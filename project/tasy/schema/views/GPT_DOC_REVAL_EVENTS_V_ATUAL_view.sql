-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW gpt_doc_reval_events_v_atual (nr_atendimento, nr_sequencia, dt_validacao, ie_situacao, dt_anterior, nr_seq_cpoe, cd_estabelecimento, dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_grupo, ie_tipo_item, ie_pendente_reval, nm_tabela, dt_final, dt_prox_geracao, dt_fim, ds_horarios, cd_intervalo, ie_duracao) AS select	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_dialysis nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'DIA' ie_tipo_grupo,
		'DI' ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_DIALISE' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		null cd_intervalo,
		max(c.ie_duracao) ie_duracao
		FROM cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_dialise c,
		atendimento_paciente z
where	a.nr_seq_revalidation_rule = b.nr_sequencia
and		c.nr_sequencia = a.nr_seq_dialysis
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 1
				from	medico
				where	coalesce(ie_situacao, 'A') = 'A'
				and		cd_pessoa_fisica = (select	max(cd_pessoa_fisica)
											from	usuario a
											where	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and (select max(nr_prescricao)
		 from prescr_solucao
		 where nr_seq_dialise_cpoe = c.nr_sequencia) is not null
and		c.nr_atendimento = a.nr_atendimento
and 	coalesce(b.ie_situacao, 'A') in ('A', 'I')
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	a.nr_seq_dialysis is not null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_dialysis,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim


union all


select	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_material nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'M' ie_tipo_grupo,
		CASE WHEN max(c.ie_controle_tempo)='S' THEN 'SOL'  ELSE 'M' END  ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_MATERIAL' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  coalesce(c.dt_fim_cih, c.dt_fim)  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		max(c.cd_intervalo) cd_intervalo,
		max(c.ie_duracao) ie_duracao
from	cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_material c,
		atendimento_paciente z
where	a.nr_seq_revalidation_rule = b.nr_sequencia
and 	c.nr_sequencia = a.nr_seq_material
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  coalesce(c.dt_fim_cih, c.dt_fim)  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 1
				from 	medico
				where	coalesce(ie_situacao, 'A') = 'A'
				and		cd_pessoa_fisica = (select 	max(cd_pessoa_fisica)
											from	usuario a
											where	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and (select	max(nr_prescricao)
		from 	prescr_material
		where	nr_seq_mat_cpoe = c.nr_sequencia) is not null
and 	c.nr_atendimento = a.nr_atendimento
and 	a.nr_seq_material is not null
and 	coalesce(c.ie_material, 'N') = 'N'
and 	coalesce(b.ie_situacao, 'A') in ('A', 'I')
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_material,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim_cih,
			c.dt_fim


union all


select	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_diet nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'N' ie_tipo_grupo,
		cpoe_obter_tipo_item('CPOE_DIETA', a.nr_seq_diet, c.ie_tipo_dieta, null, null) ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_DIETA' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		max(c.cd_intervalo) cd_intervalo,
		max(c.ie_duracao) ie_duracao
from	cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_dieta c,
		atendimento_paciente z
where 	a.nr_seq_revalidation_rule = b.nr_sequencia
and 	c.nr_sequencia = a.nr_seq_diet
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 	1
				from	medico
				where 	coalesce(ie_situacao, 'A') = 'A'
				and 	cd_pessoa_fisica = (select	max(cd_pessoa_fisica)
											from 	usuario a
											where	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and		obter_prescr_item_cpoe(c.nr_sequencia, cpoe_obter_tipo_item('CPOE_DIETA', a.nr_seq_diet, null, null, null)) is not null
and		c.nr_atendimento = a.nr_atendimento
and 	coalesce(b.ie_situacao, 'A') in ('A', 'I')
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	a.nr_seq_diet is not null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_diet,
			c.ie_tipo_dieta,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim


union all


select	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_exam nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'P' ie_tipo_grupo,
		'P' ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_PROCEDIMENTO' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		max(c.cd_intervalo) cd_intervalo,
		max(c.ie_duracao) ie_duracao
from 	cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_procedimento c,
		atendimento_paciente z
where	a.nr_seq_revalidation_rule = b.nr_sequencia
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.nr_sequencia = a.nr_seq_exam
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 1
				from medico
				where coalesce(ie_situacao, 'A') = 'A'
				and cd_pessoa_fisica = (select	max(cd_pessoa_fisica)
										from	usuario a
										where	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and (select	max(nr_prescricao)
		 from	prescr_procedimento
		 where	nr_seq_proc_cpoe = c.nr_sequencia) is not null
and c.nr_atendimento = a.nr_atendimento
and 	coalesce(b.ie_situacao, 'A') in ('A', 'I')
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	a.nr_seq_exam is not null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_exam,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim


union all


select 	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_gasotherapy nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'G' ie_tipo_grupo,
		'O' ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_GASOTERAPIA' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		max(c.cd_intervalo) cd_intervalo,
		max(c.ie_duracao) ie_duracao
from 	cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_gasoterapia c,
		atendimento_paciente z
where	a.nr_seq_revalidation_rule = b.nr_sequencia
and 	c.nr_sequencia = a.nr_seq_gasotherapy
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 1
				from	medico
				where	coalesce(ie_situacao, 'A') = 'A'
				and		cd_pessoa_fisica = (select	max(cd_pessoa_fisica)
											from 	usuario a
											where 	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and (select	max(nr_prescricao)
		 from	prescr_gasoterapia
		 where	nr_seq_gas_cpoe = c.nr_sequencia) is not null
and 	c.nr_atendimento = a.nr_atendimento
and 	coalesce(b.ie_situacao, 'A') in ('A', 'I')
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	a.nr_seq_gasotherapy is not null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_gasotherapy,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim


union all


select	a.nr_atendimento,
		max(a.nr_sequencia) nr_sequencia,
		max(a.dt_validacao) dt_validacao,
		max(b.ie_situacao) ie_situacao,
		max(a.dt_validacao) - (max(b.qt_horas_anterior)/24) dt_anterior,
		a.nr_seq_recomendation nr_seq_cpoe,
		b.cd_estabelecimento,
		max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
		max(c.nm_usuario_nrec) nm_usuario_nrec,
		'R' ie_tipo_grupo,
		'R' ie_tipo_item,
		'S' ie_pendente_reval,
		'CPOE_RECOMENDACAO' nm_tabela,
		CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE coalesce(c.dt_suspensao, c.dt_fim) END  dt_final,
		max(c.dt_prox_geracao) dt_prox_geracao,
		max(c.dt_fim) dt_fim,
		max(c.ds_horarios) ds_horarios,
		max(c.cd_intervalo) cd_intervalo,
		max(c.ie_duracao) ie_duracao
from	cpoe_revalidation_events a,
		cpoe_revalidation_rule b,
		cpoe_recomendacao c,
		atendimento_paciente z
where	a.nr_seq_revalidation_rule = b.nr_sequencia
and 	a.nr_atendimento = z.nr_atendimento
and 	c.nr_atendimento = z.nr_atendimento
and 	c.nr_sequencia = a.nr_seq_recomendation
and 	c.dt_liberacao is not null
and 	coalesce(cd_funcao_origem, 2314) = 2314
and 	c.nr_atendimento = a.nr_atendimento
and 	coalesce(CASE WHEN c.dt_lib_suspensao IS NULL THEN  c.dt_fim  ELSE obter_data_menor(c.dt_suspensao, c.dt_fim) END , LOCALTIMESTAMP + interval '1 days') > ( LOCALTIMESTAMP + ( 1/ 24 ) )
and 	exists (select 1
				from	medico
				where	coalesce(ie_situacao, 'A') = 'A'
				and		cd_pessoa_fisica = (select	max(cd_pessoa_fisica)
											from	usuario a
											where	a.nm_usuario_pesquisa = upper(c.nm_usuario_nrec)))
and (select	max(nr_prescricao)
	 from	prescr_recomendacao
	 where	nr_seq_rec_cpoe = c.nr_sequencia) is not null
and 	a.dt_validacao > trunc(LOCALTIMESTAMP - interval '10 days')
and 	a.nr_atendimento is not null
and 	a.dt_validacao is not null
and 	a.nr_seq_hemotherapy is null
and 	a.nr_seq_recomendation is not null
and 	z.dt_alta is null
and 	z.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
and 	c.cd_medico is not null
and		c.dt_prox_geracao is not null
group by	a.nr_atendimento,
			a.nr_seq_recomendation,
			b.cd_estabelecimento,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.dt_fim;

