-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW repasse_terceiro_valores_v (ds_repasses, nr_seq_procmat, cd_pessoa_fisica, cd_cgc, nm_paciente, nr_atendimento, dt_conta, item, perc_repasse, vl_amaior, vl_reapresentado, vl_glosado, vl_repasse, vl_liberado, vl_pendente, vl_faturado, ie_libera, vl_pagar, cd_convenio, ie_responsavel_credito, nr_sequencia, dt_mesano_referencia, nr_seq_item_retorno, vl_pend_reap, nr_seq_protocolo) AS select
	'Repasse Procedimento Liberado' ds_repasses, 
	c.nr_sequencia nr_seq_procmat, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(obter_pessoa_atendimento(c.nr_atendimento,'N'),1,30) nm_paciente, 
	c.nr_atendimento, 
	c.dt_conta dt_conta,	 
	SUBSTR(f.ds_procedimento,1,100) item, 
	coalesce((dividir(coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0),coalesce(g.vl_participante,coalesce(c.vl_procedimento, 0))) * 100),0) perc_repasse, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PA',b.cd_medico),0) vl_amaior, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PRE',b.cd_medico),0) vl_reapresentado, 
 	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PG',b.cd_medico),0) vl_glosado, 
 	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0) vl_repasse, 
 	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PL',b.cd_medico),0) vl_liberado,	 
	0 vl_pendente, 
	coalesce(g.vl_participante,coalesce(c.vl_procedimento, 0)) vl_faturado, 
	'S' ie_libera, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'VPP',b.CD_MEDICO),0) Vl_pagar, 
	c.cd_convenio cd_convenio, 
	coalesce(g.ie_responsavel_credito,coalesce(c.ie_responsavel_credito,null)) ie_responsavel_credito, 
	a.nr_sequencia, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia) dt_mesano_referencia, 
	b.nr_seq_item_retorno, 
	0 vl_pend_reap, 
	d.nr_seq_protocolo 
FROM procedimento f, procedimento_paciente c, terceiro a, procedimento_repasse b
LEFT OUTER JOIN procedimento_participante g ON (b.nr_seq_procedimento = g.nr_sequencia AND b.nr_seq_partic = g.nr_seq_partic)
, conta_paciente e
LEFT OUTER JOIN protocolo_convenio d ON (e.nr_seq_protocolo = d.nr_seq_protocolo)
WHERE b.nr_seq_terceiro 	   	= a.nr_sequencia AND f.cd_procedimento 	   	= c.cd_procedimento AND c.ie_origem_proced    	= f.ie_origem_proced AND b.nr_seq_procedimento 		= c.nr_sequencia  AND c.nr_interno_conta  		= e.nr_interno_conta   and (obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PL',b.CD_MEDICO) > 0 or (b.ie_status = 'G' and b.nr_repasse_terceiro is not null)) GROUP BY 
	c.nr_sequencia, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, b.cd_medico, 
	SUBSTR(obter_pessoa_atendimento(c.nr_atendimento,'N'),1,30), 
	c.nr_atendimento, 
	c.dt_conta, 
	f.ds_procedimento, 
	b.NR_SEQ_procedimento, 
	b.nr_seq_terceiro, 
	c.vl_procedimento, 
	b.nr_seq_terceiro, 
    c.cd_convenio, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia), 
	c.ie_responsavel_credito, 
	a.nr_sequencia, 
	'Repasse Procedimento Liberado', 
	0, 
	g.vl_participante, 
	g.ie_responsavel_credito, 
	b.nr_seq_item_retorno, 
	d.nr_seq_protocolo 

union all
 
SELECT 
	'Repasse Material Liberado' ds_repasses, 
	c.nr_sequencia nr_seq_procmat, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(OBTER_PESSOA_ATENDIMENTO(c.nr_atendimento,'N'),1,30) nm_paciente, 
	c.nr_atendimento, 
	c.dt_conta dt_conta,	 
	SUBSTR(f.ds_material,1,100) item, 
	coalesce((dividir(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null), c.vl_material) * 100),0) perc_repasse, 
 	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MA',null),0) VL_AMAIOR, 
 	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MRE',null),0) VL_Reapresentado, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MG',null),0) VL_GLOSADO, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null),0) VL_repasse, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'ML',null),0) VL_liberado, 
 	0 vl_pendente, 
	coalesce(c.vl_material,0) vl_faturado, 
	'S' ie_libera, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'VMP',null),0) Vl_pagar, 
	c.cd_convenio cd_convenio, 
	null ie_responsavel_credito, 
	a.nr_sequencia, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia) dt_mesano_referencia, 
	b.nr_seq_item_retorno, 
	0 vl_pend_reap, 
	d.nr_seq_protocolo 
FROM material f, material_atend_paciente c, material_repasse b, terceiro a, conta_paciente e
LEFT OUTER JOIN protocolo_convenio d ON (e.nr_seq_protocolo = d.nr_seq_protocolo)
WHERE b.nr_seq_terceiro 	= a.nr_sequencia AND f.cd_material 	 	= c.cd_material AND b.nr_seq_material 	= c.nr_sequencia  AND c.nr_interno_conta 	= e.nr_interno_conta AND (obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'ML',NULL) > 0 or (b.nr_repasse_terceiro is not null and b.ie_status = 'G')) GROUP BY 
	c.nr_sequencia, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(obter_pessoa_atendimento(c.nr_atendimento,'N'),1,30), 
	c.nr_atendimento, 
	c.dt_conta, 
	f.ds_material, 
	b.nr_seq_material, 
	b.nr_seq_terceiro, 
	c.vl_material, 
	b.nr_seq_terceiro, 
	c.cd_convenio, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia), 
	a.nr_sequencia, 
	'Repasse Material Liberado',0, 
	b.nr_seq_item_retorno, 
	d.nr_seq_protocolo 

union all
 
select 
	'Repasse Procedimento Pendente' ds_repasses, 
	c.nr_sequencia nr_seq_procmat, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(OBTER_PESSOA_ATENDIMENTO(c.nr_atendimento,'N'),1,30) nm_paciente, 
	c.nr_atendimento, 
	c.dt_conta dt_conta,	 
	SUBSTR(f.ds_procedimento,1,100) item, 
	coalesce((dividir(coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0),coalesce(g.vl_participante,coalesce(c.vl_procedimento, 0))) * 100),0) perc_repasse, 
	0 vl_amaior, 
	0 vl_reapresentado, 
	0 vl_glosado, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0) vl_repasse, 
 	0 vl_liberado, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0) vl_pendente, 
	coalesce(g.vl_participante,coalesce(c.vl_procedimento, 0)) vl_faturado, 
	'N' ie_libera, 
	0 Vl_pagar, 
	c.cd_convenio cd_convenio, 
	coalesce(g.ie_responsavel_credito,coalesce(c.ie_responsavel_credito,null)) ie_responsavel_credito, 
	a.nr_sequencia, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia) dt_mesano_referencia, 
	b.nr_seq_item_retorno, 
	(coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PR',b.cd_medico),0) - coalesce(obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PRE',b.cd_medico),0)) vl_pend_reap, 
	d.nr_seq_protocolo 
FROM procedimento f, procedimento_paciente c, terceiro a, procedimento_repasse b
LEFT OUTER JOIN procedimento_participante g ON (b.nr_seq_procedimento = g.nr_sequencia AND b.nr_seq_partic = g.nr_seq_partic)
, conta_paciente e
LEFT OUTER JOIN protocolo_convenio d ON (e.nr_seq_protocolo = d.nr_seq_protocolo)
WHERE b.nr_seq_terceiro 	   	= a.nr_sequencia AND f.cd_procedimento 	   	= c.cd_procedimento AND c.ie_origem_proced    	= f.ie_origem_proced AND b.nr_seq_procedimento 		= c.nr_sequencia  AND c.nr_interno_conta  		= e.nr_interno_conta   and obter_valores_itens_repasse(b.nr_seq_procedimento,b.nr_seq_terceiro,'PL',b.CD_MEDICO) = 0 and b.nr_repasse_terceiro is null GROUP BY 
	c.nr_sequencia, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(obter_pessoa_atendimento(c.nr_atendimento,'N'),1,30), 
	c.nr_atendimento, 
	c.dt_conta, 
	f.ds_procedimento, b.cd_medico, 
	b.NR_SEQ_procedimento, 
	b.nr_seq_terceiro, 
	c.vl_procedimento, 
	b.nr_seq_terceiro, 
    c.cd_convenio, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia), 
	c.ie_responsavel_credito, 
	a.nr_sequencia, 
	'Repasse Procedimento Pendente', 
	g.vl_participante, 
	g.ie_responsavel_credito, 
	b.nr_seq_item_retorno, 
	d.nr_seq_protocolo 

union all
 
SELECT 
	'Repasse Material Pendente' ds_repasses, 
	c.nr_sequencia nr_seq_procmat, 
	a.cd_pessoa_fisica, 
	a.cd_cgc,	 
	SUBSTR(OBTER_PESSOA_ATENDIMENTO(c.nr_atendimento,'N'),1,30) nm_paciente, 
	c.nr_atendimento, 
	c.dt_conta dt_conta,	 
	SUBSTR(f.ds_material,1,100) item, 
	coalesce((dividir(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null), c.vl_material) * 100),0) perc_repasse, 
 	0 VL_AMAIOR, 
 	0 VL_Reapresentado, 
	0 VL_GLOSADO, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null),0) VL_repasse, 
	0 VL_liberado, 
	coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null),0) VL_pendente, 
 	coalesce(c.vl_material,0) vl_faturado, 
	'N' ie_libera, 
	0 Vl_pagar, 
	c.cd_convenio cd_convenio, 
	null ie_responsavel_credito, 
	a.nr_sequencia, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia) dt_mesano_referencia, 
	b.nr_seq_item_retorno, 
	(coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MR',null),0) - coalesce(obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'MRE',null),0)) vl_pend_reap, 
	d.nr_seq_protocolo 
FROM material f, material_atend_paciente c, material_repasse b, terceiro a, conta_paciente e
LEFT OUTER JOIN protocolo_convenio d ON (e.nr_seq_protocolo = d.nr_seq_protocolo)
WHERE b.nr_seq_terceiro 	= a.nr_sequencia AND f.cd_material 	 	= c.cd_material AND b.nr_seq_material 	= c.nr_sequencia  AND c.nr_interno_conta 	= e.nr_interno_conta AND obter_valores_itens_repasse(b.nr_seq_material,b.nr_seq_terceiro,'ML',null) = 0 and b.nr_repasse_terceiro is null GROUP BY 
	c.nr_sequencia, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	SUBSTR(obter_pessoa_atendimento(c.nr_atendimento,'N'),1,30), 
	c.nr_atendimento, 
	c.dt_conta, 
	f.ds_material, 
	b.nr_seq_material, 
	b.nr_seq_terceiro, 
	c.vl_material, 
	b.nr_seq_terceiro, 
	c.cd_convenio, 
	coalesce(d.dt_mesano_referencia,e.dt_mesano_referencia), 
	a.nr_sequencia, 
	'Repasse Material Pendente', 
	b.nr_seq_item_retorno, 
	d.nr_seq_protocolo;

