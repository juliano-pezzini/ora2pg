-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_titulo_segunda_via_call (ie_selecionar, nr_titulo, dt_pagamento_previsto, dt_vencimento, nr_contrato, vl_saldo_titulo, dt_novo_venc, nr_seq_conta_banco, nr_seq_mensalidade, dt_rescisao, cd_estabelecimento, cd_pessoa_fisica, cd_cgc, ie_tipo_pf_pj, ie_tipo_titulo) AS select 	0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
WHERE not exists (	select 1
				from pls_segurado x
				where x.cd_pessoa_fisica = a.cd_pessoa_fisica
				and x.nr_seq_contrato	<> c.nr_sequencia) and a.ie_situacao	=	'1' and a.cd_pessoa_fisica	is not null and pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) = 'S'
	
union

	select 	0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
WHERE not exists (	select 1 
				from 	pls_segurado x 
				where 	x.cd_pessoa_fisica = a.cd_pessoa_fisica) and a.ie_situacao	=	'1' and a.cd_pessoa_fisica	is not null and pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) ='S'
	 
union

	select 	0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		e.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM pls_segurado e, titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
WHERE e.nr_seq_pagador 	= d.nr_sequencia and a.ie_situacao		= '1' and e.cd_pessoa_fisica	is not null and pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) = 'S' and (exists (select	1	
			from	pls_mensalidade_segurado z,
				pls_mensalidade v
			where 	z.nr_seq_mensalidade	= v.nr_sequencia
			and	v.nr_sequencia		= a.nr_seq_mensalidade
			and	z.nr_seq_segurado	= e.nr_sequencia) or a.nr_seq_mensalidade is null)
	 
union

	select	0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		e.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM pls_segurado e, pls_contrato_pagador d
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
, titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
WHERE e.nr_seq_pagador   	= d.nr_sequencia and a.ie_situacao         	= '1' and a.nr_seq_mensalidade 	is null and a.ie_pls            	= 'S' and e.cd_pessoa_fisica	is not null and pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) ='S'
	 
union

	select 	0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM pls_segurado e, titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
WHERE e.nr_seq_pagador      	= d.nr_sequencia and a.ie_situacao      	= '1' and e.cd_pessoa_fisica	is not null and pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) ='S'
	 
union

	select 0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		d.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		c.dt_rescisao,
		a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		null cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	from 	titulo_receber a,
		pls_mensalidade b,
		pls_contrato_pagador c,
		pls_contrato d,
		pls_segurado e,
		pls_segurado_pagador f
	where 	a.nr_seq_mensalidade = b.nr_sequencia
	and	c.nr_sequencia = b.nr_seq_pagador
	and   	c.nr_seq_contrato =  d.nr_sequencia
	and	e.nr_seq_contrato = d.nr_sequencia
	and	f.nr_seq_pagador = b.nr_seq_pagador
	and	e.nr_sequencia  = f.nr_seq_segurado
	and	e.cd_pessoa_fisica = a.cd_pessoa_fisica
	and   	a.ie_situacao      	= '1'
	and 	pls_obter_regra_pessoa_via_bol(a.cd_pessoa_fisica,null,a.nr_titulo,a.cd_estabelecimento) = 'S'
	
union all

	select 0 ie_selecionar,
		a.nr_titulo,
		a.dt_pagamento_previsto,
		a.dt_vencimento,
		c.nr_contrato,
		a.vl_saldo_titulo,
		to_date(null) dt_novo_venc,
		a.nr_seq_conta_banco,
		a.nr_seq_mensalidade,
		d.dt_rescisao,
		a.cd_estabelecimento,
		null cd_pessoa_fisica,
		a.cd_cgc,
		CASE WHEN coalesce(a.cd_pessoa_fisica, 0)=0 THEN  'PJ'  ELSE 'PF' END  ie_tipo_pf_pj,
		a.ie_tipo_titulo
	FROM titulo_receber a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (d.nr_seq_contrato = c.nr_sequencia)
WHERE a.ie_situacao       	= '1' and a.cd_cgc 		is not null and pls_obter_regra_pessoa_via_bol(null,a.cd_cgc,a.nr_titulo,a.cd_estabelecimento) ='S';

