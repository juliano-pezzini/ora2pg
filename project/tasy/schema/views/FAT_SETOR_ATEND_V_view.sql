-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW fat_setor_atend_v (cd_convenio, cd_setor_atendimento, cd_setor_receita, dt_mesano_referencia, nr_seq_protocolo, ie_tipo_convenio, nr_atendimento, ie_tipo_atendimento, nr_diarias, qt_paciente, vl_item, qt_exame, vl_medico) AS SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		SUM(CASE WHEN A.IE_ORIGEM_PROCED=2 THEN                 CASE WHEN F.CD_GRUPO_SUS=2 THEN 0  ELSE A.VL_MATERIAIS + A.VL_CUSTO_OPERACIONAL END   ELSE (A.VL_PROCEDIMENTO - A.VL_MEDICO - A.VL_ANESTESISTA - A.VL_AUXILIARES) END ) VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
		PROCEDIMENTO F,
   		ATENDIMENTO_PACIENTE D,
        	PROCEDIMENTO_PACIENTE A,
        	CONTA_PACIENTE C,
		PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND		A.CD_PROCEDIMENTO			= F.CD_PROCEDIMENTO
 AND		A.IE_ORIGEM_PROCED			= F.IE_ORIGEM_PROCED
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO			= Y.CD_SETOR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO
 AND	   	Y.CD_CLASSIF_SETOR IN (3,4,8)
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
   		SUM(CASE WHEN A.IE_ORIGEM_PROCED=1 THEN (A.VL_MEDICO + A.VL_ANESTESISTA + A.VL_AUXILIARES) WHEN A.IE_ORIGEM_PROCED=5 THEN (A.VL_MEDICO + A.VL_ANESTESISTA + A.VL_AUXILIARES)  ELSE A.VL_MEDICO END ) VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
        	PROCEDIMENTO_PACIENTE A,
        	CONTA_PACIENTE C,
		PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 			= Y.CD_SETOR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO
 AND	   	Y.CD_CLASSIF_SETOR IN (3,4,8)
 AND	   	A.CD_MEDICO_EXECUTOR IS NOT NULL
 AND		((A.IE_ORIGEM_PROCED = 3) OR
 		  NOT EXISTS (SELECT W.CD_PESSOA_FISICA
				FROM MEDICO_CONVENIO W
				WHERE 	W.CD_PESSOA_FISICA 	= A.CD_MEDICO_EXECUTOR
				AND 	W.CD_CONVENIO 	= B.CD_CONVENIO))
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

 SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
   		SUM(E.VL_PARTICIPANTE) VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
		PROCEDIMENTO_PARTICIPANTE E,
        	PROCEDIMENTO_PACIENTE A,
        	CONTA_PACIENTE C,
		PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	A.NR_SEQUENCIA 				= E.NR_SEQUENCIA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 			= Y.CD_SETOR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO
 AND	   	Y.CD_CLASSIF_SETOR IN (3,4,8)
 AND	   	A.CD_MEDICO_EXECUTOR IS NOT NULL
 AND		coalesce(A.IE_TIPO_SERVICO_SUS,0) <> 8
 AND		((A.IE_ORIGEM_PROCED = 3) OR
 		  NOT EXISTS (SELECT W.CD_PESSOA_FISICA
                              FROM MEDICO_CONVENIO W
                              WHERE W.CD_PESSOA_FISICA = E.CD_PESSOA_FISICA
                                AND W.CD_CONVENIO = B.CD_CONVENIO))
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		SUM(A.VL_MATERIAL) VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
        	MATERIAL_ATEND_PACIENTE A,
		CONTA_PACIENTE C,
        	PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 		= Y.CD_SETOR_ATENDIMENTO
 AND	   	Y.CD_CLASSIF_SETOR IN (3,4,8)
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		SUM(CASE WHEN A.IE_ORIGEM_PROCED=2 THEN                 CASE WHEN F.CD_GRUPO_SUS=2 THEN 0  ELSE A.VL_MATERIAIS + A.VL_CUSTO_OPERACIONAL END   ELSE A.VL_PROCEDIMENTO END ) VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
		PROCEDIMENTO F,
   		ATENDIMENTO_PACIENTE D,
        	PROCEDIMENTO_PACIENTE A,
		CONTA_PACIENTE C,
        	PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO
 AND		A.CD_PROCEDIMENTO			= F.CD_PROCEDIMENTO
 AND		A.IE_ORIGEM_PROCED			= F.IE_ORIGEM_PROCED
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 		= Y.CD_SETOR_ATENDIMENTO
 AND	   	Y.CD_CLASSIF_SETOR NOT IN (3,4,8)
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
   		SUM(CASE WHEN A.IE_ORIGEM_PROCED=1 THEN (A.VL_MEDICO + A.VL_ANESTESISTA + A.VL_AUXILIARES) WHEN A.IE_ORIGEM_PROCED=5 THEN (A.VL_MEDICO + A.VL_ANESTESISTA + A.VL_AUXILIARES)  ELSE A.VL_MEDICO END ) VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
        	PROCEDIMENTO_PACIENTE A,
		CONTA_PACIENTE C,
        	PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 		= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 		= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     		= D.NR_ATENDIMENTO
 AND		B.CD_CONVENIO			= E.CD_CONVENIO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 		= Y.CD_SETOR_ATENDIMENTO
 AND	   	Y.CD_CLASSIF_SETOR NOT IN (3,4,8)
 AND	   	A.CD_MEDICO_EXECUTOR IS NOT NULL
 AND		((A.IE_ORIGEM_PROCED = 3) OR
		  NOT EXISTS (SELECT W.CD_PESSOA_FISICA
                              FROM MEDICO_CONVENIO W
                              WHERE W.CD_PESSOA_FISICA = A.CD_MEDICO_EXECUTOR
                                AND W.CD_CONVENIO = B.CD_CONVENIO))
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
		SUM(E.VL_PARTICIPANTE) VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
        	PROCEDIMENTO_PARTICIPANTE E,
        	PROCEDIMENTO_PACIENTE A,
		CONTA_PACIENTE C,
		PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 		= C.NR_INTERNO_CONTA
 AND       	A.NR_SEQUENCIA 			= E.NR_SEQUENCIA
 AND       	C.NR_SEQ_PROTOCOLO 		= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     		= D.NR_ATENDIMENTO
 AND		B.CD_CONVENIO			= E.CD_CONVENIO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 		= Y.CD_SETOR_ATENDIMENTO
 AND	   	Y.CD_CLASSIF_SETOR NOT IN (3,4,8)
 AND	   	A.CD_MEDICO_EXECUTOR IS NOT NULL
 AND		((A.IE_ORIGEM_PROCED = 3) OR
 		  NOT EXISTS (SELECT W.CD_PESSOA_FISICA
                              FROM MEDICO_CONVENIO W
                              WHERE W.CD_PESSOA_FISICA = E.CD_PESSOA_FISICA
                                AND W.CD_CONVENIO = B.CD_CONVENIO))
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		A.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		SUM(A.VL_MATERIAL) VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		SETOR_ATENDIMENTO Y,
		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
        	MATERIAL_ATEND_PACIENTE A,
		CONTA_PACIENTE C,
        	PROTOCOLO_CONVENIO B
 WHERE     	A.NR_INTERNO_CONTA 			= C.NR_INTERNO_CONTA
 AND       	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	A.NR_ATENDIMENTO     		= D.NR_ATENDIMENTO
 AND		B.CD_CONVENIO			= E.CD_CONVENIO
 AND       	A.CD_MOTIVO_EXC_CONTA IS NULL
 AND	   	A.CD_SETOR_ATENDIMENTO 		= Y.CD_SETOR_ATENDIMENTO
 AND	   	Y.CD_CLASSIF_SETOR NOT IN (3,4,8)
GROUP BY  	A.CD_SETOR_ATENDIMENTO,
   		A.CD_SETOR_RECEITA,
		B.CD_CONVENIO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO

UNION

SELECT 	B.CD_CONVENIO,
   		G.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		G.CD_SETOR_ATENDIMENTO  CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		E.IE_TIPO_CONVENIO,
		D.NR_ATENDIMENTO,
		D.IE_TIPO_ATENDIMENTO,
   		TRUNC(G.DT_SAIDA_UNIDADE - G.DT_ENTRADA_UNIDADE) NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		CONVENIO E,
   		ATENDIMENTO_PACIENTE D,
		ATEND_PACIENTE_UNIDADE G,
        	CONTA_PACIENTE C,
		PROTOCOLO_CONVENIO B
 WHERE     	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	C.NR_ATENDIMENTO     			= D.NR_ATENDIMENTO
 AND       	D.NR_ATENDIMENTO     			= G.NR_ATENDIMENTO
 AND		B.CD_CONVENIO				= E.CD_CONVENIO

UNION

SELECT 	C.CD_CONVENIO,
   		G.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		G.CD_SETOR_ATENDIMENTO  CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		D.IE_TIPO_CONVENIO,
		A.NR_ATENDIMENTO,
		A.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		COUNT(DISTINCT A.CD_PESSOA_FISICA) QT_PACIENTE,
   		0 VL_ITEM,
		0 QT_EXAME,
		0 VL_MEDICO
FROM 		CONVENIO D,
		ATENDIMENTO_PACIENTE A,
		ATEND_PACIENTE_UNIDADE G,
		CONTA_PACIENTE B,
		PROTOCOLO_CONVENIO C
 WHERE     	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND       	B.NR_ATENDIMENTO     			= A.NR_ATENDIMENTO
 AND       	G.NR_ATENDIMENTO     			= A.NR_ATENDIMENTO
 AND		C.CD_CONVENIO				= D.CD_CONVENIO
GROUP BY 	C.CD_CONVENIO,
   		G.CD_SETOR_ATENDIMENTO,
   		G.CD_SETOR_ATENDIMENTO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		D.IE_TIPO_CONVENIO,
		A.NR_ATENDIMENTO,
		A.IE_TIPO_ATENDIMENTO

UNION

SELECT 	C.CD_CONVENIO,
   		E.CD_SETOR_ATENDIMENTO  CD_SETOR_ATENDIMENTO,
   		E.CD_SETOR_ATENDIMENTO  CD_SETOR_RECEITA,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		D.IE_TIPO_CONVENIO,
		A.NR_ATENDIMENTO,
		A.IE_TIPO_ATENDIMENTO,
   		0 NR_DIARIAS,
   		0 QT_PACIENTE,
   		0 VL_ITEM,
		COUNT(E.CD_PROCEDIMENTO) QT_EXAME,
		0 VL_MEDICO
FROM 		CONVENIO D,
		ATENDIMENTO_PACIENTE A,
		PROCEDIMENTO_PACIENTE E,
		CONTA_PACIENTE B,
		PROTOCOLO_CONVENIO C
 WHERE     	C.NR_SEQ_PROTOCOLO 			= B.NR_SEQ_PROTOCOLO
 AND		B.NR_INTERNO_CONTA			= E.NR_INTERNO_CONTA
 AND       	B.NR_ATENDIMENTO     			= A.NR_ATENDIMENTO
 AND		C.CD_CONVENIO				= D.CD_CONVENIO
GROUP BY	C.CD_CONVENIO,
   		E.CD_SETOR_ATENDIMENTO,
   		E.CD_SETOR_ATENDIMENTO,
		B.DT_MESANO_REFERENCIA,
		B.NR_SEQ_PROTOCOLO,
		D.IE_TIPO_CONVENIO,
		A.NR_ATENDIMENTO,
		A.IE_TIPO_ATENDIMENTO;

