-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conpaci_pendente_relat_v (nr_atendimento, nm_paciente, dt_entrada, ds_convenio, ds_tipo_atend, cd_matricula, cd_autorizacao, vl_conta, dt_pagamento_previsto, vl_pendente, ds_cat, ds_nf, ds_observacao, cd_convenio_parametro, nr_interno_conta, cd_estabelecimento) AS select	a.nr_atendimento,
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,40) nm_paciente, 
	p.dt_entrada, 
	substr(obter_nome_convenio(a.cd_convenio_parametro),1,254) ds_convenio, 
	substr(obter_valor_dominio(12,p.ie_tipo_atendimento),1,15) ds_tipo_atend, 
	substr(obter_matricula_usuario(a.cd_convenio_parametro,a.nr_atendimento),1,254) cd_matricula, 
	b.cd_autorizacao, 
	coalesce(b.vl_guia,0) vl_conta, 
	r.DT_PAGAMENTO_PREVISTO, 
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta,b.CD_AUTORIZACAO) vl_pendente, 
	substr(obter_categoria_convenio(a.cd_convenio_parametro, a.cd_categoria_parametro),1,200) ds_cat, 
	substr(obter_nf_conta(a.nr_interno_conta,3),1,100) ds_nf, 
	substr(obter_dados_ultimo_retorno(a.nr_interno_conta,b.cd_autorizacao,'O'),1,255) ds_observacao, 
	a.cd_convenio_parametro, 
	a.nr_interno_conta, 
	a.cd_estabelecimento 
FROM	atendimento_paciente p, 
	conta_paciente_guia b, 
	conta_paciente a, 
	titulo_receber r 
where	a.nr_interno_conta = b.nr_interno_conta 
and	a.nr_atendimento = p.nr_atendimento 
and	a.IE_CANCELAMENTO is null 
and	r.nr_interno_conta= a.nr_interno_conta 
and	r.dt_liquidacao	is null 
and	r.nr_seq_protocolo is null 
and	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO) > 0 
group	by a.nr_atendimento, p.dt_entrada, a.cd_convenio_parametro, p.ie_tipo_atendimento, b.cd_autorizacao, coalesce(b.vl_guia,0), 
r.DT_PAGAMENTO_PREVISTO, a.cd_categoria_parametro, a.nr_interno_conta,OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO), a.cd_estabelecimento 

union
 
select	a.nr_atendimento, 
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,40) nm_paciente, 
	p.dt_entrada, 
	substr(obter_nome_convenio(a.cd_convenio_parametro),1,254) ds_convenio, 
	substr(obter_valor_dominio(12,p.ie_tipo_atendimento),1,15) ds_tipo_atend, 
	substr(obter_matricula_usuario(a.cd_convenio_parametro,a.nr_atendimento),1,254) cd_matricula, 
	b.cd_autorizacao, 
	coalesce(b.vl_guia,0) vl_conta, 
	r.DT_PAGAMENTO_PREVISTO, 
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta,b.CD_AUTORIZACAO) vl_pendente, 
	substr(obter_categoria_convenio(a.cd_convenio_parametro, a.cd_categoria_parametro),1,200) ds_cat, 
	substr(obter_nf_conta(a.nr_interno_conta,3),1,100) ds_nf, 
	substr(obter_dados_ultimo_retorno(a.nr_interno_conta,b.cd_autorizacao,'O'),1,255) ds_observacao, 
	a.cd_convenio_parametro, 
	a.nr_interno_conta, 
	a.cd_estabelecimento 
from	atendimento_paciente p, 
	conta_paciente_guia b, 
	conta_paciente a, 
	titulo_receber r 
where	a.nr_interno_conta = b.nr_interno_conta 
and	a.nr_atendimento = p.nr_atendimento 
and	r.nr_seq_protocolo = a.nr_seq_protocolo 
and	r.nr_interno_conta is null 
and	r.dt_liquidacao	is null 
and	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta,b.CD_AUTORIZACAO) > 0 
and	a.IE_CANCELAMENTO is null 
group	by a.nr_atendimento, p.dt_entrada, a.cd_convenio_parametro, p.ie_tipo_atendimento, b.cd_autorizacao, coalesce(b.vl_guia,0), 
r.DT_PAGAMENTO_PREVISTO, a.cd_categoria_parametro, a.nr_interno_conta, OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO), a.cd_estabelecimento;

