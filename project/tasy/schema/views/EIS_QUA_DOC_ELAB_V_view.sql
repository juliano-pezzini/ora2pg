-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_qua_doc_elab_v (cd_ano, nr_ano, cd_estabelecimento, qt_jan, qt_fev, qt_mar, qt_abr, qt_mai, qt_jun, qt_jul, qt_ago, qt_set, qt_out, qt_nov, qt_dez, qt_media, cd_setor_atendimento) AS select	to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy') cd_ano,
	somente_numero(to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='01' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='02' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='03' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='04' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='05' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='06' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='07' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='08' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='09' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_set,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='10' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_out,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='11' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(max(CASE WHEN to_char(dt_referencia, 'mm')='12' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_dez,
	dividir(SUM(dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100) , SUM(CASE WHEN dividir(QT_DOC_ELABORADO, QT_DOCUMENTO)=0 THEN  0  ELSE 1 END )) qt_media,
	cd_setor_atendimento
FROM 	eis_qua_doc_elab
where	trunc(dt_referencia, 'yy') = trunc(LOCALTIMESTAMP, 'yy')
group	by to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'),
	somente_numero(to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy')),
	cd_setor_atendimento,cd_estabelecimento

union all

SELECT	TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy'), 'yyyy') cd_ano,
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy'), 'yyyy')) nr_ano,
	avg(cd_estabelecimento),
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='01' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='01' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jan,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='02' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='02' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_fev,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='03' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='03' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_mar,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='04' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='04' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_abr,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='05' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='05' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_mai,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='06' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='06' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jun,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='07' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='07' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jul,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='08' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='08' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_ago,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='09' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='09' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_set,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='10' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='10' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_out,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='11' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='11' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_nov,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='12' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='12' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_dez,
	coalesce(SUM(dividir(SUM(QT_DOC_ELABORADO), SUM(qt_documento)) * 100) / COUNT(*),0) qt_media,
	-1
FROM 	eis_qua_doc_elab
WHERE	TRUNC(dt_referencia, 'yy') = TRUNC(LOCALTIMESTAMP, 'yy')
GROUP	BY TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy'), 'yyyy'),
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy'), 'yyyy')),
	cd_estabelecimento,
	dt_referencia

union all

SELECT	TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy') cd_ano,
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='01' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='02' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='03' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='04' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='05' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='06' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='07' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='08' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='09' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_set,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='10' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_out,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='11' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(MAX(CASE WHEN TO_CHAR(dt_referencia, 'mm')='12' THEN  dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100  ELSE 0 END ),0) qt_dez,
	dividir(SUM(dividir(QT_DOC_ELABORADO, QT_DOCUMENTO) * 100) , SUM(CASE WHEN dividir(QT_DOC_ELABORADO, QT_DOCUMENTO)=0 THEN  0  ELSE 1 END )) qt_media,
	cd_setor_atendimento
FROM 	eis_qua_doc_elab
WHERE (TRUNC(dt_referencia, 'yy')) = TRUNC((TRUNC(LOCALTIMESTAMP, 'yy')-1),'yy')
GROUP	BY TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy'),
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy')),
	cd_estabelecimento, cd_setor_atendimento

union all

SELECT	TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy') cd_ano,
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy')) nr_ano,
	avg(cd_estabelecimento),
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='01' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='01' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jan,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='02' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='02' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_fev,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='03' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='03' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_mar,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='04' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='04' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_abr,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='05' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='05' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_mai,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='06' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='06' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jun,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='07' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='07' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_jul,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='08' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='08' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_ago,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='09' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='09' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_set,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='10' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='10' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_out,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='11' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='11' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_nov,
	coalesce(SUM(dividir(CASE WHEN TO_CHAR(dt_referencia, 'mm')='12' THEN SUM(QT_DOC_ELABORADO)  ELSE 0 END  , CASE WHEN TO_CHAR(dt_referencia, 'mm')='12' THEN SUM(QT_DOCumento)  ELSE 0 END ) * 100),0) qt_dez,
	coalesce(SUM(dividir(SUM(QT_DOC_ELABORADO), SUM(qt_documento)) * 100) / COUNT(*),0) qt_media,
	-1
FROM 	eis_qua_doc_elab
WHERE (TRUNC(dt_referencia, 'yy')) = TRUNC((TRUNC(LOCALTIMESTAMP, 'yy')-1),'yy')
GROUP	BY TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy'),
	somente_numero(TO_CHAR(TRUNC(LOCALTIMESTAMP, 'yy')-1, 'yyyy')),
	cd_estabelecimento,
	dt_referencia

union all

select	'Meta' cd_ano,
	0,
	cd_estabelecimento,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_jan,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_fev,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_mar,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_abr,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_mai,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_jun,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_jul,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_ago,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_set,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_out,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_nov,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_dez,
	0 qt_media,
	0 cd_setor_atendimento
from 	estabelecimento
group by cd_estabelecimento

union all

select	'Bench' cd_ano,
	1,
	cd_estabelecimento,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_jan,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_fev,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_mar,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_abr,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_mai,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_jun,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_jul,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_ago,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_set,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_out,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_nov,
	Eis_Obter_Meta_Indicador(cd_estabelecimento, 451, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_dez,
	0 qt_media,
	0 cd_setor_atendimento
from 	estabelecimento
group by cd_estabelecimento;

