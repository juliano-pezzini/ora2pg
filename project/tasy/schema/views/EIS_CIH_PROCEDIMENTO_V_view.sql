-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cih_procedimento_v (ie_origem_inf, dt_ficha, dt_alta, cd_procedimento, ds_procedimento, qt_todos, qt_nao_infec, qt_infectados, cd_empresa) AS select	distinct
	1 ie_origem_inf, 
	a.dt_ficha, 
	null dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE a.dt_cancelamento is null group by a.dt_ficha, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE cd_topografia is null and a.dt_cancelamento is null group by a.dt_ficha, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	0, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE cd_topografia is not null and a.dt_cancelamento is null group by a.dt_ficha, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	distinct 
	1 ie_origem_inf, 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento   and a.dt_cancelamento is null group by g.dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento   and cd_topografia is null and a.dt_cancelamento is null group by g.dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento) ds_procedimento, 
	0, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_proc_realizado d ON (a.nr_ficha_ocorrencia = d.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento   and cd_topografia is not null and a.dt_cancelamento is null group by g.dt_alta, 
	d.cd_procedimento, 
	obter_desc_proced_cih(d.cd_procedimento), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento));

