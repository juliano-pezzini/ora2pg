-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW contas_pendentes_v (nr_atendimento, nm_paciente, dt_entrada, ds_convenio, ds_tipo_atendimento, cd_matricula, cd_autorizacao, nr_protocolo, vl_conta, dt_pagamento_previsto, vl_pendente, dt_alta, nr_titulo, nr_interno_conta, dt_liquidacao, ie_tipo_atendimento, cd_convenio_parametro, nr_seq_protocolo, cd_estabelecimento, dt_vencimento, ie_tipo_convenio, cd_setor_atendimento, ie_situacao_titulo, nr_nota_fiscal, ds_procedimento, dt_emissao, nr_nota_protocolo) AS select	a.nr_atendimento,
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,40) nm_paciente, 
	p.dt_entrada, 
	substr(obter_nome_convenio(a.cd_convenio_parametro),1,254) ds_convenio, 
	substr(obter_valor_dominio(12, p.ie_tipo_atendimento),1,15) ds_tipo_atendimento, 
	substr(obter_matricula_usuario(a.cd_convenio_parametro, a.nr_atendimento),1,254) cd_matricula, 
	b.cd_autorizacao, 
	a.nr_protocolo, 
	coalesce(b.vl_guia,0) vl_conta, 
	r.dt_pagamento_previsto dt_pagamento_previsto, 
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO) vl_pendente, 
	p.dt_alta, 
	r.nr_titulo, 
	a.nr_interno_conta nr_interno_conta, 
	r.dt_liquidacao, 
	p.ie_tipo_atendimento, 
	a.cd_convenio_parametro, 
	null nr_seq_protocolo, 
	p.cd_estabelecimento, 
	null dt_vencimento, 
	p.ie_tipo_convenio, 
	obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
	r.ie_situacao ie_situacao_titulo, 
	r.nr_nota_fiscal, 
	obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,p.ie_tipo_atendimento,a.nr_interno_conta,'D') ds_procedimento, 
	a.dt_mesano_referencia dt_emissao, 
	obter_dados_titulo_receber(r.nr_titulo,'NF') nr_nota_protocolo 
FROM	atendimento_paciente p, 
	conta_paciente_guia b, 
	conta_paciente a, 
	titulo_receber r 
where	a.nr_interno_conta 	= b.nr_interno_conta 
and	a.nr_atendimento 	= p.nr_atendimento 
and	r.nr_interno_conta	= a.nr_interno_conta 
and	r.dt_liquidacao	is null 
and	r.nr_seq_protocolo is null 
and	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO) > 0 
group	by a.nr_atendimento, 
	p.dt_entrada, 
	a.cd_convenio_parametro, 
	p.ie_tipo_atendimento, 
	b.cd_autorizacao, 
	a.nr_protocolo, 
	coalesce(b.vl_guia,0), 
	r.dt_pagamento_previsto,  
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO), 
	p.dt_alta, 
	r.nr_titulo, 
	a.nr_interno_conta, 
	r.dt_liquidacao, 
	p.cd_estabelecimento, 
	p.ie_tipo_convenio, 
	r.ie_situacao, 
	r.nr_nota_fiscal, 
	obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,p.ie_tipo_atendimento,a.nr_interno_conta,'D'), 
	a.dt_mesano_referencia 

union
 
select	a.nr_atendimento, 
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,40) nm_paciente, 
	p.dt_entrada, 
	substr(obter_nome_convenio(a.cd_convenio_parametro),1,254) ds_convenio, 
	substr(obter_valor_dominio(12, p.ie_tipo_atendimento),1,15) ds_tipo_atendimento, 
	substr(obter_matricula_usuario(a.cd_convenio_parametro, a.nr_atendimento),1,254) cd_matricula, 
	b.cd_autorizacao, 
	a.nr_protocolo, 
	coalesce(b.vl_guia,0) vl_conta, 
	r.dt_pagamento_previsto, 
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO) vl_pendente, 
	p.dt_alta, 
	r.nr_titulo, 
	null nr_interno_conta, 
	r.dt_liquidacao, 
	p.ie_tipo_atendimento, 
	a.cd_convenio_parametro, 
	r.nr_seq_protocolo nr_seq_protocolo, 
	p.cd_estabelecimento, 
	r.dt_vencimento dt_vencimento, 
	p.ie_tipo_convenio, 
	obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
	r.ie_situacao ie_situacao_titulo, 
	r.nr_nota_fiscal, 
	obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,p.ie_tipo_atendimento,a.nr_interno_conta,'D') ds_procedimento, 
	a.dt_mesano_referencia dt_emissao, 
	obter_dados_titulo_receber(r.nr_titulo,'NF') nr_nota_protocolo 
from	atendimento_paciente p, 
	conta_paciente_guia b, 
	conta_paciente a, 
	titulo_receber r 
where	a.nr_interno_conta 	= b.nr_interno_conta 
and	a.nr_atendimento 	= p.nr_atendimento 
and	r.nr_seq_protocolo 	= a.nr_seq_protocolo 
and	r.dt_liquidacao	is null 
and	r.nr_interno_conta is null 
and	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO) > 0 
group	by a.nr_atendimento, 
	p.dt_entrada, 
	a.cd_convenio_parametro, 
	p.ie_tipo_atendimento, 
	b.cd_autorizacao, 
	a.nr_protocolo, 
	coalesce(b.vl_guia,0), 
	OBTER_VALOR_PENDENTE_CONTA(a.nr_interno_conta, b.CD_AUTORIZACAO), 
	p.dt_alta, 
	r.nr_titulo, 
	r.dt_liquidacao, 
	r.nr_seq_protocolo, 
	p.cd_estabelecimento, 
	r.dt_vencimento, 
	r.dt_pagamento_previsto, 
	p.ie_tipo_convenio, 
	r.ie_situacao, 
	r.nr_nota_fiscal, 
	obter_proc_principal(a.nr_atendimento,a.cd_convenio_parametro,p.ie_tipo_atendimento,a.nr_interno_conta,'D'), 
	a.dt_mesano_referencia;

