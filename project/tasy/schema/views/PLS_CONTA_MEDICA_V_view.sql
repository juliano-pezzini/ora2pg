-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_medica_v (nr_seq_conta, nr_seq_protocolo, nr_seq_segurado, ie_tipo_segurado, dt_mes_comp_protocolo, ie_sit_protocolo, vl_cobrado, cd_medico_executor, vl_total, vl_total_imp, vl_glosa, qt_ocorrencia, vl_contabil, vl_coparticipacao, vl_pendente, vl_liberado_sistema, vl_liberado_usuario, nr_seq_contrato, cd_estabelecimento) AS select  /*+ index(b PLSPRCO_I2) */	a.nr_sequencia nr_seq_conta,
	a.nr_seq_protocolo,
	a.nr_seq_segurado,
	a.ie_tipo_segurado,
	b.dt_mes_competencia dt_mes_comp_protocolo,
	b.ie_situacao ie_sit_protocolo,
	((  select  coalesce(sum(x.vl_procedimento_imp),0)
	FROM  pls_conta_proc  x
	where  x.nr_seq_conta = a.nr_sequencia
	and  ((x.ie_status <> 'D') or (x.ie_status is null))) +
	(  select  coalesce(sum(y.vl_material_imp),0)
	from  pls_conta_mat  y
	where  y.nr_seq_conta = a.nr_sequencia
	and  ((y.ie_status  <> 'D') or (y.ie_status is null)))) vl_cobrado,
	a.cd_medico_executor,
	coalesce(a.vl_total,0) vl_total,
	coalesce(a.vl_total_imp,0) vl_total_imp,
	coalesce(a.vl_glosa,0) vl_glosa,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'O'),0) qt_ocorrencia,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'CTB'),0) vl_contabil,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'CO'),0) vl_coparticipacao,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'P'),0) vl_pendente,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'LS'),0) vl_liberado_sistema,
	coalesce(pls_obter_valor_conta(a.nr_sequencia, 'LU'),0) vl_liberado_usuario,
	(select x.nr_seq_contrato
	from pls_segurado x
	where x.nr_sequencia = a.nr_seq_segurado) nr_seq_contrato,
	a.cd_estabelecimento
from  pls_protocolo_conta  b,
  pls_conta    a
where  b.ie_tipo_protocolo  in ('C','I')
and  a.nr_seq_protocolo  = b.nr_sequencia;

