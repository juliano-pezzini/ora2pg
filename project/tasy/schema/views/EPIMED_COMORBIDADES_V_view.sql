-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW epimed_comorbidades_v (visit_id, unitadmissiondatetime, comorbidity_id, comorbidity_code, comorbidity_value, comorbidity_site_code, comorbidity_site_value, updatetimestamp, updatetimestampfilter) AS SELECT a.NR_ATENDIMENTO VISIT_ID,
    TO_CHAR(obter_data_entrada_setor(a.nr_atendimento), 'YYYY-MM-DD"T"HH24:MI:SS."000"')unitadmissiondatetime,
    a.nr_sequencia comorbidity_id,
    (
    CASE
      WHEN a.nr_seq_hist_rotina =
        (SELECT c.nr_sequencia
        FROM historico_saude c
        WHERE c.nr_seq_grupo_hs IN (20)
        AND c.nr_sequencia       = a.nr_seq_hist_rotina
        )
      THEN (TO_CHAR(a.nr_seq_hist_rotina))::numeric
      WHEN a.nr_seq_hist_rotina =
        (SELECT c.nr_sequencia
        FROM historico_saude c
        WHERE c.nr_seq_grupo_hs IN (21)
        AND c.nr_sequencia       = a.nr_seq_hist_rotina
        )
      THEN (TO_CHAR('99901'))::numeric 
      WHEN a.nr_seq_hist_rotina =
        (SELECT c.nr_sequencia
        FROM historico_saude c
        WHERE c.nr_seq_grupo_hs IN (22)
        AND c.nr_sequencia       = a.nr_seq_hist_rotina
        )
      THEN (TO_CHAR('99902'))::numeric 
    END) comorbidity_code,
    (
    CASE
      WHEN A.DT_INATIVACAO IS NOT NULL
      THEN 'No'
      ELSE 'Yes'
    END)comorbidity_value,
    (
    CASE
      WHEN a.nr_seq_hist_rotina =
        (SELECT c.nr_sequencia
        FROM historico_saude c
        WHERE c.nr_seq_grupo_hs IN (21,22)
        AND c.nr_sequencia       = a.nr_seq_hist_rotina
        )
      THEN a.nr_seq_hist_rotina
      ELSE NULL
    END) comorbidity_site_code,
    (
    CASE
      WHEN a.nr_seq_hist_rotina =
        (SELECT c.nr_sequencia
        FROM historico_saude c
        WHERE c.nr_seq_grupo_hs IN (21,22)
        AND c.nr_sequencia       = a.nr_seq_hist_rotina
        )
      THEN 'Yes'
      ELSE 'No'
    END) comorbidity_site_value,
    TO_CHAR(a.dt_atualizacao, 'YYYY-MM-DD"T"HH24:MI:SS."000"') UPDATETIMESTAMP,
    to_date(a.dt_atualizacao) UPDATETIMESTAMPFILTER
  FROM PACIENTE_ANTEC_CLINICO a
  WHERE a.nr_seq_hist_rotina IS NOT NULL
  AND a.dt_liberacao         IS NOT NULL
  AND a.nr_seq_hist_rotina   IN (SELECT b.nr_sequencia
    FROM historico_saude b
    WHERE nr_seq_grupo_hs IN (20,21,22)
    AND b.nr_sequencia     = a.nr_seq_hist_rotina
    )
  AND obter_setor_atual_paciente(a.NR_ATENDIMENTO) IN (SELECT cd_setor_atendimento
    FROM SETOR_ATENDIMENTO
    WHERE IE_EPIMED = 'S'
    AND ie_situacao = 'A');

