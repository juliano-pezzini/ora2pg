-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW material_repasse_v (cd_conta_contabil, cd_medico, cd_regra, ds_observacao, dt_atualizacao, dt_atualizacao_nrec, dt_contabil, dt_contabil_titulo, dt_liberacao, ie_analisado, ie_desc_caixa, ie_estorno, ie_repasse_calc, ie_status, nm_usuario, nm_usuario_lib, nm_usuario_nrec, nr_interno_conta_est, nr_lote_contabil, nr_repasse_terceiro, nr_seq_criterio, nr_seq_item_retorno, nr_seq_material, nr_seq_motivo_des, nr_seq_origem, nr_seq_regra_item, nr_seq_ret_glosa, nr_seq_terceiro, nr_seq_trans_fin, nr_seq_trans_fin_rep_maior, nr_sequencia, vl_liberado, vl_original_repasse, vl_repasse, ds_regra, cd_material, ds_material, nr_atendimento, cd_paciente, nm_pessoa_fisica, ds_status, ds_transacao, ds_retorno, ds_convenio, nm_medico, nr_interno_conta, dt_conta, nr_protocolo, nr_seq_protocolo, ds_tipo_atendimento, nr_nota_fiscal, dt_mesano_protoc, dt_emissao_nota_fiscal, nr_seq_mat_crit_repasse, ds_centro_custo, nm_usuario_original, vl_perc_item_rep, ds_observacao_criterio, ds_categoria, nr_prescricao, ds_classif_atua_medico, vl_desp_cartao, ie_repasse_sem_conta) AS select	a.CD_CONTA_CONTABIL,
	a.CD_MEDICO, 
	a.CD_REGRA, 
	substr(a.DS_OBSERVACAO,1,255) ds_observacao, 
	a.DT_ATUALIZACAO, 
	a.DT_ATUALIZACAO_NREC, 
	a.DT_CONTABIL, 
	a.DT_CONTABIL_TITULO, 
	a.DT_LIBERACAO, 
	a.IE_ANALISADO, 
	a.IE_DESC_CAIXA, 
	a.IE_ESTORNO, 
	a.IE_REPASSE_CALC, 
	a.IE_STATUS, 
	a.NM_USUARIO, 
	a.NM_USUARIO_LIB, 
	a.NM_USUARIO_NREC, 
	a.NR_INTERNO_CONTA_EST, 
	a.NR_LOTE_CONTABIL, 
	a.NR_REPASSE_TERCEIRO, 
	a.NR_SEQ_CRITERIO, 
	a.NR_SEQ_ITEM_RETORNO, 
	a.NR_SEQ_MATERIAL, 
	a.NR_SEQ_MOTIVO_DES, 
	a.NR_SEQ_ORIGEM, 
	a.NR_SEQ_REGRA_ITEM, 
	a.NR_SEQ_RET_GLOSA, 
	a.NR_SEQ_TERCEIRO, 
	a.NR_SEQ_TRANS_FIN, 
	a.NR_SEQ_TRANS_FIN_REP_MAIOR, 
	a.NR_SEQUENCIA, 
	a.VL_LIBERADO, 
	a.VL_ORIGINAL_REPASSE, 
	a.VL_REPASSE, 
	a.ds_regra, 
	a.cd_material, 
	a.ds_material, 
	a.nr_atendimento, 
	a.cd_paciente, 
	a.nm_pessoa_fisica, 
	a.ds_status, 
	a.ds_transacao, 
	a.ds_retorno, 
	a.ds_convenio, 
	a.nm_medico, 
	a.nr_interno_conta, 
	a.dt_conta, 
	a.nr_protocolo, 
	a.nr_seq_protocolo, 
	a.ds_tipo_atendimento, 
	a.nr_nota_fiscal, 
	a.dt_mesano_protoc, 
	a.dt_emissao_nota_fiscal, 
	a.nr_seq_mat_crit_repasse, 
	a.ds_centro_custo, 
	a.NM_USUARIO_ORIGINAL, 
	a.vl_perc_item_rep, 
	a.ds_observacao_criterio, 
    a.ds_categoria, 
  a.nr_prescricao, 
  a.DS_CLASSIF_ATUA_MEDICO, 
  a.vl_desp_cartao, 
	a.ie_repasse_sem_conta 
FROM	(SELECT w.CD_CONTA_CONTABIL, 
		 w.CD_MEDICO, 
		 w.CD_REGRA, 
		 w.DS_OBSERVACAO, 
		 w.DT_ATUALIZACAO, 
		 w.DT_ATUALIZACAO_NREC, 
		 w.DT_CONTABIL, 
		 w.DT_CONTABIL_TITULO, 
		 w.DT_LIBERACAO, 
		 w.IE_ANALISADO, 
		 w.IE_DESC_CAIXA, 
		 w.IE_ESTORNO, 
		 w.IE_REPASSE_CALC, 
		 w.IE_STATUS, 
		 w.NM_USUARIO, 
		 w.NM_USUARIO_LIB, 
		 w.NM_USUARIO_NREC, 
		 w.NR_INTERNO_CONTA_EST, 
		 w.NR_LOTE_CONTABIL, 
		 w.NR_REPASSE_TERCEIRO, 
		 w.NR_SEQ_CRITERIO, 
		 w.NR_SEQ_ITEM_RETORNO, 
		 w.NR_SEQ_MATERIAL, 
		 w.NR_SEQ_MOTIVO_DES, 
		 w.NR_SEQ_ORIGEM, 
		 w.NR_SEQ_REGRA_ITEM, 
		 w.NR_SEQ_RET_GLOSA, 
		 w.NR_SEQ_TERCEIRO, 
		 w.NR_SEQ_TRANS_FIN, 
		 w.NR_SEQ_TRANS_FIN_REP_MAIOR, 
		 w.NR_SEQUENCIA, 
		 w.VL_LIBERADO, 
		 w.VL_ORIGINAL_REPASSE, 
		 w.VL_REPASSE, 
		 r.ds_regra, 
		 c.cd_material, 
		 c.ds_material, 
		 coalesce(d.nr_atendimento_mae,d.nr_atendimento) nr_atendimento, 
		 e.cd_pessoa_fisica cd_paciente, 
		 e.nm_pessoa_fisica, 
		 SUBSTR(obter_valor_dominio(1129, w.ie_status),1,50) ds_status, 
		 SUBSTR(obter_desc_trans_financ(w.nr_seq_trans_fin),1,100) ds_transacao, 
		 SUBSTR(obter_dados_retorno_convenio(w.nr_seq_item_retorno),1,100) ds_retorno, 
		 SUBSTR(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio, 
		 SUBSTR(obter_nome_pf_pj(w.cd_medico, NULL),1,100) nm_medico, 
		 b.nr_interno_conta, 
		 b.dt_conta, 
		 t.nr_protocolo, 
		 t.nr_seq_protocolo, 
		 SUBSTR(obter_nome_tipo_atend(d.ie_tipo_atendimento),1,80) ds_tipo_atendimento, 
		 substr(coalesce(obter_nf_conta(b.nr_interno_conta,9), coalesce(obter_nf_conta(b.nr_interno_conta,2),coalesce(obter_nf_conta(b.nr_interno_conta,3),obter_nf_conta(b.nr_interno_conta,10)))),1,50) nr_nota_fiscal, 
    trunc(to_date(substr(obter_dados_protocolo(t.nr_seq_protocolo,'DT'),1,10),'dd/mm/yy')) dt_mesano_protoc, 
		 substr(coalesce(obter_dt_emissao_nf(b.nr_interno_conta),obter_dados_nota_fiscal(coalesce(obter_nf_conta(b.nr_interno_conta,8), coalesce(obter_nf_conta(b.nr_interno_conta,1),obter_nf_conta(b.nr_interno_conta,4))),11)),1,50) dt_emissao_nota_fiscal, 
		 b.nr_seq_mat_crit_repasse, 
		   SUBSTR(obter_desc_centro_custo(u.cd_centro_custo),1,254) ds_centro_custo, 
		 b.NM_USUARIO_ORIGINAL, 
	   coalesce(obter_perc_item_repasse(w.nr_sequencia,w.nr_seq_terceiro,b.cd_material,null),0) vl_perc_item_rep, 
	   substr(( select max(x.ds_observacao) 
		    from mat_criterio_repasse x 
		    where x.nr_sequencia = coalesce(w.nr_seq_criterio,b.nr_seq_mat_crit_repasse)),1,255) ds_observacao_criterio, 
        substr(OBTER_CATEGORIA_CONVENIO(b.cd_convenio,Obter_Categoria_Atendimento(d.nr_atendimento)),1,255) ds_categoria, 
    b.nr_prescricao, 
    substr(obter_classif_atuacao_medico(d.nr_atendimento),1,60) DS_CLASSIF_ATUA_MEDICO, 
     w.vl_desp_cartao, 
    'N' ie_repasse_sem_conta 
	FROM  setor_atendimento u, 
		  Regra_Repasse_Terceiro r, 
	    pessoa_fisica e, 
	    material c, 
	    conta_paciente t, 
	    atendimento_paciente d, 
	    material_atend_paciente b, 
	    material_repasse w 
	WHERE u.cd_setor_atendimento = b.cd_setor_atendimento 
	 AND w.nr_seq_material    = b.nr_sequencia 
	 AND r.cd_regra       = w.cd_regra 
	 AND b.cd_material      = c.cd_material 
	 AND t.nr_interno_conta   = b.nr_interno_conta 
	 AND b.nr_atendimento    = d.nr_atendimento 
	 AND d.cd_pessoa_fisica   = e.cd_pessoa_fisica 
	 AND b.cd_motivo_exc_conta IS NULL 
	 
union
 
	SELECT  w.CD_CONTA_CONTABIL, 
		 w.CD_MEDICO, 
		 w.CD_REGRA, 
		 w.DS_OBSERVACAO, 
		 w.DT_ATUALIZACAO, 
		 w.DT_ATUALIZACAO_NREC, 
		 w.DT_CONTABIL, 
		 w.DT_CONTABIL_TITULO, 
		 w.DT_LIBERACAO, 
		 w.IE_ANALISADO, 
		 w.IE_DESC_CAIXA, 
		 w.IE_ESTORNO, 
		 w.IE_REPASSE_CALC, 
		 w.IE_STATUS, 
		 w.NM_USUARIO, 
		 w.NM_USUARIO_LIB, 
		 w.NM_USUARIO_NREC, 
		 w.NR_INTERNO_CONTA_EST, 
		 w.NR_LOTE_CONTABIL, 
		 w.NR_REPASSE_TERCEIRO, 
		 w.NR_SEQ_CRITERIO, 
		 w.NR_SEQ_ITEM_RETORNO, 
		 w.NR_SEQ_MATERIAL, 
		 w.NR_SEQ_MOTIVO_DES, 
		 w.NR_SEQ_ORIGEM, 
		 w.NR_SEQ_REGRA_ITEM, 
		 w.NR_SEQ_RET_GLOSA, 
		 w.NR_SEQ_TERCEIRO, 
		 w.NR_SEQ_TRANS_FIN, 
		 w.NR_SEQ_TRANS_FIN_REP_MAIOR, 
		 w.NR_SEQUENCIA, 
		 w.VL_LIBERADO, 
		 w.VL_ORIGINAL_REPASSE, 
		 w.VL_REPASSE, 
		 r.ds_regra, 
		 c.cd_material, 
		 c.ds_material, 
		 coalesce(d.nr_atendimento_mae,d.nr_atendimento) nr_atendimento, 
		 e.cd_pessoa_fisica cd_paciente, 
		 e.nm_pessoa_fisica, 
		 SUBSTR(obter_valor_dominio(1129, w.ie_status),1,50) ds_status, 
		 SUBSTR(obter_desc_trans_financ(w.nr_seq_trans_fin),1,100) ds_transacao, 
		 SUBSTR(obter_dados_retorno_convenio(w.nr_seq_item_retorno),1,100) ds_retorno, 
		 SUBSTR(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio, 
		 SUBSTR(obter_nome_pf_pj(w.cd_medico, NULL),1,100) nm_medico, 
		 b.nr_interno_conta, 
		 b.dt_conta, 
		 t.nr_protocolo, 
		 t.nr_seq_protocolo, 
		 SUBSTR(obter_nome_tipo_atend(d.ie_tipo_atendimento),1,80) ds_tipo_atendimento, 
		substr(coalesce(obter_nf_conta(b.nr_interno_conta,9), coalesce(obter_nf_conta(b.nr_interno_conta,2),coalesce(obter_nf_conta(b.nr_interno_conta,3),obter_nf_conta(b.nr_interno_conta,10)))),1,50) nr_nota_fiscal, 
    trunc(to_date(substr(obter_dados_protocolo(t.nr_seq_protocolo,'DT'),1,10),'dd/mm/yy')) dt_mesano_protoc, 
		 substr(coalesce(obter_dt_emissao_nf(b.nr_interno_conta),obter_dados_nota_fiscal(coalesce(obter_nf_conta(b.nr_interno_conta,8), coalesce(obter_nf_conta(b.nr_interno_conta,1),obter_nf_conta(b.nr_interno_conta,4))),11)),1,50) dt_emissao_nota_fiscal, 
		 b.nr_seq_mat_crit_repasse, 
		   SUBSTR(obter_desc_centro_custo(u.cd_centro_custo),1,254) ds_centro_custo, 
		 b.NM_USUARIO_ORIGINAL, 
	   coalesce(obter_perc_item_repasse(w.nr_sequencia,w.nr_seq_terceiro,b.cd_material,null),0) vl_perc_item_rep, 
	   substr(( select max(x.ds_observacao) 
		    from mat_criterio_repasse x 
		    where x.nr_sequencia = coalesce(w.nr_seq_criterio,b.nr_seq_mat_crit_repasse)),1,255) ds_observacao_criterio, 
        substr(OBTER_CATEGORIA_CONVENIO(b.cd_convenio,Obter_Categoria_Atendimento(d.nr_atendimento)),1,255) ds_categoria, 
    b.nr_prescricao, 
    substr(obter_classif_atuacao_medico(d.nr_atendimento),1,60) DS_CLASSIF_ATUA_MEDICO, 
     w.vl_desp_cartao, 
    'S' ie_repasse_sem_conta 
	FROM material_repasse w, setor_atendimento u, regra_repasse_terceiro r, pessoa_fisica e, atendimento_paciente d, material c, material_atend_paciente b
LEFT OUTER JOIN conta_paciente t ON (b.nr_interno_conta = t.nr_interno_conta)
WHERE u.cd_setor_atendimento = b.cd_setor_atendimento AND w.nr_seq_material    = b.nr_sequencia AND r.cd_regra       = w.cd_regra AND b.cd_material      = c.cd_material  AND b.nr_atendimento    = d.nr_atendimento AND d.cd_pessoa_fisica   = e.cd_pessoa_fisica AND b.cd_motivo_exc_conta IS NULL ) a;

