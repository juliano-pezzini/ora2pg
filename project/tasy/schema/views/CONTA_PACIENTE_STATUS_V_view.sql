-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_status_v (ie_origem_proced, cd_procedimento, cd_convenio, dt_mesano_referencia, ie_status_acerto, nr_seq_protocolo, nr_atendimento, nr_interno_conta, ie_cancelamento, ie_status, nm_paciente, cd_setor_receita, cd_setor_atendimento, cd_conta_contabil, cd_especialidade, nr_seq_grupo_rec, cd_estrutura_conta, nr_seq_proc_interno, qt_resumo, vl_medico, vl_anestesista, vl_auxiliares, vl_custo_operacional, vl_materiais, vl_procedimento, vl_matmed, vl_custo, vl_medico_fora_conta, vl_sadt_fora_conta, vl_repasse_terceiro, ie_proc_mat, ie_classif, vl_material, vl_medicamento, vl_proced, vl_proced_hosp, vl_servico, qt_exame, nr_diarias, vl_medicos, vl_diaria, vl_hospital, vl_total_receita, ie_tipo_convenio, ds_convenio, ds_setor_receita, ie_tipo_atendimento, dt_alta, dt_entrada, nr_seq_conta_origem, cd_estabelecimento, ie_clinica, ds_clinica, dt_item, cd_estab_conta, cd_categoria, ds_categoria, cd_pessoa_fisica, nr_seq_classificacao, nr_seq_proc_pacote, qt_exclusao_conta, cd_material, nr_cirurgia, cd_medico_cirurgiao, ie_carater_cirurgia, dt_alta_tiss, ie_responsavel_credito, cd_procedencia, cd_cgc_prestador, ie_idade) AS select	b.ie_origem_proced,
	b.cd_procedimento,	 
	a.cd_convenio_parametro cd_convenio, 
	a.dt_mesano_referencia, 
	a.ie_status_acerto, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	a.nr_interno_conta, 
	a.ie_cancelamento, 
	obter_status_conta_protocolo(a.nr_interno_conta, a.ie_status_acerto, a.nr_seq_protocolo) ie_status, 
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,40) nm_paciente, 
	b.cd_setor_receita, 
	b.cd_setor_atendimento, 
   	b.cd_conta_contabil, 
   	b.cd_especialidade, 
	b.nr_seq_grupo_rec, 
	b.cd_estrutura_conta, 
	b.nr_seq_proc_interno, 
	coalesce(b.qt_resumo,0) qt_resumo, 
	coalesce(b.vl_medico,0) vl_medico, 
	coalesce(b.vl_anestesista,0) vl_anestesista, 
	coalesce(b.vl_auxiliares,0) vl_auxiliares, 
	coalesce(b.vl_custo_operacional,0) vl_custo_operacional, 
	coalesce(b.vl_materiais,0) vl_materiais, 
	coalesce(b.vl_procedimento,0) vl_procedimento, 
	coalesce(b.vl_material,0) vl_matmed, 
	coalesce(b.vl_custo,0) vl_custo, 
	coalesce(b.vl_medico_fora_conta,0) vl_medico_fora_conta, 
	coalesce(b.vl_sadt_fora_conta,0) vl_sadt_fora_conta, 
	coalesce(b.vl_repasse_terceiro,0) vl_repasse_terceiro, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN 2  ELSE 1 END  ie_proc_mat, 
	substr(obter_classif_material_proced(b.cd_material, b.cd_procedimento, b.ie_origem_proced),1,1) ie_classif, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN  		CASE WHEN substr( 			obter_classif_material_proced(b.cd_material, 								b.cd_procedimento, 								b.ie_origem_proced),1,1)='1' THEN coalesce(b.vl_material,0)  ELSE 0 END   ELSE 0 END  vl_material, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN  		CASE WHEN substr( 			obter_classif_material_proced(b.cd_material, 								b.cd_procedimento, 								b.ie_origem_proced),1,1)='1' THEN 0  ELSE coalesce(b.vl_material,0) END   ELSE 0 END  vl_medicamento, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN 0  ELSE CASE WHEN substr( 			obter_classif_material_proced(b.cd_material, 								b.cd_procedimento, 								b.ie_origem_proced),1,1)='1' THEN coalesce(b.vl_procedimento,0)  ELSE 0 END  END  vl_proced, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN 0  ELSE CASE WHEN substr( 			obter_classif_material_proced(b.cd_material, 								b.cd_procedimento, 								b.ie_origem_proced),1,1)='1' THEN (b.vl_materiais + b.vl_custo_operacional)  ELSE 0 END  END  vl_proced_hosp, 
	CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN 0  ELSE CASE WHEN substr( 			obter_classif_material_proced(b.cd_material, 								b.cd_procedimento, 								b.ie_origem_proced),1,1)='2' THEN coalesce(b.vl_procedimento,0)  ELSE 0 END  END  vl_servico, 
	CASE WHEN f.cd_classif_setor=5 THEN CASE WHEN coalesce(b.cd_procedimento,0)=0 THEN 0  ELSE b.qt_resumo END   ELSE 0 END  qt_exame, 
	CASE WHEN b.ie_diaria='S' THEN b.qt_resumo  ELSE 0 END  nr_diarias, 
	(b.vl_medico + b.vl_anestesista + b.vl_auxiliares) vl_medicos, 
	CASE WHEN b.ie_diaria='S' THEN b.vl_procedimento  ELSE 0 END  vl_diaria, 
	(b.vl_materiais + b.vl_custo_operacional + b.vl_material) vl_hospital, 
	(b.vl_procedimento + b.vl_material) vl_total_receita, 
	d.ie_tipo_convenio, 
	d.ds_convenio, 
	f.ds_setor_atendimento ds_setor_receita, 
	g.ie_tipo_atendimento, 
	g.dt_alta, 
	g.dt_entrada, 
	a.nr_seq_conta_origem, 
	g.cd_estabelecimento, 
	g.IE_CLINICA, 
	substr(obter_valor_dominio(17, g.IE_CLINICa),1,100) ds_clinica, 
	b.dt_referencia dt_item, 
	a.cd_estabelecimento cd_estab_conta, 
	a.cd_categoria_parametro cd_categoria, 
	substr(obter_categoria_convenio(a.cd_convenio_parametro,a.cd_categoria_parametro),1,50) ds_categoria, 
	g.cd_pessoa_fisica, 
	g.NR_SEQ_CLASSIFICACAO, 
	b.nr_seq_proc_pacote, 
	coalesce(b.qt_exclusao_conta,0) qt_exclusao_conta, 
	b.cd_material, 
	b.nr_cirugia nr_cirurgia, 
	obter_dados_cirurgia(b.nr_cirugia, 'MC') cd_medico_cirurgiao, 
	obter_dados_cirurgia(b.nr_cirugia, 'CR') ie_carater_cirurgia, 
	a.dt_alta_tiss, 
	b.ie_responsavel_credito, 
	g.cd_procedencia, 
	b.cd_cgc_prestador, 
	Obter_Idade(c.dt_nascimento,LOCALTIMESTAMP,'A') ie_idade 
FROM	setor_atendimento f, 
	convenio d, 
	atendimento_paciente g, 
	conta_paciente_resumo b, 
	conta_paciente a, 
	pessoa_fisica c 
where	a.nr_interno_conta = b.nr_interno_conta 
and	g.cd_pessoa_fisica = c.cd_pessoa_fisica 
and	a.cd_convenio_parametro = d.cd_convenio 
and	b.cd_setor_receita = f.cd_setor_atendimento 
and	a.nr_atendimento = g.nr_atendimento;

