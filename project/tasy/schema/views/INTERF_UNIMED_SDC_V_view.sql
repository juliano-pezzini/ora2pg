-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_unimed_sdc_v (ie_tipo_registro, nr_sequencia, dt_remessa, nr_seq_protocolo, nr_interno_conta, cd_interno, cd_regional, nr_lote, cd_senha_guia, nr_doc_convenio, ie_tipo_documento, dt_emissao, dt_entrada, dt_alta, hr_entrada, hr_alta, cd_usuario_convenio, nm_usuario_convenio, uf_medico_solicitante, cd_medico_solicitante, cd_doenca_def, cd_motivo_alta, ie_carater_internacao, cd_procedimento_princ, cd_tipo_acomodacao, ie_clinica, cd_tipo_plano, dt_procedimento, hr_procedimento, ie_cirurgia_video, cd_medico_executor, ie_funcao_executor, cd_item, ie_cirurgia_multipla, ie_tipo_nascimento, ie_sexo, dt_nascimento, dt_mesano_referencia, ie_tipo_paciente, qt_item, vl_item, qt_filme, vl_filme, vl_custo_operacional, vl_medico, ds_zeros, ds_espaco, tp_obito, tp_transferencia, cd_cid_principal) AS SELECT	
	1 ie_tipo_registro, 
	0 nr_sequencia, 
	c.dt_remessa, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
 	a.cd_interno,            
 	c.cd_regional,        
	'001'||to_char(c.dt_remessa,'YYMM') nr_lote, 
 	somente_numero(substr(b.cd_senha_guia,1,7)) cd_senha_guia, 
   somente_numero(substr(b.nr_doc_convenio,1,7)) nr_doc_convenio, 
 	a.ie_tipo_atendimento ie_tipo_documento, 
 	a.dt_entrada dt_emissao, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'ddmmyyyy')  ELSE '00000000' END  dt_entrada,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy')  ELSE '00000000' END  dt_alta,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	CASE WHEN a.dt_entrada IS NULL THEN  '0000'  ELSE to_char(a.dt_entrada,'hh24mi') END    ELSE '0000' END  hr_entrada,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi')  ELSE '0000' END  hr_alta,          
 	somente_numero(substr(a.cd_usuario_convenio,1,15)) cd_usuario_convenio,       
 	substr(a.nm_paciente,1,25) nm_usuario_convenio,      
 	a.uf_crm_medico_resp uf_medico_solicitante,    
	a.NR_CRM_MEDICO_RESP cd_medico_solicitante,    
 	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END  cd_doenca_def, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN  		CASE WHEN e.ie_obito='S' THEN 0  ELSE CASE WHEN e.ie_transferencia='S' THEN 0  ELSE a.cd_motivo_alta END  END   ELSE 0 END  cd_motivo_alta, 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END  ie_carater_internacao, 
 	a.cd_proc_principal cd_procedimento_princ, 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END  cd_tipo_acomodacao, 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,0)  ELSE null END  ie_clinica,           
 	a.cd_categoria_convenio cd_tipo_plano, 
	CASE WHEN b.cd_medico_executor IS NULL THEN trunc(a.dt_entrada,'dd')  ELSE trunc(b.dt_item,'dd') END  dt_procedimento, 
	CASE WHEN b.cd_medico_executor IS NULL THEN to_char(a.dt_entrada,'hh24mi')  ELSE to_char(b.dt_item,'hh24mi') END  hr_procedimento, 
 	b.ie_video ie_cirurgia_video, 
	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN  		b.cd_interno  ELSE b.cd_medico_exec_conv END  cd_medico_executor ,            
--	decode(a.ie_tipo_atendimento,1,	nvl(b.cd_funcao_executor,0),0) ie_funcao_executor,            
	coalesce(b.cd_funcao_executor,0) ie_funcao_executor,            
 	b.cd_item_convenio cd_item, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END  ie_cirurgia_multipla,           
 	a.ie_tipo_nascimento, 
 	a.ie_sexo,                  
 	a.dt_nascimento,      
	d.dt_mesano_referencia, 
	1 ie_tipo_paciente,         
 	CASE WHEN b.cd_item_convenio=9905010 THEN  1  ELSE CASE WHEN b.cd_item_convenio=9905011 THEN  1  ELSE sum(qt_item) END  END  qt_item, 
 	sum(CASE WHEN b.cd_area_proc=1 THEN b.vl_honorario  ELSE (CASE WHEN b.cd_area_proc=4 THEN b.vl_honorario  ELSE b.vl_total_item END ) END ) vl_item, 
	sum(b.qt_filme) qt_filme,                 
 	sum(b.vl_filme) vl_filme,                 
 	sum(b.vl_custo_oper) vl_custo_operacional, 
 	sum(vl_honorario) vl_medico,                 
 	'00000000000000000000000000000000000000000000' ds_zeros, 
	'                      ' ds_espaco, 
	CASE WHEN e.ie_obito='S' THEN 2  ELSE 0 END  tp_obito, 
	CASE WHEN e.ie_transferencia='S' THEN 8  ELSE 0 END  tp_transferencia, 
	a.cd_cid_principal 
FROM protocolo_convenio d, w_interf_conta_header c, w_interf_conta_item b, w_interf_conta_cab a
LEFT OUTER JOIN motivo_alta e ON (a.cd_motivo_alta = e.cd_motivo_alta)
WHERE a.nr_interno_conta	= b.nr_interno_conta and a.nr_seq_protocolo	= d.nr_seq_protocolo and a.nr_seq_protocolo	= c.nr_seq_protocolo  group by 
	c.dt_remessa, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
 	a.cd_interno,            
 	c.cd_regional,   
	coalesce(b.cd_funcao_executor,0) ,     
	a.cd_cid_principal, 
	'001'||to_char(c.dt_remessa,'YYMM'), 
 	somente_numero(substr(b.cd_senha_guia,1,7)), 
   somente_numero(substr(b.nr_doc_convenio,1,7)), 
 	a.ie_tipo_atendimento, 
 	a.dt_entrada, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'ddmmyyyy')  ELSE '00000000' END ,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy')  ELSE '00000000' END ,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'hh24mi')  ELSE '0000' END ,           
	CASE WHEN a.ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi')  ELSE '0000' END ,          
 	somente_numero(substr(a.cd_usuario_convenio,1,15)),       
 	substr(a.nm_paciente,1,25),      
 	a.uf_crm_medico_resp,    
	a.NR_CRM_MEDICO_RESP,    
 	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END , 
	CASE WHEN a.ie_tipo_atendimento=1 THEN  		CASE WHEN e.ie_obito='S' THEN 0  ELSE CASE WHEN e.ie_transferencia='S' THEN 0  ELSE a.cd_motivo_alta END  END   ELSE 0 END , 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END , 
 	a.cd_proc_principal, 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END , 
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,0)  ELSE null END ,           
 	a.cd_categoria_convenio, 
	CASE WHEN b.cd_medico_executor IS NULL THEN trunc(a.dt_entrada,'dd')  ELSE trunc(b.dt_item,'dd') END , 
	CASE WHEN b.cd_medico_executor IS NULL THEN to_char(a.dt_entrada,'hh24mi')  ELSE to_char(b.dt_item,'hh24mi') END , 
 	b.ie_video, 
	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN  		b.cd_interno  ELSE b.cd_medico_exec_conv END ,            
	CASE WHEN a.ie_tipo_atendimento=1 THEN 	coalesce(b.cd_funcao_executor,0)  ELSE 0 END ,            
 	b.cd_item_convenio, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END ,           
 	a.ie_tipo_nascimento, 
 	a.ie_sexo,                  
 	a.dt_nascimento,      
	d.dt_mesano_referencia, 
	CASE WHEN e.ie_obito='S' THEN 2  ELSE 0 END , 
	CASE WHEN e.ie_transferencia='S' THEN 8  ELSE 0 END 	 

union all
 
SELECT	 
	9 ie_tipo_registro, 
	0, 
	LOCALTIMESTAMP, 
	nr_seq_protocolo, 
	0, 
 	'',            
 	'',        
	'', 
 	0, 
   0, 
 	0, 
 	LOCALTIMESTAMP, 
	'', 
	'', 
	'', 
	'', 
 	0,       
 	'',      
 	'',    
	'',    
 	'', 
	0, 
 	'', 
 	'', 
 	0, 
 	0,           
 	'', 
	LOCALTIMESTAMP, 
	'', 
 	'', 
	'', 
	0,            
 	'', 
	'',           
 	'', 
 	'',                  
 	LOCALTIMESTAMP,      
	LOCALTIMESTAMP, 
	0,         
 	0, 
 	0,                
	0,                 
 	0,                 
 	0, 
 	0, 
 	'', 
	'', 
	0, 
	0, 
	'' 
from	w_interf_conta_Trailler;

