-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfst_prefeitura_blu_v (tp_registro, cd_cpf_cnpj_prest, nr_inscricao_municipal, cd_estabelecimento, ie_tipo_nota, cd_municipio_prestador, nr_nota_fiscal, cd_serie_nf, es_documento_tipo, dt_emissao, dt_emissao_nf, cd_natureza_operacao, cd_regime_especial_tributacao, sn_optante_simples_nacional, ie_status, outras_informacoes, es_item_lista_servico, vl_servicos, vl_deducao, sn_iss_retido, vl_iss, vl_iss_retido, vl_outras_retencoes, vl_base_calculo, vl_aliquota, pre_cd_cpf_cnpj_tipo, cd_cgc_emitente, pre_inscricao_municipal, pre_razao_social, pre_endereco, pre_endereco_numero, pre_endereco_complemento, pre_endereco_bairro, pre_endereco_uf, pre_endereco_cep, pre_endereco_es_municipio, pre_telefone, pre_email, recolhimento_es_municipio, recolhimento_uf, sn_iss_tributavel, fim_linha) AS select	1					tp_registro,
	a.cd_cgc	cd_cpf_cnpj_prest,
	a.cd_inscricao_municipal		nr_inscricao_municipal,
	a.cd_estabelecimento,
	'A' ie_tipo_nota,
	nfse_obter_dados_pf_pj(null, a.cd_cgc, 'CDMDV') cd_municipio_prestador,
	'' nr_nota_fiscal,
	'' cd_serie_nf,
	null es_documento_tipo,
	null dt_emissao,
	'' dt_emissao_nf,
	'' cd_natureza_operacao,
	'' cd_regime_especial_tributacao,
	null sn_optante_simples_nacional,
	'' ie_status,
	' ' outras_informacoes,
	'' es_item_lista_servico,
	null vl_servicos, 
	'' vl_deducao,
	'' sn_iss_retido,
	'' vl_iss,
	'' vl_iss_retido,
	'' vl_outras_retencoes,
	'' vl_base_calculo,  
	'' vl_aliquota,
	'' pre_cd_cpf_cnpj_tipo,
	'' cd_cgc_emitente,
	'' pre_inscricao_municipal,
	'' pre_razao_social,
	'' pre_endereco,
	'' pre_endereco_numero,
	'' pre_endereco_complemento,
	'' pre_endereco_bairro,
	'' pre_endereco_uf,
	null pre_endereco_cep,
	'' pre_endereco_es_municipio,
	' ' pre_telefone,
	'' pre_email,
	'' recolhimento_es_municipio,
	'' recolhimento_uf,
	'' sn_iss_tributavel,
  '|' fim_linha
FROM	estabelecimento a

union all

select	2					tp_registro,
	null		cd_cpf_cnpj_prest,
	null		nr_inscricao_municipal,
	a.cd_estabelecimento,
	'A' ie_tipo_nota,
	nfse_obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV') cd_municipio_prestador,
	a.nr_nota_fiscal,
	a.cd_serie_nf,
	1 es_documento_tipo,
	dt_emissao, 
	to_char(dt_emissao, 'yyyy-mm-dd') || 'T' || to_char(dt_emissao, 'hh:mi:ss') dt_emissao_nf,
  CASE WHEN obter_se_nf_ret_iss(nr_sequencia)='S' THEN  '1'  ELSE '2' END  cd_natureza_operacao,
	obter_dados_compl_pf_pj(a.cd_cgc, null, 'ICT') cd_regime_especial_tributacao,
	CASE WHEN coalesce(nfse_obter_regra('OSN', cd_estabelecimento), 'N')='N' THEN  2  ELSE 1 END  sn_optante_simples_nacional,
	CASE WHEN a.ie_situacao='1' THEN  '1' WHEN a.ie_situacao='2' THEN  '1' WHEN a.ie_situacao='8' THEN  '1'  ELSE '2' END  ie_status,
	'' outras_informacoes,
	obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'I') es_item_lista_servico,
  campo_mascara(vl_mercadoria, 2) vl_servicos, 
	'0.00' vl_deducao,
	CASE WHEN CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS')=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'V', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS') END =0 THEN  '2'  ELSE '1' END  sn_iss_retido,
	campo_mascara(CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS')=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'V', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS') END ,2) vl_iss,
	campo_mascara(coalesce(CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS')=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'V', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS') END , 0), 2) vl_iss_retido,
	(select  campo_mascara(coalesce(sum(CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'V', ie_tipo_tributo)=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, ie_tipo_tributo, 'V', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'V', ie_tipo_tributo) END ),0),2)
   from   	tributo t,
            nota_fiscal_trib n
   where    t.cd_tributo = n.cd_tributo
   and n.nr_sequencia = a.nr_sequencia
   and ie_tipo_tributo <> 'ISS') as vl_outras_retencoes,
	campo_mascara(CASE WHEN CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'B', 'ISS')=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'B', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'B', 'ISS') END =0 THEN  vl_mercadoria  ELSE CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'B', 'ISS')=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'B', 'S')  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'B', 'ISS') END  END , 2) vl_base_calculo,  
	campo_mascara(CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS')/100=0 THEN  obter_valor_trib_nota_item(nr_sequencia, null, 'ISS', 'X', 'S')/100  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS')/100 END , 4) vl_aliquota,
	CASE WHEN cd_pessoa_fisica IS NULL THEN  '2'  ELSE '1' END  pre_cd_cpf_cnpj_tipo,
	a.cd_cgc_emitente,
	nfse_obter_dados_pf_pj(null, a.cd_cgc_emitente, 'IM') pre_inscricao_municipal,
	substr(elimina_caractere_especial(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc_emitente)), 1, 255) pre_razao_social,
	substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'EN'))), 1, 255) pre_endereco,
	substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'NR'), 1, 25) pre_endereco_numero,
	substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CO'))), 1, 255) pre_endereco_complemento,
	substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'B'))), 1, 255) pre_endereco_bairro,
	CASE WHEN substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'UF'), 1, 2)='IN' THEN  'EX'  ELSE substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'UF'), 1, 2) END  pre_endereco_uf,
	lpad(somente_numero(substr(CASE WHEN obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'UF')='IN' THEN  '99999999'  ELSE obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CEP') END , 1, 8)), 8, 0) pre_endereco_cep,
	LPAD(substr(CASE WHEN obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'UF')='IN' THEN  '99999'  ELSE CASE WHEN cd_cgc IS NULL THEN  obter_compl_pf(cd_pessoa_fisica, 1, 'CDMDV')  ELSE nfe_obter_dados_pj(cd_cgc, 'IBGE') END  END , 1, 60), 7, '0') pre_endereco_es_municipio,
	'' pre_telefone,
	CASE WHEN cd_pessoa_fisica='' THEN  		coalesce(substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj_estab(cd_estabelecimento, '', cd_cgc, 'M'))), 1, 80), '')  ELSE coalesce(substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica, '', 'M'))), 1, 80), '') END  pre_email,
	CASE WHEN obter_se_nf_ret_iss(a.nr_sequencia)='S' THEN  nfse_obter_dados_pf_pj(a.cd_pessoa_fisica, obter_cgc_estabelecimento(a.cd_estabelecimento), 'CDMDV')  ELSE nfse_obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV') END  recolhimento_es_municipio,
	CASE WHEN obter_se_nf_ret_iss(a.nr_sequencia)='S' THEN  nfse_obter_dados_pf_pj(a.cd_pessoa_fisica, obter_cgc_estabelecimento(a.cd_estabelecimento), 'UF')  ELSE nfse_obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'UF') END  recolhimento_uf,
	'1' sn_iss_tributavel,
  '|' fim_linha
from		nota_fiscal a,
			operacao_nota o
where	obter_se_nota_entrada_saida(a.nr_sequencia) = 'E'
and		o.cd_operacao_nf = a.cd_operacao_nf
and		o.ie_nf_eletronica = 'S'
and		o.ie_servico = 'S'
and   a.ie_situacao = 1
and	exists (
	select	1
	from	w_nota_fiscal x
	where	x.nr_seq_nota_fiscal = a.nr_sequencia)
  and   nfse_obter_dados_pf_pj(null, a.cd_cgc_emitente, 'CDMDV') != 4202404;

