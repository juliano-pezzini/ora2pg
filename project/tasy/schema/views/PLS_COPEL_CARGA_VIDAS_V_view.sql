-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_copel_carga_vidas_v (nr_seq_lote, convenio, client_id, group_id, cd_usuario_plano, person_code, status, ie_sexo, tipo_participacao, dt_inicio_vigencia, eli_type, dt_fim_vigencia, sobrenome, nome, endereco, complemento, cidade, estado, cep, categoria_segurado, pais, dt_nascimento, telefone, aniversary_date, cd_carteira_titular, primary_care_physician, transaction_code, cpf, copay_override_flag, copay_override, primary_cov, blank1, blank2, blank3, misc_grouping_1, misc_grouping_2, misc_id, user_defined_code_1, user_defined_code_2, blank4, blank5, miscellaneout_data, eligibility_validation_id, pharmacy_nabp, codigo_banco, codigo_agencia, numero_conta_corrente, identificador_ativo, email, ddd) AS select  a.nr_seq_lote,
	rpad('CT000175', 10, ' ') convenio,
	rpad((	select 	nfe_elimina_caractere_especial(substr(max(x.nm_fantasia), 1, 15))
		FROM 	pessoa_juridica x,
			pls_contrato	y
		where 	x.cd_cgc = y.cd_cgc_estipulante
		and     y.nr_sequencia = g.nr_seq_contrato	), 15, ' ') client_id,
	rpad((	select 	nfe_elimina_caractere_especial(substr(max(x.ds_nome_abrev), 1, 15))
		from 	pessoa_juridica x,
			pls_contrato	y
		where 	x.cd_cgc = y.cd_cgc_estipulante
		and     y.nr_sequencia = g.nr_seq_contrato	), 15, ' ') group_id,
	rpad(substr(h.cd_usuario_plano, 1, 18), 18, ' ') cd_usuario_plano,
        '001' 	person_code,
	'A' 	status,
	substr(i.ie_sexo, 1, 1) ie_sexo,
	CASE WHEN g.nr_seq_titular IS NULL THEN  1  ELSE 4 END  tipo_participacao,
	lpad(to_char(d.dt_inicio_vigencia, 'YYYYMMDD'), 8, ' ') 	dt_inicio_vigencia,
	'1' eli_type,
	lpad(coalesce(to_char(pls_obter_dt_limite_depend(g.nr_sequencia), 'YYYYMMDD'), '21991231'), 8, ' ') 	dt_fim_vigencia,
	substr(rpad(coalesce(nfe_elimina_caractere_especial(Obter_Nome_Sobrenome_Pessoa(i.cd_pessoa_fisica, 'SC')), ' '), 20, ' '), 1, 20) sobrenome,
	substr(rpad(coalesce(nfe_elimina_caractere_especial(Obter_Nome_Sobrenome_Pessoa(i.cd_pessoa_fisica, 'P')), ' '), 20, ' '), 1, 20) nome,
	substr(rpad(coalesce(nfe_elimina_caractere_especial(obter_endereco_cobr_pf_pj(i.cd_pessoa_fisica, null, 'EN')), ' '), 30, ' '), 1, 30) endereco,
	substr(rpad(coalesce(nfe_elimina_caractere_especial(obter_endereco_cobr_pf_pj(i.cd_pessoa_fisica, null, 'COMPL')), ' '), 25, ' '), 1, 25) complemento,
	substr(rpad(coalesce(nfe_elimina_caractere_especial(obter_endereco_cobr_pf_pj(i.cd_pessoa_fisica, null, 'M')), ' '), 20, ' '), 1, 20) cidade,
	substr(rpad(coalesce(obter_endereco_cobr_pf_pj(i.cd_pessoa_fisica, null, 'ES'), ' '), 2, ' '), 1, 2) estado,
	substr(rpad(coalesce(obter_endereco_cobr_pf_pj(i.cd_pessoa_fisica, null, 'C'), ' '), 10, ' '), 1, 10) cep,
	rpad(upper(CASE WHEN g.ie_situacao_trabalhista IS NULL THEN  'ATIVO'  ELSE obter_valor_dominio(3840, g.ie_situacao_trabalhista) END ), 20, ' ')  categoria_segurado,
	lpad(' ', 15, ' ') pais,
	lpad(to_char(i.dt_nascimento, 'YYYYMMDD'), 8, ' ') 	dt_nascimento,
	rpad(coalesce(obter_Telefone_PF(i.cd_pessoa_fisica, 9), ' '), 13, ' ') telefone,
	lpad('0', 8, 0) aniversary_date,
	rpad(pls_obter_carteira_segurado(coalesce(g.nr_seq_titular , g.nr_sequencia)), 18, ' ') cd_carteira_titular,
	lpad(' ', 10, ' ') primary_care_physician,
	'A' 	transaction_code,
	rpad(coalesce(CASE WHEN g.nr_seq_titular IS NULL THEN  i.nr_cpf  ELSE (	select 	x.nr_cpf								from 	pessoa_fisica x,									pls_segurado y								where	y.cd_pessoa_fisica = x.cd_pessoa_fisica								and	y.nr_sequencia = g.nr_seq_titular) END , ' '), 18, ' ') cpf,
	lpad(' ', 1, ' ') copay_override_flag,
	lpad(' ', 10, ' ') copay_override,
	lpad(' ', 15, ' ') primary_cov,
	lpad(' ', 10, ' ') blank1,
	lpad('0', 8, 0)    blank2,
	lpad('0', 8, 0)    blank3,
	lpad(' ', 10, ' ')   misc_grouping_1,
	lpad('0', 10, 0)   misc_grouping_2,
	lpad('0', 12, 0)   misc_id,
	lpad(' ', 2, ' ')  user_defined_code_1,
	lpad(' ', 4, ' ')  user_defined_code_2,
	lpad(' ', 1, ' ')  blank4,
	lpad(' ', 7, ' ')  blank5,
	lpad(' ', 30, ' ') miscellaneout_data,
	lpad(' ', 10, ' ') eligibility_validation_id,
	lpad('9', 12, 9)   pharmacy_nabp,
	rpad(coalesce((pls_obter_conta_titular(CASE WHEN g.nr_seq_titular IS NULL THEN  g.nr_sequencia  ELSE g.nr_seq_titular END , 'CB')), ' '), 3, ' ')  codigo_banco,
	rpad(coalesce((pls_obter_conta_titular(CASE WHEN g.nr_seq_titular IS NULL THEN  g.nr_sequencia  ELSE g.nr_seq_titular END , 'CA')), ' '), 7, ' ')  codigo_agencia,
	rpad(coalesce((pls_obter_conta_titular(CASE WHEN g.nr_seq_titular IS NULL THEN  g.nr_sequencia  ELSE g.nr_seq_titular END , 'NC')), ' '), 15, ' ')  numero_conta_corrente,
	CASE WHEN g.ie_situacao_trabalhista IS NULL THEN  '1'  ELSE CASE WHEN obter_valor_dominio(3840, g.ie_situacao_trabalhista)='A' THEN  '2'  ELSE '1' END  END  identificador_ativo,
	rpad(pls_obter_dados_segurado(g.nr_sequencia, 'E'), 50, ' ')  email,
	lpad(' ', 2, ' ')  ddd
from    pls_repasse_sca_fornecedor      a,
	pls_repasse_sca_plano        	b,
	pls_repasse_sca_benef        	c,
	pls_sca_vinculo            	d,
	pls_plano_fornecedor        	f,
	pls_segurado              	g,
	pls_segurado_carteira        	h,
	pessoa_fisica          		i
where   a.nr_sequencia            = b.nr_seq_repasse_fornecedor 
and    	b.nr_sequencia            = c.nr_seq_repasse_plano 
and    	d.nr_seq_segurado         = c.nr_seq_segurado 
and    	d.nr_seq_plano            = b.nr_seq_sca
and    	f.nr_seq_plano            = b.nr_seq_sca
and    	f.nr_seq_prestador        = a.nr_seq_prestador
and    	c.nr_seq_segurado         = g.nr_sequencia
and    	g.nr_sequencia            = h.nr_seq_segurado
and    	d.dt_liberacao            is not null
and    	d.nr_seq_segurado         is not null
and    	f.nr_seq_prestador        is not null
and    	g.cd_pessoa_fisica        = i.cd_pessoa_fisica;

