-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW integr_gerdau_nf_entrada_v (tp_registro, dt_emissao, cd_estabelecimento, vl_registro) AS select	1	tp_registro,
	n.dt_emissao, 
	n.cd_estabelecimento, 
	'GG  ' 											|| 
	'FOB  ' 											|| 
	'FOB  ' 											|| 
	'L' || rpad(n.nr_sequencia, 7, ' ')								|| 
	rpad(obter_dados_natureza_operacao(n.cd_natureza_operacao, 'CF'), 4, ' ')				|| 
	rpad(n.nr_nota_fiscal, 10, ' ')									|| 
	rpad(n.cd_serie_nf, 3, ' ')									|| 
	'  ' 											|| 
	rpad(n.cd_cgc_emitente, 20, ' ') 								|| 
	to_char(n.dt_entrada_saida, 'ddmmyyyy')								|| 
	to_char(n.dt_entrada_saida, 'ddmmyyyy')								|| 
	to_char(n.dt_emissao, 'ddmmyyyy')								|| 
	rpad('1', 3, ' ')										|| 
	'I'											|| 
	CASE WHEN t.ie_tipo_frete='F' THEN  'FOB' WHEN t.ie_tipo_frete='C' THEN  'CIF'  ELSE '  ' END  							|| 
	'N'											|| 
	'N'											|| 
	'S'											|| 
	'N'											|| 
	'N'											|| 
	'N' 											|| 
	lpad(replace(campo_mascara(obter_valor_tipo_trib_item_nf(n.nr_sequencia, null, 'ICMS'), 2),'.',''),15, 0)	|| 
	lpad(replace(campo_mascara(obter_vl_total_trib_nota(n.nr_sequencia, 'ICMS'),2),'.',''),15, 0)			|| 
	lpad(replace(campo_mascara(obter_valor_tipo_trib_item_nf(n.nr_sequencia, null, 'ICMSST'), 2),'.',''),15, 0) 	|| 
	lpad(replace(campo_mascara(obter_vl_total_trib_nota(n.nr_sequencia, 'ICMSST'),2),'.',''),15, 0)		|| 
	(select	lpad(count(*), 6, 0) FROM nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia) 		|| 
	lpad(replace(campo_mascara(n.vl_mercadoria,2),'.',''),15, 0)						|| 
	lpad(replace(campo_mascara(n.vl_frete,2),'.',''),15, 0)						|| 
	lpad(replace(campo_mascara(n.vl_seguro,2),'.',''),15, 0)						|| 
	lpad(replace(campo_mascara(n.vl_despesa_acessoria,2),'.',''),15, 0)					|| 
	lpad(replace(campo_mascara(obter_vl_total_trib_nota(n.nr_sequencia, 'IPI'),2),'.',''),15, 0)			|| 
	'000000000000000'										|| 
	lpad(replace(campo_mascara(n.vl_total_nota,2),'.',''),15, 0)						|| 
	'000000'											|| 
	'000000'											|| 
	CASE WHEN n.ie_situacao=1 THEN  '01' WHEN n.ie_situacao=8 THEN  '01'  ELSE '02' END  							|| 
	'EXTRATOR '										|| 
	to_char(LOCALTIMESTAMP, 'ddmmyyyy')									|| 
	to_char(LOCALTIMESTAMP, 'hhMMss')									|| 
	' ' 											|| 
	'000000000000000' 									|| 
	'000000000000000'										|| 
	'000000000000000'										|| 
	'000000000000000'										|| 
	'L' || rpad(n.nr_sequencia, 9, ' ')								|| 
	'000000000000000'										|| 
	'  '											|| 
	lpad(replace(campo_mascara(coalesce(t.qt_peso_liquido,0),3),'.',''),15, 0)					|| 
	lpad(replace(campo_mascara(coalesce(t.qt_peso_bruto,0),3),'.',''),15, 0)					|| 
	'NF '											|| 
	rpad(coalesce(t.cd_cnpj, ' '),16, ' ')									|| 
	rpad(CASE WHEN coalesce(t.qt_volume, 0)=0 THEN  ' '  ELSE t.qt_volume END , 5, ' ')						|| 
	rpad(coalesce(t.nr_placa_veiculo, ' '), 20, ' ')								|| 
	rpad(coalesce(t.ds_especie, ' '), 3, ' ')								|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'N'), ' '), 70, ' ')					|| 
	coalesce(n.cd_cgc_emitente, '       ')								|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'IE'), ' '), 20, ' ')					|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'E'), ' '), 35, ' ') 					|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'B'), ' '), 35, ' ')					|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CI'), ' '), 35, ' ')					|| 
	rpad(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CEP'), ' '), 10, ' ')					|| 
	'2 '											|| 
	CASE WHEN obter_dados_pf_pj(null, n.cd_cgc_emitente, 'UF')='IN' THEN  'EX'  ELSE obter_dados_pf_pj(null, n.cd_cgc_emitente, 'UF') END  || 
	rpad(coalesce(obter_dados_pais(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'P'), 'SG'), ' '), 3, ' ') 			|| 
	' '											|| 
	'000000000000000'										|| 
	'000000000000000'										|| 
	'000000000000000'										|| 
	'000000000000000'										|| 
	'  '											|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'N'), ' '), 70, ' ')						|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'IE'), ' '), 20, ' ')						|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'E'), ' '), 35, ' ') 						|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'B'), ' '), 35, ' ')						|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'CI'), ' '), 35, ' ')						|| 
	rpad(coalesce(obter_dados_pf_pj(null, t.cd_cnpj, 'CEP'), ' '), 10, ' ')						|| 
	CASE WHEN obter_dados_pf_pj(null, t.cd_cnpj, 'UF')='IN' THEN  'EX'  ELSE obter_dados_pf_pj(null, t.cd_cnpj, 'UF') END  		|| 		 
	rpad(coalesce(obter_dados_pais(obter_dados_pf_pj(null, t.cd_cnpj, 'P'), 'SG'), ' '), 3, ' ') 				|| 
	'N'											|| 
	'R'											|| 
	'RODO'											|| 
	'F'											|| 
	rpad(' ', 74, ' ')										|| 
	CASE WHEN nr_danfe IS NULL THEN  'N'  ELSE 'S' END 									|| 
	CASE WHEN obter_dados_nota_fiscal(n.nr_sequencia, 28)=1 THEN  '1'  ELSE '2' END  					|| 
	'      '											|| 
	'      '											|| 
	'N'											|| 
	rpad(' ', 657, ' ') 										|| 
	'00'											|| 
	rpad(' ', 38, ' ')										|| 
	'000000000000000'										|| 
	t.uf_placa_veiculo										|| 
	'        '										|| 
	rpad('0', 105, '0')										|| 
	rpad(' ', 105, ' ')										|| 
	'*' vl_registro 
FROM nota_fiscal n
LEFT OUTER JOIN nota_fiscal_transportadora t ON (n.nr_sequencia = t.nr_sequencia)
WHERE obter_se_nota_entrada_saida(n.nr_sequencia) = 'E';

