-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sus_ato_medico_v (ie_medico, dt_mesano_referencia, nr_seq_protocolo, cd_convenio_parametro, nr_atendimento, dt_entrada, dt_alta, cd_pessoa_fisica, cd_convenio, cd_setor_atendimento, cd_setor_receita, ie_classif_sus, ie_tipo_servico_sus, ie_tipo_ato_sus, cd_procedimento, dt_procedimento, ie_origem_proced, cd_cgc_cpf, ds_medico, nr_crm, qt_ato, vl_ato, vl_procedimento, cd_medico, nr_aih, dt_competencia, ie_cancelamento) AS select 1 ie_medico,
	 d.dt_mesano_referencia,
	d.nr_seq_protocolo,
	d.cd_convenio_parametro,
	e.nr_atendimento,
	e.dt_entrada,
	e.dt_alta,
	e.cd_pessoa_fisica,
	b.cd_convenio,
	b.cd_setor_atendimento,
	b.cd_setor_receita,
	b.ie_classif_sus,
	b.ie_tipo_servico_sus,
	b.ie_tipo_ato_sus,
	b.cd_procedimento,
	b.dt_procedimento,
	b.ie_origem_proced,
	a.nr_cpf cd_cgc_cpf,
      coalesce(a.nm_pessoa_fisica, 'Médico não Cadastrado') ds_medico,
	m.nr_crm,
      sum(CASE WHEN b.ie_tipo_ato_sus=6 THEN c.qt_ato_anestesista  ELSE c.qt_ato_medico END ) qt_ato,
	sum(Sus_Obter_Valor_Rateio_Medico(b.nr_sequencia)) vl_ato,
/*	sum(decode(b.cd_procedimento,95005013,c.vl_medico,99800179,b.vl_materiais,b.vl_medico)) vl_ato,*/

	sum(b.vl_procedimento) vl_procedimento,
	b.cd_medico_executor cd_medico,
	b.nr_aih,
	trunc(d.dt_mesano_referencia,'month') dt_competencia,
	d.ie_cancelamento
FROM atendimento_paciente e, conta_paciente d, sus_valor_proc_paciente c, procedimento_paciente b
LEFT OUTER JOIN pessoa_fisica a ON (b.cd_medico_executor = a.cd_pessoa_fisica)
LEFT OUTER JOIN medico m ON (b.cd_medico_executor = m.cd_pessoa_fisica)
WHERE d.nr_interno_conta = b.nr_interno_conta and b.nr_sequencia = c.nr_sequencia and d.nr_atendimento = e.nr_atendimento   and b.cd_motivo_exc_conta is null and e.ie_tipo_convenio = 3 and e.ie_tipo_atendimento = 1 and b.ie_tipo_servico_sus <> 8 group by 1, d.dt_mesano_referencia,
	d.nr_seq_protocolo,
	d.cd_convenio_parametro,
	e.nr_atendimento,
	e.dt_entrada,
	e.dt_alta,
	e.cd_pessoa_fisica,
	b.cd_convenio,
	b.cd_setor_atendimento,
	b.cd_setor_receita,
	b.ie_classif_sus,
	b.ie_tipo_servico_sus,
	b.ie_tipo_ato_sus,
	b.cd_procedimento,
	b.dt_procedimento,
	b.ie_origem_proced,
	a.nr_cpf,
      coalesce(a.nm_pessoa_fisica, 'Médico não Cadastrado'),
	m.nr_crm,
	b.cd_medico_executor,
	b.nr_aih,
	trunc(d.dt_mesano_referencia,'month'),
	d.ie_cancelamento

union

select 1 ie_medico,
	d.dt_mesano_referencia,
	d.nr_seq_protocolo,
	d.cd_convenio_parametro,
	e.nr_atendimento,
	e.dt_entrada,
	e.dt_alta,
	e.cd_pessoa_fisica,
	b.cd_convenio,
	b.cd_setor_atendimento,
	b.cd_setor_receita,
	b.ie_classif_sus,
	c.ie_tipo_servico_sus,
	c.ie_tipo_ato_sus,
	b.cd_procedimento,
	b.dt_procedimento,
	b.ie_origem_proced,
	a.nr_cpf cd_cgc_cpf,
      coalesce(a.nm_pessoa_fisica, 'Médico não Cadastrado') ds_medico,
	m.nr_crm,
      sum(c.qt_ponto_sus) qt_ato,
	sum(c.vl_participante) vl_ato,
	sum(b.vl_procedimento) vl_procedimento,
	c.cd_pessoa_fisica cd_medico,
	b.nr_aih,
	trunc(d.dt_mesano_referencia,'month') dt_competencia,
	d.ie_cancelamento
FROM atendimento_paciente e, conta_paciente d, procedimento_paciente b, procedimento_participante c
LEFT OUTER JOIN pessoa_fisica a ON (c.cd_pessoa_fisica = a.cd_pessoa_fisica)
LEFT OUTER JOIN medico m ON (c.cd_pessoa_fisica = m.cd_pessoa_fisica)
WHERE d.nr_interno_conta = b.nr_interno_conta and b.nr_sequencia = c.nr_sequencia and b.cd_motivo_exc_conta is null and d.nr_atendimento = e.nr_atendimento   and e.ie_tipo_convenio = 3 and e.ie_tipo_atendimento = 1 group by 1, d.dt_mesano_referencia,
	d.nr_seq_protocolo,
	d.cd_convenio_parametro,
	e.nr_atendimento,
	e.dt_entrada,
	e.dt_alta,
	e.cd_pessoa_fisica,
	b.cd_convenio,
	b.cd_setor_atendimento,
	b.cd_setor_receita,
	b.ie_classif_sus,
	c.ie_tipo_servico_sus,
	c.ie_tipo_ato_sus,
	b.cd_procedimento,
	b.dt_procedimento,
	b.ie_origem_proced,
	a.nr_cpf,
      coalesce(a.nm_pessoa_fisica, 'Médico não Cadastrado'),
	m.nr_crm,
      c.cd_pessoa_fisica,
	b.nr_aih,
	trunc(d.dt_mesano_referencia,'month'),
	d.ie_cancelamento;

