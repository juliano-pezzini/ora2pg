-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW w_media_permanencia_v (ie_tipo_convenio, cd_estabelecimento, dt_ano, ds_ano, ie_periodo, vl_janeiro, vl_fevereiro, vl_marco, vl_abril, vl_maio, vl_junho, vl_julho, vl_agosto, vl_setembro, vl_outubro, vl_novembro, vl_dezembro, vl_media_anual) AS select	a.ie_tipo_convenio,
	a.cd_estabelecimento,
	trunc(a.dt_referencia, 'yyyy') dt_ano,
	to_char(a.dt_referencia, 'yyyy') ds_ano,
	a.ie_periodo,
	sum(CASE WHEN a.ie_periodo='M' THEN  CASE WHEN to_char(a.dt_referencia, 'mm')='01' THEN  a.vl_indicador  ELSE 0 END   ELSE 0 END ) vl_janeiro,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='02' THEN  a.vl_indicador  ELSE 0 END ) vl_fevereiro,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='03' THEN  a.vl_indicador  ELSE 0 END ) vl_marco,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='04' THEN  a.vl_indicador  ELSE 0 END ) vl_abril,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='05' THEN  a.vl_indicador  ELSE 0 END ) vl_maio,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='06' THEN  a.vl_indicador  ELSE 0 END ) vl_junho,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='07' THEN  a.vl_indicador  ELSE 0 END ) vl_julho,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='08' THEN  a.vl_indicador  ELSE 0 END ) vl_agosto,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='09' THEN  a.vl_indicador  ELSE 0 END ) vl_setembro,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='10' THEN  a.vl_indicador  ELSE 0 END ) vl_outubro,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='11' THEN  a.vl_indicador  ELSE 0 END ) vl_novembro,
	sum(CASE WHEN to_char(a.dt_referencia, 'mm')='12' THEN  a.vl_indicador  ELSE 0 END ) vl_dezembro,
	max(w_media_permancia_resumo(a.ie_tipo_convenio, a.cd_estabelecimento, trunc(dt_referencia, 'year'))) vl_media_anual
FROM	w_media_permanencia a
group by a.ie_tipo_convenio,
	a.cd_estabelecimento,
	a.ie_periodo,
	trunc(a.dt_referencia, 'yyyy'),
	to_char(a.dt_referencia, 'yyyy');

