-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW w_eis_upp_prevalencia_v (nr_atendimento, dt_evento, cd_setor_atendimento, ds_setor, ds_unidade, qt_ponto, ds_risco, qt_evento, nr_sequencia) AS SELECT DISTINCT b.nr_atendimento
	,b.dt_evento 
	,c.cd_setor_atendimento 
	,substr(obter_ds_descricao_setor(c.cd_setor_atendimento), 1, 255) ds_setor 
	,obter_unidade_atendimento(b.nr_atendimento, 'A', 'U') ds_unidade 
	,d.qt_ponto 
	,substr(obter_resultado_braden(d.qt_ponto), 1, 100) ds_risco 
	,obter_qt_evento_UPP(b.nr_sequencia) qt_evento 
	,b.nr_sequencia 
FROM atend_escala_braden d, qua_evento_paciente b
LEFT OUTER JOIN cur_ferida c ON (b.nr_sequencia = c.nr_seq_evento)
WHERE c.dt_inativacao IS NULL AND b.nr_atendimento = d.nr_atendimento AND d.nr_sequencia = ( 
		SELECT max(e.nr_sequencia) 
		FROM atend_escala_braden e 
		WHERE e.nr_atendimento = d.nr_atendimento 
			AND trunc(e.dt_avaliacao) <= trunc(c.dt_atualizacao) 
		) AND trunc(c.dt_atualizacao) >= trunc(d.dt_avaliacao);

