-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sus_valor_aih_v (nr_seq_protocolo, nr_interno_conta, ie_cancelamento, nr_atendimento, cd_pessoa_fisica, ds_procedimento, qt_dia_internacao_sus, qt_diaria, qt_dias_internacao, qt_diferenca, cd_medico_atendimento, nm_medico, vl_receita, vl_gasto, vl_diferenca) AS select a.nr_seq_protocolo,
	a.nr_interno_conta, 
	a.ie_cancelamento, 
	d.nr_atendimento, 
	d.cd_pessoa_fisica, 
	e.ds_procedimento, 
	e.qt_dia_internacao_sus, 
	sum(CASE WHEN r.ie_diaria='S' THEN r.qt_resumo   ELSE 0 END ) qt_diaria, 
	coalesce(((d.dt_alta - d.dt_entrada) + 1),0) qt_dias_internacao, 
	(coalesce(((d.dt_alta - d.dt_entrada) + 1),0) - e.qt_dia_internacao_sus) qt_diferenca, 
	coalesce(d.cd_medico_atendimento,d.cd_medico_resp) cd_medico_atendimento, 
	substr(obter_nome_medico(coalesce(d.cd_medico_atendimento,cd_medico_resp), 'N'),1,80) nm_medico, 
	sum((r.vl_procedimento - (r.vl_medico + r.vl_anestesista + r.vl_auxiliares))) vl_receita, 
	sum(r.vl_custo) vl_gasto, 
	sum(((r.vl_procedimento - (r.vl_medico + r.vl_anestesista + r.vl_auxiliares)) - r.vl_custo)) vl_diferenca 
FROM 	procedimento e, 
	sus_aih b, 
	atendimento_paciente d,   
	conta_paciente_resumo r, 
	conta_paciente a 
where 	a.nr_atendimento 		= d.nr_atendimento   
and 	a.nr_interno_conta		= b.nr_interno_conta 
and 	b.cd_procedimento_solic 	= e.cd_procedimento  
and 	b.ie_origem_proced 		= e.ie_origem_proced   
and 	a.nr_interno_conta 		= r.nr_interno_conta  
group by a.nr_seq_protocolo, 
	d.nr_atendimento, 
	a.nr_interno_conta, 
	a.ie_cancelamento, 
	d.cd_pessoa_fisica, 
	e.ds_procedimento, 
	e.qt_dia_internacao_sus, 
	coalesce(((d.dt_alta - d.dt_entrada) + 1),0), 
	(coalesce(((d.dt_alta - d.dt_entrada) + 1),0) - e.qt_dia_internacao_sus),	 
	coalesce(d.cd_medico_atendimento,d.cd_medico_resp), 
	substr(obter_nome_medico(coalesce(d.cd_medico_atendimento,cd_medico_resp), 'N'),1,80);

