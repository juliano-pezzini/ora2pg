-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cirurgia_v (nr_cirurgia, cd_pessoa_fisica, cd_medico_cirurgiao, cd_procedimento_princ, cd_tipo_anestesia, nm_usuario, dt_atualizacao, dt_inicio_prevista, dt_inicio_real, nr_min_duracao_prev, nr_min_duracao_real, dt_termino, nr_prescricao, nr_atendimento, dt_entrada_unidade, cd_medico_anestesista, cd_convenio, ds_observacao, ie_origem_proced, ie_status_cirurgia, ie_motivo_cancelamento, ie_carater_cirurgia, cd_tipo_cirurgia, ie_anat_patol, ie_trauma, ie_ortese_protese, ie_antibiotico, ie_sangue, ds_antibiotico, cd_setor_atendimento, dt_termino_prevista, nr_seq_status, dt_entrada_recup, dt_saida_recup_prev, dt_saida_recup, ds_andamento, dt_chamada, dt_preparacao, dt_chegada_sala, dt_chegada_anestesista, dt_inicio_anestesia, dt_chegada_cirurgiao, dt_inicio_cirurgia, dt_fim_cirurgia, dt_fim_extubacao, dt_liberacao_sala, ie_asa_estado_paciente, cd_medico_req, ie_leito_uti, ie_peca_anat_patol, dt_chegada_srpa, dt_entr_matmed, nm_usuario_matmed, dt_saida_sala, cd_estabelecimento, dt_fim_anestesia, ie_porte, ie_lado, nr_seq_proc_interno, qt_ric, dt_lib_niss, ie_infeccao, dt_infeccao, nr_seq_proced_niss, dt_liberacao, nm_usuario_lib, qt_peso, nr_seq_interrupcao, ie_sitio_infeccao, ie_controla_peso, ie_tipo_cirurgia, ie_reoperacao, dt_cancelamento, dt_lanc_automatico, nr_seq_sitio_princ, nr_seq_sitio_espec, nr_cirurgia_superior, ie_via_acesso, nr_seq_pepo, nr_seq_via, nr_seq_agenda, ie_avaliacao_pre, nr_seq_motivo_reop, cd_categoria, ie_integracao_opme, dt_liberacao_anestesista, nm_usuario_lib_anest, dt_desfeita_lib, ds_justificativa_asa, dt_fim_conferencia, nm_usuario_fim_conferencia, dt_bloqueio_faturamento, nm_usuario_bloqueio_fat, nm_usuario_antibiotico, dt_interrupcao, nr_seq_motivo, ie_video, ie_finalidade, nm_usuario_video, nr_seq_transplante, ds_just_troca_proced, cd_procedimento_tuss, nr_prescricao_espec, ie_nivel_atencao, ds_utc, ds_utc_atualizacao, ie_horario_verao, ie_equip_verificado, ds_convenio, ds_procedimento, nm_cirurgiao, nm_paciente, nm_anestesista, dt_nascimento, nr_prontuario, ie_sexo, nr_telefone_celular, ds_tipo_anestesia, idade, dt_parametro, qt_jan, qt_fev, qt_mar, qt_abr, qt_mai, qt_jun, qt_jul, qt_ago, qt_set, qt_out, qt_nov, qt_dez, qt_ano, qt_anos, ds_ano_cirurgia, ds_setor_atendimento, cd_especialidade_cirurgiao, ds_especialidade_cirurgiao, ds_tipo_acomodacao, cd_tipo_acomodacao, ie_cirurgiao_corpo_clinico, ie_cirurgiao_funcionario, ie_tipo_atendimento, qt_porte, ds_porte, ds_carater, ds_tipo_cirurgia, ds_tipo_convenio, ds_tipo_atendimento, nr_seq_tipo_acidente) AS SELECT		A.NR_CIRURGIA,A.CD_PESSOA_FISICA,A.CD_MEDICO_CIRURGIAO,A.CD_PROCEDIMENTO_PRINC,A.CD_TIPO_ANESTESIA,A.NM_USUARIO,A.DT_ATUALIZACAO,A.DT_INICIO_PREVISTA,A.DT_INICIO_REAL,A.NR_MIN_DURACAO_PREV,A.NR_MIN_DURACAO_REAL,A.DT_TERMINO,A.NR_PRESCRICAO,A.NR_ATENDIMENTO,A.DT_ENTRADA_UNIDADE,A.CD_MEDICO_ANESTESISTA,A.CD_CONVENIO,A.DS_OBSERVACAO,A.IE_ORIGEM_PROCED,A.IE_STATUS_CIRURGIA,A.IE_MOTIVO_CANCELAMENTO,A.IE_CARATER_CIRURGIA,A.CD_TIPO_CIRURGIA,A.IE_ANAT_PATOL,A.IE_TRAUMA,A.IE_ORTESE_PROTESE,A.IE_ANTIBIOTICO,A.IE_SANGUE,A.DS_ANTIBIOTICO,A.CD_SETOR_ATENDIMENTO,A.DT_TERMINO_PREVISTA,A.NR_SEQ_STATUS,A.DT_ENTRADA_RECUP,A.DT_SAIDA_RECUP_PREV,A.DT_SAIDA_RECUP,A.DS_ANDAMENTO,A.DT_CHAMADA,A.DT_PREPARACAO,A.DT_CHEGADA_SALA,A.DT_CHEGADA_ANESTESISTA,A.DT_INICIO_ANESTESIA,A.DT_CHEGADA_CIRURGIAO,A.DT_INICIO_CIRURGIA,A.DT_FIM_CIRURGIA,A.DT_FIM_EXTUBACAO,A.DT_LIBERACAO_SALA,A.IE_ASA_ESTADO_PACIENTE,A.CD_MEDICO_REQ,A.IE_LEITO_UTI,A.IE_PECA_ANAT_PATOL,A.DT_CHEGADA_SRPA,A.DT_ENTR_MATMED,A.NM_USUARIO_MATMED,A.DT_SAIDA_SALA,A.CD_ESTABELECIMENTO,A.DT_FIM_ANESTESIA,A.IE_PORTE,A.IE_LADO,A.NR_SEQ_PROC_INTERNO,A.QT_RIC,A.DT_LIB_NISS,A.IE_INFECCAO,A.DT_INFECCAO,A.NR_SEQ_PROCED_NISS,A.DT_LIBERACAO,A.NM_USUARIO_LIB,A.QT_PESO,A.NR_SEQ_INTERRUPCAO,A.IE_SITIO_INFECCAO,A.IE_CONTROLA_PESO,A.IE_TIPO_CIRURGIA,A.IE_REOPERACAO,A.DT_CANCELAMENTO,A.DT_LANC_AUTOMATICO,A.NR_SEQ_SITIO_PRINC,A.NR_SEQ_SITIO_ESPEC,A.NR_CIRURGIA_SUPERIOR,A.IE_VIA_ACESSO,A.NR_SEQ_PEPO,A.NR_SEQ_VIA,A.NR_SEQ_AGENDA,A.IE_AVALIACAO_PRE,A.NR_SEQ_MOTIVO_REOP,A.CD_CATEGORIA,A.IE_INTEGRACAO_OPME,A.DT_LIBERACAO_ANESTESISTA,A.NM_USUARIO_LIB_ANEST,A.DT_DESFEITA_LIB,A.DS_JUSTIFICATIVA_ASA,A.DT_FIM_CONFERENCIA,A.NM_USUARIO_FIM_CONFERENCIA,A.DT_BLOQUEIO_FATURAMENTO,A.NM_USUARIO_BLOQUEIO_FAT,A.NM_USUARIO_ANTIBIOTICO,A.DT_INTERRUPCAO,A.NR_SEQ_MOTIVO,A.IE_VIDEO,A.IE_FINALIDADE,A.NM_USUARIO_VIDEO,A.NR_SEQ_TRANSPLANTE,A.DS_JUST_TROCA_PROCED,A.CD_PROCEDIMENTO_TUSS,A.NR_PRESCRICAO_ESPEC,A.IE_NIVEL_ATENCAO,A.DS_UTC,A.DS_UTC_ATUALIZACAO,A.IE_HORARIO_VERAO,A.IE_EQUIP_VERIFICADO,
       		C.DS_CONVENIO,
       		R.DS_PROCEDIMENTO,
      		M.NM_PESSOA_FISICA NM_CIRURGIAO,
       		P.NM_PESSOA_FISICA NM_PACIENTE,
       		T.NM_PESSOA_FISICA NM_ANESTESISTA,
       		P.DT_NASCIMENTO,
		coalesce(obter_prontuario_pf(coalesce(A.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento), P.cd_pessoa_fisica), P.NR_PRONTUARIO) NR_PRONTUARIO,
		P.IE_SEXO,
		P.NR_TELEFONE_CELULAR,
       		E.DS_TIPO_ANESTESIA,
		trunc((LOCALTIMESTAMP - P.DT_NASCIMENTO)/365) IDADE,
       		trunc(A.DT_INICIO_REAL, 'DD') DT_PARAMETRO,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='01' THEN 1  ELSE 0 END  qt_jan,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='02' THEN 1  ELSE 0 END  qt_fev,
	      	CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='03' THEN 1  ELSE 0 END  qt_Mar,
  	      	CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='04' THEN 1  ELSE 0 END  qt_Abr,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='05' THEN 1  ELSE 0 END  qt_Mai,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='06' THEN 1  ELSE 0 END  qt_Jun,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='07' THEN 1  ELSE 0 END  qt_Jul,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='08' THEN 1  ELSE 0 END  qt_Ago,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='09' THEN 1  ELSE 0 END  qt_Set,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='10' THEN 1  ELSE 0 END  qt_Out,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='11' THEN 1  ELSE 0 END  qt_Nov,
		CASE WHEN to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'MM')='12' THEN 1  ELSE 0 END  qt_dez,
		1 qt_ano,
		substr(obter_idade(P.dt_nascimento, LOCALTIMESTAMP, 'A'),1,3) qt_anos,
		substr(to_char(coalesce(A.dt_inicio_real, A.dt_inicio_prevista),'yyyy'),1,4) ds_ano_cirurgia,
		s.ds_setor_atendimento,
		substr(obter_especialidade_medico(A.CD_MEDICO_CIRURGIAO,'C'),1,40) CD_ESPECIALIDADE_CIRURGIAO,
		substr(obter_especialidade_medico(A.CD_MEDICO_CIRURGIAO,'D'),1,40) DS_ESPECIALIDADE_CIRURGIAO,
		substr(obter_unidade_atendimento(A.nr_atendimento, 'A', 'DTA'),1,40) ds_tipo_acomodacao,
		obter_unidade_atendimento(A.nr_atendimento, 'A', 'CTA') cd_tipo_acomodacao,
		substr(obter_se_medico(A.CD_MEDICO_CIRURGIAO,'C'),1,1) ie_cirurgiao_corpo_clinico,
		substr(obter_se_medico(A.CD_MEDICO_CIRURGIAO,'F'),1,1) ie_cirurgiao_funcionario,
		obter_tipo_atendimento(A.nr_atendimento) ie_tipo_atendimento,
		OBTER_PORTE_PROC_CIRURGIA(A.nr_cirurgia, null) qt_porte,
		substr(obter_valor_dominio(1901, ie_porte),1,200) ds_porte,
		substr(obter_valor_dominio(1016, ie_carater_cirurgia),1,200) ds_carater,
		substr(obter_desc_tipo_cirurgia(A.cd_tipo_cirurgia),1,80) ds_tipo_cirurgia,
		substr(obter_desc_tipo_convenio(A.cd_convenio),1,80) ds_tipo_convenio,
		substr(Obter_Dados_Atendimento(A.nr_atendimento,'DTA'),1,80) ds_tipo_atendimento,
		(obter_dados_atendimento(A.nr_atendimento, 'ACI'))::numeric  nr_seq_tipo_acidente
FROM procedimento r, pessoa_fisica p, pessoa_fisica m, cirurgia a
LEFT OUTER JOIN pessoa_fisica t ON (A.CD_MEDICO_ANESTESISTA = T.CD_PESSOA_FISICA)
LEFT OUTER JOIN convenio c ON (A.CD_CONVENIO = C.CD_CONVENIO)
LEFT OUTER JOIN tipo_anestesia_v e ON (A.CD_TIPO_ANESTESIA = E.CD_TIPO_ANESTESIA)
LEFT OUTER JOIN setor_atendimento s ON (A.cd_setor_atendimento = s.cd_setor_atendimento)
WHERE A.CD_PESSOA_FISICA      	= P.CD_PESSOA_FISICA  AND A.CD_MEDICO_CIRURGIAO   	= M.CD_PESSOA_FISICA  AND A.CD_PROCEDIMENTO_PRINC 	= R.CD_PROCEDIMENTO AND A.IE_ORIGEM_PROCED		= R.IE_ORIGEM_PROCED;

