-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW medicus_interf_v (tp_registro, cd_prestador_cab, cd_tipo_documento_cab, cd_letra_documento_cab, nr_sucursal_cab, nr_documento_cab, dt_ano_emissao, dt_mes_emissao, dt_dia_emissao, ds_filler_cab0, cd_sigla_moeda, vl_protocolo, vl_importe_exento, vl_importe_ib, vl_importe_total_cab, vl_importe_iva_cab, ds_filler_cab_1, cd_registro_arquivo_cab, cd_prestador_det, cd_tipo_documento_det, cd_letra_documento_det, nr_sucursal_det, nr_documento_det, cd_tipo_convenio, ds_medicard_paciente, nm_medico_solicitante, cd_tipo_medico_solicitante, nr_mat_medico_solicitante, cd_cid_principal, nr_ordem_int_medicus, nr_ordem_amb_medicus, cd_prestacao, ano_prestacao, mes_prestacao, dia_prestacao, ds_item, qt_item, vl_unitario_item, cd_importe_total, vl_importe_total, cd_importe_honorario, vl_honorarios, cd_importe_sadt, vl_sadt, cd_marca_guardia, cd_marca_urgencia, ano_entrada, mes_entrada, dia_entrada, hr_entrada, min_entrada, ano_alta, mes_alta, dia_alta, hr_alta, min_alta, ds_prestacion, cd_modulo, is_primeira_vez, is_medicus, cd_importe_iva, vl_importe_iva_det, ds_filler_det_1, cd_registro_arquivo_det, cd_classe_solicitante, cd_provincia_solicitante, cd_matricula_realizador, nr_mat_medico_realizador, cd_classe_realizador, cd_provincia_realizador, nr_codigo_instituicao, ds_filler_det_2, nr_seq_protocolo, nr_interno_conta) AS SELECT	1 TP_REGISTRO,
		LPAD(A.CD_INTERNO, 8, 0) CD_PRESTADOR_CAB,
        CASE WHEN A.IE_TIPO_ATENDIMENTO=1 THEN  'FPI'  ELSE 'FPA' END  CD_TIPO_DOCUMENTO_CAB,
        LPAD(( select substr(y.CD_SISTEMA_EXT,1, 1)
                FROM nota_fiscal x,
                     natureza_operacao y
                where x.nr_seq_protocolo = a.nr_seq_protocolo
                and y.cd_natureza_operacao = x.cd_natureza_operacao ), 1, ' ') CD_LETRA_DOCUMENTO_CAB,
        LPAD(coalesce((select substr(x.NR_NFE_IMP,1, 4) from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 0), 4, 0) NR_SUCURSAL_CAB,
        LPAD(coalesce((select substr(x.NR_NFE_IMP,length(x.NR_NFE_IMP)-8, length(x.NR_NFE_IMP)) from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 'F'), 8, ' ') NR_DOCUMENTO_CAB,
        RPAD((select to_char(max(dt_emissao),'YYYY') from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 4, ' ') DT_ANO_EMISSAO,
        RPAD((select to_char(max(dt_emissao),'MM') from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 2, ' ') DT_MES_EMISSAO,
        RPAD((select to_char(max(dt_emissao),'DD') from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 2, ' ') DT_DIA_EMISSAO,
        LPAD('', 8, 0) DS_FILLER_CAB0,
        LPAD(CASE WHEN B.DS_SIGLA_MOEDA='ARS' THEN  '01'  ELSE '02' END  , 2, 0) CD_SIGLA_MOEDA,
        LPAD(SUM(C.VL_TOTAL_CONTA), 15, 0) VL_PROTOCOLO,
        LPAD(SUM(0), 15, 0) VL_IMPORTE_EXENTO,
        LPAD(SUM(0), 15, 0) VL_IMPORTE_IB,
        LPAD(SUM(C.VL_TOTAL_CONTA), 15, 0) VL_IMPORTE_TOTAL_CAB,
        LPAD(SUM(0), 15, 0) VL_IMPORTE_IVA_CAB,
        RPAD('', 182, ' ') DS_FILLER_CAB_1,
		1 CD_REGISTRO_ARQUIVO_CAB,
		'' CD_PRESTADOR_DET,
		'' CD_TIPO_DOCUMENTO_DET,
		'' CD_LETRA_DOCUMENTO_DET,
        LPAD(0, 4, 0) NR_SUCURSAL_DET,
        LPAD(0, 8, 0) NR_DOCUMENTO_DET,
        RPAD(0, 2, ' ') CD_TIPO_CONVENIO,
		'' DS_MEDICARD_PACIENTE,
		'' NM_MEDICO_SOLICITANTE,
		'' CD_TIPO_MEDICO_SOLICITANTE,
		'' NR_MAT_MEDICO_SOLICITANTE,
		'' CD_CID_PRINCIPAL,
		'' NR_ORDEM_INT_MEDICUS,
		'' NR_ORDEM_AMB_MEDICUS,
		RPAD(0, 9, ' ') CD_PRESTACAO,
		NULL ANO_PRESTACAO,
		NULL MES_PRESTACAO,
		NULL DIA_PRESTACAO,
		'' DS_ITEM,
		LPAD(0, 15, 0)QT_ITEM,
		LPAD(0, 7, 0) VL_UNITARIO_ITEM,
		'' CD_IMPORTE_TOTAL,
		LPAD(0, 14, 0) VL_IMPORTE_TOTAL,
		'' CD_IMPORTE_HONORARIO,
		RPAD(C.VL_HONORARIOS, 14, ' ') VL_HONORARIOS,
		'' CD_IMPORTE_SADT,
        RPAD(C.VL_SADT, 14, ' ') VL_SADT,
		'N' CD_MARCA_GUARDIA,
		RPAD(0, 1, ' ') CD_MARCA_URGENCIA,
		NULL ANO_ENTRADA,
		NULL MES_ENTRADA,
		NULL DIA_ENTRADA,
		NULL HR_ENTRADA,
		NULL MIN_ENTRADA,
		NULL ANO_ALTA,
		NULL MES_ALTA,
		NULL DIA_ALTA,
		NULL HR_ALTA,
		NULL MIN_ALTA,
		'' DS_PRESTACION,
		'' CD_MODULO,
        LPAD(0, 1, 0) IS_PRIMEIRA_VEZ,
        LPAD(0, 1, 0) IS_MEDICUS,
        LPAD('', 1, 0) CD_IMPORTE_IVA,
        LPAD(0, 14, 0) VL_IMPORTE_IVA_DET,
		'' DS_FILLER_DET_1,
        LPAD(2, 1, 0) CD_REGISTRO_ARQUIVO_DET,
        RPAD(0, 15, ' ') CD_CLASSE_SOLICITANTE,
        RPAD(0, 4, ' ') CD_PROVINCIA_SOLICITANTE,
		'' CD_MATRICULA_REALIZADOR,
		'' NR_MAT_MEDICO_REALIZADOR,
        RPAD(0, 15, ' ') CD_CLASSE_REALIZADOR,
        RPAD(0, 4, ' ') CD_PROVINCIA_REALIZADOR,
        RPAD(0, 15, ' ') NR_CODIGO_INSTITUICAO,
		'' DS_FILLER_DET_2,
		A.NR_SEQ_PROTOCOLO,
    	A.NR_INTERNO_CONTA
FROM	W_INTERF_CONTA_CAB A,
		W_INTERF_CONTA_HEADER B,
		W_INTERF_CONTA_TOTAL C
WHERE 	A.NR_SEQ_PROTOCOLO	= B.NR_SEQ_PROTOCOLO
AND 	A.NR_INTERNO_CONTA	= C.NR_INTERNO_CONTA
GROUP BY CASE WHEN A.IE_TIPO_ATENDIMENTO=1 THEN  'FPI'  ELSE 'FPA' END , LPAD(coalesce(SUBSTR(OBTER_NOTA_CONTA_PROT_CONV(C.NR_SEQ_PROTOCOLO,0,'X','N'), 1, 254), 0), 8, 0),
         LPAD(A.CD_INTERNO, 8, 0), C.DT_EMISSAO, B.DS_SIGLA_MOEDA, C.VL_HONORARIOS, C.VL_SADT, A.NR_SEQ_PROTOCOLO, A.NR_INTERNO_CONTA

UNION ALL

SELECT	2 TP_REGISTRO,
		'' CD_PRESTADOR_CAB,
		'' CD_TIPO_DOCUMENTO_CAB,
		'' CD_LETRA_DOCUMENTO_CAB,
		LPAD(0, 4, 0) NR_SUCURSAL_CAB,
		LPAD(0, 8, 0) NR_DOCUMENTO_CAB,
		RPAD(C.DT_EMISSAO, 4, ' ') DT_ANO_EMISSAO,
		RPAD(C.DT_EMISSAO, 2, ' ') DT_MES_EMISSAO,
		RPAD(C.DT_EMISSAO, 2, ' ') DT_DIA_EMISSAO,
		'' DS_FILLER_CAB0,
		'' CD_SIGLA_MOEDA,
		LPAD(0, 15, 0) VL_PROTOCOLO,
		LPAD(0, 15, 0) VL_IMPORTE_EXENTO,
		LPAD(0, 15, 0) VL_IMPORTE_IB,
        LPAD(0, 15, 0) VL_IMPORTE_TOTAL_CAB,
        LPAD(0, 15, 0) VL_IMPORTE_IVA_CAB,
		'' DS_FILLER_CAB_1,
		1 CD_REGISTRO_ARQUIVO_CAB,
		LPAD(coalesce(A.CD_INTERNO, 0), 8, 0) CD_PRESTADOR_DET,
        CASE WHEN A.IE_TIPO_ATENDIMENTO=1 THEN  'FPI'  ELSE 'FPA' END  CD_TIPO_DOCUMENTO_DET,
        LPAD(( select substr(y.CD_SISTEMA_EXT,1, 1)
                from nota_fiscal x,
                     natureza_operacao y
                where x.nr_seq_protocolo = a.nr_seq_protocolo
                and y.cd_natureza_operacao = x.cd_natureza_operacao ), 1, ' ') CD_LETRA_DOCUMENTO_DET,
        LPAD(coalesce((select substr(x.NR_NFE_IMP,1, 4) from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 0), 4, 0) NR_SUCURSAL_DET,
        LPAD(coalesce((select substr(x.NR_NFE_IMP,length(x.NR_NFE_IMP)-8, length(x.NR_NFE_IMP)) from nota_fiscal x where x.nr_seq_protocolo = a.nr_seq_protocolo), 'F'), 8, ' ') NR_DOCUMENTO_DET,
        CASE WHEN A.IE_TIPO_ATENDIMENTO = 1 and A.IE_CLINICA != 2 THEN 'IN'
                WHEN A.IE_TIPO_ATENDIMENTO = 1 and A.IE_CLINICA = 2 THEN 'CA'
                WHEN A.IE_TIPO_ATENDIMENTO = 3 THEN 'EM'
                WHEN A.IE_TIPO_ATENDIMENTO = 7 or A.IE_TIPO_ATENDIMENTO = 8 THEN 'AM'
                ELSE 'AM'
        END CD_TIPO_CONVENIO,
        LPAD(A.CD_USUARIO_CONVENIO, 15, 0) DS_MEDICARD_PACIENTE,
        RPAD((select substr(obter_medico_req_extenso(D.CD_MEDICO_REQ,wheb_usuario_pck.get_nm_usuario),1,60) ), 30, ' ') NM_MEDICO_SOLICITANTE,
        LPAD(CASE WHEN( select max(IE_NACIONAL)             from CRM_ESTADO x             where x.NR_CRM = D.NR_CRM_REQUISITANTE)='S' THEN 'N'  ELSE 'P' END , 1, 0) CD_TIPO_MEDICO_SOLICITANTE,
        LPAD(coalesce(D.NR_CRM_REQUISITANTE, 0), 10, 0) NR_MAT_MEDICO_SOLICITANTE,
        LPAD(coalesce(A.CD_CID_PRINCIPAL, 0), 7, 0) CD_CID_PRINCIPAL,
        LPAD((SELECT MAX(x.CD_SENHA_GUIA) FROM W_INTERF_CONTA_AUTOR X, atendimento_paciente y WHERE A.NR_INTERNO_CONTA = x.NR_INTERNO_CONTA AND y.nr_atendimento = x.nr_atendimento 
             AND y.IE_TIPO_ATENDIMENTO = 1), 10, 0) NR_ORDEM_INT_MEDICUS,
        LPAD((SELECT MAX(x.CD_SENHA_GUIA) FROM W_INTERF_CONTA_AUTOR X, atendimento_paciente y WHERE A.NR_INTERNO_CONTA = x.NR_INTERNO_CONTA 
             AND y.nr_atendimento = x.nr_atendimento AND y.IE_TIPO_ATENDIMENTO <> 1), 15, 0) NR_ORDEM_AMB_MEDICUS,
        RPAD(D.CD_ITEM, 9, ' ') CD_PRESTACAO,
        D.DT_ITEM ANO_PRESTACAO,
        D.DT_ITEM MES_PRESTACAO,
        D.DT_ITEM DIA_PRESTACAO,
        RPAD('', 5, ' ') DS_ITEM,
        LPAD(D.QT_ITEM, 7, 0) QT_ITEM,
        LPAD(D.VL_UNITARIO_ITEM, 15, 0) VL_UNITARIO_ITEM,
        RPAD('', 1, ' ') CD_IMPORTE_TOTAL,
        LPAD((D.QT_ITEM * D.VL_UNITARIO_ITEM), 14, 0) VL_IMPORTE_TOTAL,
        RPAD('', 1, ' ') CD_IMPORTE_HONORARIO,
        LPAD(D.VL_HONORARIO, 14, 0) VL_HONORARIOS,
        RPAD('', 1, ' ') CD_IMPORTE_SADT,
        LPAD(D.VL_CUSTO_OPER, 14, 0) VL_SADT,
        RPAD('N', 1, ' ') CD_MARCA_GUARDIA,
        CASE WHEN D.NR_SEQ_PROC_CRIT_HOR IS NULL THEN  'N'  ELSE 'S' END  CD_MARCA_URGENCIA,
        A.DT_ENTRADA ANO_ENTRADA,
        A.DT_ENTRADA MES_ENTRADA,
        A.DT_ENTRADA DIA_ENTRADA,
        A.DT_ENTRADA HR_ENTRADA,
        A.DT_ENTRADA MIN_ENTRADA,
        A.DT_ALTA ANO_ALTA,
        A.DT_ALTA MES_ALTA,
        A.DT_ALTA DIA_ALTA,
        A.DT_ALTA HR_ALTA,
        A.DT_ALTA MIN_ALTA,
        RPAD(D.DS_ITEM, 47, ' ') DS_PRESTACION,
        RPAD(D.NR_SEQ_PROC_PACOTE, 3, ' ') CD_MODULO,
        RPAD('', 1, ' ') IS_PRIMEIRA_VEZ,
        RPAD(CASE WHEN D.CD_PROC_REF_CONV IS NULL THEN  2  ELSE 1 END , 1, ' ') IS_MEDICUS,
        LPAD('', 1, 0) CD_IMPORTE_IVA,
        LPAD(0, 14, 0) VL_IMPORTE_IVA_DET,
        RPAD('', 3, ' ') DS_FILLER_DET_1,
        '2' CD_REGISTRO_ARQUIVO_DET,
        RPAD(( select max(x.CD_ESPECIALIDADE_EXTERNO)
         from ESPECIALIDADE_MEDICA x
        where x.CD_ESPECIALIDADE = D.CD_ESPECIALIDADE), 15, ' ') CD_CLASSE_SOLICITANTE,
        RPAD(A.UF_CRM_MEDICO_RESP, 4, ' ') CD_PROVINCIA_SOLICITANTE,
        LPAD(CASE WHEN( select max(IE_NACIONAL)                     from CRM_ESTADO x                     where x.NR_CRM = D.NR_CRM_EXECUTOR)='S' THEN 'N'  ELSE 'P' END , 1, 0) CD_MATRICULA_REALIZADOR,
        LPAD(D.NR_CRM_EXECUTOR, 10, 0) NR_MAT_MEDICO_REALIZADOR,
        RPAD(( select max(x.CD_ESPECIALIDADE_EXTERNO)
         from ESPECIALIDADE_MEDICA x
        where x.CD_ESPECIALIDADE = D.CD_ESPECIALIDADE), 15, ' ') CD_CLASSE_REALIZADOR, 
        RPAD(D.UF_CRM_EXECUTOR, 4, ' ') CD_PROVINCIA_REALIZADOR,
        LPAD(D.CD_ITEM, 15, 0) NR_CODIGO_INSTITUICAO,
        RPAD('', 85, ' ') DS_FILLER_DET_2,
		A.NR_SEQ_PROTOCOLO,
    	A.NR_INTERNO_CONTA
FROM	W_INTERF_CONTA_CAB A,
		W_INTERF_CONTA_TOTAL C,
		W_INTERF_CONTA_ITEM D
WHERE 	A.NR_INTERNO_CONTA	= C.NR_INTERNO_CONTA
AND 	A.NR_INTERNO_CONTA	= D.NR_INTERNO_CONTA;

