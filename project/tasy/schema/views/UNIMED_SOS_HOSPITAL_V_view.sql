-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_sos_hospital_v (tp_registro, nr_seq, tp_reg, dt_geracao, nr_nota, tp_nota, cd_uni_benef, id_benef, nm_benef, dt_atend, id_ambu, cd_cid, tp_tratamento, tp_paciente, cd_uni_aut, nr_autoriz, cd_uni_pre_req, cd_pre_req, lc_cobr, cd_uni_hosp, cd_hosp, tp_acomod_cob, tp_acomod_pag, dt_internacao, dt_alta, qt_dia_aut, qt_dia_pro, cd_tratamento, cd_uni_pre, cd_prest, tp_partic, dt_servico, tp_tabela, sq_servico, cd_servico, qt_servico, tp_servico, vl_servico, cd_porte_anes, ds_servico, cd_espec, qt_tot_nota, qt_tot_hospital, qt_tot_servico, qt_tot_ser, vl_tot_ser, nr_seq_protocolo, nr_conta, ie_tipo_item) AS select
	1						tp_registro,
	0						nr_seq,
	101						tp_reg,
	a.dt_remessa				dt_geracao,
	0						nr_nota,
	0						tp_nota,
	0						cd_uni_benef,
	0						id_benef,
	' '						nm_benef,
	LOCALTIMESTAMP					dt_atend,
	' '						id_ambu,
	' '						cd_cid,
	' '						tp_tratamento,
	' '						tp_paciente,
	0						cd_uni_aut,
	0						nr_autoriz,
	0						cd_uni_pre_req,
	0						cd_pre_req,
	0						lc_cobr,
	0						cd_uni_hosp,
	' '						cd_hosp,
	' '						tp_acomod_cob,
	' '						tp_acomod_pag,
	LOCALTIMESTAMP					dt_internacao,
	LOCALTIMESTAMP					dt_alta,
	0						qt_dia_aut,
	0						qt_dia_pro,
	0						cd_tratamento,
	0						cd_uni_pre,
	' '						cd_prest,
	' '						tp_partic,
	LOCALTIMESTAMP					dt_servico,
	' '						tp_tabela,
	0						sq_servico,
	0						cd_servico,
	0						qt_servico,
	' '						tp_servico,
	0						vl_servico,
	' '						cd_porte_anes,
	' '						ds_servico,
	0						cd_espec,
	0						qt_tot_nota,
	0						qt_tot_hospital,
	0						qt_tot_servico,
	0						qt_tot_ser,
	0						vl_tot_ser,
	a.nr_seq_protocolo			nr_seq_protocolo,
	0						nr_conta,
	0						ie_tipo_item
FROM  w_interf_conta_header a

union all

/* Nota		*/

select
	2						tp_registro,
	0						nr_seq,
	102						tp_reg,
	LOCALTIMESTAMP					dt_geracao,
	(coalesce(a.nr_doc_convenio,0))::numeric 	nr_nota,
	5						tp_nota,
	(coalesce(substr(a.cd_usuario_convenio,1,4),
		substr(a.cd_interno,1,4)))::numeric 	cd_uni_benef,
	(coalesce(substr(a.cd_usuario_convenio,5,13),'0'))::numeric
							id_benef,
	substr(a.nm_paciente,1,25)		nm_benef,
	a.dt_entrada				dt_atend,
	CASE WHEN a.ie_tipo_atendimento=3 THEN 'S'  ELSE 'N' END 
							id_ambu,
	substr(a.cd_cid_principal,1,6)	cd_cid,
	' '						tp_tratamento,
	'1'						tp_paciente,
	(coalesce(substr(a.cd_interno,1,4),'0'))::numeric 
							cd_uni_aut,
	(coalesce(substr(a.nr_doc_convenio,1,9),'0'))::numeric 
							nr_autoriz,
	0						cd_uni_pre_req,
	0						cd_pre_req,
	(coalesce(substr(b.cd_regional,1,4),'0'))::numeric 
							lc_cobr,
	0						cd_uni_hosp,
	' '						cd_hosp,
	' '						tp_acomod_cob,
	' '						tp_acomod_pag,
	LOCALTIMESTAMP					dt_internacao,
	LOCALTIMESTAMP					dt_alta,
	0						qt_dia_aut,
	0						qt_dia_pro,
	0						cd_tratamento,
	0						cd_uni_pre,
	' '						cd_prest,
	' '						tp_partic,
	LOCALTIMESTAMP					dt_servico,
	' '						tp_tabela,
	0						sq_servico,
	0						cd_servico,
	0						qt_servico,
	' '						tp_servico,
	0						vl_servico,
	' '						cd_porte_anes,
	' '						ds_servico,
	0						cd_espec,
	0						qt_tot_nota,
	0						qt_tot_hospital,
	0						qt_tot_servico,
	0						qt_tot_ser,
	0						vl_tot_ser,
	a.nr_seq_protocolo			nr_seq_protocolo,
	a.nr_interno_conta			nr_conta,
	0						ie_tipo_item
from  w_interf_conta_header b,
  	w_interf_conta_cab a
where	a.nr_seq_protocolo	= b.nr_seq_protocolo

union all

/* Hospital 	*/

select
	3						tp_registro,
	0						nr_seq,
	103						tp_reg,
	LOCALTIMESTAMP					dt_geracao,
	(coalesce(a.nr_doc_convenio,0))::numeric 	nr_nota,
	0						tp_nota,
	0						cd_uni_benef,
	0						id_benef,
	' '						nm_benef,
	LOCALTIMESTAMP					dt_atend,
	' '						id_ambu,
	' '						cd_cid,
	' '						tp_tratamento,
	' '						tp_paciente,
	0						cd_uni_aut,
	0						nr_autoriz,
	0						cd_uni_pre_req,
	0						cd_pre_req,
	0						lc_cobr,
	(coalesce(substr(b.cd_regional,1,4),'0'))::numeric 
							cd_uni_hosp,
	substr(b.cd_interno,1,9)		cd_hosp,
	to_char(a.cd_tipo_acomodacao)		tp_acomod_cob,
	to_char(a.cd_tipo_acomodacao)		tp_acomod_pag,
	a.dt_entrada				dt_internacao,
	a.dt_alta					dt_alta,
	coalesce(a.qt_dia_internacao,0)		qt_dia_aut,
	((a.dt_alta - a.dt_entrada) -  coalesce(a.qt_dia_internacao,0))
							qt_dia_pro,
	(a.cd_proc_principal)::numeric 	cd_tratamento,
	0						cd_uni_pre,
	' '						cd_prest,
	' '						tp_partic,
	LOCALTIMESTAMP					dt_servico,
	' '						tp_tabela,
	0						sq_servico,
	0						cd_servico,
	0						qt_servico,
	' '						tp_servico,
	0						vl_servico,
	' '						cd_porte_anes,
	' '						ds_servico,
	0						cd_espec,
	0						qt_tot_nota,
	0						qt_tot_hospital,
	0						qt_tot_servico,
	0						qt_tot_ser,
	0						vl_tot_ser,
	a.nr_seq_protocolo			nr_seq_protocolo,
	a.nr_interno_conta			nr_conta,
	0						ie_tipo_item
from  w_interf_conta_header b,
  	w_interf_conta_cab a
where	a.nr_seq_protocolo	= b.nr_seq_protocolo

union all

/* Servico 	*/

select
	4						tp_registro,
	0						nr_seq,
	104						tp_reg,
	LOCALTIMESTAMP					dt_geracao,
	(coalesce(a.nr_doc_convenio,0))::numeric 	nr_nota,
	0						tp_nota,
	0						cd_uni_benef,
	0						id_benef,
	' '						nm_benef,
	LOCALTIMESTAMP					dt_atend,
	' '						id_ambu,
	' '						cd_cid,
	' '						tp_tratamento,
	' '						tp_paciente,
	0						cd_uni_aut,
	0						nr_autoriz,
	0						cd_uni_pre_req,
	0						cd_pre_req,
	0						lc_cobr,
	0						cd_uni_hosp,
	' '						cd_hosp,
	' '						tp_acomod_cob,
	' '						tp_acomod_pag,
	LOCALTIMESTAMP					dt_internacao,
	LOCALTIMESTAMP					dt_alta,
	0						qt_dia_aut,
	0						qt_dia_pro,
	0						cd_tratamento,
	(coalesce(b.cd_regional,'0'))::numeric 	cd_uni_pre,
	b.cd_interno				cd_prest,
	to_char(c.cd_funcao_executor)		tp_partic,
	CASE WHEN c.ie_tipo_item=1 THEN c.dt_item  ELSE trunc(c.dt_item) END 			dt_servico,
	c.cd_grupo_gasto				tp_tabela,
	0						sq_servico,
	(c.cd_item_convenio)::numeric 		cd_servico,
	sum(c.qt_item)				qt_servico,
	' '						tp_servico,
	sum(c.vl_total_item)			vl_servico,
	CASE WHEN d.ie_anestesista='S' THEN to_char(c.nr_porte_anestesico)  ELSE ' ' END 
							cd_porte_anes,
	substr(c.ds_item,1,35)			ds_servico,
	0						cd_espec,
	0						qt_tot_nota,
	0						qt_tot_hospital,
	0						qt_tot_servico,
	0						qt_tot_ser,
	0						vl_tot_ser,
	a.nr_seq_protocolo			nr_seq_protocolo,
	a.nr_interno_conta			nr_conta,
	c.ie_tipo_item				ie_tipo_item
FROM w_interf_conta_header b, w_interf_conta_cab a, w_interf_conta_item c
LEFT OUTER JOIN funcao_medico d ON (c.cd_funcao_executor = d.cd_funcao)
WHERE a.nr_seq_protocolo	= b.nr_seq_protocolo and a.nr_interno_conta	= c.nr_interno_conta  and c.vl_total_item		<> 0 group by	(coalesce(a.nr_doc_convenio,0))::numeric ,
		(coalesce(b.cd_regional,'0'))::numeric ,
		b.cd_interno,
		to_char(c.cd_funcao_executor),
		CASE WHEN c.ie_tipo_item=1 THEN c.dt_item  ELSE trunc(c.dt_item) END ,
		c.cd_grupo_gasto,
		(c.cd_item_convenio)::numeric ,
		CASE WHEN d.ie_anestesista='S' THEN to_char(c.nr_porte_anestesico)  ELSE ' ' END ,
		substr(c.ds_item,1,35),
		a.nr_seq_protocolo,
		a.nr_interno_conta,
		c.ie_tipo_item

union all

/* Trailler 	*/

select
	5						tp_registro,
	0						nr_seq,
	105						tp_reg,
	LOCALTIMESTAMP					dt_geracao,
	9999999					nr_nota,
	0						tp_nota,
	0						cd_uni_benef,
	0						id_benef,
	' '						nm_benef,
	LOCALTIMESTAMP					dt_atend,
	' '						id_ambu,
	' '						cd_cid,
	' '						tp_tratamento,
	' '						tp_paciente,
	0						cd_uni_aut,
	0						nr_autoriz,
	0						cd_uni_pre_req,
	0						cd_pre_req,
	0						lc_cobr,
	0						cd_uni_hosp,
	' '						cd_hosp,
	' '						tp_acomod_cob,
	' '						tp_acomod_pag,
	LOCALTIMESTAMP					dt_internacao,
	LOCALTIMESTAMP					dt_alta,
	0						qt_dia_aut,
	0						qt_dia_pro,
	0						cd_tratamento,
	0						cd_uni_pre,
	' '						cd_prest,
	' '						tp_partic,
	LOCALTIMESTAMP					dt_servico,
	' '						tp_tabela,
	0						sq_servico,
	0						cd_servico,
	0						qt_servico,
	' '						tp_servico,
	0						vl_servico,
	' '						cd_porte_anes,
	' '						ds_servico,
	0						cd_espec,
	0						qt_tot_nota,
	0						qt_tot_hospital,
	0						qt_tot_servico,
	a.qt_total_conta				qt_tot_ser,
	a.vl_total_conta				vl_tot_ser,
	a.nr_seq_protocolo			nr_seq_protocolo,
	9999999999					nr_conta,
	0						ie_tipo_item
from  w_interf_conta_trailler a;

