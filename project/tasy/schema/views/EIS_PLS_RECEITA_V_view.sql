-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_pls_receita_v (vl_mensalidade, vl_recebido, vl_previsto, dt_mesano_referencia, ds_forma_cobranca, nm_pagador, nm_banco, nm_estipulante, nm_empresa, ds_plano, ds_plano_sca, cd_estabelecimento, nr_seq_pagador, nr_seq_contrato, nr_seq_plano, nr_seq_vinculo_sca, ds_regulamentacao, ie_regulamentacao, ds_tipo_contratacao, ie_tipo_contratacao, ds_segmentacao, ie_segmentacao, ds_centro_custo, cd_centro_custo, ds_contrato, nr_contrato, nr_seq_mensalidade) AS select	--sum(decode(h.dt_contabilizacao,null,a.vl_item,a.vl_pro_rata_dia)) vl_mensalidade, 
	sum(a.vl_item) vl_mensalidade,
	CASE WHEN j.ie_situacao='2' THEN sum(a.vl_item)  ELSE 0 END  vl_recebido, 
	CASE WHEN j.ie_situacao='1' THEN sum(a.vl_item)  ELSE 0 END  vl_previsto, 
	trunc(b.dt_mesano_referencia,'Month') dt_mesano_referencia, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			FROM	valor_dominio 
			where	cd_dominio	= 1720 
			and	vl_dominio	= c.nr_seq_forma_cobranca),1,255) ds_forma_cobranca, 
	substr((	select	x.nm_pessoa_fisica 
			from	pessoa_fisica x 
			where	x.cd_pessoa_fisica = d.cd_pessoa_fisica 
			
UNION ALL
 
			select	y.ds_razao_social 
			from	pessoa_juridica y 
			where	y.cd_cgc	= d.cd_cgc),1,255) nm_pagador, 
	substr((	select	max(w.ds_banco) 
			from	banco w 
			where	w.cd_banco	= e.cd_banco),1,200) nm_banco, 
	substr((	select	x.nm_pessoa_fisica 
			from	pessoa_fisica x 
			where	x.cd_pessoa_fisica = f.cd_pf_estipulante 
			
UNION ALL
 
			select	y.ds_razao_social 
			from	pessoa_juridica y 
			where	y.cd_cgc	= f.cd_cgc_estipulante),1,255) nm_estipulante, 
	substr((	select	max(z.ds_razao_social) 
			from	pessoa_juridica z 
			where	z.cd_cgc	= g.cd_cgc),1,200) nm_empresa, 
	substr((	select	max(x.ds_plano) 
			from	pls_plano 	x 
			where	x.nr_sequencia		= b.nr_seq_plano 
			and	a.ie_tipo_item		IN ('1','12','4','5','25') 
			and	a.nr_seq_vinculo_sca is null 
			and	x.ie_tipo_operacao	= 'B'),1,200) ds_plano, 
	substr((	select	max(x.ds_plano) 
			from	pls_plano 	x, 
				pls_sca_vinculo	y 
			where	a.nr_seq_vinculo_sca	= y.nr_sequencia 
			and	x.nr_sequencia		= y.nr_seq_plano 
			and	a.ie_tipo_item		in ('15','4','5','25') 
			and	a.nr_seq_vinculo_sca is not null),1,200) ds_plano_sca, 
	f.cd_estabelecimento, 
	d.nr_sequencia nr_seq_pagador, 
	f.nr_sequencia nr_seq_contrato, 
	(	select	max(x.nr_sequencia) 
			from	pls_plano 	x 
			where	x.nr_sequencia		= b.nr_seq_plano 
			and	a.ie_tipo_item		IN ('1','12','4','5','25') 
			and	a.nr_seq_vinculo_sca is null 
			and	x.ie_tipo_operacao	= 'B') nr_seq_plano, 
	(	select	max(x.nr_seq_plano) 
		from	pls_sca_vinculo	x 
		where	a.nr_seq_vinculo_sca	= x.nr_sequencia 
		and	a.ie_tipo_item		in ('15','4','5','25') 
		and	a.nr_seq_vinculo_sca is not null) nr_seq_vinculo_sca, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 2157 
			and	vl_dominio	= i.ie_regulamentacao),1,255) ds_regulamentacao, 
	i.ie_regulamentacao, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 1666 
			and	vl_dominio	= i.ie_tipo_contratacao),1,255) ds_tipo_contratacao, 
	i.ie_tipo_contratacao, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 1665 
			and	vl_dominio	= i.ie_segmentacao),1,255) ds_segmentacao, 
	i.ie_segmentacao, 
	substr((	select	substr(ds_centro_custo,1,254) 
			from	centro_custo 
			where	cd_centro_custo	= a.cd_centro_custo),1,255) ds_centro_custo, 
	a.cd_centro_custo, 
	substr(obter_nome_pf_pj(f.cd_pf_estipulante,f.cd_cgc_estipulante),1,254) ds_contrato, 
	f.nr_contrato, 
	b.nr_sequencia nr_seq_mensalidade 
FROM pls_plano i, pls_lote_mensalidade h, pls_contrato f, pls_contrato_pagador d, pls_mensalidade_segurado b, pls_mensalidade_seg_item a, pls_mensalidade c
LEFT OUTER JOIN titulo_receber j ON (c.nr_sequencia = j.nr_seq_mensalidade)
, pls_contrato_pagador_fin e
LEFT OUTER JOIN pls_desc_empresa g ON (e.nr_seq_empresa = g.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg = b.nr_sequencia and b.nr_seq_mensalidade	= c.nr_sequencia and c.nr_seq_pagador	= d.nr_sequencia and c.nr_seq_pagador_fin	= e.nr_sequencia  and e.nr_seq_pagador	= d.nr_sequencia  and d.nr_seq_contrato	= f.nr_sequencia and c.nr_seq_lote		= h.nr_sequencia and b.nr_seq_plano		= i.nr_sequencia and c.ie_cancelamento is null and h.ie_status	= '2' group by 	c.nr_seq_forma_cobranca, 
		b.dt_mesano_referencia, 
		e.nr_seq_forma_cobranca, 
		d.nr_sequencia, 
		e.cd_banco, 
		g.cd_cgc, 
		f.cd_pf_estipulante, 
		f.cd_cgc_estipulante, 
		f.cd_estabelecimento, 
		d.nr_sequencia, 
		d.cd_pessoa_fisica, 
		d.cd_cgc, 
		f.nr_sequencia, 
		a.nr_seq_vinculo_sca, 
		b.nr_seq_plano, 
		a.nr_seq_plano, 
		i.ie_regulamentacao, 
		i.ie_tipo_contratacao, 
		i.ie_segmentacao, 
		a.cd_centro_custo, 
		f.nr_contrato, 
		j.ie_situacao, 
		a.ie_tipo_item, 
		b.nr_sequencia 

union all
 
select	--sum(decode(h.dt_contabilizacao,null,a.vl_item,a.vl_pro_rata_dia)) vl_mensalidade, 
	sum(a.vl_item) vl_mensalidade, 
	CASE WHEN j.ie_situacao='2' THEN sum(a.vl_item)  ELSE 0 END  vl_recebido, 
	CASE WHEN j.ie_situacao='1' THEN sum(a.vl_item)  ELSE 0 END  vl_previsto, 
	trunc(b.dt_mesano_referencia,'Month') dt_mesano_referencia, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 1720 
			and	vl_dominio	= c.nr_seq_forma_cobranca),1,255) ds_forma_cobranca, 
	substr((	select	x.nm_pessoa_fisica 
			from	pessoa_fisica x 
			where	x.cd_pessoa_fisica = d.cd_pessoa_fisica 
			
UNION ALL
 
			select	y.ds_razao_social 
			from	pessoa_juridica y 
			where	y.cd_cgc	= d.cd_cgc),1,255) nm_pagador, 
	substr((	select	max(w.ds_banco) 
			from	banco w 
			where	w.cd_banco	= e.cd_banco),1,200) nm_banco, 
	substr((	select	x.nm_pessoa_fisica 
			from	pessoa_fisica x 
			where	x.cd_pessoa_fisica = f.cd_pessoa_fisica 
			
UNION ALL
 
			select	y.ds_razao_social 
			from	pessoa_juridica y 
			where	y.cd_cgc	= f.cd_cgc),1,255) nm_estipulante, 
	substr((	select	max(z.ds_razao_social) 
			from	pessoa_juridica z 
			where	z.cd_cgc	= g.cd_cgc),1,200) nm_empresa, 
	substr((	select	max(x.ds_plano) 
			from	pls_plano 	x 
			where	x.nr_sequencia		= b.nr_seq_plano 
			and	a.ie_tipo_item		IN ('1','12','4','5','25') 
			and	a.nr_seq_vinculo_sca is null 
			and	x.ie_tipo_operacao	= 'B'),1,200) ds_plano, 
	substr((	select	max(x.ds_plano) 
			from	pls_plano 	x, 
				pls_sca_vinculo	y 
			where	a.nr_seq_vinculo_sca	= y.nr_sequencia 
			and	x.nr_sequencia		= y.nr_seq_plano 
			and	a.ie_tipo_item		in ('15','4','5','25') 
			and	a.nr_seq_vinculo_sca is not null),1,200) ds_plano_sca, 
	f.cd_estabelecimento, 
	d.nr_sequencia nr_seq_pagador, 
	f.nr_sequencia nr_seq_contrato, 
	(	select	max(x.nr_sequencia) 
			from	pls_plano 	x 
			where	x.nr_sequencia		= b.nr_seq_plano 
			and	a.ie_tipo_item		IN ('1','12','4','5','25') 
			and	a.nr_seq_vinculo_sca is null 
			and	x.ie_tipo_operacao	= 'B') nr_seq_plano, 
	(	select	max(x.nr_seq_plano) 
		from	pls_sca_vinculo	x 
		where	a.nr_seq_vinculo_sca	= x.nr_sequencia 
		and	a.ie_tipo_item		in ('15','4','5','25') 
		and	a.nr_seq_vinculo_sca is not null) nr_seq_vinculo_sca, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 2157 
			and	vl_dominio	= i.ie_regulamentacao),1,255) ds_regulamentacao, 
	i.ie_regulamentacao, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 1666 
			and	vl_dominio	= i.ie_tipo_contratacao),1,255) ds_tipo_contratacao, 
	i.ie_tipo_contratacao, 
	substr((	select	substr(ds_valor_dominio,1,254) 
			from	valor_dominio 
			where	cd_dominio	= 1665 
			and	vl_dominio	= i.ie_segmentacao),1,255) ds_segmentacao, 
	i.ie_segmentacao, 
	substr((	select	substr(ds_centro_custo,1,254) 
			from	centro_custo 
			where	cd_centro_custo	= a.cd_centro_custo),1,255) ds_centro_custo, 
	a.cd_centro_custo, 
	null ds_contrato, 
	null nr_contrato, 
	b.nr_sequencia nr_seq_mensalidade 
FROM pls_plano i, pls_lote_mensalidade h, pls_intercambio f, pls_contrato_pagador d, pls_mensalidade_segurado b, pls_mensalidade_seg_item a, pls_mensalidade c
LEFT OUTER JOIN titulo_receber j ON (c.nr_sequencia = j.nr_seq_mensalidade)
, pls_contrato_pagador_fin e
LEFT OUTER JOIN pls_desc_empresa g ON (e.nr_seq_empresa = g.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg = b.nr_sequencia and b.nr_seq_mensalidade	= c.nr_sequencia and c.nr_seq_pagador	= d.nr_sequencia and c.nr_seq_pagador_fin	= e.nr_sequencia  and e.nr_seq_pagador	= d.nr_sequencia  and d.nr_seq_pagador_intercambio	= f.nr_sequencia and c.nr_seq_lote		= h.nr_sequencia and b.nr_seq_plano		= i.nr_sequencia and c.ie_cancelamento is null and h.ie_status	= '2' group by 	c.nr_seq_forma_cobranca, 
		b.dt_mesano_referencia, 
		e.nr_seq_forma_cobranca, 
		d.nr_sequencia, 
		e.cd_banco, 
		g.cd_cgc, 
		f.cd_pessoa_fisica, 
		f.cd_cgc, 
		f.cd_estabelecimento, 
		d.nr_sequencia, 
		d.cd_pessoa_fisica, 
		d.cd_cgc, 
		f.nr_sequencia, 
		a.nr_seq_vinculo_sca, 
		b.nr_seq_plano, 
		a.nr_seq_plano, 
		i.ie_regulamentacao, 
		i.ie_tipo_contratacao, 
		i.ie_segmentacao, 
		a.cd_centro_custo, 
		j.ie_situacao, 
		a.ie_tipo_item, 
		b.nr_sequencia;

