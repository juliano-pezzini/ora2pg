-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_demonst_servicos_familia_v (cd_proc_mat, ds_proc, dt_emissao, ie_carater_internacao, vl_liberado, vl_faturado, ds_unidade, nr_seq_prestador_exec, tp_val, qt_item, vl_unitario, nr_seq_grau_partic, cd_porte_anestesico, ie_ato_cooperado, nr_seq_lote, dt_protocolo, dt_mes_competencia, nr_seq_pagador, nr_seq_conta, nr_seq_segurado, vl_glosa, nr_contrato, nr_seq_fatura, nm_segurado, dt_nascimento, cd_guia, ds_plano, nr_seq_contrato, nm_titular, cd_cooperativa, ie_tipo_guia, nr_seq_congenere_prot, ie_fatura, cd_medico_executor, nr_seq_tipo_atendimento, nr_seq_regra_fat, ie_origem_protocolo, nr_seq_conta_pos_estab, cd_exec, cd_senha, nr_fatura, vl_taxa_mais_vl_item, ie_tipo) AS select	coalesce(substr(pls_obter_dados_conta_pos(f.nr_seq_conta_pos_estab,'CP'),1,255),substr(pls_obter_dados_conta_proc(f.nr_seq_conta_proc,'C'),1,255)) cd_proc_mat,
	coalesce(substr(pls_obter_dados_conta_pos(f.nr_seq_conta_pos_estab,'CP'),1,255),substr(pls_obter_dados_conta_proc(f.nr_seq_conta_proc,'C'),1,255)) || ' - ' || 
	coalesce(substr(pls_obter_dados_conta_pos(f.nr_seq_conta_pos_estab,'DP'),1,255),substr(pls_obter_dados_conta_proc(f.nr_seq_conta_proc,'D'),1,255)) ds_proc, 
	g.dt_procedimento dt_emissao, 
	e.ie_carater_internacao, 
	coalesce(h.vl_tabela_preco,0) vl_liberado, 
	coalesce(f.vl_faturado,0) vl_faturado, 
	obter_desc_moeda(h.cd_moeda_calculo) ds_unidade, 
	e.nr_seq_prestador_exec, 
	CASE WHEN g.vl_liberado_material IS NULL THEN (CASE WHEN g.vl_liberado_hi IS NULL THEN  'CO'  ELSE 'HM' END )  ELSE 'Filme' END  tp_val, 
	coalesce(g.qt_procedimento,0) qt_item, 
	h.vl_cotacao_moeda vl_unitario, 
	CASE WHEN e.ie_tipo_guia='6' THEN e.nr_seq_grau_partic  ELSE (select max(x.nr_seq_grau_partic) 							FROM	pls_proc_participante x 							where	x.nr_seq_conta_proc = g.nr_sequencia) END  nr_seq_grau_partic, 
	g.cd_porte_anestesico,						 
	g.ie_ato_cooperado, 
	b.nr_seq_lote, 
	i.dt_protocolo, 
	i.dt_mes_competencia, 
	b.nr_seq_pagador, 
	e.nr_sequencia nr_seq_conta, 
	e.nr_seq_segurado, 
	g.vl_glosa vl_glosa, 
	substr(pls_obter_dados_pagador(b.nr_seq_pagador,'OE'),1,10) nr_contrato, 
	b.nr_sequencia nr_seq_fatura, 
	l.nm_pessoa_fisica nm_segurado, 
	l.dt_nascimento, 
	e.cd_guia, 
	m.ds_plano || ' - ' || CASE WHEN m.IE_ACOMODACAO='I' THEN 'Apto' WHEN m.IE_ACOMODACAO='C' THEN 'Enfermaria' END  ds_plano, 
	j.nr_seq_contrato, 
	substr(CASE WHEN j.nr_seq_titular IS NULL THEN  l.nm_pessoa_fisica  ELSE pls_obter_dados_segurado(j.nr_seq_titular, 'N') END ,1,50) nm_titular, 
	n.cd_cooperativa, 
	e.ie_tipo_guia, 
	i.nr_seq_congenere nr_seq_congenere_prot, 
	'S' ie_fatura, 
	CASE WHEN i.nr_seq_prestador IS NULL THEN  e.nr_seq_prestador_exec  ELSE i.nr_seq_prestador END  cd_medico_executor,	 
	e.NR_SEQ_TIPO_ATENDIMENTO, 
	c.NR_SEQ_EVENTO NR_SEQ_REGRA_FAT, 
	i.ie_origem_protocolo ie_origem_protocolo, 
	h.nr_sequencia nr_seq_conta_pos_estab,	-- aldellandrea	 
	CASE WHEN i.ie_origem_protocolo='A' THEN  pls_obter_dados_cooperativa(i.nr_seq_congenere,'C')  ELSE CASE WHEN o.nr_seq_prestador IS NULL THEN  substr(pls_obter_cod_prestador(e.nr_seq_prestador_exec,null),1,255)  ELSE pls_obter_dados_prestador(o.nr_seq_prestador, 'CD') END  END  cd_exec, 
	q.cd_senha, 
	coalesce(b.nr_fatura,b.nr_sequencia) nr_fatura, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN h.vl_medico END   ELSE (coalesce(h.vl_medico,0) + coalesce(h.vl_custo_operacional,0) + coalesce(h.vl_materiais,0)) END  vl_taxa_mais_vl_item, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN 'HM'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN 'CO'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_materiais,0)='S' THEN 'FM' END  END  END  ie_tipo 
FROM pls_guia_plano q, pls_plano m, pessoa_fisica l, pls_segurado j, pls_protocolo_conta i, pls_conta_pos_estabelecido h, pls_fatura_proc f, pls_conta e, pls_fatura_conta d, pls_fatura_evento c, pls_lote_faturamento a, pls_conta_proc g
LEFT OUTER JOIN pls_proc_participante o ON (g.nr_sequencia = o.nr_seq_conta_proc)
, pls_fatura b
LEFT OUTER JOIN pls_congenere n ON (b.nr_seq_congenere = n.nr_sequencia)
WHERE q.nr_sequencia = e.nr_seq_guia and g.nr_sequencia = f.nr_seq_conta_proc and d.nr_sequencia = f.nr_seq_fatura_conta and e.nr_sequencia = d.nr_seq_conta and i.nr_sequencia = e.nr_seq_protocolo and c.nr_sequencia = d.nr_seq_fatura_evento and b.nr_sequencia = c.nr_seq_fatura and a.nr_sequencia = b.nr_seq_lote and g.nr_sequencia = h.nr_seq_conta_proc and a.nr_sequencia = h.nr_seq_lote_fat and j.nr_sequencia = e.nr_seq_segurado and l.cd_pessoa_fisica = j.cd_pessoa_fisica and m.nr_sequencia = j.nr_seq_plano   
union all
 
select	substr(PLS_OBTER_SEQ_CODIGO_MATERIAL(g.nr_seq_material,null),1,255) cd_proc_mat, 
	substr(PLS_OBTER_SEQ_CODIGO_MATERIAL(g.nr_seq_material,null),1,255) || ' - ' || 
	substr(pls_obter_desc_material(g.nr_seq_material),1,255) ds_proc, 
	--g.ds_material_imp ds_proc, 
	g.dt_atendimento dt_emissao, 
	e.ie_carater_internacao, 
	coalesce(h.vl_tabela_preco,0) vl_liberado, 
	coalesce(f.vl_faturado,0) vl_faturado, 
	obter_desc_moeda(h.cd_moeda_calculo) ds_unidade, 
	e.nr_seq_prestador_exec, 
	null tp_val, 
	coalesce(g.qt_material, 0) qt_item, 
	h.vl_cotacao_moeda vl_unitario, 
	e.nr_seq_grau_partic nr_seq_grau_partic, 
	null cd_porte_anestesico, 
	g.ie_ato_cooperado, 
	b.nr_seq_lote, 
	i.dt_protocolo, 
	i.dt_mes_competencia, 
	b.nr_seq_pagador, 
	e.nr_sequencia nr_seq_conta, 
	e.nr_seq_segurado, 
	g.vl_glosa vl_glosa, 
	substr(pls_obter_dados_pagador(b.nr_seq_pagador,'OE'),1,10) nr_contrato, 
	b.nr_sequencia nr_seq_fatura, 
	l.nm_pessoa_fisica nm_segurado, 
	l.dt_nascimento, 
	e.cd_guia, 
	m.ds_plano || ' - ' || CASE WHEN m.IE_ACOMODACAO='I' THEN 'Apto' WHEN m.IE_ACOMODACAO='C' THEN 'Enfermaria' END  ds_plano, 
	j.nr_seq_contrato, 
	substr(CASE WHEN j.nr_seq_titular IS NULL THEN  l.nm_pessoa_fisica  ELSE pls_obter_dados_segurado(j.nr_seq_titular, 'N') END ,1,50) nm_titular, 
	n.cd_cooperativa, 
	e.ie_tipo_guia, 
	i.nr_seq_congenere nr_seq_congenere_prot, 
	'S' ie_fatura, 
	--decode(i.nr_seq_congenere,null,SUBSTR(nvl(OBTER_DADOS_MEDICO(e.CD_MEDICO_EXECUTOR,'CRM'),pls_obter_dados_prestador(e.nr_seq_prestador_exec,'CD')),1,255), 
	--	substr(pls_obter_seq_cod_cooperativa('',i.nr_seq_congenere),1,255)) CD_MEDICO_EXECUTOR, 
	CASE WHEN i.nr_seq_prestador IS NULL THEN  e.nr_seq_prestador_exec  ELSE i.nr_seq_prestador END  cd_medico_executor,	 
	e.NR_SEQ_TIPO_ATENDIMENTO, 
	c.NR_SEQ_EVENTO NR_SEQ_REGRA_FAT, 
	i.ie_origem_protocolo ie_origem_protocolo, -- aldellandrea	 
	h.nr_sequencia nr_seq_conta_pos_estab, 
	CASE WHEN i.ie_origem_protocolo='A' THEN  pls_obter_dados_cooperativa(i.nr_seq_congenere,'C')  ELSE substr(pls_obter_cod_prestador(e.nr_seq_prestador_exec,null),1,255) END  cd_exec, 
	q.cd_senha, 
	coalesce(b.nr_fatura,b.nr_sequencia) nr_fatura, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN h.vl_medico END   ELSE (coalesce(h.vl_medico,0) + coalesce(h.vl_custo_operacional,0) + coalesce(h.vl_materiais,0)) END  vl_taxa_mais_vl_item, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN 'HM'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN 'CO'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_materiais,0)='S' THEN 'FM' END  END  END  ie_tipo 
FROM pls_guia_plano q, pls_plano m, pessoa_fisica l, pls_segurado j, pls_protocolo_conta i, pls_conta_pos_estabelecido h, pls_conta_mat g, pls_fatura_mat f, pls_conta e, pls_fatura_conta d, pls_fatura_evento c, pls_lote_faturamento a, pls_fatura b
LEFT OUTER JOIN pls_congenere n ON (b.nr_seq_congenere = n.nr_sequencia)
WHERE q.nr_sequencia = e.nr_seq_guia and g.nr_sequencia = f.nr_seq_conta_mat and d.nr_sequencia = f.nr_seq_fatura_conta and e.nr_sequencia = d.nr_seq_conta and i.nr_sequencia = e.nr_seq_protocolo and c.nr_sequencia = d.nr_seq_fatura_evento and b.nr_sequencia = c.nr_seq_fatura and a.nr_sequencia = b.nr_seq_lote and g.nr_sequencia = h.nr_seq_conta_mat and a.nr_sequencia = h.nr_seq_lote_fat and j.nr_sequencia = e.nr_seq_segurado and l.cd_pessoa_fisica = j.cd_pessoa_fisica and m.nr_sequencia = j.nr_seq_plano  /*Sem fatura*/
 
UNION ALL
 
select	coalesce(substr(pls_obter_dados_conta_pos(h.nr_sequencia,'CP'),1,255),substr(pls_obter_dados_conta_proc(g.nr_sequencia,'C'),1,255)) cd_proc_mat, 
	coalesce(substr(pls_obter_dados_conta_pos(h.nr_sequencia,'CP'),1,255),substr(pls_obter_dados_conta_proc(g.nr_sequencia,'C'),1,255)) || ' - ' || 
	coalesce(substr(pls_obter_dados_conta_pos(h.nr_sequencia,'DP'),1,255),substr(pls_obter_dados_conta_proc(g.nr_sequencia,'D'),1,255)) ds_proc, 
	g.dt_procedimento dt_emissao, 
	e.ie_carater_internacao, 
	coalesce(h.vl_tabela_preco,0) vl_liberado, 
	coalesce(h.VL_ADMINISTRACAO,0) vl_faturado, 
	obter_desc_moeda(h.cd_moeda_calculo) ds_unidade, 
	e.nr_seq_prestador_exec, 
	CASE WHEN g.vl_liberado_material IS NULL THEN (CASE WHEN g.vl_liberado_hi IS NULL THEN  'CO'  ELSE 'HM' END )  ELSE 'Filme' END  tp_val, 
	coalesce(g.qt_procedimento,0) qt_item, 
	g.vl_ch_honorario, 
	CASE WHEN e.ie_tipo_guia='6' THEN e.nr_seq_grau_partic  ELSE (select max(x.nr_seq_grau_partic) 							from	pls_proc_participante x 							where	x.nr_seq_conta_proc = g.nr_sequencia) END  nr_seq_grau_partic, 
	g.cd_porte_anestesico,						 
	g.ie_ato_cooperado, 
	null nr_seq_lote, 
	i.dt_protocolo, 
	i.dt_mes_competencia, 
	j.nr_seq_pagador, 
	e.nr_sequencia nr_seq_conta, 
	e.nr_seq_segurado, 
	g.vl_glosa vl_glosa, 
	to_char(n.cd_operadora_empresa) nr_contrato, 
	null nr_seq_fatura, 
	l.nm_pessoa_fisica nm_segurado, 
	l.dt_nascimento, 
	e.cd_guia, 
	m.ds_plano || ' - ' || CASE WHEN m.IE_ACOMODACAO='I' THEN 'Apto' WHEN m.IE_ACOMODACAO='C' THEN 'Enfermaria' END  ds_plano, 
	j.nr_seq_contrato, 
	substr(CASE WHEN j.nr_seq_titular IS NULL THEN  l.nm_pessoa_fisica  ELSE pls_obter_dados_segurado(j.nr_seq_titular, 'N') END ,1,50) nm_titular, 
	'' cd_cooperativa, 
	e.ie_tipo_guia, 
	i.nr_seq_congenere nr_seq_congenere_prot, 
	'N' ie_fatura, 
	--decode(i.nr_seq_congenere,null,SUBSTR(nvl(OBTER_DADOS_MEDICO(e.CD_MEDICO_EXECUTOR,'CRM'),pls_obter_dados_prestador(e.nr_seq_prestador_exec,'CD')),1,255), 
	--	substr(pls_obter_seq_cod_cooperativa('',i.nr_seq_congenere),1,255)) CD_MEDICO_EXECUTOR, 
	CASE WHEN i.nr_seq_prestador IS NULL THEN  e.nr_seq_prestador_exec  ELSE i.nr_seq_prestador END  cd_medico_executor,	 
	e.NR_SEQ_TIPO_ATENDIMENTO, 
	null NR_SEQ_REGRA_FAT, 
    i.ie_origem_protocolo ie_origem_protocolo, -- aldellandrea	 
	h.nr_sequencia nr_seq_conta_pos_estab, 
	CASE WHEN i.ie_origem_protocolo='A' THEN  pls_obter_dados_cooperativa(i.nr_seq_congenere,'C')  ELSE CASE WHEN o.nr_seq_prestador IS NULL THEN  substr(pls_obter_cod_prestador(e.nr_seq_prestador_exec,null),1,255)  ELSE pls_obter_dados_prestador(o.nr_seq_prestador, 'CD') END  END  cd_exec, 
	q.cd_senha, 
	null nr_fatura, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN h.vl_medico END   ELSE (coalesce(h.vl_medico,0) + coalesce(h.vl_custo_operacional,0) + coalesce(h.vl_materiais,0)) END  vl_taxa_mais_vl_item, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN 'HM'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN 'CO'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_materiais,0)='S' THEN 'FM' END  END  END  ie_tipo 
FROM pls_guia_plano q, pls_intercambio n, pls_plano m, pessoa_fisica l, pls_segurado j, pls_protocolo_conta i, pls_conta_pos_estabelecido h, pls_conta e, pls_conta_proc g
LEFT OUTER JOIN pls_proc_participante o ON (g.nr_sequencia = o.nr_seq_conta_proc)
WHERE q.nr_sequencia = e.nr_seq_guia and g.nr_sequencia = h.nr_seq_conta_proc and g.nr_seq_conta = e.nr_sequencia and i.nr_sequencia = e.nr_seq_protocolo and j.nr_sequencia = e.nr_seq_segurado and l.cd_pessoa_fisica = j.cd_pessoa_fisica and m.nr_sequencia = j.nr_seq_plano and j.nr_seq_intercambio = n.nr_sequencia  and not exists (	select	1 
			from	pls_fatura_proc		x 
			where	x.nr_seq_conta_proc	= g.nr_sequencia) 
 
union all
 
select	substr(PLS_OBTER_SEQ_CODIGO_MATERIAL(g.nr_seq_material,null),1,255) cd_proc_mat, 
	substr(PLS_OBTER_SEQ_CODIGO_MATERIAL(g.nr_seq_material,null),1,255) || ' - ' || 
	substr(pls_obter_desc_material(g.nr_seq_material),1,255) ds_proc, 
	--g.ds_material_imp ds_proc, 
	g.dt_atendimento dt_emissao, 
	e.ie_carater_internacao, 
	coalesce(h.vl_tabela_preco,0) vl_liberado, 
	coalesce(h.VL_ADMINISTRACAO,0) vl_faturado, 
	obter_desc_moeda(h.cd_moeda_calculo) ds_unidade, 
	e.nr_seq_prestador_exec, 
	null tp_val, 
	coalesce(g.qt_material, 0) qt_item, 
	h.vl_cotacao_moeda vl_unitario, 
	e.nr_seq_grau_partic nr_seq_grau_partic, 
	null cd_porte_anestesico, 
	g.ie_ato_cooperado, 
	null nr_seq_lote, 
	i.dt_protocolo, 
	i.dt_mes_competencia, 
	j.nr_seq_pagador, 
	e.nr_sequencia nr_seq_conta, 
	e.nr_seq_segurado, 
	g.vl_glosa vl_glosa, 
	to_char(n.cd_operadora_empresa) nr_contrato, 
	null nr_seq_fatura, 
	l.nm_pessoa_fisica nm_segurado, 
	l.dt_nascimento, 
	e.cd_guia, 
	m.ds_plano || ' - ' || CASE WHEN m.IE_ACOMODACAO='I' THEN 'Apto' WHEN m.IE_ACOMODACAO='C' THEN 'Enfermaria' END  ds_plano, 
	j.nr_seq_contrato, 
	substr(CASE WHEN j.nr_seq_titular IS NULL THEN  l.nm_pessoa_fisica  ELSE pls_obter_dados_segurado(j.nr_seq_titular, 'N') END ,1,50) nm_titular, 
	'' cd_cooperativa, 
	e.ie_tipo_guia, 
	i.nr_seq_congenere nr_seq_congenere_prot, 
	'N' ie_fatura, 
	--decode(i.nr_seq_congenere,null,SUBSTR(nvl(OBTER_DADOS_MEDICO(e.CD_MEDICO_EXECUTOR,'CRM'),pls_obter_dados_prestador(e.nr_seq_prestador_exec,'CD')),1,255), 
	--	substr(pls_obter_seq_cod_cooperativa('',i.nr_seq_congenere),1,255)) CD_MEDICO_EXECUTOR, 
	CASE WHEN i.nr_seq_prestador IS NULL THEN  e.nr_seq_prestador_exec  ELSE i.nr_seq_prestador END  cd_medico_executor,	 
	e.NR_SEQ_TIPO_ATENDIMENTO, 
	null NR_SEQ_REGRA_FAT, 
	i.ie_origem_protocolo ie_origem_protocolo, -- aldellandrea	 
	h.nr_sequencia nr_seq_conta_pos_estab, 
	CASE WHEN i.ie_origem_protocolo='A' THEN  pls_obter_dados_cooperativa(i.nr_seq_congenere,'C')  ELSE substr(pls_obter_cod_prestador(e.nr_seq_prestador_exec,null),1,255) END  cd_exec, 
	q.cd_senha, 
	null nr_fatura, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN h.vl_medico END   ELSE (coalesce(h.vl_medico,0) + coalesce(h.vl_custo_operacional,0) + coalesce(h.vl_materiais,0)) END  vl_taxa_mais_vl_item, 
	CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_medico,0)='S' THEN 'HM'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_custo_operacional,0)='S' THEN 'CO'  ELSE CASE WHEN OBTER_SE_VALOR_MAIOR(h.vl_materiais,0)='S' THEN 'FM' END  END  END  ie_tipo 
from	pls_guia_plano			q, 
	pls_intercambio			n, 
	pls_plano			m, 
	pessoa_fisica			l, 
	pls_segurado			j, 
	pls_conta_pos_estabelecido	h, 
	pls_conta_mat			g, 
	pls_conta			e, 
	pls_protocolo_conta		i 
where	q.nr_sequencia = e.nr_seq_guia 
and	g.nr_sequencia = h.nr_seq_conta_proc 
and	g.nr_seq_conta = e.nr_sequencia 
and	i.nr_sequencia = e.nr_seq_protocolo 
and	j.nr_sequencia = e.nr_seq_segurado 
and	l.cd_pessoa_fisica = j.cd_pessoa_fisica 
and	m.nr_sequencia = j.nr_seq_plano 
and	j.nr_seq_intercambio = n.nr_sequencia 
and	not exists (	select	1 
			from	pls_fatura_mat		x 
			where	x.nr_seq_conta_mat	= g.nr_sequencia);

