-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_proc_pacote_v (cd_convenio, ie_emite_conta, nr_interno_conta, cd_procedimento, cd_procedimento_princ, ds_procedimento, dt_procedimento, dt_proced_dia, dt_conta, dt_conta_dia, dt_inicio_procedimento, dt_procedimento_princ, hr_inicio, hr_fim, qt_procedimento, vl_procedimento, vl_unitario, cd_setor_atendimento, ds_setor_atendimento, ds_classif_setor, nm_medico, nr_pto_procedimento, nr_pto_medico, nr_pto_auxiliares, nr_pto_anestesista, nr_pto_material, nr_pto_coper, qt_pto_procedimento, qt_pto_medico, qt_pto_auxiliares, qt_pto_anestesista, qt_pto_material, qt_pto_coper, cd_procedimento_convenio, ds_procedimento_convenio, cd_unidade_medida_convenio, qt_proced_convenio, vl_proced_convenio, tx_conversao_qtde, nr_sequencia, nr_seq_proc_pacote, tx_procedimento, vl_filme, vl_exame, qt_porte_anestesico, vl_unitario_convenio, cd_unidade_medida, cd_proc_orig_pacote, vl_desconto, vl_bruto, dt_inicio_pacote, dt_final_pacote, qt_dias_pacote, qt_dias_hospital, qt_dias_uti) AS select	a.cd_convenio,
	a.ie_emite_conta, 
	a.nr_interno_conta, 
	a.cd_procedimento, 
	a.cd_procedimento_princ, 
	substr(b.ds_procedimento,0,180) ds_procedimento, 
	a.dt_procedimento dt_procedimento, 
	trunc(a.dt_procedimento,'DD') dt_proced_dia, 
	a.dt_conta, 
	trunc(a.dt_conta,'DD') dt_conta_dia, 
	a.dt_inicio_procedimento dt_inicio_procedimento, 
	a.dt_procedimento_princ dt_procedimento_princ, 
	to_char(a.dt_inicio_procedimento,'hh24:mi:ss') hr_inicio, 
	to_char(a.dt_procedimento,'hh24:mi:ss') hr_fim, 
	a.qt_procedimento, 
	a.vl_procedimento, 
	(a.vl_procedimento / a.qt_procedimento) vl_unitario, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	substr(obter_valor_dominio(1,c.cd_classif_setor),0,30) ds_classif_setor, 
	e.nm_pessoa_fisica nm_medico, 
	coalesce(f.vl_procedimento, 0) nr_pto_procedimento, 
	coalesce(f.vl_medico, 0) nr_pto_medico, 
	coalesce(f.vl_auxiliares, 0) nr_pto_auxiliares, 
	coalesce(f.vl_anestesista, 0) nr_pto_anestesista, 
	coalesce(f.vl_materiais, 0) nr_pto_material, 
	coalesce(f.vl_custo_operacional, 0) nr_pto_coper, 
	CASE WHEN coalesce(f.vl_procedimento,0)=0 THEN 0  ELSE (f.vl_procedimento / a.qt_procedimento) END  qt_pto_procedimento, 
	CASE WHEN coalesce(f.vl_medico,0)=0 THEN 0  ELSE (f.vl_medico / a.qt_procedimento) END  qt_pto_medico, 
	CASE WHEN coalesce(f.vl_auxiliares,0)=0 THEN 0  ELSE (f.vl_auxiliares / a.qt_procedimento) END  qt_pto_auxiliares, 
	CASE WHEN coalesce(f.vl_anestesista,0)=0 THEN 0  ELSE (f.vl_anestesista / a.qt_procedimento) END  qt_pto_anestesista, 
	CASE WHEN coalesce(f.vl_materiais,0)=0 THEN 0  ELSE (f.vl_materiais / a.qt_procedimento) END  qt_pto_material, 
	CASE WHEN coalesce(f.vl_custo_operacional,0)=0 THEN 0  ELSE (f.vl_custo_operacional / a.qt_procedimento) END  qt_pto_coper, 
	coalesce(g.cd_procedimento,coalesce(a.cd_procedimento_convenio,a.cd_procedimento)) cd_procedimento_convenio, 
	coalesce(g.ds_procedimento,b.ds_procedimento) ds_procedimento_convenio, 
	g.cd_unidade_medida cd_unidade_medida_convenio, 
	(a.qt_procedimento * CASE WHEN coalesce(g.tx_conversao_qtde,0)=0 THEN 1  ELSE g.tx_conversao_qtde END ) qt_proced_convenio, 
	a.vl_procedimento vl_proced_convenio, 
	g.tx_conversao_qtde, 
	a.nr_sequencia, 
	a.nr_seq_proc_pacote, 
	a.tx_procedimento, 
	coalesce(a.vl_materiais,0) vl_filme, 
	(coalesce(a.vl_procedimento,0) - coalesce(a.vl_materiais,0)) vl_exame, 
	a.qt_porte_anestesico, 
	(a.vl_procedimento) / 
	(CASE WHEN a.qt_procedimento=0 THEN 1  ELSE a.qt_procedimento END  * 
	 CASE WHEN coalesce(g.tx_conversao_qtde,0)=0 THEN 1  ELSE g.tx_conversao_qtde END ) vl_unitario_convenio, 
	Obter_Unid_Med_Servico(a.cd_convenio,a.cd_categoria,a.cd_procedimento,a.ie_origem_proced,obter_estab_atend(a.nr_atendimento)) cd_unidade_medida, 
	CASE WHEN a.nr_seq_proc_pacote IS NULL THEN null  ELSE Obter_Proc_Origem_Pacote(a.nr_seq_proc_pacote) END  cd_proc_orig_pacote, 
	coalesce(h.vl_procedimento,0) vl_desconto, 
	a.vl_procedimento + coalesce(h.vl_procedimento,0) vl_bruto, 
	y.dt_inicio_pacote, 
	y.dt_final_pacote, 
	y.qt_dias_pacote, 
	y.qt_dias_hospital, 
	y.qt_dias_uti	 
FROM atendimento_pacote y, setor_atendimento c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN pessoa_fisica e ON (a.cd_medico_executor = e.cd_pessoa_fisica)
LEFT OUTER JOIN proc_paciente_valor f ON (a.nr_sequencia = f.nr_seq_procedimento AND 2 = f.ie_tipo_valor)
LEFT OUTER JOIN proc_paciente_valor h ON (a.nr_sequencia = h.nr_seq_procedimento AND 3 = h.ie_tipo_valor)
LEFT OUTER JOIN proc_paciente_convenio g ON (a.nr_sequencia = g.nr_seq_procedimento)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced and a.cd_setor_atendimento = c.cd_setor_atendimento       and a.nr_atendimento	= y.nr_atendimento and a.nr_sequencia 	= y.nr_seq_procedimento;

