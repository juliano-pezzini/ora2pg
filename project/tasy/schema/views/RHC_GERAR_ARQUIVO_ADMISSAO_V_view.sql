-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rhc_gerar_arquivo_admissao_v (prontuar, nome, tipodoc, nmrdoc, dtanasc, sexo, instruc, ufnasc, endereco, numero, complement, cep, cdgibge, ufresid, dtaconsult, cdgclini, cdgdiagpre, dtadiag, cdgbasedia, cdgtopo, cdgmorfo, ec, t, n, m, outracla, pt, pn, pm, meta01, meta02, meta03, meta04, dtatrat, nenhum, cirurgia, radio, quimio, hormo, tmo, imuno, outros, seminforma, nenhumant, cirurgiant, radioant, quimioant, hormoant, tmoant, imunoant, outrosant, seminfoan, nenhumap, cirurgiap, radioap, quimioap, hormoap, tmoap, imunoap, outrosap, seminfoap, cdgnaotrat, cdgsitua, dtaobito, tpoobito, dtapreenc, lateralida, obs, telefone, nomemae, cd_pessoa_fisica, dt_liberacao, dt_diagnostico, dt_consulta, dt_inicio_trat, dt_inicio_trat2, dt_obito, dt_obito2, ie_pasta, dtaseguim, cdgrecseg, dtarecidiv, rec01, rec02, rec03, rec04, cdgsitseg, ie_situacao_clinica, nr_seq_ficha_admissao, catatend) AS select	a.nr_prontuario PRONTUAR,
	coalesce(b.nm_pessoa_fisica, ' ') NOME,
	CASE WHEN coalesce(coalesce(b.nr_cpf,b.nr_identidade),6)=b.nr_cpf THEN 4 WHEN coalesce(coalesce(b.nr_cpf,b.nr_identidade),6)=b.nr_identidade THEN 2  ELSE 6 END   TIPODOC,
	coalesce(coalesce(b.nr_cpf,b.nr_identidade), ' ') NMRDOC,
	coalesce(to_char(b.dt_nascimento,'DD/MM/YYYY'), ' ') DTANASC,
	CASE WHEN b.ie_sexo='M' THEN 1 WHEN b.ie_sexo='F' THEN 2 END  SEXO,
	CASE WHEN b.ie_grau_instrucao=1 THEN 1 WHEN b.ie_grau_instrucao=7 THEN 2 WHEN b.ie_grau_instrucao=2 THEN 3 WHEN b.ie_grau_instrucao=3 THEN 4 WHEN b.ie_grau_instrucao=4 THEN 5  ELSE 9 END  INSTRUC,
	coalesce(b.sg_emissora_ci, ' ') UFNASC,
	coalesce(c.ds_endereco, ' ') ENDERECO,
	coalesce(c.nr_endereco, c.ds_compl_end) NUMERO,
	coalesce(c.ds_complemento, ' ') COMPLEMENT,
	coalesce(c.cd_cep, ' ') CEP,
	coalesce(c.cd_municipio_ibge, ' ') CDGIBGE,
	coalesce(c.sg_estado, ' ') UFRESID,
	coalesce(to_char(a.dt_consulta,'DD/MM/YYYY'), ' ') DTACONSULT,
	coalesce(substr(Obter_Codigo_Clinica_Cancer(a.cd_clinica_atendimento),1,3), ' ') CDGCLINI,
	a.ie_diag_trat_previo CDGDIAGPRE,
	coalesce(to_char(a.dt_diagnostico,'DD/MM/YYYY'), ' ') DTADIAG,
	a.cd_base_diag CDGBASEDIA,
	coalesce(a.cd_topog_tu_prim, ' ') CDGTOPO,
	coalesce(a.cd_morfologia_tu_prim, ' ') CDGMORFO,
	coalesce(a.cd_estadio, ' ') EC,
	coalesce(a.cd_tumor_primario, ' ') T,
	coalesce(a.cd_linfonodo_regional, ' ') N,
	coalesce(a.cd_metastase_distancia, ' ') M,
	coalesce(a.cd_estadio_outro, ' ') OUTRACLA,
	coalesce(a.cd_tumor_prim_pat, ' ') PT,
	coalesce(a.cd_linfonodo_reg_pat, ' ') PN,
	coalesce(a.cd_metastase_dist_pat, ' ') PM,
	coalesce(a.cd_topog_md_prim, ' ') META01,
	coalesce(a.cd_topog_md_seg, ' ') META02,
	coalesce(a.cd_topog_md_ter, ' ') META03,
	coalesce(a.cd_topog_md_qua, ' ') META04,
	coalesce(to_char(a.dt_inicio_trat,'DD/MM/YYYY'), ' ') DTATRAT,
	coalesce(CASE WHEN a.ie_trat_instituicao='N' THEN '0' WHEN a.ie_trat_instituicao='S' THEN '1' END , ' ') NENHUM,
	coalesce(CASE WHEN a.ie_trat_inst_cir='N' THEN '0' WHEN a.ie_trat_inst_cir='S' THEN '1' END , ' ') CIRURGIA,
	coalesce(CASE WHEN a.ie_trat_inst_radio='N' THEN '0' WHEN a.ie_trat_inst_radio='S' THEN '1' END , ' ') RADIO,
	coalesce(CASE WHEN a.ie_trat_inst_quimio='N' THEN '0' WHEN a.ie_trat_inst_quimio='S' THEN '1' END , ' ') QUIMIO,
	coalesce(CASE WHEN a.ie_trat_inst_horm='N' THEN '0' WHEN a.ie_trat_inst_horm='S' THEN '1' END , ' ') HORMO,
	coalesce(CASE WHEN a.ie_trat_inst_tmo='N' THEN '0' WHEN a.ie_trat_inst_tmo='S' THEN '1' END , ' ') TMO,
	coalesce(CASE WHEN a.ie_trat_inst_imuno='N' THEN '0' WHEN a.ie_trat_inst_imuno='S' THEN '1' END , ' ') IMUNO,
	coalesce(CASE WHEN a.ie_trat_inst_outro='N' THEN '0' WHEN a.ie_trat_inst_outro='S' THEN '1' END , ' ') OUTROS,
	coalesce(CASE WHEN a.ie_trat_inst_sem_inf='N' THEN '0' WHEN a.ie_trat_inst_sem_inf='S' THEN '1' END , ' ') SEMINFORMA,
	coalesce(CASE WHEN a.ie_nenhum_ant='N' THEN '0' WHEN a.ie_nenhum_ant='S' THEN '1' END , ' ') NENHUMANT,
	coalesce(CASE WHEN a.ie_cirurgi_ant='N' THEN '0' WHEN a.ie_cirurgi_ant='S' THEN '1' END , ' ') CIRURGIANT,
	coalesce(CASE WHEN a.ie_radio_ant='N' THEN '0' WHEN a.ie_radio_ant='S' THEN '1' END , ' ') RADIOANT,
	coalesce(CASE WHEN a.ie_quimio_ant='N' THEN '0' WHEN a.ie_quimio_ant='S' THEN '1' END , ' ') QUIMIOANT,
	coalesce(CASE WHEN a.ie_hormo_ant='N' THEN '0' WHEN a.ie_hormo_ant='S' THEN '1' END , ' ') HORMOANT,
	coalesce(CASE WHEN a.ie_tmo_ant='N' THEN '0' WHEN a.ie_tmo_ant='S' THEN '1' END , ' ') TMOANT,
	coalesce(CASE WHEN a.ie_imuno_ant='N' THEN '0' WHEN a.ie_imuno_ant='S' THEN '1' END , ' ') IMUNOANT,
	coalesce(CASE WHEN a.ie_outros_ant='N' THEN '0' WHEN a.ie_outros_ant='S' THEN '1' END , ' ') OUTROSANT,
	coalesce(CASE WHEN a.ie_seminfo_ant='N' THEN '0' WHEN a.ie_seminfo_ant='S' THEN '1' END , ' ') SEMINFOAN,
	coalesce(CASE WHEN a.ie_nenhum_ap='N' THEN '0' WHEN a.ie_nenhum_ap='S' THEN '1' END , ' ') NENHUMAP,
	coalesce(CASE WHEN a.ie_cirurgi_ap='N' THEN '0' WHEN a.ie_cirurgi_ap='S' THEN '1' END , ' ') CIRURGIAP,
	coalesce(CASE WHEN a.ie_radio_ap='N' THEN '0' WHEN a.ie_radio_ap='S' THEN '1' END , ' ') RADIOAP,
	coalesce(CASE WHEN a.ie_quimio_ap='N' THEN '0' WHEN a.ie_quimio_ap='S' THEN '1' END , ' ') QUIMIOAP,
	coalesce(CASE WHEN a.ie_hormo_ap='N' THEN '0' WHEN a.ie_hormo_ap='S' THEN '1' END , ' ') HORMOAP,
	coalesce(CASE WHEN a.ie_tmo_ap='N' THEN '0' WHEN a.ie_tmo_ap='S' THEN '1' END , ' ') TMOAP,
	coalesce(CASE WHEN a.ie_imuno_ap='N' THEN '0' WHEN a.ie_imuno_ap='S' THEN '1' END , ' ') IMUNOAP,
	coalesce(CASE WHEN a.ie_outros_ap='N' THEN '0' WHEN a.ie_outros_ap='S' THEN '1' END , ' ') OUTROSAP,
	coalesce(CASE WHEN a.ie_seminfo_ap='N' THEN '0' WHEN a.ie_seminfo_ap='S' THEN '1' END , ' ') SEMINFOAP,
	a.cd_razao_nao_trat CDGNAOTRAT,
	a.ie_estado_pac_fim_trat CDGSITUA,
	coalesce(to_char(a.dt_obito,'DD/MM/YYYY'), ' ') DTAOBITO,
	coalesce(CASE WHEN a.dt_obito IS NULL THEN null  ELSE 'A' END , ' ') TPOOBITO,
	coalesce(to_char(a.dt_preench_ficha,'DD/MM/YYYY'), ' ') DTAPREENC,
	coalesce(substr(obter_desc_can_lateralidade(a.cd_lateralidade),1,12), ' ') LATERALIDA,
	coalesce(a.ds_observacao, ' ') OBS,
	coalesce(substr(CASE WHEN c.nr_telefone IS NULL THEN ''  ELSE 'Telefone: '||c.nr_telefone END ||CASE WHEN c.ds_fax IS NULL THEN ''  ELSE ' Fax: '||c.ds_fax END ||CASE WHEN c.ds_fone_adic IS NULL THEN ''  ELSE ' Telefone adic.: '||c.ds_fone_adic END ,1,20), ' ') TELEFONE,
	coalesce(substr(obter_nome_mae_pf(a.cd_pessoa_fisica),1,50), ' ') NOMEMAE,
	coalesce(a.cd_pessoa_fisica, ' ') CD_PESSOA_FISICA,
	a.dt_liberacao,
	a.dt_diagnostico,
	a.dt_consulta,
	a.dt_inicio_trat,
	coalesce(a.dt_inicio_trat, pkg_date_utils.get_date(1000)) dt_inicio_trat2,
	a.dt_obito,
	coalesce(a.dt_obito, pkg_date_utils.get_date(1000)) dt_obito2,
	'A' ie_pasta,
	' ' DTASEGUIM,
	' ' CDGRECSEG,
	null DTARECIDIV,
	' ' REC01,
	' ' REC02,
	' ' REC03,
	' ' REC04,
	0 CDGSITSEG,
	0 ie_situacao_clinica,
	0 nr_seq_ficha_admissao,
        coalesce(CASE WHEN a.ie_custo_diagnostico=1 THEN 'SUS' WHEN a.ie_custo_diagnostico=2 THEN 'CONVENIO' WHEN a.ie_custo_diagnostico=3 THEN 'PARTICULAR' END , ' ') CATATEND
FROM can_ficha_admissao a, pessoa_fisica b
LEFT OUTER JOIN compl_pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica  and (c.ie_tipo_complemento = 1 or c.ie_tipo_complemento is null)

union all

	SELECT	a.nr_prontuario,
	coalesce(d.nm_pessoa_fisica, ' ') NOME,
	CASE WHEN coalesce(coalesce(d.nr_cpf,d.nr_identidade),6)=d.nr_cpf THEN 4 WHEN coalesce(coalesce(d.nr_cpf,d.nr_identidade),6)=d.nr_identidade THEN 2  ELSE 6 END   TIPODOC,
	coalesce(coalesce(d.nr_cpf,d.nr_identidade), ' ') NMRDOC,
	coalesce(TO_CHAR(d.dt_nascimento,'DD/MM/YYYY'), ' ') DTANASC,
	CASE WHEN d.ie_sexo='M' THEN 1 WHEN d.ie_sexo='F' THEN 2 END  SEXO,
	CASE WHEN d.ie_grau_instrucao=1 THEN 1 WHEN d.ie_grau_instrucao=7 THEN 2 WHEN d.ie_grau_instrucao=2 THEN 3 WHEN d.ie_grau_instrucao=3 THEN 4 WHEN d.ie_grau_instrucao=4 THEN 5  ELSE 9 END  INSTRUC,
	coalesce(d.sg_emissora_ci, ' ') UFNASC,
	coalesce(c.ds_endereco, ' ') ENDERECO,
	coalesce(c.nr_endereco, c.ds_compl_end) NUMERO,
	coalesce(c.ds_complemento, ' ') COMPLEMENT,
	coalesce(c.cd_cep, ' ') CEP,
	coalesce(c.cd_municipio_ibge, ' ') CDGIBGE,
	coalesce(c.sg_estado, ' ') UFRESID,
	coalesce(TO_CHAR(b.dt_consulta,'DD/MM/YYYY'), ' ') DTACONSULT,
	coalesce(SUBSTR(Obter_Codigo_Clinica_Cancer(b.cd_clinica_atendimento),1,3), ' ') CDGCLINI,
	b.ie_diag_trat_previo CDGDIAGPRE,
	coalesce(TO_CHAR(b.dt_diagnostico,'dd/mm/yyyy'), ' ') DTADIAG,
	b.cd_base_diag CDGBASEDIA,
	coalesce(a.cd_topografia, ' ') CDGTOPO,
	coalesce(a.cd_morfologia, ' ') CDGMORFO,
	coalesce(b.cd_estadio, ' ') EC,
	coalesce(b.cd_tumor_primario, ' ') T,
	coalesce(b.cd_linfonodo_regional, ' ') N,
	coalesce(b.cd_metastase_distancia, ' ') M,
	coalesce(b.cd_estadio_outro, ' ') OUTRACLA,
	coalesce(b.cd_tumor_prim_pat, ' ') PT,
	coalesce(b.cd_linfonodo_reg_pat, ' ') PN,
	coalesce(b.cd_metastase_dist_pat, ' ') PM,
	coalesce(b.cd_topog_md_prim, ' ') META01,
	coalesce(b.cd_topog_md_seg, ' ') META02,
	coalesce(b.cd_topog_md_ter, ' ') META03,
	coalesce(b.cd_topog_md_qua, ' ') META04,
	coalesce(TO_CHAR(b.dt_inicio_trat,'DD/MM/YYYY'), ' ') DTATRAT,
	coalesce(CASE WHEN a.ie_proced_terap_nenhum='N' THEN '0' WHEN a.ie_proced_terap_nenhum='S' THEN '1' END , ' ') NENHUM,
	coalesce(CASE WHEN a.ie_proced_terap_cir='N' THEN '0' WHEN a.ie_proced_terap_cir='S' THEN '1' END , ' ') CIRURGIA,
	coalesce(CASE WHEN a.ie_proced_terap_radio='N' THEN '0' WHEN a.ie_proced_terap_radio='S' THEN '1' END , ' ') RADIO,
	coalesce(CASE WHEN a.ie_proced_terap_quimio='N' THEN '0' WHEN a.ie_proced_terap_quimio='S' THEN '1' END , ' ') QUIMIO,
	coalesce(CASE WHEN a.ie_proced_terap_hormo='N' THEN '0' WHEN a.ie_proced_terap_hormo='S' THEN '1' END , ' ') HORMO,
	coalesce(CASE WHEN a.ie_proced_terap_tmo='N' THEN '0' WHEN a.ie_proced_terap_tmo='S' THEN '1' END , ' ') TMO,
	coalesce(CASE WHEN a.ie_proced_terap_imuno='N' THEN '0' WHEN a.ie_proced_terap_imuno='S' THEN '1' END , ' ') IMUNO,
	coalesce(CASE WHEN a.ie_proced_terap_outro='N' THEN '0' WHEN a.ie_proced_terap_outro='S' THEN '1' END , ' ') OUTROS,
	coalesce(CASE WHEN a.ie_proced_terap_seminfo='N' THEN '0' WHEN a.ie_proced_terap_seminfo='S' THEN '1' END , ' ') SEMINFORMA,
	coalesce(CASE WHEN a.ie_nenhum_ant='N' THEN '0' WHEN a.ie_nenhum_ant='S' THEN '1' END , ' ') NENHUMANT,
	coalesce(CASE WHEN a.ie_cirurgi_ant='N' THEN '0' WHEN a.ie_cirurgi_ant='S' THEN '1' END , ' ') CIRURGIANT,
	coalesce(CASE WHEN a.ie_radio_ant='N' THEN '0' WHEN a.ie_radio_ant='S' THEN '1' END , ' ') RADIOANT,
	coalesce(CASE WHEN a.ie_quimio_ant='N' THEN '0' WHEN a.ie_quimio_ant='S' THEN '1' END , ' ') QUIMIOANT,
	coalesce(CASE WHEN a.ie_hormo_ant='N' THEN '0' WHEN a.ie_hormo_ant='S' THEN '1' END , ' ') HORMOANT,
	coalesce(CASE WHEN a.ie_tmo_ant='N' THEN '0' WHEN a.ie_tmo_ant='S' THEN '1' END , ' ') TMOANT,
	coalesce(CASE WHEN a.ie_imuno_ant='N' THEN '0' WHEN a.ie_imuno_ant='S' THEN '1' END , ' ') IMUNOANT,
	coalesce(CASE WHEN a.ie_outros_ant='N' THEN '0' WHEN a.ie_outros_ant='S' THEN '1' END , ' ') OUTROSANT,
	coalesce(CASE WHEN a.ie_seminfo_ant='N' THEN '0' WHEN a.ie_seminfo_ant='S' THEN '1' END , ' ') SEMINFOAN,
	coalesce(CASE WHEN a.ie_nenhum_ap='N' THEN '0' WHEN a.ie_nenhum_ap='S' THEN '1' END , ' ') NENHUMAP,
	coalesce(CASE WHEN a.ie_cirurgi_ap='N' THEN '0' WHEN a.ie_cirurgi_ap='S' THEN '1' END , ' ') CIRURGIAP,
	coalesce(CASE WHEN a.ie_radio_ap='N' THEN '0' WHEN a.ie_radio_ap='S' THEN '1' END , ' ') RADIOAP,
	coalesce(CASE WHEN a.ie_quimio_ap='N' THEN '0' WHEN a.ie_quimio_ap='S' THEN '1' END , ' ') QUIMIOAP,
	coalesce(CASE WHEN a.ie_hormo_ap='N' THEN '0' WHEN a.ie_hormo_ap='S' THEN '1' END , ' ') HORMOAP,
	coalesce(CASE WHEN a.ie_tmo_ap='N' THEN '0' WHEN a.ie_tmo_ap='S' THEN '1' END , ' ') TMOAP,
	coalesce(CASE WHEN a.ie_imuno_ap='N' THEN '0' WHEN a.ie_imuno_ap='S' THEN '1' END , ' ') IMUNOAP,
	coalesce(CASE WHEN a.ie_outros_ap='N' THEN '0' WHEN a.ie_outros_ap='S' THEN '1' END , ' ') OUTROSAP,
	coalesce(CASE WHEN a.ie_seminfo_ap='N' THEN '0' WHEN a.ie_seminfo_ap='S' THEN '1' END , ' ') SEMINFOAP,
	b.cd_razao_nao_trat CDGNAOTRAT,
	b.ie_estado_pac_fim_trat CDGSITUA,
	coalesce(TO_CHAR(a.dt_obito,'dd/mm/yyyy'), ' ') DTAOBITO,
	coalesce(CASE WHEN a.dt_obito IS NULL THEN NULL  ELSE 'A' END , ' ') TPOOBITO,
	coalesce(TO_CHAR(b.dt_preench_ficha,'DD/MM/YYYY'), ' ')  DTAPREENC,
	coalesce(SUBSTR(obter_desc_can_lateralidade(b.cd_lateralidade),1,12), ' ') LATERALIDA,
	coalesce(SUBSTR(a.ds_observacao,1,250), ' ') OBS,
	coalesce(CASE WHEN c.nr_telefone IS NULL THEN ''  ELSE 'Telefone: '||c.nr_telefone END ||CASE WHEN c.ds_fax IS NULL THEN ''  ELSE ' Fax: '||c.ds_fax END ||CASE WHEN c.ds_fone_adic IS NULL THEN ''  ELSE ' Telefone adic.: '||c.ds_fone_adic END , ' ') TELEFONE,
	coalesce(SUBSTR(obter_nome_mae_pf(a.cd_pessoa_fisica),1,50), ' ') NOMEMAE,
	coalesce(b.cd_pessoa_fisica, ' ') CD_PESSOA_FISICA,
	b.dt_liberacao,
	b.dt_diagnostico,
	b.dt_consulta,
	b.dt_inicio_trat,
	coalesce(b.dt_inicio_trat, pkg_date_utils.get_date(1000)) dt_inicio_trat2,
	b.dt_obito,
	coalesce(b.dt_obito, pkg_date_utils.get_date(1000)) dt_obito2,
	'S',
	coalesce(TO_CHAR(a.dt_seguimento,'DD/MM/YYYY'), ' ') dt_seguimento,
	coalesce(a.cd_topografia_recidiva, ' ') cd_topografia_recidiva,
	a.dt_recidiva,
	coalesce(a.cd_topografia_recidiva1, ' ') cd_topografia_recidiva1,
	coalesce(a.cd_topografia_recidiva2, ' ') cd_topografia_recidiva2,
	coalesce(a.cd_topografia_recidiva3, ' ') cd_topografia_recidiva3,
	coalesce(a.cd_topografia_recidiva4, ' ') cd_topografia_recidiva4,
	a.cd_estado_doenca,
	a.ie_situacao_clinica,
	nr_seq_ficha_admissao,
        coalesce(CASE WHEN b.ie_custo_diagnostico=1 THEN 'SUS' WHEN b.ie_custo_diagnostico=2 THEN 'CONVENIO' WHEN b.ie_custo_diagnostico=3 THEN 'PARTICULAR' END , ' ') CATATEND
FROM can_ficha_admissao b, can_ficha_seguimento a, pessoa_fisica d
LEFT OUTER JOIN compl_pessoa_fisica c ON (d.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE b.nr_sequencia = a.nr_seq_ficha_admissao AND a.cd_pessoa_fisica = d.cd_pessoa_fisica  AND (c.ie_tipo_complemento = 1 OR c.ie_tipo_complemento IS NULL) order by NOME;

