-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW honorario_medico_v (dt_mesano_referencia, cd_convenio, nr_seq_protocolo, nr_protocolo, ie_status_protocolo, dt_periodo_inicial, dt_periodo_final, ie_tipo_protocolo, dt_mesano_ref_par, cd_setor_atendimento, cd_setor_receita, cd_medico_executor, nm_medico, ie_tipo_servico_sus, ie_origem_proced, ie_responsavel_credito, vl_medico, vl_medico_honorario, vl_auxiliares, vl_anestesista, ie_tipo_atendimento, ie_tipo_convenio, nr_interno_conta, ie_resp) AS select 	e.dt_mesano_referencia,
	e.cd_convenio,
	e.nr_seq_protocolo,
	e.nr_protocolo,
	e.ie_status_protocolo,
	e.dt_periodo_inicial,
	e.dt_periodo_final,
	e.ie_tipo_protocolo,
	e.dt_mesano_ref_par,
	a.cd_setor_atendimento,
	a.cd_setor_receita,
	a.cd_medico_executor,
	g.nm_pessoa_fisica  nm_medico,
	coalesce(a.ie_tipo_servico_sus,0) ie_tipo_servico_sus,
	a.ie_origem_proced,
	CASE WHEN a.ie_responsavel_credito IS NULL THEN 		CASE WHEN f.ie_conveniado='S' THEN 'S'  ELSE 'N' END   ELSE CASE WHEN w.ie_entra_conta='S' THEN 'N'  ELSE 'S' END  END  ie_responsavel_credito,
	coalesce(a.vl_medico,0) vl_medico,
	coalesce(a.vl_medico,0) + coalesce(a.vl_auxiliares,0) + coalesce(a.vl_anestesista,0) vl_medico_honorario,
	coalesce(a.vl_auxiliares,0) vl_auxiliares,
	coalesce(a.vl_anestesista,0) vl_anestesista,
	b.ie_tipo_atendimento,
	b.ie_tipo_convenio,
	c.nr_interno_conta,
	a.ie_responsavel_credito ie_resp
FROM pessoa_fisica g, protocolo_convenio e, conta_paciente c, atendimento_paciente b, procedimento_paciente a
LEFT OUTER JOIN medico_convenio f ON (a.cd_convenio = f.cd_convenio AND a.cd_medico_executor = f.cd_pessoa_fisica)
LEFT OUTER JOIN regra_honorario w ON (a.ie_responsavel_credito = w.cd_regra AND 'M' = w.ie_coluna_soma)
WHERE a.nr_interno_conta 	= c.nr_interno_conta and c.nr_atendimento 		= b.nr_atendimento and c.nr_seq_protocolo 	= e.nr_seq_protocolo and a.cd_motivo_exc_conta 	is null   and a.cd_medico_executor 	= g.cd_pessoa_fisica  and coalesce(Obter_Se_Medico_Conveniado(b.cd_estabelecimento, a.cd_medico_executor,
	a.cd_convenio, null, null,null,a.cd_setor_atendimento, null, null, b.ie_tipo_atendimento, null), 'N') = 'S'
union all

select 	e.dt_mesano_referencia,
	e.cd_convenio,
	e.nr_seq_protocolo,
	e.nr_protocolo,
	e.ie_status_protocolo,
	e.dt_periodo_inicial,
	e.dt_periodo_final,
	e.ie_tipo_protocolo,
	e.dt_mesano_ref_par,
	a.cd_setor_atendimento,
	a.cd_setor_receita,
	h.cd_pessoa_fisica,
	g.nm_pessoa_fisica nm_medico,
	coalesce(a.ie_tipo_servico_sus,0) ie_tipo_servico_sus,
	a.ie_origem_proced,
	CASE WHEN h.ie_responsavel_credito IS NULL THEN 		CASE WHEN f.ie_conveniado='S' THEN 'S'  ELSE 'N' END   ELSE CASE WHEN w.ie_entra_conta='S' THEN 'N'  ELSE 'S' END  END  ie_responsavel_credito,
	CASE WHEN h.ie_responsavel_credito IS NULL THEN h.vl_participante  ELSE h.vl_conta END  vl_medico,
	CASE WHEN h.ie_responsavel_credito IS NULL THEN h.vl_participante  ELSE h.vl_conta END  vl_medico_honorario,
	0 vl_auxiliares,
	0 vl_anestesista,
	b.ie_tipo_atendimento,
	b.ie_tipo_convenio,
	c.nr_interno_conta,
	a.ie_responsavel_credito ie_resp
FROM pessoa_fisica g, protocolo_convenio e, conta_paciente c, atendimento_paciente b, procedimento_paciente a, procedimento_participante_v h
LEFT OUTER JOIN medico_convenio f ON (h.cd_convenio = f.cd_convenio AND h.cd_pessoa_fisica = f.cd_pessoa_fisica)
LEFT OUTER JOIN regra_honorario w ON (h.ie_responsavel_credito = w.cd_regra AND 'M' = w.ie_coluna_soma)
WHERE a.nr_interno_conta 	= c.nr_interno_conta and a.nr_sequencia 		= h.nr_sequencia and c.nr_atendimento 		= b.nr_atendimento and c.nr_seq_protocolo		= e.nr_seq_protocolo and a.cd_motivo_exc_conta 	is null   and h.cd_pessoa_fisica 	= g.cd_pessoa_fisica and coalesce(Obter_Se_Medico_Conveniado(b.cd_estabelecimento, h.cd_pessoa_fisica,
		a.cd_convenio, null, null,null,a.cd_setor_atendimento, null, null, b.ie_tipo_atendimento, null), 'N') = 'S';

