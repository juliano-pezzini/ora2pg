-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mprev_partic_ciclo_item_v (nr_sequencia, dt_prevista, ie_status, dt_execucao, dt_cancelamento, nr_seq_motivo_desvio, ie_forma_atend_prev, nr_seq_plano_atend_item, nr_atendimento_ciclo, nr_seq_participante, nr_seq_programa, nr_seq_modulo, nr_seq_prog_partic_mod, dt_entrada_modulo, dt_saida_modulo, ds_motivo_saida_modulo, nr_seq_ciclo, dt_inicio_ciclo, dt_fim_ciclo, ie_status_cronica, ie_situacao, ie_ag_cancel, dt_agendamento, cd_pessoa_fisica, qt_total_periodo_ciclo, nm_programa, ds_modulo, qt_ciclo, ie_tipo_atend, nr_seq_agrupamento, nr_seq_prog_modulo, ie_cancel_troca_mod, nr_seq_classificacao, nr_seq_motivo_agendamento, nr_seq_prog_partic, ie_resultado_visita, ds_observacao, cd_estabelecimento, dt_atualizacao) AS SELECT  d.nr_sequencia,
  d.dt_prevista,
  d.ie_status,
  d.dt_execucao,
  d.dt_cancelamento,
  d.nr_seq_motivo_desvio,
  d.ie_forma_atend_prev,
  d.nr_seq_plano_atend_item,
  d.nr_atendimento_ciclo,
  a.nr_seq_participante,
  a.nr_seq_programa,
  m.nr_seq_modulo,
  b.nr_sequencia nr_seq_prog_partic_mod,
  b.dt_entrada dt_entrada_modulo,
  b.dt_saida dt_saida_modulo,
  b.ds_motivo ds_motivo_saida_modulo,
  c.nr_sequencia nr_seq_ciclo,
  c.dt_inicio_ciclo,
  c.dt_fim_ciclo,
  p.ie_status_cronica,
  p.ie_situacao,
  (select coalesce(CASE WHEN ac.ie_status_agenda='I' THEN  'S' WHEN ac.ie_status_agenda='F' THEN  'S'  ELSE 'N' END ,'N')
 FROM  agenda_consulta ac where
 ac.NR_SEQ_PARTIC_CICLO_ITEM = d.nr_sequencia and ac.ie_status_agenda in ('I', 'F') LIMIT 1) ie_ag_cancel,
  coalesce((SELECT  MAX(x.dt_agenda)
  FROM  mprev_agendamento x
  WHERE  x.nr_seq_partic_ciclo_item = d.nr_sequencia
  AND (x.ie_status_agenda <> 'C' OR x.ie_status_agenda IS NULL)), (SELECT  MAX(x.dt_agenda)
  FROM  agenda_consulta x
  WHERE  x.nr_seq_partic_ciclo_item = d.nr_sequencia
  AND (x.ie_status_agenda <> 'C' OR x.ie_status_agenda IS NULL))) dt_agendamento,
  p.cd_pessoa_fisica,
  z.qt_total_periodo_ciclo,
  pr.nm_programa,
  mo.ds_modulo,
  (SELECT  COUNT(nr_sequencia)
  FROM   mprev_partic_ciclo_atend
  WHERE   nr_seq_prog_partic_mod = b.nr_sequencia)  qt_ciclo,
  (SELECT  coalesce(MAX(ie_tipo_atendimento), 'P')
  FROM  mprev_partic_tipo_atend
  WHERE  nr_seq_participante = p.nr_sequencia
  AND  dt_inicio <= d.dt_prevista
  AND (dt_fim >= d.dt_prevista OR dt_fim IS NULL)) ie_tipo_atend,
  mo.nr_seq_agrupamento,
  m.nr_sequencia nr_seq_prog_modulo,
  d.ie_cancel_troca_mod,
  b.nr_seq_classificacao,
  d.nr_seq_motivo_agendamento,
  a.nr_sequencia nr_seq_prog_partic,
    d.ie_resultado_visita,
  d.ds_observacao,
  pr.cd_estabelecimento,
  d.dt_atualizacao
FROM   mprev_modulo_atend mo,
  mprev_programa pr,
  mprev_plano_atendimento z,
  mprev_plano_atend_item x,
  mprev_programa_partic a,
  mprev_prog_partic_modulo b,
  mprev_programa_modulo m,
  mprev_partic_ciclo_atend c,
  mprev_partic_ciclo_item d,
  mprev_participante p
WHERE   a.nr_sequencia       = b.nr_seq_programa_partic
AND  c.nr_seq_prog_partic_mod  = b.nr_sequencia
AND  d.nr_seq_partic_ciclo_atend   = c.nr_sequencia
AND  b.nr_seq_prog_modulo    = m.nr_sequencia
AND  p.nr_sequencia      = a.nr_seq_participante
AND  d.nr_seq_plano_atend_item  = x.nr_sequencia
AND  x.nr_seq_plano_atend    = z.nr_sequencia
AND  a.nr_seq_programa    = pr.nr_sequencia
AND  m.nr_seq_modulo      = mo.nr_sequencia

UNION

SELECT   d.nr_sequencia,
  d.dt_prevista,
  d.ie_status,
  d.dt_execucao,
  d.dt_cancelamento,
  d.nr_seq_motivo_desvio,
  d.ie_forma_atend_prev,
  d.nr_seq_plano_atend_item,
  coalesce(d.nr_atendimento_ciclo,0),
  a.nr_seq_participante,
  a.nr_seq_programa,
  NULL nr_seq_modulo,
  NULL nr_seq_prog_partic_mod,
  NULL dt_entrada_modulo,
  NULL dt_saida_modulo,
  NULL ds_motivo_saida_modulo,
  NULL nr_seq_ciclo,
  NULL dt_inicio_ciclo,
  NULL dt_fim_ciclo,
  NULL ie_status_cronica,
  NULL ie_situacao,
  (select coalesce(CASE WHEN ac.ie_status_agenda='I' THEN  'S' WHEN ac.ie_status_agenda='F' THEN  'S'  ELSE 'N' END ,'N')
 from  agenda_consulta ac where
 ac.NR_SEQ_PARTIC_CICLO_ITEM = d.nr_sequencia and ac.ie_status_agenda in ('I', 'F') LIMIT 1) ie_ag_cancel,
  coalesce((SELECT  MAX(x.dt_agenda)
  FROM  mprev_agendamento x
  WHERE  x.nr_seq_partic_ciclo_item = d.nr_sequencia
  AND (x.ie_status_agenda <> 'C' OR x.ie_status_agenda IS NULL)), (SELECT  MAX(x.dt_agenda)
  FROM  agenda_consulta x
  WHERE  x.nr_seq_partic_ciclo_item = d.nr_sequencia
  AND (x.ie_status_agenda <> 'C' OR x.ie_status_agenda IS NULL))) dt_agendamento,
  mprev_obter_dados_partic(a.nr_seq_participante,LOCALTIMESTAMP,'PF') cd_pessoa_fisica,
  0 qt_total_periodo_ciclo,
  f.nm_programa,
  NULL ds_modulo,
  0 qt_ciclo,
  (SELECT  coalesce(MAX(ie_tipo_atendimento), 'P')
  FROM  mprev_partic_tipo_atend
  WHERE  nr_seq_participante = a.nr_seq_participante
  AND  dt_inicio <= d.dt_prevista
  AND (dt_fim >= d.dt_prevista OR dt_fim IS NULL)) ie_tipo_atend,
  NULL nr_seq_agrupamento,
  NULL nr_seq_prog_modulo,
  d.ie_cancel_troca_mod,
  NULL nr_seq_classificacao,
  d.nr_seq_motivo_agendamento,
  a.nr_sequencia nr_seq_prog_partic,
  d.ie_resultado_visita,
  d.ds_observacao,
  f.cd_estabelecimento,
  d.dt_atualizacao 
FROM  mprev_programa_partic a,
  mprev_partic_ciclo_item d,
  mprev_programa f
WHERE  a.nr_sequencia = d.nr_seq_programa_partic
AND  f.nr_sequencia = a.nr_seq_programa;

