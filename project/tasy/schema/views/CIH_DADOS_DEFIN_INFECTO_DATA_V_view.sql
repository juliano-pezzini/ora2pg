-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cih_dados_defin_infecto_data_v (ie_tipo_definicao, dt_entrada, dt_prescricao, nr_atendimento, nr_prescricao, dt_prescricao_b, nm_paciente, nm_medico_prescritor, ds_medicamento, ds_indicacao, ds_observacao, cd_pessoa_fisica, dt_alta, cd_medico_resp, nr_prontuario, cd_estabelecimento) AS select	distinct
	'S' ie_tipo_definicao, 
	a.dt_entrada, 
	k.dt_prescricao, 
	a.nr_atendimento, 
	k.nr_prescricao, 
	to_char(k.dt_prescricao,'dd/mm/yyyy') dt_prescricao_b, 
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,100) nm_paciente, 
	substr(obter_nome_pf(k.cd_medico),1,100) nm_medico_prescritor, 
	substr(obter_desc_medic_cih(o.cd_medicamento),1,100) ds_medicamento, 
	substr(obter_valor_dominio(1927, l.ie_indicacao),1,150) ds_indicacao, 
	o.ds_observacao, 
	a.cd_pessoa_fisica, 
	a.dt_alta, 
	a.cd_medico_resp, 
	i.nr_prontuario, 
	a.cd_estabelecimento 
FROM cih_def_infect o, material n, prescr_medica k, pessoa_fisica j, pessoa_fisica i, unidade_atendimento g, setor_atendimento f, convenio e, categoria_convenio d, atend_categoria_convenio c, atend_paciente_unidade b, prescr_material l
LEFT OUTER JOIN prescr_material_cid m ON (l.nr_prescricao = m.nr_prescricao AND l.nr_sequencia = m.nr_sequencia_medic)
, atendimento_paciente a
LEFT OUTER JOIN cih_ficha_ocorrencia_hist h ON (a.nr_atendimento = h.nr_atendimento)
WHERE 1 = 1 and f.cd_classif_setor in (3,4) and o.nr_prescricao		= k.nr_prescricao and l.nr_prescricao		= k.nr_prescricao   and l.cd_material		= n.cd_material and n.ie_controle_medico 	> 0 and k.nr_cirurgia is null and not exists (select	1 
			from	cirurgia g 
			where	g.nr_prescricao = k.nr_prescricao) and k.nr_atendimento	= a.nr_atendimento and f.cd_setor_atendimento	= g.cd_setor_atendimento and g.nr_atendimento	= a.nr_atendimento and g.nr_atendimento	= b.nr_atendimento and g.dt_entrada_unidade	= b.dt_entrada_unidade and a.cd_medico_resp	= j.cd_pessoa_fisica and a.cd_pessoa_fisica	= i.cd_pessoa_fisica and c.nr_seq_interno	= obter_atecaco_atendimento(g.nr_atendimento) and c.cd_convenio		= e.cd_convenio and c.cd_convenio		= d.cd_convenio and c.cd_categoria		= d.cd_categoria  
union
 
select	distinct 
	'N' ie_tipo_definicao, 
	a.dt_entrada, 
	k.dt_prescricao, 
	a.nr_atendimento, 
	k.nr_prescricao, 
	to_char(k.dt_prescricao,'dd/mm/yyyy') dt_prescricao_b, 
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,100) nm_paciente, 
	substr(obter_nome_pf(k.cd_medico),1,100) nm_medico_prescritor, 
	null ds_medicamento, 
	substr(obter_valor_dominio(1927, l.ie_indicacao),1,150) ds_indicacao, 
	null ds_observacao, 
	a.cd_pessoa_fisica, 
	a.dt_alta, 
	a.cd_medico_resp, 
	i.nr_prontuario, 
	a.cd_estabelecimento 
FROM material n, prescr_medica k, pessoa_fisica j, pessoa_fisica i, unidade_atendimento g, setor_atendimento f, convenio e, categoria_convenio d, atend_categoria_convenio c, atend_paciente_unidade b, prescr_material l
LEFT OUTER JOIN prescr_material_cid m ON (l.nr_prescricao = m.nr_prescricao AND l.nr_sequencia = m.nr_sequencia_medic)
, atendimento_paciente a
LEFT OUTER JOIN cih_ficha_ocorrencia_hist h ON (a.nr_atendimento = h.nr_atendimento)
WHERE 1 = 1 and f.cd_classif_setor in (3,4) and l.nr_prescricao		= k.nr_prescricao   and l.cd_material		= n.cd_material and n.ie_controle_medico 	> 0 and k.nr_cirurgia is null and not exists (select	1 
			from	cirurgia g 
			where	g.nr_prescricao = k.nr_prescricao) and k.nr_atendimento	= a.nr_atendimento and f.cd_setor_atendimento	= g.cd_setor_atendimento and g.nr_atendimento	= a.nr_atendimento and g.nr_atendimento	= b.nr_atendimento and g.dt_entrada_unidade	= b.dt_entrada_unidade and a.cd_medico_resp	= j.cd_pessoa_fisica and a.cd_pessoa_fisica	= i.cd_pessoa_fisica and c.nr_seq_interno	= obter_atecaco_atendimento(g.nr_atendimento) and c.cd_convenio		= e.cd_convenio and c.cd_convenio		= d.cd_convenio and c.cd_categoria		= d.cd_categoria  and not exists (select	1 
		  	from	cih_def_infect o 
			where	o.nr_prescricao		= k.nr_prescricao) order by	2, 1;

