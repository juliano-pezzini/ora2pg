-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_lib_hemocomponentes_v (nr_seq_doacao, ds_ini, dt_coleta, nr_bolsa, nr_lote_bolsa, dt_validade_bolsa, cd_barra, ds_derivado, qt_volume, qt_armazenamento, dt_fracionamento, nm_pessoa_fisica, dt_vencimento, nm_marca, nm_usuario_lib, nm_usuario_conferencia, ds_sangue, linha1, linha2, ds1, ds2, ds3, ds4, ds5, ds6, ds9, dsa, dsb, dsc, dsd, dse, dsf, dsg, dsh, dsi, ie_nat, ds_leuco) AS SELECT	a.nr_sequencia nr_seq_doacao,
	SUBSTR(obter_iniciais_nome(NULL,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(obter_nome_pf(a.cd_pessoa_fisica),' de ',' '),' da ',' '),' das ',' '),' do ',' '),' dos ',' ')),1,20) ds_ini, 
	TO_CHAR(a.dt_coleta,'dd/mm/yyyy') dt_coleta, 
	coalesce(a.nr_bolsa,a.nr_sangue) nr_bolsa, 
 		a.nr_lote_bolsa, 
 		TO_CHAR(b.dt_vencimento,'dd/mm/yyyy') dt_validade_bolsa, 
	REPLACE(a.cd_barras_integracao||TO_CHAR(b.nr_seq_derivado,'00'),' ','') cd_barra, 
	SUBSTR(c.ds_derivado,1,30) ds_derivado, 
 		coalesce(b.qt_volume_apos_filtragem,b.qt_volume) qt_volume, 
	c.qt_temp_armazenamento qt_armazenamento, 
	TO_CHAR(b.dt_producao,'dd/mm/yyyy hh24:mi') dt_fracionamento, 
	SUBSTR(abrevia_nome_pf(d.cd_pessoa_fisica,NULL),1,17) nm_pessoa_fisica, 
	coalesce(to_char(b.dt_validade_apos_filtragem,'dd/mm/yyyy'),TO_CHAR(b.dt_vencimento,'dd/mm/yyyy')) dt_vencimento, 
	SUBSTR(obter_dados_marca_bolsa(a.NR_MARCA_BOLSA, 'DM'),1,100) nm_marca, 
	b.nm_usuario_lib, 
	a.nm_usuario_conferencia, 
	e.ie_tipo_sangue||e.ie_fator_rh ds_sangue, 
	SUBSTR(obter_select_concatenado_bv('			 
		select ds_sigla 
		from (select c.ds_sigla, 
			 		 rownum nr_linha 
				from  san_exame_lote a, 
					  san_exame_realizado b, 
					  san_exame c 
				where a.nr_sequencia = b.nr_seq_exame_lote 
				and	  b.nr_seq_exame = c.nr_sequencia 
				and	  c.ie_exige_senha = ''S'' 
				and	  lower(replace(b.ds_resultado,'' '','''')) in(''negativo'',''nãoreagente'') 
				and	  a.nr_seq_doacao = :nr_sequencia) 
		where	nr_linha between 1 and 11','nr_sequencia='||a.nr_sequencia,','),1,50) linha1, 
	SUBSTR(obter_select_concatenado_bv('			 
		select ds_sigla 
		from (select c.ds_sigla, 
			 		 rownum nr_linha 
				from  san_exame_lote a, 
					  san_exame_realizado b, 
					  san_exame c 
				where a.nr_sequencia = b.nr_seq_exame_lote 
				and	  b.nr_seq_exame = c.nr_sequencia 
				and	  c.ie_exige_senha = ''S'' 
				and	  lower(replace(b.ds_resultado,'' '','''')) in(''negativo'',''nãoreagente'') 
				and	  a.nr_seq_doacao = :nr_sequencia) 
		where	nr_linha between 22 and 11','nr_sequencia='||a.nr_sequencia,','),1,50) linha2, 
	'BOLSA COM 63 ML DE SOLUCAO CPDA1 PARA' ds1, 
	'COLETA DE 450 ML DE SANGUE TOTAL.' ds2, 
	'- NAO ADICIONAR MEDICAMENTOS' ds3, 
	'- NAO PERFURE - PRODUTO ESTERIL' ds4, 
	'LIBERACAO HEMOCOMPONENTE:' ds5, 
	'PESQUISA DE ANTICORPO IRREGULAR:'||(SELECT UPPER(MAX(y.ds_resultado)) FROM san_exame_lote x, san_exame_realizado y WHERE x.nr_sequencia = y.nr_seq_exame_lote AND y.nr_seq_exame = 10) ds6, 
	'SOROLOGIA NAO REAGENTE PARA:' ds9, 
	'' dsA, 
	'' dsB, 
	'IDENTIFICAR ADEQUADAMENTE O RECEPTOR. UTILIZAR UNICAMENTE EQUIPO DE INFUSAO COM' dsC, 
	'FILTRO PADRAO PARA TRANSFUSAO OU COM FILTRO DE LEUCOCITOS PARA USO A BEIRA DO' dsD, 
	'CENTRAL GOIANA DE SOROLOGIA' dsE, 
	'AEROPORTO CEP 74075-030 GOIANIA/GO - RESP TECN. ROBERIO P.A.' dsF, 
	'ALEMIDA CRF 5/1.1964' dsG, 
	'R. 7A N. 1590, ED RIOL SL, 101 ST.' dsH, 
	CASE WHEN e.ie_fator_rh='-' THEN 'CDE - '||(SELECT UPPER(MAX(y.ds_resultado)) FROM san_exame_lote x, san_exame_realizado y WHERE x.nr_sequencia = y.nr_seq_exame_lote AND y.nr_seq_exame = 12)  ELSE '' END  dsI, 
	CASE WHEN a.ie_realiza_nat='S' THEN 'NAT para HIV e HCV'  ELSE '' END  ie_nat, 
	(case 
	when(a.ie_tipo_bolsa = 4) then 
	'HEMOCOMPONENTE LEUCORREDUZIDO' 
	when(b.dt_validade_apos_filtragem is not null) or (b.qt_peso_apos_filtragem is not null) or (b.qt_volume_apos_filtragem is not null) then 
	'HEMOCOMPONENTE LEUCORREDUZIDO' 
	end) ds_leuco 
FROM 	pessoa_fisica d, 
	pessoa_fisica e, 
	san_derivado c, 
	san_doacao a,					 
	san_producao b 
WHERE	a.nr_sequencia = b.nr_seq_doacao 
AND		b.nr_seq_derivado = c.nr_sequencia 
AND		b.CD_PF_REALIZOU = d.cd_pessoa_fisica 
AND		a.cd_pessoa_fisica = e.cd_pessoa_fisica  
AND		a.nm_usuario_conferencia IS NOT NULL 
AND		a.nm_usuario_conferencia_seg IS NOT NULL 
AND		NOT EXISTS (	  SELECT 1 
  FROM	 san_exame_lote e, 
  		 san_exame_realizado f 
	WHERE e.nr_sequencia = f.nr_seq_exame_lote 
	AND	 e.nr_seq_doacao = a.nr_sequencia 
	AND	 REPLACE(UPPER(f.ds_resultado),' ','') IN ('POSITIVO','ANDAMENTO','INDETERMINADO'));

