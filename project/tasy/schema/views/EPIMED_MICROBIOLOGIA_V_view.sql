-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW epimed_microbiologia_v (medical_record, dt_request, birthdate, attendance_number, id_exam, dt_execution, cd_exam, exam_name, cd_specimen, specimen_name, dt_result, cd_pathogen, pathogen_name, kpc, esbl, cd_atb, atb_name, mic, atb_result, obs_pathogem, update_date, nr_prescricao) AS select m.cd_pessoa_fisica medical_record,
       to_char(m.dt_prescricao,'yyyy/MM/dd HH:mm:ss') dt_request,
       to_char(pf.dt_nascimento,'yyyy/MM/dd') birthdate,
       m.nr_atendimento attendance_number,
       p.nr_seq_exame id_exam,
      to_char(med_obter_data_coleta(p.nr_prescricao,p.nr_sequencia,20),'yyyy/MM/dd HH:mm:ss') dt_execution,
       ex.cd_exame cd_exam,
       ex.nm_exame exam_name,
       f.cd_material_exame cd_specimen,
       f.ds_material_exame specimen_name,
       l.dt_resultado dt_result,
       a.cd_microorganismo cd_pathogen,
       obter_desc_microorg_grupo(a.cd_microorganismo) pathogen_name,
       CASE WHEN lower(substr(obter_resultado_exame_ext(i.nr_seq_resultado, i.nr_sequencia),1,255))='positivo' THEN '1'  ELSE '0' END  kpc,
       CASE WHEN lower(substr(obter_resultado_exame_ext(i.nr_seq_resultado, i.nr_sequencia),1,255))='positivo' THEN '1'  ELSE '0' END  esbl,
       a.cd_medicamento cd_atb,
       obter_desc_medic_cih(a.cd_medicamento) ATB_NAME,
       a.QT_MIC MIC,
       a.ie_resultado atb_result,
       '' obs_pathogem,
       a.dt_atualizacao update_date,
       m.nr_prescricao
FROM prescr_medica m
join pessoa_fisica pf on pf.cd_pessoa_fisica = m.cd_pessoa_fisica
join prescr_procedimento p on m.nr_prescricao = p.nr_prescricao
join exame_laboratorio ex on ex.nr_seq_exame = p.nr_seq_exame
join material_exame_lab f on p.cd_material_exame = f.cd_material_exame
join exame_lab_result_item i on 	i.nr_seq_prescr = p.nr_sequencia and 	i.nr_seq_exame = p.nr_seq_exame
join exame_lab_resultado l  on 	l.nr_prescricao = p.nr_prescricao and l.nr_seq_resultado = i.nr_seq_resultado
join exame_lab_result_antib a on 	a.nr_seq_result_item= i.nr_sequencia	and 	a.nr_seq_resultado= i.nr_seq_resultado
where p.nr_seq_exame is not null
and p.ie_status_atend >= 35
and a.ie_resultado <>'N';

