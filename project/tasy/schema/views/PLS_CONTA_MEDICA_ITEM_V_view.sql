-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_medica_item_v (ie_tipo_item, ie_tipo_despesa, ds_tipo_despesa, nr_seq_item, qt_ocorrencias, vl_apresentado, vl_lib_sistema, vl_pendente, vl_lib_usuario, vl_glosa, vl_liberado, vl_saldo, ie_status_item, dt_proc_mat, cd_proc_mat, ie_origem_proc_mat, ds_proc_mat, ie_status_protocolo, cd_prestador_prot, nm_prestador, nr_seq_protocolo, ie_situacao_prot, dt_competencia_protocolo, ie_tipo_segurado, nr_seq_segurado, nr_seq_conta, dt_autorizacao, nr_seq_prestador, dt_protocolo, cd_guia, cd_guia_referencia, nr_seq_contrato, cd_estabelecimento) AS select  'P' ie_tipo_item,
        a.ie_tipo_despesa,
        CASE WHEN a.ie_tipo_despesa=1 THEN  'Procedimentos' WHEN a.ie_tipo_despesa=2 THEN  'Taxas' WHEN a.ie_tipo_despesa=3 THEN  'Di√°rias' WHEN a.ie_tipo_despesa=4 THEN  'Pacotes' END  ds_tipo_despesa,
        a.nr_sequencia nr_seq_item,
        a.qt_procedimento_imp qt_ocorrencias,
        CASE WHEN a.ie_status='D' THEN 0  ELSE a.vl_procedimento_imp END  vl_apresentado,
        CASE WHEN a.ie_status='S' THEN a.vl_liberado  ELSE 0 END  vl_lib_sistema,
        CASE WHEN a.ie_status='L' THEN 0 WHEN a.ie_status='S' THEN 0 WHEN a.ie_status='D' THEN 0 WHEN a.ie_status='C' THEN 0  ELSE a.vl_procedimento_imp END  vl_pendente,
        CASE WHEN a.ie_status='L' THEN a.vl_liberado  ELSE 0 END  vl_lib_usuario,
        a.vl_glosa vl_glosa,
        a.vl_liberado,
        a.vl_saldo vl_saldo,
        a.ie_status ie_status_item,
        a.dt_procedimento dt_proc_mat,
        a.cd_procedimento cd_proc_mat,
        a.ie_origem_proced ie_origem_proc_mat,
        substr(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced), 1, 255) ds_proc_mat,
        c.ie_status ie_status_protocolo,
        substr(pls_obter_cod_prestador(c.nr_seq_prestador, null),1, 255) cd_prestador_prot,
        substr(pls_obter_dados_prestador(c.nr_seq_prestador, 'N'), 1, 255) nm_prestador,
        c.nr_sequencia nr_seq_protocolo,
        c.ie_situacao ie_situacao_prot,
        c.dt_mes_competencia dt_competencia_protocolo,
        b.ie_tipo_segurado,
        b.nr_seq_segurado,
        b.nr_sequencia nr_seq_conta,
        b.dt_autorizacao,
        c.nr_seq_prestador,
        c.dt_protocolo,
        b.cd_guia,
        b.cd_guia_referencia,
        (select x.nr_seq_contrato
        FROM pls_segurado x
        where x.nr_sequencia = b.nr_seq_segurado) nr_seq_contrato,
	b.cd_estabelecimento
from  pls_protocolo_conta  c,
        pls_conta    b,
        pls_conta_proc    a
where   c.ie_tipo_protocolo  in ('C','I')
and     b.nr_seq_protocolo    = c.nr_sequencia
and     a.nr_seq_conta        = b.nr_sequencia

union

select  'M' ie_tipo_item,
        a.ie_tipo_despesa,
        CASE WHEN a.ie_tipo_despesa=1 THEN  'Gases medicinais' WHEN a.ie_tipo_despesa=2 THEN  'Medicamentos' WHEN a.ie_tipo_despesa=3 THEN  'Materiais' WHEN a.ie_tipo_despesa=7 THEN  'OPM' END  ds_tipo_despesa,
        a.nr_sequencia nr_seq_item,
        a.qt_material_imp qt_ocorrencias,
        CASE WHEN a.ie_status='D' THEN 0  ELSE a.vl_material_imp END  vl_apresentado,
        CASE WHEN a.ie_status='S' THEN  a.vl_liberado  ELSE 0 END  vl_lib_sistema,
        CASE WHEN a.ie_status='L' THEN 0 WHEN a.ie_status='S' THEN 0 WHEN a.ie_status='D' THEN 0 WHEN a.ie_status='C' THEN 0  ELSE a.vl_material_imp END  vl_pendente,
        CASE WHEN a.ie_status='L' THEN  a.vl_liberado  ELSE 0 END  vl_lib_usuario,
        a.vl_glosa vl_glosa,
        a.vl_liberado,
        a.vl_saldo vl_saldo,
        a.ie_status ie_status_item,
        a.dt_atendimento dt_proc_mat,
        a.nr_seq_material cd_proc_mat,
        null ie_origem_proc_mat,
        substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL', a.nr_seq_material), 1, 255) ds_proc_mat,
        c.ie_status ie_status_protocolo,
        substr(pls_obter_cod_prestador(c.nr_seq_prestador, null), 1, 255) cd_prestador_prot,
        substr(pls_obter_dados_prestador(c.nr_seq_prestador, 'N'), 1, 255) nm_prestador,
        c.nr_sequencia nr_seq_protocolo,
        c.ie_situacao ie_situacao_prot,
        c.dt_mes_competencia dt_competencia_protocolo,
        b.ie_tipo_segurado,
        b.nr_seq_segurado,
        b.nr_sequencia nr_seq_conta,
        b.dt_autorizacao,
        c.nr_seq_prestador,
        c.dt_protocolo,
        b.cd_guia,
        b.cd_guia_referencia,
        (select x.nr_seq_contrato
        from pls_segurado x
        where x.nr_sequencia = b.nr_seq_segurado) nr_seq_contrato,
	b.cd_estabelecimento
from  pls_protocolo_conta  c,
        pls_conta    b,
        pls_conta_mat    a
where  c.ie_tipo_protocolo  in ('C','I')
and  b.nr_seq_protocolo    = c.nr_sequencia
and  a.nr_seq_conta    = b.nr_sequencia;

