-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ordem_serv_cli_erro_v (qt_ordens_abertas, qt_ordens_processo, qt_ordens_cliente, qt_ordens_encerradas, dt_mes, dt_mes_order, nr_seq_proj) AS SELECT	SUM(qt_ordens_abertas) + SUM(qt_ordens_cliente) + SUM(qt_ordens_encerradas) qt_ordens_abertas,
	SUM(qt_ordens_abertas) qt_ordens_processo, 
	SUM(qt_ordens_cliente) qt_ordens_cliente, 
	SUM(qt_ordens_encerradas) qt_ordens_encerradas, 
	coalesce(TO_CHAR(dt_mes,'dd/mm/yyyy'),'Demais meses') dt_mes, 
	dt_mes dt_mes_order, nr_seq_proj 
FROM (	SELECT	0 qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		SUM(qt_ordens) qt_ordens_encerradas, 
		NULL dt_mes, 
		nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_fim_real,'month') dt_fim_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 3 
		AND	a.ie_classificacao = 'E' 
		GROUP BY	d.nr_seq_proj, TRUNC(a.dt_fim_real,'month')) x 
	WHERE	TRUNC(x.dt_fim_real) < ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) 
	GROUP BY nr_seq_proj 
	
UNION ALL
 
	SELECT	0 qt_ordens_abertas, 
		SUM(qt_ordens) qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		NULL dt_mes, nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_inicio_real,'month') dt_inicio_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		AND	a.ie_classificacao = 'E' 
		AND	a.nr_seq_estagio IN (SELECT  nr_seq_proj 
			FROM   man_estagio_processo 
			WHERE  ie_acao = 2) 
		GROUP BY	d.nr_seq_proj, TRUNC(a.dt_inicio_real,'month')) x 
	WHERE	TRUNC(x.dt_inicio_real) < ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) 
	GROUP BY nr_seq_proj 
	
UNION ALL
 
	SELECT	SUM(qt_ordens) qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		NULL dt_mes, 
		nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_inicio_real,'month') dt_inicio_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		AND	a.ie_classificacao = 'E' 
		AND	a.nr_seq_estagio IN (SELECT  nr_seq_proj 
			FROM   man_estagio_processo 
			WHERE  ie_acao = 3) 
		GROUP BY	d.nr_seq_proj, TRUNC(a.dt_inicio_real,'month')) x 
	WHERE	TRUNC(x.dt_inicio_real) < ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) 
	GROUP BY nr_seq_proj 
	
UNION ALL
 
	SELECT	0 qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		SUM(qt_ordens) qt_ordens_encerradas, 
		TRUNC(x.dt_fim_real,'month'), 
		nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_fim_real,'month') dt_fim_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 3 
		AND	a.ie_classificacao = 'E' 
		GROUP BY	TRUNC(a.dt_fim_real,'month'),d.nr_seq_proj) x 
	WHERE	TRUNC(x.dt_fim_real) BETWEEN ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) AND TRUNC(LOCALTIMESTAMP,'month') 
	GROUP BY	TRUNC(x.dt_fim_real,'month'), nr_seq_proj 
	
UNION ALL
 
	SELECT	0 qt_ordens_abertas, 
		SUM(qt_ordens) qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		TRUNC(x.dt_inicio_real,'month'), 
		nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_inicio_real,'month') dt_inicio_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		AND	a.ie_classificacao = 'E' 
		AND	a.nr_seq_estagio IN (SELECT  nr_seq_proj 
			FROM   man_estagio_processo 
			WHERE  ie_acao = 2) 
		GROUP BY	d.nr_seq_proj, TRUNC(a.dt_inicio_real,'month')) x 
	WHERE	TRUNC(x.dt_inicio_real) BETWEEN ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) AND TRUNC(LOCALTIMESTAMP,'month') 
	GROUP BY	TRUNC(x.dt_inicio_real,'month'), nr_seq_proj 
	
UNION ALL
 
	SELECT	SUM(qt_ordens) qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		TRUNC(x.dt_inicio_real,'month'), 
		nr_seq_proj 
	FROM (SELECT	COUNT(*) qt_ordens, 
			TRUNC(a.dt_inicio_real,'month') dt_inicio_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		AND	a.ie_classificacao = 'E' 
		AND	a.nr_seq_estagio IN (SELECT  nr_seq_proj 
			FROM   man_estagio_processo 
			WHERE  ie_acao = 3) 
		GROUP BY	d.nr_seq_proj, TRUNC(a.dt_inicio_real,'month')) x 
	WHERE	TRUNC(x.dt_inicio_real) BETWEEN ADD_MONTHS(TRUNC(LOCALTIMESTAMP,'month'),-5) AND TRUNC(LOCALTIMESTAMP,'month') 
	GROUP BY	TRUNC(x.dt_inicio_real,'month'), nr_seq_proj) alias69 
GROUP BY	dt_mes, nr_seq_proj;

