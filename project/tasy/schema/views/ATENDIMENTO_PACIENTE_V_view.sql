-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW atendimento_paciente_v (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, dt_alta_interno, cd_motivo_alta, ie_fim_conta, ie_clinica, ie_vinculo_sus, ie_carater_inter_sus, ds_carater_inter_sus, nm_usuario_atend, ds_obs_atendimento, cd_estabelecimento, dt_fim_conta, ie_tipo_atend_bpa, ie_tipo_convenio, ie_permite_visita, ie_status_atendimento, ds_sintoma_paciente, ie_com_alta, dt_entrada_unidade, dt_saida_unidade, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_unidade, cd_tipo_acomod_unid, ds_obs_unidade, cd_convenio, cd_categoria, cd_usuario_convenio, cd_senha, cd_empresa, nm_empresa, cd_tipo_acomod_conv, cd_dependente, ds_dependente, nr_doc_convenio, nr_guia_atend, dt_inicio_vigencia, dt_final_vigencia, dt_validade_carteira, cd_plano_convenio, ds_motivo_alta, ds_tipo_atendimento, ds_setor_atendimento, nm_unidade_basica, nm_unidade_compl, nm_unidade, cd_classif_setor, hr_inicio_prescricao, ds_convenio, ds_categoria, nm_medico, nm_paciente, nm_paciente_assinatura, nr_prontuario_pac, nr_prontuario, dt_nascimento, ds_idade, nr_anos, nr_anos_atendimento, ds_anos, ds_anos_meses_dias, ds_anos_meses, cd_religiao, ie_sexo, ds_sexo, ie_estado_civil, nr_cpf, nr_identidade, nr_telefone_celular, ie_grau_instrucao, nr_cep_cidade_nasc, cd_municipio_ibge, ds_sangue, cd_proc_principal, ds_proc_principal, ds_probabilidade, cd_cid_principal, cd_cid_secundario, ds_clinica, ds_origem_usuario, ds_status_paciente, nr_crm, dt_previsto_alta, qt_dia_internado, qt_dia_internacao, dt_alta_convenio, ds_obs_convenio, nr_seq_atepacu, ds_setor_leito, ie_responsavel, cd_pessoa_responsavel, nm_responsavel, nm_usuario_alta, dt_ultimo_pagto, ie_paciente_isolado, ie_permite_visita_rel, ds_plano, dt_aceite_dif_acomod, nr_seq_unid_int, ie_tipo_sangue, ie_fator_rh, ds_declaracao, nr_dec_obito, ds_end_compl, nm_medico_conta, nr_seq_indicacao, nm_medico_crm, nr_ramal, ds_senha, nr_dia_internado, ds_obs_alta, nr_seq_forma_chegada, nr_cartao_nac_sus, ie_tipo_guia, ds_endereco, cd_cep, ds_bairro, ds_setor_internacao, ds_setor_entrada, cd_sistema_ant, ie_probabilidade_alta, nr_gestante_pre_natal, nr_seq_classificacao, nr_seq_queixa, ds_pagador, hr_entrada, ds_tipo_acomod_conv, nr_seq_tipo_acidente, nr_doc_conv_principal, nr_dnv, cd_cid_atend, ds_dnv_atend, ds_queixa, nm_medico_externo, nm_medico_atendimento, ie_divulgar_obito, ie_tipo_atend_tiss, ie_atend_retorno, dt_internacao, nr_seq_origem, ie_calcular_dif_diaria, ie_cancelado, cd_unidade_atual, cd_unidade_basica_atual, ie_trata_ultima_banda, dt_cancelamento, dt_saida_real, nm_usuario_saida, nr_seq_grau_parentesco, nm_medico_conselho, ds_nivel_urgencia, ie_boletim_inform, ie_leito_adapt, ie_leito_adaptado, dt_saida_temporaria, dt_retorno_saida_temporaria, cd_senha_atend, nr_episodio, nr_seq_episodio, nr_con_card, cd_con_card_type) AS SELECT /*+ INDEX(C ATECACO_ATEPACI_FK_I)*/	A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
	A.DT_ENTRADA,
	A.CD_PESSOA_FISICA,
	A.CD_PROCEDENCIA,
	A.IE_TIPO_ATENDIMENTO,
	A.CD_MEDICO_RESP,
	A.DT_ALTA,
	A.DT_ALTA_INTERNO,
	A.CD_MOTIVO_ALTA,
	A.IE_FIM_CONTA,
	A.IE_CLINICA,
	A.IE_VINCULO_SUS,
	A.IE_CARATER_INTER_SUS,
	SUBSTR(OBTER_VALOR_DOMINIO(802,A.IE_CARATER_INTER_SUS),1,40) DS_CARATER_INTER_SUS,
	A.NM_USUARIO_ATEND,
	A.DS_OBSERVACAO          DS_OBS_ATENDIMENTO,
	A.CD_ESTABELECIMENTO,
	A.DT_FIM_CONTA,
	A.IE_TIPO_ATEND_BPA,
	A.IE_TIPO_CONVENIO,
	A.IE_PERMITE_VISITA,
	A.IE_STATUS_ATENDIMENTO,
	A.DS_SINTOMA_PACIENTE,
	CASE WHEN A.DT_ALTA IS NULL THEN 'N'  ELSE 'S' END  ie_com_alta,
	B.DT_ENTRADA_UNIDADE,
	B.DT_SAIDA_UNIDADE,
	B.CD_SETOR_ATENDIMENTO,
	B.CD_UNIDADE_BASICA,
	B.CD_UNIDADE_COMPL,
	B.CD_UNIDADE_BASICA || ' ' ||B.CD_UNIDADE_COMPL  cd_unidade,
	B.CD_TIPO_ACOMODACAO     CD_TIPO_ACOMOD_UNID,
	B.DS_OBSERVACAO          DS_OBS_UNIDADE,
	C.CD_CONVENIO,
	C.CD_CATEGORIA,
	C.CD_USUARIO_CONVENIO,
	C.CD_SENHA,
	C.CD_EMPRESA,
	substr(Obter_Empresa_Atend(C.nr_atendimento,'A','D'),1,80) NM_EMPRESA,
	C.CD_TIPO_ACOMODACAO     CD_TIPO_ACOMOD_CONV,
	C.CD_DEPENDENTE,
	SUBSTR(OBTER_VALOR_DOMINIO(1034, C.CD_DEPENDENTE),1,30) DS_DEPENDENTE,
	C.NR_DOC_CONVENIO,
	C.NR_DOC_CONVENIO NR_GUIA_ATEND,
	C.DT_INICIO_VIGENCIA,
	C.DT_FINAL_VIGENCIA,
	C.DT_VALIDADE_CARTEIRA,
	C.CD_PLANO_CONVENIO,
	D.DS_MOTIVO_ALTA,
	SUBSTR(OBTER_VALOR_DOMINIO(12, A.ie_tipo_atendimento),1,30) DS_TIPO_ATENDIMENTO,
	S.DS_SETOR_ATENDIMENTO,
	S.NM_UNIDADE_BASICA,
	S.NM_UNIDADE_COMPL,
	S.NM_UNIDADE_BASICA || ' ' ||S.NM_UNIDADE_COMPL  nm_unidade,
	S.CD_CLASSIF_SETOR,
	S.HR_INICIO_PRESCRICAO,
	V.DS_CONVENIO,
	T.DS_CATEGORIA,
	SUBSTR(OBTER_NOME_PF(M.CD_PESSOA_FISICA),1,255) NM_MEDICO,
	SUBSTR(OBTER_NOME_PF(P.CD_PESSOA_FISICA),1,255) NM_PACIENTE,
	SUBSTR(OBTER_NOME_PF(P.CD_PESSOA_FISICA),1,255) NM_PACIENTE_ASSINATURA,
	P.NR_PRONTUARIO NR_PRONTUARIO_PAC,
	(substr(obter_prontuario_pf(A.cd_estabelecimento,A.cd_pessoa_fisica),1,10))::numeric  NR_PRONTUARIO,
	P.DT_NASCIMENTO,
	CASE WHEN Trunc((LOCALTIMESTAMP - P.dt_nascimento)/365.25)=0 THEN 	Trunc((LOCALTIMESTAMP - P.dt_nascimento)/30) || ' ' || SUBSTR(obter_desc_expressao(293251),1,254)  ELSE Trunc((LOCALTIMESTAMP - P.dt_nascimento)/365.25) || ' '|| SUBSTR(obter_desc_expressao(283511),1,254) END  ds_idade,
	somente_numero(SUBSTR(obter_idade(P.dt_nascimento, LOCALTIMESTAMP, 'A'),1,40)) nr_anos,
	Trunc((A.dt_entrada - P.dt_nascimento)/365.25) nr_anos_atendimento,
	substr(obter_idade(P.dt_nascimento, LOCALTIMESTAMP, 'C'),1,40) ds_anos,
	substr(obter_idade(P.dt_nascimento, LOCALTIMESTAMP, 'S'),1,40) ds_anos_meses_dias,
	substr(obter_idade(P.dt_nascimento, LOCALTIMESTAMP, 'AM'),1,40) ds_anos_meses,
	P.CD_RELIGIAO,
	P.IE_SEXO,
	CASE WHEN P.ie_sexo='F' THEN  SUBSTR(obter_desc_expressao(290058),1,254) WHEN P.ie_sexo='M' THEN SUBSTR(obter_desc_expressao(292932),1,254)  ELSE SUBSTR(obter_desc_expressao(489459),1,254) END  ds_Sexo,
	P.IE_ESTADO_CIVIL,
	P.NR_CPF,
	P.NR_IDENTIDADE,
	P.NR_TELEFONE_CELULAR,
	P.IE_GRAU_INSTRUCAO,
	P.NR_CEP_CIDADE_NASC,
	P.cd_municipio_ibge,
	P.IE_TIPO_SANGUE||P.IE_FATOR_RH DS_SANGUE,
	substr(OBTER_PROC_PRINCIPAL(A.NR_ATENDIMENTO, V.CD_CONVENIO, A.IE_TIPO_ATENDIMENTO,0,'C'),1,10) CD_PROC_PRINCIPAL,
	substr(OBTER_PROC_PRINCIPAL(A.NR_ATENDIMENTO, V.CD_CONVENIO, A.IE_TIPO_ATENDIMENTO,0,'D'),1,240) DS_PROC_PRINCIPAL,
	substr(obter_valor_dominio(1267,A.ie_probabilidade_alta),1,40) ds_probabilidade,
	substr(OBTER_CID_ATENDIMENTO(A.NR_ATENDIMENTO,'P'),1,10) CD_CID_PRINCIPAL,
	substr(OBTER_CID_ATENDIMENTO(A.NR_ATENDIMENTO,'S'),1,10) CD_CID_SECUNDARIO,
	SUBSTR(OBTER_VALOR_DOMINIO(17, ie_clinica),1, 30)  DS_CLINICA,
	K.DS_ORIGEM DS_ORIGEM_USUARIO,
	substr(obter_valor_dominio(1060,A.IE_STATUS_ATENDIMENTO),1,30) DS_STATUS_PACIENTE,
	substr(obter_crm_medico(N.cd_pessoa_fisica), 1, 255) NR_CRM,
	A.DT_PREVISTO_ALTA,
	(coalesce(A.DT_ALTA, LOCALTIMESTAMP) - A.DT_ENTRADA) QT_DIA_INTERNADO,
	C.QT_DIA_INTERNACAO,
	(A.DT_ENTRADA + QT_DIA_INTERNACAO) DT_ALTA_CONVENIO,
	C.DS_OBSERVACAO  DS_OBS_CONVENIO,
	B.nr_seq_interno nr_seq_atepacu,
	S.DS_SETOR_ATENDIMENTO||' - '||B.CD_UNIDADE_BASICA||' '||B.CD_UNIDADE_COMPL   DS_SETOR_LEITO,
	A.ie_responsavel,
	A.cd_pessoa_responsavel,
	substr(obter_nome_responsavel(A.nr_atendimento),1,60) nm_responsavel,
	A.nm_usuario_alta,
	C.dt_ultimo_pagto,
	A.IE_PACIENTE_ISOLADO,
	A.IE_PERMITE_VISITA_REL,
	substr(obter_desc_plano(C.cd_convenio, C.cd_plano_convenio),1,80) ds_plano,
	C.dt_aceite_dif_acomod,
	A.nr_seq_unid_int,
	P.ie_tipo_sangue,
	P.ie_fator_rh,
	' ' ds_declaracao,
	' ' NR_DEC_OBITO,
	' ' ds_end_compl,
	' ' nm_medico_conta,
	nr_seq_indicacao,
	substr(obter_nome_medico(M.cd_pessoa_fisica,'P'),1,100) nm_medico_crm,
	obter_ramal_unidade(B.cd_unidade_basica, B.cd_unidade_compl) nr_ramal,
	CASE WHEN coalesce(pkg_i18n.get_user_locale, 'pt_BR')='pt_BR' THEN  A.ds_senha  ELSE null END  ds_senha,
	trunc(coalesce(A.DT_ALTA, LOCALTIMESTAMP) - A.DT_ENTRADA) NR_DIA_INTERNADO,
	ds_obs_alta,
	A.nr_seq_forma_chegada,
	P.nr_cartao_nac_sus,
	C.ie_tipo_guia,
	substr(obter_compl_pf(P.cd_pessoa_fisica, 1, 'E'),1,120) ds_endereco,
	substr(obter_compl_pf(P.cd_pessoa_fisica, 1, 'CEP'),1,15) cd_cep,
	substr(obter_compl_pf(P.cd_pessoa_fisica, 1, 'B'),1,40) ds_bairro,
	substr(obter_setor_atepacu(obter_atepacu_paciente(A.nr_atendimento, 'PI'),1),1,100) ds_setor_internacao,
	substr(obter_setor_atepacu(obter_atepacu_paciente(A.nr_atendimento, 'P'),1),1,100) ds_setor_entrada,
	 P.cd_sistema_ant cd_sistema_ant,
	A.ie_probabilidade_alta,
	A.NR_GESTANTE_PRE_NATAL,
	A.nr_seq_classificacao,
	A.NR_SEQ_QUEIXA,
	substr(Obter_Pagador_Atend(A.nr_atendimento),1,255) ds_pagador, PKG_DATE_UTILS.extract_field('HOUR',dt_entrada) hr_entrada,
	substr(OBTER_DESC_TIPO_ACOMOD(C.cd_tipo_acomodacao),1,100) DS_TIPO_ACOMOD_CONV,
	A.NR_SEQ_TIPO_ACIDENTE, C.NR_DOC_CONV_PRINCIPAL,
	substr(obter_dnv_nascimento(A.nr_atendimento),1,40) nr_dnv, 
	'' cd_cid_atend,
	substr(obter_dnvs_nascimento(A.nr_atendimento),1,255) ds_dnv_atend, 
	substr(obter_desc_queixa(A.NR_SEQ_QUEIXA),1,80) ds_queixa,
	A.NM_MEDICO_EXTERNO,
	substr(obter_nome_pessoa_fisica(A.cd_medico_atendimento, null),1,40) nm_medico_atendimento,
	A.IE_DIVULGAR_OBITO,
	A.ie_tipo_atend_tiss,
	CASE WHEN  A.nr_atend_original IS NULL THEN  'N'  ELSE 'S' END  ie_atend_retorno,
	CASE WHEN obter_classif_setor_min(B.nr_atendimento)=1 THEN  		CASE WHEN A.ie_tipo_atendimento=1 THEN  Obter_Unidade_Atendimento(B.nr_atendimento,'PI','DT')  ELSE to_char(A.dt_entrada, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) END   ELSE to_char(A.dt_entrada, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) END  dt_internacao,
	C.nr_seq_origem,
	B.ie_calcular_dif_diaria,
	coalesce(D.IE_CANCELADO,'N') IE_CANCELADO,
	substr(Obter_Unidade_Atendimento(B.nr_atendimento,'IA','CS'),1,50) cd_unidade_atual,
	substr(Obter_Unidade_Atendimento(B.nr_atendimento,'IA','UB'),1,50) cd_unidade_basica_atual,
	'S' ie_trata_ultima_banda,
	A.dt_cancelamento,
	A.dt_saida_real,
	A.nm_usuario_saida,
	A.nr_seq_grau_parentesco,
	substr(obter_nome_medico(M.cd_pessoa_fisica,'PC'),1,60) nm_medico_conselho,
	substr(coalesce(obter_nivel_urgencia(A.nr_atendimento),SUBSTR(obter_desc_expressao(327119),1,254)),1,100) ds_nivel_urgencia,
	coalesce(A.ie_boletim_inform,'S') ie_boletim_inform,
	substr(Obter_Unidade_Atendimento(B.nr_atendimento,'IA','LA'),1,1) ie_leito_adapt,
	substr(Obter_Unidade_Atendimento(B.nr_atendimento,'IA','LA'),1,1) ie_leito_adaptado,
	B.dt_saida_temporaria,
	B.dt_retorno_saida_temporaria,
	null cd_senha_atend,
	substr(OBTER_EPISODIO_ATEND_TELA(A.nr_atendimento),1,80) nr_episodio,
	substr(OBTER_EPISODIO_ATENDIMENTO(A.nr_atendimento),1,80) nr_seq_episodio,
	C.nr_con_card,
        C.cd_con_card_type
FROM convenio v, categoria_convenio t, setor_atendimento s, pessoa_fisica p, pessoa_fisica m, atend_paciente_unidade b, atend_categoria_convenio c
LEFT OUTER JOIN convenio_origem_usuario k ON (C.NR_SEQ_ORIGEM = K.NR_SEQUENCIA)
, atendimento_paciente a
LEFT OUTER JOIN motivo_alta d ON (A.CD_MOTIVO_ALTA = D.CD_MOTIVO_ALTA)
LEFT OUTER JOIN medico n ON (A.CD_MEDICO_RESP = N.CD_PESSOA_FISICA)
WHERE (A.NR_ATENDIMENTO = B.NR_ATENDIMENTO) and B.nr_Seq_interno = (	select	coalesce(max(x.nr_seq_interno),0)
					from 	atend_paciente_unidade x
					where	X.nr_atendimento = A.nr_atendimento
					and 	coalesce(x.dt_saida_unidade, x.dt_entrada_unidade + 9999)	= 
						(select max(coalesce(V.dt_saida_unidade, V.dt_entrada_unidade + 9999))
						from atend_paciente_unidade v
						where V.nr_atendimento 	= A.nr_atendimento)) AND (A.NR_ATENDIMENTO = C.NR_ATENDIMENTO) and C.nr_seq_interno= 	(	SELECT	/*+ INDEX(Z ATECACO_ATEPACI_FK_I)*/						coalesce(MAX(nr_seq_interno),0)
					FROM 	atend_categoria_convenio z
					WHERE	z.nr_atendimento = A.nr_atendimento
					AND 	z.dt_inicio_vigencia	=	
						(SELECT	MAX(x.dt_inicio_vigencia)
						FROM 	atend_categoria_convenio x
						WHERE 	x.nr_atendimento = A.nr_atendimento))  AND (B.CD_SETOR_ATENDIMENTO	= S.CD_SETOR_ATENDIMENTO) AND (C.CD_CONVENIO		= V.CD_CONVENIO) and (A.CD_MEDICO_RESP	= M.CD_PESSOA_FISICA)  AND (A.CD_PESSOA_FISICA	= P.CD_PESSOA_FISICA)  AND (C.CD_CONVENIO		= T.CD_CONVENIO) AND (C.CD_CATEGORIA		= T.CD_CATEGORIA);

