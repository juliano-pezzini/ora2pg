-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW consulta_externa_validador_v (ie_tipo_registro, cabecario, clues, curpprestador, nombreprestador, primerapellidoprestador, segundoapellidoprestador, tipopersonal, especificatipopersonal, cedulaprofesional, servicioatencion, curppaciente, nombre, primerapellido, segundoapellido, fechanacimiento, entidadnacimiento, edad, claveedad, sexo, seconsideraindigena, spss, numeroafiliacionspss, prospera, folioprospera, imss, numeroafiliacionimss, issste, numeroafiliacionissste, otraafiliacion, numerootraafiliacion, peso, talla, tipodificultad, gradodificultad, origendificultad, migrante, fechaconsulta, relaciontemporal, descripciondiagnostico1, primeravezdiagnostico1, suivecausesdiagnostico1, codigociediagnostico1, descripciondiagnostico2, primeravezdiagnostico2, suivecausesdiagnostico2, codigociediagnostico2, programa, primeravezanio, imc10, sintomaticorespiratoriotb, relaciontemporalembarazo, trimestregestacional, primeravezaltoriesgo, complicacionpordiabetes, complicacioninfeccionurinaria, complicacioneclamsiaeclamsia, complicacionporhemorragia, otrasaccanalisisclinicos, otrasaccprescacidofolico, otrasaccapoyotranslado, puerpera, infeccionpuerperal, aceptapf, peripostmenopausia, its, apoyopsicoemocional, patologiamamariabenigna, cancermamario, colposcopia, cancercervicouterino, ninosanort, pesoparatalla, imc5, pruebaedi, resultadoedi, resultadobatelle, aplicacioncedulacancer, confirmacioncancer, edasrt, edasplantratamiento, recuperadodeshidratacion, numerosobresvsotratamiento, numerosobresvsopromocion, irasrt, irasplantratamiento, neumoniart, informaprevencionaccidentes, lineavida, cartillavacunacion, referidopor, contrarreferido, telemedicina, dt_entrada, cd_pessoa_fisica, nr_atendimento, cd_cgc, ds_convenio, ds_medico) AS select
		--PRESTADOR SERVICO--
		2 ie_tipo_registro,
		'' cabecario,
		pessoa_juridica.cd_internacional clues,
		pessoa_juridica.cd_curp curpprestador,
		pessoa_juridica.ds_razao_social nombreprestador,
		pessoa_juridica.nm_fantasia primerapellidoprestador,
		pessoa_juridica.ds_nome_abrev segundoapellidoprestador,
		(select max(profissional.ie_profissional) FROM atend_profissional profissional where b.nr_atendimento = profissional.nr_atendimento)  tipopersonal,
		(select max(CASE WHEN profissional.ie_profissional='12' THEN obter_desc_expressao(308221) END ) from atend_profissional profissional where b.nr_atendimento = profissional.nr_atendimento) especificatipopersonal,
		(select
		 max(case
			when profissional.ie_profissional in ('2','3','4','6','8')
			then coalesce(pessoa_fisica_medico.ds_codigo_prof, m.nr_crm)
			else '0'
		 end)
		 from atend_profissional profissional where b.nr_atendimento = profissional.nr_atendimento) cedulaprofesional,
		CASE WHEN b.ie_clinica=2 THEN 3 WHEN b.ie_clinica=1 THEN 4 WHEN b.ie_clinica=3 THEN 5 WHEN b.ie_clinica=1000 THEN 6 WHEN b.ie_clinica=1001 THEN 7 WHEN b.ie_clinica=1002 THEN 8 WHEN b.ie_clinica=1004 THEN 9 WHEN b.ie_clinica=1005 THEN 13 WHEN b.ie_clinica=1006 THEN 14 WHEN b.ie_clinica=4 THEN 16 WHEN b.ie_clinica=1007 THEN 17 WHEN b.ie_clinica=1008 THEN 22 WHEN b.ie_clinica=1009 THEN 23 END  servicioatencion,
		--DADOS PACIENTE--
		pf_p.cd_curp curppaciente,
		z.ds_given_name nombre,
		z.ds_family_name primerapellido,
		z.ds_component_name_1 segundoapellido,
		pf_p.dt_nascimento fechanacimiento,
		(select max(ce.cd_entidade)
			from cat_entidade ce, pessoa_fisica pf
			where pf.cd_pessoa_fisica = pf_p.cd_pessoa_fisica
			and upper(obter_valor_dominio(50, pf.sg_estado_nasc)) = upper(ce.ds_entidade)) entidadnacimiento,
		case
			when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') is not null
			then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_inicio_atendimento,'EDAD')
		end as edad,
		case
			when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') is not null
			then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_inicio_atendimento,'CLAVEEDAD')
		end as claveedad,
		pf_p.ie_sexo sexo,
		pf_p.nr_seq_cor_pele seconsideraindigena,
		pf_p.nr_spss spss,
		pf_p.nr_spss numeroafiliacionspss,
		CASE WHEN n.cd_tipo_convenio_mx=13 THEN  1  ELSE 0 END  prospera,
		CASE WHEN n.cd_tipo_convenio_mx=13 THEN  elimina_caractere_especial(substr(p.nr_doc_convenio,1,16)) END  folioprospera,
		CASE WHEN n.cd_tipo_convenio_mx=2 THEN  1  ELSE 0 END  imss,
		CASE WHEN n.cd_tipo_convenio_mx=2 THEN  substr(p.nr_doc_convenio,1,11) END  numeroafiliacionimss,
		CASE WHEN n.cd_tipo_convenio_mx=3 THEN  1  ELSE 0 END  issste,
		CASE WHEN n.cd_tipo_convenio_mx=3 THEN  substr(p.nr_doc_convenio,1,13) END  numeroafiliacionissste,
		CASE WHEN n.cd_tipo_convenio_mx=15 THEN  1  ELSE 0 END  otraafiliacion,
		CASE WHEN n.cd_tipo_convenio_mx=15 THEN  substr(p.nr_doc_convenio,1,15) END  numerootraafiliacion,
		-- OUTROS DADOS--
		coalesce(coalesce((select	max(qt_peso)
				from	atendimento_sinal_vital
				where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
										from	atendimento_sinal_vital
										where	qt_peso is not null
										and	nr_atendimento	= b.nr_atendimento
										and	coalesce(ie_situacao,'A') = 'A'
										and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_peso), '999') peso,
		coalesce(coalesce((select	max(qt_altura_cm)
				from	atendimento_sinal_vital
				where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
				from	atendimento_sinal_vital
				where	qt_altura_cm is not null
				and	nr_atendimento	= b.nr_atendimento
				and	coalesce(ie_situacao,'A') = 'A'
				and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_altura_cm), '999') talla,
		(select max(ptd.nr_seq_tipo_def)
		 from pf_tipo_deficiencia ptd
		 where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica
		 and ptd.dt_inativacao is null and ptd.dt_liberacao is not null)  tipodificultad,
		(select max(CASE WHEN ptd.nr_seq_tipo_def=56 THEN 9  ELSE ptd.ie_grau_deficiencia END )
		 from pf_tipo_deficiencia ptd
		 where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica
		 and ptd.dt_inativacao is null and ptd.dt_liberacao is not null) gradodificultad,
		(select max(CASE WHEN ptd.nr_seq_tipo_def=56 THEN 9  ELSE ptd.nr_seq_causa_lesao END )
		 from pf_tipo_deficiencia ptd
		 where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica
		 and ptd.dt_inativacao is null and ptd.dt_liberacao is not null) as origendificultad,
		-1 migrante,
		--CONSULTA--
		b.dt_entrada fechaconsulta,
		case
			when(select count(*) from atendimento_paciente ap where (to_char(ap.dt_inicio_atendimento, 'yyyy') = extract(YEAR from b.dt_inicio_atendimento)) and b.nr_atendimento = ap.nr_atendimento) > 1
			then 1
			else 0
		end as relaciontemporal,
		elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
												from diagnostico_doenca dd, cid_doenca cd
												where dd.nr_atendimento = b.nr_atendimento
												and dd.cd_doenca = cd.cd_doenca_cid
												and dd.ie_classificacao_doenca = 'P')),1, 255)) descripciondiagnostico1,
		case
			when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(YEAR from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'P') > 1)
			then 0
			else 1
		end as primeravezdiagnostico1,
		case
			when(select max(ds_diagnostico) from diagnostico_doenca dd where dd.nr_atendimento = b.nr_atendimento and dd.ie_classificacao_doenca = 'P') is not null
			then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  '0'  ELSE '1' END  from cid_doenca a2
						where a2.cd_doenca_cid = (select max(cd_doenca)
													from diagnostico_doenca
													where nr_atendimento = b.nr_atendimento
													and ie_classificacao_doenca = 'P')), 'N')
		end as suivecausesdiagnostico1,
		(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'P') codigociediagnostico1,
		elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
												from diagnostico_doenca dd, cid_doenca cd
												where dd.nr_atendimento = b.nr_atendimento
												and dd.cd_doenca = cd.cd_doenca_cid
												and dd.ie_classificacao_doenca = 'S')),1, 255)) descripciondiagnostico2,
		case
			when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(YEAR from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'S') > 1)
			then 0
			else 1
		end as  primeravezdiagnostico2,
		case
			when(select max(ds_diagnostico) from diagnostico_doenca where nr_atendimento = b.nr_atendimento and ie_classificacao_doenca = 'S') is not null
			then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  '0'  ELSE '1' END  from cid_doenca a2
						where a2.cd_doenca_cid = (select max(cd_doenca)
						from diagnostico_doenca
						where nr_atendimento = b.nr_atendimento
						and ie_classificacao_doenca = 'S')), 'N')
		end as suivecausesdiagnostico2,
		(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'S') codigociediagnostico2,
		-1 programa,
		0 primeravezanio,
		coalesce(obter_idade_imc_nom(b.nr_atendimento,null,null,'IMC'),-1) imc10,
		case
			when(select count(*) from cid_doenca cc1, diagnostico_doenca ddp where cc1.cd_categoria_cid in ('A15', 'A16', 'A17', 'A18', 'A19') and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento) > 1
			then 1
			else 0
		end sintomaticorespiratoriotb,
		--SALUD REPRODUCTIVA--
		CASE WHEN(select max(coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida))		from atendimento_gravidez ag		where to_char(ag.dt_liberacao, 'yyyy') = extract(year from b.dt_inicio_atendimento)		and ag.nr_atendimento = b.nr_atendimento		and ag.ie_situacao = 'A')='N' THEN 0 WHEN(select max(coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida))		from atendimento_gravidez ag		where to_char(ag.dt_liberacao, 'yyyy') = extract(year from b.dt_inicio_atendimento)		and ag.nr_atendimento = b.nr_atendimento		and ag.ie_situacao = 'A')='S' THEN 1  ELSE -1 END  relaciontemporalembarazo,
		(select max(
			case
			when(ag.dt_ultima_menstruacao is not null) and (coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida) is not null)
			then
				case
					when trunc( months_between( trunc(b.dt_inicio_atendimento), trunc(ag.dt_ultima_menstruacao)  )) <= 3
					then 1
					when trunc( months_between( trunc(b.dt_inicio_atendimento), trunc(ag.dt_ultima_menstruacao)  )) <= 6
					then 2
					when trunc( months_between( trunc(b.dt_inicio_atendimento), trunc(ag.dt_ultima_menstruacao)  )) > 6
					then 3
			end
			else -1
			end)
		 from atendimento_gravidez ag
		 where ie_situacao = 'A'
		 and ag.nr_atendimento  = b.nr_atendimento) trimestregestacional,
		(select max(CASE WHEN coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida) IS NULL THEN  0  ELSE CASE WHEN ag.ie_risco_gravidez='S' THEN 1  ELSE 0 END  END )
		 from atendimento_gravidez ag where ie_situacao = 'A' and ag.nr_atendimento  = b.nr_atendimento)  primeravezaltoriesgo,
		(select max(CASE WHEN coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida) IS NULL THEN  0  ELSE CASE WHEN pp.ie_diabetes='S' THEN 1  ELSE 0 END  END )
		 from atendimento_gravidez ag where ie_situacao = 'A' and ag.nr_atendimento  = b.nr_atendimento) complicacionpordiabetes,
		(select max(CASE WHEN coalesce(b.ie_paciente_gravida,ag.ie_pac_gravida) IS NULL THEN  0  ELSE CASE WHEN pp.ie_infeccao_urinaria='S' THEN 1  ELSE 0 END  END )
		 from atendimento_gravidez ag where ie_situacao = 'A' and ag.nr_atendimento  = b.nr_atendimento) complicacioninfeccionurinaria,
		-1 complicacioneclamsiaeclamsia,
		0 complicacionporhemorragia,
		0 otrasaccanalisisclinicos,
		0 otrasaccprescacidofolico,
		0 otrasaccapoyotranslado,
		--PUERPERIO--
		-1 puerpera,
		-1 infeccionpuerperal,
		-1 aceptapf,
		--TERAPIA HORMONAL--
		-1 peripostmenopausia,
		nvl2((select cc1.cd_doenca_cid
			from cid_doenca cc1, diagnostico_doenca ddp
			where cc1.cd_categoria_cid in ('A50', 'A51', 'A52', 'A53', 'A54', 'A55', 'A56', 'A57', 'A58', 'A59','A60', 'A61', 'A62', 'A63', 'A64')
			and cc1.cd_doenca_cid like ddp.cd_doenca
			and ddp.nr_atendimento = b.nr_atendimento), 1, 0) its,
		-1 apoyopsicoemocional,
		case
			when pf_p.ie_sexo = 'F'
			then
				case
				when exists (select * from cid_doenca cc1, diagnostico_doenca ddp where cc1.cd_categoria_cid in ('N60') and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 1
				else 0
			end
			else -1
		end as patologiamamariabenigna,
		-1 cancermamario,
		-1 colposcopia,
		-1 cancercervicouterino,
		--SALUD DE NINO--
		case
			when(obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') > 10)
			then
				case
				when(select count(nr_atendimento) from atendimento_paciente ap where ap.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) > 1
				then 1
				else 0
			end
			else -1
		end as ninosanort,
		-1 pesoparatalla,
		case
			when(obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A')) between 5 and 19
		then coalesce(obter_idade_imc_nom(b.nr_atendimento,null,null,'IMC'),-1)
			else -1
		end as imc5,
		-1 pruebaedi,
		-1 resultadoedi,
		-1 resultadobatelle,
		--CÁNCER EN MENORES DE 18 AÑOS--
		-1 aplicacioncedulacancer,
		-1 confirmacioncancer,
		--ENFERMEDADES DIARREICAS AGUDAS (EDA’S)--
		-1 edasrt,
		-1 edasplantratamiento,
		0 recuperadodeshidratacion,
		0 numerosobresvsotratamiento,
		0 numerosobresvsopromocion,
		--ENFERMEDADES RESPIRATORIAS AGUDAS IRA´S --
		case
			when(obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'a') < 5)
			then
				case
					when exists (select * from cid_doenca cc1, diagnostico_doenca ddp where cc1.cd_categoria_cid in ('J00', 'J02', 'J03', 'J04', 'J05', 'J06', 'J09', 'J10', 'J11', 'J12', 'J13', 'J14','J15', 'J16', 'J17', 'J18', 'J19', 'J20','J21','J22') and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
					then 1
					else 0
				end
			else -1
		end as irasrt,
		case
			when(obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') < 5)
			then
				case
					when(select max(ddp.ie_sintomatico) from diagnostico_doenca ddp where ddp.nr_atendimento = b.nr_atendimento) = 'S'
					then 1
					else 0
				end
			else -1
		end as irasplantratamiento,
		-1 neumoniart,
		0 informaprevencionaccidentes,
		0 lineavida,
		0 cartillavacunacion,
		-1 referidopor,
		0 contrarreferido,
		0 telemedicina,
		b.dt_entrada dt_entrada,
		pf_p.cd_pessoa_fisica cd_pessoa_fisica,
		b.nr_atendimento nr_atendimento,
		pessoa_juridica.cd_cgc cd_cgc,
		obter_desc_convenio(n.cd_convenio) ds_convenio,
		(select max(obter_nome_pf(profissional.cd_pessoa_fisica)) from atend_profissional profissional where b.nr_atendimento = profissional.nr_atendimento) ds_medico
FROM atend_categoria_convenio p, categoria_convenio cc, pessoa_fisica pf_p
LEFT OUTER JOIN person_name z ON (pf_p.nr_seq_person_name = z.nr_sequencia AND 'main' = z.ds_type)
, pessoa_juridica
LEFT OUTER JOIN estabelecimento e ON (pessoa_juridica.cd_cgc = e.cd_cgc)
, atendimento_paciente b
LEFT OUTER JOIN pessoa_fisica pessoa_fisica_medico ON (b.cd_medico_resp = pessoa_fisica_medico.cd_pessoa_fisica)
LEFT OUTER JOIN parto pp ON (b.nr_atendimento = pp.nr_atendimento)
LEFT OUTER JOIN medico m ON (pessoa_fisica_medico.cd_pessoa_fisica = m.cd_pessoa_fisica)
, convenio n
LEFT OUTER JOIN cat_derechohabiencia k ON (n.cd_tipo_convenio_mx = k.nr_sequencia)
WHERE b.cd_estabelecimento = e.cd_estabelecimento and pf_p.cd_pessoa_fisica = b.cd_pessoa_fisica    and p.nr_atendimento = b.nr_atendimento and p.cd_convenio = cc.cd_convenio and p.cd_categoria = cc.cd_categoria and n.cd_convenio = cc.cd_convenio   and b.ie_tipo_atendimento 	= 7;

