-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW export_nursing_hfile_v (data_referencia, nr_atendimento, facility_code, department_code, data_identification, hospitalization_date, implementation_date, code, version, serial_number, payload_1, payload_2, payload_3, payload_4, payload_5, payload_6, payload_7, payload_8, payload_9, payload_10, payload_11, payload_12, payload_13, payload_14, payload_15, payload_16, payload_17, payload_18, payload_19, payload_20) AS SELECT
    c.dt_entrada DATA_REFERENCIA,
    c.NR_ATENDIMENTO,
    i.CD_FACILITY_CODE FACILITY_CODE,
    max(j.cd_setor_atendimento)  DEPARTMENT_CODE,
    b.cd_sistema_ant DATA_IDENTIFICATION,
    coalesce(TO_CHAR(c.dt_entrada,'YYYYMMDD'),'00000000') HOSPITALIZATION_DATE,
    coalesce(TO_CHAR(d.dt_avaliacao,'YYYYMMDD'),'00000000') IMPLEMENTATION_DATE,
	GET_CODE_NURSING_CARE_EXPORT(e.NR_SEQUENCIA,g.NR_SEQ_CLASSIFICACAO,d.dt_avaliacao) CODE,
    e.ds_version VERSION,
    ROW_NUMBER() OVER ( PARTITION BY c.NR_ATENDIMENTO ORDER BY coalesce(TO_CHAR(d.dt_avaliacao,'YYYYMMDD'),'00000000')) SERIAL_NUMBER,
    MAX( CASE WHEN g.CD_PAYLOAD = 1 THEN h.qt_ponto ELSE null END ) PAYLOAD_1,
    MAX( CASE WHEN g.CD_PAYLOAD = 2 THEN h.qt_ponto ELSE null END )  PAYLOAD_2,
    MAX( CASE WHEN g.CD_PAYLOAD = 3 THEN h.qt_ponto ELSE null END )  PAYLOAD_3,
    MAX( CASE WHEN g.CD_PAYLOAD = 4 THEN h.qt_ponto ELSE null END )  PAYLOAD_4,
    MAX( CASE WHEN g.CD_PAYLOAD = 5 THEN h.qt_ponto ELSE null END )  PAYLOAD_5,
    MAX( CASE WHEN g.CD_PAYLOAD = 6 THEN h.qt_ponto ELSE null END )  PAYLOAD_6,
    MAX( CASE WHEN g.CD_PAYLOAD = 7 THEN h.qt_ponto ELSE null END )  PAYLOAD_7,
    MAX( CASE WHEN g.CD_PAYLOAD = 8 THEN h.qt_ponto ELSE null END )  PAYLOAD_8,
    MAX( CASE WHEN g.CD_PAYLOAD = 9 THEN h.qt_ponto ELSE null END )  PAYLOAD_9,
    MAX( CASE WHEN g.CD_PAYLOAD = 10 THEN h.qt_ponto ELSE null END )  PAYLOAD_10,
    MAX( CASE WHEN g.CD_PAYLOAD = 11 THEN h.qt_ponto ELSE null END )  PAYLOAD_11,
    MAX( CASE WHEN g.CD_PAYLOAD = 12 THEN h.qt_ponto ELSE null END )  PAYLOAD_12,
    MAX( CASE WHEN g.CD_PAYLOAD = 13 THEN h.qt_ponto ELSE null END )  PAYLOAD_13,
    MAX( CASE WHEN g.CD_PAYLOAD = 14 THEN h.qt_ponto ELSE null END )  PAYLOAD_14,
    MAX( CASE WHEN g.CD_PAYLOAD = 15 THEN h.qt_ponto ELSE null END )  PAYLOAD_15,
    MAX( CASE WHEN g.CD_PAYLOAD = 16 THEN h.qt_ponto ELSE null END )  PAYLOAD_16,
    MAX( CASE WHEN g.CD_PAYLOAD = 17 THEN h.qt_ponto ELSE null END )  PAYLOAD_17,
    MAX( CASE WHEN g.CD_PAYLOAD = 18 THEN h.qt_ponto ELSE null END )  PAYLOAD_18,
    MAX( CASE WHEN g.CD_PAYLOAD = 19 THEN h.qt_ponto ELSE null END )  PAYLOAD_19,
    MAX( CASE WHEN g.CD_PAYLOAD = 20 THEN h.qt_ponto ELSE null END )  PAYLOAD_20
FROM PESSOA_FISICA b
INNER JOIN atendimento_paciente c ON
    b.cd_pessoa_fisica = c.cd_pessoa_fisica
INNER JOIN NURSING_CARE_ENCOUNTER d ON
    d.nr_atendimento = c.nr_atendimento
INNER JOIN nursing_care_version e ON
    d.NR_SEQ_NURSING_CARE = e.NR_SEQUENCIA
INNER JOIN nursing_care_enc_result f ON
    f.nr_seq_avaliacao = d.nr_sequencia
INNER JOIN nursing_care_item g ON
    g.NR_SEQUENCIA = f.nr_seq_item
INNER JOIN nursing_care_result h ON
    h.NR_SEQUENCIA = f.nr_seq_item_result AND
    h.nr_seq_item  = f.nr_seq_item
LEFT JOIN PESSOA_JURIDICA i ON
    i.CD_CGC = obter_cnpj_estabelecimento(wheb_usuario_pck.get_cd_estabelecimento())
INNER JOIN ATEND_PACIENTE_UNIDADE j ON
    j.nr_atendimento =  c.nr_atendimento
GROUP BY
    c.dt_entrada,
    c.NR_ATENDIMENTO,
    b.cd_sistema_ant,
    i.CD_FACILITY_CODE,
    coalesce(TO_CHAR(c.dt_entrada,'YYYYMMDD'),'00000000'),
    coalesce(TO_CHAR(d.dt_avaliacao,'YYYYMMDD'),'00000000'),
	cd_setor_atendimento,
    e.ds_version,
    GET_CODE_NURSING_CARE_EXPORT(e.NR_SEQUENCIA,g.NR_SEQ_CLASSIFICACAO,d.dt_avaliacao);

