-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_producao_geral_v (nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, cd_pessoa_fisica, nr_atendimento, dt_referencia, nr_seq_microarea, nr_seq_area, ds_area, qt_atendimento, qt_pf, qt_atend_cont, qt_atend_imediata, qt_atend_espec, qt_atend_emerg, qt_atend_enf) AS select	a.NR_SEQUENCIA,a.DT_ATUALIZACAO,a.NM_USUARIO,a.DT_ATUALIZACAO_NREC,a.NM_USUARIO_NREC,a.CD_PESSOA_FISICA,a.NR_ATENDIMENTO,a.DT_REFERENCIA,a.NR_SEQ_MICROAREA,a.NR_SEQ_AREA,
			substr(obter_desc_area_domicilio(a.nr_seq_area),1,255) ds_area,
			(select	count(*) FROM eis_producao_geral x where x.nr_seq_area = a.nr_seq_area) qt_atendimento,
			(select	count(distinct x.cd_pessoa_fisica) from eis_producao_geral x where x.nr_seq_area = a.nr_seq_area) qt_pf,
			(select count(*)
			from 	eis_producao_geral x,
					atend_encaminhamento z
			where	x.nr_atendimento = z.nr_atendimento
			and		x.nr_seq_area = a.nr_seq_area
			and		z.ie_encaixe_urgencia = 'N') qt_atend_cont,
			(select count(*)
			from 	eis_producao_geral x,
					atend_encaminhamento z
			where	x.nr_atendimento = z.nr_atendimento
			and		x.nr_seq_area = a.nr_seq_area
			and		z.ie_encaixe_urgencia = 'S') qt_atend_imediata,
			(select count(*)
			from 	eis_producao_geral x,
					atend_encaminhamento z
			where	x.nr_atendimento = z.nr_atendimento
			and		x.nr_seq_area = a.nr_seq_area
			and		z.ie_encaixe_urgencia = 'N'
			and		z.ie_tipo_encaminhamento = 'E') qt_atend_espec,
			(select count(*)
			from 	eis_producao_geral x,
					atend_encaminhamento z
			where	x.nr_atendimento = z.nr_atendimento
			and		x.nr_seq_area = a.nr_seq_area
			and		z.ie_encaixe_urgencia = 'S'
			and		z.ie_tipo_encaminhamento = 'E') qt_atend_emerg,
			(select	count(*)
			from	eis_producao_geral x,
					ciap_atendimento z
			where	x.nr_atendimento = z.nr_atendimento
			and		x.nr_seq_area = a.nr_seq_area
			and		obter_cod_usuario_evol_atend(z.nm_usuario) <> 'M') qt_atend_enf
	from	eis_producao_geral a;

