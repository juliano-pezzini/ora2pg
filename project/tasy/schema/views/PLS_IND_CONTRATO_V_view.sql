-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_ind_contrato_v (ds_estipulante, nm_estipulante, ie_situacao, ds_tipo_situacao, nr_seq_plano, ds_tipo_plano, nr_seq_vendedor_canal, nm_canal_venda, nr_seq_vendedor_pf, nm_vendedor, nr_seq_motivo_inclusao, ds_motivo_inclusao, ie_tipo_segurado, ds_tipo_segurado, cd_pessoa_fisica, nm_beneficiario, qt_idade, ds_municipio, ds_tipo_proposta, dt_aprovacao, dt_rescisao_contrato, nr_seq_motivo_cancelamento, ds_motivo_exclusao, dt_mesano_referencia, vl_benef, dt_rescisao_benef, dt_adesao_benef, ie_mov_nova_venda) AS select	CASE WHEN a.cd_pf_estipulante IS NULL THEN 'PESSOA JURÍDICA'  ELSE 'PESSOA FÍSICA' END  ds_estipulante,
	substr(obter_nome_pf_pj(a.cd_pf_estipulante, a.cd_cgc_estipulante),1,200) nm_estipulante, 
	a.ie_situacao, 
	substr(pls_obter_dados_segurado(c.nr_sequencia,'DS'),1,50) ds_tipo_situacao, 
	null nr_seq_plano, 
	null ds_tipo_plano, 
	c.nr_seq_vendedor_canal, 
	substr(pls_obter_nomes_contrato(c.nr_seq_vendedor_canal,'VC'),1,255) nm_canal_venda, 
	c.nr_seq_vendedor_pf, 
	substr(pls_obter_nomes_contrato(c.nr_seq_vendedor_pf,'V'),1,255) nm_vendedor, 
	c.nr_seq_motivo_inclusao, 
	(	select x.ds_motivo 
		FROM pls_motivo_inclusao_seg x 
		where x.nr_sequencia = c.nr_seq_motivo_inclusao) ds_motivo_inclusao, 
	c.ie_tipo_segurado, 
	substr(obter_valor_dominio(2406,c.ie_tipo_segurado),1,255) ds_tipo_segurado, 
	c.cd_pessoa_fisica , 
	substr(obter_nome_pf(c.cd_pessoa_fisica),1,100) nm_beneficiario, 
	substr(obter_idade_pf(c.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),1,100) qt_idade, 
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1,'DSM'),1,255) ds_municipio, 
	(	select max(substr(obter_valor_dominio(2460, x.ie_tipo_proposta),1,255)) 
		from  pls_proposta_adesao    x 
		where x.nr_seq_contrato = a.nr_sequencia) ds_tipo_proposta, 
	a.dt_aprovacao, 
	a.dt_rescisao_contrato, 
	c.nr_seq_motivo_cancelamento, 
	(	select x.ds_motivo_cancelamento 
		from pls_motivo_cancelamento x 
		where x.nr_sequencia = c.nr_seq_motivo_cancelamento) ds_motivo_exclusao, 
	a.dt_aprovacao dt_mesano_referencia, 
	coalesce(pls_obter_valor_segurado(c.nr_sequencia,'VCD'),0) vl_benef, 
	c.dt_rescisao dt_rescisao_benef, 
	c.dt_contratacao dt_adesao_benef, 
	'1' ie_mov_nova_venda -- Novas vendas 
from	pls_contrato		a, 
	pls_segurado		c 
where	a.nr_sequencia = c.nr_seq_contrato 
and	c.dt_liberacao is not null 
and	c.ie_acao_contrato in ('A','S') 

union all
 
select	CASE WHEN a.cd_pf_estipulante IS NULL THEN 'PESSOA JURÍDICA'  ELSE 'PESSOA FÍSICA' END  ds_estipulante, 
	substr(obter_nome_pf_pj(a.cd_pf_estipulante, a.cd_cgc_estipulante),1,200) nm_estipulante, 
	a.ie_situacao, 
	substr(pls_obter_dados_segurado(c.nr_sequencia,'DS'),1,50) ds_tipo_situacao, 
	null nr_seq_plano, 
	null ds_tipo_plano, 
	c.nr_seq_vendedor_canal, 
	substr(pls_obter_nomes_contrato(c.nr_seq_vendedor_canal,'VC'),1,255) nm_canal_venda, 
	c.nr_seq_vendedor_pf, 
	substr(pls_obter_nomes_contrato(c.nr_seq_vendedor_pf,'V'),1,255) nm_vendedor, 
	c.nr_seq_motivo_inclusao, 
	(	select x.ds_motivo 
		from pls_motivo_inclusao_seg x 
		where x.nr_sequencia = c.nr_seq_motivo_inclusao) ds_motivo_inclusao, 
	c.ie_tipo_segurado, 
	substr(obter_valor_dominio(2406,c.ie_tipo_segurado),1,255) ds_tipo_segurado, 
	c.cd_pessoa_fisica , 
	substr(obter_nome_pf(c.cd_pessoa_fisica),1,100) nm_beneficiario, 
	substr(obter_idade_pf(c.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),1,100) qt_idade, 
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1,'DSM'),1,255) ds_municipio, 
	(	select max(substr(obter_valor_dominio(2460, x.ie_tipo_proposta),1,255)) 
		from  pls_proposta_adesao    x 
		where x.nr_seq_contrato = a.nr_sequencia) ds_tipo_proposta, 
	a.dt_aprovacao, 
	a.dt_rescisao_contrato, 
	c.nr_seq_motivo_cancelamento, 
	(	select x.ds_motivo_cancelamento 
		from pls_motivo_cancelamento x 
		where x.nr_sequencia = c.nr_seq_motivo_cancelamento) ds_motivo_exclusao, 
	a.dt_aprovacao dt_mesano_referencia, 
	coalesce(pls_obter_valor_segurado(c.nr_sequencia,'VCD'),0) vl_benef, 
	c.dt_rescisao dt_rescisao_benef, 
	c.dt_contratacao dt_adesao_benef, 
	'2' ie_mov_nova_venda -- Movimentações 
from	pls_contrato		a, 
	pls_segurado		c 
where	a.nr_sequencia = c.nr_seq_contrato 
and	c.dt_liberacao is not null 
and	c.ie_acao_contrato in ('M','L','D') 

union all
 
select	null ds_estipulante, 
	null nm_estipulante, 
	null ie_situacao, 
	null ds_tipo_situacao, 
	b.nr_seq_plano, 
	substr(pls_obter_nome_produto_contr(b.nr_seq_plano),1,255) ds_tipo_plano, 
	null nr_seq_vendedor_canal, 
	null nm_canal_venda, 
	null nr_seq_vendedor_pf, 
	null nm_vendedor, 
	null nr_seq_motivo_inclusao, 
	null ds_motivo_inclusao, 
	null ie_tipo_segurado, 
	null ds_tipo_segurado, 
	null cd_pessoa_fisica, 
	null nm_beneficiario, 
	null qt_idade, 
	null ds_municipio, 
	null ds_tipo_proposta, 
	null dt_aprovacao, 
	null dt_rescisao_contrato, 
	null nr_seq_motivo_cancelamento, 
	null ds_motivo_exclusao, 
	a.dt_aprovacao dt_mesano_referencia, 
	coalesce(pls_obter_valor_segurado(c.nr_sequencia,'VCD'),0) vl_benef, 
	c.dt_rescisao dt_rescisao_benef, 
	c.dt_contratacao dt_adesao_benef, 
	'1' ie_mov_nova_venda -- Novas vendas 
from	pls_contrato		a, 
	pls_contrato_plano	b, 
	pls_segurado		c 
where	a.nr_sequencia = b.nr_seq_contrato 
and	a.nr_sequencia = c.nr_seq_contrato 
and	c.dt_liberacao is not null 
and	c.ie_acao_contrato in ('A','S') 

union all
 
select	null ds_estipulante, 
	null nm_estipulante, 
	null ie_situacao, 
	null ds_tipo_situacao, 
	b.nr_seq_plano, 
	substr(pls_obter_nome_produto_contr(b.nr_seq_plano),1,255) ds_tipo_plano, 
	null nr_seq_vendedor_canal, 
	null nm_canal_venda, 
	null nr_seq_vendedor_pf, 
	null nm_vendedor, 
	null nr_seq_motivo_inclusao, 
	null ds_motivo_inclusao, 
	null ie_tipo_segurado, 
	null ds_tipo_segurado, 
	null cd_pessoa_fisica, 
	null nm_beneficiario, 
	null qt_idade, 
	null ds_municipio, 
	null ds_tipo_proposta, 
	null dt_aprovacao, 
	null dt_rescisao_contrato, 
	null nr_seq_motivo_cancelamento, 
	null ds_motivo_exclusao, 
	a.dt_aprovacao dt_mesano_referencia, 
	coalesce(pls_obter_valor_segurado(c.nr_sequencia,'VCD'),0) vl_benef, 
	c.dt_rescisao dt_rescisao_benef, 
	c.dt_contratacao dt_adesao_benef, 
	'2' ie_mov_nova_venda -- Movimentações 
from	pls_contrato		a, 
	pls_contrato_plano	b, 
	pls_segurado		c 
where	a.nr_sequencia = b.nr_seq_contrato 
and	a.nr_sequencia = c.nr_seq_contrato 
and	c.dt_liberacao is not null 
and	c.ie_acao_contrato in ('M','L','D');

