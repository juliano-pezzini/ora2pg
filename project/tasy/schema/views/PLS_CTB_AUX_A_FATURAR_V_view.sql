-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_ctb_aux_a_faturar_v (cd_beneficiario, nm_beneficiario, ds_preco, ds_regulamentacao, ds_tipo_contratacao, ds_segmentacao, ds_ato_cooperado, vl_provisao, cd_conta_deb_provisao, cd_conta_cred_provisao, dt_mes_competencia, nr_conta_medica, nr_contrato, nm_prestador, nr_cpf_cnpj, ie_status_faturamento, ie_situacao, nr_seq_lote_fat, dt_mesano_referencia, nr_seq_conta_pos, nr_seq_congenere) AS select	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
	substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_beneficiario,
	obter_valor_dominio(1669, d.ie_preco) ds_preco,--modalidade contratação
	substr(obter_valor_dominio(2157, d.ie_regulamentacao),1,255) ds_regulamentacao,
	substr(obter_valor_dominio(1666, d.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	substr(obter_valor_dominio(1665, d.ie_segmentacao),1,255) ds_segmentacao,
	substr(obter_valor_dominio(3418,(	select	b.ie_ato_cooperado
						FROM	pls_conta_proc b
						where	e.nr_seq_conta_proc = b.nr_sequencia
						and	b.nr_seq_conta = c.nr_sequencia
						
union all

						select	b.ie_ato_cooperado
						from	pls_conta_mat b
						where	e.nr_seq_conta_mat = b.nr_sequencia
						and	b.nr_seq_conta = c.nr_sequencia)),1,255) ds_ato_cooperado,
	b.vl_provisao vl_provisao,
	coalesce(b.cd_conta_deb_provisao, b.cd_conta_deb_ndc) cd_conta_deb_provisao,
	coalesce(b.cd_conta_cred_provisao, b.cd_conta_cred_ndc) cd_conta_cred_provisao,
	p.dt_mes_competencia dt_mes_competencia,
	c.nr_sequencia nr_conta_medica,
	t.nr_contrato,
	substr(CASE WHEN p.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(p.nr_seq_congenere)  ELSE pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'N') END ,1,255) nm_prestador,
	substr(CASE WHEN p.ie_tipo_protocolo='I' THEN pls_obter_cnpj_congenere(p.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'CGC'),		pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'CPF')) END ,1,14) nr_cpf_cnpj,
	e.ie_status_faturamento,
	coalesce(e.ie_situacao,'A') ie_situacao,
	e.nr_seq_lote_fat,
	l.dt_mesano_referencia,
	e.nr_sequencia nr_seq_conta_pos,
	s.nr_seq_congenere
FROM pls_protocolo_conta p, pls_plano d, pls_conta c, pls_conta_pos_estab_contab b, pls_conta_pos_estabelecido e
LEFT OUTER JOIN pls_lote_faturamento l ON (e.nr_seq_lote_fat = l.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE p.nr_sequencia 		= c.nr_seq_protocolo and c.nr_sequencia 		= e.nr_seq_conta and e.nr_sequencia 		= b.nr_seq_conta_pos and s.nr_sequencia 		= c.nr_seq_segurado and d.nr_sequencia 		= s.nr_seq_plano;

