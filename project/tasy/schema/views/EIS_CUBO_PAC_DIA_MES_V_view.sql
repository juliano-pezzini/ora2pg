-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cubo_pac_dia_mes_v (ds_faixa_etaria, cd_convenio, cd_estabelecimento, ie_periodo, cd_tipo_acomodacao, cd_setor_atendimento, ie_clinica, dt_referencia, cd_medico, ie_situacao, cd_procedencia, ie_tipo_atendimento, qt_hora_alta, ie_clinica_alta, nr_seq_origem, ie_sexo, cd_cid_principal, ds_cid_principal, ds_referencia, cd_dia, nr_pacientes, nr_pac_dia, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, qt_admitido_alta_dia, hr_alta, ie_tipo_convenio, cd_especialidade, cd_empresa, ds_idade, cd_municipio_ibge) AS SELECT	substr(obter_idade(b.dt_nascimento, LOCALTIMESTAMP, 'E'),1,50) DS_FAIXA_ETARIA,
	A.cd_convenio, 
	A.cd_estabelecimento, 
	'M' ie_periodo, 
	A.cd_tipo_acomodacao, 
	A.cd_setor_atendimento, 
	A.ie_clinica, 
	A.DT_REFERENCIA, 
	coalesce(A.CD_MEDICO,'0') cd_medico, 
	A.IE_SITUACAO, 
	A.cd_procedencia, 
	A.ie_TIPO_ATENDIMENTO, 
	to_char(A.hr_alta,'00') qt_hora_alta, 
	A.ie_clinica_alta, 
	A.nr_seq_origem, 
	b.ie_sexo, 
	A.cd_cid_principal, 
	substr(obter_desc_cid(A.cd_cid_principal),1,200) || ' - '|| '(' || A.cd_cid_principal ||')' ds_cid_principal, 
	to_char(A.dt_referencia, 'dd/mm/yyyy') DS_REFERENCIA, 
	(to_char(A.dt_referencia, 'd'))::numeric  cd_dia, 
	sum(CASE WHEN PKG_date_utils.start_of(A.DT_REFERENCIA, 'MONTH', 0)=A.DT_REFERENCIA THEN  NR_PACIENTES  ELSE 0 END ) NR_PACIENTES, 
	0 NR_PAC_DIA, 
	0 NR_ADMISSOES, 
	0 NR_ALTAS, 
	0 NR_OBITOS, 
	0 NR_TRANSF_ENTRADA, 
	0 NR_TRANSF_SAIDA, 
	0 qt_admitido_alta_dia, 
	A.HR_ALTA, 
	obter_tipo_convenio(A.cd_convenio) IE_TIPO_CONVENIO, 
	obter_especialidade_medico(A.cd_medico,'C') CD_ESPECIALIDADE, 
	obter_empresa_estab(A.cd_estabelecimento) cd_empresa, 
	substr(lpad(obter_idade_pf(A.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),3,'0'),1,50) ds_idade, 
	SUBSTR(coalesce(obter_compl_pf(A.cd_pessoa_fisica,1,'CDM'),NULL),1,100) cd_municipio_ibge 
FROM eis_ocupacao_hospitalar a
LEFT OUTER JOIN pessoa_fisica b ON (A.cd_pessoa_fisica = b.cd_pessoa_fisica)
WHERE 1	= 1  and last_day(A.DT_REFERENCIA) <= trunc(LOCALTIMESTAMP, 'dd') 
GROUP 	BY substr(obter_idade(b.dt_nascimento, LOCALTIMESTAMP, 'E'),1,50), 
	A.cd_convenio, 
	A.cd_estabelecimento, 
	b.ie_sexo, 
	A.IE_PERIODO, 
	A.cd_tipo_acomodacao, 
	A.cd_setor_atendimento, 
	A.cd_cid_principal, 
	A.ie_clinica, 
	substr(obter_desc_cid(A.cd_cid_principal),1,200) || ' - '|| '(' || A.cd_cid_principal ||')', 
	A.DT_REFERENCIA, 
	coalesce(A.CD_MEDICO,'0'), 
	to_char(A.dt_referencia, 'dd/mm/yyyy'), 
	(to_char(A.dt_referencia, 'd'))::numeric , 
	A.IE_SITUACAO, 
	A.cd_procedencia, 
	A.ie_TIPO_ATENDIMENTO, 
	to_char(A.hr_alta,'00'), 
	A.nr_seq_origem, 
	A.ie_clinica_alta, 
	A.HR_ALTA, 
	obter_tipo_convenio(A.cd_convenio), 
	obter_especialidade_medico(A.cd_medico,'C'), 
	obter_empresa_estab(A.cd_estabelecimento), 
	substr(lpad(obter_idade_pf(A.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),3,'0'),1,50), 
	SUBSTR(coalesce(obter_compl_pf(A.cd_pessoa_fisica,1,'CDM'),NULL),1,100);

