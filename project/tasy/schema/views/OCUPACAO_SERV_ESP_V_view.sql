-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ocupacao_serv_esp_v (nr_atendimento, dt_entrada_unidade, cd_unidade, cd_unidade_basica, cd_unidade_compl, nm_pessoa_fisica, cd_setor_atendimento, cd_pessoa_fisica, cd_convenio, nr_seq_apresent, classif, ds_tipo_atendimento, ie_tipo_atendimento, nr_prontuario, dt_alta, dt_entrada, dt_nascimento, nm_medico_resp) AS select	a.nr_atendimento,
	a.dt_entrada_unidade,
	a.cd_unidade_basica || ' ' || a.cd_unidade_compl cd_unidade,
	a.cd_unidade_basica,
	a.cd_unidade_compl,
	( select SUBSTR(obter_nome_pf(p.cd_pessoa_fisica),1,100)  ) nm_pessoa_fisica,
	a.cd_setor_atendimento,
	p.cd_pessoa_fisica,
	d.cd_convenio,
	coalesce(nr_seq_apresent,0) nr_seq_apresent,
	( select substr(obter_desc_classif_atend(c.nr_seq_classificacao),1,60)  ) classif,
	( select substr(obter_valor_dominio(12, c.ie_tipo_atendimento),1,255)  ) ds_tipo_atendimento,
	c.ie_tipo_atendimento,
	p.nr_prontuario nr_prontuario,
	c.dt_alta dt_alta,
	c.dt_entrada dt_entrada,
	p.dt_nascimento dt_nascimento,
	( select obter_dados_medico(c.cd_medico_resp, 'NM')  ) nm_medico_resp
from	pessoa_fisica p,
	atendimento_paciente c,
	atend_categoria_convenio d,
	atend_paciente_unidade a,
	setor_atendimento b,
	unidade_atendimento u
where	a.nr_atendimento = c.nr_atendimento
and	c.cd_pessoa_fisica = p.cd_pessoa_fisica
and	b.cd_setor_atendimento	= a.cd_setor_atendimento
and	a.cd_setor_atendimento = u.cd_setor_atendimento
and	a.cd_unidade_basica =  u.cd_unidade_basica
and	a.cd_unidade_compl =  u.cd_unidade_compl
and	b.cd_classif_setor = '5'
and	a.dt_saida_unidade is null
and	a.nr_seq_interno = (	select	coalesce(max(nr_seq_interno),0)	
				from 	atend_paciente_unidade a
				where	a.nr_atendimento 		= c.nr_atendimento
  				and 	coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999)	=
					(select max(coalesce(b.dt_saida_unidade, b.dt_entrada_unidade + 9999))
				 	from atend_paciente_unidade b
					where b.nr_atendimento 	= c.nr_atendimento))
and	d.nr_atendimento = c.nr_atendimento
and	d.nr_seq_interno = (	select	coalesce(max(nr_seq_interno),0)
			 	from 	atend_categoria_convenio a
				where	a.nr_atendimento 		= c.nr_atendimento
				and 	dt_inicio_vigencia= 
					(select max(dt_inicio_vigencia)
					from atend_categoria_convenio b
					where nr_atendimento 		= c.nr_atendimento))
and	c.dt_alta is null;

