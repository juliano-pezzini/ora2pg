-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cubo_admissoes_v (ds_faixa_etaria, cd_convenio, cd_estabelecimento, ie_periodo, cd_tipo_acomodacao, cd_setor_atendimento, ie_clinica, dt_referencia, cd_medico, ie_situacao, cd_procedencia, ie_tipo_atendimento, qt_hora_alta, ie_clinica_alta, nr_seq_origem, ie_sexo, cd_cid_principal, ds_cid_principal, ds_referencia, cd_dia, nr_pacientes, nr_pac_dia, qt_temp, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, qt_admitido_alta_dia, hr_alta, ie_tipo_convenio, cd_especialidade, ds_idade, nm_pessoa_fisica, cd_empresa, cd_municipio_ibge, cd_motivo_alta, nr_seq_classificacao, ds_agrupamento, ds_especialidade_proc, ds_grupo_proc, ds_forma_organizacao, ds_grupo, ds_subgrupo, ds_area_proc, cd_empresa_conv, ie_carater_inter_sus, ds_carater_atend, ds_categoria_glosa, cd_convenio_glosa, ds_convenio_glosa, nr_horario, nr_seq_indicacao, ds_indicacao, nr_seq_forma_chegada, ds_forma_chegada, ds_categoria, ds_queixa, ds_classif_etaria, ds_motivo_alta, ds_estabelecimento, ds_categoria_cid, ds_estado_civil) AS select	substr(eis_obter_faixa_etaria((obter_idade_pf(a.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'))::numeric ),1,50) ds_faixa_etaria,
	a.cd_convenio, 
	c.cd_estabelecimento_base cd_estabelecimento, 
	a.ie_periodo, 
	a.cd_tipo_acomodacao, 
	a.cd_setor_atendimento, 
	a.ie_clinica, 
	a.dt_referencia, 
	coalesce(a.cd_medico,'0') cd_medico, 
	a.ie_situacao, 
	a.cd_procedencia, 
	a.ie_tipo_atendimento, 
	to_char(a.hr_alta,'00') qt_hora_alta, 
	a.ie_clinica_alta, 
	a.nr_seq_origem, 
	obter_sexo_pf(a.cd_pessoa_fisica,'C') ie_sexo, 
	a.cd_cid_principal, 
	substr(obter_desc_cid(a.cd_cid_principal),1,200) || ' - '|| '(' || a.cd_cid_principal ||')' ds_cid_principal, 
	to_char(a.dt_referencia, 'dd/mm/yyyy') ds_referencia, 
	(to_char(a.dt_referencia, 'd'))::numeric  cd_dia, 
	sum(CASE WHEN a.ie_periodo='D' THEN  nr_pacientes  ELSE 0 END ) nr_pacientes, 
	sum(CASE WHEN obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl)='N' THEN (CASE WHEN a.ie_situacao='P' THEN nr_pacientes  ELSE 0 END )  ELSE (CASE WHEN a.cd_pessoa_fisica IS NULL THEN  0  ELSE nr_pacientes END ) END ) nr_pac_dia, -- era assim : (decode(a.cd_pessoa_fisica, null, 0, 1)))) os 90712 
	sum(CASE WHEN Obter_Se_Unidade_Temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl)='S' THEN  1  ELSE 0 END ) qt_temp, 
	sum(nr_admissoes) nr_admissoes, 
	sum(nr_altas) nr_altas, 
	sum(nr_obitos) nr_obitos, 
	sum(nr_transf_entrada) nr_transf_entrada, 
	sum(nr_transf_saida) nr_transf_saida, 
	sum(qt_admitido_alta_dia) qt_admitido_alta_dia, 
	a.hr_alta, 
	obter_tipo_convenio(a.cd_convenio) ie_tipo_convenio, 
	obter_especialidade_medico(a.cd_medico,'C') cd_especialidade, 
	substr(lpad(obter_idade_pf(a.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),3,'0'),1,50) ds_idade, 
	substr(obter_nome_pf(a.cd_medico),1,80) nm_pessoa_fisica, 
	obter_empresa_estab(a.cd_estabelecimento) cd_empresa, 
	substr(coalesce(obter_compl_pf(a.cd_pessoa_fisica,1,'CDM'),null),1,100) cd_municipio_ibge, 
	a.cd_motivo_alta, 
	a.nr_seq_classificacao, 
	CASE WHEN c.nr_seq_agrupamento='' THEN 'Sem agrupamento'  ELSE SUBSTR(Obter_desc_agrup_setor(c.nr_seq_agrupamento),1,50) END  ds_agrupamento, 
	SUBSTR(obter_desc_especialidade_proc(a.cd_especialidade_proc),1,40) ds_especialidade_proc, 
	SUBSTR(obter_desc_grupo_proc(a.cd_grupo_proc),1,40) ds_grupo_proc, 
	SUBSTR(sus_obter_Desc_Forma_Org(a.cd_forma_organizacao),1,40) ds_forma_organizacao, 
	SUBSTR(sus_obter_desc_grupo(a.cd_grupo),1,40) ds_grupo, 
	SUBSTR(sus_obter_desc_subgrupo(a.cd_subgrupo),1,40) ds_subgrupo, 
	SUBSTR(obter_desc_area_procedimento(a.cd_area_proc),1,40) ds_area_proc, 
	a.cd_empresa_conv, 
	a.ie_carater_inter_sus, 
	SUBSTR(coalesce(sus_obter_desc_carater_atend(a.ie_carater_inter_sus),'Não informado'),1,100) ds_carater_atend, 
	SUBSTR(coalesce(obter_categoria_convenio(a.cd_convenio_glosa,a.cd_categoria_glosa),'Não informado'),1,200) ds_categoria_glosa, 
	coalesce(a.cd_convenio_glosa,0) cd_convenio_glosa,	 
	SUBSTR(coalesce(obter_nome_convenio(a.cd_convenio_glosa),'Não informado'),1,100) ds_convenio_glosa, 
	(TO_CHAR(a.dt_entrada,'hh24'))::numeric  nr_horario, 
	a.NR_SEQ_INDICACAO, 
	SUBSTR(coalesce(OBTER_DESC_INDICACAO(a.NR_SEQ_INDICACAO),'Não informado'),1,100) ds_indicacao, 
	a.nr_seq_forma_chegada, 
	SUBSTR(coalesce(obter_desc_forma_chegada(a.nr_seq_forma_chegada),'Não Informado'),1,255) ds_forma_chegada, 
	SUBSTR(obter_nome_convenio(a.cd_convenio)||' - '||obter_categoria_convenio(a.cd_convenio,a.cd_categoria),1,200) ds_categoria, 
	SUBSTR(coalesce(obter_desc_queixa(a.nr_seq_queixa),'Não Informado'),1,255) ds_queixa, 
	obter_valor_dominio(1698, Obter_classif_etaria(a.cd_estabelecimento,a.cd_pessoa_fisica,'C')) ds_classif_etaria, 
	SUBSTR(obter_desc_motivo_alta(a.cd_motivo_alta),1,255) ds_motivo_alta, 
	SUBSTR(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento, 
	SUBSTR(obter_desc_categoria_cid(obter_categoria_cid(a.cd_cid_principal)),1,255) ds_categoria_cid, 
	'' ds_estado_civil 
FROM	setor_atendimento c, 
	eis_ocupacao_hospitalar a 
where 	1	= 1 
and	a.cd_estabelecimento	= c.cd_estabelecimento_base 
and	a.cd_setor_atendimento	= c.cd_setor_atendimento 
and	a.ie_tipo_atendimento is not null 
group 	by substr(eis_obter_faixa_etaria((obter_idade_pf(a.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'))::numeric ),1,50), 
	a.cd_convenio, 
	c.cd_estabelecimento_base, 
	a.ie_periodo, 
	a.cd_tipo_acomodacao, 
	a.cd_setor_atendimento, 
	to_char(a.dt_referencia, 'dd/mm/yyyy'), 
	a.ie_clinica, 
	a.cd_cid_principal, 
	substr(obter_desc_cid(a.cd_cid_principal),1,200) || ' - '|| '(' || a.cd_cid_principal ||')', 
	(to_char(a.dt_referencia, 'd'))::numeric , 
	a.dt_referencia, 
	coalesce(a.cd_medico,'0'), 
	a.ie_situacao, 
	a.cd_procedencia, 
	a.ie_tipo_atendimento, 
	to_char(a.hr_alta,'00'), 
	a.nr_seq_origem, 
	obter_sexo_pf(a.cd_pessoa_fisica,'C'), 
	a.ie_clinica_alta, 
	a.hr_alta, 
	obter_tipo_convenio(a.cd_convenio), 
	obter_especialidade_medico(a.cd_medico,'C'), 
	substr(lpad(obter_idade_pf(a.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),3,'0'),1,50), 
	substr(obter_nome_pf(a.cd_medico),1,80), 
	obter_empresa_estab(a.cd_estabelecimento), 
	substr(coalesce(obter_compl_pf(a.cd_pessoa_fisica,1,'CDM'),null),1,100), 
	a.cd_motivo_alta, 
	a.nr_seq_classificacao, 
	CASE WHEN c.nr_seq_agrupamento='' THEN 'Sem agrupamento'  ELSE SUBSTR(Obter_desc_agrup_setor(c.nr_seq_agrupamento),1,50) END , 
	SUBSTR(obter_desc_especialidade_proc(a.cd_especialidade_proc),1,40), 
	SUBSTR(obter_desc_grupo_proc(a.cd_grupo_proc),1,40), 
	SUBSTR(sus_obter_Desc_Forma_Org(a.cd_forma_organizacao),1,40), 
	SUBSTR(sus_obter_desc_grupo(a.cd_grupo),1,40), 
	SUBSTR(sus_obter_desc_subgrupo(a.cd_subgrupo),1,40), 
	SUBSTR(obter_desc_area_procedimento(a.cd_area_proc),1,40), 
	a.cd_empresa_conv, 
	a.ie_carater_inter_sus, 
	SUBSTR(coalesce(sus_obter_desc_carater_atend(a.ie_carater_inter_sus),'Não informado'),1,100), 
	SUBSTR(coalesce(obter_categoria_convenio(a.cd_convenio_glosa,a.cd_categoria_glosa),'Não informado'),1,200), 
	coalesce(a.cd_convenio_glosa,0),	 
	SUBSTR(coalesce(obter_nome_convenio(a.cd_convenio_glosa),'Não informado'),1,100), 
	(TO_CHAR(a.dt_entrada,'hh24'))::numeric , 
	a.NR_SEQ_INDICACAO, 
	SUBSTR(coalesce(OBTER_DESC_INDICACAO(a.NR_SEQ_INDICACAO),'Não informado'),1,100), 
	a.nr_seq_forma_chegada, 
	SUBSTR(coalesce(obter_desc_forma_chegada(a.nr_seq_forma_chegada),'Não Informado'),1,255), 
	SUBSTR(obter_nome_convenio(a.cd_convenio)||' - '||obter_categoria_convenio(a.cd_convenio,a.cd_categoria),1,200), 
	SUBSTR(coalesce(obter_desc_queixa(a.nr_seq_queixa),'Não Informado'),1,255), 
	obter_valor_dominio(1698, Obter_classif_etaria(a.cd_estabelecimento,a.cd_pessoa_fisica,'C')), 
	SUBSTR(obter_desc_motivo_alta(a.cd_motivo_alta),1,255), 
	SUBSTR(obter_nome_estabelecimento(a.cd_estabelecimento),1,80), 
	SUBSTR(obter_desc_categoria_cid(obter_categoria_cid(a.cd_cid_principal)),1,255);

