-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW epimed_internados_v (nr_atendimento, nr_seq_unidade, cd_setor_atendimento, cd_unidade, dt_entrada_unidade, dt_saida_unidade, dt_alta, cd_motivo_alta, dt_entrada, nr_prontuario, cd_estabelecimento, nr_seq_interno, nm_pessoa_fisica, nr_ident_pac, ie_documento, dt_nascimento, ie_sexo, dt_alta_medico, nm_responsavel, nr_ident_resp, cd_cid_doenca, dt_atualizacao_nrec, nr_seq_agrupamento, cd_setor_atend, cd_unid_basica, cd_multi_empresa, ie_situacao_setor, ie_situacao_leito, hospitalhealthinsurancecode, healthinsurancecorporatecode, weight, height) AS select	a.nr_atendimento, --hospitaladmissionnumber, 
		f.nr_seq_interno nr_seq_unidade,
		coalesce(c.cd_setor_externo, b.cd_setor_atendimento) cd_setor_atendimento,-- unitcode, 
		coalesce(f.nm_Setor_integracao,b.cd_unidade_basica) cd_unidade,-- bedcode, --b.cd_unidade_compl, 
		to_char(b.dt_entrada_unidade, 'yyyy/mm/dd hh24:mi:ss') dt_entrada_unidade,-- unitadmissiondatetime, 
		to_char(b.dt_saida_unidade, 'yyyy/mm/dd hh24:mi:ss') dt_saida_unidade,-- unitdischargedatetime, 
		to_char(a.dt_alta, 'yyyy/mm/dd hh24:mi:ss') dt_alta,-- hospitaldischargedate, 
		a.cd_motivo_alta,-- dischargecause,
		to_char(a.dt_entrada, 'yyyy/mm/dd') dt_entrada,-- hospitaladmissiondate,
		obter_prontuario_pf(a.cd_estabelecimento,d.cd_pessoa_fisica) nr_prontuario,-- medicalrecord,
		a.cd_estabelecimento,-- hospitalcode,
		b.nr_seq_interno,-- unitadmissionnumber,
		 CASE WHEN coalesce(d.NM_SOCIAL,(SELECT MAX(nm_oculto) FROM PESSOA_FISICA_OCULTA WHERE CD_PESSOA_FISICA = d.cd_pessoa_fisica AND IE_NOME_REAL = 'N')) IS NULL THEN        d.nm_pessoa_fisica  ELSE coalesce(d.NM_SOCIAL,(SELECT MAX(nm_oculto) FROM PESSOA_FISICA_OCULTA WHERE CD_PESSOA_FISICA = d.cd_pessoa_fisica AND IE_NOME_REAL = 'N')) END 
        nm_pessoa_fisica,-- pacientname,
		d.nr_identidade nr_ident_pac,-- documentnumber,
		'RG' ie_documento,-- documenttypecode,
		to_char(d.dt_nascimento, 'yyyy/mm/dd') dt_nascimento,-- birthdate,
		d.ie_sexo,-- gender,
		a.dt_alta_medico,-- medicaldischargedate,
		--e.nm_pessoa_fisica nm_responsavel,-- responsiblename,

		substr(obter_compl_pf(a.cd_pessoa_fisica,5,'N'),1,255) nm_responsavel,-- responsiblename,
		--e.nr_identidade nr_ident_resp,-- responsibledocument,

		substr(obter_compl_pf(a.cd_pessoa_fisica,5,'I'),1,255) nr_ident_resp,
		obter_cid_atendimento(a.nr_atendimento,'P') cd_cid_doenca,-- icdcode,
		b.dt_atualizacao_nrec,
		c.nr_seq_agrupamento, -- createdate
		c.cd_setor_atendimento cd_setor_atend,
		b.cd_unidade_basica cd_unid_basica,
		a.cd_estabelecimento CD_MULTI_EMPRESA,
		c.ie_situacao ie_situacao_setor,
		f.ie_situacao ie_situacao_leito,
		Obter_Convenio_Atendimento(a.nr_atendimento) hospitalhealthinsurancecode,
		Obter_cod_ext_conv_Atendimento(a.nr_atendimento) HEALTHINSURANCECORPORATECODE,
		qt_peso		weight,
		qt_altura_cm height
from		atendimento_paciente a,
		atend_paciente_unidade b,
		setor_atendimento c,
		pessoa_fisica d,
		unidade_Atendimento f
where		a.nr_atendimento	   = b.nr_atendimento
and		b.cd_setor_atendimento = c.cd_setor_atendimento
and		coalesce(c.ie_epimed, 'N')				= 'S'
and		a.cd_pessoa_fisica	   = d.cd_pessoa_fisica
and		c.cd_setor_atendimento	= f.cd_setor_atendimento
and		b.cd_unidade_basica		= f.cd_unidade_basica
and		b.cd_unidade_compl		= f.cd_unidade_compl
and       	(a.dt_alta is null or (a.dt_alta between (trunc(LOCALTIMESTAMP) - (select coalesce(max(g.qt_dias_alta_epimed),0) from parametro_Atendimento g)) and LOCALTIMESTAMP))
and		coalesce(b.ie_passagem_setor,'N')	  in ('N','L')
and		a.dt_cancelamento is null
and		(((select abs(coalesce(max(j.nr_min_mov_epimed),0)) from parametro_Atendimento j) = 0) or
		(b.dt_entrada_unidade >= LOCALTIMESTAMP - (select abs(coalesce(max(j.nr_min_mov_epimed),0)) from parametro_Atendimento j)/1440))
order by 	a.nr_atendimento, a.cd_pessoa_fisica, b.dt_entrada_unidade;

