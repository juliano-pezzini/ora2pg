-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cassi_v (nr_seq_protocolo, cd_convenio, tp_registro, cd_prestador, nm_prestador, dt_remessa, nr_seq_remessa, nr_reg_remessa, nm_paciente, cd_cliente, nr_conta, dt_item, cd_cid, nr_crm, sg_uf_crm, nr_guia, dt_guia, ds_item, cd_item, qt_item, cd_dependente, cd_tipo_acomodacao, dt_entrada, dt_alta, cd_motivo_alta, ie_funcao_medico, cd_grupo_gasto, vl_unitario, vl_item, tp_cirurgia, pr_hora_extra, cd_setor_atendimento, cd_item_convenio, cd_senha, ds_espaco, vl_tot_honorarios, vl_tot_taxas, vl_tot_medicamentos, vl_tot_materiais, vl_tot_sadt, dt_vencimento, nr_primeira_guia, nr_ultima_guia, qt_guias, vl_total, ie_tipo_paciente, qt_registro) AS SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO,
	0 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	substr(a.nm_hospital,1,40) NM_PRESTADOR,
	a.dt_remessa DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	'' NM_PACIENTE,
	'' CD_CLIENTE,
	0 NR_CONTA,
	LOCALTIMESTAMP DT_ITEM,
	'' CD_CID,
	'' NR_CRM,
	'' SG_UF_CRM,
	'0' NR_GUIA,
	LOCALTIMESTAMP DT_GUIA,
	'' DS_ITEM,
	0 CD_ITEM,
	0 QT_ITEM,
	0 CD_DEPENDENTE,
	0 CD_TIPO_ACOMODACAO,
	LOCALTIMESTAMP DT_ENTRADA,
	LOCALTIMESTAMP DT_ALTA,
	0 CD_MOTIVO_ALTA,
	0 IE_FUNCAO_MEDICO,
	'' CD_GRUPO_GASTO,
	0 VL_UNITARIO,
	0 VL_ITEM,
	0 TP_CIRURGIA,
	0 PR_HORA_EXTRA,
	0 cd_setor_atendimento,
	0 CD_ITEM_CONVENIO,
	'0' CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	a.dt_vencimento,
	0 nr_primeira_guia,
	0 nr_ultima_guia,
	0 qt_guias,
	b.vl_total_conta vl_total,
	0 ie_tipo_paciente,
	0 qt_registro
FROM	w_interf_conta_header a,
	w_interf_conta_trailler b
where	a.nr_seq_protocolo = b.nr_seq_protocolo

union all

SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO CD_CONVENIO,
	1 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	'' NM_PRESTADOR,
	a.dt_remessa DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	'' NM_PACIENTE,
	'' CD_CLIENTE,
	0 CONTA,
	LOCALTIMESTAMP DT_ITEM,
	'' CD_CID,
	'' NR_CRM,
	'' SG_UF_CRM,
	'0'  NR_GUIA,
	LOCALTIMESTAMP DT_GUIA,
	'' DS_ITEM,
	0 CD_ITEM,
	0 QT_ITEM,
	0 CD_DEPENDENTE,
	0 CD_TIPO_ACOMODACAO,
	LOCALTIMESTAMP DT_ENTRADA,
	LOCALTIMESTAMP DT_ALTA,
	0 CD_MOTIVO_ALTA,
	0 IE_FUNCAO_MEDICO,
	'' CD_GRUPO_GASTO,
	0 VL_UNITARIO,
	0 VL_ITEM,
	0 TP_CIRURGIA,
	0 PR_HORA_EXTRA,
	0 cd_setor_atendimento,
	0 CD_ITEM_CONVENIO,
	'0' CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	a.dt_vencimento dt_vencimento,
	(coalesce(b.nr_primeira_guia,'0'))::numeric  nr_primeira_guia,
	(coalesce(b.nr_ultima_guia,'0'))::numeric  nr_ultima_guia,
	coalesce(b.qt_guia,0) qt_guias,
	b.vl_total_conta vl_total,
	0 ie_tipo_paciente,
	0 qt_registro
FROM	w_interf_conta_header a,
	w_interf_conta_trailler b
where	a.nr_seq_protocolo = b.nr_seq_protocolo

union all

SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO CD_CONVENIO,
	2 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	'' NM_PRESTADOR,
	LOCALTIMESTAMP DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	a.nm_paciente NM_PACIENTE,
	a.cd_usuario_convenio CD_CLIENTE,
	a.NR_INTERNO_CONTA NR_CONTA,
	LOCALTIMESTAMP DT_ITEM,
	a.cd_cid_principal CD_CID,
	CASE WHEN a.ie_medico_credenciado='N' THEN a.nr_crm_medico_resp  ELSE 0 END   NR_CRM,
	a.uf_crm_medico_resp SG_UF_CRM,
	coalesce(c.cd_autorizacao,'0') NR_GUIA,
	c.dt_autorizacao DT_GUIA,
	'' DS_ITEM,
	0 CD_ITEM,
	0 QT_ITEM,
	coalesce(a.cd_dependente,1) CD_DEPENDENTE,
	a.cd_tipo_acomodacao CD_TIPO_ACOMODACAO,
	a.DT_ENTRADA DT_ENTRADA,
	coalesce(a.DT_ALTA,a.dt_periodo_final) DT_ALTA,
	coalesce(a.CD_MOTIVO_ALTA,2) CD_MOTIVO_ALTA,
	0 IE_FUNCAO_MEDICO,
	'' CD_GRUPO_GASTO,
	0 VL_UNITARIO,
	0 VL_ITEM,
	0 TP_CIRURGIA,
	0 PR_HORA_EXTRA,
	0 cd_setor_atendimento,
	0 CD_ITEM_CONVENIO,
	coalesce(c.cd_senha,'0') CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	LOCALTIMESTAMP dt_vencimento,
	0 nr_primeira_guia,
	0 nr_ultima_guia,
	0 qt_guias,
	0 vl_total,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 1  ELSE 2 END  ie_tipo_paciente,
	0 qt_registro
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor c ON (a.nr_interno_conta = c.nr_interno_conta)
WHERE c.nr_sequencia		=
	(select coalesce(min(x.nr_sequencia),c.nr_sequencia)
		from w_interf_conta_autor x
		where a.nr_interno_conta = x.nr_interno_conta)

union all

SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO CD_CONVENIO,
	3 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	'' NM_PRESTADOR,
	LOCALTIMESTAMP DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	'' NM_PACIENTE,
	'' CD_CLIENTE,
	a.nr_interno_conta NR_CONTA,
	max(a.DT_ITEM) DT_ITEM,
	'' CD_CID,
	a.nr_crm_executor NR_CRM,
	a.uf_crm_executor SG_UF_CRM,
	coalesce(c.cd_autorizacao,'0') NR_GUIA,
	LOCALTIMESTAMP DT_GUIA,
	a.ds_item DS_ITEM,
	a.CD_ITEM CD_ITEM,
	sum(a.QT_ITEM) QT_ITEM,
	0 CD_DEPENDENTE,
	0 CD_TIPO_ACOMODACAO,
	trunc(dt_item,'dd') DT_ENTRADA,
	LOCALTIMESTAMP DT_ALTA,
	0 CD_MOTIVO_ALTA,
	coalesce(a.cd_funcao_executor,0) IE_FUNCAO_MEDICO,
	a.cd_grupo_gasto CD_GRUPO_GASTO,
	CASE WHEN sum(a.qt_item)=0 THEN 0  ELSE (sum(a.vl_honorario) / sum(a.qt_item)) END  VL_UNITARIO,
	sum(a.vl_honorario) VL_ITEM,
	0 TP_CIRURGIA,
	CASE WHEN a.pr_hora_extra=1 THEN 0 WHEN a.pr_hora_extra=0 THEN 0  ELSE (a.pr_hora_extra * 100 - 100) END  PR_HORA_EXTRA,
	a.cd_setor_atendimento cd_setor_atendimento,
	(coalesce(a.cd_item_convenio,a.cd_item))::numeric  cd_item_convenio,
	'0' CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	LOCALTIMESTAMP dt_vencimento,
	0 nr_primeira_guia,
	0 nr_ultima_guia,
	0 qt_guias,
	0 vl_total,
	0 ie_tipo_paciente,
	0 qt_registro
from	w_interf_conta_item a,
	w_interf_conta_autor c
where	a.nr_interno_conta = c.nr_interno_conta
and	a.cd_item in (select x.cd_procedimento
	from estrutura_procedimento_v x
	where x.cd_area_procedimento in (1,4,11,13))
group by
	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO,
	a.CD_INTERNO,
	a.nr_remessa,
	a.nr_interno_conta,
	a.nr_crm_executor,
	a.uf_crm_executor,
	coalesce(c.cd_autorizacao,'0'),
	a.ds_item,
	a.CD_ITEM,
	trunc(dt_item,'dd'),
	coalesce(a.cd_funcao_executor,0),
	a.cd_grupo_gasto,
	CASE WHEN a.pr_hora_extra=1 THEN 0 WHEN a.pr_hora_extra=0 THEN 0  ELSE (a.pr_hora_extra * 100 - 100) END ,
	a.cd_setor_atendimento,
	(coalesce(a.cd_item_convenio,a.cd_item))::numeric ,
	LOCALTIMESTAMP

union all

SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO CD_CONVENIO,
	4 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	'' NM_PRESTADOR,
	LOCALTIMESTAMP DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	'' NM_PACIENTE,
	'' CD_CLIENTE,
	a.nr_interno_conta NR_CONTA,
	max(a.DT_ITEM) DT_ITEM,
	'' CD_CID,
	'' NR_CRM,
	'' SG_UF_CRM,
	coalesce(c.cd_autorizacao,'0') NR_GUIA,
	LOCALTIMESTAMP DT_GUIA,
	a.ds_item DS_ITEM,
	a.CD_ITEM CD_ITEM,
	sum(a.QT_ITEM) QT_ITEM,
	0 CD_DEPENDENTE,
	0 CD_TIPO_ACOMODACAO,
	trunc(dt_item,'dd') DT_ENTRADA,
	LOCALTIMESTAMP DT_ALTA,
	0 CD_MOTIVO_ALTA,
	coalesce(a.cd_funcao_executor,0) IE_FUNCAO_MEDICO,
	a.cd_grupo_gasto CD_GRUPO_GASTO,
	CASE WHEN sum(a.qt_item)=0 THEN 0  ELSE (sum(a.VL_total_ITEM) / sum(a.QT_ITEM)) END  VL_UNITARIO,
	sum(a.VL_total_ITEM) VL_ITEM,
	0 TP_CIRURGIA,
	CASE WHEN a.pr_hora_extra=1 THEN 0 WHEN a.pr_hora_extra=0 THEN 0  ELSE (a.pr_hora_extra * 100 - 100) END  PR_HORA_EXTRA,
	a.cd_setor_atendimento cd_setor_atendimento,
	(coalesce(a.cd_item_convenio,a.cd_item))::numeric  cd_item_convenio,
	'0' CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	LOCALTIMESTAMP dt_vencimento,
	0 nr_primeira_guia,
	0 nr_ultima_guia,
	0 qt_guias,
	0 vl_total,
	0 ie_tipo_paciente,
	0 qt_registro
from	w_interf_conta_item a,
	w_interf_conta_autor c
where	a.nr_interno_conta = c.nr_interno_conta
and	a.cd_item not in (select x.cd_procedimento
	from estrutura_procedimento_v x
	where x.cd_area_procedimento in (1,4,11,13))
group by
	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO,
	a.CD_INTERNO,
	a.nr_remessa,
	a.nr_interno_conta,
	coalesce(c.cd_autorizacao,'0'),
	a.ds_item,
	a.CD_ITEM,
	trunc(dt_item,'dd'),
	coalesce(a.cd_funcao_executor,0),
	a.cd_grupo_gasto,
	CASE WHEN a.pr_hora_extra=1 THEN 0 WHEN a.pr_hora_extra=0 THEN 0  ELSE (a.pr_hora_extra * 100 - 100) END ,
	a.cd_setor_atendimento,
	(coalesce(a.cd_item_convenio,a.cd_item))::numeric ,
	LOCALTIMESTAMP

union all

SELECT	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO CD_CONVENIO,
	9 TP_REGISTRO,
	a.CD_INTERNO CD_PRESTADOR,
	'' NM_PRESTADOR,
	LOCALTIMESTAMP DT_REMESSA,
	a.nr_remessa NR_SEQ_REMESSA,
	0 NR_REG_REMESSA,
	'' NM_PACIENTE,
	'' CD_CLIENTE,
	99999999 NR_CONTA,
	LOCALTIMESTAMP DT_ITEM,
	'' CD_CID,
	'' NR_CRM,
	'' SG_UF_CRM,
	'0' NR_GUIA,
	LOCALTIMESTAMP DT_GUIA,
	'' DS_ITEM,
	0 CD_ITEM,
	0 QT_ITEM,
	0 CD_DEPENDENTE,
	0 CD_TIPO_ACOMODACAO,
	LOCALTIMESTAMP DT_ENTRADA,
	LOCALTIMESTAMP DT_ALTA,
	0 CD_MOTIVO_ALTA,
	0 IE_FUNCAO_MEDICO,
	'' CD_GRUPO_GASTO,
	0 VL_UNITARIO,
	sum(b.vl_total_item) VL_ITEM,
	0 TP_CIRURGIA,
	0 PR_HORA_EXTRA,
	0 cd_setor_atendimento,
	0 CD_ITEM_CONVENIO,
	'0' CD_SENHA,
	' ' ds_espaco,
	0 vl_tot_honorarios,
	0 vl_tot_taxas,
	0 vl_tot_medicamentos,
	0 vl_tot_materiais,
	0 vl_tot_sadt,
	LOCALTIMESTAMP dt_vencimento,
	0 nr_primeira_guia,
	0 nr_ultima_guia,
	0 qt_guias,
	0 vl_total,
	0 ie_tipo_paciente,
	0 qt_registro
from	w_interf_conta_item b,
	w_interf_conta_trailler a
where	a.nr_seq_protocolo = b.nr_seq_protocolo
group by
	a.NR_SEQ_PROTOCOLO,
	a.CD_CONVENIO,
	a.CD_INTERNO,
	a.nr_remessa;

