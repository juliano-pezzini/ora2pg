-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW alergia_v (ds_tipo_alerta, nr_seq_alerta, cd_pessoa_fisica, nr_seq_alergeno, ds_alergeno, nr_seq_dcb, ds_dcb, nr_seq_ficha_tecnica, ds_ficha_tecnica, cd_material, ds_material, nr_seq_dcb_mat, ds_dcb_mat, cd_classe_mat, ds_classe_mat, nr_seq_reacao, ds_tipo_reacao, ds_medic_nao_cad, ie_confirmacao, ds_confirmacao, ie_nega, dt_liberacao, nr_seq_familia, ds_familia_mat, ie_classificacao) AS select	
	coalesce(obter_nome_tipo_alerta('A'),obter_desc_expressao(493043)/*Alergias / Reacoes adversas*/
) ds_tipo_alerta,
	a.nr_sequencia nr_seq_alerta,
	a.cd_pessoa_fisica,
	a.nr_seq_tipo nr_seq_alergeno,
	CASE WHEN a.ie_nega_alergias='N' THEN substr(obter_desc_alergeno(a.nr_seq_tipo),1,80)  ELSE 'Paciente nega alergias' END  ds_alergeno,
	a.nr_seq_dcb,
	substr(obter_desc_dcb(a.nr_seq_dcb),1,80) ds_dcb,
	a.nr_seq_ficha_tecnica,
	substr(obter_estrut_princ_ativo(a.nr_seq_ficha_tecnica,'P'),1,2000) ds_ficha_tecnica,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,100) ds_material,
	substr(obter_desc_dcb_mat(a.cd_material,'C'),1,10) nr_seq_dcb_mat,
	substr(obter_desc_dcb_mat(a.cd_material,'D'),1,80) ds_dcb_mat,
	a.cd_classe_mat,
	substr(obter_desc_classe_mat(a.cd_classe_mat),1,60) ds_classe_mat,
	a.nr_seq_reacao,
	substr(obter_desc_reacao_alergica(a.nr_seq_reacao),1,100) ds_tipo_reacao,
	substr(ds_medic_nao_cad,1,100) ds_medic_nao_cad,
	a.ie_confirmacao,
	CASE WHEN a.ie_confirmacao='C' THEN 'Confirmada' WHEN a.ie_confirmacao='S' THEN 'Suspeita' END  ds_confirmacao,
	a.ie_nega_alergias ie_nega,
	a.dt_liberacao,
	a.nr_seq_familia, 
	substr(obter_desc_familia_mat(a.nr_seq_familia),1,60) ds_familia_mat,
	coalesce(a.ie_classificacao, 'A') ie_classificacao
FROM paciente_alergia a
LEFT OUTER JOIN nivel_seguranca_alerta b ON (a.nr_seq_nivel_seg = b.nr_sequencia)
WHERE ((a.dt_fim is null) or (LOCALTIMESTAMP between coalesce(a.dt_inicio,LOCALTIMESTAMP - interval '1 days') and a.dt_fim)) and a.dt_inativacao is null and consiste_se_exibe_alergia(nr_seq_tipo)	= 'S' and coalesce(a.ie_alerta,'S')	= 'S' and coalesce(a.ie_nega_alergias,'N')	= 'N';

