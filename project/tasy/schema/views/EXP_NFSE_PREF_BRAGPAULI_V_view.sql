-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_pref_bragpauli_v (nr_nota_fiscal, tp_registro, cd_serie_nf, dt_emissao, ie_situacao_nf, vl_total_nota, cd_servico, ie_tipo_toma_prest, ds_local_tomador, cd_estabelecimento) AS select	n.nr_sequencia							nr_nota_fiscal,
	'C'								tp_registro, 
	n.cd_serie_nf							cd_serie_nf, 
	n.dt_emissao							dt_emissao, 
	CASE WHEN n.ie_situacao=1 THEN 1  ELSE 2 END 					ie_situacao_nf, 
	lpad(elimina_caracteres_especiais(n.vl_total_nota),12,0)	vl_total_nota, 
	lpad(elimina_caractere_especial(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), 
	obter_procedimento_nfse(n.nr_sequencia,'O')),'CD')),10,' ') 	cd_servico, 
	1								ie_tipo_toma_prest, 
	CASE WHEN upper(elimina_caracteres_especiais(obter_dados_pf_pj(n.cd_pessoa_fisica, null, 'CI')))=(upper(elimina_caracteres_especiais(obter_dados_pf_pj(null,(obter_dados_nota_fiscal(n.nr_sequencia,2)),'CI')))) THEN 'D'  ELSE 'F' END  ds_local_tomador, 
	n.cd_estabelecimento						cd_estabelecimento 
FROM	nota_fiscal n, 
	operacao_nota o 
where	n.cd_operacao_nf = o.cd_operacao_nf 
and	o.ie_servico = 'S' 
and	n.cd_pessoa_fisica is not null 
and	n.cd_cgc is null 
and (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S');

