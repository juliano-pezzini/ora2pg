-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_proced_laborat_v (dt_referencia, cd_setor_atendimento, cd_estabelecimento, ie_periodo, nm_usuario, dt_atualizacao, dt_hora_exame, qt_procedimento, cd_procedimento, ie_origem_proced, ie_tipo_atendimento, cd_medico_prescr, ie_clinica, cd_tipo_procedimento, cd_setor_prescr, nr_seq_grupo, nr_seq_exame, dt_atualizacao_nrec, nm_usuario_nrec, cd_convenio, vl_procedimento, qt_atendimento, cd_setor_entrega, nr_seq_forma_laudo, cd_setor_proc, cd_medico_resp, dt_aprovacao, dt_prescricao, cd_motivo_exc, ds_motivo_exc, vl_custo_exame, cd_pessoa_fisica, cd_pessoa_coleta, dt_impressao_internet, cd_procedencia, ie_status_atend, qt_atend_exam, nr_prescricao, nr_atendimento, nr_seq_prescr, nr_seq_indicacao, cd_categoria, cd_cgc_prestador, nm_usuario_atend, nr_seq_recoleta, ds_procedimento, ds_tipo_atendimento, ds_setor_atendimento, ds_setor_prescr, ds_setor_entrega, ds_setor_proc, ds_clinica, ds_tipo_procedimento, nm_medico, ds_grupo_lab, nm_exame, ds_hora_exame, hr_hora_exame, ds_estabelecimento, cd_empresa, nm_medico_resp, dt_aprov, dt_prescr, cd_exame, ds_exame, nm_pessoa_coleta, dt_impressao_laudo, dt_impressao_web, dt_impressao_mapa, nm_paciente, ds_status_atend, ds_procedencia, ds_idade, ds_equipamento, ds_indicacao, ds_categoria, nr_seq_grupo_imp, ds_grupo_imp, ds_prestador, ds_usuario_atend, ie_motivo_recoleta, ds_motivo_recoleta, cd_setor_coleta, ds_setor_coleta, nr_seq_superior, ds_cgc_externo, nr_prescr, nr_atend, dt_atend) AS select	a.DT_REFERENCIA,a.CD_SETOR_ATENDIMENTO,a.CD_ESTABELECIMENTO,a.IE_PERIODO,a.NM_USUARIO,a.DT_ATUALIZACAO,a.DT_HORA_EXAME,a.QT_PROCEDIMENTO,a.CD_PROCEDIMENTO,a.IE_ORIGEM_PROCED,a.IE_TIPO_ATENDIMENTO,a.CD_MEDICO_PRESCR,a.IE_CLINICA,a.CD_TIPO_PROCEDIMENTO,a.CD_SETOR_PRESCR,a.NR_SEQ_GRUPO,a.NR_SEQ_EXAME,a.DT_ATUALIZACAO_NREC,a.NM_USUARIO_NREC,a.CD_CONVENIO,a.VL_PROCEDIMENTO,a.QT_ATENDIMENTO,a.CD_SETOR_ENTREGA,a.NR_SEQ_FORMA_LAUDO,a.CD_SETOR_PROC,a.CD_MEDICO_RESP,a.DT_APROVACAO,a.DT_PRESCRICAO,a.CD_MOTIVO_EXC,a.DS_MOTIVO_EXC,a.VL_CUSTO_EXAME,a.CD_PESSOA_FISICA,a.CD_PESSOA_COLETA,a.DT_IMPRESSAO_INTERNET,a.CD_PROCEDENCIA,a.IE_STATUS_ATEND,a.QT_ATEND_EXAM,a.NR_PRESCRICAO,a.NR_ATENDIMENTO,a.NR_SEQ_PRESCR,a.NR_SEQ_INDICACAO,a.CD_CATEGORIA,a.CD_CGC_PRESTADOR,a.NM_USUARIO_ATEND,a.NR_SEQ_RECOLETA,
		b.ds_procedimento,
		obter_valor_dominio(12, a.ie_tipo_atendimento) ds_tipo_atendimento,
		obter_nome_setor(a.cd_setor_atendimento) ds_setor_atendimento,
		obter_nome_setor(a.cd_setor_prescr) ds_setor_prescr,
		obter_nome_setor(a.cd_setor_entrega) ds_setor_entrega,
		obter_nome_setor(a.cd_setor_proc) ds_setor_proc,	
		obter_valor_dominio(17, a.ie_clinica) ds_clinica,
		obter_valor_dominio(95, a.cd_tipo_procedimento) ds_tipo_procedimento,
		obter_nome_pessoa_fisica(a.cd_medico_prescr, null) nm_medico,
		Obter_Desc_Grupo_Exame_lab(a.nr_seq_grupo) ds_grupo_lab,
		c.nm_exame,
		a.dt_hora_exame ds_hora_exame,
		a.dt_hora_exame hr_hora_exame,
		obter_nome_estabelecimento(a.cd_estabelecimento) ds_estabelecimento,
		obter_empresa_estab(a.cd_estabelecimento) cd_empresa,
		substr(obter_nome_pf(a.cd_medico_resp),1,100) nm_medico_resp,
		trunc(dt_aprovacao) dt_aprov,
		trunc(dt_prescricao) dt_prescr,
		c.cd_exame,
		c.cd_exame||' - '||c.nm_exame ds_exame,
		substr(OBTER_NOME_PF(CD_PESSOA_COLETA),1,255) nm_pessoa_coleta,
		(select TRUNC(max(r.dt_impressao),'dd')
			FROM lab_prescr_proc_impressao r
			where r.nr_prescricao = a.nr_prescricao
			and r.nr_seq_prescr = a.nr_seq_prescr
			and	coalesce(r.ie_mapa_laudo,'L') = 'L') dt_impressao_laudo,
		(select TRUNC(max(r.dt_impressao),'dd')
			from lab_prescr_proc_impressao r
			where r.nr_prescricao = a.nr_prescricao
			and r.nr_seq_prescr = a.nr_seq_prescr
			and	r.ie_mapa_laudo = 'I') dt_impressao_web,
		(select TRUNC(max(r.dt_impressao),'dd')
			from lab_prescr_proc_impressao r
			where r.nr_prescricao = a.nr_prescricao
			and r.nr_seq_prescr = a.nr_seq_prescr
			and	r.ie_mapa_laudo = 'M') dt_impressao_mapa,
		substr(OBTER_NOME_PF(a.CD_PESSOA_FISICA),1,255) nm_paciente,
		substr(obter_valor_dominio(1030,a.ie_status_atend),1,255) ds_status_atend,
		substr(obter_desc_procedencia(a.cd_procedencia),1,255) ds_procedencia,
		substr(obter_idade_pf(a.CD_PESSOA_FISICA,LOCALTIMESTAMP,'A'),1,30) ds_idade,
		(select	substr(max(obter_desc_equipamento_lab(coalesce(y.cd_equipamento,(select max(z.cd_equipamento) from lab_exame_equip z where z.nr_seq_exame = a.nr_seq_exame)))),1,255)
		from  	exame_lab_resultado x,
				exame_lab_result_item y
		where	x.nr_seq_resultado = y.nr_seq_resultado
		and		y.nr_seq_material is not null
		and		x.nr_prescricao = a.nr_prescricao
		and		y.nr_seq_prescr = a.nr_seq_prescr) ds_equipamento,
		substr(obter_desc_indicacao(a.nr_seq_indicacao),1,150) ds_indicacao,
		substr(obter_categoria_convenio(a.cd_convenio,a.cd_categoria)||' - '|| OBTER_DESC_CONVENIO(cd_convenio),1,255) ds_categoria,
		c.nr_seq_grupo_imp,
		substr(Obter_Desc_Grupo_Imp_lab(c.nr_seq_grupo_imp),1,75) ds_grupo_imp,
		substr(obter_nome_pf_pj('',a.cd_cgc_prestador),1,255) ds_prestador,
		substr(coalesce(Obter_Desc_Usuario(a.nm_usuario_atend),'Nao informado'),1,50) ds_usuario_atend,
		(select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  from prescr_procedimento x where x.nr_prescricao = a.nr_prescricao and x.nr_sequencia = a.nr_seq_prescr and x.nr_seq_recoleta is not null) ie_motivo_recoleta,
		coalesce(substr(lab_obter_desc_motivo_recoleta(a.nr_seq_recoleta),1,60),'Sem recoleta') ds_motivo_recoleta,
		obter_setor_coleta_entr_exame(a.nr_prescricao,a.nr_seq_prescr,'C') cd_setor_coleta,
		obter_nome_setor(obter_setor_coleta_entr_exame(a.nr_prescricao,a.nr_seq_prescr,'C')) ds_setor_coleta,
		c.nr_seq_superior,
		substr((select max(ds_razao_social) from pessoa_juridica where cd_cgc = c.cd_cgc_externo),1,255) ds_cgc_externo,
		a.nr_prescricao nr_prescr,
		a.nr_atendimento nr_atend,
		ap.dt_entrada dt_atend
from	procedimento b,
		exame_laboratorio c,
		eis_proced_laborat a
left outer join atendimento_paciente ap ON (ap.nr_atendimento = a.nr_atendimento)
where 	a.cd_procedimento	= b.cd_procedimento
and		a.ie_origem_proced	= b.ie_origem_proced
and		a.nr_seq_exame	= c.nr_seq_exame;

