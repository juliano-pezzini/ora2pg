-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_contestacao_discussao_v (ie_tipo, ds_tipo, nr_sequencia, cd_item, ds_item, nm_beneficiario, nr_seq_conta, vl_unitario, qt_item, vl_total, nr_nota, nr_seq_fatura, nr_seq_guia, cd_usuario_plano, dt_referencia, nr_seq_pls_fatura_item, ie_tipo_fatura, ds_tipo_fatura, cd_guia, cd_item_imp, cd_guia_prestador, dt_servico, ie_pos_novo) AS select	/*+ CHOOSE */'P' ie_tipo,
	'Procedimentos' ds_tipo,
	a.nr_seq_conta_proc nr_sequencia,
	substr(pls_obter_dados_conta_pos(a.nr_seq_conta_pos_estab,'CP'),1,255) cd_item,
	substr(pls_obter_dados_conta_pos(a.nr_seq_conta_pos_estab,'DP'),1,255) ds_item,
	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_beneficiario,
	c.nr_seq_conta nr_seq_conta,
	CASE WHEN coalesce(y.qt_item,1)=0 THEN 0  ELSE coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0)/coalesce(y.qt_item,1) END  +
	coalesce((	select sum(p.vl_faturado) + sum(p.vl_faturado_ndc)
		FROM 	pls_fatura_proc p 
		where 	p.nr_seq_conta_pos_estab = a.nr_seq_conta_pos_estab
		and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta
		and p.ie_tipo_cobranca in ('3','4')),0) vl_unitario,
	coalesce(y.qt_item,1) qt_item,
	coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0) +
	coalesce((	select sum(p.vl_faturado) + sum(p.vl_faturado_ndc) 
		from pls_fatura_proc p 
		where 	p.nr_seq_conta_pos_estab = a.nr_seq_conta_pos_estab
		and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta
		and p.ie_tipo_cobranca in ('3','4')),0) vl_total,
	(select	max(x.nr_nota)
	from	ptu_nota_cobranca x
	where	x.nr_seq_conta = c.nr_seq_conta) nr_nota,
	x.nr_seq_fatura nr_seq_fatura,
	null nr_seq_guia,
	pls_obter_dados_conta(c.nr_seq_conta,'C') cd_usuario_plano,
	null dt_referencia,
	a.nr_sequencia nr_seq_pls_fatura_item,
	'F' ie_tipo_fatura,
	'Faturamento' ds_tipo_fatura,
	coalesce(c.cd_guia_referencia,substr(pls_obter_dados_conta(c.nr_seq_conta,'G'),1,20)) cd_guia,
	(	select	to_char(max(i.cd_procedimento_imp)) 
		from	pls_conta_proc i
		where i.nr_sequencia = y.nr_seq_conta_proc) cd_item_imp,
	substr(pls_obter_dados_conta(c.nr_seq_conta, 'GE'), 1, 20) cd_guia_prestador,
	substr(pls_obter_dados_conta_proc(a.nr_seq_conta_proc, 'DTR'), 1, 15) dt_servico,
	'N' ie_pos_novo
from	pls_fatura			z,
	pls_fatura_evento 		x,
	pls_fatura_conta 		c,
	pls_fatura_proc 		a,
	pls_conta_pos_estabelecido	y
where	c.nr_seq_fatura_evento	= x.nr_sequencia
and	a.nr_seq_fatura_conta	= c.nr_sequencia
and	z.nr_sequencia		= x.nr_seq_fatura
and	y.nr_sequencia		= a.nr_seq_conta_pos_estab
and	a.ie_tipo_cobranca	not in ('3','4')
and	not exists (	select	1
			from	w_pls_selecao_item_contest t
			where	t.nr_seq_conta_proc = y.nr_seq_conta_proc
			and	t.nr_seq_fatura_proc = a.nr_sequencia)

union all

select	'M' ie_tipo,
	'Materiais' ds_tipo,
	a.nr_seq_conta_mat nr_sequencia,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat,'O'),1,255) cd_item,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat,'D'),1,255) ds_item,
	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_beneficiario,
	c.nr_seq_conta nr_seq_conta,
	CASE WHEN coalesce(y.qt_item,1)=0 THEN 0  ELSE coalesce(y.vl_beneficiario,0)/coalesce(y.qt_item,1) END  vl_unitario,
	coalesce(y.qt_item,1) qt_item,
	coalesce(y.vl_beneficiario,0) vl_total,
	(select	max(x.nr_nota)
	from	ptu_nota_cobranca x
	where	x.nr_seq_conta = c.nr_seq_conta) nr_nota,
	x.nr_seq_fatura nr_seq_fatura,
	null nr_seq_guia,
	pls_obter_dados_conta(c.nr_seq_conta,'C') cd_usuario_plano,
	null dt_referencia,
	a.nr_sequencia nr_seq_pls_fatura_item,
	'F' ie_tipo_fatura,
	'Faturamento' ds_tipo_fatura,
	coalesce(c.cd_guia_referencia,substr(pls_obter_dados_conta(c.nr_seq_conta,'G'),1,20)) cd_guia,
	(	select	to_char(max(i.cd_material_imp))
		from	pls_conta_mat i 
		where	i.nr_sequencia = y.nr_seq_conta_mat) cd_item_imp,
	substr(pls_obter_dados_conta(c.nr_seq_conta, 'GE'), 1, 20) cd_guia_prestador,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat, 'DTR'),1,15) dt_servico,
	'N' ie_pos_novo
from	pls_fatura			z,
	pls_fatura_evento 		x,
	pls_fatura_conta 		c,
	pls_fatura_mat 			a,
	pls_conta_pos_estabelecido	y
where	c.nr_seq_fatura_evento	= x.nr_sequencia
and	a.nr_seq_fatura_conta	= c.nr_sequencia
and	z.nr_sequencia		= x.nr_seq_fatura
and	y.nr_sequencia		= a.nr_seq_conta_pos_estab
and	a.ie_tipo_cobranca	not in ('3','4')
and	not exists (	select	1
			from	w_pls_selecao_item_contest	t
			where	t.nr_seq_conta_mat = y.nr_seq_conta_mat
			and	t.nr_seq_fatura_mat = a.nr_sequencia)

union all

select	'P' ie_tipo,
	'Procedimentos' ds_tipo,
	a.nr_seq_conta_proc nr_sequencia,
	substr(coalesce(y.cd_procedimento,pls_obter_dados_conta_proc(a.nr_seq_conta_proc,'C')),1,255) cd_item,
	substr(coalesce(obter_descricao_procedimento(y.cd_procedimento,y.ie_origem_proced),pls_obter_dados_conta_proc(a.nr_seq_conta_proc,'D')),1,255) ds_item,
	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_beneficiario,
	c.nr_seq_conta nr_seq_conta,
	((select sum(p.vl_faturado) + sum(p.vl_faturado_ndc) from pls_fatura_proc p where p.nr_seq_pos_proc = a.nr_seq_pos_proc)/coalesce(y.qt_item,1)) vl_unitario,
	coalesce(y.qt_item,1) qt_item,
	(select sum(p.vl_faturado) + sum(p.vl_faturado_ndc) from pls_fatura_proc p where p.nr_seq_pos_proc = a.nr_seq_pos_proc) vl_total,
	(select	max(x.nr_nota)
	from	ptu_nota_cobranca x
	where	x.nr_seq_conta = c.nr_seq_conta) nr_nota,
	x.nr_seq_fatura nr_seq_fatura,
	null nr_seq_guia,
	pls_obter_dados_conta(c.nr_seq_conta,'C') cd_usuario_plano,
	null dt_referencia,
	a.nr_sequencia nr_seq_pls_fatura_item,
	'F' ie_tipo_fatura,
	'Faturamento' ds_tipo_fatura,
	coalesce(c.cd_guia_referencia,substr(pls_obter_dados_conta(c.nr_seq_conta,'G'),1,20)) cd_guia,
	(	select	to_char(max(i.cd_procedimento_imp)) 
		from	pls_conta_proc i
		where i.nr_sequencia = y.nr_seq_conta_proc) cd_item_imp,
	substr(pls_obter_dados_conta(c.nr_seq_conta, 'GE'), 1, 20) cd_guia_prestador,
	substr(pls_obter_dados_conta_proc(a.nr_seq_conta_proc, 'DTR'), 1, 15) dt_servico,
	'S' ie_pos_novo
from	pls_fatura		z,
	pls_fatura_evento 	x,
	pls_fatura_conta 	c,
	pls_fatura_proc 	a,
	pls_conta_pos_proc	y
where	c.nr_seq_fatura_evento	= x.nr_sequencia
and	a.nr_seq_fatura_conta	= c.nr_sequencia
and	z.nr_sequencia		= x.nr_seq_fatura
and	y.nr_sequencia		= a.nr_seq_pos_proc
and	a.ie_tipo_cobranca	not in ('3','4')
and	not exists (	select	1
			from	w_pls_selecao_item_contest t
			where	t.nr_seq_conta_proc = y.nr_seq_conta_proc
			and	t.nr_seq_fatura_proc = a.nr_sequencia)

union all

select	'M' ie_tipo,
	'Materiais' ds_tipo,
	a.nr_seq_conta_mat nr_sequencia,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat,'O'),1,255) cd_item,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat,'D'),1,255) ds_item,
	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_beneficiario,
	c.nr_seq_conta nr_seq_conta,
	((select sum(p.vl_faturado) + sum(p.vl_faturado_ndc) from pls_fatura_mat p where p.nr_seq_pos_mat = a.nr_seq_pos_mat)/coalesce(y.qt_item,1)) vl_unitario,
	coalesce(y.qt_item,1) qt_item,
	(select sum(p.vl_faturado) + sum(p.vl_faturado_ndc) from pls_fatura_mat p where p.nr_seq_pos_mat = a.nr_seq_pos_mat) vl_total,
	(select	max(x.nr_nota)
	from	ptu_nota_cobranca x
	where	x.nr_seq_conta = c.nr_seq_conta) nr_nota,
	x.nr_seq_fatura nr_seq_fatura,
	null nr_seq_guia,
	pls_obter_dados_conta(c.nr_seq_conta,'C') cd_usuario_plano,
	null dt_referencia,
	a.nr_sequencia nr_seq_pls_fatura_item,
	'F' ie_tipo_fatura,
	'Faturamento' ds_tipo_fatura,
	coalesce(c.cd_guia_referencia,substr(pls_obter_dados_conta(c.nr_seq_conta,'G'),1,20)) cd_guia,
	(	select	to_char(max(i.cd_material_imp))
		from	pls_conta_mat i 
		where	i.nr_sequencia = y.nr_seq_conta_mat) cd_item_imp,
	substr(pls_obter_dados_conta(c.nr_seq_conta, 'GE'), 1, 20) cd_guia_prestador,
	substr(pls_obter_dados_conta_mat(a.nr_seq_conta_mat, 'DTR'),1,15) dt_servico,
	'S' ie_pos_novo
from	pls_fatura		z,
	pls_fatura_evento	x,
	pls_fatura_conta 	c,
	pls_fatura_mat 		a,
	pls_conta_pos_mat	y
where	c.nr_seq_fatura_evento	= x.nr_sequencia
and	a.nr_seq_fatura_conta	= c.nr_sequencia
and	z.nr_sequencia		= x.nr_seq_fatura
and	y.nr_sequencia		= a.nr_seq_pos_mat
and	a.ie_tipo_cobranca	not in ('3','4')
and	not exists (	select	1
			from	w_pls_selecao_item_contest t
			where	t.nr_seq_conta_mat = y.nr_seq_conta_mat
			and	t.nr_seq_fatura_mat = a.nr_sequencia)
order by ie_tipo,nr_seq_conta;

