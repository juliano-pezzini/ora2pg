-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_topazio_proced_v (nr_seq_protocolo, cd_convenio, tp_registro, ie_disquete, cd_tipo_registro, cd_federacao, nr_lote, cd_prestador, nr_seq_conta, nm_singular, ie_prestador, cd_cgc_hospital, nm_prestador, dt_remessa, nr_remessa, ds_espaco, nr_registro, nm_paciente, ie_sexo, dt_nascimento, nr_prontuario, cd_plano, cd_usuario, nm_convenio, qt_zeros, ie_tipo_nota, nr_nota, nr_conta_ambulat, tp_conta_origem, nr_conta_origem, cd_natureza, dt_competencia, ie_tipo_paciente, cd_tipo_atendimento, cd_classe_atend, cd_tipo_acomodacao, dt_entrada, hr_entrada, dt_saida, hr_saida, cd_motivo_alta, cd_cid, nr_crm, ds_uf_crm, nm_medico_resp, nr_crm_req, ds_uf_req, nm_medico_req, cd_medico_req, dt_req_assinada, cd_tipo_nasc, qt_eventos_nasc, qt_eventos_obito, nr_seq_autorizacao, cd_proc_autorizado, ds_proc_autorizado, cd_acomod_autorizado, qt_proc_autorizado, nr_guia, dt_guia, ds_senha, nm_autorizador, nr_seq_item_conta, cd_prest_exec, dt_procedimento, hr_procedimento, cd_funcao_executor, nr_porte_anestesico, ds_item, nr_crm_req_exa, nr_guia_exame, cd_prest_cobranca, cd_item, cd_unidade_medida, qt_item, qt_ch, vl_ch, vl_unitario, vl_total_item, ds_local_uso, cd_proc_referencia, cd_via_acesso, ie_tipo_item, qt_diarias_normais, qt_diarias_uti, qt_participantes, vl_honorarios, vl_diarias_normais, vl_diarias_uti, vl_tot_servicos, vl_tot_medicamentos, vl_tot_materiais, vl_sadt, vl_filmes, vl_tot_conta, nr_fatura, qt_conta_lote, vl_total_lote, qt_conta_remessa, vl_total_remessa, nr_interno_conta, dt_validade_carteira, nr_cns, qt_nasc_prematuro, qt_obito_nasc_precoce, qt_obito_nasc_tardio, ie_motivo_obito_mulher, ie_regime_internacao, tp_internacao, ie_motivo_saida_internacao, id_int_obstetricia_1, id_int_obstetricia_2, id_int_obstetricia_3, id_int_obstetricia_4, id_int_obstetricia_5, id_int_obstetricia_6, id_int_obstetricia_7, id_int_obstetricia_8, id_int_obstetricia_9, tp_doenca, tempo_doenca, ie_periodo_doenca, indicacao_acidente, cd_cid_diagnostico_2, cd_cid_diagnostico_3, cd_cid_diagnostico_4, tp_consulta, tp_saida_consulta_sadt, cd_cid_obito, nr_declaracao_obito, hr_fim_realiz_proc, fator_participacao, vl_total_gases_med, tp_faturamento, cd_proc_principal, hr_proc, nr_declaracao_vivos) AS SELECT 	distinct
	/* cabeçalho da conta 1 */
 
 	a.nr_seq_protocolo		nr_seq_protocolo, 
 	a.cd_convenio			cd_convenio, 
 	1 				tp_registro, 
 	'FATOU' 			ie_disquete, 
 	1 				cd_tipo_registro, 
 	Somente_Numero(a.cd_regional) 	cd_federacao, 
 	0 				nr_lote, 
 	SUBSTR(a.cd_interno,1,12) 	cd_prestador, 
 	0 				nr_seq_conta, 
 	' ' 				nm_singular, 
	' ' 				ie_prestador, 
 	' ' 				cd_cgc_hospital, 
 	' ' 				nm_prestador, 
 	LOCALTIMESTAMP 			dt_remessa, 
 	0 				nr_remessa, 
 	' ' 				ds_espaco, 
 	0 				nr_registro, 
 	upper(SUBSTR(b.nm_paciente,1,40)) nm_paciente, 
 	b.ie_sexo			ie_sexo, 
 	b.dt_nascimento			dt_nascimento, 
 	Somente_Numero(SUBSTR(b.nr_prontuario,1,7)) 
					nr_prontuario, 
 	SUBSTR(b.cd_categoria_convenio,1,2) cd_plano, 
 	SUBSTR(b.cd_usuario_convenio,1,16) cd_usuario, 
 	SUBSTR(c.ds_convenio,1,35) 	nm_convenio, 
 	0 				qt_zeros, 
	'5'				ie_tipo_nota, 
 	/*substr(OBTER_TIPO_GUIA_PROCED(K.nr_seq_item),1,1) ie_tipo_nota,*/
 
 	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END ) NR_NOTA, 
 	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END ) nr_conta_ambulat, 
 	CASE WHEN d.ie_tipo_guia='I' THEN 'I'  ELSE 'E' END  tp_conta_origem, 
 	(d.cd_autorizacao)::numeric  	nr_conta_origem, 
 	0 				cd_natureza, 
 	LOCALTIMESTAMP 			dt_competencia, 
 	' ' 				ie_tipo_paciente, 
 	0 				cd_tipo_atendimento, 
 	' ' 				cd_classe_atend, 
 	' ' 				cd_tipo_acomodacao, 
 	LOCALTIMESTAMP 			dt_entrada, 
 	LOCALTIMESTAMP 			hr_entrada, 
 	LOCALTIMESTAMP 			dt_saida, 
 	LOCALTIMESTAMP 			hr_saida, 
 	' ' 				cd_motivo_alta, 
 	' ' 				cd_cid, 
 	0 				nr_crm, 
 	' ' 				ds_uf_crm, 
 	' ' 				nm_medico_resp, 
 	0 				nr_crm_req, 
 	' ' 				ds_uf_req, 
 	' ' 				nm_medico_req, 
 	' ' 				cd_medico_req, 
 	LOCALTIMESTAMP 			dt_req_assinada, 
 	0 				cd_tipo_nasc, 
 	0 				qt_eventos_nasc, 
 	0 				qt_eventos_obito, 
 	0 				nr_seq_autorizacao, 
 	0 				cd_proc_autorizado, 
 	' ' 				ds_proc_autorizado, 
 	' ' 				cd_acomod_autorizado, 
 	0 				qt_proc_autorizado, 
 	' ' 				nr_guia, 
 	LOCALTIMESTAMP 			dt_guia, 
 	' ' 				ds_senha, 
 	' ' 				nm_autorizador, 
 	0 				nr_seq_item_conta, 
 	' ' 				cd_prest_exec, 
 	LOCALTIMESTAMP 			dt_procedimento, 
 	LOCALTIMESTAMP 			hr_procedimento, 
 	' ' 				cd_funcao_executor, 
 	0 				nr_porte_anestesico, 
 	' ' 				ds_item, 
 	0 				nr_crm_req_exa, 
 	0 				nr_guia_exame, 
 	' ' 				cd_prest_cobranca, 
 	0 				cd_item, 
 	' ' 				cd_unidade_medida, 
 	0 				qt_item, 
 	0 				qt_ch, 
 	0 				vl_ch, 
 	0 				vl_unitario, 
 	0 				vl_total_item, 
 	' ' 				ds_local_uso, 
 	0 				cd_proc_referencia, 
 	' ' 				cd_via_acesso, 
 	0 				ie_tipo_item, 
 	0 				qt_diarias_normais, 
 	0 				qt_diarias_uti, 
	0 				qt_participantes, 
 	0 				vl_honorarios, 
	0 				vl_diarias_normais, 
	0 				vl_diarias_uti, 
	0 				vl_tot_servicos, 
	0 				vl_tot_medicamentos, 
	0 				vl_tot_materiais, 
	0 				vl_sadt, 
	0 				vl_filmes, 
	0 				vl_tot_conta, 
	' ' 				nr_fatura, 
	0 				qt_conta_lote, 
	0 				vl_total_lote, 
	0 				qt_conta_remessa, 
	0 				vl_total_remessa, 
	b.nr_interno_conta 		nr_interno_conta, 
	b.dt_validade_carteira		dt_validade_carteira, 
	0 				nr_cns, 
	0 				qt_nasc_prematuro, 
	0 				qt_obito_nasc_precoce, 
	0 				qt_obito_nasc_tardio, 
	0 				ie_motivo_obito_mulher, 
	0 				ie_regime_internacao, 
	0 				tp_internacao, 
	0 				ie_motivo_saida_internacao, 
	' ' 				ID_INT_OBSTETRICIA_1, 
	' ' 				ID_INT_OBSTETRICIA_2, 
	' ' 				ID_INT_OBSTETRICIA_3, 
	' ' 				ID_INT_OBSTETRICIA_4, 
	' ' 				ID_INT_OBSTETRICIA_5, 
	' ' 				ID_INT_OBSTETRICIA_6, 
	' ' 				ID_INT_OBSTETRICIA_7, 
	' ' 				ID_INT_OBSTETRICIA_8, 
	' ' 				ID_INT_OBSTETRICIA_9, 
	' ' 				tp_doenca, 
	0 				tempo_doenca, 
	' ' 				ie_periodo_doenca, 
	0 				indicacao_acidente, 
	' ' 				cd_cid_diagnostico_2, 
	' ' 				cd_cid_diagnostico_3, 
	' ' 				cd_cid_diagnostico_4, 
	0 				tp_consulta, 
	0 				tp_saida_consulta_sadt, 
	' ' 				cd_cid_obito, 
	0 				nr_declaracao_obito, 
	LOCALTIMESTAMP 			HR_FIM_REALIZ_PROC, 
	0 				FATOR_PARTICIPACAO, 
	0 				vl_total_gases_med, 
	' ' 				tp_faturamento, 
	0				cd_proc_principal, 
	LOCALTIMESTAMP				hr_proc, 
	' '				NR_DECLARACAO_VIVOS 
FROM 	convenio 		c, 
   	w_interf_conta_header 	a, 
   	w_interf_conta_cab 	b, 
   	conta_paciente 		d, 
   	w_interf_conta_item 	K 
WHERE 	K.nr_interno_conta 	= 	b.nr_interno_conta 
--AND 	((nvl(k.cd_especialidade_proc,0) = 28000005) or (K.ie_total_interf 	= 	4)) 
and (K.ie_total_interf 	= 	4) 
AND 	a.nr_seq_protocolo 	= 	b.nr_seq_protocolo 
AND 	b.cd_convenio 		= 	c.cd_convenio 
and 	b.nr_interno_conta 	= 	d.nr_interno_conta 
and 	K.nr_prescricao 	<> 	0 

UNION ALL
 
SELECT 	distinct 
	/* cabeçalho da conta 2 */
 
 	a.nr_seq_protocolo		nr_Seq_protocolo, 
 	a.cd_convenio			cd_convenio, 
 	2 				tp_registro, 
 	'FATOU' 			ie_disquete, 
 	2 				cd_tipo_registro, 
 	Somente_Numero(a.cd_regional) 	cd_federacao, 
 	0 				nr_lote, 
	SUBSTR(a.cd_interno,1,12) 	cd_prestador, 
	0 				nr_seq_conta, 
	' ' 				nm_singular, 
	' ' 				ie_prestador, 
	' ' 				cd_cgc_hospital, 
	' ' 				nm_prestador, 
	LOCALTIMESTAMP 			dt_remessa, 
	0 				nr_remessa, 
	' ' 				ds_espaco, 
	0 				nr_registro, 
	' ' 				nm_paciente, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	0 				nr_prontuario, 
	' ' 				cd_plano, 
	' ' 				cd_usuario, 
	' ' 				nm_convenio, 
	0 				qt_zeros, 
	'0' 				ie_tipo_nota, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END ) NR_NOTA, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END ) nr_conta_ambulat, 
	CASE WHEN d.ie_tipo_guia='I' THEN 'I'  ELSE 'E' END  tp_conta_origem, 
	(d.cd_autorizacao)::numeric  nr_conta_origem, 
	0 				cd_natureza, 
	c.dt_mesano_referencia 		dt_competencia, 
	CASE WHEN d.ie_tipo_guia='I' THEN 'I'  ELSE 'E' END  ie_tipo_paciente, 
	ie_clinica 			cd_tipo_atendimento, 
	SUBSTR(ie_carater_inter,1,1) 	cd_classe_atend, 
	SUBSTR(cd_tipo_acomodacao,1,1) 	cd_tipo_acomodacao, 
	b.dt_entrada 			dt_entrada, 
	b.dt_entrada 			hr_entrada, 
	b.dt_alta 			dt_saida, 
	b.dt_alta 			hr_saida, 
	coalesce(substr(obter_conversao_externa(b.cd_cgc_convenio,'INTERF_ENVIO_TOPAZIO_V','CD_MOTIVO_ALTA',coalesce(b.cd_motivo_alta,0)),1,30),' ') 
					cd_motivo_alta, 
	coalesce(SUBSTR(b.cd_cid_principal,1,6),'   ') 
					cd_cid, 
	Somente_Numero(coalesce(substr(b.nr_crm_medico_resp,1,5),'0')) 
					nr_crm, 
	coalesce(b.uf_crm_medico_resp,' ') 	ds_uf_crm, 
	upper(SUBSTR(b.nm_medico_resp,1,40)) nm_medico_resp, 
	Somente_Numero(coalesce(substr(b.nr_crm_medico_resp,1,5),'0')) 
					nr_crm_req, 
	coalesce(b.uf_crm_medico_resp,' ') 	ds_uf_req, 
	SUBSTR(b.nm_medico_resp,1,40) 	nm_medico_req, 
	SUBSTR(b.cd_conv_medico_resp,1,12) cd_medico_req, 
	b.dt_entrada 			dt_req_assinada, 
	coalesce(Somente_Numero(b.ie_tipo_nascimento),0) cd_tipo_nasc, 
	0 				qt_eventos_nasc, 
	0 				qt_eventos_obito, 
	0 				nr_seq_autorizacao, 
	0 				cd_proc_autorizado, 
	' ' 				ds_proc_autorizado, 
	' ' 				cd_acomod_autorizado, 
	0 				qt_proc_autorizado, 
	' ' 				nr_guia, 
	LOCALTIMESTAMP 			dt_guia, 
	' ' 				ds_senha, 
	' ' 				nm_autorizador, 
	0 				nr_seq_item_conta, 
	' ' 				cd_prest_exec, 
	LOCALTIMESTAMP 			dt_procedimento, 
	LOCALTIMESTAMP 			hr_procedimento, 
	' ' 				cd_funcao_executor, 
	0 				nr_porte_anestesico, 
	' ' 				ds_item, 
	0 				nr_crm_req_exa, 
	0 				nr_guia_exame, 
	' ' 				cd_prest_cobranca, 
	0 				cd_item, 
	' ' 				cd_unidade_medida, 
	0 				qt_item, 
	0 				QT_CH, 
	0 				vl_ch, 
	0 				vl_unitario, 
	0 				vl_total_item, 
	' ' 				ds_local_uso, 
	0 				cd_proc_referencia, 
	' ' 				cd_via_acesso, 
	0 				ie_tipo_item, 
	0 				qt_diarias_normais, 
	0 				qt_diarias_uti, 
	0 				qt_participantes, 
	0 				vl_honorarios, 
	0 				vl_diarias_normais, 
	0 				vl_diarias_uti, 
	0 				vl_tot_servicos, 
	0 				vl_tot_medicamentos, 
	0 				vl_tot_materiais, 
	0 				vl_sadt, 
	0 				vl_filmes, 
	0 				vl_tot_conta, 
	' ' 				nr_fatura, 
	0 				qt_conta_lote, 
	0 				vl_total_lote, 
	0 				qt_conta_remessa, 
	0 				vl_total_remessa, 
	b.nr_interno_conta 		nr_interno_conta, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				nr_cns, 
	0 				qt_nasc_prematuro, 
	0 				qt_obito_nasc_precoce, 
	0 				qt_obito_nasc_tardio, 
	0 				ie_motivo_obito_mulher, 
	1 				ie_regime_internacao, 
	b.ie_clinica 			tp_internacao, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN b.cd_motivo_alta  ELSE 0 END  
					ie_motivo_saida_internacao, 
	'N' 				ID_INT_OBSTETRICIA_1, 
	'N' 				ID_INT_OBSTETRICIA_2, 
	'N' 				ID_INT_OBSTETRICIA_3, 
	'N' 				ID_INT_OBSTETRICIA_4, 
	'N' 				ID_INT_OBSTETRICIA_5, 
	'N' 				ID_INT_OBSTETRICIA_6, 
	'N' 				ID_INT_OBSTETRICIA_7, 
	'N' 				ID_INT_OBSTETRICIA_8, 
	'N' 				ID_INT_OBSTETRICIA_9, 
	' ' 				tp_doenca, 
	0 				tempo_doenca, 
	' ' 				ie_periodo_doenca, 
	0 				indicacao_acidente, 
	' ' 				cd_cid_diagnostico_2, 
	' ' 				cd_cid_diagnostico_3, 
	' ' 				cd_cid_diagnostico_4, 
	0 				tp_consulta, 
	0 				tp_saida_consulta_sadt, 
	' ' 				cd_cid_obito, 
	0 				nr_declaracao_obito, 
	LOCALTIMESTAMP 			HR_FIM_REALIZ_PROC, 
	0 				FATOR_PARTICIPACAO, 
	0 				vl_total_gases_med, 
	' ' 				tp_faturamento, 
	0				cd_proc_principal, 
	LOCALTIMESTAMP				hr_proc, 
	' '				NR_DECLARACAO_VIVOS 
FROM 	protocolo_convenio 	c, 
 	w_interf_conta_header 	a, 
 	w_interf_conta_cab 	b, 
 	conta_paciente 		d, 
 	w_interf_conta_item 	K 
WHERE 	coalesce(K.nr_prescricao,0) 	> 	0 
and 	K.nr_interno_conta 	= 	b.nr_interno_conta 
--AND 	((nvl(k.cd_especialidade_proc,0) = 28000005) or (K.ie_total_interf 	= 	4)) 
and (K.ie_total_interf 	= 	4) 
and 	a.nr_seq_protocolo 	= 	c.nr_seq_protocolo 
AND 	a.nr_seq_protocolo 	= 	b.nr_seq_protocolo 
and 	b.nr_interno_conta 	= 	d.nr_interno_conta 

union all
 
SELECT 
	/* ítem da conta exames,servicos*/
 
 	a.nr_seq_protocolo		NR_SEQ_protocolo, 
 	a.cd_convenio			cd_convenio, 
 	4 				tp_registro, 
 	'FATOU' 			ie_disquete, 
 	4 				cd_tipo_registro, 
 	Somente_Numero(a.cd_regional) 	cd_federacao, 
	0 				nr_lote, 
	SUBSTR(a.cd_interno,1,12) 	cd_prestador, 
	0 				nr_seq_conta, 
	' ' 				nm_singular, 
	' ' 				ie_prestador, 
	' ' 				cd_cgc_hospital, 
	' ' 				nm_prestador, 
	LOCALTIMESTAMP 			dt_remessa, 
	0 				nr_remessa, 
	' ' 				ds_espaco, 
	0 				nr_registro, 
	' ' 				nm_paciente, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	0 				nr_prontuario, 
	' ' 				cd_plano, 
	' ' 				cd_usuario, 
	' ' 				nm_convenio, 
	0 				qt_zeros, 
	'0' 				ie_tipo_nota, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(b.nr_prescricao,0))='0' THEN coalesce(b.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(b.nr_prescricao,0)) END ) NR_NOTA, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(b.nr_prescricao,0))='0' THEN coalesce(b.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(b.nr_prescricao,0)) END )	nr_conta_ambulat, 
	CASE WHEN d.ie_tipo_guia='I' THEN 'I'  ELSE 'E' END  tp_conta_origem, 
	(d.cd_autorizacao)::numeric  	nr_conta_origem, 
	0 				cd_natureza, 
	LOCALTIMESTAMP 			dt_competencia, 
	' ' 				ie_tipo_paciente, 
	0 				cd_tipo_atendimento, 
	' ' 				cd_classe_atend, 
	' ' 				cd_tipo_acomodacao, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			hr_entrada, 
	LOCALTIMESTAMP 			dt_saida, 
	LOCALTIMESTAMP 			hr_saida, 
	' ' 				cd_motivo_alta, 
	' ' 				cd_cid, 
	0 				nr_crm, 
	' ' 				ds_uf_crm, 
	' ' 				nm_medico_resp, 
	0 				nr_crm_req, 
	' ' 				ds_uf_req, 
	' ' 				nm_medico_req, 
	' ' 				cd_medico_req, 
	LOCALTIMESTAMP 			dt_req_assinada, 
	0 				cd_tipo_nasc, 
	0 				qt_eventos_nasc, 
	0 				qt_eventos_obito, 
	0 				nr_seq_autorizacao, 
	0 				cd_proc_autorizado, 
	' ' 				ds_proc_autorizado, 
	' ' 				cd_acomod_autorizado, 
	0 				qt_proc_autorizado, 
	' ' 				nr_guia, 
	LOCALTIMESTAMP 			dt_guia, 
	' ' 				ds_senha, 
	' ' 				nm_autorizador, 
	0 				nr_seq_item_conta, 
	trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) cd_prest_exec, 
	b.dt_item 			dt_procedimento, 
	b.dt_item 			hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  
					cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) 	nr_porte_anestesico, 
	upper(SUBSTR(b.ds_item,1,75)) 	ds_item, 
	coalesce(Somente_Numero(coalesce(SUBSTR(b.nr_crm_requisitante,1,5),b.nr_crm_executor)),0) 
					nr_crm_req_exa, 
	0 				nr_guia_exame, 
	' '				cd_prest_cobranca, 
	coalesce(Somente_Numero(coalesce(b.cd_item_convenio,b.cd_item)),0) 
					cd_item, 
	SUBSTR(b.cd_unidade_medida,1,3) cd_unidade_medida, 
	SUM(b.qt_item) 			qt_item, 
	0 				qt_ch, 
	0 				vl_ch, 
	0 				vl_unitario, 
	/*SUM(b.vl_total_item / b.qt_item) vl_unitario,*/
 
	0 				vl_total_item, 
	/*SUM(vl_total_item) vl_total_item,*/
 
	 ' ' 				ds_local_uso, 
	(substr(coalesce(Obter_Proc_Ref(b.nr_seq_PROC_PRINC, 'C'),0),1,8))::numeric  	 
					cd_proc_referencia, 
	coalesce(substr(obter_conversao_externa(c.cd_cgc_convenio,'INTERF_ENVIO_TOPAZIO_V','CD_VIA_ACESSO',coalesce(b.ie_via_acesso_inf,0)),1,1),'0') 
					cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  
					ie_tipo_item, 
	0 				qt_diarias_normais, 
	0 				qt_diarias_uti, 
	0 				qt_participantes, 
	0 				vl_honorarios, 
	0 				vl_diarias_normais, 
	0 				vl_diarias_uti, 
	0 				vl_tot_servicos, 
	0 				vl_tot_medicamentos, 
	0 				vl_tot_materiais, 
	0 				vl_sadt, 
	0 				vl_filmes, 
	0 				vl_tot_conta, 
	' ' 				nr_fatura, 
	0 				qt_conta_lote, 
	0 				vl_total_lote, 
	0 				qt_conta_remessa, 
	0 				vl_total_remessa, 
	c.nr_interno_conta 		nr_interno_conta, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				nr_cns, 
	0 				qt_nasc_prematuro, 
	0 				qt_obito_nasc_precoce, 
	0 				qt_obito_nasc_tardio, 
	0 				ie_motivo_obito_mulher, 
	0 				ie_regime_internacao, 
	0 				tp_internacao, 
	0 				ie_motivo_saida_internacao, 
	' ' 				ID_INT_OBSTETRICIA_1, 
	' ' 				ID_INT_OBSTETRICIA_2, 
	' ' 				ID_INT_OBSTETRICIA_3, 
	' ' 				ID_INT_OBSTETRICIA_4, 
	' ' 				ID_INT_OBSTETRICIA_5, 
	' ' 				ID_INT_OBSTETRICIA_6, 
	' ' 				ID_INT_OBSTETRICIA_7, 
	' ' 				ID_INT_OBSTETRICIA_8, 
	' ' 				ID_INT_OBSTETRICIA_9, 
	' ' 				tp_doenca, 
	0 				tempo_doenca, 
	' ' 				ie_periodo_doenca, 
	0 				indicacao_acidente, 
	' ' 				cd_cid_diagnostico_2, 
	' ' 				cd_cid_diagnostico_3, 
	' ' 				cd_cid_diagnostico_4, 
	0 				tp_consulta, 
	0 				tp_saida_consulta_sadt, 
	' ' 				cd_cid_obito, 
	0 				nr_declaracao_obito, 
	LOCALTIMESTAMP 			HR_FIM_REALIZ_PROC, 
	0 				FATOR_PARTICIPACAO, 
	0 				vl_total_gases_med, 
	' ' 				tp_faturamento, 
	0				cd_proc_principal, 
	b.dt_item			hr_proc, 
	' '				NR_DECLARACAO_VIVOS 
FROM conta_paciente d, w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE c.nr_interno_conta 	= 	d.nr_interno_conta and b.nr_seq_protocolo 	= 	a.nr_seq_protocolo AND b.nr_seq_protocolo 	= 	c.nr_seq_protocolo AND b.nr_interno_conta 	= 	c.nr_interno_conta --AND 	((nvl(b.cd_especialidade_proc,0) = 28000005) or (b.ie_total_interf 	= 	4)) 
  and (b.ie_total_interf 	= 	4) AND coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  AND coalesce(z.ie_entra_conta,'S') = 	'S' AND b.qt_item  		<> 	0 --AND 	nvl(b.cd_especialidade_proc,0) <> 16000005 
  AND coalesce(b.ie_tipo_item,0) 	<> 2 AND b.cd_item NOT IN (SELECT x.cd_procedimento 
 			FROM 	estrutura_procedimento_v x 
 			WHERE 	x.cd_area_procedimento IN (1,4,11,13)) AND b.cd_item NOT IN (SELECT x.cd_procedimento 
 						FROM estrutura_procedimento_v x 
 						WHERE x.cd_grupo_proc IN (7,4)) GROUP BY 
 	a.nr_seq_protocolo,	 
 	a.cd_convenio, 
 	Somente_Numero(a.cd_regional), 
 	SUBSTR(a.cd_interno,1,12), 
	trim(both SUBSTR(b.cd_medico_exec_conv,1,12)), 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(b.nr_prescricao,0))='0' THEN coalesce(b.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(b.nr_prescricao,0)) END ), 
 	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(b.nr_prescricao,0))='0' THEN coalesce(b.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(b.nr_prescricao,0)) END ), 
 	CASE WHEN d.ie_tipo_guia='I' THEN 'I'  ELSE 'E' END , 
 	(d.cd_autorizacao)::numeric , 
 	b.dt_item, 
 	b.dt_item, 
 	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
 	coalesce(b.nr_porte_anestesico,0), 
 	SUBSTR(b.ds_item,1,75), 
 	coalesce(Somente_Numero(coalesce(SUBSTR(b.nr_crm_requisitante,1,5),b.nr_crm_executor)),0), 
 	coalesce(Somente_Numero(b.nr_prescricao),0), 
 	coalesce(Somente_Numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
 	SUBSTR(b.cd_unidade_medida,1,3), 
	(substr(coalesce(Obter_Proc_Ref(b.nr_seq_PROC_PRINC, 'C'),0),1,8))::numeric , 
 	coalesce(substr(obter_conversao_externa(c.cd_cgc_convenio,'INTERF_ENVIO_TOPAZIO_V','CD_VIA_ACESSO',coalesce(b.ie_via_acesso_inf,0)),1,1),'0'), 
 	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
 	c.nr_interno_conta, 
 	b.cd_setor_atendimento 
HAVING 	SUM(b.qt_item) <> 0 

UNION ALL
 
SELECT 	distinct 
	/* total da conta */
 
 	a.nr_seq_protocolo			nr_seq_protocolo, 
 	a.cd_convenio				cd_convenio, 
	5 					tp_registro, 
	'FATOU' 				ie_disquete, 
	5 					cd_tipo_registro, 
	Somente_Numero(a.cd_regional) 		cd_federacao, 
	0 					nr_lote, 
	SUBSTR(a.cd_interno,1,12) 		cd_prestador, 
	0 					nr_seq_conta, 
	' ' 					nm_singular, 
	' ' 					ie_prestador, 
	' ' 					cd_cgc_hospital, 
	' ' 					nm_prestador, 
	LOCALTIMESTAMP 				dt_remessa, 
	0 					nr_remessa, 
	' ' 					ds_espaco, 
	0 					nr_registro, 
	' ' 					nm_paciente, 
	' ' 					ie_sexo, 
	LOCALTIMESTAMP 				dt_nascimento, 
	0 					nr_prontuario, 
	' ' 					cd_plano, 
	' ' 					cd_usuario, 
	' ' 					nm_convenio, 
	0 					qt_zeros, 
	'0' 					ie_tipo_nota, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END )	NR_NOTA, 
	somente_numero(CASE WHEN obter_guia_prescricao(coalesce(K.nr_prescricao,0))='0' THEN coalesce(K.nr_prescricao,0)  ELSE obter_guia_prescricao(coalesce(K.nr_prescricao,0)) END )	nr_conta_ambulat, 
	' ' 					tp_conta_origem, 
	0 					nr_conta_origem, 
	0 					cd_natureza, 
	LOCALTIMESTAMP 				dt_competencia, 
	' ' 					ie_tipo_paciente, 
	0 					cd_tipo_atendimento, 
	' ' 					cd_classe_atend, 
	' ' 					cd_tipo_acomodacao, 
	LOCALTIMESTAMP 				dt_entrada, 
	LOCALTIMESTAMP 				hr_entrada, 
	LOCALTIMESTAMP 				dt_saida, 
	LOCALTIMESTAMP 				hr_saida, 
	' ' 					cd_motivo_alta, 
	' ' 					cd_cid, 
	0 					nr_crm, 
	' ' 					ds_uf_crm, 
	' ' 					nm_medico_resp, 
	0 					nr_crm_req, 
	' ' 					ds_uf_req, 
	' ' 					nm_medico_req, 
	' ' 					cd_medico_req, 
	LOCALTIMESTAMP 				dt_req_assinada, 
	0 					cd_tipo_nasc, 
	0 					qt_eventos_nasc, 
	0 					qt_eventos_obito, 
	0 					nr_seq_autorizacao, 
	0 					cd_proc_autorizado, 
	' ' 					ds_proc_autorizado, 
	' ' 					cd_acomod_autorizado, 
	0 					qt_proc_autorizado, 
	' ' 					nr_guia, 
	LOCALTIMESTAMP 				dt_guia, 
	' ' 					ds_senha, 
	' ' 					nm_autorizador, 
	0 					nr_seq_item_conta, 
	' ' 					cd_prest_exec, 
	LOCALTIMESTAMP 				dt_procedimento, 
	LOCALTIMESTAMP 				hr_procedimento, 
	' ' 					cd_funcao_executor, 
	0 					nr_porte_anestesico, 
	 ' ' 					ds_item, 
	0 					nr_crm_req_exa, 
	0 					nr_guia_exame, 
	' ' 					cd_prest_cobranca, 
	0 					cd_item, 
	' ' 					cd_unidade_medida, 
	0 					qt_item, 
	0 					qt_ch, 
	0 					vl_ch, 
	0 					vl_unitario, 
	0 					vl_total_item, 
	' ' 					ds_local_uso, 
	0 					cd_proc_referencia, 
	' ' 					cd_via_acesso, 
	0 					ie_tipo_item, 
	0 					qt_diarias_normais, 
	0 					qt_diarias_uti, 
	0 					qt_participantes, 
	0 					vl_honorarios, 
	0 					vl_diarias_normais, 
	0 					vl_diarias_uti, 
	0 					vl_tot_servicos, 
	0 					vl_tot_medicamentos, 
	0 					vl_tot_materiais, 
	0 					vl_sadt, 
	0 					vl_filmes, 
	0 					vl_tot_conta, 
	' ' 					nr_fatura, 
	0 					qt_conta_lote, 
	0 					vl_total_lote, 
	0 					qt_conta_remessa, 
	0 					vl_total_remessa, 
	b.nr_interno_conta 			nr_interno_conta, 
	LOCALTIMESTAMP 				dt_validade_carteira, 
	0 					nr_cns, 
	0 					qt_nasc_prematuro, 
	0 					qt_obito_nasc_precoce, 
	0 					qt_obito_nasc_tardio, 
	0 					ie_motivo_obito_mulher, 
	0 					ie_regime_internacao, 
	0 					tp_internacao, 
	0 					ie_motivo_saida_internacao, 
	' ' 					ID_INT_OBSTETRICIA_1, 
	' ' 					ID_INT_OBSTETRICIA_2, 
	' ' 					ID_INT_OBSTETRICIA_3, 
	' ' 					ID_INT_OBSTETRICIA_4, 
	' ' 					ID_INT_OBSTETRICIA_5, 
	' ' 					ID_INT_OBSTETRICIA_6, 
	' ' 					ID_INT_OBSTETRICIA_7, 
	' ' 					ID_INT_OBSTETRICIA_8, 
	' ' 					ID_INT_OBSTETRICIA_9, 
	' ' 					tp_doenca, 
	0 					tempo_doenca, 
	' ' 					ie_periodo_doenca, 
	0 					indicacao_acidente, 
	' ' 					cd_cid_diagnostico_2, 
	' ' 					cd_cid_diagnostico_3, 
	' ' 					cd_cid_diagnostico_4, 
	0 					tp_consulta, 
	0 					tp_saida_consulta_sadt, 
	' ' 					cd_cid_obito, 
	0 					nr_declaracao_obito, 
	LOCALTIMESTAMP 				HR_FIM_REALIZ_PROC, 
	0 					FATOR_PARTICIPACAO, 
	0 					vl_total_gases_med, 
	'T' 					tp_faturamento, 
	0					cd_proc_principal, 
	LOCALTIMESTAMP					hr_proc, 
	' '					NR_DECLARACAO_VIVOS 
FROM 	w_interf_conta_header 	a, 
  	w_interf_conta_total 	b, 
   	w_interf_conta_item 	K 
WHERE 	coalesce(K.nr_prescricao,0) 	> 	0 
and 	K.nr_interno_conta 	= 	b.nr_interno_conta 
--AND 	((nvl(k.cd_especialidade_proc,0) = 28000005) or (K.ie_total_interf 	= 	4)) 
and (K.ie_total_interf 	= 	4) 
and 	b.nr_seq_protocolo 	= 	a.nr_seq_protocolo;

