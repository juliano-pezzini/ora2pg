-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_resumo_v (nr_interno_conta, vl_liquido, vl_desconto, vl_original, vl_original_medico, qt_item, qt_item_convenio, vl_medico) AS select	a.nr_interno_conta,
	sum(a.vl_material) vl_liquido,
	--sum(decode(nvl(b.ie_tipo_desconto,0), 0, 0, a.vl_desconto)) vl_desconto,
	sum(CASE WHEN coalesce(b.ie_tipo_desconto,0)=0 THEN  0  ELSE coalesce(obter_desconto_matproc(a.nr_sequencia,'M'),0) END ) vl_desconto,
	sum(a.vl_material + coalesce(obter_desconto_matproc(a.nr_sequencia,'M'),0)) vl_original,
	sum(a.vl_bruto) vl_original_medico,
	sum(qt_material) qt_item,
	sum(a.qt_material_convenio) qt_item_convenio,
	0 vl_medico
FROM conta_paciente_material_v a
LEFT OUTER JOIN conta_paciente_desconto b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia and a.cd_motivo_exc_conta is null  and ((7			<> coalesce(b.ie_tipo_desconto,0)) or ( a.NR_SEQ_PROC_PACOTE is null)) and coalesce(b.nr_sequencia,0) = (select coalesce(max(x.nr_sequencia),0)
			  from 	conta_paciente_desconto x
			  where x.nr_interno_conta = b.nr_interno_conta) and coalesce(a.nr_seq_desconto,0) = (select coalesce(max(x.nr_seq_desconto),0)
			     from   conta_paciente_material_v x
			     where  x.nr_sequencia = a.nr_sequencia) group by a.nr_interno_conta

union all

select	a.nr_interno_conta,
	sum(a.vl_procedimento) vl_liquido,
	sum(CASE WHEN coalesce(b.ie_tipo_desconto,0)=0 THEN  0  ELSE a.vl_desconto END ) vl_desconto,
	sum(a.vl_bruto) vl_original,
	sum(CASE WHEN a.vl_bruto=0 THEN a.vl_medico+ Obter_Valor_Participante(a.nr_sequencia)  ELSE a.vl_bruto END ) vl_original_medico,
	sum(qt_procedimento) qt_item,
	sum(a.qt_proced_convenio) qt_item_convenio,
	obter_valor_honorario(a.nr_interno_conta, 'MED') vl_medico
FROM conta_paciente_procedimento_v a
LEFT OUTER JOIN conta_paciente_desconto b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE coalesce(a.nr_seq_proc_pacote, 0) <> a.nr_sequencia and a.cd_motivo_exc_conta is null  and ((7			<> coalesce(b.ie_tipo_desconto,0)) or ( a.NR_SEQ_PROC_PACOTE is null)) and coalesce(b.nr_sequencia,0) = (select coalesce(max(x.nr_sequencia),0)
				from 	conta_paciente_desconto x
				where x.nr_interno_conta = b.nr_interno_conta) group by a.nr_interno_conta

union all

select	a.nr_interno_conta,
	sum(a.vl_procedimento) vl_liquido,
	sum(CASE WHEN coalesce(b.ie_tipo_desconto,0)=0 THEN  0  ELSE a.vl_desconto END ) vl_desconto,
	sum(a.vl_bruto) vl_original,
	sum(CASE WHEN a.vl_bruto=0 THEN a.vl_medico+ Obter_Valor_Participante(a.nr_sequencia)  ELSE a.vl_bruto END ) vl_original_medico,
	sum(qt_procedimento) qt_item,
	sum(a.qt_proced_convenio) qt_item_convenio,
	obter_valor_honorario(a.nr_interno_conta, 'MED') vl_medico
from	conta_paciente_desconto b,
	conta_paciente_procedimento_v a
where 	a.nr_seq_proc_pacote	= a.nr_sequencia
and	a.nr_interno_conta	= b.nr_interno_conta
and 	b.ie_tipo_desconto	= 7
and	a.cd_motivo_exc_conta is null
group by a.nr_interno_conta;

