-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_hscf_senior_v (tp_registro, nr_titulo, dt_emissao, cd_prestador, dt_pagamento, nr_terceiro, nr_rpa, pr_grp, nr_dependente_irf, dt_rendimentos, vl_rendimentos, vl_outros_descontos, vl_base_inss, vl_deducao_inss, vl_inss_transporte, vl_base_irf, vl_pensao, vl_ir_retido, vl_iss, cd_custo) AS select	tp_registro,
	nr_titulo,
	dt_emissao,
	cd_prestador,
	dt_pagamento,
	nr_terceiro,
	nr_rpa,
	pr_grp,
	nr_dependente_irf,
	dt_rendimentos,
	sum(vl_rendimentos) vl_rendimentos,
	sum(vl_outros_descontos) vl_outros_descontos,
	sum(vl_base_inss) vl_base_inss,
	sum(vl_deducao_inss) vl_deducao_inss,
	sum(vl_inss_transporte) vl_inss_transporte,
	sum(vl_base_irf) vl_base_irf,
	sum(vl_pensao) vl_pensao,
	sum(vl_ir_retido) vl_ir_retido,
	sum(vl_iss) vl_iss,
	cd_custo
FROM (
select	1					tp_registro,
	a.nr_titulo				nr_titulo,
	a.dt_emissao				dt_emissao,
	coalesce(a.cd_pessoa_fisica, a.cd_cgc)	cd_prestador,
	a.dt_vencimento_atual			dt_pagamento,
	d.nr_seq_terceiro			nr_terceiro,
	a.nr_seq_rpa				nr_rpa,
	0					pr_grp,
	0					nr_dependente_irf,
	LOCALTIMESTAMP					dt_rendimentos,
	sum(coalesce(a.vl_titulo,0))			vl_rendimentos,
	0					vl_outros_descontos,
	CASE WHEN e.ie_tipo_tributo='INSS' THEN  sum(coalesce(c.vl_base_calculo,0))  ELSE 0 END  vl_base_inss,
	CASE WHEN e.ie_tipo_tributo='INSS' THEN  sum(coalesce(c.vl_reducao,0))  ELSE 0 END  vl_deducao_inss,
	0					vl_inss_transporte,
	CASE WHEN e.ie_tipo_tributo='IR' THEN  sum(coalesce(c.vl_base_calculo,0))  ELSE 0 END  vl_base_irf,
	0					vl_pensao,
	CASE WHEN e.ie_tipo_tributo='IR' THEN  sum(coalesce(vl_nao_retido,0))  ELSE 0 END  vl_ir_retido,
	0					vl_iss,
	999999999				cd_custo
from	estabelecimento b,
	repasse_terceiro d,
	tributo e,
	titulo_pagar a,
	titulo_pagar_imposto c
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_titulo		= c.nr_titulo
and	a.nr_repasse_terceiro	= d.nr_repasse_terceiro
and	e.cd_tributo		= c.cd_tributo
and	a.nr_repasse_terceiro is not null
group by	e.ie_tipo_tributo,
		a.nr_titulo,
		a.dt_emissao,
		coalesce(a.cd_pessoa_fisica, a.cd_cgc),
		a.dt_vencimento_atual,
		d.nr_seq_terceiro,
		a.nr_seq_rpa	) alias21
group by tp_registro,
	nr_titulo,
	dt_emissao,
	cd_prestador,
	dt_pagamento,
	nr_terceiro,
	nr_rpa,
	pr_grp,
	nr_dependente_irf,
	dt_rendimentos,
	cd_custo;

