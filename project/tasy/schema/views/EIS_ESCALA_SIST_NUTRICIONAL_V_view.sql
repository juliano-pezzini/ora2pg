-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_escala_sist_nutricional_v (cd_setor_atendimento, ie_sexo, ds_sexo, cd_pessoa_fisica, ie_faixa_etaria, ds_resultado, dt_avaliacao, qt_24, qt_48, qt_72, cd_empresa, cd_estabelecimento, nr_atendimento, cd_paciente) AS select	distinct 	
	obter_setor_atendimento(e.nr_atendimento) cd_setor_atendimento, 
	obter_sexo_pf(a.cd_pessoa_fisica,'C') ie_sexo, 
	obter_sexo_pf(a.cd_pessoa_fisica,'D') ds_sexo, 
	a.cd_pessoa_fisica, 
	substr(obter_idade(obter_data_nascto_pf(a.cd_pessoa_fisica),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
	substr(obter_result_escala_sist_nut(e.ie_dietoterapia,e.ie_fator_risco),1,255) ds_resultado, 
	trunc(e.dt_avaliacao) dt_avaliacao, 
	coalesce(obter_eis_nutricional(a.nr_atendimento, e.nr_sequencia, 'h24', 'N'),0) qt_24, 
	coalesce(obter_eis_nutricional(a.nr_atendimento, e.nr_sequencia, 'h48', 'N'),0) qt_48, 
	coalesce(obter_eis_nutricional(a.nr_atendimento, e.nr_sequencia, 'h72', 'N'),0) qt_72, 
	f.cd_empresa, 
	a.cd_estabelecimento, 
	a.nr_atendimento, 
	a.cd_pessoa_fisica cd_paciente 
FROM 	escala_sist_nutricional e, 
	estabelecimento f, 
	atendimento_paciente a 
where 	a.nr_atendimento= e.nr_atendimento 
and	a.cd_estabelecimento = f.cd_estabelecimento 
and	e.dt_liberacao is not null 
and	e.dt_inativacao is null;

