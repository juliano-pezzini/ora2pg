-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_interf_mens_copartic_hmc_v (tp_registro, nr_seq_segurado, titular, vl_mensalidade, vl_coparticipacao, vl_agrupado, nr_cpf, nm_pessoa_fisica, dt_nascimento, ds_titularidade, nr_seq_titular, nm_usuario, cd_matricula) AS select	1 tp_registro,
	null nr_seq_segurado,
	null titular,
	null vl_mensalidade,
	null vl_coparticipacao,
	null vl_agrupado,
	null nr_cpf,
	null nm_pessoa_fisica,
	null dt_nascimento,
	null ds_titularidade,
	null nr_seq_titular,
	null nm_usuario,
	null cd_matricula


union all

select	2 tp_registro,
	nr_seq_segurado,
	titular,
	Campo_Mascara_virgula(sum(vl_mensalidade)) vl_mensalidade,
	Campo_Mascara_virgula(sum(vl_coparticipacao)) vl_coparticipacao,
	Campo_Mascara_virgula(sum(vl_agrupado)) vl_agrupado,
	nr_cpf,
	nm_pessoa_fisica,
	dt_nascimento,
	ds_titularidade,
	nr_seq_titular,
	nm_usuario,
	cd_matricula_estipulante cd_matricula
from (	select	a.nr_seq_segurado,
		b.nr_sequencia titular,
		coalesce(pls_obter_valor_item_mens(c.nr_sequencia,'12'),0) vl_mensalidade,
		c.vl_coparticipacao,
		a.vl_agrupado,
		0 nr_seq_titular,
		d.nr_cpf,
		d.nm_pessoa_fisica,
		a.dt_mesano_referencia,
		d.dt_nascimento,
		'Titular' ds_titularidade,
		a.nm_usuario,
		b.cd_matricula_estipulante
	from	w_pls_interface_mens	a,
		pls_segurado		b,
		pls_mensalidade_segurado c,
		pessoa_fisica		d
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_mensalidade_seg = c.nr_sequencia
	and	b.cd_pessoa_fisica	= d.cd_pessoa_fisica
	and	b.nr_seq_titular is null
	
union all

	select	a.nr_seq_segurado,
		b.nr_seq_titular titular,
		coalesce(pls_obter_valor_item_mens(c.nr_sequencia,'12'),0),
		c.vl_coparticipacao,
		vl_agrupado,
		b.nr_seq_titular,
		d.nr_cpf,
		d.nm_pessoa_fisica,
		a.dt_mesano_referencia,
		d.dt_nascimento,
		'Dependente',
		a.nm_usuario,
		b.cd_matricula_estipulante
	from	w_pls_interface_mens	a,
		pls_segurado		b,
		pls_mensalidade_segurado c,
		pessoa_fisica		d
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_mensalidade_seg = c.nr_sequencia
	and	b.cd_pessoa_fisica	= d.cd_pessoa_fisica
	and	b.nr_seq_titular is not null
) alias10
group by nr_seq_segurado,
	titular,nr_cpf,
	nm_pessoa_fisica,
	dt_nascimento,
	nr_seq_titular,
	ds_titularidade,
	nm_usuario,
	cd_matricula_estipulante
order by tp_registro, titular, nr_seq_titular;

