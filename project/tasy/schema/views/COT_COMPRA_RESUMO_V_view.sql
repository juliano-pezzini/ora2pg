-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cot_compra_resumo_v (nr_seq_item_fornec, nr_sequencia, nr_cot_compra, nr_item_cot_compra, nr_solic_compra, nr_seq_cot_forn, nr_seq_cot_item_forn, cd_cgc_fornecedor_venc_alt, cd_cgc_fornecedor, nm_fornecedor, cd_pessoa_fisica, ie_situacao, cd_unidade_medida_compra, nr_ordem_compra, cd_material, ds_material_cadastro, dt_limite_entrega, ds_observacao, ds_material, ds_material_direto, qt_material, vl_unitario_material, vl_unitario_liquido, vl_preco_liquido, vl_frete_rateio, vl_presente, vl_preco, qt_prioridade, pr_desconto, dt_validade, vl_unid_fornec, vl_tributo, vl_resultado, vl_desconto, pr_desconto_forn_item, qt_conv_unid_fornec, ds_frete, ds_marca, ds_marca_fornec, cd_estabelecimento, cd_condicao_pagamento, ds_condicao_pagamento, ds_mensagem, ds_motivo_venc_alt, nr_contrato, nr_seq_contrato, nr_id_integracao, dt_geracao_ordem_compra, dt_liberacao, nm_usuario_lib, ds_justificativa_lib, nr_seq_agenda_pac, ie_finalidade_cotacao, dt_cot_compra, vl_unitario_ref_moeda, nr_seq_motivo_cancel, dt_reprovacao, nr_seq_proj_rec, vl_unit_previsto, ds_justif_escolha_fornec, ds_paciente, cd_paciente_forn_item) AS select	a.nr_Sequencia nr_seq_item_fornec,
	b.nr_sequencia,
	b.nr_cot_compra,
	b.nr_item_cot_compra,
	(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'SC'))::numeric  nr_solic_compra,
	b.nr_seq_cot_forn,
	b.nr_seq_cot_item_forn,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'FOA'),1,14) cd_cgc_fornecedor_venc_alt,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CNPJ'),1,14) cd_cgc_fornecedor,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'NMF'),1,80) nm_fornecedor,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CDP'),1,10) cd_pessoa_fisica,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'SIT'),1,1) ie_situacao,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'UMC'),1,15) cd_unidade_medida_compra,
	a.nr_ordem_compra,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,100) ds_material_cadastro,
	to_date(obter_dados_cot_compra_item(a.nr_cot_compra, a.nr_item_cot_compra, 'D')) dt_limite_entrega,
	a.ds_observacao,
	coalesce(coalesce(a.ds_material_direto, substr(obter_dados_cot_compra_item(a.nr_cot_compra, a.nr_item_cot_compra, 'DMD'),1,255)),
		substr(obter_desc_material(a.cd_material),1,255)) ds_material,
	a.ds_material_direto,
	b.qt_material,
	b.vl_unitario_material,
	b.vl_unitario_liquido,
	b.vl_preco_liquido,
	b.vl_frete_rateio,
	b.vl_presente,
	b.vl_preco,
	b.qt_prioridade,
	b.pr_desconto,
	a.dt_validade,
	b.vl_unid_fornec,
	(select sum(t.vl_tributo) FROM cot_compra_forn_item_tr t where a.nr_sequencia = t.nr_seq_cot_item_forn) vl_tributo,
	obter_result_cot_fornec_item(a.nr_sequencia) vl_resultado,	
	a.vl_desconto,
	a.pr_desconto pr_desconto_forn_item,
	a.qt_conv_unid_fornec,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'DF'),1,80) ds_frete,
	a.ds_marca,
	a.ds_marca_fornec,
	coalesce((obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'E'))::numeric , c.cd_estabelecimento) cd_estabelecimento,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CPG'),1,80) cd_condicao_pagamento,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'DCP'),1,80) ds_condicao_pagamento,
	b.ds_mensagem,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'MVA'),1,255) ds_motivo_venc_alt,
	a.nr_contrato,
	a.nr_seq_contrato,
	a.nr_id_integracao,
	c.dt_geracao_ordem_compra,
	a.dt_liberacao,
	a.nm_usuario_lib,
	a.ds_justificativa_lib,
	c.nr_seq_agenda_pac,
	c.ie_finalidade_cotacao,
	c.dt_cot_compra,
	a.vl_unitario_ref_moeda,
	c.nr_seq_motivo_cancel,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'DTR'),1,255) dt_reprovacao,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'PRE'),1,255) nr_seq_proj_rec,
	(select x.vl_unit_previsto from cot_compra_item x where x.nr_item_cot_compra = b.nr_item_cot_compra and x.nr_cot_compra = c.nr_cot_compra) vl_unit_previsto,
	a.ds_justif_escolha_fornec,
	substr(obter_nome_pf(a.cd_paciente_forn_item),1,255) ds_paciente,
	a.cd_paciente_forn_item
from	cot_compra c,
	cot_compra_resumo b,
	cot_compra_forn_item a
where	a.nr_sequencia		= b.nr_seq_cot_item_forn
and	a.nr_cot_compra = c.nr_cot_compra
and not exists (select 1
		from cot_compra_solic_agrup x
		where a.nr_item_cot_compra	= x.nr_item_cot_compra
		and a.nr_cot_compra	= x.nr_cot_compra
		and c.cd_estabelecimento	<> x.cd_estabelecimento
		and obter_qt_estab_item_agrup(x.nr_cot_compra, x.nr_item_cot_compra) > 1)

union all

select	a.nr_Sequencia nr_seq_item_fornec,
	b.nr_sequencia,
	b.nr_cot_compra,
	b.nr_item_cot_compra,
	x.nr_solic_compra,
	b.nr_seq_cot_forn,
	b.nr_seq_cot_item_forn,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'FOA'),1,14) cd_cgc_fornecedor_venc_alt,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CNPJ'),1,14) cd_cgc_fornecedor,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'NMF'),1,80) nm_fornecedor,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CDP'),1,10) cd_pessoa_fisica,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'SIT'),1,1) ie_situacao,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'UMC'),1,15) cd_unidade_medida_compra,
	x.nr_ordem_compra,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,100) ds_material_cadastro,
	to_date(obter_dados_cot_compra_item(a.nr_cot_compra, a.nr_item_cot_compra, 'D')) dt_limite_entrega,
	a.ds_observacao,
	coalesce(coalesce(a.ds_material_direto, substr(obter_dados_cot_compra_item(a.nr_cot_compra, a.nr_item_cot_compra, 'DMD'),1,255)),
		substr(obter_desc_material(a.cd_material),1,255)) ds_material,
	a.ds_material_direto,
	x.qt_material,
	b.vl_unitario_material,
	b.vl_unitario_liquido,
	(b.vl_unitario_material * x.qt_material) vl_preco_liquido,
	b.vl_frete_rateio,
	(b.vl_unitario_material * x.qt_material) vl_presente,
	b.vl_preco,
	b.qt_prioridade,
	b.pr_desconto,
	a.dt_validade,
	b.vl_unid_fornec,
	(select sum(t.vl_tributo) from cot_compra_forn_item_tr t where a.nr_sequencia = t.nr_seq_cot_item_forn) vl_tributo,
	obter_result_cot_fornec_item(a.nr_sequencia) vl_resultado,	  
	a.vl_desconto,
	a.pr_desconto pr_desconto_forn_item,
	a.qt_conv_unid_fornec,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'DF'),1,80) ds_frete,
	a.ds_marca,
	a.ds_marca_fornec,
	x.cd_estabelecimento cd_estabelecimento,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'CPG'),1,80) cd_condicao_pagamento,
	substr(obter_dados_cot_compra_forn(b.nr_cot_compra, b.nr_seq_cot_forn, 'DCP'),1,80) ds_condicao_pagamento,
	b.ds_mensagem,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'MVA'),1,255) ds_motivo_venc_alt,
	a.nr_contrato,
	a.nr_seq_contrato,
	a.nr_id_integracao,
	c.dt_geracao_ordem_compra,
	a.dt_liberacao,
	a.nm_usuario_lib,
	a.ds_justificativa_lib,
	c.nr_seq_agenda_pac,
	c.ie_finalidade_cotacao,
	c.dt_cot_compra,
	a.vl_unitario_ref_moeda,
	c.nr_seq_motivo_cancel,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'DTR'),1,255) dt_reprovacao,
	substr(obter_dados_cot_compra_item(b.nr_cot_compra, b.nr_item_cot_compra, 'PRE'),1,255) nr_seq_proj_rec,
	(select x.vl_unit_previsto from cot_compra_item x where x.nr_item_cot_compra = b.nr_item_cot_compra and x.nr_cot_compra = c.nr_cot_compra) vl_unit_previsto,
	a.ds_justif_escolha_fornec,
	substr(obter_nome_pf(a.cd_paciente_forn_item),1,255) ds_paciente,
	a.cd_paciente_forn_item
from	cot_compra c,
	cot_compra_resumo b,
	cot_compra_forn_item a,
	cot_compra_solic_agrup x
where	a.nr_sequencia		= b.nr_seq_cot_item_forn
and	a.nr_cot_compra 		= c.nr_cot_compra 
and	a.nr_item_cot_compra	= x.nr_item_cot_compra
and	a.nr_cot_compra		= x.nr_cot_compra
and exists (select 1
		from cot_compra_solic_agrup y
		where a.nr_item_cot_compra	= y.nr_item_cot_compra
		and a.nr_cot_compra	= y.nr_cot_compra
		and c.cd_estabelecimento	<> y.cd_estabelecimento
		and obter_qt_estab_item_agrup(y.nr_cot_compra, y.nr_item_cot_compra) > 1);

