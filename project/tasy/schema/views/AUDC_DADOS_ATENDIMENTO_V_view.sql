-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW audc_dados_atendimento_v (nr_sequencia, nr_seq_guia, cd_guia_operadora, cd_medico_solicitante, dt_inicio_internacao, dt_alta_internacao, nm_medico_solic, qt_dias_internacao, ie_home_care, cd_unidade_internacao, cd_estabelecimento, ie_estagio, nr_seq_segurado, nm_auditor, nr_seq_prestador_exec, nr_seq_prestador_solic, dt_fim_auditoria) AS select  a.nr_sequencia,
        a.nr_seq_guia,
        a.cd_guia_operadora,
        a.cd_medico_solicitante,
        a.dt_inicio_internacao,
        a.dt_alta_internacao,
	obter_nome_pf(a.cd_medico_solicitante) nm_medico_solic,
        (select  trunc(LOCALTIMESTAMP - b.dt_autorizacao) FROM pls_guia_plano b where   b.nr_sequencia = a.nr_seq_guia) qt_dias_internacao,
        CASE WHEN(select count(1) from paciente_home_care b	where   b.dt_final is null and b.cd_pessoa_fisica = c.cd_pessoa_fisica)=1 THEN 'S'  ELSE 'N' END  ie_home_care,
        a.cd_unidade_internacao,
        a.cd_estabelecimento,
        a.ie_estagio,
	a.nr_seq_segurado,
	(select max(b.nm_usuario_exec) from audc_atend_grupo_aud b where b.nr_seq_audc_atend = a.nr_sequencia and b.dt_inicio_analise is not null and b.dt_fim_analise is null) nm_auditor,
	a.nr_seq_prestador_exec,
	a.nr_seq_prestador_solic,
	a.dt_fim_auditoria
from   	audc_atendimento a,
        pls_segurado c
where   a.nr_seq_segurado = c.nr_sequencia
and	a.dt_fim_auditoria is null;

