-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW movimento_estoque_v2 (nr_movimento_estoque, cd_estabelecimento, cd_local_estoque, dt_movimento_estoque, cd_operacao_estoque, cd_acao, cd_material_estoque, dt_mesano_referencia, dt_processo, cd_unidade_medida_estoque, cd_setor_atendimento, ie_origem_documento, nr_documento, nr_sequencia_item_docto, cd_fornecedor, cd_local_estoque_destino, cd_centro_custo, cd_conta_contabil, qt_movimento, cd_unidade_med_mov, nm_usuario, ds_observacao, nr_seq_tab_orig, qt_estoque, vl_estoque, vl_movimento, vl_consumo, qt_consumo) AS select	m.nr_movimento_estoque,
	m.cd_estabelecimento,
	m.cd_local_estoque,
	m.dt_movimento_estoque,
	m.cd_operacao_estoque,
	m.cd_acao,
	m.cd_material_estoque,
	m.dt_mesano_referencia,
	m.dt_processo,
	m.cd_unidade_medida_estoque,
	m.cd_setor_atendimento,
	m.ie_origem_documento,
	m.nr_documento,
	m.nr_sequencia_item_docto,
	m.cd_fornecedor,
	m.cd_local_estoque_destino,
	m.cd_centro_custo,
	m.cd_conta_contabil,
	m.qt_movimento,
	m.cd_unidade_med_mov,
	m.nm_usuario,
	m.ds_observacao,
	m.nr_seq_tab_orig,
	CASE WHEN 	m.cd_acao=2 THEN 	m.qt_estoque * -1  ELSE m.qt_estoque END  qt_estoque,
	CASE WHEN 	m.cd_acao=2 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) WHEN 	m.cd_acao=1 THEN  	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) END  vl_estoque,
	CASE WHEN m.cd_acao=2 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) WHEN m.cd_acao=1 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) END  vl_movimento,
	CASE WHEN o.ie_consumo='A' THEN 	CASE WHEN m.cd_acao=2 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) WHEN m.cd_acao=1 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) END  WHEN o.ie_consumo='D' THEN 	CASE WHEN m.cd_acao=2 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) WHEN m.cd_acao=1 THEN 	sum(CASE WHEN t.ie_aumenta_diminui_valor='A' THEN (v.vl_movimento) WHEN t.ie_aumenta_diminui_valor='D' THEN (v.vl_movimento * -1) WHEN t.ie_aumenta_diminui_valor='N' THEN (0) END ) END  *-1  ELSE 0 END  vl_consumo,
	CASE WHEN o.ie_consumo='A' THEN 	CASE WHEN 	m.cd_acao=1 THEN 	sum(qt_estoque)  ELSE sum(qt_estoque * -1) END  WHEN o.ie_consumo='D' THEN 	CASE WHEN 	m.cd_acao=1 THEN 	sum(qt_estoque * -1)  ELSE sum(qt_estoque) END   ELSE 0 END  qt_consumo
FROM operacao_estoque o, movimento_estoque m
LEFT OUTER JOIN movimento_estoque_valor v ON (m.nr_movimento_estoque = v.nr_movimento_estoque)
LEFT OUTER JOIN tipo_valor t ON (v.cd_tipo_valor = t.cd_tipo_valor)
WHERE m.cd_operacao_estoque	= o.cd_operacao_estoque and m.dt_processo is not null group by
	m.cd_estabelecimento,
	m.dt_mesano_referencia,
	m.dt_processo,
	m.cd_local_estoque,
	m.nr_movimento_estoque,
	m.dt_movimento_estoque,
	m.cd_operacao_estoque,
	m.cd_acao,
	m.cd_material_estoque,
	m.cd_unidade_medida_estoque,
	m.cd_setor_atendimento,
	m.ie_origem_documento,
	m.nr_documento,
	m.nr_sequencia_item_docto,
	m.cd_fornecedor,
	m.cd_local_estoque_destino,
	m.cd_centro_custo,
	m.cd_conta_contabil,
	m.qt_movimento,
	m.cd_unidade_med_mov,
	m.nm_usuario,
	CASE WHEN m.cd_acao=2 THEN  m.qt_estoque * -1  ELSE m.qt_estoque END ,
	m.ds_observacao,
	m.nr_seq_tab_orig,
	o.ie_consumo;

