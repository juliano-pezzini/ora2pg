-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_agenda_v (cd_agenda, ds_agenda, cd_especialidade, ds_especialidade, cd_medico, nm_medico, dt_referencia, nr_seq_turno, nr_seq_turno_esp, nr_seq_sala, cd_setor_sala, ds_setor_sala, ie_motivo_bloqueio, ds_motivo_bloqueio, ds_sala, cd_setor_exclusivo, ds_setor_exclusivo, ie_status_agenda, ds_status_agenda, ie_clinica_agenda, ds_clinica, cd_turno, qt_bloqueados, qt_horarios, qt_utilizado, qt_tot_agendados, qt_tot_executados, qt_tot_utilizado, qt_faltas, qt_canceladas, qt_transferidos, ie_classif_agenda, ds_classif_agenda, cd_tipo_agenda) AS select	e.cd_agenda,
	substr(ageint_obter_desc_agenda(e.cd_agenda),1,255) ds_agenda, 
	e.cd_especialidade, 
	substr(obter_nome_especialidade(e.cd_especialidade),1,255) ds_especialidade, 
	e.cd_medico, 
	substr(obter_nome_pf(e.cd_medico),1,255) nm_medico, 
	e.dt_agenda dt_referencia, 
	e.nr_seq_turno, 
	e.nr_seq_turno_esp, 
	e.nr_seq_sala, 
	(	select	x.cd_setor_atendimento 
		FROM	agenda_sala_consulta x 
		where	x.nr_sequencia = e.nr_seq_sala) cd_setor_sala, 
	substr(obter_nome_setor(	select	x.cd_setor_atendimento 
								from	agenda_sala_consulta x 
								where	x.nr_sequencia = e.nr_seq_sala),1,255) ds_setor_sala, 
	(	select	distinct 
				x.ie_motivo_bloqueio 
		from	agenda_consulta a, 
				agenda b, 
				agenda_bloqueio x 
		where	a.cd_agenda 	= b.cd_agenda 
		and		b.cd_agenda		= x.cd_agenda	 
		and		a.cd_agenda		= e.cd_agenda 
		and		trunc(e.dt_agenda) between x.dt_inicial and x.dt_final) ie_motivo_bloqueio, 
	(	select	distinct 
				obter_valor_dominio(1007, x.ie_motivo_bloqueio) 
		from	agenda_consulta a, 
				agenda b, 
				agenda_bloqueio x 
		where	a.cd_agenda 	= b.cd_agenda 
		and		b.cd_agenda		= x.cd_agenda 
		and		a.cd_agenda		= e.cd_agenda 
		and		trunc(e.dt_agenda) between x.dt_inicial and x.dt_final) ds_motivo_bloqueio, 
	substr(Obter_Desc_Sala_Agecons(e.nr_seq_sala),1,255) ds_sala, 
	e.cd_setor_exclusivo, 
	substr(obter_nome_setor(e.cd_setor_exclusivo),1,255) ds_setor_exclusivo, 
	e.ie_status_agenda, 
	substr(obter_valor_dominio(83,e.ie_status_agenda),1,150) ds_status_agenda, 
	e.ie_clinica_agenda, 
	substr(obter_valor_dominio(17,e.ie_clinica_agenda),1,150) ds_clinica, 
	e.cd_turno, 
	--Qtd. Horários Bloqueados 
	CASE WHEN e.ie_status_agenda='B' THEN  1  ELSE CASE WHEN coalesce(obter_se_bloqueio_manual(e.dt_agenda,e.cd_agenda), 'N')='S' THEN  1 END  END  qt_bloqueados, 
	--Qtd. Horários Instalados/Disponíveis 
	CASE WHEN e.ie_status_agenda='C' THEN 0  ELSE CASE WHEN(case when e.nr_seq_turno_esp = 0 then 'N' else 'S' end)='S' THEN  0  ELSE CASE WHEN coalesce(e.ie_encaixe,'N')='S' THEN 0  ELSE 1 END  END  END  qt_horarios,	 
	--Qtd. Horários Operacionais/Utilizados 
	CASE WHEN e.ie_status_agenda='B' THEN 0 WHEN e.ie_status_agenda='L' THEN 0 WHEN e.ie_status_agenda='R' THEN 0 WHEN e.ie_status_agenda='C' THEN 0 WHEN e.ie_status_agenda='II' THEN 0 WHEN e.ie_status_agenda='LF' THEN 0  ELSE CASE WHEN coalesce(e.ie_encaixe,'N')='S' THEN 0  ELSE 1 END  END  qt_utilizado,	 
	--Qtd. Horários Agendados 
	CASE WHEN e.ie_status_agenda='B' THEN 0 WHEN e.ie_status_agenda='L' THEN 0 WHEN e.ie_status_agenda='R' THEN 0 WHEN e.ie_status_agenda='C' THEN 0 WHEN e.ie_status_agenda='II' THEN 0 WHEN e.ie_status_agenda='LF' THEN 0  ELSE 1 END  qt_tot_agendados,	 
	--Qtd. Horários Executados(Somente Executados) 
	CASE WHEN e.ie_status_agenda='B' THEN 0 WHEN e.ie_status_agenda='L' THEN 0 WHEN e.ie_status_agenda='R' THEN 0 WHEN e.ie_status_agenda='C' THEN 0 WHEN e.ie_status_agenda='II' THEN 0 WHEN e.ie_status_agenda='LF' THEN 0 WHEN e.ie_status_agenda='F' THEN 0 WHEN e.ie_status_agenda='I' THEN 0  ELSE 1 END  qt_tot_executados,	 
	--Qtd. Total de Horários Ocupados 
	CASE WHEN e.ie_status_agenda='B' THEN 0 WHEN e.ie_status_agenda='L' THEN 0 WHEN e.ie_status_agenda='R' THEN 0 WHEN e.ie_status_agenda='C' THEN 0 WHEN e.ie_status_agenda='II' THEN 0 WHEN e.ie_status_agenda='LF' THEN 0  ELSE 1 END  qt_tot_utilizado,	 
	--Qtd. Horários com Falta registrada 
	CASE WHEN e.ie_status_agenda='F' THEN 1 WHEN e.ie_status_agenda='I' THEN 1 END  qt_faltas, 
	--Qtd. Horários Cancelados 
	CASE WHEN e.ie_status_agenda='C' THEN 1  ELSE 0 END  qt_canceladas, 
	--Qtd. Horários transferidos 
	CASE WHEN coalesce(e.ie_transferido,'N')='S' THEN 1 END  qt_transferidos, 
	e.ie_classif_agenda, 
	substr(obter_classif_agenda_turno(e.ie_classif_agenda, null), 1, 200) ds_classif_agenda, 
	e.cd_tipo_agenda 
from	eis_ocupacao_agenda e;

