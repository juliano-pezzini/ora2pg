-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW complemento_pago_v (sequencia, fecha, monto, tipo, forma, moneda, rfc_emisor, nom_banco, cta_ordenante, rfc_beneficiario, cta_beneficiario, monto_cfdi_4) AS select 	b.nr_sequencia sequencia,
	Retorna_data_complemento_pago(b.nr_sequencia, d.nr_titulo, d.nr_sequencia) fecha,
	subst_virgula_ponto_adic_zero(campo_mascara_casas(CASE WHEN elimina_acentuacao(b.ds_observacao)='Cancelacion de pago' THEN  1  ELSE coalesce(d.vl_recebido_estrang, d.vl_recebido) END , 2)) monto,
	CASE WHEN Obter_desc_sigla_moeda(d.cd_moeda)='MXN' THEN  1  ELSE Subst_virgula_ponto_adic_zero( Obter_cotacao_moeda_fin(d.cd_moeda, d.dt_recebimento)) END  tipo,
	lpad(coalesce(cd_integracao_externa, 99),2,'0') forma, 
	coalesce(Obter_desc_sigla_moeda(d.cd_moeda), 'MXN') moneda, 	
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFC')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') END  rfc_emisor,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'B')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') END  nom_banco,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'C')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') END  cta_ordenante,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFCB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') END  rfc_beneficiario,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'CONTAB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') END  cta_beneficiario,
	'0.00' monto_cfdi_4
FROM 	nota_fiscal  a,
	nota_fiscal  b,
	titulo_receber c,
	titulo_receber_liq d,
	tipo_recebimento e
where	a.nr_sequencia = b.nr_sequencia_ref
and	c.nr_seq_nf_saida = a.nr_sequencia
and	c.nr_titulo = d.nr_titulo
and	d.nr_sequencia = b.nr_seq_baixa_tit
and	d.cd_tipo_recebimento = e.cd_tipo_recebimento

union

select 	a.nr_sequencia sequencia,
	to_char(g.dt_recebimento, 'yyyy-mm-dd') || 'T' || to_char(g.dt_recebimento, 'hh24:mi:ss') fecha,
	subst_virgula_ponto_adic_zero(campo_mascara_casas(g.vl_recebimento, 2)) monto,
	CASE WHEN Obter_Desc_sigla_Moeda(d.cd_moeda)='MXN' THEN  1  ELSE subst_virgula_ponto_adic_zero(obter_cotacao_moeda_fin(d.cd_moeda,d.dt_recebimento)) END  tipo,
	lpad(coalesce(cd_integracao_externa, 99),2,'0') forma,
	coalesce(obter_desc_sigla_moeda(d.cd_moeda),'MXN') moneda,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFC')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') END  rfc_emisor,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'B')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') END  nom_banco,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'C')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') END  cta_ordenante,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFCB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') END  rfc_beneficiario,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'CONTAB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') END  cta_beneficiario,
	'0.00' monto_cfdi_4
from 	nota_fiscal a,
	nota_fiscal_item b,
	titulo_receber c,
	titulo_receber_liq d,
	tipo_recebimento e,
	convenio_ret_receb f,
	convenio_receb g    
where 	a.nr_sequencia = b.nr_sequencia
and 	b.nr_titulo is not null 
and 	b.nr_seq_tit_rec is not null 
and 	b.nr_titulo = c.nr_titulo
and 	c.nr_titulo = d.nr_titulo
and 	b.nr_seq_tit_rec = d.nr_sequencia
and 	d.cd_tipo_recebimento = e.cd_tipo_recebimento
and 	d.nr_seq_retorno = f.nr_seq_retorno
and 	g.nr_sequencia = f.nr_seq_receb

union

select 	distinct a.nr_sequencia sequencia,
	to_char(d.dt_recebimento, 'yyyy-mm-dd') || 'T' || to_char(d.dt_recebimento, 'hh24:mi:ss') fecha,
	(	select 	subst_virgula_ponto_adic_zero(campo_mascara_casas(sum(coalesce(trl.vl_recebido_estrang, trl.vl_recebido)), 2))     
		from 	nota_fiscal nf,
			nota_fiscal_item nfi,
			titulo_receber tr,
			titulo_receber_liq trl
		where	 nf.nr_sequencia = a.nr_sequencia
		and 	nf.nr_sequencia = nfi.nr_sequencia
		and 	nfi.nr_titulo = tr.nr_titulo
		and 	tr.nr_titulo = trl.nr_titulo) monto,
	CASE WHEN Obter_Desc_sigla_Moeda(d.cd_moeda)='MXN' THEN  1  ELSE subst_virgula_ponto_adic_zero(obter_cotacao_moeda_fin(d.cd_moeda,d.dt_recebimento)) END  tipo,
	lpad(coalesce(cd_integracao_externa, 99),2,'0') forma,
	coalesce(obter_desc_sigla_moeda(d.cd_moeda),'MXN') moneda,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFC')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFC') END  rfc_emisor,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'B')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'B') END  nom_banco,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'C')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'C') END  cta_ordenante,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'RFCB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'RFCB') END  rfc_beneficiario,
	CASE WHEN obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') IS NULL THEN obter_dados_transf_mx(d.nr_titulo,d.nr_sequencia,'CONTAB')  ELSE obter_dados_control_mx(d.nr_titulo,d.nr_sequencia,'CONTAB') END  cta_beneficiario,
	(	select 	subst_virgula_ponto_adic_zero(campo_mascara_casas(sum(h.vl_recebido),2))	
		from  	nota_fiscal  e,
			nota_fiscal  f,
			nota_fiscal_item i,
			titulo_receber g,
			titulo_receber_liq h
		where 	f.nr_sequencia = b.nr_sequencia
		and     f.nr_sequencia = i.nr_sequencia
		and     e.nr_sequencia = g.nr_seq_nf_saida
		and     i.nr_titulo = g.nr_titulo
		and     g.nr_titulo = h.nr_titulo
		and     h.nr_sequencia = i.nr_seq_tit_rec) monto_cfdi_4
from 	nota_fiscal a,
	nota_fiscal_item b,
	titulo_receber c,
	titulo_receber_liq d,
	tipo_recebimento e
where 	a.nr_sequencia = b.nr_sequencia
and 	b.nr_titulo is not null 
and 	b.nr_seq_tit_rec is not null 
and 	b.nr_titulo = c.nr_titulo
and 	d.nr_seq_retorno is null
and 	c.nr_titulo = d.nr_titulo
and 	b.nr_seq_tit_rec = d.nr_sequencia
and 	d.cd_tipo_recebimento = e.cd_tipo_recebimento;

