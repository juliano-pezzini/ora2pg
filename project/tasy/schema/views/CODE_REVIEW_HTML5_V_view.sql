-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW code_review_html5_v (nr_seq_ordem_serv, ds_gerencia, dt_atividade, ie_area_gerencia, ie_code_review, nr_seq_localizacao) AS SELECT 	a.nr_seq_ordem_serv,
                   	c.ds_gerencia,
	a.dt_atividade,
	c.ie_area_gerencia,
	coalesce((SELECT 'N' IE_CODE_REVIEW FROM man_ordem_servico t WHERE t.nr_sequencia = a.nr_seq_ordem_serv
AND NOT EXISTS (SELECT 1
                        FROM man_ordem_serv_tecnico x
                       WHERE x.nr_seq_ordem_serv = a.nr_seq_ordem_serv
                       --31 teste do analista ou  163 aprovação de code review
                         AND x.nr_seq_tipo         = 163
                     )),'S') ie_code_review,
	o.nr_seq_localizacao
                FROM man_ordem_serv_ativ a
                     ,grupo_desenvolvimento b
                     ,gerencia_wheb c
                     ,man_ordem_servico o
                     ,man_estagio_processo ep
               WHERE a.nr_seq_grupo_des = b.nr_sequencia
                 AND b.nr_seq_gerencia = c.nr_sequencia
                 AND o.nr_sequencia = a.nr_seq_ordem_serv
                 AND o.nr_seq_estagio = ep.nr_sequencia
                 AND o.ie_classificacao IN ('E','S')
				 AND o.ie_plataforma = 'H'
				 AND c.ie_area_gerencia IN ('DES', 'PDES')
				 AND c.ds_gerencia NOT LIKE '%Localização%'
                 AND (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
                 AND a.nr_seq_funcao IN (11,551, 1288)
                 AND ((coalesce(0,0) = 0) OR (b.nr_seq_gerencia = 0))
                 AND EXISTS -- colocadas em cliente teste após atividade de programação
                    (SELECT 1
                       FROM man_estagio_processo c1,
                            man_ordem_serv_estagio d
                      WHERE c1.nr_sequencia = d.nr_seq_estagio
                        AND d.nr_seq_ordem   = a.nr_seq_ordem_serv
                        AND d.nr_seq_estagio  IN (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
                        AND d.dt_atualizacao BETWEEN TRUNC(a.dt_atividade, 'MONTH') AND fim_mes(a.dt_atividade)
                    );

