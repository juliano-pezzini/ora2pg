-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW curva_abc_v (dt_mesano_referencia, cd_estabelecimento, cd_local_estoque, cd_material, ie_consignado, ie_curva_abc, cd_grupo_material, ds_grupo_material, cd_centro_custo, ds_centro_custo, qt_estoque, vl_estoque) AS select	a.dt_mesano_referencia,
	a.cd_estabelecimento,
	a.cd_local_estoque,
	a.cd_material,
	a.ie_consignado,
	m.ie_curva_abc,
	e.cd_grupo_material,
	e.ds_grupo_material,
	a.cd_centro_custo,
	substr(obter_desc_centro_custo(a.cd_centro_custo),1,80) ds_centro_custo,
	sum(CASE WHEN o.ie_consumo='A' THEN 	a.qt_estoque WHEN o.ie_consumo='D' THEN 	a.qt_estoque * -1  ELSE 0 END ) qt_estoque,
	sum(CASE WHEN o.ie_consumo='A' THEN 	a.vl_estoque + a.vl_consignado WHEN o.ie_consumo='D' THEN (a.vl_estoque + a.vl_consignado) * -1  ELSE 0 END ) vl_estoque
FROM	estrutura_material_v e,
	material m,
	resumo_movto_estoque a,
	operacao_estoque o
where	a.cd_operacao_estoque 		= o.cd_operacao_estoque
and	a.cd_material			= m.cd_material
and	m.cd_material			= e.cd_material
and	coalesce(m.ie_curva_abc,'N')		= 'S'
group by	a.dt_mesano_referencia,
	a.cd_estabelecimento,
	a.cd_local_estoque,
	a.cd_material,
	a.ie_consignado,
	m.ie_curva_abc,
	e.cd_grupo_material,
	e.ds_grupo_material,
	a.cd_centro_custo;

