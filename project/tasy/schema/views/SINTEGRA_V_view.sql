-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sintegra_v (tp_registro, cd_cpf_cnpj, ds_razao_social, ds_municipio, sg_estado, nr_fax, ie_versao_arq, cd_ident_natur_operacao, cd_finalidade_arq, ds_endereco, nr_endereco, ds_complemento, ds_bairro, cd_cep, nm_contato, nr_telefone, nr_inscricao_estadual, dt_emissao, cd_modelo_fiscal, cd_serie_nf, nr_nota_fiscal, cd_operacao_nf, ie_emitente_nf, vl_total_nf, vl_base_calculo_icms, vl_icms, vl_isenta, vl_outras, pr_aliquota_icms, ie_situacao, vl_ipi, cd_situacao_tributaria, nr_item_nf, cd_produto_servico, qt_item_nf, vl_total_item_nf, vl_despesa_acessoria, vl_base_calculo_sub_trib, cd_ncm_mercosul, ds_produto_servico, cd_unidade_medida, pr_aliquota_ipi, pr_reducao_calculo_icms, cd_estabelecimento, qt_total_registros_50, qt_total_registros_54, qt_total_registros_75, nr_interno_conta) AS select	10					tp_registro,
	substr(elimina_caracteres_especiais(cd_cgc),1,14) cd_cpf_cnpj,
	ds_razao_social				ds_razao_social,
	substr(obter_dados_pf_pj(null,cd_cgc,'CI'),1,30) 	ds_municipio,
	substr(obter_dados_pf_pj(null,cd_cgc,'UF'),1,2) 	sg_estado,
	somente_numero(substr(obter_dados_pf_pj(null,cd_cgc,'FAX'),1,10)) nr_fax,
	'3'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	substr(elimina_caracteres_especiais(cd_inscricao_estadual),1,14) nr_inscricao_estadual,
	to_date(null)				dt_emissao,
	'01'					cd_modelo_fiscal,
	''					cd_serie_nf,
	''					nr_nota_fiscal,
	0					cd_operacao_nf,
	'P'					ie_emitente_nf,
	0					vl_total_nf,
	0					vl_base_calculo_icms,
	0					vl_icms,
	0					vl_isenta,
	0					vl_outras,
	0					pr_aliquota_icms,
	''					ie_situacao,
	0					vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	0					cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	'0'					nr_interno_conta
FROM	estabelecimento_v
where	1=1

union

select	11					tp_registro,
	substr(elimina_caracteres_especiais(cd_cgc),1,14) cd_cpf_cnpj,
	ds_razao_social				ds_razao_social,
	substr(obter_dados_pf_pj(null,cd_cgc,'CI'),1,30) ds_municipio,
	substr(obter_dados_pf_pj(null,cd_cgc,'UF'),1,2) sg_estado,
	somente_numero(substr(obter_dados_pf_pj(null,cd_cgc,'FAX'),1,10)) nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	substr(obter_dados_pf_pj(null,cd_cgc,'EN'),1,34) ds_endereco,
	somente_numero(substr(obter_dados_pf_pj(null,cd_cgc,'NR'),1,5)) nr_endereco,
	substr(obter_dados_pf_pj(null,cd_cgc,'CO'),1,22) ds_complemento,
	substr(obter_dados_pf_pj(null,cd_cgc,'B'),1,15) ds_bairro,
	somente_numero(substr(obter_dados_pf_pj(null,cd_cgc,'CEP'),1,8)) cd_cep,
	substr(obter_dados_pf_pj_estab(cd_estabelecimento,null,cd_cgc,'ENC'),1,28) nm_contato,
	somente_numero(substr(obter_dados_pf_pj(null,cd_cgc,'T'),1,12)) nr_telefone,
	'0'			 		nr_inscricao_estadual,
	to_date(null)				dt_emissao,
	'01'					cd_modelo_fiscal,
	''					cd_serie_nf,
	''					nr_nota_fiscal,
	0					cd_operacao_nf,
	'P'					ie_emitente_nf,
	0					vl_total_nf,
	0					vl_base_calculo_icms,
	0					vl_icms,
	0					vl_isenta,
	0					vl_outras,
	0					pr_aliquota_icms,
	''					ie_situacao,
	0					vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	0					cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	'0'					nr_interno_conta
from	estabelecimento_v
where	1=1

union

select	50					tp_registro,
	substr(elimina_caracteres_especiais(CASE WHEN n.cd_cgc IS NULL THEN 					substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)  ELSE n.cd_cgc END ),1,14) cd_cpf_cnpj,
	''					ds_razao_social,
	''					ds_municipio,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2) sg_estado,
	0					nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	substr(elimina_caracteres_especiais(substr(obter_dados_pf_pj(null,coalesce(n.cd_cgc,n.cd_cgc_emitente),'IE'),1,14)),1,14) nr_inscricao_estadual,
	n.dt_emissao				dt_emissao,
	'01'					cd_modelo_fiscal,
	n.cd_serie_nf				cd_serie_nf,
	substr(n.nr_nota_fiscal,1,6)			nr_nota_fiscal,
	n.cd_natureza_operacao			cd_operacao_nf,
	CASE WHEN substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1)='E' THEN 'T'  ELSE 'P' END  ie_emitente_nf,
	n.vl_total_nota				vl_total_nf,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'B','ICMS') vl_base_calculo_icms,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','ICMS') vl_icms,
	0					vl_isenta,
	0					vl_outras,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'X','ICMS') pr_aliquota_icms,
	CASE WHEN n.ie_situacao='3' THEN 'S' WHEN n.ie_situacao='9' THEN 'S'  ELSE 'N' END  ie_situacao,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','IPI') vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	0					cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	n.cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	n.nr_nota_fiscal				nr_interno_conta
from	nota_fiscal n
where	1=1
and	n.ie_situacao = '1'
and	n.cd_natureza_operacao <> 111
and	n.cd_operacao_nf in (1,4,5,21,22,26,28,29,30,31,32,33,34,36,37,38,40,41)
and	n.dt_atualizacao_estoque is not null

union

select	51					tp_registro,
	substr(elimina_caracteres_especiais(CASE WHEN n.cd_cgc IS NULL THEN 					substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)  ELSE n.cd_cgc END ),1,14) cd_cpf_cnpj,
	''					ds_razao_social,
	''					ds_municipio,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2) sg_estado,
	0					nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	substr(elimina_caracteres_especiais(substr(obter_dados_pf_pj(null,coalesce(n.cd_cgc,n.cd_cgc_emitente),'IE'),1,14)),1,14) nr_inscricao_estadual,
	n.dt_emissao				dt_emissao,
	'01'					cd_modelo_fiscal,
	n.cd_serie_nf				cd_serie_nf,
	substr(n.nr_nota_fiscal,1,6)			nr_nota_fiscal,
	n.cd_natureza_operacao			cd_operacao_nf,
	CASE WHEN substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1)='E' THEN 'T'  ELSE 'P' END  ie_emitente_nf,
	n.vl_total_nota				vl_total_nf,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'B','ICMS') vl_base_calculo_icms,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','ICMS') vl_icms,
	0					vl_isenta,
	0					vl_outras,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'X','ICMS') pr_aliquota_icms,
	CASE WHEN n.ie_situacao='3' THEN 'S' WHEN n.ie_situacao='9' THEN 'S'  ELSE 'N' END  ie_situacao,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','IPI') vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	0					cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	n.cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	n.nr_nota_fiscal				nr_interno_conta
from	nota_fiscal n
where	1=1
and	n.ie_situacao = '1'
and	n.cd_natureza_operacao <> 111
and	n.cd_operacao_nf in (1,4,5,21,22,26,28,29,30,31,32,33,34,36,37,38,40,41)
and	n.dt_atualizacao_estoque is not null

union

select	54					tp_registro,
	substr(elimina_caracteres_especiais(CASE WHEN n.cd_cgc IS NULL THEN 					substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)  ELSE n.cd_cgc END ),1,14) cd_cpf_cnpj,
	''					ds_razao_social,
	''					ds_municipio,
	''					sg_estado,
	0					nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	'0'			 		nr_inscricao_estadual,
	n.dt_emissao				dt_emissao,
	'01'					cd_modelo_fiscal,
	n.cd_serie_nf				cd_serie_nf,
	substr(n.nr_nota_fiscal,1,6)			nr_nota_fiscal,
	n.cd_natureza_operacao			cd_operacao_nf,
	CASE WHEN substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1)='E' THEN 'T'  ELSE 'P' END  ie_emitente_nf,
	n.vl_total_nota				vl_total_nf,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'B','ICMS') vl_base_calculo_icms,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','ICMS') vl_icms,
	0					vl_isenta,
	0					vl_outras,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'X','ICMS') pr_aliquota_icms,
	CASE WHEN n.ie_situacao='3' THEN 'S' WHEN n.ie_situacao='9' THEN 'S'  ELSE 'N' END  ie_situacao,
	obter_valor_tipo_tributo_nota(n.nr_sequencia,'V','IPI') vl_ipi,
	0					cd_situacao_tributaria,
	i.nr_item_nf				nr_item_nf,
	coalesce(i.cd_material, i.cd_procedimento)		cd_produto_servico,
	i.qt_item_nf				qt_item_nf,
	i.vl_total_item_nf				vl_total_item_nf,
	n.vl_despesa_acessoria			vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	n.cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	n.nr_nota_fiscal				nr_interno_conta
from	nota_fiscal_item i,
	nota_fiscal n
where	1=1
and	n.nr_sequencia = i.nr_sequencia
and	n.ie_situacao = '1'
and	n.cd_natureza_operacao <> 111
and	n.cd_operacao_nf in (1,4,5,21,22,26,28,29,30,31,32,33,34,36,37,38,40,41)
and	n.dt_atualizacao_estoque is not null

union all

select	distinct
	75					tp_registro,
	'0',
	''					ds_razao_social,
	''					ds_municipio,
	''					sg_estado,
	0					nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	'0'			 		nr_inscricao_estadual,
	trunc(n.dt_emissao,'mm')			dt_emissao,
	'01'					cd_modelo_fiscal,
	'0'					cd_serie_nf,
	'0'					nr_nota_fiscal,
	0					cd_operacao_nf,
	''					ie_emitente_nf,
	0					vl_total_nf,
	0					vl_base_calculo_icms,
	0					vl_icms,
	0					vl_isenta,
	0					vl_outras,
	0					pr_aliquota_icms,
	'0'					ie_situacao,
	0					vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	i.cd_material				cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	substr(obter_desc_material(i.cd_material),1,255) ds_produto_servico,
	substr(obter_dados_material(i.cd_material,'UME'),1,255) cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	n.cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	'0'					nr_interno_conta
from	nota_fiscal_item i,
	nota_fiscal n
where	1=1
and	n.nr_sequencia = i.nr_sequencia
and	n.ie_situacao = '1'
and	i.cd_material is not null
and	n.cd_natureza_operacao <> 111
and	n.cd_operacao_nf in (1,4,5,21,22,26,28,29,30,31,32,33,34,36,37,38,40,41)
and	n.dt_atualizacao_estoque is not null

union

select	90					tp_registro,
	substr(elimina_caracteres_especiais(cd_cgc),1,14) cd_cpf_cnpj,
	ds_razao_social				ds_razao_social,
	''					ds_municipio,
	''					sg_estado,
	0					nr_fax,
	'2'					ie_versao_arq,
	'3'					cd_ident_natur_operacao,
	'1'					cd_finalidade_arq,
	''					ds_endereco,
	0					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	0					cd_cep,
	''					nm_contato,
	0					nr_telefone,
	substr(elimina_caracteres_especiais(cd_inscricao_estadual),1,14) nr_inscricao_estadual,
	to_date(null)				dt_emissao,
	'01'					cd_modelo_fiscal,
	''					cd_serie_nf,
	''					nr_nota_fiscal,
	0					cd_operacao_nf,
	'P'					ie_emitente_nf,
	0					vl_total_nf,
	0					vl_base_calculo_icms,
	0					vl_icms,
	0					vl_isenta,
	0					vl_outras,
	0					pr_aliquota_icms,
	''					ie_situacao,
	0					vl_ipi,
	0					cd_situacao_tributaria,
	0					nr_item_nf,
	0					cd_produto_servico,
	0					qt_item_nf,
	0					vl_total_item_nf,
	0					vl_despesa_acessoria,
	0					vl_base_calculo_sub_trib,
	'0'					cd_ncm_mercosul,
	''					ds_produto_servico,
	''					cd_unidade_medida,
	0					pr_aliquota_ipi,
	0					pr_reducao_calculo_icms,
	cd_estabelecimento,
	0					qt_total_registros_50,
	0					qt_total_registros_54,
	0					qt_total_registros_75,
	'0'					nr_interno_conta
from	estabelecimento_v
where	1=1;

