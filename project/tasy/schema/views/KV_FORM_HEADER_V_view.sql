-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW kv_form_header_v (nr_atendimento, ds_convenio, ds_sobrenome, ds_nome, ds_endereco, ds_cidade, dt_nascimento, cd_cnes, cd_usuario_conv, cd_estab, ds_status, nr_crm, dt_referencia) AS select  b.nr_atendimento,
        substr(Obter_Nome_Convenio(g.cd_convenio),1,255) ds_convenio,
        e.ds_family_name ds_sobrenome,
        e.ds_given_name ds_nome,
        (f.ds_endereco || ' ' || f.ds_compl_end) ds_endereco,
        (f.cd_cep || ' ' || f.ds_municipio) ds_cidade,
        to_char(c.dt_nascimento,'dd.MM.yyyy') dt_nascimento,
        obter_dados_pf_pj('',n.cd_cgc,'CNES') cd_cnes,
        substr(g.cd_usuario_convenio,1,255) cd_usuario_conv,
        '260500005' cd_estab,
        --DECODE(g.ie_tipo_conveniado,'1','1000000','2','3000000','5','5000000') ds_status,
        4 ds_status,
        d.nr_crm,
        to_char(LOCALTIMESTAMP, 'dd.MM.yyyy') dt_referencia
FROM convenio n, estabelecimento h, atend_categoria_convenio g, person_name e, medico d, atendimento_paciente b, pessoa_fisica c
LEFT OUTER JOIN compl_pessoa_fisica f ON (c.cd_pessoa_fisica = f.cd_pessoa_fisica)
WHERE b.cd_pessoa_fisica = c.cd_pessoa_fisica and b.cd_medico_resp = d.cd_pessoa_fisica and c.nr_seq_person_name = e.nr_sequencia  and coalesce(f.ie_tipo_complemento, 1) = 1 and g.nr_atendimento = b.nr_atendimento and g.nr_seq_interno = (select min(t.nr_seq_interno) from atend_categoria_convenio t where t.nr_atendimento = b.nr_atendimento) and b.cd_estabelecimento = h.cd_estabelecimento and n.cd_convenio = g.cd_convenio;

