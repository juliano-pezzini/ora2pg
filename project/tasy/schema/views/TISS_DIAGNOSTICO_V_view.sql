-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_diagnostico_v (ds_versao, ie_origem, ds_tipo_doenca, ds_tipo_tabela, ds_cid, cd_doenca_cid, ds_indicador_acidente, nr_seq_cliente, nr_atendimento, dt_diagnostico, nr_sequencia_autor, ie_classificacao_doenca, nr_interno_conta, nr_seq_protocolo, cd_motivo_saida_int, ds_diagnostico, ie_tipo_doenca, ie_unidade_tempo, qt_tempo, ie_tipo_atendimento, cd_estabelecimento) AS SELECT	'2.01.01' ds_versao,
	'AC' ie_origem,
	coalesce(a.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	SUBSTR(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	a.cd_doenca cd_doenca_cid,
	'0' ds_indicador_acidente,
	0 nr_seq_cliente,
	a.nr_atendimento,
	a.dt_diagnostico,
	b.nr_sequencia nr_sequencia_autor,
	a.ie_classificacao_doenca,
	0 nr_interno_conta,
	0 nr_seq_protocolo,
	'' CD_MOTIVO_SAIDA_INT,
	a.ds_diagnostico,
	a.ie_tipo_doenca,
	a.ie_unidade_tempo,
	a.qt_tempo,
	e.ie_tipo_atendimento,
	e.cd_estabelecimento
FROM 	atendimento_paciente e,
	diagnostico_doenca a,
	diagnostico_medico c,
	autorizacao_convenio b
WHERE	b.nr_atendimento		= c.nr_atendimento
AND	c.nr_atendimento		= a.nr_atendimento
AND	c.dt_diagnostico		= a.dt_diagnostico
AND	b.nr_atendimento		= e.nr_atendimento
AND	a.ie_classificacao_doenca	= 'P'
AND	c.dt_diagnostico		=
		(SELECT		MAX(x.dt_diagnostico)
		FROM		diagnostico_doenca y,
				diagnostico_medico x
		WHERE		x.nr_atendimento	= b.nr_atendimento
		AND		x.nr_atendimento	= y.nr_atendimento
		AND		x.dt_diagnostico	= y.dt_diagnostico
		AND		y.ie_classificacao_doenca	= 'P')

UNION

SELECT	'2.01.01' ds_versao,
	'AC' ie_origem,
	coalesce(a.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	SUBSTR(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	a.cd_doenca cd_doenca_cid,
	'0' ds_indicador_acidente,
	0 nr_seq_cliente,
	(null)::numeric  nr_atendimento,
	c.dt_diagnostico,
	b.nr_sequencia nr_sequencia_autor,
	a.ie_classificacao_doenca,
	0 nr_interno_conta,
	0 nr_seq_protocolo,
	'' CD_MOTIVO_SAIDA_INT,
	a.ds_diagnostico,
	a.ie_tipo_doenca,
	a.ie_unidade_tempo,
	a.qt_tempo,
	null ie_tipo_atendimento,
	e.cd_estabelecimento
FROM 	autorizacao_convenio_tiss e,
	autor_diag_doenca a,
	autor_diag_medico c,
	autorizacao_convenio b
WHERE	b.nr_sequencia		= c.nr_sequencia_autor
AND	c.nr_sequencia		= a.nr_seq_autor_diag
AND	b.nr_sequencia		= e.nr_sequencia_autor
AND	a.ie_classificacao_doenca	= 'P'
and	b.nr_atendimento		is null
and	b.nr_seq_agenda		is null
and	b.nr_seq_agenda_consulta	is null
and	b.nr_seq_gestao		is null
and	b.cd_pessoa_fisica 		is not null

UNION

SELECT	'2.01.01' ds_versao,
	'ACD' ie_origem,
	coalesce(a.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	SUBSTR(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	a.cd_doenca cd_doenca_cid,
	'0' ds_indicador_acidente,
	0 nr_seq_cliente,
	e.nr_atendimento,
	c.dt_diagnostico,
	b.nr_sequencia nr_sequencia_autor,
	a.ie_classificacao_doenca,
	0 nr_interno_conta,
	0 nr_seq_protocolo,
	'' CD_MOTIVO_SAIDA_INT,
	a.ds_diagnostico,
	a.ie_tipo_doenca,
	a.ie_unidade_tempo,
	a.qt_tempo,
	e.ie_tipo_atendimento,
	e.cd_estabelecimento
FROM autor_diag_medico c, autor_diag_doenca a, autorizacao_convenio b
LEFT OUTER JOIN atendimento_paciente e ON (b.nr_atendimento = e.nr_atendimento)
WHERE b.nr_sequencia		= c.nr_sequencia_autor AND c.nr_sequencia		= a.nr_seq_autor_diag  AND a.ie_classificacao_doenca	= 'P'

UNION

SELECT	'2.01.01' ds_versao,
	'PC' ie_origem,
	coalesce(d.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	SUBSTR(OBTER_DESC_CID_DOENCA(d.CD_DOENCA),1,70) ds_cid,
	d.cd_doenca cd_doenca_cid,
	'0' ds_indicador_acidente,
	0 nr_seq_cliente,
	b.nr_atendimento,
	c.dt_diagnostico,
	0 nr_sequencia_autor,
	d.ie_classificacao_doenca,
	b.nr_interno_conta,
	a.nr_seq_protocolo,
	f.CD_MOTIVO CD_MOTIVO_SAIDA_INT,
	d.ds_diagnostico,
	d.ie_tipo_doenca,
	d.ie_unidade_tempo,
	d.qt_tempo,
	e.ie_tipo_atendimento,
	a.cd_estabelecimento
FROM atendimento_paciente e, diagnostico_doenca d, diagnostico_medico c, conta_paciente b
LEFT OUTER JOIN protocolo_convenio a ON (b.nr_seq_protocolo = a.nr_seq_protocolo)
LEFT OUTER JOIN tiss_motivo_saida_int f ON (b.nr_seq_saida_int = f.nr_sequencia)
WHERE b.nr_atendimento		= c.nr_atendimento AND c.dt_diagnostico		= d.dt_diagnostico AND c.nr_atendimento		= d.nr_atendimento AND b.nr_atendimento		= e.nr_atendimento  AND d.ie_classificacao_doenca	= 'P' AND c.dt_diagnostico		=
		(SELECT		MAX(x.dt_diagnostico)
		FROM		diagnostico_doenca y,
				diagnostico_medico x
		WHERE		x.nr_atendimento	= b.nr_atendimento
		AND		x.nr_atendimento	= y.nr_atendimento
		AND		x.dt_diagnostico	= y.dt_diagnostico
		AND		y.ie_classificacao_doenca	= 'P');

