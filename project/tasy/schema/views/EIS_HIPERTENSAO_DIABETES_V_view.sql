-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_hipertensao_diabetes_v (nr_atendimento, cd_pessoa_fisica, dt_referencia, nr_seq_area, ds_area, qt_atend_diabete, qt_atend_hipertensao, qt_pf_maior_15, qt_pf) AS select	a.nr_atendimento,
			a.cd_pessoa_fisica,
			a.dt_entrada dt_referencia,
			obter_area_pf(a.cd_pessoa_fisica) nr_seq_area,
			substr(obter_desc_area_domicilio(obter_area_pf(a.cd_pessoa_fisica)),1,255) ds_area,
			(select 	count(*)
				FROM	atendimento_paciente z,
						LISTA_PROBLEMA_PAC x
				where 	z.nr_atendimento = x.nr_atendimento
				and		z.ie_nivel_atencao = 'P'
				and		x.ie_tipo_diagnostico = 2
				and		x.dt_liberacao is not null
				and		x.dt_inativacao is null
				and		obter_area_pf(z.cd_pessoa_fisica) = obter_area_pf(a.cd_pessoa_fisica)
				and 	obter_categoria_cid(x.cd_doenca) in ('E10', 'E11', 'E12', 'E13', 'E14', 'E15')) qt_atend_diabete,
			(select 	count(*)
				from	atendimento_paciente z,
						LISTA_PROBLEMA_PAC x
				where 	z.nr_atendimento = x.nr_atendimento
				and		z.ie_nivel_atencao = 'P'
				and		x.ie_tipo_diagnostico = 2
				and		x.dt_liberacao is not null
				and		x.dt_inativacao is null
				and		obter_area_pf(z.cd_pessoa_fisica) = obter_area_pf(a.cd_pessoa_fisica)
				and 	obter_categoria_cid(x.cd_doenca) in ('I10', 'I11', 'I12', 'I13', 'I15')) qt_atend_hipertensao,
			(select 	count(distinct x.cd_pessoa_fisica)
				from 	atendimento_paciente x
				where 	x.ie_nivel_atencao = 'P'
				and		obter_idade_pf(x.cd_pessoa_fisica, LOCALTIMESTAMP, 'A') >= 15
				and		obter_area_pf(x.cd_pessoa_fisica) = obter_area_pf(a.cd_pessoa_fisica)) qt_pf_maior_15,
			(select 	count(distinct x.cd_pessoa_fisica)
				from 	atendimento_paciente x
				where 	x.ie_nivel_atencao = 'P'
				and		obter_area_pf(x.cd_pessoa_fisica) = obter_area_pf(a.cd_pessoa_fisica)) qt_pf
	from	atendimento_paciente a,
			LISTA_PROBLEMA_PAC b
	where	a.nr_atendimento = b.nr_atendimento
	and		a.ie_nivel_atencao = 'P'
	and		b.ie_tipo_diagnostico = 2
	and		b.dt_liberacao is not null
	and		b.dt_inativacao is null
	and		obter_categoria_cid(b.cd_doenca) in ('E10', 'E11', 'E12', 'E13', 'E14', 'E15', 'I10', 'I11', 'I12', 'I13', 'I15');

