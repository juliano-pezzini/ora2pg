-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_resumo_v2 (ie_proc_mat, ds_tipo_matproc, ds_proc_mat, cd_convenio, ds_convenio, dt_mesano_referencia, ie_status_protocolo, nr_seq_protocolo, nr_atendimento, ie_tipo_atendimento, ie_tipo_convenio, cd_setor_receita, cd_setor_atendimento, cd_conta_contabil, cd_especialidade, nr_seq_grupo_rec, cd_estrutura_conta, ds_setor_receita, qt_paciente, qt_exame, nr_diarias, vl_medico, vl_medico_fora_conta, vl_material, vl_diaria, vl_sadt_fora_conta, vl_custo, vl_proced, vl_item, vl_total_receita, vl_imposto, qt_item, vl_original) AS select	'P' ie_proc_mat,
	'Procedimento' ds_tipo_matproc, 
	p.ds_procedimento ds_proc_mat, 
	c.cd_convenio, 
	d.ds_convenio, 
   	c.dt_mesano_referencia, 
	c.ie_status_protocolo, 
	c.nr_seq_protocolo, 
	a.nr_atendimento, 
	g.ie_tipo_atendimento, 
	d.ie_tipo_convenio, 
	b.cd_setor_receita, 
	b.cd_setor_atendimento, 
   	b.cd_conta_contabil, 
   	b.cd_especialidade, 
	b.nr_seq_grupo_rec, 
	b.cd_estrutura_conta, 
	f.ds_setor_atendimento ds_setor_receita, 
	count(distinct b.cd_setor_receita||b.nr_interno_conta) qt_paciente, 
	sum(CASE WHEN f.cd_classif_setor=5 THEN b.qt_resumo  ELSE 0 END ) qt_exame, 
	sum(CASE WHEN b.ie_diaria='S' THEN b.qt_resumo  ELSE 0 END ) nr_diarias, 
	sum(b.vl_medico + b.vl_anestesista + b.vl_auxiliares) vl_medico, 
	sum(b.vl_medico_fora_conta) vl_medico_fora_conta, 
	sum(b.vl_material) vl_material, 
	sum(CASE WHEN b.ie_diaria='S' THEN b.vl_procedimento  ELSE 0 END ) vl_diaria, 
	sum(b.vl_sadt_fora_conta) vl_sadt_fora_conta, 
	sum(vl_custo) vl_custo, 
	sum(CASE WHEN b.ie_diaria='S' THEN 0  ELSE (b.vl_materiais + b.vl_custo_operacional) END ) vl_proced, 
	sum(b.vl_materiais + b.vl_custo_operacional + b.vl_material) vl_item, 
	sum(b.vl_procedimento + b.vl_material) vl_total_receita, 
	sum(b.vl_imposto) vl_imposto, 
	sum(b.qt_resumo) qt_item, 
	sum(b.vl_original) vl_original 
FROM	procedimento p, 
	setor_atendimento f, 
	convenio d, 
	atendimento_paciente g, 
	conta_paciente a, 
	conta_paciente_resumo b, 
	protocolo_convenio c 
where	c.nr_seq_protocolo 	= a.nr_seq_protocolo 
and 	a.nr_interno_conta 	= b.nr_interno_conta 
and 	c.cd_convenio 		= d.cd_convenio 
and 	b.cd_setor_atendimento 	= f.cd_setor_atendimento 
and 	a.nr_atendimento 	= g.nr_atendimento 
and	b.cd_procedimento	= p.cd_procedimento 
and	b.ie_origem_proced	= p.ie_origem_proced 
group by p.ds_procedimento, 
	c.cd_convenio, 
	d.ds_convenio, 
	b.ie_origem_proced, 
	c.dt_mesano_referencia, 
	c.ie_status_protocolo, 
	c.nr_seq_protocolo, 
	a.nr_atendimento, 
	g.ie_tipo_atendimento, 
	d.ie_tipo_convenio, 
	b.cd_setor_receita, 
	b.cd_setor_atendimento, 
   	b.cd_conta_contabil, 
   	b.cd_especialidade, 
	b.nr_seq_grupo_rec, 
	b.cd_estrutura_conta, 
	f.ds_setor_atendimento 

union
 
select	'M' ie_proc_mat, 
	'Material' ds_tipo_matproc, 
	p.ds_material ds_proc_mat, 
	c.cd_convenio, 
	d.ds_convenio, 
   	c.dt_mesano_referencia, 
	c.ie_status_protocolo, 
	c.nr_seq_protocolo, 
	a.nr_atendimento, 
	g.ie_tipo_atendimento, 
	d.ie_tipo_convenio, 
	b.cd_setor_receita, 
	b.cd_setor_atendimento, 
   	b.cd_conta_contabil, 
   	b.cd_especialidade, 
	b.nr_seq_grupo_rec, 
	b.cd_estrutura_conta, 
	f.ds_setor_atendimento ds_setor_receita, 
	count(distinct b.cd_setor_receita||b.nr_interno_conta) qt_paciente, 
	sum(CASE WHEN f.cd_classif_setor=5 THEN b.qt_resumo  ELSE 0 END ) qt_exame, 
	sum(CASE WHEN b.ie_diaria='S' THEN b.qt_resumo  ELSE 0 END ) nr_diarias, 
	sum(b.vl_medico + b.vl_anestesista + b.vl_auxiliares) vl_medico, 
	sum(b.vl_medico_fora_conta) vl_medico_fora_conta, 
	sum(b.vl_material) vl_material, 
	sum(CASE WHEN b.ie_diaria='S' THEN b.vl_procedimento  ELSE 0 END ) vl_diaria, 
	sum(b.vl_sadt_fora_conta) vl_sadt_fora_conta, 
	sum(vl_custo) vl_custo, 
	sum(CASE WHEN b.ie_diaria='S' THEN 0  ELSE (b.vl_materiais + b.vl_custo_operacional) END ) vl_proced, 
	sum(b.vl_materiais + b.vl_custo_operacional + b.vl_material) vl_item, 
	sum(b.vl_procedimento + b.vl_material) vl_total_receita, 
	sum(b.vl_imposto) vl_imposto, 
	sum(b.qt_resumo) qt_item, 
	sum(b.vl_original) vl_original 
from	material p, 
	setor_atendimento f, 
	convenio d, 
	atendimento_paciente g, 
	conta_paciente a, 
	conta_paciente_resumo b, 
	protocolo_convenio c 
where	c.nr_seq_protocolo 	= a.nr_seq_protocolo 
and 	a.nr_interno_conta 	= b.nr_interno_conta 
and 	c.cd_convenio 		= d.cd_convenio 
and 	b.cd_setor_atendimento 	= f.cd_setor_atendimento 
and 	a.nr_atendimento 	= g.nr_atendimento 
and	b.cd_material		= p.cd_material 
group by p.ds_material, 
	c.cd_convenio, 
	d.ds_convenio, 
	b.ie_origem_proced, 
	c.dt_mesano_referencia, 
	c.ie_status_protocolo, 
	c.nr_seq_protocolo, 
	a.nr_atendimento, 
	g.ie_tipo_atendimento, 
	d.ie_tipo_convenio, 
	b.cd_setor_receita, 
	b.cd_setor_atendimento, 
   	b.cd_conta_contabil, 
   	b.cd_especialidade, 
	b.nr_seq_grupo_rec, 
	b.cd_estrutura_conta, 
	f.ds_setor_atendimento;

