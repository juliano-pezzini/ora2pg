-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_hipotese_diagnostica_v (ds_versao, ie_origem, ds_tipo_doenca, ds_tipo_tabela, ds_cid, cd_doenca_cid, ds_indicador_acidente, nr_seq_cliente, nr_atendimento, dt_diagnostico, nr_sequencia_autor, ie_classificacao_doenca, ie_unidade_tempo) AS select	'2.01.01' ds_versao,
	'AC' ie_origem,
	coalesce(a.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	substr(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	a.cd_doenca cd_doenca_cid,
	coalesce(b.IE_TISS_TIPO_ACIDENTE,to_char(coalesce(obter_acidente_tiss_atend(b.nr_atendimento),'2'))) ds_indicador_acidente,
	0 nr_seq_cliente,
	a.nr_atendimento,
	a.dt_diagnostico,
	b.nr_sequencia nr_sequencia_autor,
	a.ie_classificacao_doenca,
	a.ie_unidade_tempo
FROM diagnostico_doenca a
LEFT OUTER JOIN autorizacao_convenio b ON (a.nr_atendimento = b.nr_atendimento)
union

SELECT	'2.01.01' ds_versao,
	'ACD' ie_origem,
	coalesce(a.ie_tipo_doenca, 'A') ds_tipo_doenca,
	'CID-10' ds_tipo_tabela,
	SUBSTR(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	a.cd_doenca cd_doenca_cid,
	coalesce(b.IE_TISS_TIPO_ACIDENTE,to_char(coalesce(obter_acidente_tiss_atend(b.nr_atendimento),'2'))) ds_indicador_acidente,
	0 nr_seq_cliente,
	null,
	c.dt_diagnostico,
	b.nr_sequencia nr_sequencia_autor,
	a.ie_classificacao_doenca,
	a.ie_unidade_tempo
FROM 	autor_diag_doenca a,
	autor_diag_medico c,
	autorizacao_convenio b
WHERE	b.nr_sequencia		= c.nr_sequencia_autor
and (b.nr_atendimento 	is null or 
	not exists (	select 	1 
			from 	diagnostico_doenca x 
			where 	x.nr_atendimento = b.nr_atendimento))
and (b.nr_seq_agenda 	is not null or 
	not exists (	select 	1 
			from 	diagnostico_doenca x 
			where 	x.nr_atendimento = b.nr_atendimento))
AND	c.nr_sequencia		= a.nr_seq_autor_diag
AND	a.ie_classificacao_doenca	= 'P';

