-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW dmed_rppss_v (nr_cpf, nm_pessoa_fisica, dt_emissao, vl_total_titulo, cd_pessoa_fisica, cd_estabelecimento) AS select  f.nr_cpf nr_cpf,
	f.nm_pessoa_fisica nm_pessoa_fisica,
	r.dt_emissao dt_emissao,
	sum(CASE WHEN a.cd_pessoa_fisica=p.cd_pessoa_fisica THEN coalesce(l.vl_recebido,0)  ELSE 0 END ) vl_total_titulo,
	f.cd_pessoa_fisica,
	r.cd_estabelecimento cd_estabelecimento
FROM atendimento_pagador p, atendimento_paciente a, pessoa_fisica f
LEFT OUTER JOIN nacionalidade n ON (f.cd_nacionalidade = n.cd_nacionalidade)
, titulo_receber r
LEFT OUTER JOIN titulo_receber_liq l ON (r.nr_titulo = l.nr_titulo)
WHERE a.nr_atendimento = r.nr_atendimento  and a.nr_atendimento = p.nr_atendimento and f.cd_pessoa_fisica = p.cd_pessoa_fisica  and r.ie_situacao <> 5 and r.ie_situacao <> 3 and r.vl_saldo_titulo = 0 and r.ie_origem_titulo in (2,1) and to_char(coalesce(l.dt_recebimento,r.dt_emissao),'yyyy') = '2010' and l.cd_tipo_recebimento in (select ie_tipo_receber
				  from	 dmed_regra_tipo_tit) and coalesce(n.ie_brasileiro,'S') = 'S' group by f.nr_cpf, f.nm_pessoa_fisica,r.dt_emissao,f.cd_pessoa_fisica, r.cd_estabelecimento
having sum(coalesce(l.vl_recebido,0)) > 0

union all

select  f.nr_cpf nr_cpf,
	f.nm_pessoa_fisica nm_pessoa_fisica,
	r.dt_emissao dt_emissao,
	sum(r.vl_titulo) vl_total_titulo,
	f.cd_pessoa_fisica,
	r.cd_estabelecimento cd_estabelecimento
FROM atendimento_paciente a, pessoa_fisica f
LEFT OUTER JOIN nacionalidade n ON (f.cd_nacionalidade = n.cd_nacionalidade)
, titulo_receber r
LEFT OUTER JOIN titulo_receber_liq l ON (r.nr_titulo = l.nr_titulo)
WHERE a.cd_pessoa_fisica = f.cd_pessoa_fisica and a.nr_atendimento = r.nr_atendimento   and r.ie_situacao <> 5 and r.ie_situacao <> 3 and r.vl_saldo_titulo = 0 and r.ie_origem_titulo in (2,1) and to_char(coalesce(l.dt_recebimento,r.dt_emissao),'yyyy') = '2010' and l.cd_tipo_recebimento in (select ie_tipo_receber
				  from	 dmed_regra_tipo_tit) and coalesce(n.ie_brasileiro,'S') = 'S' and to_char(r.dt_emissao,'yyyy') = '2010' and not exists (select 1 from atendimento_pagador p where p.nr_atendimento = a.nr_atendimento) group by f.nr_cpf, f.nm_pessoa_fisica,r.dt_emissao,f.cd_pessoa_fisica, r.cd_estabelecimento
having sum(coalesce(l.vl_recebido,0)) > 0
order by nr_cpf,nm_pessoa_fisica;

