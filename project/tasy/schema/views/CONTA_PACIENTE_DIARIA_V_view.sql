-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_diaria_v (nr_sequencia, cd_convenio, ie_emite_conta, nr_interno_conta, cd_procedimento, cd_setor_atendimento, ds_setor_atendimento, ds_classif_setor, ds_procedimento, cd_procedimento_convenio, ds_procedimento_convenio, nr_seq_proc_pacote, cd_unidade_basica, cd_unidade_compl, dt_entrada_unidade, dt_saida_unidade, qt_procedimento, vl_procedimento, vl_unitario, vl_desconto, vl_unitario_bruto, vl_bruto, dt_conta, dt_conta_dia, ie_espaco, cd_unidade_medida, nr_seq_protocolo) AS select a.nr_sequencia,
	a.cd_convenio, 
	a.ie_emite_conta, 
	f.nr_interno_conta, 
	a.cd_procedimento, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	substr(d.ds_valor_dominio,0,30) 		ds_classif_setor, 
	substr(b.ds_procedimento,1,80) 		ds_procedimento, 
	coalesce(g.cd_procedimento,coalesce(a.cd_procedimento_convenio,a.cd_procedimento)) cd_procedimento_convenio, 
	coalesce(g.ds_procedimento,b.ds_procedimento) 	ds_procedimento_convenio, 
	a.nr_seq_proc_pacote, 
	e.cd_unidade_basica, 
	e.cd_unidade_compl, 
	e.dt_entrada_unidade, 
	coalesce(e.dt_saida_unidade,f.dt_periodo_final) dt_saida_unidade, 
	sum(a.qt_procedimento) qt_procedimento, 
	sum(a.vl_procedimento) vl_procedimento, 
	sum(a.vl_procedimento) / sum(a.qt_procedimento) vl_unitario, 
	sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0)) vl_desconto, 
	(sum(a.vl_procedimento) + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0))) / sum(a.qt_procedimento) vl_unitario_bruto, 
	(sum(a.vl_procedimento) + sum(coalesce(obter_desconto_matproc(a.nr_sequencia,'P'),0))) vl_bruto, 
	a.dt_conta, 
	trunc(a.dt_conta,'dd') dt_conta_dia, 
	' ' ie_espaco, 
	'Un' cd_unidade_medida, 
	f.nr_seq_protocolo 
FROM conta_paciente f, atend_paciente_unidade e, valor_dominio d, setor_atendimento c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN proc_paciente_convenio g ON (a.nr_sequencia = g.nr_seq_procedimento)
WHERE a.cd_procedimento 	= b.cd_procedimento and a.ie_origem_proced 	= b.ie_origem_proced and b.ie_classificacao	= '3' and a.cd_setor_atendimento 	= c.cd_setor_atendimento and c.cd_classif_setor 	= d.vl_dominio  and d.cd_dominio 		= 1 and a.nr_atendimento		= e.nr_atendimento and a.dt_entrada_unidade	= e.dt_entrada_unidade and a.nr_interno_conta	= f.nr_interno_conta group by a.nr_sequencia, 
	a.cd_convenio, 
	a.ie_emite_conta, 
	f.nr_interno_conta, 
	a.cd_procedimento, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	substr(d.ds_valor_dominio,0,30), 
	substr(b.ds_procedimento,1,80), 
	coalesce(g.cd_procedimento,coalesce(a.cd_procedimento_convenio,a.cd_procedimento)), 
	coalesce(g.ds_procedimento,b.ds_procedimento), 
	a.nr_seq_proc_pacote, 
	e.cd_unidade_basica, 
	e.cd_unidade_compl, 
	e.dt_entrada_unidade, 
	coalesce(e.dt_saida_unidade,f.dt_periodo_final), 
	a.dt_conta, 
	trunc(a.dt_conta,'dd'), 
	' ', 
	'Un', 
	f.nr_seq_protocolo;

