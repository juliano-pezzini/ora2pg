-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_fiscal_v (ie_operacao_fiscal, ds_operacao_nf, ds_comprador, ds_fornecedor, cd_cgc_cpf, ds_cgc_cpf, ds_doc_ref, nm_pessoa, nm_fantasia, dt_atual_estoque_dia, cd_convenio, ie_calculada, cd_contrato, nr_sequencia, cd_estabelecimento, cd_cgc_emitente, cd_serie_nf, nr_nota_fiscal, nr_sequencia_nf, cd_operacao_nf, dt_emissao, dt_entrada_saida, ie_acao_nf, ie_emissao_nf, ie_tipo_frete, vl_mercadoria, vl_total_nota, qt_peso_bruto, qt_peso_liquido, dt_atualizacao, nm_usuario, cd_condicao_pagamento, dt_contabil, cd_cgc, cd_pessoa_fisica, vl_ipi, vl_descontos, vl_frete, vl_seguro, vl_despesa_acessoria, ds_observacao, nr_nota_referencia, cd_serie_referencia, cd_natureza_operacao, dt_atualizacao_estoque, vl_desconto_rateio, ie_situacao, nr_ordem_compra, nr_lote_contabil, nr_sequencia_ref, nr_interno_conta, dt_atualizacao_cp_cr, nr_seq_protocolo, cd_moeda, vl_conv_moeda, ds_inconsistencia, dt_impressao, ds_obs_desconto_nf, nr_seq_classif_fiscal, ie_entregue_bloqueto, ie_status_envio, nr_seq_exportada, nr_nfe_imp, ie_tipo_nota, cd_setor_impressao, nr_seq_motivo_cancel, nr_seq_motivo_devol, nr_recibo, nr_seq_mensalidade, cd_setor_digitacao, nr_seq_prot_res_pls, nr_seq_lote_res_pls, cd_conv_integracao, nr_danfe, dt_atualizacao_nrec, ie_nf_eletronica, nr_seq_grupo_prod, nm_usuario_calc, ds_razao_emitente_orig, ds_razao_tomador_orig, dt_aprovacao) AS select	o.ie_operacao_fiscal,
	o.ds_operacao_nf,
	a.nm_pessoa_fisica || c.ds_razao_social ds_comprador,
	f.ds_razao_social ds_fornecedor,
	coalesce(a.nr_cpf, c.cd_cgc) cd_cgc_cpf,
	obter_cgc_cpf_editado(coalesce(a.nr_cpf, c.cd_cgc)) ds_cgc_cpf,
	coalesce(nr_seq_protocolo, nr_interno_conta) ds_doc_ref,
	coalesce(a.nm_pessoa_fisica, coalesce(c.ds_razao_social, f.ds_razao_social)) nm_pessoa,
	coalesce(a.nm_pessoa_fisica, coalesce(c.nm_fantasia, f.nm_fantasia)) nm_fantasia,
	trunc(dt_atualizacao_estoque,'dd') dt_atual_estoque_dia,
	coalesce(obter_convenio_nf(n.nr_sequencia),n.cd_conv_integracao) cd_convenio,
	CASE WHEN n.dt_atualizacao_estoque IS NULL THEN  'N'  ELSE 'S' END  ie_calculada,
	substr(obter_dados_contrato(obter_dados_nota_fiscal(n.nr_sequencia, 15), 'CD'),1,20) cd_contrato,
	n.nr_sequencia,
	n.cd_estabelecimento,
	n.cd_cgc_emitente,
	n.cd_serie_nf,
	n.nr_nota_fiscal,
	n.nr_sequencia_nf,
	n.cd_operacao_nf,
	n.dt_emissao,
	n.dt_entrada_saida,
	n.ie_acao_nf,
	n.ie_emissao_nf,
	n.ie_tipo_frete,
	n.vl_mercadoria,
	n.vl_total_nota,
	n.qt_peso_bruto,
	n.qt_peso_liquido,
	n.dt_atualizacao,
	n.nm_usuario,
	n.cd_condicao_pagamento,
	n.dt_contabil,
	n.cd_cgc,
	n.cd_pessoa_fisica,
	n.vl_ipi,
	n.vl_descontos,
	n.vl_frete,
	n.vl_seguro,
	n.vl_despesa_acessoria,
	n.ds_observacao,
	n.nr_nota_referencia,
	n.cd_serie_referencia,
	n.cd_natureza_operacao,
	n.dt_atualizacao_estoque,
	n.vl_desconto_rateio,
	n.ie_situacao,
	n.nr_ordem_compra,
	n.nr_lote_contabil,
	n.nr_sequencia_ref,
	n.nr_interno_conta,
	n.dt_atualizacao_cp_cr,
	n.nr_seq_protocolo,
	n.cd_moeda,
	n.vl_conv_moeda,
	n.ds_inconsistencia,
	n.dt_impressao,
	n.ds_obs_desconto_nf,
	n.nr_seq_classif_fiscal,
	n.ie_entregue_bloqueto,
	n.ie_status_envio,
	n.nr_seq_exportada,
	n.nr_nfe_imp,
	n.ie_tipo_nota,
	n.cd_setor_impressao,
	n.nr_seq_motivo_cancel,
	n.nr_seq_motivo_devol,
	n.nr_recibo,
	n.nr_seq_mensalidade,
	n.cd_setor_digitacao,
	n.nr_seq_prot_res_pls,
	n.nr_seq_lote_res_pls,
	n.cd_conv_integracao,
	n.nr_danfe,
	n.dt_atualizacao_nrec,
	n.ie_nf_eletronica,
	n.nr_seq_grupo_prod,
	n.nm_usuario_calc,
	substr(n.DS_RAZAO_EMITENTE_ORIG,1,255) ds_razao_emitente_orig,
	substr(n.DS_RAZAO_TOMADOR_ORIG,1,255) ds_razao_tomador_orig,
  n.dt_aprovacao
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN pessoa_fisica a ON (n.cd_pessoa_fisica = a.cd_pessoa_fisica)
LEFT OUTER JOIN pessoa_juridica c ON (n.cd_cgc = c.cd_cgc)
LEFT OUTER JOIN pessoa_juridica f ON (n.cd_cgc_emitente = f.cd_cgc)
WHERE n.cd_operacao_nf  	= o.cd_operacao_nf;

