-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_resumo_internacao_v (tp_registro, ds_registro, nr_seq_protocolo, nr_interno_conta, nr_atendimento, cd_pessoa_fisica, nr_registro_ans, cd_cgc_prestador, cd_autorizacao, dt_autorizacao, cd_usuario_convenio, nm_beneficiario, ds_plano, ds_carater_internacao, ds_acomodacao, dt_entrada, dt_alta, ds_tipo_internacao, cd_edicao, cd_cid_principal, ds_tipo_acidente, ds_motivo_alta, cd_procedimento_sus, qt_dia_internacao, dt_procedimento, cd_edicao_amb, cd_procedimento, qt_procedimento, vl_unitario_item, vl_total_item, ds_tipo_faturamento) AS select	1					TP_REGISTRO,
	'CABECALHO'				DS_REGISTRO,
	a.nr_seq_protocolo			NR_SEQ_PROTOCOLO,
	a.nr_interno_conta			NR_INTERNO_CONTA,
	a.nr_atendimento			NR_ATENDIMENTO,
	c.cd_pessoa_fisica			CD_PESSOA_FISICA,
	d.cd_ans				NR_REGISTRO_ANS,
	a.cd_cgc_hospital			CD_CGC_PRESTADOR,
	substr(f.cd_autorizacao,1,10)		CD_AUTORIZACAO,
	b.dt_autorizacao			DT_AUTORIZACAO,
	a.cd_usuario_convenio			CD_USUARIO_CONVENIO,
	a.nm_paciente				NM_BENEFICIARIO,
	substr(obter_desc_plano(a.cd_convenio, a.cd_plano_convenio),1,20) DS_PLANO,
        CASE WHEN a.ie_carater_inter='U' THEN 'S'  ELSE 'N' END 	DS_CARATER_INTERNACAO,
	substr(obter_desc_tipo_acomod(a.cd_tipo_acomodacao),1,30) DS_ACOMODACAO,
	a.dt_entrada				DT_ENTRADA,
	a.dt_alta				DT_ALTA,
	a.ie_clinica				DS_TIPO_INTERNACAO,
	'CID-10'				CD_EDICAO,
	a.cd_cid_principal			CD_CID_PRINCIPAL,
	substr(obter_desc_tipo_acidente(c.nr_seq_tipo_acidente),1,30) DS_TIPO_ACIDENTE,
	substr(obter_desc_motivo_alta(a.cd_motivo_alta),1,30) DS_MOTIVO_ALTA,
	0					CD_PROCEDIMENTO_SUS,
	a.qt_dia_internacao			QT_DIA_INTERNACAO,
	LOCALTIMESTAMP					DT_PROCEDIMENTO,
	substr(OBTER_EDICAO_AMB(d.cd_estabelecimento, a.cd_convenio, a.cd_categoria_convenio, b.dt_autorizacao),1,20) CD_EDICAO_AMB,
	0					CD_PROCEDIMENTO,
	0					QT_PROCEDIMENTO,
	0					VL_UNITARIO_ITEM,
	0					VL_TOTAL_ITEM,
	'P'					DS_TIPO_FATURAMENTO
FROM	estabelecimento d,
	conta_paciente_guia f,
	conta_paciente e,
	atendimento_paciente c,
	w_interf_conta_autor b,
	w_interf_conta_cab a
where	a.nr_interno_conta	= b.nr_interno_conta
and	c.nr_atendimento	= e.nr_atendimento
and	f.nr_interno_conta	= e.nr_interno_conta
and	a.nr_atendimento	= c.nr_atendimento
and	c.cd_estabelecimento	= d.cd_estabelecimento

union all

select	2					TP_REGISTRO,
	'ITEM'					DS_REGISTRO,
	a.nr_seq_protocolo			NR_SEQ_PROTOCOLO,
	a.nr_interno_conta			NR_INTERNO_CONTA,
	a.nr_atendimento			NR_ATENDIMENTO,
	b.cd_pessoa_fisica			CD_PESSOA_FISICA,
	c.cd_ans				NR_REGISTRO_ANS,
	d.cd_cgc_hospital			CD_CGC_PRESTADOR,
	substr(f.cd_autorizacao,1,10)		CD_AUTORIZACAO,
	e.dt_autorizacao			DT_AUTORIZACAO,
	' '					CD_USUARIO_CONVENIO,
	' '					NM_BENEFICIARIO,
	' '					DS_PLANO,
	' '					DS_CARATER_INTERNACAO,
	' '					DS_ACOMODACAO,
	LOCALTIMESTAMP					DT_ENTRADA,
	LOCALTIMESTAMP					DT_ALTA,
	0					DS_TIPO_INTERNACAO,
	'CID-10'				CD_EDICAO,
	d.cd_cid_principal			CD_CID_PRINCIPAL,
	substr(obter_desc_tipo_acidente(b.nr_seq_tipo_acidente),1,30) DS_TIPO_ACIDENTE,
	substr(obter_desc_motivo_alta(d.cd_motivo_alta),1,30) DS_MOTIVO_ALTA,
	a.cd_item				CD_PROCEDIMENTO_SUS,
	0					QT_DIA_INTERNACAO,
	a.dt_item				DT_PROCEDIMENTO,
	substr(OBTER_EDICAO_AMB(c.cd_estabelecimento, a.cd_convenio, d.cd_categoria_convenio, a.dt_autorizacao),1,20) CD_EDICAO_AMB,
	a.cd_item				CD_PROCEDIMENTO,
	a.qt_item				QT_PROCEDIMENTO,
	a.vl_unitario_item			VL_UNITARIO_ITEM,
	a.vl_total_item				VL_TOTAL_ITEM,
	'P'					DS_TIPO_FATURAMENTO
FROM conta_paciente h, conta_paciente_guia f, estabelecimento c, atendimento_paciente b, w_interf_conta_item a, w_interf_conta_cab d
LEFT OUTER JOIN w_interf_conta_autor e ON (d.nr_interno_conta = e.nr_interno_conta)
WHERE a.nr_atendimento	= b.nr_atendimento and b.nr_atendimento	= h.nr_atendimento and f.nr_interno_conta	= h.nr_interno_conta and b.cd_estabelecimento	= c.cd_estabelecimento and b.nr_atendimento	= d.nr_atendimento  and a.nr_interno_conta	= d.nr_interno_conta;

