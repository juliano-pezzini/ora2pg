-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hd_gestao_presc_dial_v (nm_paciente, nr_prescricao, nr_atendimento, nm_medico, ds_convenio, dt_inicio, dt_final, ds_tipo_hemodialise, ds_setor_atendimento, dt_liberacao, ie_tipo_dialise, cd_setor_atendimento, ie_conferida, cd_pessoa_fisica) AS (
select 	substr(obter_nome_pessoa_fisica(m.cd_pessoa_fisica,null),1,255) nm_paciente, 
	m.nr_prescricao nr_prescricao, 
	m.nr_atendimento nr_atendimento, 
	substr(obter_nome_pessoa_fisica(m.cd_medico,null),1,255) nm_medico, 
	substr(Obter_desc_convenio(Obter_Convenio_Atendimento(m.nr_atendimento)),1,255) ds_convenio, 
	pkg_date_utils.start_of(m.dt_inicio_prescr,'dd') dt_inicio, 
	pkg_date_utils.start_of(m.dt_validade_prescr,'dd') dt_final, 
	substr(obter_valor_dominio('1934', p.ie_tipo_hemodialise), 1, 255) ds_tipo_hemodialise, 
	substr(obter_ds_setor_atendimento(m.cd_setor_atendimento), 1, 255) ds_setor_atendimento, 
	m.dt_liberacao, 
	p.ie_tipo_dialise, 
	m.cd_setor_atendimento, 
	obter_ie_prescricao_conferida(m.nr_prescricao) ie_conferida, 
	m.cd_pessoa_fisica 
FROM 	hd_prescricao p, 
	prescr_medica m 
where 	p.nr_prescricao = m.nr_prescricao 
and	m.dt_liberacao is not null 
and	p.ie_tipo_hemodialise in (	 
		select	ie_tipo_hemodialise 
	  	from	hd_regra_prescricao a, 
			hd_regra_presc_dial b 
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
		and	b.nr_seq_regra = a.nr_sequencia 
		and	b.cd_setor_atendimento = m.cd_setor_atendimento 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A') 

union
 
select 	substr(obter_nome_pessoa_fisica(m.cd_pessoa_fisica,null),1,255) nm_paciente, 
	m.nr_prescricao nr_prescricao, 
	m.nr_atendimento nr_atendimento, 
	substr(obter_nome_pessoa_fisica(m.cd_medico,null),1,255) nm_medico, 
	substr(Obter_desc_convenio(Obter_Convenio_Atendimento(m.nr_atendimento)),1,255) ds_convenio, 
	pkg_date_utils.start_of(m.dt_inicio_prescr,'dd') dt_inicio, 
	pkg_date_utils.start_of(m.dt_validade_prescr,'dd') dt_final, 
	substr(obter_valor_dominio('1934', p.ie_tipo_hemodialise), 1, 255) ds_tipo_hemodialise, 
	substr(obter_ds_setor_atendimento(m.cd_setor_atendimento), 1, 255) ds_setor_atendimento, 
	m.dt_liberacao, 
	p.ie_tipo_dialise, 
	m.cd_setor_atendimento, 
	obter_ie_prescricao_conferida(m.nr_prescricao) ie_conferida, 
	m.cd_pessoa_fisica 
from 	hd_prescricao p, 
	prescr_medica m 
where 	p.nr_prescricao = m.nr_prescricao 
and	m.dt_liberacao is not null 
and	p.ie_tipo_hemodialise in (	 
		select	ie_tipo_hemodialise 
	  	from	hd_regra_prescricao a, 
			hd_regra_presc_dial b 
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
		and	b.nr_seq_regra = a.nr_sequencia 
		and	b.cd_setor_atendimento is null 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A') 
and	not exists ( 
		select	1 
		from	hd_regra_prescricao a, 
			hd_regra_presc_dial b 
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
		and	b.cd_setor_atendimento = m.cd_setor_atendimento 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A') 

union
 
select 	substr(obter_nome_pessoa_fisica(m.cd_pessoa_fisica,null),1,255) nm_paciente, 
	m.nr_prescricao nr_prescricao, 
	m.nr_atendimento nr_atendimento, 
	substr(obter_nome_pessoa_fisica(m.cd_medico,null),1,255) nm_medico, 
	substr(Obter_desc_convenio(Obter_Convenio_Atendimento(m.nr_atendimento)),1,255) ds_convenio, 
	pkg_date_utils.start_of(m.dt_inicio_prescr,'dd') dt_inicio, 
	pkg_date_utils.start_of(m.dt_validade_prescr,'dd') dt_final, 
	substr(obter_valor_dominio('1934', p.ie_tipo_hemodialise), 1, 255) ds_tipo_hemodialise, 
	substr(obter_ds_setor_atendimento(m.cd_setor_atendimento), 1, 255) ds_setor_atendimento, 
	m.dt_liberacao, 
	p.ie_tipo_dialise, 
	m.cd_setor_atendimento, 
	obter_ie_prescricao_conferida(m.nr_prescricao) ie_conferida, 
	m.cd_pessoa_fisica 
from 	hd_prescricao p, 
	prescr_medica m 
where 	p.nr_prescricao = m.nr_prescricao 
and	m.dt_liberacao is not null 
and	not exists ( 
		select	1 
		from	hd_regra_prescricao a, 
			hd_regra_presc_dial b 
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
		and	b.cd_setor_atendimento = m.cd_setor_atendimento 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A') 
and	not exists ( 
		select	1 
		from	hd_regra_prescricao a, 
			hd_regra_presc_dial b 
		where	a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
		and	b.cd_setor_atendimento is null 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A') 
);

