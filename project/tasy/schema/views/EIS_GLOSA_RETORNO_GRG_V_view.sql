-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_glosa_retorno_grg_v (cd_estabelecimento, dt_referencia, cd_convenio, ds_convenio, cd_categoria, ds_categoria, cd_motivo_glosa, ds_motivo_glosa, cd_setor_atendimento, ds_setor_atendimento, cd_setor_responsavel, ds_setor_responsavel, ie_tipo_atendimento, ds_tipo_atendimento, ie_tipo_convenio, ds_tipo_convenio, vl_glosa, vl_glosa_aceita, vl_reapresentacao) AS select	x.cd_estabelecimento,
	x.dt_referencia, 
	x.cd_convenio, 
	x.ds_convenio, 
	x.cd_categoria, 
	x.ds_categoria, 
	x.cd_motivo_glosa, 
	x.ds_motivo_glosa, 
	x.cd_setor_atendimento, 
  x.ds_setor_atendimento, 
  x.cd_setor_responsavel, 
  x.ds_setor_responsavel, 
  x.ie_tipo_atendimento, 
  x.ds_tipo_atendimento, 
  x.ie_tipo_convenio, 
  x.ds_tipo_convenio, 
  sum(x.vl_glosa) vl_glosa, 
  sum(x.vl_glosa_aceita) vl_glosa_aceita, 
  sum(x.vl_reapresentacao) vl_reapresentacao 
FROM ( 
    select b.cd_estabelecimento, 
    h.dt_retorno dt_referencia, 
    f.cd_convenio, 
    substr(f.ds_convenio,1,255) ds_convenio, 
    g.cd_categoria, 
    substr(g.ds_categoria,1,255) ds_categoria, 
    e.cd_motivo_glosa, 
    substr(e.ds_motivo_glosa,1,255) ds_motivo_glosa, 
    d.cd_setor_atendimento, 
    substr(obter_nome_setor(d.cd_setor_atendimento),1,255) ds_setor_atendimento, 
    d.cd_setor_responsavel, 
    substr(obter_nome_setor(d.cd_setor_responsavel),1,255) ds_setor_responsavel, 
    a.ie_tipo_atendimento, 
    substr(obter_valor_dominio(12,a.ie_tipo_atendimento),1,255) ds_tipo_atendimento, 
    f.ie_tipo_convenio, 
    substr(obter_valor_dominio(11,f.ie_tipo_convenio),1,255) ds_tipo_convenio, 
    sum(d.vl_glosa) vl_glosa, 
    CASE WHEN e.ie_acao_glosa='A' THEN sum(d.vl_glosa)  ELSE 0 END  vl_glosa_aceita, 
    CASE WHEN e.ie_acao_glosa='R' THEN sum(d.vl_glosa)  ELSE 0 END  vl_reapresentacao 
  from  atendimento_paciente a, 
    conta_paciente b, 
    convenio_retorno_item c, 
    convenio_retorno_glosa d, 
    motivo_glosa e, 
    convenio f, 
    categoria_convenio g, 
    convenio_retorno h 
  where  a.nr_atendimento    = b.nr_atendimento 
  and  b.nr_interno_conta    = c.nr_interno_conta 
  and  c.nr_seq_retorno    = h.nr_sequencia 
  and  c.nr_sequencia      = d.nr_seq_ret_item 
  and  d.cd_motivo_glosa    = e.cd_motivo_glosa 
  and  b.cd_convenio_parametro    = f.cd_convenio 
  and  b.cd_categoria_parametro  = g.cd_categoria 
  and  b.cd_convenio_parametro    = g.cd_convenio 
  group by   b.cd_estabelecimento, 
      h.dt_retorno, 
      f.cd_convenio, 
      f.ds_convenio, 
      g.cd_categoria, 
      g.ds_categoria, 
      e.cd_motivo_glosa, 
      e.ds_motivo_glosa, 
      d.cd_setor_atendimento, 
      d.cd_setor_responsavel, 
      a.ie_tipo_atendimento, 
      f.ie_tipo_convenio, 
      e.ie_acao_glosa 
  
union all
 
  select  b.cd_estabelecimento, 
    h.dt_lote dt_referencia, 
    f.cd_convenio, 
    substr(f.ds_convenio,1,255) ds_convenio, 
    g.cd_categoria, 
    substr(g.ds_categoria,1,255) ds_categoria, 
    e.cd_motivo_glosa, 
    substr(e.ds_motivo_glosa,1,255) ds_motivo_glosa, 
    (obter_dados_lote_audit_item(d.nr_sequencia,'SA'))::numeric  cd_setor_atendimento, 
    substr(obter_nome_setor(obter_dados_lote_audit_item(d.nr_sequencia,'SA')),1,255) ds_setor_atendimento, 
    d.cd_setor_responsavel, 
    substr(obter_nome_setor(d.cd_setor_responsavel),1,255) ds_setor_responsavel, 
    a.ie_tipo_atendimento, 
    substr(obter_valor_dominio(12,a.ie_tipo_atendimento),1,255) ds_tipo_atendimento, 
    f.ie_tipo_convenio, 
    substr(obter_valor_dominio(11,f.ie_tipo_convenio),1,255) ds_tipo_convenio, 
    sum(d.vl_glosa_informada) vl_glosa, 
    sum(d.vl_glosa) vl_glosa_aceita, 
    sum(d.vl_amenor) vl_reapresentacao 
  from  atendimento_paciente a, 
    conta_paciente b, 
    lote_audit_hist_guia c, 
    lote_audit_hist_item d, 
    motivo_glosa e, 
    convenio f, 
    categoria_convenio g, 
    lote_audit_hist h 
  where  a.nr_atendimento    = b.nr_atendimento 
  and  b.nr_interno_conta    = c.nr_interno_conta 
  and  c.nr_seq_lote_hist    = h.nr_sequencia 
  and  c.nr_sequencia      = d.nr_seq_guia 
  and  d.cd_motivo_glosa    = e.cd_motivo_glosa 
  and  b.cd_convenio_parametro    = f.cd_convenio 
  and  b.cd_categoria_parametro  = g.cd_categoria 
  and  b.cd_convenio_parametro    = g.cd_convenio 
  group by   b.cd_estabelecimento, 
      h.dt_lote, 
      f.cd_convenio, 
      f.ds_convenio, 
      g.cd_categoria, 
      g.ds_categoria, 
      e.cd_motivo_glosa, 
      e.ds_motivo_glosa, 
      d.cd_setor_atendimento, 
      d.cd_setor_responsavel, 
      a.ie_tipo_atendimento, 
      f.ie_tipo_convenio, 
      e.ie_acao_glosa, 
      d.nr_sequencia 
  ) x 
group by x.cd_estabelecimento, 
  x.dt_referencia, 
  x.cd_convenio, 
  x.ds_convenio, 
  x.cd_categoria, 
  x.ds_categoria, 
  x.cd_motivo_glosa, 
  x.ds_motivo_glosa, 
  x.cd_setor_atendimento, 
  x.ds_setor_atendimento, 
  x.cd_setor_responsavel, 
  x.ds_setor_responsavel, 
  x.ie_tipo_atendimento, 
  x.ds_tipo_atendimento, 
  x.ie_tipo_convenio, 
  x.ds_tipo_convenio;

