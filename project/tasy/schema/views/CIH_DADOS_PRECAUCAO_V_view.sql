-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cih_dados_precaucao_v (nr_atendimento, dt_inicio, dt_termino, nm_pessoa_fisica, cd_setor_atendimento, ds_setor_atendimento, ds_tipo_isolamento, ds_microorganismo, ds_topografia, hr_tempo) AS select	distinct
	b.nr_atendimento, 
	b.dt_inicio, 
	coalesce(b.dt_termino,c.dt_alta) dt_termino, 
	substr(obter_nome_pf(c.cd_pessoa_fisica),1,100) nm_pessoa_fisica, 
	(select max(j.cd_setor_atendimento) 
	FROM	atend_paciente_unidade s, 
		unidade_atendimento u, 
		atendimento_paciente x, 
		setor_atendimento j 
	where	s.cd_setor_atendimento	= u.cd_setor_atendimento 
	and	s.nr_atendimento	= b.nr_atendimento 
	and	s.cd_setor_atendimento	= j.cd_setor_atendimento 
	and	x.nr_atendimento	= s.nr_atendimento 
	and	s.dt_entrada_unidade =	(select	max(i.dt_entrada_unidade) 
					from	atend_paciente_unidade i, 
						setor_atendimento g 
					where	1 = 1 
					and	i.cd_setor_atendimento is not null 
					and	i.nr_atendimento	= b.nr_atendimento 
					and	i.cd_setor_atendimento	= g.cd_setor_atendimento 
					and	g.cd_classif_setor in (1, 3, 4) 
					and	trunc(dt_entrada_unidade) <= trunc(b.dt_inicio))) cd_setor_atendimento, 
	(coalesce(	(select max(j.ds_setor_atendimento) 
		from	atend_paciente_unidade s, 
			unidade_atendimento u, 
			atendimento_paciente x, 
			setor_atendimento j 
		where	s.cd_setor_atendimento	= u.cd_setor_atendimento 
		and	s.nr_atendimento	= b.nr_atendimento 
		and	s.cd_setor_atendimento	= j.cd_setor_atendimento 
		and	x.nr_atendimento	= s.nr_atendimento 
		and	j.cd_classif_setor in (3,4,9) 
		and	trunc(s.dt_saida_unidade) between trunc(b.dt_inicio) and trunc(b.dt_inicio)+86399/86400), 
		(select max(j.ds_setor_atendimento) 
		from	atend_paciente_unidade s, 
			unidade_atendimento u, 
			atendimento_paciente x, 
			setor_atendimento j 
		where	s.cd_setor_atendimento	= u.cd_setor_atendimento 
		and	s.nr_atendimento	= b.nr_atendimento 
		and	s.cd_setor_atendimento	= j.cd_setor_atendimento 
		and	j.cd_classif_setor in (3,4,9) 
		and	x.nr_atendimento	= s.nr_atendimento 
		and	s.dt_entrada_unidade =	(select	max(i.dt_entrada_unidade) 
						from	atend_paciente_unidade i, 
							setor_atendimento g 
						where	1 = 1 
						and	i.cd_setor_atendimento is not null 
						and	i.nr_atendimento	= b.nr_atendimento 
						and	i.cd_setor_atendimento	= g.cd_setor_atendimento 
						and	g.cd_classif_setor in (3,4,9) 
						and	trunc(i.dt_entrada_unidade) <= trunc(b.dt_inicio)))) 
	) ds_setor_atendimento, 
	x.ds_precaucao ds_tipo_isolamento, 
	obter_select_concatenado_bv(	'select	y.ds_microorganismo 
					from	cih_microorganismo y, 
						atend_precaucao_micro d 
					where	d.nr_seq_atend_precaucao	= :nr_sequencia 
					and	y.cd_microorganismo		= d.cd_microorganismo ' 
					,'nr_sequencia='||to_char(b.nr_sequencia),', ') ds_microorganismo, 
	k.ds_topografia, 
	substr((case	when	(replace(obter_dif_horario(b.dt_inicio, coalesce(coalesce(b.dt_termino,c.dt_alta),LOCALTIMESTAMP)),':',''))::numeric  <= (replace('24:00:00',':',''))::numeric  and 
				(replace(obter_dif_horario(b.dt_inicio, coalesce(coalesce(b.dt_termino,c.dt_alta),LOCALTIMESTAMP)),':',''))::numeric  != 0 then 
				to_char(obter_dif_horario(b.dt_inicio, b.dt_termino))||' Hrs' 
			when	(replace(obter_dif_horario(b.dt_inicio, coalesce(coalesce(b.dt_termino,c.dt_alta),LOCALTIMESTAMP)),':',''))::numeric  = 0 then 
				'00:00:00 Hrs' 
		else 
			to_char(trunc(coalesce(coalesce(b.dt_termino,c.dt_alta),LOCALTIMESTAMP)) - trunc(b.dt_inicio))||CASE WHEN to_char(trunc(coalesce(coalesce(b.dt_termino,c.dt_alta),LOCALTIMESTAMP)) - trunc(b.dt_inicio))=1 THEN ' Dia'  ELSE ' Dias' END  
	end),1,20) hr_tempo 
FROM atendimento_paciente c, atendimento_precaucao b
LEFT OUTER JOIN cih_precaucao x ON (b.nr_seq_precaucao = x.nr_sequencia)
LEFT OUTER JOIN cih_topografia k ON (b.cd_topografia = k.cd_topografia)
WHERE 1 = 1 and b.dt_inicio is not null and b.dt_liberacao is not null and c.nr_atendimento	= b.nr_atendimento   order by	nm_pessoa_fisica;

