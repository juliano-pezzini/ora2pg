-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW usuario_ferias_hn_v (cd_cargo, cd_pf, dt_inicio, dt_ad, tm_casa, nm_prof, cd_setor_atendimento, cd_pessoa_fisica, agosto, setembro, outubro, novembro, dezembro, janeiro, fevereiro, marco, abril, maio, junho, julho, qt18_ago, qt18_set, qt18_out, qt18_nov, qt18_dez, qt18_jan, qt18_fev, qt18_mar, qt18_abr, qt18_mai, qt18_jun, qt18_jul, tot_func, tot_func_m18) AS SELECT		SUBSTR(obter_cargo_usuario(a.nm_usuario_ausente),1,200) cd_cargo,
			C.cd_pessoa_fisica cd_pf,
			a.dt_inicio dt_inicio,
			c.DT_ADMISSAO_HOSP dt_ad,
			TO_CHAR(((LOCALTIMESTAMP - c.DT_ADMISSAO_HOSP) / 365),'99.99') tm_casa,
			SUBSTR(obter_nome_pf_pj(c.cd_pessoa_fisica,''),1,200) nm_prof,
			b.cd_setor_atendimento,
			c.cd_pessoa_fisica,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='08' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Agosto,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='09' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Setembro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='10' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Outubro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='11' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Novembro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='12' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Dezembro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='01' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Janeiro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='02' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Fevereiro,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='03' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Marco,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='04' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Abril,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='05' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Maio,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='06' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Junho,
			CASE WHEN to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'mm')='07' THEN  to_char(to_date(obter_se_ferias_hn(c.cd_pessoa_fisica),'dd/mm/yyyy'), 'dd/mm') END   Julho,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '08'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_ago,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '09'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_set,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '10'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_out,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '11'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_nov,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '12'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_dez,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '01'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_jan,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '02'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_fev,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '03'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_mar,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '04'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_abr,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '05'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_mai,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '06'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_jun,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	TO_CHAR(a.dt_inicio,'mm') = '07'
			AND	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) qt18_jul,
			COUNT(a.nm_usuario_ausente) tot_func,
			(SELECT  COUNT(a.nm_usuario_ausente)
			
			where	obter_dias_entre_datas(c.dt_admissao_hosp, LOCALTIMESTAMP) > 549) tot_func_m18
FROM   	 	AUSENCIA_TASY a,
			usuario b,
			pessoa_fisica c
WHERE		cd_motivo_ausencia = 1
AND		a.nm_usuario_ausente = b.nm_usuario
AND		obter_se_ferias_hn(c.cd_pessoa_fisica) IS NOT NULL
AND		c.dt_demissao_hosp is null
AND			b.cd_pessoa_fisica = c.cd_pessoa_fisica
AND		obter_dias_entre_datas(c.dt_admissao_hosp, a.dt_fim) > 0
GROUP BY a.nm_usuario_ausente, c.dt_admissao_hosp, c.cd_pessoa_fisica, a.dt_inicio, b.cd_setor_atendimento;

