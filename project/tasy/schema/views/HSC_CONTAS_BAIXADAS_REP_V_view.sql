-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hsc_contas_baixadas_rep_v (ds_terceiro, nr_titulo, nr_atendimento, ds_item, vl_item, ds_paciente, ds_convenio, ds_tipo, cd_estabelecimento, dt_pagamento_previsto, cd_convenio_parametro, ie_status) AS select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1, 200) ds_terceiro,
	b.nr_titulo,
	c.nr_atendimento,
	substr(obter_desc_proc_paciente('D',c.nr_sequencia), 1, 200) ds_item,
	d.vl_repasse vl_item,
	substr(obter_nome_pf(g.cd_pessoa_fisica), 1, 200) ds_paciente,
	substr(obter_nome_convenio(e.cd_convenio_parametro), 1, 200) ds_convenio,
	'Procedimento' ds_tipo,
	e.cd_estabelecimento,
	b.dt_pagamento_previsto,
	e.cd_convenio_parametro,
	d.ie_status
FROM convenio h, atendimento_paciente g, conta_paciente e, procedimento_repasse d, procedimento_paciente c, terceiro a, titulo_receber b
LEFT OUTER JOIN protocolo_convenio f ON (b.nr_seq_protocolo = f.nr_seq_protocolo)
WHERE d.nr_seq_terceiro 	= a.nr_sequencia and g.nr_atendimento 	= c.nr_atendimento and e.nr_interno_conta 	= c.nr_interno_conta and d.nr_seq_procedimento 	= c.nr_sequencia and d.nr_repasse_terceiro 	is null  and (b.nr_seq_protocolo is null 	and b.nr_interno_conta = c.nr_interno_conta) and h.cd_convenio		= e.cd_convenio_parametro and (exists (select	1
		from	convenio_retorno_item x
		where	x.nr_interno_conta = c.nr_interno_conta/*
		*/
)
	or (h.ie_tipo_convenio = '1')
	) and b.dt_liquidacao is not null and b.vl_saldo_titulo = 0 and (0 = (	select	sum(l.vl_item)
		from 	conta_paciente_v l
		where 	l.nr_interno_conta 	= e.nr_interno_conta
		and 	l.cd_motivo_exc_conta 	is null
		and 	((ie_proc_mat 		= 2) or (nr_seq_proc_pacote 	is null
			or l.nr_sequencia 	<> l.nr_seq_proc_pacote))) -
		(select sum(coalesce(x.vl_recebido,0)) -
			sum(coalesce(x.vl_descontos,0)) -
			sum(coalesce(x.vl_glosa,0)) -
			sum(x.vl_perdas) vl_desc
		from    titulo_receber_liq x,
			titulo_receber y
		where   y.nr_titulo 		= x.nr_titulo
		and     y.nr_interno_conta 	= e.nr_interno_conta) +
		(select	sum((obter_dados_titulo_receber(y.nr_titulo,'VA'))::numeric )
		from	titulo_receber y
		where	y.nr_interno_conta 	= e.nr_interno_conta))

union

select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1, 200) ds_terceiro,
	b.nr_titulo,
	c.nr_atendimento,
	substr(obter_desc_proc_paciente('D',c.nr_sequencia), 1, 200) ds_item,
	d.vl_repasse vl_item,
	substr(obter_nome_pf(g.cd_pessoa_fisica), 1, 200) ds_paciente,
	substr(obter_nome_convenio(e.cd_convenio_parametro), 1, 200) ds_convenio,
	'Procedimento' ds_tipo,
	e.cd_estabelecimento,
	b.dt_pagamento_previsto,
	e.cd_convenio_parametro,
	d.ie_status
FROM convenio h, atendimento_paciente g, conta_paciente e, procedimento_repasse d, procedimento_paciente c, terceiro a, titulo_receber b
LEFT OUTER JOIN protocolo_convenio f ON (b.nr_seq_protocolo = f.nr_seq_protocolo)
WHERE d.nr_seq_terceiro 	= a.nr_sequencia and g.nr_atendimento 	= c.nr_atendimento and e.nr_interno_conta 	= c.nr_interno_conta and d.nr_seq_procedimento 	= c.nr_sequencia and d.nr_repasse_terceiro 	is null  and (b.nr_seq_protocolo 	is not null and e.nr_seq_protocolo = f.nr_seq_protocolo and e.ie_cancelamento is null) and h.cd_convenio		= e.cd_convenio_parametro and (exists (select	1
		from	convenio_retorno_item x
		where	x.nr_interno_conta = c.nr_interno_conta/*
		*/
)
	or (h.ie_tipo_convenio = '1')
	) and b.dt_liquidacao is not null and b.vl_saldo_titulo = 0 and (0 = (	select	sum(l.vl_item)
		from 	conta_paciente_v l
		where 	l.nr_interno_conta 	= e.nr_interno_conta
		and 	l.cd_motivo_exc_conta 	is null
		and 	((ie_proc_mat 		= 2) or (nr_seq_proc_pacote 	is null
			or l.nr_sequencia 	<> l.nr_seq_proc_pacote))) -
		(select sum(coalesce(x.vl_recebido,0)) -
			sum(coalesce(x.vl_descontos,0)) -
			sum(coalesce(x.vl_glosa,0)) -
			sum(x.vl_perdas) vl_desc
		from    titulo_receber_liq x,
			titulo_receber y
		where   y.nr_titulo 		= x.nr_titulo
		and (y.nr_seq_protocolo 	= b.nr_seq_protocolo and y.nr_interno_conta is null)) +
		(select	sum((obter_dados_titulo_receber(y.nr_titulo,'VA'))::numeric )
		from	titulo_receber y
		where (y.nr_seq_protocolo 	= b.nr_seq_protocolo and y.nr_interno_conta is null)))
 
union

select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1, 200) ds_terceiro,
	b.nr_titulo,
	c.nr_atendimento,
	substr(obter_desc_material(c.cd_material), 1, 200) ds_item,
	d.vl_repasse vl_item,
	substr(obter_nome_pf(g.cd_pessoa_fisica), 1, 200) ds_paciente,
	substr(obter_nome_convenio(e.cd_convenio_parametro), 1, 200) ds_convenio,
	'Material' ds_tipo,
	e.cd_estabelecimento,
	b.dt_pagamento_previsto,
	e.cd_convenio_parametro ,
	d.ie_status
FROM convenio h, atendimento_paciente g, conta_paciente e, material_repasse d, material_atend_paciente c, terceiro a, titulo_receber b
LEFT OUTER JOIN protocolo_convenio f ON (b.nr_seq_protocolo = f.nr_seq_protocolo)
WHERE d.nr_seq_terceiro 	= a.nr_sequencia and g.nr_atendimento 	= c.nr_atendimento and e.nr_interno_conta 	= c.nr_interno_conta and d.nr_seq_material 	= c.nr_sequencia and d.nr_repasse_terceiro 	is null  and (b.nr_seq_protocolo 	is null and b.nr_interno_conta = c.nr_interno_conta) and h.cd_convenio		= e.cd_convenio_parametro and (exists (select	1
		from	convenio_retorno_item x
		where 	x.nr_interno_conta = c.nr_interno_conta)/*
	*/
or (h.ie_tipo_convenio = '1')
	) and b.dt_liquidacao is not null and b.vl_saldo_titulo = 0 and (0 = (	select	sum(l.vl_item)
		from 	conta_paciente_v l
		where 	l.nr_interno_conta 	= e.nr_interno_conta
		and 	l.cd_motivo_exc_conta 	is null
		and 	((ie_proc_mat 		= 2) or (nr_seq_proc_pacote 	is null
			or l.nr_sequencia 	<> l.nr_seq_proc_pacote))) -
		(select sum(coalesce(x.vl_recebido,0)) -
			sum(coalesce(x.vl_descontos,0)) -
			sum(coalesce(x.vl_glosa,0)) -
			sum(x.vl_perdas) vl_desc
		from    titulo_receber_liq x,
			titulo_receber y
		where   y.nr_titulo 		= x.nr_titulo
		and      y.nr_interno_conta 	= e.nr_interno_conta) +
		(select	sum((obter_dados_titulo_receber(y.nr_titulo,'VA'))::numeric )
		from	titulo_receber y
		where	y.nr_interno_conta 	= e.nr_interno_conta))
 
union

select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1, 200) ds_terceiro,
	b.nr_titulo,
	c.nr_atendimento,
	substr(obter_desc_material(c.cd_material), 1, 200) ds_item,
	d.vl_repasse vl_item,
	substr(obter_nome_pf(g.cd_pessoa_fisica), 1, 200) ds_paciente,
	substr(obter_nome_convenio(e.cd_convenio_parametro), 1, 200) ds_convenio,
	'Material' ds_tipo,
	e.cd_estabelecimento,
	b.dt_pagamento_previsto,
	e.cd_convenio_parametro,
	d.ie_status
FROM convenio h, atendimento_paciente g, conta_paciente e, material_repasse d, material_atend_paciente c, terceiro a, titulo_receber b
LEFT OUTER JOIN protocolo_convenio f ON (b.nr_seq_protocolo = f.nr_seq_protocolo)
WHERE d.nr_seq_terceiro 	= a.nr_sequencia and g.nr_atendimento 	= c.nr_atendimento and e.nr_interno_conta 	= c.nr_interno_conta and d.nr_seq_material 	= c.nr_sequencia and d.nr_repasse_terceiro 	is null  and (b.nr_seq_protocolo 	is not null and e.nr_seq_protocolo = f.nr_seq_protocolo and e.ie_cancelamento is null) and h.cd_convenio		= e.cd_convenio_parametro and (exists (select	1
		from	convenio_retorno_item x
		where 	x.nr_interno_conta = c.nr_interno_conta)/*
	*/
or (h.ie_tipo_convenio = '1')
	) and b.dt_liquidacao is not null and b.vl_saldo_titulo = 0 and (0 = (	select	sum(l.vl_item)
		from 	conta_paciente_v l
		where 	l.nr_interno_conta 	= e.nr_interno_conta
		and 	l.cd_motivo_exc_conta 	is null
		and 	((ie_proc_mat 		= 2) or (nr_seq_proc_pacote 	is null
			or l.nr_sequencia 	<> l.nr_seq_proc_pacote))) -
		(select sum(coalesce(x.vl_recebido,0)) -
			sum(coalesce(x.vl_descontos,0)) -
			sum(coalesce(x.vl_glosa,0)) -
			sum(x.vl_perdas) vl_desc
		from    titulo_receber_liq x,
			titulo_receber y
		where   y.nr_titulo 		= x.nr_titulo
		and     y.nr_seq_protocolo 	= b.nr_seq_protocolo and y.nr_interno_conta is null) +
		(select	sum((obter_dados_titulo_receber(y.nr_titulo,'VA'))::numeric )
		from	titulo_receber y
		where	y.nr_seq_protocolo 	= b.nr_seq_protocolo and y.nr_interno_conta is null)) order by	1, 8 desc, 2;

