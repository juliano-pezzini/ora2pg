-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ctb_pls_info_conta_prov_cprt_v (nr_seq_protocolo, nr_seq_conta, ie_ato_cooperado, ie_regulamentacao, ie_tipo_contratacao, ie_segmentacao, ie_tipo_contrato, nr_seq_grupo_ans, ds_tipo_despesa, ie_tipo_segurado, ie_tipo_compartilhamento, ie_tipo_repasse, nr_seq_tipo_prestador, ie_tipo_relacao, nr_contrato, nr_lote_contabil_prov, cd_conta_prov_cred, cd_conta_prov_deb, nr_seq_resumo, nr_seq_mat, nr_seq_proc, nr_documento, nr_seq_segurado, nr_seq_congenere) AS select x.nr_sequencia nr_seq_protocolo,
       a.nr_sequencia nr_seq_conta,
       coalesce(c.ie_ato_cooperado,b.ie_ato_cooperado) ie_ato_cooperado,
       d.ie_regulamentacao,
       d.ie_tipo_contratacao,
       d.ie_segmentacao,
       case when
               coalesce(g.nr_seq_contrato, 0) <> 0 then (select    CASE WHEN cd_pf_estipulante IS NULL THEN  'PJ'  ELSE 'PF' END
               FROM      pls_contrato
               where     nr_sequencia    = g.nr_seq_contrato  LIMIT 1)
	else case when   coalesce(g.nr_seq_intercambio, 0) <> 0 then (select    CASE WHEN cd_pessoa_fisica IS NULL THEN  'PJ'  ELSE 'PF' END 
               from      pls_intercambio
               where     nr_sequencia    = g.nr_seq_intercambio  LIMIT 1)
        else   null
               end
       end ie_tipo_contrato,
       coalesce(c.nr_seq_grupo_ans,b.nr_seq_grupo_ans) nr_seq_grupo_ans,
       substr(obter_valor_dominio(3796 ,(select r.ie_tipo_despesa
					from	pls_conta_medica_resumo r
					where	r.nr_sequencia = c.nr_seq_conta_resumo
					and	r.nr_seq_conta = a.nr_sequencia
					
union

					select	p.ie_tipo_despesa
					from	pls_conta_proc p
					where	p.nr_sequencia = b.nr_seq_conta_proc
					and	coalesce(c.nr_seq_conta_resumo,0) = 0
					
union

					select	m.ie_tipo_despesa
					from	pls_conta_mat m
					where	m.nr_sequencia = b.nr_seq_conta_mat
					and	coalesce(c.nr_seq_conta_resumo,0) = 0)), 1, 255) ds_tipo_despesa,
       coalesce(a.ie_tipo_segurado,g.ie_tipo_segurado) ie_tipo_segurado,
	pls_obter_comp_repasse(m.dt_atendimento, x.dt_mes_competencia, g.nr_sequencia, x.nr_seq_congenere, 'C') ie_tipo_compartilhamento,
	pls_obter_comp_repasse(m.dt_atendimento, x.dt_mes_competencia, g.nr_sequencia, x.nr_seq_congenere, 'R') ie_tipo_repasse, 
	(select	max(nr_seq_tipo_prestador)
	from	pls_prestador
	where	nr_sequencia	= CASE WHEN h.ie_prestador_codificacao='E' THEN a.nr_seq_prestador_exec WHEN h.ie_prestador_codificacao='S' THEN a.nr_seq_prestador WHEN h.ie_prestador_codificacao='A' THEN x.nr_seq_prestador WHEN h.ie_prestador_codificacao='P' THEN c.nr_seq_prestador_pgto END ) nr_seq_tipo_prestador,
       (select	max(ie_tipo_relacao)
       from	pls_prestador
       where	nr_sequencia	= CASE WHEN h.ie_prestador_codificacao='E' THEN a.nr_seq_prestador_exec WHEN h.ie_prestador_codificacao='S' THEN a.nr_seq_prestador WHEN h.ie_prestador_codificacao='A' THEN x.nr_seq_prestador WHEN h.ie_prestador_codificacao='P' THEN c.nr_seq_prestador_pgto END ) ie_tipo_relacao,
       i.nr_contrato,
       c.nr_lote_contabil_prov,
       c.cd_conta_cred_provisao cd_conta_prov_cred,
       c.cd_conta_deb_provisao cd_conta_prov_deb,
       c.nr_sequencia nr_seq_resumo,
       null nr_seq_mat,
       b.nr_sequencia nr_seq_proc,
       c.nr_sequencia nr_documento,
       g.nr_sequencia nr_seq_segurado,
       x.nr_seq_congenere
FROM pls_protocolo_conta x, pls_conta_mat m, pls_esquema_contabil h, pls_plano d, pls_conta_copartic_contab c, pls_conta_coparticipacao b, pls_conta a, pls_segurado g
LEFT OUTER JOIN pls_contrato i ON (g.nr_seq_contrato = i.nr_sequencia)
WHERE a.nr_sequencia			= b.nr_seq_conta and b.nr_sequencia			= c.nr_seq_conta_copartic and a.nr_sequencia			= b.nr_seq_conta and x.nr_sequencia			= a.nr_seq_protocolo and d.nr_sequencia			= a.nr_seq_plano and h.nr_sequencia 			= c.nr_seq_esquema_prov  and g.nr_sequencia 			= a.nr_seq_segurado and b.nr_seq_conta_mat 		= m.nr_sequencia
 
union all

select x.nr_sequencia nr_seq_protocolo,
       a.nr_sequencia nr_seq_conta,
       coalesce(c.ie_ato_cooperado,b.ie_ato_cooperado) ie_ato_cooperado,
       d.ie_regulamentacao,
       d.ie_tipo_contratacao,
       d.ie_segmentacao,
       case when
               coalesce(g.nr_seq_contrato, 0) <> 0 then (select    CASE WHEN cd_pf_estipulante IS NULL THEN  'PJ'  ELSE 'PF' END 
               from      pls_contrato
               where     nr_sequencia    = g.nr_seq_contrato  LIMIT 1)
	else case when   coalesce(g.nr_seq_intercambio, 0) <> 0 then (select    CASE WHEN cd_pessoa_fisica IS NULL THEN  'PJ'  ELSE 'PF' END 
               from      pls_intercambio
               where     nr_sequencia    = g.nr_seq_intercambio  LIMIT 1)
        else   null
               end
       end ie_tipo_contrato,
       coalesce(c.nr_seq_grupo_ans,b.nr_seq_grupo_ans) nr_seq_grupo_ans,
       substr(obter_valor_dominio(3796 ,(select r.ie_tipo_despesa
					from	pls_conta_medica_resumo r
					where	r.nr_sequencia = c.nr_seq_conta_resumo
					and	r.nr_seq_conta = a.nr_sequencia
					
union

					select	p.ie_tipo_despesa
					from	pls_conta_proc p
					where	p.nr_sequencia = b.nr_seq_conta_proc
					and	coalesce(c.nr_seq_conta_resumo,0) = 0
					
union

					select	m.ie_tipo_despesa
					from	pls_conta_mat m
					where	m.nr_sequencia = b.nr_seq_conta_mat
					and	coalesce(c.nr_seq_conta_resumo,0) = 0)), 1, 255) ds_tipo_despesa,
       coalesce(a.ie_tipo_segurado,g.ie_tipo_segurado) ie_tipo_segurado,
	pls_obter_comp_repasse(p.dt_procedimento, x.dt_mes_competencia, g.nr_sequencia, x.nr_seq_congenere, 'C') ie_tipo_compartilhamento,
	pls_obter_comp_repasse(p.dt_procedimento, x.dt_mes_competencia, g.nr_sequencia, x.nr_seq_congenere, 'R') ie_tipo_repasse, 
	(select	max(nr_seq_tipo_prestador)
	from	pls_prestador
	where	nr_sequencia	= CASE WHEN h.ie_prestador_codificacao='E' THEN a.nr_seq_prestador_exec WHEN h.ie_prestador_codificacao='S' THEN a.nr_seq_prestador WHEN h.ie_prestador_codificacao='A' THEN x.nr_seq_prestador WHEN h.ie_prestador_codificacao='P' THEN c.nr_seq_prestador_pgto END ) nr_seq_tipo_prestador,
       (select	max(ie_tipo_relacao)
       from	pls_prestador
       where	nr_sequencia	= CASE WHEN h.ie_prestador_codificacao='E' THEN a.nr_seq_prestador_exec WHEN h.ie_prestador_codificacao='S' THEN a.nr_seq_prestador WHEN h.ie_prestador_codificacao='A' THEN x.nr_seq_prestador WHEN h.ie_prestador_codificacao='P' THEN c.nr_seq_prestador_pgto END ) ie_tipo_relacao,
       i.nr_contrato,
       c.nr_lote_contabil_prov,
       c.cd_conta_cred_provisao cd_conta_prov_cred,
       c.cd_conta_deb_provisao cd_conta_prov_deb,
       c.nr_sequencia nr_seq_resumo,
       null nr_seq_mat,
       b.nr_sequencia nr_seq_proc,
       c.nr_sequencia nr_documento,
       g.nr_sequencia nr_seq_segurado,
       x.nr_seq_congenere
FROM pls_protocolo_conta x, pls_conta_proc p, pls_esquema_contabil h, pls_plano d, pls_conta_copartic_contab c, pls_conta_coparticipacao b, pls_conta a, pls_segurado g
LEFT OUTER JOIN pls_contrato i ON (g.nr_seq_contrato = i.nr_sequencia)
WHERE a.nr_sequencia			= b.nr_seq_conta and b.nr_sequencia			= c.nr_seq_conta_copartic and a.nr_sequencia			= b.nr_seq_conta and x.nr_sequencia			= a.nr_seq_protocolo and d.nr_sequencia			= a.nr_seq_plano and h.nr_sequencia 			= c.nr_seq_esquema_prov  and g.nr_sequencia 			= a.nr_seq_segurado and b.nr_Seq_conta_proc		= p.nr_sequencia;

