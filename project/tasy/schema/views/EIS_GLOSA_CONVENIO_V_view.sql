-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_glosa_convenio_v (cd_convenio, ds_convenio, ie_tipo_convenio, ds_tipo_convenio, ie_tipo_atendimento, ds_tipo_atendimento, cd_categoria, ds_categoria, cd_empresa, cd_estabelecimento, dt_referencia, vl_pago, vl_conta, vl_glosa, vl_aceito, vl_naceito, dt_ref_conta) AS select	w.cd_convenio,
	substr(obter_nome_convenio(w.cd_convenio),1,255) ds_convenio,
	w.ie_tipo_convenio,
	substr(obter_valor_dominio(11,w.ie_tipo_convenio),1,255) ds_tipo_convenio,
	w.ie_tipo_atendimento,
	substr(obter_valor_dominio(12,w.ie_tipo_atendimento),1,255) ds_tipo_atendimento,
	w.cd_categoria,
	z.ds_categoria,
	w.cd_empresa,
	w.cd_estabelecimento,
	w.dt_referencia,
	sum(w.vl_pago) vl_pago,
	sum(w.vl_conta) vl_conta,
	coalesce(sum(w.vl_aceito),0) + coalesce(sum(w.vl_naceito),0) vl_glosa,
	sum(w.vl_aceito) vl_aceito,
	sum(w.vl_naceito) vl_naceito,
	w.dt_mesano_referencia dt_ref_conta
FROM	categoria_convenio z,
	(/* VL_PAGO e VL_CONTA e VL_GLOSA */
	select	a.cd_convenio,
		d.dt_mesano_referencia,
		b.ie_tipo_convenio,
		e.ie_tipo_atendimento,
		(select	max(x.cd_categoria)
		from	atend_categoria_convenio x
		where	x.cd_convenio		= a.cd_convenio
		and	x.nr_atendimento	= e.nr_atendimento) cd_categoria,
		f.cd_empresa,
		f.cd_estabelecimento,
		a.dt_entrega_convenio dt_referencia,
		(select	sum(x.vl_pago)
		from	convenio_retorno_item x
		where	x.nr_interno_conta	= d.nr_interno_conta) vl_pago,
		d.vl_conta,
		(select	coalesce(sum(x.vl_amenor),0)
		from	convenio_retorno_item x
		where	x.nr_seq_retorno	=
			(select	max(y.nr_seq_retorno)
			from	convenio_retorno_item y
			where	y.nr_interno_conta	= x.nr_interno_conta)
		and	not exists (select	1
			from	lote_audit_hist_guia y
			where	y.nr_interno_conta	= x.nr_interno_conta)
		and	x.nr_interno_conta	= d.nr_interno_conta) +
		(select	coalesce(sum(z.vl_amenor),0)
		from	lote_audit_hist_item z,
			lote_audit_hist y,
			lote_audit_hist_guia x
		where	x.nr_sequencia		= z.nr_seq_guia
		and	y.nr_sequencia		= obter_ultima_analise(y.nr_seq_lote_audit)
		and	x.nr_seq_lote_hist	= y.nr_sequencia
		and	x.nr_interno_conta	= d.nr_interno_conta) vl_naceito,
		(select	coalesce(sum(x.vl_glosado),0)
		from	convenio_retorno_item x
		where	x.nr_interno_conta	= d.nr_interno_conta) +
		(select	coalesce(sum(y.vl_glosa),0)
		from	lote_audit_hist_item y,
			lote_audit_hist_guia x
		where	x.nr_sequencia		= y.nr_seq_guia
		and	x.nr_interno_conta	= d.nr_interno_conta) vl_aceito
	from	estabelecimento f,
		atendimento_paciente e,
		conta_paciente d,
		titulo_receber c,
		convenio b,
		protocolo_convenio a
	where	exists (select	1
		from	convenio_retorno_item x
		where	x.nr_interno_conta	= d.nr_interno_conta
		
union

		select	1
		from	lote_audit_hist_guia x
		where	x.nr_interno_conta	= d.nr_interno_conta)
	and	e.cd_estabelecimento	= f.cd_estabelecimento
	and	d.nr_atendimento	= e.nr_atendimento
	and (c.nr_interno_conta = d.nr_interno_conta or c.nr_seq_protocolo = d.nr_seq_protocolo)
	and	a.nr_seq_protocolo	= c.nr_seq_protocolo
	and	a.cd_convenio		= b.cd_convenio
	) w
where	w.cd_categoria	= z.cd_categoria
and	w.cd_convenio	= z.cd_convenio
group by	w.cd_convenio,
	w.ie_tipo_convenio,
	w.ie_tipo_atendimento,
	w.cd_categoria,
	z.ds_categoria,
	w.cd_empresa,
	w.cd_estabelecimento,
	w.dt_referencia,
	w.dt_mesano_referencia;

