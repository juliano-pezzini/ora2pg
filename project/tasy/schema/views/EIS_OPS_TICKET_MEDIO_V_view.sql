-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_ticket_medio_v (dt_mes_competencia, cd_estabelecimento, qt_segurado, vl_receitas, vl_ticket_receita, vl_custo, vl_ticket_custo) AS select	dt_mes_competencia,
	cd_estabelecimento,
	qt_segurado,
	vl_receitas,
	dividir(vl_receitas, qt_segurado) vl_ticket_receita,
	vl_custo,
	dividir(vl_custo, qt_segurado) vl_ticket_custo
FROM (
	select	pkg_date_utils.start_of(d.dt_mes_competencia,'MONTH') dt_mes_competencia,
		a.cd_estabelecimento,
		sum(coalesce(a.vl_mensalidade,0) + coalesce(a.vl_faturado,0) + coalesce(a.vl_taxa,0)) vl_receitas,
		sum(coalesce(a.vl_conta,0) + coalesce(a.vl_reembolso,0) + coalesce(a.vl_ressarcir,0) + coalesce(a.vl_recurso,0) - coalesce(a.vl_coparticipacao,0)) vl_custo,
		count(distinct a.nr_seq_segurado) qt_segurado
	from	pls_ar_dados_v a,
		pls_ar_lote d,
		pls_segurado s
	where	d.nr_sequencia = a.nr_seq_lote
	and	a.nr_seq_segurado = s.nr_sequencia
	group by pkg_date_utils.start_of(d.dt_mes_competencia,'MONTH'), a.cd_estabelecimento
	) alias15;

