-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lote_fornec_bipamento_v (cd_estabelecimento, nr_seq_lote_fornec, cd_pessoa_fisica, nm_pessoa_fisica, nr_atendimento, nr_prescricao, ie_origem, ie_entrada_saida, qt_material, dt_utilizado, cd_material, cd_local_estoque, cd_prescritor, cd_unidade_medida, cd_acao) AS select	b.cd_estabelecimento,
	x.nr_seq_lote_fornec,
	b.cd_pessoa_fisica cd_pessoa_fisica,
	c.nm_pessoa_fisica nm_pessoa_fisica,
	b.nr_atendimento nr_atendimento,
	b.nr_prescricao nr_prescricao,
	'Prescrição' ie_origem,
	'S' ie_entrada_saida,
	sum(coalesce(x.qt_executada, x.qt_material)) qt_material,
	trunc(x.DT_ATENDIMENTO,'dd') dt_utilizado,
	a.cd_material,
	x.cd_local_estoque,
	b.cd_prescritor,
	x.cd_unidade_medida,
	null cd_acao
FROM	pessoa_fisica c,
	prescr_medica b,
	prescr_material a,
	material_atend_paciente x
where	b.cd_pessoa_fisica 	= c.cd_pessoa_fisica
and	a.nr_prescricao    	= b.nr_prescricao
and	a.nr_prescricao	= x.nr_prescricao
and	a.nr_sequencia	= x.nr_sequencia_prescricao
and	x.nr_seq_lote_fornec is not null
group by
	b.cd_estabelecimento,
	x.nr_seq_lote_fornec,
	b.cd_pessoa_fisica,
	c.nm_pessoa_fisica,
	b.nr_atendimento,
	b.nr_prescricao,
	trunc(x.DT_ATENDIMENTO,'dd'),
	a.cd_material,
	x.cd_local_estoque,
	b.cd_prescritor,
	x.cd_unidade_medida;

