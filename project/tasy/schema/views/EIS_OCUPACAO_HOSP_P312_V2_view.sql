-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_hosp_p312_v2 (dt_referencia, cd_estabelecimento, ds_estabelecimento, cd_empresa, cd_setor_atendimento, ds_setor_atendimento, cd_convenio, ds_convenio, cd_unidade_basica, cd_unidade_compl, qt_leito_planejado, qt_leito_instalado, qt_leito_extra, qt_leito_vago, qt_leito_ocupado, qt_leito_bloqueado, qt_leito_desativado, qt_internacao, qt_alta, qt_evasao, qt_desistencia, qt_obito_hospitalar, qt_obito_institucional, qt_trans_interna, qt_trans_externa, qt_leito_dia, qt_ocupado, qt_paciente_dia, qt_obs_hospitalar, qt_saidas, qt_bloq, qt_ex_ocup, qt_desativado, ie_clinica, ds_clinica, cd_agrupamento, ds_agrupamento, cd_tipo_acomodacao, ds_acomodacao, qt_indicegiro, tx_ocup_oper, tx_ocup_oper_312, media_permanen) AS SELECT 	a.dt_referencia,
		a.cd_estabelecimento,
		a.ds_estabelecimento,
		a.cd_empresa,
		a.cd_setor_atendimento,
		a.ds_setor_atendimento,
		a.cd_convenio,
		a.ds_convenio,
		a.cd_unidade_basica,
		a.cd_unidade_compl,
		a.qt_leito_planejado,
		a.qt_leito_instalado,
		a.qt_leito_extra,
		a.qt_leito_vago,
		a.qt_leito_ocupado,
		a.qt_leito_bloqueado,
		a.qt_leito_desativado,
		a.qt_internacao,
		a.qt_alta,
		a.qt_evasao,
		a.qt_desistencia,
		a.qt_obito_hospitalar,
		a.qt_obito_institucional,
		a.qt_trans_interna,
		a.qt_trans_externa,
		a.qt_leito_dia,
		a.qt_ocupado,
		a.qt_paciente_dia,
		a.qt_obs_hospitalar,
		(qt_alta + qt_obito_hospitalar + CASE WHEN a.ie_classif_setor=4 THEN a.qt_trans_interna  ELSE 0 END  +
		CASE WHEN a.ie_obito_institucional='N' THEN  qt_obito_institucional  ELSE 0 END  +
		qt_trans_externa + qt_desistencia + qt_evasao) qt_saidas,
		CASE WHEN a.qt_leito_extra=1 THEN  0  ELSE a.qt_leito_bloqueado END  qt_bloq,
		CASE WHEN a.qt_leito_ocupado=1 THEN  CASE WHEN a.qt_leito_extra=1 THEN  a.qt_leito_extra  ELSE 0 END   ELSE 0 END  qt_ex_ocup,
		CASE WHEN a.qt_leito_extra=1 THEN  0  ELSE a.qt_leito_desativado END  qt_desativado,
		a.ie_clinica,
		a.ds_clinica,
		a.cd_agrupamento,
		coalesce(a.ds_agrupamento,'Sem agrupamento') ds_agrupamento,
		a.cd_tipo_acomodacao,
		coalesce(ds_tipo_acomodacao,'Sem acomodação') ds_acomodacao,
		ROUND((qt_alta + qt_obito_hospitalar + CASE WHEN ie_obito_institucional='N' THEN  qt_obito_institucional  ELSE 0 END  + qt_trans_externa + qt_desistencia + qt_evasao) / (CASE WHEN coalesce(a.qt_leito_vago + a.qt_leito_ocupado,0)=0 THEN  1  ELSE coalesce(a.qt_leito_vago + a.qt_leito_ocupado,0) END )) qt_indiceGiro,
		(DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA))) * 100 tx_ocup_oper,
		CASE WHEN DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA))=0 THEN 1  ELSE DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA)) END  * 100 tx_ocup_oper_312,
		DIVIDIR((QT_PACIENTE_DIA),(qt_alta + qt_obito_hospitalar + CASE WHEN ie_obito_institucional='N' THEN  qt_obito_institucional  ELSE 0 END  + qt_trans_externa + qt_desistencia + qt_evasao)) media_permanen
FROM eis_ocupacao_hospitalar_p312 a;

