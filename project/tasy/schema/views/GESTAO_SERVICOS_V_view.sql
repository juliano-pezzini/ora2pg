-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW gestao_servicos_v (nr_seq_apresent, ie_tipo_item, ds_tipo_item, ds_tipo_item_plural, ie_laboratorio, cd_estabelecimento, nr_atendimento, nr_prescricao, cd_prescritor, nm_prescritor, dt_prescricao, dt_inicio_prescr, dt_validade_prescr, dt_liberacao, dt_lib_horario, cd_setor_prescr, ie_setor_processo_gedipa, nr_seq_item, ie_acm_sn, ie_di, cd_item, ie_origem_proced, nr_seq_proc_interno, ds_item, nr_agrupamento, cd_intervalo, ds_diluente, ds_topografia, ie_assoc_adep, nr_seq_area_prep, nr_seq_lote, nr_seq_processo, nr_seq_horario, dt_horario, qt_pend, cd_um, qt_dose, cd_unidade_medida_dose, ie_via, cd_pessoa_evento, nm_pessoa_evento, dt_liberacao_medico, ie_urgencia, cd_local_estoque, nr_seq_superior, ie_item_superior, ds_justificativa, nr_sequencia_proc, cd_local_estoque_mat, cd_local_estoque_aux, cd_setor_aux, dt_fim_horario) AS select	CASE WHEN b.nr_seq_exame IS NULL THEN  5  ELSE 8 END  nr_seq_apresent,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'P'  ELSE 'L' END  ie_tipo_item,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'Procedimento'  ELSE 'Coleta' END  ds_tipo_item,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'Procedimentos'  ELSE 'Coletas' END  ds_tipo_item_plural,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'N'  ELSE 'S' END  ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	p.nm_pessoa_fisica nm_prescritor,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	a.dt_liberacao,
	c.dt_lib_horario,
	a.cd_setor_atendimento cd_setor_prescr,
	substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
	b.nr_sequencia nr_seq_item,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	'N' ie_di,
	to_char(b.cd_procedimento) cd_item,
	b.ie_origem_proced,
	b.nr_seq_proc_interno,
	CASE WHEN b.nr_seq_exame IS NULL THEN  substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)  ELSE substr(obter_desc_exame(b.nr_seq_exame),1,240) END  ds_item,
	(null)::numeric  nr_agrupamento,
	b.cd_intervalo cd_intervalo,
	null ds_diluente,
	substr(obter_desc_topografia_dor(b.nr_seq_topografia),1,60) ds_topografia,
	substr(obter_se_assoc_proc_adep(b.cd_procedimento,b.ie_origem_proced),1,1) ie_assoc_adep,
	(null)::numeric  nr_seq_area_prep,
	(null)::numeric  nr_seq_lote,
	(null)::numeric  nr_seq_processo,
	c.nr_sequencia nr_seq_horario,
	c.dt_horario,
	1 qt_pend,
	'' cd_um,
	1 qt_dose,
	'' cd_unidade_medida_dose,
	'' ie_via,
	'' cd_pessoa_evento,
	'' nm_pessoa_evento,
	a.dt_liberacao_medico,
	'' ie_urgencia,
	obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
	(null)::numeric  nr_seq_superior,
	null ie_item_superior,
	null ds_justificativa,
	null nr_sequencia_proc,
	null cd_local_estoque_mat,
	obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
	Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
	c.dt_fim_horario
FROM	pessoa_fisica p,
	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a,
	sp_prescr_proc z
where	c.nr_seq_procedimento = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	z.nr_prescricao = b.nr_prescricao
and	z.nr_seq_prescr = b.nr_sequencia
--and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
--and	nvl(c.ie_horario_especial,'N') <> 'S'
and	b.nr_seq_solic_sangue is null
and	b.nr_seq_derivado is null
and	b.nr_seq_prot_glic is null
and	((b.nr_seq_proc_interno is null) or (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'NC'))
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union all

select	5 nr_seq_apresent,
	'E' ie_tipo_item,
	'SAE' ds_tipo_item,
	'SAE' ds_tipo_item_plural,
	'N' ie_laboratorio,
	coalesce(w.cd_estabelecimento,1) cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	substr(obter_nome_pf(a.cd_prescritor),1,80) nm_prescritor,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	a.dt_liberacao,
	c.dt_lib_horario,
	a.cd_setor_atendimento cd_setor_prescr,
	substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
	x.nr_sequencia nr_seq_item,
	coalesce(x.ie_se_necessario,'N') ie_acm_sn,
	'N' ie_di,
	to_char(y.nr_sequencia) cd_item,
	null ie_origem_proced,
	null nr_seq_proc_interno,
	y.ds_procedimento ds_item,
	(null)::numeric  nr_agrupamento,
	x.cd_intervalo cd_intervalo,
	null ds_diluente,
	null ds_topografia,
	null ie_assoc_adep,
	(null)::numeric  nr_seq_area_prep,
	(null)::numeric  nr_seq_lote,
	(null)::numeric  nr_seq_processo,
	c.nr_sequencia nr_seq_horario,
	c.dt_horario,
	1 qt_pend,
	'' cd_um,
	1 qt_dose,
	'' cd_unidade_medida_dose,
	'' ie_via,
	'' cd_pessoa_evento,
	'' nm_pessoa_evento,
	a.dt_liberacao,
	'' ie_urgencia,
	obter_local_estoque_setor(a.cd_setor_atendimento, coalesce(w.cd_estabelecimento,1)) cd_local_estoque,
	(null)::numeric  nr_seq_superior,
	null ie_item_superior,
	null ds_justificativa,
	null nr_sequencia_proc,
	null cd_local_estoque_mat,
	null cd_local_estoque_aux,
	Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
	c.dt_fim_horario
FROM pe_procedimento y, sp_prescr_proc s, pe_prescr_proc_hor c, pe_prescricao a, pe_prescr_proc x
LEFT OUTER JOIN intervalo_prescricao w ON (x.cd_intervalo = w.cd_intervalo)
WHERE y.nr_sequencia = x.nr_seq_proc and y.nr_sequencia = c.nr_seq_proc and x.nr_seq_prescr = c.nr_seq_pe_prescr and x.nr_sequencia = c.nr_seq_pe_proc and x.nr_seq_prescr = a.nr_sequencia and c.nr_seq_pe_prescr = a.nr_sequencia and s.nr_seq_pe_prescr = a.nr_sequencia and s.nr_seq_proc_interv = x.nr_sequencia and a.dt_liberacao is not null and x.dt_suspensao is null and coalesce(x.ie_adep,'S') = 'S' and coalesce(a.ie_situacao,'A') = 'A' --and	((nvl(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario is not null))
;

