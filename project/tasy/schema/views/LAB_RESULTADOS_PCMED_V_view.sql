-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_resultados_pcmed_v (cd_tipo_registro, ie_registro, cd_empresa, id_pac_emp, nr_prescricao, nr_seq_prescr, nr_requisicao_ext, nr_amostra, nr_seq_grupo, ds_metodo, dt_aprovacao, dt_liberacao, nm_medico, ds_observacao, nr_seq_lote, cd_exame, ds_resultado, ds_referencia, qt_resultado, qt_minimo_ref, qt_maximo_ref, ds_unidade, qt_exames, qt_resultados, tot_prob, nr_checksum) AS select	distinct
	10 cd_tipo_registro,
	'#EX' ie_registro,
	'052' cd_empresa,
	substr(obter_pf_codigo_externo('PC',b.cd_pessoa_fisica),1,20) id_pac_emp,
	b.nr_prescricao,
	c.nr_sequencia nr_seq_prescr,
	a.nr_requisicao_ext,
	b.nr_prescricao nr_amostra,
	d.cd_exame nr_seq_grupo,
	substr(obter_metodo_exame_lab(a.nr_seq_metodo,2),1,70) ds_metodo,
	to_char(a.dt_aprovacao,'yyyymmdd') dt_aprovacao,
	to_char(b.dt_liberacao,'yyyymmdd') dt_liberacao,
	substr(obter_nome_pf(a.cd_medico_resp),1,70) nm_medico,
	substr(CASE WHEN lab_obter_obs_pcmed(c.nr_prescricao, c.nr_sequencia)='' THEN remover_char_espec_pcmed(c.ds_observacao)  ELSE trim(both lab_obter_obs_pcmed(c.nr_prescricao, c.nr_sequencia)) END ,1,420) ds_observacao,
	a.nr_seq_lote,
	null cd_exame,
	'' ds_resultado,
	'' ds_referencia,
	null qt_resultado,
	null qt_minimo_ref,
	null qt_maximo_ref,
	'' ds_unidade,
	0 qt_exames,
	0 qt_resultados,
	null tot_prob,
	calcula_checksum_pcmed('#EX|052|'||substr(obter_pf_codigo_externo('PC',b.cd_pessoa_fisica),1,11)||'|'||coalesce(a.nr_requisicao_ext,0)||'|'||coalesce(b.nr_prescricao,0)||'|'||
		d.cd_exame||'|'||substr(obter_metodo_exame_lab(a.nr_seq_metodo,2),1,70)||'|'||to_char(a.dt_aprovacao,'yyyymmdd')||'|'||to_char(b.dt_liberacao,'yyyymmdd')||'|'||
		substr(obter_nome_pf(a.cd_medico_resp),1,70)||'|'||substr(CASE WHEN lab_obter_obs_pcmed(c.nr_prescricao, c.nr_sequencia)='' THEN remover_char_espec_pcmed(c.ds_observacao)  ELSE trim(both lab_obter_obs_pcmed(c.nr_prescricao, c.nr_sequencia)) END ,1,420)||'|')||'#' nr_checksum
FROM	exame_laboratorio d,
	lab_lote_result_item a,
	prescr_medica b,
	prescr_procedimento c
where	a.nr_prescricao = b.nr_prescricao
and	a.nr_prescricao = c.nr_prescricao
and	a.nr_seq_prescr = c.nr_sequencia
and	d.nr_seq_exame	= c.nr_seq_exame
 and 	exists (select distinct 1
 	from lab_exame_equip
 	where nr_seq_exame = d.nr_seq_exame
 	and ie_padrao = 'S'
 	and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')

union 	all

select  20 cd_tipo_registro,
	'#RA' ie_registro,
	'' cd_empresa,
	null id_pac_emp,
	b.nr_prescricao,
	a.nr_seq_prescr,
	'' nr_requisicao_ext,
	null nr_amostra,
	'' nr_seq_grupo,
	'' ds_metodo,
	'' dt_aprovacao,
	'' dt_liberacao,
	'' nm_medico,
	'' ds_observacao,
	a.nr_seq_lote,
	e.cd_exame,
	d.ds_resultado,
	d.ds_referencia,
	null qt_resultado,
	null qt_minimo_ref,
	null qt_maximo_ref,
	substr(obter_lab_unid_med(e.nr_seq_unid_med,'D'),1,15) ds_unidade,
	0 qt_exames,
	0 qt_resultados,
	null tot_prob,
	calcula_checksum_pcmed('#RA'||'|'||substr(e.cd_exame,1,15)||'|'||substr(d.ds_resultado,1,70)||'|'||substr(obter_lab_unid_med(e.nr_seq_unid_med,'D'),1,15)||'|'||
		substr(d.ds_referencia,1,20)||'|')||'#' nr_checksum
from	lab_lote_result_item a,
	prescr_medica b,
	exame_lab_resultado c,
	exame_lab_result_item d,
	exame_laboratorio e
where	a.nr_prescricao = b.nr_prescricao
and	e.ie_formato_resultado not in ('P','VP','V')
and 	b.nr_prescricao = c.nr_prescricao
and 	c.nr_seq_resultado = d.nr_seq_resultado
and	a.nr_seq_prescr = d.nr_seq_prescr
and 	e.nr_seq_exame = d.nr_seq_exame
and 	((e.nr_seq_superior = a.nr_seq_exame) or (e.nr_seq_exame = a.nr_seq_exame))
 and 	exists (select distinct 1
 	from lab_exame_equip
 	where nr_seq_exame = e.nr_seq_exame
 	and ie_padrao = 'S'
 	and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')

union all

select	30 cd_tipo_registro,
	'#RN' ie_registro,
	'' cd_empresa,
	null id_pac_emp,
	b.nr_prescricao,
	a.nr_seq_prescr,
	'' nr_requisicao_ext,
	null nr_amostra,
	'' nr_seq_grupo,
	'' ds_metodo,
	'' dt_aprovacao,
	'' dt_liberacao,
	'' nm_medico,
	'' ds_observacao,
	a.nr_seq_lote,
	e.cd_exame,
	'' ds_resultado,
	'' ds_referencia,
	replace(CASE WHEN d.qt_resultado IS NULL THEN d.pr_resultado  ELSE d.qt_resultado END ,',','.') qt_resultado,
	d.qt_minima qt_minimo_ref,
	d.qt_maxima qt_maximo_ref,
	substr(obter_lab_unid_med(e.nr_seq_unid_med,'D'),1,15) ds_unidade,
	0 qt_exames,
	0 qt_resultados,
	null tot_prob,
	calcula_checksum_pcmed('#RN'||'|'||substr(e.cd_exame,1,15)||'|'||replace(substr(d.qt_resultado,1,20),',','.')||'|'||substr(obter_lab_unid_med(e.nr_seq_unid_med,'D'),1,15)||'|'||
	substr(d.qt_minima,1,20)||'|'||substr(d.qt_maxima,1,20)||'|')||'#' nr_checksum
from	lab_lote_result_item a,
	prescr_medica b,
	exame_lab_resultado c,
	exame_lab_result_item d,
	exame_laboratorio e
where	a.nr_prescricao = b.nr_prescricao
and	e.ie_formato_resultado in ('P','VP','V')
and 	b.nr_prescricao = c.nr_prescricao
and 	c.nr_seq_resultado = d.nr_seq_resultado
and 	e.nr_seq_exame = d.nr_seq_exame
and 	a.nr_seq_prescr = d.nr_seq_prescr
and 	((e.nr_seq_superior = a.nr_seq_exame) or (e.nr_seq_exame = a.nr_seq_exame))
 and 	exists (select distinct 1
 	from lab_exame_equip
 	where nr_seq_exame = e.nr_seq_exame
 	and ie_padrao = 'S'
 	and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')

union all

select distinct 40 cd_tipo_registro,
	'#TR' ie_registro,
	'' cd_empresa,
	null id_pac_emp,
	null nr_prescricao,
	null nr_seq_prescr,
	'' nr_requisicao_ext,
	null nr_amostra,
	'' nr_seq_grupo,
	'' ds_metodo,
	'' dt_aprovacao,
	'' dt_liberacao,
	'' nm_medico,
	'' ds_observacao,
	a.nr_seq_lote,
	'' cd_exame,
	'' ds_resultado,
	'' ds_referencia,
	null qt_resultado,
	null qt_minimo_ref,
	null qt_maximo_ref,
	'' ds_unidade,
	(select sum(count(distinct e.nr_seq_exame)) qt_exames
	from	lab_lote_result_item x,
			prescr_medica b,
			exame_lab_resultado c,
			exame_lab_result_item d,
			exame_laboratorio e
	where	x.nr_prescricao = b.nr_prescricao
	and 	b.nr_prescricao = c.nr_prescricao
	and 	c.nr_seq_resultado = d.nr_seq_resultado
	and 	x.nr_seq_prescr = d.nr_seq_prescr
	and 	e.nr_seq_exame = d.nr_seq_exame
	and 	((e.nr_seq_superior = x.nr_seq_exame) or (e.nr_seq_exame = x.nr_seq_exame))
	and		x.nr_seq_lote = a.nr_seq_lote
 	and 	exists (select distinct 1
 		from lab_exame_equip
 		where nr_seq_exame = e.nr_seq_exame
 		and ie_padrao = 'S'
 		and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')
	group by 	x.nr_seq_lote, b.nr_prescricao) qt_exames,
	(select sum(count(*)) qt_resultados
	from	lab_lote_result_item x,
			prescr_medica b,
			exame_lab_resultado c,
			exame_lab_result_item d,
			exame_laboratorio e
	where	x.nr_prescricao = b.nr_prescricao
	and 	b.nr_prescricao = c.nr_prescricao
	and 	c.nr_seq_resultado = d.nr_seq_resultado
	and 	x.nr_seq_prescr = d.nr_seq_prescr
	and 	e.nr_seq_exame = d.nr_seq_exame
	and 	((e.nr_seq_superior = x.nr_seq_exame) or (e.nr_seq_exame = x.nr_seq_exame))
	and		x.nr_seq_lote = a.nr_seq_lote
 	and 	exists (select distinct 1
 		from lab_exame_equip
 		where nr_seq_exame = e.nr_seq_exame
 		and ie_padrao = 'S'
 		and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')
	group by 	x.nr_seq_lote, b.nr_prescricao) qt_resultados,
	0 tot_prob,
	calcula_checksum_pcmed('#TR'||'|'||(select  sum(count(distinct e.nr_seq_exame)) qt_exames
						from	lab_lote_result_item x,
								prescr_medica b,
								exame_lab_resultado c,
								exame_lab_result_item d,
								exame_laboratorio e
						where	x.nr_prescricao = b.nr_prescricao
						and 	b.nr_prescricao = c.nr_prescricao
						and 	c.nr_seq_resultado = d.nr_seq_resultado
						and 	x.nr_seq_prescr = d.nr_seq_prescr
						and 	e.nr_seq_exame = d.nr_seq_exame
						and 	((e.nr_seq_superior = x.nr_seq_exame) or (e.nr_seq_exame = x.nr_seq_exame))
						and		x.nr_seq_lote = a.nr_seq_lote
 						and 	exists (select distinct 1
 							from lab_exame_equip
 							where nr_seq_exame = e.nr_seq_exame
 							and ie_padrao = 'S'
 							and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')
						group by 	x.nr_seq_lote, b.nr_prescricao)
				||'|'||(select sum(count(*)) qt_resultados
						from	lab_lote_result_item x,
								prescr_medica b,
								exame_lab_resultado c,
								exame_lab_result_item d,
								exame_laboratorio e
						where	x.nr_prescricao = b.nr_prescricao
						and 	b.nr_prescricao = c.nr_prescricao
						and 	c.nr_seq_resultado = d.nr_seq_resultado
						and 	x.nr_seq_prescr = d.nr_seq_prescr
						and 	e.nr_seq_exame = d.nr_seq_exame
						and 	((e.nr_seq_superior = x.nr_seq_exame) or (e.nr_seq_exame = x.nr_seq_exame))
						and		x.nr_seq_lote = a.nr_seq_lote
 						and 	exists (select distinct 1
 							from lab_exame_equip
 							where nr_seq_exame = e.nr_seq_exame
 							and ie_padrao = 'S'
 							and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')
						group by 	x.nr_seq_lote, b.nr_prescricao)
							||'|'||'0'||'|')||'#' nr_checksum
from	lab_lote_result_item a,
	prescr_medica b,
	exame_lab_resultado c,
	exame_lab_result_item d,
	exame_laboratorio e
where	a.nr_prescricao = b.nr_prescricao
and 	b.nr_prescricao = c.nr_prescricao
and 	c.nr_seq_resultado = d.nr_seq_resultado
and 	a.nr_seq_prescr = d.nr_seq_prescr
and 	e.nr_seq_exame = d.nr_seq_exame
and 	((e.nr_seq_superior = a.nr_seq_exame) or (e.nr_seq_exame = a.nr_seq_exame))
 and 	exists (select distinct 1
 	from lab_exame_equip
 	where nr_seq_exame = e.nr_seq_exame
 	and ie_padrao = 'S'
 	and obter_equipamento_exame(nr_seq_exame,cd_equipamento,'S') = 'PCMED')
group by 	a.nr_seq_lote,
	b.nr_prescricao
order by 	nr_prescricao,nr_seq_prescr, 1;

