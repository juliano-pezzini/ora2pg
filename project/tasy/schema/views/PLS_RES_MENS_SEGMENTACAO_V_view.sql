-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_res_mens_segmentacao_v (ie_reg, dt_mesano_referencia, ds_segmentacao, vl_item_individual, vl_item_coletivo, vl_item_cancelado, vl_item_estorno, vl_antec_estorno, vl_aberto, vl_pro_rata_dia, vl_antecipacao) AS select	1 ie_reg,
	trunc(b.dt_mesano_referencia,'month') dt_mesano_referencia,
	(	select	substr(ds_valor_dominio,1,200)
		FROM	valor_dominio
		where	cd_dominio	= 1665
		and	vl_dominio	= d.ie_segmentacao) ds_segmentacao,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
	sum((	select	coalesce(x.vl_antecipacao,0)
		from	pls_mensalidade_seg_item x,
			pls_mensalidade_segurado y,
			pls_mensalidade		 w
		where	x.nr_sequencia		= a.nr_sequencia
		and	x.nr_seq_mensalidade_seg = y.nr_sequencia
		and	y.nr_seq_mensalidade	= w.nr_sequencia
		and	w.ie_cancelamento	= 'E'
		and	exists (select	1
				from	pls_regra_pro_rata_dia z
				where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
	--sum(decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',a.vl_antecipacao,'12',a.vl_antecipacao,0))) vl_antec_estorno,
	sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
	sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
	sum(a.vl_antecipacao) vl_antecipacao
from	pls_mensalidade_seg_item a,
	pls_mensalidade_segurado b,
	pls_plano		d,
	pls_mensalidade		e,
	pls_lote_mensalidade	f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	b.nr_seq_plano		= d.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	d.ie_tipo_operacao	= 'B'
group by	d.ie_segmentacao,trunc(b.dt_mesano_referencia,'month')

UNION ALL

select	2 ie_reg,
	dt_mes_competencia dt_mesano_referencia,
	'' ds_segmentacao,
	0 vl_item_individual,
	0 vl_item_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,
	0 vl_antec_estorno,
	0 vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_antecipacao
from	pls_competencia

UNION ALL

select	3 ie_reg,
	trunc(b.dt_mesano_referencia,'month') dt_mesano_referencia,
	'Total' ds_plano,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
	sum((	select	coalesce(x.vl_antecipacao,0)
		from	pls_mensalidade_seg_item x,
			pls_mensalidade_segurado y,
			pls_mensalidade		 w
		where	x.nr_sequencia		= a.nr_sequencia
		and	x.nr_seq_mensalidade_seg = y.nr_sequencia
		and	y.nr_seq_mensalidade	= w.nr_sequencia
		and	w.ie_cancelamento	= 'E'
		and	exists (select	1
				from	pls_regra_pro_rata_dia z
				where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
	--sum(decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',a.vl_antecipacao,'12',a.vl_antecipacao,0))) vl_antec_estorno,
	sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
	sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
	sum(a.vl_antecipacao) vl_antecipacao
from	pls_mensalidade_seg_item a,
	pls_mensalidade_segurado b,
	pls_plano		d,
	pls_mensalidade		e,
	pls_lote_mensalidade	f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	d.ie_tipo_operacao	= 'B'
group by	trunc(b.dt_mesano_referencia,'month');

