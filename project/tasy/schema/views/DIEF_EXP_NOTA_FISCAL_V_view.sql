-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW dief_exp_nota_fiscal_v (tp_registro, nr_inscricao_municipal, cd_estabelecimento, nr_nota_fiscal, dt_emissao, cd_especie_documento, cd_serie_nf, ie_tipo_tomador, cd_cpf_cnpj_tomador, nr_autorizacao, ie_destaque, cd_atividade, ie_aliquota, vl_servico, vl_deducao, vl_imposto, vl_total_tributavel, vl_total_nota_fiscal, dt_cancelamento, ds_motivo_cancelamento, nr_item_nf, ie_ordem, nr_sequencia, cd_operacao_nf, ie_situacao, dt_emissao_nota, ie_prestacao_servico, nr_nota_fiscal_final, dt_pagamento) AS select	01 					tp_registro,
	substr(somente_numero(a.cd_inscricao_municipal),1,8) nr_inscricao_municipal, 
	a.cd_estabelecimento			cd_estabelecimento, 
	'0'					nr_nota_fiscal, 
	to_date(null)				dt_emissao, 
	0					cd_especie_documento, 
	''			 		cd_serie_nf, 
	0					ie_tipo_tomador, 
	''					cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	0					vl_servico, 
	0					vl_deducao, 
	0					vl_imposto, 
	0					vl_total_tributavel, 
	0					vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	''					ds_motivo_cancelamento, 
	0					nr_item_nf, 
	0					ie_ordem, 
	0					nr_sequencia, 
	0					cd_operacao_nf, 
	0					ie_situacao, 
	''					dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
FROM	estabelecimento_v a 
where	1=1 

union
 
select	02					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	n.dt_entrada_saida				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  cd_cpf_cnpj_tomador, 
	somente_numero(substr(obter_dados_nota_fiscal(n.nr_sequencia, 18),1,20)) nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	n.vl_total_nota				vl_servico, 
	0					vl_deducao, 
	0					vl_imposto, 
	0					vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	n.ds_observacao				ds_motivo_cancelamento, 
	0					nr_item_nf, 
	1					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	nota_fiscal n 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	n.dt_atualizacao_estoque is not null 
and	n.ie_situacao in ('1','3') 

union
 
select	03					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	to_char((substr(n.nr_nota_fiscal,1,8))::numeric ) nr_nota_fiscal, 
	n.dt_entrada_saida				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	'0'					cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=2 THEN 2 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=3 THEN 3 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=5 THEN  4 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN  2  ELSE 6 END  ie_aliquota, 
	n.vl_total_nota				vl_servico, 
	0					vl_deducao, 
	CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='N' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN (n.vl_total_nota * 0.02)  ELSE Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS') END  END  vl_imposto, 
	0					vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	n.ds_observacao				ds_motivo_cancelamento, 
	0					nr_item_nf, 
	1					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	nota_fiscal n 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	n.dt_atualizacao_estoque is not null 
and	n.ie_situacao in ('1','3') 

union
 
select	04					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	n.dt_entrada_saida				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	0					vl_servico, 
	0					vl_deducao, 
	CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='N' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN (n.vl_total_nota * 0.02)  ELSE Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS') END  END  vl_imposto, 
	0					vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	n.ds_observacao				ds_motivo_cancelamento, 
	0					nr_item_nf, 
	1					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	nota_fiscal n 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	n.dt_atualizacao_estoque is not null 
and	n.ie_situacao in ('1','3') 

union
 
select	05					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	to_char((substr(n.nr_nota_fiscal,1,8))::numeric ) nr_nota_fiscal, 
	n.dt_entrada_saida				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	n.vl_total_nota				vl_servico, 
	0					vl_deducao, 
	CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='N' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN (n.vl_total_nota * 0.02)  ELSE Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS') END  END  vl_imposto, 
	n.vl_total_nota				vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	''					ds_motivo_cancelamento, 
	0					nr_item_nf, 
	2					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	last_day(trunc(n.dt_emissao,'mm')) 	dt_pagamento 
from	nota_fiscal n 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'E' 
and	n.dt_atualizacao_estoque is not null 
and	n.ie_situacao in ('1','3') 

union
 
select	08					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	n.dt_atualizacao				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.ie_situacao=9 THEN  0  ELSE CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END  END  ie_tipo_tomador, 
	CASE WHEN n.ie_situacao=9 THEN  '00000000000000'  ELSE CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  END  cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	n.vl_mercadoria				vl_servico, 
	0					vl_deducao, 
	0					vl_imposto, 
	n.vl_total_nota				vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	dt_atualizacao				dt_cancelamento, 
	coalesce(coalesce(n.ds_observacao, substr(obter_motivo_cancel_oc(n.nr_seq_motivo_cancel),1,255)),'NF Cancelada') ds_motivo_cancelamento, 
	0					nr_item_nf, 
	3					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	CASE WHEN n.ie_situacao=9 THEN  3  ELSE 4 END 			ie_situacao, 
	CASE WHEN n.ie_situacao='9' THEN  '00000000'  ELSE to_char(n.dt_emissao,'DDMMYYYY') END  dt_emissao_nota, 
	CASE WHEN n.ie_situacao=9 THEN  2  ELSE 1 END 	ie_prestacao_servico, 
	CASE WHEN n.ie_situacao='9' THEN  n.nr_nota_fiscal  ELSE '0' END 	nr_nota_fiscal_final, 
	last_day(trunc(n.dt_emissao,'mm')) 	dt_pagamento 
from	nota_fiscal n 
where	n.ie_situacao not in ('1','3') 
and (n.dt_atualizacao_estoque is not null or n.ie_situacao = 9) 

union
 
select	09					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	to_char((substr(n.nr_nota_fiscal,1,8))::numeric ) nr_nota_fiscal, 
	n.dt_atualizacao				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=2 THEN 2 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=3 THEN 3 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=5 THEN  4 WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN  2  ELSE 6 END  ie_aliquota, 
	n.vl_total_nota				vl_servico, 
	0					vl_deducao, 
	CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='N' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS')=0 THEN (n.vl_total_nota * 0.02)  ELSE Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS') END  END  vl_imposto, 
	0					vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	n.ds_observacao				ds_motivo_cancelamento, 
	0					nr_item_nf, 
	3					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	nota_fiscal n 
where	n.ie_situacao not in ('1','3') 
and (n.dt_atualizacao_estoque is not null) 

union
 
select	10					tp_registro, 
	'' 					nr_inscricao_municipal, 
	n.cd_estabelecimento			cd_estabelecimento, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	n.dt_atualizacao				dt_emissao, 
	CASE WHEN n.cd_serie_nf='U' THEN  2 WHEN n.cd_serie_nf='NFS' THEN  1  ELSE 10 END 	cd_especie_documento, 
	substr(n.cd_serie_nf,1,5) 			cd_serie_nf, 
	CASE WHEN n.cd_cgc IS NULL THEN  1  ELSE 2 END 			ie_tipo_tomador, 
	CASE WHEN n.cd_cgc IS NULL THEN  lpad(somente_numero( 		CASE WHEN substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)='99999999999' THEN '00000000000'  ELSE substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11) END ),14,0)  ELSE lpad(n.cd_cgc,14,'0') END  cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	0					vl_servico, 
	0					vl_deducao, 
	0					vl_imposto, 
	0					vl_total_tributavel, 
	n.vl_total_nota				vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	n.ds_observacao				ds_motivo_cancelamento, 
	0					nr_item_nf, 
	3					ie_ordem, 
	n.nr_sequencia, 
	n.cd_operacao_nf, 
	0					ie_situacao, 
	to_char(n.dt_emissao,'DDMMYYYY')		dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	nota_fiscal n 
where	n.ie_situacao not in ('1','3') 
and (n.dt_atualizacao_estoque is not null or n.ie_situacao = 9) 

union
 
select	11 					tp_registro, 
	substr(somente_numero(a.cd_inscricao_municipal),1,8) nr_inscricao_municipal, 
	a.cd_estabelecimento			cd_estabelecimento, 
	'999999999999'				nr_nota_fiscal, 
	to_date(null)				dt_emissao, 
	0					cd_especie_documento, 
	''			 		cd_serie_nf, 
	0					ie_tipo_tomador, 
	''					cd_cpf_cnpj_tomador, 
	0					nr_autorizacao, 
	0					ie_destaque, 
	000000					cd_atividade, 
	0					ie_aliquota, 
	0					vl_servico, 
	0					vl_deducao, 
	0					vl_imposto, 
	0					vl_total_tributavel, 
	0					vl_total_nota_fiscal, 
	to_date(null)				dt_cancelamento, 
	''					ds_motivo_cancelamento, 
	0					nr_item_nf, 
	9					ie_ordem, 
	999999999999				nr_sequencia, 
	0					cd_operacao_nf, 
	0					ie_situacao, 
	''					dt_emissao_nota, 
	0					ie_prestacao_servico, 
	'0'					nr_nota_fiscal_final, 
	to_date(null)				dt_pagamento 
from	estabelecimento_v a 
where	1=1;

