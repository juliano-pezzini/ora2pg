-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_rps_prefeitura_sp (tp_registro, nr_inscricao_municipal, ds_tipo_rps, cd_serie_nf, nr_nota_fiscal, dt_emissao, ie_situacao, vl_servico, vl_descontos, cd_servico, vl_aliquota, ie_iss_retido, ie_cpf_cnpj, cd_cpf_cnpj, nr_inscricao_munic_tomador, nr_inscricao_estad_tomador, nm_tomador, ds_tipo_logradouro, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_estado, cd_cep, ds_email, ds_servicos, vl_total_servicos, vl_total_descontos, qt_linhas, cd_estabelecimento, ds_observacao) AS select	1					tp_registro,
	a.cd_inscricao_municipal		nr_inscricao_municipal,
	''					ds_tipo_rps,
	''					cd_serie_nf,
	'0'					nr_nota_fiscal,
	null					dt_emissao,
	''					ie_situacao,
	0					vl_servico,
	0					vl_descontos,
	''					cd_servico,
	0					vl_aliquota,
	''					ie_iss_retido,
	0					ie_cpf_cnpj,
	''					cd_cpf_cnpj,
	''					nr_inscricao_munic_tomador,
	''					nr_inscricao_estad_tomador,
	''					nm_tomador,
	''					ds_tipo_logradouro,
	''					ds_endereco,
	''					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	''					ds_municipio,
	''					sg_estado,
	''					cd_cep,
	''					ds_email,
	' '					ds_servicos,
	0					vl_total_servicos,
	0					vl_total_descontos,
	0					qt_linhas,
	a.cd_estabelecimento,
	''					ds_observacao
FROM	estabelecimento a

union

select	2					tp_registro,
	''					nr_inscricao_municipal,
	'RPS'					ds_tipo_rps,
	n.cd_serie_nf				cd_serie_nf,
	n.nr_nota_fiscal			nr_nota_fiscal,
	n.dt_emissao				dt_emissao,
	CASE WHEN n.ie_situacao=9 THEN 'C' WHEN n.ie_situacao=1 THEN 'T'  ELSE 'T' END 	ie_situacao,
	n.vl_mercadoria			vl_servico,
	n.vl_descontos			vl_descontos,
	o.nr_codigo_serv_prest		cd_servico,
	0					vl_aliquota,
	to_char(CASE WHEN coalesce((	select	count(*)			from	nota_fiscal_trib a, 				tributo c 			where	a.cd_tributo 	 = c.cd_tributo 			and	c.ie_tipo_tributo= 'ISS' 			and 	a.nr_sequencia 	 = n.nr_sequencia),0)=0 THEN 2  ELSE 1 END ) ie_iss_retido,
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 2  ELSE 1 END 	ie_cpf_cnpj,
	coalesce(substr(obter_cpf_pessoa_fisica(n.cd_pessoa_fisica),1,14),n.cd_cgc) cd_cpf_cnpj,
	substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,20) nr_inscricao_munic_tomador,
	substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20) nr_inscricao_estad_tomador,
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,75) nm_tomador,
	'Rua'					ds_tipo_logradouro,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'E'),1,50) ds_endereco,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),1,10) nr_endereco,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CO'),1,30) ds_complemento,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,30) ds_bairro,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,50) ds_municipio,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2) sg_estado,
	to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15))) cd_cep,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'M'),1,60) ds_email,
	substr(Obter_select_concatenado(
		'select decode(cd_material, null, substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,240),
				substr(obter_desc_material(cd_material),1,100))
		from nota_fiscal_item where nr_sequencia = ' || n.nr_sequencia,null,'|'),1,1000) ds_servicos,
	0					vl_total_servicos,
	0					vl_total_descontos,
	0					qt_linhas,
	n.cd_estabelecimento,
	n.ds_observacao
from	operacao_nota o,
	nota_fiscal n
where	n.ie_situacao = 1
and	o.cd_operacao_nf = n.cd_operacao_nf
and	exists (
	select	1
	from	w_nota_fiscal x
	where	x.nr_seq_nota_fiscal = n.nr_sequencia)

union

select	9					tp_registro,
	''					nr_inscricao_municipal,
	''					ds_tipo_rps,
	''					cd_serie_nf,
	'0'					nr_nota_fiscal,
	null					dt_emissao,
	''					ie_situacao,
	0					vl_servico,
	0					vl_descontos,
	''					cd_servico,
	0					vl_aliquota,
	''					ie_iss_retido,
	0					ie_cpf_cnpj,
	''					cd_cpf_cnpj,
	''					nr_inscricao_munic_tomador,
	''					nr_inscricao_estad_tomador,
	''					nm_tomador,
	''					ds_tipo_logradouro,
	''					ds_endereco,
	''					nr_endereco,
	''					ds_complemento,
	''					ds_bairro,
	''					ds_municipio,
	''					sg_estado,
	''					cd_cep,
	''					ds_email,
	' '					ds_servicos,
	sum(n.vl_mercadoria)			vl_total_servicos,
	sum(n.vl_descontos)			vl_total_descontos,
	0					qt_linhas,
	n.cd_estabelecimento,
	''
from	nota_fiscal n
where	n.ie_situacao = 1
and	exists (
	select	1
	from	w_nota_fiscal x
	where	x.nr_seq_nota_fiscal = n.nr_sequencia)
group by n.cd_estabelecimento;

