-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exportar_notas_caxias_sul_d_v (tp_registro, cnpj_contribuinte, periodo_emissao, nr_funcionarios, vl_folha_pagamento, vl_faturamento_total, nm_responsavel, cpf_responsavel, nr_telefone, ie_entrada_saida, cd_especie, cd_serie_nota, nr_nota_fiscal, ie_situacao, cd_cpf_cnpj_prestador, cd_cpf_cnpj_tomador, dt_emissao, vl_total_nota, vl_deducoes, vl_aliquota, ie_iss_retido, cd_atividade, cd_estabelecimento, ie_tipo_nota, cd_operacao_nf, cd_natureza_operacao, cd_cgc_emitente, cd_serie_nf) AS select
	9 tp_registro, 
	'' cnpj_contribuinte, 
	'' periodo_emissao, 
	'' nr_funcionarios, 
	'' vl_folha_pagamento, 
	'' vl_faturamento_total, 
	'' nm_responsavel, 
	'' cpf_responsavel, 
	'' nr_telefone, 
	substr(obter_se_nota_entrada_saida(nr_sequencia),1,1) ie_entrada_saida, 
	rpad(CASE WHEN cd_serie_nf='S' THEN 'NFSE'  ELSE 'NF' END ,5,' ') cd_especie, 
	rpad(cd_serie_nf,5,' ') cd_serie_nota, 
	lpad(nr_nota_fiscal,10,'0') nr_nota_fiscal, 
	CASE WHEN ie_situacao='1' THEN 'N' WHEN ie_situacao='2' THEN 'N'  ELSE 'C' END  ie_situacao,	 
	rpad(cd_cgc_emitente,15,' ') cd_cpf_cnpj_prestador,		 
	rpad(CASE WHEN obter_se_nota_entrada_saida(nr_sequencia)='E' THEN obter_cgc_estabelecimento(cd_estabelecimento)  ELSE coalesce(cd_cgc,rpad(coalesce(obter_dados_pf_pj(cd_pessoa_fisica,null,'C'),'0'),11,'0')) END ,15,' ') cd_cpf_cnpj_tomador,		 
	to_char(dt_emissao, 'dd/mm/rrrr') dt_emissao, 
	lpad(sip_campo_mascara_virgula(vl_mercadoria),17,'0') vl_total_nota, 
	lpad(vl_descontos,17,0) vl_deducoes, 
	lpad(obter_taxa_iss_nota(nr_sequencia),5,'0') vl_aliquota, 
	substr( 
		CASE WHEN substr(obter_se_nf_retem_iss(nr_sequencia),1,1)='N' THEN 'N'  ELSE CASE WHEN obter_dados_pf_pj(null,cd_cgc_emitente,'CDM')=obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CDM') THEN  'M'  ELSE 'F' END  END 	 
		,1,1) ie_iss_retido, 
	lpad(CASE WHEN obter_se_nota_entrada_saida(nr_sequencia)='E' THEN 0  ELSE 760 END ,8,'0') cd_atividade, 
	cd_estabelecimento, 
	ie_tipo_nota, 
	cd_operacao_nf, 
	cd_natureza_operacao, 
	cd_cgc_emitente, 
	cd_serie_nf 
FROM  	nota_fiscal 
where	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc_emitente,'CDM') = 430510 
and 	((substr(ie_tipo_nota,1,1) = 'E' and ie_situacao = 1) or (substr(ie_tipo_nota,1,1) <> 'E'));

