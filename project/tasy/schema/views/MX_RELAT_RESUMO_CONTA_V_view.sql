-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mx_relat_resumo_conta_v (nr_interno_conta, vl_base_sem_imposto, vl_base_com_imposto, cd_setor_atendimento, ds_setor_atendimento, pr_imposto, ie_emite_conta, ds_emite_conta, vl_adiantamento, vl_adiantamento_pend, vl_desc_sem_imposto, vl_desc_com_imposto, vl_ded_sem_imposto, vl_ded_com_imposto, ds_deducao, ie_conta_deducao) AS select	x.nr_interno_conta,
		CASE WHEN(select count(1) FROM propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 				x.vl_procedimento /*+
				obter_valor_deducao_conv(x.nr_interno_conta,x.nr_sequencia,null,null,'SI') +
				obter_desconto_matproc(x.nr_sequencia,'P') +
				(nvl(x.vl_procedimento,0) * (decode(c.ie_classificacao,1,obter_indice_preco_proc(x.nr_sequencia),obter_indice_preco_servico(x.nr_sequencia))/100))*/				  ELSE 0 END  vl_base_sem_imposto,
		CASE WHEN(select count(1) from propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 0  ELSE x.vl_procedimento /*+
				obter_valor_deducao_conv(x.nr_interno_conta,x.nr_sequencia,null,null,'CI') +
				obter_desconto_matproc(x.nr_sequencia,'P') +
				(nvl(x.vl_procedimento,0) * (decode(c.ie_classificacao,1,obter_indice_preco_proc(x.nr_sequencia),obter_indice_preco_servico(x.nr_sequencia))/100))*/ END vl_base_com_imposto,
		x.cd_setor_atendimento,
		substr(obter_desc_setor_atend(cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	sum(y.pr_imposto) from propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia) pr_imposto,
		x.ie_emite_conta,
		substr(obter_desc_estrut_conta(ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		CASE WHEN(select count(1) from conta_pac_ded_conv_item z where z.nr_seq_propaci_dest = x.nr_sequencia)=0 THEN 'N'  ELSE 'S' END  ie_conta_deducao
from	procedimento c,
		procedimento_paciente x
where	x.cd_procedimento = c.cd_procedimento
and		x.ie_origem_proced	= c.ie_origem_proced
and (x.ie_emite_conta not in ('203') or obter_se_base_wheb = 'S')
and		((x.ie_emite_conta not in ('71') or obter_se_base_wheb = 'S') or x.vl_procedimento <> 0)
and		(x.nr_seq_proc_pacote is null or nr_sequencia = (select nr_seq_procedimento from atendimento_pacote ap where x.nr_sequencia = ap.nr_seq_procedimento))

union all

/* Material */

select	x.nr_interno_conta,
		CASE WHEN(select count(1) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 			x.vl_material /*+
			obter_valor_deducao_conv(x.nr_interno_conta,null,x.nr_sequencia,null,'SI') +
			obter_desconto_matproc(x.nr_sequencia,'M') +
			(NVL(x.vl_material,0) * (obter_indice_preco_material_2(x.nr_sequencia) / 100))*/			  ELSE 0 END  vl_base_sem_imposto,
		CASE WHEN(select count(1) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 0  ELSE x.vl_material /*+
			obter_valor_deducao_conv(x.nr_interno_conta,null,x.nr_sequencia,null,'CI') +
			obter_desconto_matproc(x.nr_sequencia,'M') +
			(NVL(x.vl_material,0) * (obter_indice_preco_material_2(x.nr_sequencia) / 100))*/ END  vl_base_com_imposto,
		x.cd_setor_atendimento,
		substr(obter_desc_setor_atend(cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	sum(y.pr_imposto) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia) pr_imposto,
		x.ie_emite_conta,
		substr(obter_desc_estrut_conta(ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		CASE WHEN(select count(1) from conta_pac_ded_conv_item z where z.nr_seq_matpaci_dest = x.nr_sequencia)=0 THEN 'N'  ELSE 'S' END  ie_conta_deducao
from	material_atend_paciente x
where	x.nr_seq_proc_pacote is null

union all

/* Descontos  - Proc*/

select	x.nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		x.cd_setor_atendimento,
		substr(obter_desc_setor_atend(cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	sum(y.pr_imposto) from propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia) pr_imposto,
		x.ie_emite_conta,
		substr(obter_desc_estrut_conta(ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		CASE WHEN(select count(1) from propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 			CASE WHEN coalesce(obter_vl_item_conta_original(x.nr_sequencia, null),0)=0 THEN MX_OBTER_VALOR_ESTADO_CONTA(x.nr_interno_conta,x.nr_sequencia,null,null,'D')  ELSE ((obter_vl_item_conta_original(x.nr_sequencia, null) * x.qt_procedimento) -					x.vl_procedimento -					obter_desconto_matproc(x.nr_sequencia,'P') -					obter_valor_deducao_conv(x.nr_interno_conta,x.nr_sequencia,null,null,null)) END 			 END  vl_desc_sem_imposto,
		CASE WHEN(select count(1) from propaci_imposto y where y.nr_seq_propaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 			0  ELSE CASE WHEN coalesce(obter_vl_item_conta_original(x.nr_sequencia, null),0)=0 THEN MX_OBTER_VALOR_ESTADO_CONTA(x.nr_interno_conta,x.nr_sequencia,null,null,'D')  ELSE ((obter_vl_item_conta_original(x.nr_sequencia, null) * x.qt_procedimento) -					x.vl_procedimento -					obter_desconto_matproc(x.nr_sequencia,'P') -					obter_valor_deducao_conv(x.nr_interno_conta,x.nr_sequencia,null,null,null)) END  END  vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		CASE WHEN(select count(1) from conta_pac_ded_conv_item z where z.nr_seq_propaci_dest = x.nr_sequencia)=0 THEN 'N'  ELSE 'S' END  ie_conta_deducao
from	procedimento c,
		procedimento_paciente x
where	x.cd_procedimento	= c.cd_procedimento
and		x.ie_origem_proced	= c.ie_origem_proced
and (x.ie_emite_conta not in ('203') or obter_se_base_wheb = 'S')
and		((x.ie_emite_conta not in ('71') or obter_se_base_wheb = 'S') or x.vl_procedimento <> 0)
and		(x.nr_seq_proc_pacote is null or nr_sequencia = (select nr_seq_procedimento from atendimento_pacote ap where x.nr_sequencia = ap.nr_seq_procedimento))

union all

/* Descontos mat */

select	x.nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		x.cd_setor_atendimento,
		substr(obter_desc_setor_atend(cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	sum(y.pr_imposto) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia) pr_imposto,
		x.ie_emite_conta,
		substr(obter_desc_estrut_conta(ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		CASE WHEN(select count(1) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 			CASE WHEN coalesce(obter_vl_item_conta_original(null,x.nr_sequencia),0)=0 THEN MX_OBTER_VALOR_ESTADO_CONTA(x.nr_interno_conta,null,x.nr_sequencia,null,'D')  ELSE ((obter_vl_item_conta_original(null, x.nr_sequencia) * x.qt_material) -					x.vl_material -					obter_desconto_matproc(x.nr_sequencia,'M') -					obter_valor_deducao_conv(x.nr_interno_conta,null,x.nr_sequencia,null,null)) END   ELSE 0 END  vl_desc_sem_imposto,
		CASE WHEN(select count(1) from matpaci_imposto y where y.nr_seq_matpaci = x.nr_sequencia and y.pr_imposto > 0)=0 THEN 			0  ELSE CASE WHEN coalesce(obter_vl_item_conta_original(null,x.nr_sequencia),0)=0 THEN MX_OBTER_VALOR_ESTADO_CONTA(x.nr_interno_conta,null,x.nr_sequencia,null,'D')  ELSE ((obter_vl_item_conta_original(null, x.nr_sequencia) * x.qt_material) -					x.vl_material -					obter_desconto_matproc(x.nr_sequencia,'M') -					obter_valor_deducao_conv(x.nr_interno_conta,null,x.nr_sequencia,null,null)) END  END  vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		CASE WHEN(select count(1) from conta_pac_ded_conv_item z where z.nr_seq_matpaci_dest = x.nr_sequencia)=0 THEN 'N'  ELSE 'S' END  ie_conta_deducao
from	material_atend_paciente x
where	x.nr_seq_proc_pacote is null

union all

/* Coaseguro y deducible  - antigo */

select	a.nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		a.cd_setor_atendimento,
		substr(obter_desc_setor_atend(a.cd_setor_atendimento),1,255) ds_setor_atendimento,
		y.pr_imposto pr_imposto,
		a.ie_emite_conta,
		substr(obter_desc_estrut_conta(a.ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		(a.vl_procedimento - (dividir_sem_round(y.vl_imposto,y.pr_imposto)*100)) vl_ded_sem_imposto,
		(dividir_sem_round(y.vl_imposto,y.pr_imposto)*100) vl_ded_com_imposto,
		substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,155) ds_deducao,
		'N' ie_conta_deducao
FROM conta_log_processamento c, procedimento_paciente a
LEFT OUTER JOIN propaci_imposto y ON (a.nr_sequencia = y.nr_seq_propaci)
WHERE a.nr_sequencia = c.nr_seq_item
union all

/* Coaseguro y deducible  - novo */

select	b.nr_seq_conta_orig nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		c.cd_setor_atendimento,
		substr(obter_desc_setor_atend(c.cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	max(x.pr_imposto)
		from	propaci_imposto x,
				procedimento_paciente y
		where	x.nr_seq_propaci = y.nr_sequencia
		and		y.nr_sequencia = a.nr_seq_propaci_origem) pr_imposto,
		c.ie_emite_conta,
		substr(obter_desc_estrut_conta(c.ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,c.nr_sequencia,null,b.ie_tipo_calculo,'SI') vl_ded_sem_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,c.nr_sequencia,null,b.ie_tipo_calculo,'CI') vl_ded_com_imposto,
		substr(obter_valor_dominio(7408, b.ie_tipo_calculo),1,100) ds_deducao,
		'N' ie_conta_deducao
from	procedimento_paciente c,
		conta_pac_ded_conv_item a,
		conta_pac_deducao_conv b
where	a.nr_seq_deducao_conv	= b.nr_sequencia
and		c.nr_sequencia = a.nr_seq_propaci_origem

union all

select	b.nr_seq_conta_des nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		c.cd_setor_atendimento,
		substr(obter_desc_setor_atend(c.cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	max(x.pr_imposto)
		from	propaci_imposto x,
				procedimento_paciente y
		where	x.nr_seq_propaci = y.nr_sequencia
		and		y.nr_sequencia = a.nr_seq_propaci_dest) pr_imposto,
		c.ie_emite_conta,
		substr(obter_desc_estrut_conta(c.ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,c.nr_sequencia,null,b.ie_tipo_calculo,'SI') vl_ded_sem_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,c.nr_sequencia,null,b.ie_tipo_calculo,'CI') vl_ded_com_imposto,
		substr(obter_valor_dominio(7408, b.ie_tipo_calculo),1,100) ds_deducao,
		'S' ie_conta_deducao
from	procedimento_paciente c,
		conta_pac_ded_conv_item a,
		conta_pac_deducao_conv b
where	a.nr_seq_deducao_conv	= b.nr_sequencia
and		c.nr_sequencia = a.nr_seq_propaci_dest

union all

select	b.nr_seq_conta_orig nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		c.cd_setor_atendimento,
		substr(obter_desc_setor_atend(c.cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	max(x.pr_imposto)
		from	matpaci_imposto x,
				material_atend_paciente y
		where	x.nr_seq_matpaci = y.nr_sequencia
		and		y.nr_sequencia = a.nr_seq_matpaci_origem) pr_imposto,
		c.ie_emite_conta,
		substr(obter_desc_estrut_conta(c.ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,null,c.nr_sequencia,b.ie_tipo_calculo,'SI') vl_ded_sem_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,null,c.nr_sequencia,b.ie_tipo_calculo,'CI') vl_ded_com_imposto,
		substr(obter_valor_dominio(7408, b.ie_tipo_calculo),1,100) ds_deducao,
		'N' ie_conta_deducao
from	material_atend_paciente c,
		conta_pac_ded_conv_item a,
		conta_pac_deducao_conv b
where	a.nr_seq_deducao_conv	= b.nr_sequencia
and		c.nr_sequencia = a.nr_seq_matpaci_origem

union all

select	b.nr_seq_conta_des nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		c.cd_setor_atendimento,
		substr(obter_desc_setor_atend(c.cd_setor_atendimento),1,255) ds_setor_atendimento,
		(select	max(x.pr_imposto)
		from	matpaci_imposto x,
				material_atend_paciente y
		where	x.nr_seq_matpaci = y.nr_sequencia
		and		y.nr_sequencia = a.nr_seq_matpaci_dest) pr_imposto,
		c.ie_emite_conta,
		substr(obter_desc_estrut_conta(c.ie_emite_conta),1,255) ds_emite_conta,
		0 vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,null,c.nr_sequencia,b.ie_tipo_calculo,'SI') vl_ded_sem_imposto,
		obter_valor_deducao_conv(c.nr_interno_conta,null,c.nr_sequencia,b.ie_tipo_calculo,'CI') vl_ded_com_imposto,
		substr(obter_valor_dominio(7408, b.ie_tipo_calculo),1,100) ds_deducao,
		'S' ie_conta_deducao
from	material_atend_paciente c,
		conta_pac_ded_conv_item a,
		conta_pac_deducao_conv b
where	a.nr_seq_deducao_conv	= b.nr_sequencia
and		c.nr_sequencia = a.nr_seq_matpaci_dest
/* Adiantamentos */

union all

select	a.nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		null cd_setor_atendimento,
		null ds_setor_atendimento,
		null pr_imposto,
		null ie_emite_conta,
		null ds_emite_conta,
		coalesce(b.vl_adiantamento,0) vl_adiantamento,
		0 vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		'N' ie_conta_deducao
from	conta_paciente a,
		conta_paciente_adiant b
where	a.nr_interno_conta = b.nr_interno_conta

union all

select	b.nr_interno_conta,
		0 vl_base_sem_imposto,
		0 vl_base_com_imposto,
		null cd_setor_atendimento,
		null ds_setor_atendimento,
		null pr_imposto,
		null ie_emite_conta,
		null ds_emite_conta,
		0 vl_adiantamento,
		coalesce(a.vl_saldo,0) vl_adiantamento_pend,
		0 vl_desc_sem_imposto,
		0 vl_desc_com_imposto,
		0 vl_ded_sem_imposto,
		0 vl_ded_com_imposto,
		null ds_deducao,
		'N' ie_conta_deducao
from	adiantamento a,
		conta_paciente b
where 	a.nr_atendimento = b.nr_atendimento;

