-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cad_prest_tom_novalima_v (tp_registro, dt_ger_arq, insc_mun_contribuente, cnpj_cpf_contribuente, nm_contribuente, seq_arquivo, ver_arquivo, prod, nm_sistema, cgc_cpf_prestador, nm_razaosocial, tp_logradouro, nm_logradouro, numero, ds_complemento, nm_bairro, ds_cep, ds_cidade, ds_estado, ds_pais, ds_fone, opt_spsimples, atv_cadastrada, tp_empresa, ins_mun_prefeitura, dt_cadastro, cd_estabelecimento, dt_emissao) AS SELECT 	DISTINCT
	'0' 				tp_registro, 
	LOCALTIMESTAMP		 	DT_GER_ARQ, 
	a.CD_INSCRICAO_MUNICIPAL  	INSC_MUN_CONTRIBUENTE, 
	a.cd_cgc 			CNPJ_CPF_CONTRIBUENTE, 
	a.ds_razao_social			NM_CONTRIBUENTE, 
	'1'			    	SEQ_ARQUIVO, 
	'0100'				VER_ARQUIVO, 
	'P'			    	PROD, 
	'ISSDIGITAL'			NM_SISTEMA, 
	''				CGC_CPF_PRESTADOR, 
	''				NM_RAZAOSOCIAL, 
	''				TP_LOGRADOURO, 
	''				NM_LOGRADOURO, 
	'' 				NUMERO, 
	''				DS_COMPLEMENTO, 
	''				NM_BAIRRO, 
	''				DS_CEP, 
	''				DS_CIDADE, 
	''				DS_ESTADO, 
	''				DS_PAIS, 
	''				DS_FONE, 
	''				OPT_SPSIMPLES, 
	''				ATV_CADASTRADA, 
	''				TP_EMPRESA, 
	' '				INS_MUN_PREFEITURA, 
	' '				DT_CADASTRO, 
	a.cd_estabelecimento, 
	null   				dt_emissao 
FROM	estabelecimento_v a 

UNION
	 
SELECT 	DISTINCT 
	'1' 				tp_registro, 
	null 	 			DT_GER_ARQ, 
	''	 			INSC_MUN_CONTRIBUENTE, 
	'' 	 			CNPJ_CPF_CONTRIBUENTE, 
	'' 	 			NM_CONTRIBUENTE, 
	''	 			SEQ_ARQUIVO, 
	'' 	 			VER_ARQUIVO, 
	''	 			PROD, 
	'' 	 			NM_SISTEMA, 
	CASE WHEN CD_CGC IS NULL THEN CD_PESSOA_FISICA  ELSE CD_CGC END 	CGC_CPF_PRESTADOR, 
	OBTER_NOME_PF_PJ(cd_pessoa_fisica,cd_cgc) 	NM_RAZAOSOCIAL, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'LO') 		TP_LOGRADOURO, 
    obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'R') 		NM_LOGRADOURO , 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'NR') 	NUMERO, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CO')		DS_COMPLEMENTO, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'B')		NM_BAIRRO, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CEP')	DS_CEP, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CI')		DS_CIDADE,  
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'UF')		DS_ESTADO, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'PAIS')	DS_PAIS, 
	obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'T')		DS_FONE, 
	nfse_obter_regra('OSN',cd_estabelecimento) 		OPT_SPSIMPLES,  
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(nr_sequencia,'P'),obter_procedimento_nfse(NR_SEQUENCIA,'O')) ,'CD') ATV_CADASTRADA, 
	'D'           			TP_EMPRESA, 
	' '			  	INS_MUN_PREFEITURA, 
	' '			  	DT_CADASTRO, 
	cd_estabelecimento, 
	dt_emissao 
FROM	NOTA_FISCAL 
where	substr(obter_se_nota_entrada_saida(nr_sequencia),1,1) = 'S' 

UNION
 
SELECT '9' 				tp_registro, 
	null 			 	DT_GER_ARQ, 
	''	 		 	INSC_MUN_CONTRIBUENTE, 
	'' 	 		 	CNPJ_CPF_CONTRIBUENTE, 
	'' 			 	NM_CONTRIBUENTE, 
	''			 	SEQ_ARQUIVO, 
	'' 			 	VER_ARQUIVO, 
	''	 		 	PROD, 
	'' 	 		 	NM_SISTEMA, 
	''		     		CGC_CPF_PRESTADOR, 
	''			 	NM_RAZAOSOCIAL, 
	''	 		 	TP_LOGRADOURO, 
	''	 		 	NM_LOGRADOURO , 
	''  		 		NUMERO, 
	''  		 		DS_COMPLEMENTO, 
	''			 	NM_BAIRRO, 
	''			 	DS_CEP, 
	''			 	DS_CIDADE,  
	''			 	DS_ESTADO, 
	''			 	DS_PAIS, 
	''			 	DS_FONE, 
	''			 	OPT_SPSIMPLES,  
	''			 	ATV_CADASTRADA, 
	''      	 			TP_EMPRESA, 
	' '			 	INS_MUN_PREFEITURA, 
	' '			 	DT_CADASTRO, 
	a.cd_estabelecimento, 
	null			 	dt_emissao 
FROM	estabelecimento_v a;

