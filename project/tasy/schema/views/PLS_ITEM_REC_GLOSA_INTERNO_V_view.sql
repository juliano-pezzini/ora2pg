-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_item_rec_glosa_interno_v (nr_seq_conta_proc, nr_seq_conta_mat, nr_seq_conta, cd_item, ie_origem_proced, nr_seq_material, qt_item_imp, vl_item_imp, qt_item, vl_liberado, ds_item, vl_glosa, nm_beneficiario, cd_guia, cd_guia_referencia, nm_prestador, dt_recebimento, dt_emissao, nr_seq_prestador_exec, nr_seq_protocolo, cd_guia_prest_pesquisa, ie_tipo_item, ds_tipo_item, cd_estabelecimento, cd_guia_pesquisa, cd_guia_ref_pesquisa, nr_seq_segurado) AS select	a.nr_sequencia nr_seq_conta_proc,
	null nr_seq_conta_mat,
	a.nr_seq_conta,
	to_char(a.cd_procedimento) cd_item,
	a.ie_origem_proced,
	null nr_seq_material,
	a.qt_procedimento_imp qt_item_imp,
	a.vl_procedimento_imp vl_item_imp,
	a.qt_procedimento qt_item,
	a.vl_liberado,
	substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_item,
	a.vl_glosa,
	substr(obter_nome_pf(b.cd_pessoa_fisica),1,255) nm_beneficiario,
	w.cd_guia,
	w.cd_guia_referencia,
	substr(pls_obter_dados_prestador(w.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
	c.dt_recebimento,
	w.dt_atendimento_referencia dt_emissao,
	w.nr_seq_prestador_exec,
	w.nr_seq_protocolo,
	w.cd_guia_prest_pesquisa,
	'P' ie_tipo_item,
	'Procedimentos' ds_tipo_item,
	c.cd_estabelecimento,
	w.cd_guia_pesquisa,
	w.cd_guia_ref_pesquisa,
	w.nr_seq_segurado
FROM	pls_conta_proc		a,
	pls_conta		w,
	pls_segurado		b,
	pls_protocolo_conta	c
where	w.nr_sequencia	= a.nr_seq_conta
and	b.nr_sequencia	= w.nr_seq_segurado
and	c.nr_sequencia	= w.nr_seq_protocolo
and	pls_obter_recursa_item_regra(a.nr_sequencia,w.nr_sequencia,w.nr_seq_prestador_exec,'P') = 'S'
and	not exists (select	1
		from	w_pls_recurso_glosa x
		where	x.nr_seq_conta_proc = a.nr_sequencia
		and	x.ie_tipo_inclusao = 'P')
and	exists	(select	1
		from	pls_conta_medica_resumo d
		where	w.nr_sequencia	= d.nr_seq_conta
		and	((d.nr_seq_lote_pgto is not null) or (nr_seq_pp_lote is not null)))
and	a.vl_glosa > 0
and	w.vl_glosa > 0

union all

select	null nr_seq_conta_proc,
	a.nr_sequencia nr_seq_conta_mat,
	a.nr_seq_conta,
	substr(pls_obter_seq_codigo_material(a.nr_seq_material,null),1,255) cd_item,
	null ie_origem_proced,
	a.nr_seq_material,
	a.qt_material_imp qt_item_imp,
	a.vl_material_imp vl_item_imp,
	a.qt_material qt_item,
	a.vl_liberado,
	substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',a.nr_seq_material),1,255) ds_item,
	a.vl_glosa,
	substr(obter_nome_pf(b.cd_pessoa_fisica),1,255) nm_beneficiario,
	w.cd_guia,
	w.cd_guia_referencia,
	substr(pls_obter_dados_prestador(w.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
	c.dt_recebimento,
	w.dt_atendimento_referencia dt_emissao,
	w.nr_seq_prestador_exec,
	w.nr_seq_protocolo,
	w.cd_guia_prest_pesquisa,
	'M' ie_tipo_item,
	'Materiais' ds_tipo_item,
	c.cd_estabelecimento,
	w.cd_guia_pesquisa,
	w.cd_guia_ref_pesquisa,
	w.nr_seq_segurado
from	pls_conta_mat		a,
	pls_conta		w,
	pls_segurado		b,
	pls_protocolo_conta	c
where	w.nr_sequencia	= a.nr_seq_conta
and	b.nr_sequencia	= w.nr_seq_segurado
and	c.nr_sequencia	= w.nr_seq_protocolo
and	pls_obter_recursa_item_regra(a.nr_sequencia,w.nr_sequencia,w.nr_seq_prestador_exec,'S') = 'S'
and	not exists (select	1
		from	w_pls_recurso_glosa x
		where	x.nr_seq_conta_mat = a.nr_sequencia
		and	x.ie_tipo_inclusao = 'M')
and	exists	(select	1
		from	pls_conta_medica_resumo d
		where	w.nr_sequencia	= d.nr_seq_conta
		and	((d.nr_seq_lote_pgto is not null) or (nr_seq_pp_lote is not null)))
and	a.vl_glosa > 0
and	w.vl_glosa > 0;

