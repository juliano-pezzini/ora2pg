-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW receita_conta_paciente_v2 (dt_entrada_unidade, nr_atendimento, ie_proc_mat, dt_conta, dt_item, cd_item, qt_item, vl_item, vl_medico, vl_anestesista, vl_filme, vl_auxiliares, vl_custo_operacional, nr_interno_conta, dt_acerto_conta, dt_acerto_convenio, cd_convenio_parametro, cd_categoria, cd_setor_atendimento, cd_motivo_exc_conta, vl_unitario, cd_conta_contabil, nr_lote_contabil, ds_conta_receita, dt_mesano_referencia, dt_mesano_contabil, nr_seq_propaci, nr_seq_matpaci, vl_repasse, cd_medico_executor) AS select	to_date(to_char(a.dt_entrada_unidade, 'DD/MM/YYYY'),'DD/MM/YYYY') dt_entrada_unidade,
	a.nr_atendimento,
	1 ie_proc_mat,
	a.dt_conta,
	a.dt_procedimento      dt_item,
	a.cd_procedimento      cd_item,
	a.qt_procedimento      qt_item,
	a.vl_procedimento      vl_item,
	a.vl_medico            vl_medico,
	a.vl_anestesista       vl_anestesista,
	a.vl_materiais         vl_filme,
	a.vl_auxiliares        vl_auxiliares,
	a.vl_custo_operacional vl_custo_operacional,
	a.nr_interno_conta,
	a.dt_acerto_conta,
	a.dt_acerto_convenio,
	d.cd_convenio_parametro,
	a.cd_categoria,
	a.cd_setor_atendimento,
	a.cd_motivo_exc_conta,
	(a.vl_procedimento / CASE WHEN a.qt_procedimento=0 THEN 1  ELSE a.qt_procedimento END ) vl_unitario,
	a.cd_conta_contabil,
	a.nr_lote_contabil,
	c.ds_conta_contabil    ds_conta_receita,
	d.dt_mesano_referencia,
	d.dt_mesano_contabil,
	a.nr_sequencia nr_seq_propaci,
	null nr_seq_matpaci,
	coalesce(Obter_Valor_Repasse_Item(a.nr_sequencia,'P'),0) vl_repasse,
	a.cd_medico_executor
FROM	conta_contabil c,
	conta_paciente d,
	procedimento_paciente a
where (a.cd_conta_contabil	  = c.cd_conta_contabil)
and (a.nr_interno_conta	  = d.nr_interno_conta)

union all

select	to_date(to_char(x.dt_entrada_unidade, 'DD/MM/YYYY'),'DD/MM/YYYY') dt_entrada_unidade,
	x.nr_atendimento,
	2 ie_proc_mat,
	x.dt_conta,
	x.dt_atendimento	dt_item,
	x.cd_material		cd_item,
	x.qt_material		qt_item,
	x.vl_material		vl_item,
	0			vl_medico,
	0			vl_anestesista,
	0			vl_filme,
	0			vl_auxiliares,
	0			vl_custo_operacional,
	x.nr_interno_conta,
	x.dt_acerto_conta,
	x.dt_acerto_convenio,
	z.cd_convenio_parametro,
	x.cd_categoria,
	x.cd_setor_atendimento,
	x.cd_motivo_exc_conta,
	x.vl_unitario,
	x.cd_conta_contabil,
	x.nr_lote_contabil,
	y.ds_conta_contabil	ds_conta_receita,
	z.dt_mesano_referencia,
	z.dt_mesano_contabil,
	null nr_Seq_propaci,
	x.nr_sequencia nr_seq_matpaci,
	coalesce(Obter_Valor_Repasse_Item(x.nr_sequencia,'M'),0) vl_repasse,
	'' cd_medico_executor
from	conta_contabil y,
	conta_paciente z,
	material_atend_paciente x
where (x.cd_conta_contabil = y.cd_conta_contabil)
and (x.nr_interno_conta	= z.nr_interno_conta);

