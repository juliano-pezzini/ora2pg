-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sus_cih_v (nr_atendimento, cd_estabelecimento, cd_pessoa_fisica, dt_entrada, ie_tipo_atendimento, dt_alta, cd_motivo_alta, ie_tipo_convenio, nm_paciente, nr_prontuario, dt_nascimento, ie_sexo, nm_logradouro, nr_endereco, ds_complemento, sg_estado_paciente, cd_cep, cd_municipio, cd_cgc, sg_estado_cgc, cd_cep_cgc, ds_bairro_cgc, nr_logradouro_cgc, nm_logradouro_cgc, cd_municipio_cgc, cd_procedimento, ie_origem_proced, cd_cid_primario, cd_cid_secundario, cd_municipio_ibge, cd_cns, cd_ans, ie_fonte_remuneracao, ie_fonte_remuner2, dt_competencia, cd_cnes, ds_procedimento, cd_cnpj, cd_usuario_convenio, nr_declaracao_obito, qt_dias_uti, cd_convenio, dt_inicio_vigencia, cd_categoria, qt_filhos_vivos, doc_nasc1, doc_nasc2, doc_nasc3, doc_nasc4, doc_nasc5, ie_alta_uti) AS SELECT	A.NR_ATENDIMENTO,
	A.CD_ESTABELECIMENTO, 
	A.CD_PESSOA_FISICA, 
    A.DT_ENTRADA, 
    A.IE_TIPO_ATENDIMENTO, 
    A.DT_ALTA, 
	A.CD_MOTIVO_ALTA, 
	A.IE_TIPO_CONVENIO, 
    B.NM_PESSOA_FISICA NM_PACIENTE, 
    B.NR_PRONTUARIO, 
    B.DT_NASCIMENTO, 
    B.IE_SEXO, 
	C.DS_ENDERECO NM_LOGRADOURO, 
	C.NR_ENDERECO, 
	C.DS_COMPLEMENTO, 
	C.SG_ESTADO SG_ESTADO_PACIENTE, 
	REPLACE(C.CD_CEP,'-','') CD_CEP, 
	f.CD_MUNICIPIO_SINPAS CD_MUNICIPIO, 
	E.CD_CGC, 
	E.SG_ESTADO SG_ESTADO_CGC, 
	E.CD_CEP CD_CEP_CGC, 
	E.DS_BAIRRO DS_BAIRRO_CGC, 
	substr(obter_cep_log(E.cd_cep, 'C'),1,250) NR_LOGRADOURO_CGC, 
	substr(obter_cep_log(E.cd_cep, 'D'),1,250) NM_LOGRADOURO_CGC, 
	substr(Obter_Cod_Municipio_IBGE(E.cd_cep),1,250) CD_MUNICIPIO_CGC, 
	g.CD_PROCEDIMENTO, 
	g.IE_ORIGEM_PROCED, 
	g.CD_CID_PRIMARIO, 
	g.CD_CID_SECUNDARIO, 
	C.CD_MUNICIPIO_IBGE, 
	' ' CD_CNS, 
	p.CD_ANS, 
	CASE WHEN A.IE_TIPO_CONVENIO=1 THEN 'P'  ELSE 'C' END  IE_FONTE_REMUNERACAO, 
	CASE WHEN A.IE_TIPO_CONVENIO=1 THEN '2'  ELSE '1' END  IE_FONTE_REMUNER2, 
	A.DT_ALTA_INTERNO DT_COMPETENCIA, 
	substr(to_char(coalesce(SUS_Obter_CNES_Estab(D.cd_estabelecimento),D.cd_cns), '0000000'),2,8) CD_CNES, 
	substr(Obter_Desc_Proc_CIH(g.CD_PROCEDIMENTO, g.nr_atendimento),1,188) ds_procedimento, 
	CASE WHEN A.IE_TIPO_CONVENIO=1 THEN ''  ELSE v.cd_cgc END  cd_cnpj, 
	t.CD_USUARIO_CONVENIO CD_USUARIO_CONVENIO, 
	substr(to_char(Obter_Declaracao_Obito(A.nr_atendimento), '00000000'),2,9) nr_declaracao_obito, 
	CASE WHEN SUS_Obter_Dias_UTI(A.nr_atendimento)=0 THEN  OBTER_DIAS_INTERNACAO_UTI(A.nr_atendimento)  ELSE SUS_Obter_Dias_UTI(A.nr_atendimento) END  QT_DIAS_UTI, 
	t.cd_convenio, 
	t.dt_inicio_vigencia, 
	t.cd_categoria, 
	OBTER_QT_NASCIDOS_CIH(g.CD_PROCEDIMENTO,A.nr_atendimento) qt_filhos_vivos, 
	OBTER_DNV_NASCIDOS_CIH(g.CD_PROCEDIMENTO,1,A.nr_atendimento) doc_nasc1, 
	OBTER_DNV_NASCIDOS_CIH(g.CD_PROCEDIMENTO,2,A.nr_atendimento) doc_nasc2, 
	OBTER_DNV_NASCIDOS_CIH(g.CD_PROCEDIMENTO,3,A.nr_atendimento) doc_nasc3, 
	OBTER_DNV_NASCIDOS_CIH(g.CD_PROCEDIMENTO,4,A.nr_atendimento) doc_nasc4, 
	OBTER_DNV_NASCIDOS_CIH(g.CD_PROCEDIMENTO,5,A.nr_atendimento) doc_nasc5, 
	substr(OBTER_SE_ALTA_UTI(A.nr_atendimento), 1,1) ie_alta_uti 
FROM convenio v, atend_categoria_convenio t, pessoa_juridica p, pessoa_juridica e, estabelecimento d, pessoa_fisica b
LEFT OUTER JOIN compl_pessoa_fisica c ON (B.CD_PESSOA_FISICA = C.CD_PESSOA_FISICA AND 1 = C.IE_TIPO_COMPLEMENTO)
LEFT OUTER JOIN sus_municipio f ON (C.CD_MUNICIPIO_IBGE = f.CD_MUNICIPIO_IBGE)
, atendimento_paciente a
LEFT OUTER JOIN procedimento_paciente_cih g ON (A.NR_ATENDIMENTO = g.NR_ATENDIMENTO)
WHERE A.CD_PESSOA_FISICA 		= B.CD_PESSOA_FISICA    AND coalesce(A.IE_TIPO_CONVENIO,1)	<> 3 AND A.CD_ESTABELECIMENTO		= D.CD_ESTABELECIMENTO AND D.CD_CGC			= E.CD_CGC  and A.nr_atendimento		= t.nr_atendimento and t.cd_convenio			= v.cd_convenio and v.cd_cgc			= p.cd_cgc and t.dt_inicio_vigencia= 
	(select max(dt_inicio_vigencia) 
	from atend_categoria_convenio b 
	where nr_atendimento 		= A.nr_atendimento) AND EXISTS (SELECT	1 
       	FROM		SETOR_ATENDIMENTO Y, 
				ATEND_PACIENTE_UNIDADE Z 
		WHERE		Z.CD_SETOR_ATENDIMENTO = Y.CD_SETOR_ATENDIMENTO 
		AND		A.NR_ATENDIMENTO    = Z.NR_ATENDIMENTO 
		AND		Y.CD_CLASSIF_SETOR IN (3,4,8));

