-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_retorno_convenio_glosa_v (vl_pago, vl_naceito, vl_aceito, vl_glosa, vl_cobrado, vl_conta, ds_convenio, cd_convenio, ds_tipo_convenio, ie_tipo_convenio, dt_referencia, dt_baixa_cr, cd_empresa, ie_tipo_atendimento, ds_tipo_atendimento, cd_categoria, ds_categoria, cd_motivo_glosa, ds_motivo_glosa, cd_setor_atendimento, cd_setor_responsavel, ds_setor_atendimento, ds_setor_responsavel, nm_usuario_retorno, nr_seq_retorno, ds_historico, nr_seq_historico, nm_conta_paciente, dt_vencimento) AS select	coalesce(g.vl_pago_digitado,(obter_dados_ret_movto_glosa(g.nr_sequencia, 3))::numeric ) vl_pago,
	CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='R' THEN g.vl_glosa  ELSE 0 END  vl_naceito,
	CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='A' THEN g.vl_glosa  ELSE 0 END  vl_aceito,
	(CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='R' THEN g.vl_glosa  ELSE 0 END  + CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='A' THEN g.vl_glosa  ELSE 0 END ) vl_glosa,
	coalesce(g.vl_cobrado,0) vl_cobrado,
	0 vl_conta,--b.vl_conta,
	null ds_convenio,
	null cd_convenio,
	null ds_tipo_convenio,
	null ie_tipo_convenio,
	trunc(c.dt_retorno) dt_referencia,
	trunc(c.dt_baixa_cr) dt_baixa_cr,
	substr(obter_empresa_estab(b.cd_estabelecimento),1,255) cd_empresa,
	e.ie_tipo_atendimento,
	substr(obter_valor_dominio(12,ie_tipo_atendimento),1,255) ds_tipo_atendimento,
	f.cd_categoria,
	(substr(obter_nome_convenio(b.cd_convenio_parametro),1,150) || ' - ' || f.ds_categoria) ds_categoria,
	g.cd_motivo_glosa,
	coalesce(h.ds_motivo_glosa,'NÃ£o Informado') ds_motivo_glosa,
	g.cd_setor_atendimento,
	g.cd_setor_responsavel,
	substr(obter_dados_setor(g.cd_setor_atendimento,'DS'),1,255) ds_setor_atendimento,
	substr(obter_dados_setor(g.cd_setor_responsavel,'DS'),1,255) ds_setor_responsavel,
	c.nm_usuario_retorno,
	c.NR_SEQUENCIA NR_SEQ_RETORNO,
	substr(obter_dado_conpaci_ret_hist(g.nr_seq_conpaci_ret_hist,'DS_HISTORICO'),1,255) ds_historico,
	(obter_dado_conpaci_ret_hist(g.nr_seq_conpaci_ret_hist,'NR_SEQ_HISTORICO'))::numeric  nr_seq_historico,
	substr(b.nr_interno_conta||' - '||obter_nome_pf_pj(e.cd_pessoa_fisica,null),1,255) nm_conta_paciente,
	to_date(obter_dados_titulo_receber(a.nr_titulo,'D'),'dd/mm/yyyy') dt_vencimento
FROM 	motivo_glosa h,
	categoria_convenio f,
	atendimento_paciente e,
	conta_paciente b,
	convenio_retorno_glosa g,
	convenio_retorno_item a,
	convenio_retorno c
where	a.nr_interno_conta 	= b.nr_interno_conta
and	c.cd_convenio		= b.cd_convenio_parametro
and	a.nr_Seq_retorno 		= c.nr_sequencia
and	b.nr_atendimento		= e.nr_atendimento
and	c.cd_convenio		= f.cd_convenio
and	b.cd_categoria_parametro 	= f.cd_categoria
and	g.nr_seq_ret_item		= a.nr_sequencia
and	g.cd_motivo_glosa		= h.cd_motivo_glosa

union all

select	coalesce(g.vl_pago_digitado,(obter_dados_ret_movto_glosa(g.nr_sequencia, 3))::numeric ) vl_pago,
	CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='R' THEN g.vl_glosa  ELSE 0 END  vl_naceito,
	CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='A' THEN g.vl_glosa  ELSE 0 END  vl_aceito,
	(CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='R' THEN g.vl_glosa  ELSE 0 END  + CASE WHEN coalesce(g.ie_acao_glosa,h.ie_acao_glosa)='A' THEN g.vl_glosa  ELSE 0 END ) vl_glosa,
	coalesce(g.vl_cobrado,0) vl_cobrado,
	0 vl_conta, --b.vl_conta,
	substr(obter_nome_convenio(d.cd_convenio),1,255) ds_convenio,
	d.cd_convenio cd_convenio,
	substr(OBTER_VALOR_DOMINIO(11,d.ie_tipo_convenio),1,255) ds_tipo_convenio,
	d.ie_tipo_convenio ie_tipo_convenio,
	trunc(c.dt_retorno) dt_referencia,
	trunc(c.dt_baixa_cr) dt_baixa_cr,
	substr(obter_empresa_estab(b.cd_estabelecimento),1,255) cd_empresa,
	null ie_tipo_atendimento,
	null  ds_tipo_atendimento,
	null cd_categoria,
	null ds_categoria,
	0 cd_motivo_glosa,
	null ds_motivo_glosa,
	null cd_setor_atendimento,
	null cd_setor_responsavel,
	null ds_setor_atendimento,
	null ds_setor_responsavel,
	null nm_usuario_retorno,
	c.NR_SEQUENCIA NR_SEQ_RETORNO,
	null ds_historico,
	null nr_seq_historico,
	null nm_conta_paciente,
	null dt_vencimento
from 	motivo_glosa h,
	categoria_convenio f,
	convenio d,
	atendimento_paciente e,
	conta_paciente b,
	convenio_retorno_glosa g,
	convenio_retorno_item a,
	convenio_retorno c
where	b.cd_convenio_parametro	= c.cd_convenio
and	c.cd_convenio		= d.cd_convenio
and	a.nr_interno_conta 	= b.nr_interno_conta
and	a.nr_Seq_retorno 		= c.nr_sequencia
and	b.nr_atendimento		= e.nr_atendimento
and	c.cd_convenio		= f.cd_convenio
and	b.cd_categoria_parametro 	= f.cd_categoria
and	g.nr_seq_ret_item		= a.nr_sequencia
and	g.cd_motivo_glosa		= h.cd_motivo_glosa;

