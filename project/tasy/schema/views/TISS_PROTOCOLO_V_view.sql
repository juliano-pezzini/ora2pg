-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_protocolo_v (ds_registro, tp_registro, ie_servico, cd_registro, cd_origem, nr_lote, nr_interno_conta, nr_parcela, cd_convenio, nm_convenio, tp_prestador, cd_prestador, nm_prestador, dt_geracao, nr_remessa, cd_plano, cd_paciente, cd_autorizacao, cd_acomodacao, dt_entrada, dt_saida, dt_inicio_cobranca, dt_fim_cobranca, ie_tipo_atendimento, cd_cid, cd_proc_principal, cd_medico_convenio, nr_crm, uf_crm, nr_crm_req, uf_crm_req, nr_seq_item, cd_item, nm_item, ie_emergencia, ie_extra, dt_item, ie_funcao_medico, qt_item, vl_item, ie_cirurgia_multipla, vl_total_item, qt_item_conta, nm_paciente, nr_fatura, qt_conta, vl_total_lote, nr_seq_protocolo, ds_espaco, nr_registro, ie_matmed, ds_ma_me_tx, ie_tipo_atend_esp, ie_tipo_atend_tasy, dt_procedimento, cd_edicao_amb, cd_procedimento, cd_ans, dt_validade_carteira, nm_pessoa_fisica, nr_cartao_nac_sus, nr_atendimento, cd_pessoa_fisica) AS SELECT		'CABECALHO CONTA   '		DS_REGISTRO,
		2					TP_REGISTRO, 
		'CSMH'					IE_SERVICO, 
		1					CD_REGISTRO, 
		0					CD_ORIGEM, 
		b.NR_SEQ_PROTOCOLO			NR_LOTE, 
		b.NR_INTERNO_CONTA			NR_INTERNO_CONTA, 
		1					NR_PARCELA, 
		0					CD_CONVENIO, 
		' '					NM_CONVENIO, 
		'J'					TP_PRESTADOR, 
		f.cd_cgc_hospital			CD_PRESTADOR, 
		f.nm_hospital			 	NM_PRESTADOR, 
		LOCALTIMESTAMP					DT_GERACAO, 
		1					NR_REMESSA, 
		b.CD_PLANO_CONVENIO			CD_PLANO, 
		substr(b.CD_USUARIO_CONVENIO,1,18)	CD_PACIENTE,		 
		substr(h.cd_autorizacao,1,10)		CD_AUTORIZACAO, 
		b.CD_TIPO_ACOMODACAO			CD_ACOMODACAO, 
		b.DT_ENTRADA				DT_ENTRADA, 
		coalesce(b.DT_ALTA,b.DT_PERIODO_FINAL)	DT_SAIDA, 
		b.DT_PERIODO_INICIAL			DT_INICIO_COBRANCA, 
		coalesce(b.DT_ALTA,b.DT_PERIODO_FINAL)	DT_FIM_COBRANCA, 
		b.IE_CLINICA				IE_TIPO_ATENDIMENTO, 
		b.CD_CID_PRINCIPAL			CD_CID, 
		b.CD_PROC_PRINCIPAL			CD_PROC_PRINCIPAL, 
		b.CD_CONV_MEDICO_RESP		CD_MEDICO_CONVENIO, 
		b.NR_CRM_MEDICO_RESP			NR_CRM, 
		b.UF_CRM_MEDICO_RESP			UF_CRM, 
		b.NR_CRM_MEDICO_RESP			NR_CRM_REQ, 
		b.UF_CRM_MEDICO_RESP			UF_CRM_REQ, 
		1					NR_SEQ_ITEM, 
		' '					CD_ITEM, 
		' '					NM_ITEM, 
		' '					IE_EMERGENCIA, 
		' '					IE_EXTRA, 
		LOCALTIMESTAMP				DT_ITEM, 
		0					IE_FUNCAO_MEDICO, 
		0					QT_ITEM, 
		0					VL_ITEM, 
		0					IE_CIRURGIA_MULTIPLA, 
      	0	   				VL_TOTAL_ITEM, 
      	0	   				QT_ITEM_CONTA, 
	   	' '					NM_PACIENTE, 
	    ' '		   			NR_FATURA, 
      	0					QT_CONTA, 
	    0					VL_TOTAL_LOTE, 
		b.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
		1					NR_REGISTRO, 
		' '					IE_MATMED, 
		' '					DS_MA_ME_TX, 
		to_char(Obter_Tipo_Atend_Abramge(b.nr_interno_conta))	ie_tipo_atend_esp, 
		b.ie_tipo_atendimento		ie_tipo_atend_tasy, 
		LOCALTIMESTAMP	DT_PROCEDIMENTO, 
		null CD_EDICAO_AMB, 
		null CD_PROCEDIMENTO, 
		c.cd_ans, 
		b.DT_VALIDADE_CARTEIRA, 
		substr(obter_nome_pf_pj(d.cd_pessoa_fisica, null),1,254) nm_pessoa_fisica, 
		i.cd_cnes 				NR_CARTAO_NAC_SUS, 
		b.nr_atendimento 			NR_ATENDIMENTO, 
		e.cd_pessoa_fisica			CD_PESSOA_FISICA 
FROM		sus_parametros i, 
		pessoa_fisica e, 
		atendimento_paciente d, 
		estabelecimento c, 
		conta_paciente_guia h, 
		conta_paciente a, 
		w_interf_conta_header f, 
		w_interf_conta_cab b 
where		a.nr_interno_conta	= b.nr_interno_conta 
and		a.nr_interno_conta	= h.nr_interno_conta 
and		a.cd_estabelecimento	= c.cd_estabelecimento 
and		a.nr_atendimento	= d.nr_atendimento 
and		d.cd_pessoa_fisica	= e.cd_pessoa_fisica 
and		c.cd_estabelecimento	= i.cd_estabelecimento 
and		f.nr_seq_protocolo	= b.nr_seq_protocolo 

union all
 
SELECT   	'ITEM DA CONTA     '	 	DS_REGISTRO, 
    	3	         	   	TP_REGISTRO, 
      	'CSMH' 	 	       	IE_SERVICO, 
      	2       			CD_REGISTRO, 
      	0  	    			CD_ORIGEM, 
      	c.NR_SEQ_PROTOCOLO   		NR_LOTE, 
      	c.NR_INTERNO_CONTA	 		NR_INTERNO_CONTA, 
      	max(c.NR_SEQ_ITEM) 		  	NR_PARCELA, 
      	0  		        	CD_CONVENIO, 
      	' '	     			NM_CONVENIO, 
      	' ' 			   		TP_PRESTADOR, 
      	c.cd_cgc_prestador			CD_PRESTADOR, 
      	d.ds_razao_social			NM_PRESTADOR, 
      	LOCALTIMESTAMP  	     		DT_GERACAO, 
      	1	          	 	NR_REMESSA, 
      	' '   	         	CD_PLANO, 
     	' ' 			      	CD_PACIENTE,       
     	' '         			CD_AUTORIZACAO, 
     	0       		   	CD_ACOMODACAO, 
      	LOCALTIMESTAMP	         	DT_ENTRADA, 
     	LOCALTIMESTAMP 		     	DT_SAIDA, 
	   	LOCALTIMESTAMP     	  		DT_INICIO_COBRANCA, 
      	LOCALTIMESTAMP	         	DT_FIM_COBRANCA, 
     	0	      	  		IE_TIPO_ATENDIMENTO, 
	    	null 			       CD_CID, 
      	' '       	     	CD_PROC_PRINCIPAL, 
		' '					CD_MEDICO_CONVENIO, 
   		' '  		   		NR_CRM, 
      	' '	    	       	UF_CRM, 
		' '					NR_CRM_REQ, 
		' '					UF_CRM_REQ, 
		max(c.NR_SEQ_ITEM) 			NR_SEQ_ITEM, 
      	c.CD_ITEM_CONVENIO			CD_ITEM, 
      	substr(ELIMINA_ACENTUACAO(upper(c.DS_ITEM)),1,50) NM_ITEM, 
	    CASE WHEN W.IE_CARATER_INTER='U' THEN 'S'  ELSE 'N' END 	IE_EMERGENCIA, 
      	CASE WHEN c.pr_hora_extra=0 THEN 'N' WHEN c.pr_hora_extra=1 THEN 'N' WHEN c.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END  IE_EXTRA, 
      	TRUNC(W.DT_ENTRADA,'dd') 		DT_ITEM, 
    		c.CD_FUNCAO_EXECUTOR 	   	IE_FUNCAO_MEDICO, 
      	SUM(c.QT_ITEM)       	QT_ITEM, 
     	SUM(CASE WHEN(coalesce(c.vl_honorario,0) + coalesce(c.vl_custo_oper,0) + coalesce(c.vl_filme,0))=0 THEN c.vl_total_item  ELSE (coalesce(c.vl_honorario,0) + coalesce(c.vl_custo_oper,0) + coalesce(c.vl_filme,0)) END )	VL_ITEM, 
      	0	   			   	IE_CIRURGIA_MULTIPLA, 
   		0				   	VL_TOTAL_ITEM, 
     	0	   				QT_ITEM_CONTA, 
   		' '					NM_PACIENTE, 
      	' '	   				NR_FATURA, 
   		0					QT_CONTA, 
     	0					VL_TOTAL_LOTE, 
		c.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
      	1 		       		NR_REGISTRO, 
		' '					IE_MATMED, 
		' '					DS_MA_ME_TX, 
		' '					ie_tipo_atend_esp, 
		w.ie_tipo_atendimento		ie_tipo_atend_tasy, 
		c.dt_item				DT_PROCEDIMENTO, 
		substr(OBTER_EDICAO_AMB(e.cd_estabelecimento, c.cd_convenio, w.cd_categoria_convenio, c.dt_autorizacao),1,20) 
CD_EDICAO_AMB, 
		c.cd_item				CD_PROCEDIMENTO, 
		null cd_ans, 
		null DT_VALIDADE_CARTEIRA, 
		null nm_pessoa_fisica, 
		null NR_CARTAO_NAC_SUS, 
		null NR_ATENDIMENTO, 
		null CD_PESSOA_FISICA 
FROM w_interf_conta_cab w, atendimento_paciente f, estabelecimento e, pessoa_juridica d
LEFT OUTER JOIN w_interf_conta_item c ON (d.cd_cgc = c.cd_cgc_prestador)
LEFT OUTER JOIN regra_honorario z ON (c.ie_responsavel_credito = Z.cd_regra)
WHERE c.NR_INTERNO_CONTA = W.NR_INTERNO_CONTA  and e.cd_estabelecimento	= f.cd_estabelecimento and f.nr_atendimento	= w.nr_atendimento and coalesce(Z.ie_entra_conta,'S') = 'S' and c.ie_tipo_item	= 1 and c.qt_item		<> 0 and c.cd_medico_executor is not null  GROUP BY	c.NR_SEQ_PROTOCOLO, 
      	c.NR_INTERNO_CONTA, 
      	c.CD_ITEM_CONVENIO, 
      	substr(ELIMINA_ACENTUACAO(upper(c.DS_ITEM)),1,50), 
      	CASE WHEN W.IE_CARATER_INTER='U' THEN 'S'  ELSE 'N' END , 
      	CASE WHEN c.pr_hora_extra=0 THEN 'N' WHEN c.pr_hora_extra=1 THEN 'N' WHEN c.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END , 
      	TRUNC(W.DT_ENTRADA,'dd'), 
      	c.CD_FUNCAO_EXECUTOR, 
      	c.NR_SEQ_PROTOCOLO, 
		w.ie_tipo_atendimento, 
      	c.cd_cgc_prestador, 
      	d.ds_razao_social, 
		c.dt_item, 
		substr(OBTER_EDICAO_AMB(e.cd_estabelecimento, c.cd_convenio, w.cd_categoria_convenio, 
c.dt_autorizacao),1,20), 
		c.cd_item 
having		SUM(c.QT_ITEM) <> 0 

union all
 
SELECT   	'ITEM DA CONTA     '	 	DS_REGISTRO, 
	   	3     	 	    	TP_REGISTRO, 
      	'CSMH' 	  			IE_SERVICO, 
	    2    	       	CD_REGISTRO, 
      	0      				CD_ORIGEM, 
	    c.NR_SEQ_PROTOCOLO	   		NR_LOTE, 
      	c.NR_INTERNO_CONTA	   		NR_INTERNO_CONTA, 
	    max(c.NR_SEQ_ITEM)   	   	NR_PARCELA, 
      	0         	  		CD_CONVENIO, 
	    ' '			       	NM_CONVENIO, 
      	' '   	 	    	TP_PRESTADOR, 
	    ' '      			CD_PRESTADOR, 
    	' ' 	 	    	 	NM_PRESTADOR, 
      	LOCALTIMESTAMP	    	    DT_GERACAO, 
   		1 	        		NR_REMESSA, 
      	' '		       	CD_PLANO, 
      	' ' 	    	       	CD_PACIENTE,       
      	' ' 		    	   	CD_AUTORIZACAO, 
   		0       		   	CD_ACOMODACAO, 
      	LOCALTIMESTAMP   	    	  	DT_ENTRADA, 
    	LOCALTIMESTAMP 			   	DT_SAIDA, 
     	LOCALTIMESTAMP         		DT_INICIO_COBRANCA, 
   		LOCALTIMESTAMP 		    	DT_FIM_COBRANCA, 
	    0	  	          	IE_TIPO_ATENDIMENTO, 
    	null  		    	CD_CID, 
	    ' '       	  		CD_PROC_PRINCIPAL, 
		' '					CD_MEDICO_CONVENIO, 
    	' ' 		        	NR_CRM, 
     	' '	    	   		UF_CRM, 
		' '					NR_CRM_REQ, 
		' '					UF_CRM_REQ, 
      	max(c.NR_SEQ_ITEM)      	NR_SEQ_ITEM, 
      	c.CD_ITEM_CONVENIO			CD_ITEM, 
      	substr(ELIMINA_ACENTUACAO(upper(c.DS_ITEM)),1,50) NM_ITEM, 
      	CASE WHEN W.IE_CARATER_INTER='U' THEN 'S'  ELSE 'N' END 	IE_EMERGENCIA, 
      	CASE WHEN c.pr_hora_extra=0 THEN 'N' WHEN c.pr_hora_extra=1 THEN 'N' WHEN c.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END  IE_EXTRA, 
      	TRUNC(W.DT_ENTRADA,'dd') 		DT_ITEM, 
      	c.CD_FUNCAO_EXECUTOR  	   	IE_FUNCAO_MEDICO, 
      	SUM(c.QT_ITEM)     	   	QT_ITEM, 
      	SUM(c.vl_total_item)   		VL_ITEM, 
      	0  		        	IE_CIRURGIA_MULTIPLA, 
      	0		   			VL_TOTAL_ITEM, 
      	0		   			QT_ITEM_CONTA, 
	   	' '					NM_PACIENTE, 
      	' '   				NR_FATURA, 
      	0					QT_CONTA, 
     	0					VL_TOTAL_LOTE, 
	 	c.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
      	1        	    	NR_REGISTRO, 
		CASE WHEN c.ie_total_interf=2 THEN '1' WHEN c.ie_total_interf=9 THEN '1' WHEN c.ie_total_interf=10 THEN '1' WHEN c.ie_total_interf=11 THEN '1' WHEN c.ie_total_interf=3 THEN '2'  ELSE ' ' END 	IE_MAT_MED, 
		CASE WHEN c.ie_total_interf=2 THEN 'MA' WHEN c.ie_total_interf=9 THEN 'MA' WHEN c.ie_total_interf=10 THEN 'MA' WHEN c.ie_total_interf=11 THEN 'MA' WHEN c.ie_total_interf=3 THEN 'ME' WHEN c.ie_total_interf=5 THEN 'TX' WHEN c.ie_total_interf=6 THEN 'TX' WHEN c.ie_total_interf=7 THEN 'TX'  ELSE ' ' END  DS_MA_ME_TX, 
		' '					ie_tipo_atend_esp, 
		w.ie_tipo_atendimento		ie_tipo_atend_tasy, 
		LOCALTIMESTAMP				DT_PROCEDIMENTO, 
		null CD_EDICAO_AMB, 
		null CD_PROCEDIMENTO, 
		null cd_ans, 
		null DT_VALIDADE_CARTEIRA, 
		null nm_pessoa_fisica, 
		null NR_CARTAO_NAC_SUS, 
		null NR_ATENDIMENTO, 
		null CD_PESSOA_FISICA 
FROM		W_INTERF_CONTA_ITEM C, 
		W_INTERF_CONTA_CAB W 
WHERE 	c.NR_INTERNO_CONTA = W.NR_INTERNO_CONTA 
and (c.ie_tipo_item	= 2 or (c.ie_tipo_item	= 1 and 
		c.cd_medico_executor is null)) 
and		c.vl_total_item	<> 0 
and		c.qt_item		<> 0 
GROUP BY	c.NR_SEQ_PROTOCOLO, 
      	c.NR_INTERNO_CONTA, 
      	c.CD_ITEM_CONVENIO, 
      	substr(ELIMINA_ACENTUACAO(upper(c.DS_ITEM)),1,50), 
      	CASE WHEN W.IE_CARATER_INTER='U' THEN 'S'  ELSE 'N' END , 
      	CASE WHEN c.pr_hora_extra=0 THEN 'N' WHEN c.pr_hora_extra=1 THEN 'N' WHEN c.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END , 
      	TRUNC(W.DT_ENTRADA,'dd'), 
      	c.CD_FUNCAO_EXECUTOR, 
      	c.NR_SEQ_PROTOCOLO, 
		CASE WHEN c.ie_total_interf=2 THEN '1' WHEN c.ie_total_interf=9 THEN '1' WHEN c.ie_total_interf=10 THEN '1' WHEN c.ie_total_interf=11 THEN '1' WHEN c.ie_total_interf=3 THEN '2'  ELSE ' ' END , 
		CASE WHEN c.ie_total_interf=2 THEN 'MA' WHEN c.ie_total_interf=9 THEN 'MA' WHEN c.ie_total_interf=10 THEN 'MA' WHEN c.ie_total_interf=11 THEN 'MA' WHEN c.ie_total_interf=3 THEN 'ME' WHEN c.ie_total_interf=5 THEN 'TX' WHEN c.ie_total_interf=6 THEN 'TX' WHEN c.ie_total_interf=7 THEN 'TX'  ELSE ' ' END , 
		w.ie_tipo_atendimento 
having		SUM(c.QT_ITEM) <> 0 

union all
 
SELECT   	'TOTAL DA CONTA    ' 		DS_REGISTRO, 
      	4    		       	TP_REGISTRO, 
      	'CSMH' 	        	IE_SERVICO, 
      	3       		   	CD_REGISTRO, 
      	0		      		CD_ORIGEM, 
      	b.NR_SEQ_PROTOCOLO	   		NR_LOTE, 
      	b.NR_INTERNO_CONTA   	 	NR_INTERNO_CONTA, 
      	1 			       	NR_PARCELA, 
      	0   		       	CD_CONVENIO, 
      	' '  			    NM_CONVENIO, 
      	' ' 			      	TP_PRESTADOR, 
      	' '   		      	CD_PRESTADOR, 
      	' '  			       	NM_PRESTADOR, 
      	LOCALTIMESTAMP  			   	DT_GERACAO, 
      	1        		   	NR_REMESSA, 
      	' ' 		  	      	CD_PLANO, 
      	' '       			CD_PACIENTE,       
      	' '            		CD_AUTORIZACAO, 
      	0 		        	CD_ACOMODACAO, 
      	LOCALTIMESTAMP		       	DT_ENTRADA, 
      	LOCALTIMESTAMP        	 	DT_SAIDA, 
      	LOCALTIMESTAMP        		DT_INICIO_COBRANCA, 
      	LOCALTIMESTAMP 	        	DT_FIM_COBRANCA, 
      	0  		          	IE_TIPO_ATENDIMENTO, 
      	null           		CD_CID, 
      	' '            		CD_PROC_PRINCIPAL, 
		' '					CD_MEDICO_CONVENIO, 
      	' ' 		          	NR_CRM, 
      	' '          	  	UF_CRM, 
		' '					NR_CRM_REQ, 
		' '					UF_CRM_REQ, 
      	1 		         	NR_SEQ_ITEM, 
      	' '					CD_ITEM, 
      	' '   				NM_ITEM, 
      	' '   				IE_EMERGENCIA, 
      	' ' 		          	IE_EXTRA, 
      	LOCALTIMESTAMP				DT_ITEM, 
      	0         		   	IE_FUNCAO_MEDICO, 
      	0					QT_ITEM, 
      	0					VL_ITEM, 
      	0					IE_CIRURGIA_MULTIPLA, 
      	sum(CASE WHEN e.cd_medico_executor IS NULL THEN e.vl_total_item  ELSE CASE WHEN(coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0))=0 THEN e.vl_total_item  ELSE (coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0)) END  END ) VL_TOTAL_ITEM, 
      	0					QT_ITEM_CONTA, 
		substr(ELIMINA_ACENTUACAO(UPPER(b.NM_PACIENTE)),1,40) 
							NM_PACIENTE, 
      	' '	   				NR_FATURA, 
      	0					QT_CONTA, 
      	0					VL_TOTAL_LOTE, 
  		b.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
      	1         		   	NR_REGISTRO, 
		' '					IE_MATMED, 
		' '					DS_MA_ME_TX, 
		' '					ie_tipo_atend_esp, 
		b.ie_tipo_atendimento		ie_tipo_atend_tasy, 
		LOCALTIMESTAMP	DT_PROCEDIMENTO, 
		null CD_EDICAO_AMB, 
		null CD_PROCEDIMENTO, 
		null cd_ans, 
		null DT_VALIDADE_CARTEIRA, 
		null nm_pessoa_fisica, 
		null NR_CARTAO_NAC_SUS, 
		null NR_ATENDIMENTO, 
		null CD_PESSOA_FISICA 
FROM w_interf_conta_cab b, w_interf_conta_item e
LEFT OUTER JOIN estrutura_procedimento_v x ON (e.CD_ITEM = X.CD_PROCEDIMENTO AND e.IE_ORIGEM_PROCED = X.IE_ORIGEM_PROCED)
LEFT OUTER JOIN regra_honorario z ON (e.IE_RESPONSAVEL_CREDITO = Z.cd_regra)
WHERE b.NR_INTERNO_CONTA 	= e.NR_INTERNO_CONTA    and coalesce(Z.ie_entra_conta,'S') = 'S' GROUP BY	b.NR_SEQ_PROTOCOLO, 
     	b.NR_INTERNO_CONTA, 
		substr(ELIMINA_ACENTUACAO(UPPER(b.NM_PACIENTE)),1,40), 
		b.ie_tipo_atendimento 

union all
 
SELECT   	'FIM DE LOTE      '		DS_REGISTRO, 
      	5    		    	TP_REGISTRO, 
      	'CSMH'   				IE_SERVICO, 
      	4       			CD_REGISTRO, 
      	0			      	CD_ORIGEM, 
      	b.NR_SEQ_PROTOCOLO		   	NR_LOTE, 
      	99999999		   		NR_INTERNO_CONTA, 
      	99   			   	NR_PARCELA, 
      	0   			   	CD_CONVENIO, 
      	' '   			   	NM_CONVENIO, 
      	' '   			    TP_PRESTADOR, 
      	' '   			    CD_PRESTADOR, 
      	' '   			    NM_PRESTADOR, 
      	LOCALTIMESTAMP   			    DT_GERACAO, 
      	1    			    NR_REMESSA, 
      	' '     				CD_PLANO, 
      	' '    				CD_PACIENTE,       
      	' '     				CD_AUTORIZACAO, 
      	0      				CD_ACOMODACAO, 
      	LOCALTIMESTAMP  			   	DT_ENTRADA, 
      	LOCALTIMESTAMP         		DT_SAIDA, 
      	LOCALTIMESTAMP  			   	DT_INICIO_COBRANCA, 
      	LOCALTIMESTAMP  			   	DT_FIM_COBRANCA, 
      	0       			IE_TIPO_ATENDIMENTO, 
      	null    				CD_CID, 
      	' '           		CD_PROC_PRINCIPAL, 
		' '					CD_MEDICO_CONVENIO, 
      	' '    			   	NR_CRM, 
      	' '   			   	UF_CRM, 
		' '					NR_CRM_REQ, 
		' '					UF_CRM_REQ, 
      	1            		NR_SEQ_ITEM, 
      	' '					CD_ITEM, 
      	' '        			NM_ITEM, 
      	' '   				IE_EMERGENCIA, 
      	' '      			IE_EXTRA, 
      	LOCALTIMESTAMP				DT_ITEM, 
      	0         			IE_FUNCAO_MEDICO, 
      	0					QT_ITEM, 
      	0					VL_ITEM, 
      	0					IE_CIRURGIA_MULTIPLA, 
      	0		   			VL_TOTAL_ITEM, 
      	0	   				QT_ITEM_CONTA, 
		' '					NM_PACIENTE, 
      	' '	   				NR_FATURA, 
      	count(distinct e.nr_interno_conta)	QT_CONTA, 
      	sum(CASE WHEN e.cd_medico_executor IS NULL THEN e.vl_total_item  ELSE CASE WHEN(coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0))=0 THEN e.vl_total_item  ELSE (coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0)) END  END ) VL_TOTAL_ITEM, 
		b.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
     	1       			NR_REGISTRO, 
		' '					IE_MATMED, 
		' '					DS_MA_ME_TX, 
		' '					ie_tipo_atend_esp, 
		0					ie_tipo_atend_tasy, 
		LOCALTIMESTAMP	DT_PROCEDIMENTO, 
		null CD_EDICAO_AMB, 
		null CD_PROCEDIMENTO, 
		null cd_ans, 
		null DT_VALIDADE_CARTEIRA, 
		null nm_pessoa_fisica, 
		null NR_CARTAO_NAC_SUS, 
		null NR_ATENDIMENTO, 
		null CD_PESSOA_FISICA 
FROM w_interf_conta_cab b, w_interf_conta_item e
LEFT OUTER JOIN estrutura_procedimento_v x ON (e.CD_ITEM = X.CD_PROCEDIMENTO AND e.IE_ORIGEM_PROCED = X.IE_ORIGEM_PROCED)
LEFT OUTER JOIN regra_honorario z ON (e.ie_responsavel_credito = Z.cd_regra)
WHERE b.NR_INTERNO_CONTA 	= e.NR_INTERNO_CONTA    and coalesce(Z.ie_entra_conta,'S') = 'S' GROUP BY	b.NR_SEQ_PROTOCOLO 

union all
 
SELECT 	'TRAILLER       ' 		DS_REGISTRO, 
      	6        			TP_REGISTRO, 
      	'CSMH'  				IE_SERVICO, 
      	9   			      	CD_REGISTRO, 
      	(coalesce(f.CD_INTERNO,0))::numeric 	CD_ORIGEM, 
      	99999999		   		NR_LOTE, 
      	99999999	   			NR_INTERNO_CONTA, 
      	99    		      	NR_PARCELA, 
      	0 	           	CD_CONVENIO, 
      	' '       			NM_CONVENIO, 
      	' ' 			      	TP_PRESTADOR, 
      	' '  			   	CD_PRESTADOR, 
      	' '  			   	NM_PRESTADOR, 
      	LOCALTIMESTAMP     			DT_GERACAO, 
      	1    			   	NR_REMESSA, 
      	' '   			   	CD_PLANO, 
      	' '      			CD_PACIENTE,       
      	' '     				CD_AUTORIZACAO, 
      	0        			CD_ACOMODACAO, 
      	LOCALTIMESTAMP       			DT_ENTRADA, 
      	LOCALTIMESTAMP         		DT_SAIDA, 
      	LOCALTIMESTAMP         		DT_INICIO_COBRANCA, 
		LOCALTIMESTAMP    			DT_FIM_COBRANCA, 
      	0     			   	IE_TIPO_ATENDIMENTO, 
      	null 			       	CD_CID, 
      	' '   			   	CD_PROC_PRINCIPAL, 
		' '					CD_MEDICO_CONVENIO, 
      	' '    				NR_CRM, 
      	' '    				UF_CRM, 
		' '					NR_CRM_REQ, 
		' '					UF_CRM_REQ, 
      	1            		NR_SEQ_ITEM, 
      	' '					CD_ITEM, 
      	' '  			   	NM_ITEM, 
      	' '   				IE_EMERGENCIA, 
      	' '   		    	IE_EXTRA, 
      	LOCALTIMESTAMP				DT_ITEM, 
      	0   			   	IE_FUNCAO_MEDICO, 
      	0					QT_ITEM, 
      	0					VL_ITEM, 
      	0					IE_CIRURGIA_MULTIPLA, 
      	0				   	VL_TOTAL_ITEM, 
      	0	   				QT_ITEM_CONTA, 
		' '					NM_PACIENTE, 
      	' '			   		NR_FATURA, 
      	count(distinct e.nr_interno_conta)	QT_CONTA, 
      	sum(CASE WHEN e.cd_medico_executor IS NULL THEN e.vl_total_item  ELSE CASE WHEN(coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0))=0 THEN e.vl_total_item  ELSE (coalesce(e.vl_honorario,0) + coalesce(e.vl_custo_oper,0) + coalesce(e.vl_filme,0)) END  END ) VL_TOTAL_ITEM, 
		b.NR_SEQ_PROTOCOLO			NR_SEQ_PROTOCOLO, 
		' '					DS_ESPACO, 
      	1         		    NR_REGISTRO, 
		' '					IE_MATMED, 
		' '					DS_MA_ME_TX, 
		' '					ie_tipo_atend_esp, 
		9					ie_tipo_atend_tasy, 
		LOCALTIMESTAMP	DT_PROCEDIMENTO, 
		null CD_EDICAO_AMB, 
		null CD_PROCEDIMENTO, 
		null cd_ans, 
		null DT_VALIDADE_CARTEIRA, 
		null nm_pessoa_fisica, 
		null NR_CARTAO_NAC_SUS, 
		null NR_ATENDIMENTO, 
		null CD_PESSOA_FISICA 
FROM w_interf_conta_header f, w_interf_conta_cab b, w_interf_conta_item e
LEFT OUTER JOIN estrutura_procedimento_v x ON (e.CD_ITEM = X.CD_PROCEDIMENTO AND e.IE_ORIGEM_PROCED = X.IE_ORIGEM_PROCED)
LEFT OUTER JOIN regra_honorario z ON (e.IE_RESPONSAVEL_CREDITO = Z.cd_regra)
WHERE b.NR_INTERNO_CONTA 	= e.NR_INTERNO_CONTA and b.nr_seq_protocolo	= f.nr_seq_protocolo    and coalesce(Z.ie_entra_conta,'S') = 'S' GROUP BY	(coalesce(f.CD_INTERNO,0))::numeric , 
		b.NR_SEQ_PROTOCOLO;

