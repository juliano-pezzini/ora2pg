-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_atend_pac_conv_v (cd_estabelecimento, cd_convenio, ds_convenio, ie_periodo, dt_referencia, qt_pessoa, qt_atendimentos) AS select	a.cd_estabelecimento,
	b.cd_convenio, 
	c.ds_convenio, 
	'M' ie_periodo, 
	trunc(dt_entrada, 'MONTH') dt_referencia, 
	count(distinct cd_pessoa_fisica) qt_pessoa, 
	count(*) qt_atendimentos 
FROM	convenio c, 
	atend_categoria_convenio b, 
	ATEND_PACIENTE_UNIDADE D, 
	atendimento_paciente a 
where	a.nr_atendimento	= b.nr_atendimento 
and	b.cd_convenio		= c.cd_convenio 
AND   a.NR_ATENDIMENTO 	= D.NR_ATENDIMENTO 
AND 	(b.DT_INICIO_VIGENCIA = 
   		(SELECT MIN(W.DT_INICIO_VIGENCIA) DT_PRIMEIRA_VIGENCIA 
    		FROM  ATEND_CATEGORIA_CONVENIO W 
    		WHERE W.NR_ATENDIMENTO = a.NR_ATENDIMENTO) ) 
AND  	DS_CONVENIO IS NOT NULL 
AND 	(D.DT_ENTRADA_UNIDADE = 
   		(SELECT MIN(W.DT_ENTRADA_UNIDADE) 
    		FROM  	SETOR_ATENDIMENTO X, 
			ATEND_PACIENTE_UNIDADE W 
	    	WHERE 	W.NR_ATENDIMENTO = a.NR_ATENDIMENTO 
	 	AND 	W.CD_SETOR_ATENDIMENTO = X.CD_SETOR_ATENDIMENTO)) 
group by a.cd_estabelecimento, 
	b.cd_convenio, 
	c.ds_convenio, 
	'M', 
	trunc(dt_entrada, 'MONTH');

