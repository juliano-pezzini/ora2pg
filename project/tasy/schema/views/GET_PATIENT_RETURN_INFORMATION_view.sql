-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW get_patient_return_information (cedocve, cjurcve, cmpocve, cloccve, ctuncve, clues, folio, egreso, ingre, dias_esta, tuhpsiq, servhc, servhp, tipserv, servicioingre, servicio02, servicio03, servicioegre, sa_labor, sa_expul, sa_recup, sa_inten, sa_interm, proced, cluesproced, cluesreferido, motegre, diag_ini, afecprin, vez, infec, causaext, traumat, lugar, cedularesp, nm_medico, derhab, nr_atendimento, dt_alta) AS SELECT 	coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_ESTADO'),2,'0'),'00') CEDOCVE,
		coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_JURISDICAO'),2,'0'),'00') CJURCVE,
		coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_MUNICIPIO'),3,'0'),'00') CMPOCVE,
		coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_LOCALIDADE'),4,'0'),'00') CLOCCVE,
		obter_dados_cat_clues(c.cd_internacional,'IE_TIPO_UNIDADE') CTUNCVE,
		SUBSTR(coalesce(obter_dados_cat_clues(c.cd_internacional,'CD_CLUES'),c.cd_cgc),1,11) CLUES,
		a.nr_atendimento FOLIO,
		pkg_date_utils.START_OF(a.dt_alta, 'DAY') EGRESO,
		pkg_date_utils.START_OF(a.dt_entrada, 'DAY') INGRE,
		(TO_DATE(a.dt_alta, 'dd/mm/yyyy') - TO_DATE(a.dt_entrada, 'dd/mm/yyyy')) + 1 DIAS_ESTA,
		RPAD(coalesce(cm.ie_tipo_uni_psiq,' '),3,' ') TUHPSIQ,
		CASE WHEN coalesce(cm.ie_serv_psiq_cont,0)=0 THEN 9  ELSE cm.ie_serv_psiq_cont END  SERVHC,
		CASE WHEN coalesce(cm.ie_serv_psiq_par,0)=0 THEN 9  ELSE cm.ie_serv_psiq_par END  SERVHP,
		coalesce(a.ie_tipo_serv_mx,1) TIPSERV,
		coalesce(RPAD((SELECT CASE WHEN coalesce(x.cd_servico,0)=0 THEN 999  ELSE x.cd_servico END  FROM cat_servicos x WHERE x.nr_sequencia = a.cd_serv_entrada_mx),3),'999') SERVICIOINGRE,
		coalesce(RPAD((SELECT CASE WHEN coalesce(x.cd_servico,0)=0 THEN 999  ELSE x.cd_servico END  FROM cat_servicos x WHERE x.nr_sequencia = a.cd_serv_sec_mx),3),'999') SERVICIO02,
		coalesce(RPAD((SELECT CASE WHEN coalesce(x.cd_servico,0)=0 THEN 999  ELSE x.cd_servico END  FROM cat_servicos x WHERE x.nr_sequencia = a.cd_serv_ter_mx),3),'999') SERVICIO03,
		coalesce(RPAD((SELECT CASE WHEN coalesce(x.cd_servico,0)=0 THEN 999  ELSE x.cd_servico END  FROM cat_servicos x WHERE x.nr_sequencia = a.cd_serv_alta_mx),3),'999') SERVICIOEGRE,
		case
			when(e.ie_sexo = 'F' and (obter_idade(e.dt_nascimento, LOCALTIMESTAMP, 'A') between 10 and 54))
			then LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,12),'   '),3,'0')
			else '   '
		end as SA_LABOR,
		case
			when(e.ie_sexo = 'F' and (obter_idade(e.dt_nascimento, LOCALTIMESTAMP, 'A') between 10 and 54))
			then LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,13),'   '),3,'0')
			else '   '
		end as SA_EXPUL,
		case
			when(e.ie_sexo = 'F' and (obter_idade(e.dt_nascimento, LOCALTIMESTAMP, 'A') between 10 and 54))
			then LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,14),'   '),3,'0')
			else '   '
		end as SA_RECUP,
		case
			when(e.ie_sexo = 'F' and (obter_idade(e.dt_nascimento, LOCALTIMESTAMP, 'A') between 10 and 54))
			then LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,15),'   '),3,'0')
			else '   '
		end as SA_INTEN,
		case
			when(e.ie_sexo = 'F' and (obter_idade(e.dt_nascimento, LOCALTIMESTAMP, 'A') between 10 and 54))
			then LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,16),'   '),3,'0')
			else '   '
		end as SA_INTERM,
		coalesce(a.cd_procedencia,'9') PROCED,
		coalesce(obter_dados_cat_clues((SELECT x.cd_internacional FROM pessoa_juridica x WHERE x.cd_cgc = i.cd_cgc_procedencia),'CD_CLUES'),'           ') CLUESPROCED,
		coalesce(obter_dados_cat_clues((SELECT x.cd_internacional FROM pessoa_juridica x WHERE x.cd_cgc = t.cd_cgc),'CD_CLUES'),'           ') CLUESREFERIDO,
		coalesce((SELECT CD_EXTERNO
			FROM 	MOTIVO_ALTA X
			WHERE x.CD_MOTIVO_ALTA = A.CD_MOTIVO_ALTA),'9') MOTEGRE,
		CASE WHEN coalesce(Obter_cid_atend_Pre(a.nr_atendimento),'X')='X' THEN '    '  ELSE Obter_cid_atend_Pre(a.nr_atendimento) END  DIAG_INI,
		case
			when(select max(h.ds_metodos_contrac) from historico_saude_mulher h where h.cd_pessoa_fisica = a.cd_pessoa_fisica) = '1'
			then 'Z301'
			else CASE WHEN coalesce(Obter_cid_atend_def(a.nr_atendimento),'X')='X' THEN '    '  ELSE Obter_cid_atend_def(a.nr_atendimento) END
		end as AFECPRIN,
		CASE WHEN(SELECT 	COUNT(t.cd_doenca)				FROM 	diagnostico_doenca t,						atendimento_paciente u				WHERE 	t.dt_diagnostico				BETWEEN LOCALTIMESTAMP - interval '365 days' AND LOCALTIMESTAMP				AND t.nr_atendimento = u.nr_atendimento				AND u.nr_atendimento <> a.nr_atendimento				AND u.cd_pessoa_fisica = a.cd_pessoa_fisica				AND t.cd_doenca = obter_cid_atendimento(a.nr_atendimento, 'P'))='0' THEN '1'  ELSE '2' END  VEZ,
		CASE WHEN(SELECT 	COUNT(1)				FROM 	atendimento_precaucao x				WHERE x.nr_atendimento = a.nr_atendimento				AND x.dt_liberacao IS NOT NULL)='0' THEN '2'  ELSE '1' END  INFEC,
		case
			when(select max(h.ds_metodos_contrac) from historico_saude_mulher h where h.cd_pessoa_fisica = a.cd_pessoa_fisica) = '1'
			then 'Z301'
			else RPAD(obter_cid_atendimento(a.nr_atendimento,'S'),4,' ')
		end as CAUSAEXT,
		coalesce(a.nr_seq_tipo_acidente,'9') TRAUMAT,
		coalesce(obter_dados_cat_lugar_acc(a.cd_lugar_acc,'CD_LUGAR_ACC'),'9') LUGAR,
		LPAD(coalesce(coalesce(obter_medico_alta(a.nr_atendimento),obter_dados_pf(a.cd_medico_resp, 'CPR')),'0'),15,'0')CEDULARESP,
		RPAD(e.nm_pessoa_fisica,250) nm_medico,
		RPAD(CASE WHEN coalesce(obter_convenio_atend_mx(a.nr_atendimento, 1),'99')='99' THEN '9'  ELSE obter_convenio_atend_mx(a.nr_atendimento, 1) END ,2) DERHAB,
		a.nr_atendimento NR_ATENDIMENTO,
		a.dt_alta dt_alta
FROM pessoa_fisica e, pessoa_juridica c, estabelecimento b, atendimento_paciente a
LEFT OUTER JOIN atend_categoria_convenio f ON (a.nr_atendimento = f.nr_atendimento)
LEFT OUTER JOIN procedencia i ON (a.cd_procedencia = i.cd_procedencia)
LEFT OUTER JOIN atendimento_transf t ON (a.nr_atendimento = t.nr_atendimento)
LEFT OUTER JOIN complemento_mexico cm ON (a.nr_atendimento = cm.nr_atendimento)
LEFT OUTER JOIN convenio g ON (f.cd_convenio = g.cd_convenio)
WHERE a.dt_alta IS NOT NULL AND a.cd_estabelecimento = b.cd_estabelecimento AND b.cd_cgc = c.cd_cgc    AND e.cd_pessoa_fisica = a.cd_medico_resp   AND f.nr_seq_interno = obter_atecaco_atendimento(a.nr_atendimento);

