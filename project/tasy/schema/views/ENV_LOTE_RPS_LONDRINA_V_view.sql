-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW env_lote_rps_londrina_v (cd_cpf_cnpj_prest, nr_nota_fiscal, cd_serie_nf, cd_sub_serie_nf, dt_emissao, cd_servico, ie_situacao, vl_servico, cd_cmc, ie_tipo_nota_fiscal, vl_aliquota, cd_estabelecimento) AS select	substr(CASE WHEN n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN '00000000000000'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END ,1,255) cd_cpf_cnpj_prest,
	n.nr_nota_fiscal	nr_nota_fiscal,
	n.cd_serie_nf		cd_serie_nf,
	'0'			cd_sub_serie_nf,
	n.dt_emissao		dt_emissao,
	o.nr_codigo_serv_prest	cd_servico,
	'0'			ie_situacao,
	CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END  vl_servico,
	'46132'			cd_cmc,
	'T'			ie_tipo_nota_fiscal,
	'0'			vl_aliquota,
	n.cd_estabelecimento
FROM	operacao_nota o,
	nota_fiscal n
where	o.cd_operacao_nf = n.cd_operacao_nf
and          o.ie_servico = 'S';

