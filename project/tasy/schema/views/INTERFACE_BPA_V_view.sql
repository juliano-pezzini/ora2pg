-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interface_bpa_v (cd_convenio, nr_protocolo, nr_seq_protocolo, dt_periodo_final, dt_competencia_aih, nm_orgao_origem_bpa, cd_orgao_origem_bpa, cd_unidade, cd_cgc, nm_orgao_destino_bpa, ie_orgao_destino_bpa, cd_unidade_bpa, dt_procedimento, cd_procedimento, cd_atividade_prof_bpa, ie_tipo_atend_bpa, ie_grupo_atend_bpa, cd_faixa_etaria, qt_procedimento, vl_procedimento) AS select  b.cd_convenio_parametro cd_convenio,
           b.nr_protocolo,
   x.nr_seq_protocolo,
   x.dt_periodo_final,
   c.dt_competencia_aih,
   c.nm_orgao_origem_bpa,
   c.cd_orgao_origem_bpa,
   c.cd_unidade_bpa cd_unidade,
   d.cd_cgc,
   c.nm_orgao_destino_bpa,
   c.ie_orgao_destino_bpa,
   c.cd_unidade_bpa,
   '01/' || substr(to_char(x.dt_periodo_final,'mm/yyyy'),0,7) dt_procedimento,
   a.cd_procedimento,
   a.cd_atividade_prof_bpa,
   Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T') ie_tipo_atend_bpa,
   Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G') ie_grupo_atend_bpa,
   g.cd_faixa_etaria,
   sum(a.qt_procedimento) qt_procedimento,
	sum(a.vl_procedimento) vl_procedimento
FROM protocolo_convenio x, atendimento_paciente e, estabelecimento d, sus_parametros c, conta_paciente b, procedimento_paciente a
LEFT OUTER JOIN sus_valor_proc_paciente g ON (a.nr_sequencia = g.nr_sequencia)
WHERE a.nr_interno_conta = b.nr_interno_conta and b.nr_seq_protocolo = x.nr_seq_protocolo and b.nr_atendimento = e.nr_atendimento and e.cd_estabelecimento = c.cd_estabelecimento and e.cd_estabelecimento = d.cd_estabelecimento and a.cd_motivo_exc_conta is null  and a.vl_procedimento > 0 and a.ie_origem_proced	= 3 group by  b.cd_convenio_parametro,
   b.nr_protocolo,
   x.nr_seq_protocolo,
   x.dt_periodo_final,
   c.dt_competencia_aih,
   c.nm_orgao_origem_bpa,
   c.cd_orgao_origem_bpa,
   c.cd_unidade_bpa,
   c.nm_orgao_destino_bpa,
   c.ie_orgao_destino_bpa,
   c.cd_unidade_bpa,
   d.cd_cgc,
   Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T'),
   Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G'),
   '01/' || substr(to_char(x.dt_periodo_final,'mm/yyyy'),0,7),
   a.cd_procedimento,
   a.cd_atividade_prof_bpa,
   a.cd_procedimento,
   a.cd_atividade_prof_bpa,
   g.cd_faixa_etaria;

