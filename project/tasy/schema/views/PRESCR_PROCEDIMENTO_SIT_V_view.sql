-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW prescr_procedimento_sit_v (nr_atendimento, nr_prescricao, nr_sequencia_prescricao, cd_setor_atendimento, dt_item, dt_conta, dt_entrada_unidade, cd_convenio, cd_categoria, qt_executada, qt_devolvida, qt_saldo, vl_item, nm_usuario, cd_item, qt_prescrita, cd_motivo_baixa, dt_baixa, ds_item, tp_item, ds_tp_item, nm_usuario_original, nm_prescritor, ds_setor_paciente, qt_checados) AS select	/*+ ORDEDED */	p.nr_atendimento, 
	p.nr_prescricao, 
	a.nr_sequencia_prescricao, 
	a.cd_setor_atendimento,	 
	p.dt_prescricao	dt_item, 
	a.dt_conta, 
	a.dt_entrada_unidade, 
	a.cd_convenio, 
	a.cd_categoria, 
	a.qt_procedimento	qt_executada, 
	a.qt_devolvida	qt_devolvida, 
	(a.qt_procedimento - a.qt_devolvida) qt_saldo, 
	a.vl_procedimento	vl_item, 
	a.nm_usuario, 
	i.cd_procedimento	cd_item, 
	i.qt_procedimento	qt_prescrita, 
	i.cd_motivo_baixa, 
	i.dt_baixa, 
	m.ds_procedimento	ds_item, 
	m.ie_classificacao	tp_item		/* 1-AMB 2-SERVICOS 3-DIARIAS	*/
, 
	CASE WHEN m.ie_classificacao=1 THEN 'PROCEDIMENTOS' WHEN m.ie_classificacao=2 THEN 'SERVICOS'  ELSE 'DIARIAS' END  ds_tp_item, 
	p.nm_usuario_original, 
	substr(coalesce(obter_nome_pf(p.cd_prescritor),'Não informado'),1,60) nm_prescritor, 
	substr(coalesce(obter_nome_setor(p.cd_setor_atendimento),'Não informado'),1,100) ds_setor_paciente, 
	(	select	count(b.dt_fim_horario) 
		FROM	prescr_proc_hor b 
		where	b.dt_fim_horario	is not null 
		and	i.nr_prescricao		= b.nr_prescricao 
		and	i.nr_sequencia		= b.nr_seq_procedimento 
		and	m.cd_procedimento	= b.cd_procedimento 
	) qt_checados 
FROM prescr_medica p, procedimento m, prescr_procedimento i
LEFT OUTER JOIN procedimento_paciente a ON (i.nr_prescricao = a.nr_prescricao AND i.nr_sequencia = a.nr_sequencia_prescricao)
WHERE p.nr_prescricao		= i.nr_prescricao and i.ie_origem_proced	= m.ie_origem_proced and i.cd_procedimento	= m.cd_procedimento;

