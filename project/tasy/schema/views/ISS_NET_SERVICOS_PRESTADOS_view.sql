-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW iss_net_servicos_prestados (cd_modelo, nr_nota_fiscal, dt_emissao_dia, dt_emissao_mes, dt_emissao_ano, vl_tributo, vl_documento, cd_natureza_operacao, cd_inscricao_municipal, cd_cpf_cnpj, ds_nome, cd_cep, ds_endereco, nr_endereco, ds_bairro, nm_cidade, sg_estado, ie_imp_retido, cd_estabelecimento, dt_emissao) AS select	lpad(coalesce(m.sg_modelo,0),4,0) cd_modelo,
	lpad(n.nr_nota_fiscal,9, 0) nr_nota_fiscal, 
	to_char(n.dt_emissao, 'dd') dt_emissao_dia, 
	to_char(n.dt_emissao, 'mm') dt_emissao_mes, 
	to_char(n.dt_emissao, 'yyyy') dt_emissao_ano, 
	lpad(subst_virgula_ponto_adic_zero(coalesce(sum(b.vl_tributo),0)),12,0) vl_tributo, 
	lpad(subst_virgula_ponto_adic_zero(coalesce(sum(n.vl_total_nota),0)),12,0) vl_documento, 
	lpad(n.cd_natureza_operacao,6, 0) cd_natureza_operacao, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'IE'), ' '),15, ' ') cd_inscricao_municipal, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'C'), ' '),15, ' ') cd_cpf_cnpj, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'N'), ' '),101, ' ') ds_nome, 
	lpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),0), 9, 0) cd_cep, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'R'), ' '), 101, ' ') ds_endereco, 
	lpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),0),6, 0 ) nr_endereco, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'), ' '),31, ' ') ds_bairro, 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'), ' '),29, ' ') nm_cidade, 
	obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF') sg_estado, 
	(select	CASE WHEN count(*)=0 THEN 0  ELSE 1 END  
	FROM	tributo t, 
		nota_fiscal_trib b 
	where	n.nr_sequencia = b.nr_sequencia 
	and	b.cd_tributo = t.cd_tributo 
	and	t.ie_tipo_tributo = 'ISS') ie_imp_retido, 
	n.cd_estabelecimento, 
	n.dt_emissao 
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN nota_fiscal_trib b ON (n.nr_sequencia = b.nr_sequencia)
LEFT OUTER JOIN modelo_nota_fiscal m ON (n.nr_seq_modelo = m.nr_sequencia)
WHERE n.cd_operacao_nf	= o.cd_operacao_nf and o.ie_servico	= 'S' and o.ie_operacao_fiscal	= 'S' group by	n.nr_nota_fiscal, m.sg_modelo, n.dt_emissao, n.cd_natureza_operacao, n.cd_pessoa_fisica, n.cd_cgc, n.nr_sequencia, n.cd_estabelecimento;

