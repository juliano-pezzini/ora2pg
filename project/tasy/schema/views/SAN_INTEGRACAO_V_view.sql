-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_integracao_v (nr_seq_lote, nr_tipo_registro, cd_versao, cd_sh, ds_arquivo, nr_seq_arquivo, dt_geracao, dt_inicio_periodo, dt_fim_periodo, nr_bolsa, cd_sh_origem, nr_seq_doacao_visa, nr_seq_doacao_sh, dt_doacao, cd_hemocomponente, ie_lavado, ie_filtrado, ie_irradiado, ds_fator, ds_dfraco, qt_volume, dt_validade, ie_bolsa_pediatrica, ie_bolsa_aliquotada, ie_sistema, dt_abertura_bolsa, ie_bolsa_pool, nr_seq_pool, cd_destino, nr_seq_transfusao, ie_interrompida, dt_descarte, cd_motivo_descarte, dt_distribuicao, cd_hemocomponente_sh, ds_hemocomponente, dt_transfusao, cd_local_tranfusao, cd_tipo_transfusao, ie_tipagem_direta, ie_tipagem_reversa, ds_pai, ie_prova_cruzada, ds_coombs_direto, cd_classificacao_transf, cd_convenio, nr_receptor, nm_receptor, dt_nascimento, nm_mae, ie_sexo, nm_pai, dt_obito, cd_nacionalidade, cd_naturalidade, cd_raca, cd_estado_civil, cd_escolaridade, cd_ocupacao, ds_documento, cd_documento, ds_orgao_expedidor, cd_cep, cd_pais, ie_logradouro, ds_logradouro, nr_endereco, ds_complemento, ds_bairro, cd_municipio, nr_telefone_res, nr_telefone_cel, ds_email, nr_sistema_sang, nr_antigeno, ds_resultado, nr_seq_anticorpo, cd_reacao_transfusional) AS select  -- Header do arquivo
		d.nr_sequencia	nr_seq_lote,
		'00'		nr_tipo_registro,
		rpad(San_obter_dados_integracao(d.ie_tipo_integracao,'V'),4,' ') cd_versao,
		rpad(San_obter_dados_integracao(d.ie_tipo_integracao,'S'),6,' ') cd_sh,
		rpad(San_obter_dados_integracao(d.ie_tipo_integracao,'A'),20,' ') ds_arquivo,
		lpad(d.nr_sequencia,6,0)	nr_seq_arquivo,
		LOCALTIMESTAMP		dt_geracao,
		d.dt_inicio 	dt_inicio_periodo,
		d.dt_fim_lote 	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		null	nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	FROM	san_lote_integracao d

union

select --Registro com informacoes sobre o destino da bolsa
		distinct d.nr_sequencia	nr_seq_lote,
		'10' 		nr_tipo_registro,
		null	cd_versao,
		lpad(m.cd_externo,6,0) cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		lpad(b.nr_sangue,15,0)	nr_bolsa,
		lpad(coalesce(b.nr_sec_saude,
		(select max(x.nr_sec_saude)
		from san_doacao x where x.nr_sequencia = b.nr_seq_doacao)),6,0)	cd_sh_origem,
		lpad(San_obter_dados_integracao(d.ie_tipo_integracao,'S'),6)||to_char(b.dt_producao,'yy')||LPAD(b.nr_sequencia,6,0)	nr_seq_doacao_visa,
		lpad(b.nr_sequencia,15,0)	nr_seq_doacao_sh,
		b.dt_producao	dt_doacao,
		lpad(i.cd_externo,2,0) cd_hemocomponente,
		coalesce(b.ie_lavado,'N')	ie_lavado,
		coalesce(b.ie_filtrado,'N')	ie_filtrado,
		coalesce(b.ie_irradiado,'N')	ie_irradiado,
		coalesce(obter_dados_pf(c.cd_pessoa_fisica,'TS')||obter_dados_pf(c.cd_pessoa_fisica,'RH'), b.ie_tipo_sangue||b.ie_fator_rh) ds_fator,
		CASE WHEN upper(san_obter_resul_trans_vgs(null, b.nr_sequencia, 7))='NEGATIVO' THEN 'N' WHEN upper(san_obter_resul_trans_vgs(null, b.nr_sequencia, 7))='POSITIVO' THEN 'P'  ELSE 'NR' END  ds_dfraco,
		lpad(b.qt_volume,3,0)	qt_volume,
		b.dt_vencimento dt_validade,
		i.ie_bolsa_pediatrica,
		b.ie_aliquotado ie_bolsa_aliquotada,
		CASE WHEN b.ie_sistema_aliquotagem='A' THEN 'A' WHEN b.ie_sistema_aliquotagem='F' THEN 'C' END  ie_sistema,
		b.dt_inicio_alicotagem dt_abertura_bolsa,
		b.ie_pool	ie_bolsa_pool,
		b.nr_sec_saude	nr_seq_pool,
		CASE WHEN w.nr_seq_inutil IS NULL THEN 		CASE WHEN w.nr_seq_trans IS NULL THEN 		CASE WHEN w.nr_seq_emp IS NULL THEN  'DISTSH'  ELSE 'DISTIND' END   ELSE 'TRAN' END   ELSE 'DESC' END  cd_destino,
		lpad(w.nr_seq_trans,15,0) 		nr_seq_transfusao,
		'N'	ie_interrompida, --Pendente
		e.dt_inutilizacao 	dt_descarte,
		lpad(e.nr_seq_motivo_inutil,2,0) 	cd_motivo_descarte,
		z.dt_emprestimo		dt_distribuicao,
		lpad(i.cd_externo,15,0) 		cd_hemocomponente_sh,
		SUBSTR(i.ds_derivado,1,100) 		ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	FROM san_derivado i, san_lote_integracao d, san_producao b
LEFT OUTER JOIN san_emprestimo h ON (b.nr_seq_emp_ent = h.nr_sequencia)
LEFT OUTER JOIN san_entidade m ON (h.nr_seq_entidade = m.nr_sequencia)
, san_lote_item w
LEFT OUTER JOIN san_inutilizacao e ON (w.nr_seq_inutil = e.nr_sequencia)
LEFT OUTER JOIN san_transfusao c ON (w.nr_seq_trans = c.nr_sequencia)
LEFT OUTER JOIN san_emprestimo z ON (w.nr_seq_emp = z.nr_sequencia)
WHERE b.nr_seq_derivado	= i.nr_sequencia  and w.nr_seq_producao	= b.nr_sequencia and w.nr_seq_lote		= d.nr_sequencia     
union

select  -- Registro com informacoes sobre a transfusao
		w.nr_seq_lote,
		'20' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		lpad(lpad(p.ie_tipo_sangue,2,' ')||p.ie_fator_rh,3,' ') ds_fator,
		CASE WHEN upper(san_obter_resul_trans_vgs(a.nr_sequencia, null, 7))='NEGATIVO' THEN 'N' WHEN upper(san_obter_resul_trans_vgs(a.nr_sequencia, null, 7))='POSITIVO' THEN 'P'  ELSE 'NR' END  ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		lpad(w.nr_seq_trans,15,0)	nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		a.dt_transfusao,
		CASE WHEN Obter_Tipo_Atendimento(a.nr_atendimento)=7 THEN  2 WHEN Obter_Tipo_Atendimento(a.nr_atendimento)=8 THEN  1 WHEN Obter_Tipo_Atendimento(a.nr_atendimento)=1 THEN  3 END  cd_local_tranfusao,
		lpad(a.ie_tipo_transfusao,2,0) cd_tipo_transfusao,
		(select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
		from	san_exame    k,
			san_exame_realizado f,
			san_exame_lote g
		where	f.nr_seq_exame_lote	= g.nr_sequencia
		and	k.nr_sequencia		= f.nr_seq_exame
		and	g.nr_seq_transfusao	= a.nr_sequencia
		and	k.ie_tipo_sangue 	= 'S'
		and	f.dt_liberacao is not null
		)	ie_tipagem_direta,
		(select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
		from	san_exame    k,
			san_exame_realizado f,
			san_exame_lote g
		where	g.nr_seq_transfusao	= a.nr_sequencia
		and	f.nr_seq_exame_lote	= g.nr_sequencia
		and	k.nr_sequencia		= f.nr_seq_exame
		and	k.ie_tipo_exame	= 3
		and	f.dt_liberacao is not null
		)	ie_tipagem_reversa,
		upper(rpad(Obter_ultimo_exame_pai(a.cd_pessoa_fisica),3,' ')) ds_pai,
		(select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END 
		from	san_exame    k,
			san_exame_realizado f,
			san_exame_lote g
		where	g.nr_seq_transfusao	= a.nr_sequencia
		and	f.nr_seq_exame_lote	= g.nr_sequencia
		and	k.nr_sequencia		= f.nr_seq_exame
		and	k.ie_tipo_exame	= 1
		and	f.dt_liberacao is not null
		)	ie_prova_cruzada,
		CASE WHEN upper(san_obter_resul_trans_vgs(a.nr_sequencia, null, '6'))='POSITIVO' THEN 'POS' WHEN upper(san_obter_resul_trans_vgs(a.nr_sequencia, null, '6'))='NEGATIVO' THEN 'NEG'  ELSE 'NAR' END  ds_coombs_direto,
		lpad(q.cd_externo,2,0) cd_classificacao_transf,
		CASE WHEN(select max(x.ie_tipo_convenio)		from	atendimento_paciente x		where	x.nr_atendimento = a.nr_atendimento)=1 THEN 1 WHEN(select max(x.ie_tipo_convenio)		from	atendimento_paciente x		where	x.nr_atendimento = a.nr_atendimento)=3 THEN 2  ELSE 3 END    cd_convenio,
		lpad(a.cd_pessoa_fisica,15,0) nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	FROM san_lote_item w, pessoa_fisica p, san_transfusao a
LEFT OUTER JOIN san_classif_reserva_trans q ON (a.nr_seq_classif = q.nr_sequencia)
WHERE a.nr_sequencia		= w.nr_seq_trans  and p.cd_pessoa_fisica	= a.cd_pessoa_fisica and w.nr_seq_inutil is null
 
union

SELECT 	--Registro com informacoes sobre o receptor
		w.nr_seq_lote,
		'21' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		null	nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		lpad(p.cd_pessoa_fisica,15,0) nr_receptor,
		upper(substr(p.nm_pessoa_fisica,1,60)) nm_receptor,
		p.dt_nascimento dt_nascimento,
		upper(substr(obter_nome_pai_mae(p.cd_pessoa_fisica,'M'),1,255)) nm_mae,
		p.ie_sexo,
		upper(substr(obter_nome_pai_mae(p.cd_pessoa_fisica,'P'),1,255)) nm_pai,
		p.dt_obito,
		lpad((select max(cd_externo) 
		from nacionalidade x 
		where x.cd_nacionalidade = p.cd_nacionalidade 
		and ie_situacao = 'A'),5,0) cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		lpad(p.cd_cbo_sus,6,'0') cd_ocupacao,
		CASE WHEN p.nr_identidade IS NULL THEN  '999'  ELSE 'RG' END  ds_documento,
		lpad(coalesce(p.nr_cpf, p.nr_identidade),20,0) cd_documento,
		rpad(p.ds_orgao_emissor_ci,2,' ') ds_orgao_expedidor,
		lpad(cp.cd_cep,8,0),
		null	cd_pais,
		'         R'	ie_logradouro,
		rpad(sus_obter_desc_tipolog(cp.cd_tipo_logradouro),60,' ') ds_logradouro,
		lpad(cp.nr_endereco,10,0) nr_endereco,
		rpad(cp.ds_complemento,40,' ') ds_complemento,
		rpad(cp.ds_bairro,40,' ') ds_bairro,
		null	cd_municipio,
		lpad(cp.nr_telefone,11,0) nr_telefone_res,
		lpad(cp.ds_fone_adic,11,0) nr_telefone_cel,
		rpad(cp.ds_email,60,' ') ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	FROM san_lote_item w, san_transfusao a, pessoa_fisica p
LEFT OUTER JOIN compl_pessoa_fisica cp ON (p.cd_pessoa_fisica = cp.cd_pessoa_fisica AND '1' = cp.ie_tipo_complemento)
WHERE a.nr_sequencia		= w.nr_seq_trans and a.cd_pessoa_fisica	= p.cd_pessoa_fisica   and w.nr_seq_inutil is null
 
union

SELECT 	--Registro com informacoes sobre a fenotipagem do receptor
		w.nr_seq_lote,
		'22' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		lpad(w.nr_seq_trans,15,0) nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		c.nr_sistema_sang nr_sistema_sang,
		c.nr_antigeno nr_antigeno,
		c.ds_resultado ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	from	san_transfusao	a,
		san_producao	b,
		san_derivado i,
		san_lote_item w,
		TABLE(SAN_RESULT_FENOTIPAGEM_TABLE.RETURN_FENOTIPAGEM(w.nr_seq_lote)) c
	where	a.nr_sequencia		= w.nr_seq_trans
	and	b.nr_seq_derivado	= i.nr_sequencia
	and	w.nr_seq_producao	= b.nr_sequencia
	and	c.nr_seq_transfusao	= a.nr_sequencia
	and	w.nr_seq_inutil is null

union

select 	--Registro com informacoes sobre anticorpos do receptor
        DISTINCT
		q.nr_seq_lote,
		'23' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		lpad(q.nr_seq_trans,15,0) nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		(case
			WHEN l.ie_resultado = 'S' THEN 'POS'
			WHEN l.ie_anti_nao_identificado = 'S' and l.ie_resultado = 'N' THEN 'INC'
			WHEN l.ie_resultado = 'N' THEN 'NEG'
		end) ie_resultado,
		s.nr_anticorpo nr_seq_anticorpo,
		null cd_reacao_transfusional
	from san_transfusao	r,
    san_lote_item q,
    san_exame_lote o,
    san_exame_realizado n,
    san_exame_anticorpos l,
    san_valor_integ_anticorpo s
where	r.nr_sequencia = q.nr_seq_trans
and o.nr_seq_transfusao	= r.nr_sequencia
and	n.nr_seq_exame_lote	= o.nr_sequencia
and n.nr_seq_exame_lote = l.nr_seq_exame_lote
and l.nr_seq_anticorpo = s.nr_seq_anticorpo
and	q.nr_seq_inutil is null

union

select 	--Registro com informacoes sobre reacao transfusional
		w.nr_seq_lote,
		'24' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		lpad(w.nr_seq_trans,15,0) nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		substr(x.cd_reacao_externa,1,3) cd_reacao_transfusional
	from	san_transfusao	a,
		san_producao	b,
		san_lote_item w,
		san_trans_reacao y,
		san_tipo_reacao x
	where	a.nr_sequencia		= w.nr_seq_trans
	and	w.nr_seq_producao	= b.nr_sequencia
	and	y.nr_seq_producao	= b.nr_sequencia
	and	y.nr_seq_reacao		= x.nr_sequencia
	and	w.nr_seq_inutil is null

union

select 	--Trailer do arquivo
		d.nr_sequencia nr_seq_lote,
		'99' nr_tipo_registro,
		null	cd_versao,
		null	cd_sh,
		null	ds_arquivo,
		null	nr_seq_arquivo,
		null	dt_geracao,
		null	dt_inicio_periodo,
		null	dt_fim_periodo,
		null	nr_bolsa,
		null	cd_sh_origem,
		null	nr_seq_doacao_visa,
		null	nr_seq_doacao_sh,
		null	dt_doacao,
		null	cd_hemocomponente,
		null	ie_lavado,
		null	ie_filtrado,
		null	ie_irradiado,
		null	ds_fator,
		null	ds_dfraco,
		null	qt_volume,
		null	dt_validade,
		null	ie_bolsa_pediatrica,
		null	ie_bolsa_aliquotada,
		null	ie_sistema,
		null	dt_abertura_bolsa,
		null	ie_bolsa_pool,
		null	nr_seq_pool,
		null	cd_destino,
		null	nr_seq_transfusao,
		null	ie_interrompida,
		null	dt_descarte,
		null	cd_motivo_descarte,
		null	dt_distribuicao,
		null	cd_hemocomponente_sh,
		null	ds_hemocomponente,
		null	dt_transfusao,
		null	cd_local_tranfusao,
		null	cd_tipo_transfusao,
		null	ie_tipagem_direta,
		null	ie_tipagem_reversa,
		null	ds_pai,
		null	ie_prova_cruzada,
		null	ds_coombs_direto,
		null	cd_classificacao_transf,
		null	cd_convenio,
		null	nr_receptor,
		null	nm_receptor,
		null	dt_nascimento,
		null	nm_mae,
		null	ie_sexo,
		null	nm_pai,
		null	dt_obito,
		null	cd_nacionalidade,
		null	cd_naturalidade,
		null	cd_raca,
		null	cd_estado_civil,
		null	cd_escolaridade,
		null	cd_ocupacao,
		null	ds_documento,
		null	cd_documento,
		null	ds_orgao_expedidor,
		null	cd_cep,
		null	cd_pais,
		null	ie_logradouro,
		null	ds_logradouro,
		null	nr_endereco,
		null	ds_complemento,
		null	ds_bairro,
		null	cd_municipio,
		null	nr_telefone_res,
		null	nr_telefone_cel,
		null	ds_email,
		null	nr_sistema_sang,
		null	nr_antigeno,
		null	ds_resultado,
		null	nr_seq_anticorpo,
		null	cd_reacao_transfusional
	from	san_lote_integracao d;

