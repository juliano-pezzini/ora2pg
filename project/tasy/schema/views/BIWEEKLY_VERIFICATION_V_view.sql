-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW biweekly_verification_v (seq, cd_prs_id, tc_id, ds_descricao, ds_funcao, nr_seq_ciclo, ds_tc_passo, ds_result_esperado, dt_execucao, ds_result_atual, result_passo, nm_executor, nr_seq_service_order, ie_status_ordem, medical_device, ds_estagio, ds_gerencia_os, ds_gerencia_funcao, ie_matriz_risco, ie_tipo_execucao, ds_tipo_mudanca, ds_descricao_os, ie_classificacao, ds_severidade, ds_justificativa_vv, ds_privacy_risk, potencial_security, ie_potencial_privacy, nr_seq_intencao_uso, ds_version, ie_clinico) AS select	b.seq,
	a.cd_prs_id,
	a.tc_id,
	a.ds_descricao,
	a.ds_funcao,
	a.nr_seq_ciclo,
	a.ds_tc_passo,
	a.ds_result_esperado,
	a.dt_execucao,
	a.ds_result_atual,
	a.result_passo,
	a.nm_executor,
	a.nr_seq_service_order,
	a.ie_status_ordem,
	a.medical_device,
	obter_desc_estagio_proc(man_obter_estagio_ordem(a.nr_seq_service_order)) ds_estagio,
	obter_nome_gerencia(obter_gerencia_resp_os(a.nr_seq_service_order)) ds_gerencia_os,
	obter_nome_gerencia(obter_gerencia_funcao_2(a.cd_funcao)) ds_gerencia_funcao,
	a.ie_matriz_risco,
	a.ie_tipo_execucao,
	a.ds_tipo_mudanca,
	c.ds_descricao_os,
	c.ie_classificacao,
	c.ds_severidade,
	c.ds_justificativa_vv,
	c.ds_privacy_risk,
	c.potencial_security,
	c.ie_potencial_privacy,
	a.nr_seq_intencao_uso,
	a.ds_version,
	coalesce(a.ie_clinico, b.ie_clinico, 'N') ie_clinico
FROM (select	row_number() OVER () AS seq,
		a.ds_key,
		a.nr_seq_intencao_uso,
		a.ds_version,
		a.ie_clinico
	from (select distinct x.nr_seq_tc ||'-'|| x.cd_funcao || CASE WHEN t.ie_obrigatorio='S' THEN '-'||t.ie_obrigatorio  ELSE '-N' END  ds_key,
			area.nr_seq_intencao_uso nr_seq_intencao_uso,
			x.ds_version ds_version,
			p.ie_clinico ie_clinico
		FROM reg_tc_pendencies x, reg_customer_requirement urs, reg_caso_teste t, reg_product_requirement p, reg_features_customer fea, reg_area_customer area, reg_tc_evidence_item y
LEFT OUTER JOIN reg_tc_so_pendencies z ON (y.nr_sequencia = z.nr_seq_ev_item)
WHERE y.nr_seq_ect = x.nr_sequencia  and t.nr_sequencia = x.nr_seq_tc and t.nr_seq_product = p.nr_sequencia and p.nr_customer_requirement = urs.nr_sequencia and urs.nr_seq_features = fea.nr_sequencia and fea.nr_seq_area_customer = area.nr_sequencia and x.ie_status <> 'E' ) a
	) b, (select	f.cd_funcao,
		p.cd_prs_id,
		'TASY_TC_' || x.nr_seq_tc tc_id,
		t.ds_descricao,
		obter_desc_expressao_idioma(f.cd_exp_funcao, f.ds_funcao, 5) ds_funcao,
		y.nr_seq_ciclo,
		y.ds_item_description ds_tc_passo,
		y.ds_result ds_result_esperado,
		trunc(y.dt_execution) dt_execucao,
		y.ds_exec_result ds_result_atual,
		CASE WHEN y.ie_result='P' THEN 'Passed' WHEN y.ie_result='B' THEN 'Blocked' WHEN y.ie_result='F' THEN 'Failed' END  result_passo,
		obter_nome_usuario(y.nm_user_execution) nm_executor,
		z.nr_seq_service_order,
		CASE WHEN(select r.ie_status_ordem			from man_ordem_servico r			where r.nr_sequencia = z.nr_seq_service_order)=1 THEN 'Open' WHEN(select r.ie_status_ordem			from man_ordem_servico r			where r.nr_sequencia = z.nr_seq_service_order)=2 THEN 'In progress' WHEN(select r.ie_status_ordem			from man_ordem_servico r			where r.nr_sequencia = z.nr_seq_service_order)=3 THEN 'Closed' END  ie_status_ordem,
		coalesce(c.ie_clinico, 'N') medical_device,
		x.nr_seq_tc ||'-'|| x.cd_funcao || CASE WHEN t.ie_obrigatorio='S' THEN '-'||t.ie_obrigatorio  ELSE '-N' END  ds_key,
        CASE WHEN(select max(rt.nr_seq_type)           from reg_product_req_type rt          where rt.nr_seq_type = 12            and rt.nr_seq_product_req = p.nr_sequencia)=12 THEN 'S'  ELSE 'N' END  ie_matriz_risco,
		coalesce(reg_test_plan_pck.get_change_type_desc(x.ie_tipo_mudanca),'Automacao') ds_tipo_mudanca,
		CASE WHEN t.ie_tipo_execucao='M' THEN 'Manual' WHEN t.ie_tipo_execucao='A' THEN 'Automatizado'  ELSE '' END  ie_tipo_execucao,
		area.nr_seq_intencao_uso nr_seq_intencao_uso,
		x.ds_version ds_version,
		p.ie_clinico ie_clinico
	FROM reg_caso_teste t, reg_product_requirement p, reg_features_customer fea, reg_customer_requirement c, reg_area_customer area, reg_tc_pendencies x
LEFT OUTER JOIN funcao f ON (x.cd_funcao = f.cd_funcao)
, reg_tc_evidence_item y
LEFT OUTER JOIN reg_tc_so_pendencies z ON (y.nr_sequencia = z.nr_seq_ev_item)
WHERE y.nr_seq_ect = x.nr_sequencia   and t.nr_sequencia = x.nr_seq_tc and t.nr_seq_product = p.nr_sequencia and c.nr_sequencia = p.nr_customer_requirement and c.nr_seq_features = fea.nr_sequencia and fea.nr_seq_area_customer = area.nr_sequencia and x.ie_status <> 'E'
	 ) a
LEFT OUTER JOIN (select	mos.nr_sequencia nr_seq_os,
                mos.ds_dano_breve ds_descricao_os,
                obter_valor_dominio(1149, mos.ie_classificacao) ie_classificacao,
                (select	substr(obter_desc_expressao(ms.cd_exp_severidade, ms.ds_severidade), 1, 255) ds_severidade
                from	man_severidade ms
                where 	ms.nr_sequencia = mos.nr_seq_severidade) ds_severidade,
                obter_nome_gerencia(nr_seq_gerencia_insatisf) ds_gerencia,
                (select	max(ds_justificativa)
                from	man_ordem_serv_analise_vv mosav
                where	mosav.nr_seq_ordem_serv = mos.nr_sequencia
                and	mosav.dt_atualizacao = (select	max(mosavd.dt_atualizacao)
                                                from	man_ordem_serv_analise_vv mosavd
                                                where	mosavd.nr_seq_ordem_serv = mosav.nr_seq_ordem_serv)) ds_justificativa_vv,
                obter_valor_dominio(9431, mos.ie_severity_harm) ds_privacy_risk,
                CASE WHEN mos.ie_potencial_security='N' THEN  'Nao' WHEN mos.ie_potencial_security='S' THEN  'Sim' WHEN mos.ie_potencial_security IS NULL THEN  'Nao' END  potencial_security,
                CASE WHEN mos.ie_potencial_privacy='N' THEN  'Nao' WHEN mos.ie_potencial_privacy='S' THEN  'Sim' WHEN mos.ie_potencial_privacy IS NULL THEN  'Nao' END  ie_potencial_privacy
        from	man_ordem_servico mos) c ON (a.nr_seq_service_order = c.nr_seq_os)
WHERE a.ds_key = b.ds_key  and a.nr_seq_intencao_uso = b.nr_seq_intencao_uso and a.ds_version = b.ds_version;

