-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ocupacao_acomodacao_v (cd_tipo_acomodacao, ds_tipo_acomodacao, cd_setor_atendimento, ds_setor_atendimento, cd_estabelecimento_base, qt_unidade, qt_unidade_temp, qt_unidade_ocupada, qt_unidade_acomp, qt_unidade_livre, qt_unidade_interditada, qt_unidade_higienizacao, qt_unidade_reservada, qt_unid_temp_ocup, qt_unidades_alta) AS SELECT  /*+ ORDERED */	A.cd_tipo_acomodacao,
	A.ds_tipo_acomodacao,
      	C.cd_setor_atendimento,
      	C.ds_setor_atendimento,
	C.cd_estabelecimento_base,
	COUNT(*) qt_unidade,
      	sum(CASE WHEN B.IE_TEMPORARIO='S' THEN  1  ELSE 0 END ) qt_UNIDADE_TEMP,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='P' THEN  1  ELSE 0 END ) qt_UNIDADE_OCUPADA,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='M' THEN  1  ELSE 0 END ) qt_UNIDADE_ACOMP,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='L' THEN  1  ELSE 0 END ) qt_UNIDADE_LIVRE,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='I' THEN  1  ELSE 0 END ) qt_UNIDADE_INTERDITADA,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='H' THEN  1  ELSE 0 END ) qt_UNIDADE_HIGIENIZACAO,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='R' THEN  1  ELSE 0 END ) qt_UNIDADE_RESERVADA,
	sum(CASE WHEN B.IE_TEMPORARIO='S' THEN 	    CASE WHEN B.IE_STATUS_UNIDADE='P' THEN  1  ELSE 0 END   ELSE 0 END ) qt_UNID_TEMP_OCUP,
	sum(CASE WHEN B.IE_STATUS_UNIDADE='A' THEN  1  ELSE 0 END ) QT_UNIDADES_ALTA
FROM 	SETOR_ATENDIMENTO C,
     	UNIDADE_ATENDIMENTO B,
	TIPO_ACOMODACAO A
WHERE B.CD_SETOR_ATENDIMENTO     = C.CD_SETOR_ATENDIMENTO
  AND B.IE_SITUACAO              = 'A'
  AND A.CD_TIPO_ACOMODACAO	   = B.CD_TIPO_ACOMODACAO
  and C.CD_CLASSIF_SETOR IN (3,4)
GROUP BY 	A.cd_tipo_acomodacao,
		A.ds_tipo_acomodacao,
		C.cd_setor_atendimento,
		C.ds_setor_atendimento,
		C.cd_estabelecimento_base;

