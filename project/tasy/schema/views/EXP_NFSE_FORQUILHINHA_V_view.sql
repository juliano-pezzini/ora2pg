-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_forquilhinha_v (cd_estabelecimento, nr_nota_fiscal, ie_situacao, dt_emissao, dt_prestacao_servico, nr_nota_substituida, ei_nat_operacao, nr_nfe_imp, cd_serie_nf, ie_tipo_rps, dt_emissao_rps, ie_status_rps, nr_nfe_imp_sub, nr_serie_rps_substituido, vl_servico, nr_cnae, id_atividade, vl_base_calculo, vl_aliquota, vl_iss, ie_status_iss_retido, ds_servicos, cd_municipio, qtd_servicos_prestados, vl_unitario_serv_prestado, nr_cmc_empresa, nm_rz_emp_prest, nm_fant_emp_servico, cd_cpf_cnpj_prest, nm_end_emp_serv, nr_end_prestador, nm_compl_prestador, nm_bairro_prestador, cd_municipio_prestador, un_uf_prestador, nr_cep_prestador, nm_email_prestador, nr_tel_prestador, nr_cpf_cnpj_tomador, ie_pessoa_tomadora_serv, nm_rz_social_tomador, nm_end_tomador, nr_end_tomador, nm_compl_end_tomador, nm_bairro_tomador, cd_cidade_tomador, un_uf_tomador, nr_cep_tomador, nm_email_tomador, nr_telefone_tomador, dt_cancelamento, ie_sincronizacao, vl_deducoes, vl_pis, vl_confins, vl_inss, vl_ir, vl_csll) AS select 	cd_estabelecimento cd_estabelecimento,	/*  criada por rkorz */
	lpad(0,15,0) nr_nota_fiscal, 
	CASE WHEN a.ie_situacao=1 THEN  '1' WHEN a.ie_situacao=3 THEN  '1' WHEN a.ie_situacao=9 THEN  '1' END ie_situacao, 
	a.dt_emissao dt_emissao, 
	to_char(a.dt_emissao,'yyyymm')dt_prestacao_servico, 
	lpad(0,15,0) nr_nota_substituida, 
	lpad(nfse_obter_regra('TP',a.cd_estabelecimento),2,0) ei_nat_operacao, 
	lpad(a.nr_nota_fiscal,15,0) nr_nfe_imp, --lpad(a.nr_nfe_imp,15,0) nr_rps, 
	lpad(cd_serie_nf,5,0) cd_serie_nf, -- lpad(a.cd_serie_rps,5,0) nr_serie_rps, 
 	CASE WHEN nfse_obter_regra('TR',cd_estabelecimento)=1 THEN '1' WHEN nfse_obter_regra('TR',cd_estabelecimento)=2 THEN '2' WHEN nfse_obter_regra('TR',cd_estabelecimento)=3 THEN '3' END  ie_tipo_rps, 
	a.dt_emissao dt_emissao_rps, -- a.dt_emissao_nfe dt_emissao_rps, 
	CASE WHEN a.ie_situacao=1 THEN  '1' WHEN a.ie_situacao=3 THEN  '1' WHEN a.ie_situacao=9 THEN  '1' END  ie_status_rps, 
	lpad(0,15,0) nr_nfe_imp_sub, 
	lpad(0,5,0) nr_serie_rps_substituido, 
	lpad(sip_campo_mascara_virgula(CASE WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=1 THEN  a.vl_total_nota WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=2 THEN  a.vl_total_nota - a.vl_descontos WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=3 THEN  a.vl_mercadoria WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=4 THEN a.vl_mercadoria - a.vl_descontos END ),16,0) vl_servico, 
	lpad(pls_obter_cd_cnae(obter_dados_pf_pj(null, a.cd_cgc_emitente,'CNAE')),7,' ') nr_cnae, 
	lpad(644,15,0) id_atividade, 	--lpad(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia, 	'P'),obter_procedimento_nfse(a.nr_sequencia,'O')),'CD'),15,0) id_atividade, 
	CASE WHEN sip_campo_mascara_virgula(obter_base_calc_icms_nf(a.nr_sequencia))='0,00' THEN lpad(sip_campo_mascara_virgula(CASE WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=1 THEN  a.vl_total_nota WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=2 THEN  a.vl_total_nota - a.vl_descontos WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=3 THEN a.vl_mercadoria WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=4 THEN  a.vl_mercadoria - a.vl_descontos END ),16,0)  ELSE lpad(sip_campo_mascara_virgula(obter_base_calc_icms_nf(a.nr_sequencia)),16,0) END  vl_base_calculo, 
	lpad(sip_campo_mascara_virgula(2),16,0) vl_aliquota, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','ISS')),16,0) vl_iss, 
	CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  '1'  ELSE '2' END  ie_status_iss_retido, 
 	coalesce(replace(replace(substr(obter_descricao_rps(a.cd_estabelecimento, a.nr_sequencia, 'DS_SERVICOS'), 1, 1000), CHR(13), ' '), CHR(10), ' '), 	'Servicos') ds_servicos, 
  	 lpad(obter_tom_municipio_ibge(obter_dados_pf_pj(null, a.cd_cgc_emitente, 'CDM')),15,0) cd_municipio, 
	lpad((	select	count(b.cd_procedimento) 
		FROM  nota_fiscal_item b 
		where b.nr_sequencia = a.nr_sequencia),15,0) qtd_servicos_prestados, 
	lpad(sip_campo_mascara_virgula(CASE WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=1 THEN  a.vl_total_nota WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=2 THEN  a.vl_total_nota - a.vl_descontos WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=3 THEN a.vl_mercadoria WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=4 THEN  a.vl_mercadoria - a.vl_descontos END ),16,0) vl_unitario_serv_prestado, 
	lpad(obter_dados_pf_pj(null,cd_cgc_emitente, 'IM'),15,0) nr_cmc_empresa, -- numero cmc da empresa 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'N') nm_rz_emp_prest, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'F') nm_fant_emp_servico, 
	lpad(a.cd_cgc_emitente,14,0) cd_cpf_cnpj_prest, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'LO') ||' '|| obter_dados_pf_pj(null, a.cd_cgc_emitente,'R') nm_end_emp_serv, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'NR') nr_end_prestador,	 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'CO') nm_compl_prestador, 	 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'B') nm_bairro_prestador, 
	lpad(obter_tom_municipio_ibge(obter_dados_pf_pj(null, a.cd_cgc_emitente, 'CDM')),15,0) cd_municipio_prestador, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'UF') un_uf_prestador, 
	lpad(obter_dados_pf_pj(null, a.cd_cgc_emitente,'CEP'),8,0) nr_cep_prestador, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'M') nm_email_prestador, 
	obter_dados_pf_pj(null, a.cd_cgc_emitente,'T') nr_tel_prestador, 
	CASE WHEN a.cd_cgc='' THEN lpad(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),14,0)  ELSE lpad(a.cd_cgc,14,0) END  nr_cpf_cnpj_tomador, 
	CASE WHEN obter_dados_pf(a.cd_pessoa_fisica,'CPF')='' THEN CASE WHEN a.cd_cgc='' THEN '03'  ELSE '02' END   ELSE '01' END  ie_pessoa_tomadora_serv, 
	CASE WHEN a.cd_pessoa_fisica IS NULL THEN obter_dados_pf_pj(null, a.cd_cgc, 'N')  ELSE obter_nome_pf(a.cd_pessoa_fisica) END  nm_rz_social_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'EN') nm_end_tomador, 
	coalesce(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'NR'),0) nr_end_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CO') nm_compl_end_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'B') nm_bairro_tomador, 
	lpad(obter_tom_municipio_ibge(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CDM')),15,0) cd_cidade_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'UF') un_uf_tomador, 
	coalesce(lpad(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CEP'),8,0),lpad(0,8,0)) nr_cep_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'M') nm_email_tomador, 
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'T') nr_telefone_tomador, 
	a.dt_cancelamento_nfe dt_cancelamento, 
	1 ie_sincronizacao, 
	lpad(sip_campo_mascara_virgula(a.vl_descontos),16,0) vl_deducoes, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','PIS')),16,0) vl_pis, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','COFINS')),16,0) vl_confins, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','INSS')),16,0) vl_inss, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','IR')),16,0) vl_ir, 
	lpad(sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','CSLL')),16,0)vl_csll 
from 	nota_fiscal a 
where 	ie_situacao <> 2 
and	obter_se_nota_entrada_saida(nr_sequencia) = 'S';

