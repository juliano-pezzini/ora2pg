-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW integracao_eritel_v (cd_estabelecimento, cd_setor_atendimento, ds_setor_atendimento, cd_unidade_basica, nr_ramal, ie_status_unidade, ds_status_unidade, dt_status, cd_evento_eritel) AS SELECT 	s.cd_estabelecimento,
	s.cd_setor_atendimento,
	s.ds_setor_atendimento,
	u.cd_unidade_basica,
	u.nr_ramal,
	u.ie_status_unidade,
	obter_valor_dominio(82,u.ie_status_unidade) ds_status_unidade,
	(select max(dt_historico)
		FROM unidade_atend_hist h 
		where h.nr_seq_unidade = u.nr_seq_interno) dt_status,
	(select max(v.cd_evento_eritel)
		from	sl_unid_atend v
		where	v.nr_sequencia = (select max(b.nr_sequencia) from sl_unid_atend b where u.nr_seq_interno = b.nr_seq_unidade)) cd_evento_eritel
from  	unidade_atendimento u,
	setor_atendimento s
where 	s.cd_setor_atendimento = u.cd_setor_atendimento
and 	s.ie_situacao = 'A'
and 	u.ie_situacao = 'A'
and 	s.cd_classif_setor in (2,3,4,9)
order by 1,3,4;

