-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hcbcs_interf_afpergs_servicos (tp_registro, ds_registro, nr_seq_protocolo, dt_emissao, cd_profissional, dt_mesano_referencia, cd_cgc, ds_razao_social, nr_registro, dt_atendimento, cd_usuario_convenio, cd_item, cd_categoria, tp_tabela, vl_total_item, qt_total_reg, vl_total_protocolo) AS select	0 tp_registro,
	'Cabeçalho' ds_registro, 
	b.nr_seq_protocolo, 
	to_char(LOCALTIMESTAMP,'DDMMYYYY') dt_emissao, 
	0 cd_profissional, 
	to_char(b.dt_mesano_referencia,'DDMMYYYY') dt_mesano_referencia, 
	substr(obter_cgc_estabelecimento(b.cd_estabelecimento),1,14) cd_cgc, 
	substr(obter_razao_social(obter_cgc_estabelecimento(b.cd_estabelecimento)),1,40) ds_razao_social, 
	row_number() OVER () AS nr_registro, 
	''	dt_atendimento, 
	'' 	cd_usuario_convenio, 
	0	cd_item, 
	''	cd_categoria, 
	0	tp_tabela, 
	0	vl_total_item, 
	0	qt_total_reg, 
	0	vl_total_protocolo 
FROM	protocolo_convenio b, 
	w_interf_conta_cab a 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 

union all
 
select	1 tp_registro, 
	'Movimento' ds_registro, 
	b.nr_seq_protocolo, 
	''	dt_emissao, 
	0	cd_profissional, 
	'' 	dt_mesano_referencia, 
	'' 	cd_cgc, 
	'' 	ds_razao_social, 
	row_number() OVER () AS nr_registro, 
	substr(to_char(obter_data_entrada(a.nr_atendimento),'DDMMYYYY'),1,6) dt_atendimento, 
	a.cd_usuario_convenio, 
	c.cd_item, 
	CASE WHEN c.ie_origem_proced=1 THEN '0'  ELSE 'N' END  cd_categoria, 
	CASE WHEN c.ie_origem_proced=1 THEN 1  ELSE 2 END  tp_tabela,       
	c.vl_total_item, 
	0	qt_total_reg, 
	0	vl_total_protocolo 
from	protocolo_convenio b, 
	w_interf_conta_cab a, 
	w_interf_conta_item c 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 
and	c.nr_interno_conta = a.nr_atendimento 
and	ie_tipo_item = 1 

union all
 
select	2 tp_registro, 
	'Rodapé' ds_registro, 
	0	nr_seq_protocolo, 
	''	dt_emissao, 
	0	cd_profissional, 
	'' 	dt_mesano_referencia, 
	'' 	cd_cgc, 
	'' 	ds_razao_social, 
	0	nr_registro, 
	''	 dt_atendimento, 
	''	cd_usuario_convenio, 
	0	cd_item, 
	''	cd_categoria, 
	0	tp_tabela,       
	0	vl_total_item, 
	count(*) qt_total_reg, 
	sum(c.vl_total_item) vl_total_protocolo 
from	protocolo_convenio b, 
	w_interf_conta_cab a, 
	w_interf_conta_item c 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 
and	c.nr_interno_conta = a.nr_atendimento 
and	ie_tipo_item = 1;

