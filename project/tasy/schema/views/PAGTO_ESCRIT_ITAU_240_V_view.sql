-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pagto_escrit_itau_240_v (tp_registro, ie_forma_pagto, nr_seq_forma_pagto, nr_inscricao, cd_agencia, cd_conta, ds_dac_agencia, nm_empresa, ds_banco, dt_arquivo, nr_seq_envio, ie_tipo_fornecedor, cd_cgc_fornecedor, cd_agencia_bancaria, ds_dac_ag_bancaria, nr_conta_forneced, nm_hospital, ds_endereco, ds_cidade, cd_cep, ds_estado, cd_banco_fornecedor, cd_agencia_fornecedor, cd_agencia_conta, nm_fornecedor, nr_documento, dt_vencimento, vl_saldo_titulo, nr_inscricao_fornec, qt_registros, ie_cod_barras, vl_titulo, vl_desconto, vl_acrescimo, dt_pagto, vl_pagto, vl_total_pagto, qt_lotes_arquivo, qt_total_registros, nr_lote_servico, vl_juros, vl_multa, vl_csll, vl_pis, vl_ir, vl_iss, vl_cofins) AS SELECT  0 tp_registro,
        '0' ie_forma_pagto,
        0 nr_seq_forma_pagto,
        a.cd_cgc nr_inscricao,
        somente_numero(g.cd_agencia_bancaria) cd_agencia,
        g.cd_conta,
        g.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(p.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(g.ds_banco)) ds_banco,
        TO_CHAR(e.dt_remessa_retorno, 'ddmmyyyyhh24miss') dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	0 nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    estabelecimento a,
        banco_estabelecimento_v g,
        pessoa_juridica p,
        banco_escritural e
WHERE   e.cd_estabelecimento    = a.cd_estabelecimento
AND     a.cd_cgc                = p.cd_cgc
AND     g.nr_sequencia          = e.nr_seq_conta_banco
AND     g.ie_tipo_relacao       IN ('EP','ECC')

UNION

/* HEADER DE LOTE DOC ITAÚ */

SELECT  1 tp_registro,
        '03' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(j.ds_municipio) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOC', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              = 341
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                        = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao               IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'DOC'
GROUP BY        e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(j.ds_municipio),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('DOC', c.nr_seq_escrit)

UNION

/* DOC ITAÚ SEGMENTO A */

SELECT  2 tp_registro,
        '03' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOC', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              = 341
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND	c.ie_tipo_pagamento	= 'DOC'

UNION

/* DOC ITAÚ SEGMENTO C */

SELECT  3 tp_registro,
        '03' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOC', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM titulo_pagar_escrit c, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_imposto g
LEFT OUTER JOIN tributo h ON (g.cd_tributo = h.cd_tributo)
, titulo_pagar_v2 d
LEFT OUTER JOIN titulo_pagar_imposto g ON (d.nr_titulo = g.nr_titulo)
WHERE c.cd_banco              = 341 AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento	= 'DOC' ) alias47
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE DOC ITAÚ */

SELECT  4 tp_registro,
        '03' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOC', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        banco_estabelecimento_v b,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              = 341
AND     e.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     k.nr_titulo             = c.nr_titulo
AND     b.ie_tipo_relacao               IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'DOC'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.nr_sequencia,
        Obter_tipo_pagamento('DOC', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE TED MESMO FORNECEDOR */

SELECT  1 tp_registro,
        '43' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(j.ds_municipio) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'TED'
GROUP BY        e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(j.ds_municipio),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('TEDMT', c.nr_seq_escrit)

UNION

/* TED MESMO FORNECEDOR SEGMENTO A */

SELECT  2 tp_registro,
        '43' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'TED'

UNION

/* TED MESMO FORNECEDOR SEGMENTO C */

SELECT  3 tp_registro,
        '43' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDMT', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_imposto g
LEFT OUTER JOIN tributo h ON (g.cd_tributo = h.cd_tributo)
, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE e.cd_cgc                = d.cd_favorecido AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento     = 'TED' ) alias98
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE TED MESMO FORNECEDOR */

SELECT  4 tp_registro,
        '43' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM	titulo_pagar_v2 d,
	banco_estabelecimento_v b,
	estabelecimento a,
	banco_escritural e,
	titulo_pagar k,
	titulo_pagar_escrit c
WHERE	a.cd_cgc		= d.cd_favorecido
AND	e.nr_sequencia		= c.nr_seq_escrit
AND	e.cd_estabelecimento	= a.cd_estabelecimento
AND	k.nr_titulo		= c.nr_titulo
AND	b.ie_tipo_relacao	IN ('EP','ECC')
AND	b.nr_sequencia		= e.nr_seq_conta_banco
AND	c.ie_tipo_pagamento	= 'TED'
AND	k.nr_titulo		= d.nr_titulo
GROUP BY	e.nr_sequencia,
	Obter_tipo_pagamento('TEDMT', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE TED OUTRO FORNECEDOR */

SELECT  1 tp_registro,
        '41' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(j.ds_municipio) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                        <> d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                        = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao               IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'TED'
GROUP   BY e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(j.ds_municipio),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('TEDOT', c.nr_seq_escrit)

UNION

/* TED OUTRO FORNECEDOR SEGMENTO A */

SELECT  2 tp_registro,
        '41' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                <> d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'TED'

UNION

/* TED OUTRO FORNECEDOR SEGMENTO C */

SELECT  3 tp_registro,
        '41' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDOT', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and e.cd_cgc                <> d.cd_favorecido AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento     = 'TED' ) alias149
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE TED OUTRO FORNECEDOR */

SELECT  4 tp_registro,
        '41' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
	'' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('TEDOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        banco_estabelecimento_v b,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   a.cd_cgc                <> d.cd_favorecido
AND     e.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     k.nr_titulo             = c.nr_titulo
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'TED'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.nr_sequencia,
        Obter_tipo_pagamento('TEDOT', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE CC OUTRO FORNECEDOR */

SELECT  1 tp_registro,
        '01' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(j.ds_municipio) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                <> d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'
GROUP BY        e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(j.ds_municipio),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('CCOT', c.nr_seq_escrit)

UNION

/* CC OUTRO FORNECEDOR SEGMENTO A */

SELECT  2 tp_registro,
        '01' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                <> d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND	k.nr_titulo		= d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'

UNION

/* CC OUTRO FORNECEDOR SEGMENTO C */

SELECT  3 tp_registro,
        '01' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCOT', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and e.cd_cgc                <> d.cd_favorecido AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento     = 'CC' ) alias200
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE CC OUTRO FORNECEDOR */

SELECT  4 tp_registro,
        '01' ie_forma_pagto,
	1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCOT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        banco_estabelecimento_v b,
	estabelecimento a,
        banco_escritural e,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   a.cd_cgc                <> d.cd_favorecido
AND     e.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     k.nr_titulo             = c.nr_titulo
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.nr_sequencia,
        Obter_tipo_pagamento('CCOT', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE CC MESMO FORNECEDOR */

SELECT  1 tp_registro,
        '06' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(j.ds_municipio) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'
GROUP BY        e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(j.ds_municipio),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('CCMT', c.nr_seq_escrit)

UNION

/* CC MESMO FORNECEDOR SEGMENTO A */

SELECT  2 tp_registro,
        '06' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
	0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = d.cd_favorecido
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'

UNION

/* CC MESMO FORNECEDOR SEGMENTO C */

SELECT  3 tp_registro,
        '06' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCMT', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and e.cd_cgc                = d.cd_favorecido AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento     = 'CC' ) alias251
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE CC MESMO FORNECEDOR */

SELECT  4 tp_registro,
        '06' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
	0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
	'0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
	'' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('CCMT', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        banco_estabelecimento_v b,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   a.cd_cgc                = d.cd_favorecido
AND     e.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     k.nr_titulo             = c.nr_titulo
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'CC'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.nr_sequencia,
        Obter_tipo_pagamento('CCMT', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE BLQ ITAÚ */

SELECT  5 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.cd_cgc nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(upper(j.ds_municipio)) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        '' cd_agencia_fornecedor,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQ',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = j.cd_cgc
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     a.nr_seq_conta_banco    = b.nr_sequencia
AND     c.nr_titulo             = k.nr_titulo
AND     c.ie_tipo_pagamento     = 'BLQ'
AND     SUBSTR(k.nr_bloqueto, 1,3)      = 341
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.cd_cgc,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' '),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(upper(j.ds_municipio)),
        j.cd_cep,
        j.sg_estado,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('BLQ',c.nr_seq_escrit)

UNION

/* BLQ ITAÚ SEGMENTO A */

SELECT  6 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        c.cd_agencia_bancaria cd_agencia_bancaria,
        c.ie_digito_conta ds_dac_ag_bancaria,
        c.nr_conta nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        d.nr_bloqueto ie_cod_barras,
        d.vl_titulo,
        c.vl_desconto,
        (C.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        c.vl_escritural vl_pagto,
        (c.vl_escritural - c.VL_DESCONTO + C.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQ',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     a.nr_seq_conta_banco    = b.nr_sequencia
AND     c.ie_tipo_pagamento     = 'BLQ'
AND     SUBSTR(k.nr_bloqueto, 1,3) = 341

UNION

/* BLQ ITAÚ SEGMENTO C */

SELECT  7 tp_registro,
        CASE WHEN cd_banco=341 THEN '30'  ELSE '31' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        vl_desconto,
        vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQ', nr_seq_envio) nr_lote_servico,
	vl_juros,
	vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo,
		c.cd_banco
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND a.nr_seq_conta_banco    = b.nr_sequencia AND c.ie_tipo_pagamento     = 'BLQ' AND SUBSTR(d.nr_bloqueto, 1,3) = 341 ) alias312
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0) or (vl_desconto > 0) or (vl_juros > 0) or (vl_multa > 0) or (vl_acrescimo > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo,
        vl_desconto,
	vl_acrescimo,
	vl_juros,
        vl_multa,
	CASE WHEN cd_banco=341 THEN '30'  ELSE '31' END

UNION

/* TRAILER DE LOTE BLQ ITAÚ */

SELECT  8 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        SUM(d.vl_titulo) vl_titulo,
        SUM(c.vl_desconto) vl_desconto,
        SUM(c.vl_acrescimo) vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        COUNT(*) qt_lotes_arquivo,
        COUNT(*) qt_total_registros,
	Obter_tipo_pagamento('BLQ',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    banco_estabelecimento_v b,
        titulo_pagar_v2 d,
        titulo_pagar k,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar_escrit c
WHERE   e.nr_sequencia          = c.nr_seq_escrit
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'BLQ'
AND     SUBSTR(k.nr_bloqueto, 1,3) = 341
GROUP BY        e.nr_sequencia,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('BLQ',c.nr_seq_escrit)

UNION

/* HEADER DE LOTE DOC NÃO ITAÚ */

SELECT  1 tp_registro,
        '03' ie_forma_pagto,
        CASE WHEN(SELECT	COUNT(*)                FROM    titulo_pagar y,			titulo_pagar_escrit x                WHERE   x.nr_titulo     = y.nr_titulo                AND     x.nr_seq_escrit = a.nr_sequencia                AND     SUBSTR(y.nr_bloqueto, 1,3)      = 341)=0 THEN  1  ELSE 2 END  nr_seq_forma_pagto,
        e.CD_CGC nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        ' ' cd_cgc_fornecedor,
        ' ' cd_agencia_bancaria,
        ' ' ds_dac_ag_bancaria,
        ' ' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(upper(j.ds_municipio)) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        ' ' cd_agencia_fornecedor,
        ' ' cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOCN', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              <> 341
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_cgc                = j.cd_cgc
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'DOC'
GROUP BY        e.CD_CGC,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
	b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(upper(j.ds_municipio)),
        j.cd_cep,
        j.sg_estado,
        Obter_tipo_pagamento('DOCN', c.nr_seq_escrit)

UNION

/* DOC NÃO ITAÚ SEGMENTO A */

SELECT  2 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
	'' ds_banco,
        '' dt_arquivo,
	a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo,
        e.cd_cgc nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        k.vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOCN', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              <> 341
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = a.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'DOC'

UNION

/* DOC NÃO ITAÚ SEGMENTO C */

SELECT  3 tp_registro,
        '03' ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOCN', nr_seq_envio) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and c.cd_banco              <> 341 AND c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND b.nr_sequencia          = a.nr_seq_conta_banco AND c.ie_tipo_pagamento     = 'DOC' ) alias379
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo

UNION

/* TRAILER DE LOTE DOC NÃO ITAÚ */

SELECT  4 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
	'' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('DOCN', c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        banco_estabelecimento_v b,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   c.cd_banco              <> 341
AND     e.nr_sequencia          = c.nr_seq_escrit
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     k.nr_titulo             = c.nr_titulo
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'DOC'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.nr_sequencia,
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('DOCN', c.nr_seq_escrit)

UNION

/* HEADER DE LOTE BLQ NÃO ITAÚ */

SELECT  5 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        CASE WHEN(SELECT	COUNT(*)                FROM    titulo_pagar y,			titulo_pagar_escrit x                WHERE   x.nr_titulo     = y.nr_titulo                AND     x.nr_seq_escrit = a.nr_sequencia                AND     SUBSTR(y.nr_bloqueto, 1,3)      = 341)=0 THEN  1  ELSE 2 END  nr_seq_forma_pagto,
        e.cd_cgc nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
        b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '' nr_conta_forneced,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(upper(j.ds_municipio)) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        '' cd_agencia_fornecedor,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQN',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = j.cd_cgc
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     a.nr_seq_conta_banco    = b.nr_sequencia
AND     c.nr_titulo             = k.nr_titulo
AND     c.ie_tipo_pagamento     = 'BLQ'
AND (k.nr_bloqueto is null or SUBSTR(k.nr_bloqueto,1,3) <> 341)
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.cd_cgc,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' '),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(upper(j.ds_municipio)),
        j.cd_cep,
        j.sg_estado,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('BLQN',c.nr_seq_escrit)

UNION

/* BLQ NÃO ITAÚ SEGMENTO A */

SELECT  6 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        CASE WHEN(SELECT	COUNT(*)                FROM    titulo_pagar y,			titulo_pagar_escrit x                WHERE   x.nr_titulo     = y.nr_titulo                AND     x.nr_seq_escrit = a.nr_sequencia                AND     SUBSTR(y.nr_bloqueto, 1,3)      = 341)=0 THEN  1  ELSE 2 END  nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        c.cd_agencia_bancaria cd_agencia_bancaria,
        c.ie_digito_conta ds_dac_ag_bancaria,
        c.nr_conta nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        d.nr_bloqueto ie_cod_barras,
        d.vl_titulo,
        c.vl_desconto,
        (c.vl_acrescimo + C.VL_JUROS + C.VL_MULTA) vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        c.vl_escritural vl_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQN',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     a.nr_seq_conta_banco    = b.nr_sequencia
AND     c.ie_tipo_pagamento     = 'BLQ'
AND (k.nr_bloqueto is null or SUBSTR(k.nr_bloqueto,1,3) <> 341)

UNION

/* BLQ NÃO ITAÚ SEGMENTO C */

SELECT  7 tp_registro,
        CASE WHEN cd_banco=341 THEN '30'  ELSE '31' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        nr_seq_envio,
        '' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '0' cd_agencia_conta,
        '' nm_fornecedor,
        nr_titulo nr_documento,
        dt_vencimento_atual dt_vencimento,
        0 vl_saldo_titulo,
        '' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        vl_titulo vl_titulo,
        vl_desconto,
        vl_acrescimo,
        dt_vencimento_atual dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('BLQN', nr_seq_envio) nr_lote_servico,
	vl_juros,
	vl_multa,
	sum(vl_csll) vl_csll,
	sum(vl_pis) vl_pis,
	sum(vl_ir) vl_ir,
	sum(vl_iss) vl_iss,
        sum(vl_cofins) vl_cofins
FROM (select	a.nr_sequencia nr_seq_envio,
		d.nr_titulo,
		d.dt_vencimento_atual,
		d.vl_titulo,
		CASE WHEN h.ie_tipo_tributo='CSLL' THEN g.vl_imposto END  vl_csll,
		CASE WHEN h.ie_tipo_tributo='PIS' THEN g.vl_imposto END  vl_pis,
		CASE WHEN h.ie_tipo_tributo='IR' THEN g.vl_imposto END  vl_ir,
		CASE WHEN h.ie_tipo_tributo='ISS' THEN g.vl_imposto END  vl_iss,
		CASE WHEN h.ie_tipo_tributo='COFINS' THEN g.vl_imposto END  vl_cofins,
		c.vl_desconto,
		c.vl_juros,
		c.vl_multa,
		c.vl_acrescimo,
		c.cd_banco
	FROM tributo h, estabelecimento e, titulo_pagar_v2 d, banco_estabelecimento_v b, banco_escritural a, titulo_pagar_escrit c
LEFT OUTER JOIN titulo_pagar_imposto g ON (c.nr_titulo = g.nr_titulo)
WHERE g.cd_tributo		= h.cd_tributo  and c.nr_titulo             = d.nr_titulo AND a.nr_sequencia          = c.nr_seq_escrit AND a.cd_estabelecimento    = e.cd_estabelecimento AND b.ie_tipo_relacao       IN ('EP','ECC') AND a.nr_seq_conta_banco    = b.nr_sequencia AND c.ie_tipo_pagamento     = 'BLQ' AND (d.nr_bloqueto is null or SUBSTR(d.nr_bloqueto,1,3) <> 341) ) alias449
where (vl_csll > 0) or (vl_pis > 0) or (vl_ir > 0) or (vl_iss > 0) or (vl_cofins > 0) or (vl_desconto > 0) or (vl_juros > 0) or (vl_multa > 0) or (vl_acrescimo > 0)
group by	nr_seq_envio,
	nr_titulo,
	dt_vencimento_atual,
	vl_titulo,
        vl_desconto,
	vl_acrescimo,
	vl_juros,
        vl_multa,
	CASE WHEN cd_banco=341 THEN '30'  ELSE '31' END 

UNION

/* TRAILER DE LOTE BLQ NÃO ITAÚ */

SELECT  8 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        CASE WHEN(SELECT	COUNT(*)                FROM    titulo_pagar y,			titulo_pagar_escrit x                WHERE   x.nr_titulo     = y.nr_titulo                AND     x.nr_seq_escrit = e.nr_sequencia                AND     SUBSTR(y.nr_bloqueto, 1,3)      = 341)=0 THEN  1  ELSE 2 END  nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        SUM(d.vl_titulo) vl_titulo,
        SUM(c.vl_desconto) vl_desconto,
        SUM(c.vl_acrescimo) vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        COUNT(*) qt_lotes_arquivo,
        COUNT(*) qt_total_registros,
	Obter_tipo_pagamento('BLQN',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    banco_estabelecimento_v b,
        titulo_pagar_v2 d,
        titulo_pagar k,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar_escrit c
WHERE   e.nr_sequencia          = c.nr_seq_escrit
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'BLQ'
AND (k.nr_bloqueto is null or SUBSTR(k.nr_bloqueto,1,3) <> 341)
GROUP BY        e.nr_sequencia,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '33' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('BLQN',c.nr_seq_escrit)

UNION

/* HEADER DE LOTE PC */

SELECT  9 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '13' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        e.cd_cgc nr_inscricao,
        somente_numero(b.cd_agencia_bancaria) cd_agencia,
	b.cd_conta,
        b.ie_digito_conta ds_dac_agencia,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_empresa,
        Elimina_Acentuacao(upper(b.ds_banco)),
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        '2' ie_tipo_fornecedor,
        '' cd_cgc_fornecedor,
        '' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '' nr_conta_forneced,
	Elimina_Acentuacao(upper(j.ds_razao_social)) nm_hospital,
        Elimina_Acentuacao(upper(j.ds_endereco)) ds_endereco,
        Elimina_Acentuacao(upper(j.ds_municipio)) ds_cidade,
        j.cd_cep,
        j.sg_estado ds_estado,
        0 cd_banco_fornecedor,
        '' cd_agencia_fornecedor,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)) nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
	0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('PC',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_v2 d,
        pessoa_juridica j,
        Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar k,
        titulo_pagar_escrit c
WHERE   e.cd_cgc                = j.cd_cgc
AND	a.nr_sequencia		= c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     a.nr_seq_conta_banco    = b.nr_sequencia
AND     c.nr_titulo             = k.nr_titulo
AND     c.ie_tipo_pagamento     = 'PC'
AND     k.nr_titulo             = d.nr_titulo
GROUP BY        e.cd_cgc,
        somente_numero(b.cd_agencia_bancaria),
        b.cd_conta,
        b.ie_digito_conta,
        Elimina_Acentuacao(upper(j.ds_razao_social)),
        Elimina_Acentuacao(upper(b.ds_banco)),
        a.nr_sequencia,
        lpad(b.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(b.CD_CONTA,12,0)
        || lpad(b.ie_digito_conta,2,' '),
        Elimina_Acentuacao(upper(j.ds_endereco)),
        Elimina_Acentuacao(upper(j.ds_municipio)),
        j.cd_cep,
        j.sg_estado,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '13' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('PC',c.nr_seq_escrit)

UNION

/* PC SEGMENTO A */

SELECT  10 tp_registro,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '13' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        a.nr_sequencia nr_seq_envio,
        CASE WHEN k.cd_pessoa_fisica IS NULL THEN '2'  ELSE '1' END  ie_tipo_fornecedor,
        d.cd_favorecido cd_cgc_fornecedor,
        c.cd_agencia_bancaria cd_agencia_bancaria,
        c.ie_digito_conta ds_dac_ag_bancaria,
        c.nr_conta nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        c.cd_banco cd_banco_fornecedor,
        c.cd_agencia_bancaria cd_agencia_fornecedor,
        lpad(c.cd_agencia_bancaria,5,0)
        || ' '
        || lpad(c.nr_conta,12,0)
        || lpad(c.ie_digito_conta,2,' ') cd_agencia_conta,
        Elimina_Acentuacao(upper(d.nm_favorecido)) nm_fornecedor,
        d.nr_titulo nr_documento,
        d.dt_vencimento_atual dt_vencimento,
        d.vl_saldo_titulo vl_saldo_titulo,
        '0' nr_inscricao_fornec,
	0 qt_registros,
        d.nr_bloqueto ie_cod_barras,
        d.vl_titulo,
        c.vl_desconto,
        c.vl_acrescimo,
        d.dt_vencimento_atual dt_pagto,
        (c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        0 vl_total_pagto,
        0 qt_lotes_arquivo,
        0 qt_total_registros,
	Obter_tipo_pagamento('PC',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    Estabelecimento e,
        banco_estabelecimento_v b,
        banco_escritural a,
        titulo_pagar_v2 d,
        titulo_pagar_v k,
        titulo_pagar_escrit c
WHERE   c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     a.nr_sequencia          = c.nr_seq_escrit
AND     a.cd_estabelecimento    = e.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND	a.nr_seq_conta_banco	= b.nr_sequencia
AND     c.ie_tipo_pagamento     = 'PC'

UNION

/* TRAILER DE LOTE PC */

SELECT  11 tp_registro,
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '13' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_pagto,
        1 nr_seq_forma_pagto,
        '0' nr_inscricao,
	0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        0 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        COUNT(*) + 2 qt_registros,
        '' ie_cod_barras,
        SUM(d.vl_titulo) vl_titulo,
        SUM(c.vl_desconto) vl_desconto,
        SUM(c.vl_acrescimo) vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_pagto,
        SUM(c.vl_escritural - c.VL_DESCONTO + c.VL_ACRESCIMO + C.VL_JUROS + C.VL_MULTA) vl_total_pagto,
        COUNT(*) qt_lotes_arquivo,
        COUNT(*) qt_total_registros,
	Obter_tipo_pagamento('PC',c.nr_seq_escrit) nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    banco_estabelecimento_v b,
        titulo_pagar_v2 d,
        titulo_pagar k,
        estabelecimento a,
        banco_escritural e,
        titulo_pagar_escrit c
WHERE   e.nr_sequencia          = c.nr_seq_escrit
AND     c.nr_titulo             = d.nr_titulo
AND     k.nr_titulo             = d.nr_titulo
AND     e.cd_estabelecimento    = a.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     c.ie_tipo_pagamento     = 'PC'
GROUP BY        e.nr_sequencia,
        CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '01' WHEN c.ie_tipo_pagamento='TED' THEN '03' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='PC' THEN '13' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=341 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END ,
        Obter_tipo_pagamento('PC',c.nr_seq_escrit)

UNION

/* TRAILER DE ARQUIVO */

SELECT  12 tp_registro,
        '99' ie_forma_pagto,
        0 nr_seq_forma_pagto,
        '0' nr_inscricao,
        0 cd_agencia,
        '0' cd_conta,
        '' ds_dac_agencia,
        '' nm_empresa,
        '' ds_banco,
        '' dt_arquivo,
        e.nr_sequencia nr_seq_envio,
        ' ' ie_tipo_fornecedor,
        '0' cd_cgc_fornecedor,
        '0' cd_agencia_bancaria,
        '' ds_dac_ag_bancaria,
        '0' nr_conta_forneced,
        '' nm_hospital,
        '' ds_endereco,
        '' ds_cidade,
        '0' cd_cep,
        '' ds_estado,
        0 cd_banco_fornecedor,
        '0' cd_agencia_fornecedor,
        '' cd_agencia_conta,
        '' nm_fornecedor,
        99999 nr_documento,
        LOCALTIMESTAMP dt_vencimento,
        0 vl_saldo_titulo,
        '0' nr_inscricao_fornec,
        0 qt_registros,
        '' ie_cod_barras,
        0 vl_titulo,
        0 vl_desconto,
        0 vl_acrescimo,
        LOCALTIMESTAMP dt_pagto,
        0 vl_pagto,
        0 vl_total_pagto,
        (obter_dados_pagto_escrit(e.nr_sequencia,'QTLI'))::numeric  qt_lotes_arquivo,
        (obter_dados_pagto_escrit(e.nr_sequencia,'QTRI'))::numeric  qt_total_registros,
	999999 nr_lote_servico,
	0 vl_juros,
	0 vl_multa,
	0 vl_csll,
	0 vl_pis,
	0 vl_ir,
	0 vl_iss,
        0 vl_cofins
FROM    titulo_pagar_escrit c,
        banco_estabelecimento_v b,
        estabelecimento a,
        banco_escritural e
WHERE   e.cd_estabelecimento    = a.cd_estabelecimento
AND     b.ie_tipo_relacao       IN ('EP','ECC')
AND     b.nr_sequencia          = e.nr_seq_conta_banco
AND     e.nr_sequencia          = c.nr_seq_escrit
GROUP BY        e.nr_sequencia
ORDER BY        nr_lote_servico,
        ie_forma_pagto,
        tp_registro,
	nr_documento;

