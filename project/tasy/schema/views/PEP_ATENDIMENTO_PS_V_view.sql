-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pep_atendimento_ps_v (nr_atendimento, dt_entrada, dt_alta, dt_alta_interno, cd_pessoa_fisica, nm_pessoa_fisica, nr_prontuario, nm_guerra, cd_medico_resp, cd_estabelecimento, ds_sintoma_paciente, cd_setor_atendimento, cd_departamento, cd_unidade_basica, cd_unidade_compl, cd_unidade, ds_setor_atendimento, dt_nascimento, cd_medico_referido, dt_inicio_atendimento, nr_atend_original, ds_classif_atend, ds_cor_classif_atend, ds_idade, qt_idade, qt_idade_dia, hr_medicacao, hr_checagem_adep, hr_lib_medico, hr_inicio_consulta, hr_fim_consulta, hr_enfermagem, hr_fim_enfermagem, hr_chamado, hr_liberacao_enfermagem, hr_reavaliacao_medica, dt_chamada_paciente, dt_lib_medico, dt_liberacao_enfermagem, cd_medico_chamado, nm_medico_chamado, hr_espera, hr_pa, ds_unidade, ds_anotacao, qt_prescricao, cd_classif_setor, ds_convenio, ds_breve_local, ds_cor_local_pa, ie_clinica, nr_seq_classificacao, ds_clinica, ie_internado, ie_exame_lib, ie_exame_lib_exames, ie_exame_nao_lab_lib, ie_exame_lib_externo_exames, ds_carater_atendimento, nr_seq_queixa, ds_queixa, nr_seq_triagem, ds_triagem, ie_prioridade, ds_cor, ds_cor_fonte, ds_triagem_prioridade, ie_prioridade_classif, ds_cor_prioridade, ds_senha_qmatic, nr_seq_local_pa, cd_convenio, cd_categoria, ds_categoria, ie_tipo_atendimento, dt_atend_medico, dt_fim_consulta, dt_fim_triagem, dt_impressao, ds_motivo_transf, ds_obs_alta_trans, nm_hosp_destino, ds_necessidade_vaga, ie_status, dt_saida_prev_loc_pa, nr_atend_alta, dt_fim_conta, ds_tipo_atendimento, nm_medico_aux, cd_medico_aux, dt_chamada_enfermagem, ie_proced_atend, ie_clinica_ant, cd_pessoa_responsavel, dt_chamada_reavaliacao, dt_inicio_reavaliacao, ie_tipo_guia, ds_tipo_guia, ie_carater_inter_sus, nm_paciente, dt_fim_reavaliacao, dt_inicio_observacao, dt_fim_observacao, ie_permit_lib_med, ie_chamado, dt_cancelamento, nm_usuario, nr_seq_informacao, ds_informacao, dt_chamada_medic, nm_usuario_triagem, dt_medicacao, dt_recebimento_senha, nr_seq_pac_senha_fila, cd_medico_preferencia, dt_fim_senha, ds_senha_gerenciamento, hr_espera_senha, hr_inicio_esp_exame, hr_fim_esp_exame, dt_inicio_esp_exame, dt_fim_esp_exame, dt_inicio_prescr_pa, dt_fim_prescr_pa, ds_parecer, ie_prior_classif_atend, ie_exame_laudo_lib, ds_cor_motivo_alta_pa, ie_sexo, nm_pessoa_pesquisa, ds_fila, ds_cor_queixa, ds_cor_cons_med, ds_cor_triagem_cons, ds_cor_tempo_triagem, ds_cor_tempo_fim_tri, ds_cor_esp_cons, ds_cor_esp_triagem, cd_senha_gerada, nr_seq_fila_espera, ds_cor_convenio, ie_sem_prioridade, ds_cor_isolamento_cih, qt_prescr_pendente, ie_pac_isolado, ie_exame_urgente, ds_cor_regra, ds_cor_tempo, ie_laudo_lib_int, ie_possui_prescr, ie_laudo_urgente, ds_cor_inf, nr_seq_triagem_prioridade, dt_chegada_medic, hr_inicio_observacao, hr_fim_observacao, nr_seq_pa_status, qt_temp_dif_triagem_cons, qt_temp_dif_esp_triagem, qt_tempo_reg_esp_cons, qt_temp_reg_esp_triagem, qt_tempo_reg_triagem_cons, qt_tempo_regra_triagem, qt_tempo_esp_cons_med, ie_necessidade_reconsulta, ds_status_processo_pa, nr_cpf) AS SELECT	
	a.nr_atendimento,
	a.dt_entrada,  
	a.dt_alta,  
	a.dt_alta_interno,  
	a.cd_pessoa_fisica,  
	substr(obter_nome_pf(p.cd_pessoa_fisica),1,60) nm_pessoa_fisica,  
	p.nr_prontuario,  
	SUBSTR(obter_nome_medico(cd_medico_resp,'G'),1,60) nm_guerra,  
	a.cd_medico_resp,  
	a.cd_estabelecimento,  
	a.ds_sintoma_paciente,  
	b.cd_setor_atendimento,
	b.cd_departamento,
	b.cd_unidade_basica,  
	b.cd_unidade_compl,  
	b.cd_unidade_basica || ' ' ||b.cd_unidade_compl  cd_unidade,  
	s.ds_setor_atendimento,  
	p.dt_nascimento,
	a.cd_medico_referido,
	a.dt_inicio_atendimento,
	a.nr_atend_original,
	SUBSTR(OBTER_DESC_CLASSIF_ATEND(NR_SEQ_CLASSIFICACAO),1,90) DS_CLASSIF_ATEND,
	SUBSTR(OBTER_cor_CLASSIF_ATEND(NR_SEQ_CLASSIFICACAO),1,15) DS_COR_CLASSIF_ATEND,  
	SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'S'),1,15) ds_idade,  
	SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'A'),1,15) qt_idade, 
	TRUNC((SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'DIA'),1,15))::numeric ) qt_idade_dia,
	TO_CHAR(a.dt_medicacao,'hh24:mi') hr_medicacao,  
	TO_CHAR(a.DT_CHECAGEM_ADEP,'hh24:mi') hr_checagem_adep,  
	TO_CHAR(a.dt_lib_medico,'hh24:mi') hr_lib_medico,  
	TO_CHAR(a.dt_atend_medico,'hh24:mi') hr_inicio_consulta,  
	TO_CHAR(a.dt_fim_consulta,'hh24:mi') hr_fim_consulta,  
	TO_CHAR(a.dt_inicio_atendimento,'hh24:mi') hr_enfermagem,  
	TO_CHAR(a.dt_fim_triagem,'hh24:mi') hr_fim_enfermagem,  
	TO_CHAR(a.dt_chamada_paciente,'hh24:mi') hr_chamado,  
	TO_CHAR(a.dt_liberacao_enfermagem,'hh24:mi') hr_liberacao_enfermagem,  
	TO_CHAR(a.dt_reavaliacao_medica,'hh24:mi') hr_reavaliacao_medica,  
	a.dt_chamada_paciente,  
	a.dt_lib_medico,  
	a.dt_liberacao_enfermagem,  
	a.cd_medico_chamado,  
	SUBSTR(obter_nome_pf(a.cd_medico_chamado),1,60) nm_medico_chamado,
	SUBSTR(obter_horas_minutos(ROUND((coalesce(coalesce(a.dt_atend_medico,a.dt_alta), LOCALTIMESTAMP) - a.dt_entrada) * 1440)),1,10) hr_espera,  
	SUBSTR(obter_horas_minutos(ROUND((coalesce(dt_alta, LOCALTIMESTAMP) - coalesce(a.dt_atend_medico,LOCALTIMESTAMP)) * 1440)),1,10) hr_pa,
	b.cd_unidade_basica || ' ' ||b.cd_unidade_compl ds_unidade,
	SUBSTR(obter_anotacao_pendente(a.nr_atendimento),1,255) ds_anotacao,  
	SUBSTR(Obter_qt_prescr_Atend(a.nr_atendimento),1,255) qt_prescricao,  
	s.cd_classif_setor,  
	SUBSTR(Obter_Nome_Convenio(c.cd_convenio),1,50)  ds_convenio,  
	SUBSTR(obter_desc_abrev_local_pa(nr_seq_local_pa),1,255) ds_breve_local,  
	SUBSTR(obter_cor_local_pa(nr_seq_local_pa),1,255) ds_cor_local_pa,  
	a.ie_clinica,  
	a.nr_seq_classificacao,  
	SUBSTR(obter_valor_dominio(17,a.ie_clinica),1,60) ds_clinica,  
	SUBSTR(Obter_se_pa_internado(a.nr_atendimento),1,1) ie_internado,  
	SUBSTR(Obter_se_exame_lib(a.nr_atendimento),1,1) ie_exame_lib,  
	SUBSTR(Obter_se_exame_lib_exames(a.nr_atendimento),1,1) ie_exame_lib_exames,  
	SUBSTR(Obter_se_exame_nao_lib(a.nr_atendimento),1,1) ie_exame_nao_lab_lib,
	SUBSTR(Obter_se_exame_externo_lib(a.nr_atendimento),1,1) ie_exame_lib_externo_exames,
	SUBSTR(obter_valor_dominio(802, a.IE_CARATER_INTER_SUS),1,100)  ds_carater_atendimento,
	a.nr_seq_queixa,
	SUBSTR(Obter_Queixas_Atendimento(a.nr_atendimento,a.nr_seq_queixa),1,255) ds_queixa,
	a.nr_seq_triagem,
	SUBSTR(coalesce(coalesce(obter_desc_triagem(a.nr_seq_triagem), obter_triagem_atendimento(a.nr_atendimento)),obter_desc_sem_triagem(a.nr_seq_triagem)),1,60) ds_triagem,
	obter_prioridade_tcr(a.nr_seq_triagem) ie_prioridade,
	SUBSTR(obter_cor_tcr(a.nr_seq_triagem,'C'),1,15) ds_cor,  
	SUBSTR(obter_cor_tcr(a.nr_seq_triagem,'F'),1,15) ds_cor_fonte,
	SUBSTR(obter_dados_tcp(a.nr_seq_triagem_prioridade,'DESC'),1,60) ds_triagem_prioridade,
	(obter_dados_tcp(a.nr_seq_triagem_prioridade,'SEQ'))::numeric  ie_prioridade_classif,  
	SUBSTR(obter_dados_tcp(a.nr_seq_triagem_prioridade,'COR'),1,15) ds_cor_prioridade,  
	a.ds_senha_qmatic,  
	a.nr_seq_local_pa,
	c.cd_convenio cd_convenio,
	c.cd_categoria cd_categoria,  
	SUBSTR(obter_categoria_convenio(c.cd_convenio,c.cd_categoria),1,255) ds_categoria,
	a.ie_tipo_atendimento,
	a.dt_atend_medico,
	a.dt_fim_consulta,  
	a.dt_fim_triagem,
	a.dt_impressao,
	SUBSTR(Obter_dados_alta_transf(a.nr_atendimento,'DM'),1,60) ds_motivo_transf,  
	SUBSTR(Obter_dados_alta_transf(a.nr_atendimento,'O'),1,60) ds_obs_alta_trans,  
	SUBSTR(Obter_dados_alta_transf(a.nr_atendimento,'HD'),1,60) nm_hosp_destino,
	SUBSTR(Obter_Dados_GV(a.nr_atendimento),1,255) ds_necessidade_vaga,
	SUBSTR(obter_status_atend_pa_nova(	a.nr_Atendimento,a.dt_alta,  
						a.dt_medicacao,  
						a.dt_lib_medico,  
						a.dt_atend_medico,  
						a.dt_fim_consulta,  
						a.dt_inicio_atendimento	,  
						a.dt_fim_triagem,  
						a.dt_chamada_paciente,  
						a.dt_liberacao_enfermagem,  
						a.dt_reavaliacao_medica,  
						a.nr_atend_alta,  
						a.cd_estabelecimento,  
						a.dt_fim_reavaliacao,  
						a.dt_inicio_observacao,  
						a.dt_fim_observacao,
						a.dt_chamada_reavaliacao, 
						a.dt_inicio_reavaliacao,
						a.ie_chamado,
						a.dt_chamada_enfermagem),1,10) ie_status,
	a.dt_saida_prev_loc_pa,  
	a.nr_atend_alta,  
	a.dt_fim_conta,
	SUBSTR(obter_nome_tipo_atend(a.IE_TIPO_ATENDIMENTO),1,30) ds_tipo_atendimento,
	SUBSTR(obter_medico_aux_pa(a.nr_atendimento,'N'),1,80) nm_medico_aux,
	SUBSTR(obter_medico_aux_pa(a.nr_atendimento,'C'),1,80) cd_medico_aux,
	a.dt_chamada_enfermagem,
	obter_se_prescr_proc_atend_pa(a.cd_estabelecimento,a.nr_atendimento) ie_proced_atend,
	a.ie_clinica_ant,
	a.cd_pessoa_responsavel,
	a.dt_chamada_reavaliacao,  
	a.dt_inicio_reavaliacao,  
	c.ie_tipo_guia,  
	SUBSTR(obter_valor_dominio(1031,c.ie_tipo_guia),1,200) ds_tipo_guia,
	a.ie_carater_inter_sus,
	SUBSTR(OBTER_NOME_SOCIAL_PF(a.cd_pessoa_fisica),1,100) nm_paciente,
	a.dt_fim_reavaliacao,
	a.dt_inicio_observacao,  
	a.dt_fim_observacao,
	SUBSTR(Obter_se_atend_permit_lib_pa(a.nr_atendimento,a.cd_estabelecimento),1,10) ie_permit_lib_med,
	a.ie_chamado,  
	a.dt_cancelamento,  
	a.nm_usuario,  
	a.nr_seq_informacao,  
	a.ds_informacao,  
	a.dt_chamada_medic,
	a.nm_usuario_triagem,
	a.dt_medicacao,
	a.dt_recebimento_senha,
	a.nr_seq_pac_senha_fila,  
	a.cd_medico_preferencia,
	obter_data_fim_senha(a.nr_seq_pac_senha_fila) dt_fim_senha,
	SUBSTR(obter_letra_verifacao_senha(obter_fila_senha(a.nr_seq_pac_senha_fila)) || obter_dados_senha(a.nr_seq_pac_senha_fila, 'CD'),1,20) ds_senha_gerenciamento,
	SUBSTR(obter_horas_minutos(ROUND((coalesce(a.dt_fim_consulta, LOCALTIMESTAMP) - TO_DATE(obter_dados_senha(a.nr_seq_pac_senha_fila,'DG'),'dd/mm/yyyy hh24:mi:ss')) * 1440)),1,10) hr_espera_senha,
	TO_CHAR(a.dt_inicio_esp_exame,'hh24:mi') hr_inicio_esp_exame,
	TO_CHAR(a.dt_fim_esp_exame,'hh24:mi') hr_fim_esp_exame,  
	a.dt_inicio_esp_exame,  
	a.dt_fim_esp_exame,  
	a.dt_inicio_prescr_pa,  
	a.dt_fim_prescr_pa,
	SUBSTR(obter_se_atend_parecer(a.nr_atendimento),1,100) ds_parecer,
	obter_prioridade_classif_atend(a.nr_seq_classificacao) ie_prior_classif_atend,  
	SUBSTR(Obter_se_exame_laudo_lib(a.nr_atendimento),1,1) ie_exame_laudo_lib,  
	obter_cor_motivo_alta_pa(a.cd_motivo_alta) ds_cor_motivo_alta_pa,  
	p.ie_sexo,
	p.nm_pessoa_pesquisa,
	substr(coalesce(obter_dados_fila_triagem(a.nr_atendimento,'DS'),obter_dados_senha(a.nr_seq_pac_senha_fila,'DS')),1,255) ds_fila,
	substr(obter_cor_queixa_paciente(a.nr_atendimento, a.nr_seq_queixa),1,50) ds_cor_queixa,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_ATEND_MEDICO,'C',a.DT_FIM_CONSULTA,'TMC'),1,50) DS_COR_CONS_MED,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_FIM_TRIAGEM,'C',a.DT_ATEND_MEDICO,'TTC'),1,50) DS_COR_TRIAGEM_CONS,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_INICIO_ATENDIMENTO,'C',a.DT_FIM_TRIAGEM,'TMT'),1,50) DS_COR_TEMPO_TRIAGEM,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.dt_fim_triagem,'C',a.dt_alta,'TDE'),1,50) ds_cor_tempo_fim_tri,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_ENTRADA,'C',a.DT_ATEND_MEDICO,'TIC'),1,50) DS_COR_ESP_CONS,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.dt_entrada,'C',a.DT_INICIO_ATENDIMENTO,'ETT'),1,50) DS_COR_ESP_TRIAGEM,
	substr(obter_dados_senha(a.nr_seq_pac_senha_fila,'CD'),1,100) CD_SENHA_GERADA,
	substr(obter_dados_senha(a.nr_seq_pac_senha_fila,'SF'),1,100) NR_SEQ_FILA_ESPERA,
	substr(obter_cor_convenio(c.cd_convenio),1,15) DS_COR_CONVENIO,
	CASE WHEN obter_prioridade_tcr(a.nr_seq_triagem)=999 THEN 0  ELSE obter_prioridade_tcr(a.nr_seq_triagem) END  ie_sem_prioridade,
	substr(obter_dados_tipo_isolamento(obter_tipo_isolamento_cih(a.nr_atendimento),'C'),1,255) DS_COR_ISOLAMENTO_CIH,
	substr(obter_qt_prescr_pendente(a.nr_atendimento),1,255) QT_PRESCR_PENDENTE,
	substr(obter_se_pac_isolamento(a.nr_atendimento),1,10) IE_PAC_ISOLADO,
	Obter_se_pend_exame_urgente(a.nr_atendimento) ie_exame_urgente,
	obter_cor_grid_atend_local_pa(a.nr_atendimento) ds_cor_regra,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_FIM_TRIAGEM,'C',a.dt_alta,'TDE'),1,50) ds_cor_tempo,
	substr(atend_prescr_compl_laudo_lib(a.nr_atendimento),1,1) ie_laudo_lib_int,
	substr(obter_se_possui_prescr(a.nr_atendimento),1,150) ie_possui_prescr,
	substr(Obter_se_laudo_urg(a.nr_atendimento),1,1) IE_LAUDO_URGENTE,
	SUBSTR(obter_informacao_atendimento(a.nr_seq_informacao, 'C'),1,254) DS_COR_INF,
	a.nr_seq_triagem_prioridade,
	a.dt_chegada_medic,
	TO_CHAR(a.dt_inicio_observacao,'hh24:mi') hr_inicio_observacao,
	TO_CHAR(a.dt_fim_observacao,'hh24:mi') hr_fim_observacao,
	coalesce(a.NR_SEQ_PA_STATUS,(obter_desc_status_pa(a.NR_SEQ_PA_STATUS,'C'))::numeric ) NR_SEQ_PA_STATUS,
	SUBSTR(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_FIM_TRIAGEM,'R',a.DT_ATEND_MEDICO,'TTC'),1,50) qt_temp_dif_triagem_cons,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.dt_entrada,'R',a.DT_INICIO_ATENDIMENTO,'ETT'),1,50) QT_TEMP_DIF_ESP_TRIAGEM,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_ENTRADA,'T',a.DT_ATEND_MEDICO,'TIC'),1,50) QT_TEMPO_REG_ESP_CONS,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.dt_entrada,'T',a.DT_INICIO_ATENDIMENTO,'ETT'),1,50) QT_TEMP_REG_ESP_TRIAGEM,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_FIM_TRIAGEM,'T',a.DT_ATEND_MEDICO,'TTC'),1,50) QT_TEMPO_REG_TRIAGEM_CONS,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_INICIO_ATENDIMENTO,'T',a.DT_FIM_TRIAGEM,'TMT'),1,50) QT_TEMPO_REGRA_TRIAGEM,
	substr(obter_tempo_regra_espera_pa(a.ie_clinica,a.nr_seq_triagem,a.DT_ATEND_MEDICO,'T',a.DT_FIM_CONSULTA,'TMC'),1,50) QT_TEMPO_ESP_CONS_MED,
	obter_se_reavaliacao_medic(a.nr_atendimento) IE_NECESSIDADE_RECONSULTA,
	OBTER_STATUS_PROCESSO_PA(a.nr_atendimento) DS_STATUS_PROCESSO_PA,
	substr(obter_dados_pf(a.CD_PESSOA_FISICA,'CPF'),1,100) NR_CPF
FROM setor_atendimento s, 
	pessoa_fisica p,  
	atend_categoria_convenio c,  
	atend_paciente_unidade b,  
	atendimento_paciente a  
WHERE	a.nr_atendimento 	= b.nr_atendimento  
AND	b.nr_seq_interno 	= obter_atepacu_paciente(a.nr_atendimento, 'A')
AND	a.nr_Atendimento 	= c.nr_atendimento  
AND	c.nr_seq_interno	=  obter_atecaco_atendimento(a.nr_atendimento)
AND	a.cd_pessoa_fisica		= p.cd_pessoa_fisica  
and	s.cd_setor_atendimento = b.cd_setor_atendimento
AND	a.nr_atendimento	> 0 /* Rafael em 07/10/2006 OS 41178 */
  
AND	EXISTS (SELECT 1  
		FROM	setor_atendimento x,  
			atend_paciente_unidade y  
		WHERE	a.nr_atendimento = y.nr_atendimento  
		AND	y.cd_setor_atendimento	= x.cd_setor_atendimento  
		AND	x.cd_classif_setor	= '1');

