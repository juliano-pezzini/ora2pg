-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW waiting_list_chemotherapy (se_dia, se_agendado, nm_pessoa_fisica, cd_pessoa_fisica, nr_ciclo, nr_seq_atendimento, nr_seq_pend_agenda, cd_estabelecimento, ie_alocado, encounter_number, agenda_id, medication_protocol, gender, ie_crianca, date_of_birth, cycle, cycle_day, arrived, dt_chegada, duration, dt_real, dt_prevista, dt_fim_adm, ds_observacao, ds_precaucao, ds_classif_paciente, nr_seq_local, nr_prescricao) AS select
        qt_obter_se_dia_agendado(paciente_atendimento.nr_seq_atendimento, coalesce(paciente_atendimento.dt_real, paciente_atendimento.dt_prevista)) se_dia,
        qt_obter_se_agendado(paciente_atendimento.nr_seq_pend_agenda, coalesce(paciente_atendimento.dt_real, paciente_atendimento.dt_prevista)) se_agendado,
        nm_pessoa_fisica,
        cd_pessoa_fisica,
        nr_ciclo,
        nr_seq_atendimento,
        nr_seq_pend_agenda,
        paciente_atendimento.cd_estabelecimento,
        ie_alocado,
        paciente_atendimento.nr_atendimento       as encounter_number,
        paciente_atendimento.nr_seq_atendimento   as agenda_id,
        substr(obter_desc_prot_medic(paciente_atendimento.nr_seq_paciente), 1, 255) as medication_protocol,
        ( obter_sexo_pf(pessoa_fisica.cd_pessoa_fisica, 'C') ) as gender,
        (
            case
                when obter_idade_pf(pessoa_fisica.cd_pessoa_fisica, LOCALTIMESTAMP, 'A') < 18 then
                    'S'
                else
                    'N'
            end
        ) as ie_crianca,
        to_char(pessoa_fisica.dt_nascimento, 'DD/MM/YYYY') as date_of_birth,
        paciente_atendimento.nr_ciclo as cycle,
        paciente_atendimento.ds_dia_ciclo as cycle_day,
        (CASE WHEN paciente_atendimento.dt_chegada IS NOT NULL THEN 'S' ELSE 'N' END) as arrived,
        paciente_atendimento.dt_chegada,
        paciente_atendimento.qt_tempo_medic as duration,
        paciente_atendimento.dt_real,
        paciente_atendimento.dt_prevista,
        paciente_atendimento.dt_fim_adm,
        paciente_atendimento.ds_observacao,
        substr(obter_precaucao_isolamento(paciente_atendimento.nr_atendimento, 'D'), 1, 255) as ds_precaucao,
        substr(qt_obter_desc_classif_paciente(pessoa_fisica.cd_pessoa_fisica), 1, 255) as ds_classif_paciente,
        paciente_atendimento.nr_seq_local,
        paciente_atendimento.nr_prescricao
    FROM
        paciente_atendimento,
        pessoa_fisica
    where
        pessoa_fisica.cd_pessoa_fisica = obter_cd_paciente_setor(paciente_atendimento.nr_seq_paciente)
        and ((obter_valor_param_usuario(380, 6, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'S')
          and (paciente_atendimento.nr_prescricao is not null)
          or (obter_valor_param_usuario(380, 6, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'N' ))
        and ((obter_valor_param_usuario(380, 7, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'S')
          and (paciente_atendimento.dt_liberacao_atend is not null)
          or (obter_valor_param_usuario(380, 7, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'N'))
        and ((obter_valor_param_usuario(380, 8, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'S')
          and (paciente_atendimento.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento)
          or (obter_valor_param_usuario(380, 8, obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento) = 'N'));

