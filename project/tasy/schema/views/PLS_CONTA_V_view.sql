-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_v (nr_sequencia, nr_seq_protocolo, ie_tipo_guia, ie_regime_internacao, ie_regime_internacao_imp, ie_carater_internacao, ie_carater_internacao_imp, ie_tipo_conta, ie_tipo_consulta, ie_tipo_consulta_imp, nr_seq_saida_int, nr_seq_saida_consulta, nr_seq_clinica, nr_seq_clinica_imp, nr_seq_tipo_acomodacao, ie_origem_conta, ie_medico_exec_informado, nr_seq_tipo_atendimento, nr_seq_segurado, nr_seq_prestador_exec_imp, nr_seq_prestador_exec, cd_pessoa_fisica_conta, cd_cgc_conta, nr_seq_competencia, nr_seq_prestador, nr_seq_prestador_conta, nr_seq_prestador_imp, cd_medico_executor, cd_medico_executor_imp, cd_medico_solicitante, cd_medico_solicitante_imp, nr_seq_conselho_exec, nr_seq_conselho_solic, nr_seq_grau_partic, nr_seq_grau_partic_conta, nr_seq_guia, ie_status, dt_entrada, dt_entrada_imp, dt_alta, dt_alta_imp, dt_emissao, dt_emissao_imp, dt_emissao_dd, dt_emissao_imp_dd, cd_usuario_plano_imp, cd_guia, cd_guia_pesquisa, cd_guia_imp, cd_guia_ref, cd_guia_solic_imp, dt_atendimento_inf, dt_atendimento_imp_inf, dt_atendimento_inf_dd, dt_atendimento_imp_inf_dd, dt_autorizacao, cd_senha, cd_senha_imp, cd_senha_externa, nr_seq_analise, nr_seq_conta_referencia, nr_seq_fatura, nr_seq_nota_cobranca, sg_conselho_exec_imp, uf_crm_exec_imp, nr_crm_exec_imp, cd_cbo_saude_exec_imp, nr_seq_cbo_saude, cd_cbo_saude_solic_imp, nr_seq_cbo_saude_solic, vl_total_imp, nr_seq_saida_spsadt, ie_tipo_partic_prof, nr_crm_exec, cd_cooperativa, cd_estabelecimento, cd_cnes, cd_cnes_executor_imp, cd_guia_prestador, ds_indicacao_clinica, ds_indicacao_clinica_imp, ie_obito_mulher, qt_nasc_vivos_termo, qt_nasc_mortos, qt_nasc_mortos_imp, qt_obito_precoce, qt_obito_precoce_imp, qt_obito_tardio, qt_obito_tardio_imp, ie_tipo_acomodacao_ptu, cd_guia_referencia, nr_seq_lote_pgto, nr_seq_prestador_solic, cd_doenca_dig, nr_seq_prestador_exec_imp_ref, nr_documento, vl_total, nr_seq_tipo_conta, nr_seq_prot_referencia, dt_lib_pagamento, nr_seq_periodo_pgto, cd_congenere, cd_estabelecimento_prot, dt_protocolo, dt_mes_competencia, nr_seq_prestador_prot, dt_geracao_analise_lote, ie_status_lote, ie_tipo_protocolo, nr_seq_lote_conta, ie_status_protocolo, ie_situacao_protocolo, ie_origem_protocolo, qt_contas_informadas_prot, vl_cobrado_manual_prot, nr_protocolo_prestador, dt_recebimento_prot, nr_seq_congenere_prot, dt_mes_competencia_trunc, sg_estado, cd_municipio_ibge, nr_seq_congenere, ie_apresentacao, nr_seq_prestador_imp_prot, dt_fim_tratamento, qt_dias_internacao, nr_seq_clas_prest_exec, cd_prestador_exec, nr_seq_tipo_prest_exec, ie_tipo_vinculo_prest_exec, cd_cgc_prest_exec, cd_pessoa_fisica_prest, ie_tipo_relacao_prest_exec, ie_regra_data_preco_mat_exec, nr_seq_clas_prest_prot, cd_prestador_prot, nr_seq_tipo_prest_prot, ie_situacao_prest_prot, ie_tipo_relacao_prest_prot, ie_tipo_vinculo_prest_prot, cd_pessoa_fisica_prest_prot, cd_cgc_prest_prot, nr_seq_clas_prest_solic, cd_prestador_solic, nr_seq_tipo_prest_solic, ie_situacao_prest_solic, qt_nasc_mortos_num, qt_nasc_mortos_imp_num, qt_nasc_vivos_num, qt_nasc_vivos_imp_num, qt_nasc_vivos_premat_num, qt_nasc_vivos_premat_imp_num, qt_nasc_vivos_termo_num, qt_obito_precoce_num, qt_obito_precoce_imp_num, qt_obito_tardio_num, qt_obito_tardio_imp_num, qt_nasc_vivos_total, qt_nasc_vivos_total_imp, qt_obito_total, qt_nasc_total_imp, qt_nasc_total, qt_obito_total_imp, ie_internado, ie_internado_imp, ie_vinc_internado, nr_seq_cbo_saude_imp, nr_seq_cbo_saude_solic_imp, cd_usuario_plano, ie_tipo_internado, ie_tipo_internado_imp, ie_internacao_obstetrica, ie_tipo_intercambio, dt_atendimento, dt_atendimento_dd, dt_atendimento_conta, dt_atendimento_conta_dd, dt_atendimento_imp, dt_atendimento_imp_dd, nr_seq_tipo_atend_imp, nr_seq_tipo_acomod_imp, ie_glosa, cd_tiss_atendimento, nr_fatura, ie_status_fatura, nr_nota_cobranca, dt_recebimento_fatura, dt_postagem_fatura, qt_sum_proc, qt_sum_auto_gerado_proc, vl_conta, nr_seq_intercambio, nr_seq_congenere_seg, ie_tipo_segurado, nr_seq_plano, ie_sexo_benef, dt_nascimento_benef, ie_segmentacao_benef, ie_tipo_contratacao_benef, nr_seq_contrato, qt_idade_benef_mes, qt_idade_benef, qt_idade_benef_dia, ie_preco_pre_pos_misto, cd_medico_solic_guia, ie_status_analise, nr_seq_guia_conta, nr_seq_guia_referencia, ie_status_guia, nr_seq_prestador_req, cd_cid_principal, cd_cid_principal_imp, cd_cat_cid_principal, cd_cat_cid_principal_imp, qt_horas_atendimento, dt_alta_ref, dt_entrada_ref, dt_documento, cd_versao_tiss, dt_fim_faturamento, dt_fim_faturamento_imp, dt_inicio_faturamento, dt_inicio_faturamento_imp, ie_indicador_dorn, ie_indicador_dorn_imp, ie_exige_autorizacao, ds_observacao, ds_observacao_imp, dt_protocolo_imp, nr_crm_solic_imp, uf_crm_solic_imp, sg_conselho_solic_imp, ie_tipo_gat, cd_prestador_exec_imp, nr_seq_tipo_prest_exec_imp, cd_prestador_prot_imp, nr_seq_tipo_prest_prot_imp, ie_recem_nascido_imp, ie_recem_nascido, nr_seq_prest_inter, nm_usuario_conta_nrec, nm_usuario_prot_nrec, dt_atualizacao_prot_nrec, cd_guia_prestador_imp, ie_tipo_atendimento_imp, ie_indicacao_acidente, ie_indicacao_acidente_imp, nr_seq_plano_conta, ie_motivo_encerramento, nr_seq_conta_princ, nm_medico_solic_imp, nr_seq_segurado_prot, ie_tipo_faturamento, ie_tipo_faturamento_imp, nr_seq_mot_reembolso, ie_tipo_atendimento_reemb, nr_seq_regra_conta_auto, nr_seq_regra_an_agrup, nr_seq_lote_conta_orig, ie_status_fat, ie_tipo_doenca, nm_recem_nascido, nm_medico_executor_imp, nr_seq_ajuste_fat, dt_entrada_trunc, dt_alta_trunc, dt_entrada_imp_trunc, dt_alta_imp_trunc, tp_rede_min, nr_guia_tiss_operadora, nr_guia_tiss_prestador, nr_guia_tiss_principal, ie_guia_fisica, ie_estagio_complemento, cd_ans, dt_validade_senha, sg_conselho_exec, sg_conselho_solic, uf_crm_exec, vl_diarias, vl_gases, vl_materiais, vl_medicamentos, vl_opm, vl_procedimentos, vl_taxas, nr_seq_prestador_exec_princ, dt_fim_consistencia, ie_cobertura_especial, ie_regime_atendimento, ie_saude_ocupacional) AS select	/* Campos da tabela */

	a.nr_sequencia,
	b.nr_sequencia nr_seq_protocolo,
	a.ie_tipo_guia,
	a.ie_regime_internacao,
	a.ie_regime_internacao_imp,
	a.ie_carater_internacao,
	a.ie_carater_internacao_imp,
	a.ie_tipo_conta,
	a.ie_tipo_consulta,
	a.ie_tipo_consulta_imp,
	a.nr_seq_saida_int,
	a.nr_seq_saida_consulta,
	a.nr_seq_clinica,
	a.nr_seq_clinica_imp,
	a.nr_seq_tipo_acomodacao,
	a.ie_origem_conta,
	pls_obter_se_medico_exec_inter(a.nr_seq_nota_cobranca) ie_medico_exec_informado,
	a.nr_seq_tipo_atendimento,
	a.nr_seq_segurado,
	a.nr_seq_prestador_exec_imp_ref nr_seq_prestador_exec_imp,
	a.nr_seq_prestador_exec,
	a.cd_pessoa_fisica cd_pessoa_fisica_conta,
	a.cd_cgc cd_cgc_conta,
	a.nr_seq_competencia,
	a.nr_seq_prestador,
	a.nr_seq_prestador nr_seq_prestador_conta,
	a.nr_seq_prestador_imp_ref nr_seq_prestador_imp,
	a.cd_medico_executor,
	pls_buscar_cd_prof_imp(a.cd_medico_executor_imp,a.nr_crm_exec_imp,a.uf_crm_exec_imp,a.sg_conselho_exec_imp,b.cd_versao_tiss) cd_medico_executor_imp,
	a.cd_medico_solicitante,      
	pls_buscar_cd_prof_imp(a.cd_medico_solicitante_imp, a.nr_crm_solic_imp, a.uf_crm_solic_imp,a.sg_conselho_solic_imp, b.cd_versao_tiss)cd_medico_solicitante_imp,
	a.nr_seq_conselho_exec,
	a.nr_seq_conselho_solic,
	a.nr_seq_grau_partic,
	a.nr_seq_grau_partic nr_seq_grau_partic_conta,
	a.nr_seq_guia,
	a.ie_status,
	a.dt_entrada,
	a.dt_entrada_imp,
	a.dt_alta,
	a.dt_alta_imp,
	a.dt_emissao,
	a.dt_emissao_imp,
	trunc(a.dt_emissao, 'dd') dt_emissao_dd,
	trunc(a.dt_emissao_imp, 'dd') dt_emissao_imp_dd,
	a.cd_usuario_plano_imp,
	a.cd_guia,
	a.cd_guia_pesquisa,
	a.cd_guia_imp,
	a.cd_guia_referencia cd_guia_ref,
	a.cd_guia_solic_imp,
	a.dt_atendimento dt_atendimento_inf,
	a.dt_atendimento_imp dt_atendimento_imp_inf,
	trunc(a.dt_atendimento, 'dd') dt_atendimento_inf_dd,
	trunc(a.dt_atendimento_imp, 'dd') dt_atendimento_imp_inf_dd,
	a.dt_autorizacao,
	a.cd_senha,
	a.cd_senha_imp,
	a.cd_senha_externa,
	a.nr_seq_analise,
	a.nr_seq_conta_referencia,
	a.nr_seq_fatura,
	a.nr_seq_nota_cobranca,
	a.sg_conselho_exec_imp,
	a.uf_crm_exec_imp,
	a.nr_crm_exec_imp,
	a.cd_cbo_saude_exec_imp,
	a.nr_seq_cbo_saude,
	a.cd_cbo_saude_solic_imp,
	a.nr_seq_cbo_saude_solic,
	a.vl_total_imp,
	a.nr_seq_saida_spsadt,
	a.ie_tipo_partic_prof,
	a.nr_crm_exec,
	a.cd_cooperativa,
	a.cd_estabelecimento,
	a.cd_cnes,
	a.cd_cnes_executor_imp,
	a.cd_guia_prestador,
	a.ds_indicacao_clinica,
	a.ds_indicacao_clinica_imp,
	a.ie_obito_mulher,
	a.qt_nasc_vivos_termo,
	a.qt_nasc_mortos,
	a.qt_nasc_mortos_imp,
	a.qt_obito_precoce, 
	a.qt_obito_precoce_imp,
	a.qt_obito_tardio,
	a.qt_obito_tardio_imp,
	a.ie_tipo_acomodacao_ptu,
	a.cd_guia_ok cd_guia_referencia,
	a.nr_seq_lote_pgto,
	a.nr_seq_prestador_solic_ref nr_seq_prestador_solic,
	a.cd_doenca_dig,
	a.nr_seq_prestador_exec_imp_ref,
	a.nr_documento,
	a.vl_total,
	a.nr_seq_tipo_conta,
	b.nr_seq_prot_referencia,
	b.dt_lib_pagamento,
	b.nr_seq_periodo_pgto,
	b.cd_congenere,
	b.cd_estabelecimento cd_estabelecimento_prot,
	b.dt_protocolo dt_protocolo,
	b.dt_mes_competencia,
	b.nr_seq_prestador	nr_seq_prestador_prot,
	b.dt_geracao_analise_lote, 
	b.ie_status_lote, 
	b.ie_tipo_protocolo,
	b.nr_seq_lote_conta,
	b.ie_status ie_status_protocolo,
	b.ie_situacao ie_situacao_protocolo,
	b.ie_origem_protocolo,
	b.qt_contas_informadas qt_contas_informadas_prot,
	b.vl_cobrado_manual vl_cobrado_manual_prot,
	b.nr_protocolo_prestador,
	b.dt_recebimento dt_recebimento_prot,
	b.nr_seq_congenere	nr_seq_congenere_prot,
	b.dt_mes_competencia_trunc,
	b.sg_estado,
	b.cd_municipio_ibge,
	b.nr_seq_congenere,
	b.ie_apresentacao,
	b.nr_seq_prestador_imp nr_seq_prestador_imp_prot,
	a.dt_fim_tratamento,
	/* Functions */


	trunc(coalesce(a.dt_alta, a.dt_emissao) - a.dt_entrada) qt_dias_internacao ,
	(select	x.nr_seq_classificacao
	 FROM	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) nr_seq_clas_prest_exec,
	(select	x.cd_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) cd_prestador_exec, 
	(select	x.nr_seq_tipo_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) nr_seq_tipo_prest_exec, 
	(select	x.ie_tipo_vinculo
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) ie_tipo_vinculo_prest_exec, 
	(select	x.cd_cgc
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) cd_cgc_prest_exec,
	(select	x.cd_pessoa_fisica
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec) cd_pessoa_fisica_prest,
	(select x.ie_tipo_relacao
	 from	pls_prestador x
	 where	x.nr_sequencia = a.nr_seq_prestador_exec) ie_tipo_relacao_prest_exec,
	(select coalesce(x.ie_regra_data_preco_mat,'E')
	 from	pls_prestador x
	 where	x.nr_sequencia = a.nr_seq_prestador_exec) ie_regra_data_preco_mat_exec,
	(select	x.nr_seq_classificacao
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador) nr_seq_clas_prest_prot,
	(select	x.cd_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador) cd_prestador_prot, 
	(select	x.nr_seq_tipo_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador) nr_seq_tipo_prest_prot, 
	(select	max(x.ie_situacao)
	 from	pls_prestador x
	 where	x.nr_sequencia = b.nr_seq_prestador) ie_situacao_prest_prot,
	(select	max(x.ie_tipo_relacao)
	 from	pls_prestador x
	 where	x.nr_sequencia = b.nr_seq_prestador) ie_tipo_relacao_prest_prot,
	(select	max(x.ie_tipo_vinculo)
	 from	pls_prestador x
	 where	x.nr_sequencia = b.nr_seq_prestador) ie_tipo_vinculo_prest_prot,
	(select	x.cd_pessoa_fisica
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador) cd_pessoa_fisica_prest_prot,
	(select	x.cd_cgc
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador) cd_cgc_prest_prot,
	(select	max(nr_seq_classificacao)
	 from	pls_prestador
	 where	nr_sequencia	= a.nr_seq_prestador_solic_ref) nr_seq_clas_prest_solic,
	(select	max(cd_prestador)
	 from	pls_prestador
	 where	nr_sequencia	= a.nr_seq_prestador_solic_ref) cd_prestador_solic, 
	(select	max(nr_seq_tipo_prestador)
	 from	pls_prestador
	 where	nr_sequencia	= a.nr_seq_prestador_solic_ref) nr_seq_tipo_prest_solic,
	(select	max(x.ie_situacao)
	 from	pls_prestador x
	 where	x.nr_sequencia = a.nr_seq_prestador_solic_ref) ie_situacao_prest_solic,
	-- Informacoes de nascimentos e obitos.

	somente_numero(a.qt_nasc_mortos) qt_nasc_mortos_num,
	somente_numero(a.qt_nasc_mortos_imp) qt_nasc_mortos_imp_num,
	somente_numero(a.qt_nasc_vivos) qt_nasc_vivos_num,
	somente_numero(a.qt_nasc_vivos_imp) qt_nasc_vivos_imp_num,
	somente_numero(a.qt_nasc_vivos_prematuros) qt_nasc_vivos_premat_num,
	somente_numero(a.qt_nasc_vivos_prematuros_imp) qt_nasc_vivos_premat_imp_num,
	somente_numero(a.qt_nasc_vivos_termo) qt_nasc_vivos_termo_num,
	somente_numero(a.qt_obito_precoce) qt_obito_precoce_num,
	somente_numero(a.qt_obito_precoce_imp) qt_obito_precoce_imp_num,
	somente_numero(a.qt_obito_tardio) qt_obito_tardio_num,
	somente_numero(a.qt_obito_tardio_imp) qt_obito_tardio_imp_num,
	--Quantidade total de nascidos vivos.

	-- No TISS 3.0 nao vem mais informacao nos campos da conta, portanto e necessario contas as declaracoes validas, como o somente_numero retorna 0 se deu errado

	-- entao traz o maior, sempre, com o greatest.

	(select	count(1)
	from	pls_diagnostico_nasc_vivo nv
	where	nv.nr_seq_conta		= a.nr_sequencia
	and	nv.nr_decl_nasc_vivo	<> '0') qt_nasc_vivos_total,
	-- Quantidade total apresentada de nascidos vivos.

	(somente_numero(a.qt_nasc_vivos_imp) + somente_numero(a.qt_nasc_vivos_prematuros_imp)) qt_nasc_vivos_total_imp,
	-- Quantidade total de obitos.

	(somente_numero(a.qt_nasc_mortos) + somente_numero(a.qt_obito_precoce) +
	somente_numero(a.qt_obito_tardio)) qt_obito_total,
	-- Total de nasimentos apresentado, independe de vivos ou mortos.

	(somente_numero(a.qt_nasc_vivos_imp) + somente_numero(a.qt_nasc_vivos_prematuros_imp) +
	somente_numero(a.qt_nasc_mortos_imp)) qt_nasc_total_imp,
	-- Total de nascimentos, independe de vivos ou mortos

	greatest(CASE WHEN somente_numero(a.qt_nasc_vivos_termo)=0 THEN  somente_numero(a.qt_nasc_vivos)  ELSE somente_numero(a.qt_nasc_vivos_termo) END  
	+ somente_numero(a.qt_nasc_vivos_prematuros) + somente_numero(a.qt_nasc_mortos)
	,
	(select	count(1)
	from	pls_diagnostico_nasc_vivo nv
	where	nv.nr_seq_conta		= a.nr_sequencia
	and	nv.nr_decl_nasc_vivo	<> '0') +
	(select	count(1)
	from	pls_diagnost_conta_obito nm
	where	nm.nr_seq_conta = a.nr_sequencia
	and	nm.nr_declaracao_obito <> '0')) qt_nasc_total,
	-- Quantidade totas de obitos apresentada

	(somente_numero(a.qt_nasc_mortos_imp) + somente_numero(a.qt_obito_precoce_imp) +
	somente_numero(a.qt_obito_tardio_imp)) qt_obito_total_imp,
	pls_obter_se_internado(a.nr_sequencia,null, a.ie_tipo_guia, a.nr_seq_tipo_atendimento, 
				null, a.cd_estabelecimento, 'N',
				a.ie_regime_atendimento, a.ie_saude_ocupacional, a.dt_atendimento_referencia) ie_internado,
	pls_obter_se_internado(null, 'PORTAL', a.ie_tipo_guia, null, a.ie_tipo_atendimento_imp,
				a.cd_estabelecimento, 'N', a.ie_regime_atendimento, 
				a.ie_saude_ocupacional, a.dt_atendimento_referencia) ie_internado_imp,
	--Se conta referencia uma conta que e internacao.

	a.ie_vinc_internacao ie_vinc_internado,
	pls_obter_dados_gerar_conta(a.nr_sequencia, 'CBO') nr_seq_cbo_saude_imp,
	pls_obter_dados_gerar_conta(a.nr_sequencia, 'CBOSOLIC') nr_seq_cbo_saude_solic_imp,
	pls_obter_carteira_segurado(a.nr_seq_segurado) cd_usuario_plano,
	CASE WHEN pls_obter_se_internado(a.nr_sequencia,null, a.ie_tipo_guia, a.nr_seq_tipo_atendimento, 				null, a.cd_estabelecimento, 'N',				a.ie_regime_atendimento, a.ie_saude_ocupacional, a.dt_atendimento_referencia)='S' THEN 'I'  ELSE 'A' END  ie_tipo_internado,
	CASE WHEN pls_obter_se_internado(null, 'PORTAL', a.ie_tipo_guia, null, a.ie_tipo_atendimento_imp,				a.cd_estabelecimento, 'N', a.ie_regime_atendimento, 				a.ie_saude_ocupacional, a.dt_atendimento_referencia)='S' THEN 'I'  ELSE 'A' END  ie_tipo_internado_imp,
	pls_obter_se_int_obstetrica(a.ie_tipo_guia,a.ie_gestacao,a.ie_aborto,
				a.ie_parto_normal,a.ie_complicacao_puerperio,a.ie_complicacao_neonatal,
				a.ie_parto_cesaria,a.ie_baixo_peso,a.ie_atend_rn_sala_parto,a.ie_transtorno) ie_internacao_obstetrica,
	pls_obter_tipo_intercambio(coalesce(a.nr_seq_congenere, b.nr_seq_congenere), a.cd_estabelecimento) ie_tipo_intercambio,
	-- Data de atendimento da conta. Este campo e alimentado via trigger. E nela que esta a regra de negocio para decidir qual e a data correta

	a.dt_atendimento_referencia dt_atendimento,
	trunc(a.dt_atendimento_referencia, 'dd') dt_atendimento_dd,
	a.dt_atendimento_referencia dt_atendimento_conta,
	trunc(a.dt_atendimento_referencia, 'dd') dt_atendimento_conta_dd,
	-- Data de atendimento da conta que foi importada. Este campo e alimentado via trigger. E nela que esta a regra de negocio para decidir qual e a data correta

	a.dt_atendimento_imp_referencia dt_atendimento_imp,
	trunc(a.dt_atendimento_imp_referencia, 'dd') dt_atendimento_imp_dd,
	-- Obter a guia de referencia da conta, como o sistema permite trabalhar de forma diferente em relacao a qual campo deve ser informado, este campo deve ser utilizado 

	-- para definir qual a guia de referencia sendo utilizada indepente de como a operadora trabalha em relacao a este campo.

	-- Tipo de atendimento pelo codigo do TISS (Regra De: Para: )

	(select max(z.nr_sequencia)
	from   	pls_tipo_atendimento z
	where 	z.ie_situacao = 'A'
	and 	z.cd_estabelecimento = a.cd_estabelecimento
	and	z.cd_tiss = a.ie_tipo_atendimento_imp) nr_seq_tipo_atend_imp,
	-- Tipo de acomodacao informada na importacao com o codigo do TISS (Regra De: Para:)

	(select	max(z.nr_sequencia)
	from  	pls_tipo_acomodacao z
	where	z.cd_tiss   	   = a.cd_tipo_acomodacao_imp
	and 	z.ie_situacao 	   = 'A') nr_seq_tipo_acomod_imp,
	-- Ira verificar a situacao de todos os itens da conta.

	pls_obter_se_conta_glosada(a.nr_sequencia) ie_glosa,
	-- Obter o tipo de atendimento no TISS para esta conta (Regra De: Para:)

	(select	max(z.cd_tiss)
	from	pls_tipo_atendimento z
	where	z.nr_sequencia = a.nr_seq_tipo_atendimento) cd_tiss_atendimento,
	-- Obter o numero da fatura (PTU_FATURA)

	(select	max(z.nr_fatura)
	from	ptu_fatura z
	where	z.nr_sequencia = a.nr_seq_fatura) nr_fatura,
	--Obter o ie_status da ptu_fatura

	(select	max(z.ie_status)
	from	ptu_fatura z
	where	z.nr_sequencia = a.nr_seq_fatura) ie_status_fatura,
	-- Obter o numero da nota de cobranca (PTU_NOTA_COBRANCA)

	pls_obter_nr_nota_fatura(a.nr_seq_nota_cobranca) nr_nota_cobranca,
	-- Data  de recebimento da fatura no A500.

	CASE WHEN a.ie_tipo_conta='I' THEN (select	max(z.dt_recebimento_fatura)	from	ptu_fatura z	where	z.nr_sequencia = a.nr_seq_fatura)  ELSE LOCALTIMESTAMP END  dt_recebimento_fatura,
	CASE WHEN a.ie_tipo_conta='I' THEN (select	max(z.dt_postagem)	from	ptu_fatura z	where	z.nr_sequencia = a.nr_seq_fatura)  ELSE LOCALTIMESTAMP END  dt_postagem_fatura,
	(select sum(b.qt_procedimento)
         from   pls_conta_proc b
         where	b.nr_seq_conta = a.nr_sequencia) qt_sum_proc,
	 (select sum(b.qt_procedimento)
         from   pls_conta_proc b
         where	b.nr_seq_conta = a.nr_sequencia
	 and	b.ie_autogerado 	= 'S') qt_sum_auto_gerado_proc,
	coalesce(((select coalesce(sum(d.vl_liberado),0) vl_liberado
         from   pls_conta_proc d
         where d.nr_seq_conta = a.nr_sequencia)
	 +
	 (select coalesce(sum(e.vl_liberado),0) vl_liberado
         from   pls_conta_mat e
         where e.nr_seq_conta = a.nr_sequencia)), 0) vl_conta,
	-- A view PLS_SEGURADO_V nao esta mais sendo utilizada pelo fato de que nem todos os beneficiarios estao em algum contrato

	(select	nr_seq_intercambio
	from	pls_segurado x
	where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_intercambio,
	(select	nr_seq_congenere
	from	pls_segurado x
	where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_congenere_seg,
	a.ie_tipo_segurado,
	(select	x.nr_seq_plano
	from	pls_segurado x
	where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_plano,
	(select	y.ie_sexo
	from	pls_segurado 	x,
		pessoa_fisica	y
	where	x.cd_pessoa_fisica 	= y.cd_pessoa_fisica
	and	x.nr_sequencia 		= a.nr_seq_segurado) ie_sexo_benef,
	(select	y.dt_nascimento
	from	pls_segurado 	x,
		pessoa_fisica	y
	where	x.cd_pessoa_fisica 	= y.cd_pessoa_fisica
	and	x.nr_sequencia 		= a.nr_seq_segurado) dt_nascimento_benef,
	(select	y.ie_segmentacao
	from	pls_segurado	x,
		pls_plano 	y
	where	x.nr_seq_plano = y.nr_sequencia
	and	x.nr_sequencia = a.nr_seq_segurado) ie_segmentacao_benef,
	(select	y.ie_tipo_contratacao
	from	pls_segurado	x,
		pls_plano 	y
	where	x.nr_seq_plano = y.nr_sequencia
	and	x.nr_sequencia = a.nr_seq_segurado) ie_tipo_contratacao_benef,
	(select x.nr_seq_contrato
	from	pls_segurado x
	where	x.nr_sequencia = a.nr_seq_segurado) nr_seq_contrato,
	(select	round((obter_idade(y.dt_nascimento, a.dt_atendimento_referencia, 'M'))::numeric )
	from	pls_segurado 	x,
		pessoa_fisica	y
	where	x.cd_pessoa_fisica 	= y.cd_pessoa_fisica
	and	x.nr_sequencia 		= a.nr_seq_segurado) qt_idade_benef_mes,
	(select	round((obter_idade(y.dt_nascimento, a.dt_atendimento_referencia, 'A'))::numeric )
	from	pls_segurado 	x,
		pessoa_fisica	y
	where	x.cd_pessoa_fisica 	= y.cd_pessoa_fisica
	and	x.nr_sequencia 		= a.nr_seq_segurado) qt_idade_benef,
	(select	round((obter_idade(y.dt_nascimento, a.dt_atendimento_referencia, 'DIA'))::numeric )
	from	pls_segurado 	x,
		pessoa_fisica	y
	where	x.cd_pessoa_fisica 	= y.cd_pessoa_fisica
	and	x.nr_sequencia 		= a.nr_seq_segurado) qt_idade_benef_dia,
	-- Retorna a formacao baseada no dominio 6961 para definir se Pre, Pos ou misto.

	(select	case(y.ie_preco)
		when '1' then 'PR'
		when '2' then 'PO'
		when '3' then 'PO'
		when '4' then 'MI'
		end ie_preco
	from	pls_segurado	x,
		pls_plano 	y
	where	x.nr_seq_plano = y.nr_sequencia
	and	x.nr_sequencia = a.nr_seq_segurado) ie_preco_pre_pos_misto,
	(select cd_medico_solicitante
	from	pls_guia_plano
	where	nr_sequencia	= a.nr_seq_guia) cd_medico_solic_guia,
	(select max(ie_status)
	from 	pls_analise_conta b
	where 	b.nr_sequencia = a.nr_seq_analise) ie_status_analise,
	(select	max(guia.nr_sequencia)
	from	pls_guia_plano guia
	where	guia.nr_seq_segurado = a.nr_seq_segurado
	and	guia.cd_guia = a.cd_guia
	and	guia.ie_status = '1') nr_seq_guia_conta,
	(select	max(guia.nr_sequencia)
	from	pls_guia_plano guia 
	where	guia.nr_seq_segurado = a.nr_seq_segurado
	and	guia.cd_guia = a.cd_guia_referencia
	and	guia.ie_status = '1') nr_seq_guia_referencia,
	(select	max(guia.ie_status)
	from	pls_guia_plano guia
	where	guia.nr_sequencia = a.nr_seq_guia) ie_status_guia,
	(select	max(req.nr_seq_prestador)
	from	pls_execucao_requisicao req
	where	req.nr_seq_guia = a.nr_seq_guia
	and	req.ie_situacao = '1') nr_seq_prestador_req,
	-- CID principal da conta

	(select	max(g.cd_doenca)
	from	pls_diagnostico_conta g
	where	g.nr_seq_conta		= a.nr_sequencia
	and	g.ie_classificacao	= 'P') cd_cid_principal,
	(select	max(g.cd_doenca_imp)
	from	pls_diagnostico_conta g
	where	g.nr_seq_conta		= a.nr_sequencia
	and	g.ie_classificacao	= 'P') cd_cid_principal_imp,
	-- Categoria do CID principal

	(select	max(h.cd_categoria_cid)
	from	pls_diagnostico_conta	g,
		cid_doenca		h
	where	g.nr_seq_conta 		= a.nr_sequencia
	and	g.ie_classificacao 	= 'P'
	and	h.cd_doenca_cid		= g.cd_doenca) cd_cat_cid_principal,
	(select	max(h.cd_categoria_cid)
	from	pls_diagnostico_conta	g,
		cid_doenca		h
	where	g.nr_seq_conta 		= a.nr_sequencia
	and	g.ie_classificacao 	= 'P'
	and	h.cd_doenca_cid		= g.cd_doenca_imp) cd_cat_cid_principal_imp,
	-- Retorna quantidade de horas do atendimento

	pls_manipulacao_datas_pck.calcular_tempo(a.dt_entrada, a.dt_alta, 'H') qt_horas_atendimento,
	coalesce((select	max(c.dt_alta)
	from	pls_conta c
	where	c.cd_guia_ok = a.cd_guia_referencia
	and	c.nr_seq_segurado = a.nr_seq_segurado
	and	c.ie_tipo_guia	= '5'),
	(select	max(c.dt_alta)
	from	pls_conta c
	where	c.cd_guia = a.cd_guia_referencia
	and	c.nr_seq_segurado = a.nr_seq_segurado)) dt_alta_ref,
	coalesce((select	min(dt_entrada)
	from	pls_conta c
	where	c.cd_guia_ok = a.cd_guia_referencia
	and	c.nr_seq_segurado = a.nr_seq_segurado
	and	c.ie_tipo_guia	= '5'),
	(select	min(dt_entrada)
	from	pls_conta c
	where	c.cd_guia = a.cd_guia_referencia
	and	c.nr_seq_segurado = a.nr_seq_segurado)) dt_entrada_ref,
	dt_documento dt_documento,
	b.cd_versao_tiss,
	a.dt_fim_faturamento,
	a.dt_fim_faturamento_imp,
	a.dt_inicio_faturamento,
	a.dt_inicio_faturamento_imp,
	(select	max(x.ie_indicador_dorn)
	from	pls_diagnost_conta_obito x
	where	x.nr_seq_conta = a.nr_sequencia) ie_indicador_dorn,
	(select	max(x.ie_indicador_dorn_imp)
	from	pls_diagnost_conta_obito x
	where	x.nr_seq_conta = a.nr_sequencia) ie_indicador_dorn_imp,
	ie_exige_autorizacao, 
	ds_observacao, 
	ds_observacao_imp, 
	b.dt_protocolo_imp,
	a.nr_crm_solic_imp, 
	a.uf_crm_solic_imp,
	a.sg_conselho_solic_imp,
	a.ie_tipo_gat,
	(select	x.cd_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec_imp_ref) cd_prestador_exec_imp,
	(select	x.nr_seq_tipo_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= a.nr_seq_prestador_exec_imp_ref) nr_seq_tipo_prest_exec_imp, 
	(select	x.cd_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador_imp) cd_prestador_prot_imp, 
	(select	x.nr_seq_tipo_prestador
	 from	pls_prestador x
	 where	x.nr_sequencia	= b.nr_seq_prestador_imp) nr_seq_tipo_prest_prot_imp ,
	 a.ie_recem_nascido_imp,
	 a.ie_recem_nascido,
	 a.nr_seq_prest_inter,
	 a.nm_usuario_nrec nm_usuario_conta_nrec,
	 b.nm_usuario_nrec nm_usuario_prot_nrec,
	 b.dt_atualizacao_nrec dt_atualizacao_prot_nrec,
	 a.cd_guia_prestador_imp,
	 a.ie_tipo_atendimento_imp,
	 a.ie_indicacao_acidente,
	 a.ie_indicacao_acidente_imp,
	a.nr_seq_plano nr_seq_plano_conta,
	a.ie_motivo_encerramento,
	a.nr_seq_conta_princ,
	a.nm_medico_solic_imp,
	b.nr_seq_segurado_prot,
	a.ie_tipo_faturamento,
	a.ie_tipo_faturamento_imp,
	b.nr_seq_mot_reembolso,
	b.ie_tipo_atendimento_reemb,
	a.nr_seq_regra_conta_auto,
	a.nr_seq_regra_an_agrup,          
	a.nr_seq_lote_conta_orig,
	a.ie_status_fat,
	a.ie_tipo_doenca,
	a.nm_recem_nascido,
	a.nm_medico_executor_imp,
	a.nr_seq_ajuste_fat,
	trunc(a.dt_entrada,'dd') dt_entrada_trunc,
	trunc(a.dt_alta,'dd') dt_alta_trunc,
	trunc(a.dt_entrada_imp,'dd') dt_entrada_imp_trunc,
	trunc(a.dt_alta_imp,'dd') dt_alta_imp_trunc,
	a.tp_rede_min,
	a.nr_guia_tiss_operadora,
	a.nr_guia_tiss_prestador,
	a.nr_guia_tiss_principal,
	b.ie_guia_fisica,
	a.ie_estagio_complemento,
	a.cd_ans,
	a.dt_validade_senha,
	a.sg_conselho_exec,
	a.sg_conselho_solic,
	a.uf_crm_exec,
	a.vl_diarias,
	a.vl_gases,
	a.vl_materiais,
	a.vl_medicamentos,
	a.vl_opm,
	a.vl_procedimentos,
	a.vl_taxas,
	a.nr_seq_prestador_exec_princ,
	a.dt_fim_consistencia,
	a.ie_cobertura_especial,
	a.ie_regime_atendimento,
	a.ie_saude_ocupacional
from	pls_conta		a,
	pls_protocolo_conta_v	b
where	b.nr_sequencia = a.nr_seq_protocolo;

