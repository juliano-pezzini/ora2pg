-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_coparticipacao_relatorio_v (nr_seq_titular, nr_sequencia, ie_titularidade, dt_autorizacao, qt_item, vl_coparticipacao) AS select nr_seq_titular,
	nr_sequencia, 
	ie_titularidade, 
	dt_autorizacao, 
	qt_item, 
	vl_coparticipacao 
FROM ( 
		select	x.nr_seq_titular, 
			x.nr_sequencia, 
			CASE WHEN x.nr_seq_titular IS NULL THEN  'T'  ELSE 'D' END  ie_titularidade, 
			null dt_autorizacao, 
			e.qt_procedimento qt_item, 
			f.vl_coparticipacao vl_coparticipacao 
		from	pls_segurado x, 
			pls_conta_proc_v e, 
			pls_conta_coparticipacao f 
		where  e.nr_seq_segurado = x.nr_sequencia 
		and	e.ie_status <> 'D' 
		and   f.nr_seq_conta_proc = e.nr_sequencia 
		and 	f.nr_seq_mensalidade_seg is null 
 
		
union all
 
 
		select	x.nr_seq_titular, 
			x.nr_sequencia, 
			CASE WHEN x.nr_seq_titular IS NULL THEN  'T'  ELSE 'D' END  ie_titularidade, 
			null dt_autorizacao, 
			e.qt_material qt_item, 
			f.vl_coparticipacao vl_coparticipacao 
		from	pls_segurado x, 
			pls_conta_mat_v e, 
			pls_conta_coparticipacao f 
		where	e.nr_seq_segurado = x.nr_sequencia  
		and	e.ie_status <> 'D' 
		and   f.nr_seq_conta_mat = e.nr_sequencia 
		and	f.nr_seq_mensalidade_seg is null 
 
		
union all
 
 
		select	x.nr_seq_titular, 
			x.nr_sequencia, 
			CASE WHEN x.nr_seq_titular IS NULL THEN  'T'  ELSE 'D' END  ie_titularidade, 
			e.dt_autorizacao dt_autorizacao, 
			f.qt_autorizada qt_item, 
			m.vl_coparticipacao vl_coparticipacao 
		from	pls_segurado x, 
			pls_guia_plano e, 
			pls_guia_plano_proc f, 
			pls_guia_coparticipacao m 
		where	e.nr_seq_segurado = x.nr_sequencia 
		and	e.ie_status = '1' 
		and	f.nr_seq_guia = e.nr_sequencia 
		and	m.nr_seq_guia_proc = f.nr_sequencia 
		and 	not exists ( 
					select	1 
					from	pls_conta_proc_v z, 
						pls_conta_coparticipacao y 
					where  z.nr_seq_segurado  = x.nr_sequencia 
					and	z.ie_status 	  <> 'D' 
					and   y.nr_seq_conta_proc = z.nr_sequencia 
					and 	z.nr_seq_guia	  = f.nr_seq_guia 
					and 	z.cd_procedimento  = f.cd_procedimento 
					and 	y.nr_seq_mensalidade_seg is null 
				) 
 
		
union all
 
 
		select	x.nr_seq_titular, 
			x.nr_sequencia, 
			CASE WHEN x.nr_seq_titular IS NULL THEN  'T'  ELSE 'D' END  ie_titularidade, 
			e.dt_autorizacao dt_autorizacao, 
			f.qt_autorizada qt_item, 
			m.vl_coparticipacao vl_coparticipacao 
		from	pls_segurado x, 
			pls_guia_plano e, 
			pls_guia_plano_mat f, 
			pls_guia_coparticipacao m 
		where	e.nr_seq_segurado = x.nr_sequencia 
		and	e.ie_status = '1' 
		and	f.nr_seq_guia = e.nr_sequencia 
		and	m.nr_seq_guia_proc = f.nr_sequencia 
		and 	not exists ( 
					select	1 
					from	pls_conta_mat_v z, 
						pls_conta_coparticipacao y 
					where  z.nr_seq_segurado  = x.nr_sequencia 
					and	z.ie_status 	  <> 'D' 
					and   y.nr_seq_conta_mat = z.nr_sequencia 
					and	y.nr_seq_mensalidade_seg is null 
					and 	z.nr_seq_guia	  = f.nr_seq_guia 
					and 	z.nr_seq_material  = f.nr_seq_material 
				) 
	) alias2;

