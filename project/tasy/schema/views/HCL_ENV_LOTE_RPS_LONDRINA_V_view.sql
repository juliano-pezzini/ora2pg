-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hcl_env_lote_rps_londrina_v (cd_cpf_cnpj_prest, nr_nota_fiscal, cd_serie_nf, cd_sub_serie_nf, dt_emissao, cd_servico, ie_situacao, vl_servico, cd_cmc, ie_tipo_nota_fiscal, vl_aliquota, cd_estabelecimento) AS select	substr(CASE WHEN n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN '00000000000000'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END ,1,255) cd_cpf_cnpj_prest,
	n.nr_nota_fiscal	nr_nota_fiscal, 
	n.cd_serie_nf		cd_serie_nf, 
	'0'			cd_sub_serie_nf, 
	n.dt_emissao		dt_emissao, 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN obter_dados_pf_pj_estab(n.cd_estabelecimento, NULL, n.cd_cgc, 'ATIV')  ELSE (select nr_codigo_serv_prest FROM pessoa_fisica p where p.cd_pessoa_fisica = n.cd_pessoa_fisica) END  cd_servico, 
	'tt'			ie_situacao, 
	CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END  vl_servico, 
	'46132'			cd_cmc, 
	'T'			ie_tipo_nota_fiscal, 
	'0'			vl_aliquota, 
	n.cd_estabelecimento 
from	operacao_nota o, 
	nota_fiscal n 
where	o.cd_operacao_nf = n.cd_operacao_nf 
and     o.ie_servico = 'S';

