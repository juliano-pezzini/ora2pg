-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nut_alteracao_prescricao_v (dt_producao, dt_producao_order, ds_setor_atendimento, ds_servico, cd_setor_atendimento, nr_seq_servico, dt_servico, nr_atendimento) AS select	to_char(a.dt_servico,'dd/mm/yyyy') dt_producao,
	to_date(to_char(a.dt_servico,'dd/mm/yyyy')) dt_producao_order,
	substr(ds_setor_atendimento,1,100) ds_setor_atendimento,
	substr(b.ds_servico,1,100) ds_servico,
	a.cd_setor_Atendimento cd_setor_atendimento,
	a.nr_seq_servico,
	a.dt_servico,
	a.nr_Atendimento
FROM  	nut_atend_serv_dia a,
	nut_servico b,
	setor_atendimento c,
	nut_atend_serv_dia_rep d
where	a.nr_Seq_servico = b.nr_sequencia
and	a.cd_setor_Atendimento = c.cd_Setor_Atendimento
and	a.nr_sequencia = d.nr_seq_serv_dia
and	exists (	select  1
	   	from	prescr_medica x
	   	where	x.nr_atendimento = a.nr_atendimento
	   	and	x.dt_liberacao is not null
	   	and	a.dt_Servico between coalesce(x.dt_inicio_prescr,a.dt_Servico) and coalesce(dt_fim_prescricao,a.dt_Servico)
	   	and	x.dt_suspensao is null)
AND (EXISTS (SELECT 1 FROM prescr_dieta x WHERE x.nr_prescricao = d.nr_prescr_oral) or
	 EXISTS (SELECT 1 FROM rep_jejum x WHERE x.nr_prescricao = d.nr_prescr_jejum) or
	 EXISTS (SELECT 1 FROM prescr_material x WHERE x.nr_prescricao = d.nr_prescr_compl AND x.ie_agrupador = 12) or
	 EXISTS (SELECT 1 FROM prescr_material x WHERE x.nr_prescricao = d.nr_prescr_enteral AND x.ie_agrupador = 8) or
 	 EXISTS (SELECT 1 FROM nut_paciente x WHERE x.nr_prescricao = d.nr_prescr_npt_adulta) or
	 EXISTS (SELECT 1 FROM nut_pac x WHERE x.nr_prescricao = d.nr_prescr_npt_ped) or
 	 EXISTS (SELECT 1 FROM nut_pac x WHERE x.nr_prescricao = d.nr_prescr_npt_neo))
--and	(SELECT count(*) FROM prescr_medica x WHERE x.nr_atendimento = a.nr_Atendimento AND x.dt_liberacao IS NOT NULL AND SUBSTR(GN_obter_se_itens_susp(x.nr_prescricao),1,1) = 'S' AND  a.dt_Servico BETWEEN NVL(x.dt_inicio_prescr,a.dt_Servico) AND NVL(x.dt_fim_prescricao,a.dt_Servico))	> 0
;

