-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW detecciones_nom_v (ie_tipo_registro, cabecario, clues, curpprestador, nombreprestador, primerapellidoprestador, segundoapellidoprestador, tipopersonal, especificatipopersonal, cedulaprofesional, servicioatencion, especificarservicio, curppaciente, nombre, primerapellido, segundoapellido, fechanacimiento, entidadnacimiento, edad, claveedad, sexo, seconsideraindigena, spss, numeroafiliacionspss, prospera, folioprospera, imss, numeroafiliacionimss, issste, numeroafiliacionissste, otraafiliacion, numerootraafiliacion, peso, talla, tipodificultad, gradodificultad, origendificultad, migrante, fechadeteccion, diabetesmellitus, hipertensionarterial, obesidad, dislipidemias, depresion, alteracionmemoria, sintomaticorespiratorio, alcoholismo, tabaquismo, farmacos, incontinenciaurinaria, caida60ymas, riesgofractura, vih, gonorrea, itssecretoras, itsulcerativas, itstumorales, sifilis, sospechasindrometurner, violenciafamiliar, hiperplasiaprostatica, tirasembarazadassanas, tirasdeteccion, tirascontrol, reactivosantigenoprostatico, cartillavacunacion, telemedicina, dt_entrada, nr_atendimento) AS select
	0 ie_tipo_registro,
	'clues|curpPrestador|nombrePrestador|primerApellidoPrestador|segundoApellidoPrestador|tipoPersonal|especificaTipoPersonal|cedulaProfesional|servicioAtencion|especificarServicio|curpPaciente|'||
	'nombre|primerApellido|segundoApellido|fechaNacimiento|entidadNacimiento|edad|claveEdad|sexo|seConsideraIndigena|spss|numeroAfiliacionSpss|prospera|folioProspera|imss|numeroAfiliacionImss|'||
	'issste|numeroAfiliacionIssste|otraAfiliacion|numeroOtraAfiliacion|peso|talla|tipoDificultad|gradoDificultad|origenDificultad|migrante|fechaDeteccion|diabetesMellitus|'||
	'hipertensionArterial|obesidad|dislipidemias|depresion|alteracionMemoria|sintomaticoRespiratorio|alcoholismo|tabaquismo|farmacos|incontinenciaUrinaria|caida60yMas|riesgoFractura|vih|gonorrea|'||
	'itsSecretoras|itsUlcerosas|itsTumorales|sifilis|sospechaSindromeTurner|violenciaFamiliar|hiperplasiaProstatica|tirasEmbarazadasSanas|'||
	'tirasDeteccion|tirasControl|reactivosAntigenoProstatico|cartillaVacunacion|telemedicina' CABECARIO,
	null clues,
	null curpprestador,
	null nombreprestador,
	null primerapellidoprestador,
	null segundoapellidoprestador,
	null tipopersonal,
	null especificatipopersonal,
	null cedulaprofesional,
	null servicioatencion,
	null especificarservicio,
	null curppaciente,
	null nombre,
	null primerapellido,
	null segundoapellido,
	null fechanacimiento,
	null entidadnacimiento,
	null edad,
	null claveedad,
	null sexo,
	null seconsideraindigena,
	null spss,
	null numeroafiliacionspss,
	null prospera,
	null folioprospera,
	null imss,
	null numeroafiliacionimss,
	null issste,
	null numeroafiliacionissste,
	null otraafiliacion,
	null numerootraafiliacion,
	null peso,
	null talla,
	null tipodificultad,
	null gradodificultad,
	null origendificultad,
	null migrante,
	null fechadeteccion,
	null diabetesmellitus,
	null hipertensionarterial,
	null obesidad,
	null dislipidemias,
	null depresion,
	null alteracionmemoria,
	null sintomaticorespiratorio,
	null alcoholismo,
	null tabaquismo,
	null farmacos,
	null incontinenciaurinaria,
	null caida60ymas,
	null riesgofractura,
	null vih,
	null gonorrea,
	null itssecretoras,
	null itsulcerativas,
	null itstumorales,
	null sifilis,
	null sospechasindrometurner,
	null violenciafamiliar,
	null hiperplasiaprostatica,
	null tirasembarazadassanas,
	null tirasdeteccion,
	null tirascontrol,
	null reactivosantigenoprostatico,
	null cartillavacunacion,
	null telemedicina,
	null dt_entrada,
	null nr_atendimento


union all

select
	--prestador servico--
	2 ie_tipo_registro,
	'' cabecario,
	pj.cd_internacional clues,
	coalesce(substr(upper(pj.cd_curp),1,18), 'XXXX999999XXXXXX99') curpprestador,
	coalesce(substr(upper(pj.ds_razao_social),1,50), 'XX') nombreprestador,
	coalesce(substr(upper(pj.nm_fantasia),1,50), 'XX') primerapellidoprestador,
	coalesce(substr(upper(pj.ds_nome_abrev),1,50), 'XX') segundoapellidoprestador,
	profissional.ie_profissional  tipopersonal,
	CASE WHEN profissional.ie_profissional='12' THEN obter_desc_expressao(308221) END  especificatipopersonal,
	case
		when profissional.ie_profissional in ('2','3','4','6','8')
		then coalesce(lpad(coalesce(pf_m.ds_codigo_prof, m.nr_crm),8,0),0)
		else '0'
	end as cedulaprofesional,
	CASE WHEN b.ie_clinica=2 THEN 3 WHEN b.ie_clinica=1 THEN 4 WHEN b.ie_clinica=3 THEN 5 WHEN b.ie_clinica=1000 THEN 6 WHEN b.ie_clinica=1001 THEN 7 WHEN b.ie_clinica=1002 THEN 8 WHEN b.ie_clinica=1004 THEN 9 WHEN b.ie_clinica=1005 THEN 13 WHEN b.ie_clinica=1006 THEN 14 WHEN b.ie_clinica=4 THEN 16 WHEN b.ie_clinica=1007 THEN 17 WHEN b.ie_clinica=1008 THEN 22 WHEN b.ie_clinica=1009 THEN 23 END  servicioatencion,
	null especificarservicio,
	--dados paciente--
	coalesce(substr(upper(pf_p.cd_curp),1,18), 'XXXX999999XXXXXX99') curppaciente,
	substr(upper(y.ds_given_name),1,50) nombre,
	coalesce(substr(upper(y.ds_family_name),1,50), 'XX') primerapellido,
	coalesce(substr(upper(y.ds_component_name_1),1,50), 'XX') segundoapellido,
	to_char(pf_p.dt_nascimento, 'dd/mm/yyyy') fechanacimiento,
	obter_dados_cat_entidade(pf_p.cd_pessoa_fisica, 'CD_ENTIDADE') entidadnacimiento,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') is not null
		then coalesce(obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_inicio_atendimento,'IDADE'),-1)
		else 999
	end as edad,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') is not null
		then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_inicio_atendimento,'CLAVEEDAD')
		else 9
	end as claveedad,
	CASE WHEN pf_p.ie_sexo='M' THEN  1  WHEN pf_p.ie_sexo='F' THEN  2  ELSE 9 END  sexo,
	CASE WHEN pf_p.nr_seq_cor_pele=201 THEN  1  ELSE 0 END  seconsideraindigena,
	-- --derechohaniencia--
	(CASE WHEN pf_p.nr_spss IS NOT NULL THEN 1 ELSE 0 END) spss,
	case
		when pf_p.nr_spss is not null
		then substr(pf_p.nr_spss,1,13)
	end as numeroafiliacionspss,
	CASE WHEN n.cd_tipo_convenio_mx=13 THEN  1  ELSE 0 END  prospera,
	CASE WHEN n.cd_tipo_convenio_mx=13 THEN  elimina_caractere_especial(substr(p.nr_doc_convenio,1,16)) END  folioprospera,
	CASE WHEN n.cd_tipo_convenio_mx=2 THEN  1  ELSE 0 END  imss,
	CASE WHEN n.cd_tipo_convenio_mx=2 THEN  substr(p.nr_doc_convenio,1,11) END  numeroafiliacionimss,
	CASE WHEN n.cd_tipo_convenio_mx=3 THEN  1  ELSE 0 END  issste,
	CASE WHEN n.cd_tipo_convenio_mx=3 THEN  substr(p.nr_doc_convenio,1,13) END  numeroafiliacionissste,
	CASE WHEN n.cd_tipo_convenio_mx=15 THEN  1  ELSE 0 END  otraafiliacion,
	CASE WHEN n.cd_tipo_convenio_mx=15 THEN  substr(p.nr_doc_convenio,1,15) END  numerootraafiliacion,
	---- outros dados--
	coalesce(coalesce((select	max(qt_peso)
		from	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	qt_peso is not null
					and	nr_atendimento	= b.nr_atendimento
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_peso), '999') peso,
	coalesce(coalesce((select	max(qt_altura_cm)
		from	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
					from	atendimento_sinal_vital
					where	qt_altura_cm is not null
					and	nr_atendimento	= b.nr_atendimento
					and	coalesce(ie_situacao,'A') = 'A'
					and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_altura_cm), '999') talla,
	(select max(CASE WHEN ptd.nr_seq_tipo_def=48 THEN 1 WHEN ptd.nr_seq_tipo_def=49 THEN 2 WHEN ptd.nr_seq_tipo_def=50 THEN 3 WHEN ptd.nr_seq_tipo_def=51 THEN 4 WHEN ptd.nr_seq_tipo_def=52 THEN 5 WHEN ptd.nr_seq_tipo_def=53 THEN 6 WHEN ptd.nr_seq_tipo_def=54 THEN 7 WHEN ptd.nr_seq_tipo_def=55 THEN 8 WHEN ptd.nr_seq_tipo_def=56 THEN 9 END )
	 from pf_tipo_deficiencia ptd
	where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica and ptd.dt_inativacao is null and ptd.dt_liberacao is not null) as tipodificultad,
	 -- gradodificultad
	(select max(CASE WHEN ptd.nr_seq_tipo_def=56 THEN 9  ELSE ptd.ie_grau_deficiencia END )
	from pf_tipo_deficiencia ptd
	where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica
	and ptd.dt_inativacao is null and ptd.dt_liberacao is not null) as gradodificultad,
	-- origendificultad
	(select max(case
		when ptd.nr_seq_tipo_def = 56
		then 9
		else CASE WHEN ptd.nr_seq_causa_lesao=6 THEN 1 WHEN ptd.nr_seq_causa_lesao=8 THEN 2 WHEN ptd.nr_seq_causa_lesao=9 THEN 3 WHEN ptd.nr_seq_causa_lesao=10 THEN 4 WHEN ptd.nr_seq_causa_lesao=11 THEN 5 WHEN ptd.nr_seq_causa_lesao=12 THEN 6 WHEN ptd.nr_seq_causa_lesao=13 THEN 9 END
		end)
	from pf_tipo_deficiencia ptd
	where pf_p.cd_pessoa_fisica = ptd.cd_pessoa_fisica
	and ptd.dt_inativacao is null and ptd.dt_liberacao is not null) as origendificultad,
	-1 migrante,
	coalesce(to_char((select max(ddp.dt_diagnostico) from diagnostico_doenca ddp where ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'P'), 'dd/mm/yyyy'), null) fechadeteccion,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 20 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'DIABT' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as diabetesmellitus,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 20 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'HIPAS' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as hipertensionarterial,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 20 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'OBSDA' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as obesidad,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 20 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'LIPDM' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as dislipidemias,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 60 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'DPRSS' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as depresion,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 60 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'ALTME' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as alteracionmemoria,
	coalesce((select CASE WHEN ddp.ie_sintomatico='S' THEN  0  ELSE 1 END  from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'STRSP' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento), '-1') sintomaticorespiratorio,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'ALCOL' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as alcoholismo,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'TABAC' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as tabaquismo,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'FARMA' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as farmacos,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'INCUR' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as incontinenciaurinaria,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 60 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'SINDC' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as caida60ymas,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 50 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'RISFO' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as riesgofractura,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 50 and (select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'HIV' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as vih,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'GRREA' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as gonorrea,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where (cc1.cd_doenca in ('A54', 'N74') or cc1.cd_doenca like '%A59%' or cc1.cd_doenca like '%A70%') and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as itssecretoras,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.cd_doenca in ('B081','B977')  and cc1.cd_doenca_cid like ddp.cd_doenca and b.nr_atendimento = ddp.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as itsulcerativas,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.cd_doenca in ('B97.7', 'A58', 'A60') and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as itstumorales,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'SIFIL' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as sifilis,
	case
		when(select max(ddp.cd_doenca) from diagnostico_doenca ddp where b.nr_atendimento = ddp.nr_atendimento) is not null
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'SINDT' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as sospechasindrometurner,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 15 and pf_p.ie_sexo = 'F'
		then
			case
				when exists (select 1 from sinan_inf_violencia siv, notificacao_sinan nf where siv.nr_seq_notificacao = nf.nr_sequencia and nf.nr_atendimento = b.nr_atendimento and ie_tipo_violencia = 2)
				then 0
				else 1
			end
		else -1
	end as violenciafamiliar,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_inicio_atendimento, 'A') >= 15 and pf_p.ie_sexo = 'M'
		then
			case
				when exists (select 1 from cid_doenca cc1, diagnostico_doenca ddp where cc1.ie_doenca_cronica_mx = 'HIPPR' and cc1.cd_doenca_cid like ddp.cd_doenca and ddp.nr_atendimento = b.nr_atendimento)
				then 0
				else 1
			end
		else -1
	end as hiperplasiaprostatica,
	0 tirasembarazadassanas,
	0 tirasdeteccion,
	0 tirascontrol,
	0 reactivosantigenoprostatico,
	0 cartillavacunacion,
	0 telemedicina,
	b.dt_entrada dt_entrada,
	b.nr_atendimento nr_atendimento
FROM person_name y, atend_profissional profissional, pessoa_juridica pj, pessoa_fisica pf_m, atend_categoria_convenio p, medico m, estabelecimento e, categoria_convenio cc, atendimento_paciente b, pessoa_fisica pf_p
LEFT OUTER JOIN sus_municipio sm ON (pf_p.cd_municipio_ibge = sm.cd_municipio_ibge)
LEFT OUTER JOIN cat_entidade ce ON (sm.nr_seq_entidade_mx = ce.nr_sequencia)
, convenio n
LEFT OUTER JOIN cat_derechohabiencia k ON (n.cd_tipo_convenio_mx = k.nr_sequencia)
WHERE b.nr_atendimento  	= p.nr_atendimento and pj.cd_cgc 		= e.cd_cgc and b.cd_estabelecimento 	= e.cd_estabelecimento and b.cd_pessoa_fisica	= pf_p.cd_pessoa_fisica and b.cd_medico_resp 	= m.cd_pessoa_fisica and pf_m.cd_pessoa_fisica 	= m.cd_pessoa_fisica   and p.cd_convenio 		= cc.cd_convenio and p.cd_categoria 		= cc.cd_categoria and n.cd_convenio 		= cc.cd_convenio  and b.nr_atendimento 	= profissional.nr_atendimento and y.nr_sequencia 		= pf_p.nr_seq_person_name and y.ds_type		= 'main';

