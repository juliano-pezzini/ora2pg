-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exportar_nota_piracicaba_v (tp_registro, nr_sequencia, dt_emissao, dt_entrada_saida, cd_estabelecimento, cd_cpf_cnpj, valor_registro) AS select 	DISTINCT 0																			TP_REGISTRO,
	0 																				NR_SEQUENCIA, 
	null																				DT_EMISSAO, 
	null																				DT_ENTRADA_SAIDA, 
	e.cd_estabelecimento 																		CD_ESTABELECIMENTO,	 
	e.CD_CGC																			CD_CPF_CNPJ, 
	''																				||'|'|| --sequencial 
	'1.06'																				||'|'|| 
	''																				VALOR_REGISTRO 
FROM 	estabelecimento_v e 
where	1 = 1 
and 	nfse_obter_regra('TP', e.cd_estabelecimento) is not NULL 
GROUP BY  e.cd_estabelecimento , e.CD_CGC 

UNION
  
--Nota 
select DISTINCT 1 																			TP_REGISTRO, 
	n.nr_sequencia 																			NR_SEQUENCIA, 
	n.dt_emissao																			DT_EMISSAO, 
	n.dt_entrada_saida																		DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 																		CD_ESTABELECIMENTO, 
	''																				CD_CPF_CNPJ, 
	''																				||'|'|| -- sequencial 
	(select max(nr_seq_lote) from w_nota_fiscal) 															||'|'|| --lote_rps 
	n.cd_cgc_emitente																		||'|'|| --cnpj 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM')															||'|'|| --inscricao_municipal 
	Obter_Cod_Municipio_IBGE(substr(nfe_obter_dados_pj(n.cd_cgc_emitente,'CEP'),1,8))										||'|'|| --es_municipio 
	n.nr_nota_fiscal 																		||'|'|| --Numero Rps 
	n.cd_serie_nf 																			||'|'|| --Serie Rps 
	to_char(n.dt_emissao,'dd/mm/yyyy')																||'|'|| --Data Emissao 
	Obter_Desc_Natureza_Operacao(n.cd_natureza_operacao)														||'|'|| --Natureza Operacao 
	nfse_obter_regra('RET', n.cd_estabelecimento)															||'|'|| --Regime Tributacao 
	nfse_obter_regra('OSN', n.cd_estabelecimento)															||'|'|| --sn_optante_simples_nacional 
	CASE WHEN n.ie_situacao='1' THEN '1'  ELSE '2' END 																||'|'|| --cd_status 
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), 
											obter_procedimento_nfse(n.nr_sequencia,'O'),n.cd_estabelecimento), 'GR') 	||'|'|| --es_item_lista_servico 
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), 
											obter_procedimento_nfse(n.nr_sequencia,'O'),n.cd_estabelecimento), 'CD') 	||'|'|| --cd_tributacao_municipio 
	substr(coalesce(obter_dados_cnae(obter_dados_pf_pj(null,n.cd_cgc_emitente, 'CNAE'),'ID'),'0'),1, 11)									||'|'|| --es_cnae 
	coalesce(SUBSTR(obter_descricao_rps(n.cd_estabelecimento, n.nr_sequencia,'DS_SERVICOS'),1,1000),'Servicos')								||'|'|| --discriminacao	 
	campo_mascara(n.vl_mercadoria,2)																||'|'|| --vl_servicos 
	CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN campo_mascara(obter_valor_tributo_nota(n.nr_sequencia,'V'),2)  ELSE null END 						||'|'|| --vl_deducao 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'PIS')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'PIS'),2) END 		||'|'|| --vl_pis 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'COFINS')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'COFINS'),2) END 	||'|'|| --vl_cofins 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS'),2) END 		||'|'|| --vl_inss 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR'),2) END 		||'|'|| --vl_ir 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'CSLL')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'CSLL'),2) END 		||'|'|| --vl_csll 
	CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN '1'  ELSE '2' END 													||'|'|| --sn_iss_retido 
	campo_mascara(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='N' THEN  							(((n.vl_total_nota - n.vl_descontos)*Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'))/100)  ELSE 0 END ,2)	||'|'|| --vl_iss 	 
	campo_mascara(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'V','ISS')  ELSE 0 END ,2)			||'|'|| --vl_iss_retido 
	CASE WHEN obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'O')=0 THEN null  ELSE campo_mascara(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'O'),2) END 			||'|'|| --vl_outras_retencoes 
	campo_mascara((n.vl_total_nota - n.vl_descontos),2)												||'|'|| --vl_base_calculo 
	campo_mascara(dividir(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'X', 'ISS'),100),2)										||'|'|| --vl_aliquota 
	CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN (campo_mascara((n.vl_mercadoria) - obter_Valor_Tributo_Nota(nr_sequencia, 'V') - coalesce(n.vl_descontos, 0), 2))  ELSE ((n.vl_mercadoria) 	- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'PIS'), 0)) 											- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'COFINS'), 0)) 											- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS'), 0)) 											- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR'), 0)) 											- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'CSLL'), 0)) 											- (coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'O'), 0)) 											- (CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN  coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'ISS'), 0)  ELSE 0 END ) 											- (coalesce(n.vl_descontos, 0))) END 							||'|'|| --vl_liquido_nfse 
	CASE WHEN n.vl_descontos=0 THEN  null  ELSE campo_mascara(n.vl_descontos,2) END 												||'|'|| --vl_desconto_incondicionado 
	0																				||'|'|| --vl_desconto_condicionado 
	CASE WHEN n.cd_cgc='' THEN CASE WHEN SUBSTR(obter_dados_pf(n.cd_pessoa_fisica,'CPF'),1,11)='' THEN 1  ELSE 3 END   ELSE 2 END 									||'|'|| --tom_cd_cpf_cnpj_tipo 
	CASE WHEN n.cd_cgc='' THEN coalesce(SUBSTR(obter_dados_pf(n.cd_pessoa_fisica,'CPF'),1,11),'00000000000')  ELSE n.cd_cgc END 								||'|'|| --tom_cpf_cnpj 
	''																				||'|'|| --tom_inscricao_municipal 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,60)													||'|'|| --tom_razao_social 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'EN'),1,50) END 									||'|'|| --tom_endereco 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),1,10)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NR'),1,10) END 									||'|'|| --tom_endereco_numero 
	''																				||'|'|| --tom_endereco_complemento 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,30)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'B'),1,30) END  									||'|'|| --tom_endereco_bairro 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2)  ELSE 'EX' END 								||'|'|| --tom_endereco_uf 
	''																				||'|'|| --tom_endereco_cep 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  CASE WHEN n.cd_cgc IS NULL THEN  '99999 '  ELSE Obter_Cod_Municipio_IBGE(substr(nfe_obter_dados_pj(n.cd_cgc,'CEP'),1,8)) END  END 			||'|'|| --tom_endereco_es_municipio 
	''																				||'|'|| --tom_telefone 
	''																				||'|'|| --tom_email 
	''																				||'|'|| --intermediario_razao_social	 
	''																				||'|'|| --intermediario_cpf_cnpj 
	''																				||'|'|| --intermediario_cd_cpf_cnpj_tipo 
	''																				||'|'|| --intermediario_inscricao_municipal 
	''																				||'|'|| --construcao_civil_cd_obra 
	''																				||'|'|| --construcao_civil_cd_art 
	''																				||'|'|| --numero_substituta 
	''																				||'|'|| --serie_substituta 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  CASE WHEN n.cd_cgc IS NULL THEN  '99999 '  ELSE Obter_Cod_Municipio_IBGE(substr(nfe_obter_dados_pj(n.cd_cgc,'CEP'),1,8)) END  END 			||'|'|| --orgao_gerador_es_municipio 
	'SP'																				||'|'|| --orgao_gerador_uf 
	''																				||'|'|| --outras_informacoes 
	''																				||'|'|| --tom_inscricao_estadual 
	''																				VALOR_REGISTRO 
from 	nota_fiscal n, 
	estabelecimento e 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	n.cd_estabelecimento = e.cd_estabelecimento 
and	exists (select 1 from w_nota_fiscal w where w.nr_seq_nota_fiscal = n.nr_sequencia) 
and n.vl_mercadoria > 0 

UNION
  
--Itens da Nota 
select DISTINCT 2 																			TP_REGISTRO, 
	0 																        			NR_SEQUENCIA, 
	null																				DT_EMISSAO, 
	null																				DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 																		CD_ESTABELECIMENTO, 
	''																				CD_CPF_CNPJ, 
	''																				||'|'|| --sequencial 
	CASE WHEN i.CD_MATERIAL IS NULL THEN Obter_Desc_Procedimento(i.CD_PROCEDIMENTO,i.IE_ORIGEM_PROCED)  ELSE Obter_Desc_Material(i.CD_MATERIAL) END 					||'|'|| --descricao 
	CASE WHEN i.CD_MATERIAL IS NULL THEN ''  ELSE Campo_Mascara(i.qt_item_nf,2) END 													||'|'||	--qt_item 
	Campo_Mascara(i.vl_unitario_item_nf,4)																||'|'||	--vl_unitario 
	''																				||'|'|| --sn_iss_tributavel 
	''																				VALOR_REGISTRO 
from 	nota_fiscal n, 
	nota_fiscal_item i 
where	i.nr_sequencia = n.nr_sequencia 
and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	exists (select 1 from w_nota_fiscal w where w.nr_seq_nota_fiscal = n.nr_sequencia) 
and n.vl_mercadoria > 0 
group by n.cd_estabelecimento, i.cd_material, i.cd_procedimento,i.ie_origem_proced, i.qt_item_nf, i.vl_unitario_item_nf;

