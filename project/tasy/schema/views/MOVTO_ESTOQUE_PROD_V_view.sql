-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW movto_estoque_prod_v (nr_movimento_estoque, cd_estabelecimento, cd_local_estoque, dt_movimento_estoque, cd_operacao_estoque, cd_acao, cd_material_estoque, dt_mesano_referencia, dt_processo, cd_unidade_medida_estoque, cd_setor_atendimento, ie_origem_documento, nr_documento, nr_sequencia_item_docto, cd_fornecedor, cd_local_estoque_destino, cd_centro_custo, cd_conta_contabil, qt_movimento, cd_unidade_med_mov, nm_usuario, dt_atualizacao, ds_observacao, nr_seq_tab_orig, nr_atendimento, qt_estoque, vl_estoque, vl_movimento) AS SELECT	M.NR_MOVIMENTO_ESTOQUE,
	M.CD_ESTABELECIMENTO,
	M.CD_LOCAL_ESTOQUE,
	M.DT_MOVIMENTO_ESTOQUE,
	M.CD_OPERACAO_ESTOQUE,
	M.CD_ACAO,
	M.CD_MATERIAL_ESTOQUE,
	M.DT_MESANO_REFERENCIA,
	M.DT_PROCESSO,
	M.CD_UNIDADE_MEDIDA_ESTOQUE,
	M.CD_SETOR_ATENDIMENTO,
	M.IE_ORIGEM_DOCUMENTO,
	M.NR_DOCUMENTO,
	M.NR_SEQUENCIA_ITEM_DOCTO,
	M.CD_FORNECEDOR,
	M.CD_LOCAL_ESTOQUE_DESTINO,
	M.CD_CENTRO_CUSTO,
	M.cd_conta_contabil,
	M.QT_MOVIMENTO,
	M.CD_UNIDADE_MED_MOV,
	M.nm_usuario,
	M.dt_atualizacao,
	M.DS_OBSERVACAO,
	M.nr_seq_tab_orig,
	M.nr_atendimento,
	CASE WHEN M.CD_ACAO=2 THEN  M.QT_ESTOQUE * -1  ELSE M.QT_ESTOQUE END  QT_ESTOQUE,
	CASE WHEN M.CD_ACAO=2 THEN  SUM(CASE WHEN T.IE_AUMENTA_DIMINUI_VALOR='A' THEN (V.VL_MOVIMENTO * -1) WHEN T.IE_AUMENTA_DIMINUI_VALOR='D' THEN (V.VL_MOVIMENTO) WHEN T.IE_AUMENTA_DIMINUI_VALOR='N' THEN (0) END ) WHEN M.CD_ACAO=1 THEN  SUM(CASE WHEN T.IE_AUMENTA_DIMINUI_VALOR='A' THEN (V.VL_MOVIMENTO) WHEN T.IE_AUMENTA_DIMINUI_VALOR='D' THEN (V.VL_MOVIMENTO * -1) WHEN T.IE_AUMENTA_DIMINUI_VALOR='N' THEN (0) END ) END  vl_estoque,
	CASE WHEN M.CD_ACAO=2 THEN  SUM(CASE WHEN T.IE_AUMENTA_DIMINUI_VALOR='A' THEN (V.VL_MOVIMENTO * -1) WHEN T.IE_AUMENTA_DIMINUI_VALOR='D' THEN (V.VL_MOVIMENTO) WHEN T.IE_AUMENTA_DIMINUI_VALOR='N' THEN (0) END ) WHEN M.CD_ACAO=1 THEN  SUM(CASE WHEN T.IE_AUMENTA_DIMINUI_VALOR='A' THEN (V.VL_MOVIMENTO) WHEN T.IE_AUMENTA_DIMINUI_VALOR='D' THEN (V.VL_MOVIMENTO * -1) WHEN T.IE_AUMENTA_DIMINUI_VALOR='N' THEN (0) END ) END  vl_movimento
FROM operacao_estoque o, lote_producao l, movimento_estoque m
LEFT OUTER JOIN movimento_estoque_valor v ON (M.NR_MOVIMENTO_ESTOQUE = V.NR_MOVIMENTO_ESTOQUE)
LEFT OUTER JOIN tipo_valor t ON (V.CD_TIPO_VALOR = T.CD_TIPO_VALOR)
WHERE M.CD_OPERACAO_ESTOQUE   = O.CD_OPERACAO_ESTOQUE AND L.NR_LOTE_PRODUCAO	= M.NR_DOCUMENTO AND O.IE_TIPO_REQUISICAO	= 7  -- Produção
  AND M.DT_PROCESSO IS NOT NULL group by
	M.CD_ESTABELECIMENTO,
	M.DT_MESANO_REFERENCIA,
	M.DT_PROCESSO,
	M.CD_LOCAL_ESTOQUE,
	M.NR_MOVIMENTO_ESTOQUE,
	M.DT_MOVIMENTO_ESTOQUE,
	M.CD_OPERACAO_ESTOQUE,
	M.CD_ACAO,
	M.CD_MATERIAL_ESTOQUE,
	M.CD_UNIDADE_MEDIDA_ESTOQUE,
	M.CD_SETOR_ATENDIMENTO,
	M.IE_ORIGEM_DOCUMENTO,
	M.NR_DOCUMENTO,
	M.NR_SEQUENCIA_ITEM_DOCTO,
	M.CD_FORNECEDOR,
	M.CD_LOCAL_ESTOQUE_DESTINO,
	M.CD_CENTRO_CUSTO,
	M.cd_conta_contabil,
	M.QT_MOVIMENTO,
	M.CD_UNIDADE_MED_MOV,
	M.nm_usuario,
	M.dt_atualizacao,
	CASE WHEN M.CD_ACAO=2 THEN  M.QT_ESTOQUE * -1  ELSE M.QT_ESTOQUE END ,
	M.DS_OBSERVACAO,
	M.nr_seq_tab_orig,
	M.nr_atendimento;

