-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW agenda_paciente_exames_v (ds_agenda, nr_minuto_duracao, nm_paciente_pf, nr_atendimento, ds_convenio, nm_medico, qt_min_espera_tasy, dt_entrada_tasy, cd_pessoa_fisica, ds_observacao, ds_status_paciente, ds_protocolo, ds_cirurgia, dt_agenda, cd_procedimento, nr_sequencia, ie_origem_proced, nr_seq_proc_interno, nm_usuario_acesso, nr_seq_status_pac, cd_tipo_agenda, ie_situacao, cd_estabelecimento, cd_medico_exec, cd_turno, ie_status_agenda, nm_paciente, hr_inicio, cd_agenda, ie_status_laudo, dt_confirmacao, ie_autorizacao, ie_encaixe) AS select
	a.ds_agenda,
	b.nr_minuto_duracao,
	substr(CASE WHEN b.ie_status_agenda='b' THEN CASE WHEN b.ds_observacao IS NULL THEN  'bloqueado'  ELSE 'bloqueado('|| b.ds_observacao || ')' END   ELSE coalesce(substr(obter_nome_pf(p.cd_pessoa_fisica),1,200),substr(b.nm_paciente,1,200)) END ,1,200) nm_paciente_pf,
	b.nr_atendimento,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	substr(obter_nome_pf(b.cd_medico),1,200) nm_medico,
	Obter_Tempo_Espera_Atend(b.nr_atendimento) qt_min_espera_tasy,
	obter_data_entrada(b.nr_atendimento) dt_entrada_tasy,
	b.cd_pessoa_fisica,
	substr(b.ds_observacao,1,250) ds_observacao,
	s.ds_status_paciente,
	b.ds_protocolo,
	substr(b.ds_cirurgia,1,250) ds_cirurgia,
	b.dt_agenda,
	b.cd_procedimento,
	b.nr_sequencia,
	b.ie_origem_proced,
	b.nr_seq_proc_interno,
	b.nm_usuario_acesso,
	b.nr_seq_status_pac,
	a.cd_tipo_agenda,
	a.ie_situacao,
	a.cd_estabelecimento,
	b.cd_medico_exec,
	b.cd_turno,
	b.ie_status_agenda,
	b.nm_paciente,
	b.hr_inicio,
	a.cd_agenda,
	substr(coalesce(obter_status_laudo_agenda(b.nr_sequencia, b.nr_atendimento),'N'),1,3) ie_status_laudo,
	b.dt_confirmacao,
	b.ie_autorizacao,
	b.ie_encaixe
FROM agenda a, agenda_paciente b
LEFT OUTER JOIN pessoa_fisica p ON (b.cd_pessoa_fisica = p.cd_pessoa_fisica)
LEFT OUTER JOIN agenda_paciente_classif x ON (b.nr_seq_classif_agenda = x.nr_sequencia)
LEFT OUTER JOIN status_paciente_agenda s ON (b.nr_seq_status_pac = s.nr_sequencia)
LEFT OUTER JOIN paciente_senha_fila sf ON (b.nr_seq_pac_senha_fila = sf.nr_sequencia)
WHERE a.cd_agenda = b.cd_agenda;

