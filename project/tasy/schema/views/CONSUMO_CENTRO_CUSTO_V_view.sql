-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW consumo_centro_custo_v (nr_atendimento, nr_movimento_estoque, cd_estabelecimento, cd_local_estoque, dt_movimento_estoque, cd_operacao_estoque, cd_acao, cd_material_estoque, dt_mesano_referencia, cd_unidade_medida_estoque, cd_setor_atendimento, nr_documento, cd_local_estoque_destino, cd_centro_custo, qt_estoque, vl_estoque) AS select 	m.nr_atendimento,
	m.nr_movimento_estoque,
        	m.cd_estabelecimento,
	m.cd_local_estoque,
	m.dt_movimento_estoque,
	m.cd_operacao_estoque,
	m.cd_acao,
	m.cd_material_estoque,
	m.dt_mesano_referencia,
	m.cd_unidade_medida_estoque,
	m.cd_setor_atendimento,
	m.nr_documento,
	m.cd_local_estoque_destino,
	m.cd_centro_custo,
	CASE WHEN m.cd_acao=1 THEN  CASE WHEN o.ie_consumo='U' THEN  m.qt_estoque WHEN o.ie_consumo='D' THEN  		 m.qt_estoque * -1  ELSE 0 END   ELSE CASE WHEN o.ie_consumo='A' THEN  m.qt_estoque * -1 WHEN o.ie_consumo='D' THEN   		 m.qt_estoque  ELSE 0 END  END qt_estoque,
	CASE WHEN m.cd_acao=2 THEN  CASE WHEN o.ie_consumo='A' THEN  v.vl_movimento * -1 WHEN o.ie_consumo='D' THEN  		 v.vl_movimento  ELSE 0 END   ELSE CASE WHEN o.ie_consumo='A' THEN  v.vl_movimento WHEN o.ie_consumo='D' THEN  		v.vl_movimento * -1  ELSE 0 END  END vl_estoque
FROM operacao_estoque o, movimento_estoque m
LEFT OUTER JOIN movimento_estoque_valor v ON (m.nr_movimento_estoque = v.nr_movimento_estoque)
WHERE m.cd_operacao_estoque = o.cd_operacao_estoque and m.cd_centro_custo is not null;

