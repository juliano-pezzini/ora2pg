-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sla_dashboard_diario_v (extract_date, customer, so_number, so_description, customer_classification, philips_classification, customer_severity, philips_severity, so_sla, development_group, develop_management, develop_manager, support_group, support_management, support_manager, sla_id, sla_description, target_response, target_resolution, so_open_time, so_open_month_year, so_close_time, so_close_month_year, response_finish_in, resolution_finish_in, work_start, aging, actual_stage, last_update_philips, days_without_update_philips, last_update_customer, so_response_time, so_resolution_time, customer_time, sla_resolution_remaining, perc_sla_resolution_remaining, sla_resolution_breached, sla_resolution_breached_in, sla_response_remaining, perc_sla_response_remaining, sla_response_breached, so_reclassification_time, so_worked, status_sla_resolution, localization, status_sla_response) AS select REL2.EXTRACT_DATE,REL2.CUSTOMER,REL2.SO_NUMBER,REL2.SO_DESCRIPTION,REL2.CUSTOMER_CLASSIFICATION,REL2.PHILIPS_CLASSIFICATION,REL2.CUSTOMER_SEVERITY,REL2.PHILIPS_SEVERITY,REL2.SO_SLA,REL2.DEVELOPMENT_GROUP,REL2.DEVELOP_MANAGEMENT,REL2.DEVELOP_MANAGER,REL2.SUPPORT_GROUP,REL2.SUPPORT_MANAGEMENT,REL2.SUPPORT_MANAGER,REL2.SLA_ID,REL2.SLA_DESCRIPTION,REL2.TARGET_RESPONSE,REL2.TARGET_RESOLUTION,REL2.SO_OPEN_TIME,REL2.SO_OPEN_MONTH_YEAR,REL2.SO_CLOSE_TIME,REL2.SO_CLOSE_MONTH_YEAR,REL2.RESPONSE_FINISH_IN,REL2.RESOLUTION_FINISH_IN,REL2.WORK_START,REL2.AGING,REL2.ACTUAL_STAGE,REL2.LAST_UPDATE_PHILIPS,REL2.DAYS_WITHOUT_UPDATE_PHILIPS,REL2.LAST_UPDATE_CUSTOMER,REL2.SO_RESPONSE_TIME,REL2.SO_RESOLUTION_TIME,REL2.CUSTOMER_TIME,REL2.SLA_RESOLUTION_REMAINING,REL2.PERC_SLA_RESOLUTION_REMAINING,REL2.SLA_RESOLUTION_BREACHED,REL2.SLA_RESOLUTION_BREACHED_IN,REL2.SLA_RESPONSE_REMAINING,REL2.PERC_SLA_RESPONSE_REMAINING,REL2.SLA_RESPONSE_BREACHED,REL2.SO_RECLASSIFICATION_TIME,REL2.SO_WORKED,REL2.STATUS_SLA_RESOLUTION,REL2.LOCALIZATION
      ,CASE
        WHEN REL2.SLA_RESPONSE_BREACHED = 'S' THEN 
          'Breached' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 0  and REL2.PERC_SLA_RESPONSE_REMAINING <= 25 THEN 
          'Critical' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 25 and REL2.PERC_SLA_RESPONSE_REMAINING <= 75 THEN 
          'Warning' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 75 THEN 
          'Good'
        ELSE
          NULL
      END 
      STATUS_SLA_RESPONSE
FROM (
SELECT to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss') EXTRACT_DATE
       ,REL1.CUSTOMER
       ,REL1.SO_NUMBER
       ,REL1.SO_DESCRIPTION
       ,REL1.CUSTOMER_CLASSIFICATION
       ,REL1.PHILIPS_CLASSIFICATION
       ,REL1.CUSTOMER_SEVERITY
       ,REL1.PHILIPS_SEVERITY
       ,REL1.SO_SLA
       ,REL1.DEVELOPMENT_GROUP
       ,REL1.DEVELOP_MANAGEMENT 
       ,REL1.DEVELOP_MANAGER
       ,REL1.SUPPORT_GROUP
       ,REL1.SUPPORT_MANAGEMENT
       ,REL1.SUPPORT_MANAGER
       ,REL1.SLA_ID
       ,REL1.SLA_DESCRIPTION
       ,REL1.TARGET_RESPONSE
       ,REL1.TARGET_RESOLUTION
       ,REL1.SO_OPEN_TIME
       ,REL1.SO_OPEN_MONTH_YEAR
       ,REL1.SO_CLOSE_TIME
       ,REL1.SO_CLOSE_MONTH_YEAR
       ,REL1.RESPONSE_FINISH_IN
       ,REL1.RESOLUTION_FINISH_IN
       ,REL1.WORK_START
       ,REL1.AGING
       ,REL1.ACTUAL_STAGE
       ,REL1.LAST_UPDATE_PHILIPS
       ,REL1.DAYS_WITHOUT_UPDATE_PHILIPS
       ,REL1.LAST_UPDATE_CUSTOMER
       ,REL1.SO_RESPONSE_TIME 
       ,REL1.SO_RESOLUTION_TIME
       ,REL1.CUSTOMER_TIME
       ,REL1.SLA_RESOLUTION_REMAINING 
       ,REL1.PERC_SLA_RESOLUTION_REMAINING 
       ,REL1.SLA_RESOLUTION_BREACHED 
       ,CASE WHEN  REL1.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                        WHEN REL1.IE_TEMPO='COR' THEN                          TO_CHAR(TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL1.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                       ELSE (    select to_char(man_obter_hor_com(ml.cd_estabelecimento                                                                  ,CASE                                                                     WHEN msr.QT_MIN_TERMINO > REL1.SO_RESOLUTION_TIME  THEN                                                                      max(mose.DT_ATUALIZACAO)                                                                    ELSE                                                                      min(mose.DT_ATUALIZACAO)                                                                   END                                                                   ,CASE                                                                     WHEN msr.QT_MIN_TERMINO > REL1.SO_RESOLUTION_TIME  THEN (msr.QT_MIN_TERMINO - REL1.SO_RESOLUTION_TIME)                                                                    ELSE                                                                      msr.QT_MIN_TERMINO                                                                   END                                                                   )                                          ,'DD/MM/YYYY HH24:MI:SS') SLA_RESOLUTION_BREACHED_IN                             from MAN_SLA ms                                   ,MAN_SLA_REGRA msr                                   ,MAN_SLA_LOC msl                                   ,MAN_LOCALIZACAO ml                                   ,man_ordem_servico mos                                    ,man_ordem_serv_estagio mose                                  ,man_estagio_processo mep                             where ms.IE_SITUACAO='A'                               and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA                               and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA                               and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL                               and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE --FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA
							  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
                              and mos.nr_seq_localizacao = ml.nr_sequencia                              and mos.nr_sequencia = mose.NR_SEQ_ORDEM                              and mose.nr_seq_estagio = mep.nr_sequencia                                and mos.nr_sequencia = REL1.SO_NUMBER                              and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)-- 2	Cliente (Teste); 261	Desenv aguardando cliente; 1341	Aguardando Inf. do Cliente - Suporte; 1511	Cliente (Teste) - OK; 1902	Tec aguardando definicao cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado; 121-Aguardando conexao; 41 Aguardando informacoes do Cliente
                         group by msr.QT_MIN_TERMINO,ml.cd_estabelecimento )                   END END 
        SLA_RESOLUTION_BREACHED_IN
       ,(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) SLA_RESPONSE_REMAINING 
       ,CASE  
          WHEN REL1.SO_RESPONSE_TIME < REL1.TARGET_RESPONSE THEN 
           100-round((REL1.SO_RESPONSE_TIME*100/REL1.TARGET_RESPONSE)::numeric,1) 
          ELSE  
           0 
        END 
        PERC_SLA_RESPONSE_REMAINING 
       ,CASE  
          WHEN(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) > 0 THEN 
           'N' 
          ELSE  
           'S' 
        END SLA_RESPONSE_BREACHED         
       ,CASE 
           WHEN TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') > TO_DATE('17/07/2015', 'DD/MM/YYYY HH24:MI:SS') THEN 
            TO_CHAR((select MAX(most.DT_ATUALIZACAO) 
                                 from MAN_ORDEM_SERV_TECNICO most 
                                where most.NR_SEQ_TIPO = 148 -- 148=mudanca de historico
                                  and most.NR_SEQ_ORDEM_SERV = REL1.SO_NUMBER),'DD/MM/YYYY HH24:MI:SS') 
          WHEN REL1.SO_SLA = 'N' THEN
            '17/07/2015 08:00:00' 
        END
        SO_RECLASSIFICATION_TIME
       ,CASE
          WHEN( select count(mosa.NR_SEQUENCIA)
                   from MAN_ORDEM_SERV_ATIV mosa
                  where mosa.NR_SEQ_ORDEM_SERV= REL1.SO_NUMBER
                    and mosa.NR_SEQ_FUNCAO in (select mtf.nr_SEQUENCIA from man_tipo_funcao mtf where mtf.NR_SEQ_GRUPO_TRAB = 1)
                    and trunc(mosa.DT_ATIVIDADE) = trunc(LOCALTIMESTAMP)) > 0 THEN --:PARAM_DATE
          'S'
        ELSE
          'N'
        END
        SO_WORKED 
        ,CASE  
          WHEN REL1.SLA_RESOLUTION_BREACHED = 'S' THEN 
            'Breached' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) <= 390 THEN 
            'Critical' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) between 390 and 1440 THEN 
            'Warning' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) > 1440 THEN 
            'Good'
          ELSE
            NULL
        END 
        STATUS_SLA_RESOLUTION 
       ,CASE  
          WHEN UPPER(REL1.ACTUAL_STAGE) IN (
              'CLIENTE (TESTE)'
              ,'AGUARDANDO INFORMACOES DO CLIENTE'
              ,'AGUARDANDO INF. DO CLIENTE - SUPORTE'
              ,'CLIENTE (TESTE) - OK'
              ,'TEC AGUARDANDO definicao CLIENTE'
              ,'DESENV AGUARDANDO CLIENTE'
              ,'AGUARDANDO CONEXAO') THEN 
           'CUSTOMER' 
          ELSE  
           'PHILIPS' 
        END LOCALIZATION
FROM (
        SELECT --REL.* 
               REL.CUSTOMER
               ,REL.SO_NUMBER
               ,REL.SO_DESCRIPTION
               ,REL.CUSTOMER_CLASSIFICATION
               ,REL.PHILIPS_CLASSIFICATION
               ,REL.CUSTOMER_SEVERITY
               ,REL.PHILIPS_SEVERITY
               ,REL.SO_SLA
               ,REL.DEVELOPMENT_GROUP
               ,REL.DEVELOP_MANAGEMENT 
               ,REL.DEVELOP_MANAGER
               ,REL.SUPPORT_GROUP
               ,REL.SUPPORT_MANAGEMENT
               ,REL.SUPPORT_MANAGER
               ,REL.SLA_ID
               ,REL.SLA_DESCRIPTION
               ,REL.TARGET_RESPONSE
               ,REL.TARGET_RESOLUTION
               ,REL.SO_OPEN_TIME
               ,REL.SO_OPEN_MONTH_YEAR
               ,REL.SO_CLOSE_TIME
               ,null SO_CLOSE_MONTH_YEAR -- NAO PEGAR DATA DE ENCERRAMENTO PORQUE A OS AINDA ESTA ABERTA
               ,REL.RESPONSE_FINISH_IN
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                        WHEN REL.IE_TEMPO='COR' THEN                          TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                       ELSE                           TO_CHAR(man_obter_hor_com(REL.cd_estabelecimento                                                        ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')                                                        ,REL.TARGET_RESOLUTION                                                ),'DD/MM/YYYY HH24:MI:SS')                     END END 
                RESOLUTION_FINISH_IN                 
               ,REL.WORK_START	
               ,REL.AGING
               ,CASE WHEN trunc(LOCALTIMESTAMP)                       =trunc(LOCALTIMESTAMP) THEN REL.ACTUAL_STAGE                         ELSE (  select max(b.ds_estagio)                             from man_ordem_serv_estagio a, man_estagio_processo b                            where a.nr_seq_estagio = b.nr_sequencia                              and a.nr_seq_ordem	= REL.SO_NUMBER                              and a.dt_atualizacao = (select max(c.dt_atualizacao)                                                        from man_ordem_serv_estagio c                                                       where c.nr_seq_ordem	= a.nr_seq_ordem                                                         and trunc(c.dt_atualizacao) <= trunc(LOCALTIMESTAMP))) END 
                ACTUAL_STAGE
               ,REL.LAST_UPDATE_PHILIPS
               ,CASE 
                  WHEN trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')) < trunc(LOCALTIMESTAMP) THEN
                    round(trunc(LOCALTIMESTAMP) - trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss'))) 
                  ELSE
                    0
                END     
                DAYS_WITHOUT_UPDATE_PHILIPS --:PARAM_DATE
               ,REL.LAST_UPDATE_CUSTOMER
               ,coalesce(Man_Obter_Min_com(REL.cd_estabelecimento
                                 ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')
                                 ,TO_DATE(REL.WORK_START,'DD/MM/YYYY HH24:MI:SS') 
                                 ),0) SO_RESPONSE_TIME 
               ,REL.SO_RESOLUTION_TIME	
               ,REL.CUSTOMER_TIME	
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE (REL.TARGET_RESOLUTION-REL.SO_RESOLUTION_TIME) END  SLA_RESOLUTION_REMAINING 
               ,CASE  
                  WHEN(REL.TARGET_RESOLUTION > 0 and REL.SO_RESOLUTION_TIME < REL.TARGET_RESOLUTION) THEN 
                    100-round((REL.SO_RESOLUTION_TIME*100/REL.TARGET_RESOLUTION)::numeric,1) 
                  WHEN(REL.TARGET_RESOLUTION > 0 and REL.SO_RESOLUTION_TIME > REL.TARGET_RESOLUTION) THEN 
                    0
                  ELSE  
                    NULL 
                END 
                PERC_SLA_RESOLUTION_REMAINING 
               ,CASE  
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) > 0) THEN 
                    'N' 
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) <= 0) THEN 
                    'S' 
                  ELSE  
                    NULL
                END SLA_RESOLUTION_BREACHED 
               --obtem se houve encerramento automatico pela job de cancelamento quando nao ja retorno do cliente 

               ,(select a.nr_seq_tipo 
                   from (  select most.nr_seq_tipo, most.NR_SEQ_ORDEM_SERV
                             from MAN_ORDEM_SERV_TECNICO most 
                            where trunc(most.DT_HISTORICO) < trunc(LOCALTIMESTAMP) 
                         order by most.dt_atualizacao desc
                        )a
                  where a.NR_SEQ_ORDEM_SERV = REL.SO_NUMBER  LIMIT 1) 
                HAS_AUTOMATIC_CLOSE 
               ,REL.IE_TEMPO
        FROM ( 
           select ml.DS_LOCALIZACAO "CUSTOMER"          
                  ,CASE 
                    WHEN mos.ie_classificacao_cliente ='E'  THEN 
                      'Defeito'
                    WHEN mos.ie_classificacao_cliente ='S'  THEN 
                      'Solicitacao'
                    WHEN mos.ie_classificacao_cliente ='D'  THEN 
                      'Duvida'
                  END
                  CUSTOMER_CLASSIFICATION
                  ,CASE 
                    WHEN mos.ie_classificacao ='E'  THEN 
                      'Defeito'
                    WHEN mos.ie_classificacao ='S'  THEN 
                      'Solicitacao'
                    WHEN mos.ie_classificacao ='D'  THEN 
                      'Duvida'
                  END
                  PHILIPS_CLASSIFICATION
                  ,mos.nr_sequencia SO_NUMBER 
                  ,mos.ds_dano_breve SO_DESCRIPTION 
                  ,mos.ie_prioridade PHILIPS_SEVERITY  
                  ,mos.ie_prioridade_cliente CUSTOMER_SEVERITY 
                  ,man_obter_se_os_sla(mos.NR_SEQUENCIA) SO_SLA 
                  ,gd.DS_GRUPO DEVELOPMENT_GROUP
                  ,gwd.DS_GERENCIA "DEVELOP_MANAGEMENT" 
                  ,obter_nome_pf_pj(gwd.cd_responsavel,null) "DEVELOP_MANAGER"
                  ,gs.DS_GRUPO SUPPORT_GROUP
                  ,gws.DS_GERENCIA "SUPPORT_MANAGEMENT" 
                  ,obter_nome_pf_pj(gws.cd_responsavel,null) "SUPPORT_MANAGER"
                  ,ms.NR_SEQUENCIA SLA_ID 
                  ,ms.DS_TITULO SLA_DESCRIPTION
                  ,msr.QT_MIN_INICIO TARGET_RESPONSE 
                  ,msr.QT_MIN_TERMINO TARGET_RESOLUTION
                  ,msr.IE_TEMPO
                  ,TO_CHAR(mos.dt_ordem_servico, 'DD/MM/YYYY HH24:MI:SS') SO_OPEN_TIME 
                  ,trunc(mos.dt_ordem_servico, 'month') SO_OPEN_MONTH_YEAR
                  ,NULL SO_CLOSE_TIME 
                  ,CASE  
                     WHEN msr.IE_TEMPO='COR' THEN 
                        TO_CHAR(mos.dt_ordem_servico + (msr.QT_MIN_INICIO/1440),'DD/MM/YYYY HH24:MI:SS') 
                     /*Tratamento de final de semana porque a funcao esta com problema*/
  
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 1 THEN 
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 1,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 7 THEN 
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 2,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                     /*Tratamento de final de semana porque a funcao esta com problema*/
  
                     ELSE  
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento, mos.dt_ordem_servico, msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                   END 
                   RESPONSE_FINISH_IN                 
                  ,TO_CHAR(trunc(LOCALTIMESTAMP) - trunc(mos.dt_ordem_servico),'9999') AGING --:PARAM_DATE
                  ,(    SELECT TO_CHAR(mose.dt_atualizacao,'DD/MM/YYYY HH24:MI:SS') WORK_START 
                          FROM man_estagio_processo MEP1 
                               ,Man_ordem_serv_estagio MOSE 
                         WHERE mose.nr_seq_ordem      =  mos.NR_SEQUENCIA 
                           AND MEP1.IE_AGUARDA_CLIENTE='N' 
                           AND MEP1.nr_sequencia        = mose.nr_seq_estagio 
                           AND mose.NR_SEQUENCIA = (SELECT Min(mose.nr_sequencia) 
                                                      FROM Man_ordem_serv_estagio MOSE 
                                                     WHERE mose.nr_seq_ordem      =  mos.NR_SEQUENCIA 
                                                       AND mose.NM_USUARIO <> 'WebService')) WORK_START 
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_PHILIPS 
                       from MAN_ORDEM_SERV_TECNICO most 
                      where most.NR_SEQ_ORDEM_SERV= mos.NR_SEQUENCIA
                        and most.NM_USUARIO <> 'WebService') LAST_UPDATE_PHILIPS 
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_CUSTOMER 
                       from MAN_ORDEM_SERV_TECNICO most 
                      where most.NR_SEQ_ORDEM_SERV= mos.NR_SEQUENCIA
                        and most.NM_USUARIO = 'WebService') LAST_UPDATE_CUSTOMER 
                  ,(
 /*calculo tempo da OS*/
                 
                     select sum(man_obter_tempo_com(
                               ml.cd_estabelecimento
                               ,mose.dt_atualizacao
                               ,coalesce((select	min(a.dt_atualizacao)
                                       from	man_ordem_serv_estagio a
                                      where	a.nr_seq_ordem	= mos1.nr_sequencia
                                        and	a.dt_atualizacao > mose.dt_atualizacao),CASE WHEN trunc(LOCALTIMESTAMP)=trunc(LOCALTIMESTAMP) THEN LOCALTIMESTAMP  ELSE to_date(trunc(LOCALTIMESTAMP) ||' 23:59:59','dd/mm/yyyy hh24:mi:ss' ) END )
                               ,'MC'))QT_MINUTOS_SLA
                       from MAN_SLA ms 
                            ,MAN_SLA_REGRA msr 
                            ,MAN_SLA_LOC msl 
                            ,MAN_LOCALIZACAO ml 
                            ,man_ordem_servico mos1  
                            ,man_ordem_serv_estagio mose
                            ,man_estagio_processo mep 
                      where ms.IE_SITUACAO='A' 
                        and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA 
                        and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA 
                        and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL 
                        and msr.IE_PRIORIDADE = mos1.IE_PRIORIDADE_CLIENTE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
 
					    and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/

                        and mos1.nr_seq_localizacao = ml.nr_sequencia
                        and mos1.nr_sequencia = mose.NR_SEQ_ORDEM
                        and	mose.nr_seq_estagio = mep.nr_sequencia  
                        and mos1.nr_sequencia = mos.NR_SEQUENCIA
                        and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)-- 2	Cliente (Teste); 261	Desenv aguardando cliente; 1341	Aguardando Inf. do Cliente - Suporte; 1511	Cliente (Teste) - OK; 1902	Tec aguardando definicao cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado; 121- Aguardando Conexao; 41 Aguardando Informacoes do Cliente
                   )
                   SO_RESOLUTION_TIME 
                  ,coalesce((SELECT SUM(MAN_OBTER_MIN_COM(1,MOSE1.DT_ATUALIZACAO 
                                                  ,(select coalesce(min(a.dt_atualizacao),trunc(LOCALTIMESTAMP))   --:PARAM_DATE
                                                      from man_ordem_serv_estagio a 
                                                     where a.nr_seq_ordem	= MOSE1.NR_SEQ_ORDEM 
                                                       and a.dt_atualizacao > MOSE1.dt_atualizacao) 
                                                 )) CUSTOMER_TIME 
                      FROM man_estagio_processo MEP2 
                           ,Man_ordem_serv_estagio MOSE1 
                     WHERE MOSE1.nr_seq_ordem = mos.NR_SEQUENCIA 
                       AND ( MEP2.IE_AGUARDA_CLIENTE='S'  
                            OR MEP2.NR_SEQUENCIA IN (1664, 261, 1591)) /*Estagios aguardando cliente no desenvolvimento (nao considerado no calculo de sla)*/
 
                       AND MEP2.nr_sequencia = MOSE1.nr_seq_estagio),0) CUSTOMER_TIME 
                  ,ml.cd_estabelecimento
                  ,mep.ds_estagio ACTUAL_STAGE
             FROM man_sla_regra msr, man_sla_loc msl, man_sla ms, man_localizacao ml, man_estagio_processo mep, (select gw.* from gerencia_wheb gw) gwd, grupo_desenvolvimento gd, man_ordem_servico mos
LEFT OUTER JOIN grupo_suporte gs ON (mos.nr_seq_grupo_sup = gs.nr_sequencia)
LEFT OUTER JOIN (select gw.* from gerencia_wheb gw) gws ON (gs.nr_seq_gerencia_sup = gws.nr_sequencia)
WHERE ms.IE_SITUACAO='A' and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE  --FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA
  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
  and mos.nr_seq_grupo_des = gd.nr_sequencia and gd.nr_seq_gerencia = gwd.nr_sequencia   and mos.nr_seq_estagio = mep.nr_sequencia and mos.nr_seq_localizacao = ml.nr_sequencia and mos.ie_classificacao_cliente = 'E' -- so defeito aberto pelo cliente

              /*TRATAR AQUI A QUESTAO DE OS QUE NAO ESTAVA ENCERRADA NA DATA QUE ESTA SENDO FEITA A EXTRACAO*/

  and ( --Nao encerrados 
                    (mos.nr_seq_estagio <> 9  --9-OK - Cliente - Encerrado 
                     and mos.ie_status_ordem <> 3  --3-Encerrado
                     and	mos.DT_FIM_REAL is null)  --Fim nao informado
                    -- Encerrados posterior a data do parametro 

                    or
                     trunc(mos.DT_FIM_REAL) > trunc(LOCALTIMESTAMP)  --Fim maior que a data do relatorio
                    or
                    mos.DT_FIM_REAL is null
                  ) and trunc(mos.dt_ordem_servico) <= trunc(LOCALTIMESTAMP)  --:PARAM_DATE
 ) REL 
) REL1
WHERE (REL1.HAS_AUTOMATIC_CLOSE is null or REL1.HAS_AUTOMATIC_CLOSE <> 111) --nao houve fechamento automatico pela job, quando esta sem retorno do cliente  
) REL2
----------------------------------------


UNION ALL

/*OSs ENCERRADAS*/


select REL2."EXTRACT_DATE",REL2."CUSTOMER",REL2."SO_NUMBER",REL2."SO_DESCRIPTION",REL2."CUSTOMER_CLASSIFICATION",REL2."PHILIPS_CLASSIFICATION",REL2."CUSTOMER_SEVERITY",REL2."PHILIPS_SEVERITY",REL2."SO_SLA",REL2."DEVELOPMENT_GROUP",REL2."DEVELOP_MANAGEMENT",REL2."DEVELOP_MANAGER",REL2."SUPPORT_GROUP",REL2."SUPPORT_MANAGEMENT",REL2."SUPPORT_MANAGER",REL2."SLA_ID",REL2."SLA_DESCRIPTION",REL2."TARGET_RESPONSE",REL2."TARGET_RESOLUTION",REL2."SO_OPEN_TIME",REL2."SO_OPEN_MONTH_YEAR",REL2."SO_CLOSE_TIME",REL2."SO_CLOSE_MONTH_YEAR",REL2."RESPONSE_FINISH_IN",REL2."RESOLUTION_FINISH_IN",REL2."WORK_START",REL2."AGING",REL2."ACTUAL_STAGE",REL2."LAST_UPDATE_PHILIPS",REL2."DAYS_WITHOUT_UPDATE_PHILIPS",REL2."LAST_UPDATE_CUSTOMER",REL2."SO_RESPONSE_TIME",REL2."SO_RESOLUTION_TIME",REL2."CUSTOMER_TIME",REL2."SLA_RESOLUTION_REMAINING",REL2."PERC_SLA_RESOLUTION_REMAINING",REL2."SLA_RESOLUTION_BREACHED",REL2."SLA_RESOLUTION_BREACHED_IN",REL2."SLA_RESPONSE_REMAINING",REL2."PERC_SLA_RESPONSE_REMAINING",REL2."SLA_RESPONSE_BREACHED",REL2."SO_RECLASSIFICATION_TIME",REL2."SO_WORKED",REL2."STATUS_SLA_RESOLUTION",REL2."LOCALIZATION"
      ,CASE  
        WHEN REL2.SLA_RESPONSE_BREACHED = 'S' THEN 
          'Breached' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 0  and REL2.PERC_SLA_RESPONSE_REMAINING <= 25 THEN 
          'Critical' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 25 and REL2.PERC_SLA_RESPONSE_REMAINING <= 75 THEN 
          'Warning' 
        WHEN REL2.PERC_SLA_RESPONSE_REMAINING > 75 THEN 
          'Good'
        ELSE
          NULL
      END 
      STATUS_SLA_RESPONSE 
from (
SELECT to_char(LOCALTIMESTAMP,'dd/mm/yyyy hh24:mi:ss') EXTRACT_DATE
       ,REL1.*
       ,(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) SLA_RESPONSE_REMAINING 
       ,CASE  
          WHEN REL1.SO_RESPONSE_TIME < REL1.TARGET_RESPONSE THEN 
           100-round((REL1.SO_RESPONSE_TIME*100/REL1.TARGET_RESPONSE)::numeric,1) 
          ELSE  
           0 
        END 
        PERC_SLA_RESPONSE_REMAINING
       ,CASE  
          WHEN(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) > 0 THEN 
           'N' 
          ELSE  
           'S' 
        END SLA_RESPONSE_BREACHED         
       ,CASE 
           WHEN TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') > TO_DATE('17/07/2015', 'DD/MM/YYYY HH24:MI:SS') THEN 
            TO_CHAR((select MAX(most.DT_ATUALIZACAO) 
                                 from MAN_ORDEM_SERV_TECNICO most 
                                where most.NR_SEQ_TIPO = 148 -- 148=mudanca de historico
                                  and most.NR_SEQ_ORDEM_SERV = REL1.SO_NUMBER),'DD/MM/YYYY HH24:MI:SS') 
          WHEN REL1.SO_SLA = 'N' THEN
            '17/07/2015 08:00:00'
        END
        SO_RECLASSIFICATION_TIME
       ,CASE
          WHEN( select count(mosa.NR_SEQUENCIA)
                   from MAN_ORDEM_SERV_ATIV mosa
                  where mosa.NR_SEQ_ORDEM_SERV= REL1.SO_NUMBER
                    and mosa.NR_SEQ_FUNCAO in (select mtf.nr_SEQUENCIA from man_tipo_funcao mtf where mtf.NR_SEQ_GRUPO_TRAB = 1)
                    and trunc(mosa.DT_ATIVIDADE) = trunc(LOCALTIMESTAMP)) > 0 THEN --:PARAM_DATE
          'S'
        ELSE
          'N'
        END
        SO_WORKED 
        ,CASE  
          WHEN REL1.SLA_RESOLUTION_BREACHED = 'S' THEN 
            'Breached' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) <= 390 THEN 
            'Critical' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) between 390 and 1440 THEN 
            'Warning' 
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) > 1440 THEN 
            'Good'
          ELSE
            NULL
        END 
        STATUS_SLA_RESOLUTION 
       ,CASE  
          WHEN UPPER(REL1.ACTUAL_STAGE) IN (
              'CLIENTE (TESTE)'
              ,'AGUARDANDO INFORMACOES DO CLIENTE'
              ,'AGUARDANDO INF. DO CLIENTE - SUPORTE'
              ,'CLIENTE (TESTE) - OK'
              ,'TEC AGUARDANDO DEFINICAO CLIENTE'
              ,'DESENV AGUARDANDO CLIENTE'
              ,'AGUARDANDO CONEXAO') THEN 
           'CUSTOMER' 
          ELSE  
           'PHILIPS' 
        END LOCALIZATION
FROM (
        SELECT --REL.* 
               REL.CUSTOMER
               ,REL.SO_NUMBER
               ,REL.SO_DESCRIPTION
               ,REL.CUSTOMER_CLASSIFICATION
               ,REL.PHILIPS_CLASSIFICATION
               ,REL.CUSTOMER_SEVERITY
               ,REL.PHILIPS_SEVERITY
               ,REL.SO_SLA
               ,REL.DEVELOPMENT_GROUP
               ,REL.DEVELOP_MANAGEMENT 
               ,REL.DEVELOP_MANAGER
               ,REL.SUPPORT_GROUP
               ,REL.SUPPORT_MANAGEMENT
               ,REL.SUPPORT_MANAGER
               ,REL.SLA_ID
               ,REL.SLA_DESCRIPTION
               ,REL.TARGET_RESPONSE
               ,REL.TARGET_RESOLUTION
               ,REL.SO_OPEN_TIME
               ,REL.SO_OPEN_MONTH_YEAR
               ,to_char(REL.SO_CLOSE_TIME,'dd/mm/yyyy hh24:mi:ss') SO_CLOSE_TIME
               ,trunc(REL.SO_CLOSE_TIME,'month') SO_CLOSE_MONTH_YEAR
               ,REL.RESPONSE_FINISH_IN
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                        WHEN REL.IE_TEMPO='COR' THEN                          TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                       ELSE                           TO_CHAR(man_obter_hor_com(REL.cd_estabelecimento                                                        ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')                                                        ,REL.TARGET_RESOLUTION                                                ),'DD/MM/YYYY HH24:MI:SS')                     END END 
                RESOLUTION_FINISH_IN                 
               ,REL.WORK_START	
               ,REL.AGING
               ,CASE WHEN trunc(LOCALTIMESTAMP)                       =trunc(to_date(trunc(LOCALTIMESTAMP))) THEN REL.ACTUAL_STAGE                         ELSE (  select max(b.ds_estagio)                             from man_ordem_serv_estagio a, man_estagio_processo b                            where a.nr_seq_estagio = b.nr_sequencia                              and a.nr_seq_ordem	= REL.SO_NUMBER                              and a.dt_atualizacao = (select max(c.dt_atualizacao)                                                        from man_ordem_serv_estagio c                                                       where c.nr_seq_ordem	= a.nr_seq_ordem                                                         and trunc(c.dt_atualizacao) <= trunc(LOCALTIMESTAMP))) END 
                ACTUAL_STAGE
               ,REL.LAST_UPDATE_PHILIPS
               ,CASE 
                  WHEN trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')) < trunc(LOCALTIMESTAMP) THEN
                    round(trunc(LOCALTIMESTAMP) - trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss'))) 
                  ELSE
                    0
                END     
                DAYS_WITHOUT_UPDATE_PHILIPS --:PARAM_DATE
               ,REL.LAST_UPDATE_CUSTOMER
               ,coalesce(Man_Obter_Min_com(REL.cd_estabelecimento
                                 ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')
                                 ,TO_DATE(REL.WORK_START,'DD/MM/YYYY HH24:MI:SS') 
                                 ),0) SO_RESPONSE_TIME 
               ,REL.SO_RESOLUTION_TIME	
               ,REL.CUSTOMER_TIME	
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE (REL.TARGET_RESOLUTION-REL.SO_RESOLUTION_TIME) END  SLA_RESOLUTION_REMAINING 
               ,CASE  
                  WHEN(REL.TARGET_RESOLUTION > 0 and REL.SO_RESOLUTION_TIME < REL.TARGET_RESOLUTION) THEN 
                    100-round((REL.SO_RESOLUTION_TIME*100/REL.TARGET_RESOLUTION)::numeric,1) 
                  WHEN(REL.TARGET_RESOLUTION > 0 and REL.SO_RESOLUTION_TIME > REL.TARGET_RESOLUTION) THEN 
                    0
                  ELSE  
                    NULL 
                END 
                PERC_SLA_RESOLUTION_REMAINING 
               ,CASE  
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) > 0) THEN 
                    'N' 
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) <= 0) THEN 
                    'S' 
                  ELSE  
                    NULL
                END SLA_RESOLUTION_BREACHED 
                /*PODE OCORRER ERRO NO CAMPO ABAIXO DEVIDO A CADASTRO DE SLA DUPLICADO*/


               ,CASE WHEN  REL.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                            WHEN REL.IE_TEMPO='COR' THEN                             TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                           ELSE (   select to_char(man_obter_hor_com(ml.cd_estabelecimento                                                                       ,CASE                                                                           WHEN msr.QT_MIN_TERMINO > REL.SO_RESOLUTION_TIME  THEN                                                                             max(mose.DT_ATUALIZACAO)                                                                           ELSE                                                                             min(mose.DT_ATUALIZACAO)                                                                          END                                                                          ,CASE                                                                             WHEN msr.QT_MIN_TERMINO > REL.SO_RESOLUTION_TIME  THEN (msr.QT_MIN_TERMINO - REL.SO_RESOLUTION_TIME)                                                                            ELSE                                                                              msr.QT_MIN_TERMINO                                                                          END                                                                          )                                                  ,'DD/MM/YYYY HH24:MI:SS') SLA_RESOLUTION_BREACHED_IN                                     from MAN_SLA ms                                           ,MAN_SLA_REGRA msr                                           ,MAN_SLA_LOC msl                                           ,MAN_LOCALIZACAO ml                                           ,man_ordem_servico mos                                            ,man_ordem_serv_estagio mose                                          ,man_estagio_processo mep                                     where ms.IE_SITUACAO='A'                                       and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA                                       and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA                                       and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL                                       and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE --FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA 
									  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
                                      and mos.nr_seq_localizacao = ml.nr_sequencia                                      and mos.nr_sequencia = mose.NR_SEQ_ORDEM                                      and	mose.nr_seq_estagio = mep.nr_sequencia                                        and mos.nr_sequencia = REL.SO_NUMBER                                      and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)-- 2	Cliente (Teste); 261	Desenv aguardando cliente; 1341	Aguardando Inf. do Cliente - Suporte; 1511	Cliente (Teste) - OK; 1902	Tec aguardando definicao cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado;121 - Aguardando Conexao; 41 Aguardando Informacoes do Cliente
                                 group by msr.QT_MIN_TERMINO,ml.cd_estabelecimento                                 )                            END END  
                SLA_RESOLUTION_BREACHED_IN 
        FROM ( 
           select ml.DS_LOCALIZACAO "CUSTOMER"          
                  ,CASE 
                    WHEN mos.ie_classificacao_cliente ='E'  THEN 
                      'Defeito'
                    WHEN mos.ie_classificacao_cliente ='S'  THEN 
                      'Solicitacao'
                    WHEN mos.ie_classificacao_cliente ='D'  THEN 
                      'Duvida'
                  END
                  CUSTOMER_CLASSIFICATION
                  ,CASE 
                    WHEN mos.ie_classificacao ='E'  THEN 
                      'Defeito'
                    WHEN mos.ie_classificacao ='S'  THEN 
                      'Solicitacao'
                    WHEN mos.ie_classificacao ='D'  THEN 
                      'Duvida'
                  END
                  PHILIPS_CLASSIFICATION
                  ,mos.nr_sequencia SO_NUMBER 
                  ,mos.ds_dano_breve SO_DESCRIPTION 
                  ,mos.ie_prioridade PHILIPS_SEVERITY  
                  ,mos.ie_prioridade_cliente CUSTOMER_SEVERITY 
                  ,man_obter_se_os_sla(mos.NR_SEQUENCIA) SO_SLA 
                  ,gd.DS_GRUPO DEVELOPMENT_GROUP
                  ,gwd.DS_GERENCIA "DEVELOP_MANAGEMENT" 
                  ,obter_nome_pf_pj(gwd.cd_responsavel,null) "DEVELOP_MANAGER"
                  ,gs.DS_GRUPO SUPPORT_GROUP
                  ,gws.DS_GERENCIA "SUPPORT_MANAGEMENT" 
                  ,obter_nome_pf_pj(gws.cd_responsavel,null) "SUPPORT_MANAGER"
                  ,ms.NR_SEQUENCIA SLA_ID 
                  ,ms.DS_TITULO SLA_DESCRIPTION
                  ,msr.QT_MIN_INICIO TARGET_RESPONSE 
                  ,msr.QT_MIN_TERMINO TARGET_RESOLUTION 
                  ,msr.IE_TEMPO
                  ,TO_CHAR(mos.dt_ordem_servico, 'DD/MM/YYYY HH24:MI:SS') SO_OPEN_TIME 
                  ,trunc(mos.dt_ordem_servico, 'month') SO_OPEN_MONTH_YEAR
                  ,mos.SO_CLOSE_TIME   
                  ,CASE  
                     WHEN msr.IE_TEMPO='COR' THEN 
                        TO_CHAR(mos.dt_ordem_servico + (msr.QT_MIN_INICIO/1440),'DD/MM/YYYY HH24:MI:SS') 
                     /*Tratamento de final de semana porque a funcao esta com problema*/
  
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 1 THEN 
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 1,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 7 THEN 
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 2,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                     /*Tratamento de final de semana porque a funcao esta com problema*/
  
                     ELSE  
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento, mos.dt_ordem_servico, msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS') 
                   END 
                   RESPONSE_FINISH_IN                 
                  ,TO_CHAR(trunc(LOCALTIMESTAMP) - trunc(mos.dt_ordem_servico),'9999') aging --:PARAM_DATE
                  ,(    SELECT TO_CHAR(mose.dt_atualizacao,'DD/MM/YYYY HH24:MI:SS') WORK_START 
                          FROM man_estagio_processo MEP1 
                               ,Man_ordem_serv_estagio MOSE 
                         WHERE mose.nr_seq_ordem      =  mos.NR_SEQUENCIA 
                           AND MEP1.IE_AGUARDA_CLIENTE='N' 
                           AND MEP1.nr_sequencia        = mose.nr_seq_estagio 
                           AND mose.NR_SEQUENCIA = (SELECT Min(mose.nr_sequencia) 
                                                      FROM Man_ordem_serv_estagio MOSE 
                                                     WHERE mose.nr_seq_ordem      =  mos.NR_SEQUENCIA 
                                                       AND mose.NM_USUARIO <> 'WebService')) WORK_START 
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_PHILIPS 
                       from MAN_ORDEM_SERV_TECNICO most 
                      where most.NR_SEQ_ORDEM_SERV= mos.NR_SEQUENCIA
                        and most.NM_USUARIO <> 'WebService') LAST_UPDATE_PHILIPS 
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_CUSTOMER 
                       from MAN_ORDEM_SERV_TECNICO most 
                      where most.NR_SEQ_ORDEM_SERV= mos.NR_SEQUENCIA
                        and most.NM_USUARIO = 'WebService') LAST_UPDATE_CUSTOMER 
                  ,(
                     select sum(man_obter_tempo_com(
                               ml.cd_estabelecimento
                               ,mose.dt_atualizacao
                               ,coalesce((select	min(a.dt_atualizacao)
                                       from	man_ordem_serv_estagio a
                                      where	a.nr_seq_ordem	= mos1.nr_sequencia
                                        and	a.dt_atualizacao > mose.dt_atualizacao),CASE WHEN trunc(LOCALTIMESTAMP)=trunc(LOCALTIMESTAMP) THEN LOCALTIMESTAMP  ELSE to_date(trunc(LOCALTIMESTAMP) ||' 23:59:59','dd/mm/yyyy hh24:mi:ss' ) END )
                               ,'MC'))QT_MINUTOS_SLA
                       from MAN_SLA ms 
                            ,MAN_SLA_REGRA msr 
                            ,MAN_SLA_LOC msl 
                            ,MAN_LOCALIZACAO ml 
                            ,man_ordem_servico mos1  
                            ,man_ordem_serv_estagio mose
                            ,man_estagio_processo mep 
                      where ms.IE_SITUACAO='A' 
                          and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA 
                          and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA 
                          and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL 
                          and msr.IE_PRIORIDADE = mos1.IE_PRIORIDADE_CLIENTE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
 
						  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/

                          and mos1.nr_seq_localizacao = ml.nr_sequencia
                          and mos1.nr_sequencia = mose.NR_SEQ_ORDEM
                          and	mose.nr_seq_estagio = mep.nr_sequencia  
                          and mos1.nr_sequencia = mos.NR_SEQUENCIA
                          and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)-- 2	Cliente (Teste); 261	Desenv aguardando cliente; 1341	Aguardando Inf. do Cliente - Suporte; 1511	Cliente (Teste) - OK; 1902	Tec aguardando definicao cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado; 121-Aguardando conexao; 41 Aguardando informacoes do Cliente
                   )
                   SO_RESOLUTION_TIME 
                  ,coalesce((SELECT SUM(MAN_OBTER_MIN_COM(1,MOSE1.DT_ATUALIZACAO 
                                                  ,(select coalesce(min(a.dt_atualizacao),trunc(LOCALTIMESTAMP))   --:PARAM_DATE
                                                      from man_ordem_serv_estagio a 
                                                     where a.nr_seq_ordem	= MOSE1.NR_SEQ_ORDEM 
                                                       and a.dt_atualizacao > MOSE1.dt_atualizacao) 
                                                 )) CUSTOMER_TIME 
                      FROM man_estagio_processo MEP2 
                           ,Man_ordem_serv_estagio MOSE1 
                     WHERE MOSE1.nr_seq_ordem = mos.NR_SEQUENCIA 
                       AND ( MEP2.IE_AGUARDA_CLIENTE='S'  
                            OR MEP2.NR_SEQUENCIA IN (1664, 261, 1591)) /*Estagios aguardando cliente no desenvolvimento (nao considerado no calculo de sla)*/
 
                       AND MEP2.nr_sequencia = MOSE1.nr_seq_estagio),0) 
                   CUSTOMER_TIME 
                  ,ml.cd_estabelecimento  
                  ,mep.ds_estagio ACTUAL_STAGE
             FROM man_sla_regra msr, man_sla_loc msl, man_sla ms, man_localizacao ml, man_estagio_processo mep, (select gw.* from gerencia_wheb gw) gwd, grupo_desenvolvimento gd, ( select os.* from (
                      select mos1.* 
                            ,CASE WHEN(--OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO
                                  select trunc(max(most.DT_HISTORICO))                                    from MAN_ORDEM_SERV_TECNICO most                                    where most.NR_SEQ_ORDEM_SERV = mos1.nr_sequencia                                     and trunc(most.DT_HISTORICO) = trunc(LOCALTIMESTAMP)                                     and most.NR_SEQ_TIPO = 111                                )                               =trunc(LOCALTIMESTAMP) THEN (--OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO
                                  select max(most.DT_HISTORICO)                                    from MAN_ORDEM_SERV_TECNICO most                                    where most.NR_SEQ_ORDEM_SERV = mos1.nr_sequencia                                     and trunc(most.DT_HISTORICO) = trunc(LOCALTIMESTAMP)                                     and most.NR_SEQ_TIPO = 111                                )                                 ELSE (--OBTEM DATA SE ENCERRADA PELO CLIENTE
                                  select max(mose.DT_ATUALIZACAO)                                    from MAN_ORDEM_SERV_ESTAGIO mose                                   where mose.NR_SEQ_ORDEM = mos1.nr_sequencia                                     and trunc(mose.DT_ATUALIZACAO) = trunc(LOCALTIMESTAMP)                                     and mose.NR_SEQ_ESTAGIO=9                                ) END  SO_CLOSE_TIME
                      from man_ordem_servico mos1 )os  
                     where TRUNC(os.SO_CLOSE_TIME) = trunc(LOCALTIMESTAMP) --:PARAM_DATE
                       and os.ie_status_ordem = 3  --3-Encerrado
                   ) mos
LEFT OUTER JOIN grupo_suporte gs ON (mos.nr_seq_grupo_sup = gs.nr_sequencia)
LEFT OUTER JOIN (select gw.* from gerencia_wheb gw) gws ON (gs.nr_seq_gerencia_sup = gws.nr_sequencia)
WHERE ms.IE_SITUACAO='A' and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
  and msr.ie_classificacao = mos.ie_classificacao /*filtro classificacao da os = classificacao do cadastro de sla*/
  and mos.nr_seq_grupo_des = gd.nr_sequencia and gd.nr_seq_gerencia = gwd.nr_sequencia   and mos.nr_seq_estagio  = mep.nr_sequencia and mos.nr_seq_localizacao = ml.nr_sequencia -- Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito
  and mos.ie_classificacao = 'E' and mos.ie_classificacao_cliente = 'E' -- Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito
 ) REL
) REL1
) rel2;

