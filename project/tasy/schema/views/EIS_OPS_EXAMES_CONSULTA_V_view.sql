-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_exames_consulta_v (ie_tipo_despesa, dt_mes_competencia, cd_estabelecimento, nr_seq_prest_solic, nm_prestador_solic, nr_seq_prestador_exec, nm_prestador_exec, qt_consultas, qt_exames, ds_tipo_item, vl_item, qt_item) AS select	ie_tipo_despesa,
	dt_mes_competencia,
	cd_estabelecimento,
	nr_seq_prest_solic,
	substr(pls_obter_dados_prestador(nr_seq_prest_solic,'N'),1,255) nm_prestador_solic,
	nr_seq_prestador_exec,
	substr(pls_obter_dados_prestador(nr_seq_prestador_exec,'N'),1,255) nm_prestador_exec,
	qt_consultas,
	qt_exames,
	CASE WHEN qt_consultas=0 THEN obter_desc_expressao(289728)  ELSE obter_desc_expressao(879464) END  ds_tipo_item,
	CASE WHEN qt_consultas=0 THEN vl_exame  ELSE vl_consulta END  VL_ITEM,
	CASE WHEN qt_consultas=0 THEN qt_exames  ELSE qt_consultas END  QT_ITEM
FROM (
	select	ie_tipo_despesa,
		nr_seq_prest_solic,
		nr_seq_prestador_exec,
		dt_mes_competencia,
		cd_estabelecimento,
		vl_consulta,
		vl_exame,
		sum(qt_consultas) qt_consultas,
		sum(qt_exames) qt_exames
	from (
		select	substr(obter_desc_expressao(879464),1,15) ie_tipo_despesa,
			v.nr_seq_prest_solic,
			v.nr_seq_prestador_exec,
			v.dt_mes_competencia,
			v.cd_estabelecimento,
			0 vl_consulta,
			sum(v.vl_item) vl_exame,
			0 qt_consultas,
			count(*) qt_exames
		from	pls_conta_proc cp,
			eis_ops_custo_v v,
			ans_grupo_despesa h
		where	v.nr_seq_conta_proc = cp.nr_sequencia
		and	v.nr_seq_conta = cp.nr_seq_conta
		and	cp.nr_seq_grupo_ans = h.nr_sequencia
		and	h.ie_tipo_grupo_ans = '10'
		group by v.dt_mes_competencia,
			 v.cd_estabelecimento,
			 v.nr_seq_prest_solic,
			 v.nr_seq_prestador_exec
		
union all

		select	substr(obter_desc_expressao(289728),1,15) ie_tipo_despesa,
			v.nr_seq_prest_solic,
			v.nr_seq_prestador_exec,
			v.dt_mes_competencia,
			v.cd_estabelecimento,
			sum(v.vl_item) vl_consulta,
			0 vl_exame,
			count(*) qt_consultas,
			0 qt_exames
		from	pls_conta_proc cp,
			eis_ops_custo_v v,
			ans_grupo_despesa h
		where	v.nr_seq_conta_proc = cp.nr_sequencia
		and	v.nr_seq_conta = cp.nr_seq_conta
		and	cp.nr_seq_grupo_ans = h.nr_sequencia
		and	h.ie_tipo_grupo_ans = '20'
		group by v.dt_mes_competencia,
			v.cd_estabelecimento,
			 v.nr_seq_prest_solic,
			 v.nr_seq_prestador_exec
		) alias16
	group by ie_tipo_despesa,
		 nr_seq_prest_solic,
		 nr_seq_prestador_exec,
		 dt_mes_competencia,
		 cd_estabelecimento,
		 vl_consulta,
		 vl_exame
	) alias17;

