-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_risco_manchester_v (dt_entrada, dt_entrada_unidade, cd_estabelecimento, ds_estabelecimento, cd_pessoa_fisica, ds_clinica, ie_clinica, nr_atendimento, ds_classificacao, ie_classificacao, qt_manchester, ds_sexo, ds_idade_ano, ds_idade_mes, ie_internado, ds_dia_semana, ds_mes_triagem, cd_medico_resp, nr_seq_manchester_fluxo, ds_manchester_fluxo, ds_medico_resp, cd_classificador, ds_classificador, cd_especialidade, ds_especialidade, ie_sexo, qt_min_fim_atend_inic_classif, qt_minuto_int_classif, qt_minuto_classif, qt_minuto_classif_atend, qt_minuto_classif_fim, qt_fim_classif_atend, qt_obs_fim, qt_minuto_atend_fim_triag, qt_obito, ds_funcao_classificador, qt_reclassificacao, qt_observacao, dt_inicio_triagem, ds_setor_atendimento, cd_setor_atendimento, ds_auditoria, ie_auditoria, qt_tempo_medico_desfecho, ds_hora, cd_hora) AS select	a.dt_entrada,
	b.dt_entrada_unidade,
	a.cd_estabelecimento,
	substr(obter_dados_estab(a.cd_estabelecimento,1),1,255) ds_estabelecimento,
	a.cd_pessoa_fisica,
	obter_valor_dominio(17,a.ie_clinica) ds_clinica,
	a.ie_clinica,
	a.nr_atendimento,
	substr(obter_valor_dominio(6673,substr(obter_classific_manchester(nr_seq_classif),1,10)),1,255) ds_classificacao,
	substr(obter_classific_manchester(nr_seq_classif),1,10) ie_classificacao,
	obter_classif_manchester(a.nr_atendimento, dt_entrada) qt_manchester,
	CASE WHEN ie_sexo='M' THEN 'Masculino'  ELSE 'Feminino' END  ds_sexo,
	substr(obter_idade(d.dt_nascimento,LOCALTIMESTAMP,'A'),1,10) ds_idade_ano,
	substr(obter_idade(d.dt_nascimento,LOCALTIMESTAMP,'M'),1,10) ds_idade_mes,
	CASE WHEN substr(Obter_Se_Atend_Internado(a.nr_atendimento),1,1)='S' THEN 'Sim'  ELSE 'NÃ£o' END  ie_internado,
	obter_dia_semana(dt_inicio_triagem) ds_dia_semana,
	Obter_desc_mes_data(dt_inicio_triagem,'D') ds_mes_triagem,
	a.cd_medico_resp,
	nr_seq_manchester_fluxo,
	substr(obter_fluxo_manchester(nr_seq_manchester_fluxo),1,255) DS_MANCHESTER_FLUXO,
	substr(obter_nome_pf(cd_medico_resp),1,255) ds_medico_resp,
	cd_classificador,
	--substr(obter_nome_pf(cd_classificador),1,255) ds_classificador,
	substr(obter_nome_pf(cd_classificador) || CASE WHEN obter_dados_pf(cd_classificador,'CPR') IS NULL THEN  obter_dados_pf(cd_classificador,'CPR')  ELSE ' (' || obter_dados_pf(cd_classificador,'CPR') || ')' END  ,1,255) ds_classificador,
	substr(obter_especialidade_pf(a.cd_medico_resp),1,15) cd_especialidade,
	substr(obter_desc_med_especialidade(substr(obter_especialidade_pf(a.cd_medico_resp),1,15)),1,255) ds_especialidade,
	ie_sexo,
	obter_min_entre_datas_null(b.dt_entrada_unidade,c.dt_inicio_triagem,1) qt_min_fim_atend_inic_classif,
	obter_min_entre_datas_null(a.dt_entrada,c.dt_inicio_triagem,1) qt_minuto_int_classif,
	obter_min_entre_datas_null(c.dt_inicio_triagem,c.dt_fim_triagem ,1) qt_minuto_classif,
	obter_min_entre_datas_null(c.dt_fim_triagem,a.dt_atend_medico ,1) qt_minuto_classif_atend,
	obter_min_entre_datas_null(a.dt_entrada,a.dt_fim_consulta ,1) qt_minuto_classif_fim,
	obter_min_entre_datas_null(a.dt_atend_medico,a.dt_fim_consulta ,1) qt_fim_classif_atend,
	obter_min_entre_datas_null(a.dt_inicio_observacao,a.dt_fim_consulta ,1) qt_obs_fim,
	obter_min_entre_datas_null(a.dt_entrada,c.dt_fim_triagem ,1) qt_minuto_atend_fim_triag,
	CASE WHEN obter_se_obito(a.cd_pessoa_fisica)='S' THEN 1  ELSE 0 END  qt_obito,
	substr(Obter_dados_usuario_opcao(obter_usuario_pf(c.cd_classificador),'DF'),1,100) ds_funcao_classificador,
	CASE WHEN ie_retriagem='S' THEN 1  ELSE 0 END  qt_reclassificacao, -- obter_qtdade_recla_marnchester(a.nr_atendimento)
	CASE WHEN a.dt_inicio_observacao IS NULL THEN 0  ELSE 1 END  qt_observacao,
	c.dt_inicio_triagem,
	substr(obter_nome_setor(s.cd_setor_atendimento),1,200) ds_setor_atendimento,
	s.cd_setor_atendimento,
	CASE WHEN c.ie_auditoria='C' THEN 'Correta' WHEN c.ie_auditoria='I' THEN 'Incorreta' END  ds_auditoria,
	c.ie_auditoria,
	obter_min_entre_datas_null(a.dt_atend_medico, to_date(obter_dados_desfecho_pa(a.nr_atendimento,'UP'),'dd/mm/yyyy hh24:mi:ss'),1) qt_tempo_medico_desfecho,
	to_char(a.dt_entrada,'hh24')||':00' ds_hora,
	(to_char(a.dt_entrada,'hh24'))::numeric  cd_hora
FROM setor_atendimento s, pessoa_fisica d, atendimento_paciente a, atend_paciente_unidade b
LEFT OUTER JOIN triagem_pronto_atend c ON (b.nr_atendimento = c.nr_atendimento)
WHERE a.cd_pessoa_fisica 		= d.cd_pessoa_fisica  and a.nr_atendimento 		= b.nr_atendimento and b.cd_setor_atendimento 		= s.cd_setor_atendimento --and	dt_atend_original is null
  and b.dt_entrada_unidade 		=(select min(w.dt_entrada_unidade)
					from   	setor_atendimento x,
						atend_paciente_unidade w
					where	w.nr_atendimento = a.nr_atendimento
					and	w.cd_setor_atendimento = x.cd_setor_atendimento
					and 	x.cd_classif_setor = 1) /*and c.dt_inicio_triagem = (select min(t.dt_inicio_triagem)
						   from triagem_pronto_atend t
						   where t.nr_atendimento = a.nr_atendimento)
and	b.cd_setor_atendimento = 79337*/
  and s.cd_classif_setor	= 1;

