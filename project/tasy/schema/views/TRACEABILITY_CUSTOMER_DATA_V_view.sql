-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW traceability_customer_data_v (ie_production, ds_environment, cd_cgc, cd_estabelecimento, ds_razao_social, ds_locale, nm_pais, nm_estado, nm_municipio, ds_endereco, nr_telefone) AS with last_customer_environment as (
		select	tce.nm_database,
			tce.ds_server_host,
			tce.ie_production,
			tce.ds_environment,
			tce.dt_atualizacao
		FROM (select	b.nm_database,
						b.ds_server_host,
						b.ie_production,
						b.ds_environment,
						b.dt_atualizacao
				 from	tasy_customer_environment b
				 where	b.nm_database = current_database() 
				 and	b.ds_server_host = inet_server_addr()::text
				 order by b.dt_atualizacao desc) tce LIMIT 1)
	select	lce.ie_production,
			lce.ds_environment,
			e.cd_cgc,
			e.cd_estabelecimento,
			pj.ds_razao_social,
			coalesce(el.ds_locale, 'pt_BR') ds_locale,
			coalesce(p.nm_pais, trim((select substr(ds_valor_dominio, position('-' in ds_valor_dominio)+1, length(ds_valor_dominio)-1) from valor_dominio_v where cd_dominio = 8031 and vl_dominio = coalesce(el.ds_locale, 'pt_BR')))) nm_pais,	
			obter_valor_dominio(50, pj.sg_estado) nm_estado,
			coalesce((select a.ds_municipio from sus_municipio a where a.cd_municipio_ibge = pj.cd_municipio_ibge), pj.ds_municipio) nm_municipio,
			pj.ds_endereco,
			(pj.nr_ddi_telefone || ' ' || pj.nr_ddd_telefone || ' ' || pj.nr_telefone) nr_telefone
	FROM last_customer_environment lce, estabelecimento e
LEFT OUTER JOIN establishment_locale el ON (e.cd_estabelecimento = el.cd_estabelecimento)
, pessoa_juridica pj
LEFT OUTER JOIN pais p ON (pj.nr_seq_pais = p.nr_sequencia)
WHERE e.cd_cgc = pj.cd_cgc;

