-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW livro_apuracao_iss_v (dt_emissao, esp, cd_serie_nf, nr_nota_fiscal, ie_cancelada, vl_contabil, cd_contabil, cfps, ie_tributacao_cst, vl_base_calculo, vl_aliquota, vl_iss, dt_entrada_saida, nr_sequencia, ie_tipo_tributo, cd_estabelecimento, ie_situacao, cd_tributo, ie_soma_diminui) AS select	a.dt_emissao dt_emissao,
	'NFS' esp,
	a.cd_serie_nf cd_serie_nf,
	a.nr_nota_fiscal nr_nota_fiscal,
	CASE WHEN a.ie_situacao=9 THEN 'Sim' WHEN a.ie_situacao=2 THEN 'Sim'  ELSE 'Não' END  ie_cancelada,
	b.vl_total_item_nf vl_contabil,
	'' cd_contabil,
	a.cd_natureza_operacao cfps,
	s.cd_situacao ie_tributacao_cst,
	c.vl_base_calculo vl_base_calculo,
	c.tx_tributo vl_aliquota,
	c.vl_tributo vl_iss,
	a.dt_entrada_saida,
	a.nr_sequencia,
	e.ie_tipo_tributo,
	a.cd_estabelecimento,
	a.ie_situacao,
	e.cd_tributo,
	e.ie_soma_diminui
FROM tributo e, estabelecimento d, nota_fiscal_item_trib c, nota_fiscal a, nota_fiscal_item b
LEFT OUTER JOIN situacao_trib_prest_serv s ON (b.nr_seq_classif_trib = s.nr_sequencia)
WHERE a.nr_sequencia = b.nr_sequencia and a.cd_estabelecimento = d.cd_estabelecimento and a.nr_sequencia = c.nr_sequencia and c.nr_item_nf = b.nr_item_nf and b.nr_sequencia = c.nr_sequencia and e.ie_situacao = 'A' and c.cd_tributo = e.cd_tributo  and e.ie_tipo_tributo = 'ISS' and a.dt_atualizacao_estoque is not null

union all

select	a.dt_emissao dt_emissao,
	'NFS' esp,
	a.cd_serie_nf cd_serie_nf,
	a.nr_nota_fiscal nr_nota_fiscal,
	CASE WHEN a.ie_situacao=9 THEN 'Sim' WHEN a.ie_situacao=2 THEN 'Sim'  ELSE 'Não' END  ie_cancelada,
	c.vl_base_calculo vl_contabil,
	'' cd_contabil,
	a.cd_natureza_operacao cfps,
	null ie_tributacao_cst,
	c.vl_base_calculo vl_base_calculo,
	c.tx_tributo vl_aliquota,
	c.vl_tributo vl_iss,
	a.dt_entrada_saida,
	a.nr_sequencia,
	e.ie_tipo_tributo,
	a.cd_estabelecimento,
	a.ie_situacao,
	e.cd_tributo,
	e.ie_soma_diminui
from	nota_fiscal a,
	nota_fiscal_trib c,
	estabelecimento d,
	tributo e
where	a.cd_estabelecimento = d.cd_estabelecimento
and	a.nr_sequencia = c.nr_sequencia
and	c.cd_tributo = e.cd_tributo
and	e.ie_tipo_tributo = 'ISS'
and	a.dt_atualizacao_estoque is not null

union all

select	a.dt_emissao dt_emissao,
	'NFS' esp,
	a.cd_serie_nf cd_serie_nf,
	a.nr_nota_fiscal nr_nota_fiscal,
	CASE WHEN a.ie_situacao=9 THEN 'Sim' WHEN a.ie_situacao=2 THEN 'Sim'  ELSE 'Não' END  ie_cancelada,
	a.vl_mercadoria vl_contabil,
	'' cd_contabil,
	a.cd_natureza_operacao cfps,
	null ie_tributacao_cst,
	g.vl_base_calculo vl_base_calculo,
	g.tx_tributo vl_aliquota,
	g.vl_tributo vl_iss,
	a.dt_entrada_saida,
	a.nr_sequencia,
	e.ie_tipo_tributo,
	a.cd_estabelecimento,
	a.ie_situacao,
	e.cd_tributo,
	e.ie_soma_diminui
from	nota_fiscal a,
	estabelecimento d,
	tributo e,
	nota_fiscal_venc f,
	nota_fiscal_venc_trib g
where	a.nr_sequencia = f.nr_sequencia
and	g.nr_sequencia = f.nr_sequencia
and	g.dt_vencimento	= f.dt_vencimento
and	g.ie_origem = f.ie_origem
and	g.cd_tributo = e.cd_tributo
and	a.cd_estabelecimento = d.cd_estabelecimento
and	e.ie_tipo_tributo = 'ISS'
and	a.dt_atualizacao_estoque is not null
order by	dt_entrada_saida,
	nr_nota_fiscal;

