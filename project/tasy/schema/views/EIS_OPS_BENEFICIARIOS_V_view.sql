-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_beneficiarios_v (dt_mes_competencia, dt_mes_competencia_param, cd_estabelecimento, ie_tipo_segurado, nr_seq_segurado, nr_idade) AS select	pkg_date_formaters.to_varchar(b.dt_mes,'shortDate',wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_mes_competencia,
	b.dt_mes dt_mes_competencia_param,
	a.cd_estabelecimento,
	a.ie_tipo_segurado,
	nr_seq_segurado,
	nr_idade
FROM (
	select	pkg_date_utils.start_of(s.dt_contratacao,'MONTH') dt_contratacao,
		pkg_date_utils.start_of(s.dt_rescisao,'MONTH') dt_rescisao,
		s.cd_estabelecimento,
		s.ie_tipo_segurado,
		s.nr_sequencia nr_seq_segurado,
		trunc(pkg_date_utils.get_DiffDate(p.dt_nascimento, LOCALTIMESTAMP, 'YEAR')) nr_idade
	from	pls_segurado s,
		pessoa_fisica p
	where	s.cd_pessoa_fisica = p.cd_pessoa_fisica
	and	s.nr_seq_segurado_ant is null
	and	s.nr_seq_segurado_mig is null
	and	s.dt_liberacao is not null
	) a,
	mes_v b
where	a.dt_contratacao <= b.dt_mes
and	coalesce(a.dt_rescisao,b.dt_mes) >= b.dt_mes
order by b.dt_mes desc;

