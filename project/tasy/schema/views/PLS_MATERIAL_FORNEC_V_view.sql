-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_material_fornec_v (cd_material_ops, cd_estabelecimento, nr_sequencia, cd_material, ds_material, ds_anvisa, nm_fornecedor_mat, nr_seq_fornec, cd_fabricante) AS select	a.cd_material_ops cd_material_ops,
		a.cd_estabelecimento cd_estabelecimento,
		a.nr_sequencia nr_sequencia,
		a.nr_sequencia cd_material,
		a.ds_material ds_material,
		substr(pls_obter_cd_anvisa_material(a.nr_sequencia),1,15) ds_anvisa,
		substr(pls_obter_fornecedor_material(b.nr_seq_fornecedor),1,255) nm_fornecedor_mat,
		b.nr_seq_fornecedor nr_seq_fornec,
		(select	max(x.cd_fabricante) FROM material x where x.cd_material = a.cd_material) cd_fabricante
	FROM pls_material_fornec b
LEFT OUTER JOIN pls_material a ON (b.nr_seq_material = a.nr_sequencia)
WHERE (a.dt_exclusao is null or a.dt_exclusao > LOCALTIMESTAMP) and (a.dt_inclusao is null or trunc(a.dt_inclusao) <= trunc(LOCALTIMESTAMP)) and b.ie_visualizar_portal = 'S' and exists (select 1
			from   pls_material_fornec_preco x
			where  x.nr_seq_mat_fornec = b.nr_sequencia
			and    LOCALTIMESTAMP between x.dt_inicio_vigencia and coalesce(x.dt_fim_vigencia,LOCALTIMESTAMP))
	
union all

	select	a.cd_material_ops cd_material_ops,
		a.cd_estabelecimento cd_estabelecimento,
		a.nr_sequencia nr_sequencia,
		a.nr_sequencia cd_material,
		a.ds_material ds_material,
		substr(pls_obter_cd_anvisa_material(a.nr_sequencia),1,15) ds_anvisa,
		null nm_fornecedor_mat,
		null nr_seq_fornec,
		(select	max(x.cd_fabricante) from material x where x.cd_material = a.cd_material) cd_fabricante
	from	pls_material a
	where (a.dt_exclusao is null or a.dt_exclusao > LOCALTIMESTAMP)
	and (a.dt_inclusao is null or trunc(a.dt_inclusao) <= trunc(LOCALTIMESTAMP));

