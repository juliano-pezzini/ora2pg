-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW giss_serv_tomad_criciuma_v (tp_registro, ie_ibge, cd_cpf_cnpj, ds_razao_social, cd_serie_nf, nr_nota_fiscal, dt_emissao, ie_situacao, vl_total_nota, ie_municipio, cd_municipio, ie_simples_nacional, nr_sequencia, cd_operacao_nf, cd_natureza_operacao, cd_estabelecimento, cd_atividade_cnae, vl_servico, tx_tributo) AS select	0			tp_registro,
      	1			ie_ibge,
      	cd_cgc			cd_cpf_cnpj,
      	ds_razao_social,
      	''			cd_serie_nf,
      	'0'			nr_nota_fiscal,
      	to_date(null)		dt_emissao,
      	''			ie_situacao,
      	0			vl_total_nota,
      	'D' 			ie_municipio,
      	'0'			cd_municipio,
      	'N'			ie_simples_nacional,
      	0			nr_sequencia,
      	0			cd_operacao_nf,
      	0			cd_natureza_operacao,
      	cd_estabelecimento,
      	' ' 			cd_atividade_cnae,
      	0			vl_servico,
      	0			tx_tributo
FROM	estabelecimento_v
where	1=1

union

select	1			tp_registro,
    	1			ie_ibge,
    	cd_cgc			cd_cpf_cnpj,
    	ds_razao_social,
    	''			cd_serie_nf,
    	'0'			nr_nota_fiscal,
    	to_date(null)		dt_emissao,
    	''			ie_situacao,
    	0			vl_total_nota,
    	'D' 			ie_municipio,
    	'0'			cd_municipio,
    	'N'			ie_simples_nacional,
    	0			nr_sequencia,
    	0			cd_operacao_nf,
    	0			cd_natureza_operacao,
    	cd_estabelecimento,
    	' ' 			cd_atividade_cnae,
    	0			vl_servico,
    	0			tx_tributo
from	estabelecimento_v
where	1=1

union

select	2			tp_registro,
      	1			ie_ibge,
      	CASE WHEN n.cd_cgc IS NULL THEN  	substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)  ELSE n.cd_cgc END  cd_cpf_cnpj,
      	substr(obter_nome_pf_pj(n.cd_pessoa_fisica, n.cd_cgc),1,50) ds_razao_social,
      	n.cd_serie_nf,
      	n.nr_nota_fiscal,
      	n.dt_emissao,
      	min(CASE WHEN(select 3 from   nota_fiscal x              where  obter_dados_cnae(obter_dados_pf_pj(null,x.cd_cgc,'CNAE'),'CD') in ('3.05', '7.02', '7.04', '7.05', '7.09', '7.10', '7.12', '7.16', '7.17', '7.19', '11.02', '17.05', '17.10')              and      x.cd_cgc not in ('96824594006912','72115025000141','72256654000191')              and      x.nr_sequencia = n.nr_sequencia)=3 THEN 'R'  ELSE CASE WHEN n.ie_situacao=1 THEN 'N' WHEN n.ie_situacao=2 THEN 'N'  ELSE 'C' END  END ) ie_situacao,
      	sum(i.vl_total_item_nf) vl_total_nota,
      	'D' 			ie_municipio,
      	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15) ||
      				substr(calcula_digito('MODULO10',substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15)),1,1) cd_municipio,
      	'N'			ie_simples_nacional,
      	n.nr_sequencia nr_sequencia,
      	n.cd_operacao_nf,
      	n.cd_natureza_operacao,
      	n.cd_estabelecimento,
      	' ' 			cd_atividade_cnae,
      	0			vl_servico,
      	0			tx_tributo
FROM nota_fiscal n, nota_fiscal_item i
LEFT OUTER JOIN estrutura_material_v v ON (i.cd_material = v.cd_material)
WHERE substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'E' and i.nr_sequencia	= n.nr_sequencia and (((n.cd_estabelecimento in (1,26,27,28,42,43,60))  and (v.cd_grupo_material = 10)) or
	((n.cd_estabelecimento = 12) and (v.cd_subgrupo_material in (124,131,133)))) and n.ie_situacao = 1  and (n.cd_operacao_nf  in (3,1) or 1 = (	select	max(coalesce(1,0))
						from	nota_fiscal_item x,
							estrutura_material_v y
						where	x.cd_material = y.cd_material
						and	(((n.cd_estabelecimento in (1,26,27,28,42,43,60)) and (y.cd_grupo_material = 10)) or
							((n.cd_estabelecimento = 12) and (y.cd_subgrupo_material in (124,131,133))))
						and	x.nr_sequencia = n.nr_sequencia)) group by
	CASE WHEN n.cd_cgc IS NULL THEN  	substr(obter_dados_pf(n.cd_pessoa_fisica, 'CPF'),1,11)  ELSE n.cd_cgc END ,
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica, n.cd_cgc),1,50),
	n.cd_serie_nf,
	n.nr_nota_fiscal,
	n.dt_emissao,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15) ||
				substr(calcula_digito('MODULO10',substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15)),1,1),
	n.cd_operacao_nf,
	n.cd_natureza_operacao,
	n.cd_estabelecimento,
	n.nr_sequencia

union

select	3			tp_registro,
      	1			ie_ibge,
      	'0'			cd_cpf_cnpj,
      	' '			ds_razao_social,
      	n.cd_serie_nf,
      	n.nr_nota_fiscal,
      	n.dt_emissao,
      	min(CASE WHEN(select 3 from   nota_fiscal x               where  obter_dados_cnae(obter_dados_pf_pj(null,x.cd_cgc,'CNAE'),'CD') in ('3.05', '7.02', '7.04', '7.05', '7.09', '7.10', '7.12', '7.16', '7.17', '7.19', '11.02', '17.05', '17.10')              and      x.cd_cgc not in ('96824594006912','72115025000141','72256654000191')              and      x.nr_sequencia = n.nr_sequencia)=3 THEN 'R'  ELSE CASE WHEN n.ie_situacao=1 THEN 'N' WHEN n.ie_situacao=2 THEN 'N'  ELSE 'C' END  END ) ie_situacao,
      	sum(i.vl_total_item_nf) vl_total_nota,
      	'D' 			ie_municipio,
      	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15) ||
      				substr(calcula_digito('MODULO10',substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15)),1,1) cd_municipio,
      	'N'			ie_simples_nacional,
      	n.nr_sequencia,
      	n.cd_operacao_nf,
      	n.cd_natureza_operacao,
      	n.cd_estabelecimento,
      	coalesce(pls_obter_cd_cnae(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CNAE')),'0000000') cd_atividade_cnae,
      	sum(i.vl_total_item_nf)		vl_servico,
      	obter_valor_tipo_tributo_nota(n.nr_sequencia, 'X', 'ISS')	tx_tributo
FROM nota_fiscal n, nota_fiscal_item i
LEFT OUTER JOIN estrutura_material_v v ON (i.cd_material = v.cd_material)
WHERE substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'E' and i.nr_sequencia	= n.nr_sequencia and (((n.cd_estabelecimento in (1,26,27,28,42,43,60))  and (v.cd_grupo_material = 10)) or
	((n.cd_estabelecimento = 12) and (v.cd_subgrupo_material in (124,131,133)))) and n.ie_situacao = 1  and (n.cd_operacao_nf  in (3,1) or 1 = (	select	max(coalesce(1,0))
						from	nota_fiscal_item x,
							estrutura_material_v y
						where	x.cd_material = y.cd_material
						and	(((n.cd_estabelecimento in (1,26,27,28,42,43,60)) and (y.cd_grupo_material = 10)) or
							((n.cd_estabelecimento = 12) and (y.cd_subgrupo_material in (124,131,133))))
						and	x.nr_sequencia = n.nr_sequencia)) group by n.cd_serie_nf,
	n.nr_nota_fiscal,
	n.dt_emissao,
	substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15) ||
				substr(calcula_digito('MODULO10',substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM'),1,15)),1,1),
	n.cd_operacao_nf,
	n.cd_natureza_operacao,
	n.cd_estabelecimento,
	coalesce(pls_obter_cd_cnae(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CNAE')),'0000000'),
	n.nr_sequencia;

