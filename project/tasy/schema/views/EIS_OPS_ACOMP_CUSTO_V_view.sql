-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_acomp_custo_v (ie_tipo_periodo, ds_periodo, nr_seq_conta, dt_competencia, cd_estabelecimento, vl_cobrado) AS select	1 ie_tipo_periodo,
	substr(obter_desc_expressao(690887),1,30) ds_periodo, -- Mês atual
	c.nr_sequencia nr_seq_conta,
	LOCALTIMESTAMP dt_competencia,
	c.cd_estabelecimento,
	sum(c.vl_cobrado) vl_cobrado
FROM	pls_conta c,
	pls_protocolo_conta p
where	p.nr_sequencia = c.nr_seq_protocolo
and	p.dt_mes_competencia between pkg_date_utils.start_of(LOCALTIMESTAMP,'MONTH',0) and pkg_date_utils.end_of(LOCALTIMESTAMP,'MONTH',0)
group by p.dt_mes_competencia, c.cd_estabelecimento, c.nr_sequencia

union all

select	2 ie_tipo_periodo,
	substr(obter_desc_expressao(305038),1,30) ds_periodo, -- Mês anterior
	c.nr_sequencia nr_seq_conta,
	LOCALTIMESTAMP dt_competencia,
	c.cd_estabelecimento,
	sum(c.vl_cobrado) vl_cobrado
from	pls_conta c,
	pls_protocolo_conta p
where	p.nr_sequencia = c.nr_seq_protocolo
and	p.dt_mes_competencia between pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-1),'MONTH',0) and pkg_date_utils.end_of(pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-1),'MONTH',0),'MONTH',0)
group by p.dt_mes_competencia, c.cd_estabelecimento, c.nr_sequencia

union all

select	3 ie_tipo_periodo,
	substr(obter_desc_expressao(891934),1,30) ds_periodo, --Mês no ano anterior
	c.nr_sequencia nr_seq_conta,
	LOCALTIMESTAMP dt_competencia,
	c.cd_estabelecimento,
	sum(c.vl_cobrado) vl_cobrado
from	pls_conta c,
	pls_protocolo_conta p
where	p.nr_sequencia = c.nr_seq_protocolo
and	p.dt_mes_competencia between pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'MONTH',0) and pkg_date_utils.end_of(pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'MONTH',0),'MONTH',0)
group by p.dt_mes_competencia, c.cd_estabelecimento, c.nr_sequencia

union all

select	4 ie_tipo_periodo,
	substr(obter_desc_expressao(893132),1,30) ds_periodo, --Média 3 meses ano anterior
	null nr_seq_conta,
	LOCALTIMESTAMP dt_competencia,
	c.cd_estabelecimento,
	dividir(sum(c.vl_cobrado), 3) vl_cobrado
from	pls_conta c,
	pls_protocolo_conta p
where	p.nr_sequencia = c.nr_seq_protocolo
and	p.dt_mes_competencia between pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-13),'MONTH',0) and pkg_date_utils.end_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-11),'MONTH',0)
group by c.cd_estabelecimento;

