-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_grupo_contrato_v (ds_acao_contrato, qt_ativo, qt_inativo, qt_aberto, vl_ativo, vl_inativo, nr_seq_grupo, nr_seq_contrato, nr_seq_intercambio, ie_ordem) AS select	substr(obter_valor_dominio(2115,ie_acao_contrato),1,150) ds_acao_contrato,
	sum(qt_ativos) qt_ativo,
	sum(qt_inativos) qt_inativo,
	sum(qt_abertos) qt_aberto,
	sum(vl_segurado_ativo) vl_ativo,
	sum(vl_segurado_inativo) vl_inativo,
	nr_seq_grupo,
	nr_seq_contrato,
	nr_seq_intercambio,
	1 ie_ordem
FROM (	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	a.nr_sequencia	= c.nr_seq_contrato
	and	b.dt_liberacao is not null
	and	b.dt_rescisao is null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	a.nr_sequencia = c.nr_seq_contrato
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	a.nr_sequencia = c.nr_seq_contrato
	and	b.dt_liberacao is null
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),c.nr_seq_grupo,a.nr_sequencia
	
union all

	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	a.nr_sequencia	= c.nr_seq_intercambio
	and	b.dt_liberacao is not null
	and	b.dt_rescisao is null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	a.nr_sequencia = c.nr_seq_intercambio
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	a.nr_sequencia = c.nr_seq_intercambio
	and	b.dt_liberacao is null
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),c.nr_seq_grupo,a.nr_sequencia) alias25
group by	ie_acao_contrato,nr_seq_grupo,nr_seq_contrato,nr_seq_intercambio

UNION ALL

select	'' ie_acao_contrato,
	null qt_ativo,
	null qt_inativo,
	null qt_aberto,
	null vl_ativo,
	null vl_inativo,
	null nr_seq_grupo,
	null nr_seq_contrato,
	null nr_seq_intercambio,
	2 ie_ordem
from	tabela_sistema
UNION ALL

select	'Total' ie_acao_contrato,sum(qt_ativos) qt_ativo,
	sum(qt_inativos) qt_inativo,
	sum(qt_abertos) qt_aberto,
	sum(vl_segurado_ativo) vl_ativo,
	sum(vl_segurado_inativo) vl_inativo,
	nr_seq_grupo,
	nr_seq_contrato,
	null nr_seq_intercambio,
	3 ie_ordem
from (	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_rescisao is null
	and	b.dt_liberacao is not null
	and	a.nr_sequencia = c.nr_seq_contrato
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	a.nr_sequencia = c.nr_seq_contrato
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio
	from	pls_contrato a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_liberacao is null
	and	a.nr_sequencia = c.nr_seq_contrato
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),c.nr_seq_grupo,a.nr_sequencia
	
union all

	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	a.nr_sequencia = c.nr_seq_intercambio
	and	b.dt_rescisao is null
	and	b.dt_liberacao is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	a.nr_sequencia = c.nr_seq_intercambio
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,c.nr_seq_grupo,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		c.nr_seq_grupo,
		null nr_seq_contrato,
		a.nr_sequencia nr_seq_intercambio
	from	pls_intercambio a,
		pls_segurado b,
		pls_contrato_grupo c
	where	a.nr_sequencia	= b.nr_seq_intercambio
	and	b.dt_liberacao is null
	and	a.nr_sequencia = c.nr_seq_intercambio
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),c.nr_seq_grupo,a.nr_sequencia) alias49
group by nr_seq_grupo,nr_seq_contrato,nr_seq_intercambio LIMIT 1;

