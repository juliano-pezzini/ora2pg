-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sus_interface_quimio_v (ds_registro, tp_registro, cd_tipo_registro, nr_lote, nr_seq_laudo, cd_estabelecimento, cd_cnes, ds_razao_social, qt_laudos, dt_geracao, qt_laudo, nr_cpf, nm_paciente, cd_nacionalidade, cd_municipio_ibge, ds_endereco, nr_endereco, ds_bairro, cd_cep, ds_compl, nr_telefone_celular, nr_telefone_contato, dt_nascimento, ie_sexo, nm_mae, cd_naturalidade, cd_cor, nm_responsavel, nr_cartao_nac_sus, nr_cpf_medic_solic, dt_emissao, cd_procedimento_solic, cd_cid10, ie_linfonodos, ds_estadio, ds_abrev_tnm, ds_estadio_outro_sist, ds_grau_histo, ds_cid_morfologico, ds_diag_cito_hist, dt_diag_cito_hist, ds_local_metastase, ie_tratamento_ant, ds_pri_tratamento, ds_seg_tratamento, ds_ter_tratamento, dt_pri_tratamento, dt_seg_tratamento, dt_ter_tratamento, ie_continuidade_trat, ie_via_iv, ie_via_sc, ie_via_im, ie_via_vo, ie_via_it, ie_via_ives, ie_via_outros, ie_finalidade, ds_esquema, qt_meses_prev, qt_meses_autorizado, dt_inicio_trat, dt_fim_trat) AS select	'CABECALHO' ds_registro,
	1 tp_registro,
	'1' cd_tipo_registro,
	a.nr_sequencia nr_lote,
	0 nr_seq_laudo,
	b.cd_estabelecimento cd_estabelecimento,
	c.cd_cnes cd_cnes,
	substr(obter_nome_pf_pj('',b.cd_cgc),1,60) ds_razao_social,
	Count_Laudos_Lote(a.nr_sequencia) qt_laudos,
	LOCALTIMESTAMP dt_geracao,
	null qt_laudo,
	null nr_cpf,
	null nm_paciente,
	null cd_nacionalidade,
	null cd_municipio_ibge,
	null ds_endereco,
	null nr_endereco,
	null ds_bairro,
	null cd_cep,
	null ds_compl,
	null nr_telefone_celular,
	null nr_telefone_contato,
	null dt_nascimento,
	null ie_sexo,
	null nm_mae,
	null cd_naturalidade,
	null cd_cor,
	null nm_responsavel,
	null nr_cartao_nac_sus,
	null nr_cpf_medic_solic,
	null dt_emissao,
	null cd_procedimento_solic,
	null cd_cid10,
	null ie_linfonodos,
	null ds_estadio,
	null ds_abrev_tnm,
	null ds_estadio_outro_sist,
	null ds_grau_histo,
	null ds_cid_morfologico,
	null ds_diag_cito_hist,
	null dt_diag_cito_hist,
	null ds_local_metastase,
	null ie_tratamento_ant,
	null ds_pri_tratamento,	
	null ds_seg_tratamento,
	null ds_ter_tratamento,
	null dt_pri_tratamento,
	null dt_seg_tratamento,
	null dt_ter_tratamento,
	null ie_continuidade_trat,
	null ie_via_iv,
	null ie_via_sc,
	null ie_via_im,
	null ie_via_vo,
	null ie_via_it,
	null ie_via_ives,
	null ie_via_outros,
	null ie_finalidade,
	null ds_esquema,
	null qt_meses_prev,
	null qt_meses_autorizado,
	null dt_inicio_trat,
	null dt_fim_trat
FROM	sus_parametros	c,
	estabelecimento	b,
	sus_lote_autor	a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.cd_estabelecimento	= c.cd_estabelecimento

union

select	'PACIENTE' ds_registro,
	2 tp_registro,
	'2' cd_tipo_registro,
	a.nr_sequencia nr_lote,
	b.nr_seq_interno nr_seq_laudo,
	null cd_estabelecimento,
	null cd_cnes,
	'' ds_razao_social,
	null qt_laudos,
	null dt_geracao,
	0 nr_seq_laudo,
	d.nr_cpf nr_cpf,
	d.nm_pessoa_fisica nm_paciente,
	CASE WHEN d.cd_nacionalidade='10' THEN '10' WHEN d.cd_nacionalidade='20' THEN '20'  ELSE '50' END  cd_nacionalidade,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'CDM'),1,6) cd_municipio_ibge,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'EN'),1,60) ds_endereco,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'NR'),1,4) nr_endereco,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'B'),1,30) ds_bairro,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'CEP'),1,8) cd_cep,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'CO'),1,20) ds_compl,
/*	substr(lpad(decode(d.nr_telefone_celular,'','',somente_numero(d.nr_telefone_celular)),12,' '),1,12) nr_telefone_celular,
	substr(lpad(decode(obter_compl_pf(c.cd_pessoa_fisica, 1, 'T'),'','',somente_numero(obter_compl_pf(c.cd_pessoa_fisica, 1, 'T'))),12,' '),1,12) 
nr_telefone_contato,*/

	' ' nr_telefone_celular,
	' ' nr_telefone_contato,
	d.dt_nascimento,
	d.ie_sexo,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 5, 'N'),1,50) nm_mae,
	substr(CASE WHEN d.cd_nacionalidade=10 THEN obter_compl_pf(c.cd_pessoa_fisica, 1, 'CDM') END ,1,6) cd_naturalidade,
	coalesce(nr_seq_cor_pele,00) cd_cor,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 3, 'N'),1,20) nm_responsavel,
	d.nr_cartao_nac_sus nr_cartao_nac_sus,
	null nr_cpf_medic_solic,
	null dt_emissao,
	null cd_procedimento_solic,
	null cd_cid10,
	null ie_linfonodos,
	null ds_estadio,
	null ds_abrev_tnm,
	null ds_estadio_outro_sist,
	null ds_grau_histo,
	null ds_cid_morfologico,
	null ds_diag_cito_hist,
	null dt_diag_cito_hist,
	null ds_local_metastase,
	null ie_tratamento_ant,
	null ds_pri_tratamento,
	null ds_seg_tratamento,
	null ds_ter_tratamento,
	null dt_pri_tratamento,
	null dt_seg_tratamento,
	null dt_ter_tratamento,
	null ie_continuidade_trat,
	null ie_via_iv,
	null ie_via_sc,
	null ie_via_im,
	null ie_via_vo,
	null ie_via_it,
	null ie_via_ives,
	null ie_via_outros,
	null ie_finalidade,
	null ds_esquema,
	null qt_meses_prev,
	null qt_meses_autorizado,
	null dt_inicio_trat,
	null dt_fim_trat
from	pessoa_fisica		d,
	atendimento_paciente	c,
	sus_laudo_paciente	b,
	sus_lote_autor		a
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_atendimento	= c.nr_atendimento
and	c.cd_pessoa_fisica	= d.cd_pessoa_fisica

union

select	'QUIMIOTERAPIA'	ds_registro,
	3 tp_registro,
	'3' cd_tipo_registro,
	a.nr_sequencia nr_lote,
	b.nr_seq_interno nr_seq_laudo,
	null cd_estabelecimento,
	null cd_cnes,
	'' ds_razao_social,
	null qt_laudos,
	null dt_geracao,
	null qt_laudo,
	substr(obter_cpf_pessoa_fisica(c.cd_pessoa_fisica),1,11) nr_cpf,
	null nm_paciente,
	null cd_nacionalidade,
    	null cd_municipio_ibge,
	null ds_endereco,
	null nr_endereco,
	null ds_bairro,
	null cd_cep,
	null ds_compl,
	null nr_telefone_celular,
	null nr_telefone_contato,
	null dt_nascimento,
	null ie_sexo,
	null nm_mae,
	null cd_naturalidade,
	null cd_cor,
	null nm_responsavel,
	null nr_cartao_nac_sus,
	substr(obter_cpf_pessoa_fisica(b.cd_medico_requisitante),1,11) nr_cpf_medic_solic,
	b.dt_emissao dt_emissao,
	lpad(b.cd_procedimento_solic,10,0) cd_procedimento_solic,
	substr(b.cd_cid_principal,1,4) cd_cid10,
	CASE WHEN b.ie_lifonodos_reg_inval='S' THEN 'S' WHEN b.ie_lifonodos_reg_inval='N' THEN 'N'  ELSE 'A' END  ie_linfonodos,
	CASE WHEN obter_valor_dominio(2502,b.ds_estadio_uicc)='0' THEN 1 WHEN obter_valor_dominio(2502,b.ds_estadio_uicc)='I' THEN 2 WHEN obter_valor_dominio(2502,b.ds_estadio_uicc)='II' THEN 3 WHEN obter_valor_dominio(2502,b.ds_estadio_uicc)='III' THEN 4 WHEN obter_valor_dominio(2502,b.ds_estadio_uicc)='IV' THEN 5  ELSE 5 END  ds_estadio,
	substr(Obter_Dados_Loco_Regional(c.cd_pessoa_fisica, 1),1,5) ds_abrev_tnm,
	substr(b.ds_estadio_outro_sist,1,20) ds_estadio_outro_sist,
	substr(CASE WHEN cd_grau_histopat=8 THEN 'GX' WHEN cd_grau_histopat=9 THEN 'G2' WHEN cd_grau_histopat=10 THEN 'G3' WHEN cd_grau_histopat=11 THEN 'G1' WHEN cd_grau_histopat=12 THEN 'G4'  ELSE '' END ,1,20) ds_grau_histo,
	substr(b.cd_diag_cito_hist,1,6) ds_cid_morfologico,
	substr(obter_desc_morfologia(b.cd_diag_cito_hist, b.NR_SEQ_MORF_DESC_ADIC),1,60) ds_diag_cito_hist,
	b.dt_diag_cito_hist,
	substr(coalesce(b.ds_localizacao_metastase,' 0'),1,50) ds_local_metastase,
	b.ie_tratamento_ant,
	substr(replace(b.ds_tratamento_ant,chr(13)||chr(10),' '),1,60) ds_pri_tratamento,
	substr(replace(b.ds_tratamento_ant2,chr(13)||chr(10),' '),1,60) ds_seg_tratamento,
	substr(replace(b.ds_tratamento_ant3,chr(13)||chr(10),' '),1,60) ds_ter_tratamento,
	b.dt_pri_tratamento,
	b.dt_seg_tratamento,
	b.dt_ter_tratamento,
	b.ie_continuidade_trat,
	coalesce(b.ie_via_iv,'N') ie_via_iv,
	coalesce(b.ie_via_sc,'N') ie_via_sc,
	coalesce(b.ie_via_im,'N') ie_via_im,
	coalesce(b.ie_via_vo,'N') ie_via_vo,
	coalesce(b.ie_via_it,'N') ie_via_it,
	coalesce(b.ie_via_ives,'N') ie_via_ives,
	coalesce(b.ie_via_outros,'N') ie_via_outros,
	CASE WHEN b.ie_finalidade=1 THEN '07' WHEN b.ie_finalidade=2 THEN '08' WHEN b.ie_finalidade=3 THEN '09' WHEN b.ie_finalidade=4 THEN '10' WHEN b.ie_finalidade=8 THEN '04' WHEN b.ie_finalidade=5 THEN '11' END  ie_finalidade,
	elimina_caracteres_especiais(replace(b.ds_sigla_esquema,'/','')) ds_esquema,
	b.qt_meses_prev qt_meses_prev,
	substr(CASE WHEN b.ie_continuidade_trat='S' THEN qt_meses_autorizado  ELSE 0 END ,1,4) qt_meses_autorizado,
	b.dt_inicio_trat_solic dt_inicio_trat,
	add_months(dt_emissao, 2) dt_fim_trat
from	atendimento_paciente	c,
	sus_laudo_paciente	b,
	sus_lote_autor		a
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_atendimento	= c.nr_atendimento;

