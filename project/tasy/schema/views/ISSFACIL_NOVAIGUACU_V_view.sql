-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW issfacil_novaiguacu_v (cd_estabelecimento, tp_registro, cd_inscricao_municipal, cd_versao, dt_referencia, dt_emissao, cd_serie_nf, cd_modelo, cd_natureza_operacao, cd_tributacao, nr_nota_fiscal, vl_bruto, vl_servico, ie_tipo_recolhimento, tx_tributo, cd_siafi_tomador, cd_cnae, ds_motivo_retencao, cd_siafi_prestador, ie_situacao, ie_simples_nacional, nr_parcela, qt_parcela, ds_motivo_nao_retencao, cd_cnpj_prestador, nr_cpf_prestador, nm_prestador, nr_nota_fiscal_final, cd_cnpj_tomador, nr_cpf_tomador, nm_tomador, cd_servico, cd_siafi_municipio, cd_operacao_nf) AS select	a.cd_estabelecimento,
	1 					tp_registro, 
	a.CD_INSCRICAO_MUNICIPAL		cd_inscricao_municipal, 
	'100'	 				cd_versao, 
	LOCALTIMESTAMP					dt_referencia, 
	to_date(null)				dt_emissao, 
	'0'					cd_serie_nf, 
	'1' 					cd_modelo, 
	'B' 					cd_natureza_operacao, 
	' '					cd_tributacao, 
	'0'					nr_nota_fiscal, 
	lpad(campo_mascara(0,2), 15, 0)		vl_bruto, 
	lpad(campo_mascara(0,2), 15, 0)		vl_servico, 
	'A' 					ie_tipo_recolhimento, 
	lpad(campo_mascara(0,2), 5, 0)		tx_tributo, 
	''					cd_siafi_tomador, 
	''					cd_cnae, 
	''					ds_motivo_retencao, 
	''					cd_siafi_prestador, 
	''					ie_situacao, 
	''					ie_simples_nacional, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao, 
	'0'					cd_cnpj_prestador, 
	'0'					nr_cpf_prestador, 
	' '					nm_prestador, 
	'0'					nr_nota_fiscal_final, 
	'0'					cd_cnpj_tomador, 
	'0'					nr_cpf_tomador, 
	' '					nm_tomador, 
	' '					cd_servico, 
	'5869'					cd_siafi_municipio, 
	0					cd_operacao_nf 
FROM	estabelecimento_v a 

union
 
select	a.cd_estabelecimento			cd_estabelecimento, 
	2 					tp_registro, 
	'0'					cd_inscricao_municipal, 
	'100'	 				cd_versao, 
	LOCALTIMESTAMP					dt_referencia, 
	a.dt_emissao				dt_emissao, 
	a.cd_serie_nf				cd_serie_nf, 
	'1' 					cd_modelo, 
	'B' 					cd_natureza_operacao, 
	' '					cd_tributacao, 
	a.nr_nota_fiscal			nr_nota_fiscal, 
	lpad(campo_mascara(a.vl_total_nota,2), 15, 0)	vl_bruto, 
	lpad(campo_mascara(a.vl_mercadoria,2), 15, 0) 	vl_servico, 
	'A' 					ie_tipo_recolhimento, 
	lpad(campo_mascara(0,2), 5, 0)		tx_tributo, 
	lpad(obter_siafi_municipio_ibge( 
			CASE WHEN  				obter_municipio_ibge(elimina_caracteres_especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CEP')))='0' THEN  				obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CDM')  ELSE obter_municipio_ibge(elimina_caracteres_especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CEP'))) END 	 
	), 8, '0')				cd_siafi_tomador, 
	substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CNAE'),1, 255) cd_cnae, 
	CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='1' THEN  'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='3' THEN  'E' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='4' THEN  'D'  ELSE 'E' END  ds_motivo_retencao, 
	'5869'					cd_siafi_prestador, 
	ie_situacao				ie_situacao, 
	nfse_obter_regra('OSN',a.cd_estabelecimento)	ie_simples_nacional, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao, 
	coalesce(a.cd_cgc_emitente, '00000000000000') 	cd_cnpj_prestador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') 	nr_cpf_prestador, 
	coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'N'),1,30), 'DIVERSOS') nm_prestador, 
	'0'					nr_nota_fiscal_final, 
	coalesce(a.cd_cgc, '00000000000000') 	cd_cnpj_tomador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') 	nr_cpf_tomador, 
	coalesce(substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,30), 'DIVERSOS') nm_tomador, 
	' '					cd_servico, 
	'5869'					cd_siafi_municipio, 
	a.cd_operacao_nf			cd_operacao_nf 
from	nota_fiscal a 
where	substr(Obter_Se_Nota_Entrada_Saida(a.nr_sequencia),1,1) = 'S' 

union
 
select	a.cd_estabelecimento			cd_estabelecimento, 
	4 					tp_registro, 
	'0'					cd_inscricao_municipal, 
	'100'	 				cd_versao, 
	LOCALTIMESTAMP				dt_referencia, 
	a.dt_emissao				dt_emissao, 
	a.cd_serie_nf				cd_serie_nf, 
	'1' 					cd_modelo, 
	'B' 					cd_natureza_operacao, 
	' '					cd_tributacao, 
	a.nr_nota_fiscal			nr_nota_fiscal, 
	lpad(campo_mascara(a.vl_total_nota,2), 15, 0)	vl_bruto, 
	lpad(campo_mascara(a.vl_mercadoria,2), 15, 0) 	vl_servico, 
	'M' 					ie_tipo_recolhimento, 
	lpad(campo_mascara(0,2), 5, 0)		tx_tributo, 
	''					cd_siafi_tomador, 
	substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CNAE'),1, 255) cd_cnae, 
	CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='1' THEN  'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='3' THEN  'E' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='4' THEN  'D'  ELSE 'E' END  ds_motivo_retencao, 
	lpad(obter_siafi_municipio_ibge( 
			CASE WHEN  				obter_municipio_ibge(elimina_caracteres_especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CEP')))='0' THEN  				obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDM')  ELSE obter_municipio_ibge(elimina_caracteres_especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CEP'))) END 	 
	), 8, '0')				cd_siafi_prestador, 
	ie_situacao				ie_situacao, 
	nfse_obter_regra('OSN',a.cd_estabelecimento)	ie_simples_nacional, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao, 
	coalesce(a.cd_cgc_emitente, '00000000000000') 	cd_cnpj_prestador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') 	nr_cpf_prestador, 
	coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'N'),1,30), 'DIVERSOS') nm_prestador, 
	'0'					nr_nota_fiscal_final, 
	coalesce(a.cd_cgc, '00000000000000') 	cd_cnpj_tomador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') 	nr_cpf_tomador, 
	coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'N'),1,30), 'DIVERSOS') nm_tomador, 
	' '					cd_servico, 
	'5869'					cd_siafi_municipio, 
	a.cd_operacao_nf			cd_operacao_nf 
from	nota_fiscal a 
where	substr(Obter_Se_Nota_Entrada_Saida(a.nr_sequencia),1,1) = 'E';

