-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_interf_exp_flp_v (tp_registro, ds_registro, nr_cad_munic_contrib, cd_cgc_contrib, cd_serie_talonario, cd_cnpj, nr_cnae, nr_nf_talonario, nr_nf_final_talao, nr_nf_inicial_talao, nr_cad_munic_tomador, nr_aidf, nr_nf_inicial, nr_nf_final, ds_razao_social, nm_fantasia, nr_inscricao_estadual, nr_reg_junta_comercial, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_estado, cd_cep, cd_ddd, nr_telefone, nr_fax, ds_email, cd_cnpj_grafica, ds_razao_social_grafica, nm_fantasia_grafica, ds_endereco_grafica, nr_endereco_grafica, ds_complemento_grafica, ds_bairro_grafica, cd_cep_grafica, ds_municipio_grafica, sg_uf_grafica, cd_ddd_grafica, nr_telefone_grafica, ie_grafica, ie_grafica_florianopolis, cd_cnpj_grafica_talao, dt_emissao, nr_nota_fiscal, ie_tomador_municipio, cd_cgc_emitente, ie_situacao, vl_contabil, vl_base_calculo, ds_observacao, cd_cfps, cd_situacao_tributaria, vl_aliquota_iss, vl_iss, cd_estabelecimento) AS select	1						tp_registro,
	'H'						ds_registro, 
	'3.00.0001'					nr_cad_munic_contrib, 
	' '						cd_cgc_contrib, 
	' '						cd_serie_talonario, 
	' '						cd_cnpj, 
	' ' 						nr_cnae, 
	' '						nr_nf_talonario, 
	' '						nr_nf_final_talao, 
	' '						nr_nf_inicial_talao, 
	' '						nr_cad_munic_tomador, 
	' '						nr_aidf, 
	' '						nr_nf_inicial, 
	' '						nr_nf_final, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	to_date(null)					dt_emissao, 
	'0'						nr_nota_fiscal, 
	0						ie_tomador_municipio, 
	' '						cd_cgc_emitente, 
	' '						ie_situacao, 
	'0'						vl_contabil, 
	'0'						vl_base_calculo, 
	' '						ds_observacao, 
	' '						cd_cfps, 
	' '						cd_situacao_tributaria, 
	'0'						vl_aliquota_iss, 
	'0'						vl_iss, 
	cd_estabelecimento					cd_estabelecimento 
FROM	estabelecimento 

union
 
select	2						tp_registro, 
	'C'						ds_registro, 
	LPAD(obter_dados_pf_pj(null, a.cd_cgc,'IM'),7,0)nr_cad_munic_contrib, 
	' '						cd_cgc_contrib, 
	' '						cd_serie_talonario, 
	LPAD(a.cd_cgc,14,' ')				cd_cnpj, 
	' ' 						nr_cnae, 
	' '						nr_nf_talonario, 
	' '						nr_nf_final_talao, 
	' '						nr_nf_inicial_talao, 
	' '						nr_cad_munic_tomador, 
	' ' 						nr_aidf, 
	' '						nr_nf_inicial, 
	' '						nr_nf_final, 
	LPAD(a.ds_razao_social,80,' ')			ds_razao_social, 
	LPAD(a.nm_fantasia,50,' ')			nm_fantasia, 
	LPAD(a.nr_inscricao_estadual,20,' ')		nr_inscricao_estadual, 
	LPAD(b.nr_reg_junta_comercial,20,' ')		nr_reg_junta_comercial, 
	LPAD(a.ds_endereco,80,' ')			ds_endereco, 
	LPAD(a.nr_endereco,10,' ')			nr_endereco, 
	LPAD(a.ds_complemento,30,' ')			ds_complemento, 
	LPAD(a.ds_bairro,50,' ')			ds_bairro, 
	LPAD(a.ds_municipio,50,' ')			ds_municipio, 
	LPAD(a.sg_estado,2,' ')				sg_estado, 
	LPAD(a.cd_cep,8,' ')				cd_cep, 
	LPAD(a.NR_DDD_TELEFONE,2,' ')			cd_ddd, 
	LPAD(a.nr_telefone,8,' ')			nr_telefone, 
	LPAD(a.nr_fax,8, ' ')				nr_fax, 
	LPAD(a.ds_email,80,' ')				ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	to_date(null)					dt_emissao, 
	'0'						nr_nota_fiscal, 
	0						ie_tomador_municipio, 
	' '						cd_cgc_emitente, 
	' '						ie_situacao, 
	'0'						vl_contabil, 
	'0'						vl_base_calculo, 
	' '						ds_observacao, 
	' '						cd_cfps, 
	' '						cd_situacao_tributaria, 
	'0'						vl_aliquota_iss, 
	'0'						vl_iss, 
	b.cd_estabelecimento 
from	pessoa_juridica a, 
	estabelecimento b 
where	a.cd_cgc		= b.cd_cgc 

union
 
select	4						tp_registro, 
	'T'						ds_registro, 
	LPAD(obter_dados_pf_pj(null, a.cd_cgc_emitente,'IM'),7,0) nr_cad_munic_contrib, 
	LPAD(a.cd_cgc_emitente, 14, 0)			cd_cgc_contrib, 
	LPAD(' ',10,' ')				cd_serie_talonario, 
	'0'						cd_cnpj, 
	' ' 						nr_cnae, 
	' '						nr_nf_talonario, 
	' '						nr_nf_final_talao, 
	' '						nr_nf_inicial_talao, 
	' '						nr_cad_munic_tomador, 
	LPAD(0,40,0)					nr_aidf, 
	LPAD(0,15,0)					nr_nf_inicial, 
	LPAD(0,15,0)					nr_nf_final, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	LPAD(' ',14,' ')				cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	to_date(null)					dt_emissao, 
	'0'						nr_nota_fiscal, 
	0						ie_tomador_municipio, 
	' '						cd_cgc_emitente, 
	' '						ie_situacao, 
	'0'						vl_contabil, 
	'0'						vl_base_calculo, 
	' '						ds_observacao, 
	' '						cd_cfps, 
	' '						cd_situacao_tributaria, 
	'0'						vl_aliquota_iss, 
	'0'						vl_iss, 
	a.cd_estabelecimento 
from	nota_fiscal a 

union
 
select	5						tp_registro, 
	'E'						ds_registro, 
	Lpad(obter_dados_pf_pj(null, n.cd_cgc_emitente,'IM'),7,0)					nr_cad_munic_contrib, 
	LPAD(n.cd_cgc_emitente,14,0)									cd_cgc_contrib, 
	LPAD(' ',10,' ')										CD_SERIE_TALONARIO, 
	LPAD(n.cd_cgc,14,' ')										cd_cnpj, 
	LPAD(coalesce(obter_dados_cnae(obter_dados_pf_pj(null, n.cd_cgc_emitente,'CNAE'),'CD'),0),11,0)	nr_cnae, 
	LPAD(0,15,0)											nr_nf_talonario, 
	' '						nr_nf_final_talao, 
	' '						nr_nf_inicial_talao, 
	LPAD(coalesce(obter_dados_pf_pj(null, n.cd_cgc,'IM'),0),7,0)						nr_cad_munic_tomador, 
	' '						nr_aidf, 
	' '						nr_nf_inicial, 
	' '						nr_nf_final, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	n.dt_emissao					dt_emissao, 
	LPAD(n.nr_nota_fiscal,15,0)				nr_nota_fiscal, 
	CASE WHEN substr(elimina_acentuacao(upper(substr(obter_dados_pf_pj(null, n.cd_cgc,'CI'),1,13))),1,13)='FLORIANOPOLIS' THEN 1  ELSE 0 END  ie_tomador_municipio, 
	n.cd_cgc					cd_cgc_emitente, 
	CASE WHEN n.ie_situacao=1 THEN 'E' WHEN n.ie_situacao=9 THEN 'C' END 		ie_situacao, 
	LPAD(elimina_caractere_especial(to_Char(n.vl_total_nota)),18,0)	vl_contabil, 
	LPAD(elimina_caractere_especial(to_char(obter_valor_tributo_nota(n.nr_sequencia,'B'))),18,0)	vl_base_calculo, 
		lPAD(coalesce(SUBSTR(REPLACE(n.ds_observacao,chr(13),''),1,45),' '),45,' ')					ds_observacao, 
	LPAD(to_char(substr(obter_descricao_padrao('CLASSIF_FISCAL_PREST_SERV','CD_CLASSIFICACAO',n.nr_seq_classif_fiscal),1,100)),4,0) cd_cfps, 
	LPAD(to_char((select	max(substr(obter_descricao_padrao('SITUACAO_TRIB_PREST_SERV','CD_SITUACAO',c.nr_seq_sit_trib),1,2)) 
	from	nota_fiscal_item y, 
		nota_fiscal_item_trib c 
	where	c.nr_sequencia= n.nr_sequencia 
	and	n.nr_sequencia= y.nr_sequencia 
	and	y.nr_item_nf 	= c.nr_item_nf 
	and	y.nr_item_nf 	= (select min(z.nr_item_nf) from nota_fiscal_item z where z.nr_sequencia = n.nr_sequencia) 
	and	c.cd_tributo in (select x.cd_tributo from tributo x where x.ie_tipo_tributo = 'ISS'))),3,0) cd_situacao_tributaria, 
	LPAD(elimina_caractere_especial(to_char(obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS'))),18,0)  vl_aliquota_iss, 
	LPAD(elimina_caractere_especial(to_char(obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS'))),18,0)	vl_iss, 
	n.cd_estabelecimento 
from	nota_fiscal n 
where (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S') 
and	n.cd_cgc is not null 
and   n.cd_pessoa_fisica is null 

union
 
select	6						tp_registro, 
	'F'						ds_registro, 
	LPAD(coalesce(obter_dados_pf_pj(null, n.cd_cgc_emitente,'IM'),0),7,0)				nr_cad_munic_contrib, 
	LPAD(n.cd_cgc_emitente,14,0)									cd_cgc_contrib, 
	LPAD(' ',10,' ')										CD_SERIE_TALONARIO, 
	' '												cd_cnpj, 
	LPAD(coalesce(obter_dados_cnae(obter_dados_pf_pj(null, n.cd_cgc_emitente,'CNAE'),'CD'),0),11,0)	nr_cnae, 
	LPAD(0,15,0)											nr_nf_talonario, 
	' '						nr_nf_final, 
	' '						nr_nf_inicial, 
	' '						nr_cad_munic_tomador, 
	' '						nr_aidf, 
	' '						nr_nf_inicial_talao, 
	' '						nr_nf_final_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	n.dt_emissao					dt_emissao, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	0						ie_tomador_municipio, 
	' '						cd_cgc_emitente, 
	CASE WHEN n.ie_situacao=1 THEN 'E' WHEN n.ie_situacao=9 THEN 'C' WHEN n.ie_situacao=2 THEN 'C' WHEN n.ie_situacao=3 THEN 'C' END 		ie_situacao, 
	LPAD(elimina_caractere_especial(to_Char(n.vl_total_nota)),18,0)	vl_contabil, 
	LPAD(elimina_caractere_especial(to_char(obter_valor_tributo_nota(n.nr_sequencia,'B'))),18,0)		vl_base_calculo, 
	lPAD(coalesce(SUBSTR(REPLACE(n.ds_observacao,chr(13),''),1,45),' '),45,' ')					ds_observacao, 
	LPAD(to_char(substr(obter_descricao_padrao('CLASSIF_FISCAL_PREST_SERV','CD_CLASSIFICACAO',n.nr_seq_classif_fiscal),1,100)),4,0) cd_cfps, 
	LPAD(to_char((select	max(substr(obter_descricao_padrao('SITUACAO_TRIB_PREST_SERV','CD_SITUACAO',c.nr_seq_sit_trib),1,2)) 
	from	nota_fiscal_item y, 
		nota_fiscal_item_trib c 
	where	c.nr_sequencia= n.nr_sequencia 
	and	n.nr_sequencia= y.nr_sequencia 
	and	y.nr_item_nf 	= c.nr_item_nf 
	and	y.nr_item_nf 	= (select min(z.nr_item_nf) from nota_fiscal_item z where z.nr_sequencia = n.nr_sequencia) 
	and	c.cd_tributo in (select x.cd_tributo from tributo x where x.ie_tipo_tributo = 'ISS'))),3,0) cd_situacao_tributaria, 
	elimina_caractere_especial(to_char(obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS')))			vl_aliquota_iss, 
	elimina_caractere_especial(to_char(obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS')))			vl_iss, 
	n.cd_estabelecimento 
from	nota_fiscal n 
where (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S') 
and	n.cd_pessoa_fisica is not null 

union
                                           
select	99						tp_registro, 
	'L'						ds_registro, 
	' '						nr_cad_munic_contrib, 
	' '						cd_cgc_contrib, 
	' '						cd_serie_talonario, 
	' '						cd_cnpj, 
	' ' 						nr_cnae, 
	' '						nr_nf_talonario, 
	' '						nr_cad_munic_tomador, 
	' '						nr_aidf, 
	' '						nr_nf_final_talao, 
	' '						nr_nf_inicial_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_nf_inicial, 
	' '						nr_nf_final, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	to_date(null)					dt_emissao, 
	'0'						nr_nota_fiscal, 
	0						ie_tomador_municipio, 
	' '						cd_cgc_emitente, 
	' '						ie_situacao, 
	'0'						vl_contabil, 
	'0'						vl_base_calculo, 
	' '						ds_observacao, 
	' '						cd_cfps, 
	' '						cd_situacao_tributaria, 
	'0'						vl_aliquota_iss, 
	'0'						vl_iss, 
	cd_estabelecimento				cd_estabelecimento 
from	estabelecimento;

