-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW movto_medic_controlado_v (nr_movimento_estoque, dt_mesano_referencia, cd_material_estoque, ie_origem_documento, nr_seq_tab_orig, ds_material, ds_reduzida, ds_material_origem, ds_material_origem_reduzida, nr_documento, nr_sequencia_documento, nr_seq_item, cd_fornecedor, cd_unidade_medida_estoque, cd_estabelecimento, dt_movimento_estoque, cd_classificacao, cd_dcb, ds_dcb, cd_acao, ie_tipo_requisicao, cd_operacao_estoque, qt_transf, qt_entrada, qt_saida, qt_estoque, qt_estoque_acao, qt_movimento, ds_historico, cd_local_estoque, nr_prescricao, nr_atendimento) AS select	e.nr_movimento_estoque,
	e.dt_mesano_referencia, 
	e.cd_material_estoque, 
	e.ie_origem_documento, 
	e.nr_seq_tab_orig, 
	substr(obter_desc_material(e.cd_material_estoque),1,100) ds_material, 
	substr(obter_desc_redu_material(e.cd_material_estoque),1,100) ds_reduzida, 
	substr(obter_desc_material(coalesce(substr(obter_mat_nf_estoque(e.nr_seq_tab_orig,e.nr_sequencia_item_docto),1,100),e.cd_material)),1,100) ds_material_origem, 
	substr(obter_desc_redu_material(coalesce(substr(obter_mat_nf_estoque(e.nr_seq_tab_orig,e.nr_sequencia_item_docto),1,100),e.cd_material)),1,100) ds_material_origem_reduzida, 
	e.nr_documento, 
	e.nr_sequencia_documento, 
	e.nr_sequencia_item_docto nr_seq_item, 
	e.cd_fornecedor, 
	e.cd_unidade_medida_estoque, 
	e.cd_estabelecimento, 
	e.dt_movimento_estoque, 
	m.cd_classificacao, 
	c.cd_dcb, 
	c.ds_dcb, 
	e.cd_acao, 
	f.ie_tipo_requisicao, 
	f.cd_operacao_estoque, 
	sum(CASE WHEN f.ie_tipo_requisicao='2' THEN  			CASE WHEN f.ie_entrada_saida='E' THEN  e.qt_estoque * -1  ELSE e.qt_estoque END   ELSE 0 END ) qt_transf, 
	sum(CASE WHEN f.ie_tipo_requisicao='2' THEN  			0  ELSE CASE WHEN f.ie_entrada_saida='E' THEN  CASE WHEN e.cd_acao=1 THEN coalesce(e.qt_estoque,0)  ELSE coalesce(e.qt_estoque,0) * -1 END   ELSE 0 END  END ) qt_entrada, 
	sum(CASE WHEN f.ie_tipo_requisicao='2' THEN  			0  ELSE CASE WHEN f.ie_entrada_saida='S' THEN  CASE WHEN e.cd_acao=1 THEN coalesce(e.qt_estoque,0)  ELSE coalesce(e.qt_estoque,0) * -1 END   ELSE 0 END  END ) qt_saida, 
	sum(coalesce(e.qt_estoque,0)) qt_estoque, 
	sum(CASE WHEN e.cd_acao=1 THEN coalesce(e.qt_estoque,0)  ELSE coalesce(e.qt_estoque,0) * -1 END ) qt_estoque_acao, 
	sum(e.qt_movimento) qt_movimento, 
	substr(obter_hist_medic_controlado(e.nr_movimento_estoque, 'S','N','N'),1,250) ds_historico, 
	e.cd_local_estoque, 
	e.nr_prescricao, 
	e.nr_atendimento 
FROM	operacao_estoque f, 
	dcb_medic_controlado c, 
	medic_controlado m, 
	material d, 
	movimento_estoque e 
where	f.cd_operacao_estoque	= e.cd_operacao_estoque 
and	d.cd_material 		= e.cd_material_estoque 
and	e.cd_material_estoque	= m.cd_material 
and	m.nr_seq_dcb		= c.nr_sequencia 
and	m.ie_situacao		= 'A' 
group by	e.nr_movimento_estoque, 
		e.dt_mesano_referencia, 
		e.cd_material_estoque, 
		e.ie_origem_documento, 
		e.nr_seq_tab_orig, 
		substr(obter_desc_material(e.cd_material_estoque),1,100), 
		obter_desc_redu_material(e.cd_material_estoque), 
		substr(obter_desc_material(coalesce(substr(obter_mat_nf_estoque(e.nr_seq_tab_orig,e.nr_sequencia_item_docto),1,100),e.cd_material)),1,100), 
		substr(obter_desc_redu_material(coalesce(substr(obter_mat_nf_estoque(e.nr_seq_tab_orig,e.nr_sequencia_item_docto),1,100),e.cd_material)),1,100), 
		e.nr_documento, 
		e.nr_sequencia_documento, 
		e.nr_sequencia_item_docto, 
		e.cd_fornecedor, 
		e.cd_unidade_medida_estoque, 
		e.cd_estabelecimento, 
		e.dt_movimento_estoque, 
		m.cd_classificacao, 
		c.cd_dcb, 
		c.ds_dcb, 
		e.cd_acao, 
		e.nr_prescricao, 
		f.ie_entrada_saida, 
		f.ie_tipo_requisicao, 
		f.cd_operacao_estoque, 
		substr(obter_hist_medic_controlado(e.nr_movimento_estoque, 'S','N','N'),1,250), 
		e.cd_local_estoque, 
		e.nr_atendimento;

