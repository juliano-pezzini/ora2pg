-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_interf_mens_superc_koch_v (dt_mesano_referencia, nr_cpf_titular, ie_titularidade, nr_cpf_dependente, cd_usuario_plano, vl_mensalidade, vl_coparticipacao, nr_seq_titular, nm_usuario) AS select	DT_MESANO_REFERENCIA,
	nr_cpf_titular,
	ie_titularidade,
	nr_cpf_dependente,
	cd_usuario_plano,
	(Campo_Mascara_virgula(vl_mensalidade))::numeric  vl_mensalidade,
	substr(to_char(CASE WHEN vl_coparticipacao=0 THEN '0,00'  ELSE Campo_Mascara_virgula(vl_coparticipacao) END ),1,255) vl_coparticipacao,
	nr_seq_titular,
	nm_usuario
FROM  (	select	c.DT_MESANO_REFERENCIA,
		d.nr_cpf nr_cpf_titular,
		'T' ie_titularidade,
		d.nr_cpf nr_cpf_dependente,
		e.cd_usuario_plano,
		coalesce(c.vl_mensalidade,0) - coalesce(c.vl_coparticipacao,0) vl_mensalidade,
		coalesce(c.vl_coparticipacao,0) vl_coparticipacao,
		b.nr_sequencia nr_seq_titular,
		a.nm_usuario
	from	pessoa_fisica		d,
		w_pls_interface_mens	a,
		pls_segurado		b,
		pls_mensalidade_segurado c,
		pls_segurado_carteira	e
	where	b.cd_pessoa_fisica	= d.cd_pessoa_fisica
	and	e.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_mensalidade_seg = c.nr_sequencia
	and	b.nr_seq_titular is null
	
union all

	select	c.DT_MESANO_REFERENCIA,
		(	select	max(x.nr_cpf)
			from	pessoa_fisica		x,
				pls_segurado		y
			where	y.cd_pessoa_fisica	= x.cd_pessoa_fisica
			and	y.nr_sequencia		= b.nr_seq_titular) nr_cpf_titular,
		'D' ie_titularidade,
		d.nr_cpf nr_cpf_dependente,
		e.cd_usuario_plano,
		coalesce(c.vl_mensalidade,0) - coalesce(c.vl_coparticipacao,0) vl_mensalidade,
		coalesce(c.vl_coparticipacao,0) vl_coparticipacao,
		b.nr_seq_titular nr_seq_titular,
		a.nm_usuario
	from	pessoa_fisica		d,
		w_pls_interface_mens	a,
		pls_segurado		b,
		pls_mensalidade_segurado c,
		pls_segurado_carteira	e
	where	b.cd_pessoa_fisica	= d.cd_pessoa_fisica
	and	e.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_segurado	= b.nr_sequencia
	and	a.nr_seq_mensalidade_seg = c.nr_sequencia
	and	b.nr_seq_titular is not null
) alias13
order by nr_seq_titular, ie_titularidade desc;

