-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_mens_conta_banco_v (ie_reg, dt_mesano_referencia, ds_conta_banco, vl_item_individual, vl_item_coletivo, vl_item_cancelado, vl_item_estorno, vl_antec_estorno, vl_aberto, vl_pro_rata_dia, vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao, vl_antecipacao_individual, vl_antecipacao_coletivo, cd_estabelecimento) AS select	1 ie_reg,
	dt_mesano_referencia,
	ds_conta_banco,
	sum(vl_item_individual) vl_item_individual,
	sum(vl_item_coletivo) vl_item_coletivo,
	sum(vl_item_cancelado) vl_item_cancelado,
	sum(vl_item_estorno) vl_item_estorno,
	sum(vl_antec_estorno) vl_antec_estorno,
	sum(vl_aberto) vl_aberto,
	sum(vl_pro_rata_dia) vl_pro_rata_dia,
	sum(vl_pro_rata_individual) vl_pro_rata_individual,
	sum(vl_pro_rata_coletivo) vl_pro_rata_coletivo,
	sum(vl_antecipacao) vl_antecipacao,
	sum(vl_antecipacao_individual) vl_antecipacao_individual,
	sum(vl_antecipacao_coletivo) vl_antecipacao_coletivo,
	cd_estabelecimento
FROM (	select	b.dt_mesano_referencia dt_mesano_referencia,
		substr(obter_conta_banco(e.nr_seq_conta_banco),1,255) ds_conta_banco,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_pro_rata_dia  ELSE 0 END  END ) vl_item_estorno,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
		sum(a.vl_antecipacao) vl_antecipacao,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_segurado		c,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	exists (select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	e.nr_seq_conta_banco,
			b.dt_mesano_referencia,
			f.cd_estabelecimento
	
UNION ALL

	select	b.dt_mesano_referencia dt_mesano_referencia,
		substr(obter_conta_banco(e.nr_seq_conta_banco),1,255) ds_conta_banco,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,
		sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
		sum(a.vl_antecipacao) vl_antecipacao,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_segurado		c,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	not exists (	select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	e.nr_seq_conta_banco,
			b.dt_mesano_referencia,
			f.cd_estabelecimento) alias48
group by	dt_mesano_referencia,
		ds_conta_banco,
		cd_estabelecimento

UNION ALL

select	2 ie_reg,
	e.dt_referencia dt_mesano_referencia,
	substr(obter_conta_banco(e.nr_seq_conta_banco),1,100) ||'/ destacado' ds_conta_banco,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN a.ie_tipo_item='1' THEN a.vl_pro_rata_dia WHEN a.ie_tipo_item='12' THEN a.vl_pro_rata_dia  ELSE a.vl_item END  END ) vl_item_estorno,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN a.ie_tipo_item='1' THEN a.vl_antecipacao WHEN a.ie_tipo_item='12' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
	sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
	sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
	sum(a.vl_antecipacao) vl_antecipacao,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo,
	f.cd_estabelecimento
from	pls_mensalidade_seg_item a,
	pls_contrato_pagador	b,
	pls_contrato		c,
	pls_plano               d,
	pls_mensalidade         e,
	pls_lote_mensalidade    f
where	a.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	e.nr_seq_pagador	= b.nr_sequencia
and	b.nr_seq_contrato	= c.nr_sequencia
and	d.nr_sequencia		= (	select	max(nr_seq_plano)
					from	pls_contrato_plano x
					where	x.nr_seq_contrato = c.nr_sequencia
					and	x.ie_situacao		= 'A')
and	a.nr_seq_mensalidade_seg is null
and	a.ie_tipo_item  = '17'
group by	e.nr_seq_conta_banco,
		e.dt_referencia,
		f.cd_estabelecimento

UNION ALL

select	3 ie_reg,
	dt_mes_competencia dt_mesano_referencia,
	'' ds_conta_banco,
	0 vl_item_individual,
	0 vl_item_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,
	0 vl_antec_estorno,
	0 vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_pro_rata_individual,
	0 vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	cd_estabelecimento
from	pls_competencia

UNION ALL

select	4 ie_reg,
	dt_mesano_referencia,
	'Total' ds_conta_banco,
	sum(vl_item_individual) vl_item_individual,
	sum(vl_item_coletivo) vl_item_coletivo,
	sum(vl_item_cancelado) vl_item_cancelado,
	sum(vl_item_estorno) vl_item_estorno,
	sum(vl_antec_estorno) vl_antec_estorno,
	sum(vl_aberto) vl_aberto,
	sum(vl_pro_rata_dia) vl_pro_rata_dia,
	sum(vl_pro_rata_individual) vl_pro_rata_individual,
	sum(vl_pro_rata_coletivo) vl_pro_rata_coletivo,
	sum(vl_antecipacao) vl_antecipacao,
	sum(vl_antecipacao_individual) vl_antecipacao_individual,
	sum(vl_antecipacao_coletivo) vl_antecipacao_coletivo,
	cd_estabelecimento
from (	select	b.dt_mesano_referencia dt_mesano_referencia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_pro_rata_dia  ELSE 0 END  END ) vl_item_estorno,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
		sum(a.vl_antecipacao) vl_antecipacao,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_segurado		c,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	exists (select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	b.dt_mesano_referencia,
			f.cd_estabelecimento
	
UNION ALL

	select	b.dt_mesano_referencia dt_mesano_referencia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,
		sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
		sum(a.vl_antecipacao) vl_antecipacao,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_segurado		c,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	not exists (	select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	b.dt_mesano_referencia,
			f.cd_estabelecimento) alias112
group by	dt_mesano_referencia,
		cd_estabelecimento;

