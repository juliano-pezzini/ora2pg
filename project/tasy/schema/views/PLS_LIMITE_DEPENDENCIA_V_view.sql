-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_limite_dependencia_v (nr_seq_contrato, nr_contrato, nr_sequencia, dt_contratacao, dt_migracao, dt_liberacao, nr_seq_titular, nm_pessoa_fisica, dt_limite_depend, dt_nascimento, nr_seq_plano, ie_sexo, cd_estabelecimento, nr_seq_parentesco, nr_seq_tabela, nr_seq_vendedor_canal, nr_seq_pagador, nr_seq_solicitacao, cd_pessoa_fisica, cd_usuario_plano, ds_parentesco, nm_pagador) AS select	b.nr_seq_contrato,
	f.nr_contrato,
	b.nr_sequencia,
	b.dt_contratacao,
	b.dt_migracao,
	b.dt_liberacao,
	b.nr_seq_titular,
	obter_nome_pf(c.cd_pessoa_fisica) nm_pessoa_fisica,
	--pls_obter_dt_lim_depend_contr(b.nr_sequencia, b.cd_pessoa_fisica, b.nr_seq_contrato, b.nr_seq_parentesco, c.dt_nascimento, c.ie_sexo, c.ie_estado_civil) dt_limite_depend,

	pls_obter_dt_limite_depend(b.nr_sequencia) dt_limite_depend,
	c.dt_nascimento,
	b.nr_seq_plano,
	c.ie_sexo,
	f.cd_estabelecimento,
	b.nr_seq_parentesco,
	b.nr_seq_tabela,
	b.nr_seq_vendedor_canal,
	b.nr_seq_pagador,
	(	select	max(z.nr_sequencia)
		FROM	pls_solicitacao_comercial z
		where	z.nr_seq_segurado	= b.nr_sequencia) nr_seq_solicitacao,
	c.cd_pessoa_fisica,
	a.cd_usuario_plano,
	g.ds_parentesco,
	(	select 	obter_nome_pf(d.cd_pessoa_fisica)
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = d.cd_pessoa_fisica
		
union all

		select	y.ds_razao_social
		from	pessoa_juridica y
		where	y.cd_cgc	= d.cd_cgc) nm_pagador
from	pessoa_fisica		c,
	pls_segurado		b,
	pls_segurado_carteira	a,
	pls_contrato_pagador	d,
	pls_contrato		f,
	grau_parentesco		g
where	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
and	a.nr_seq_segurado	= b.nr_sequencia
and	b.nr_seq_contrato	= f.nr_sequencia
and	b.nr_seq_parentesco	= g.nr_sequencia
and	b.nr_seq_pagador	= d.nr_sequencia
and	b.nr_seq_titular is not null
and	b.dt_liberacao is not null
and	b.dt_rescisao is null
and	((b.ie_controla_dt_dependencia = 'S') or (b.ie_controla_dt_dependencia is null))
and	b.nr_seq_contrato is not null;

