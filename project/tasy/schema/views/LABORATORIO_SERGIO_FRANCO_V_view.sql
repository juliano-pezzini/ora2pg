-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW laboratorio_sergio_franco_v (tp_registro, cd_lab, dt_geracao, nr_seq_lote_externo, nr_laboratorio, nr_prescricao, dt_prescricao, nr_crm, nm_medico, ds_observacao, nm_paciente, ie_sexo, dt_nascimento, vl_peso, vl_altura, dt_mestruacao, cd_usuario_conv, dt_validade_conv, cd_exame, ie_urgencia, nr_guia_conv, dt_coleta, ds_material, qt_total_exame, qt_total_pedido) AS select	'01' tp_registro,
	Obter_Dados_Lote_Externo(a.nr_Seq_lote_externo,3) cd_lab, 
	LOCALTIMESTAMP dt_geracao, 
	a.nr_seq_lote_externo, 
	'' nr_laboratorio, 
	null nr_prescricao, 
	null dt_prescricao, 
	'' nr_crm, 
	'' nm_medico, 
	'' ds_observacao, 
	'' nm_paciente, 
	'' ie_sexo, 
	null dt_nascimento, 
	null vl_peso, 
	null vl_altura, 
	null dt_mestruacao, 
	null cd_usuario_conv, 
	null dt_validade_conv, 
	'' cd_exame, 
	'' ie_urgencia, 
	null nr_guia_conv, 
	null dt_coleta, 
	'' ds_material, 
	null qt_total_exame, 
	null qt_total_pedido 
FROM	prescr_procedimento a, 
	exame_laboratorio b 
where	a.nr_seq_exame = b.nr_seq_exame 

union
 
select	'02' tp_registro, 
	'' cd_lab, 
	null dt_geracao, 
	a.nr_seq_lote_externo, 
	'' nr_laboratorio, 
	a.nr_prescricao nr_prescricao, 
	d.dt_prescricao dt_prescricao, 
	obter_dados_medico(d.cd_medico,'CRM') nr_crm, 
	obter_nome_medico(d.cd_medico,'N') nm_medico, 
	a.ds_observacao, 
	obter_nome_pf(d.cd_pessoa_fisica) nm_paciente, 
	obter_sexo_pf(d.cd_pessoa_fisica,'C') ie_sexo, 
	to_date(obter_dados_pf(d.cd_pessoa_fisica,'DN')) dt_nascimento, 
	d.qt_peso vl_peso, 
	d.qt_altura_cm vl_altura, 
	d.dt_mestruacao, 
	e.cd_usuario_convenio cd_usuario_conv, 
	e.dt_validade_carteira dt_validade_conv, 
	'' cd_exame, 
	'' ie_urgencia, 
	null nr_guia_conv, 
	null dt_coleta, 
	'' ds_material, 
	null qt_total_exame, 
	null qt_total_pedido 
from	prescr_procedimento a, 
	exame_laboratorio b, 
	prescr_medica d, 
	atend_categoria_convenio e 
where	a.nr_seq_exame = b.nr_seq_exame 
and	a.nr_prescricao = d.nr_prescricao 
and	d.nr_atendimento = e.nr_atendimento 

union
 
select	'03' tp_registro, 
	'' cd_lab, 
	null dt_geracao, 
	a.nr_seq_lote_externo, 
	'' nr_laboratorio, 
	null nr_prescricao, 
	null dt_prescricao, 
	'' nr_crm, 
	'' nm_medico, 
	'' ds_observacao, 
	'' nm_paciente, 
	'' ie_sexo, 
	null dt_nascimento, 
	null vl_peso, 
	null vl_altura, 
	null dt_mestruacao, 
	null cd_usuario_conv, 
	null dt_validade_conv, 
	coalesce(b.cd_exame_integracao, b.cd_exame) cd_exame, 
	a.ie_urgencia ie_urgencia, 
	a.nr_prescricao nr_guia_conv, 
	a.dt_coleta dt_coleta, 
	obter_desc_material_exame_lab(a.cd_material_exame) ds_material, 
	null qt_total_exame, 
	null qt_total_pedido 
from	prescr_procedimento a, 
	exame_laboratorio b 
where	a.nr_seq_exame = b.nr_seq_exame 

union
 
select	'04' tp_registro, 
	'' cd_lab, 
	null dt_geracao, 
	a.nr_seq_lote_externo, 
	'' nr_laboratorio, 
	null nr_prescricao, 
	null dt_prescricao, 
	'' nr_crm, 
	'' nm_medico, 
	'' ds_observacao, 
	'' nm_paciente, 
	'' ie_sexo, 
	null dt_nascimento, 
	null vl_peso, 
	null vl_altura, 
	null dt_mestruacao, 
	null cd_usuario_conv, 
	null dt_validade_conv, 
	'' cd_exame, 
	'' ie_urgencia, 
	null nr_guia_conv, 
	null dt_coleta, 
	'' ds_material, 
	count(a.nr_seq_exame) qt_total_exame, 
	count(distinct a.nr_prescricao) qt_total_pedido 
from	prescr_procedimento a 
group by a.nr_seq_lote_externo;

