-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW les_dps_prefeitura_sp (tp_registro, ds_tipo_dps, nr_versao, nr_inscricao_municipal, nr_nota_fiscal, dt_emissao, cd_servico, ie_situacao, vl_servico, cd_estabelecimento, qt_linhas, nr_sequencia) AS select 	1                    tp_registro,
	'N'                   ds_tipo_dps, 
	'001'                  nr_versao, 
	lpad(a.cd_inscricao_municipal, '8', '0') nr_inscricao_municipal, 
	null              nr_nota_fiscal, 
	null                  dt_emissao, 
	''                   cd_servico, 
	''                   ie_situacao, 
	''               vl_servico, 
	a.cd_estabelecimento, 
	0 qt_linhas, 
	0 nr_sequencia 
FROM	estabelecimento a 

union
 
select	2                   tp_registro, 
	CASE WHEN o.ie_tipo_nf_eletronica='E' THEN  '01'  ELSE '02' END  ds_tipo_dps, 
	''                       nr_versao, 
	lpad(coalesce(CASE WHEN o.ie_tipo_nf_eletronica='E' THEN  obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM')  ELSE '0' END , '0'),'8','0')   nr_inscricao_municipal, 
	coalesce(n.nr_nfe_imp, n.nr_nota_fiscal)		nr_nota_fiscal, 
	n.dt_emissao              dt_emissao, 
	lpad(coalesce(substr(elimina_caractere_especial(obter_dados_grupo_servico_item(obter_item_serv_matproc_nf(n.nr_sequencia),'CD')),1,5), obter_dados_pf_pj_estab(n.cd_estabelecimento, null, n.cd_cgc_emitente, 'ATIV')),5,'0') cd_servico, 
	CASE WHEN n.ie_situacao=1 THEN  'I' WHEN n.ie_situacao=8 THEN  'I'  ELSE 'E' END  ie_situacao, 
	replace(campo_mascara(n.vl_mercadoria,2),'.', '')            vl_servico, 
	n.cd_estabelecimento, 
	0 qt_linhas, 
	n.nr_sequencia nr_sequencia 
from	operacao_nota o, 
	nota_fiscal n 
where  n.ie_situacao = 1 
and   o.cd_operacao_nf = n.cd_operacao_nf 
and   exists ( 
		select 1 
		from  w_nota_fiscal x 
		where  x.nr_seq_nota_fiscal = n.nr_sequencia) 

union
 
select	9            tp_registro, 
	''               ds_tipo_dps, 
	''               nr_versao, 
	''               nr_inscricao_municipal, 
	'0'               nr_nota_fiscal, 
	null              dt_emissao, 
	null              cd_servico, 
	''               ie_situacao, 
	replace(campo_mascara(sum(n.vl_mercadoria),2), '.', '')  vl_servico, 
	n.cd_estabelecimento, 
	count(*) qt_linhas, 
	0 nr_sequencia 
from	nota_fiscal n 
where	n.ie_situacao = 1 
and   exists ( 
		select 1 
		from  w_nota_fiscal x 
		where  x.nr_seq_nota_fiscal = n.nr_sequencia) 
group by n.cd_estabelecimento;

