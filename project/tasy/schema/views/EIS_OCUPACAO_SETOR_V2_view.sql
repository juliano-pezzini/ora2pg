-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_setor_v2 (ds_tipo_classif, cd_estabelecimento, dt_referencia, cd_setor_atendimento, ds_setor_atendimento, ie_periodo, cd_classif_setor, nr_leitos_ocupados, nr_leitos_livres, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, nr_dias_periodo, ie_ocup_hospitalar) AS SELECT 	'      ' || coalesce(ds_tipo_acomodacao, 'Livres') ds_tipo_classif,
		A.cd_estabelecimento,
		A.DT_REFERENCIA,
		A.CD_SETOR_ATENDIMENTO,
 		s.DS_SETOR_ATENDIMENTO,
		A.IE_PERIODO,
		s.CD_CLASSIF_SETOR,
        	SUM(CASE WHEN A.IE_SITUACAO='P' THEN NR_PACIENTES  ELSE 0 END ) NR_LEITOS_OCUPADOS,
		SUM(coalesce(QT_LEITO_LIVRE,0)) NR_LEITOS_Livres,
        	SUM(NR_ADMISSOES) NR_ADMISSOES,
        	SUM(NR_ALTAS) NR_ALTAS,
        	SUM(NR_OBITOS) NR_OBITOS,
        	SUM(NR_TRANSF_ENTRADA) NR_TRANSF_ENTRADA,
        	SUM(NR_TRANSF_SAIDA)  NR_TRANSF_SAIDA,
       	avg(CASE WHEN A.IE_PERIODO='M' THEN  (TO_CHAR(LAST_DAY(A.DT_REFERENCIA),'DD'))::numeric   ELSE 1 END ) NR_DIAS_PERIODO,
		coalesce(ie_ocup_hospitalar,'S') ie_ocup_Hospitalar
FROM setor_atendimento s, eis_ocupacao_hospitalar a
LEFT OUTER JOIN tipo_acomodacao d ON (A.CD_tipo_acomodacao = d.CD_tipo_acomodacao)
WHERE A.cd_setor_atendimento = s.cd_setor_atendimento GROUP BY 	'      ' || coalesce(ds_tipo_acomodacao, 'Livres'),
		A.cd_estabelecimento,
		A.DT_REFERENCIA,
		A.CD_SETOR_ATENDIMENTO,
       	s.DS_SETOR_ATENDIMENTO,
		A.IE_PERIODO,
		s.CD_CLASSIF_SETOR,
		coalesce(ie_ocup_hospitalar,'S');

