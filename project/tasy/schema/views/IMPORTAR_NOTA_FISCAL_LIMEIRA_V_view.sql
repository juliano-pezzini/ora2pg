-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW importar_nota_fiscal_limeira_v (tp_registro, versao, ccm, referencia, dt_emissao, local_prest_serv, vl_total_serv, cod_servico, aliquota_iss_outro_munic, vl_iss_retido, vl_irrf_retido, vl_pis_retido, vl_cofins_retido, vl_csll_retida, vl_inss_retido, cnpj_tomador, dt_venc_fatura, instrucao_pag, vl_deducao_base, cod_vencimento, cfop, referencia_nf, quantidade, unidade, descricao, vl_unitario, cnpj_cpf, ref_nf, nome_tomador, insc_municipal, insc_estadual_rg, endereco, municipio, uf, cep, email_tomador, end_cobranca, cd_estabelecimento) AS select 1	TP_REGISTRO,
		-- dados cabeçalho 
		'001' VERSAO, 
		Elimina_Caracteres_Especiais(substr(obter_dados_pf_pj(null,a.cd_cgc,'IM'),1,10))	CCM, 
		-- dados nota fiscal 
		''	REFERENCIA, 
		null DT_EMISSAO, 
		''	LOCAL_PREST_SERV, 
		0	VL_TOTAL_SERV, 
		'' COD_SERVICO, 
		0	ALIQUOTA_ISS_OUTRO_MUNIC, 
		0	VL_ISS_RETIDO, 
		''	VL_IRRF_RETIDO, 
		''	VL_PIS_RETIDO, 
		''	VL_COFINS_RETIDO, 
		''	VL_CSLL_RETIDA, 
		''	VL_INSS_RETIDO, 
		''	CNPJ_TOMADOR, 
		''	DT_VENC_FATURA, 
		''	INSTRUCAO_PAG, 
		0	VL_DEDUCAO_BASE, 
		0	COD_VENCIMENTO, 
		''	CFOP, 
		-- dados item de serviço de nota fiscal 
		''	REFERENCIA_NF, 
		''	QUANTIDADE, 
		''	UNIDADE, 
		''	DESCRICAO, 
		''	VL_UNITARIO, 
		-- dados tomador serviço 
		''	CNPJ_CPF, 
		''	REF_NF, 
		''	NOME_TOMADOR, 
		''	INSC_MUNICIPAL, 
		''	INSC_ESTADUAL_RG, 
		''	ENDERECO, 
		''	MUNICIPIO, 
		''	UF, 
		''	CEP, 
		''	EMAIL_TOMADOR, 
		''	END_COBRANCA, 
		a.cd_estabelecimento			CD_ESTABELECIMENTO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

union
 
--NOTA FISCAL 
select	2 		TP_REGISTRO, 
		-- dados cabeçalho 
		''	VERSAO, 
		''		CCM, 
		-- dados nota fiscal 
		n.nr_nota_fiscal	REFERENCIA, 
		n.dt_emissao 	DT_EMISSAO, 
		CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'), 1, 2)='IN' THEN  '5'  ELSE CASE WHEN obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc, 'CDM')='352690' THEN '1'  ELSE '2' END  END  LOCAL_PREST_SERV, 
		n.vl_total_nota	VL_TOTAL_SERV, 
		obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), obter_procedimento_nfse(n.nr_sequencia,'O')), 'GR')  COD_SERVICO, 
		obter_valor_tributo_nota(n.nr_sequencia,'X')	ALIQUOTA_ISS_OUTRO_MUNIC, 
		obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISSQN')	VL_ISS_RETIDO, 
		lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'IR', 'VL')), 15, 0)	VL_IRRF_RETIDO, 
		lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'PIS', 'VL')), 15, 0)	VL_PIS_RETIDO, 
		lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'COFINS', 'VL')), 15, 0)	VL_COFINS_RETIDO, 
		lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, '', 'VL')), 15, 0)	VL_CSLL_RETIDA, 
		lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'INSS', 'VL')), 15, 0)	VL_INSS_RETIDO, 
		case 
			when coalesce(n.cd_cgc,'X') = 'X' 
				 then coalesce(n.cd_pessoa_fisica,'SEM') 
			when coalesce(n.cd_pessoa_fisica,'X') = 'X' 
			  then CASE WHEN substr(obter_dados_pf_pj(null, n.cd_cgc , 'UF'), 1, 2)='IN' THEN 'EXT'  ELSE n.cd_cgc END  
		end CNPJ_TOMADOR, 
		' '	DT_VENC_FATURA, 
		' '	INSTRUCAO_PAG, 
		n.vl_descontos	VL_DEDUCAO_BASE, 
		n.cd_condicao_pagamento	COD_VENCIMENTO, 
		substr(elimina_caractere_especial(obter_dados_natureza_operacao(n.cd_natureza_operacao,'CF')),1,10)	CFOP, 
		-- dados item de serviço de nota fiscal 
		''	REFERENCIA_NF, 
		''	QUANTIDADE, 
		''	UNIDADE, 
		''	DESCRICAO, 
		''	VL_UNITARIO, 
		-- dados tomador serviço 
		''	CNPJ_CPF, 
		''	REF_NF, 
		''	NOME_TOMADOR, 
		''	INSC_MUNICIPAL, 
		''	INSC_ESTADUAL_RG, 
		''	ENDERECO, 
		''	MUNICIPIO, 
		''	UF, 
		''	CEP, 
		''	EMAIL_TOMADOR, 
		''	END_COBRANCA, 
	  n.cd_estabelecimento			CD_ESTABELECIMENTO		 
from	operacao_nota o, 
		nota_fiscal n 
where 	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
and	o.cd_operacao_nf = n.cd_operacao_nf 

union
 
--ITEM DE SERVIÇO DE NOTA FISCAL 
select	3		TP_REGISTRO, 
		-- dados cabeçalho 
		''	VERSAO, 
		''		CCM, 
		-- dados nota fiscal 
		''	REFERENCIA, 
		null DT_EMISSAO, 
		''	LOCAL_PREST_SERV, 
		0	VL_TOTAL_SERV, 
		'' COD_SERVICO, 
		0	ALIQUOTA_ISS_OUTRO_MUNIC, 
		0	VL_ISS_RETIDO, 
		''	VL_IRRF_RETIDO, 
		''	VL_PIS_RETIDO, 
		''	VL_COFINS_RETIDO, 
		''	VL_CSLL_RETIDA, 
		''	VL_INSS_RETIDO, 
		''	CNPJ_TOMADOR, 
		''	DT_VENC_FATURA, 
		''	INSTRUCAO_PAG, 
		0	VL_DEDUCAO_BASE, 
		0	COD_VENCIMENTO, 
		''	CFOP, 
		-- dados item de serviço de nota fiscal 
		n.nr_nota_fiscal	REFERENCIA_NF, 
		lpad((	select	count(b.cd_procedimento) 
				from  nota_fiscal_item b 
				where b.nr_sequencia = n.nr_sequencia),15,0)	QUANTIDADE, 
		(select	distinct coalesce(cd_unidade_medida_compra,'UM') 
				from  nota_fiscal_item b 
				where b.nr_sequencia = n.nr_sequencia)	UNIDADE, 
		coalesce(replace(replace(substr(obter_descricao_rps(n.cd_estabelecimento, n.nr_sequencia, 'DS_SERVICOS'), 1, 1000), 
				CHR(13), ' '), CHR(10), ' '), 	'Servicos') DESCRICAO, 
		lpad(elimina_caractere_especial(( select max(coalesce(vl_unitario_item_nf,0)) 
						from  nota_fiscal_item b 
						where b.nr_sequencia = n.nr_sequencia)), 16, 0) VL_UNITARIO, 
		-- dados tomador serviço 
		''	CNPJ_CPF, 
		''	REF_NF, 
		''	NOME_TOMADOR, 
		''	INSC_MUNICIPAL, 
		''	INSC_ESTADUAL_RG, 
		''	ENDERECO, 
		''	MUNICIPIO, 
		''	UF, 
		''	CEP, 
		''	EMAIL_TOMADOR, 
		''	END_COBRANCA, 
	  n.cd_estabelecimento			CD_ESTABELECIMENTO 
from	operacao_nota o, 
		nota_fiscal n 
where 	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
and	o.cd_operacao_nf = n.cd_operacao_nf 

union
 
--TOMADOR SERVICO 
select	4	TP_REGISTRO, 
		-- dados cabeçalho 
		''	VERSAO, 
		''		CCM, 
		-- dados nota fiscal 
		''	REFERENCIA, 
		null DT_EMISSAO, 
		''	LOCAL_PREST_SERV, 
		0	VL_TOTAL_SERV, 
		'' COD_SERVICO, 
		0	ALIQUOTA_ISS_OUTRO_MUNIC, 
		0	VL_ISS_RETIDO, 
		''	VL_IRRF_RETIDO, 
		''	VL_PIS_RETIDO, 
		''	VL_COFINS_RETIDO, 
		''	VL_CSLL_RETIDA, 
		''	VL_INSS_RETIDO, 
		''	CNPJ_TOMADOR, 
		''	DT_VENC_FATURA, 
		''	INSTRUCAO_PAG, 
		0	VL_DEDUCAO_BASE, 
		0	COD_VENCIMENTO, 
		''	CFOP, 
		-- dados item de serviço de nota fiscal 
		''	REFERENCIA_NF, 
		''	QUANTIDADE, 
		''	UNIDADE, 
		''	DESCRICAO, 
		''	VL_UNITARIO, 
		-- dados tomador serviço 
		case 
			when coalesce(n.cd_cgc,'X') = 'X' 
				 then coalesce(n.cd_pessoa_fisica,'SEM') 
			when coalesce(n.cd_pessoa_fisica,'X') = 'X' 
			  then CASE WHEN substr(obter_dados_pf_pj(null, n.cd_cgc , 'UF'), 1, 2)='IN' THEN 'EXT'  ELSE n.cd_cgc END  
		end CNPJ_CPF, 
		n.cd_serie_referencia	REF_NF, 
		CASE WHEN n.cd_pessoa_fisica IS NULL THEN obter_dados_pf_pj(null, n.cd_cgc, 'N')  ELSE obter_nome_pf(n.cd_pessoa_fisica) END 	NOME_TOMADOR, 
		substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,10)	INSC_MUNICIPAL, 
		substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20)	INSC_ESTADUAL_RG, 
		substr(obter_dados_pf_pj(NULL,n.cd_cgc,'LO'),1,5) || ' - ' || substr(obter_dados_pf_pj(NULL,n.cd_cgc,'R'),1,50)	ENDERECO, 
		lpad(obter_tom_municipio_ibge(obter_dados_pf_pj(null, n.cd_cgc, 'CDM')),15,0)	MUNICIPIO, 
		substr(obter_dados_pf_pj(NULL,n.cd_cgc,'UF'),1,2)	UF, 
		to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))	CEP, 
		substr(obter_dados_pf_pj(NULL,n.cd_cgc,'M'),1,200)	EMAIL_TOMADOR, 
		substr(obter_dados_pf_pj(NULL,n.cd_cgc,'LO'),1,5) || ' - ' || substr(obter_dados_pf_pj(NULL,n.cd_cgc,'R'),1,50)	END_COBRANCA, 
		n.cd_estabelecimento			CD_ESTABELECIMENTO 
from	operacao_nota o, 
		nota_fiscal n 
where 	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
and	o.cd_operacao_nf = n.cd_operacao_nf 

union
 
--RODAPE 
select	9	TP_REGISTRO, 
		-- dados cabeçalho 
		'001'	VERSAO, 
		''		CCM, 
		-- dados nota fiscal 
		''	REFERENCIA, 
		null DT_EMISSAO, 
		''	LOCAL_PREST_SERV, 
		0	VL_TOTAL_SERV, 
		'' COD_SERVICO, 
		0	ALIQUOTA_ISS_OUTRO_MUNIC, 
		0	VL_ISS_RETIDO, 
		''	VL_IRRF_RETIDO, 
		''	VL_PIS_RETIDO, 
		''	VL_COFINS_RETIDO, 
		''	VL_CSLL_RETIDA, 
		''	VL_INSS_RETIDO, 
		''	CNPJ_TOMADOR, 
		''	DT_VENC_FATURA, 
		''	INSTRUCAO_PAG, 
		0	VL_DEDUCAO_BASE, 
		0	COD_VENCIMENTO, 
		''	CFOP, 
		-- dados item de serviço de nota fiscal 
		''	REFERENCIA_NF, 
		''	QUANTIDADE, 
		''	UNIDADE, 
		''	DESCRICAO, 
		''	VL_UNITARIO, 
		-- dados tomador serviço 
		''	CNPJ_CPF, 
		''	REF_NF, 
		''	NOME_TOMADOR, 
		''	INSC_MUNICIPAL, 
		''	INSC_ESTADUAL_RG, 
		''	ENDERECO, 
		''	MUNICIPIO, 
		''	UF, 
		''	CEP, 
		''	EMAIL_TOMADOR, 
		''	END_COBRANCA, 
		n.cd_estabelecimento			CD_ESTABELECIMENTO 					 
from	operacao_nota o, 
		nota_fiscal n 
where 	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
and	o.cd_operacao_nf = n.cd_operacao_nf 
group by n.cd_estabelecimento;

