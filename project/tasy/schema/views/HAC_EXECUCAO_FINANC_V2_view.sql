-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hac_execucao_financ_v2 (ie_ordem, cd_conta_financ, ds_conta_financ, nr_bordero, ds_bordero, nr_seq_conta, nr_seq_saldo_banco, nr_seq_caixa, nr_seq_saldo_caixa, ds_conta, ds_benefic, nr_titulo_receber, nr_titulo_pagar, vl_entrada, vl_saida, dt_baixa, dt_transacao, dt_referencia, dt_saldo, cd_estabelecimento, ie_origem, dt_atualizacao, ds_transacao, ie_tipo) AS select 	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem,
	coalesce(c.nr_seq_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	d.nr_bordero nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos') ds_bordero, 
	g.nr_seq_conta nr_seq_conta, 
	g.nr_sequencia nr_seq_saldo_banco, 
	null nr_seq_caixa, 
	null nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60) ds_conta, 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80) ds_benefic, 
	null nr_titulo_receber, 
	d.nr_titulo nr_titulo_pagar, 
	CASE WHEN f.ie_banco='D' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_banco='C' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_baixa dt_baixa, 
	e.dt_transacao dt_transacao, 
	g.dt_referencia dt_referencia, 
	null dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'B' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'TP' ie_tipo 
FROM banco_estabelecimento h, banco_saldo g, transacao_financeira f, movto_trans_financ e, titulo_pagar a, titulo_pagar_baixa d
LEFT OUTER JOIN titulo_pagar_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_seq_titulo_pagar 	= d.nr_titulo and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_banco 	= g.nr_sequencia and g.nr_seq_conta		= h.nr_sequencia and f.ie_banco 		<> 'N' group by 
	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.nr_seq_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira'), 
	d.nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos'), 
	g.nr_seq_conta, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60), 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_banco, 
	c.nr_seq_conta_financ, 
	d.dt_baixa, 
	e.dt_transacao, 
	g.dt_referencia, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem, 
	coalesce(c.nr_seq_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	d.nr_bordero nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos') ds_bordero, 
	g.nr_seq_conta nr_seq_conta, 
	g.nr_sequencia nr_seq_saldo_banco, 
	null nr_seq_caixa, 
	null nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60) ds_conta, 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80) ds_benefic, 
	null nr_titulo_receber, 
	d.nr_titulo nr_titulo_pagar, 
	CASE WHEN f.ie_banco='D' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_banco='C' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_baixa dt_baixa, 
	e.dt_transacao dt_transacao, 
	g.dt_referencia dt_referencia, 
	null dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'B' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'TP' ie_tipo 
FROM banco_estabelecimento h, banco_saldo g, transacao_financeira f, movto_trans_financ e, titulo_pagar a, titulo_pagar_baixa d
LEFT OUTER JOIN titulo_pagar_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_bordero	 	= d.nr_bordero and e.nr_sequencia		= (select	max(x.nr_sequencia) /*Trazer apenas uma transacao*/
 
				  from		movto_trans_financ x 
				  where	x.nr_bordero = d.nr_bordero) and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_banco 	= g.nr_sequencia and g.nr_seq_conta		= h.nr_sequencia and f.ie_banco 		<> 'N' group by 
	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.nr_seq_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira'), 
	d.nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos'), 
	g.nr_seq_conta, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60), 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_banco, 
	c.nr_seq_conta_financ, 
	d.dt_baixa, 
	e.dt_transacao, 
	g.dt_referencia, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem, 
	coalesce(c.nr_seq_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	d.nr_bordero nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos') ds_bordero, 
	null nr_seq_conta, 
	null nr_seq_saldo_banco, 
	h.nr_sequencia nr_seq_caixa, 
	g.nr_sequencia nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60) ds_conta, 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80) ds_benefic, 
	null nr_titulo_receber, 
	d.nr_titulo nr_titulo_pagar, 
	CASE WHEN f.ie_saldo_caixa='E' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_saldo_caixa='S' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_baixa dt_baixa, 
	e.dt_transacao dt_transacao, 
	null dt_referencia, 
	g.dt_saldo dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'C' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao, 
	'TP' ie_tipo 
FROM caixa h, caixa_saldo_diario g, transacao_financeira f, movto_trans_financ e, titulo_pagar a, titulo_pagar_baixa d
LEFT OUTER JOIN titulo_pagar_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_seq_titulo_pagar 	= d.nr_titulo and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_caixa 	= g.nr_sequencia and g.nr_seq_caixa		= h.nr_sequencia and f.ie_saldo_caixa	<> 'N' and f.ie_caixa		in ('D','A') group by 
	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.nr_seq_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira'), 
	d.nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos'), 
	h.nr_sequencia, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60), 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_saldo_caixa, 
	c.nr_seq_conta_financ, 
	d.dt_baixa, 
	e.dt_transacao, 
	null, 
	g.dt_saldo, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem, 
	coalesce(c.nr_seq_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	d.nr_bordero nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos') ds_bordero, 
	null nr_seq_conta, 
	null nr_seq_saldo_banco, 
	h.nr_sequencia nr_seq_caixa, 
	g.nr_sequencia nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60) ds_conta, 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80) ds_benefic, 
	null nr_titulo_receber, 
	d.nr_titulo nr_titulo_pagar, 
	CASE WHEN f.ie_saldo_caixa='E' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_saldo_caixa='S' THEN CASE WHEN c.nr_seq_conta_financ IS NULL THEN sum(coalesce(d.vl_baixa,0))  ELSE (sum(coalesce(d.vl_baixa,0))*sum(coalesce(c.vl_titulo,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_baixa dt_baixa, 
	e.dt_transacao dt_transacao, 
	null dt_referencia, 
	g.dt_saldo dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'C' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'TP' ie_tipo 
FROM caixa h, caixa_saldo_diario g, transacao_financeira f, movto_trans_financ e, titulo_pagar a, titulo_pagar_baixa d
LEFT OUTER JOIN titulo_pagar_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_bordero	 	= d.nr_bordero and e.nr_sequencia		= (select	max(x.nr_sequencia) /*Trazer apenas uma transacao*/
 
				  from		movto_trans_financ x 
				  where	x.nr_bordero = d.nr_bordero) and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_caixa 	= g.nr_sequencia and g.nr_seq_caixa		= h.nr_sequencia and f.ie_saldo_caixa	<> 'N' and f.ie_caixa		in ('D','A') group by 
	CASE WHEN c.nr_seq_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.nr_seq_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.nr_seq_conta_financ),1,60),'Sem Conta Financeira'), 
	d.nr_bordero, 
	coalesce(to_char(d.nr_bordero),'Avulsos'), 
	h.nr_sequencia, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60), 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_saldo_caixa, 
	c.nr_seq_conta_financ, 
	d.dt_baixa, 
	e.dt_transacao, 
	null, 
	g.dt_saldo, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	CASE WHEN c.cd_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem, 
	coalesce(c.cd_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.cd_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	null nr_bordero, 
	null ds_bordero, 
	g.nr_seq_conta nr_seq_conta, 
	g.nr_sequencia nr_seq_saldo_banco, 
	null nr_seq_caixa, 
	null nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60) ds_conta, 
	substr(obter_pessoa_titulo_pagar(d.nr_titulo),1,80) ds_benefic, 
	d.nr_titulo nr_titulo_receber, 
	null nr_titulo_pagar, 
	CASE WHEN f.ie_banco='D' THEN CASE WHEN c.cd_conta_financ IS NULL THEN sum(coalesce(d.vl_recebido,0))  ELSE (sum(coalesce(d.vl_recebido,0))*sum(coalesce(c.vl_classificacao,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_banco='C' THEN CASE WHEN c.cd_conta_financ IS NULL THEN sum(coalesce(d.vl_recebido,0))  ELSE (sum(coalesce(d.vl_recebido,0))*sum(coalesce(c.vl_classificacao,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_recebimento dt_baixa, 
	e.dt_transacao dt_transacao, 
	g.dt_referencia dt_referencia, 
	null dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'B' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'TR' ie_tipo 
FROM banco_estabelecimento h, banco_saldo g, transacao_financeira f, movto_trans_financ e, titulo_receber a, titulo_receber_liq d
LEFT OUTER JOIN titulo_receber_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_seq_titulo_receber = d.nr_titulo and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_banco 	= g.nr_sequencia and g.nr_seq_conta		= h.nr_sequencia and f.ie_banco 		<> 'N' and coalesce(ie_lib_caixa, 'S') = 'S' group by 
	CASE WHEN c.cd_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.cd_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.cd_conta_financ),1,60),'Sem Conta Financeira'), 
	g.nr_seq_conta, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60), 
	substr(obter_pessoa_titulo_receber(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_banco, 
	c.cd_conta_financ, 
	d.dt_recebimento, 
	e.dt_transacao, 
	g.dt_referencia, 
	null, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	CASE WHEN c.cd_conta_financ IS NULL THEN 2  ELSE 1 END  ie_ordem, 
	coalesce(c.cd_conta_financ,0) cd_conta_financ, 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.cd_conta_financ),1,60),'Sem Conta Financeira') ds_conta_financ, 
	null nr_bordero, 
	null ds_bordero, 
	null nr_seq_conta, 
	null nr_seq_saldo_banco, 
	h.nr_sequencia nr_seq_caixa, 
	g.nr_sequencia nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60) ds_conta, 
	substr(obter_pessoa_titulo_receber(d.nr_titulo),1,80) ds_benefic, 
	d.nr_titulo nr_titulo_receber, 
	null nr_titulo_pagar, 
	CASE WHEN f.ie_saldo_caixa='E' THEN CASE WHEN c.cd_conta_financ IS NULL THEN sum(coalesce(d.vl_recebido,0))  ELSE (sum(coalesce(d.vl_recebido,0))*sum(coalesce(c.vl_classificacao,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_entrada, 
	CASE WHEN f.ie_saldo_caixa='S' THEN CASE WHEN c.cd_conta_financ IS NULL THEN sum(coalesce(d.vl_recebido,0))  ELSE (sum(coalesce(d.vl_recebido,0))*sum(coalesce(c.vl_classificacao,0))/sum(a.vl_titulo)) END   ELSE 0 END  vl_saida, 
	d.dt_recebimento dt_baixa, 
	e.dt_transacao dt_transacao, 
	null dt_referencia, 
	g.dt_saldo dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'C' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'TR' ie_tipo 
FROM caixa h, caixa_saldo_diario g, transacao_financeira f, movto_trans_financ e, titulo_receber a, titulo_receber_liq d
LEFT OUTER JOIN titulo_receber_classif c ON (d.nr_titulo = c.nr_titulo)
WHERE e.nr_seq_titulo_receber = d.nr_titulo and a.nr_titulo		= d.nr_titulo  and e.nr_seq_trans_financ 	= f.nr_sequencia and e.nr_seq_saldo_caixa 	= g.nr_sequencia and g.nr_seq_caixa		= h.nr_sequencia and f.ie_saldo_caixa	<> 'S' and f.ie_caixa		in ('D','A') and coalesce(ie_lib_caixa, 'S') = 'S' group by 
	CASE WHEN c.cd_conta_financ IS NULL THEN 2  ELSE 1 END , 
	coalesce(c.cd_conta_financ,0), 
	coalesce(substr(obter_descricao_padrao('CONTA_FINANCEIRA','DS_CONTA_FINANC',c.cd_conta_financ),1,60),'Sem Conta Financeira'), 
	h.nr_sequencia, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60), 
	substr(obter_pessoa_titulo_receber(d.nr_titulo),1,80), 
	d.nr_titulo, 
	f.ie_saldo_caixa, 
	c.cd_conta_financ, 
	d.dt_recebimento, 
	e.dt_transacao, 
	null, 
	g.dt_saldo, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	1 ie_ordem, 
	null cd_conta_financ, 
	null ds_conta_financ, 
	null nr_bordero, 
	null ds_bordero, 
	g.nr_seq_conta nr_seq_conta, 
	g.nr_sequencia nr_seq_saldo_banco, 
	null nr_seq_caixa, 
	null nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60) ds_conta, 
	null ds_benefic, 
	null nr_titulo_receber, 
	null nr_titulo_pagar, 
	sum(CASE WHEN f.ie_banco='D' THEN e.vl_transacao  ELSE 0 END ) vl_entrada, 
	sum(CASE WHEN f.ie_banco='C' THEN e.vl_transacao  ELSE 0 END ) vl_saida, 
	null dt_baixa, 
	e.dt_transacao dt_transacao, 
	g.dt_referencia dt_referencia, 
	null dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'B' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao ds_transacao, 
	'ST' ie_tipo 
from 	banco_estabelecimento h, 
	banco_saldo g, 
	transacao_financeira f, 
	movto_trans_financ e 
where	e.nr_seq_trans_financ 	= f.nr_sequencia 
and	e.nr_seq_saldo_banco 	= g.nr_sequencia 
and	g.nr_seq_conta		= h.nr_sequencia 
and	e.nr_seq_titulo_pagar is null 
and	e.nr_seq_titulo_receber is null 
and	e.nr_bordero is null 
and	f.ie_banco <> 'N' 
group by 
	g.nr_seq_conta, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('BANCO_ESTABELECIMENTO','CD_CONTA',g.nr_seq_conta),1,60), 
	e.dt_transacao, 
	g.dt_referencia, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao 

union all
 
select 	2 ie_ordem, 
	null cd_conta_financ, 
	null ds_conta_financ, 
	null nr_bordero, 
	null ds_bordero, 
	null nr_seq_conta, 
	null nr_seq_saldo_banco, 
	h.nr_sequencia nr_seq_caixa, 
	g.nr_sequencia nr_seq_saldo_caixa, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60) ds_conta, 
	null ds_benefic, 
	null nr_titulo_receber, 
	null nr_titulo_pagar, 
	sum(CASE WHEN f.ie_saldo_caixa='E' THEN e.vl_transacao  ELSE 0 END ) vl_entrada, 
	sum(CASE WHEN f.ie_saldo_caixa='S' THEN e.vl_transacao  ELSE 0 END ) vl_saida, 
	null dt_baixa, 
	e.dt_transacao dt_transacao, 
	null dt_referencia, 
	g.dt_saldo dt_saldo, 
	h.cd_estabelecimento cd_estabelecimento, 
	'C' ie_origem, 
	e.dt_atualizacao dt_atualizacao, 
	f.ds_transacao, 
	'ST' ie_tipo 
from	caixa h, 
	caixa_saldo_diario g, 
	transacao_financeira f, 
	movto_trans_financ e 
where	e.nr_seq_trans_financ 	= f.nr_sequencia 
and	e.nr_seq_saldo_caixa 	= g.nr_sequencia 
and	g.nr_seq_caixa		= h.nr_sequencia 
and	e.nr_seq_titulo_pagar is null 
and	e.nr_seq_titulo_receber is null 
and	e.nr_bordero is null 
and	ie_saldo_caixa <> 'N' 
and	f.ie_caixa		in ('D','A') 
group by 
	h.nr_sequencia, 
	g.nr_sequencia, 
	substr(obter_descricao_padrao('CAIXA','DS_CAIXA',g.nr_seq_caixa),1,60), 
	e.dt_transacao, 
	g.dt_saldo, 
	h.cd_estabelecimento, 
	e.dt_atualizacao, 
	f.ds_transacao;

