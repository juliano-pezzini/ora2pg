-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_planserv_v (tp_registro, ds_servico, cd_registro, ds_zeros, cd_convenio, nm_convenio, tp_prestador, cd_prestador, ds_branco, nm_prestador, dt_geracao, nr_remessa, nr_versao, nr_seq_registro, nr_interno_conta, nr_parcela, cd_plano, cd_beneficiario, ds_senha_autor, cd_acomodacao, dt_entrada, hr_entrada, dt_saida, hr_saida, dt_inicio_cobranca, dt_fim_cobranca, ie_tipo_atend_operadora, cd_cid, cd_proc_principal, nr_crm_resp_cab, cd_uf_crm_cab, nr_crm_solic_cab, cd_uf_crm_solic_cab, nr_tipo_alta, ie_pre_natal, dt_solicitacao, ie_tipo_parto, tp_recem_nascido, tp_paciente, ie_carater_atend, cd_prestador_exec, cd_biometria, hr_inicio_periodo, nr_fim_periodo, cd_empresa_audit, nr_relat_tec_audit, ds_campo_livre_prest, nr_seq_item, cd_item, ds_item, ie_item_emergencia, ie_dia_hr_extraordinaria, dt_realizacao_proc, cd_posicao_prof, qt_executada, vl_item, nr_perc_cir_radio_areas, nr_crm_resp, cd_uf_crm_resp, ie_uti, cd_espec_proc, vl_filme, vl_procedimento, vl_custo_adm, ds_campo_livre, ie_tipo_material, tp_embalagem_fracao, cd_unid_emb_fracao, ds_sigla_lab, cd_tiss, tp_codigo_tiss, qt_item, nm_beneficiario, qt_mat_med_tipo3, qt_total_contas, vl_total_contas, nr_seq_protocolo, nr_conta, ds_zeros1, ds_zeros2, ds_zeros3, ds_zeros4, ds_zeros5, dt_rat, ds_conselho_solic, ds_conselho_exec, dt_item) AS select	1 tp_registro,
	'TSCM' ds_servico,--TSCM 
	0 cd_registro, --Registro 0 (HEADER - Cabeçalho) 
	0 ds_zeros, 
	0 cd_convenio, 
	'PLANSERV' nm_convenio, 
	'J' tp_prestador, /* J ou F */
 
	a.cd_interno cd_prestador, 
	' ' DS_BRANCO, 
	a.nm_hospital nm_prestador, 
	to_char(LOCALTIMESTAMP,'ddmmyyyy') dt_geracao, 
	0 NR_REMESSA, 
	2 nr_versao, 
	0 nr_seq_registro, 
	'' nr_interno_conta, 
	'' nr_parcela, 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp_cab, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic_cab, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	'' cd_item, 
	'' ds_item, 
	'' ie_item_emergencia, 
	'' ie_dia_hr_extraordinaria, 
	'' dt_realizacao_proc, 
	'' cd_posicao_prof, 
	0 qt_executada, 
	0 vl_item, 
	0 nr_perc_cir_radio_areas, 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, 
	'' ie_uti, 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	'' ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	0 nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
FROM	w_interf_conta_header a 

union all
 
select	2 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	1 cd_registro, --Registro 1 Cabeçalho das contas 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, /* J ou F */
 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	0 NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = b.nr_interno_conta),b.nr_interno_conta),10,0) nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2) nr_parcela, --OBS 2 
	Lpad(b.cd_plano_convenio,10,'') cd_plano, 
	b.cd_usuario_convenio cd_beneficiario, 
	lpad(coalesce(substr(planserv_obter_dados_cat_conv(b.nr_atendimento, b.nr_interno_conta,'S'),1,10),0),10,0) ds_senha_autor, 
	coalesce(substr(Obter_Conversao_Externa(cd_cgc_convenio,'TIPO_ACOMODACAO','CD_TIPO_ACOMODACAO',b.cd_tipo_acomodacao),1,1),0) CD_ACOMODACAO, --Conversão meio externo 
	to_char(obter_dt_primeiro_item_conta(b.nr_atendimento),'ddmmyyyy') dt_entrada, 
	to_char(obter_dt_primeiro_item_conta(b.nr_atendimento),'hh24:mi') hr_entrada, 
	to_char(b.dt_alta,'ddmmyyyy') dt_saida, 
	to_char(b.dt_alta,'hh24:mi') hr_saida, 
	to_char(dt_periodo_inicial,'ddmmyyyy') dt_inicio_cobranca, 
	to_char(dt_periodo_final,'ddmmyyyy') dt_fim_cobranca, 
	--substr(Obter_Tp_Atend_Conv_Regra(b.nr_interno_conta),1,1) ie_tipo_atend_operadora, 
	substr(obter_tipo_atend_conta_conv(b.nr_interno_conta),1,1) ie_tipo_atend_operadora,	 
	b.cd_cid_principal cd_cid, 
	coalesce(obter_proc_princ_autor(b.nr_atendimento),b.cd_proc_principal) cd_proc_principal, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'R','R'),1,20) nr_crm_resp_cab, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'R','U'),1,2) cd_uf_crm_cab, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'S','R'),1,20) nr_crm_solic_cab, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'S','U'),1,2) cd_uf_crm_solic_cab, 
	coalesce(substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'MOTIVO_ALTA','CD_MOTIVO_ALTA',coalesce(b.cd_motivo_alta,0)),1,1),'5') nr_tipo_alta, 
	(select	coalesce(max('S'),'N') from med_pac_pre_natal x where x.nr_atendimento = b.nr_atendimento) IE_PRE_NATAL, 
	to_char(b.dt_entrada,'ddmmyyyy') dt_solicitacao, 
	substr(obter_tipo_parto(b.nr_atendimento,b.ie_sexo),1,1) IE_TIPO_PARTO, 
	substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'NASCIMENTO','IE_TIPO_NASCIMENTO',obter_dados_nascimento_atend(b.nr_atendimento,'TN')),1,1) tp_recem_nascido, 
	Lpad(1,2,0) tp_paciente, 
	coalesce(substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'SUS_CARATER_INTERNACAO','CD_CARATER_INTERNACAO',b.ie_carater_sus),1,1),0) ie_carater_atend, --alterar tem que fazer de - para 
	b.cd_cgc_hospital cd_prestador_exec, 
	coalesce(substr(planserv_obter_dados_cat_conv(b.nr_atendimento, b.nr_interno_conta,'B'),1,10),0) CD_BIOMETRIA, 
	to_char(dt_periodo_inicial,'hh24:mi') HR_INICIO_PERIODO, 
	to_char(dt_periodo_final,'hh24:mi') NR_FIM_PERIODO, 
	(substr(obter_dados_audit_conpaci(b.nr_interno_conta,'E'),1,2))::numeric  CD_EMPRESA_AUDIT, 
	substr(obter_dados_audit_conpaci(b.nr_interno_conta,'R'),1,10) NR_RELAT_TEC_AUDIT, 
	' ' DS_CAMPO_LIVRE_PREST, 
	0 nr_seq_item, 
	'' cd_item, 
	'' ds_item, 
	'' ie_item_emergencia, 
	'' ie_dia_hr_extraordinaria, 
	'' dt_realizacao_proc, 
	'' cd_posicao_prof, 
	0 qt_executada, 
	0 vl_item, 
	0 nr_perc_cir_radio_areas, 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, 
	'' ie_uti, 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	'' ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	b.nr_seq_protocolo, 
	b.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	substr(obter_dados_audit_conpaci(b.nr_interno_conta,'D'),1,8) dt_rat, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'S','S'),1,10) ds_conselho_solic, 
	substr(planserv_obter_dados_medico(b.nr_atendimento,b.cd_medico_resp,b.nr_crm_medico_resp,b.uf_crm_medico_resp,'E','S'),1,10) ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
from	w_interf_conta_cab b 

union all
 
select	3 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	2 cd_registro, --Registro 2 (Item da conta proced) 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	a.nr_remessa NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = b.nr_interno_conta),b.nr_interno_conta),10,0) nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2) nr_parcela, --OBS 2 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8) cd_item, 
	a.ds_item ds_item, 
	CASE WHEN OBTER_TIPO_ATENDIMENTO(b.nr_atendimento)=3 THEN 'S'  ELSE 'N' END  ie_item_emergencia, 
	substr(obter_se_proc_crit_horario(a.nr_seq_item),1,1) ie_dia_hr_extraordinaria, 
	to_char(a.dt_item, 'ddmmyyyy') dt_realizacao_proc, 
	substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'INTERF_PLANSERV_V','CD_FUNCAO_EXECUTOR',a.cd_funcao_executor),1,1) cd_posicao_prof, --OBS 10 
	sum(a.qt_item) qt_executada, 
	CASE WHEN a.nr_seq_proc_pacote IS NULL THEN  CASE WHEN a.ie_responsavel_credito='RM' THEN  CASE WHEN a.ie_emite_conta=107 THEN  sum(coalesce(a.vl_honorario,0)) WHEN a.ie_emite_conta=91 THEN  sum(coalesce(a.vl_honorario,0))  ELSE sum(coalesce(a.vl_total_item,0)) END   ELSE sum(coalesce(a.vl_total_item,0)) END   ELSE sum(coalesce(a.vl_total_item,0)) END  vl_item, 
	a.pr_via_acesso nr_perc_cir_radio_areas, --OBS11 
	a.nr_crm_executor NR_CRM_RESP, 
	a.uf_crm_executor cd_uf_crm_resp, 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END  ie_uti, --OBS14 
	0 cd_espec_proc, --OBS15 
	sum(a.vl_filme) vl_filme, 
	sum(a.vl_total_item) vl_procedimento, 
	sum(a.vl_custo_oper) vl_custo_adm, 
	substr(' ',1,20) ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
from	w_interf_conta_item a, 
	w_interf_conta_cab b 
where	a.nr_interno_conta = b.nr_interno_conta 
and	a.ie_tipo_item = 1 
and 	coalesce(a.nr_seq_proc_pacote,0) <> coalesce(a.nr_seq_item,0) 
group by a.nr_remessa, 
	b.nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2), --OBS 2	 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8), 
	a.ds_item, 
	CASE WHEN OBTER_TIPO_ATENDIMENTO(b.nr_atendimento)=3 THEN 'S'  ELSE 'N' END , 
	substr(obter_se_proc_crit_horario(a.nr_seq_item),1,1), 
	to_char(a.dt_item, 'ddmmyyyy'), 
	substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'INTERF_PLANSERV_V','CD_FUNCAO_EXECUTOR',a.cd_funcao_executor),1,1), --OBS 10 
	a.pr_via_acesso, --OBS11 
	a.nr_crm_executor, 
	a.uf_crm_executor, 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END , --OBS14 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	a.ie_responsavel_credito, 
	a.nr_seq_proc_pacote, 
	a.ie_emite_conta/*, 
	to_char(a.dt_item, 'ddmmyyyy hh24miss'), -- somente para não agrupar pela data*/
 
having ((sum(a.qt_item) > 0) and (sum(coalesce(a.vl_total_item,0)) > 0)) 

union all
 
select	3 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	2 cd_registro, --Registro 2 (Item da conta proced ----> somente para pacotes) 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	a.nr_remessa NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = b.nr_interno_conta),b.nr_interno_conta),10,0) nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2) nr_parcela, --OBS 2 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8) cd_item, 
	a.ds_item ds_item, 
	CASE WHEN OBTER_TIPO_ATENDIMENTO(b.nr_atendimento)=3 THEN 'S'  ELSE 'N' END  ie_item_emergencia, 
	substr(obter_se_proc_crit_horario(a.nr_seq_item),1,1) ie_dia_hr_extraordinaria, 
	to_char(a.dt_item, 'ddmmyyyy') dt_realizacao_proc, 
	substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'INTERF_PLANSERV_V','CD_FUNCAO_EXECUTOR',a.cd_funcao_executor),1,1) cd_posicao_prof, --OBS 10 
	sum(a.qt_item) qt_executada, 
	CASE WHEN a.nr_seq_proc_pacote IS NULL THEN  CASE WHEN a.ie_responsavel_credito='RM' THEN  CASE WHEN a.ie_emite_conta=107 THEN  sum(coalesce(a.vl_honorario,0)) WHEN a.ie_emite_conta=77 THEN  sum(coalesce(a.vl_honorario,0))  ELSE sum(coalesce(a.vl_total_item,0)) END   ELSE sum(coalesce(a.vl_total_item,0)) END   ELSE sum(coalesce(a.vl_total_item,0)) END  vl_item, 
	a.pr_via_acesso nr_perc_cir_radio_areas, --OBS11 
	a.nr_crm_executor NR_CRM_RESP, 
	a.uf_crm_executor cd_uf_crm_resp, 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END  ie_uti, --OBS14 
	0 cd_espec_proc, --OBS15 
	sum(a.vl_filme) vl_filme, 
	sum(a.vl_total_item) vl_procedimento, 
	sum(a.vl_custo_oper) vl_custo_adm, 
	substr(' ',1,20) ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	to_char(a.dt_item, 'ddmmyyyy hh24miss') dt_item -- somente para não agrupar pela data 
from	w_interf_conta_item a, 
	w_interf_conta_cab b 
where	a.nr_interno_conta = b.nr_interno_conta 
and	a.ie_tipo_item = 1 
and a.nr_seq_proc_pacote = a.nr_seq_item 
group by a.nr_remessa, 
	b.nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2), --OBS 2	 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8), 
	a.ds_item, 
	CASE WHEN OBTER_TIPO_ATENDIMENTO(b.nr_atendimento)=3 THEN 'S'  ELSE 'N' END , 
	substr(obter_se_proc_crit_horario(a.nr_seq_item),1,1), 
	to_char(a.dt_item, 'ddmmyyyy'), 
	substr(Obter_Conversao_Externa(b.cd_cgc_convenio,'INTERF_PLANSERV_V','CD_FUNCAO_EXECUTOR',a.cd_funcao_executor),1,1), --OBS 10 
	a.pr_via_acesso, --OBS11 
	a.nr_crm_executor, 
	a.uf_crm_executor, 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END , --OBS14 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	a.ie_responsavel_credito, 
	a.nr_seq_proc_pacote, 
	a.ie_emite_conta, 
	to_char(a.dt_item, 'ddmmyyyy hh24miss') -- somente para não agrupar pela data 
having ((sum(a.qt_item) > 0) and (sum(coalesce(a.vl_total_item,0)) > 0)) 

union all
 
SELECT	3 tp_registro, 
	'TSCM' ds_servico, 
	2 cd_registro,  --Registro 2 (Item da conta Materiais e Medicamentos - agrupados) 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	0 NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = a.nr_interno_conta),a.nr_interno_conta),10,0) nr_interno_conta, 
	'' nr_parcela, 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp_cab, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic_cab, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8) cd_item, 
	SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'D',a.ie_tipo_item),1,50) ds_item, 
	'N' ie_item_emergencia, 
	'N' ie_dia_hr_extraordinaria, 
	to_char(b.dt_periodo_final,'ddmmyyyy') dt_realizacao_proc, 
	'' cd_posicao_prof, 
	CASE WHEN SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8)=63130017 THEN  planserv_qt_registro_total(a.nr_interno_conta, 'MA') WHEN SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8)=63130025 THEN  planserv_qt_registro_total(a.nr_interno_conta, 'ME') WHEN SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8)=63130033 THEN  planserv_qt_registro_total(a.nr_interno_conta, 'CO') WHEN SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8)=63130041 THEN  planserv_qt_registro_total(a.nr_interno_conta, 'OP') WHEN SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8)=63130050 THEN  planserv_qt_registro_total(a.nr_interno_conta, 'SE')  ELSE 0 END  qt_executada, 
	SUM(coalesce(a.vl_total_item,0)) , 
	0 nr_perc_cir_radio_areas, 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, 
	'' ie_uti, 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	' ' ds_campo_livre, 
	coalesce((SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item),1,1))::numeric ,0) ie_tipo_material, --Interface Meio Externo ou criar regra 
	' ' tp_embalagem_fracao,--Ver com consultor 
	' ' cd_unid_emb_fracao,--Ver com consultor 
	' ' ds_sigla_lab, ----Ver com consultor 
	'0' cd_tiss, --Criar campo cd_material_tiss na w_interf_conta_item OBS20 
	' ' tp_codigo_tiss, -- OBS 21 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
FROM	w_interf_conta_item a, 
	w_interf_conta_cab b 
WHERE	a.nr_interno_conta = b.nr_interno_conta 
AND	SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item),1,1) IS NOT NULL 
AND	a.ie_tipo_item = 2 
GROUP BY a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	LPAD(a.nr_interno_conta,10,0), 
	to_char(b.dt_periodo_final,'ddmmyyyy'), 
	SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'A',a.ie_tipo_item),1,8), 
	SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'D',a.ie_tipo_item),1,50), 
	coalesce((SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item),1,1))::numeric ,0) 
having ((sum(a.qt_item) > 0) and (sum(coalesce(a.vl_total_item,0)) > 0)) 

union all
 
select	4 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	3 cd_registro, --Registro 3 (Item da conta mat med) 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	a.nr_remessa NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = a.nr_interno_conta),a.nr_interno_conta),10,0) nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2) nr_parcela, --OBS 2 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp_cab, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic_cab, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8) cd_item, 
	a.ds_item ds_item, 
	'' ie_item_emergencia, 
	'' ie_dia_hr_extraordinaria, 
	'' dt_realizacao_proc, 
	'' cd_posicao_prof, --OBS 10 
	sum(a.qt_item) qt_executada, 
	sum(coalesce(a.vl_total_item,0)) vl_item, 
	0 nr_perc_cir_radio_areas, --OBS11 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, --OBS12 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END  ie_uti, --OBS14 ie_uti, --OBS14 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	' ' ds_campo_livre, 
	coalesce((SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item),1,1))::numeric ,0) ie_tipo_material, --Interface Meio Externo ou criar regra 
	' ' tp_embalagem_fracao,--Ver com consultor 
	' ' cd_unid_emb_fracao,--Ver com consultor 
	' ' ds_sigla_lab, ----Ver com consultor 
	coalesce(a.cd_item_convenio, a.cd_item) cd_tiss, --Criar campo cd_material_tiss na w_interf_conta_item OBS20 
	substr(CASE WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='1' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='3' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='4' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='2' THEN '2' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='5' THEN '2' END ,1,1) tp_codigo_tiss, -- OBS 21 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
from	w_interf_conta_item a, 
	w_interf_conta_cab b 
where	a.nr_interno_conta = b.nr_interno_conta 
and	a.ie_tipo_item = 2 
group by a.nr_remessa, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, b.NR_INTERNO_CONTA, b.NR_SEQ_PROTOCOLO),1,2), 
	substr(coalesce(a.cd_item_convenio, a.cd_item),1,8), 
	a.ds_item, 
	CASE WHEN a.cd_classif_setor=4 THEN 'S'  ELSE 'N' END , 
	coalesce((SUBSTR(planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item),1,1))::numeric ,0), 
	coalesce(a.cd_item_convenio, a.cd_item), 
	substr(CASE WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='1' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='3' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='4' THEN '1' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='2' THEN '2' WHEN planserv_obter_agrupamento_mat(a.nr_seq_item,'I',a.ie_tipo_item)='5' THEN '2' END ,1,1), 
	a.nr_seq_protocolo, 
	a.nr_interno_conta/*, 
	to_char(a.dt_item, 'ddmmyyyy hh24miss')*/
 
having ((sum(a.qt_item) > 0) and (sum(coalesce(a.vl_total_item,0)) > 0)) 

union all
 
select	5 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	4 cd_registro, --Registro 4 total conta 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, /* J ou F */
 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	0 NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	LPAD(coalesce((select x.nr_seq_ordem from conta_paciente x where x.nr_interno_conta = a.nr_interno_conta),a.nr_interno_conta),10,0) nr_interno_conta, 
	substr(planserv_obter_parcela_conta(b.CD_PACIENTE, a.NR_INTERNO_CONTA, a.NR_SEQ_PROTOCOLO),1,2) nr_parcela, --OBS 2, 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp_cab, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic_cab, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	'' cd_item, 
	'' ds_item, 
	'' ie_item_emergencia, 
	'' ie_dia_hr_extraordinaria, 
	'' dt_realizacao_proc, 
	'' cd_posicao_prof, 
	0 qt_executada, 
	coalesce(a.VL_TOTAL_CONTA,0) vl_item, 
	0 nr_perc_cir_radio_areas, 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, 
	'' ie_uti, 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	'' ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	/*select count(x.cd_item)  
	from  w_interf_conta_item x 
	where	x.nr_interno_conta = a.nr_interno_conta 
	and	x.ie_tipo_item = 1) + 
	(select	count(distinct x.cd_grupo) 
	from 	mat_atend_pac_convenio x, w_interf_conta_item y 
	where 	x.nr_seq_material = y.nr_seq_item 
	and y.nr_interno_conta = a.nr_interno_conta 
	and x.cd_grupo in ('1', '2', '3', '4', '5') 
	and	y.ie_tipo_item	 = 2))qt_item,*/
 
	planserv_qt_registro_total(a.nr_interno_conta, 'Q') qt_item, 
	substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,60) nm_beneficiario, 
	planserv_qt_registro_total(a.nr_interno_conta, 'M') qt_mat_med_tipo3, --OBS 17 
	0 qt_total_contas, 
	0 vl_total_contas, 
	a.nr_seq_protocolo, 
	a.nr_interno_conta nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
from	w_interf_conta_total a, 
	w_interf_conta_cab b 
where	a.nr_interno_conta = b.nr_interno_conta 

union all
 
select	6 tp_registro, 
	'TSCM' ds_servico,--TSCM 
	9 cd_registro, --Registro 9 total geral 
	0 ds_zeros, 
	0 cd_convenio, 
	'' nm_convenio, 
	'' tp_prestador, /* J ou F */
 
	'' cd_prestador, 
	' ' DS_BRANCO, 
	'' nm_prestador, 
	'' dt_geracao, 
	0 NR_REMESSA, 
	0 nr_versao, 
	0 nr_seq_registro, --OBS99 
	'' nr_interno_conta, 
	'' nr_parcela, 
	'' cd_plano, 
	'' cd_beneficiario, 
	'' ds_senha_autor, 
	'' cd_acomodacao, 
	'' dt_entrada, 
	'' hr_entrada, 
	'' dt_saida, 
	'' hr_saida, 
	'' dt_inicio_cobranca, 
	'' dt_fim_cobranca, 
	'' ie_tipo_atend_operadora, 
	'' cd_cid, 
	0 cd_proc_principal, 
	'' nr_crm_resp_cab, 
	'' cd_uf_crm_cab, 
	'' nr_crm_solic_cab, 
	'' cd_uf_crm_solic_cab, 
	'' nr_tipo_alta, 
	'' ie_pre_natal, 
	'' dt_solicitacao, 
	'' ie_tipo_parto, 
	'' tp_recem_nascido, 
	'' tp_paciente, 
	'' ie_carater_atend, 
	'' cd_prestador_exec, 
	'' cd_biometria, 
	'' hr_inicio_periodo, 
	'' nr_fim_periodo, 
	0 cd_empresa_audit, 
	'' nr_relat_tec_audit, 
	'' ds_campo_livre_prest, 
	0 nr_seq_item, 
	'' cd_item, 
	'' ds_item, 
	'' ie_item_emergencia, 
	'' ie_dia_hr_extraordinaria, 
	'' dt_realizacao_proc, 
	'' cd_posicao_prof, 
	0 qt_executada, 
	0 vl_item, 
	0 nr_perc_cir_radio_areas, 
	'' NR_CRM_RESP, 
	'' cd_uf_crm_resp, 
	'' ie_uti, 
	0 cd_espec_proc, 
	0 vl_filme, 
	0 vl_procedimento, 
	0 vl_custo_adm, 
	'' ds_campo_livre, 
	0 ie_tipo_material, 
	'' tp_embalagem_fracao, 
	'' cd_unid_emb_fracao, 
	'' ds_sigla_lab, 
	'' cd_tiss, 
	'' tp_codigo_tiss, 
	0 qt_item, 
	'' nm_beneficiario, 
	0 qt_mat_med_tipo3, --OBS 17 
	count(distinct a.nr_interno_conta) qt_total_contas, 
	coalesce(sum(a.VL_TOTAL_CONTA),0) vl_total_contas, 
	a.nr_seq_protocolo, 
	99999999 nr_conta, 
	0 ds_zeros1, 
	0 ds_zeros2, 
	0 ds_zeros3, 
	0 ds_zeros4, 
	0 ds_zeros5, 
	'' dt_rat, 
	'' ds_conselho_solic, 
	'' ds_conselho_exec, 
	'' dt_item -- somente para não agrupar pela data 
from	w_interf_conta_total a 
group by a.nr_seq_protocolo;

