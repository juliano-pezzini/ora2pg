-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW oft_agenda_cirurgica_v (nr_atendimento, ie_status_agenda, ie_tipo_classif, ie_autorizacao, dt_confirmacao, cd_pessoa_fisica, dt_agenda, ds_agenda, hr_inicio, nr_minuto_duracao, nm_paciente_pf, ds_convenio, nm_medico, ds_observacao, ds_tipo_anestesia, nm_pessoa_contato, ds_proc_cirurgia, nm_guerra, nm_instrumentador, nm_circulante, dt_entrada_tasy, qt_min_espera_tasy, ds_cirurgia, nr_seq_status_pac, ie_reserva_leito, ie_banco_sangue, ds_status_agenda, nr_sequencia, cd_convenio, cd_procedimento, ie_origem_proced, cd_tipo_agenda, cd_estabelecimento, cd_medico, cd_turno, cd_agenda, ie_profissional_agenda, ie_permissao, ds_opme, ds_lado, dt_inicio_consulta, nr_seq_oftalmo) AS select
	b.nr_atendimento,
	b.ie_status_agenda,
	x.ie_tipo_classif,
	b.ie_autorizacao,
	b.dt_confirmacao,
	b.cd_pessoa_fisica,
	b.dt_agenda,
	a.ds_agenda,
	b.hr_inicio,
	b.nr_minuto_duracao,
	substr(CASE WHEN b.ie_status_agenda='B' THEN CASE WHEN b.ds_observacao IS NULL THEN  obter_desc_expressao(302715,'Bloqueado')  ELSE obter_desc_expressao(302715,'Bloqueado')||'('|| b.ds_observacao || ')' END   ELSE coalesce(substr(obter_nome_pf(b.cd_pessoa_fisica),1,200),substr(b.nm_paciente,1,200)) END ,1,200) nm_paciente_pf,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	substr(obter_nome_pf(b.cd_medico),1,200) nm_medico,
	substr(b.ds_observacao,1,250) ds_observacao,
	substr(obter_valor_dominio(36, b.cd_tipo_anestesia),1,30) ds_tipo_anestesia,
	b.nm_pessoa_contato,
	substr(coalesce(substr(obter_Nome_Item_Convenio(b.cd_convenio, 1,b.cd_procedimento, b.ie_origem_proced,'N', null, null, null, null),1,80),substr(obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced),1,150)),1,250) ds_proc_cirurgia,
	substr(OBTER_NOME_MEDICO(b.cd_medico, 'G'),1,200) nm_guerra,
	b.nm_instrumentador,
	b.nm_circulante,
	OBTER_DATA_ENTRADA(b.nr_atendimento) dt_entrada_tasy,
	Obter_Tempo_Espera_Atend(b.nr_atendimento) qt_min_espera_tasy,
	substr(b.ds_cirurgia,1,250) ds_cirurgia,
	b.nr_seq_status_pac,
	b.ie_reserva_leito,
	b.ie_banco_sangue,
	substr(obter_valor_dominio(83, b.ie_status_agenda),1,30) ds_status_agenda,
	b.nr_sequencia,
	b.cd_convenio,
	b.cd_procedimento,
	b.ie_origem_proced,
	a.cd_tipo_agenda,
	a.cd_estabelecimento,
	b.cd_medico,
	b.cd_turno,
	a.cd_agenda,
	obter_se_profissional_agenda(b.nr_sequencia, obter_pf_usuario(wheb_usuario_pck.get_nm_usuario,'C')) ie_profissional_agenda,
	SUBSTR(obter_se_perm_agecirur(b.cd_pessoa_fisica,obter_pf_usuario(wheb_usuario_pck.get_nm_usuario,'C'),wheb_usuario_pck.get_cd_perfil,b.cd_agenda),1,1) ie_permissao,
   SUBSTR(obter_descricao_opme_fornec(b.nr_sequencia),1,255) ds_opme,
   SUBSTR(obter_valor_dominio(1372,b.ie_lado),1,80) ds_lado,
   d.dt_inicio_consulta,
   b.nr_seq_oftalmo
FROM agenda a, agenda_paciente b
LEFT OUTER JOIN agenda_paciente_classif x ON (b.nr_seq_classif_agenda = x.nr_sequencia)
LEFT OUTER JOIN oft_consulta d ON (b.nr_seq_oftalmo = d.nr_sequencia)
WHERE a.cd_agenda = b.cd_agenda   and b.ie_status_agenda NOT IN ('L','I','B','F') and a.cd_tipo_agenda = 1;

