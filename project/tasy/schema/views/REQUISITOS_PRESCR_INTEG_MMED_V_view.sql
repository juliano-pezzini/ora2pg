-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW requisitos_prescr_integ_mmed_v (nr_prescricao, nr_sequencia, nr_seq_interno, ie_liberacao, ie_baixa, dt_integracao, ie_procedimento, ie_tipo_proced, ie_setor_banco, ie_setor_proced) AS select 	b.nr_prescricao,
	a.nr_sequencia,
	a.nr_seq_interno,
	'Liberação da prescrição: '||CASE WHEN b.dt_liberacao_medico IS NULL THEN (CASE WHEN b.dt_liberacao IS NULL THEN 'Falta liberar prescrição'  ELSE 'OK' END )  ELSE 'OK' END  ie_liberacao,
	'Motivo de baixa: '||CASE WHEN a.cd_motivo_baixa=0 THEN 'OK' WHEN a.cd_motivo_baixa=1 THEN 'OK'  ELSE 'Prescrição já possui motivo de baixa (diferente de 0 ou 1 - Atendimento normal)' END  ie_baixa,
	'Data de integração: '||CASE WHEN a.dt_integracao IS NULL THEN 'OK'  ELSE 'Já possui data de integração: '||a.dt_integracao END  dt_integracao,
	'Procedimento de imagem: '||CASE WHEN a.nr_seq_exame IS NULL THEN 'OK'  ELSE 'O procedimento prescrito é de laboratório, somente serão integrados procedimentos de imagem' END  ie_procedimento,
	'Tipo do procedimento: '||case when p.cd_tipo_procedimento in (select x.cd_tipo_procedimento
								 FROM	 mmed_tipo_procedimento x
								 where	 x.nr_seq_parametro_mmed = (select max(y.nr_sequencia) 
								    from mmed_parametro_integracao y)) then 'OK' else 'Não está entre os definidos para a integração no cadastro Parâmetros de integração do MultiMED, verificar campo Tipo da função Procedimentos' end ie_tipo_proced,
	'Setor/banco: '||(select CASE WHEN count(*)=0 THEN 'O setor da prescrição '||a.cd_setor_atendimento||' - '||s.ds_setor_atendimento||' não está configurado para a integração, verificar campo Usuário banco da função Estrutura atendimento'  ELSE 'OK' END  from setor_atendimento where cd_setor_atendimento = a.cd_setor_atendimento and ((upper(nm_usuario_banco) = (select max(x.nm_usuario_banco) from mmed_parametro_integracao x)) or (upper(nm_usuario_banco) = (select user )))) ie_setor_banco,
	'Setor do procedimento: '||CASE WHEN a.cd_setor_atendimento IS NULL THEN 'O item da prescrição não possui nenhum setor de execução informado, verificar na prescrição'  ELSE 'OK' END  ie_setor_proced
FROM procedimento p, prescr_medica b, prescr_procedimento a
LEFT OUTER JOIN setor_atendimento s ON (a.cd_setor_atendimento = s.cd_setor_atendimento)
WHERE a.nr_prescricao = b.nr_prescricao  and a.cd_procedimento      = p.cd_procedimento and a.ie_origem_proced     = p.ie_origem_proced;

