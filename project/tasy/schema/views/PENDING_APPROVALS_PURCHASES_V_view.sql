-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pending_approvals_purchases_v (nr_sequencia, nr_seq_proc_aprov, nr_documento, ds_tipo_documento, valor_total, ie_status, nm_solicitante, dt_liberacao, qt_dias_pendentes, nm_usuario, data_historico) AS select  a.nr_sequencia,
     a.nr_seq_proc_aprov, 
     b.nr_documento, 
     b.ds_tipo_documento, 
     obter_valor_processo_aprov(a.nr_sequencia, a.nr_seq_proc_aprov,obter_pessoa_fisica_usuario(b.nm_usuario, 'C'),0) valor_total, 
     CASE WHEN a.ie_aprov_reprov='P' THEN CASE WHEN b.ie_urgente='S' THEN  'URGENT'  ELSE 'NO_STATUS' END  WHEN a.ie_aprov_reprov='A' THEN 'APPROVED' WHEN a.ie_aprov_reprov='B' THEN 'SETTLED' WHEN a.ie_aprov_reprov='E' THEN 'FORWARDED' WHEN a.ie_aprov_reprov='R' THEN 'DISAPPROVED' END  ie_status, /* CUIDADO ENUM */
  
     coalesce(substr(obter_dados_aprov_pend(a.nr_seq_proc_aprov,b.nr_documento,b.nm_usuario,'NM'),1,255), '-') nm_solicitante, /* VALIDAR COM O MAICON */
 
     a.dt_liberacao, 
     trunc(LOCALTIMESTAMP - a.dt_liberacao) qt_dias_pendentes, /* possivel problema de interncionalizacao */
 
     b.nm_usuario, 
     a.dt_definicao data_historico 
FROM   processo_aprov_compra a, 
     w_processo_aprov_compra b 
where   a.nr_sequencia   = b.nr_sequencia 
and    a.nr_seq_proc_aprov = b.nr_seq_proc_aprov 
and a.dt_liberacao is not null 
order by b.ie_urgente desc, a.dt_liberacao asc, ie_status desc;

