-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_pls_censo_v (ie_tipo_item, cd_estabelecimento, nm_estabelecimento, nm_outorgante, cd_cgc_outorgante, nr_seq_plano, ds_plano, nm_fantasia, ie_segmentacao, ds_segmentacao, ie_tipo_contratacao, ds_tipo_contratacao, ie_franquia, ds_franquia, ie_coparticipacao, ds_coparticipacao, ie_regulamentacao, ds_regulamentacao, ie_acomodacao, ds_acomodacao, ie_participacao, ds_participacao, nr_seq_segurado, qt_idade, ie_sexo, nr_seq_contrato, ds_estipulante, nr_seq_vendedor_canal, nm_canal_venda, ie_faixa_etaria, dt_mes_ref, qt_inclusoes, qt_exclusoes, qt_migracoes, qt_inclusao_sib, qt_exclusao_sib, qt_alteracao_sib, qt_ativos, dt_referencia, nr_seq_cpt, ds_cpt, cd_doenca_cid, ds_doenca_cid) AS select	distinct 1 ie_tipo_item,
	a.cd_estabelecimento,
	a.nm_estabelecimento,
	a.nm_outorgante,
	a.cd_cgc_outorgante,
	a.nr_seq_plano,
	a.ds_plano,
	a.nm_fantasia,
	a.ie_segmentacao,
	a.ds_segmentacao,
	a.ie_tipo_contratacao,
	a.ds_tipo_contratacao,
	a.ie_franquia,
	a.ds_franquia,
	a.ie_coparticipacao,
	a.ds_coparticipacao,
	a.ie_regulamentacao,
	a.ds_regulamentacao,
	a.ie_acomodacao,
	a.ds_acomodacao,
	a.ie_participacao,
	a.ds_participacao,
	a.nr_seq_segurado,
	a.qt_idade,
	a.ie_sexo,
	a.nr_seq_contrato,
	a.ds_estipulante,
	a.nr_seq_vendedor_canal,
	a.nm_canal_venda,
	a.ie_faixa_etaria,
	a.dt_mes_ref,
	/* Alterado select para esta forma para melhoria de performance */

	coalesce((	select	max(1)
		FROM	pls_segurado
		where	last_day(dt_contratacao) = last_day(b.dt_mes)
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_inclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_rescisao) = last_day(b.dt_mes)
		and	dt_migracao is null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_exclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_migracao) = last_day(b.dt_mes)
		and	dt_rescisao is not null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_migracoes,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 1),0) qt_inclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 3),0) qt_exclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 2),0) qt_alteracao_sib,
	coalesce((	 select	max(1)
		from	pls_segurado		x
		where	x.cd_estabelecimento	= a.cd_estabelecimento
		and	x.nr_sequencia		= a.nr_seq_segurado
		and	x.dt_liberacao is not null
		and	x.dt_rescisao is null
		and	trunc(x.dt_liberacao,'Month') <= trunc(b.dt_mes,'Month')),0)	qt_ativos,
	b.dt_mes dt_referencia,
	a.nr_seq_cpt,
	a.ds_cpt,
	null cd_doenca_cid,
	null ds_doenca_cid
from	(select	distinct e.cd_estabelecimento,
		substr(obter_nome_estabelecimento(e.cd_estabelecimento),1,200) nm_estabelecimento,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= f.cd_cgc_outorgante) nm_outorgante,
		f.cd_cgc_outorgante,
		b.nr_sequencia nr_seq_plano,
		b.ds_plano,
		b.nm_fantasia,
		b.ie_segmentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1665
		and	vl_dominio	= b.ie_segmentacao)ds_segmentacao,
		b.ie_tipo_contratacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1666
		and	vl_dominio	= b.ie_tipo_contratacao)ds_tipo_contratacao,
		b.ie_franquia,
		CASE WHEN b.ie_franquia='S' THEN 'Fator moderador - Franquia'  ELSE '' END  ds_franquia,
		b.ie_coparticipacao,
		CASE WHEN b.ie_coparticipacao='S' THEN 'Fator moderador - Co-Participação'  ELSE '' END  ds_coparticipacao,
		b.ie_regulamentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2157
		and	vl_dominio	= b.ie_regulamentacao)ds_regulamentacao,
		b.ie_acomodacao,
		CASE WHEN b.ie_acomodacao='I' THEN 'Individual' WHEN b.ie_acomodacao='C' THEN 'Coletivo' WHEN b.ie_acomodacao='N' THEN 'Nenhum' END  ds_acomodacao,
		b.ie_participacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2156
		and	vl_dominio	= b.ie_participacao)ds_participacao,
		a.nr_sequencia nr_seq_segurado,
		to_number(coalesce(trunc((LOCALTIMESTAMP - trunc(c.dt_nascimento,'dd')) / 365),0)) qt_idade,
		c.ie_sexo,
		a.nr_seq_contrato,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= e.cd_cgc_estipulante
			and	e.cd_pf_estipulante is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= e.cd_pf_estipulante
			and	e.cd_cgc_estipulante is null) || ' (' || e.nr_sequencia || ')' ds_estipulante,
		a.nr_seq_vendedor_canal,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= i.cd_cgc
			and	i.cd_pessoa_fisica is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= i.cd_pessoa_fisica
			and	i.cd_cgc is null)nm_canal_venda,
		substr(pls_obter_faixa_etaria_padrao(a.nr_sequencia,'I','IG', e.cd_estabelecimento),1,10) ie_faixa_etaria,
		trunc(coalesce(h.dt_mes_competencia,j.dt_mes),'month') dt_mes_ref,
		null nr_seq_cpt,
		null ds_cpt
	FROM mes_v j, pls_outorgante f, pls_contrato e, pessoa_fisica c, pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_interf_sib g ON (a.nr_sequencia = g.nr_seq_segurado)
LEFT OUTER JOIN pls_vendedor i ON (a.nr_seq_vendedor_canal = i.nr_sequencia)
LEFT OUTER JOIN pls_lote_sib h ON (g.nr_seq_lote_sib = h.nr_sequencia)
WHERE a.nr_seq_plano		= b.nr_sequencia and a.cd_pessoa_fisica	= c.cd_pessoa_fisica and a.nr_seq_contrato	= e.nr_sequencia and a.dt_cancelamento is null and e.cd_estabelecimento	= f.cd_estabelecimento    ) a,
		mes_v b
	where	b.dt_mes	= coalesce(a.dt_mes_ref,b.dt_mes)

UNION

select	distinct 2 ie_tipo_item,
	a.cd_estabelecimento,
	a.nm_estabelecimento,
	a.nm_outorgante,
	a.cd_cgc_outorgante,
	a.nr_seq_plano,
	a.ds_plano,
	a.nm_fantasia,
	a.ie_segmentacao,
	a.ds_segmentacao,
	a.ie_tipo_contratacao,
	a.ds_tipo_contratacao,
	a.ie_franquia,
	a.ds_franquia,
	a.ie_coparticipacao,
	a.ds_coparticipacao,
	a.ie_regulamentacao,
	a.ds_regulamentacao,
	a.ie_acomodacao,
	a.ds_acomodacao,
	a.ie_participacao,
	a.ds_participacao,
	a.nr_seq_segurado,
	a.qt_idade,
	a.ie_sexo,
	a.nr_seq_contrato,
	a.ds_estipulante,
	a.nr_seq_vendedor_canal,
	a.nm_canal_venda,
	a.ie_faixa_etaria,
	a.dt_mes_ref,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_contratacao) = last_day(b.dt_mes)
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_inclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_rescisao) = last_day(b.dt_mes)
		and	dt_migracao is null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_exclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_migracao) = last_day(b.dt_mes)
		and	dt_rescisao is not null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_migracoes,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 1),0) qt_inclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 3),0) qt_exclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 2),0) qt_alteracao_sib,
	0 qt_ativos,
	b.dt_mes dt_referencia,
	a.nr_seq_cpt,
	a.ds_cpt,
	null cd_doenca_cid,
	null ds_doenca_cid
FROM mes_v b
LEFT OUTER JOIN (select	distinct e.cd_estabelecimento,
		substr(obter_nome_estabelecimento(e.cd_estabelecimento),1,200) nm_estabelecimento,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= f.cd_cgc_outorgante) nm_outorgante,
		f.cd_cgc_outorgante,
		b.nr_sequencia nr_seq_plano,
		b.ds_plano,
		b.nm_fantasia,
		b.ie_segmentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1665
		and	vl_dominio	= b.ie_segmentacao)ds_segmentacao,
		b.ie_tipo_contratacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1666
		and	vl_dominio	= b.ie_tipo_contratacao)ds_tipo_contratacao,
		b.ie_franquia,
		CASE WHEN b.ie_franquia='S' THEN 'Fator moderador - Franquia'  ELSE '' END  ds_franquia,
		b.ie_coparticipacao,
		CASE WHEN b.ie_coparticipacao='S' THEN 'Fator moderador - Co-Participação'  ELSE '' END  ds_coparticipacao,
		b.ie_regulamentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2157
		and	vl_dominio	= b.ie_regulamentacao)ds_regulamentacao,
		b.ie_acomodacao,
		CASE WHEN b.ie_acomodacao='I' THEN 'Individual' WHEN b.ie_acomodacao='C' THEN 'Coletivo' WHEN b.ie_acomodacao='N' THEN 'Nenhum' END  ds_acomodacao,
		b.ie_participacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2156
		and	vl_dominio	= b.ie_participacao)ds_participacao,
		a.nr_sequencia nr_seq_segurado,
		to_number(coalesce(trunc((LOCALTIMESTAMP - trunc(c.dt_nascimento,'dd')) / 365),0)) qt_idade,
		c.ie_sexo,
		a.nr_seq_contrato,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= e.cd_cgc_estipulante
			and	e.cd_pf_estipulante is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= e.cd_pf_estipulante
			and	e.cd_cgc_estipulante is null) || ' (' || e.nr_sequencia || ')' ds_estipulante,
		a.nr_seq_vendedor_canal,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= j.cd_cgc
			and	j.cd_pessoa_fisica is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= j.cd_pessoa_fisica
			and	j.cd_cgc is null)nm_canal_venda,
		substr(pls_obter_faixa_etaria_padrao(a.nr_sequencia,'I','IG', e.cd_estabelecimento),1,10) ie_faixa_etaria,
		trunc(coalesce(h.dt_mes_competencia,a.dt_contratacao),'month') dt_mes_ref,
		i.nr_seq_tipo_carencia nr_seq_cpt,
		(	select	ds_carencia
			from	pls_tipo_carencia	t
			where	t.nr_sequencia		= i.nr_seq_tipo_carencia) ds_cpt
		--substr(obter_descricao_padrao('PLS_TIPO_CARENCIA','DS_CARENCIA',i.nr_seq_tipo_carencia),1,255) ds_cpt
	FROM pls_outorgante f, pls_contrato e, pessoa_fisica c, pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_interf_sib g ON (a.nr_sequencia = g.nr_seq_segurado)
LEFT OUTER JOIN pls_carencia i ON (a.nr_sequencia = i.nr_seq_segurado)
LEFT OUTER JOIN pls_vendedor j ON (a.nr_seq_vendedor_canal = j.nr_sequencia)
LEFT OUTER JOIN pls_lote_sib h ON (g.nr_seq_lote_sib = h.nr_sequencia)
WHERE a.nr_seq_plano		= b.nr_sequencia and a.cd_pessoa_fisica	= c.cd_pessoa_fisica and a.nr_seq_contrato	= e.nr_sequencia and a.dt_cancelamento is null and e.cd_estabelecimento	= f.cd_estabelecimento     ) a ON (b.dt_mes = a.dt_mes_ref)
UNION

select	distinct 3 ie_tipo_item,
	a.cd_estabelecimento,
	a.nm_estabelecimento,
	a.nm_outorgante,
	a.cd_cgc_outorgante,
	a.nr_seq_plano,
	a.ds_plano,
	a.nm_fantasia,
	a.ie_segmentacao,
	a.ds_segmentacao,
	a.ie_tipo_contratacao,
	a.ds_tipo_contratacao,
	a.ie_franquia,
	a.ds_franquia,
	a.ie_coparticipacao,
	a.ds_coparticipacao,
	a.ie_regulamentacao,
	a.ds_regulamentacao,
	a.ie_acomodacao,
	a.ds_acomodacao,
	a.ie_participacao,
	a.ds_participacao,
	a.nr_seq_segurado,
	a.qt_idade,
	a.ie_sexo,
	a.nr_seq_contrato,
	a.ds_estipulante,
	a.nr_seq_vendedor_canal,
	a.nm_canal_venda,
	a.ie_faixa_etaria,
	a.dt_mes_ref,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_contratacao) = last_day(b.dt_mes)
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_inclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_rescisao) = last_day(b.dt_mes)
		and	dt_migracao is null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_exclusoes,
	coalesce((	select	max(1)
		from	pls_segurado
		where	last_day(dt_migracao) = last_day(b.dt_mes)
		and	dt_rescisao is not null
		and	nr_sequencia	= a.nr_seq_segurado),0) qt_migracoes,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 1),0) qt_inclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 3),0) qt_exclusao_sib,
	coalesce((	select	max(1)
		from	pls_interf_sib a,
			pls_lote_sib b
		where	a.nr_seq_lote_sib	= b.nr_sequencia
		and	last_day(b.dt_mes_competencia) = last_day(b.dt_mes)
		and	a.nr_seq_segurado	= a.nr_seq_segurado
		and	a.ie_tipo_reg	= 2),0) qt_alteracao_sib,
	0 qt_ativos,
	b.dt_mes dt_referencia,
	a.nr_seq_cpt,
	a.ds_cpt,
	a.cd_doenca_cid,
	a.ds_doenca_cid
FROM mes_v b
LEFT OUTER JOIN (select	distinct e.cd_estabelecimento,
		substr(obter_nome_estabelecimento(e.cd_estabelecimento),1,200) nm_estabelecimento,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= f.cd_cgc_outorgante) nm_outorgante,
		f.cd_cgc_outorgante,
		b.nr_sequencia nr_seq_plano,
		b.ds_plano,
		b.nm_fantasia,
		b.ie_segmentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1665
		and	vl_dominio	= b.ie_segmentacao)ds_segmentacao,
		b.ie_tipo_contratacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 1666
		and	vl_dominio	= b.ie_tipo_contratacao)ds_tipo_contratacao,
		b.ie_franquia,
		CASE WHEN b.ie_franquia='S' THEN 'Fator moderador - Franquia'  ELSE '' END  ds_franquia,
		b.ie_coparticipacao,
		CASE WHEN b.ie_coparticipacao='S' THEN 'Fator moderador - Co-Participação'  ELSE '' END  ds_coparticipacao,
		b.ie_regulamentacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2157
		and	vl_dominio	= b.ie_regulamentacao)ds_regulamentacao,
		b.ie_acomodacao,
		CASE WHEN b.ie_acomodacao='I' THEN 'Individual' WHEN b.ie_acomodacao='C' THEN 'Coletivo' WHEN b.ie_acomodacao='N' THEN 'Nenhum' END  ds_acomodacao,
		b.ie_participacao,
		(select	substr(ds_valor_dominio,1,255)
		from	valor_dominio
		where	cd_dominio	= 2156
		and	vl_dominio	= b.ie_participacao)ds_participacao,
		a.nr_sequencia nr_seq_segurado,
		to_number(coalesce(trunc((LOCALTIMESTAMP - trunc(c.dt_nascimento,'dd')) / 365),0)) qt_idade,
		c.ie_sexo,
		a.nr_seq_contrato,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= e.cd_cgc_estipulante
			and	e.cd_pf_estipulante is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= e.cd_pf_estipulante
			and	e.cd_cgc_estipulante is null) || ' (' || e.nr_sequencia || ')' ds_estipulante,
		a.nr_seq_vendedor_canal,
		(	select	ds_razao_social
			from	pessoa_juridica	x
			where	x.cd_cgc	= l.cd_cgc
			and	l.cd_pessoa_fisica is null
			
union

			select	nm_pessoa_fisica
			from	pessoa_fisica	y
			where	y.cd_pessoa_fisica	= l.cd_pessoa_fisica
			and	l.cd_cgc is null)nm_canal_venda,
		substr(pls_obter_faixa_etaria_padrao(a.nr_sequencia,'I','IG', e.cd_estabelecimento),1,10) ie_faixa_etaria,
		trunc(coalesce(h.dt_mes_competencia,a.dt_contratacao),'month') dt_mes_ref,
		null nr_seq_cpt,
		null ds_cpt,
		k.cd_doenca_cid,
		k.ds_doenca_cid
	FROM pls_outorgante f, pls_contrato e, pessoa_fisica c, pls_plano b, pls_segurado a
LEFT OUTER JOIN pls_interf_sib g ON (a.nr_sequencia = g.nr_seq_segurado)
LEFT OUTER JOIN pls_guia_plano i ON (a.nr_sequencia = i.nr_seq_segurado)
LEFT OUTER JOIN pls_vendedor l ON (a.nr_seq_vendedor_canal = l.nr_sequencia)
LEFT OUTER JOIN pls_lote_sib h ON (g.nr_seq_lote_sib = h.nr_sequencia)
LEFT OUTER JOIN pls_diagnostico j ON (i.nr_sequencia = j.nr_seq_guia)
LEFT OUTER JOIN cid_doenca k ON (j.cd_doenca = k.cd_doenca_cid)
WHERE a.nr_seq_plano		= b.nr_sequencia and a.cd_pessoa_fisica	= c.cd_pessoa_fisica and a.nr_seq_contrato	= e.nr_sequencia and a.dt_cancelamento is null and e.cd_estabelecimento	= f.cd_estabelecimento       ) a ON (b.dt_mes = a.dt_mes_ref);

