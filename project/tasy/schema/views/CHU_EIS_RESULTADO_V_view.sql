-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW chu_eis_resultado_v (dt_referencia, ie_periodo, cd_estabelecimento, cd_convenio, cd_setor_atendimento, ie_tipo_atendimento, dt_receita, ie_protocolo, ie_proc_mat, cd_especialidade, cd_conta_contabil, nr_seq_conta_financ, nr_seq_grupo_rec, cd_estrutura_conta, vl_procedimento, vl_material, vl_terceiro, vl_custo, vl_imposto, ie_complexidade, vl_desconto, ie_pacote, vl_original, cd_categoria, vl_hospital, qt_dia_internacao, dt_entrega, vl_repasse_calc, ie_proc_material, ie_tipo_convenio, ds_convenio, ds_ano, dt_ano, ds_grupo_receita, cd_estrutura, vl_faturado, vl_total, vl_result_pacote, vl_margem, pr_margem, cd_setor_paciente) AS select dt_referencia,
       ie_periodo,
       cd_estabelecimento,
       a.cd_convenio,
       cd_setor_atendimento,
       CASE WHEN a.cd_setor_atendimento=16 THEN 9  ELSE a.ie_tipo_atendimento END  ie_tipo_atendimento,
       dt_receita,
       ie_protocolo,
       ie_proc_mat,
       cd_especialidade,
       a.cd_conta_contabil,
       nr_seq_conta_financ,
       nr_seq_grupo_rec,
       cd_estrutura_conta,
       vl_procedimento,
       vl_material,
       vl_terceiro,
       vl_custo,
       vl_imposto,
       ie_complexidade,
       vl_desconto,
       ie_pacote,
       vl_original,
       cd_categoria,
       vl_hospital,
       qt_dia_internacao,
       dt_entrega,
       vl_repasse_calc,
       somente_numero(a.ie_proc_mat) ie_proc_material,
       b.ie_tipo_convenio,
       b.ds_convenio,
       to_char(a.dt_referencia, 'YYYY') ds_ano,
       trunc(a.dt_referencia, 'year') dt_ano,
       substr(obter_desc_grupo_rec(a.nr_seq_grupo_rec),1,200) ds_grupo_receita,
       somente_numero(a.cd_estrutura_conta) cd_estrutura,
       (a.vl_Procedimento + a.vl_Material) vl_faturado,
       (a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) vl_total,
       (a.vl_procedimento + a.vl_material - coalesce(a.vl_original,0)) vl_result_pacote,
       (a.vl_hospital -  a.vl_custo) vl_margem,
       (dividir((a.vl_Procedimento + a.vl_Material - a.vl_custo - a.vl_imposto),
      CASE WHEN(a.vl_Procedimento + a.vl_Material)=0 THEN 1  ELSE (a.vl_Procedimento + a.vl_Material) END ) * 100) pr_margem,
	a.cd_setor_paciente
FROM  convenio b,
      Eis_Resultado a
where  a.cd_convenio    = b.cd_convenio;

