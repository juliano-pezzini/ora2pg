-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pep_ocupacao_unidade_v (nr_atendimento, dt_entrada_unidade, cd_unidade, cd_unidade_basica, cd_unidade_compl, dt_entrada, nm_pessoa_fisica, cd_setor_atendimento, cd_pessoa_fisica, dt_nascimento, nr_prontuario, ie_status_unidade, ie_sexo, ds_convenio, ds_categoria, cd_paciente_reserva, nm_paciente_reserva, cd_convenio_reserva, nm_usuario_reserva, nr_crm, nm_guerra, ie_classe_acomodacao, ie_sexo_paciente, ie_sexo_fixo, ds_status_unidade, ds_observacao, qt_dia_permanencia, dt_inicio_higienizacao, dt_higienizacao, nr_seq_interno, dt_previsto_alta, dt_alta_medico, nm_usuario_higienizacao, nm_usuario_fim_higienizacao, nr_ramal, ie_temporario, ie_tipo_reserva, cd_tipo_acomodacao, ie_probabilidade_alta, ds_probabilidade, cd_psicologo, ds_ocupacao, nr_agrupamento, qt_peso_maximo, qt_altura_maxima, cd_convenio, qt_tempo_prev_higien, nr_seq_motivo_reserva, ie_acompanhante, nr_seq_apresent, ie_radioterapia, nr_atend_alta, ie_interditado_radiacao, cd_estabelecimento, nr_seq_perfil, cd_motivo_alta_medica, cd_medico_resp, ie_carater_inter_sus, cd_medico_referido, nr_seq_local_pa, ie_paciente_isolado, nr_seq_atepacu, ie_ordem) AS select 	a.nr_atendimento,
       	a.dt_entrada_unidade,
	(a.cd_unidade_basica || ' ' || a.cd_unidade_compl) cd_unidade,
        a.cd_unidade_basica,
	a.cd_unidade_compl,
        b.dt_entrada,
        substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) nm_pessoa_fisica,
        a.cd_setor_atendimento,
        e.cd_pessoa_fisica,
        e.dt_nascimento,
        --e.nr_prontuario,

	(substr(obter_prontuario_pf(b.cd_estabelecimento,b.cd_pessoa_fisica),1,255))::numeric  nr_prontuario,
        a.ie_status_unidade,
        e.ie_sexo,
        substr(obter_nome_convenio(c.cd_convenio),1,40) ds_convenio,
	substr(obter_categoria_convenio(c.cd_convenio,c.cd_categoria),1,40) ds_categoria, -- dalcastagne em 04/04/2008 os 88104
        a.cd_paciente_reserva,
        substr(obter_nome_pf(f.cd_pessoa_fisica),1,60) nm_paciente_reserva,a.cd_convenio_reserva,
	nm_usuario_reserva,
        d.nr_crm,
        d.nm_guerra,
	a.ie_classe_acomodacao,
	a.ie_sexo_paciente,
	a.ie_sexo_fixo,
	substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) ds_status_unidade,
	a.ds_observacao,
	trunc(LOCALTIMESTAMP - b.dt_entrada, 0) qt_dia_permanencia,
	dt_inicio_higienizacao,
	dt_higienizacao,
	a.nr_seq_interno,
	b.dt_previsto_alta,	
	b.dt_alta_medico,
	a.nm_usuario_higienizacao,
	a.nm_usuario_fim_higienizacao,
	a.nr_ramal,
	a.ie_temporario,
	a.ie_tipo_reserva,
	a.cd_tipo_acomodacao,
	b.ie_probabilidade_alta,
	substr(obter_valor_dominio(1267,b.ie_probabilidade_alta),1,40) ds_probabilidade,
	b.cd_psicologo,
	a.ds_ocupacao,
	a.nr_agrupamento,
	a.qt_peso_maximo,
	a.qt_altura_maxima,
	c.cd_convenio,
	a.qt_tempo_prev_higien,
	a.nr_seq_motivo_reserva,
	'N' ie_acompanhante,
	coalesce(a.nr_seq_apresent,999) nr_seq_apresent,
	coalesce(a.ie_radioterapia,'N') ie_radioterapia,
	b.nr_atend_alta,
	coalesce(a.ie_interditado_radiacao,'N') ie_interditado_radiacao,
	b.cd_estabelecimento,
	e.nr_seq_perfil,
	b.cd_motivo_alta_medica,
	b.cd_medico_resp,
	b.IE_CARATER_INTER_SUS,
	b.cd_medico_referido,
	b.NR_SEQ_LOCAL_PA,
	b.IE_PACIENTE_ISOLADO,
	obter_atepacu_paciente(b.nr_atendimento, 'A') nr_seq_atepacu,
	1 ie_ordem
FROM pessoa_fisica e, atend_categoria_convenio c, atendimento_paciente b
LEFT OUTER JOIN medico d ON (b.cd_medico_resp = d.cd_pessoa_fisica)
, unidade_atendimento a
LEFT OUTER JOIN pessoa_fisica f ON (a.cd_paciente_reserva = f.cd_pessoa_fisica)
WHERE a.nr_atendimento      	= b.nr_atendimento and a.nr_atendimento	= c.nr_atendimento and c.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento) and b.cd_pessoa_fisica    = e.cd_pessoa_fisica  and a.ie_situacao         = 'A' and a.ie_status_unidade   in ('A','P','G','H','O')  and a.nr_atendimento >0
 
union all
 
select  a.nr_atendimento_acomp,
        a.dt_entrada_unidade,
        (a.cd_unidade_basica ||' ' || a.cd_unidade_compl) cd_unidade,
        a.cd_unidade_basica,
        a.cd_unidade_compl,
      	b.dt_entrada,
        substr('Acomp ' || obter_nome_pf(e.cd_pessoa_fisica),1,40) nm_pessoa_fisica,
        a.cd_setor_atendimento,
        e.cd_pessoa_fisica,
        e.dt_nascimento,
        --e.nr_prontuario,

	(substr(obter_prontuario_pf(b.cd_estabelecimento,b.cd_pessoa_fisica),1,255))::numeric  nr_prontuario,
        a.ie_status_unidade,
        e.ie_sexo,
        substr(obter_nome_convenio(c.cd_convenio),1,40) ds_convenio,
	substr(obter_categoria_convenio(c.cd_convenio,c.cd_categoria),1,40) ds_categoria, -- dalcastagne em 04/04/2008 os 88104
        a.cd_paciente_reserva,
        substr(obter_nome_pf(f.cd_pessoa_fisica),1,60) nm_paciente_reserva,
	a.cd_convenio_reserva,
	nm_usuario_reserva,
        d.nr_crm,
        d.nm_guerra,
	a.ie_classe_acomodacao,
	a.ie_sexo_paciente,
	a.ie_sexo_fixo,
	'Acomp ' || substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) ds_status_unidade,
	a.ds_observacao,
	trunc(LOCALTIMESTAMP - b.dt_entrada, 0) qt_dia_permanencia,
	dt_inicio_higienizacao,
	dt_higienizacao,
	a.nr_seq_interno,
	b.dt_previsto_alta,
	b.dt_alta_medico,
	a.nm_usuario_higienizacao,
	a.nm_usuario_fim_higienizacao,
	a.nr_ramal,
	a.ie_temporario,
	a.ie_tipo_reserva,
	a.cd_tipo_acomodacao,
	b.ie_probabilidade_alta,
	substr(obter_valor_dominio(1267,b.ie_probabilidade_alta),1,40) ds_probabilidade,
	b.cd_psicologo,
	a.ds_ocupacao,
	a.nr_agrupamento,
	a.qt_peso_maximo,         
	a.qt_altura_maxima,
	c.cd_convenio cd_convenio,
	a.qt_tempo_prev_higien,
	a.nr_seq_motivo_reserva,
	'S' ie_acompanhante,
	coalesce(a.nr_seq_apresent,999) nr_seq_apresent,
	coalesce(a.ie_radioterapia,'N') ie_radioterapia,
	b.nr_atend_alta,
	coalesce(a.ie_interditado_radiacao,'N') ie_interditado_radiacao,
	b.cd_estabelecimento,
	e.nr_seq_perfil,
	b.cd_motivo_alta_medica,
	b.cd_medico_resp,
	b.IE_CARATER_INTER_SUS,
	b.cd_medico_referido,
	b.NR_SEQ_LOCAL_PA,
	b.IE_PACIENTE_ISOLADO,
	obter_atepacu_paciente(b.nr_atendimento, 'A') nr_seq_atepacu,
	1 ie_ordem
FROM pessoa_fisica f, pessoa_fisica e, atend_categoria_convenio c, unidade_atendimento a, atendimento_paciente b
LEFT OUTER JOIN medico d ON (b.cd_medico_resp = d.cd_pessoa_fisica)
WHERE a.nr_atendimento_acomp= b.nr_atendimento and b.cd_pessoa_fisica    = e.cd_pessoa_fisica and a.nr_atendimento	= c.nr_atendimento and c.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)  and a.ie_situacao         = 'A' and a.ie_status_unidade   = 'M' and a.cd_paciente_reserva = f.cd_pessoa_fisica and a.nr_atendimento >0
 
union all

select 	a.nr_atendimento_ant nr_atendimento,
       	a.dt_entrada_unidade,
	(a.cd_unidade_basica || ' ' || a.cd_unidade_compl) cd_unidade,
        a.cd_unidade_basica,
	a.cd_unidade_compl,
        b.dt_entrada,
        substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) nm_pessoa_fisica,
        a.cd_setor_atendimento,
        e.cd_pessoa_fisica,
        e.dt_nascimento,
        --e.nr_prontuario,

	(substr(obter_prontuario_pf(b.cd_estabelecimento,b.cd_pessoa_fisica),1,255))::numeric  nr_prontuario,
        a.ie_status_unidade,
        e.ie_sexo,
        substr(obter_nome_convenio(c.cd_convenio),1,40) ds_convenio,
	substr(obter_categoria_convenio(c.cd_convenio,c.cd_categoria),1,40) ds_categoria, -- dalcastagne em 04/04/2008 os 88104
        a.cd_paciente_reserva,
        substr(obter_nome_pf(f.cd_pessoa_fisica),1,60) nm_paciente_reserva,
	a.cd_convenio_reserva,
	nm_usuario_reserva,
        d.nr_crm,
        d.nm_guerra,
	a.ie_classe_acomodacao,
	a.ie_sexo_paciente,
	a.ie_sexo_fixo,
	substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) ds_status_unidade,
	a.ds_observacao,
	trunc(LOCALTIMESTAMP - b.dt_entrada, 0) qt_dia_permanencia,
	dt_inicio_higienizacao,
	dt_higienizacao,
	a.nr_seq_interno,
	b.dt_previsto_alta,	
	b.dt_alta_medico,
	a.nm_usuario_higienizacao,
	a.nm_usuario_fim_higienizacao,
	a.nr_ramal,
	a.ie_temporario,
	a.ie_tipo_reserva,
	a.cd_tipo_acomodacao,
	b.ie_probabilidade_alta,
	substr(obter_valor_dominio(1267,b.ie_probabilidade_alta),1,40) ds_probabilidade,
	b.cd_psicologo,
	a.ds_ocupacao,
	a.nr_agrupamento,
	a.qt_peso_maximo,         
	a.qt_altura_maxima,
	c.cd_convenio,
	a.qt_tempo_prev_higien,
	a.nr_seq_motivo_reserva,
	'N' ie_acompanhante,
	coalesce(a.nr_seq_apresent,999) nr_seq_apresent,
	coalesce(a.ie_radioterapia,'N') ie_radioterapia,
	b.nr_atend_alta,
	coalesce(a.ie_interditado_radiacao,'N') ie_interditado_radiacao,
	b.cd_estabelecimento,
	e.nr_seq_perfil,
	b.cd_motivo_alta_medica,
	b.cd_medico_resp,
	b.IE_CARATER_INTER_SUS,
	b.cd_medico_referido,
	b.NR_SEQ_LOCAL_PA,
	b.IE_PACIENTE_ISOLADO,
	obter_atepacu_paciente(b.nr_atendimento, 'A') nr_seq_atepacu,
	1 ie_ordem
FROM parametro_medico pm, pessoa_fisica e, atend_categoria_convenio c, atendimento_paciente b
LEFT OUTER JOIN medico d ON (b.cd_medico_resp = d.cd_pessoa_fisica)
, unidade_atendimento a
LEFT OUTER JOIN pessoa_fisica f ON (a.cd_paciente_reserva = f.cd_pessoa_fisica)
WHERE a.nr_atendimento_ant      	= b.nr_atendimento and a.nr_atendimento_ant	= c.nr_atendimento and c.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento_ant) and b.cd_pessoa_fisica    = e.cd_pessoa_fisica  and a.ie_situacao         = 'A' and a.ie_status_unidade   = 'A'  and a.nr_atendimento_ant >0 and a.nr_atendimento_ant is not null and a.nr_atendimento is null and b.dt_alta is not null and pm.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento and coalesce(pm.ie_pac_proc_alta_setor,'S') = 'S'
 
union all

select 	b.nr_atendimento,
       	a.dt_entrada_unidade,
	(a.cd_unidade_basica || ' ' || a.cd_unidade_compl) cd_unidade,
        a.cd_unidade_basica,
	a.cd_unidade_compl,
        b.dt_entrada,
        substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) nm_pessoa_fisica,
        a.cd_setor_atendimento,
        e.cd_pessoa_fisica,
        e.dt_nascimento,
        --e.nr_prontuario,

	(substr(obter_prontuario_pf(b.cd_estabelecimento,b.cd_pessoa_fisica),1,255))::numeric  nr_prontuario,
        a.ie_status_unidade,
        e.ie_sexo,
        substr(obter_nome_convenio(c.cd_convenio),1,40) ds_convenio,
	substr(obter_categoria_convenio(c.cd_convenio,c.cd_categoria),1,40) ds_categoria, -- dalcastagne em 04/04/2008 os 88104
        a.cd_paciente_reserva,
        substr(obter_nome_pf(f.cd_pessoa_fisica),1,60) nm_paciente_reserva,
	a.cd_convenio_reserva,
	nm_usuario_reserva,
        d.nr_crm,
        d.nm_guerra,
	a.ie_classe_acomodacao,
	a.ie_sexo_paciente,
	a.ie_sexo_fixo,
	substr(obter_nome_pf(e.cd_pessoa_fisica),1,60) ds_status_unidade,
	a.ds_observacao,
	trunc(LOCALTIMESTAMP - b.dt_entrada, 0) qt_dia_permanencia,
	dt_inicio_higienizacao,
	dt_higienizacao,
	a.nr_seq_interno,
	b.dt_previsto_alta,	
	b.dt_alta_medico,
	a.nm_usuario_higienizacao,
	a.nm_usuario_fim_higienizacao,
	a.nr_ramal,
	a.ie_temporario,
	a.ie_tipo_reserva,
	a.cd_tipo_acomodacao,
	b.ie_probabilidade_alta,
	substr(obter_valor_dominio(1267,b.ie_probabilidade_alta),1,40) ds_probabilidade,
	b.cd_psicologo,
	a.ds_ocupacao,
	a.nr_agrupamento,
	a.qt_peso_maximo,         
	a.qt_altura_maxima,
	c.cd_convenio,
	a.qt_tempo_prev_higien,
	a.nr_seq_motivo_reserva,
	'N' ie_acompanhante,
	coalesce(a.nr_seq_apresent,999) nr_seq_apresent,
	coalesce(a.ie_radioterapia,'N') ie_radioterapia,
	b.nr_atend_alta,
	coalesce(a.ie_interditado_radiacao,'N') ie_interditado_radiacao,
	b.cd_estabelecimento,
	e.nr_seq_perfil,
	b.cd_motivo_alta_medica,
	b.cd_medico_resp,
	b.IE_CARATER_INTER_SUS,
	b.cd_medico_referido,
	b.NR_SEQ_LOCAL_PA,
	b.IE_PACIENTE_ISOLADO,
	obter_atepacu_paciente(b.nr_atendimento, 'A') nr_seq_atepacu,
	2 ie_ordem
FROM atendimento_paciente y, setor_atendimento x, atend_paciente_unidade u, setor_atendimento t, pessoa_fisica e, atend_categoria_convenio c, atendimento_paciente b
LEFT OUTER JOIN medico d ON (b.cd_medico_resp = d.cd_pessoa_fisica)
, unidade_atendimento a
LEFT OUTER JOIN pessoa_fisica f ON (a.cd_paciente_reserva = f.cd_pessoa_fisica)
WHERE a.nr_atendimento      	= y.nr_atendimento and y.nr_atendimento		= b.nr_atendimento_mae and a.nr_atendimento	= c.nr_atendimento and c.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento) and b.cd_pessoa_fisica    = e.cd_pessoa_fisica  and u.nr_atendimento = b.nr_atendimento and u.nr_seq_interno = (select Obter_Atepacu_paciente(b.nr_atendimento, 'A') ) and t.cd_setor_atendimento = u.cd_setor_atendimento and b.dt_alta_interno     = to_date('30/12/2999', 'DD/MM/YYYY') and a.ie_situacao         = 'A' and a.ie_status_unidade   in ('P','G','H') and x.cd_setor_atendimento	= a.cd_setor_atendimento and x.ie_rn_mae				= 'S'  and t.cd_classif_setor = '9' and a.nr_atendimento >0 and b.dt_cancelamento is null;

