-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cih_cirurgia_v (ie_origem_inf, dt_ficha, dt_alta, ds_cirurgia, cd_medico_cirurgiao, cd_tipo_cirurgia, ie_asa_estado_paciente, nm_medico_cir, ds_tipo_cirurgia, ds_asa, qt_todos, qt_nao_infec, qt_infectados, qt_ih, qt_ic, cd_empresa, ie_carater_cirurgia, ds_caracter_cirurgia, ie_aval_banho, ds_aval_banho, ie_aval_antissepsia, ds_aval_antissepsia, ie_aval_degermacao, ds_aval_degermacao, ie_aval_tricotomia, ds_aval_tricotomia, ie_aval_higiene_oral, ds_aval_higiene_oral, ds_implante, ie_implante, qt_caso_infeccao, cd_especialidade, ds_especialidade, qt_especialidade_princ, cd_especialidade_adic, ds_especialidade_adic, qt_especialidade_adic, qt_antibiotico_profilatico, ie_antibiotico, ie_aval_medic_prof, ds_aval_medic_prof, cd_setor_atendimento, ds_setor_atendimento, cd_topografia, ds_topografia, cd_estabelecimento) AS select	distinct
	1 ie_origem_inf, 
	a.dt_ficha, 
	null dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	0 qt_ih, 
	0 qt_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	0 qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct d.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN d.ie_antibiotico='S' THEN  d.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	null cd_setor_atendimento, 
	null ds_setor_atendimento,		 
	null cd_topografia, 
	null ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia d ON (c.nr_seq_cirurgia_pac = d.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (d.nr_prescricao = e.nr_prescricao)
WHERE a.dt_cancelamento is null group by a.dt_ficha, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	d.cd_procedimento_princ, 
	d.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	obter_estab_atend(a.nr_atendimento) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	0 nr_ih, 
	0 nr_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	count(distinct CASE WHEN b.cd_caso_infeccao IS NULL THEN  null  ELSE b.nr_sequencia||b.cd_caso_infeccao END ) qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct d.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN d.ie_antibiotico='S' THEN  d.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	b.cd_setor_atendimento, 
	obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento,	 
	b.cd_topografia, 
	obter_desc_topografia(b.cd_topografia) ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia d ON (c.nr_seq_cirurgia_pac = d.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (d.nr_prescricao = e.nr_prescricao)
WHERE cd_topografia is null and a.dt_cancelamento is null group by a.dt_ficha, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	d.cd_procedimento_princ, 
	d.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	b.cd_setor_atendimento, 
	b.cd_topografia, 
	obter_estab_atend(a.nr_atendimento) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	0, 
	0,	 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=1 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) + 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=2 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ),	 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=1 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) nr_ih, 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=2 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) nr_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	count(distinct CASE WHEN b.cd_caso_infeccao IS NULL THEN  null  ELSE b.nr_sequencia END ) qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(f.cd_procedimento_princ, f.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(f.cd_procedimento_princ, f.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct f.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN f.ie_antibiotico='S' THEN  f.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	f.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	b.cd_setor_atendimento, 
	obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento, 
	b.cd_topografia, 
	obter_desc_topografia(b.cd_topografia) ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM cih_caso_infeccao d, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia f ON (c.nr_seq_cirurgia_pac = f.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (f.nr_prescricao = e.nr_prescricao)
WHERE b.cd_caso_infeccao	= 	d.cd_caso_infeccao   and cd_topografia is not null and a.dt_cancelamento is null group by a.dt_ficha, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	f.cd_procedimento_princ, 
	f.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	f.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	b.cd_setor_atendimento, 
	b.cd_topografia, 
	obter_estab_atend(a.nr_atendimento) 

union
 
select	distinct 1 ie_origem_inf, 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	0 nr_ih, 
	0 nr_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	0 qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct d.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN d.ie_antibiotico='S' THEN  d.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	null cd_setor_atendimento, 
	null ds_setor_atendimento,	 
	null cd_topografia, 
	null ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia d ON (c.nr_seq_cirurgia_pac = d.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (d.nr_prescricao = e.nr_prescricao)
WHERE a.nr_atendimento    =  	g.nr_atendimento    and a.dt_cancelamento is null group by g.dt_alta, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	d.cd_procedimento_princ, 
	d.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	obter_estab_atend(a.nr_atendimento) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	0 nr_ih, 
	0 nr_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	count(b.nr_sequencia||b.cd_caso_infeccao) qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(d.cd_procedimento_princ, d.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct d.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN d.ie_antibiotico='S' THEN  d.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	b.cd_setor_atendimento, 
	obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento, 
	b.cd_topografia, 
	obter_desc_topografia(b.cd_topografia) ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia d ON (c.nr_seq_cirurgia_pac = d.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (d.nr_prescricao = e.nr_prescricao)
WHERE a.nr_atendimento    =  	g.nr_atendimento     and cd_topografia is null and a.dt_cancelamento is null group by g.dt_alta, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	d.cd_procedimento_princ, 
	d.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	d.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	b.cd_topografia, 
	b.cd_setor_atendimento, 
	obter_estab_atend(a.nr_atendimento) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	initcap(c.ds_cirurgia) ds_cirurgia, 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40) nm_medico_cir, 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60) ds_tipo_cirurgia, 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente) ds_asa, 
	0, 
	0, 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=1 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) + 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=2 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ), 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=1 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) nr_ih, 
	count(distinct CASE WHEN coalesce(d.ie_tipo_caso, b.cd_caso_infeccao)=2 THEN  a.nr_ficha_ocorrencia||f.nr_cirurgia||b.nr_sequencia  ELSE null END ) nr_ic, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa, 
	c.ie_carater_cirurgia, 
	substr(obter_valor_dominio(1016, c.ie_carater_cirurgia),1,255) ds_caracter_cirurgia, 
	c.ie_aval_banho, 
	CASE WHEN c.ie_aval_banho='C' THEN 'Correto' WHEN c.ie_aval_banho='I' THEN 'Ignorado' WHEN c.ie_aval_banho='IN' THEN 'Incorreto' WHEN c.ie_aval_banho='NR' THEN  'Não Realizado' END  ds_aval_banho, 
	c.ie_aval_antissepsia, 
	CASE WHEN c.ie_aval_antissepsia='C' THEN  'Correto' WHEN c.ie_aval_antissepsia='I' THEN  'Ignorado' WHEN c.ie_aval_antissepsia='IN' THEN  'Incorreto' WHEN c.ie_aval_antissepsia='NR' THEN  'Não Realizado' END  ds_aval_antissepsia, 
	c.ie_aval_degermacao, 
	CASE WHEN c.ie_aval_degermacao='C' THEN  'Correto' WHEN c.ie_aval_degermacao='I' THEN  'Ignorado' WHEN c.ie_aval_degermacao='IN' THEN  'Incorreto' WHEN c.ie_aval_degermacao='NR' THEN  'Não Realizado' END  ds_aval_degermacao, 
	c.ie_aval_tricotomia, 
	CASE WHEN c.ie_aval_tricotomia='C' THEN  'Correto' WHEN c.ie_aval_tricotomia='I' THEN  'Ignorado' WHEN c.ie_aval_tricotomia='IN' THEN  'Incorreto' WHEN c.ie_aval_tricotomia='NR' THEN  'Não Realizado' END  ds_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	CASE WHEN c.ie_aval_higiene_oral='C' THEN  'Correto' WHEN c.ie_aval_higiene_oral='I' THEN  'Ignorado' WHEN c.ie_aval_higiene_oral='IN' THEN  'Incorreto' WHEN c.ie_aval_higiene_oral='NR' THEN  'Não Realizado' END  ds_aval_higiene_oral, 
	CASE WHEN c.ie_ortese_protese='S' THEN  'Sim' WHEN c.ie_ortese_protese='N' THEN  'Não' END  ds_implante, 
	c.ie_ortese_protese ie_implante, 
	count(distinct b.nr_sequencia||b.cd_caso_infeccao) qt_caso_infeccao, 
	substr(obter_dados_estrut_proc(f.cd_procedimento_princ, f.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade, 
	substr(obter_dados_estrut_proc(f.cd_procedimento_princ, f.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade, 
	count(distinct f.nr_cirurgia) qt_especialidade_princ, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'C', 'E'),1,254) cd_especialidade_adic, 
	substr(obter_dados_estrut_proc(e.cd_procedimento, e.ie_origem_proced, 'D', 'E'),1,254) ds_especialidade_adic, 
	count(distinct e.nr_prescricao||e.nr_sequencia) qt_especialidade_adic, 
	count(distinct CASE WHEN f.ie_antibiotico='S' THEN  f.nr_cirurgia  ELSE null END ) qt_antibiotico_profilatico, 
	f.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	CASE WHEN c.ie_aval_medic_prof='C' THEN  'Correto' WHEN c.ie_aval_medic_prof='I' THEN  'Ignorado' WHEN c.ie_aval_medic_prof='IN' THEN  'Incorreto' WHEN c.ie_aval_medic_prof='NR' THEN  'Não Realizado' END  ds_aval_medic_prof, 
	b.cd_setor_atendimento, 
	obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento, 
	b.cd_topografia, 
	obter_desc_topografia(b.cd_topografia) ds_topografia, 
	obter_estab_atend(a.nr_atendimento) cd_estabelecimento 
FROM atendimento_paciente g, cih_caso_infeccao d, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_cirurgia c ON (a.nr_ficha_ocorrencia = c.nr_ficha_ocorrencia)
LEFT OUTER JOIN cirurgia f ON (c.nr_seq_cirurgia_pac = f.nr_cirurgia)
LEFT OUTER JOIN prescr_procedimento e ON (f.nr_prescricao = e.nr_prescricao)
WHERE a.nr_atendimento    =  	g.nr_atendimento and b.cd_caso_infeccao	= 	d.cd_caso_infeccao     and cd_topografia is not null and a.dt_cancelamento is null group by g.dt_alta, 
	initcap(c.ds_cirurgia), 
	c.cd_medico_cirurgiao, 
	c.cd_tipo_cirurgia, 
	c.ie_asa_estado_paciente, 
	substr(obter_nome_medico(c.cd_medico_cirurgiao, 'N'),1,40), 
	substr(obter_desc_tipo_cirurgia(c.cd_tipo_cirurgia),1,60), 
	obter_valor_dominio(1287,c.ie_asa_estado_paciente), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)), 
	c.ie_carater_cirurgia, 
	c.ie_aval_banho, 
	c.ie_aval_antissepsia, 
	c.ie_aval_degermacao, 
	c.ie_aval_tricotomia, 
	c.ie_aval_higiene_oral, 
	c.ie_ortese_protese, 
	f.cd_procedimento_princ, 
	f.ie_origem_proced, 
	e.cd_procedimento, 
	e.ie_origem_proced, 
	f.ie_antibiotico, 
	c.ie_aval_medic_prof, 
	b.cd_topografia, 
	b.cd_setor_atendimento, 
	obter_estab_atend(a.nr_atendimento);

