-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW fis_hsjgdl_reporte_diot (ie_tipo_terceiro, ie_tipo_operacao_mx, cd_rfc, cd_internacional, nm_estrangeiro, sg_pais, ds_nacionalidade, vl_total_nota, vl_baixa, vl_mercadoria, vl_campo_8, vl_campo_9, vl_campo_10, vl_campo_11, vl_campo_12, vl_campo_13, vl_campo_14, vl_campo_15, vl_campo_16, vl_campo_17, vl_campo_18, vl_campo_19, vl_campo_20, vl_campo_21, vl_campo_22, nr_titulo, nota, dt_baixa, nr_lote_contabil, nr_seq_cheque_cp, nr_seq_diot, cd_cgc, ie_union) AS select  y.ie_tipo_terceiro,
	y.ie_tipo_operacao_mx,
	y.cd_rfc,
	y.cd_internacional,
	Elimina_Acentos(y.nm_estrangeiro) nm_estrangeiro,
	Elimina_Acentos(y.sg_pais) sg_pais,
	elimina_acentos(y.ds_nacionalidade) ds_nacionalidade,
	trunc(sum(y.vl_total_nota)) vl_total_nota,
	trunc(sum(y.vl_baixa)) vl_baixa,
	trunc(sum(y.vl_mercadoria)) vl_mercadoria,
	trunc(sum(y.vl_campo_8))  vl_campo_8,
	trunc(sum(y.vl_campo_9))  vl_campo_9,
	trunc(sum(y.vl_campo_10)) vl_campo_10,
	trunc(sum(y.vl_campo_11)) vl_campo_11,
	trunc(sum(y.vl_campo_12)) vl_campo_12,
	trunc(sum(y.vl_campo_13)) vl_campo_13,
	trunc(sum(y.vl_campo_14)) vl_campo_14,
	trunc(sum(y.vl_campo_15)) vl_campo_15,
	trunc(sum(y.vl_campo_16)) vl_campo_16,
	trunc(sum(y.vl_campo_17)) vl_campo_17,
	trunc(sum(y.vl_campo_18)) vl_campo_18,
	trunc(sum(y.vl_campo_19)) vl_campo_19,
	trunc(sum(y.vl_campo_20)) vl_campo_20,
	trunc(sum(y.vl_campo_21)) vl_campo_21,
	trunc(sum(y.vl_campo_22)) vl_campo_22,
	y.nr_titulo, y.nota, y.dt_baixa,
	y.nr_lote_contabil,
	replace(y.nr_seq_cheque_cp,',',null)nr_seq_cheque_cp,
	y.nr_seq_diot,
	y.cd_cgc,
	y.ie_union
FROM (
select 	CASE WHEN t.ie_internacional='N' THEN '04'  ELSE '05' END  ie_tipo_terceiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE j.cd_internacional END  cd_internacional,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE Elimina_Acentos(j.ds_razao_social) END  nm_estrangeiro,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE e.sg_pais END  sg_pais,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE obter_nome_pais(e.nr_sequencia) END   ds_nacionalidade,
	max(c.vl_total_nota) vl_total_nota,
	sum(y.vl_baixa) vl_baixa,
	max(c.vl_mercadoria) vl_mercadoria,
	CASE WHEN y.nr_tit_receber IS NULL THEN  fis_obter_dados_iva(c.nr_sequencia, 1) END  vl_campo_8,
	(null)::numeric  vl_campo_9,
	(null)::numeric  vl_campo_10,
	(null)::numeric  vl_campo_11,
	(null)::numeric  vl_campo_12,
	(null)::numeric  vl_campo_13,
	(null)::numeric  vl_campo_14,
	(null)::numeric  vl_campo_15,
	(null)::numeric  vl_campo_16,
	(null)::numeric  vl_campo_17,
	(null)::numeric  vl_campo_18,
	fis_obter_dados_iva(c.nr_sequencia, 3) vl_campo_19,
	fis_obter_dados_iva(c.nr_sequencia, 2) vl_campo_20,
	fis_obter_dados_iva(c.nr_sequencia, 5) vl_campo_21,
	fis_obter_dados_iva(c.nr_sequencia, 6, z.dt_ref_inicial, fim_dia(z.dt_ref_final)) vl_campo_22,
	y.nr_titulo,
	x.nr_seq_nota_fiscal nota,
	trunc(y.dt_baixa) dt_baixa,
	y.nr_lote_contabil,
	coalesce(obter_cheque_bordero(y.nr_bordero),y.nr_seq_cheque_cp) nr_seq_cheque_cp,
	z.nr_sequencia nr_seq_diot,
	j.cd_cgc,
	'1' ie_union
FROM fis_diot_controle z, titulo_pagar_baixa y, titulo_pagar x, tipo_pessoa_juridica t, estabelecimento h, nota_fiscal c, operacao_nota b, pessoa_juridica j
LEFT OUTER JOIN pais e ON (j.nr_seq_pais = e.nr_sequencia)
WHERE b.cd_operacao_nf = c.cd_operacao_nf  and x.nr_titulo = y.nr_titulo and x.nr_seq_nota_fiscal = c.nr_sequencia --and	trunc(y.dt_baixa) between dt_inicio_p and dt_fim_p
  and y.nr_seq_baixa_origem is null and not exists ( 	select 	1
			from   	titulo_pagar_baixa q
			where  	q.nr_titulo = x.nr_titulo
			and  	nr_seq_baixa_origem is not null
			and    	nr_seq_baixa_origem = y.nr_sequencia) and t.cd_tipo_pessoa = j.cd_tipo_pessoa and c.ie_situacao = 1 and c.ie_tipo_nota in ('EN','EF') and j.cd_cgc = x.cd_cgc --and	c.cd_estabelecimento 	= cd_estabelecimento_p
--and	h.cd_empresa 		= cd_empresa_p
  and c.cd_estabelecimento 	= h.cd_estabelecimento /*and 	(((y.nr_seq_cheque_cp is null) and (trunc(y.dt_baixa) between dt_inicio_p and dt_fim_p)) or
	((y.nr_seq_cheque_cp is not null) and
	(select nvl(max(1),0) from cheque where nr_sequencia = y.nr_seq_cheque_cp and dt_compensacao between dt_inicio_p and dt_fim_p) = 1))*/
  and ((exists (select 1
		from 	cheque_bordero_titulo a,
			titulo_pagar_bordero_v b,
			cheque c
		where 	a.nr_bordero = b.nr_bordero
		and 	a.nr_seq_cheque = c.nr_sequencia
		and 	b.nr_titulo = x.nr_titulo
		and     c.dt_cancelamento is null
		and 	c.dt_compensacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
		
union

		select 	1
		from 	cheque d
		where 	d.nr_sequencia = y.nr_seq_cheque_cp
		and     d.dt_cancelamento is null
		and 	d.dt_compensacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final)))
	 or (not exists (select 1
			from 	cheque_bordero_titulo a,
				titulo_pagar_bordero_v b,
				cheque c
			where 	a.nr_bordero = b.nr_bordero
			and 	a.nr_seq_cheque = c.nr_sequencia
			and 	b.nr_titulo = x.nr_titulo
			and	c.dt_atualizacao > LOCALTIMESTAMP - interval '365 days'
			and     c.dt_cancelamento is null
			
union

			select 	1
			from 	cheque d
			where 	d.nr_sequencia = y.nr_seq_cheque_cp
			and     d.dt_cancelamento is null
			and	d.dt_atualizacao > LOCALTIMESTAMP - interval '365 days')
		and trunc(y.dt_baixa) between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
		and  y.nr_tit_receber is null)) group by t.ie_internacional,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	j.cd_internacional,
	j.ds_razao_social,
	e.sg_pais,
	y.nr_tit_receber,
	e.nr_sequencia,
	c.nr_sequencia,
	y.nr_titulo,
	x.nr_seq_nota_fiscal,
	trunc(y.dt_baixa),
	y.nr_lote_contabil,
	coalesce(obter_cheque_bordero(y.nr_bordero),y.nr_seq_cheque_cp),
	z.dt_ref_inicial,
	z.dt_ref_final,
	z.nr_sequencia,
	j.cd_cgc

union all

select CASE WHEN e.ie_brasileiro='S' THEN  '04'  ELSE '05' END  ie_tipo_terceiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	CASE WHEN e.ie_brasileiro='N' THEN  j.nr_cartao_estrangeiro  ELSE null END  cd_internacional,
	CASE WHEN e.ie_brasileiro='N' THEN  Elimina_Acentos(substr(j.nm_pessoa_fisica, 1, 43), null) END  nm_estrangeiro,
	CASE WHEN e.ie_brasileiro='N' THEN  substr(p.sg_pais,1,2)  ELSE null END  sg_pais,
	CASE WHEN e.ie_brasileiro='N' THEN  e.ds_nacionalidade  ELSE null END  ds_nacionalidade,
	max(c.vl_total_nota) vl_total_nota,
	sum(y.vl_baixa) vl_baixa,
	max(c.vl_mercadoria) vl_mercadoria,
	CASE WHEN y.nr_tit_receber IS NULL THEN  fis_obter_dados_iva(c.nr_sequencia, 1) END  vl_campo_8,
	(null)::numeric  vl_campo_9,
	(null)::numeric  vl_campo_10,
	(null)::numeric  vl_campo_11,
	(null)::numeric  vl_campo_12,
	(null)::numeric  vl_campo_13,
	(null)::numeric  vl_campo_14,
	(null)::numeric  vl_campo_15,
	(null)::numeric  vl_campo_16,
	(null)::numeric  vl_campo_17,
	(null)::numeric  vl_campo_18,
	fis_obter_dados_iva(c.nr_sequencia, 3) vl_campo_19,
	fis_obter_dados_iva(c.nr_sequencia, 2) vl_campo_20,
	fis_obter_dados_iva(c.nr_sequencia, 5) vl_campo_21,
	fis_obter_dados_iva(c.nr_sequencia, 6, z.dt_ref_inicial, fim_dia(z.dt_ref_final)) vl_campo_22,
	y.nr_titulo,
	x.nr_seq_nota_fiscal nota,
	trunc(y.dt_baixa) dt_baixa,
	y.nr_lote_contabil,
	coalesce(obter_cheque_bordero(y.nr_bordero),y.nr_seq_cheque_cp) nr_seq_cheque_cp,
	z.nr_sequencia nr_seq_diot,
	j.cd_pessoa_fisica cd_cgc,
	'2' ie_union
FROM fis_diot_controle z, titulo_pagar_baixa y, titulo_pagar x, estabelecimento h, nota_fiscal c, operacao_nota b, pessoa_fisica j
LEFT OUTER JOIN nacionalidade e ON (j.cd_nacionalidade = e.cd_nacionalidade)
, obter_dados_pf_pj(j
LEFT OUTER JOIN pais p ON (obter_dados_pf_pj(j.cd_pessoa_fisica, null, 'CPAIS') = p.cd_codigo_pais)
WHERE b.cd_operacao_nf = c.cd_operacao_nf   and x.nr_titulo = y.nr_titulo and x.nr_seq_nota_fiscal = c.nr_sequencia --and	trunc(y.dt_baixa) between dt_inicio_p and dt_fim_p
  and y.nr_seq_baixa_origem is null and not exists ( 	select 	1
			from   	titulo_pagar_baixa q
			where  	q.nr_titulo = x.nr_titulo
			and  	nr_seq_baixa_origem is not null
			and    	nr_seq_baixa_origem = y.nr_sequencia) and c.ie_situacao = 1 and c.ie_tipo_nota in ('EN','EF') and j.cd_pessoa_fisica = x.cd_pessoa_fisica --and	c.cd_estabelecimento 	= cd_estabelecimento_p
--and	h.cd_empresa 		= cd_empresa_p
  and c.cd_estabelecimento 	= h.cd_estabelecimento /*and 	((y.nr_seq_cheque_cp is null) or
	((y.nr_seq_cheque_cp is not null) and
	(select nvl(max(1),0) from cheque where nr_sequencia = y.nr_seq_cheque_cp and dt_compensacao is not null) = 1))*/
  and ((exists (select 1
		from 	cheque_bordero_titulo a,
			titulo_pagar_bordero_v b,
			cheque c
		where 	a.nr_bordero = b.nr_bordero
		and 	a.nr_seq_cheque = c.nr_sequencia
		and 	b.nr_titulo = x.nr_titulo
		and     c.dt_cancelamento is null
		and 	c.dt_compensacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
		
union

		select 	1
		from 	cheque d
		where 	d.nr_sequencia = y.nr_seq_cheque_cp
		and     d.dt_cancelamento is null
		and 	d.dt_compensacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final)))
	 or (not exists (select 1
			from 	cheque_bordero_titulo a,
				titulo_pagar_bordero_v b,
				cheque c
			where 	a.nr_bordero = b.nr_bordero
			and 	a.nr_seq_cheque = c.nr_sequencia
			and 	b.nr_titulo = x.nr_titulo
			and	c.dt_atualizacao > LOCALTIMESTAMP - interval '365 days'
			and     c.dt_cancelamento is null
			
union

			select 	1
			from 	cheque d
			where 	d.nr_sequencia = y.nr_seq_cheque_cp
			and     d.dt_cancelamento is null
			and	d.dt_atualizacao > LOCALTIMESTAMP - interval '365 days')
		and trunc(y.dt_baixa) between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
		and  y.nr_tit_receber is null)) group by e.ie_brasileiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	j.nr_cartao_estrangeiro,
	j.nm_pessoa_fisica,
	p.sg_pais,
	y.nr_tit_receber,
	e.ds_nacionalidade,
	c.nr_sequencia,
	y.nr_titulo,
	x.nr_seq_nota_fiscal,
	trunc(y.dt_baixa),
	y.nr_lote_contabil,
	coalesce(obter_cheque_bordero(y.nr_bordero),y.nr_seq_cheque_cp),
	z.dt_ref_inicial,
	z.dt_ref_final,
	z.nr_sequencia,
	j.cd_pessoa_fisica

union

select 	CASE WHEN t.ie_internacional='N' THEN '04'  ELSE '05' END  ie_tipo_terceiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE j.cd_internacional END  cd_internacional,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE Elimina_Acentos(j.ds_razao_social) END  nm_estrangeiro,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE e.sg_pais END  sg_pais,
	CASE WHEN t.ie_internacional='N' THEN  null  ELSE obter_nome_pais(e.nr_sequencia) END   ds_nacionalidade,
	max(c.vl_total_nota) vl_total_nota,
	sum(y.vl_adiantamento) vl_baixa,
	max(c.vl_mercadoria) vl_mercadoria,
	fis_obter_dados_iva(c.nr_sequencia, 1) vl_campo_8,
	(null)::numeric  vl_campo_9,
	(null)::numeric  vl_campo_10,
	(null)::numeric  vl_campo_11,
	(null)::numeric  vl_campo_12,
	(null)::numeric  vl_campo_13,
	(null)::numeric  vl_campo_14,
	(null)::numeric  vl_campo_15,
	(null)::numeric  vl_campo_16,
	(null)::numeric  vl_campo_17,
	(null)::numeric  vl_campo_18,
	fis_obter_dados_iva(c.nr_sequencia, 3) vl_campo_19,
	fis_obter_dados_iva(c.nr_sequencia, 2) vl_campo_20,
	fis_obter_dados_iva(c.nr_sequencia, 5) vl_campo_21,
	fis_obter_dados_iva(c.nr_sequencia, 6, z.dt_ref_inicial, fim_dia(z.dt_ref_final)) vl_campo_22,
	y.nr_titulo,
	x.nr_seq_nota_fiscal nota,
	trunc(y.dt_atualizacao) dt_baixa,
	null,
	null,
	z.nr_sequencia nr_seq_diot,
	j.cd_cgc,
	'3' ie_union
FROM fis_diot_controle z, titulo_pagar_adiant y, titulo_pagar x, tipo_pessoa_juridica t, estabelecimento h, nota_fiscal c, operacao_nota b, pessoa_juridica j
LEFT OUTER JOIN pais e ON (j.nr_seq_pais = e.nr_sequencia)
WHERE b.cd_operacao_nf = c.cd_operacao_nf  and x.nr_titulo = y.nr_titulo and x.nr_seq_nota_fiscal = c.nr_sequencia --and	trunc(y.dt_atualizacao) between dt_inicio_p and dt_fim_p
  and y.dt_atualizacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final) /*and    	y.nr_seq_baixa_origem is null
and	not exists( 	select 	1
			from   	titulo_pagar_baixa q
			where  	q.nr_titulo = x.nr_titulo
			and  	nr_seq_baixa_origem is not null
			and    	nr_seq_baixa_origem = y.nr_sequencia)*/
  and t.cd_tipo_pessoa = j.cd_tipo_pessoa and c.ie_situacao = 1 and c.ie_tipo_nota in ('EN','EF') and j.cd_cgc = x.cd_cgc --and	c.cd_estabelecimento 	= cd_estabelecimento_p
--and	h.cd_empresa 		= cd_empresa_p
  and c.cd_estabelecimento 	= h.cd_estabelecimento /*and 	((y.nr_seq_cheque_cp is null) or
	((y.nr_seq_cheque_cp is not null) and
	(select nvl(max(1),0) from cheque where nr_sequencia = y.nr_seq_cheque_cp and dt_compensacao is not null) = 1))*/
 group by t.ie_internacional,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	j.cd_internacional,
	j.ds_razao_social,
	e.sg_pais,
	e.nr_sequencia,
	c.nr_sequencia,
	y.nr_titulo,
	x.nr_seq_nota_fiscal,
	trunc(y.dt_atualizacao),
	z.dt_ref_inicial,
	z.dt_ref_final,
	z.nr_sequencia,
	j.cd_cgc

union all

select CASE WHEN e.ie_brasileiro='S' THEN  '04'  ELSE '05' END  ie_tipo_terceiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	CASE WHEN e.ie_brasileiro='N' THEN  j.nr_cartao_estrangeiro  ELSE null END  cd_internacional,
	CASE WHEN e.ie_brasileiro='N' THEN  Elimina_Acentos(substr(j.nm_pessoa_fisica, 1, 43), null) END  nm_estrangeiro,
	CASE WHEN e.ie_brasileiro='N' THEN  substr(p.sg_pais,1,2)  ELSE null END  sg_pais,
	CASE WHEN e.ie_brasileiro='N' THEN  e.ds_nacionalidade  ELSE null END  ds_nacionalidade,
	max(c.vl_total_nota) vl_total_nota,
	sum(y.vl_adiantamento) vl_baixa,
	max(c.vl_mercadoria) vl_mercadoria,
	fis_obter_dados_iva(c.nr_sequencia, 1) vl_campo_8,
	(null)::numeric  vl_campo_9,
	(null)::numeric  vl_campo_10,
	(null)::numeric  vl_campo_11,
	(null)::numeric  vl_campo_12,
	(null)::numeric  vl_campo_13,
	(null)::numeric  vl_campo_14,
	(null)::numeric  vl_campo_15,
	(null)::numeric  vl_campo_16,
	(null)::numeric  vl_campo_17,
	(null)::numeric  vl_campo_18,
	fis_obter_dados_iva(c.nr_sequencia, 3) vl_campo_19,
	fis_obter_dados_iva(c.nr_sequencia, 2) vl_campo_20,
	fis_obter_dados_iva(c.nr_sequencia, 5) vl_campo_21,
	fis_obter_dados_iva(c.nr_sequencia, 6, z.dt_ref_inicial, fim_dia(z.dt_ref_final)) vl_campo_22,
	y.nr_titulo,
	x.nr_seq_nota_fiscal nota,
	trunc(y.dt_atualizacao) dt_baixa,
	null,
	null,
	z.nr_sequencia nr_seq_diot,
	'' cd_cgc,
	'4' ie_union
FROM fis_diot_controle z, titulo_pagar_adiant y, titulo_pagar x, estabelecimento h, nota_fiscal c, operacao_nota b, pessoa_fisica j
LEFT OUTER JOIN nacionalidade e ON (j.cd_nacionalidade = e.cd_nacionalidade)
, obter_dados_pf_pj(j
LEFT OUTER JOIN pais p ON (obter_dados_pf_pj(j.cd_pessoa_fisica, null, 'CPAIS') = p.cd_codigo_pais)
WHERE b.cd_operacao_nf = c.cd_operacao_nf   and x.nr_titulo = y.nr_titulo and x.nr_seq_nota_fiscal = c.nr_sequencia --and	trunc(y.dt_atualizacao) between dt_inicio_p and dt_fim_p
  and y.dt_atualizacao between z.dt_ref_inicial and fim_dia(z.dt_ref_final) /*and    	y.nr_seq_baixa_origem is null
and	not exists( 	select 	1
			from   	titulo_pagar_baixa q
			where  	q.nr_titulo = x.nr_titulo
			and  	nr_seq_baixa_origem is not null
			and    	nr_seq_baixa_origem = y.nr_sequencia)*/
  and c.ie_situacao = 1 and c.ie_tipo_nota in ('EN','EF') and j.cd_pessoa_fisica = x.cd_pessoa_fisica --and	c.cd_estabelecimento 	= cd_estabelecimento_p
--and	h.cd_empresa 		= cd_empresa_p
  and c.cd_estabelecimento 	= h.cd_estabelecimento /*and 	((y.nr_seq_cheque_cp is null) or
	((y.nr_seq_cheque_cp is not null) and
	(select nvl(max(1),0) from cheque where nr_sequencia = y.nr_seq_cheque_cp and dt_compensacao is not null) = 1))*/
 group by e.ie_brasileiro,
	b.ie_tipo_operacao_mx,
	j.cd_rfc,
	j.nr_cartao_estrangeiro,
	j.nm_pessoa_fisica,
	p.sg_pais,
	e.ds_nacionalidade,
	c.nr_sequencia,
	y.nr_titulo,
	x.nr_seq_nota_fiscal,
	trunc(y.dt_atualizacao),
	z.dt_ref_inicial,
	z.dt_ref_final,
	z.nr_sequencia,
	''

union
 -------começo union 5
	select  CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  '04'  ELSE '05' END  ie_tipo_terceiro,
	'85',
	max(OBTER_DADOS_PF_PJ(mtf.cd_pessoa_fisica,mtf.cd_cgc,'RFC')) cd_rfc,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'CINT') END  cd_internacional,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE elimina_acentos(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'N')) END  nm_estrangeiro,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'P'),'SG') END  sg_pais,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'P'),'N') END   ds_nacionalidade,
	0 vl_total_nota,
	0 vl_baixa,
	0 vl_mercadoria,
	(mtf.vl_transacao / 1.16) vl_campo_8,
	null vl_campo_9,
	null vl_campo_10,
	null vl_campo_11,
	null vl_campo_12,
	null vl_campo_13,
	null vl_campo_14,
	null vl_campo_15,
	null vl_campo_16,
	null vl_campo_17,
	null vl_campo_18,
	null vl_campo_19,
	null vl_campo_20,
	null vl_campo_21,
	null vl_campo_22,
	null nr_titulo,
	null nota,
	trunc(mtf.dt_transacao) dt_baixa,
	null,
	null,
	z.nr_sequencia nr_seq_diot,
	coalesce(mtf.cd_cgc,mtf.cd_pessoa_fisica) cd_cgc,
	'5' ie_union
from 	movto_trans_financ mtf,
	fis_diot_controle z
where	trunc(mtf.dt_transacao) between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
and 	mtf.nr_seq_trans_financ in (
					select  distinct
						nr_seq_transacao
					from 	fis_diot_regras
					)
group by trunc(mtf.dt_transacao),
	mtf.vl_transacao,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  '04'  ELSE '05' END ,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'CINT') END ,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE elimina_acentos(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'N')) END  ,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'P'),'SG') END ,
	CASE WHEN obter_se_pj_internacional(mtf.cd_cgc)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(mtf.cd_pessoa_fisica,mtf.cd_cgc,'P'),'N') END ,
	z.nr_sequencia,	-------final union 5,
	coalesce(mtf.cd_cgc,mtf.cd_pessoa_fisica)

union
    -- começo union 6
	select  CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='S' THEN  '05'  ELSE '04' END  ie_tipo_terceiro,
	'85' ie_tipo_operacao_mx,
	max(OBTER_DADOS_PF_PJ(null,c.cd_cgc_agencia,'RFC')) cd_rfc,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pf_pj(null,c.cd_cgc_agencia,'CINT') END  cd_internacional,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE elimina_acentos(obter_dados_pf_pj(null,c.cd_cgc_agencia,'N')) END  nm_estrangeiro,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(null,c.cd_cgc_agencia,'P'),'SG') END  sg_pais,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(null,c.cd_cgc_agencia,'P'),'N') END   ds_nacionalidade,
	0 vl_total_nota,
	0 vl_baixa,
	0 vl_mercadoria,
	CASE WHEN(select count(*) from fis_diot_controle_banc WHERE nr_seq_controle = z.nr_sequencia and nr_seq_trans_iva_acred  = mtf.nr_seq_trans_financ)=1 THEN  mtf.vl_transacao  ELSE 0 END vl_campo_8,
	null vl_campo_9,
	null vl_campo_10,
	null vl_campo_11,
	null vl_campo_12,
	null vl_campo_13,
	null vl_campo_14,
	null vl_campo_15,
	null vl_campo_16,
	null vl_campo_17,
	null vl_campo_18,
	0  vl_campo_19,
	CASE WHEN(select count(*) from fis_diot_controle_banc WHERE nr_seq_controle = z.nr_sequencia and nr_seq_trans_base_imp = mtf.nr_seq_trans_financ)=1 THEN  mtf.vl_transacao  ELSE 0 END vl_campo_20,
	0 vl_campo_21,
	0 vl_campo_22,
	null nr_titulo,
	null  nota,
	trunc(mtf.dt_transacao) dt_baixa,
	null,
	null,
	z.nr_sequencia nr_seq_diot,
	c.cd_cgc_agencia cd_cgc,
	'6' ie_union
from 	movto_trans_financ mtf,
	banco_estabelecimento_v b,
	agencia_bancaria c,
	fis_diot_controle z
where	trunc(mtf.dt_transacao) between z.dt_ref_inicial and fim_dia(z.dt_ref_final)
and	b.cd_banco = c.cd_banco
and	b.nr_sequencia = mtf.nr_seq_banco
and 	(mtf.nr_seq_trans_financ =	(select  nr_seq_trans_base_imp from fis_diot_controle_banc where nr_seq_controle = z.nr_sequencia)
      or mtf.nr_seq_trans_financ =  (select  nr_seq_trans_iva_acred from fis_diot_controle_banc where nr_seq_controle = z.nr_sequencia))
group by mtf.nr_seq_trans_financ,
	mtf.vl_transacao,
	trunc(mtf.dt_transacao),
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='S' THEN  '05'  ELSE '04' END ,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pf_pj(null,c.cd_cgc_agencia,'CINT') END ,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE elimina_acentos(obter_dados_pf_pj(null,c.cd_cgc_agencia,'N')) END ,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(null,c.cd_cgc_agencia,'P'),'SG') END ,
	CASE WHEN obter_se_pj_internacional(c.cd_cgc_agencia)='N' THEN  null  ELSE obter_dados_pais(obter_dados_pf_pj(null,c.cd_cgc_agencia,'P'),'N') END ,
	z.nr_sequencia,
	c.cd_cgc_agencia	-- fim union 6
	) y
group	by	y.ie_tipo_terceiro,
		y.ie_tipo_operacao_mx,
		y.cd_rfc,
		y.cd_internacional,
		y.nm_estrangeiro,
		y.sg_pais,
		y.ds_nacionalidade,
		y.nr_titulo,
		y.nota,
		y.dt_baixa,
		y.nr_lote_contabil,
		y.nr_seq_cheque_cp,
		y.nr_seq_diot,
		y.cd_cgc,
		y.ie_union
order by y.cd_rfc;

