-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mapa_dieta_v (nr_sequencia, cd_pessoa_fisica, dt_dieta, cd_refeicao, ie_destino_dieta, ie_status, dt_atualizacao, nm_usuario, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_dieta, ds_observacao, nr_atendimento, qt_parametro, ds_observacao_tec, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_superior, dt_liberacao, nm_usuario_lib, ie_forma_geracao, nr_seq_tipo_jejum, dt_inicio_jejum, dt_fim_jejum, nr_prescricao, nr_seq_local_ref, ie_tipo_dieta, ds_refeicao, ds_classe_acomodacao, ds_destino, ds_acomodacao_etiq, ds_idade, ds_idade_anos, ds_idade_abrev, nm_pessoa_fisica, nm_dieta, cd_unidade, hr_atualizacao, qt_paciente, qt_acompanhante, ds_tipo_acomodacao, ds_dados_convenio, ds_obs_tec, ds_local_ref, ds_alerta, nm_curto, ds_anotacao, nr_seq_opcao_cardapio) AS select  a.nr_sequencia,
	a.cd_pessoa_fisica,
	a.dt_dieta,
	a.cd_refeicao,
	a.ie_destino_dieta,
	a.ie_status,
	a.dt_atualizacao,
	a.nm_usuario,
	a.cd_setor_atendimento,
	a.cd_unidade_basica,
	a.cd_unidade_compl,
	a.cd_dieta,
	a.ds_observacao,
	a.nr_atendimento,
	a.qt_parametro,
	a.ds_observacao_tec,
	a.dt_atualizacao_nrec,
	a.nm_usuario_nrec,
	a.nr_seq_superior,
	a.dt_liberacao,
	a.nm_usuario_lib,
	a.ie_forma_geracao,
	a.nr_seq_tipo_jejum,
	a.dt_inicio_jejum,
	a.dt_fim_jejum,
	a.nr_prescricao,
	a.nr_seq_local_ref,
	coalesce(b.ie_tipo_dieta,a.ie_tipo_dieta) ie_tipo_dieta,
	obter_valor_dominio(99, a.cd_refeicao) ds_refeicao,
	CASE WHEN c.ie_classe_acomodacao='I' THEN 'Individual' WHEN c.ie_classe_acomodacao='C' THEN 'Coletivo' END  ds_classe_acomodacao,
	CASE WHEN a.ie_destino_dieta='P' THEN 'Paciente' WHEN a.ie_destino_dieta='A' THEN 'Acompanhante' END  ds_destino,
	CASE WHEN s.cd_classif_setor=3 THEN (a.cd_unidade_basica || ' ' ||a.cd_unidade_compl) WHEN s.cd_classif_setor=4 THEN (a.cd_unidade_basica || ' ' ||a.cd_unidade_compl)  ELSE s.ds_setor_atendimento END  ds_acomodacao_etiq,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'C'),1,20) ds_idade,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'A'),1,20) || ' a' ds_idade_anos,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'S'),1,20) ds_idade_abrev,
	substr(obter_nome_pf(p.cd_pessoa_fisica),1,60) nm_pessoa_fisica,
     	 b.nm_dieta,
     	 (a.cd_unidade_basica || ' ' ||a.cd_unidade_compl) cd_unidade,
     	 (to_char(a.dt_atualizacao,'dd/mm hh24:mi')) hr_atualizacao,
	CASE WHEN a.ie_destino_dieta='P' THEN 1  ELSE 0 END  qt_paciente,
	CASE WHEN a.ie_destino_dieta='A' THEN 1  ELSE 0 END  qt_acompanhante,
	substr(obter_desc_tipo_acomod(c.cd_tipo_acomodacao),1,100) ds_tipo_acomodacao,
	substr(obter_dados_conv_mapa_dieta(a.nr_sequencia),1,240) ds_dados_convenio,
	substr(a.ds_observacao_tec,1,2000) ds_obs_tec,
	substr(obter_desc_local_refeicao(a.nr_seq_local_ref), 1, 255) ds_local_ref,
	substr(obter_desc_nut_alerta(p.cd_pessoa_fisica),1,255) ds_alerta	,
	b.nm_curto,
	a.ds_anotacao,
	a.nr_seq_opcao_cardapio
FROM setor_atendimento s, pessoa_fisica p, unidade_atendimento c, mapa_dieta a
LEFT OUTER JOIN dieta b ON (a.cd_dieta = b.cd_dieta)
WHERE a.cd_pessoa_fisica       = p.cd_pessoa_fisica  and a.cd_unidade_basica      = c.cd_unidade_basica and a.cd_unidade_compl       = c.cd_unidade_compl and a.cd_setor_atendimento	 = c.cd_setor_atendimento and a.cd_setor_atendimento   = s.cd_setor_atendimento;

