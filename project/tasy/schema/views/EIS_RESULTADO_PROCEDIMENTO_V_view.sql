-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_resultado_procedimento_v (nr_sequencia, nr_interno_conta, dt_referencia, ie_tipo_atendimento, cd_convenio, dt_atualizacao, vl_medico, vl_medico_fora_conta, vl_material, vl_diaria, vl_sadt_fora_conta, vl_custo, vl_custo_variavel, vl_imposto, vl_procedimento, vl_item, vl_receita, vl_repasse_terceiro, vl_desconto, cd_procedimento, ie_origem_proced, cd_proc_pacote, ie_orig_proc_pacote, vl_original, cd_medico, cd_especialidade, qt_dia_internacao, vl_custo_dir_apoio, vl_custo_mao_obra, vl_custo_direto, vl_custo_indireto, vl_despesa, vl_glosa, vl_desc_financ, vl_repasse_calc, ie_clinica_alta, vl_custo_sadt, vl_custo_hm, ie_status_protocolo, vl_consignado, vl_nao_consignado, dt_receita, cd_setor_atendimento, nr_seq_exame, nr_cirurgia, ie_clinica, ie_complexidade_sus, vl_custo_excluido, ie_proc_mat, nr_seq_grupo_rec, cd_estrutura_conta, vl_glosado, vl_adicional, vl_amenor, vl_custo_mat, ds_agenda_cir, cd_agenda_cir, ie_carater_cirurgia, cd_conta_contabil, cd_centro_custo_setor, dt_entrada, dt_alta, cd_plano_convenio, cd_estab_atend, cd_grupo, ds_grupo, cd_subgrupo, ds_subgrupo, cd_forma_organizacao, ds_forma_organizacao, ie_complexidade, cd_convenio_atend, ds_especialidade, ie_tipo_protocolo, ds_clinica_alta, cd_pessoa_fisica, nm_paciente, ds_procedimento, ds_proc_pacote, nm_medico, ds_convenio, vl_faturado, vl_resultado, pr_resultado, vl_margem_contrib, pr_margem, vl_result_pacote, vl_original_res, cd_estabelecimento, ds_setor_atendimento, cd_setor_atend, ds_grupo_proc, ds_categoria, ds_plano, ds_estabelecimento, ie_cirurgico, ds_carater_cir, ds_cirurgico, ds_clinica, cd_cid, ds_cid, ie_tipo_procedimento, ds_tipo_procedimento, ie_protocolo, nr_seq_protocolo, nr_atendimento, ie_carater_inter_sus, ds_carater_inter_sus, cd_especialidade_proc, ds_especialidade_proc, vl_resultado_sem_rep, ds_centro_custo, cd_especialidade_atend, ds_especialidade_atend, ie_tipo_convenio, ds_tipo_convenio) AS select	/*+ index (EISCOPA_I1 e) + index (CONPACI_ESTABEL_FK_I b) */
	e.nr_sequencia,
	e.nr_interno_conta,
	e.dt_referencia,
	e.ie_tipo_atendimento,
	e.cd_convenio,
	e.dt_atualizacao,
	e.vl_medico,
	e.vl_medico_fora_conta,
	e.vl_material,
	e.vl_diaria,
	e.vl_sadt_fora_conta,
	e.vl_custo,
	e.vl_custo_variavel,
	e.vl_imposto,
	e.vl_procedimento,
	e.vl_item,
	e.vl_receita,
	e.vl_repasse_terceiro,
	e.vl_desconto,
	e.cd_procedimento,
	e.ie_origem_proced,
	e.cd_proc_pacote,
	e.ie_orig_proc_pacote,
	e.vl_original,
	e.cd_medico,
	e.cd_especialidade,
	e.qt_dia_internacao,
	e.vl_custo_dir_apoio,
	e.vl_custo_mao_obra,
	e.vl_custo_direto,
	e.vl_custo_indireto,
	e.vl_despesa,
	e.vl_glosa,
	e.vl_desc_financ,
	e.vl_repasse_calc,
	e.ie_clinica_alta,
	e.vl_custo_sadt,
	e.vl_custo_hm,
	e.ie_status_protocolo,
	e.vl_consignado,
	e.vl_nao_consignado,
	e.dt_receita,
	e.cd_setor_atendimento,
	e.nr_seq_exame,
	e.nr_cirurgia,
	e.ie_clinica,
	e.ie_complexidade_sus,
	e.vl_custo_excluido,
	e.ie_proc_mat,
	e.nr_seq_grupo_rec,
	e.cd_estrutura_conta,
	e.vl_glosado,
	e.vl_adicional,
	e.vl_amenor,
	e.vl_custo_mat,
	e.ds_agenda_cir,
	e.cd_agenda_cir,
	e.ie_carater_cirurgia,
	e.cd_conta_contabil,
	e.cd_centro_custo_setor,
	e.dt_entrada,
	e.dt_alta,
	e.cd_plano_convenio,
	e.cd_estab_atend,
	e.cd_grupo,
	e.ds_grupo,
	e.cd_subgrupo,
	e.ds_subgrupo,
	e.cd_forma_organizacao,
	e.ds_forma_organizacao,
	e.ie_complexidade,
	e.cd_convenio_atend,
	(select coalesce(Obter_Desc_Espec_medica(e.cd_especialidade), WHEB_MENSAGEM_PCK.get_texto(55174)) ) ds_especialidade,
	(select obter_status_conta_protocolo(e.nr_interno_conta, 0, 0) ) ie_tipo_protocolo,
	substr(coalesce(obter_valor_dominio(1166, e.ie_clinica_alta),WHEB_MENSAGEM_PCK.get_texto(281290)),1,200) ds_clinica_alta,
	(select Obter_Pessoa_Conta(e.nr_interno_conta, 'C') ) cd_pessoa_fisica,
	(select Obter_Pessoa_Conta(e.nr_interno_conta, 'N') ) || ' - ' || b.nr_atendimento nm_paciente,
      	(select substr(coalesce(obter_desc_estrut_proc(null, null, null, e.cd_procedimento, e.ie_origem_proced), WHEB_MENSAGEM_PCK.get_texto(55174)),1,60) ) ds_procedimento,
       (select substr(obter_desc_estrut_proc(null, null, null, e.cd_proc_pacote, e.ie_orig_proc_pacote),1,60) ) ds_proc_pacote,
	(select substr(obter_nome_pessoa_fisica(e.cd_medico, null),1,200) ) nm_medico,
	substr(obter_nome_convenio(e.cd_convenio),1,200) ds_convenio,
	(e.vl_receita + vl_repasse_terceiro) vl_faturado,
	(e.vl_receita  + vl_repasse_terceiro - e.vl_imposto - e.vl_custo) vl_resultado,
	(e.vl_receita  + vl_repasse_terceiro - e.vl_imposto - e.vl_custo) * 100 /
		(e.vl_receita + vl_repasse_terceiro) pr_resultado,
	(e.vl_receita  + vl_repasse_terceiro - e.vl_imposto - e.vl_custo_variavel) vl_margem_contrib,
	(e.vl_receita  + vl_repasse_terceiro - e.vl_imposto - e.vl_custo_variavel) * 100 /
		(e.vl_receita + vl_repasse_terceiro) pr_margem,
        (e.vl_receita - coalesce(vl_original,0)) vl_Result_pacote,
	(coalesce(e.vl_original,0)) vl_original_res,
	b.cd_estabelecimento,
	(select Obter_Unidade_Atendimento(b.nr_atendimento,'P','S') ) ds_setor_atendimento,
	(select Obter_Unidade_Atendimento(b.nr_atendimento,'P','CS') ) cd_setor_atend,
	(select substr(obter_grupo_procedimento(e.cd_procedimento, e.ie_origem_proced, 'D'),1,240) ) ds_grupo_proc,
	substr(obter_nome_convenio(e.cd_convenio) || ' - ' || obter_categoria_convenio(e.cd_convenio, b.cd_categoria_parametro),1,200) ds_categoria,
	substr(obter_nome_convenio(e.cd_convenio) || ' - ' || OBTER_PLANO_CONVENIO_ATEND(b.nr_atendimento, 'D'),1,200) ds_plano,
	substr(obter_nome_estabelecimento(b.cd_estabelecimento),1,80) ds_estabelecimento,
	CASE WHEN coalesce(e.nr_cirurgia,0)=0 THEN 'N'  ELSE 'S' END  ie_cirurgico,
	CASE WHEN coalesce(e.nr_cirurgia,0)=0 THEN  WHEB_MENSAGEM_PCK.get_texto(1072749)  ELSE substr(coalesce(obter_valor_dominio(1016, obter_dados_cirurgia(coalesce(e.nr_cirurgia,0), 'CR')),WHEB_MENSAGEM_PCK.get_texto(55174)),1,60) END  ds_carater_cir,
	CASE WHEN coalesce(e.nr_cirurgia,0)=0 THEN WHEB_MENSAGEM_PCK.get_texto(779656)  ELSE WHEB_MENSAGEM_PCK.get_texto(779654) END  ds_cirurgico,
	(select substr(Obter_Clinica_Atendimento(b.nr_atendimento),1,100) ) ds_clinica,
	(select substr(Obter_Cid_Atendimento(b.nr_atendimento, 'P'),1,10) ) cd_cid,
	substr(OBTER_DESC_CID(Obter_Cid_Atendimento(b.nr_atendimento, 'P')),1,230) ds_cid,
	somente_numero(Obter_tipo_procedimento(e.cd_procedimento,e.ie_origem_proced,'C')) ie_tipo_procedimento,
	substr(Obter_tipo_procedimento(e.cd_procedimento,e.ie_origem_proced,'D'),1,200) ds_tipo_procedimento,
	(select obter_status_conta_protocolo(b.nr_interno_conta,b.ie_status_acerto,b.nr_seq_protocolo) ) ie_protocolo,
	b.nr_Seq_protocolo,
	b.nr_atendimento,	 
	sus_obter_carater_inter_atend(b.nr_atendimento) ie_carater_inter_sus,
	substr(coalesce(obter_valor_dominio(802, sus_obter_carater_inter_atend(b.nr_atendimento)), WHEB_MENSAGEM_PCK.get_texto(55174)),1,200) ds_carater_inter_sus,
	(select coalesce(obter_especialidade_proced(e.cd_procedimento,e.ie_origem_proced), 0) ) cd_especialidade_proc,
	(select coalesce(obter_desc_espec_proc(obter_especialidade_proced(e.cd_procedimento,e.ie_origem_proced)), WHEB_MENSAGEM_PCK.get_texto(55174)) ) ds_especialidade_proc,
	coalesce(e.vl_receita + e.vl_repasse_terceiro,0) - coalesce(e.vl_custo,0) - coalesce(e.vl_repasse_calc,0) vl_resultado_sem_rep,
	substr(obter_desc_centro_custo(e.cd_centro_custo_setor),1,200) ds_centro_custo,
	e.cd_especialidade_atend,
	(select coalesce(Obter_Desc_Espec_medica(e.cd_especialidade_atend), WHEB_MENSAGEM_PCK.get_texto(55174)) ) ds_especialidade_atend,
	e.ie_tipo_convenio,
	e.ds_tipo_convenio
from   	conta_paciente b, 
	eis_conta_paciente e
where	e.nr_interno_conta = b.nr_interno_conta;

