-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_promosoft_v (cd_registro, cd_tipo_registro, ie_identificador, nr_seq_registro, nr_prescricao, dt_inicio, dt_fim, cd_setor, ds_amostra, nm_paciente, dt_idade, nr_seq_dia, cd_pessoa_fisica, ie_sexo, dt_prescricao, ie_tipo_requisitor, cd_requisitor, ds_dado_clinico, nr_seq_exame, cd_exame, nr_seq_material, ds_resultados) AS select	0 cd_registro,
	'H' cd_tipo_registro,
	0 ie_identificador,
	'0001' nr_seq_registro,
	nr_prescricao,
	min(dt_prescricao) dt_inicio,
	max(dt_prescricao) dt_fim,
	'001' cd_setor,
	' ' ds_amostra,
	' ' nm_paciente,
	' ' dt_idade,
	' ' nr_seq_dia,
	' ' cd_pessoa_fisica,
	' ' ie_sexo,
	LOCALTIMESTAMP dt_prescricao,
	' ' ie_tipo_requisitor,
	' ' cd_requisitor,
	' ' ds_dado_clinico,
	0 nr_seq_exame,
	'' cd_exame,
	0 nr_seq_material,
	' ' ds_resultados
FROM	prescr_medica a
where	exists (select 1 from prescr_procedimento b
		where a.nr_prescricao = b.nr_prescricao
		  and b.nr_seq_exame is not null
		  and b.dt_integracao is null
		  and Obter_Equipamento_Exame(b.nr_seq_exame,null,'PROMO') is not null)
group by nr_prescricao

union

select	1 cd_registro,
	'P' cd_tipo_registro,
	1 ie_identificador,
	'0001' nr_seq_registro,
	a.nr_prescricao,
	LOCALTIMESTAMP,
	LOCALTIMESTAMP,
	' ' cd_setor,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
--	lpad(a.nr_prescricao,10,'0') ds_amostra,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'DI') dt_idade,
	'0' nr_seq_dia,
	c.cd_pessoa_fisica,
	c.ie_sexo,
	b.dt_prescricao,
	'A' ie_tipo_requisitor,
	'1' cd_requisitor,
	b.ds_dado_clinico,
	0 nr_seq_exame,
	'' cd_exame,
	0 nr_seq_material,
	' ' ds_resultados
from 	pessoa_fisica c,
	prescr_medica b,
	prescr_procedimento a,
	lab_parametro f
where a.nr_prescricao = b.nr_prescricao
  and b.cd_estabelecimento = f.cd_estabelecimento
  and b.cd_pessoa_fisica = c.cd_pessoa_fisica
  and a.nr_seq_exame is not null
  and a.dt_integracao is null
  and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null

union

select	2 cd_registro,
	'E' cd_tipo_registro,
	1 ie_identificador,
	'0001' nr_seq_registro,
	a.nr_prescricao,
	LOCALTIMESTAMP,
	LOCALTIMESTAMP,
	'' cd_setor,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
--	lpad(a.nr_prescricao,10,'0') ds_amostra,
	' ' nm_paciente,
	' ' dt_idade,
	' ' nr_seq_dia,
	' ' cd_pessoa_fisica,
	' ' ie_sexo,
	LOCALTIMESTAMP dt_prescricao,
	' ' ie_tipo_requisitor,
	' ' cd_requisitor,
	' ' ds_dado_clinico,
	a.nr_seq_exame,
	coalesce(substr(Obter_Equipamento_Exame(a.nr_seq_exame, null, 'PROMO'),1,10),coalesce(cd_exame_integracao,c.cd_exame)) cd_exame,
	d.nr_sequencia nr_seq_material,
	'||' ds_resultados
from 	material_exame_lab d,
	exame_laboratorio c,
	prescr_procedimento a,
	prescr_medica b,
	lab_parametro f
where a.nr_prescricao = b.nr_prescricao
  and a.nr_seq_exame = c.nr_seq_exame
  and a.cd_material_exame = d.cd_material_exame
  and b.cd_estabelecimento = f.cd_estabelecimento
  and a.dt_integracao is null
  and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null

union

select	9 cd_registro,
	'T' cd_tipo_registro,
	2 ie_identificador,
	'0001' nr_seq_registro,
	nr_prescricao,
	LOCALTIMESTAMP,
	LOCALTIMESTAMP,
	'001' cd_setor,
	' ' ds_amostra,
	' ' nm_paciente,
	' ' dt_idade,
	' ' nr_seq_dia,
	' ' cd_pessoa_fisica,
	' ' ie_sexo,
	dt_prescricao,
	' ' ie_tipo_requisitor,
	' ' cd_requisitor,
	' ' ds_dado_clinico,
	0 nr_seq_exame,
	'' cd_exame,
	0 nr_seq_material,
	' ' ds_resultados
from	prescr_medica a
where	exists (select 1 from prescr_procedimento b
		where a.nr_prescricao = b.nr_prescricao
		  and b.nr_seq_exame is not null
		  and b.dt_integracao is null
		  and Obter_Equipamento_Exame(b.nr_seq_exame,null,'PROMO') is not null);

