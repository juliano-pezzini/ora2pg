-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_tub_v (ie_tipo_registro, nr_seq_protocolo, nr_interno_conta, cd_interno, cd_regional, nr_lote, nr_doc_convenio, ie_tipo_documento, dt_emissao, dt_entrada, dt_alta, hr_entrada, hr_alta, cd_usuario_convenio, nm_usuario_convenio, uf_medico_solicitante, cd_medico_solicitante, cd_doenca_def, cd_motivo_alta, ie_carater_internacao, cd_procedimento_princ, cd_tipo_acomodacao, ie_clinica, cd_tipo_plano, dt_procedimento, hr_procedimento, ie_cirurgia_video, cd_medico_executor, ie_funcao_executor, cd_item, ie_cirurgia_multipla, ie_tipo_nascimento, ie_sexo, dt_nascimento, dt_mesano_referencia, qt_item, vl_item, qt_filme, vl_filme, vl_custo_operacional, vl_medico, ds_zeros, ds_espaco, ds_reg_trailer, cd_senha, ie_tipo_item) AS SELECT	1 ie_tipo_registro,
	a.nr_seq_protocolo,
	a.nr_interno_conta,
 	a.cd_interno,
 	c.cd_regional,
 	c.nr_remessa nr_lote,
 	lpad(substr(b.nr_doc_convenio,1,7),7, '0') nr_doc_convenio,
 	a.ie_tipo_atendimento ie_tipo_documento,
 	a.dt_entrada dt_emissao,
	to_char(a.dt_entrada,'ddmmyyyy') dt_entrada,
	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy') dt_alta,
	to_char(a.dt_entrada,'hh24mi') hr_entrada,
	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi') hr_alta,
 	substr(a.cd_usuario_convenio,1,15) cd_usuario_convenio,
 	substr(a.nm_paciente,1,25) nm_usuario_convenio,
 	a.uf_crm_medico_resp uf_medico_solicitante,
	a.cd_conv_medico_resp cd_medico_solicitante,
 	a.cd_cid_principal cd_doenca_def,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE null END  cd_motivo_alta,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END  ie_carater_internacao,
 	a.cd_proc_principal cd_procedimento_princ,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END  cd_tipo_acomodacao,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,0)  ELSE null END  ie_clinica,
 	a.cd_categoria_convenio cd_tipo_plano,
	CASE WHEN b.cd_medico_executor IS NULL THEN trunc(a.dt_entrada,'dd')  ELSE trunc(b.dt_item,'dd') END  dt_procedimento,
	CASE WHEN b.cd_medico_executor IS NULL THEN to_char(a.dt_entrada,'hh24mi')  ELSE to_char(b.dt_item,'hh24mi') END  hr_procedimento,
 	b.ie_video ie_cirurgia_video,
	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN 		coalesce(b.cd_interno,'0')  ELSE b.cd_medico_exec_conv END  cd_medico_executor ,
/*	decode(a.ie_tipo_atendimento,1,	b.cd_funcao_executor,0) ie_funcao_executor,  alterado por marcus OS5966 */

	b.cd_funcao_executor ie_funcao_executor,
	CASE WHEN substr(b.cd_item_convenio,1,1)=8 THEN  b.cd_item_convenio  ELSE substr(b.cd_item_convenio,1,(length(b.cd_item_convenio) - 1)) END  cd_item,
	CASE WHEN a.ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END  ie_cirurgia_multipla,
 	a.ie_tipo_nascimento,
 	a.ie_sexo,
 	a.dt_nascimento,
	c.dt_remessa dt_mesano_referencia,
 	sum(b.qt_item) qt_item,
 	sum(b.vl_total_item) vl_item,
	sum(b.qt_filme) qt_filme,
 	sum(b.vl_filme) vl_filme,
 	sum(b.vl_custo_oper) vl_custo_operacional,
 	sum(b.vl_honorario) vl_medico,
 	'00000000000000000000000000000000000000000000' ds_zeros,
	'                                            ' ds_espaco,
	' ' ds_reg_trailer,
	b.cd_senha_guia cd_senha,
	b.ie_tipo_item
FROM	w_interf_conta_item b,
	w_interf_conta_cab a,
	w_interf_conta_header c
where	c.nr_seq_protocolo 	= a.nr_seq_protocolo
and	a.nr_interno_conta	= b.nr_interno_conta
group by
	a.nr_seq_protocolo,
	a.nr_interno_conta,
 	a.cd_interno,
 	c.cd_regional,
 	c.nr_remessa,
 	lpad(substr(b.nr_doc_convenio,1,7),7, '0'),
 	a.ie_tipo_atendimento,
 	a.dt_entrada,
 	to_char(a.dt_entrada,'ddmmyyyy'),
	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy'),
	to_char(a.dt_entrada,'hh24mi'),
	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi'),
 	substr(a.cd_usuario_convenio,1,15),
 	substr(a.nm_paciente,1,25),
 	a.uf_crm_medico_resp,
	a.cd_conv_medico_resp,
 	a.cd_cid_principal,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE null END ,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END ,
 	a.cd_proc_principal,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END ,
 	CASE WHEN a.ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,0)  ELSE null END ,
 	a.cd_categoria_convenio,
	CASE WHEN b.cd_medico_executor IS NULL THEN trunc(a.dt_entrada,'dd')  ELSE trunc(b.dt_item,'dd') END ,
	CASE WHEN b.cd_medico_executor IS NULL THEN to_char(a.dt_entrada,'hh24mi')  ELSE to_char(b.dt_item,'hh24mi') END ,
 	b.ie_video,
	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN 		coalesce(b.cd_interno,'0')  ELSE b.cd_medico_exec_conv END ,
	b.cd_funcao_executor,
	CASE WHEN substr(b.cd_item_convenio,1,1)=8 THEN  b.cd_item_convenio  ELSE substr(b.cd_item_convenio,1,(length(b.cd_item_convenio) - 1)) END ,
	CASE WHEN a.ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END ,
 	a.ie_tipo_nascimento,
 	a.ie_sexo,
 	a.dt_nascimento,
	c.dt_remessa,
	b.cd_senha_guia,
	b.ie_tipo_item

union all

SELECT	9 ie_tipo_registro,
	nr_seq_protocolo,
	0, '', '', 0, '', 0,
 	LOCALTIMESTAMP, '', '',
 	'', '', '',
 	'', '', '', '', 0, '',
 	'', 0, 0, '', LOCALTIMESTAMP, '',
 	'', '', 0, '', '', '',
 	'', LOCALTIMESTAMP, LOCALTIMESTAMP, 0,
 	0, 0, 0, 0, 0, '', '', '9', '',0
from	w_interf_conta_Trailler;

