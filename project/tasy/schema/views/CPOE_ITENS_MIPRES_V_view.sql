-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cpoe_itens_mipres_v (nr_seq_item_cpoe, ie_tipo_item_presc, nr_seq_item_presc, nr_prescricao, ie_nopbs, nr_seq_receita_amb, nr_seq_item_receita_amb, nr_atendimento, ie_oncologia, ie_conselho_medico, cd_pessoa_fisica) AS select  distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'M' ie_tipo_item_presc, --Medicamento / medicamento composto
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        cpoe_get_nopbs_material(b.cd_material) ie_nopbs,
        a.nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        a.nr_atendimento nr_atendimento,
        coalesce(a.ie_oncologia,'N') ie_oncologia,
        c.ie_conselho_medico,
        a.cd_pessoa_fisica
FROM    cpoe_material a,
        prescr_material b,
        material c
where   a.nr_sequencia = b.nr_seq_mat_cpoe
and     b.cd_material in (
                            a.cd_material, a.cd_mat_comp1, a.cd_mat_comp2, a.cd_mat_comp3,
                            a.cd_mat_comp4, a.cd_mat_comp5, a.cd_mat_comp6, a.cd_mat_comp7,
                            a.cd_mat_dil, a.cd_mat_red, a.cd_mat_recons, a.cd_mat_recons1,
                            a.cd_mat_recons2, a.cd_mat_recons3, a.cd_mat_recons4,
                            a.cd_mat_recons5, a.cd_mat_recons6, a.cd_mat_recons7
                          )
and     a.dt_liberacao is not null
and		a.nr_seq_hemoterapia is null
and     b.ie_agrupador in (1, 3, 7, 9)
and     c.cd_material = b.cd_material

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'MAT' ie_tipo_item_presc, --Material
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        cpoe_get_nopbs_material(b.cd_material) ie_nopbs,
        a.nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        coalesce(a.ie_oncologia,'N') ie_oncologia,
        c.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_material a,
        prescr_material b,
        material c
where   b.nr_seq_mat_cpoe = a.nr_sequencia
and     b.cd_material = a.cd_material
and     a.dt_liberacao is not null
and     b.ie_agrupador = 2
and     c.cd_material = b.cd_material

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'SOL' ie_tipo_item_presc, --Solucao
        x.nr_seq_solucao nr_seq_item_presc,
        b.nr_prescricao,
        cpoe_get_nopbs_material(b.cd_material) ie_nopbs,
        a.nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        coalesce(a.ie_oncologia,'N') ie_oncologia,
        d.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_material a,
        prescr_material b,
        prescr_solucao x,
        material d
where   b.nr_seq_mat_cpoe = a.nr_sequencia
and     b.cd_material = a.cd_material
and     x.nr_prescricao = b.nr_prescricao
and     x.nr_seq_solucao = b.nr_sequencia_solucao
and     a.dt_liberacao is not null
and     b.ie_agrupador = 4
and     d.cd_material = b.cd_material

union all

select	distinct
        prc.nr_seq_proc_cpoe nr_seq_item_cpoe,
        'ASS' ie_tipo_item_presc, -- Medicamento/material associado ao procedimento
        prm.nr_sequencia nr_seq_item_presc,
        prm.nr_prescricao,
        cpoe_get_nopbs_material(prm.cd_material) ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        prs.nr_atendimento,
        'N' ie_oncologia,
        mat.ie_conselho_medico,
        prs.cd_pessoa_fisica
from    prescr_medica prs,
        prescr_material prm,
        prescr_procedimento prc,
        material mat
where   prm.nr_prescricao = prs.nr_prescricao
and		prc.nr_prescricao = prm.nr_prescricao
and		prc.nr_sequencia = prm.nr_sequencia_proc
and     prs.dt_liberacao is not null
and     prm.ie_agrupador = 5
and     mat.cd_material = prm.cd_material

union all

select  distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'M' ie_tipo_item_presc, --Material de Receita Ambulatoria
        null nr_seq_item_presc,
        null nr_prescricao,
        cpoe_get_nopbs_material(c.cd_material) ie_nopbs,
        a.nr_seq_receita_amb,
        c.nr_sequencia nr_seq_item_receita_amb,
        a.nr_atendimento,
        coalesce(a.ie_oncologia,'N') ie_oncologia,
        d.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_material a,
        fa_receita_farmacia b,
        fa_receita_farmacia_item c,
        material d
where   b.nr_sequencia = a.nr_seq_receita_amb
and     b.nr_atendimento = a.nr_atendimento
and     c.cd_material = a.cd_material
and     c.nr_seq_receita = b.nr_sequencia
and     a.dt_liberacao is not null
and     a.nr_seq_hemoterapia is null
and not exists (
                  select  1
                  from    prescr_mipres p
                  where   p.nr_seq_item_receita_amb = c.nr_sequencia
                )
and     d.cd_material = c.cd_material

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'P' ie_tipo_item_presc, --Procedimento
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        coalesce(c.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        coalesce(a.ie_oncologia,'N') ie_oncologia,
        c.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_procedimento a,
        prescr_procedimento b,
        procedimento c,
        proc_interno d,
        prescr_medica e
where   a.nr_sequencia          = b.NR_SEQ_proc_CPOE
and     a.nr_seq_proc_interno   = d.nr_sequencia
and     c.cd_procedimento       = d.cd_procedimento
and     d.ie_origem_proced      = c.ie_origem_proced
and     e.nr_prescricao         = b.nr_prescricao
AND		e.nr_atendimento        = a.nr_atendimento
and     a.dt_liberacao is not null
and     a.nr_seq_hemoterapia is null

union all

select	distinct
        hem.nr_sequencia nr_seq_item_cpoe,
        'PH' ie_tipo_item_presc, --Hemoterapia
        ph.nr_sequencia nr_seq_item_presc,
        ph.nr_prescricao,
        coalesce(prc.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        hem.nr_atendimento nr_atendimento,
        'N' ie_oncologia,
        prc.ie_conselho_medico,
        hem.cd_pessoa_fisica
from    cpoe_hemoterapia hem,
        prescr_solic_bco_sangue ph,
        san_derivado sd,
        proc_interno pri,
        procedimento prc
where   hem.nr_sequencia         = ph.nr_seq_hemo_cpoe
and     hem.nr_seq_derivado      = sd.nr_sequencia
and     sd.nr_seq_proc_interno   = pri.nr_sequencia
and     pri.cd_procedimento      = prc.cd_procedimento
and		pri.ie_origem_proced     = prc.ie_origem_proced
and     hem.dt_liberacao is not null

union all

select  distinct
        cmt.nr_sequencia nr_seq_item_cpoe,
        'MAH' ie_tipo_item_presc, --Medicamentos Associado a hemoterapia
        prm.nr_sequencia nr_seq_item_presc,
        prm.nr_prescricao,
        cpoe_get_nopbs_material(prm.cd_material) ie_nopbs,
        cmt.nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        cmt.nr_atendimento nr_atendimento,
        coalesce(cmt.ie_oncologia,'N') ie_oncologia,
        mat.ie_conselho_medico,
        cmt.cd_pessoa_fisica
from    cpoe_material cmt,
        prescr_material prm,
        material mat
where   cmt.nr_sequencia = prm.nr_seq_mat_cpoe
and     prm.cd_material in (
                            cmt.cd_material, cmt.cd_mat_comp1, cmt.cd_mat_comp2, cmt.cd_mat_comp3,
                            cmt.cd_mat_comp4, cmt.cd_mat_comp5, cmt.cd_mat_comp6, cmt.cd_mat_comp7,
                            cmt.cd_mat_dil, cmt.cd_mat_red, cmt.cd_mat_recons, cmt.cd_mat_recons1,
                            cmt.cd_mat_recons2, cmt.cd_mat_recons3, cmt.cd_mat_recons4,
                            cmt.cd_mat_recons5, cmt.cd_mat_recons6, cmt.cd_mat_recons7
                          )
and     cmt.dt_liberacao is not null
and     prm.ie_agrupador in (1, 3, 7, 9)
and     cmt.nr_seq_hemoterapia is not null
and     mat.cd_material = prm.cd_material

union all

select  distinct
        cph.nr_sequencia nr_seq_item_cpoe,
        'PRH' ie_tipo_item_presc, --Procedimento/hemoterapia
		pp.nr_sequencia nr_seq_item_presc,
		pp.nr_prescricao,
        coalesce(prc.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        cph.nr_atendimento,
        coalesce(cpp.ie_oncologia,'N') ie_oncologia,
        prc.ie_conselho_medico,
        cph.cd_pessoa_fisica
from 	cpoe_hemoterapia cph,
        cpoe_procedimento cpp,
        prescr_procedimento pp,
        proc_interno pri,
        procedimento prc
where 	cph.nr_sequencia = cpp.nr_seq_hemoterapia
and     cpp.nr_sequencia = pp.nr_seq_proc_cpoe
and     cph.nr_seq_proc_interno = pri.nr_sequencia
and     pri.cd_procedimento = prc.cd_procedimento
and     pri.ie_origem_proced = prc.ie_origem_proced
and     cph.dt_liberacao is not null

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'D' ie_tipo_item_presc, --Dieta
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        cpoe_get_nopbs_material(b.cd_material) ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        'N' ie_oncologia,
        c.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_dieta a,
        prescr_material b,
        material c
where   b.nr_seq_dieta_cpoe = a.nr_sequencia
and     a.dt_liberacao is not null
and     a.ie_tipo_dieta IN ('S','E', 'L')
and     b.ie_agrupador in (8, 12, 16)
and     c.cd_material = b.cd_material

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'MAG' ie_tipo_item_presc, --Material associado gasoterapia
        c.nr_sequencia nr_seq_item_presc,
        c.nr_prescricao,
        cpoe_get_nopbs_material(c.cd_material) ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        'N' ie_oncologia,
        d.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_gasoterapia a,
        prescr_gasoterapia b,
        prescr_material c,
        material d
where   b.nr_seq_gas_cpoe = a.nr_sequencia
and     c.nr_seq_gasoterapia = b.nr_sequencia
and     a.dt_liberacao is not null
and     c.ie_agrupador = 15
and     d.cd_material = c.cd_material

union all

select	distinct
        a.nr_sequencia nr_seq_item_cpoe,
        'MAD' ie_tipo_item_presc, --Milk/Infantil formula
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        cpoe_get_nopbs_material(b.cd_material) ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        'N' ie_oncologia,
        c.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_dieta a,
        prescr_material b,
        material c
where   b.nr_seq_dieta_cpoe = a.nr_sequencia
and     a.dt_liberacao is not null
and     b.ie_agrupador = 17
and     c.cd_material = b.cd_material

union all

select  a.nr_sequencia nr_seq_item_cpoe,
        'R' ie_tipo_item_presc, /* recomendacoes */
        b.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        coalesce(d.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        a.nr_atendimento nr_atendimento,
        'N' ie_oncologia,
        d.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_recomendacao a,
        prescr_recomendacao b,
        regra_proced_recomendacao c,
        procedimento d,
        proc_interno f
where   b.nr_seq_rec_cpoe = a.nr_sequencia
and     a.dt_liberacao is not null
and     b.cd_recomendacao is not null
and     c.cd_tipo_recomendacao = b.cd_recomendacao
and     d.cd_procedimento = c.cd_procedimento
and     d.ie_origem_proced = c.ie_origem_proced
and     f.cd_procedimento = d.cd_procedimento
and     f.ie_origem_proced = d.ie_origem_proced

union all

select  a.nr_sequencia nr_seq_item_cpoe,
        'MREC' ie_tipo_item_presc, /* Material associado a recomendacao */
        d.nr_sequencia nr_seq_item_presc,
        b.nr_prescricao,
        coalesce(f.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        a.nr_atendimento nr_atendimento,
        'N' ie_oncologia,
        f.ie_conselho_medico,
        a.cd_pessoa_fisica
from    cpoe_recomendacao a,
        prescr_recomendacao b,
        prescr_material d,
        kit_mat_recomendacao e,
        material f
where   a.nr_sequencia = b.nr_seq_rec_cpoe
and     a.dt_liberacao is not null
and     b.cd_recomendacao is not null
and     b.nr_prescricao = d.nr_prescricao
and     d.cd_kit_material = e.cd_kit
and     d.cd_material = f.cd_material

union all

select distinct
        cap.nr_sequencia nr_seq_item_cpoe,
        'AP' ie_tipo_item_presc, --  Exames Anatomia Patologica
        pp.nr_sequencia nr_seq_item_presc,
        pp.nr_prescricao,
        coalesce(prc.ie_nopbs,'N') ie_nopbs,
        null nr_seq_receita_amb,
        null nr_seq_item_receita_amb,
        null nr_atendimento,
        null ie_oncologia,
        prc.ie_conselho_medico,
        cap.cd_pessoa_fisica
from    cpoe_anatomia_patologica cap,
        prescr_procedimento pp,
        procedimento prc,
        proc_interno pri
where   cap.nr_sequencia          = pp.nr_seq_proc_cpoe
and     cap.nr_seq_proc_interno   = pri.nr_sequencia
and     prc.cd_procedimento       = pri.cd_procedimento
and     pri.ie_origem_proced      = prc.ie_origem_proced
and     cap.dt_liberacao is not null;

