-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_ressarcimento_v (cd_guia, cd_procedimento, ds_procedimento, dt_procedimento, dt_recebimento, cd_usuario_plano, nm_segurado, nm_prestador_pagto, ds_def, ds_grupo_ans, ds_tipo_relacao, ds_ato_cooperado, ds_preco, ds_regulamentacao, ds_tipo_contratacao, ds_segmentacao, vl_evento, vl_ressarcimento, dt_movimento, nr_titulo, cd_classif_prov_deb, cd_classif_prov_cred, nr_seq_segurado, dt_mes_competencia, ie_tipo_segurado, nr_seq_conta) AS SELECT		b.cd_guia cd_guia, /* View para relatório wpls 2363, valores de ressarcimento, glosas e coparticipação */
		to_char(d.cd_procedimento) cd_procedimento, /* Procedimentos glosados com lote de pagamento */
		substr(obter_descricao_procedimento(d.cd_procedimento,d.ie_origem_proced),1,255) ds_procedimento,
		to_char(d.dt_procedimento,'dd/mm/yyyy') dt_procedimento,
		a.dt_recebimento dt_recebimento,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_usuario_plano,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_pgto,'N'),1,255) as nm_prestador_pagto,
		'Glosa' ds_def,
		(select max(x.ds_grupo) FROM ans_grupo_despesa x where x.nr_sequencia = d.nr_seq_grupo_ans) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) as ds_tipo_relacao,
		substr(obter_valor_dominio(3418, d.ie_ato_cooperado),1,255) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, e.ie_preco),1,18) ds_preco,
		substr(obter_valor_dominio(2157, e.ie_regulamentacao),1,255) ds_regulamentacao,
		substr(obter_valor_dominio(1666, e.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
		substr(obter_valor_dominio(1665, e.ie_segmentacao),1,255) ds_segmentacao,
		d.vl_provisao vl_evento,
		c.vl_glosa vl_ressarcimento,
		g.dt_mes_competencia  dt_movimento,
		(select 	j.nr_titulo
			from 	pls_pagamento_prestador i,
				pls_pag_prest_vencimento j
			where   0=0
			and	c.nr_seq_conta_proc = b.nr_sequencia
			and	j.nr_seq_pag_prestador = i.nr_sequencia
			and	i.nr_seq_lote = c.nr_seq_lote_pgto
			and	i.nr_seq_prestador = c.nr_seq_prestador_pgto) nr_titulo,
		coalesce(c.cd_classif_glosa_deb, d.cd_classif_prov_deb) cd_classif_prov_deb,
		coalesce(c.cd_classif_glosa_cred, d.cd_classif_glosa_cred) cd_classif_prov_cred,
		b.nr_seq_segurado nr_seq_segurado,
		a.dt_mes_competencia dt_mes_competencia,
		coalesce(b.ie_tipo_segurado,f.ie_tipo_segurado) ie_tipo_segurado,
		b.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta a,
		pls_conta b,
		pls_conta_medica_resumo c,
		pls_conta_proc d,
		pls_plano e,
		pls_segurado f,
		pls_lote_pagamento g
where		0=0
and		b.nr_seq_protocolo 	= a.nr_sequencia
and 		c.nr_seq_conta		= b.nr_sequencia
and		d.nr_sequencia		= c.nr_seq_conta_proc
and		e.nr_sequencia 		= b.nr_seq_plano
and		f.nr_sequencia 		= b.nr_seq_segurado
and		g.nr_sequencia		= c.nr_seq_lote_pgto
and		coalesce(c.vl_glosa,0) > 0

union all

SELECT		b.cd_guia cd_guia,
		to_char(d.cd_procedimento) cd_procedimento, /* Procedimentos glosados sem lote de pagamento e protocolo encerrado sem pagamento */
		substr(obter_descricao_procedimento(d.cd_procedimento,d.ie_origem_proced),1,255) ds_procedimento,
		to_char(d.dt_procedimento,'dd/mm/yyyy') dt_procedimento,
		a.dt_recebimento dt_recebimento,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_usuario_plano,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_pgto,'N'),1,255) as nm_prestador_pagto,
		'Glosa' ds_def,
		(select max(x.ds_grupo) from ans_grupo_despesa x where x.nr_sequencia = d.nr_seq_grupo_ans) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) as ds_tipo_relacao,
		substr(obter_valor_dominio(3418, d.ie_ato_cooperado),1,255) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, e.ie_preco),1,18) ds_preco,
		substr(obter_valor_dominio(2157, e.ie_regulamentacao),1,255) ds_regulamentacao,
		substr(obter_valor_dominio(1666, e.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
		substr(obter_valor_dominio(1665, e.ie_segmentacao),1,255) ds_segmentacao,
		d.vl_provisao vl_evento,
		c.vl_glosa vl_ressarcimento,
		a.dt_mes_competencia dt_movimento,
		(select 	j.nr_titulo
			from 	pls_pagamento_prestador i,
				pls_pag_prest_vencimento j
			where   0=0
			and	c.nr_seq_conta_proc = b.nr_sequencia
			and	j.nr_seq_pag_prestador = i.nr_sequencia
			and	i.nr_seq_lote = c.nr_seq_lote_pgto
			and	i.nr_seq_prestador = c.nr_seq_prestador_pgto) nr_titulo,
		coalesce(c.cd_classif_glosa_deb, d.cd_classif_glosa_deb) cd_classif_prov_deb,
		coalesce(c.cd_classif_glosa_cred, d.cd_classif_glosa_cred) cd_classif_prov_cred,
		b.nr_seq_segurado nr_seq_segurado,
		a.dt_mes_competencia dt_mes_competencia,
		coalesce(b.ie_tipo_segurado,f.ie_tipo_segurado) ie_tipo_segurado,
		b.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta a,
		pls_conta b,
		pls_conta_medica_resumo c,
		pls_conta_proc d,
		pls_plano e,
		pls_segurado f
where		0=0
and		b.nr_seq_protocolo 	= a.nr_sequencia
and 		c.nr_seq_conta		= b.nr_sequencia
and		d.nr_sequencia		= c.nr_seq_conta_proc
and		e.nr_sequencia 		= b.nr_seq_plano
and		f.nr_sequencia 		= b.nr_seq_segurado
and		coalesce(c.vl_glosa,0) > 0
and		a.ie_status = 4
and 		c.nr_seq_lote_pgto is null

union all

SELECT		b.cd_guia cd_guia, /* Materiais glosados com lote de pagamento  */
		substr(pls_obter_seq_codigo_material(d.nr_seq_material,''),1,255) cd_servico,
		substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',d.nr_seq_material),1,255) ds_procedimento,
		to_char(d.dt_atendimento,'dd/mm/yyyy') dt_procedimento,
		a.dt_recebimento dt_recebimento,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_usuario_plano,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_pgto,'N'),1,255) as nm_prestador_pagto,
		'Glosa' ds_def,
		(select max(x.ds_grupo) from ans_grupo_despesa x where x.nr_sequencia = d.nr_seq_grupo_ans) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) as ds_tipo_relacao,
		substr(obter_valor_dominio(3418, d.ie_ato_cooperado),1,255) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, e.ie_preco),1,18) ds_preco,
		substr(obter_valor_dominio(2157, e.ie_regulamentacao),1,255) ds_regulamentacao,
		substr(obter_valor_dominio(1666, e.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
		substr(obter_valor_dominio(1665, e.ie_segmentacao),1,255) ds_segmentacao,
		d.vl_provisao vl_evento,
		c.vl_glosa vl_ressarcimento,
		g.dt_mes_competencia  dt_movimento,
		(select 	j.nr_titulo
			from 	pls_pagamento_prestador i,
				pls_pag_prest_vencimento j
			where   0=0
			and	c.nr_seq_conta_proc = b.nr_sequencia
			and	j.nr_seq_pag_prestador = i.nr_sequencia
			and	i.nr_seq_lote = c.nr_seq_lote_pgto
			and	i.nr_seq_prestador = c.nr_seq_prestador_pgto) nr_titulo,
		coalesce(c.cd_classif_glosa_deb, d.cd_classif_glosa_deb) cd_classif_prov_deb,
		coalesce(c.cd_classif_glosa_cred, d.cd_classif_glosa_cred) cd_classif_prov_cred,
		b.nr_seq_segurado nr_seq_segurado,
		a.dt_mes_competencia dt_mes_competencia,
		coalesce(b.ie_tipo_segurado,f.ie_tipo_segurado) ie_tipo_segurado,
		b.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta a,
		pls_conta b,
		pls_conta_medica_resumo c,
		pls_conta_mat d,
		pls_plano e,
		pls_segurado f,
		pls_lote_pagamento g
where		0=0
and		b.nr_seq_protocolo 	= a.nr_sequencia
and 		c.nr_seq_conta		= b.nr_sequencia
and		d.nr_sequencia		= c.nr_seq_conta_mat
and		e.nr_sequencia 		= b.nr_seq_plano
and		f.nr_sequencia 		= b.nr_seq_segurado
and		g.nr_sequencia		= c.nr_seq_lote_pgto
and		coalesce(c.vl_glosa,0) > 0

union all

SELECT		b.cd_guia cd_guia, /* Materiais glosados sem lote de pagamento e protocolo encerrado sem pagamento */
		substr(pls_obter_seq_codigo_material(d.nr_seq_material,''),1,255) cd_servico,
		substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',d.nr_seq_material),1,255) ds_procedimento,
		to_char(d.dt_atendimento,'dd/mm/yyyy') dt_procedimento,
		a.dt_recebimento dt_recebimento,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_usuario_plano,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_pgto,'N'),1,255) as nm_prestador_pagto,
		'Glosa' ds_def,
		(select max(x.ds_grupo) from ans_grupo_despesa x where x.nr_sequencia = d.nr_seq_grupo_ans) ds_grupo_ans,
		substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'TR'),1,255) as ds_tipo_relacao,
		substr(obter_valor_dominio(3418, d.ie_ato_cooperado),1,255) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, e.ie_preco),1,18) ds_preco,
		substr(obter_valor_dominio(2157, e.ie_regulamentacao),1,255) ds_regulamentacao,
		substr(obter_valor_dominio(1666, e.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
		substr(obter_valor_dominio(1665, e.ie_segmentacao),1,255) ds_segmentacao,
		d.vl_provisao vl_evento,
		c.vl_glosa vl_ressarcimento,
		a.dt_mes_competencia dt_mes_competencia,
		(select 	j.nr_titulo
			from 	pls_pagamento_prestador i,
				pls_pag_prest_vencimento j
			where   0=0
			and	c.nr_seq_conta_proc = b.nr_sequencia
			and	j.nr_seq_pag_prestador = i.nr_sequencia
			and	i.nr_seq_lote = c.nr_seq_lote_pgto
			and	i.nr_seq_prestador = c.nr_seq_prestador_pgto) nr_titulo,
		coalesce(c.cd_classif_glosa_deb, d.cd_classif_glosa_deb) cd_classif_prov_deb,
		coalesce(c.cd_classif_glosa_cred, d.cd_classif_glosa_cred) cd_classif_prov_cred,
		b.nr_seq_segurado nr_seq_segurado,
		a.dt_mes_competencia dt_mes_competencia,
		coalesce(b.ie_tipo_segurado,f.ie_tipo_segurado) ie_tipo_segurado,
		b.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta a,
		pls_conta b,
		pls_conta_medica_resumo c,
		pls_conta_mat d,
		pls_plano e,
		pls_segurado f
where		0=0
and		b.nr_seq_protocolo 	= a.nr_sequencia
and 		c.nr_seq_conta		= b.nr_sequencia
and		d.nr_sequencia		= c.nr_seq_conta_mat
and		e.nr_sequencia 		= b.nr_seq_plano
and		f.nr_sequencia 		= b.nr_seq_segurado
and		coalesce(c.vl_glosa,0) > 0
and		a.ie_status = 4
and		c.nr_seq_lote_pgto is null

union all

SELECT 		a.cd_guia cd_guia, /* Procedimentos cooparticipação */
		to_char(b.cd_procedimento) cd_procedimento,
		substr(obter_descricao_procedimento(b.cd_procedimento,b.ie_origem_proced),1,255) ds_procedimento,
		to_char(b.dt_procedimento,'dd/mm/yyyy') dt_procedimento,
		c.dt_recebimento dta_rec,
		pls_obter_dados_segurado(a.nr_seq_segurado,'C') cd_usuario_plano,
		pls_obter_dados_segurado(a.nr_seq_segurado,'N') nm_segurado,
		pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N') as nm_prestador_pagto,
		'Coparticipação' ds_def,
		(select max(x.ds_grupo) from ans_grupo_despesa x where x.nr_sequencia = b.nr_seq_grupo_ans) ds_grupo_ans,
		pls_obter_dados_prestador(a.nr_seq_prestador_exec,'TR') as ds_tipo_relacao,
		obter_valor_dominio(3418, b.ie_ato_cooperado) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, d.ie_preco),1,18) ds_preco,
		obter_valor_dominio(2157, d.ie_regulamentacao) ds_regulamentacao,
		obter_valor_dominio(1666, d.ie_tipo_contratacao) ds_tipo_contratacao,
		obter_valor_dominio(1665, d.ie_segmentacao) ds_segmentacao,
		b.vl_provisao vl_evento,
		f.vl_coparticipacao vl_ressarcimento,
		c.dt_mes_competencia  dt_movimento,
		0 nr_titulo,
		coalesce(f.cd_classif_deb_provisao, f.cd_classif_deb) cd_classif_prov_deb,
		coalesce(f.cd_classif_cred_provisao, f.cd_classif_cred) cd_classif_prov_cred,
		a.nr_seq_segurado nr_seq_segurado,
		c.dt_mes_competencia dt_mes_competencia,
		coalesce(a.ie_tipo_segurado,g.ie_tipo_segurado) ie_tipo_segurado,
		a.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta c,
		pls_conta a,
		pls_conta_proc b,
		pls_plano d,
		pls_conta_copartic_contab f,
		pls_segurado g
where		0=0
and		c.nr_sequencia = a.nr_seq_protocolo
and 		b.nr_seq_conta = a.nr_sequencia
and		d.nr_sequencia = a.nr_seq_plano
and		f.nr_seq_conta = a.nr_sequencia
and		g.nr_sequencia = a.nr_seq_segurado
and 		coalesce(f.vl_coparticipacao,0) > 0

union all

SELECT 		a.cd_guia cd_guia, /* Materiais cooparticipação */
		substr(pls_obter_seq_codigo_material(nr_seq_material,''),1,255) cd_servico,
		substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',b.nr_seq_material),1,255) ds_procedimento,
		to_char(b.dt_atendimento,'dd/mm/yyyy') dt_procedimento,
		c.dt_recebimento dt_recebimento,
		pls_obter_dados_segurado(a.nr_seq_segurado,'C') cd_usuario_plano,
		pls_obter_dados_segurado(a.nr_seq_segurado,'N') nm_segurado,
		pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N') as nm_prestador_pagto,
		'Coparticipação' ds_def,
		(select max(x.ds_grupo) from ans_grupo_despesa x where x.nr_sequencia = b.nr_seq_grupo_ans) ds_grupo_ans,
		pls_obter_dados_prestador(a.nr_seq_prestador_exec,'TR') as nm_prestador,
		obter_valor_dominio(3418, b.ie_ato_cooperado) ds_ato_cooperado,
		substr(obter_valor_dominio(1669, d.ie_preco),1,18) ds_preco,
		obter_valor_dominio(2157, d.ie_regulamentacao) ds_regulamentacao,
		obter_valor_dominio(1666, d.ie_tipo_contratacao) ds_tipo_contratacao,
		obter_valor_dominio(1665, d.ie_segmentacao) ds_segmentacao,
		b.vl_provisao vl_evento,
		f.vl_coparticipacao vl_ressarcimento,
		c.dt_mes_competencia  dt_movimento,
		0 nr_titulo,
		coalesce(f.cd_classif_deb_provisao, f.cd_classif_deb) cd_classif_prov_deb,
		coalesce(f.cd_classif_cred_provisao, f.cd_classif_cred) cd_classif_prov_cred,
		a.nr_seq_segurado nr_seq_segurado,
		c.dt_mes_competencia dt_mes_competencia,
		coalesce(a.ie_tipo_segurado,g.ie_tipo_segurado) ie_tipo_segurado,
		a.nr_sequencia nr_seq_conta
from 		pls_protocolo_conta c,
		pls_conta a,
		pls_conta_mat b,
		pls_plano d,
		pls_conta_copartic_contab f,
		pls_segurado g
where		0=0
and		c.nr_sequencia = a.nr_seq_protocolo
and		b.nr_seq_conta = a.nr_sequencia
and		d.nr_sequencia = a.nr_seq_plano
and		f.nr_seq_conta = a.nr_sequencia
and		g.nr_sequencia = a.nr_seq_segurado
and 		coalesce(f.vl_coparticipacao,0) > 0;

