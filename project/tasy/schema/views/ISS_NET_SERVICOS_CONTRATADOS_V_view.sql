-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW iss_net_servicos_contratados_v (tp_registro, nr_sequencia, cd_estabelecimento, dt_emissao, valor_registro) AS SELECT	1																TP_REGISTRO,	
	null																NR_SEQUENCIA,											 
	a.cd_estabelecimento														CD_ESTABELECIMENTO, 
	null																DT_EMISSAO, 
	substr(obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'IM')								||';'|| --NR_INCRI_MUN 
	EXTRACT(MONTH FROM LOCALTIMESTAMP)													||';'|| --DT_MES_REFER 
	EXTRACT(YEAR FROM LOCALTIMESTAMP)													||';'|| --DT_ano_REFER 
	TO_CHAR(LOCALTIMESTAMP,'HH24:mi')||' '||TO_CHAR(LOCALTIMESTAMP,'dd/mm/yyyy') 									||''|| --DT_hora DT_geracao 
	obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'N')									||';'||	--ds_rz_sozial 
	'1'																||';'||	--ds_frase 
	'EXPORTACAO DECLARACAO ELETRONICA-ONLINE-NOTA CONTROL',0,250)									VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 
and 	nfse_obter_regra('TP', a.cd_estabelecimento) is not NULL 
group by a.cd_estabelecimento, a.cd_cgc 

UNION
 
--Valores da Nota 
select 2																TP_REGISTRO, 
	n.nr_sequencia 															NR_SEQUENCIA,	 
	n.cd_estabelecimento														CD_ESTABELECIMENTO, 
	n.dt_emissao															DT_EMISSAO, 
	substr(n.cd_serie_nf														||';'|| --modelo documento 
	n.nr_nota_fiscal														||';'|| --nr documento 
	lpad(subst_virgula_ponto_adic_zero(coalesce(sum(b.vl_tributo),0)),12,0)								||';'|| --vl_tributo 
	lpad(subst_virgula_ponto_adic_zero(coalesce(sum(n.vl_total_nota),0)),12,0)								||';'||	--vl_documento 
	b.tx_tributo															||';'||	--vl_aliquot 
	TO_CHAR(n.dt_emissao,'DDMMYYYY') 												||';'||	--dt_emissao 
	TO_CHAR(n.dt_emissao,'DDMMYYYY') 												||';'|| --dt_pagamento	 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'C'), ' '),14, ' ') 						||';'|| --cpf/cnpj prestador	 
	coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'N'), ' ') 							||';'||	--razao_social 
	obter_dados_pf_pj_estab(n.cd_estabelecimento,null,n.cd_cgc_emitente,'IM')							||';'||	--NR_INCRI_MUN 
	CASE WHEN coalesce(sum(b.vl_tributo),0)=0 THEN 0  ELSE 1 END 												||';'||	--ie_imp_retido	 
	lpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CEP'),0), 9, 0)						||';'||	--cd_cep 
	coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'R'), ' ')								||';'||	--ds_endereco 
	coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'NR'),0)								||';'||	--nr_endereco 
	coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'B'), ' ')								||';'||	--ds_bairro 
	coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CI'), ' ')							||';'||	--ds_cidade 
	obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'UF')									||';'||	--sg_estado 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'DDD') 										||';'||	--cod_area (DDD) 
	CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN '1'  ELSE '0' END ,0,560)								VALOR_REGISTRO 
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN nota_fiscal_trib b ON (n.nr_sequencia = b.nr_sequencia)
LEFT OUTER JOIN modelo_nota_fiscal m ON (n.nr_seq_modelo = m.nr_sequencia)
LEFT OUTER JOIN tributo d ON (b.cd_tributo = d.cd_tributo)
WHERE n.ie_tipo_nota 		= 'EN' and n.dt_atualizacao_estoque is not null  -- nota calculada 
 group by 	n.nr_nota_fiscal, 
		n.dt_emissao, 
		n.cd_natureza_operacao, 
		n.cd_pessoa_fisica, 
		n.nr_sequencia, 
		n.cd_estabelecimento, 
		b.tx_tributo, 
		b.vl_tributo, 
		n.cd_serie_nf, 
		n.cd_cgc_emitente;

