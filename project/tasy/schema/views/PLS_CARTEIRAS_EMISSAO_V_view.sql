-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_carteiras_emissao_v (dt_mes, qt_primeira_via, qt_segunda_via, qt_renovacao, qt_reemissao, qt_alteracao_plano) AS select	a.dt_mes,
	sum(b.qt_primeira_via) qt_primeira_via,
	sum(b.qt_segunda_via) qt_segunda_via,
	sum(b.qt_renovacao) qt_renovacao,
	sum(b.qt_reemissao) qt_reemissao,
	sum(b.qt_alteracao_plano) qt_alteracao_plano
FROM mes_v a
LEFT OUTER JOIN (select	trunc(b.dt_envio,'month') dt_referencia,
		count(*) qt_primeira_via,
		0 qt_segunda_via,
		0 qt_renovacao,
		0 qt_reemissao,
		0 qt_alteracao_plano
	from	pls_segurado_carteira	a,
		pls_lote_carteira	b
	where	a.nr_seq_lote_emissao	= b.nr_sequencia
	and	a.nr_via_solicitacao	= 1
	group by trunc(b.dt_envio,'month')
	
union all

	select	trunc(b.dt_envio,'month'),
		0 qt_primeira_via,
		count(*) qt_segunda_via,
		0 qt_renovacao,
		0 qt_reemissao,
		0 qt_alteracao_plano
	from	pls_segurado_carteira	a,
		pls_lote_carteira	b
	where	a.nr_seq_lote_emissao	= b.nr_sequencia
	and	a.nr_via_solicitacao	<> 1
	and	a.nr_seq_motivo_via	<> 4
	group by trunc(b.dt_envio,'month')
	
union all

	select	trunc(b.dt_envio,'month'),
		0 qt_primeira_via,
		0 qt_segunda_via,
		0 qt_renovacao,
		count(*) qt_reemissao,
		0 qt_alteracao_plano
	from	pls_segurado_carteira	a,
		pls_lote_carteira	b
	where	a.nr_seq_lote_emissao	= b.nr_sequencia
	and	a.nr_via_solicitacao	<> 1
	and	a.nr_seq_motivo_via	= 4
	group by trunc(b.dt_envio,'month')) b ON (a.dt_mes = b.dt_referencia) group BY a.dt_mes;

