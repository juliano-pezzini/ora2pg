-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW iss_exp_serv_contr_apa_goian_v (tp_registro, nr_sequencia, cd_estabelecimento, dt_emissao, valor_registro) AS SELECT	1																	TP_REGISTRO,	
	null																	NR_SEQUENCIA,											
	a.cd_estabelecimento													CD_ESTABELECIMENTO,
	null																	DT_EMISSAO,
	substr(obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'IM')					||';'|| --NR_INCRI_MUN
	SUBSTR('0'||EXTRACT(MONTH FROM LOCALTIMESTAMP),(length('0'||EXTRACT(MONTH FROM LOCALTIMESTAMP))-1),2)	||';'|| --DT_MES_REFER
	EXTRACT(YEAR FROM LOCALTIMESTAMP)																||';'|| --DT_ano_REFER
	TO_CHAR(LOCALTIMESTAMP,'HH24:mi')||' '||TO_CHAR(LOCALTIMESTAMP,'dd/mm/yyyy') 							||'' || --DT_hora DT_geracao
	obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'N')							||';'||	--ds_rz_sozial
	'1'																						||';'||	--codigo atividade referencia ou obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'G')
	'EXPORTACAO DECLARACAO ELETRONICA-ONLINE-NOTA CONTROL',0,250)							VALOR_REGISTRO
FROM 		estabelecimento_v a
WHERE		1 = 1
and 		nfse_obter_regra('TP', a.cd_estabelecimento) is not NULL
group by 	a.cd_estabelecimento, a.cd_cgc

UNION
 
--Valores da Nota
select  2																							TP_REGISTRO,
	a.nr_sequencia 																					NR_SEQUENCIA,	
	a.cd_estabelecimento																			CD_ESTABELECIMENTO,
	a.dt_emissao																					DT_EMISSAO,
	CASE WHEN '5201405'=upper(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')) THEN '7'  ELSE '4' END 										||';'|| --cd_modelo pode ou a.cd_serie_nf,
	a.nr_nota_fiscal 																														||';'|| --nr_documento,
	CASE WHEN a.vl_mercadoria=0 THEN  '0.00'  ELSE replace(to_char(campo_mascara(a.vl_mercadoria, 2)),',','.') END  										||';'|| --vl_tributavel,
	CASE WHEN a.vl_mercadoria=0 THEN  '0.00'  ELSE replace(to_char(campo_mascara(a.vl_mercadoria, 2)),',','.') END  										||';'|| --vl_documento,
	campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia,'X','ISS'),2)																||';'|| --vl_aliquota,
	TO_CHAR(a.dt_emissao,'DDMMYYYY')																										||';'|| --dt_emissao,
	TO_CHAR(a.dt_atualizacao_estoque,'DDMMYYYY')																							||';'|| --dt_pagamento,
	a.cd_cgc_emitente 																														||';'|| --cd_cgc_emitente,
	obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente) 																				||';'|| --nm_razao_social,
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'IM') 																			||';'|| --nr_inscricao_municipal,
	CASE WHEN coalesce(Obter_Valor_tipo_Tributo_Nota(a.nr_sequencia, 'V', 'ISS'),0)=0 THEN  0  ELSE 1 END  														||';'|| --IE_IMPOSTO_RETIDO,
	OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CEP') 																		||';'|| --cd_cep,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'E'),1,125) 															||';'|| --ds_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'NR'),1,10) 															||';'|| --nr_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'B'),1,60) 																||';'|| --ds_bairro_prestador,
	SUBSTR(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CI'),1,50) 															||';'|| --DS_CIDADE,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'UF'),1,2) 																||';'|| --sg_estado,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'DDT'),1,2) 															||';'|| --nr_ddd_telefone,
	CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN '1'  ELSE '0' END 																				VALOR_REGISTRO
from	nota_fiscal a,
		operacao_nota o
where	a.cd_operacao_nf = o.cd_operacao_nf
and		a.ie_situacao in ('1')
and		substr(obter_se_nota_entrada_saida(a.nr_sequencia),1,1) = 'E'
and 	o.ie_servico = 'S';

