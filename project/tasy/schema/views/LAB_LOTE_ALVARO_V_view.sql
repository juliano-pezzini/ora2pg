-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_lote_alvaro_v (nr_seq_lote_externo, cd_pessoa_fisica, nr_prescricao, nr_seq_geracao, nr_seq_amostra, nm_paciente, dt_nascimento, ie_sexo, ds_endereco, ds_municipio, ds_uf, cd_cep, ds_obs_prescr, dt_prescricao, nr_amostra, cd_material_exame, cd_material_integracao, cd_exame, cd_exame_equip, ds_observacao, nr_sequencia, nr_crm, nr_crm_uf, nm_guerra, nr_seq_grupo, qt_peso, qt_altura_cm) AS select	a.nr_seq_lote_externo,
	c.cd_pessoa_fisica,
	b.nr_prescricao,
	b.nr_prescricao nr_seq_geracao,
	null nr_seq_amostra,
	substr(c.nm_paciente,1,40) nm_paciente,
	c.dt_nascimento,
	c.ie_sexo,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'E'),1,40) ds_endereco,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'CI'),1,30) ds_municipio,
	obter_compl_pf(c.cd_pessoa_fisica, 1, 'UF') ds_uf,
	obter_compl_pf(c.cd_pessoa_fisica, 1, 'CEP') cd_cep,
	substr(coalesce(b.ds_dado_clinico, a.ds_observacao_coleta),1,255) ds_obs_prescr,
	b.dt_prescricao,
	to_char(b.dt_prescricao,'dd') || d.nr_seq_grupo || a.nr_seq_lab nr_amostra,
	a.cd_material_exame,
	coalesce(lab_obter_mat_integr_exame(e.nr_sequencia,d.nr_seq_exame,'ALVARO'),coalesce(e.cd_material_integracao, e.cd_material_exame)) cd_material_integracao,
	coalesce(lab_obter_codigo_exame_equip('ALVARO', d.nr_seq_exame, c.ie_tipo_atendimento, null, null, 'CEXE'),coalesce(d.cd_exame_integracao, d.cd_exame)) cd_exame,
	lab_obter_codigo_exame_equip('ALVARO', d.nr_seq_exame, c.ie_tipo_atendimento, null, null, 'CEXE') cd_exame_equip,
	a.ds_observacao,
	a.nr_sequencia,
	substr(obter_crm_medico(f.cd_pessoa_fisica), 1, 255) nr_crm,
	substr(obter_crm_medico(f.cd_pessoa_fisica), 1, 255) || '-' || substr(obter_uf_crm_medico(f.cd_pessoa_fisica), 1, 255) nr_crm_uf,
	f.nm_guerra,
	d.nr_seq_grupo,
	b.qt_peso,
	b.qt_altura_cm
FROM 	medico f,
	material_exame_lab e,
	exame_laboratorio d,
	atendimento_paciente_v c,
	prescr_medica b,
	prescr_procedimento a,
	lab_parametro g
where a.nr_prescricao		= b.nr_prescricao
  and b.nr_atendimento		= c.nr_atendimento
  and a.nr_seq_exame 		= d.nr_seq_exame
  and a.cd_material_exame	= e.cd_material_exame
  and b.cd_medico		= f.cd_pessoa_fisica
  and c.cd_estabelecimento	= g.cd_estabelecimento
  and coalesce(g.ie_gerar_xml_alvaro_amostra,'N') = 'N'

union all

select	a.nr_seq_lote_externo,
	c.cd_pessoa_fisica,
	b.nr_prescricao,
	b.nr_prescricao nr_seq_geracao,
	to_char(h.nr_seq_prescr_proc_mat) nr_seq_amostra,	
	substr(c.nm_paciente,1,40) nm_paciente,
	c.dt_nascimento,
	c.ie_sexo,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'E'),1,40) ds_endereco,
	substr(obter_compl_pf(c.cd_pessoa_fisica, 1, 'CI'),1,30) ds_municipio,
	obter_compl_pf(c.cd_pessoa_fisica, 1, 'UF') ds_uf,
	obter_compl_pf(c.cd_pessoa_fisica, 1, 'CEP') cd_cep,
	substr(coalesce(b.ds_dado_clinico, a.ds_observacao_coleta),1,255) ds_obs_prescr,
	b.dt_prescricao,
	to_char(b.dt_prescricao,'dd') || d.nr_seq_grupo || a.nr_seq_lab nr_amostra,
	a.cd_material_exame,
	coalesce(lab_obter_mat_integr_exame(e.nr_sequencia,d.nr_seq_exame,'ALVARO'),coalesce(e.cd_material_integracao, e.cd_material_exame)) cd_material_integracao,
	coalesce(lab_obter_codigo_exame_equip('ALVARO', d.nr_seq_exame, c.ie_tipo_atendimento, null, null, 'CEXE'),coalesce(d.cd_exame_integracao, d.cd_exame)) cd_exame,
	lab_obter_codigo_exame_equip('ALVARO', d.nr_seq_exame, c.ie_tipo_atendimento, null, null, 'CEXE') cd_exame_equip,
	a.ds_observacao,
	a.nr_sequencia,
	substr(obter_crm_medico(f.cd_pessoa_fisica), 1, 255) nr_crm,
	substr(obter_crm_medico(f.cd_pessoa_fisica), 1, 255) || '-' || substr(obter_uf_crm_medico(f.cd_pessoa_fisica), 1, 255) nr_crm_uf,
	f.nm_guerra,
	d.nr_seq_grupo,
	b.qt_peso,
	b.qt_altura_cm
from 	medico f,
	material_exame_lab e,
	exame_laboratorio d,
	atendimento_paciente_v c,
	prescr_medica b,
	prescr_procedimento a,
	prescr_proc_mat_item h,
	lab_parametro g
where a.nr_prescricao		= b.nr_prescricao
  and b.nr_atendimento		= c.nr_atendimento
  and a.nr_seq_exame 		= d.nr_seq_exame
  and a.cd_material_exame	= e.cd_material_exame
  and b.cd_medico		= f.cd_pessoa_fisica
  and h.nr_prescricao		= a.nr_prescricao
  and h.nr_seq_prescr		= a.nr_sequencia
  and c.cd_estabelecimento	= g.cd_estabelecimento
  and coalesce(g.ie_gerar_xml_alvaro_amostra,'N') = 'S';

