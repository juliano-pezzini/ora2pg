-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cobranca_escritural_real_v (tp_registro, cd_agencia_cedente, nr_conta_cedente, nm_cedente, dt_remessa, nr_seq_envio, cd_cpf_cnpj_cedente, cd_agencia_banco_cedente, nr_conta_banco_cedente, nr_titulo_detalhe, nr_titulo_banco, nr_titulo_cedente, dt_vencimento, vl_titulo, cd_agencia_cobradora, dt_emissao, cd_inscr_sacado, nr_cpf_cnpj_sacado, nm_sacado, ds_endereco_sacado, ds_bairro_sacado, cd_cep_sacado, ds_cidade_sacado, ds_uf_sacado, qt_titulos, vl_total, cd_inscricao, vl_multa, vl_juros_mora, cd_tipo_juros, ie_tipo_multa) AS select	0 TP_REGISTRO,
	c.CD_AGENCIA_BANCARIA CD_AGENCIA_CEDENTE, 
	c.CD_CONTA NR_CONTA_CEDENTE, 
	substr(obter_nome_pf_pj(null,b.CD_CGC),1,255) NM_CEDENTE, 
	a.DT_REMESSA_RETORNO DT_REMESSA, 
	a.NR_SEQUENCIA NR_SEQ_ENVIO, 
	'' CD_CPF_CNPJ_CEDENTE, 
	'0' CD_AGENCIA_BANCO_CEDENTE, 
	'0' NR_CONTA_BANCO_CEDENTE, 
	0 NR_TITULO_DETALHE, 
	0 NR_TITULO_BANCO, 
	0 NR_TITULO_CEDENTE, 
	LOCALTIMESTAMP DT_VENCIMENTO, 
	0 VL_TITULO, 
	'' CD_AGENCIA_COBRADORA, 
	LOCALTIMESTAMP DT_EMISSAO, 
	0 CD_INSCR_SACADO, 
	'' NR_CPF_CNPJ_SACADO, 
	'' NM_SACADO, 
	'' DS_ENDERECO_SACADO, 
	'' DS_BAIRRO_SACADO, 
	'' CD_CEP_SACADO, 
	'' DS_CIDADE_SACADO, 
	'' DS_UF_SACADO, 
	0 QT_TITULOS, 
	0 VL_TOTAL, 
	'' CD_INSCRICAO, 
	0 vl_multa, 
	0 vl_juros_mora, 
	'' cd_tipo_juros, 
	'' ie_tipo_multa 
FROM	estabelecimento b, 
	banco_estabelecimento c, 
	cobranca_escritural a 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 

UNION
 
/*Remessa reg. detalhe*/
 
select	1 TP_REGISTRO, 
	'0' CD_AGENCIA_CEDENTE, 
	'0' NR_CONTA_CEDENTE, 
	'' NM_CEDENTE, 
	LOCALTIMESTAMP DT_REMESSA, 
	a.NR_SEQUENCIA NR_SEQ_ENVIO, 
	b.CD_CGC_CPF CD_CPF_CNPJ_CEDENTE, 
	d.CD_AGENCIA_BANCARIA CD_AGENCIA_BANCO_CEDENTE, 
	d.CD_CONTA NR_CONTA_BANCO_CEDENTE, 
	c.NR_TITULO NR_TITULO_DETALHE, 
	c.NR_TITULO NR_TITULO_BANCO, 
	c.NR_TITULO NR_TITULO_CEDENTE, 
	b.DT_PAGAMENTO_PREVISTO DT_VENCIMENTO, 
	b.VL_TITULO, 
	b.CD_AGENCIA_BANCARIA CD_AGENCIA_COBRADORA, 
	b.DT_EMISSAO, 
	b.IE_TIPO_PESSOA CD_INSCR_SACADO, 
	b.CD_CGC_CPF NR_CPF_CNPJ_SACADO,	 
	b.NM_PESSOA NM_SACADO,	 
	obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'EC') DS_ENDERECO_SACADO, 
	substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B'),1,40) DS_BAIRRO_SACADO, 
	obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP') CD_CEP_SACADO, 
	obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI') DS_CIDADE_SACADO, 
	obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF') DS_UF_SACADO, 
	0 QT_TITULOS, 
	0 VL_TOTAL, 
	CASE WHEN b.cd_cgc IS NULL THEN '01'  ELSE '02' END  CD_INSCRICAO, 
	CASE WHEN coalesce(c.vl_multa,0)=0 THEN CASE WHEN coalesce(b.vl_multa,0)=0 THEN b.tx_multa  ELSE b.vl_multa END   ELSE c.vl_multa END  vl_multa, 
	CASE WHEN coalesce(c.vl_juros,0)=0 THEN CASE WHEN coalesce(b.vl_juros,0)=0 THEN b.tx_juros  ELSE b.vl_juros END   ELSE c.vl_juros END  vl_juros_mora, 
	CASE WHEN coalesce(c.vl_juros,0)=0 THEN CASE WHEN coalesce(b.vl_juros,0)=0 THEN '1'  ELSE '0' END   ELSE '0' END  cd_tipo_juros, 
	CASE WHEN coalesce(c.vl_multa,0)=0 THEN CASE WHEN coalesce(b.vl_multa,0)=0 THEN '1'  ELSE '0' END   ELSE '0' END  ie_tipo_multa 
from	banco_estabelecimento d, 
	titulo_receber_v b, 
	titulo_receber_cobr c, 
	cobranca_escritural a 
where	a.nr_sequencia		= c.nr_seq_cobranca 
and	c.nr_titulo		= b.nr_titulo 
and	a.nr_seq_conta_banco	= d.nr_sequencia 

union
 
/*Trailler*/
 
select	9 TP_REGISTRO, 
	'0' CD_AGENCIA_CEDENTE, 
	'0' NR_CONTA_CEDENTE, 
	'' NM_CEDENTE, 
	LOCALTIMESTAMP DT_REMESSA, 
	a.NR_SEQUENCIA NR_SEQ_ENVIO, 
	'' CD_CPF_CNPJ_CEDENTE, 
	'0' CD_AGENCIA_BANCO_CEDENTE, 
	'0' NR_CONTA_BANCO_CEDENTE, 
	0 NR_TITULO_DETALHE, 
	0 NR_TITULO_BANCO, 
	0 NR_TITULO_CEDENTE, 
	LOCALTIMESTAMP DT_VENCIMENTO, 
	0 VL_TITULO, 
	'' CD_AGENCIA_COBRADORA, 
	LOCALTIMESTAMP DT_EMISSAO, 
	0 CD_INSCR_SACADO, 
	'' NR_CPF_CNPJ_SACADO, 
	'' NM_SACADO, 
	'' DS_ENDERECO_SACADO, 
	'' DS_BAIRRO_SACADO, 
	'' CD_CEP_SACADO, 
	'' DS_CIDADE_SACADO, 
	'' DS_UF_SACADO, 
	count(*) QT_TITULOS, 
	sum(b.vl_cobranca) VL_TOTAL, 
	'' CD_INSCRICAO, 
	0 vl_multa, 
	0 vl_juros_mora, 
	'' cd_tipo_juros, 
	'' ie_tipo_multa 
from	titulo_receber_cobr b, 
	cobranca_escritural a 
where	a.nr_sequencia		= b.nr_seq_cobranca 
group by	a.nr_sequencia, 
 	 a.dt_remessa_retorno, 
	 a.dt_remessa_retorno, 
	 a.cd_banco;

