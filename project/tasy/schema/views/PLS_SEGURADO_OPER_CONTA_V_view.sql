-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_segurado_oper_conta_v (nr_sequencia, nr_seq_plano, cd_convenio, cd_categoria, qt_idade_anos, qt_idade_meses, ie_local_cadastro, ie_tipo_segurado, ie_pcmso, ie_sexo, nr_seq_contrato, nr_seq_intercambio, dt_nascimento, dt_primeira_utilizacao, dt_contratacao, nr_seq_titular, nr_seq_grupo_coop, cd_matricula_estipulante, nr_seq_grupo_intercambio, nr_seq_congenere, ie_tipo_intercambio, sg_estado_operadora, nr_seq_congenere_sup) AS select	a.nr_sequencia,
	a.nr_seq_plano,
	pls_obter_conv_cat_segurado(a.nr_sequencia, 1) cd_convenio,
	pls_obter_conv_cat_segurado(a.nr_sequencia, 2) cd_categoria,
	obter_idade(b.dt_nascimento, LOCALTIMESTAMP, 'A') qt_idade_anos,
	obter_idade(b.dt_nascimento, LOCALTIMESTAMP, 'M') qt_idade_meses,
	a.ie_local_cadastro,
	a.ie_tipo_segurado,
	coalesce(a.ie_pcmso,'N') ie_pcmso,
	b.ie_sexo,
	a.nr_seq_contrato,
	a.nr_seq_intercambio,
	b.dt_nascimento,
	(select	min(x.dt_atendimento)
	FROM	pls_conta_ocor_v	x
	where	x.nr_seq_segurado	= a.nr_sequencia) dt_primeira_utilizacao,
	a.dt_contratacao,
	a.nr_seq_titular,
	a.nr_seq_grupo_coop,
	a.cd_matricula_estipulante,
	a.nr_seq_grupo_intercambio,
	coalesce(a.nr_seq_ops_congenere,a.nr_seq_congenere) nr_seq_congenere,
	pls_obter_tipo_intercambio(coalesce(a.nr_seq_ops_congenere, a.nr_seq_congenere), a.cd_estabelecimento) ie_tipo_intercambio,
	pls_obter_estado_congenere(coalesce(a.nr_seq_ops_congenere, a.nr_seq_congenere), a.cd_estabelecimento) sg_estado_operadora,
	CASE WHEN a.nr_seq_ops_congenere IS NULL THEN (select w.nr_seq_congenere from pls_congenere w where nr_sequencia = a.nr_seq_congenere)  ELSE (select w.nr_seq_congenere from pls_congenere w where nr_sequencia = a.nr_seq_ops_congenere) END  nr_seq_congenere_sup
from	pls_segurado	a,
	pessoa_fisica	b
where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica;

