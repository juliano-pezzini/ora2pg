-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW inventario_v (nr_movimento_estoque, cd_estabelecimento, cd_local_estoque, dt_mesano_referencia, dt_movimento, cd_material_estoque, cd_unidade_medida_estoque, qt_estoque, vl_estoque, cd_cgc_emitente, cd_operacao_estoque, nm_usuario, cd_fornecedor) AS select	m.nr_movimento_estoque,
	m.cd_estabelecimento,
	m.cd_local_estoque,
	m.dt_mesano_referencia,
	trunc(m.dt_movimento_estoque,'dd') dt_movimento,
	m.cd_material_estoque,
	m.cd_unidade_medida_estoque,
	sum(CASE WHEN m.cd_acao=1 THEN 		CASE WHEN ie_entrada_saida='E' THEN  m.qt_estoque  ELSE m.qt_estoque * -1 END   ELSE CASE WHEN ie_entrada_saida='S' THEN  m.qt_estoque  ELSE m.qt_estoque * -1 END  END ) qt_estoque,
	sum(CASE WHEN m.cd_acao=1 THEN 		CASE WHEN ie_entrada_saida='E' THEN  v.vl_movimento  ELSE v.vl_movimento * -1 END   ELSE CASE WHEN ie_entrada_saida='S' THEN  v.vl_movimento  ELSE v.vl_movimento * -1 END  END ) vl_estoque,
	m.cd_cgc_emitente,
	o.cd_operacao_estoque,
	m.nm_usuario,
	CASE WHEN coalesce(m.ie_movto_consignado,CASE WHEN coalesce(o.ie_consignado,0)=0 THEN 'N'  ELSE 'C' END )='C' THEN m.cd_fornecedor  ELSE null END  cd_fornecedor
FROM operacao_estoque o, movimento_estoque m
LEFT OUTER JOIN movimento_estoque_valor v ON (m.nr_movimento_estoque = v.nr_movimento_estoque)
WHERE m.cd_operacao_estoque	= o.cd_operacao_estoque and m.dt_processo		is not null and o.ie_tipo_requisicao	= '5' and m.ie_origem_documento <> '15' group by
	m.nr_movimento_estoque,
	m.cd_estabelecimento,
	m.cd_local_estoque,
	m.dt_mesano_referencia,
	trunc(m.dt_movimento_estoque,'dd'),
	m.cd_material_estoque,
	m.cd_unidade_medida_estoque,
	m.nm_usuario,
	m.cd_cgc_emitente,
	m.cd_fornecedor,
	o.cd_operacao_estoque,
	CASE WHEN coalesce(m.ie_movto_consignado,CASE WHEN coalesce(o.ie_consignado,0)=0 THEN 'N'  ELSE 'C' END )='C' THEN m.cd_fornecedor  ELSE null END;

