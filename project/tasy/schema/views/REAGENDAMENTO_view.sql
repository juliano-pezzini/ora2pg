-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW reagendamento (dt_cancelamento, nm_usuario_confirm, usuario_orig, usuario_atual, dt_liberacao, nm_usuario_alter_data_prev, dt_executada, qt_tempo_dia, ds_cor_fundo_autor, dt_liberacao_atend, dt_falta_consistencia, nm_usuario_agendamento, cd_setor_atendimento, ds_motivo_alt_data, nr_seq_protocolo, nr_prescricao, dt_interrompido, ds_motivo_susp, nr_seq_atendimento, dt_real, dt_agenda, ie_via_aplicacao, nr_seq_paciente, nr_apac, ie_cancela_dia, ie_agendado, dt_alter_data_prev, nm_usuario_atual, ds_dia_ciclo, usuario_confirm, nm_usuario_orig, ds_estagio_autor, dt_suspensao_medico, ds_mot_reagendamento, ds_acomod, ds_cor_fonte_autor, ds_motivo_canc, dt_anterior, dt_falta, ds_acomod_agenda, qt_duracao_aplicacao, nr_ciclo, dt_prevista, ds_ultimo_local, nm_pessoa_fisica, nr_atendimento, ie_reagendamento, nr_sequencia, dt_anterio, ds_setor_trat, qt_tempo_medic, nr_prontuario, ds_observacao, nm_paciente, cd_protocolo, cd_medico_resp, ds_setor_realizacao, nr_seq_medicacao, nm_medico_resp, cd_pessoa_fisica, ds_convenio, ie_protocolo_livre, ds_protoc_medic, qt_dias_intervalo, cd_estabelecimento, ds_estabelecimento, ie_status, ds_protocolo, nr_telefones, ds_protocolo_livre, dt_nascimento) AS select
    obter_data_canc_quimio(b.nr_seq_atendimento) as DT_CANCELAMENTO,
    b.nm_usuario_lib_atend as NM_USUARIO_CONFIRM,
    SUBSTR(qt_dados_age_cons(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista) ,2),1,255) as USUARIO_ORIG,
    SUBSTR(qt_dados_age_cons(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista) ,4),1,255) as USUARIO_ATUAL,
    b.dt_liberacao as DT_LIBERACAO,
    b.nm_usuario_alter_data_prev as NM_USUARIO_ALTER_DATA_PREV,
    coalesce(qt_obter_data_status('E',b.nr_seq_atendimento),b.dt_fim_adm) as DT_EXECUTADA,
    qt_obter_tempo_dur_dia(b.ds_dia_ciclo,a.nr_seq_medicacao,a.cd_protocolo,b.nr_ciclo) as QT_TEMPO_DIA,
    substr(qt_obter_cor_autor_pend(b.nr_seq_atendimento,'B'),1,15) as DS_COR_FUNDO_AUTOR,
    b.dt_liberacao_atend as DT_LIBERACAO_ATEND,
    qt_obter_data_status('A',b.nr_seq_atendimento) as DT_FALTA_CONSISTENCIA,
    coalesce(b.nm_usuario_nrec, '') as NM_USUARIO_AGENDAMENTO,
    b.cd_setor_atendimento as CD_SETOR_ATENDIMENTO,
    substr(obter_desc_motivo_alter_data(b.nr_seq_motivo_alter_data),1,255) as DS_MOTIVO_ALT_DATA,
    b.nr_seq_protocolo as NR_SEQ_PROTOCOLO,
    b.nr_prescricao as NR_PRESCRICAO,
    b.dt_interrompido as DT_INTERROMPIDO,    
    substr(obter_desc_motivo_susp(b.nr_seq_motivo_susp),1,255) as DS_MOTIVO_SUSP,
    b.nr_seq_atendimento as NR_SEQ_ATENDIMENTO,    
    b.dt_real as DT_REAL,
    b.dt_real as DT_AGENDA,
    substr(obter_vias_admins(b.nr_seq_atendimento),1,250) as IE_VIA_APLICACAO,
    b.nr_seq_paciente as NR_SEQ_PACIENTE,
    Qt_Obter_Numero_Apac(a.cd_pessoa_fisica,coalesce(b.dt_real, b.dt_prevista)) as NR_APAC,
    substr(qt_enable_cancel_cycle_sche(b.nr_seq_atendimento, b.nm_usuario),1,80) as IE_CANCELA_DIA,
    Qt_Obter_Se_Dia_Agendado(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista)) as IE_AGENDADO,
    b.dt_alter_data_prev as DT_ALTER_DATA_PREV,
    SUBSTR(qt_dados_age_cons(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista) ,3),1,255) as NM_USUARIO_ATUAL,
    b.ds_dia_ciclo as DS_DIA_CICLO,
    SUBSTR(qt_dados_age_cons(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista) ,5),1,255) as USUARIO_CONFIRM,
    SUBSTR(qt_dados_age_cons(b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista) ,1),1,255) as NM_USUARIO_ORIG,
    substr(qt_obter_cor_autor_pend(b.nr_seq_atendimento,'W'),1,60) as DS_ESTAGIO_AUTOR,
    b.dt_suspensao_medico as DT_SUSPENSAO_MEDICO,
    (   select      substr(obter_ds_motivo_reagendamento(max(X.NR_SEQ_MOT_REAGENDAMENTO)),1,255)
            FROM	AGENDA_QUIMIO X
            where	X.NR_SEQ_ATENDIMENTO = B.NR_SEQ_ATENDIMENTO) as DS_MOT_REAGENDAMENTO,
    substr(Qt_Obter_Local_Trat(b.nr_seq_atendimento),1,60) as DS_ACOMOD,
    substr(qt_obter_cor_autor_pend(b.nr_seq_atendimento,'F'),1,15) as DS_COR_FONTE_AUTOR,
    substr(obter_mot_canc_quimio(b.nr_seq_atendimento),1,255) as DS_MOTIVO_CANC,
    b.dt_anterior as DT_ANTERIOR,
    qt_obter_data_status('F',b.nr_seq_atendimento) as DT_FALTA,
    substr(obter_desc_local_qt(b.NR_SEQ_LOCAL,'C'),1,60) as DS_ACOMOD_AGENDA,
    substr(qt_obter_dur_aplicacao_pend(b.ds_dia_ciclo, a.nr_seq_medicacao, a.cd_protocolo, b.nr_seq_atendimento, coalesce(b.dt_real, b.dt_prevista), b.nr_seq_pend_agenda, substr(qt_obter_usuario_agendamento(b.nr_seq_atendimento),1,255), b.cd_estabelecimento), 1, 255) as QT_DURACAO_APLICACAO,    
    b.nr_ciclo as NR_CICLO,
    b.dt_prevista as DT_PREVISTA,
    obter_ultimo_local_qt(a.nr_seq_paciente) as DS_ULTIMO_LOCAL,
    substr(obter_nome_pf(a.cd_pessoa_fisica),1,150) as NM_PESSOA_FISICA,
    b.nr_atendimento as NR_ATENDIMENTO,
    b.ie_reagendamento as IE_REAGENDAMENTO,
    b.nr_seq_pend_agenda as NR_SEQUENCIA,
    b.dt_anterior as DT_ANTERIO,
    substr(obter_nome_setor(b.cd_setor_atendimento),1,100) as DS_SETOR_TRAT,
    a.qt_tempo_medic as QT_TEMPO_MEDIC,    
    substr(obter_prontuario_pf(b.cd_estabelecimento, a.cd_pessoa_fisica),1,15) as NR_PRONTUARIO,
    a.ds_observacao as DS_OBSERVACAO,
    substr(obter_nome_pf(a.cd_pessoa_fisica),1,60) as NM_PACIENTE,
    a.cd_protocolo as CD_PROTOCOLO,
    a.cd_medico_resp as CD_MEDICO_RESP,
    substr(obter_nome_setor(b.cd_setor_atendimento),1,100) as DS_SETOR_REALIZACAO,
    a.nr_seq_medicacao as NR_SEQ_MEDICACAO,    
    substr(obter_nome_pf(a.cd_medico_resp),1,150) as NM_MEDICO_RESP,
    a.cd_pessoa_fisica as CD_PESSOA_FISICA,
	(select  max(b.ds_convenio)
	from paciente_setor_convenio a,
		convenio b
	where	a.cd_convenio = b.cd_convenio
	and	nr_seq_paciente = a.nr_seq_paciente) as DS_CONVENIO,    
    a.ie_protocolo_livre as IE_PROTOCOLO_LIVRE,
	(select	max(substr((select max(nm_protocolo) as ds_protocolo_w from protocolo where	cd_protocolo = a.cd_protocolo)||' / '||nm_medicacao,1,255)) as ds_prot_medic_w	
	from	protocolo_medicacao
	where	cd_protocolo 	= a.cd_protocolo
	and	nr_sequencia	= a.nr_seq_medicacao) as DS_PROTOC_MEDIC,
    a.qt_dias_intervalo as QT_DIAS_INTERVALO,
	b.cd_estabelecimento as CD_ESTABELECIMENTO,
    substr(coalesce(obter_nome_estab(b.cd_estabelecimento),' '),1,250) as DS_ESTABELECIMENTO,
    a.ie_status as IE_STATUS,	
    (select	max(nm_protocolo) from protocolo where cd_protocolo = a.cd_protocolo) as DS_PROTOCOLO,    
    substr(obter_fone_pac_agenda(a.cd_pessoa_fisica),1,255) as NR_TELEFONES,
    a.ds_protocolo_livre as DS_PROTOCOLO_LIVRE,
    (select	max(dt_nascimento) from pessoa_fisica where cd_pessoa_fisica = a.cd_pessoa_fisica) as DT_NASCIMENTO    
from	paciente_setor a
inner join paciente_atendimento b
on	a.nr_seq_paciente 	= b.nr_seq_paciente
where b.nr_seq_pend_agenda is not null    
order by b.nr_seq_pend_agenda desc;

