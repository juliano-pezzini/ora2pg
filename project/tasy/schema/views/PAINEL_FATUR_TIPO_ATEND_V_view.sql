-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW painel_fatur_tipo_atend_v (ds_analise, cd_estabelecimento, vl_int, vl_ps, vl_amb, vl_ext) AS select	'Faturado total' ds_analise,
	cd_estabelecimento,
	sum(CASE WHEN ie_tipo_atendimento=1 THEN  vl_total  ELSE 0 END ) vl_int,
	sum(CASE WHEN ie_tipo_atendimento=3 THEN  vl_total  ELSE 0 END ) vl_ps,
	sum(CASE WHEN ie_tipo_atendimento=8 THEN  vl_total  ELSE 0 END ) vl_amb,
	sum(CASE WHEN ie_tipo_atendimento=7 THEN  vl_total  ELSE 0 END ) vl_ext
FROM	eis_resultado_v
where 	dt_referencia between TRUNC(LOCALTIMESTAMP,'month') and TRUNC(LOCALTIMESTAMP,'dd')
group by cd_estabelecimento

union all

select	'Faturado total (sem NF)' ds_analise,
	cd_estabelecimento,
	sum(CASE WHEN ie_tipo_atendimento=1 THEN  vl_total  ELSE 0 END ) vl_int,
	sum(CASE WHEN ie_tipo_atendimento=3 THEN  vl_total  ELSE 0 END ) vl_ps,
	sum(CASE WHEN ie_tipo_atendimento=8 THEN  vl_total  ELSE 0 END ) vl_amb,
	sum(CASE WHEN ie_tipo_atendimento=7 THEN  vl_total  ELSE 0 END ) vl_ext
from	eis_resultado_v
where 	dt_referencia between TRUNC(LOCALTIMESTAMP,'month') and TRUNC(LOCALTIMESTAMP,'dd')
and 	obter_nf_conta(NR_INTERNO_CONTA,2) is null
and 	obter_nf_conta(NR_INTERNO_CONTA,3) is null
group by cd_estabelecimento

union all

select	'Faturado total (com NF)' ds_analise,
	cd_estabelecimento,
	sum(CASE WHEN ie_tipo_atendimento=1 THEN  vl_total  ELSE 0 END ) vl_int,
	sum(CASE WHEN ie_tipo_atendimento=3 THEN  vl_total  ELSE 0 END ) vl_ps,
	sum(CASE WHEN ie_tipo_atendimento=8 THEN  vl_total  ELSE 0 END ) vl_amb,
	sum(CASE WHEN ie_tipo_atendimento=7 THEN  vl_total  ELSE 0 END ) vl_ext
from	eis_resultado_v
where 	dt_referencia between TRUNC(LOCALTIMESTAMP,'month') and TRUNC(LOCALTIMESTAMP,'dd')
and 	((obter_nf_conta(NR_INTERNO_CONTA,2) is not null) or (obter_nf_conta(NR_INTERNO_CONTA,3) is not null))
group by cd_estabelecimento;

