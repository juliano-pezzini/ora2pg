-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW proj_coord_consult_v (nm_solicitante, dt_contrato, ds_nivel, ds_prox_nivel, dt_pn, meses, nivel_aval, dt_avaliacao, prx_avaliacao, nr_seq_item, cd_pessoa_fisica, cd_coordenador_padrao, ds_estabelecimento) AS select 	nm_solicitante,
	dt_contrato,
	ds_nivel,
	ds_prox_nivel,
	dt_pn,
	Meses,
	max(nivel_aval) nivel_aval,
	dt_avaliacao,prx_avaliacao,
	max(nr_seq_item)nr_seq_item,
	cd_pessoa_fisica,
	cd_coordenador_padrao,
	ds_estabelecimento
FROM	(	select	distinct(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)) nm_solicitante,
			to_date(a.dt_contrato,'dd/mm/yy') dt_contrato,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'NA'),1,250) ds_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'PN'),1,250) ds_prox_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'DPN'),1,250) dt_pn,
			trunc((LOCALTIMESTAMP - a.dt_contrato)/30) Meses,
			substr(obter_result_pessoa_avaliacao(d.nr_seq_avaliacao,
			CASE WHEN upper((select substr(obter_result_pessoa_avaliacao(x.nr_seq_avaliacao,x.nr_seq_item),1,250)					from 	pessoa_avaliacao_result x					where 	x.nr_seq_avaliacao=d.nr_seq_avaliacao					and 	x.nr_seq_item= 11140))=upper('Sim') THEN d.nr_seq_item  ELSE '' END ),1,250) nivel_aval,
			to_date(c.dt_avaliacao,'dd/mm/yy') dt_avaliacao,
			to_date(c.dt_prox_avaliacao,'dd/mm/yy') prx_avaliacao,
			d.nr_seq_item,a.cd_pessoa_fisica,
			a.cd_coordenador_padrao,
			SUBSTR( obter_nome_estabelecimento((SELECT cd_estabelecimento FROM COM_CANAL_CONSULTOR_ESTAB q WHERE	q.NR_SEQ_CANAL_CONSULT  = a.nr_sequencia)),1,255)ds_estabelecimento
		from	com_canal_consultor a,
			pessoa_fisica_avaliacao c,
			pessoa_avaliacao_result d
		where	a.cd_pessoa_fisica=c.cd_pessoa_fisica
		and	c.nr_sequencia=d.nr_seq_avaliacao
		and	c.nr_seq_tipo_avaliacao= 451
		and	d.nr_seq_item= 11141
		and	c.nr_sequencia=(select 	max(x.nr_sequencia)
					from    pessoa_fisica_avaliacao x
					where	x.nr_seq_tipo_avaliacao= 451
					and	x.cd_pessoa_fisica=a.cd_pessoa_fisica)
		and	a.ie_situacao='A'
	
union

		select	distinct(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)) nm_solicitante,
			to_date(a.dt_contrato,'dd/mm/yy') dt_contrato,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'NA'),1,250) ds_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'PN'),1,250) ds_prox_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'DPN'),1,250) dt_pn,
			trunc((LOCALTIMESTAMP - a.dt_contrato)/30) Meses,substr(obter_result_pessoa_avaliacao(d.nr_seq_avaliacao,d.nr_seq_item),1,250) nivel_aval,
			to_date(c.dt_avaliacao,'dd/mm/yy') dt_avaliacao,to_date(c.dt_prox_avaliacao,'dd/mm/yy') prx_avaliacao,
			null,
			a.cd_pessoa_fisica,
			a.cd_coordenador_padrao,
			SUBSTR( obter_nome_estabelecimento((SELECT cd_estabelecimento FROM COM_CANAL_CONSULTOR_ESTAB q WHERE	q.NR_SEQ_CANAL_CONSULT  = a.nr_sequencia)),1,255)ds_estabelecimento
		FROM pessoa_avaliacao_result d, com_canal_consultor a
LEFT OUTER JOIN pessoa_fisica_avaliacao c ON (a.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE c.nr_sequencia=d.nr_seq_avaliacao and obter_result_pessoa_avaliacao(d.nr_seq_avaliacao,11141) is null and c.nr_seq_tipo_avaliacao= 451 and d.nr_seq_item= 11138 and c.nr_sequencia=(select max(x.nr_sequencia)
					from	pessoa_fisica_avaliacao x
					where	x.nr_seq_tipo_avaliacao = 451
					and	x.cd_pessoa_fisica = a.cd_pessoa_fisica) and a.ie_situacao='A'
	
union

		select	distinct(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150)) nm_solicitante,
			to_date(a.dt_contrato,'dd/mm/yy') dt_contrato,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'NA'),1,250) ds_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'PN'),1,250) ds_prox_nivel,
			substr(obter_nivel_consultor(obter_empresa_estab(c.cd_estabelecimento),a.cd_pessoa_fisica,'DPN'),1,250) dt_pn,
			trunc((LOCALTIMESTAMP - a.dt_contrato)/30) Meses,
			null nivel_aval,
			to_date(c.dt_avaliacao,'dd/mm/yy') dt_avaliacao,to_date(c.dt_prox_avaliacao,'dd/mm/yy') prx_avaliacao,
			null nr_seq_item,
			a.cd_pessoa_fisica,
			a.cd_coordenador_padrao,
			SUBSTR( obter_nome_estabelecimento((SELECT cd_estabelecimento FROM COM_CANAL_CONSULTOR_ESTAB q WHERE	q.NR_SEQ_CANAL_CONSULT  = a.nr_sequencia)),1,255)ds_estabelecimento
		FROM com_canal_consultor a
LEFT OUTER JOIN pessoa_fisica_avaliacao c ON (a.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE c.nr_seq_tipo_avaliacao is null and a.ie_situacao='A'
		order 	by nm_solicitante ) alias76
group by nm_solicitante,
	dt_contrato,
	ds_nivel,
	ds_prox_nivel,
	Meses,
	dt_avaliacao,
	prx_avaliacao,
	cd_pessoa_fisica,
	cd_coordenador_padrao,
	dt_pn,
	ds_estabelecimento
order by 1;

