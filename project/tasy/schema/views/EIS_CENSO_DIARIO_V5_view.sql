-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_censo_diario_v5 (ds_faixa_etaria, ds_idade, cd_idade, cd_convenio, cd_estabelecimento, ie_periodo, cd_tipo_acomodacao, cd_setor_atendimento, ie_clinica, dt_referencia, cd_medico, nm_pessoa_fisica, nm_paciente, ie_situacao, cd_procedencia, ie_tipo_atendimento, qt_hora_alta, ie_clinica_alta, nr_seq_origem, ie_sexo, cd_cid_principal, cd_categoria_cid, ds_cid_principal, ds_categoria_cid, ds_referencia, cd_dia, nr_pacientes, nr_pac_dia, qt_temp, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, nr_transf_ent_int, nr_transf_ent_ext, nr_transf_saida_int, nr_transf_saida_ext, qt_admitido_alta_dia, hr_alta, ie_tipo_convenio, cd_especialidade, qt_leito_livre, cd_procedimento, ds_procedimento, ds_estabelecimento, ds_motivo_alta, cd_motivo_alta, cd_empresa, cd_classif_etaria, ds_classif_etaria, cd_estabelecimento_base, cd_municipio_ibge, nr_seq_queixa, ds_queixa, cd_categoria, ds_categoria, nr_seq_forma_chegada, ds_forma_chegada, nr_horario, cd_convenio_glosa, cd_categoria_glosa, ds_convenio_glosa, ds_categoria_glosa, ds_indicacao, nr_seq_indicacao, cd_pessoa_fisica, ie_carater_inter_sus, ds_carater_atend, cd_empresa_conv, ds_empresa_conv, ds_agrupamento, nr_seq_agrupamento, nr_seq_classificacao, ds_grupo, ds_subgrupo, ds_forma_organizacao, ds_grupo_proc, ds_area_proc, ds_especialidade_proc, cd_grupo, cd_subgrupo, cd_forma_organizacao, cd_grupo_proc, cd_area_proc, cd_especialidade_proc, cd_proced_principal, ds_proced_principal, ds_classif_atend, ds_estado_civil, nr_control, dt_entrada, dt_alta) AS SELECT
	A.ds_faixa_etaria,
	A.ds_idade,
	A.cd_idade,
	A.cd_convenio,
	A.cd_estabelecimento,
	A.IE_PERIODO,
	A.cd_tipo_acomodacao,
	A.cd_setor_atendimento,
	A.ie_clinica,
	A.DT_REFERENCIA,
	coalesce(A.CD_MEDICO,'0') cd_medico,
	A.nm_pessoa_fisica,
	A.nm_paciente,
	A.IE_SITUACAO,
	A.cd_procedencia,
	A.ie_TIPO_ATENDIMENTO,
	A.qt_hora_alta,
	A.ie_clinica_alta,
	A.nr_seq_origem,
	A.ie_sexo,
	A.cd_cid_principal,
	A.cd_categoria_cid,
	'(' || cd_cid_principal ||')'|| ' - '|| substr(ds_cid_principal,1,200) ds_cid_principal,
	A.ds_categoria_cid,
	A.ds_referencia,
	A.cd_dia,
	sum(CASE WHEN A.IE_periodo='D' THEN  NR_PACIENTES  ELSE 0 END )  NR_PACIENTES,
	A.nr_pac_dia,
	A.qt_temp,
	SUM(NR_ADMISSOES) NR_ADMISSOES,
	SUM(NR_ALTAS) NR_ALTAS,
	SUM(NR_OBITOS) NR_OBITOS,
	SUM(NR_TRANSF_ENTRADA) NR_TRANSF_ENTRADA,
	SUM(NR_TRANSF_SAIDA) NR_TRANSF_SAIDA,
	A.nr_transf_ent_int,
	A.nr_transf_ent_ext,
	A.nr_transf_saida_int,
	A.nr_transf_saida_ext,
	sum(qt_admitido_alta_dia) qt_admitido_alta_dia,
	A.HR_ALTA,
	A.ie_tipo_convenio,
	A.cd_espec_medico cd_especialidade,
	sum(qt_leito_livre) qt_leito_livre,
	cd_procedimento,
	A.ds_procedimento,
	A.ds_estabelecimento,
	A.ds_motivo_alta,
	A.cd_motivo_alta,
	A.cd_empresa,
	A.cd_classif_etaria,
	A.ds_classif_etaria,
	A.cd_estabelecimento_base,
	A.cd_municipio_ibge,
	A.nr_seq_queixa,
	A.ds_queixa,
	A.cd_categoria,
	A.ds_categoria,
	A.nr_seq_forma_chegada,
	A.ds_forma_chegada,
	A.nr_horario,
	coalesce(A.cd_convenio_glosa,0) cd_convenio_glosa,
	A.cd_categoria_glosa,
	A.ds_convenio_glosa,
	A.ds_categoria_glosa,
	A.ds_indicacao,
	A.NR_SEQ_INDICACAO,
	A.cd_pessoa_fisica,
	A.ie_carater_inter_sus,
	A.ds_carater_atend,
	A.cd_empresa_conv,
	substr(coalesce(obter_nome_emp_ref(A.cd_empresa_conv),obter_texto_tasy(1098949,null)),1,100) ds_empresa_conv,
	A.ds_agrupamento,
	coalesce(A.nr_seq_agrupamento,0) nr_seq_Agrupamento,
	A.nr_seq_classificacao,
	A.ds_grupo,
	A.ds_subgrupo,                    
	A.ds_forma_organizacao, 	                   
	A.ds_grupo_proc,
	A.ds_area_proc,
	A.ds_especialidade_proc,
	A.cd_grupo,
	A.cd_subgrupo,
	A.cd_forma_organizacao,
	A.cd_grupo_proc,
	A.cd_area_proc,
	A.cd_especialidade_proc,
	A.cd_proced_principal,
	A.ds_proced_principal,
	A.ds_classif_atend,
	A.ds_estado_civil,
	A.nr_control,
	A.dt_entrada,
	A.dt_alta
FROM	EIS_OCUPACAO_HOSPITALAR A
GROUP 	BY ds_faixa_etaria, 
	ds_idade,
	cd_idade,
	A.cd_convenio,
	A.cd_pessoa_fisica,
	A.cd_estabelecimento,
	A.IE_PERIODO,
	A.cd_tipo_acomodacao,
	A.cd_setor_atendimento,
	to_char(A.dt_referencia, 'dd/mm/yyyy'),
	A.ie_clinica,
	A.cd_cid_principal,
	cd_categoria_cid,
	'(' || cd_cid_principal ||')'|| ' - '|| substr(ds_cid_principal,1,200),
	ds_categoria_cid,
	(to_char(A.dt_referencia, 'd'))::numeric ,
	A.DT_REFERENCIA,
	coalesce(A.CD_MEDICO,'0'),
	A.IE_SITUACAO,
	A.cd_procedencia,
	A.ie_TIPO_ATENDIMENTO,
	(to_char(A.hr_alta,'00'))::numeric ,
	A.nr_seq_origem,
	A.ie_sexo,
	A.ie_clinica_alta,
	A.HR_ALTA,
	A.ie_tipo_convenio,
	cd_espec_medico,
	nm_pessoa_fisica,
	nm_paciente,
	cd_procedimento,
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,100),
	substr(obter_nome_estabelecimento(A.cd_estabelecimento),1,80),
	substr(obter_desc_motivo_alta(A.cd_motivo_alta),1,255),
	A.cd_motivo_alta,
	A.cd_empresa,
	Obter_classif_etaria(A.cd_estabelecimento,A.cd_pessoa_fisica,'C'),
	obter_valor_dominio(1698, Obter_classif_etaria(A.cd_estabelecimento,A.cd_pessoa_fisica,'C')),
	A.cd_estabelecimento_base,
	substr(coalesce(obter_compl_pf(A.cd_pessoa_fisica,1,'CDM'),null),1,100),
	A.nr_seq_queixa,
	ds_queixa,
	A.cd_categoria,
	substr(obter_nome_convenio(A.cd_convenio)||' - '||obter_categoria_convenio(A.cd_convenio,A.cd_categoria),1,200),
	A.nr_seq_forma_chegada,
	substr(coalesce(obter_desc_forma_chegada(A.nr_seq_forma_chegada),obter_texto_tasy(1098949,null)),1,255),
	(to_char(A.dt_entrada,'hh24'))::numeric ,
	coalesce(A.cd_convenio_glosa,0),
	A.cd_categoria_glosa,
	substr(coalesce(obter_nome_convenio(A.cd_convenio_glosa),obter_texto_tasy(1098949,null)),1,100),
	substr(coalesce(obter_categoria_convenio(A.cd_convenio_glosa,A.cd_categoria_glosa),obter_texto_tasy(1098949,null)),1,200),
	substr(coalesce(OBTER_DESC_INDICACAO(A.NR_SEQ_INDICACAO),obter_texto_tasy(1098949,null)),1,100),
	A.NR_SEQ_INDICACAO,
	A.cd_pessoa_fisica,
	A.ie_carater_inter_sus,
	ds_carater_atend,
	A.cd_empresa_conv,
	A.ds_agrupamento,
	coalesce(A.nr_seq_agrupamento,0),
	A.nr_seq_classificacao,
	ds_grupo,                       
	ds_subgrupo,                    
	ds_forma_organizacao, 	                   
	ds_grupo_proc,
	ds_area_proc,
	ds_especialidade_proc,
	A.cd_grupo,
	A.cd_subgrupo,
	A.cd_forma_organizacao,
	A.cd_grupo_proc,
	A.cd_area_proc,
	A.cd_especialidade_proc,
	A.cd_proced_principal,
	A.ds_proced_principal,
	A.ds_classif_atend,
	A.ds_estado_civil,
	A.nr_control,
	A.dt_entrada,
	A.dt_alta,
	qt_hora_alta,
  	ds_referencia,
  	cd_dia,
  	nr_pac_dia,
  	qt_temp,
  	nr_transf_ent_int,
  	nr_transf_ent_ext,
  	nr_transf_saida_int,
  	nr_transf_saida_ext,
  	cd_especialidade,
  	ds_procedimento,
  	ds_estabelecimento,
  	ds_motivo_alta,
  	cd_classif_etaria,
  	ds_classif_etaria,
  	cd_estabelecimento_base,
  	cd_municipio_ibge,
  	ds_categoria,
  	ds_forma_chegada,
  	nr_horario,
  	ds_convenio_glosa,
  	ds_categoria_glosa,
  	ds_indicacao,
  	ds_empresa_conv

union

SELECT	ds_faixa_etaria, 
	ds_idade,
	cd_idade,
	A.cd_convenio,
	A.cd_estabelecimento,
	'M',
	A.cd_tipo_acomodacao,
	A.cd_setor_atendimento,
	A.ie_clinica,
	A.DT_REFERENCIA,
	coalesce(A.CD_MEDICO,'0') cd_medico,
	nm_pessoa_fisica,
	nm_paciente, 
	A.IE_SITUACAO,
	A.cd_procedencia,
	A.ie_TIPO_ATENDIMENTO,
	(to_char(A.hr_alta,'00'))::numeric ,
	A.ie_clinica_alta,
	A.nr_seq_origem,
	A.ie_sexo,
	A.cd_cid_principal,
	cd_categoria_cid,
	'(' || cd_cid_principal ||')'|| ' - '|| substr(ds_cid_principal,1,200) ds_cid_principal,
	ds_categoria_cid,
	to_char(A.dt_referencia, 'dd/mm/yyyy'),
	A.cd_dia,
	sum(CASE WHEN greatest(last_day(A.DT_REFERENCIA), trunc(LOCALTIMESTAMP, 'dd'))=trunc(LOCALTIMESTAMP, 'dd') THEN 	CASE WHEN trunc(A.DT_REFERENCIA,'mm')=A.DT_REFERENCIA THEN  CASE WHEN A.ie_periodo='M' THEN NR_PACIENTES  ELSE 0 END   ELSE 0 END   ELSE CASE WHEN greatest(trunc(A.DT_REFERENCIA, 'dd'), trunc(LOCALTIMESTAMP, 'dd') - 1)=trunc(LOCALTIMESTAMP, 'dd') - 1 THEN  		CASE WHEN A.ie_periodo='D' THEN NR_PACIENTES  ELSE 0 END   ELSE 0 END  END )  NR_PACIENTES, /* Com Elemar em 04/03/2008 , corrigido por spkoth em 17/11/2015 - OS958276*/
	0 NR_PAC_DIA,
	A.qt_temp,
	0 NR_ADMISSOES,
	0 NR_ALTAS,
	0 NR_OBITOS,
	0 NR_TRANSF_ENTRADA,
	0 NR_TRANSF_SAIDA,
	0 NR_TRANSF_ENT_INT,
	0 NR_TRANSF_ENT_EXT,
	0 NR_TRANSF_SAIDA_INT,
	0 NR_TRANSF_SAIDA_EXT,
	0 qt_admitido_alta_dia,
	A.HR_ALTA,
	ie_tipo_convenio,
	cd_espec_medico,
	sum(qt_leito_livre) qt_leito_livre,
	cd_procedimento,
	A.ds_procedimento,
	A.ds_estabelecimento,
	substr(obter_desc_motivo_alta(A.cd_motivo_alta),1,255),
	A.cd_motivo_alta,
	A.cd_empresa,
	A.cd_classif_etaria,
	A.ds_classif_etaria,
	A.cd_estabelecimento_base,
	A.cd_municipio_ibge,
	A.nr_seq_queixa,
	A.ds_queixa,
	A.cd_categoria,
	A.ds_categoria,
	A.nr_seq_forma_chegada,
	A.ds_forma_chegada,
	A.nr_horario,
	coalesce(A.cd_convenio_glosa,0),
	A.cd_categoria_glosa,
	A.ds_convenio_glosa,
	A.ds_categoria_glosa,
	A.ds_indicacao,
	A.NR_SEQ_INDICACAO,
	A.cd_pessoa_fisica,
	A.ie_carater_inter_sus,
	A.ds_carater_atend,
	A.cd_empresa_conv,
	substr(coalesce(obter_nome_emp_ref(A.cd_empresa_conv),obter_texto_tasy(1098949,null)),1,100) ds_empresa_conv,
	A.ds_agrupamento,
	coalesce(A.nr_seq_agrupamento,0) nr_seq_Agrupamento,
	A.nr_seq_classificacao,
	ds_grupo,                       
	ds_subgrupo,                    
	ds_forma_organizacao, 	                   
	ds_grupo_proc,
	ds_area_proc,
	ds_especialidade_proc,
	A.cd_grupo,
	A.cd_subgrupo,
	A.cd_forma_organizacao,
	A.cd_grupo_proc,
	A.cd_area_proc,
	A.cd_especialidade_proc,
	A.cd_proced_principal,
	A.ds_proced_principal,
	A.ds_classif_atend,
	A.ds_estado_civil,
	A.nr_control,
	A.dt_entrada,
	A.dt_alta
FROM	EIS_OCUPACAO_HOSPITALAR A
GROUP 	BY ds_faixa_etaria, 
	ds_idade,
	cd_idade,
	A.cd_convenio,
	A.cd_pessoa_fisica,
	A.cd_estabelecimento,
	obter_sexo_pf(A.cd_pessoa_fisica,'C'),
	A.IE_PERIODO,
	A.cd_tipo_acomodacao,
	A.cd_setor_atendimento,
	A.cd_cid_principal,
	A.ie_clinica,
	'(' || cd_cid_principal ||')'|| ' - '|| substr(ds_cid_principal,1,200),
	cd_categoria_cid,
	ds_categoria_cid,
	A.DT_REFERENCIA,
	coalesce(A.CD_MEDICO,'0'),
	nm_pessoa_fisica,
	to_char(A.dt_referencia, 'dd/mm/yyyy'),
	(to_char(A.dt_referencia, 'd'))::numeric ,
	A.IE_SITUACAO,
	A.cd_procedencia,
	A.ie_TIPO_ATENDIMENTO,
	(to_char(A.hr_alta,'00'))::numeric ,
	A.nr_seq_origem,
	A.ie_sexo,
	A.ie_clinica_alta,
	A.HR_ALTA,
	ie_tipo_convenio,
	cd_espec_medico,
	nm_paciente,
	cd_procedimento,
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,100),
	substr(obter_nome_estabelecimento(A.cd_estabelecimento),1,80),
	substr(obter_desc_motivo_alta(A.cd_motivo_alta),1,255),
	A.cd_motivo_alta,
	A.cd_empresa,
	Obter_classif_etaria(A.cd_estabelecimento,A.cd_pessoa_fisica,'C'),
	obter_valor_dominio(1698, Obter_classif_etaria(A.cd_estabelecimento,A.cd_pessoa_fisica,'C')),
	A.cd_estabelecimento_base,
	substr(coalesce(obter_compl_pf(A.cd_pessoa_fisica,1,'CDM'),null),1,100),
	A.nr_seq_queixa,
	ds_queixa,
	A.cd_categoria,
	substr(obter_nome_convenio(A.cd_convenio)||' - '||obter_categoria_convenio(A.cd_convenio,A.cd_categoria),1,200),
	A.nr_seq_forma_chegada,
	substr(coalesce(obter_desc_forma_chegada(A.nr_seq_forma_chegada),obter_texto_tasy(1098949,null)),1,255),
	(to_char(A.dt_entrada,'hh24'))::numeric ,
	A.cd_convenio_glosa,
	A.cd_categoria_glosa,
	substr(coalesce(obter_nome_convenio(A.cd_convenio_glosa),obter_texto_tasy(1098949,null)),1,100),
	substr(coalesce(obter_categoria_convenio(A.cd_convenio_glosa,A.cd_categoria_glosa),obter_texto_tasy(1098949,null)),1,200),
	substr(coalesce(OBTER_DESC_INDICACAO(A.NR_SEQ_INDICACAO),obter_texto_tasy(1098949,null)),1,100),
	A.NR_SEQ_INDICACAO,
	A.cd_pessoa_fisica,
	A.ie_carater_inter_sus,
	ds_carater_atend,
	A.cd_empresa_conv,
	A.ds_agrupamento,
	coalesce(A.nr_seq_agrupamento,0),
	A.nr_seq_classificacao,
	ds_grupo,                       
	ds_subgrupo,                    
	ds_forma_organizacao, 	                   
	ds_grupo_proc,
	ds_area_proc,
	ds_especialidade_proc,
	A.cd_grupo,
	A.cd_subgrupo,
	A.cd_forma_organizacao,
	A.cd_grupo_proc,
	A.cd_area_proc,
	A.cd_especialidade_proc,
	A.cd_proced_principal,
	ds_proced_principal,
	ds_classif_atend,
	ds_estado_civil,	
	nr_control,
	A.dt_entrada,
	A.dt_alta,  
	qt_hora_alta,
  	ds_referencia,
  	cd_dia,
  	nr_pac_dia,
  	qt_temp,
  	nr_transf_ent_int,
  	nr_transf_ent_ext,
  	nr_transf_saida_int,
  	nr_transf_saida_ext,
  	cd_especialidade,
  	ds_procedimento,
  	ds_estabelecimento,
  	ds_motivo_alta,
  	cd_classif_etaria,
  	ds_classif_etaria,
  	cd_estabelecimento_base,
  	cd_municipio_ibge,
  	ds_categoria,
  	ds_forma_chegada,
  	nr_horario,
  	ds_convenio_glosa,
  	ds_categoria_glosa,
  	ds_indicacao,
  	ds_empresa_conv;

