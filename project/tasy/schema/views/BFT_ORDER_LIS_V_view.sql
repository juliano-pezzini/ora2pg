-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_order_lis_v (prescription_number, prescription_item_sequence, procedure_code, internal_procedure_code, lab_sequence_code, exam_procedure_name, ordering_provider_id_number, ordering_provider_given_name, ordering_provider_last_name, ordering_provider_middle_name, released_user_provider_num, requesting_physician, diagnostic_service_section_id, priority, requested_date_time, interval_date_time, start_date_time, internal_prescription_code, relevant_clinical_data, notes, sample_collection_time, sample_collected_person_code, is_external_collection, collection_department_code, pieces_quantity_for_exam, exam_department_code, notes_for_collection, quantity_of_specimen_container, is_suspended, suspended_time, exam_material_code, lab_exam_status, ie_default_sample, integration_exam_code, lab_exam_code, nr_prescricao, nr_seq_proc_hor, nr_seq_interno, date_acknowledged, user_acknowledged, identifier_material_code, material_name) AS select	a.nr_prescricao prescription_number,
	a.nr_sequencia prescription_item_sequence,
	a.cd_procedimento procedure_code,
	a.nr_seq_proc_interno internal_procedure_code,
	a.nr_seq_exame lab_sequence_code,
	elimina_acentuacao(f.nm_exame) exam_procedure_name,
	b.cd_medico ordering_provider_id_number,
	obter_dados_pf(b.cd_medico,'PNG') ordering_provider_given_name,
	obter_dados_pf(b.cd_medico,'PNL') ordering_provider_last_name,
	obter_dados_pf(b.cd_medico,'PNM') ordering_provider_middle_name,
	get_provider_details(b.cd_medico, b.cd_estabelecimento, null) released_user_provider_num,
	substr(obter_nome_pf(a.cd_medico_exec),1,80) requesting_physician,
	substr(
	(select max(x.ds_modalidade)
		FROM regra_proc_interno_integra x
		where x.nr_seq_proc_interno = a.nr_seq_proc_interno
		),1,10) diagnostic_service_section_id,
	a.ie_urgencia priority,
	b.dt_liberacao requested_date_time,
	d.dt_horario interval_date_time,
	coalesce(d.dt_horario,a.dt_prev_execucao) start_date_time,
	a.nr_seq_interno internal_prescription_code,
	a.ds_dado_clinico relevant_clinical_data,
	substr(a.ds_observacao,1,4000) notes,
	a.dt_coleta sample_collection_time,
	a.cd_pessoa_coleta sample_collected_person_code,
	a.ie_coleta_externa is_external_collection,
	a.cd_setor_coleta collection_department_code,
	a.qt_peca_ap pieces_quantity_for_exam,
	a.cd_setor_atendimento exam_department_code,
	a.ds_observacao_coleta notes_for_collection,
	a.qt_frasco_env quantity_of_specimen_container,
	a.ie_suspenso is_suspended,
	a.dt_suspensao suspended_time,
	a.cd_material_exame exam_material_code,
	a.ie_status_atend lab_exam_status,
	g.ie_padrao_amostra ie_default_sample,
	f.cd_exame_integracao integration_exam_code,
	f.cd_exame lab_exam_code,
	b.nr_prescricao,
	d.nr_sequencia nr_seq_proc_hor,
	a.nr_seq_interno,
	(select max(dt_atualizacao_nrec)
	from laudo_paciente_ciente lpc
	where lpc.nr_sequencia = (select  max(x.nr_sequencia)
				from laudo_paciente_ciente x
				where x.nr_prescricao = a.nr_prescricao
				and x.nr_seq_prescricao = a.nr_sequencia
				and x.ie_tipo_acao = 'M'))  date_acknowledged,
	substr(get_user_report_ack(a.nr_prescricao,a.nr_sequencia),1,20) user_acknowledged,
	return_mat_integracao(a.nr_seq_interno, 'C') identifier_material_code,
	return_mat_integracao(a.nr_seq_interno, 'D') material_name
	from 	prescr_procedimento a,
	prescr_medica b,
	prescr_proc_hor d,
	exame_laboratorio f,
	lab_parametro g,
	proc_interno h,
	procedimento i
where	a.nr_prescricao     			= b.nr_prescricao
and	a.nr_seq_exame       is not null
and	g.cd_estabelecimento  		= b.cd_estabelecimento
and	a.nr_seq_exame        		= f.nr_seq_exame
and	b.dt_liberacao       is not null
and	h.cd_procedimento 			= i.cd_procedimento
and	h.ie_origem_proced 		= i.ie_origem_proced
and	h.nr_seq_exame_lab		= f.nr_seq_exame
and 	exists (select 1 from proc_interno_integracao p where ((p.nr_seq_proc_interno = a.nr_seq_proc_interno) or (p.cd_tipo_procedimento 	= coalesce(i.cd_tipo_procedimento,0))) and coalesce(p.cd_estabelecimento,coalesce(b.cd_estabelecimento,0)) = coalesce(b.cd_estabelecimento,0))
and   	a.nr_prescricao		= 	d.nr_prescricao
and   	a.nr_sequencia      = 	d.nr_seq_procedimento
and	a.nr_seq_proc_interno 	=   h.nr_sequencia;

