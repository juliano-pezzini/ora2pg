-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_mensalidade_peona_v (dt_mes_referencia, vl_mensalidade, vl_coparticipacao, vl_liq_sem_copartic, vl_mens_definitivo, vl_antecipacao_rata, vl_pro_rata_dia, vl_cancelado, vl_imposto, vl_antecipacao, vl_antecipacao_rata_ant, vl_manual, vl_carteirinha, cd_estabelecimento) AS select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	sum(CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_item)  ELSE abs(d.vl_pro_rata_dia) END ) vl_mensalidade,
	sum(CASE WHEN d.ie_tipo_item='3' THEN abs(d.vl_item)  ELSE 0 END ) vl_coparticipacao,
	(sum(CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_item)  ELSE abs(d.vl_pro_rata_dia) END ) - sum(CASE WHEN d.ie_tipo_item='3' THEN CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_item)  ELSE abs(d.vl_pro_rata_dia) END   ELSE 0 END )) vl_liq_sem_copartic,
	sum(CASE WHEN a.ie_status=2 THEN CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_item)  ELSE abs(d.vl_pro_rata_dia) END   ELSE 0 END ) vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
FROM	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	b.ie_cancelamento is null
and	d.ie_tipo_item	not in ('20','11')
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	sum(CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_antecipacao)  ELSE 0 END ) vl_antecipacao_rata,
	sum(abs(d.vl_pro_rata_dia)) vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	b.ie_cancelamento is null
and	d.ie_tipo_item	not in ('20','11')
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	sum(abs(d.vl_item)) vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	d.nr_seq_mensalidade_seg = c.nr_sequencia
and	b.ie_cancelamento = 'C'
and	a.dt_contabilizacao is null
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(a.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	sum(abs(e.vl_tributo)) vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade c,
	titulo_receber d,
	titulo_receber_trib e,
	tributo f
where	c.nr_seq_lote	=  a.nr_sequencia
and	c.nr_sequencia =  d.nr_seq_mensalidade
and	d.nr_titulo    =  e.nr_titulo
and	e.cd_tributo   = f.cd_tributo
and	c.ie_cancelamento is null
and	f.ie_soma_diminui <> 'N'
group by	trunc(a.dt_mesano_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(a.dt_contabilizacao,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	sum(abs(a.vl_lote)) vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a
group by	trunc(a.dt_contabilizacao,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(add_months(c.dt_mesano_referencia,1),'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	sum(CASE WHEN a.dt_contabilizacao IS NULL THEN abs(d.vl_antecipacao)  ELSE 0 END ) vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	b.ie_cancelamento is null
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(add_months(c.dt_mesano_referencia,1),'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(b.dt_referencia,'month') dt_mes_referencia,
	sum(abs(d.vl_item)) vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= d.nr_seq_mensalidade
and	b.ie_cancelamento is null
group by	trunc(b.dt_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	sum(abs(d.vl_item)) vl_manual,
	0 vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	d.ie_tipo_item	= '20'
and	b.ie_cancelamento is null
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		a.cd_estabelecimento

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_mens_definitivo,
	0 vl_antecipacao_rata,
	0 vl_pro_rata_dia,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antecipacao,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	sum(abs(d.vl_item)) vl_carteirinha,
	a.cd_estabelecimento
from	pls_lote_mensalidade a,
	pls_mensalidade b,
	pls_mensalidade_segurado c,
	pls_mensalidade_seg_item d
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	d.ie_tipo_item	= '11'
and	pls_obter_se_exclui_seg_peona(c.nr_seq_segurado, c.dt_mesano_referencia, a.cd_estabelecimento) = 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		a.cd_estabelecimento;

