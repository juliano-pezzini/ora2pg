-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sp_matproc_exames_realizados_v (cd_setor_atendimento, ie_proc_mat, nr_atendimento, nr_interno_conta, nm_paciente, vl_item, vl_item2, vl_item3, ie_status_acerto, dt_periodo_inicial, ie_cancelamento, nr_seq_protocolo, nr_seq_proc_pacote, cd_item, cd_convenio_parametro, ie_tipo_atendimento) AS SELECT		a.cd_setor_atendimento,
		1 ie_proc_mat,
		a.nr_atendimento,
		a.nr_interno_conta,
		SUBSTR(obter_pessoa_atendimento(a.nr_atendimento, 'N'),1,100) nm_paciente,
		SUM(CASE WHEN obter_se_contido(b.ie_classificacao,'1')='S' THEN  a.vl_procedimento  ELSE 0 END ) vl_item,
		SUM(CASE WHEN obter_se_contido(b.ie_classificacao,'2')='S' THEN  a.vl_procedimento  ELSE 0 END ) vl_item2,
		SUM(CASE WHEN obter_se_contido(b.ie_classificacao,'3')='S' THEN  a.vl_procedimento  ELSE 0 END ) vl_item3,
		c.ie_status_acerto,
		c.dt_periodo_inicial,
		c.ie_cancelamento,
		c.nr_seq_protocolo,
		a.nr_seq_proc_pacote,
		a.cd_procedimento cd_item,
		c.cd_convenio_parametro,
		d.ie_tipo_atendimento
FROM		procedimento_paciente a,
		procedimento b,
		atendimento_paciente d,
		conta_paciente c
WHERE		a.cd_procedimento = b.cd_procedimento
AND		a.ie_origem_proced = b.ie_origem_proced
AND		a.nr_interno_conta = c.nr_interno_conta
AND		c.nr_atendimento = d.nr_atendimento
GROUP BY		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.nr_interno_conta,
		c.ie_status_acerto,
		c.dt_periodo_inicial,
		c.ie_cancelamento,
		c.nr_seq_protocolo,
		a.nr_seq_proc_pacote,
		a.cd_procedimento,
		c.cd_convenio_parametro,
		d.ie_tipo_atendimento

UNION ALL

SELECT		a.cd_setor_atendimento,
		2 ie_proc_mat,
		a.nr_atendimento,
		a.nr_interno_conta,
		SUBSTR(obter_pessoa_atendimento(a.nr_atendimento, 'N'),1,100) nm_paciente,
		SUM(CASE WHEN obter_se_contido(b.ie_tipo_material,'1,4')='S' THEN  a.vl_material  ELSE 0 END ) vl_item,
		SUM(CASE WHEN obter_se_contido(b.ie_tipo_material,'2,3')='S' THEN  a.vl_material  ELSE 0 END ) vl_item2,
		SUM(CASE WHEN obter_se_contido(b.ie_tipo_material,'5')='S' THEN  a.vl_material  ELSE 0 END ) vl_item3,
		c.ie_status_acerto,
		c.dt_periodo_inicial,
		c.ie_cancelamento,
		c.nr_seq_protocolo,
		a.nr_seq_proc_pacote,
		a.cd_material cd_item,
		c.cd_convenio_parametro,
		d.ie_tipo_atendimento
FROM		material_atend_paciente a,
		material b,
		atendimento_paciente d,
		conta_paciente c
WHERE		a.cd_material = b.cd_material
AND		a.nr_interno_conta = c.nr_interno_conta
AND		c.nr_atendimento = d.nr_atendimento
GROUP BY		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.nr_interno_conta,
		c.ie_status_acerto,
		c.dt_periodo_inicial,
		c.ie_cancelamento,
		c.nr_seq_protocolo,
		a.nr_seq_proc_pacote,
		a.cd_material,
		c.cd_convenio_parametro,
		d.ie_tipo_atendimento
ORDER BY		1;

