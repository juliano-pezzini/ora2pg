-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW protocolo_int_pac_statistic_v (ie_tp, ie_ta, ds_tipo_atendimento, cd_departamento, ds_departamento, dt_ent, dt_sai, nr_atendimento, cd_pf, nm_protocolo, dt_inip, dt_fimp, nr_seqp, ie_statusp, cd_pfp, ie_variacao) AS SELECT IE_TP,
         IE_TIPO_ATENDIMENTO IE_TA,
         COALESCE(OBTER_DESCRICAO_DOMINIO(12, IE_TIPO_ATENDIMENTO), OBTER_DESC_EXPRESSAO(309956)) DS_TIPO_ATENDIMENTO,
         CD_DEPARTAMENTO,
         (SELECT MAX(DS_DEPARTAMENTO) FROM DEPARTAMENTO_MEDICO WHERE CD_DEPARTAMENTO = a.CD_DEPARTAMENTO) DS_DEPARTAMENTO,
         DT_ENTRADA DT_ENT,
         DT_SAIDA DT_SAI,
         NR_ATENDIMENTO,
         CD_PESSOA_FISICA CD_PF,
         NM_PROTOCOLO,
         DT_INICIO_PROTOCOLO DT_INIP,
         DT_FIM_PROTOCOLO DT_FIMP,
         NR_SEQUENCIA_PROTOCOLO NR_SEQP,
         IE_STATUSP,
         CD_PESSOA_FISICA_PROTOCOLO CD_PFP,
         IE_VARIACAO
  FROM (

SELECT  'D' IE_TP,
        A.IE_TIPO_ATENDIMENTO,
        OBTER_DEPARTAMENTO_DATA(A.NR_ATENDIMENTO, FIM_DIA(coalesce(B.DT_ENTRADA_UNIDADE,A.DT_ENTRADA))) CD_DEPARTAMENTO,  
        coalesce(B.DT_ENTRADA_UNIDADE,A.DT_ENTRADA) DT_ENTRADA,
        coalesce(B.DT_SAIDA_UNIDADE,A.DT_SAIDA_REAL) DT_SAIDA,
        A.NR_ATENDIMENTO,
        A.CD_PESSOA_FISICA,
        NULL NM_PROTOCOLO,
        NULL DT_INICIO_PROTOCOLO,
        NULL DT_FIM_PROTOCOLO,
        NULL NR_SEQUENCIA_PROTOCOLO,
        NULL IE_STATUSP,
        NULL CD_PESSOA_FISICA_PROTOCOLO,
        'N' IE_VARIACAO
FROM atendimento_paciente a
LEFT OUTER JOIN atend_paciente_unidade b ON (A.NR_ATENDIMENTO = B.NR_ATENDIMENTO)
WHERE A.IE_TIPO_ATENDIMENTO in (1, 8)


 
union all

select 'P' IE_TP,
        A.IE_TIPO_ATENDIMENTO,
        OBTER_DEPARTAMENTO_DATA(A.NR_ATENDIMENTO, FIM_DIA(P.DT_INICIAL_PREVISTO)) CD_DEPARTAMENTO,          
        P.DT_INICIAL_PREVISTO DT_ENTRADA,
        coalesce(P.DT_FINAL_PREVISTO,P.DT_FINALIZACAO) DT_SAIDA,
        A.NR_ATENDIMENTO,
        null CD_PESSOA_FISICA,
        P.DS_TRATAMENTO NM_PROTOCOLO,
        P.DT_INICIAL_PREVISTO DT_INICIO_PROTOCOLO,
        coalesce(P.DT_FINALIZACAO, P.DT_FINAL_PREVISTO) DT_FIM_PROTOCOLO,
        P.NR_SEQUENCIA NR_SEQUENCIA_PROTOCOLO,
        P.IE_STATUS IE_STATUSP,
        A.CD_PESSOA_FISICA CD_PESSOA_FISICA_PROTOCOLO,        
        CASE WHEN P.IE_VARIACAO = 'S' THEN 'S' ELSE (SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END 
                                                       FROM PROTOCOLO_INT_PAC_ETAPA    ET,
                                                            PROTOCOLO_INT_PAC_EVENTO   EV,
                                                            PROTOCOLO_INT_PAC_VARIANCE VA
                                                      WHERE ET.NR_SEQUENCIA = EV.NR_SEQ_PRT_INT_PAC_ETAPA
                                                        AND EV.NR_SEQUENCIA = VA.NR_SEQ_EVENTO
                                                        AND VA.IE_SITUACAO  = 'A'
                                                        AND ET.NR_SEQ_PROTOCOLO_INT_PAC = P.NR_SEQUENCIA) END IE_VARIACAO
FROM atendimento_paciente a, protocolo_int_paciente p
LEFT OUTER JOIN protocolo_integrado q ON (P.NR_SEQUENCIA_PROTOCOLO = Q.NR_SEQUENCIA)
WHERE P.IE_STATUS IN ('A', 'F') AND A.NR_ATENDIMENTO = P.NR_ATENDIMENTO_ORIGEM  AND coalesce(Q.IE_TIPO,'CP') <> 'CS' AND A.IE_TIPO_ATENDIMENTO in (1, 8)
 ) a
WHERE CD_DEPARTAMENTO IS NOT NULL;

