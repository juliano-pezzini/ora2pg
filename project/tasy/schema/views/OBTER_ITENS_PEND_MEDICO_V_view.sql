-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW obter_itens_pend_medico_v (seq, nr_atendimento, ds_item, ds_tipo, cd_medico, nm_usuario_nrec) AS select 1 seq,
        nr_atendimento nr_atendimento, 
        substr(obter_desc_material(cd_material),1,255) ds_item, 
        substr(obter_desc_expressao(10652448),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 FROM   cpoe_material a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    coalesce(a.nr_seq_receita_amb, 0) = 0 
 and    coalesce(a.ie_retrogrado, 'N') = 'N' 
 and    coalesce(a.ie_controle_tempo, 'N') = 'N' 
 and    ((((coalesce(a.ie_evento_unico, 'N') = 'N') and (a.nr_seq_adicional is null) and (a.nr_seq_ataque is null)) and (coalesce(a.ie_material, 'N') = 'N')) or (not exists (select  1 
                      from   prescr_medica y, 
                             prescr_material z 
                      where  y.nr_prescricao = z.nr_prescricao 
                        and  y.nr_atendimento = a.nr_atendimento 
                        and  z.nr_seq_mat_cpoe = a.nr_sequencia))) 
 and    coalesce(a.ie_baixado_por_alta, 'N') = 'N' 
 and    coalesce(a.ie_material, 'N') = 'N' 
 and    coalesce(a.cd_funcao_origem, 2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END ) = 'S') or 
        ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
  
--SOLUCAO
 select 2 seq, 
        nr_atendimento nr_atendimento, 
        substr(obter_desc_material(cd_material),1,255) ds_item, 
        substr(obter_desc_expressao(298683),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_material a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    coalesce(a.nr_seq_receita_amb, 0) = 0 
 and    coalesce(a.ie_retrogrado, 'N') = 'N' 
 and    coalesce(a.ie_controle_tempo, 'N') = 'S' 
 and    ((((coalesce(a.ie_evento_unico, 'N') = 'N') and (a.nr_seq_adicional is null) and (a.nr_seq_ataque is null)) and (coalesce(a.ie_material, 'N') = 'N')) or (not exists (select  1 
                       from  prescr_medica y, 
                             prescr_material z 
                      where  y.nr_prescricao = z.nr_prescricao 
                      and    y.nr_atendimento = a.nr_atendimento 
                      and    z.nr_seq_mat_cpoe = a.nr_sequencia))) 
 and    coalesce(a.ie_baixado_por_alta, 'N') = 'N' 
 and    coalesce(a.ie_material, 'N') = 'N' 
 and    coalesce(a.cd_funcao_origem, 2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  coalesce(a.dt_fim_cih, a.dt_fim)  ELSE coalesce(a.dt_suspensao, a.dt_fim) END ) = 'S') or 
        ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
 
--Dietas
 select 3 seq, 
        nr_atendimento nr_atendimento,  
        substr(cpoe_obter_desc_dieta_simp(nr_sequencia),1,255) ds_item, 
        substr(obter_desc_expressao(294515),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_dieta a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    coalesce(a.ie_retrogrado,'N') = 'N' 
 and    ((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (  select  1 
                            from  prescr_medica y 
                            where  y.nr_atendimento = a.nr_atendimento 
                            and     exists (select  1 
                                            from  prescr_material z 
                                            where  z.nr_prescricao = y.nr_prescricao 
                                            and  z.nr_seq_dieta_cpoe = a.nr_sequencia 
                                            
union
 
                                            select  1 
                                            from  prescr_dieta z 
                                            where  z.nr_prescricao = y.nr_prescricao 
                                            and     z.nr_seq_dieta_cpoe = a.nr_sequencia 
                                            
union
 
                                            select  1 
                                            from  rep_jejum z 
                                            where  z.nr_prescricao = y.nr_prescricao 
                                            and  z.nr_seq_dieta_cpoe = a.nr_sequencia 
                                            
union
 
                                            select  1 
                                            from  prescr_leite_deriv z 
                                            where  z.nr_prescricao = y.nr_prescricao 
                                            and  z.nr_seq_dieta_cpoe = a.nr_sequencia 
                                            
union
 
                                            select  1 
                                            from  nut_pac z 
                                            where  z.nr_prescricao = y.nr_prescricao 
                                            and  z.nr_seq_npt_cpoe = a.nr_sequencia)))) 
 and    coalesce(a.ie_baixado_por_alta,'N') = 'N' 
 and    coalesce(a.ie_dose_unica,'N') = 'N' 
 and    coalesce(a.cd_funcao_origem,2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or 
                                 ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
 
--Recomendacao
 select 4 seq, 
        nr_atendimento nr_atendimento,  
        substr(cpoe_obter_desc_recomendacao(cd_recomendacao),1,255) ds_item, 
        substr(obter_desc_expressao(297341),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_recomendacao a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    coalesce(a.ie_retrogrado,'N') = 'N' 
 and    ((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (    select  1 
                            from    prescr_medica y, 
                                    prescr_recomendacao z 
                            where   y.nr_prescricao = z.nr_prescricao 
                            and     y.nr_atendimento = a.nr_atendimento 
                            and     z.nr_seq_rec_cpoe = a.nr_sequencia))) 
 and    coalesce(a.ie_baixado_por_alta,'N') = 'N' 
 and    coalesce(a.cd_funcao_origem,2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or 
                ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
 
--Gasoterapia
 select 5 seq, 
        nr_atendimento nr_atendimento, 
        substr(CPOE_Obter_Desc_Gas(nr_seq_gas),1,255) ds_item, 
        substr(obter_desc_expressao(290567),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_gasoterapia a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    coalesce(a.ie_retrogrado,'N') = 'N' 
 and    coalesce(a.ie_baixado_por_alta,'N') = 'N' 
 and    coalesce(a.cd_funcao_origem,2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, 
                                                         CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or 
                         ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
 
--Procedimento
 select 6 seq, 
        nr_atendimento nr_atendimento, 
        substr(Obter_Desc_Proc_Interno(nr_seq_proc_interno),1,255) ds_item, 
        substr(obter_desc_expressao(296422),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_procedimento a, 
        proc_interno  b 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  is null)) 
 and    a.nr_seq_proc_interno = b.nr_sequencia 
 and    a.nr_atendimento is not null 
 and    a.dt_liberacao is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    ((coalesce(b.ie_copiar_rep, 'XXX') <> 'C') or (not exists (select  1 
                        from    prescr_medica y, 
                                prescr_procedimento z 
                        where   y.nr_prescricao = z.nr_prescricao 
                        and     y.nr_atendimento = a.nr_atendimento 
                        and     z.nr_seq_proc_cpoe = a.nr_sequencia))) 
 and    coalesce(a.ie_retrogrado,'N') = 'N' 
 and    ((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (    select  1 
         from  prescr_medica y, 
           prescr_procedimento z 
         where  y.nr_prescricao = z.nr_prescricao 
         and  y.nr_atendimento = a.nr_atendimento 
         and  z.nr_seq_proc_cpoe = a.nr_sequencia))) 
 and    coalesce(a.ie_baixado_por_alta,'N') = 'N' 
 and    coalesce(a.cd_funcao_origem,2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or 
            ((a.dt_fim is null) and a.ie_duracao = 'C')) 
 
union
 
--Dialise
 select 7 seq, 
        nr_atendimento nr_atendimento, 
        substr(CPOE_obter_desc_dialise_simp(ie_tipo_dialise, ie_hemodialise, ie_tipo_peritoneal),1,255) ds_item, 
        substr(obter_desc_expressao(287725),1,100) ds_tipo,
        coalesce(a.cd_medico, obter_pessoa_fisica_usuario(a.nm_usuario_nrec, 'C')) cd_medico,
        a.nm_usuario_nrec nm_usuario_nrec
 from   cpoe_dialise a 
 where  ((CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= LOCALTIMESTAMP) or (CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  is null)) 
 and    a.nr_atendimento is not null 
 and    a.dt_prox_geracao between LOCALTIMESTAMP - interval '3 days' and LOCALTIMESTAMP + interval '3 days' 
 and    a.dt_liberacao is not null 
 and    coalesce(a.ie_retrogrado,'N') = 'N' 
 and    coalesce(a.ie_baixado_por_alta,'N') = 'N' 
 and    coalesce(a.cd_funcao_origem,2314) = 2314 
 and    ((cpoe_obter_se_copia_item_term(a.ds_horarios, null, LOCALTIMESTAMP, CASE WHEN a.dt_lib_suspensao IS NULL THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or 
            ((a.dt_fim is null) and a.ie_duracao = 'C')) 
order by nr_atendimento, seq, ds_item;

