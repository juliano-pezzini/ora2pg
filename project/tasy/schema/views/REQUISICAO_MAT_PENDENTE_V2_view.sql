-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW requisicao_mat_pendente_v2 (cd_estabelecimento, cd_local_estoque, nr_requisicao, dt_solicitacao_requisicao, dt_liberacao, dt_aprovacao, nm_usuario, dt_emissao_loc_estoque, cd_centro_custo, cd_local_estoque_destino, ie_urgente, cd_setor_atendimento, ds_setor_requisicao, ds_local_estoque, cd_operacao_estoque, ds_operacao, ds_obs, nr_seq_justificativa, cd_setor_entrega, ds_setor_usuario, ds_destino, ds_centro_custo, ds_pessoa_requisitante, ds_pessoa_solicitante, ds_geracao, ds_justificativa, dt_compra, nr_seq_ordem_serv) AS select	b.cd_estabelecimento,
	b.cd_local_estoque,
	b.nr_requisicao,
	b.dt_solicitacao_requisicao,
	b.dt_liberacao,
	b.dt_aprovacao,
	b.nm_usuario,
	b.dt_emissao_loc_estoque,
	b.cd_centro_custo,
	b.cd_local_estoque_destino,
	b.ie_urgente,
	b.cd_setor_atendimento,
	c.ds_setor_atendimento ds_setor_requisicao,
	l.ds_local_estoque,
	b.cd_operacao_estoque,
	o.ds_operacao,
	b.ds_observacao ds_obs,
	b.nr_seq_justificativa,
	b.cd_setor_entrega,
	substr(obter_dados_usuario_opcao(b.nm_usuario,'DS'),1,40) ds_setor_usuario,
	h.ds_local_estoque ds_destino,
	d.ds_centro_custo ds_centro_custo,
	substr(obter_nome_pf(e.cd_pessoa_fisica),1,255) ds_pessoa_requisitante,
	substr(obter_nome_pf(f.cd_pessoa_fisica),1,255) ds_pessoa_solicitante,
	substr(CASE WHEN b.ie_geracao='A' THEN 'Automática' WHEN b.ie_geracao='AC' THEN 'Automática'  ELSE 'MANUAL' END ,1,30) ds_geracao,
	g.ds_motivo ds_justificativa,
	b.dt_compra,
	b.nr_seq_ordem_serv
FROM operacao_estoque o, local_estoque l, pessoa_fisica e, requisicao_material b
LEFT OUTER JOIN setor_atendimento c ON (b.cd_setor_atendimento = c.cd_setor_atendimento)
LEFT OUTER JOIN centro_custo d ON (b.cd_centro_custo = d.cd_centro_custo)
LEFT OUTER JOIN pessoa_fisica f ON (b.cd_pessoa_solicitante = f.cd_pessoa_fisica)
LEFT OUTER JOIN motivo_justif_req g ON (b.nr_seq_justificativa = g.nr_sequencia)
LEFT OUTER JOIN local_estoque h ON (b.cd_local_estoque_destino = h.cd_local_estoque)
WHERE b.cd_local_estoque = l.cd_local_estoque and b.cd_operacao_estoque = o.cd_operacao_estoque and b.cd_pessoa_requisitante = e.cd_pessoa_fisica      and b.dt_baixa is null and exists (	select 	1
		from 	item_requisicao_material c
		where	b.nr_requisicao	= c.nr_requisicao		
		and	coalesce(c.cd_motivo_baixa, 0) = 0);

