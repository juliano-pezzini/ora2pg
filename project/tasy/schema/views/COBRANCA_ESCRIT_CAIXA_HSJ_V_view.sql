-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cobranca_escrit_caixa_hsj_v (ie_reg, tp_registro, nr_seq_envio, dt_remessa_retorno, dt_credito, cd_banco, cd_cgc, cd_agencia_bancaria, nr_conta_corrente, ie_digito_conta, nm_empresa, nr_titulo, nr_doc_cobranca, dt_vencimento, dt_emissao, dt_desconto, dt_juros_mora, vl_cobranca, vl_juros_mora, vl_desconto, ie_tipo_inscricao, nr_inscricao, nm_pessoa, ds_endereco, nr_endereco, ds_complemento, ds_bairro, cd_cep, ds_cidade, ds_uf, qt_cobranca_simples, vl_carteira_simples, ie_emissao_bloqueto, ds_nosso_numero, qt_lote_arquivo, qt_reg_arquivo, nm_banco, ds_mensagem, ds_carteira, nm_segurado, ds_idade, ds_produto, vl_mensalidade, vl_multa, ie_ordem_int, cd_convenio, cd_carteira, ie_dig_ag_conta, cd_titular, ds_reajuste, nr_parcela, ds_tipo_item, dt_protocolo, qt_segurado) AS select	1 ie_reg,
	1 tp_registro, 
	a.nr_sequencia nr_seq_envio, 
	a.dt_remessa_retorno, 
	a.dt_remessa_retorno dt_credito, 
	a.cd_banco, 
	b.cd_cgc, 
	lpad(c.cd_agencia_bancaria,5,'0') cd_agencia_bancaria, 
	c.cd_conta nr_conta_corrente, 
	c.ie_digito_conta, 
	substr(obter_razao_social(b.cd_cgc),1,50) nm_empresa, 
	0 nr_titulo, 
	0 nr_doc_cobranca, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	a.dt_remessa_retorno dt_desconto, 
	LOCALTIMESTAMP dt_juros_mora, 
	0 vl_cobranca, 
	0 vl_juros_mora, 
	0 vl_desconto, 
	0 ie_tipo_inscricao, 
	'' nr_inscricao, 
	'0' nm_pessoa, 
	'' ds_endereco, 
	'' nr_endereco, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	'' ds_cidade, 
	'' ds_uf, 
	0 qt_cobranca_simples, 
	0 vl_carteira_simples, 
	'' ie_emissao_bloqueto, 
	'' ds_nosso_numero, 
	0 qt_lote_arquivo, 
	0 qt_reg_arquivo, 
	substr(obter_nome_banco(a.cd_banco),1,30) nm_banco, 
	'' ds_mensagem, 
	'' ds_carteira, 
	'' nm_segurado, 
	'' ds_idade, 
	'' ds_produto, 
	'' vl_mensalidade, 
	0 vl_multa, 
	0 ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	'' cd_titular, 
	'' ds_reajuste, 
	0 nr_parcela, 
	'' ds_tipo_item, 
	to_Date(null) dt_protocolo, 
	0 qt_segurado 
FROM	banco_estabelecimento c, 
	estabelecimento b, 
	cobranca_escritural a 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 

union all
 
/*	Header do Lote	*/
 
select	2 ie_reg, 
	2 tp_registro, 
	a.nr_sequencia nr_seq_envio, 
	a.dt_remessa_retorno, 
	a.dt_remessa_retorno dt_credito, 
	a.cd_banco, 
	b.cd_cgc, 
	lpad(c.cd_agencia_bancaria,5,'0') cd_agencia_bancaria, 
	c.cd_conta nr_conta_corrente, 
	c.ie_digito_conta, 
	substr(obter_razao_social(b.cd_cgc),1,50) nm_empresa, 
	0 nr_titulo, 
	0 nr_doc_cobranca, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	a.dt_remessa_retorno dt_desconto, 
	LOCALTIMESTAMP dt_juros_mora, 
	0 vl_cobranca, 
	0 vl_juros_mora, 
	0 vl_desconto, 
	0 ie_tipo_inscricao, 
	'' nr_inscricao, 
	'0' nm_pessoa, 
	'' ds_endereco, 
	'' nr_endereco, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	'' ds_cidade, 
	'' ds_uf, 
	0 qt_cobranca_simples, 
	0 vl_carteira_simples, 
	a.ie_emissao_bloqueto, 
	'' ds_nosso_numero, 
	0 qt_lote_arquivo, 
	0 qt_reg_arquivo, 
	'' nm_banco, 
	'' ds_mensagem, 
	'' ds_carteira, 
	'' nm_segurado, 
	'' ds_idade, 
	'' ds_produto, 
	'' vl_mensalidade, 
	0 vl_multa, 
	0 ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	'' cd_titular, 
	'' ds_reajuste, 
	0 nr_parcela,	 
	'' ds_tipo_item, 
	to_Date(null) dt_protocolo, 
	0 qt_segurado 
from	estabelecimento b, 
	banco_estabelecimento c, 
	cobranca_escritural a 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 

union all
 
/*	Segmento P	,	Segmento Q	,	Segmento R	 */
 
select	distinct 3 ie_reg, 
	3 tp_registro, 
	a.nr_sequencia nr_seq_envio, 
	LOCALTIMESTAMP dt_remessa_retorno, 
	LOCALTIMESTAMP dt_credito, 
	a.cd_banco, 
	'' cd_cgc, 
	c.cd_agencia_bancaria, 
	c.nr_conta nr_conta_corrente, 
	c.ie_digito_conta, 
	'' nm_empresa, 
	c.nr_titulo, 
	c.nr_titulo nr_doc_cobranca, 
	b.dt_pagamento_previsto dt_vencimento, 
	b.dt_emissao, 
	a.dt_remessa_retorno dt_desconto, 
	b.dt_pagamento_previsto dt_juros_mora, 
	c.vl_cobranca, 
	(b.vl_titulo * b.tx_juros / 100 / 30) vl_juros_mora, 
	b.TX_DESC_ANTECIPACAO vl_desconto, 
	coalesce(CASE WHEN b.cd_pessoa_fisica IS NULL THEN  2  ELSE 1 END ,0) ie_tipo_inscricao, 
	CASE WHEN CASE WHEN b.cd_pessoa_fisica IS NULL THEN  2  ELSE 1 END =2 THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C') WHEN CASE WHEN b.cd_pessoa_fisica IS NULL THEN  2  ELSE 1 END =1 THEN (substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C'),1,9) || '0000' || substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C'),10,2))  ELSE '000000000000000' END  nr_inscricao, 
	substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc),1,255) nm_pessoa, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'E'),1,120) ds_endereco, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'NR'),1,120) nr_endereco, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'CO'),1,120) ds_complemento, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'B'),1,40) ds_bairro, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'CEP'),1,8) cd_cep, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'CI'),1,40) ds_cidade, 
	substr(pls_obter_compl_pagador(d.nr_seq_pagador,'UF'),1,2) ds_uf, 
	0 qt_cobranca_simples, 
	0 vl_carteira_simples, 
	a.ie_emissao_bloqueto, 
	82||lpad(b.nr_titulo,8,'0')||'-'|| calcula_digito('Modulo11',(82||lpad(b.nr_titulo,8,'0'))) ds_nosso_numero, 
	0 qt_lote_arquivo, 
	0 qt_reg_arquivo, 
	substr(obter_nome_banco(a.cd_banco),1,40) nm_banco, 
	substr('Ap√≥s venc. Juros ' || to_char(b.tx_juros) || '% e Multa ' || to_char(b.tx_multa) || '% ' || b.ds_observacao_titulo,1,40) ds_mensagem, 
	'' ds_carteira, 
	'' nm_segurado, 
	'' ds_idade, 
	'' ds_produto,	 
	'' vl_mensalidade, 
	((b.vl_titulo * b.tx_multa) / 100) vl_multa, 
	0 ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	lpad(d.nr_seq_contrato,15,'0') cd_titular, 
	CASE WHEN ds_observacao_titulo IS NULL THEN 'N'  ELSE 'S' END  ds_reajuste, 
	d.nr_parcela nr_parcela, 
	'' ds_tipo_item, 
	to_Date(null) dt_protocolo, 
	0 qt_segurado 
from	pls_mensalidade d, 
	titulo_receber b, 
	titulo_receber_cobr c, 
	cobranca_escritural a 
where	a.nr_sequencia		= c.nr_seq_cobranca 
and	c.nr_titulo		= b.nr_titulo 
and	d.nr_sequencia		= b.nr_seq_mensalidade 

union all
 
/*	Segmento S		*/
 
select	distinct 3 ie_reg, 
	6 tp_registro, 
	nr_seq_envio, 
	CASE WHEN ie_tipo_contratacao='I' THEN  dt_remessa_retorno  ELSE to_date(null) END  dt_remessa_retorno, 
	CASE WHEN ie_tipo_contratacao='I' THEN  dt_credito  ELSE to_date(null) END  dt_credito,	 
	cd_banco, 
	'' cd_cgc, 
	'' cd_agencia_bancaria, 
	'' nr_conta_corrente, 
	'' ie_digito_conta, 
	'' nm_empresa, 
	nr_titulo, 
	0 nr_doc_cobranca, 
	CASE WHEN ie_tipo_contratacao='I' THEN LOCALTIMESTAMP  ELSE to_date(null) END  dt_vencimento, 
	CASE WHEN ie_tipo_contratacao='I' THEN LOCALTIMESTAMP  ELSE to_date(null) END  dt_emissao, 
	CASE WHEN ie_tipo_contratacao='I' THEN LOCALTIMESTAMP  ELSE to_date(null) END  dt_desconto, 
	CASE WHEN ie_tipo_contratacao='I' THEN LOCALTIMESTAMP  ELSE to_date(null) END  dt_juros_mora, 
	0 vl_cobranca, 
	0 vl_juros_mora, 
	0 vl_desconto, 
	0 ie_tipo_inscricao, 
	'' nr_inscricao, 
	DS_NOME_SACADO nm_pessoa, 
	'' ds_endereco, 
	'' nr_endereco, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	'' ds_cidade, 
	'' ds_uf, 
	0 qt_cobranca_simples, 
	0 vl_carteira_simples, 
	'' ie_emissao_bloqueto, 
	'' ds_nosso_numero, 
	0 qt_lote_arquivo, 
	0 qt_reg_arquivo, 
	'' nm_banco, 
	'' ds_mensagem, 
	CASE WHEN ie_tipo_contratacao='I' THEN  ds_carteira  ELSE '' END  ds_carteira, 
	CASE WHEN ie_tipo_contratacao='I' THEN  nm_segurado  ELSE '' END  nm_segurado, 
	CASE WHEN ie_tipo_contratacao='I' THEN  to_char(ds_idade)  ELSE '' END  ds_idade, 
	substr(CASE WHEN ie_tipo_contratacao='I' THEN  ds_produto  ELSE '' END ,1,255) ds_produto, 
	CASE WHEN ie_tipo_contratacao='I' THEN  to_char(vl_mensalidade)  ELSE 0 END  vl_mensalidade, 
	0 vl_multa, 
	ie_ordem ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	'' cd_titular, 
	'' ds_reajuste, 
	0 nr_parcela,	 
	CASE WHEN ie_tipo_contratacao='I' THEN  ds_tipo_item  ELSE '' END  ds_tipo_item, 
	CASE WHEN ie_tipo_contratacao='I' THEN  dt_protocolo  ELSE to_Date(null) END  dt_protocolo, 
	0 qt_segurado 
from (select	1 ie_ordem, 
		j.dt_remessa_retorno, 
		j.dt_remessa_retorno dt_credito, 
		k.nr_titulo, 
		j.cd_banco, 
		j.nr_sequencia nr_seq_envio, 
		substr(pls_obter_dados_segurado(c.nr_seq_segurado,'C'),1,30) ds_carteira, 
		substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_segurado, 
		c.qt_idade ds_idade, 
		d.vl_item vl_mensalidade, 
		substr(CASE WHEN d.ie_tipo_item='3' THEN 'Guia: ' || cd_guia || ' - Prestador: ' || substr(pls_obter_dados_prestador(h.nr_seq_prestador,'N'),1,255)   ELSE 'Produto: ' || e.nr_seq_plano || ' - ' || substr(pls_obter_dados_produto(e.nr_seq_plano,'S'),1,200) END ,1,255) ds_produto, 
		substr(obter_valor_dominio(1930,ie_tipo_item),1,255) ds_tipo_item, 
		CASE WHEN d.ie_tipo_item=3 THEN trunc(h.dt_mes_competencia,'dd')  ELSE null END  dt_protocolo, 
		i.ie_tipo_contratacao, 
		substr(obter_nome_pf_pj(l.cd_pessoa_fisica, l.cd_cgc),1,255) DS_NOME_SACADO, 
		0 qt_segurado 
	FROM titulo_receber l, titulo_receber_cobr k, cobranca_escritural j, pls_plano i, pls_segurado e, pls_mensalidade_segurado c, pls_mensalidade b, pls_mensalidade_seg_item d
LEFT OUTER JOIN pls_conta g ON (d.nr_seq_conta = g.nr_sequencia)
LEFT OUTER JOIN pls_conta_coparticipacao f ON (g.nr_sequencia = f.nr_seq_conta)
LEFT OUTER JOIN pls_protocolo_conta h ON (g.nr_seq_protocolo = h.nr_sequencia)
WHERE j.nr_sequencia     = k.nr_seq_cobranca and b.nr_sequencia     = l.nr_seq_mensalidade and l.nr_titulo       = k.nr_titulo and b.nr_sequencia     = c.nr_seq_mensalidade and c.nr_sequencia     = d.nr_seq_mensalidade_seg and c.nr_seq_segurado    = e.nr_sequencia    and e.nr_seq_plano     = i.nr_sequencia order by	nm_segurado) alias71 

union all
 
/*	Trailer do Lote	*/
 
select	4 ie_reg, 
	7 tp_registro, 
	nr_seq_envio, 
	dt_remessa_retorno, 
	dt_credito, 
	cd_banco, 
	'' cd_cgc, 
	'' cd_agencia_bancaria, 
	'' nr_conta_corrente, 
	'' ie_digito_conta, 
	'' nm_empresa, 
	0 nr_titulo, 
	0 nr_doc_cobranca, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	LOCALTIMESTAMP dt_desconto, 
	LOCALTIMESTAMP dt_juros_mora, 
	0 vl_cobranca, 
	0 vl_juros_mora, 
	0 vl_desconto, 
	0 ie_tipo_inscricao, 
	'' nr_inscricao, 
	'999999999999999999' nm_pessoa, 
	'' ds_endereco, 
	'' nr_endereco, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	'' ds_cidade, 
	'' ds_uf, 
	(( count(*) + (count(distinct nr_titulo) * 3) ) + 2) qt_cobranca_simples, 
	0 vl_carteira_simples, 
	'' ie_emissao_bloqueto, 
	'' ds_nosso_numero, 
	0 qt_lote_arquivo, 
	0 qt_reg_arquivo, 
	'' nm_banco, 
	'' ds_mensagem, 
	'' ds_carteira, 
	'' nm_segurado, 
	'' ds_idade, 
	'' ds_produto, 
	'' vl_mensalidade, 
	0 vl_multa, 
	0 ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	'' cd_titular, 
	'' ds_reajuste, 
	0 nr_parcela,	 
	'' ds_tipo_item, 
	to_Date(null) dt_protocolo, 
	count(qt_seg) qt_segurado 
from (select 1 ie_ordem, 
			a.nr_sequencia nr_seq_envio, 
			a.dt_remessa_retorno, 
			a.dt_remessa_retorno dt_credito, 
			a.cd_banco, 
			b.nr_titulo, 
			e.nr_sequencia nr_seq_seg, 
			d.nr_parcela, 
			d.qt_idade, 
			c.nr_seq_contrato, 
			e.nr_seq_plano, 
			d.nr_seq_segurado, 
			d.nr_sequencia, 
			d.vl_mensalidade, 
			count(e.nr_sequencia) qt_seg 
		from	pls_segurado 		e, 
			pls_mensalidade_segurado d, 
			pls_mensalidade 	c, 
			titulo_receber		f, 
			titulo_receber_cobr 	b, 
			cobranca_escritural 	a 
		where	a.nr_sequencia     = b.nr_seq_cobranca 
		and	f.nr_seq_mensalidade	= c.nr_sequencia 
		and	f.nr_titulo		= b.nr_titulo		 
		and	d.nr_seq_mensalidade  = c.nr_sequencia 
		and	e.nr_sequencia     = d.nr_seq_segurado 
		and	d.nr_sequencia in (	select g.nr_sequencia 
										from  pls_mensalidade_segurado g 
										where  g.nr_seq_mensalidade = c.nr_sequencia  LIMIT 4) 
		group by 
			a.nr_sequencia, 
			a.dt_remessa_retorno, 
			a.cd_banco, 
			b.nr_titulo, 
			e.nr_sequencia, 
			d.nr_parcela, 
			d.qt_idade, 
			c.nr_seq_contrato, 
			e.nr_seq_plano, 
			d.nr_seq_segurado, 
			d.nr_sequencia, 
			d.vl_mensalidade 
		
union all
 
		select	2 ie_ordem, 
			a.nr_sequencia nr_seq_envio, 
			a.dt_remessa_retorno, 
			a.dt_remessa_retorno dt_credito, 
			a.cd_banco, 
			b.nr_titulo, 
			0 nr_sequencia, 
			0 nr_parcela, 
			0 qt_idade, 
			0 nr_seq_contrato, 
			0 nr_seq_plano, 
			0 nr_seq_segurado, 
			0 nr_sequencia, 
			sum(d.vl_mensalidade), 
			count(e.nr_sequencia) qt_seg 
		from	pls_segurado 		e, 
			pls_mensalidade_segurado d, 
			pls_mensalidade 	c, 
			titulo_receber		f, 
			titulo_receber_cobr 	b, 
			cobranca_escritural 	a 
		where	a.nr_sequencia     = b.nr_seq_cobranca 
		and	c.nr_sequencia		= f.nr_seq_mensalidade 
		and	f.nr_titulo		= b.nr_titulo 
		and	d.nr_seq_mensalidade  = c.nr_sequencia 
		and	e.nr_sequencia     = d.nr_seq_segurado 
		and	d.nr_sequencia not in (select g.nr_sequencia 
						from  pls_mensalidade_segurado g 
						where  g.nr_seq_mensalidade = c.nr_sequencia  LIMIT 4) 
		group by	a.nr_sequencia, 
				a.dt_remessa_retorno, 
				a.dt_remessa_retorno, 
				a.cd_banco, 
				b.nr_titulo) alias84 
group by nr_seq_envio, 
	dt_remessa_retorno, 
	dt_credito, 
	cd_banco 

union all
	 
/*	Trailer do Arquivo	*/
 
select	5 ie_reg, 
	9 tp_registro, 
	a.nr_sequencia nr_seq_envio, 
	a.dt_remessa_retorno, 
	a.dt_remessa_retorno dt_credito, 
	a.cd_banco, 
	'' cd_cgc, 
	'' cd_agencia_bancaria, 
	'' nr_conta_corrente, 
	'' ie_digito_conta, 
	'' nm_empresa, 
	0 nr_titulo, 
	0 nr_doc_cobranca, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	a.dt_remessa_retorno dt_desconto, 
	LOCALTIMESTAMP dt_juros_mora, 
	0 vl_cobranca, 
	0 vl_juros_mora, 
	0 vl_desconto, 
	0 ie_tipo_inscricao, 
	'' nr_inscricao, 
	'999999999999999999' nm_pessoa, 
	'' ds_endereco, 
	'' nr_endereco, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	'' ds_cidade, 
	'' ds_uf, 
	count(*) qt_cobranca_simples, 
	sum(b.vl_cobranca) vl_carteira_simples, 
	'' ie_emissao_bloqueto, 
	'' ds_nosso_numero, 
	000001 qt_lote_arquivo, 
	count(*) qt_reg_arquivo, 
	'' nm_banco, 
	'' ds_mensagem, 
	'' ds_carteira, 
	'' nm_segurado, 
	'' ds_idade, 
	'' ds_produto, 
	'' vl_mensalidade, 
	0 vl_multa, 
	0 ie_ordem_int, 
	0 cd_convenio, 
	'' cd_carteira, 
	0 ie_dig_ag_conta, 
	'' cd_titular, 
	'' ds_reajuste, 
	0 nr_parcela,	 
	'' ds_tipo_item, 
	to_Date(null) dt_protocolo, 
	0 qt_segurado 
from	titulo_receber_cobr b, 
	cobranca_escritural a 
where	a.nr_sequencia		= b.nr_seq_cobranca 
group by a.nr_sequencia, 
 	 a.dt_remessa_retorno, 
	 a.dt_remessa_retorno, 
	 a.cd_banco;

