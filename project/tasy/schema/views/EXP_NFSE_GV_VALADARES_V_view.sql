-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_gv_valadares_v (cd_estabelecimento, tp_registro, tp_escrituracao, dt_emissao_int, dt_emissao, ie_situacao, nr_serie_nf, vl_servico, cd_atividade_servico, tp_pessoa, nr_nota_fiscal, nr_cnpj_cpf_prestador, nm_razao_social, nm_cidade_prestador, nm_estado_prestador, nm_end_prestador, nr_prestador, nr_cep_prestador, lc_prestacao, nm_pais_prestacao, nm_resultado_prestacao, nm_emp_estrangeira, nm_emp_estrangeira2, lc_localizacao_obra, nr_cnpj_cpf_prop_obra, nm_prop_obra, dt_inicio_obra, nm_ident_obra, lc_obra, nr_obra, nr_aliquota_simples, vl_base_calculo, vl_deducoes, vl_imposto_renda, vl_inss, vl_confins, vl_csll, vl_pis, nm_email, ds_discriminacao) AS select 	cd_estabelecimento cd_estabelecimento, -- CRIADA por rkorz 
	'C' tp_registro,
	'1'tp_escrituracao, 
	to_char(a.dt_emissao, 'yyyymmdd') dt_emissao_int, 
  	dt_emissao dt_emissao, 
	CASE WHEN a.ie_situacao=3 THEN  '1' WHEN a.ie_situacao=9 THEN  '1'  ELSE CASE WHEN obter_se_pj_retem_iss(a.cd_cgc_emitente, a.cd_estabelecimento)='S' THEN '0' WHEN obter_se_pj_retem_iss(a.cd_cgc_emitente, a.cd_estabelecimento)='N' THEN '3' END  END  ie_situacao, 
	cd_serie_nf nr_serie_nf, 
	lpad(CASE WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=1 THEN  a.vl_total_nota WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=2 THEN  a.vl_total_nota - a.vl_descontos WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=3 THEN  a.vl_mercadoria WHEN nfse_obter_regra('VL', a.cd_estabelecimento)=4 THEN a.vl_mercadoria - a.vl_descontos END ,12,0) vl_servico, 
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia, 'P'),obter_procedimento_nfse(a.nr_sequencia,'O')),'CD') cd_atividade_servico, 
	'1' tp_pessoa, 
	(nr_nota_fiscal)::numeric  nr_nota_fiscal, 
	cd_cgc_emitente nr_cnpj_cpf_prestador, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'N') nm_razao_social, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'CI')nm_cidade_prestador, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'UF')nm_estado_prestador, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'R') nm_end_prestador, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'NR') nr_prestador, 
	obter_dados_pf_pj('',a.cd_cgc_emitente,'CEP')nr_cep_prestador, 
	'0'lc_prestacao, 
	'010' nm_pais_prestacao, 
	' ' nm_resultado_prestacao, 
	lpad(' ',100,' ') nm_emp_estrangeira, 
 	lpad(' ',200,' ') nm_emp_estrangeira2, 
	' ' lc_localizacao_obra, 
	lpad(' ',14,' ') nr_cnpj_cpf_prop_obra, 
	lpad(' ',100,' ') nm_prop_obra, 
	lpad(' ',8,' ') dt_inicio_obra, 
	lpad(' ',100,' ') nm_ident_obra, 
	lpad(' ',100,' ')lc_obra, 
	lpad(' ',20,' ') nr_obra,  
	CASE WHEN nfse_obter_regra('OSN',cd_estabelecimento)='S' THEN sip_campo_mascara_virgula(obter_valor_tipo_tributo_nota(a.nr_sequencia,'X','ISS'))  ELSE CASE WHEN nfse_obter_regra('OSN',cd_estabelecimento)='N' THEN lpad(' ',4,' ') END  END  nr_aliquota_simples, 
	lpad(obter_base_calc_icms_nf(a.nr_sequencia),12,0) vl_base_calculo, 
	lpad(a.vl_descontos,12,0) vl_deducoes, 
	lpad(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','IR'),12,0) vl_imposto_renda, 
	lpad(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','INSS'),12,0) vl_inss, 
	lpad(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','COFINS'),12,0) vl_confins, 
	lpad(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','CSLL'),12,0)vl_csll, 
	lpad(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V','PIS'),12,0) vl_pis, 
	obter_dados_pf_pj_estab(a.cd_estabelecimento, a.cd_pessoa_fisica,cd_cgc_emitente,'M') nm_email, 
	coalesce(replace(replace(substr(obter_descricao_rps(a.cd_estabelecimento, a.nr_sequencia, 'DS_SERVICOS'), 1, 1000), chr(13), ' '), chr(10), ' '), 'Servicos') ds_discriminacao 
FROM	nota_fiscal a 
where	ie_situacao <> 2;

