-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rastreabilidade_doc_inf_v (dt_acao, ie_acao, nm_pessoa, nr_seq_documento, nm_documento) AS select	dt_aprovacao dt_acao,
	'Aprovação - Documento' ie_acao, 
	substr(obter_nome_pf(cd_pessoa_aprov),1,80) nm_pessoa, 
	nr_sequencia nr_seq_documento, 
	substr(obter_desc_expressao(cd_exp_documento, nm_documento), 1, 255) nm_documento 
FROM	qua_documento 
where	dt_aprovacao is not null 

union all
 
select	dt_elaboracao, 
	'Elaboração - Documento', 
	substr(obter_nome_pf(cd_pessoa_elaboracao),1,80), 
	nr_sequencia, 
	substr(obter_desc_expressao(cd_exp_documento, nm_documento), 1, 255) 
from	qua_documento 
where	dt_elaboracao is not null 

union all
 
select	dt_validacao, 
	'Validação - Documento', 
	substr(obter_nome_pf(cd_pessoa_validacao),1,80), 
	nr_sequencia, 
	substr(obter_desc_expressao(cd_exp_documento, nm_documento), 1, 255) 
from	qua_documento 
where	dt_validacao is not null 

union all
 
select	a.dt_aprovacao, 
	'Aprovação - Revisão', 
	substr(obter_nome_pf(a.cd_pessoa_aprovacao),1,80), 
	b.nr_sequencia, 
	substr(obter_desc_expressao(b.cd_exp_documento, b.nm_documento), 1, 255) 
from	qua_doc_revisao a, 
	qua_documento b 
where	a.nr_seq_doc = b.nr_sequencia 
and	a.dt_aprovacao is not null 

union all
 
select	a.dt_revisao, 
	'Revisão', 
	substr(obter_nome_pf(a.cd_pessoa_revisao),1,80), 
	b.nr_sequencia, 
	substr(obter_desc_expressao(b.cd_exp_documento, b.nm_documento), 1, 255) 
from	qua_doc_revisao a, 
	qua_documento b 
where	a.nr_seq_doc = b.nr_sequencia 
and	a.dt_revisao is not null 

union all
 
select	a.dt_validacao, 
	'Validação - Revisão', 
	substr(obter_nome_pf(a.cd_pessoa_validacao),1,80), 
	b.nr_sequencia, 
	substr(obter_desc_expressao(b.cd_exp_documento, b.nm_documento), 1, 255) 
from	qua_doc_revisao a, 
	qua_documento b 
where	a.nr_seq_doc = b.nr_sequencia 
and	a.dt_validacao is not null 

union all
 
select	a.dt_acesso, 
	CASE WHEN a.ie_log='C' THEN  'Log - Consulta' WHEN a.ie_log='A' THEN  'Log - Alteração' END , 
	a.nm_usuario, 
	b.nr_sequencia, 
	substr(obter_desc_expressao(b.cd_exp_documento, b.nm_documento), 1, 255) 
from	qua_doc_log_acesso a, 
	qua_documento b 
where	a.nr_seq_doc = b.nr_sequencia 

union all
 
select	b.dt_atualizacao, 
	substr('Alteração de Status - ' || obter_valor_dominio(1369,b.ds_valor_new),1,255), 
	b.nm_usuario, 
	somente_numero(a.ds_chave_simples), 
	substr(qua_obter_dados_documento(somente_numero(a.ds_chave_simples),'D'),1,255) 
from	tasy_log_alt_campo b, 
	tasy_log_alteracao a 
where	a.nr_sequencia = b.nr_seq_log_alteracao 
and	a.nm_tabela = 'QUA_DOCUMENTO' 
and	b.nm_atributo = 'IE_STATUS' 
order by	1;

