-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_proc_partic_v (ds_versao, cd_procedimento, cd_edicao_amb, qt_procedimento, vl_reducao_acrescimo, vl_procedimento, dt_entrada, dt_alta, ie_via_acesso, vl_unitario, ds_procedimento, dt_procedimento, cd_autorizacao, nr_seq_procedimento, nr_cpf, ds_funcao_medico, cd_medico_executor, nr_atendimento, nm_pessoa_fisica, sg_conselho, nr_crm, uf_crm, nr_interno_conta, ie_honorario, cd_edicao_relat, nr_seq_partic, cd_medico_convenio, cd_cgc_honorario, ie_tiss_tipo_guia, cd_procedimento_convenio, dt_inicio_cirurgia, dt_fim_cirurgia, ie_tiss_tipo_guia_honor, ie_tecnica_utilizada) AS select	'2.01.01' ds_versao,
	lpad(c.cd_procedimento, 10, '0') cd_procedimento,
	substr(coalesce(tiss_obter_tabela(c.cd_edicao_amb,p.cd_estabelecimento, g.cd_convenio_parametro, g.cd_categoria_parametro, c.dt_conta, 'X',h.IE_CLASSIFICACAO,c.cd_procedimento,c.ie_origem_proced, null, null, p.nr_atendimento,c.nr_seq_proc_interno, c.nr_seq_exame, c.cd_procedimento_tuss),'00'), 1, 20) cd_edicao_amb,
	c.qt_procedimento,
	0 vl_reducao_acrescimo,
	a.vl_participante vl_procedimento,
	p.dt_entrada,
	p.dt_alta,
	c.ie_via_acesso,
	dividir_sem_round(a.vl_participante, c.qt_procedimento) vl_unitario,
	substr(TISS_ELIMINAR_CARACTERE(obter_desc_proc_convenio(c.nr_sequencia, null)), 1, 60) ds_procedimento,
	c.dt_procedimento,
	coalesce(coalesce(a.nr_doc_honor_conv, c.nr_doc_convenio), obter_desc_expressao(778770)) cd_autorizacao,	
	c.nr_sequencia nr_seq_procedimento,
	b.nr_cpf,
	substr(tiss_obter_grau_partic(a.ie_funcao),1,25) ds_funcao_medico,
	b.cd_pessoa_fisica cd_medico_executor,
	c.nr_atendimento,
	b.nm_pessoa_fisica,
	d.sg_conselho,
	substr(OBTER_DADOS_MEDICO(b.cd_pessoa_fisica, 'CRM'),1,20) nr_crm,
	substr(OBTER_DADOS_MEDICO(b.cd_pessoa_fisica, 'UFCRM'),1,20) uf_crm,
	c.nr_interno_conta,
	CASE WHEN CASE WHEN coalesce(a.ie_tiss_tipo_guia,'X')='X' THEN  f.ie_entra_conta || f.ie_repassa_medico WHEN coalesce(a.ie_tiss_tipo_guia,'X')='6' THEN  'NN'  ELSE 'S' END ='NN' THEN  'S'  ELSE 'N' END   ie_honorario,
	substr(coalesce(tiss_obter_tabela(c.cd_edicao_amb,p.cd_estabelecimento, g.cd_convenio_parametro, g.cd_categoria_parametro, c.dt_conta, 'R', h.IE_CLASSIFICACAO,c.cd_procedimento,c.ie_origem_proced, null, null, p.nr_atendimento,c.nr_seq_proc_interno, c.nr_seq_exame, c.cd_procedimento_tuss),'00'), 1, 20) cd_edicao_relat,
	a.nr_seq_partic,
	substr(obter_medico_convenio(g.cd_estabelecimento, b.cd_pessoa_fisica, g.cd_convenio_parametro, null, null, null, null,null, p.ie_tipo_atendimento, a.ie_funcao, null),1,20) cd_medico_convenio,
	coalesce(a.cd_cgc, c.cd_cgc_prestador) cd_cgc_honorario,
	substr(TISS_OBTER_GUIA_PROC(	p.ie_tipo_atendimento,
					c.cd_procedimento, 
					c.ie_origem_proced,
					f.ie_entra_conta,
					f.ie_repassa_medico,
					a.ie_tiss_tipo_guia),1,5) ie_tiss_tipo_guia,
	replace(replace(lpad(coalesce(c.CD_PROCEDIMENTO_CONVENIO, c.cd_procedimento),10,'0'), '.',''),'-','') CD_PROCEDIMENTO_CONVENIO,
	coalesce(j.dt_inicio_cirurgia, c.dt_inicio_procedimento) dt_inicio_cirurgia,
	coalesce(j.dt_fim_cirurgia, c.dt_procedimento) dt_fim_cirurgia,
	substr(TISS_OBTER_GUIA_PROC(	p.ie_tipo_atendimento, 
					c.cd_procedimento, 
					c.ie_origem_proced,
					f.ie_entra_conta,
					f.ie_repassa_medico,
					a.ie_tiss_tipo_guia),1,5)  ie_tiss_tipo_guia_honor,
	c.ie_tecnica_utilizada
FROM atendimento_paciente p, procedimento h, conta_paciente g, pessoa_fisica b
LEFT OUTER JOIN conselho_profissional d ON (b.nr_seq_conselho = d.nr_sequencia)
, procedimento_participante a
LEFT OUTER JOIN regra_honorario f ON (a.ie_responsavel_credito = f.cd_regra)
, procedimento_paciente c
LEFT OUTER JOIN cirurgia j ON (c.nr_cirurgia = j.nr_cirurgia)
WHERE a.cd_pessoa_fisica		= b.cd_pessoa_fisica and a.nr_sequencia		= c.nr_sequencia  and p.nr_atendimento		= c.nr_atendimento  and c.nr_interno_conta		= g.nr_interno_conta and c.cd_procedimento		= h.cd_procedimento and c.ie_origem_proced		= h.ie_origem_proced and TISS_OBTER_SE_PARTIC_CONV(g.cd_estabelecimento, g.cd_convenio_parametro, b.cd_pessoa_fisica) = 'S'  
union

select	'2.01.01' ds_versao,
	lpad(a.cd_procedimento, 10, '0') cd_procedimento,
	substr(coalesce(tiss_obter_tabela(a.cd_edicao_amb,p.cd_estabelecimento, g.cd_convenio_parametro, g.cd_categoria_parametro, a.dt_conta, 'X',h.IE_CLASSIFICACAO,a.cd_procedimento,a.ie_origem_proced, null, null, p.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),'00'), 1, 20) cd_edicao_amb,
	a.qt_procedimento,
	0 vl_reducao_acrescimo,
	a.vl_medico vl_procedimento,
	p.dt_entrada,
	p.dt_alta,
	a.ie_via_acesso,
	dividir_sem_round(a.vl_medico, a.qt_procedimento) vl_unitario,
	substr(TISS_ELIMINAR_CARACTERE(obter_desc_proc_convenio(a.nr_sequencia, null)), 1, 60) ds_procedimento,
	a.dt_procedimento,
	coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)) cd_autorizacao,	
	a.nr_sequencia nr_seq_procedimento,
	b.nr_cpf,
	substr(tiss_obter_grau_partic(a.ie_funcao_medico),1,25) ds_funcao_medico,
	a.cd_medico_executor,
	a.nr_atendimento,
	b.nm_pessoa_fisica,
	d.sg_conselho,
	substr(OBTER_DADOS_MEDICO(b.cd_pessoa_fisica, 'CRM'),1,20) nr_crm,
	substr(OBTER_DADOS_MEDICO(b.cd_pessoa_fisica, 'UFCRM'),1,20) uf_crm,
	a.nr_interno_conta,
	CASE WHEN CASE WHEN coalesce(a.ie_tiss_tipo_guia,'X')='X' THEN  f.ie_entra_conta || f.ie_repassa_medico WHEN coalesce(a.ie_tiss_tipo_guia,'X')='6' THEN  'NN'  ELSE 'S' END ='NN' THEN  'S'  ELSE 'N' END   ie_honorario,
	substr(coalesce(tiss_obter_tabela(a.cd_edicao_amb,p.cd_estabelecimento, g.cd_convenio_parametro, g.cd_categoria_parametro, a.dt_conta, 'R',h.IE_CLASSIFICACAO,a.cd_procedimento,a.ie_origem_proced, null, null, p.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),'00'), 1, 20) cd_edicao_relat,
	(null)::numeric  nr_seq_partic,
	substr(obter_medico_convenio(g.cd_estabelecimento, b.cd_pessoa_fisica, g.cd_convenio_parametro, null, null, null, null,null, p.ie_tipo_atendimento, a.ie_funcao_medico, null),1,20) cd_medico_convenio,
	a.cd_cgc_prestador cd_cgc_honorario,
	substr(TISS_OBTER_GUIA_PROC(	p.ie_tipo_atendimento, 
					a.cd_procedimento, 
					a.ie_origem_proced,
					f.ie_entra_conta,
					f.ie_repassa_medico,
					a.ie_tiss_tipo_guia),1,5) ie_tiss_tipo_guia,
	replace(replace(lpad(coalesce(a.CD_PROCEDIMENTO_CONVENIO, a.cd_procedimento),10,'0'), '.',''),'-','') CD_PROCEDIMENTO_CONVENIO,
	coalesce(j.dt_inicio_cirurgia, a.dt_inicio_procedimento) dt_inicio_cirurgia,
	coalesce(j.dt_fim_cirurgia, a.dt_procedimento) dt_fim_cirurgia,
	substr(TISS_OBTER_GUIA_PROC(	p.ie_tipo_atendimento, 
					a.cd_procedimento, 
					a.ie_origem_proced,
					f.ie_entra_conta,
					f.ie_repassa_medico,
					a.ie_tiss_tipo_guia_honor),1,5) ie_tiss_tipo_guia_honor,
	a.ie_tecnica_utilizada
FROM atendimento_paciente p, procedimento h, conta_paciente g, pessoa_fisica b
LEFT OUTER JOIN conselho_profissional d ON (b.nr_seq_conselho = d.nr_sequencia)
, procedimento_paciente a
LEFT OUTER JOIN regra_honorario f ON (a.ie_responsavel_credito = f.cd_regra)
LEFT OUTER JOIN cirurgia j ON (a.nr_cirurgia = j.nr_cirurgia)
WHERE a.cd_medico_executor		= b.cd_pessoa_fisica  and p.nr_atendimento		= a.nr_atendimento  and a.nr_interno_conta		= g.nr_interno_conta and a.cd_procedimento		= h.cd_procedimento and a.ie_origem_proced		= h.ie_origem_proced and TISS_OBTER_SE_PARTIC_CONV(g.cd_estabelecimento, g.cd_convenio_parametro, b.cd_pessoa_fisica) = 'S';

