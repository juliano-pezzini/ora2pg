-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exportar_nota_petropolis_v (tp_registro, nr_sequencia, dt_emissao, dt_entrada_saida, cd_estabelecimento, registro, cd_cpf_cnpj, valor_registro) AS select 	DISTINCT 10																			TP_REGISTRO,
	0 																				NR_SEQUENCIA, 
	null																				DT_EMISSAO, 
	null																				DT_ENTRADA_SAIDA, 
	e.cd_estabelecimento 																		CD_ESTABELECIMENTO, 
	'10' 																				REGISTRO,		 
	e.CD_CGC																			CD_CPF_CNPJ, 
	nfse_obter_regra('TP', e.cd_estabelecimento)															||'|'|| 
	''																				||'|'|| 
	''																				||'|'|| 
	'1.00'																				VALOR_REGISTRO 
FROM 	estabelecimento_v e 
where	1 = 1 
and 	nfse_obter_regra('TP', e.cd_estabelecimento) is not NULL 
GROUP BY  e.cd_estabelecimento , e.CD_CGC 

UNION
  
--Definição registro 20 
select DISTINCT 20 																			TP_REGISTRO, 
	n.nr_sequencia 																			NR_SEQUENCIA, 
	n.dt_emissao																			DT_EMISSAO, 
	n.dt_entrada_saida																		DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 																		CD_ESTABELECIMENTO, 
	'' 																				REGISTRO, 
	''																				CD_CPF_CNPJ, 
	'20' 																				||'|'|| --TipoReg 
	'RPS'																				||'|'|| --TipoNFS 
	n.nr_nota_fiscal 																		||'|'|| --NumRps 
	n.cd_serie_nf 																			||'|'|| --SerRps 
	to_char(n.dt_emissao,'dd/mm/yyyy')																||'|'|| --DtEmi 
	CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN 'SIM'  ELSE 'NAO' END 													||'|'|| --RetFonte 
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), obter_procedimento_nfse(n.nr_sequencia,'O')),'CD') 	||'|'|| --CodSrv 
	coalesce(replace(replace(substr(obter_descricao_rps(n.cd_estabelecimento, n.nr_sequencia, 'DS_SERVICOS'), 1, 1000), chr(13), ' '), chr(10), ' '), 'Servicos')	||'|'|| --DiscrSrv 
	replace(Campo_Mascara_virgula_casas(n.vl_total_nota,2),'.','')													||'|'|| --VlNFS 
	replace(Campo_Mascara_virgula_casas(n.vl_descontos,2),'.','')													||'|'|| --VlDed 
	''																				||'|'|| --DiscrDed 
	replace(Campo_Mascara_virgula_casas((n.vl_total_nota - n.vl_descontos),2),'.','')										||'|'|| --VlBasCalc 
	replace(Campo_Mascara_virgula_casas(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'),0),2),'.','')							||'|'|| --AlqIss 
	replace(Campo_Mascara_virgula_casas(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='N' THEN  							(((n.vl_total_nota - n.vl_descontos)*Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'))/100)  ELSE 0 END ,2),'.','')||'|'|| --VlIss 
	replace(Campo_Mascara_virgula_casas(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'V','ISS')  ELSE 0 END ,2),'.','')	||'|'|| --VlIssRet 
	CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2)='IN' THEN '00000000000000'  ELSE CASE WHEN  n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN '00000000000000'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END  END 						||'|'|| --CpfCnpTom 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,60) 													||'|'|| --RazSocTom 
	'Rua'																				||'|'|| --TipoLogtom 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'EN'),1,50) END  													||'|'|| --LogTom 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN  substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),1,10)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NR'),1,10) END  													||'|'|| --NumEndTom 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CO'),1,30)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CO'),1,30) END 													||'|'|| --ComplEndTom 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,30)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'B'),1,30) END  													||'|'|| --BairroTom 
	nfe_elimina_caractere_especial(CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,50)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CI'),1,50) END ) 													||'|'|| --MunTom 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 	substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'UF'),1,2) END 													||'|'|| --SiglaUFTom 
	to_char(CASE WHEN n.cd_pessoa_fisica IS NULL THEN  to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CEP'),1,15) END ) 													||'|'||	--CepTom		 
	''																				||'|'|| --Telefone 
	''																				||'|'|| --Inscriçao Municipal 
	''																				||'|'|| --TipoLogLocPre 
	''																				||'|'|| --LogLocPre 
	''																				||'|'|| --NumEndLocPre 
	''																				||'|'|| --ComplEndLocPre 
	''																				||'|'|| --BairroLocPre 
	''																				||'|'|| --MunLocPre 
	''																				||'|'|| --SiglaUFLocpre 
	''																				||'|'|| --CepLocPre 
	coalesce(substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'M'),1,60),'')													||'|'|| --E-mail 1 
	''																				||'|'|| --E-mail 2 
	''																				VALOR_REGISTRO 
from 	nota_fiscal n, 
	estabelecimento e 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	n.cd_estabelecimento = e.cd_estabelecimento 
and	exists (select 1 from w_nota_fiscal w where w.nr_seq_nota_fiscal = n.nr_sequencia) 
and n.vl_mercadoria > 0 

UNION
  
--Definição registro 90 
select DISTINCT 90 																			TP_REGISTRO, 
	0 																        			NR_SEQUENCIA, 
	null																				DT_EMISSAO, 
	null																				DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 																		CD_ESTABELECIMENTO, 
	'' 																				REGISTRO, 
	''																				CD_CPF_CNPJ, 
	'90' 																				||'|'|| --Tipo Reg 
	Count(n.nr_sequencia)																		||'|'||	--Qtd Reg Normal 
	replace(Campo_Mascara_virgula_casas(sum(n.vl_total_nota),2),'.','')												||'|'||	--Valor Nfs 
	replace(Campo_Mascara_virgula_casas(sum(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='N' THEN  						(((n.vl_total_nota - n.vl_descontos)*Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'))/100)  ELSE 0 END ),2),'.','')	||'|'||	--Valor Iss 
	--replace(Campo_Mascara_virgula_casas((sum(((n.vl_total_nota - n.vl_descontos)*Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'))/100)),2),'.','')		 
	replace(Campo_Mascara_virgula_casas(sum(n.vl_descontos),2),'.','')												||'|'||	--Valor Deducao 
	Campo_Mascara_virgula_casas(sum(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'V','ISS')  ELSE 0 END ),2)			VALOR_REGISTRO 
from 	nota_fiscal n 
where	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 
and	exists (select 1 from w_nota_fiscal w where w.nr_seq_nota_fiscal = n.nr_sequencia) 
and n.vl_mercadoria > 0 
group by n.cd_estabelecimento;

