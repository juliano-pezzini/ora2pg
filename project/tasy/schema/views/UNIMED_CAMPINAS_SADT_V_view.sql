-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_campinas_sadt_v (tp_registro, tp_arquivo, cd_local_prestador, tp_local, mes_ano_producao, dt_recebimento, nr_seq_grade, dt_entrega_unimed, nr_unimed, ds_espacos, ds_complemento, nr_seq_protocolo, nr_interno_conta, dt_entrada, cd_autorizacao, cd_usuario_convenio, tp_servico, cd_servico, qt_item, vl_item, cd_cid_principal, cd_cid_secundario, cd_solicitante, cd_executante, ie_via_acesso, ie_partic_medica, ie_internado, ie_atend_urgencia, ie_acidente, nm_paciente, ie_sexo, ie_estado_civil, dt_nascimento, nr_cpf_rne, tp_origem_usuario, cd_origem_usuario, ds_nacionalidade, dt_internacao, dt_alta, tp_alta, cd_uncp_solic, tp_local_solic, ie_ordem) AS select	/* Cabe√ßalho */
	1				tp_registro, 
	'AP'				tp_arquivo, 
	substr(coalesce(cd_interno,'UNCPXXXX'),1,8) cd_local_prestador, 
	22				tp_local, 
	dt_inicio_protocolo		mes_ano_producao, 
	LOCALTIMESTAMP				dt_recebimento, 
	nr_remessa			nr_seq_grade, 
	LOCALTIMESTAMP				dt_entrega_unimed, 
	' '				nr_unimed, 
	' '				ds_espacos,	 
	substr(nm_hospital,1,40)	ds_complemento, 
	nr_seq_protocolo		nr_seq_protocolo, 
	0				nr_interno_conta, 
	LOCALTIMESTAMP				dt_entrada, 
	' '				cd_autorizacao, 
	' '				cd_usuario_convenio, 
	' '				tp_servico, 
	' '				cd_servico, 
	0				qt_item, 
	0				vl_item, 
	' '				cd_cid_principal, 
	' '				cd_cid_secundario, 
	' ' 				cd_solicitante, 
	' ' 				cd_executante, 
	' '				ie_via_acesso, 
	0				ie_partic_medica, 
	' '				ie_internado, 
	' '				ie_atend_urgencia, 
	0				ie_acidente, 
	' '				nm_paciente, 
	' '				ie_sexo, 
	0				ie_estado_civil, 
	' '				dt_nascimento, 
	' '				nr_cpf_rne, 
	0				tp_origem_usuario, 
	' '				cd_origem_usuario, 
	' '				ds_nacionalidade, 
	' '				dt_internacao, 
	' '				dt_alta,	 
	' '				tp_alta,	 
	' '				cd_uncp_solic, 
	' ' 				tp_local_solic, 
	0				ie_ordem 
FROM 	w_interf_conta_header 

union
 
select	/* Movimento */
 
	2				tp_registro, 
	'AP'				tp_arquivo, 
	'UNCPXXXX'			cd_local_prestador, 
	0				tp_local, 
	LOCALTIMESTAMP				mes_ano_producao, 
	LOCALTIMESTAMP				dt_recebimento, 
	0				nr_seq_grade, 
	LOCALTIMESTAMP				dt_entrega_unimed, 
	' '				nr_unimed, 
	' '				ds_espacos, 
	' '				ds_complemento, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	a.nr_interno_conta		nr_interno_conta, 
	max(a.dt_entrada)		dt_entrada, 
	'00000000000'			cd_autorizacao, 
	substr(a.cd_usuario_convenio,1,17) cd_usuario_convenio, 
	coalesce(substr(b.cd_grupo_gasto,1,1),'2') tp_servico, 
	lpad(substr(b.cd_item_convenio,1,8),8,'0') cd_servico, 
	sum(b.qt_item)			qt_item, 
	sum(b.vl_total_item)		vl_item, 
	a.cd_cid_principal		cd_cid_principal, 
	a.cd_cid_secundario		cd_cid_secundario, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null,null, null, null, null, null,null,null), a.cd_medico_resp),1,6) 
					cd_solicitante, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null,null, null, null, null, null,null,null), b.cd_medico_executor),1,6) 
					cd_executante, 
	' ' 				ie_via_acesso, 
	0				ie_partic_medica, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END  ie_internado, 
	CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END  ie_atend_urgencia, 
	obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE substr(a.nm_paciente,1,100) END  nm_paciente, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE a.ie_sexo END  ie_sexo, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN 0  ELSE a.ie_estado_civil END  ie_estado_civil, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN '00000000'  ELSE to_char(a.dt_nascimento,'ddmmyyyy') END  dt_nascimento, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE a.nr_cpf_paciente END 	nr_cpf_rne, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN 0  ELSE 1 END 	tp_origem_usuario, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE lpad(substr(a.cd_usuario_convenio,1,17),17,'0') END  cd_origem_usuario, 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE 'BRASIL' END  ds_nacionalidade, 
	' '				dt_internacao, 
	' '				dt_alta,	 
	' ' 				tp_alta, 
	substr(coalesce(a.cd_interno,'UNCPXXXX'),1,8) cd_uncp_solic, 
	'22' 				tp_local_solic, 
	CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  ie_ordem 
from 	w_interf_conta_cab	a,	 
	w_interf_conta_item 	b 
where	a.nr_interno_conta = b.nr_interno_conta 
and 	somente_numero(coalesce(b.ie_emite_conta,0)) in (51,52,53,72,74,75) 
and 	coalesce(b.ie_responsavel_credito,'H') <> 'M' 
group by 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	substr(a.cd_usuario_convenio,1,17), 
	coalesce(substr(b.cd_grupo_gasto,1,1),'2'), 
	lpad(substr(b.cd_item_convenio,1,8),8,'0'), 
	a.cd_cid_principal, 
	a.cd_cid_secundario, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio,null, null, null, null, null, null,null,null), a.cd_medico_resp),1,6), 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio,null, null, null, null, null, null,null,null), b.cd_medico_executor),1,6), 
	CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END , 
	CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END , 
	obter_acidente_tiss_atend(a.nr_atendimento), 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE substr(a.nm_paciente,1,100) END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE a.ie_sexo END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN 0  ELSE a.ie_estado_civil END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN '00000000'  ELSE to_char(a.dt_nascimento,'ddmmyyyy') END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE a.nr_cpf_paciente END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN 0  ELSE 1 END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE lpad(substr(a.cd_usuario_convenio,1,17),17,'0') END , 
	CASE WHEN substr(a.cd_usuario_convenio,1,4)='0002' THEN ' '  ELSE 'BRASIL' END , 
	substr(coalesce(a.cd_interno,'UNCPXXXX'),1,8), 
	CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  
having	sum(b.qt_item) > 0;

