-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_proposta_adesao_ind_v (ie_tipo_contratacao, ds_tipo_contratacao, ie_tipo_proposta, ds_tipo_proposta, nr_seq_agente_motivador, ds_agente, nr_seq_vendedor_pf, nm_vendedor, nr_seq_vendedor_canal, nm_canal_venda, ie_status, ds_status, nr_seq_plano, ds_produto, cd_estipulante, ds_estipulante, qt_idade, dt_mesano_referencia, cd_estabelecimento, vl_total, ie_mov_nova_venda) AS select	a.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,a.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	a.ie_tipo_proposta,
	substr(obter_valor_dominio(2460,a.ie_tipo_proposta),1,255) ds_tipo_proposta,
	a.nr_seq_agente_motivador,
	(select substr(max(x.ds_agente_motivador),1,255) FROM pls_agente_motivador x where x.nr_sequencia = a.nr_seq_agente_motivador) ds_agente,
	a.nr_seq_vendedor_pf,
	substr(pls_obter_nome_vend_vinculado(a.nr_seq_vendedor_pf),1,255) nm_vendedor,
	a.nr_seq_vendedor_canal,
	substr(pls_obter_nomes_contrato(a.nr_seq_vendedor_canal,'VC'),1,255) nm_canal_venda,
	a.ie_status,
	substr(obter_valor_dominio(2331,a.ie_status),1,255) ds_status,
	b.nr_seq_plano,
	CASE WHEN obter_valor_param_usuario(1232, 47, 1939, a.nm_usuario, null)='S' THEN substr(pls_obter_dados_produto(b.nr_seq_plano,'NF'),1,255)  ELSE substr(pls_obter_dados_produto(b.nr_seq_plano,'N'),1,255) END  ds_produto,
	a.cd_estipulante,
	substr(obter_nome_pf_pj(a.cd_estipulante, a.cd_cgc_estipulante),1,200) ds_estipulante,
	substr(obter_idade_pf(c.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),1,100) qt_idade,
	a.dt_inicio_proposta dt_mesano_referencia,
	a.cd_estabelecimento,
	a.vl_proposta vl_total,
	'1' ie_mov_nova_venda -- Novas vendas
from	pls_proposta_adesao		a,
	pls_proposta_plano		b,
	pessoa_fisica			c,
	pls_proposta_beneficiario	d
where	a.nr_sequencia = b.nr_seq_proposta
and	d.nr_seq_proposta = a.nr_sequencia
and	d.cd_beneficiario = c.cd_pessoa_fisica
and	a.ie_tipo_proposta = 1

union all

select	a.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,a.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	a.ie_tipo_proposta,
	substr(obter_valor_dominio(2460,a.ie_tipo_proposta),1,255) ds_tipo_proposta,
	a.nr_seq_agente_motivador,
	(select substr(max(x.ds_agente_motivador),1,255) from pls_agente_motivador x where x.nr_sequencia = a.nr_seq_agente_motivador) ds_agente,
	a.nr_seq_vendedor_pf,
	substr(pls_obter_nome_vend_vinculado(a.nr_seq_vendedor_pf),1,255) nm_vendedor,
	a.nr_seq_vendedor_canal,
	substr(pls_obter_nomes_contrato(a.nr_seq_vendedor_canal,'VC'),1,255) nm_canal_venda,
	a.ie_status,
	substr(obter_valor_dominio(2331,a.ie_status),1,255) ds_status,
	b.nr_seq_plano,
	CASE WHEN obter_valor_param_usuario(1232, 47, 1939, a.nm_usuario, null)='S' THEN substr(pls_obter_dados_produto(b.nr_seq_plano,'NF'),1,255)  ELSE substr(pls_obter_dados_produto(b.nr_seq_plano,'N'),1,255) END  ds_produto,
	a.cd_estipulante,
	substr(obter_nome_pf_pj(a.cd_estipulante, a.cd_cgc_estipulante),1,200) ds_estipulante,
	substr(obter_idade_pf(c.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),1,100) qt_idade,
	a.dt_inicio_proposta dt_mesano_referencia,
	a.cd_estabelecimento,
	a.vl_proposta vl_total,
	'2' ie_mov_nova_venda -- Movimentações
from	pls_proposta_adesao		a,
	pls_proposta_plano		b,
	pessoa_fisica			c,
	pls_proposta_beneficiario	d
where	a.nr_sequencia = b.nr_seq_proposta
and	d.nr_seq_proposta = a.nr_sequencia
and	d.cd_beneficiario = c.cd_pessoa_fisica
and	a.ie_tipo_proposta <> 1;

