-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW convenios_ger_v (cd_convenio, ds_convenio, nr_prioridade, nr_atendimento, ds_regra) AS select  c.cd_convenio,
            c.ds_convenio,
            ptc.nr_prioridade,
            ap.nr_atendimento,
            'ptc' ds_regra
    FROM    pessoa_titular_convenio ptc,
            atendimento_paciente ap,
            tipo_admissao_fat taf,
            convenio c
    where   ap.cd_pessoa_fisica = ptc.cd_pessoa_fisica
    and     ptc.cd_convenio = c.cd_convenio
    and     c.ie_tipo_convenio  = 11 -- public
    and     ((trunc(ap.dt_entrada) = trunc(coalesce(ptc.dt_inicio_vigencia, ap.dt_entrada))
                or trunc(ap.dt_entrada) > trunc(coalesce(ptc.dt_inicio_vigencia, ap.dt_entrada)))
        and (trunc(ap.dt_entrada) = trunc(coalesce(ptc.dt_fim_vigencia, ap.dt_entrada))
                or trunc(ap.dt_entrada) < trunc(coalesce(ptc.dt_fim_vigencia, ap.dt_entrada))))
    and     ap.nr_seq_tipo_admissao_fat = taf.nr_sequencia
    and     taf.ie_tipo_kv = 'S'
    
union

    select  c.cd_convenio,
            c.ds_convenio,
            acc.nr_prioridade,
            ap.nr_atendimento,
            'acc' ds_regra
    from    atend_categoria_convenio acc,
            atendimento_paciente ap,
            tipo_admissao_fat taf,
            convenio c
    where   acc.nr_atendimento =  ap.nr_atendimento
    and     acc.cd_convenio = c.cd_convenio
    and     ((trunc(ap.dt_entrada) = trunc(coalesce(acc.dt_inicio_vigencia, ap.dt_entrada))
                or trunc(ap.dt_entrada) > trunc(coalesce(acc.dt_inicio_vigencia, ap.dt_entrada)))
        and (trunc(ap.dt_entrada) = trunc(coalesce(acc.dt_final_vigencia, ap.dt_entrada))
                or trunc(ap.dt_entrada) < trunc(coalesce(acc.dt_final_vigencia, ap.dt_entrada))))
    and     ap.nr_seq_tipo_admissao_fat = taf.nr_sequencia
    and     coalesce(taf.ie_tipo_kv, 'N') = 'N';

