-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW manchester_triagem_v (nr_atendimento, nr_seq_triagem, cd_pessoa_fisica, qt_idade_ano_mes, qt_idade, qt_idade_dia, ie_sexo, ds_triagem, dt_triagem, dt_inicio_atendimento, nm_usuario_triagem, ds_tipo_atendimento, cd_procedencia, ds_queixa, ds_observacao_triagem, dt_entrada, nm_medico_triador, ie_funcao_profissional, ds_funcao_proficional, ds_registro_conselho, ds_setor_atendimento, dt_fim_triagem, dt_nascimento, cd_estabelecimento, cd_setor_atendimento, ie_tipo_atendimento, dt_alta, ds_clinica, ds_prioridade, dt_alta_medico) AS SELECT	/* +index(a ATEPACI_I2) */
	a.nr_atendimento,
	a.nr_seq_triagem,
	a.cd_pessoa_fisica,
	SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'AM'),1,15) qt_idade_ano_mes,
	SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'A'),1,15) qt_idade,
	TRUNC((SUBSTR(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'DIA'),1,15))::numeric ) qt_idade_dia,
	p.ie_sexo,
	SUBSTR(coalesce(coalesce(obter_desc_triagem(a.nr_seq_triagem), obter_triagem_atendimento(a.nr_atendimento)),obter_desc_sem_triagem(a.nr_seq_triagem)),1,60) ds_triagem,
	obter_data_triagem_atendimento(a.nr_atendimento) dt_triagem,
	a.dt_inicio_atendimento,
	a.nm_usuario_triagem,
	SUBSTR(obter_nome_tipo_atend(a.IE_TIPO_ATENDIMENTO),1,30) ds_tipo_atendimento,
	a.cd_procedencia,
	SUBSTR(Obter_Queixas_Atendimento(a.nr_atendimento,a.nr_seq_queixa),1,255) ds_queixa,
	substr(obter_inf_triagem_pa(a.nr_atendimento, 'O'),1,255) ds_observacao_triagem,
	a.dt_entrada,
	substr(obter_triagem_atendimento(a.nr_atendimento ,'M'),1,150) nm_medico_triador,
	substr(obter_triagem_atendimento(a.nr_atendimento ,'FAB'),1,150) ie_funcao_profissional,
	substr(obter_triagem_atendimento(a.nr_atendimento ,'F'),1,150) ds_funcao_proficional,
	substr(obter_triagem_atendimento(a.nr_atendimento ,'R'),1,150) ds_registro_conselho,
	s.ds_setor_atendimento,
	a.dt_fim_triagem,
	p.dt_nascimento,
	a.cd_estabelecimento,
	b.cd_setor_atendimento,
	a.ie_tipo_atendimento,
	a.dt_alta,
	SUBSTR(obter_valor_dominio(17,a.ie_clinica),1,60) ds_clinica 	,
	substr(obter_triagem_atendimento(a.nr_atendimento ,'P'),1,150) ds_prioridade,
	a.dt_alta_medico dt_alta_medico
FROM	setor_atendimento s,
	pessoa_fisica p,
	atend_categoria_convenio c,
	atend_paciente_unidade b,
	atendimento_paciente a
WHERE	a.nr_atendimento 	= b.nr_atendimento
AND	b.nr_seq_interno 	= obter_atepacu_paciente(a.nr_atendimento, 'A')
AND	a.nr_Atendimento 	= c.nr_atendimento
and   a.dt_entrada between LOCALTIMESTAMP - interval '30 days' and LOCALTIMESTAMP
AND	c.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)
AND	b.cd_setor_atendimento		= s.cd_setor_atendimento
AND	a.cd_pessoa_fisica		= p.cd_pessoa_fisica
AND	EXISTS (SELECT 1
		FROM	setor_atendimento x,
			atend_paciente_unidade y
		WHERE	a.nr_atendimento = y.nr_atendimento
		AND	y.cd_setor_atendimento	= x.cd_setor_atendimento
		AND	x.cd_classif_setor	= '1');

