-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW confirmacao_bionexo_v (cd_cgc_fornecedor, id_artigo, cd_material, qt_material, ds_observacao, nr_cot_compra, nr_ordem_compra) AS select	substr(obter_cod_fornec_int_compras(a.cd_cgc_fornecedor, b.cd_estabelecimento),1,255) cd_cgc_fornecedor,
	nr_id_integracao id_artigo,
	a.cd_material,
	a.qt_material,
	substr(gerar_obs_oc_envio_confirmacao(a.nr_ordem_compra),1,4000) ds_observacao,
	a.nr_cot_compra,
	a.nr_ordem_compra
FROM	cot_compra_forn_item_tr_v a,
	cot_compra b,
	parametro_compras p
where	a.nr_cot_compra		= b.nr_cot_compra
and		p.cd_estabelecimento = b.cd_estabelecimento
and	a.nr_seq_item_fornec	= obter_venc_cot_fornec_item(a.nr_cot_compra, a.nr_item_cot_compra)
and	substr(obter_se_existe_cot_resumo(a.nr_cot_compra),1,1) = 'N'
and	p.ie_resposta_int_compra = 'S'
and	obter_se_item_confirmado(a.nr_cot_compra, a.nr_item_cot_compra) = 'N'
and	a.cd_cgc_fornecedor is not null

union all

select	substr(obter_cod_fornec_int_compras(a.cd_cgc_fornecedor, b.cd_estabelecimento),1,255) cd_cgc_fornecedor,
	nr_id_integracao id_artigo,
	a.cd_material,
	a.qt_material,
	substr(gerar_obs_oc_envio_confirmacao(a.nr_ordem_compra),1,4000) ds_observacao,
	a.nr_cot_compra,
	a.nr_ordem_compra
from	cot_compra_resumo_v a,
	cot_compra b,
	parametro_compras p
where	a.nr_cot_compra		= b.nr_cot_compra
and		p.cd_estabelecimento = b.cd_estabelecimento
and	substr(obter_se_existe_cot_resumo(a.nr_cot_compra),1,1) = 'S'
and	p.ie_resposta_int_compra = 'S'
and	obter_se_item_confirmado(a.nr_cot_compra, a.nr_item_cot_compra) = 'N'
and	a.cd_cgc_fornecedor is not null

union all

select	distinct
	substr(obter_cod_fornec_int_compras(a.cd_cgc_fornecedor, b.cd_estabelecimento),1,255) cd_cgc_fornecedor,
	a.nr_id_integracao id_artigo,
	a.cd_material,
	c.qt_material,
	substr(gerar_obs_oc_envio_confirmacao(a.nr_ordem_compra),1,4000) ds_observacao,
	a.nr_cot_compra,
	a.nr_ordem_compra
from	cot_compra_forn_item_tr_v a,
	ordem_compra b,
	ordem_compra_item c,
	cot_compra d,
	parametro_compras p
where	a.nr_cot_compra		= d.nr_cot_compra
and	a.nr_ordem_compra	= b.nr_ordem_compra
and	b.nr_ordem_compra	= c.nr_ordem_compra
and	a.nr_item_cot_compra	= c.nr_item_cot_compra
and		p.cd_estabelecimento = b.cd_estabelecimento
and	a.nr_seq_item_fornec	= obter_venc_cot_fornec_item(a.nr_cot_compra, a.nr_item_cot_compra)
and	substr(obter_se_existe_cot_resumo(a.nr_cot_compra),1,1)		= 'N'
and	p.ie_resposta_int_compra = 'P'
and	obter_se_item_confirmado(a.nr_cot_compra, a.nr_item_cot_compra) = 'N'
and	c.dt_aprovacao is not null
and	c.dt_reprovacao is null
and	a.cd_cgc_fornecedor is not null
and	exists (select 1 from ordem_compra_item_entrega ocie where ocie.nr_ordem_compra = c.nr_ordem_compra and ocie.nr_item_oci = c.nr_item_oci and ocie.dt_cancelamento is null)

union all

select	--distinct
	substr(obter_cod_fornec_int_compras(a.cd_cgc_fornecedor, b.cd_estabelecimento),1,255) cd_cgc_fornecedor,
	a.nr_id_integracao id_artigo,
	a.cd_material,
	c.qt_material,
	substr(gerar_obs_oc_envio_confirmacao(a.nr_ordem_compra),1,4000) ds_observacao,
	a.nr_cot_compra,
	b.nr_ordem_compra
from	cot_compra_resumo_v a,
	ordem_compra b,
	ordem_compra_item c,
	cot_compra d,
	parametro_compras p
where	a.nr_cot_compra		= d.nr_cot_compra
and	a.nr_ordem_compra	= b.nr_ordem_compra
and	b.nr_ordem_compra	= c.nr_ordem_compra
and	a.nr_item_cot_compra	= c.nr_item_cot_compra
and	p.cd_estabelecimento = b.cd_estabelecimento
and	substr(obter_se_existe_cot_resumo(a.nr_cot_compra),1,1)		= 'S'
and	p.ie_resposta_int_compra 					= 'P'
and	obter_se_item_confirmado(a.nr_cot_compra, a.nr_item_cot_compra) = 'N'
and	a.cd_cgc_fornecedor is not null
and	c.dt_aprovacao is not null
and	c.dt_reprovacao is null
and	exists (select 1 from ordem_compra_item_entrega ocie where ocie.nr_ordem_compra = c.nr_ordem_compra and ocie.nr_item_oci = c.nr_item_oci and ocie.dt_cancelamento is null);

