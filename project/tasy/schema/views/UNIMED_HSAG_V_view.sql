-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_hsag_v (tp_registro, ie_tipo_prestador, cd_prestador, nm_prestador, nr_lote, dt_geracao, cd_tipo_documento, nr_documento, nr_cep, cd_tipo_prestador, nr_crm, dt_inicio_internacao, dt_alta, ie_padrao_internacao, cd_unimed_usuario, cd_contrato_usuario, cd_familia_usuario, ie_dependencia_usuario, ie_digito_ver_usuario, dt_exec_servico, hr_exec_servico, cd_cid, ie_detalhe_cid, cd_dig_verif_cid, cd_seq_doc_servico, cd_amb_lpm, cd_dig_verif_servico, qt_servico_executado, ie_porte_cirurgico, ie_partic_executante, cd_local_atendimento, vl_servico, cd_moeda_servico, vl_filme, cd_moeda_filme, nr_autorizacao, cd_fator_plano, ie_tipo_prest_executante, cd_prest_executante, ie_situacao_guia, nm_usuario, hr_saida_paciente, nr_seq_protocolo, nr_atendimento, nr_interno_conta, qt_doc_enviados, qt_serv_relacionados, qt_total_servicos_real, qt_total_cobrado_ch, qt_total_filme, cd_campo_quebra, nr_guia_original, dt_emissao, ds_plano, dt_validade_carteira, ie_carater_internacao, qt_solicitada, qt_autorizada, cd_conselho_profissional, nr_conselho, uf_conselho, ie_tipo_atendimento, ie_acidente, ie_tecnica_utilizada, tp_saida, tp_consulta, tp_internacao, ie_regime_inter, ie_motivo_saida_inter, ds_indicacao_clinica) AS select		0					tp_registro,
		CASE WHEN a.ie_tipo_protocolo=21 THEN 2 WHEN a.ie_tipo_protocolo=22 THEN 2  ELSE 4 END  ie_tipo_prestador, 
		101					cd_prestador, 
		substr(a.nm_hospital,1,40)		nm_prestador, 
		a.nr_seq_protocolo			nr_lote, 
		a.dt_remessa				dt_geracao, 
		0					cd_tipo_documento, 
		0					nr_documento, 
		''					nr_cep, 
		1					cd_tipo_prestador, 
		''					nr_crm, 
		LOCALTIMESTAMP					dt_inicio_internacao, 
		LOCALTIMESTAMP					dt_alta, 
		0					ie_padrao_internacao, 
		''					cd_unimed_usuario, 
		''					cd_contrato_usuario, 
		''					cd_familia_usuario, 
		''					ie_dependencia_usuario, 
		''					ie_digito_ver_usuario, 
		''					dt_exec_servico, 
		''					hr_exec_servico, 
		''					cd_cid, 
		''					ie_detalhe_cid, 
		''					cd_dig_verif_cid, 
		0					cd_seq_doc_servico,		 
		''					cd_amb_lpm, 
		''					cd_dig_verif_servico, 
		0					qt_servico_executado,				 
		''					ie_porte_cirurgico, 
		''					ie_partic_executante, 
		0					cd_local_atendimento, 
		0					vl_servico, 
		0					cd_moeda_servico, 
		0					vl_filme, 
		0					cd_moeda_filme, 
		0					nr_autorizacao, 
		0					cd_fator_plano, 
		0					ie_tipo_prest_executante, 
		0					cd_prest_executante, 
		''					ie_situacao_guia,		 
		''					nm_usuario, 
		''					hr_saida_paciente, 
		a.nr_seq_protocolo			nr_seq_protocolo, 
		0					nr_atendimento, 
		0					nr_interno_conta, 
		0					qt_doc_enviados, 
		0					qt_serv_relacionados, 
		0					qt_total_servicos_real, 
		0					qt_total_cobrado_ch, 
		0					qt_total_filme, 
		0					cd_campo_quebra, 
		''					nr_guia_original, 
		LOCALTIMESTAMP					dt_emissao, 
		''					ds_plano, 
		LOCALTIMESTAMP					dt_validade_carteira, 
		''					ie_carater_internacao, 
		0					qt_solicitada, 
		0					qt_autorizada, 
		''					cd_conselho_profissional, 
		''					nr_conselho, 
		''					uf_conselho, 
		1					ie_tipo_atendimento, 
		0					ie_acidente, 
		''					ie_tecnica_utilizada, 
		0					tp_saida, 
		0					tp_consulta, 
		0					tp_internacao, 
		0					ie_regime_inter, 
		0					ie_motivo_saida_inter, 
		''					ds_indicacao_clinica 
FROM 		w_interf_conta_header a 

union all
 
select		a.TP_REGISTRO,a.IE_TIPO_PRESTADOR,a.CD_PRESTADOR,a.NM_PRESTADOR,a.NR_LOTE,a.DT_GERACAO,a.CD_TIPO_DOCUMENTO,a.NR_DOCUMENTO,a.NR_CEP,a.CD_TIPO_PRESTADOR,a.NR_CRM,a.DT_INICIO_INTERNACAO,a.DT_ALTA,a.IE_PADRAO_INTERNACAO,a.CD_UNIMED_USUARIO,a.CD_CONTRATO_USUARIO,a.CD_FAMILIA_USUARIO,a.IE_DEPENDENCIA_USUARIO,a.IE_DIGITO_VER_USUARIO,a.DT_EXEC_SERVICO,a.HR_EXEC_SERVICO,a.CD_CID,a.IE_DETALHE_CID,a.CD_DIG_VERIF_CID,a.CD_SEQ_DOC_SERVICO,a.CD_AMB_LPM,a.CD_DIG_VERIF_SERVICO,a.QT_SERVICO_EXECUTADO,a.IE_PORTE_CIRURGICO,a.IE_PARTIC_EXECUTANTE,a.CD_LOCAL_ATENDIMENTO,a.VL_SERVICO,a.CD_MOEDA_SERVICO,a.VL_FILME,a.CD_MOEDA_FILME,a.NR_AUTORIZACAO,a.CD_FATOR_PLANO,a.IE_TIPO_PREST_EXECUTANTE,a.CD_PREST_EXECUTANTE,a.IE_SITUACAO_GUIA,a.NM_USUARIO,a.HR_SAIDA_PACIENTE,a.NR_SEQ_PROTOCOLO,a.NR_ATENDIMENTO,a.NR_INTERNO_CONTA,a.QT_DOC_ENVIADOS,a.QT_SERV_RELACIONADOS,a.QT_TOTAL_SERVICOS_REAL,a.QT_TOTAL_COBRADO_CH,a.QT_TOTAL_FILME,a.CD_CAMPO_QUEBRA,a.NR_GUIA_ORIGINAL,a.DT_EMISSAO,a.DS_PLANO,a.DT_VALIDADE_CARTEIRA,a.IE_CARATER_INTERNACAO,a.QT_SOLICITADA,a.QT_AUTORIZADA,a.CD_CONSELHO_PROFISSIONAL,a.NR_CONSELHO,a.UF_CONSELHO,a.IE_TIPO_ATENDIMENTO,a.IE_ACIDENTE,a.IE_TECNICA_UTILIZADA,a.TP_SAIDA,a.TP_CONSULTA,a.TP_INTERNACAO,a.IE_REGIME_INTER,a.IE_MOTIVO_SAIDA_INTER,a.DS_INDICACAO_CLINICA 
from 	(select	1					tp_registro, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 4 WHEN a.ie_tipo_atendimento=3 THEN 6  ELSE CASE WHEN b.cd_setor_atendimento=15 THEN 3 WHEN b.cd_setor_atendimento=13 THEN 3 WHEN b.cd_setor_atendimento=21 THEN 3 WHEN b.cd_setor_atendimento=22 THEN 3 WHEN b.cd_setor_atendimento=12 THEN 3 WHEN b.cd_setor_atendimento=11 THEN 3 WHEN b.cd_setor_atendimento=24 THEN 3 WHEN b.cd_setor_atendimento=23 THEN 3 WHEN b.cd_setor_atendimento=49 THEN 7 WHEN b.cd_setor_atendimento=14 THEN 14 WHEN b.cd_setor_atendimento=19 THEN 16 WHEN b.cd_setor_atendimento=16 THEN 16 WHEN b.cd_setor_atendimento=17 THEN 16 WHEN b.cd_setor_atendimento=18 THEN 17 WHEN b.cd_setor_atendimento=20 THEN 20 WHEN b.cd_setor_atendimento=48 THEN 2 WHEN b.cd_setor_atendimento=51 THEN 2  ELSE 9 END  END  
							ie_tipo_prestador, 
		CASE WHEN b.cd_setor_atendimento=49 THEN 120 WHEN b.cd_setor_atendimento=14 THEN 1  ELSE CASE WHEN b.cd_item=10014 THEN 8889  ELSE 101 END  END  
							cd_prestador, 
		''					nm_prestador, 
		0					nr_lote, 
		LOCALTIMESTAMP					dt_geracao, 
		CASE WHEN b.cd_item=10014 THEN 6  ELSE CASE WHEN a.ie_tipo_atendimento=1 THEN 2 WHEN a.ie_tipo_atendimento=3 THEN 16 WHEN a.ie_tipo_atendimento=7 THEN 1 WHEN a.ie_tipo_atendimento=8 THEN 1  ELSE CASE WHEN b.cd_setor_atendimento=48 THEN 10 WHEN b.cd_setor_atendimento=51 THEN 10  ELSE 3 END  END  END  
							cd_tipo_documento, 
		somente_numero(substr(coalesce(b.nr_doc_convenio,c.cd_autorizacao),1,12)) 
							nr_documento,		 
		''					nr_cep, 
		1					cd_tipo_prestador, 
		a.nr_crm_medico_resp			nr_crm, 
		a.dt_entrada				dt_inicio_internacao, 
		a.dt_alta				dt_alta, 
		a.cd_tipo_acomodacao			ie_padrao_internacao, 
		substr(a.cd_usuario_convenio,1,3)	cd_unimed_usuario, 
		substr(a.cd_usuario_convenio,4,4)	cd_contrato_usuario, 
		substr(a.cd_usuario_convenio,8,6)	cd_familia_usuario, 
		substr(a.cd_usuario_convenio,14,2)	ie_dependencia_usuario, 
		substr(a.cd_usuario_convenio,16,1)	ie_digito_ver_usuario, 
		to_char(b.dt_item,'ddmmyyyy')		dt_exec_servico, 
		to_char(b.dt_item,'hh24mi')		hr_exec_servico, 
		a.cd_cid_principal			cd_cid, 
		''					ie_detalhe_cid, 
		''					cd_dig_verif_cid, 
		0					cd_seq_doc_servico, 
		substr(b.cd_item_convenio,1,7) 		cd_amb_lpm, 
		'0' 					cd_dig_verif_servico, 
		sum(b.qt_item)				qt_servico_executado, 
		to_char(b.nr_porte_anestesico)		ie_porte_cirurgico, 
		CASE WHEN Obter_Se_Negativo(vl_total_item)='N' THEN  to_char(b.cd_funcao_executor)  ELSE null END  
							ie_partic_executante, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  
							cd_local_atendimento, 
		sum(b.vl_total_item - coalesce(b.vl_filme,0)) vl_servico, 
		6					cd_moeda_servico, 
		sum(b.vl_filme)				vl_filme, 
		6					cd_moeda_filme, 
		somente_numero(substr(OBTER_DADOS_CATEG_CONV(a.nr_atendimento,'S'),1,10)) 
							 nr_autorizacao, 
		0					cd_fator_plano, 
		CASE WHEN b.ie_responsavel_credito='M' THEN 1 WHEN b.ie_responsavel_credito='RM' THEN CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END   ELSE CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  END  
							ie_tipo_prest_executante, 
		CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.NR_CRM_EXECUTOR,0)) WHEN b.ie_responsavel_credito=obter_estab_atend(a.nr_atendimento) THEN 1 WHEN b.ie_responsavel_credito=123 THEN 11  ELSE 229 END  
							cd_prest_executante, 
		''					ie_situacao_guia,		 
		substr(a.nm_paciente,1,25)		nm_usuario, 
		to_char(a.dt_alta,'hh24mi')		hr_saida_paciente, 
		a.nr_seq_protocolo			nr_seq_protocolo, 
		a.nr_atendimento			nr_atendimento, 
		a.nr_interno_conta			nr_interno_conta, 
		0					qt_doc_enviados, 
		0					qt_serv_relacionados, 
		0					qt_total_servicos_real, 
		0					qt_total_cobrado_ch, 
		0					qt_total_filme, 
		a.nr_interno_conta 			cd_campo_quebra, 
		substr(a.nr_doc_convenio,1,20) 
							nr_guia_original, 
		a.dt_entrada				dt_emissao, 
		substr(obter_desc_plano(a.cd_convenio,a.cd_plano_convenio),1,40) 
							ds_plano, 
		a.dt_validade_carteira			dt_validade_carteira, 
		a.ie_carater_inter			ie_carater_internacao, 
		trunc(sum(b.qt_item))			qt_solicitada, 
		trunc(sum(b.qt_item))				qt_autorizada, 
		'CRM'					cd_conselho_profissional, 
		substr(b.nr_crm_executor,1,15)		nr_conselho, 
		b.uf_crm_executor			uf_conselho, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 2 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 1 END  
							ie_tipo_atendimento, 
		obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente, 
		obter_tecnica_utilizada_tiss(b.nr_seq_item) ie_tecnica_utilizada, 
		coalesce(somente_numero(TISS_OBTER_TIPO_SAIDA('SPSADT',a.nr_interno_conta)),5) tp_saida, 
		1					tp_consulta, 
		coalesce(a.ie_clinica,1)			tp_internacao, 
		1					ie_regime_inter, 
		a.cd_motivo_alta			ie_motivo_saida_inter, 
		substr(Obter_indicacao_clinica(a.nr_atendimento, b.cd_item, b.ie_origem_proced),1,500) 
							ds_indicacao_clinica 
FROM w_interf_conta_cab a, w_interf_conta_item b
LEFT OUTER JOIN w_interf_conta_autor c ON (b.nr_interno_conta = c.nr_interno_conta)
WHERE b.nr_interno_conta		= a.nr_interno_conta  and b.ie_tipo_item			= 1 and coalesce(c.nr_sequencia,0)		= 
		(select coalesce(min(x.nr_sequencia),0) 
		from	w_interf_conta_autor x 
		where	a.nr_interno_conta	= x.nr_interno_conta) group by 	CASE WHEN a.ie_tipo_atendimento=1 THEN 4 WHEN a.ie_tipo_atendimento=3 THEN 6  ELSE CASE WHEN b.cd_setor_atendimento=15 THEN 3 WHEN b.cd_setor_atendimento=13 THEN 3 WHEN b.cd_setor_atendimento=21 THEN 3 WHEN b.cd_setor_atendimento=22 THEN 3 WHEN b.cd_setor_atendimento=12 THEN 3 WHEN b.cd_setor_atendimento=11 THEN 3 WHEN b.cd_setor_atendimento=24 THEN 3 WHEN b.cd_setor_atendimento=23 THEN 3 WHEN b.cd_setor_atendimento=49 THEN 7 WHEN b.cd_setor_atendimento=14 THEN 14 WHEN b.cd_setor_atendimento=19 THEN 16 WHEN b.cd_setor_atendimento=16 THEN 16 WHEN b.cd_setor_atendimento=17 THEN 16 WHEN b.cd_setor_atendimento=18 THEN 17 WHEN b.cd_setor_atendimento=20 THEN 20 WHEN b.cd_setor_atendimento=48 THEN 2 WHEN b.cd_setor_atendimento=51 THEN 2  ELSE 9 END  END , 
		CASE WHEN b.cd_setor_atendimento=49 THEN 120 WHEN b.cd_setor_atendimento=14 THEN 1  ELSE CASE WHEN b.cd_item=10014 THEN 8889  ELSE 101 END  END , 
		CASE WHEN b.cd_item=10014 THEN 6  ELSE CASE WHEN a.ie_tipo_atendimento=1 THEN 2 WHEN a.ie_tipo_atendimento=3 THEN 16 WHEN a.ie_tipo_atendimento=7 THEN 1 WHEN a.ie_tipo_atendimento=8 THEN 1  ELSE CASE WHEN b.cd_setor_atendimento=48 THEN 10 WHEN b.cd_setor_atendimento=51 THEN 10  ELSE 3 END  END  END , 
		somente_numero(substr(coalesce(b.nr_doc_convenio,c.cd_autorizacao),1,12)), 
		a.nr_crm_medico_resp, 
		a.dt_entrada, 
		a.dt_alta, 
		a.cd_tipo_acomodacao, 
		substr(a.cd_usuario_convenio,1,3), 
		substr(a.cd_usuario_convenio,4,4), 
		substr(a.cd_usuario_convenio,8,6), 
		substr(a.cd_usuario_convenio,14,2), 
		substr(a.cd_usuario_convenio,16,1), 
		to_char(b.dt_item,'ddmmyyyy'), 
		to_char(b.dt_item,'hh24mi'), 
		a.cd_cid_principal, 
		substr(b.cd_item_convenio,1,7), 
		to_char(b.nr_porte_anestesico), 
		CASE WHEN Obter_Se_Negativo(vl_total_item)='N' THEN  to_char(b.cd_funcao_executor)  ELSE null END  , 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END , 
		somente_numero(substr(OBTER_DADOS_CATEG_CONV(a.nr_atendimento,'S'),1,10)), 
		CASE WHEN b.ie_responsavel_credito='M' THEN 1 WHEN b.ie_responsavel_credito='RM' THEN CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END   ELSE CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  END , 
		CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.NR_CRM_EXECUTOR,0)) WHEN b.ie_responsavel_credito=obter_estab_atend(a.nr_atendimento) THEN 1 WHEN b.ie_responsavel_credito=123 THEN 11  ELSE 229 END , 
		substr(a.nm_paciente,1,25), 
		to_char(a.dt_alta,'hh24mi'), 
		a.nr_seq_protocolo, 
		a.nr_atendimento, 
		a.nr_interno_conta, 
		substr(a.nr_doc_convenio,1,20), 
		a.dt_entrada, 
		substr(obter_desc_plano(a.cd_convenio,a.cd_plano_convenio),1,40), 
		a.dt_validade_carteira, 
		a.ie_carater_inter, 
		substr(b.nr_crm_executor,1,15), 
		b.uf_crm_executor, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 2 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 1 END , 
		obter_acidente_tiss_atend(a.nr_atendimento), 
		obter_tecnica_utilizada_tiss(b.nr_seq_item), 
		coalesce(somente_numero(TISS_OBTER_TIPO_SAIDA('SPSADT',a.nr_interno_conta)),5), 
		coalesce(a.ie_clinica,1), 
		a.cd_motivo_alta, 
		substr(Obter_indicacao_clinica(a.nr_atendimento, b.cd_item, b.ie_origem_proced),1,500)) a 
where 		a.vl_servico <> 0 

union all
 
select 		1					tp_registro, 
		CASE WHEN a.ie_tipo_atendimento=1 THEN 4 WHEN a.ie_tipo_atendimento=3 THEN 6  ELSE CASE WHEN b.cd_setor_atendimento=15 THEN 3 WHEN b.cd_setor_atendimento=13 THEN 3 WHEN b.cd_setor_atendimento=21 THEN 3 WHEN b.cd_setor_atendimento=22 THEN 3 WHEN b.cd_setor_atendimento=12 THEN 3 WHEN b.cd_setor_atendimento=11 THEN 3 WHEN b.cd_setor_atendimento=24 THEN 3 WHEN b.cd_setor_atendimento=23 THEN 3 WHEN b.cd_setor_atendimento=49 THEN 7 WHEN b.cd_setor_atendimento=14 THEN 14 WHEN b.cd_setor_atendimento=19 THEN 16 WHEN b.cd_setor_atendimento=16 THEN 16 WHEN b.cd_setor_atendimento=17 THEN 16 WHEN b.cd_setor_atendimento=18 THEN 17 WHEN b.cd_setor_atendimento=20 THEN 20 WHEN b.cd_setor_atendimento=48 THEN 2 WHEN b.cd_setor_atendimento=51 THEN 2  ELSE 9 END  END  
							ie_tipo_prestador, 
		CASE WHEN b.cd_setor_atendimento=49 THEN 120 WHEN b.cd_setor_atendimento=14 THEN 1  ELSE CASE WHEN b.cd_item=10014 THEN 8889  ELSE 101 END  END  
							cd_prestador, 
		''					nm_prestador, 
		0					nr_lote, 
		LOCALTIMESTAMP					dt_geracao, 
		CASE WHEN b.cd_item=10014 THEN 6  ELSE CASE WHEN a.ie_tipo_atendimento=1 THEN 2 WHEN a.ie_tipo_atendimento=3 THEN 16 WHEN a.ie_tipo_atendimento=7 THEN 1 WHEN a.ie_tipo_atendimento=8 THEN 1  ELSE CASE WHEN b.cd_setor_atendimento=48 THEN 10 WHEN b.cd_setor_atendimento=51 THEN 10  ELSE 3 END  END  END  
							cd_tipo_documento, 
		somente_numero(substr(coalesce(b.nr_doc_convenio,c.cd_autorizacao),1,12)) 
							nr_documento,		 
		''					nr_cep, 
		1					cd_tipo_prestador, 
		a.nr_crm_medico_resp			nr_crm, 
		a.dt_entrada				dt_inicio_internacao, 
		a.dt_alta				dt_alta, 
		a.cd_tipo_acomodacao			ie_padrao_internacao, 
		substr(a.cd_usuario_convenio,1,3)	cd_unimed_usuario, 
		substr(a.cd_usuario_convenio,4,4)	cd_contrato_usuario, 
		substr(a.cd_usuario_convenio,8,6)	cd_familia_usuario, 
		substr(a.cd_usuario_convenio,14,2)	ie_dependencia_usuario, 
		substr(a.cd_usuario_convenio,16,1)	ie_digito_ver_usuario, 
		to_char(a.dt_entrada,'ddmmyyyy')	dt_exec_servico, 
		to_char(a.dt_entrada,'hh24mi')		hr_exec_servico, 
		null					cd_cid, 
		''					ie_detalhe_cid, 
		''					cd_dig_verif_cid, 
		0					cd_seq_doc_servico, 
		substr(b.cd_item_convenio,1,7)		cd_amb_lpm, 
		'0'					cd_dig_verif_servico, 
		1					qt_servico_executado, 
		''					ie_porte_cirurgico, 
		''					ie_partic_executante, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  
							cd_local_atendimento, 
		sum(b.vl_total_item)			vl_servico, 
		6					cd_moeda_servico, 
		0					vl_filme, 
		6					cd_moeda_filme, 
		somente_numero(substr(OBTER_DADOS_CATEG_CONV(a.nr_atendimento,'S'),1,10)) 
							nr_autorizacao, 
		0					cd_fator_plano, 
		CASE WHEN b.ie_responsavel_credito='M' THEN 1 WHEN b.ie_responsavel_credito='RM' THEN CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END   ELSE CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  END  
							ie_tipo_prest_executante, 
		CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.NR_CRM_EXECUTOR,0)) WHEN b.ie_responsavel_credito=obter_estab_atend(a.nr_atendimento) THEN 1 WHEN b.ie_responsavel_credito=123 THEN 11  ELSE 229 END  
							cd_prest_executante, 
		''					ie_situacao_guia,		 
		substr(a.nm_paciente,1,25)		nm_usuario, 
		to_char(a.dt_alta,'hh24mi')		hr_saida_paciente, 
		a.nr_seq_protocolo			nr_seq_protocolo, 
		a.nr_atendimento			nr_atendimento, 
		a.nr_interno_conta			nr_interno_conta, 
		0					qt_doc_enviados, 
		0					qt_serv_relacionados, 
		0					qt_total_servicos_real, 
		0					qt_total_cobrado_ch, 
		0					qt_total_filme, 
		a.nr_interno_conta			cd_campo_quebra, 
		substr(a.nr_doc_convenio,1,20) 
							nr_guia_original, 
		a.dt_entrada				dt_emissao, 
		substr(obter_desc_plano(a.cd_convenio,a.cd_plano_convenio),1,40) 
							ds_plano, 
		a.dt_validade_carteira			dt_validade_carteira, 
		a.ie_carater_inter			ie_carater_internacao, 
		trunc(sum(b.qt_item))			qt_solicitada, 
		trunc(sum(b.qt_item))			qt_autorizada, 
		'CRM'					cd_conselho_profissional, 
		substr(b.nr_crm_executor,1,15)		nr_conselho, 
		b.uf_crm_executor			uf_conselho, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 2 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 1 END  
							ie_tipo_atendimento, 
		obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente, 
		obter_tecnica_utilizada_tiss(b.nr_seq_item) ie_tecnica_utilizada, 
		coalesce(somente_numero(TISS_OBTER_TIPO_SAIDA('SPSADT',a.nr_interno_conta)),5) tp_saida, 
		1					tp_consulta, 
		coalesce(a.ie_clinica,1)			tp_internacao, 
		1					ie_regime_inter, 
		a.cd_motivo_alta			ie_motivo_saida_inter, 
		substr(Obter_indicacao_clinica(a.nr_atendimento, b.cd_item, b.ie_origem_proced),1,500) 
							ds_indicacao_clinica 
FROM w_interf_conta_cab a, w_interf_conta_item b
LEFT OUTER JOIN w_interf_conta_autor c ON (b.nr_interno_conta = c.nr_interno_conta)
WHERE b.nr_interno_conta		= a.nr_interno_conta  and b.ie_tipo_item			= 2 and coalesce(c.nr_sequencia,0)		= 
		(select coalesce(min(x.nr_sequencia),0) 
		from	w_interf_conta_autor x 
		where	a.nr_interno_conta	= x.nr_interno_conta) group by	CASE WHEN a.ie_tipo_atendimento=1 THEN 4 WHEN a.ie_tipo_atendimento=3 THEN 6  ELSE CASE WHEN b.cd_setor_atendimento=15 THEN 3 WHEN b.cd_setor_atendimento=13 THEN 3 WHEN b.cd_setor_atendimento=21 THEN 3 WHEN b.cd_setor_atendimento=22 THEN 3 WHEN b.cd_setor_atendimento=12 THEN 3 WHEN b.cd_setor_atendimento=11 THEN 3 WHEN b.cd_setor_atendimento=24 THEN 3 WHEN b.cd_setor_atendimento=23 THEN 3 WHEN b.cd_setor_atendimento=49 THEN 7 WHEN b.cd_setor_atendimento=14 THEN 14 WHEN b.cd_setor_atendimento=19 THEN 16 WHEN b.cd_setor_atendimento=16 THEN 16 WHEN b.cd_setor_atendimento=17 THEN 16 WHEN b.cd_setor_atendimento=18 THEN 17 WHEN b.cd_setor_atendimento=20 THEN 20 WHEN b.cd_setor_atendimento=48 THEN 2 WHEN b.cd_setor_atendimento=51 THEN 2  ELSE 9 END  END , 
		CASE WHEN b.cd_setor_atendimento=49 THEN 120 WHEN b.cd_setor_atendimento=14 THEN 1  ELSE CASE WHEN b.cd_item=10014 THEN 8889  ELSE 101 END  END , 
		CASE WHEN b.cd_item=10014 THEN 6  ELSE CASE WHEN a.ie_tipo_atendimento=1 THEN 2 WHEN a.ie_tipo_atendimento=3 THEN 16 WHEN a.ie_tipo_atendimento=7 THEN 1 WHEN a.ie_tipo_atendimento=8 THEN 1  ELSE CASE WHEN b.cd_setor_atendimento=48 THEN 10 WHEN b.cd_setor_atendimento=51 THEN 10  ELSE 3 END  END  END , 
		somente_numero(substr(coalesce(b.nr_doc_convenio,c.cd_autorizacao),1,12)), 
		a.nr_crm_medico_resp, 
		a.dt_entrada, 
		a.dt_alta, 
		a.cd_tipo_acomodacao, 
		substr(a.cd_usuario_convenio,1,3), 
		substr(a.cd_usuario_convenio,4,4), 
		substr(a.cd_usuario_convenio,8,6), 
		substr(a.cd_usuario_convenio,14,2), 
		substr(a.cd_usuario_convenio,16,1), 
		to_char(a.dt_entrada,'ddmmyyyy'), 
		to_char(a.dt_entrada,'hh24mi'), 
		substr(b.cd_item_convenio,1,7), 
		'0', 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END , 
		c.cd_senha, 
		a.cd_tipo_acomodacao, 
		somente_numero(substr(OBTER_DADOS_CATEG_CONV(a.nr_atendimento,'S'),1,10)), 
		CASE WHEN b.ie_responsavel_credito='M' THEN 1 WHEN b.ie_responsavel_credito='RM' THEN CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END   ELSE CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 4 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 5 END  END , 
		CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.NR_CRM_EXECUTOR,0)) WHEN b.ie_responsavel_credito=obter_estab_atend(a.nr_atendimento) THEN 1 WHEN b.ie_responsavel_credito=123 THEN 11  ELSE 229 END , 
		substr(a.nm_paciente,1,25), 
		to_char(a.dt_alta,'hh24mi'), 
		a.nr_seq_protocolo, 
		a.nr_atendimento, 
		a.nr_interno_conta, 
		substr(a.nr_doc_convenio,1,20), 
		a.dt_entrada, 
		substr(obter_desc_plano(a.cd_convenio,a.cd_plano_convenio),1,40), 
		a.dt_validade_carteira, 
		a.ie_carater_inter, 
		substr(b.nr_crm_executor,1,15), 
		b.uf_crm_executor, 
		CASE WHEN obter_estab_atend(a.nr_atendimento)=1 THEN 2 WHEN obter_estab_atend(a.nr_atendimento)=11 THEN 1 END , 
		obter_acidente_tiss_atend(a.nr_atendimento), 
		obter_tecnica_utilizada_tiss(b.nr_seq_item), 
		coalesce(somente_numero(TISS_OBTER_TIPO_SAIDA('SPSADT',a.nr_interno_conta)),5), 
		coalesce(a.ie_clinica,1), 
		a.cd_motivo_alta, 
		substr(Obter_indicacao_clinica(a.nr_atendimento, b.cd_item, b.ie_origem_proced),1,500) 

union all
 
select		9					tp_registro, 
		4					ie_tipo_prestador, 
		101					cd_prestador, 
		''					nm_prestador, 
		0					nr_lote, 
		LOCALTIMESTAMP					dt_geracao, 
		0					cd_tipo_documento, 
		0					nr_documento, 
		''					nr_cep, 
		1					cd_tipo_prestador, 
		''					nr_crm, 
		LOCALTIMESTAMP					dt_inicio_internacao, 
		LOCALTIMESTAMP					dt_alta, 
		0					ie_padrao_internacao, 
		''					cd_unimed_usuario, 
		''					cd_contrato_usuario, 
		''					cd_familia_usuario, 
		''					ie_dependencia_usuario, 
		''					ie_digito_ver_usuario, 
		''					dt_exec_servico, 
		''					hr_exec_servico, 
		''					cd_cid, 
		''					ie_detalhe_cid, 
		''					cd_dig_verif_cid, 
		0					cd_seq_doc_servico,		 
		''					cd_amb_lpm, 
		''					cd_dig_verif_servico, 
		0					qt_servico_executado,				 
		''					ie_porte_cirurgico, 
		''					ie_partic_executante, 
		0					cd_local_atendimento, 
		0					vl_servico, 
		0					cd_moeda_servico, 
		0					vl_filme, 
		0					cd_moeda_filme, 
		0					nr_autorizacao, 
		0					cd_fator_plano, 
		0					ie_tipo_prest_executante, 
		0					cd_prest_executante, 
		''					ie_situacao_guia,		 
		''					nm_usuario, 
		''					hr_saida_paciente, 
		x.nr_seq_protocolo			nr_seq_protocolo, 
		0					nr_atendimento, 
		0					nr_interno_conta, 
		x.qt_total_conta			qt_doc_enviados, 
		0					qt_serv_relacionados, 
		sum(b.vl_total_item)			qt_total_servicos_real, 
		0					qt_total_cobrado_ch, 
		sum(b.vl_filme)				qt_total_filme, 
		0					cd_campo_quebra, 
		''					nr_guia_original, 
		LOCALTIMESTAMP					dt_emissao, 
		''					ds_plano, 
		LOCALTIMESTAMP					dt_validade_carteira, 
		''					ie_carater_internacao, 
		0					qt_solicitada, 
		0					qt_autorizada, 
		''					cd_conselho_profissional, 
		''					nr_conselho, 
		''					uf_conselho, 
		1					ie_tipo_atendimento, 
		0					ie_acidente, 
		''					ie_tecnica_utilizada, 
		0					tp_saida, 
		0					tp_consulta, 
		0					tp_internacao, 
		0					ie_regime_inter, 
		0					ie_motivo_saida_inter, 
		''					ds_indicacao_clinica 
from 		w_interf_conta_trailler x, 
		w_interf_conta_item b 
where		x.nr_seq_protocolo	= b.nr_seq_protocolo 
group by 
		x.nr_seq_protocolo, 
		x.qt_total_conta;

