-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_massa_guarani_empresa_v (nr_seq_lote, cd_usuario_plano, nm_beneficiario, ie_sexo, ie_estado_civil, nr_identidade, dt_nascimento, dt_contratacao, cd_matricula, cd_repasse, ie_situacao, ds_acomodacao, cd_anterior, nr_cpf, ds_endereco, ds_bairro, ds_municipio, sg_estado, cd_cep, nr_ddd, nr_telefone, nm_mae, nr_pis_pasep) AS select	a.nr_seq_lote,
	a.CD_USUARIO_PLANO, 
	A.NM_BENEFICIARIO, 
	a.ie_sexo, 
	CASE WHEN a.IE_ESTADO_CIVIL='2' THEN 'C' WHEN a.IE_ESTADO_CIVIL='1' THEN 'S' WHEN a.IE_ESTADO_CIVIL='3' THEN 'D'  ELSE 'O' END  ie_estado_civil, 
	a.NR_IDENTIDADE, 
	a.dt_nascimento, 
	a.dt_contratacao, 
	a.CD_MATRICULA, 
	(	select	pls_obter_cd_seq_congenere(x.nr_seq_congenere_atend,'CD') 
		FROM	pls_segurado_repasse 	x 
		where	x.nr_seq_segurado	= b.nr_sequencia 
		and	x.dt_liberacao is not null 
		and	((x.dt_fim_repasse is null) or (x.dt_fim_repasse > LOCALTIMESTAMP))) cd_repasse, 
	CASE WHEN a.IE_TIPO_MOVIMENTACAO='E' THEN 'I'  ELSE 'A' END  ie_situacao, 
	CASE WHEN d.IE_ACOMODACAO='C' THEN 'A' WHEN d.IE_ACOMODACAO='I' THEN 'B' END  ds_acomodacao, 
	substr(pls_obter_dados_segurado(b.NR_SEQ_SEGURADO_ANT,'C'),1,255) cd_anterior, 
	a.nr_cpf, 
	a.ds_endereco, 
	a.ds_bairro, 
	a.ds_municipio, 
	a.sg_estado, 
	a.cd_cep, 
	' ' nr_ddd, 
	a.nr_telefone, 
	a.nm_mae, 
	a.nr_pis_pasep 
from	PLS_MOVIMENTACAO_BENEF	a, 
	pls_segurado		b, 
	pls_plano		d 
where	a.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_plano		= d.nr_sequencia;

