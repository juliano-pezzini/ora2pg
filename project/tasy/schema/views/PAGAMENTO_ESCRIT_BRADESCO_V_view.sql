-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pagamento_escrit_bradesco_v (tp_registro, nr_inscricao, nm_empresa, dt_arquivo, hr_arquivo, ie_tipo_fornecedor, cd_cgc_fornecedor, nm_fornecedor, ds_endereco, cd_cep, cd_banco_fornecedor, cd_agencia_fornecedor, ie_dig_agencia_fornec, nr_conta_forneced, nr_digito_conta, nr_pagamento, cd_carteira, nr_bradesco, dt_vencimento, dt_emissao, dt_desconto, nr_fator_vencimento, vl_documento, vl_pagamento, vl_desconto, vl_acrescimo, nr_documento, cd_serie_documento, dt_pagamento, cd_moeda, cd_area_empresa, cd_lancamento, ie_tipo_conta, qt_registros, vl_total_pagto, nr_seq_envio, nr_bloqueto, nr_livre_bloqueto, nr_dig_bloqueto, cd_moeda_bloqueto, cd_banco_bloqueto, vl_bloqueto, cd_modalidade, ie_tipo_movimento) AS select 	0 tp_registro,
	a.cd_cgc nr_inscricao, 
	upper(p.ds_razao_social) nm_empresa, 
	e.dt_remessa_retorno dt_arquivo, 
	e.dt_remessa_retorno hr_arquivo, 
	'0' ie_tipo_fornecedor, 
	'0' cd_cgc_fornecedor, 
	'' nm_fornecedor, 
	'' ds_endereco, 
	'0' cd_cep, 
	0 cd_banco_fornecedor, 
	'0' cd_agencia_fornecedor, 
	'0' ie_dig_agencia_fornec, 
	'0' nr_conta_forneced, 
	'0' nr_digito_conta, 
	0 nr_pagamento, 
	'0' cd_carteira, 
	0 nr_bradesco, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	LOCALTIMESTAMP dt_desconto, 
	'0' nr_fator_vencimento, 
	0 vl_documento, 
	0 vl_pagamento, 
	0 vl_desconto, 
	0 vl_acrescimo, 
	0 nr_documento, 
	'' cd_serie_documento, 
	LOCALTIMESTAMP dt_pagamento, 
	0 cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	0 qt_registros, 
	0 vl_total_pagto, 
	e.nr_sequencia nr_seq_envio, 
	'0' nr_bloqueto, 
	'0' nr_livre_bloqueto, 
	'0' nr_dig_bloqueto, 
	'0' cd_moeda_bloqueto, 
	0 cd_banco_bloqueto, 
	0 vl_bloqueto, 
	0 cd_modalidade, 
	3 ie_tipo_movimento 
FROM banco_estabelecimento b, 
   estabelecimento a, 
   pessoa_juridica p, 
   banco_escritural e 
where e.cd_estabelecimento 	= a.cd_estabelecimento 
 and e.cd_estabelecimento 	= b.cd_estabelecimento 
 and a.cd_cgc 			= p.cd_cgc 
 and e.cd_banco		= b.cd_banco 
 and b.ie_tipo_relacao		in ('EP', 'ECC') 

union
 
/* Somente para bloquetos */
 
select 	1 tp_registro, 
	'0' nr_inscricao, 
	'' nm_empresa, 
	LOCALTIMESTAMP dt_arquivo, 
	LOCALTIMESTAMP hr_arquivo, 
	d.ie_tipo_favorecido ie_tipo_fornecedor, 
	CASE WHEN d.ie_tipo_favorecido=1 THEN substr(d.cd_favorecido,1,9) ||'0000'|| substr(d.cd_favorecido,10,2)  ELSE d.cd_favorecido END  cd_cgc_fornecedor, 
	upper(d.nm_favorecido) nm_fornecedor, 
	upper(d.ds_endereco) ds_endereco, 
	d.cd_cep, 
	c.cd_banco cd_banco_fornecedor, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  		c.cd_agencia_bancaria  ELSE '00000' END  cd_agencia_fornecedor, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  		to_char(calcula_digito('Modulo11',c.cd_agencia_bancaria))  ELSE '0' END  ie_dig_agencia_fornec, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  c.nr_conta  ELSE '0000000' END  nr_conta_forneced, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  c.ie_digito_conta  ELSE '0' END  nr_digito_conta, 
	c.nr_titulo nr_pagamento, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  '237'  ELSE '000' END  cd_carteira, 
	CASE WHEN substr(d.nr_bloqueto,1,3)='237' THEN  CASE WHEN d.nr_bloqueto=26 THEN  11 END   ELSE 000 END  nr_bradesco, 
	d.dt_vencimento_atual dt_vencimento, 
	d.dt_emissao, 
	d.dt_limite_antecipacao dt_desconto, 
	substr(d.nr_bloqueto,6,4) nr_fator_vencimento, 
	coalesce(c.vl_escritural,0) vl_documento, 
	(coalesce(c.vl_escritural,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0)) vl_pagamento, 
	c.vl_desconto, 
	c.vl_acrescimo, 
	coalesce(d.nr_documento,d.nr_titulo) nr_documento, 
	'' cd_serie_documento, 
	d.dt_vencimento_atual dt_pagamento, 
	c.ie_moeda cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	0 qt_registros, 
	0 vl_total_pagto, 
	a.nr_sequencia nr_seq_envio, 
	d.nr_bloqueto nr_bloqueto, 
	substr(d.nr_bloqueto,20, 25) nr_livre_bloqueto, 
	substr(d.nr_bloqueto, 5, 1) nr_dig_bloqueto, 
	substr(d.nr_bloqueto, 4, 1) cd_moeda_bloqueto, 
	Campo_Numerico(substr(d.nr_bloqueto, 1, 3)) cd_banco_bloqueto, 
	Campo_Numerico(substr(d.nr_bloqueto, 10, 10)) vl_bloqueto, 
	31 cd_modalidade, 
	3 ie_tipo_movimento 
from	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a, 
	titulo_pagar_v2 d, 
   	titulo_pagar_escrit c 
where c.nr_titulo     	= d.nr_titulo 
 and a.nr_sequencia    	= c.nr_seq_escrit 
 and a.cd_banco     	= b.cd_banco 
 and a.cd_estabelecimento 	= b.cd_estabelecimento 
 and a.cd_estabelecimento 	= e.cd_estabelecimento 
 and b.ie_tipo_relacao		in ('EP', 'ECC') 
 and c.ie_tipo_pagamento	= 'BLQ' 

union
 
/* Somente para Credito em Conta Corrente */
 
select 	1 tp_registro, 
	'0' nr_inscricao, 
	'' nm_empresa, 
	LOCALTIMESTAMP dt_arquivo, 
	LOCALTIMESTAMP hr_arquivo, 
	d.ie_tipo_favorecido ie_tipo_fornecedor, 
	CASE WHEN d.ie_tipo_favorecido=1 THEN substr(d.cd_favorecido,1,9) ||'0000'|| substr(d.cd_favorecido,10,2)  ELSE d.cd_favorecido END  cd_cgc_fornecedor, 
	upper(d.nm_favorecido) nm_fornecedor, 
	upper(d.ds_endereco) ds_endereco, 
	d.cd_cep, 
	237 cd_banco_fornecedor, 
	c.cd_agencia_bancaria cd_agencia_fornecedor, 
	CASE WHEN c.ie_digito_agencia IS NULL THEN  to_char(calcula_digito('Modulo11',c.cd_agencia_bancaria))  ELSE c.ie_digito_agencia END  ie_dig_agencia_fornec, 
	c.nr_conta nr_conta_forneced, 
	c.ie_digito_conta nr_digito_conta, 
	c.nr_titulo nr_pagamento, 
	'000' cd_carteira, 
	0 nr_bradesco, 
	d.dt_vencimento_atual dt_vencimento, 
	d.dt_emissao, 
	d.dt_limite_antecipacao dt_desconto, 
	'' nr_fator_vencimento, 
	c.vl_escritural vl_documento, 
	(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_pagamento, 
	c.vl_desconto, 
	c.vl_acrescimo, 
	coalesce(d.nr_documento,d.nr_titulo) nr_documento, 
	'' cd_serie_documento, 
	d.dt_vencimento_atual dt_pagamento, 
	c.ie_moeda cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	0 qt_registros, 
	0 vl_total_pagto, 
	a.nr_sequencia nr_seq_envio, 
	'' nr_bloqueto, 
	'' nr_livre_bloqueto, 
	'' ie_dig_bloqueto, 
	'' cd_moeda_bloqueto, 
	0 cd_banco_bloqueto, 
	0 vl_bloqueto, 
	1 cd_modalidade, 
	3 ie_tipo_movimento 
from	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a, 
	titulo_pagar_v2 d, 
   	titulo_pagar_escrit c 
where c.nr_titulo     	= d.nr_titulo 
 and a.nr_sequencia    	= c.nr_seq_escrit 
 and a.cd_banco     	= b.cd_banco 
 and a.cd_estabelecimento 	= b.cd_estabelecimento 
 and a.cd_estabelecimento 	= e.cd_estabelecimento 
 and b.ie_tipo_relacao	in ('EP', 'ECC') 
 and c.ie_tipo_pagamento	= 'CC' 

union
 
/* Somente para DOC - mesmo titular */
 
select 	1 tp_registro, 
	'0' nr_inscricao, 
	'' nm_empresa, 
	LOCALTIMESTAMP dt_arquivo, 
	LOCALTIMESTAMP hr_arquivo, 
	d.ie_tipo_favorecido ie_tipo_fornecedor, 
	CASE WHEN d.ie_tipo_favorecido=1 THEN substr(d.cd_favorecido,1,9) ||'0000'|| substr(d.cd_favorecido,10,2)  ELSE d.cd_favorecido END  cd_cgc_fornecedor, 
	upper(d.nm_favorecido) nm_fornecedor, 
	upper(d.ds_endereco) ds_endereco, 
	d.cd_cep, 
	c.cd_banco cd_banco_fornecedor, 
	c.cd_agencia_bancaria cd_agencia_fornecedor, 
	CASE WHEN c.ie_digito_agencia IS NULL THEN  to_char(calcula_digito('Modulo11',c.cd_agencia_bancaria))  ELSE c.ie_digito_agencia END  ie_dig_agencia_fornec, 
	c.nr_conta nr_conta_forneced, 
	c.ie_digito_conta nr_digito_conta, 
	c.nr_titulo nr_pagamento, 
	'000' cd_carteira, 
	0 nr_bradesco, 
	d.dt_vencimento_atual dt_vencimento, 
	d.dt_emissao, 
	d.dt_limite_antecipacao dt_desconto, 
	'' nr_fator_vencimento, 
	c.vl_escritural vl_documento, 
	(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_pagamento, 
	c.vl_desconto, 
	c.vl_acrescimo, 
	coalesce(d.nr_documento,d.nr_titulo) nr_documento, 
	'' cd_serie_documento, 
	d.dt_vencimento_atual dt_pagamento, 
	c.ie_moeda cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	0 qt_registros, 
	0 vl_total_pagto, 
	a.nr_sequencia nr_seq_envio, 
	'' nr_bloqueto, 
	CASE WHEN e.cd_cgc=d.cd_favorecido THEN 'D'  ELSE 'C' END  || '000000' || '01' || '01' nr_livre_bloqueto, 
	'' ie_dig_bloqueto, 
	'' cd_moeda_bloqueto, 
	0 cd_banco_bloqueto, 
	0 vl_bloqueto, 
	03 cd_modalidade, 
	3 ie_tipo_movimento 
from	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a, 
	titulo_pagar_v2 d, 
   	titulo_pagar_escrit c 
where c.nr_titulo     	= d.nr_titulo 
 and a.nr_sequencia    	= c.nr_seq_escrit 
 and a.cd_banco     	= b.cd_banco 
 and a.cd_estabelecimento 	= b.cd_estabelecimento 
 and a.cd_estabelecimento 	= e.cd_estabelecimento 
 and b.ie_tipo_relacao	in ('EP', 'ECC') 
 and c.ie_tipo_pagamento	= 'DOC' 

Union
 
/* Somente para TED */
 
select 	1 tp_registro, 
	'0' nr_inscricao, 
	'' nm_empresa, 
	LOCALTIMESTAMP dt_arquivo, 
	LOCALTIMESTAMP hr_arquivo, 
	d.ie_tipo_favorecido ie_tipo_fornecedor, 
	CASE WHEN d.ie_tipo_favorecido=1 THEN substr(d.cd_favorecido,1,9) ||'0000'|| substr(d.cd_favorecido,10,2)  ELSE d.cd_favorecido END  cd_cgc_fornecedor, 
	upper(d.nm_favorecido) nm_fornecedor, 
	upper(d.ds_endereco) ds_endereco, 
	d.cd_cep, 
	c.cd_banco cd_banco_fornecedor, 
	c.cd_agencia_bancaria cd_agencia_fornecedor, 
	CASE WHEN c.ie_digito_agencia IS NULL THEN  to_char(calcula_digito('Modulo11',c.cd_agencia_bancaria))  ELSE c.ie_digito_agencia END  ie_dig_agencia_fornec, 
	c.nr_conta nr_conta_forneced, 
	c.ie_digito_conta nr_digito_conta, 
	c.nr_titulo nr_pagamento, 
	'000' cd_carteira, 
	0 nr_bradesco, 
	d.dt_vencimento_atual dt_vencimento, 
	d.dt_emissao, 
	d.dt_limite_antecipacao dt_desconto, 
	'' nr_fator_vencimento, 
	c.vl_escritural vl_documento, 
	(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_pagamento, 
	c.vl_desconto, 
	c.vl_acrescimo, 
	coalesce(d.nr_documento,d.nr_titulo) nr_documento, 
	'' cd_serie_documento, 
	d.dt_vencimento_atual dt_pagamento, 
	c.ie_moeda cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	0 qt_registros, 
	0 vl_total_pagto, 
	a.nr_sequencia nr_seq_envio, 
	'' nr_bloqueto, 
	CASE WHEN e.cd_cgc=d.cd_favorecido THEN 'D'  ELSE 'C' END  || '000000' || '01' || '01' nr_livre_bloqueto, 
	'' ie_dig_bloqueto, 
	'' cd_moeda_bloqueto, 
	0 cd_banco_bloqueto, 
	0 vl_bloqueto, 
	08 cd_modalidade, 
	3 ie_tipo_movimento 
from	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a, 
	titulo_pagar_v2 d, 
   	titulo_pagar_escrit c 
where	c.nr_titulo		= d.nr_titulo 
and	a.nr_sequencia		= c.nr_seq_escrit 
and	a.cd_banco		= b.cd_banco 
and	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.cd_estabelecimento	= e.cd_estabelecimento 
and	b.ie_tipo_relacao		in ('EP', 'ECC') 
and	c.ie_tipo_pagamento	= 'TED' 

union
 
/* Trailler */
 
 select 9 tp_registro, 
	'0' nr_inscricao, 
	'' nm_empresa, 
	LOCALTIMESTAMP dt_arquivo, 
	LOCALTIMESTAMP hr_arquivo, 
	'0' ie_tipo_fornecedor, 
	'0' cd_cgc_fornecedor, 
	'' nm_fornecedor, 
	'' ds_endereco, 
	'0' cd_cep, 
	0 cd_banco_fornecedor, 
	'0' cd_agencia_fornecedor, 
	'0' ie_dig_agencia_fornec, 
	'0' nr_conta_forneced, 
	'0' nr_digito_conta, 
	0 nr_pagamento, 
	'0' cd_carteira, 
	0 nr_bradesco, 
	LOCALTIMESTAMP dt_vencimento, 
	LOCALTIMESTAMP dt_emissao, 
	LOCALTIMESTAMP dt_desconto, 
	'0' nr_fator_vencimento, 
	0 vl_documento, 
	0 vl_pagamento, 
	0 vl_desconto, 
	0 vl_acrescimo, 
	0 nr_documento, 
	'' cd_serie_documento, 
	LOCALTIMESTAMP dt_pagamento, 
	0 cd_moeda, 
	0 cd_area_empresa, 
	01321 cd_lancamento, 
	0 ie_tipo_conta, 
	(count(*) + 2) qt_registros, 
	sum(c.vl_escritural - c.vl_desconto + c.vl_acrescimo) vl_total_pagto, 
   e.nr_sequencia nr_seq_envio, 
	'0' nr_bloqueto, 
	'0' nr_livre_bloqueto, 
	'0' nr_dig_bloqueto, 
	'0' cd_moeda_bloqueto, 
	0 cd_banco_bloqueto, 
	0 vl_bloqueto, 
	0 cd_modalidade, 
	3 ie_tipo_movimento 
 FROM titulo_pagar_escrit c, estabelecimento a, banco_estabelecimento b
LEFT OUTER JOIN banco_escritural e ON (b.nr_sequencia = e.nr_seq_conta_banco)
WHERE e.nr_sequencia			= c.nr_seq_escrit and e.cd_banco 			= b.cd_banco  and e.cd_estabelecimento 		= b.cd_estabelecimento and e.cd_estabelecimento 		= a.cd_estabelecimento and b.ie_tipo_relacao		in ('EP', 'ECC') group by e.nr_sequencia;

