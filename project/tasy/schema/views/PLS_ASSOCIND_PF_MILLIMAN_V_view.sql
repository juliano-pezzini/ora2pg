-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_assocind_pf_milliman_v (nr_sequencia, nr_cpf, nm_beneficiario, ie_sexo, dt_nascimento, nm_municipio, dt_ingresso, nr_matricula_benef, ie_tipo_contratacao, nm_lote, tp_registro, ie_tipo_garantia, ie_grau_dependencia, dt_saida, cd_produto_ans, nr_matricula_titular, cd_estabelecimento) AS select	b.nr_sequencia,
	a.nr_cpf		nr_cpf,
	a.nm_pessoa_fisica	nm_beneficiario,
	a.ie_sexo		ie_sexo,
	a.dt_nascimento		dt_nascimento,
	(	select	max(x.ds_municipio)
		FROM	compl_pessoa_fisica	x
		where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	x.ie_tipo_complemento	in (1,2)) nm_municipio,
	b.dt_contratacao	dt_ingresso,
	c.cd_usuario_plano 	nr_matricula_benef,
	e.ie_tipo_contratacao	ie_tipo_contratacao,
	' '			nm_lote,
	' '			tp_registro,
	CASE WHEN e.ie_segmentacao='3' THEN  '1' WHEN e.ie_segmentacao='7' THEN  '2' WHEN e.ie_segmentacao='1' THEN  '3' WHEN e.ie_segmentacao='2' THEN  '4' WHEN e.ie_segmentacao='11' THEN  '5' WHEN e.ie_segmentacao='5' THEN  '6' WHEN e.ie_segmentacao='12' THEN  '7' WHEN e.ie_segmentacao='10' THEN  '8' WHEN e.ie_segmentacao='8' THEN  '9' WHEN e.ie_segmentacao='9' THEN  '10' WHEN e.ie_segmentacao='4' THEN  '11' WHEN e.ie_segmentacao='6' THEN  '12' END  ie_tipo_garantia,
	CASE WHEN b.nr_seq_titular IS NULL THEN  '1'  ELSE CASE WHEN b.nr_seq_parentesco=125 THEN '3'  ELSE '2' END  END 	ie_grau_dependencia,
	b.dt_rescisao		dt_saida,
	CASE WHEN e.ie_regulamentacao='R' THEN  e.cd_scpa  ELSE e.nr_protocolo_ans END 	cd_produto_ans,
	CASE WHEN b.nr_seq_titular IS NULL THEN  c.cd_usuario_plano  ELSE (	select	y.cd_usuario_plano								from	pls_segurado_carteira	y,									pls_segurado		x								where	x.nr_sequencia 		= y.nr_seq_segurado								and	x.nr_sequencia 		= b.nr_seq_titular) END  nr_matricula_titular,
	a.cd_estabelecimento
from	pessoa_fisica		a,
	pls_segurado		b,
	pls_segurado_carteira	c,
	pls_contrato		h,
	pls_plano		e
where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica
and	b.nr_sequencia 		= c.nr_seq_segurado
and	h.nr_sequencia		= b.nr_seq_contrato
and	b.nr_seq_plano		= e.nr_sequencia
and	b.ie_tipo_segurado	= 'B'
and	e.ie_tipo_contratacao	= 'I';

