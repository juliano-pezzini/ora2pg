-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_medicine_v (encounter_id, medicine_code, medicine_description, medicine_route, route_desc, medicine_dose, medicine_interval, interval_desc, unit, unit_desc, medicine_suspension_code, medicine_susp_desc, medicine_final_date, change_type, med_submission_date, doctor_code, doctor_given_name, doctor_last_name, doctor_middle_name) AS select	a.nr_atendimento encounter_id,
           	a.cd_material medicine_code,
           	obter_desc_material(a.cd_material) medicine_description,
           	a.ie_via_aplicacao medicine_route,
        	obter_via_aplicacao(a.ie_via_aplicacao, 'D') route_desc,
        	a.qt_dose medicine_dose,
        	a.cd_intervalo medicine_interval,
       	obter_desc_intervalo_prescr(a.cd_intervalo) interval_desc,
        	a.cd_unidade_medida unit,        
       	obter_desc_unidade_medida(a.cd_unidade_medida) unit_desc,
        	a.nr_seq_motivo_susp medicine_suspension_code,
       	obter_desc_motivo_susp(a.nr_seq_motivo_susp) medicine_susp_desc,        
        	a.dt_fim medicine_final_date,
        	CASE WHEN a.dt_suspensao IS NULL THEN  'N'  ELSE 'S' END  change_type,
        	a.dt_liberacao med_submission_date,
        	coalesce(a.cd_medico, a.nm_usuario) doctor_code,
        	obter_dados_pf(coalesce(a.cd_medico, a.nm_usuario),'PNG') doctor_given_name,
        	obter_dados_pf(coalesce(a.cd_medico, a.nm_usuario),'PNL') doctor_last_name,
        	obter_dados_pf(coalesce(a.cd_medico, a.nm_usuario),'PNM') doctor_middle_name
FROM    	cpoe_material a
where   	a.dt_liberacao is not null

union

select  	b.nr_atendimento encounter_id,
        	c.cd_material medicine_code,
        	obter_desc_material(c.cd_material) medicine_description,
        	c.ie_via_aplicacao medicine_route,
        	obter_via_aplicacao(c.ie_via_aplicacao, 'D') route_desc,
        	c.qt_dose medicine_dose,
        	c.cd_intervalo medicine_interval,        
        	obter_desc_intervalo_prescr(c.cd_intervalo) interval_desc,        
        	c.cd_unidade_medida unit,       
        	obter_desc_unidade_medida(c.cd_unidade_medida) unit_desc,
        	b.nr_seq_motivo_canc medicine_suspension_code,
        	obter_desc_motivo_canc(b.nr_seq_motivo_canc) medicine_susp_desc,
        	b.dt_validade_receita medicine_final_date,
        	CASE WHEN b.dt_cancelamento IS NULL THEN  'N'  ELSE 'S' END  change_type,
        	b.dt_liberacao med_submission_date,
        	coalesce(b.cd_medico, b.nm_usuario) doctor_code,
        	obter_dados_pf(coalesce(b.cd_medico, b.nm_usuario),'PNG') doctor_given_name,
        	obter_dados_pf(coalesce(b.cd_medico, b.nm_usuario),'PNL') doctor_last_name,
        	obter_dados_pf(coalesce(b.cd_medico, b.nm_usuario),'PNM') doctor_middle_name
from    	fa_receita_farmacia b, 
	fa_receita_farmacia_item c
where   	b.nr_sequencia = c.nr_seq_receita
and     	b.dt_liberacao is not null

union

select  	d.nr_atendimento encounter_id,
        	d.cd_material medicine_code,
        	obter_desc_material(d.cd_material) medicine_description,
        	d.ie_via_aplicacao medicine_route,        
        	obter_via_aplicacao(d.ie_via_aplicacao, 'D') route_desc,
        	d.qt_dose medicine_dose,
        	d.cd_intervalo medicine_interval,       
        	obter_desc_intervalo_prescr(d.cd_intervalo) interval_desc,        
        	d.cd_unid_med unit,        
        	obter_desc_unidade_medida(d.cd_unid_med) unit_desc,
        	null medicine_suspension_code,
        	d.ds_motivo||d.ds_justificativa medicine_susp_desc,
        	d.dt_fim medicine_final_date,
        	CASE WHEN d.dt_inativacao IS NULL THEN  'N'  ELSE 'S' END  change_type,
        	d.dt_liberacao med_submission_date,
        	coalesce(d.cd_profissional, d.nm_usuario) doctor_code,
        	obter_dados_pf(coalesce(d.cd_profissional, d.nm_usuario),'PNG') doctor_given_name,
        	obter_dados_pf(coalesce(d.cd_profissional, d.nm_usuario),'PNL') doctor_last_name,
        	obter_dados_pf(coalesce(d.cd_profissional, d.nm_usuario),'PNM') doctor_middle_name
from    	paciente_medic_uso d
where   	d.dt_liberacao is not null;

