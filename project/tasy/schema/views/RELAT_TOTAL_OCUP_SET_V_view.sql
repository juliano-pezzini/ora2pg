-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW relat_total_ocup_set_v (ds_setor_atendimento, nr_unidades_setor, nr_unidades_ocupadas, nr_unidades_temporarias, nr_unidades_reservadas, nr_unidades_higienizacao, nr_unidades_livres, nr_unid_temp_ocup, nr_unid_ocup, qt_unidade_acomp, nr_unidades_interditadas, qt_unidades_isolamento, qt_pac_isolado, qt_unidades_alta, qt_unidade_chamad_manut, qt_unidade_manutencao, qt_unidade_saida_inter, nr_unidades_normais, pr_ocupacao, pr_ocupacao_acomp, pr_ocupacao_total, pr_ocupacao_total2, pr_olf, pr_ohr) AS SELECT 'Total Geral' ds_setor_atendimento,
    SUM(CASE WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor END ) nr_unidades_setor,                                        
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas END ) nr_unidades_ocupadas,                                  
    SUM(nr_unidades_temporarias) nr_unidades_temporarias,          
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_reservadas END ) nr_unidades_reservadas,                                
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_higienizacao END ) nr_unidades_higienizacao,                              
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_livres END ) nr_unidades_livres,                                    
    SUM(nr_unid_temp_ocup) nr_unid_temp_ocup,                 
    SUM(nr_unid_temp_ocup) + SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas END ) nr_unid_ocup,                          
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_acomp END ) qt_unidade_acomp,                                      
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_interditadas END ) nr_unidades_interditadas,                              
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_isolamento END ) qt_unidades_isolamento, 
	  SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_pac_isolado END ) qt_pac_isolado,                                   
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_alta END ) qt_unidades_alta,  
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_chamad_manut END ) qt_unidade_chamad_manut, 
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_manutencao END ) qt_unidade_manutencao, 
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_saida_inter END ) qt_unidade_saida_inter,                                
    SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor - nr_unidades_temporarias END ) nr_unidades_normais,                       
/*   (SUM(DECODE(ie_ocup_hospitalar,'M',0,'T',0,nr_unidades_ocupadas * 100)) /                                         
    SUM(DECODE(ie_ocup_hospitalar,'M',0,'T',0,nr_unidades_setor + nr_unid_te 
mp_ocup - nr_unidades_temporarias))) pr_ocupacao,*/
               
    Obter_percetual_ocupacao(                        
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor END ),        
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_temporarias END ),     
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas END ),       
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_acomp END ),         
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_interditadas END ),     
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_livres END ),        
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_higienizacao END ),     
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_reservadas END ),      
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_isolamento END ),      
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_alta END ),         
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_ocup END ),        
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_ocupadas END ),      
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unid_temp_acomp END ),        
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_interditadas END ),    
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_livres END ),       
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_higienizacao END ),    
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unid_temp_reservadas END ),     
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unid_temp_isolamento END ),     
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unid_temp_alta END ), 
			SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_manutencao END ), 
			'1') pr_ocupacao,                           
    dividir((SUM(nr_unidades_ocupadas) + SUM(qt_unidade_acomp)) * 100,SUM(nr_unidades_setor)) pr_ocupacao_acomp,                       
    dividir(SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE (nr_unidades_setor - qt_disponiveis) END ), SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE (nr_unidades_setor) END )) * 100 pr_ocupacao_total,                            
    dividir(SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas + qt_unidade_acomp + qt_unidades_isolamento + nr_unidades_interditadas + nr_unidades_reservadas + nr_unid_temp_ocup END ) * 100 ,            
      SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor + nr_unid_temp_ocup END )) pr_ocupacao_total2,                        
    dividir(SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas * 100 END ), SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor - nr_unidades_temporarias END )) pr_olf,                             
    dividir(SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas * 100 END ), SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE (nr_unidades_setor + nr_unidades_temporarias) - nr_unidades_interditadas END )) pr_ohr               
FROM  ocupacao_setores_v2                            
WHERE ie_ocup_hospitalar IN ('S','M','T') AND ie_situacao = 'A'         
AND Obter_se_exibe_estab(cd_estabelecimento_base,1,'007129','N') = 'S'      
AND  (('N' = 'N') OR (('N' = 'S') AND (obter_se_setor_usuario(cd_setor_atendimento, '007129') = 'S')))                             
AND  ((('N' = 'N') AND (cd_classif_setor IN (3,4))) OR             
    (('N' = 'S') AND (cd_classif_setor IN (1,3,4))))              
GROUP BY 'Total Geral';

