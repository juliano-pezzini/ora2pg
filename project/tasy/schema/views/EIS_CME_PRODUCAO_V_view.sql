-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cme_producao_v (ie_tipo, dt_origem, qt_conj_montado, cd_pessoa_resp, nm_resp_montagem, qt_ciclos, nr_seq_equipamento, ds_equipamento, qt_conj_ciclo, nr_seq_conjunto, nm_conjunto, ds_setor, ds_pessoa, ds_medico, ds_cnpj, qt_tamanho, ie_tamanho, cd_estabelecimento) AS select	1 ie_tipo,
	trunc(a.dt_origem) dt_origem, 
	count(*) qt_conj_montado, 
	a.cd_pessoa_resp, 
	substr(obter_nome_pessoa_fisica(a.cd_pessoa_resp,null),1,100) nm_resp_montagem, 
	0 qt_ciclos, 
	b.nr_seq_equipamento, 
	substr(cme_obter_desc_equip(b.nr_seq_equipamento),1,100) ds_equipamento, 
	0 qt_conj_ciclo, 
	a.nr_seq_conjunto, 
	substr(cme_obter_nome_conjunto(a.nr_seq_conjunto),1,100) nm_conjunto, 
	substr(obter_nome_setor(a.cd_setor_atend_dest),1,100) ds_setor, 
	substr(obter_nome_pf_pj(a.cd_pessoa_fisica,null),1,100) ds_pessoa, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,100) ds_medico, 
	substr(obter_nome_pf_pj(null,a.cd_cgc),1,100) ds_cnpj, 
	0 qt_tamanho, 
	null ie_tamanho, 
	a.cd_estabelecimento 
FROM cm_conjunto_cont a
LEFT OUTER JOIN cm_ciclo b ON (a.nr_seq_ciclo = b.nr_sequencia)
WHERE a.ie_status_conjunto in (1,5) and coalesce(a.ie_situacao,'A') = 'A' group by	trunc(a.dt_origem), 
	a.cd_pessoa_resp, 
	b.nr_seq_equipamento, 
	a.nr_seq_conjunto, 
	a.cd_setor_atend_dest, 
	a.cd_pessoa_fisica, 
	a.cd_medico, 
	a.cd_cgc, 
	a.cd_estabelecimento 

union
 
select	2 ie_tipo, 
	trunc(dt_inicio) dt_origem, 
	0 qt_conj_montado, 
	null cd_pessoa_resp, 
	null nm_resp_montagem, 
	count(*) qt_ciclos, 
	b.nr_seq_equipamento, 
	substr(cme_obter_desc_equip(b.nr_seq_equipamento),1,100) ds_equipamento, 
	0 qt_conj_ciclo, 
	null nr_seq_conjunto, 
	null nm_conjunto, 
	null ds_setor, 
	null ds_pessoa, 
	null ds_medico, 
	null ds_cnpj, 
	0 qt_tamanho, 
	null ie_tamanho, 
	b.cd_estabelecimento 
from	cm_ciclo b 
where	b.dt_fim is not null 
group by	trunc(dt_inicio), 
	b.nr_seq_equipamento, 
	b.cd_estabelecimento 

union
 
select	3 ie_tipo, 
	trunc(a.dt_origem) dt_origem, 
	0 qt_conj_montado, 
	a.cd_pessoa_resp, 
	substr(obter_nome_pessoa_fisica(a.cd_pessoa_resp,null),1,100) nm_resp_montagem, 
	0 qt_ciclos, 
	b.nr_seq_equipamento, 
	substr(cme_obter_desc_equip(b.nr_seq_equipamento),1,100) ds_equipamento, 
	count(*) qt_conj_ciclo, 
	a.nr_seq_conjunto, 
	substr(cme_obter_nome_conjunto(a.nr_seq_conjunto),1,100) nm_conjunto, 
	substr(obter_nome_setor(a.cd_setor_atend_dest),1,100) ds_setor, 
	substr(obter_nome_pf_pj(a.cd_pessoa_fisica,null),1,100) ds_pessoa, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,100) ds_medico, 
	substr(obter_nome_pf_pj(null,a.cd_cgc),1,100) ds_cnpj, 
	0 qt_tamanho, 
	null ie_tamanho, 
	a.cd_estabelecimento 
from	cm_ciclo b, 
	cm_conjunto_cont a 
where	a.nr_seq_ciclo = b.nr_sequencia 
and	b.dt_fim is not null 
and	coalesce(a.ie_situacao,'A') = 'A' 
group by	trunc(a.dt_origem), 
	a.cd_pessoa_resp, 
	b.nr_seq_equipamento, 
	a.nr_seq_conjunto, 
	a.cd_setor_atend_dest, 
	a.cd_pessoa_fisica, 
	a.cd_medico, 
	a.cd_cgc, 
	a.cd_estabelecimento 

union
 
select	4 ie_tipo, 
	y.dt_origem dt_origem, 
	0 qt_conj_montado, 
	null cd_pessoa_resp, 
	null nm_resp_montagem, 
	0 qt_ciclos, 
	null nr_seq_equipamento, 
	null ds_equipamento, 
	0 qt_conj_ciclo, 
	y.nr_seq_conjunto, 
	null nm_conjunto, 
	null ds_setor, 
	null ds_pessoa, 
	null ds_medico, 
	null ds_cnpj, 
	count(ie_tamanho) qt_tamanho, 
	ie_tamanho ie_tamanho, 
	y.cd_estabelecimento 
from 	cm_conjunto x, 
	cm_conjunto_cont y 
where 	ie_tamanho is not null 
and 	x.nr_sequencia = y.nr_seq_conjunto 
and	y.ie_status_conjunto = 3 
group by ie_tamanho, 
	dt_origem,	 
	nr_seq_conjunto, 
	y.cd_estabelecimento;

