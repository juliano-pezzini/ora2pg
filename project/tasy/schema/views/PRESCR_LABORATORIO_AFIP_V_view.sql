-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW prescr_laboratorio_afip_v (nr_prescricao, nr_sequencia, ds_estabelecimento, cd_estabelecimento, cd_pessoa_fisica, nm_usuario, ds_observacao, ie_urgencia, cd_setor_atendimento, nr_atendimento, cd_medico, dt_prescricao, dt_liberacao, cd_setor_paciente, nm_paciente, nm_paciente_sem_acento, dt_nascimento, ie_sexo, nr_prontuario, nm_medico, nr_crm, uf_crm, cd_convenio, cd_categoria, cd_usuario_convenio, dt_validade_carteira, nr_doc_convenio, ie_tipo_guia, ds_convenio, cd_cgc_conv, cd_regional_conv, cd_material_exame, ds_material_exame, cd_exame, nm_exame, sg_conselho, ds_setor_paciente, cd_unidade, cd_unidade_basica, cd_unidade_compl, cd_exame_integracao, dt_recoleta, qt_peso, qt_altura_cm, dt_coleta, nm_pessoa_responsavel, nr_controle_exame, ds_senha, cd_material_integracao, dt_cancelamento, dt_mestruacao, ds_obs_prescr) AS SELECT
	a.NR_PRESCRICAO, 
	a.NR_SEQUENCIA, 
	a.ds_estabelecimento, 
	a.cd_estabelecimento, 
	coalesce(c.cd_sistema_ant,a.cd_pessoa_fisica) cd_pessoa_fisica, 
	a.NM_USUARIO, 
	a.DS_OBSERVACAO, 
	CASE WHEN r.nr_seq_prioridade=1 THEN  'S' WHEN r.nr_seq_prioridade=2 THEN  'S'  ELSE a.ie_urgencia END  ie_urgencia, 
	a.cd_setor_atendimento, 
	a.NR_ATENDIMENTO, 
 	a.CD_MEDICO, 
 	a.DT_PRESCRICAO, 
	a.DT_LIBERACAO, 
	g.cd_setor_atendimento cd_setor_paciente, 
	CASE WHEN a.CD_RECEM_NATO IS NULL THEN c.NM_PESSOA_FISICA  ELSE SUBSTR(obter_nome_pf(a.CD_RECEM_NATO),1,80) ||' RN de '||c.NM_PESSOA_FISICA END  NM_PACIENTE, 
	elimina_acentuacao(UPPER(CASE WHEN a.CD_RECEM_NATO IS NULL THEN c.NM_PESSOA_FISICA  ELSE SUBSTR(obter_nome_pf(a.CD_RECEM_NATO),1,80) ||' RN de '||c.NM_PESSOA_FISICA END )) NM_PACIENTE_SEM_ACENTO, 
	c.DT_NASCIMENTO, 
	c.IE_SEXO, 
	c.NR_PRONTUARIO, 
	d.NM_PESSOA_FISICA NM_MEDICO, 
	e.NR_CRM, 
	e.UF_CRM,			/*Elemar - 27/08/2008*/
 
	F.CD_CONVENIO, 
	F.CD_CATEGORIA, 
	F.CD_USUARIO_CONVENIO, 
	F.DT_VALIDADE_CARTEIRA, 	/*Elemar - 27/08/2008*/
 
	F.NR_DOC_CONVENIO,		/*Elemar - 27/08/2008*/
 
	F.IE_TIPO_GUIA,			/*Elemar - 27/08/2008*/
 
	V.DS_CONVENIO, 
	V.CD_CGC CD_CGC_CONV,		/*Elemar - 27/08/2008*/
 
	V.CD_REGIONAL CD_REGIONAL_CONV,	/*Elemar - 27/08/2008*/
 
	A.CD_MATERIAL_EXAME, 
	m.ds_material_exame, 
	Y.CD_EXAME, 
	y.nm_exame, 
	obter_conselho_profissional(d.nr_seq_conselho,'S') sg_conselho, 
	s.ds_setor_atendimento ds_setor_paciente, 
	g.cd_unidade_basica || ' ' || cd_unidade_compl cd_unidade, 
	g.cd_unidade_basica, 
	cd_unidade_compl, 
	coalesce(Obter_Equipamento_Exame(y.nr_seq_exame,null,'AFIP'),y.cd_exame_integracao) cd_exame_integracao, 
	(select max(dt_atualizacao) FROM prescr_proc_etapa z where z.ie_etapa = 12 and z.nr_prescricao = a.nr_prescricao and z.nr_seq_prescricao = a.nr_sequencia) dt_recoleta, 
	a.qt_peso, 
	a.qt_altura_cm, 
	--0 qt_peso, 
	--0 qt_altura_cm, 
	a.DT_COLETA, 
	substr((select max(nm_pessoa_fisica) from pessoa_fisica where cd_pessoa_fisica = t.cd_pessoa_responsavel),1,40) nm_pessoa_responsavel, 
	a.nr_controle_exame, 
	substr(t.ds_senha,1,20) ds_senha, 
	m.cd_material_integracao, 
	a.dt_cancelamento, 
	a.dt_mestruacao, 
	a.ds_obs_prescr 
FROM convenio v, setor_atendimento s, procedimento p, atend_paciente_unidade g, atend_categoria_convenio f, pessoa_fisica d, pessoa_fisica c, atendimento_paciente t
LEFT OUTER JOIN tipo_indicacao h ON (t.nr_seq_indicacao = h.nr_sequencia)
LEFT OUTER JOIN triagem_classif_risco r ON (t.nr_seq_triagem = r.nr_sequencia)
, (SELECT a.cd_procedimento, 
		a.ie_origem_proced, 
		a.nr_seq_exame, 
		Obter_nome_fantasia_estab(b.cd_estabelecimento) ds_estabelecimento, 
		a.cd_material_exame, 
		a.NR_PRESCRICAO, 
		a.NR_SEQUENCIA, 
		a.QT_PROCEDIMENTO, 
		a.DT_ATUALIZACAO, 
		a.NM_USUARIO, 
		a.DS_OBSERVACAO, 
		a.IE_URGENCIA, 
		a.DS_DADO_CLINICO, 
		a.IE_SUSPENSO, 
		a.cd_setor_atendimento, 
		A.DS_MATERIAL_ESPECIAL, 
		a.ie_amostra, 
		a.ds_horarios, 
		a.dt_prev_execucao, 
		a.ie_executar_leito, 
		a.nr_seq_proc_interno, 
		a.nr_seq_condicao, 
		b.NR_ATENDIMENTO, 
		b.CD_MEDICO, 
		b.DT_PRESCRICAO, 
		b.DT_LIBERACAO, 
		b.DT_LIBERACAO_MEDICO, 
		b.IE_RECEM_NATO, 
		b.CD_RECEM_NATO, 
		b.cd_estabelecimento, 
		b.cd_pessoa_fisica, 
		b.NR_CONTROLE, 
		b.DT_MESTRUACAO, 
		b.QT_PESO, 
		a.DT_RESULTADO, 
		a.DT_COLETA, 
		a.IE_AUTORIZACAO, 
		a.nr_controle_exame, 
		a.dt_cancelamento, 
		b.qt_altura_cm, 
		b.ds_observacao ds_obs_prescr 
	FROM	prescr_medica b, 
		prescr_procedimento a 
	WHERE	a.nr_prescricao 		= b.nr_prescricao 
	AND 	a.dt_integracao IS NULL 
	AND	a.nr_seq_exame IS NOT NULL 
	AND 	coalesce(dt_liberacao_medico, dt_liberacao) IS NOT NULL 
	AND 	coalesce(A.IE_SUSPENSO,'N')	= 'N' 
	and	 	Obter_Equipamento_Exame(nr_seq_exame,null,'AFIP') is not null 
	AND		b.dt_prescricao BETWEEN LOCALTIMESTAMP - interval '30 days' AND LOCALTIMESTAMP + interval '10 days' 
	) a
LEFT OUTER JOIN compl_pessoa_fisica z ON (a.cd_pessoa_fisica = z.cd_pessoa_fisica AND 1 = z.IE_TIPO_COMPLEMENTO)
LEFT OUTER JOIN medico e ON (a.cd_medico = e.cd_pessoa_fisica)
LEFT OUTER JOIN material_exame_lab m ON (a.cd_material_exame = m.cd_material_exame)
, coalesce(a
LEFT OUTER JOIN exame_laboratorio y ON (coalesce(a.nr_seq_exame,obter_exame_lab_proc_int(a.nr_seq_proc_interno)) = y.nr_seq_exame)
WHERE a.cd_procedimento		= p.cd_procedimento AND a.ie_origem_proced		= p.ie_origem_proced AND a.cd_pessoa_fisica 		= c.cd_pessoa_fisica  AND a.cd_medico 			= d.cd_pessoa_fisica    AND G.NR_SEQ_INTERNO		= obter_atepacu_paciente(a.nr_atendimento,'A') AND G.CD_SETOR_ATENDIMENTO		= S.CD_SETOR_ATENDIMENTO  AND F.NR_ATENDIMENTO 		= a.NR_ATENDIMENTO AND T.NR_ATENDIMENTO 		= a.nR_ATENDIMENTO  --AND	NVL(h.ie_integra,'S')		= 'S' 
  AND F.DT_INICIO_VIGENCIA 		= (SELECT MAX(W.DT_INICIO_VIGENCIA) FROM ATEND_CATEGORIA_CONVENIO W WHERE W.NR_ATENDIMENTO = a.NR_ATENDIMENTO) AND F.CD_CONVENIO     		= V.CD_CONVENIO;

