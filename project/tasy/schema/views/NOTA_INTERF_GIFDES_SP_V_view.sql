-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_interf_gifdes_sp_v (tp_registro, ds_registro, versao_sefinnet, nr_cmc, cnpj, ds_razao, ds_nome, insc_estadual, junta_comercial, endereco, numero, complemento, bairro, cidade, uf, cep, ddd, fone, fax, email, cd_estabelecimento, dt_emissao, dt_emissao_nota, ie_grafica, nr_cmc_prest, cnpj_prest, nr_nota_fiscal, cd_serie_nf, ie_situacao, cnae, vl_contabil_total, base_calculo_total, aliquota_iss, vl_iss, ds_observacao, cfps, cst, cnpj_grafica, nr_aidf, nr_nota_ini, nr_nota_fim) AS select	1		tp_registro,
	'H'		ds_registro,
	'3.00.0001'	versao_sefinnet,
	'' 		nr_cmc,
	'' 		cnpj,
	'' 		ds_razao,
	'' 		ds_nome,
	'' 		insc_estadual,
	'' 		junta_comercial,
	'' 		endereco,
	'' 		numero,
	'' 		complemento,
	'' 		bairro,
	'' 		cidade,
	'' 		uf,
	'' 		cep,
	'' 		ddd,
	''		fone,
	''		fax,
	''		email,
	n.cd_estabelecimento cd_estabelecimento,
	null 		dt_emissao,
	null		dt_emissao_nota,
	' '		ie_grafica,
	'0'		nr_cmc_prest,
	' ' 		cnpj_prest,
	'0'		nr_nota_fiscal,
	' ' 		cd_serie_nf,
	' ' 		ie_situacao,
	'00000000000' 	cnae,
	'0'		vl_contabil_total,
	'0'		base_calculo_total,
	'0'		aliquota_iss,
	'0'		vl_iss,
	' '		ds_observacao,
	'0'		cfps,
	'0'		cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	' '		nr_nota_ini,
	' '		nr_nota_fim
FROM	estabelecimento n

union ALL

select	2		tp_registro,
	'C' 		ds_registro,
	'' 		versao_sefinnet,
	Lpad(substr(j.nr_inscricao_municipal,1,7),7,'0')	nr_cmc,
	Rpad(substr(j.cd_cgc,1,14),14,' ') 			cnpj,
	Rpad(substr(j.ds_razao_social,1,80),80,' ') 		ds_razao,
	Rpad(substr(j.nm_fantasia,1,50),50,' ') 		ds_nome,
	Rpad(substr(j.nr_inscricao_estadual,1,20),20,' ')	insc_estadual,
	'                    ' 					junta_comercial,
	Rpad(substr(j.ds_endereco,1,80),80,' ') 		endereco,
	Rpad(substr(j.nr_endereco,1,10),10,' ') 		numero,
	Rpad(substr(j.ds_complemento,1,30),30,' ') 		complemento,
	Rpad(substr(j.ds_bairro,1,50),50,' ') 			bairro,
	Rpad(substr(j.ds_municipio,1,50),50,' ') 		cidade,
	Rpad(substr(j.sg_estado,1,2),2,' ') 			uf,
	Rpad(substr(j.cd_cep,1,8),8,' ') 			cep,
	Rpad(substr(j.nr_ddd_telefone,1,2),2,' ') 		ddd,
	Rpad(substr(j.nr_telefone,1,8),8,' ') 			fone,
	Rpad(substr(j.nr_fax,1,8),8,' ') 			fax,
	Rpad(substr(j.ds_email,1,80),80,' ') 			email,
	a.cd_estabelecimento 					cd_estabelecimento,
	null 		dt_emissao,
	null		dt_emissao_nota,
	' '		ie_grafica,
	'0'		nr_cmc_prest,
	' ' 		cnpj_prest,
	'0'		nr_nota_fiscal,
	' ' 		cd_serie_nf,
	' ' 		ie_situacao,
	'00000000000' 	cnae,
	'0'		vl_contabil_total,
	'0'		base_calculo_total,
	'0'		aliquota_iss,
	'0'		vl_iss,
	' '		ds_observacao,
	'0'		cfps,
	'0'		cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	' '		nr_nota_ini,
	' '		nr_nota_fim
from 	estabelecimento a,
	pessoa_juridica j
where	a.cd_cgc = j.cd_cgc

union all

select	distinct 3	tp_registro,
	'P' 		ds_registro,
	'' 		versao_sefinnet,
	Lpad(substr(nr_inscricao_municipal,1,7),7,'0')		nr_cmc,
	Rpad(substr(cd_cgc,1,14),14,' ') 			cnpj,
	Rpad(substr(ds_razao_social,1,80),80,' ') 		ds_razao,
	Rpad(substr(nm_fantasia,1,50),50,' ') 			ds_nome,
	''							insc_estadual,
	''		 					junta_comercial,
	Rpad(substr(ds_endereco,1,80),80,' ') 			endereco,
	Rpad(substr(nr_endereco,1,10),10,' ') 			numero,
	Rpad(substr(ds_complemento,1,30),30,' ') 		complemento,
	Rpad(substr(ds_bairro,1,50),50,' ') 			bairro,
	Rpad(substr(ds_municipio,1,50),50,' ') 			cidade,
	Rpad(substr(sg_estado,1,2),2,' ') 			uf,
	Rpad(substr(cd_cep,1,8),8,' ') 				cep,
	Rpad(substr(nr_ddd_telefone,1,2),2,' ') 		ddd,
	''				 			fax,
	''				 			email,
	Rpad(substr(nr_telefone,1,8),8,' ') 			fone,
	cd_estabelecimento 					cd_estabelecimento,
	dt_emissao,
	NULL dt_emissao_nota,
	ie_grafica,
	'0'		nr_cmc_prest,
	' ' 		cnpj_prest,
	'0'		nr_nota_fiscal,
	' ' 		cd_serie_nf,
	' ' 		ie_situacao,
	'00000000000' 	cnae,
	'0'		vl_contabil_total,
	'0'		base_calculo_total,
	'0'		aliquota_iss,
	'0'		vl_iss,
	' '		ds_observacao,
	'0'		cfps,
	'0'		cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	' '		nr_nota_ini,
	' '		nr_nota_fim
from (
	select	distinct j.nr_inscricao_municipal,
		j.cd_cgc,
		j.ds_razao_social,
		j.nm_fantasia,
		j.ds_endereco,
		j.nr_endereco,
		j.ds_complemento,
		j.ds_bairro,
		j.cd_cep,
		j.ds_municipio,
		j.sg_estado,
		j.nr_ddd_telefone,
		j.nr_telefone,
		'0'	ie_grafica,
		n.dt_emissao,
		e.cd_estabelecimento
	from	nota_fiscal n,
		estabelecimento e,
		operacao_nota a,
		pessoa_juridica j
	where	a.cd_operacao_nf = n.cd_operacao_nf
	and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
	and	n.ie_situacao = '1'
	and	n.cd_cgc_emitente = e.cd_cgc
	and	n.dt_atualizacao_estoque is not null
	and	a.ie_servico = 'S'
	and	n.cd_cgc = j.cd_cgc
	
union all

	select	distinct j.nr_inscricao_municipal,
		j.cd_cgc,
		j.ds_razao_social,
		j.nm_fantasia,
		j.ds_endereco,
		j.nr_endereco,
		j.ds_complemento,
		j.ds_bairro,
		j.cd_cep,
		j.ds_municipio,
		j.sg_estado,
		j.nr_ddd_telefone,
		j.nr_telefone,
		'0'	ie_grafica,
		to_date('01/01/2000') dt_emissao,
		a.cd_estabelecimento
	from 	estabelecimento a,
		pessoa_juridica j
	where	a.cd_cgc = j.cd_cgc
	
union all

	select	distinct j.nr_inscricao_municipal,
		j.cd_cgc,
		j.ds_razao_social,
		j.nm_fantasia,
		j.ds_endereco,
		j.nr_endereco,
		j.ds_complemento,
		j.ds_bairro,
		j.cd_cep,
		j.ds_municipio,
		j.sg_estado,
		j.nr_ddd_telefone,
		j.nr_telefone,
		'1' ie_grafica,
		n.dt_emissao,
		e.cd_estabelecimento
	from	nota_fiscal n,
		estabelecimento e,
		operacao_nota a,
		pessoa_juridica j,
		nota_fiscal_aidf i
	where	a.cd_operacao_nf = n.cd_operacao_nf
	and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
	and	n.ie_situacao = '1'
	and	n.cd_cgc_emitente = e.cd_cgc
	and	n.dt_atualizacao_estoque is not null
	and	a.ie_servico = 'S'
	and	n.cd_serie_nf = i.cd_serie_nf
	and	(n.nr_nota_fiscal)::numeric  between i.nr_nota_ini and i.nr_nota_fim
	and	i.cnpj_grafica = j.cd_cgc
	
union all

	select	distinct '9999999' nr_inscricao_municipal,
		p.nr_cpf  cd_cgc,
		p.nm_pessoa_fisica ds_razao_social,
		p.nm_pessoa_fisica nm_fantasia,
		j.ds_endereco,
		to_char(j.nr_endereco) nr_endereco,
		j.ds_complemento,
		j.ds_bairro,
		j.cd_cep,
		j.ds_municipio,
		j.sg_estado,
		j.nr_ddd_telefone,
		j.nr_telefone,
		'0'	ie_grafica,
		n.dt_emissao,
		e.cd_estabelecimento
	from	nota_fiscal n,
		estabelecimento e,
		operacao_nota a,
		pessoa_fisica p,
		compl_pessoa_fisica j
	where	a.cd_operacao_nf = n.cd_operacao_nf
	and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
	and	n.ie_situacao = '1'
	and	n.cd_cgc_emitente = e.cd_cgc
	and	n.dt_atualizacao_estoque is not null
	and	a.ie_servico = 'S'
	and	p.cd_pessoa_fisica = n.cd_pessoa_fisica
	and	p.cd_pessoa_fisica = j.cd_pessoa_fisica
	and	j.ie_tipo_complemento = 1
	) alias67

union all

select	distinct 4		tp_registro,
	'T'		ds_registro,
	'3.00.0001'	versao_sefinnet,
	Lpad(substr(j.nr_inscricao_municipal,1,7),7,'0')	nr_cmc,
	Rpad(substr(j.cd_cgc,1,14),14,' ') 			cnpj,
	'' 		ds_razao,
	'' 		ds_nome,
	'' 		insc_estadual,
	'' 		junta_comercial,
	'' 		endereco,
	'' 		numero,
	'' 		complemento,
	'' 		bairro,
	'' 		cidade,
	'' 		uf,
	'' 		cep,
	'' 		ddd,
	''		fone,
	''		fax,
	''		email,
	n.cd_estabelecimento cd_estabelecimento,
	n.dt_emissao	dt_emissao,
	null		dt_emissao_nota,
	' '		ie_grafica,
	'0'		nr_cmc_prest,
	' ' 		cnpj_prest,
	'0'		nr_nota_fiscal,
	Rpad(substr(i.cd_serie_nf,1,10),10,' ') cd_serie_nf,
	' ' 		ie_situacao,
	'00000000000' 	cnae,
	'0'		vl_contabil_total,
	'0'		base_calculo_total,
	'0'		aliquota_iss,
	'0'		vl_iss,
	' '		ds_observacao,
	'0'		cfps,
	'0'		cst,
	i.cnpj_grafica,
	Lpad(substr(i.nr_aidf,1,40),40,'0') nr_aidf,
	Lpad(substr(i.nr_nota_ini,1,15),15,'0') nr_nota_ini,
	Lpad(substr(i.nr_nota_fim,1,15),15,'0') nr_nota_fim
from	nota_fiscal n,
	estabelecimento e,
	operacao_nota a,
	nota_fiscal_aidf i,
	pessoa_juridica j
where	a.cd_operacao_nf = n.cd_operacao_nf
and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
and	n.ie_situacao = '1'
and	n.cd_cgc_emitente = e.cd_cgc
and	n.dt_atualizacao_estoque is not null
and	a.ie_servico = 'S'
and	n.cd_serie_nf = i.cd_serie_nf
and	(n.nr_nota_fiscal)::numeric  between i.nr_nota_ini and i.nr_nota_fim
and	e.cd_cgc = j.cd_cgc

union all

select	5		tp_registro,
	'E'		ds_registro,
	' '		versao_sefinnet,
	Lpad(substr(j.nr_inscricao_municipal,1,7),7,'0')	nr_cmc,
	Rpad(substr(j.cd_cgc,1,14),14,' ') 			cnpj,
	'' 		ds_razao,
	'' 		ds_nome,
	'' 		insc_estadual,
	'' 		junta_comercial,
	'' 		endereco,
	'' 		numero,
	'' 		complemento,
	'' 		bairro,
	'' 		cidade,
	'' 		uf,
	'' 		cep,
	'' 		ddd,
	''		fone,
	''		fax,
	''		email,
	n.cd_estabelecimento cd_estabelecimento,
	n.dt_emissao,
	n.dt_emissao dt_emissao_nota,
	' '		ie_grafica,
	Lpad(substr(h.nr_inscricao_municipal,1,7),7,'0')	nr_cmc_prest,
	Rpad(substr(h.cd_cgc,1,14),14,' ') 			cnpj_prest,
	Lpad(substr(n.nr_nota_fiscal,1,15),15,'0')		nr_nota_fiscal,
	Rpad(substr(n.cd_serie_nf,1,10),10,' ') 		cd_serie_nf,
	CASE WHEN n.ie_situacao=1 THEN 'E'  ELSE 'C' END  ie_situacao,
	Lpad(substr(  coalesce(obter_cnae_florianopolis(n.cd_estabelecimento,n.nr_sequencia),obter_dados_cnae(j.nr_seq_cnae,'ID'))  ,1, 11),11,'00000000000') cnae,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(coalesce(n.vl_mercadoria,0),2)),1,18),18,'0') vl_contabil_total,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(Sum(x.vl_base_calculo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') base_calculo_total,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(max(x.tx_tributo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') aliquota_iss,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(sum(x.vl_tributo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	n.nr_sequencia = x.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') vl_iss,
	Rpad(substr(n.ds_observacao,1,100),100,' ') ds_observacao,
	obter_cfps_municipio(n.cd_estabelecimento,n.cd_cgc_emitente,n.cd_pessoa_fisica,'FLORIANOPOLIS') cfps,
	lpad(substr(
		(select	max(s.cd_situacao)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),1,3),3,'0') cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	Lpad(substr(i.nr_nota_ini,1,15),15,'0') nr_nota_ini,
	' '		nr_nota_fim
from	nota_fiscal_item_trib x,
	nota_fiscal n,
	tributo t,
	estabelecimento e,
	situacao_trib_prest_serv s,
	operacao_nota a,
	pessoa_juridica j,
	pessoa_juridica h,
	nota_fiscal_aidf i
where	x.nr_sequencia = n.nr_sequencia
and	x.cd_tributo    = t.cd_tributo
and	a.cd_operacao_nf = n.cd_operacao_nf
and	t.ie_tipo_tributo = 'ISS'
and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
and	n.cd_cgc_emitente = e.cd_cgc
and	x.nr_seq_sit_trib = s.nr_sequencia
and	n.dt_atualizacao_estoque is not null
and	a.ie_servico = 'S'
and	j.cd_cgc = e.cd_cgc
and	h.cd_cgc = n.cd_cgc
and	n.cd_serie_nf = i.cd_serie_nf
and	(n.nr_nota_fiscal)::numeric  between i.nr_nota_ini and i.nr_nota_fim

union all

select	6		tp_registro,
	'F'		ds_registro,
	'3.00.0001'	versao_sefinnet,
	Lpad(substr(j.nr_inscricao_municipal,1,7),7,'0')	nr_cmc,
	Rpad(substr(j.cd_cgc,1,14),14,' ') 			cnpj,
	'' 		ds_razao,
	'' 		ds_nome,
	'' 		insc_estadual,
	'' 		junta_comercial,
	'' 		endereco,
	'' 		numero,
	'' 		complemento,
	'' 		bairro,
	'' 		cidade,
	'' 		uf,
	'' 		cep,
	'' 		ddd,
	''		fone,
	''		fax,
	''		email,
	n.cd_estabelecimento cd_estabelecimento,
	n.dt_emissao,
	n.dt_emissao dt_emissao_nota,
	' '		ie_grafica,
	'0'		nr_cmc_prest,
	' '		cnpj_prest,
	Lpad(substr(n.nr_nota_fiscal,1,15),15,'0')		nr_nota_fiscal,
	Rpad(substr(n.cd_serie_nf,1,10),10,' ') 		cd_serie_nf,
	CASE WHEN n.ie_situacao=1 THEN 'E'  ELSE 'C' END  ie_situacao,
	Lpad(substr(  coalesce(obter_cnae_florianopolis(n.cd_estabelecimento,n.nr_sequencia),obter_dados_cnae(j.nr_seq_cnae,'ID'))  ,1, 11),11,'00000000000') cnae,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(coalesce(n.vl_mercadoria,0),2)),1,18),18,'0') vl_contabil_total,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(Sum(x.vl_base_calculo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') base_calculo_total,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(max(x.tx_tributo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') aliquota_iss,
	Lpad(substr(elimina_caracteres_especiais(campo_mascara(
		(select	coalesce(sum(x.vl_tributo),0)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	n.nr_sequencia = x.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),2)),1,18),18,'0') vl_iss,
	Rpad(substr(n.ds_observacao,1,100),100,' ') ds_observacao,
	obter_cfps_municipio(n.cd_estabelecimento,n.cd_cgc_emitente,n.cd_pessoa_fisica,'FLORIANOPOLIS') cfps,
	lpad(substr(
		(select	max(s.cd_situacao)
		from	nota_fiscal_item_trib x,
			tributo t,
			situacao_trib_prest_serv s
		where	x.nr_sequencia = n.nr_sequencia
		and	x.cd_tributo    = t.cd_tributo
		and	x.nr_seq_sit_trib = s.nr_sequencia
		and	t.ie_tipo_tributo = 'ISS'),1,3),3,'0') cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	Lpad(substr(i.nr_nota_ini,1,15),15,'0') nr_nota_ini,
	Lpad(substr(i.nr_nota_fim,1,15),15,'0') nr_nota_fim
from	nota_fiscal_item_trib x,
	nota_fiscal n,
	tributo t,
	estabelecimento e,
	situacao_trib_prest_serv s,
	operacao_nota a,
	pessoa_juridica j,
	nota_fiscal_aidf i
where	x.nr_sequencia = n.nr_sequencia
and	x.cd_tributo    = t.cd_tributo
and	a.cd_operacao_nf = n.cd_operacao_nf
and	t.ie_tipo_tributo = 'ISS'
and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S'
and	n.ie_situacao = '1'
and	n.cd_cgc_emitente = e.cd_cgc
and	x.nr_seq_sit_trib = s.nr_sequencia
and	n.dt_atualizacao_estoque is not null
and	a.ie_servico = 'S'
and	j.cd_cgc = e.cd_cgc
and	n.cd_pessoa_fisica is not null
and	n.cd_serie_nf = i.cd_serie_nf
and	(n.nr_nota_fiscal)::numeric  between i.nr_nota_ini and i.nr_nota_fim

union ALL

select	99		tp_registro,
	'L' 		ds_registro,
	'' 		versao_sefinnet,
	'0'		nr_cmc,
	' '		cnpj,
	' ' 		ds_razao,
	' ' 		ds_nome,
	' '		insc_estadual,
	'                    '	junta_comercial,
	' ' 		endereco,
	' ' 		numero,
	' ' 		complemento,
	' ' 		bairro,
	' ' 		cidade,
	' ' 		uf,
	' ' 		cep,
	' ' 		ddd,
	' ' 		fone,
	' ' 		fax,
	' ' 		email,
	a.cd_estabelecimento	cd_estabelecimento,
	null 		dt_emissao,
	null 		dt_emissao_nota,
	' '		ie_grafica,
	'0'		nr_cmc_prest,
	' ' 		cnpj_prest,
	'0'		nr_nota_fiscal,
	' ' 		cd_serie_nf,
	' ' 		ie_situacao,
	'00000000000' 	cnae,
	'0'		vl_contabil_total,
	'0'		base_calculo_total,
	'0'		aliquota_iss,
	'0'		vl_iss,
	' '		ds_observacao,
	'0'		cfps,
	'0'		cst,
	' '		cnpj_grafica,
	' '		nr_aidf,
	' '		nr_nota_ini,
	' '		nr_nota_fim
from 	estabelecimento a,
	pessoa_juridica j
where	a.cd_cgc = j.cd_cgc
ORDER BY tp_registro desc;

