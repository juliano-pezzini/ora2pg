-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_producao_consulta_v (ie_interno_externo, ie_avaliacao_final, cd_estabelecimento, nr_sangue, ds_derivado, sg_sigla, nm_pessoa_fisica, ie_tipo_sangue, ie_fator_rh, ds_tipo_doacao, nr_seq_doacao, dt_doacao, nr_bolsa, nr_sequencia, dt_producao, dt_vencimento, nm_usuario, dt_atualizacao, nr_seq_transfusao, nr_seq_inutil, nr_seq_emp_saida, nr_seq_propaci, cd_pf_realizou, ie_irradiado, ie_lavado, ie_filtrado, ie_aliquotado, nr_seq_derivado, nr_sec_saude, nm_usuario_lib, dt_liberacao, qt_volume, qt_vol_transf, nr_seq_reserva, dt_emprestimo, nr_seq_apresent, cd_barras, dt_inicio, dt_fim, dt_utilizacao, nr_transfusao_controle, ie_aferese, dt_fim_producao, dt_recebimento, dt_liberacao_bolsa, nr_seq_emp_ent, dt_inicio_prod_emprestimo, dt_fim_prod_emprestimo, qt_volume_apos_filtragem, qt_peso_apos_filtragem, dt_validade_apos_filtragem, ie_classif_doacao, nm_usuario_conferencia, dt_conferencia_prod, ie_pai_reproduzido, ie_realiza_nat, dt_fim_prod_doacao, ie_bloqueio, cd_doador, ds_iniciais_doador, cd_estab_atual, cd_estab_producao, ie_encaminhado, nr_seq_tipo, nr_lote_bolsa, qt_dias_ant_validade, ie_tipo_derivado, qt_dias_validade, nr_seq_derivado_origem, dt_coleta, cd_isbt, dt_liberacao_direc, nm_usuario_direc, nr_seq_entidade, dt_reintegracao, qt_unidade_derivado, cd_pf_destino, nr_seq_isbt) AS SELECT	CASE WHEN g.nr_sequencia IS NULL THEN  'I'  ELSE 'R' END  ie_interno_externo,
	a.ie_avaliacao_final,
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.sg_sigla,
	b.nm_pessoa_fisica,
	b.ie_tipo_sangue,
	b.ie_fator_rh,
	c.ds_tipo_doacao,
	a.nr_sequencia nr_seq_doacao,
	a.dt_doacao,
	a.nr_bolsa,
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	CASE WHEN g.nr_sequencia IS NULL THEN  d.nr_seq_emp_saida  ELSE null END  nr_seq_emp_saida,
	d.nr_seq_propaci,
	d.cd_pf_realizou,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	NULL dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.nr_transfusao_controle,
	d.ie_aferese,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_liberacao dt_liberacao_bolsa,
	d.nr_seq_emp_ent,
	d.dt_inicio_prod_emprestimo,
	d.dt_fim_prod_emprestimo,
	d.qt_volume_apos_filtragem,
	d.qt_peso_apos_filtragem,
	d.dt_validade_apos_filtragem,
	c.ie_classif_doacao,
	d.nm_usuario_conferencia,
	d.dt_conferencia dt_conferencia_prod,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	a.ie_realiza_nat,
	a.dt_fim_prod_doacao,
	coalesce(SUBSTR(san_obter_se_hemo_bloqueado(d.nr_sequencia),1,1),'N') ie_bloqueio,
	a.cd_pessoa_fisica cd_doador,
	SUBSTR(obter_iniciais_nome(a.cd_pessoa_fisica, NULL),1,10) ds_iniciais_doador,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	a.nr_seq_tipo,
	a.nr_lote_bolsa nr_lote_bolsa,
	e.qt_dias_ant_validade,
	e.ie_tipo_derivado,
	e.qt_dias_validade,
	d.nr_seq_derivado_origem,
	a.dt_coleta,
	c.cd_isbt,
	d.dt_liberacao_direc,
	d.nm_usuario_direc,
	null nr_seq_entidade,
	g.dt_reintegracao,
	d.qt_unidade_derivado,
	i.cd_pf_destino,
	san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_tipo_doacao c, pessoa_fisica b, san_doacao a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
LEFT OUTER JOIN san_derivado_reintegrado g ON (d.nr_sequencia = g.nr_seq_producao)
LEFT OUTER JOIN san_emprestimo i ON (d.nr_seq_emp_saida = i.nr_sequencia)
WHERE a.cd_pessoa_fisica	= b.cd_pessoa_fisica AND a.nr_seq_tipo		= c.nr_sequencia AND a.nr_sequencia		= d.nr_seq_doacao AND d.nr_seq_derivado	= e.nr_sequencia    and (i.dt_emprestimo 	< g.dt_reintegracao
    or g.dt_reintegracao is null) AND d.nr_seq_emp_ent IS NULL

UNION

SELECT	'E' ie_interno_externo,
	'A',
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.sg_sigla,
	b.ds_entidade,
	d.ie_tipo_sangue,
	d.ie_fator_rh,
	wheb_mensagem_pck.get_Texto(1125870),--'Emprestimo',
	a.nr_sequencia,
	d.dt_producao,
	d.nr_bolsa,
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	d.nr_seq_emp_saida,
	d.nr_seq_propaci,
	d.cd_pf_realizou,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	a.dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.nr_transfusao_controle,
	d.ie_aferese,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_emprestimo dt_liberacao_bolsa,
	d.nr_seq_emp_ent,
	d.dt_inicio_prod_emprestimo,
	d.dt_fim_prod_emprestimo,
	d.qt_volume_apos_filtragem,
	d.qt_peso_apos_filtragem,
	d.dt_validade_apos_filtragem,
	NULL ie_classif_doacao,
	d.nm_usuario_conferencia,
	d.dt_conferencia dt_conferencia_prod,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	NULL ie_realiza_nat,
	NULL dt_fim_prod_doacao,
	coalesce(SUBSTR(san_obter_se_hemo_bloqueado(d.nr_sequencia),1,1),'N') ie_bloqueio,
	NULL cd_doador,
	SUBSTR(obter_iniciais_nome(NULL, d.nm_doador),1,10) ds_iniciais_doador,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	NULL nr_seq_tipo,
	NULL nr_lote_bolsa,
	e.qt_dias_ant_validade,
	e.ie_tipo_derivado,
	e.qt_dias_validade,
	d.nr_seq_derivado_origem,
	NULL,
	NULL,
	d.dt_liberacao_direc,
	d.nm_usuario_direc,
	b.nr_sequencia nr_seq_entidade,
	null dt_reintegracao,
	d.qt_unidade_derivado,
	a.cd_pf_destino,
	san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_entidade b, san_emprestimo a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_derivado	= e.nr_sequencia AND d.nr_seq_emp_ent	= a.nr_sequencia AND a.nr_seq_entidade	= b.nr_sequencia  
UNION

SELECT	'A' ie_interno_externo,
	'A',
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.sg_sigla,
	'Agrupamento',
	d.ie_tipo_sangue,
	d.ie_fator_rh,
	'Agrupamento',
	a.nr_sequencia nr_seq_agrupamento,
	d.dt_producao,
	d.nr_bolsa,
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	d.nr_seq_emp_saida,
	d.nr_seq_propaci,
	d.cd_pf_realizou,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	NULL dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.nr_transfusao_controle,
	d.ie_aferese,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_liberacao dt_liberacao_bolsa,
	d.nr_seq_emp_ent,
	d.dt_inicio_prod_emprestimo,
	d.dt_fim_prod_emprestimo,
	d.qt_volume_apos_filtragem,
	d.qt_peso_apos_filtragem,
	d.dt_validade_apos_filtragem,
	NULL ie_classif_doacao,
	d.nm_usuario_conferencia,
	d.dt_conferencia dt_conferencia_prod,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	NULL ie_realiza_nat,
	NULL dt_fim_prod_doacao,
	coalesce(SUBSTR(san_obter_se_hemo_bloqueado(d.nr_sequencia),1,1),'N') ie_bloqueio,
	NULL cd_doador,
	SUBSTR(obter_iniciais_nome(NULL, d.nm_doador),1,10) ds_iniciais_doador,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	NULL nr_seq_tipo,
	NULL nr_lote_bolsa,
	e.qt_dias_ant_validade,
	e.ie_tipo_derivado,
	e.qt_dias_validade,
	d.nr_seq_derivado_origem,
	NULL,
	NULL,
	d.dt_liberacao_direc,
	d.nm_usuario_direc,
	null nr_seq_entidade,
	null dt_reintegracao,
	d.qt_unidade_derivado,
	i.cd_pf_destino,
	san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_agrupamento a, san_producao d
LEFT OUTER JOIN san_emprestimo i ON (d.nr_seq_emp_saida = i.nr_sequencia)
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_derivado	= e.nr_sequencia AND a.nr_sequencia		= d.nr_seq_agrupamento;

