-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cih_infeccao_alta_v (dt_alta_interno, dt_mes_alta, nr_alta_ih, nr_alta_ic, nr_alta_outra, nr_alta, cd_clinica, cd_estabelecimento) AS select a.dt_alta_interno,
       trunc(a.dt_alta_interno,'MONTH') dt_mes_alta,
       count(distinct a.nr_ficha_ocorrencia) nr_alta_ih,
       0 nr_alta_ic,
       0 nr_alta_outra,
	 0 nr_alta,
	a.cd_clinica,
	a.cd_estabelecimento
FROM cih_infeccao_v b,
     cih_ficha_ocorrencia_v a
where a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia
  and b.nr_ih > 0
group by a.dt_alta_interno, trunc(a.dt_alta_interno,'MONTH'),a.cd_clinica, a.cd_estabelecimento

union

select a.dt_alta_interno,
       trunc(a.dt_alta_interno,'MONTH'),
       0,
       count(distinct a.nr_ficha_ocorrencia),
       0,
	 0,
	a.cd_clinica,
	a.cd_estabelecimento
from cih_infeccao_v b,
     cih_ficha_ocorrencia_v a
where a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia
  and b.nr_ic > 0
group by a.dt_alta_interno, trunc(a.dt_alta_interno,'MONTH'),a.cd_clinica, a.cd_estabelecimento

union

select a.dt_alta_interno,
       trunc(a.dt_alta_interno,'MONTH'),
       0,
       0,
       count(distinct a.nr_ficha_ocorrencia),
	 0,
	a.cd_clinica,
	a.cd_estabelecimento
from cih_infeccao_v b,
     cih_ficha_ocorrencia_v a
where a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia
  and b.nr_outras > 0
group by a.dt_alta_interno, trunc(a.dt_alta_interno,'MONTH'),a.cd_clinica, a.cd_estabelecimento

union

select a.dt_alta_interno,
       trunc(a.dt_alta_interno,'MONTH'),
       0,
       0,
	 0,
	 count(*),
	a.cd_clinica,
	a.cd_estabelecimento
from cih_ficha_ocorrencia_v a
where not exists (select b.nr_ficha_ocorrencia from cih_infeccao_v b
			where b.nr_ficha_ocorrencia = a.nr_ficha_ocorrencia
			  and ((b.nr_ih > 0) or (b.nr_ic > 0)))
group by a.dt_alta_interno, trunc(a.dt_alta_interno,'MONTH'),a.cd_clinica, a.cd_estabelecimento;

