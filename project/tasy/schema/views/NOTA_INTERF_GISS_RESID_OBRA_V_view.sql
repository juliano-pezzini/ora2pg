-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_interf_giss_resid_obra_v (nr_nota_fiscal, cd_serie_nf, dt_emissao, ie_situacao, vl_total_nota, ie_pf_pj, ie_prestador_municipio, ds_razao_social, nr_inscricao_municipal, cd_cpf_cnpj, ie_prestador_isento, nr_inscricao_estadual, cd_cep, ds_tipo_logradouro, ds_titulo_logradouro, ds_endereco, ds_complemento, nr_endereco, ds_bairro, sg_estado, ds_municipio, ds_local_prest_servico, cd_estabelecimento, cd_operacao_nf, vl_base_calculo, cd_atividade_serv) AS select	a.nr_nota_fiscal,
	substr(rpad(a.cd_serie_nf,10,'.'),1,10) cd_serie_nf, 
	a.dt_emissao, 
	CASE WHEN a.ie_situacao=1 THEN  1 WHEN a.ie_situacao=2 THEN  3 WHEN a.ie_situacao=3 THEN  3 WHEN a.ie_situacao=9 THEN  3 END  ie_situacao, 
	a.vl_mercadoria vl_total_nota, 
	CASE WHEN coalesce(a.cd_pessoa_fisica,'0')='0' THEN '2'  ELSE '1' END  ie_pf_pj, 
	'S' ie_prestador_municipio, 
	CASE WHEN coalesce(a.cd_pessoa_fisica,'0')='0' THEN  		substr(obter_nome_pf_pj(null, a.cd_cgc),1,80)  ELSE substr(obter_nome_pf_pj(a.cd_pessoa_fisica, null),1,80) END  ds_razao_social, 
	somente_numero(coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'IM'),1,20), '00000000000000000000')) nr_inscricao_municipal, 
	CASE WHEN a.cd_cgc IS NULL THEN  coalesce(lpad(somente_numero( 		substr(obter_dados_pf(a.cd_pessoa_fisica, 'CPF'),1,11)),14,0),'00000000000')  ELSE lpad(a.cd_cgc,14,'0') END  cd_cpf_cnpj, 
	'S' ie_prestador_isento, 
	somente_numero(coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'IE'),1,20), '00000000000000000000')) nr_inscricao_estadual, 
	substr(somente_numero(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CEP')),1,8) cd_cep, 
	'Rua' ds_tipo_logradouro, 
	' ' ds_titulo_logradouro, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'EN'),1,50) ds_endereco, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CO'),1,40) ds_complemento, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'NR'),1,10) nr_endereco, 
	coalesce(substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'B'),1,50),'Bairro') ds_bairro, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'UF'),1,2) sg_estado, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CI'),1,50) ds_municipio, 
	'D' ds_local_prest_servico, 
	a.cd_estabelecimento, 
	a.cd_operacao_nf, 
	a.vl_total_nota vl_base_calculo, 
	substr(obter_dados_pf_pj_estab(a.cd_estabelecimento, a.cd_pessoa_fisica, a.cd_cgc, 'ATIV'),1,5) cd_atividade_serv 
FROM	nota_fiscal a 
where (substr(obter_se_nota_entrada_saida(a.nr_sequencia),1,1) = 'E');

