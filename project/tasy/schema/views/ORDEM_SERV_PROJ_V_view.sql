-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ordem_serv_proj_v (qt_ordens_abertas, qt_ordens_processo, qt_ordens_cliente, qt_ordens_encerradas, dt_mes, dt_mes_order, nr_seq_proj) AS select	sum(qt_ordens_abertas) + sum(qt_ordens_cliente) + sum(qt_ordens_encerradas) qt_ordens_abertas,
	sum(qt_ordens_abertas) qt_ordens_processo, 
	sum(qt_ordens_cliente) qt_ordens_cliente, 
	sum(qt_ordens_encerradas) qt_ordens_encerradas, 
	coalesce(to_char(dt_mes,'dd/mm/yyyy'),'Demais meses') dt_mes, 
	dt_mes dt_mes_order, nr_seq_proj 
FROM (	select	0 qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		sum(qt_ordens) qt_ordens_encerradas, 
		null dt_mes, 
		nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_fim_real,'month') dt_fim_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 3 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		group by	d.nr_seq_proj, trunc(a.dt_fim_real,'month')) x 
	where	trunc(x.dt_fim_real) < add_months(trunc(LOCALTIMESTAMP,'month'),-5) 
	group by nr_seq_proj 
	
UNION ALL
 
	select	0 qt_ordens_abertas, 
		sum(qt_ordens) qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		null dt_mes, nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_inicio_real,'month') dt_inicio_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		and	a.nr_seq_estagio in (select  nr_seq_proj               
			from   man_estagio_processo              
			where  ie_acao = 2) 
		group by	d.nr_seq_proj, trunc(a.dt_inicio_real,'month')) x 
	where	trunc(x.dt_inicio_real) < add_months(trunc(LOCALTIMESTAMP,'month'),-5) 
	group by nr_seq_proj 
	
UNION ALL
 
	select	sum(qt_ordens) qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		null dt_mes, nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_inicio_real,'month') dt_inicio_real, 
			d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		and	a.nr_seq_estagio in (select  nr_seq_proj               
			from   man_estagio_processo              
			where  ie_acao = 3) 
		group by	d.nr_seq_proj, trunc(a.dt_inicio_real,'month')) x 
	where	trunc(x.dt_inicio_real) < add_months(trunc(LOCALTIMESTAMP,'month'),-5) 
	group by nr_seq_proj 
	
UNION ALL
 
	select	0 qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		sum(qt_ordens) qt_ordens_encerradas, 
		trunc(x.dt_fim_real,'month'), 
		nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_fim_real,'month') dt_fim_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 3 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		group by	trunc(a.dt_fim_real,'month'),d.nr_seq_proj) x 
	where	trunc(x.dt_fim_real) between add_months(trunc(LOCALTIMESTAMP,'month'),-5) and trunc(LOCALTIMESTAMP,'month') 
	group by	trunc(x.dt_fim_real,'month'), nr_seq_proj 
	
UNION ALL
 
	select	0 qt_ordens_abertas, 
		sum(qt_ordens) qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		trunc(x.dt_inicio_real,'month'), 
		nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_inicio_real,'month') dt_inicio_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		and	a.nr_seq_estagio in (select  nr_seq_proj               
			from   man_estagio_processo              
			where  ie_acao = 2) 
		group by	d.nr_seq_proj, trunc(a.dt_inicio_real,'month')) x 
	where	trunc(x.dt_inicio_real) between add_months(trunc(LOCALTIMESTAMP,'month'),-5) and trunc(LOCALTIMESTAMP,'month') 
	group by	trunc(x.dt_inicio_real,'month'), nr_seq_proj 
	
UNION ALL
 
	select	sum(qt_ordens) qt_ordens_abertas, 
		0 qt_ordens_cliente, 
		0 qt_ordens_encerradas, 
		trunc(x.dt_inicio_real,'month'), 
		nr_seq_proj 
	from (select	count(*) qt_ordens, 
			trunc(a.dt_inicio_real,'month') dt_inicio_real,d.nr_seq_proj 
		FROM	man_ordem_servico_v a, 
			proj_ordem_servico d 
		WHERE	a.nr_Sequencia = d.nr_seq_ordem 
		AND	a.ie_status_ordem = 2 
		and	exists (select 1 from proj_ordem_servico x 
			where x.NR_SEQ_PROJ = d.nr_seq_proj 
			and x.NR_SEQ_ORDEM = a.nr_sequencia) 
		and	a.nr_seq_estagio in (select  nr_seq_proj               
			from   man_estagio_processo              
			where  ie_acao = 3) 
		group by	d.nr_seq_proj, trunc(a.dt_inicio_real,'month')) x 
	where	trunc(x.dt_inicio_real) between add_months(trunc(LOCALTIMESTAMP,'month'),-5) and trunc(LOCALTIMESTAMP,'month') 
	group by	trunc(x.dt_inicio_real,'month'), nr_seq_proj) alias75 
group by	dt_mes, nr_seq_proj;

