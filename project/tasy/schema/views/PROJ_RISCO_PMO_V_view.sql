-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW proj_risco_pmo_v (limit, dt_prox_hist, dt_prox_hist_proj, ds_folowup_status, nr_sequencia) AS with limits as (
 select 1 cod, substr(obter_valor_dominio_idioma(1906,1,5),1,254) risk, 90 limit
union

 select 5 cod, substr(obter_valor_dominio_idioma(1906,5,5),1,254) risk, 60 limit  
union

 select 8 cod, substr(obter_valor_dominio_idioma(1906,8,5),1,254) risk, 30 limit  
union

 select 9 cod, substr(obter_valor_dominio_idioma(1906,9,5),1,254) risk, 30 limit ),
 limits_proj as (
 select 1 cod, substr(obter_valor_dominio_idioma(1906,1,5),1,254) risk, 30 limit  
union

 select 5 cod, substr(obter_valor_dominio_idioma(1906,5,5),1,254) risk, 15 limit  
union

 select 8 cod, substr(obter_valor_dominio_idioma(1906,8,5),1,254) risk, 7 limit  
union

 select 9 cod, substr(obter_valor_dominio_idioma(1906,9,5),1,254) risk, 7 limit ),
last_hist as (
 select max(dt_liberacao) dt_liberacao, nr_seq_risco from proj_risco_hist group by nr_seq_risco)
select l.limit,
       case when lh.dt_liberacao is null then a.dt_registro + l.limit
       else lh.dt_liberacao + l.limit end dt_prox_hist,
       case when lh.dt_liberacao is null then a.dt_registro + lp.limit
       else lh.dt_liberacao + lp.limit end dt_prox_hist_proj,
       case when lh.dt_liberacao is null and (a.dt_registro + l.limit) < LOCALTIMESTAMP then 'RED'
       when lh.dt_liberacao is not null and (lh.dt_liberacao + l.limit) < LOCALTIMESTAMP then 'RED'
       when lh.dt_liberacao is not null and (lh.dt_liberacao + l.limit) between LOCALTIMESTAMP and LOCALTIMESTAMP + interval '7 days' then 'YELLOW'
       when lh.dt_liberacao is not null and (lh.dt_liberacao + l.limit) > LOCALTIMESTAMP + interval '7 days' then 'GREEN' end ds_folowup_status,
       nr_sequencia
FROM proj_risco_implantacao a
LEFT OUTER JOIN limits l ON (a.ie_grau_risco = l.cod)
LEFT OUTER JOIN limits_proj lp ON (a.ie_grau_risco = lp.cod)
LEFT OUTER JOIN last_hist lh ON (a.nr_sequencia = lh.nr_seq_risco);

