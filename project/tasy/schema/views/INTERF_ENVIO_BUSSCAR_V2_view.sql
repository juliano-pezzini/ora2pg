-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_envio_busscar_v2 (tp_registro, ds_constante, ie_registro, cd_atendente, cd_cnpj_hospital, nr_seq_protocolo, nr_nota_fiscal, nr_serie_nf, nr_interno_conta, cd_empresa, cd_cnpj_convenio, cd_usuario_convenio, nm_funcionario, nm_paciente, ie_servico_prestado, cd_tipo_plano, tp_atendimento, cd_procedimento, ds_procedimento, ie_acidente_trabalho, ie_internado, ie_cirurgia, dt_atendimento, dt_pagamento, vl_procedimento, vl_adicional) AS select 	1				tp_registro,
	lpad(' ',204,' ')		ds_constante,
	'1'				ie_registro,
	lpad(substr(a.cd_convenio,1,5),5,'0') cd_atendente,
	a.cd_cgc_hospital		cd_cnpj_hospital,
	a.nr_seq_protocolo		nr_seq_protocolo,
	0				nr_nota_fiscal,
	' '				nr_serie_nf,
	0				nr_interno_conta,
	lpad(substr(a.cd_regional,1,3),3,'0')	cd_empresa,
	a.cd_cgc_convenio		cd_cnpj_convenio,
	' '				 cd_usuario_convenio,
	' '				nm_funcionario,
	' '				nm_paciente,
	0				ie_servico_prestado,
	' '				cd_tipo_plano,
	0 				tp_atendimento,
	' '				cd_procedimento,
	' '				ds_procedimento,
	' '				ie_acidente_trabalho,
	' ' 				ie_internado,
	' '				ie_cirurgia,
	LOCALTIMESTAMP				dt_atendimento,
	LOCALTIMESTAMP				dt_pagamento,
	0				vl_procedimento,
	0				vl_adicional
FROM 	w_interf_conta_header	a

union all

select 	2				tp_registro,
	' '				ds_constante,
	'2'				ie_registro,
	/*lpad(substr(c.cd_convenio,1,5),5,'0') cd_atendente,*/

	'00000'				cd_atendente,
	c.cd_cgc_hospital		cd_cnpj_hospital,
	c.nr_seq_protocolo		nr_seq_protocolo,
	0				nr_nota_fiscal,
	' '				nr_serie_nf,
	c.nr_interno_conta		nr_interno_conta,
	/*lpad(substr(h.cd_regional,1,3),3,'0') cd_empresa,*/

	'000'				cd_empresa,
	c.cd_cgc_convenio		cd_cnpj_convenio,
	substr(c.cd_usuario_convenio,1,13) cd_usuario_convenio,
	lpad(' ',40, ' ')		nm_funcionario,
	substr(c.nm_paciente,1,40)	nm_paciente,
	CASE WHEN c.cd_dependente=1 THEN 1  ELSE 2 END 	ie_servico_prestado,
	lpad(c.cd_plano_convenio,2,'0') cd_tipo_plano,
	/*decode(c.ie_tipo_atendimento,3,5,1) tp_atendimento,*/

	CASE WHEN obter_dados_categ_conv(c.nr_atendimento,'CA')='3' THEN 1 WHEN obter_dados_categ_conv(c.nr_atendimento,'CA')='4' THEN 2 WHEN obter_dados_categ_conv(c.nr_atendimento,'CA')='5' THEN 3 WHEN obter_dados_categ_conv(c.nr_atendimento,'CA')='6' THEN 4  ELSE CASE WHEN c.ie_tipo_atendimento=3 THEN 5  ELSE 6 END  END
					tp_atendimento,
	lpad(substr(i.cd_item_convenio,1,8),8,'0') cd_procedimento,
	substr(i.ds_item,1,60)		ds_procedimento,
	'N'				ie_acidente_trabalho,
	CASE WHEN c.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END  ie_internado,
	CASE WHEN c.nr_cirurgia IS NULL THEN 'N'  ELSE 'S' END  ie_cirurgia,
	c.dt_entrada			dt_atendimento,
	h.dt_vencimento			dt_pagamento,
	i.vl_total_item			vl_procedimento,
	0				vl_adicional
from 	w_interf_conta_header	h,
	w_interf_conta_cab	c,
	w_interf_conta_item	i
where 	c.nr_interno_conta = i.nr_interno_conta
and 	h.nr_seq_protocolo = c.nr_seq_protocolo
and 	i.ie_tipo_item	= 1;

