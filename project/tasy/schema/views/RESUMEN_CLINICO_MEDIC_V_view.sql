-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW resumen_clinico_medic_v (nr_atendimento, ds_material, dt_adm, dt_fim_adm, qt_dose, ie_via_aplicacao, ie_desc_via_aplicacao, ds_observacao, cd_cat_medicamento, ds_medicamento, cd_material) AS SELECT  a.nr_atendimento NR_ATENDIMENTO,
        SUBSTR(x.ds_material,1,240) DS_MATERIAL,
        MIN(c.dt_horario) DT_ADM,
        MAX(c.dt_fim_horario) DT_FIM_ADM,
        SUM(coalesce(CASE WHEN coalesce(d.qt_dose_adm,0)=0 THEN c.qt_dose  ELSE d.qt_dose_adm END ,c.qt_dose)) QT_DOSE,
        coalesce(OBTER_VIA_ANVISA(b.IE_VIA_APLICACAO),b.IE_VIA_APLICACAO) IE_VIA_APLICACAO,
		Obter_Desc_via(coalesce(OBTER_VIA_ANVISA(b.IE_VIA_APLICACAO),b.IE_VIA_APLICACAO)) IE_DESC_VIA_APLICACAO,
        b.ds_observacao DS_OBSERVACAO,
		CM.CD_CAT_MEDICAMENTO CD_CAT_MEDICAMENTO,
		CM.DS_MEDICAMENTO DS_MEDICAMENTO,
		x.cd_material CD_MATERIAL
FROM prescr_medica a, material x
LEFT OUTER JOIN cat_medicamento cm ON (x.cd_material = CM.cd_medicamento)
, prescr_mat_hor c
LEFT OUTER JOIN prescr_mat_alteracao d ON (c.nr_sequencia = d.nr_seq_horario)
, prescr_material b
LEFT OUTER JOIN prescr_mat_hor c ON (b.nr_sequencia = c.nr_seq_material)
WHERE c.nr_prescricao = b.nr_prescricao AND b.nr_prescricao = a.nr_prescricao AND b.cd_material        = x.cd_material AND c.DT_SUSPENSAO IS NULL AND coalesce(c.ie_situacao,'A') = 'A' AND coalesce(c.ie_adep,'S') = 'S' AND b.ie_agrupador = 1 AND coalesce(a.ie_adep,'S') = 'S' AND coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'  GROUP BY a.nr_atendimento,
	  	 a.nr_prescricao,
		 x.ds_material,
		 b.IE_VIA_APLICACAO,
		 b.ds_observacao,
		CM.CD_CAT_MEDICAMENTO,
		CM.DS_MEDICAMENTO,
		x.CD_MATERIAL;

