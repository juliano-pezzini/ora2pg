-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW qua_auditoria_item_v (ordem, nr_seq_audit, nr_seq_item_result, nr_seq_tipo, cd_classificacao, ds_item, nr_seq_item, nr_seq_apres, ie_resultado, ds_orientacao, ds_complemento, ie_permite_na, nr_seq_apres_cap, nr_seq_apres_estrut, nr_seq_apres_item, nr_seq_audit_estrut, nr_seq_apres_subitem, nr_seq_subitem) AS SELECT	1 ordem,
	b.nr_sequencia nr_seq_audit,
	0 nr_seq_item_result,
	a.nr_seq_tipo,
	a.cd_classificacao,
	c.ds_capitulo ds_item,
	0 nr_seq_item,
	0 nr_seq_apres,
	'' ie_resultado,
	'' ds_orientacao,
	'' ds_complemento,
	'S' ie_permite_na,
	coalesce(c.nr_seq_apres,0) nr_seq_apres_cap,
	coalesce(a.nr_seq_apres,0) nr_seq_apres_estrut,
	0 nr_seq_apres_item,
	a.nr_sequencia nr_seq_audit_estrut,
	0 nr_seq_apres_subitem,
	0  nr_seq_subitem
FROM	qua_auditoria_cap c,
	qua_auditoria b,
	qua_auditoria_estrut a
WHERE	a.nr_seq_tipo = b.nr_seq_tipo
AND	a.nr_seq_cap = c.nr_sequencia
AND	c.ie_situacao = 'A'
and	a.nr_sequencia = qua_obter_estrut_regra(a.nr_sequencia,b.cd_setor_atendimento,b.nr_seq_ambiente)
and	exists (select	1
		from	qua_auditoria_result	x,
			qua_auditoria_item	y
		where	a.nr_sequencia	= y.nr_seq_estrutura
		and	y.nr_sequencia	= x.nr_seq_item
		and	b.nr_sequencia = x.nr_seq_auditoria)

UNION

SELECT	2 ordem,
	b.nr_sequencia nr_seq_audit,
	0 nr_seq_item_result,
	a.nr_seq_tipo, 
	a.cd_classificacao,
	CASE WHEN a.nr_seq_cap IS NULL THEN a.ds_estrutura  ELSE '    ' || a.ds_estrutura END  ds_item,
	0 nr_seq_item,
	0 nr_seq_apres,
	'' ie_resultado,
	'' ds_orientacao,
	'' ds_complemento,
	'S' ie_permite_na,
	coalesce(c.nr_seq_apres,0) nr_seq_apres_cap,
	coalesce(a.nr_seq_apres,0) nr_seq_apres_estrut,
	0 nr_seq_apres_item,
	a.nr_sequencia nr_seq_audit_estrut,
	0 nr_seq_apres_subitem,
	0  nr_seq_subitem
FROM	qua_auditoria_cap c,
	qua_auditoria b,
	qua_auditoria_estrut a
WHERE	a.nr_seq_tipo = b.nr_seq_tipo
AND	a.nr_seq_cap = c.nr_sequencia
AND	c.ie_situacao = 'A'
and	a.nr_sequencia = qua_obter_estrut_regra(a.nr_sequencia,b.cd_setor_atendimento,b.nr_seq_ambiente)
and	exists (select	1
		from	qua_auditoria_result	x,
			qua_auditoria_item	y
		where	a.nr_sequencia	= y.nr_seq_estrutura
		and	y.nr_sequencia	= x.nr_seq_item
		and	b.nr_sequencia = x.nr_seq_auditoria)

UNION

SELECT	3 ordem,
	d.nr_sequencia nr_seq_audit,
	c.nr_sequencia nr_seq_item_result,
	a.nr_seq_tipo, 
	a.cd_classificacao,
	   '        ' || SUBSTR(obter_desc_expressao(b.CD_EXP_ITEM,b.DS_ITEM),1,255) ds_item,
	b.nr_sequencia nr_seq_item,
	b.nr_seq_apres,
	c.ie_resultado,
	b.ds_orientacao,
	c.ds_complemento,
	b.ie_permite_na,
	coalesce(e.nr_seq_apres,0) nr_seq_apres_cap,
	coalesce(a.nr_seq_apres,0) nr_seq_apres_estrut,
	coalesce(b.nr_seq_apres,0) nr_seq_apres_item,
	a.nr_sequencia nr_seq_audit_estrut,
	0 nr_seq_apres_subitem,
	0  nr_seq_subitem
FROM	qua_auditoria_cap e,
	qua_auditoria d,
	qua_auditoria_result c,
	qua_auditoria_item b,
	qua_auditoria_estrut a
WHERE	b.nr_seq_estrutura = a.nr_sequencia
AND	b.ie_situacao = 'A'
AND	d.nr_sequencia = c.nr_seq_auditoria
AND	a.nr_seq_cap = e.nr_sequencia
AND	d.nr_seq_tipo = a.nr_seq_tipo
AND	coalesce(c.nr_seq_subitem,0) = 0
AND	c.nr_seq_item = b.nr_sequencia
and	a.nr_sequencia = qua_obter_estrut_regra(a.nr_sequencia,d.cd_setor_atendimento,d.nr_seq_ambiente)

UNION
 
SELECT	4 ordem,
	d.nr_sequencia nr_seq_audit,
	c.nr_sequencia nr_seq_item_result,
	a.nr_seq_tipo, 
	a.cd_classificacao,
	'               ' || s.ds_item ds_item,
	b.nr_sequencia nr_seq_item,
	b.nr_seq_apres,
	c.ie_resultado,
	s.ds_orientacao,
	c.ds_complemento,
	b.ie_permite_na,
	coalesce(e.nr_seq_apres,0) nr_seq_apres_cap,
	coalesce(a.nr_seq_apres,0) nr_seq_apres_estrut,
	coalesce(b.nr_seq_apres,0) nr_seq_apres_item,
	a.nr_sequencia nr_seq_audit_estrut,
	coalesce(s.nr_seq_apres,0) nr_seq_apres_subitem,
	s.nr_sequencia nr_seq_subitem
FROM	qua_auditoria_cap e,
	qua_auditoria d,
	qua_auditoria_result c,
	qua_auditoria_item b,
	qua_auditoria_subitem s,
	qua_auditoria_estrut a
WHERE	b.nr_seq_estrutura = a.nr_sequencia
AND	d.nr_sequencia = c.nr_seq_auditoria
AND	a.nr_seq_cap = e.nr_sequencia
AND	s.nr_seq_item = b.nr_sequencia
AND	d.nr_seq_tipo = a.nr_seq_tipo
AND	s.nr_sequencia= c.nr_seq_subitem
AND	c.nr_seq_item = b.nr_sequencia
AND	b.ie_situacao = 'A'
and	a.nr_sequencia = qua_obter_estrut_regra(a.nr_sequencia,d.cd_setor_atendimento,d.nr_seq_ambiente);

