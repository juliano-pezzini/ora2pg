-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_consulta_rescisao_v (nr_sequencia, ie_todos, nr_seq_rescindido, nm_rescindido, dt_rescisao, ds_motivo_cancelamento, dt_solicitacao, nm_usuario_solicitacao, ds_observacao, nm_subestipulante, cd_pessoa_fisica, nr_seq_titular, dt_cancelamento, dt_rescisao_benef, ie_tipo, ds_tipo, nr_seq_motivo_rescisao, nr_seq_contrato, cd_estabelecimento, nr_contrato, dt_limite_utilizacao, dt_liberacao, dt_obito, nr_certidao_obito, ie_situacao, ie_situacao_trabalhista, ds_tipo_segurado, nr_seq_motivo_rejeicao, ds_motivo_rejeicao, ie_tipo_solicitante, nr_seq_plano, nr_seq_pagador, nr_seq_segurado, ie_exige_liberacao_web, nr_seq_causa_rescisao, ie_data_alterada_regra) AS select	a.nr_sequencia,	
	'N' ie_todos,
	a.nr_seq_segurado nr_seq_rescindido,
	substr(obter_nome_pf(b.cd_pessoa_fisica),1,60) nm_rescindido,
	a.dt_rescisao,
	c.ds_motivo_cancelamento,
	a.dt_solicitacao,
	a.nm_usuario_solicitacao,
	substr(a.ds_observacao,1,255) ds_observacao,
	substr(pls_obter_desc_subestipulante(b.nr_seq_subestipulante),1,80) nm_subestipulante,
	b.cd_pessoa_fisica,
	b.nr_seq_titular,
	null dt_cancelamento,
	b.dt_rescisao dt_rescisao_benef,
	'B' ie_tipo,
	wheb_mensagem_pck.get_texto(1108818) ds_tipo,
	a.nr_seq_motivo_rescisao,
	b.nr_seq_contrato,
	(substr(pls_obter_dados_contrato(b.nr_seq_contrato,'EST'),1,5))::numeric  cd_estabelecimento,
	substr(pls_obter_dados_contrato(b.nr_seq_contrato,'N'),1,20) nr_contrato,
	a.dt_limite_utilizacao,
	a.dt_liberacao,
	a.dt_obito,	
	a.nr_certidao_obito,
	a.ie_situacao,
	b.ie_situacao_trabalhista,
	(	select	substr(x.ds_valor_dominio,1,255)
		FROM	valor_dominio_v	x
		where	x.cd_dominio	= 2406
		and	x.vl_dominio	= b.ie_tipo_segurado) ds_tipo_segurado,
	a.nr_seq_motivo_rejeicao,
	(	select 	ds_motivo_rejeicao
		from 	pls_motivo_cancel_rescisao	x
		where	nr_sequencia	= a.nr_seq_motivo_rejeicao) ds_motivo_rejeicao,
	a.ie_tipo_solicitante,
	b.nr_seq_plano,
	b.nr_seq_pagador	nr_seq_pagador,
	b.nr_sequencia		nr_seq_segurado,
	a.ie_exige_liberacao_web ie_exige_liberacao_web,
	a.nr_seq_causa_rescisao,
	a.ie_data_alterada_regra
FROM pessoa_fisica d, pls_segurado b, pls_motivo_cancelamento c
LEFT OUTER JOIN pls_rescisao_contrato a ON (c.nr_sequencia = a.nr_seq_motivo_rescisao)
WHERE a.nr_seq_segurado	= b.nr_sequencia and b.cd_pessoa_fisica	= d.cd_pessoa_fisica  
union

select	a.nr_sequencia,
	'N' ie_todos,
	a.nr_seq_pagador nr_seq_rescindido,
	substr((select	obter_nome_pf(b.cd_pessoa_fisica)
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = b.cd_pessoa_fisica
		
UNION ALL

		select	y.ds_razao_social
		from	pessoa_juridica y
		where	y.cd_cgc	= b.cd_cgc),1,255) nm_rescindido,
	a.dt_rescisao,
	c.ds_motivo_cancelamento,
	a.dt_solicitacao,
	a.nm_usuario_solicitacao,
	substr(a.ds_observacao,1,255) ds_observacao,
	null nm_subestipulante,
	b.cd_pessoa_fisica,
	null nr_seq_titular,
	null dt_cancelamento,
	b.dt_rescisao dt_rescisao_benef,
	'P' ie_tipo,
	'Pagador' ds_tipo,
	a.nr_seq_motivo_rescisao,
	b.nr_seq_contrato,
	(substr(pls_obter_dados_contrato(b.nr_seq_contrato,'EST'),1,5))::numeric  cd_estabelecimento,
	substr(pls_obter_dados_contrato(b.nr_seq_contrato,'N'),1,20) nr_contrato,
	a.dt_limite_utilizacao,
	a.dt_liberacao,
	a.dt_obito,	
	a.nr_certidao_obito,
	a.ie_situacao,
	b.ie_situacao_trabalhista,
	null ds_tipo_segurado,
	a.nr_seq_motivo_rejeicao,
	(	select 	ds_motivo_rejeicao
		from 	pls_motivo_cancel_rescisao	x
		where	nr_sequencia	= a.nr_seq_motivo_rejeicao) ds_motivo_rejeicao,
	a.ie_tipo_solicitante,
	null nr_seq_plano,
	b.nr_sequencia nr_seq_pagador,
	null	nr_seq_segurado,
	a.ie_exige_liberacao_web ie_exige_liberacao_web,
	a.nr_seq_causa_rescisao,
	a.ie_data_alterada_regra
FROM pls_contrato_pagador b, pls_motivo_cancelamento c
LEFT OUTER JOIN pls_rescisao_contrato a ON (c.nr_sequencia = a.nr_seq_motivo_rescisao)
WHERE a.nr_seq_pagador	= b.nr_sequencia  
union

select	a.nr_sequencia,
	'N' ie_todos,
	b.nr_contrato nr_seq_rescindido,
	substr(pls_obter_dados_contrato(b.nr_sequencia, 'S'),1,255) nm_rescindido,
	a.dt_rescisao,
	c.ds_motivo_cancelamento,
	a.dt_solicitacao,
	a.nm_usuario_solicitacao,
	substr(a.ds_observacao,1,255) ds_observacao,
	substr((select x.nm_pessoa_fisica
		from	pessoa_fisica x
		where	x.cd_pessoa_fisica = b.cd_pf_estipulante
		
UNION ALL

		select	y.ds_razao_social
		from	pessoa_juridica y
		where	y.cd_cgc	= b.cd_cgc_estipulante),1,200) nm_subestipulante,
	coalesce(b.cd_pf_estipulante, b.cd_cgc_estipulante) cd_pessoa_fisica,
	null nr_seq_titular,
	b.dt_cancelamento,
	b.dt_cancelamento dt_rescisao_benef,
	'C' ie_tipo,
	'Contrato' ds_tipo,
	a.nr_seq_motivo_rescisao,
	b.nr_sequencia,
	b.cd_estabelecimento,
	to_char(b.nr_contrato) nr_contrato,
	a.dt_limite_utilizacao,
	a.dt_liberacao,
	a.dt_obito,
	a.nr_certidao_obito,
	a.ie_situacao,
	null ie_situacao_trabalhista,
	null ds_tipo_segurado,
	a.nr_seq_motivo_rejeicao,
	(	select 	ds_motivo_rejeicao
		from 	pls_motivo_cancel_rescisao	x
		where	nr_sequencia	= a.nr_seq_motivo_rejeicao) ds_motivo_rejeicao,
	a.ie_tipo_solicitante,
	null nr_seq_plano,
	null nr_seq_pagador,
	null nr_seq_segurado,
	a.ie_exige_liberacao_web ie_exige_liberacao_web,
	a.nr_seq_causa_rescisao,
	a.ie_data_alterada_regra
FROM pls_contrato b, pls_motivo_cancelamento c
LEFT OUTER JOIN pls_rescisao_contrato a ON (c.nr_sequencia = a.nr_seq_motivo_rescisao)
WHERE a.nr_seq_contrato	= b.nr_sequencia;

