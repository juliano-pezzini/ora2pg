-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_interf_hsa_v (tp_registro, ds_registro, ds_terceiro, cd_cgc_terceiro, nr_inscricao_inss, cd_categoria_sefip, cd_empresa, cd_filial, dt_competencia_pagto, cd_cidade, vl_rendimento, vl_contribuicao_inss, vl_deducao_inss, vl_base_ir, dt_pagamento, cd_retencao, qt_dependente_ir, vl_ir_retido, vl_base_gps, pr_gps, dt_emissao, cd_estabelecimento) AS select	0					tp_registro,
	'FP-DIRF'				ds_registro, 
	''					ds_terceiro, 
	'0'					cd_cgc_terceiro, 
	'0'					nr_inscricao_inss, 
	0					cd_categoria_sefip, 
	0					cd_empresa, 
	0					cd_filial, 
	LOCALTIMESTAMP 				dt_competencia_pagto, 
	'0'					cd_cidade, 
	0					vl_rendimento, 
	0					vl_contribuicao_inss, 
	0					vl_deducao_inss, 
	0					vl_base_ir, 
	LOCALTIMESTAMP				dt_pagamento, 
	0					cd_retencao, 
	0					qt_dependente_ir, 
	0					vl_ir_retido, 
	0					vl_base_gps, 
	0					pr_gps, 
	to_date(null)				dt_emissao, 
	e.cd_estabelecimento 
FROM	estabelecimento e 

union
 
select	1					tp_registro, 
	''					ds_registro, 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,30) ds_terceiro, 
	coalesce(n.cd_cgc,n.cd_pessoa_fisica)	cd_cgc_terceiro, 
	e.cd_inscricao_municipal 		nr_inscricao_inss, 
	0 					cd_categoria_sefip, 
	0					cd_empresa, 
	0					cd_filial, 
	LOCALTIMESTAMP 				dt_competencia_pagto, 
	'0'					cd_cidade, 
	0					vl_rendimento, 
	0					vl_contribuicao_inss, 
	0					vl_deducao_inss, 
	0					vl_base_ir, 
	LOCALTIMESTAMP				dt_pagamento, 
	0					cd_retencao, 
	0					qt_dependente_ir, 
	0					vl_ir_retido, 
	0					vl_base_gps, 
	0					pr_gps, 
	n.dt_emissao				dt_emissao, 
	e.cd_estabelecimento 
from	estabelecimento e, 
	nota_fiscal n 
where	n.cd_estabelecimento = e.cd_estabelecimento 
and	substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S' 

union
 
select	2 					tp_registro, 
	''					ds_registro, 
	''					ds_terceiro, 
	'0'					cd_cgc_terceiro, 
	'0'					nr_inscricao_inss, 
	0					cd_categoria_sefip, 
	e.cd_empresa, 
	1 					cd_filial, 
	r.dt_liquidacao			dt_competencia_pagto, 
	substr(obter_cod_municipio_ibge(substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CEP'),1,8)),1,30) 
						cd_cidade, 
	n.vl_total_nota			vl_rendimento, 
	0					vl_contribuicao_inss, 
	0					vl_deducao_inss, 
	Obter_Valor_Tributo_Nota(n.nr_sequencia,'B') vl_base_ir, 
	r.dt_liquidacao			dt_pagamento, 
	t.cd_tributo				cd_retencao, 
	0					qt_dependente_ir, 
	Obter_Valor_Tributo_Nota(n.nr_sequencia,'V') vl_ir_retido, 
	0					vl_base_gps, 
	0					pr_gps, 
	n.dt_emissao				dt_emissao, 
	e.cd_estabelecimento 
FROM nota_fiscal_trib t, estabelecimento e, nota_fiscal n
LEFT OUTER JOIN titulo_receber r ON (n.nr_sequencia = r.nr_seq_nf_saida)
WHERE n.cd_estabelecimento 	= e.cd_estabelecimento and n.nr_sequencia		= t.nr_sequencia  and substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S';

