-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_compras_v2 (nr_sequencia, dt_referencia, cd_estabelecimento, ie_periodo, dt_atualizacao, nm_usuario, cd_cgc, ie_prod_fabric, cd_grupo_material, ie_tipo_material, cd_material, qt_dias_prazo_entrega, qt_dias_prazo_pagto, qt_dias_atraso, qt_compra, ie_urgente, vl_compra, vl_compra_avista, vl_custo_padrao, vl_medio_fatur, vl_liq_moeda_ref, cd_comprador, vl_compra_prazo_medio, ie_classificacao, ie_curva_abc, cd_operacao_nf, ie_vinc_ordem, qt_compra_urgente, qt_compra_informal, ie_vinc_contrato, ie_ordem_contrato, nr_seq_proj_rec, cd_conta_contabil, cd_local_estoque, vl_bruto_compra, cd_centro_custo, cd_pessoa_fisica, nr_seq_tipo_compra, qt_count_itens, pr_desconto_medio, vl_meta, ie_contrato_mercado, ie_tipo_fornecedor, qt_prazo_medio_pagto, ds_cod_cgc, vl_resultado, nm_comprador, ds_grupo_material, ds_material, ds_prod_fabric, ds_classificacao, ie_padronizado, ds_operacao_nf, ds_conta_contabil, ds_projeto_recurso, ds_razao_social, nm_pessoa_fisica, ds_fornecedor, ie_qualidade, ds_prazo_medio, ds_tipo_material, ds_tipo_pessoa, ds_ordem_contrato, ds_local_estoque, cd_tipo_pessoa, cd_subgrupo_material, ds_subgrupo_material, cd_classe_material, ds_classe_material, ds_tipo_compra, ds_centro_custo, ds_municipio, sg_estado, ds_contrato_mercado, nr_seq_familia, ds_familia) AS select	a.NR_SEQUENCIA,a.DT_REFERENCIA,a.CD_ESTABELECIMENTO,a.IE_PERIODO,a.DT_ATUALIZACAO,a.NM_USUARIO,a.CD_CGC,a.IE_PROD_FABRIC,a.CD_GRUPO_MATERIAL,a.IE_TIPO_MATERIAL,a.CD_MATERIAL,a.QT_DIAS_PRAZO_ENTREGA,a.QT_DIAS_PRAZO_PAGTO,a.QT_DIAS_ATRASO,a.QT_COMPRA,a.IE_URGENTE,a.VL_COMPRA,a.VL_COMPRA_AVISTA,a.VL_CUSTO_PADRAO,a.VL_MEDIO_FATUR,a.VL_LIQ_MOEDA_REF,a.CD_COMPRADOR,a.VL_COMPRA_PRAZO_MEDIO,a.IE_CLASSIFICACAO,a.IE_CURVA_ABC,a.CD_OPERACAO_NF,a.IE_VINC_ORDEM,a.QT_COMPRA_URGENTE,a.QT_COMPRA_INFORMAL,a.IE_VINC_CONTRATO,a.IE_ORDEM_CONTRATO,a.NR_SEQ_PROJ_REC,a.CD_CONTA_CONTABIL,a.CD_LOCAL_ESTOQUE,a.VL_BRUTO_COMPRA,a.CD_CENTRO_CUSTO,a.CD_PESSOA_FISICA,a.NR_SEQ_TIPO_COMPRA,a.QT_COUNT_ITENS,a.PR_DESCONTO_MEDIO,a.VL_META,a.IE_CONTRATO_MERCADO,a.IE_TIPO_FORNECEDOR,
	(a.vl_compra_prazo_medio * a.qt_dias_prazo_pagto) qt_prazo_medio_pagto, 
	a.cd_cgc ds_cod_cgc, 
	(a.vl_custo_padrao - a.vl_compra) vl_resultado, 
	substr(obter_nome_pessoa_fisica(a.cd_comprador, null),1,80) nm_comprador, 
	substr(obter_desc_estrut_mat(a.cd_grupo_material, null, null, null),1,80) ds_grupo_material, 
	substr('(' || a.cd_material || ') ' || obter_desc_estrut_mat(null, null, null, a.cd_material),1,255) ds_material, 
	substr(obter_valor_dominio(6, a.ie_prod_fabric),1,10) ds_prod_fabric, 
	substr(obter_valor_dominio(1840, a.ie_classificacao),1,40) ds_classificacao, 
	substr(obter_se_material_padronizado(a.cd_estabelecimento, a.cd_material),1,1) ie_padronizado, 
	substr(obter_desc_operacao_nota(a.cd_operacao_nf),1,80) ds_operacao_nf, 
	substr(obter_desc_conta_contabil(a.cd_conta_contabil),1,255) ds_conta_contabil, 
	substr(obter_desc_proj_recurso(a.nr_seq_proj_rec),1,100) ds_projeto_recurso, 
	c.ds_razao_social, 
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica, 
	substr(CASE WHEN a.cd_pessoa_fisica IS NULL THEN c.ds_razao_social  ELSE obter_nome_pf(a.cd_pessoa_fisica) END ,1,255) ds_fornecedor, 
	substr(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc, 'ECQ'),1,3) ie_qualidade, 
	'Prazo medio' ds_prazo_medio, 
	substr(obter_valor_dominio(29, a.ie_tipo_material),1,20) ds_tipo_material, 
	substr(obter_desc_tipo_pj(c.cd_tipo_pessoa, 'D'),1,120) ds_tipo_pessoa, 
	substr(CASE WHEN a.ie_ordem_contrato='N' THEN 'Compra normal' WHEN a.ie_ordem_contrato='O' THEN 'Compra com ordem' WHEN a.ie_ordem_contrato='C' THEN 'Compra com contrato' END ,1,30) ds_ordem_contrato, 
	substr(obter_desc_local_estoque(a.cd_local_estoque),1,255) ds_local_estoque, 
	c.cd_tipo_pessoa, 
	e.cd_subgrupo_material, 
	e.ds_subgrupo_material, 
	e.cd_classe_material, 
	e.ds_classe_material, 
	substr(lic_obter_desc_tipo_compra(a.nr_seq_tipo_compra),1,255) ds_tipo_compra, 
	coalesce(substr(obter_desc_centro_custo(a.cd_centro_custo),1,80),'Sem centro de custo') ds_centro_custo, 
	upper(ds_municipio) ds_municipio, 
	sg_estado, 
	substr(obter_valor_dominio(5815,ie_contrato_mercado),1,255) ds_contrato_mercado, 
	e.nr_seq_familia, 
	substr(Obter_Desc_Familia_Mat(e.nr_seq_familia),1,255) ds_familia 
FROM	estrutura_material_v e, 
	pessoa_juridica c, 
	eis_compras a 
where	a.cd_cgc	= c.cd_cgc 
and	a.cd_material	= e.cd_material 
and	coalesce(a.ie_tipo_fornecedor,'PJ') <> 'PF' 

union all
 
select	a.NR_SEQUENCIA,a.DT_REFERENCIA,a.CD_ESTABELECIMENTO,a.IE_PERIODO,a.DT_ATUALIZACAO,a.NM_USUARIO,a.CD_CGC,a.IE_PROD_FABRIC,a.CD_GRUPO_MATERIAL,a.IE_TIPO_MATERIAL,a.CD_MATERIAL,a.QT_DIAS_PRAZO_ENTREGA,a.QT_DIAS_PRAZO_PAGTO,a.QT_DIAS_ATRASO,a.QT_COMPRA,a.IE_URGENTE,a.VL_COMPRA,a.VL_COMPRA_AVISTA,a.VL_CUSTO_PADRAO,a.VL_MEDIO_FATUR,a.VL_LIQ_MOEDA_REF,a.CD_COMPRADOR,a.VL_COMPRA_PRAZO_MEDIO,a.IE_CLASSIFICACAO,a.IE_CURVA_ABC,a.CD_OPERACAO_NF,a.IE_VINC_ORDEM,a.QT_COMPRA_URGENTE,a.QT_COMPRA_INFORMAL,a.IE_VINC_CONTRATO,a.IE_ORDEM_CONTRATO,a.NR_SEQ_PROJ_REC,a.CD_CONTA_CONTABIL,a.CD_LOCAL_ESTOQUE,a.VL_BRUTO_COMPRA,a.CD_CENTRO_CUSTO,a.CD_PESSOA_FISICA,a.NR_SEQ_TIPO_COMPRA,a.QT_COUNT_ITENS,a.PR_DESCONTO_MEDIO,a.VL_META,a.IE_CONTRATO_MERCADO,a.IE_TIPO_FORNECEDOR, 
	(a.vl_compra_prazo_medio * a.qt_dias_prazo_pagto) qt_prazo_medio_pagto, 
	a.cd_cgc ds_cod_cgc, 
	(a.vl_custo_padrao - a.vl_compra) vl_resultado, 
	substr(obter_nome_pessoa_fisica(a.cd_comprador, null),1,80) nm_comprador, 
	substr(obter_desc_estrut_mat(a.cd_grupo_material, null, null, null),1,80) ds_grupo_material, 
	substr('(' || a.cd_material || ') ' || obter_desc_estrut_mat(null, null, null, a.cd_material),1,255) ds_material, 
	substr(obter_valor_dominio(6, a.ie_prod_fabric),1,10) ds_prod_fabric, 
	substr(obter_valor_dominio(1840, a.ie_classificacao),1,40) ds_classificacao, 
	substr(obter_se_material_padronizado(a.cd_estabelecimento, a.cd_material),1,1) ie_padronizado, 
	substr(obter_desc_operacao_nota(a.cd_operacao_nf),1,80) ds_operacao_nf, 
	substr(obter_desc_conta_contabil(a.cd_conta_contabil),1,255) ds_conta_contabil, 
	substr(obter_desc_proj_recurso(a.nr_seq_proj_rec),1,100) ds_projeto_recurso, 
	CASE WHEN a.cd_pessoa_fisica IS NULL THEN ''  ELSE obter_nome_pf(a.cd_pessoa_fisica) END , 
	substr(obter_nome_pf(a.cd_pessoa_fisica),1,255) nm_pessoa_fisica, 
	substr(CASE WHEN a.cd_pessoa_fisica IS NULL THEN ''  ELSE obter_nome_pf(a.cd_pessoa_fisica) END ,1,255) ds_fornecedor, 
	substr(obter_dados_pf_pj_estab(a.cd_estabelecimento, null, a.cd_cgc, 'ECQ'),1,3) ie_qualidade, 
	'Prazo medio' ds_prazo_medio, 
	substr(obter_valor_dominio(29, a.ie_tipo_material),1,20) ds_tipo_material, 
	'Pessoa FÃ­sica' ds_tipo_pessoa, 
	substr(CASE WHEN a.ie_ordem_contrato='N' THEN 'Compra normal' WHEN a.ie_ordem_contrato='O' THEN 'Compra com ordem' WHEN a.ie_ordem_contrato='C' THEN 'Compra com contrato' END ,1,30) ds_ordem_contrato, 
	substr(obter_desc_local_estoque(a.cd_local_estoque),1,255) ds_local_estoque, 
	0 cd_tipo_pessoa, 
	e.cd_subgrupo_material, 
	e.ds_subgrupo_material, 
	e.cd_classe_material, 
	e.ds_classe_material, 
	substr(lic_obter_desc_tipo_compra(a.nr_seq_tipo_compra),1,255) ds_tipo_compra, 
	coalesce(substr(obter_desc_centro_custo(a.cd_centro_custo),1,80),'Sem centro de custo') ds_centro_custo, 
	upper(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DM')  ELSE nfe_obter_dados_pj(a.cd_cgc,'MU') END ) ds_municipio, 
	CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'UF')  ELSE nfe_obter_dados_pj(a.cd_cgc,'UF') END  sg_estado, 
	substr(obter_valor_dominio(5815,ie_contrato_mercado),1,255) ds_contrato_mercado, 
	e.nr_seq_familia, 
	substr(Obter_Desc_Familia_Mat(e.nr_seq_familia),1,255) ds_familia 
from	estrutura_material_v e, 
	eis_compras a 
where	a.cd_material	= e.cd_material 
and	coalesce(a.ie_tipo_fornecedor,'PJ') = 'PF' 
and	a.cd_pessoa_fisica is not null;

