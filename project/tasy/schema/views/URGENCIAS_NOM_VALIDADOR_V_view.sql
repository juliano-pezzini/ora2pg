-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW urgencias_nom_validador_v (clues, folio, curppaciente, nombre, primerapellido, segundoapellido, fechanacimiento, nacioextranjero, paisorigen, entidadnacimiento, edad, claveedad, sexo, afiliacion, gratuidad, numeroafiliacion, digitoverificador, resideextranjero, paisresidencia, entidadresidencia, municipioresidencia, localidadresidencia, codigopostal, seignoracp, tipovialidad, nombrevialidad, numeroexteriornumerico, tipoasentamiento, nombreasentamiento, telefono, fechaingreso, horaingreso, motivoatencion, tipocama, trasladotransitorio, fechaalta, horaalta, mesestadistico, tiempoestancia, altapor, cluesreferido, mujerfertil, descripcionafeccionprincipal, codigocieafeccionprincipal, comorbilidad, afeccionreseleccionada, procedimiento, medicamento, planiras, planedas, numerosobres, ministeriopublico, foliocertificadodefuncion, curpresponsable, nombreresponsable, primerapellidoresponsable, segundoapellidoresponsable, dt_entrada, cd_pessoa_fisica, cd_pessoa_fisica_medico, cd_cgc) AS select
	z.cd_clues clues,
        b.nr_atendimento folio,
	a.cd_curp curppaciente,
	y.ds_given_name nombre,
	y.ds_family_name primerapellido,
	y.ds_component_name_1 segundoapellido,
	a.dt_nascimento fechanacimiento,
        CASE WHEN c.ie_brasileiro='N' THEN  0  WHEN c.ie_brasileiro='S' THEN  1 END  as nacioextranjero,
        CASE WHEN c.ie_brasileiro='S' THEN  c.cd_externo END  as paisorigen,
        CASE WHEN c.ie_brasileiro='S' THEN  obter_dados_cat_entidade(a.cd_pessoa_fisica, 'CD_ENTIDADE')   ELSE 97 END  entidadnacimiento,
        case
		when obter_idade(a.dt_nascimento, b.dt_entrada, 'A') is not null
		then obter_idade_imc_nom(b.nr_atendimento,a.dt_nascimento,b.dt_entrada,'EDAD')
	end as edad,
	case
		when obter_idade(a.dt_nascimento, b.dt_entrada, 'A') is not null
		then obter_idade_imc_nom(b.nr_atendimento,a.dt_nascimento,b.dt_entrada,'CLAVEEDAD')
	end as claveedad,
        CASE WHEN a.ie_sexo='M' THEN  1  WHEN a.ie_sexo='F' THEN  2 END  sexo,
        r.cd_der_lesiones afiliacion,
        case
            when r.cd_der_lesiones = 12
            then CASE WHEN o.nr_doc_convenio IS NULL THEN 0  ELSE 1 END
	    end as gratuidad,
        case
            when o.nr_doc_convenio is not null
            then elimina_caracteres_especiais(o.nr_doc_convenio)
        end as numeroafiliacion,
        CASE WHEN r.cd_der_lesiones=11 THEN elimina_caracteres_especiais(a.nr_spss)  ELSE 0 END  as digitoverificador,
        CASE WHEN s.sg_pais='MEX' THEN 0  ELSE 1 END  resideextranjero,
        case
		when s.sg_pais = ('MEX')
		then upper(s.nm_pais)
	end as paisresidencia,
        CASE WHEN c.ie_brasileiro='S' THEN  e.cd_entidade   ELSE 97 END  entidadresidencia,
        CASE WHEN c.ie_brasileiro='S' THEN  k.cd_cat_municipio   ELSE 997 END  municipioresidencia,
        CASE WHEN c.ie_brasileiro='S' THEN  f.nr_seq_localizacao_mx  ELSE 9997 END   as localidadresidencia,
        case
		when s.sg_pais = 'MEX'
		then f.cd_cep
		else '99999'
	end as codigopostal,
        case
		when s.sg_pais not in ('MEX')
		then 1
		else 0
	end as seignoracp,
	'99' tipovialidad,
	'SIN INFORMACIÃ“N' nombrevialidad,
	substr(elimina_caractere_especial(f.nr_endereco),1,5) numeroexteriornumerico,
        CASE WHEN c.ie_brasileiro='S' THEN  n.cd_tipo_asen  ELSE 97 END  tipoasentamiento,
        elimina_caractere_especial(substr(n.nm_assentamento,1,100)) nombreasentamiento,
        f.nr_telefone as telefono,
        to_char(b.dt_entrada, 'dd/mm/yyyy') fechaingreso,
		to_char(b.dt_entrada, 'hh:mm') horaingreso,
        CASE WHEN coalesce(b.ie_clinica,9)=1 THEN 2 WHEN coalesce(b.ie_clinica,9)=2 THEN 9 WHEN coalesce(b.ie_clinica,9)=3 THEN 3 WHEN coalesce(b.ie_clinica,9)=4 THEN 4 WHEN coalesce(b.ie_clinica,9)=5 THEN 9 WHEN coalesce(b.ie_clinica,9)=6 THEN 1 WHEN coalesce(b.ie_clinica,9)=7 THEN 1 WHEN coalesce(b.ie_clinica,9)=8 THEN 1 WHEN coalesce(b.ie_clinica,9)=9 THEN 9 END  motivoatencion,
        pl.ie_tipo_cama tipocama,
        CASE WHEN z.cd_clues IS NULL THEN 0  ELSE 1 END  trasladotransitorio,
        to_char(b.dt_alta, 'dd/mm/yyyy') fechaalta,
        to_char(b.dt_alta, 'hh24:mi') horaalta,
        to_char(b.dt_alta, 'mm') as mesestadistico,
        obter_dias_entre_alta_vig_nom(b.nr_atendimento) as tiempoestancia,
        ma.ie_motivo_alta_mx altapor,
        z.cd_clues cluesreferido,
	CASE WHEN a.ie_sexo='F' THEN (select max(t.ie_pac_gravida) FROM atendimento_gravidez t where t.nr_atendimento = b.nr_atendimento)   ELSE null END  as mujerfertil,
	elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
						from diagnostico_doenca dd, cid_doenca cd
						where dd.nr_atendimento = b.nr_atendimento
						and dd.cd_doenca = cd.cd_doenca_cid
						and dd.ie_classificacao_doenca = 'P'
						and dd.cd_doenca in ('O00','O01','O02','O03','O04','O05','O06','O07','O08','O80','O81','O82','O83','O84'))),1, 255)) descripcionafeccionprincipal,
	(select max(cd.cd_doenca_cid)
	from diagnostico_doenca dd, cid_doenca cd
	where dd.nr_atendimento = b.nr_atendimento
	and dd.cd_doenca = cd.cd_doenca_cid
	and dd.ie_classificacao_doenca = 'P'
	and dd.cd_doenca in ('O00','O01','O02','O03','O04','O05','O06','O07','O08','O80','O81','O82','O83','O84')) codigocieafeccionprincipal,
	upper(obter_comorbilidade(b.nr_atendimento,'c')) as comorbilidad,
	trim((select max(dd.cd_doenca) from diagnostico_doenca dd where dd.nr_atendimento = b.nr_atendimento and dd.ie_classificacao_doenca = 'S' and dd.cd_doenca in ('O00','O01','O02','O03','O04','O05','O06','O07'))) afeccionreseleccionada,
	upper(obter_procedimentos_mx(b.nr_atendimento)) as procedimiento,
	upper(obter_medicamentos_mx(b.nr_atendimento)) as medicamento,
	obter_infeccoes_mexico(b.nr_atendimento) as planiras,
	obter_protocolos_mx(b.nr_atendimento) as planedas,
	obter_quantidade_soro_presc(b.nr_atendimento) as numerosobres,
        0 ministeriopublico,
        case
		when ma.ie_motivo_alta_mx = 3
		then ('180'||substr(w.nr_declaracao,1,7))
		else '0'
	end as foliocertificadodefuncion,
        x.cd_curp as curpresponsable,
        upper(yy.ds_given_name) nombreresponsable,
	upper(yy.ds_family_name) primerapellidoresponsable,
	upper(yy.ds_component_name_1) segundoapellidoresponsable,
	b.dt_entrada dt_entrada,
	a.cd_pessoa_fisica cd_pessoa_fisica,
	x.cd_pessoa_fisica cd_pessoa_fisica_medico,
	j.cd_cgc cd_cgc
FROM categoria_convenio p, pessoa_fisica a
LEFT OUTER JOIN person_name y ON (a.nr_seq_person_name = y.nr_sequencia AND 'main' = y.ds_type)
LEFT OUTER JOIN nacionalidade c ON (a.cd_nacionalidade = c.cd_nacionalidade)
LEFT OUTER JOIN compl_pessoa_fisica v ON (a.cd_pessoa_fisica = v.cd_pessoa_fisica AND 3 = v.ie_tipo_complemento)
LEFT OUTER JOIN compl_pessoa_fisica f ON (a.cd_pessoa_fisica = f.cd_pessoa_fisica AND 1 = f.ie_tipo_complemento)
LEFT OUTER JOIN sus_municipio d ON (f.cd_municipio_ibge = d.cd_municipio_ibge)
LEFT OUTER JOIN cat_tipo_assentamento n ON (f.nr_seq_assentamento_mx = n.nr_sequencia)
LEFT OUTER JOIN pais s ON (f.nr_seq_pais = s.nr_sequencia)
LEFT OUTER JOIN cat_entidade e ON (d.nr_seq_entidade_mx = e.nr_sequencia)
LEFT OUTER JOIN cat_municipio k ON (d.nr_seq_municipio_mx = k.nr_sequencia)
, atendimento_paciente b
LEFT OUTER JOIN atend_categoria_convenio o ON (b.nr_atendimento = o.nr_atendimento)
LEFT OUTER JOIN atendimento_gravidez t ON (b.nr_atendimento = t.nr_atendimento)
LEFT OUTER JOIN declaracao_obito w ON (b.nr_atendimento = w.nr_atendimento)
LEFT OUTER JOIN motivo_alta ma ON (b.cd_motivo_alta_medica = ma.cd_motivo_alta)
LEFT OUTER JOIN pa_local pl ON (b.nr_seq_local_pa = pl.nr_sequencia)
, estabelecimento j
LEFT OUTER JOIN pessoa_juridica i ON (j.cd_cgc = i.cd_cgc)
LEFT OUTER JOIN cat_clues z ON (i.cd_internacional = z.cd_clues)
, convenio q
LEFT OUTER JOIN cat_derechohabiencia r ON (q.cd_tipo_convenio_mx = r.nr_sequencia)
, pessoa_fisica x
LEFT OUTER JOIN person_name yy ON (x.nr_seq_person_name = yy.nr_sequencia AND 'main' = yy.ds_type)
WHERE b.cd_pessoa_fisica 		= a.cd_pessoa_fisica              and b.cd_estabelecimento 		= j.cd_estabelecimento  and o.cd_convenio 			= p.cd_convenio and o.cd_categoria 			= p.cd_categoria and q.cd_convenio 			= p.cd_convenio     and x.cd_pessoa_fisica 		= b.cd_medico_resp     and b.ie_tipo_atendimento 		= 3 and b.dt_alta is not null;

