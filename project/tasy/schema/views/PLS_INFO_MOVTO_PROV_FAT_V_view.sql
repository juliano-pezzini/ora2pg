-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_info_movto_prov_fat_v (vl_provisao, vl_administracao, vl_diferenca, vl_reembolso, vl_contab_ajuste, vl_taxa_adm_prov, dt_atualizacao_nrec, dt_mes_competencia, cd_estabelecimento, nr_seq_protocolo, nr_seq_conta, nr_seq_pos, nr_seq_pos_estab_contab) AS with parametros_contabeis_w as (	select	coalesce(max(x.ie_status_prov_pagto), 'N') ie_status_prov_pagto,
						x.cd_estabelecimento
					FROM	pls_parametro_contabil x
					group by x.cd_estabelecimento)
select	CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * ctb_pls_obter_valor_prov_fat(b.cd_estabelecimento, b.nr_sequencia, e.nr_sequencia, 'P') vl_provisao,
	CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * ctb_pls_obter_valor_prov_fat(b.cd_estabelecimento, b.nr_sequencia, e.nr_sequencia, 'A') vl_administracao,
	CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * ctb_pls_obter_valor_prov_fat(b.cd_estabelecimento, b.nr_sequencia, e.nr_sequencia, 'D') vl_diferenca,
	CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * ctb_pls_obter_valor_prov_fat(b.cd_estabelecimento, b.nr_sequencia, e.nr_sequencia, 'R') vl_reembolso,
	CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * ctb_pls_obter_valor_prov_fat(b.cd_estabelecimento, b.nr_sequencia, e.nr_sequencia, 'AJ') vl_contab_ajuste,
	0 vl_taxa_adm_prov,
	f.dt_atualizacao_nrec dt_atualizacao_nrec,
	e.dt_mes_competencia dt_mes_competencia,
	a.cd_estabelecimento cd_estabelecimento,
	a.nr_sequencia nr_seq_protocolo,
	b.nr_sequencia nr_seq_conta,
	d.nr_sequencia nr_seq_pos,
	e.nr_sequencia nr_seq_pos_estab_contab
from	pls_log_pos_estabelecido		f,
	pls_conta_pos_estab_contab 		e,
	pls_conta_pos_estabelecido		d,
	pls_conta				b,
	pls_protocolo_conta			a,
	pls_segurado				s,
	parametros_contabeis_w			z
where	d.nr_sequencia		= f.nr_seq_conta_pos
and	b.nr_sequencia		= f.nr_seq_conta
and	d.nr_sequencia		= e.nr_seq_conta_pos
and	b.nr_sequencia		= d.nr_seq_conta
and	a.nr_sequencia		= b.nr_seq_protocolo
and	s.nr_sequencia 		= b.nr_seq_segurado
and	b.cd_estabelecimento 	= z.cd_estabelecimento
and	(	-- Status da conta medica = Nao cancelada, ou apenas fechadas e a conta esta fechada
		(z.ie_status_prov_pagto <> 'F')
	or (z.ie_status_prov_pagto = 'F' and b.ie_status = 'F')
	)
and	coalesce(f.ie_tipo_registro,'H') = 'H' -- Historico	
and	(	-- Apenas situacoes onde "inverte a acao" do faturamento, sendo necessario contabilizar com sinal oposto
		(coalesce(f.ie_status_faturamento_ant,'X') in ('C','N','U','X') and f.ie_status_faturamento_new in ('L','P'))
	or (f.ie_status_faturamento_ant in ('L','P') and f.ie_status_faturamento_new in ('C','N','U'))
	)
and	a.ie_situacao	!= 'RE'  			-- Nao trazer protocolos rejeitados
and	coalesce(d.ie_situacao,'A')	= 'A' 			-- Apenas pos ativos
and     coalesce(d.ie_status_faturamento, 'A') <> 'A' 	-- Nao pode ser Envio A520
and	coalesce((	select	max(r.ie_situacao)
		from	pls_conta_medica_resumo r
		where	b.nr_sequencia	= r.nr_seq_conta
		and	r.nr_sequencia	= e.nr_seq_conta_resumo),'X')	<> 'I';

