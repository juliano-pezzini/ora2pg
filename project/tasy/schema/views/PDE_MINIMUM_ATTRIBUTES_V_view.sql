-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pde_minimum_attributes_v (nm_table, nm_attribute, cd_ontology, ranking) AS select nm_table,
				 nm_attribute,
				 cd_ontology,
				 ranking
	  FROM (select nm_table,
								 nm_attribute,
								 cd_ontology,
								 cd_valor_ontologia,
								 rank() over (partition by nm_table
															 order by case
																					when nm_attribute = 'NR_SEQ_PRESC' then
                                            1
																					when nm_attribute = 'NR_SEQUENCIA'
																					 and nm_table = 'PRESCR_PROCEDIMENTO' then
																					  1
																					when nm_attribute = 'NR_PRESCRICAO' then
																					  2
																					when nm_attribute = 'NR_ATENDIMENTO' then
																					  3
																					when nm_attribute = 'CD_PESSOA_FISICA' theN
																					  4
																					else
																					  5
																				end) as ranking
						from (select case
													 when a.nm_tabela = 'PRESCR_PROCEDIMENTO'
																and a.nm_atributo = 'NR_SEQUENCIA' then
														'NR_SEQ_PRESC'
													 else
														a.nm_atributo
												 end as nm_attribute,
												 case
													 when phi.cd_valor_ontologia is null then
														'Ontology required'
													 else
														phi.cd_valor_ontologia
												 end cd_ontology,
												 a.nm_tabela as nm_table,
												 phi.cd_valor_ontologia
										from tabela_atributo a
										left join res_cadastro_ontologia_phi phi
											on phi.nm_tabela = a.nm_tabela
										 and phi.nm_atributo = a.nm_atributo
									 where (a.nm_atributo in ('CD_PESSOA_FISICA',
																						'NR_ATENDIMENTO',
																						'NR_PRESCRICAO',
																						'NR_SEQ_PRESC')
											or (a.nm_atributo = 'NR_SEQUENCIA'
													and
													a.nm_tabela = 'PRESCR_PROCEDIMENTO')
													)
									) alias5
			) alias6
  where (nm_attribute = 'CD_PESSOA_FISICA' and ranking = 1)
     or nm_attribute <> 'CD_PESSOA_FISICA'
     or (nm_attribute = 'CD_PESSOA_FISICA' and  nm_table in ('PRESCR_MEDICA', 'ATENDIMENTO_PACIENTE'));

