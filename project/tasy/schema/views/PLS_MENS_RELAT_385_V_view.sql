-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_mens_relat_385_v (dt_mes_referencia, vl_mensalidade, vl_coparticipacao, vl_liq_sem_copartic, vl_antecipacao, vl_cancelado, vl_imposto, vl_antec_pro_rata, vl_antecipacao_rata_ant, vl_manual, vl_carteirinha, ie_tipo_vinculo_operadora, ie_cancelamento, ie_tipo_item, dt_geracao_nf) AS select	trunc(d.dt_referencia, 'month') dt_mes_referencia,
	sum(a.vl_item) vl_mensalidade,
	CASE WHEN a.ie_tipo_item='3' THEN  sum(a.vl_item)  ELSE 0 END  vl_coparticipacao,
	CASE WHEN a.ie_tipo_item='3' THEN  0  ELSE sum(CASE WHEN e.dt_contabilizacao IS NULL THEN  a.vl_item  ELSE a.vl_pro_rata_dia END ) END  vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
FROM pls_lote_mensalidade e, pls_mensalidade d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_tipo_lanc_adic f ON (a.nr_seq_tipo_lanc = f.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_mensalidade_seg and c.nr_sequencia		= b.nr_seq_segurado and d.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= d.nr_seq_lote and ((a.ie_tipo_item not in ('20','11')) or (a.ie_tipo_item = '20' and f.ie_considera_receita = 'S')) and coalesce(e.ie_mensalidade_mes_anterior,'N')	= 'N' group by	trunc(d.dt_referencia,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(a.dt_antecipacao,'month') dt_mes_referencia,
	sum(a.vl_antecipacao) vl_mensalidade,
	0 vl_coparticipacao,
	sum(a.vl_antecipacao) vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
FROM pls_lote_mensalidade e, pls_mensalidade d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_tipo_lanc_adic f ON (a.nr_seq_tipo_lanc = f.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_mensalidade_seg and c.nr_sequencia		= b.nr_seq_segurado and d.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= d.nr_seq_lote and e.ie_status = '2' and e.dt_contabilizacao is not null and ((a.ie_tipo_item not in ('20','11')) or (a.ie_tipo_item = '20' and f.ie_considera_receita = 'S')) and coalesce(e.ie_mensalidade_mes_anterior,'N')	= 'N' group by	trunc(a.dt_antecipacao,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(b.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	sum(CASE WHEN e.dt_contabilizacao IS NULL THEN  a.vl_antecipacao  ELSE 0 END ) vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
FROM pls_lote_mensalidade e, pls_mensalidade d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_tipo_lanc_adic f ON (a.nr_seq_tipo_lanc = f.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_mensalidade_seg and c.nr_sequencia		= b.nr_seq_segurado and d.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= d.nr_seq_lote  and e.ie_status = '2' and ((a.ie_tipo_item not in ('20','11','3')) or (a.ie_tipo_item = '20' and f.ie_considera_receita = 'S')) and coalesce(e.ie_mensalidade_mes_anterior,'N') = 'N' group by	trunc(b.dt_mesano_referencia,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(e.dt_contabilizacao,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	sum(a.vl_item) vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
from	pls_mensalidade_seg_item 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_mensalidade			d,
	pls_lote_mensalidade		e
where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
and	c.nr_sequencia		= b.nr_seq_segurado
and	d.nr_sequencia		= b.nr_seq_mensalidade
and	e.nr_sequencia		= d.nr_seq_lote
and	e.ie_status = '2'
and	a.ie_tipo_item <> '11'
and	coalesce(e.ie_mensalidade_mes_anterior,'N')	= 'N'
group by	trunc(e.dt_contabilizacao,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(d.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	sum(a.vl_tributo) vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	null ie_tipo_vinculo_operadora,
	c.ie_cancelamento,
	null ie_tipo_item,
	d.dt_geracao_nf
from	nota_fiscal_trib	a,
	nota_fiscal		b,
	pls_mensalidade		c,
	pls_lote_mensalidade	d
where	b.nr_sequencia		= a.nr_sequencia
and	c.nr_sequencia		= b.nr_seq_mensalidade
and	d.nr_sequencia		= c.nr_seq_lote
and	d.ie_status = '2'
and	coalesce(d.ie_mensalidade_mes_anterior,'N') = 'N'
group by	trunc(d.dt_mesano_referencia,'month'),
		c.ie_cancelamento,
		d.dt_geracao_nf

UNION ALL

select	trunc(d.dt_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	sum(a.vl_item) vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
FROM pls_lote_mensalidade e, pls_mensalidade d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_tipo_lanc_adic f ON (a.nr_seq_tipo_lanc = f.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_mensalidade_seg  and c.nr_sequencia		= b.nr_seq_segurado and d.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= d.nr_seq_lote and e.ie_status = '2' and d.ie_cancelamento = 'C' and e.dt_contabilizacao is null and coalesce(e.ie_mensalidade_mes_anterior,'N') = 'N' and ((a.ie_tipo_item <> '20') or (a.ie_tipo_item = '20' and f.ie_considera_receita = 'S')) group by	trunc(d.dt_referencia,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(e.dt_mesano_referencia,'month') dt_mes_referencia,
	sum(a.vl_item) vl_mensalidade,
	CASE WHEN a.ie_tipo_item='3' THEN sum(a.vl_item)  ELSE 0 END  vl_coparticipacao,
	CASE WHEN a.ie_tipo_item='3' THEN 0  ELSE sum(a.vl_item) END  vl_liq_sem_copartic,
	0 vl_antecipacao,
	CASE WHEN d.ie_cancelamento='C' THEN sum(a.vl_item)  ELSE 0 END ,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	CASE WHEN d.ie_cancelamento IS NULL THEN sum(CASE WHEN a.ie_tipo_item='20' THEN a.vl_item  ELSE 0 END )  ELSE 0 END  vl_manual,
	CASE WHEN d.ie_cancelamento IS NULL THEN sum(CASE WHEN a.ie_tipo_item='11' THEN a.vl_item  ELSE 0 END )  ELSE 0 END  vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
from	pls_mensalidade_seg_item 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_mensalidade			d,
	pls_lote_mensalidade		e
where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
and	c.nr_sequencia		= b.nr_seq_segurado
and	d.nr_sequencia		= b.nr_seq_mensalidade
and	e.nr_sequencia		= d.nr_seq_lote
and	e.ie_status = '2'
and	coalesce(e.ie_mensalidade_mes_anterior,'N') = 'S'
group by	trunc(e.dt_mesano_referencia,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(a.dt_antecipacao,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	sum(CASE WHEN e.dt_contabilizacao IS NULL THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao_rata_ant,
	0 vl_manual,
	0 vl_carteirinha,
	c.ie_tipo_vinculo_operadora,
	d.ie_cancelamento,
	a.ie_tipo_item,
	e.dt_geracao_nf
FROM pls_lote_mensalidade e, pls_mensalidade d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_tipo_lanc_adic f ON (a.nr_seq_tipo_lanc = f.nr_sequencia)
WHERE b.nr_sequencia		= a.nr_seq_mensalidade_seg and c.nr_sequencia		= b.nr_seq_segurado and d.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= d.nr_seq_lote  and e.ie_status = '2' and d.ie_cancelamento is null and coalesce(e.ie_mensalidade_mes_anterior,'N') = 'N' and ((a.ie_tipo_item not in ('20','11')) or (a.ie_tipo_item = '20' and f.ie_considera_receita = 'S')) group by	trunc(a.dt_antecipacao,'month'),
		a.ie_tipo_item,
		c.ie_tipo_vinculo_operadora,
		d.ie_cancelamento,
		e.dt_geracao_nf

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	CASE WHEN coalesce(e.ie_considera_despesa,'N')='S' THEN abs(d.vl_item)  ELSE d.vl_item END  vl_manual,
	0 vl_carteirinha,
	f.ie_tipo_vinculo_operadora,
	b.ie_cancelamento,
	d.ie_tipo_item,
	a.dt_geracao_nf
from	pls_mensalidade_seg_item 	d,
	pls_tipo_lanc_adic		e,
	pls_mensalidade_segurado 	c,
	pls_segurado			f,
	pls_mensalidade			b,
	pls_lote_mensalidade		a
where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	d.nr_seq_tipo_lanc	= e.nr_sequencia
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	f.nr_sequencia	= c.nr_seq_segurado
and	a.nr_sequencia	= b.nr_seq_lote
and	d.ie_tipo_item	= '20'
and	e.ie_considera_receita = 'N'
and	((b.ie_cancelamento is null) or (coalesce(e.ie_considera_despesa,'N') = 'S'))
and	a.ie_status	= '2'
and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'

UNION ALL

select	trunc(c.dt_mesano_referencia,'month') dt_mes_referencia,
	0 vl_mensalidade,
	0 vl_coparticipacao,
	0 vl_liq_sem_copartic,
	0 vl_antecipacao,
	0 vl_cancelado,
	0 vl_imposto,
	0 vl_antec_pro_rata,
	0 vl_antecipacao_rata_ant,
	0 vl_manual,
	sum(d.vl_item) vl_carteirinha,
	e.ie_tipo_vinculo_operadora,
	b.ie_cancelamento,
	d.ie_tipo_item,
	a.dt_geracao_nf
from	pls_mensalidade_seg_item d,
	pls_mensalidade_segurado c,
	pls_segurado		e,
	pls_mensalidade		b,
	pls_lote_mensalidade	a
where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
and	e.nr_sequencia	= c.nr_seq_segurado
and	b.nr_sequencia	= c.nr_seq_mensalidade
and	a.nr_sequencia	= b.nr_seq_lote
and	d.ie_tipo_item	= '11'
and	b.ie_cancelamento is null
and	a.ie_status	= '2'
and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
group by	trunc(c.dt_mesano_referencia,'month'),
		d.ie_tipo_item,
		e.ie_tipo_vinculo_operadora,
		b.ie_cancelamento,
		a.dt_geracao_nf;

