-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_per_benef_cons_v (dt_mes_competencia, ie_tipo_grupo_ans, ie_tipo_segurado, qt_benef_atendido, qt_beneficiarios) AS select	dt_mes_competencia,
	ie_tipo_grupo_ans,
	ie_tipo_segurado,
	qt_benef_atendido,
	qt_beneficiarios
FROM	(
	with benef_w as (select	count(*) qt_benef_atendido,
				dt_mes_competencia,
				ie_tipo_grupo_ans,
				ie_tipo_segurado
			from (select	distinct c.nr_seq_segurado,
					pkg_date_utils.start_of(cp.dt_procedimento,'MONTH') dt_mes_competencia,
					h.ie_tipo_grupo_ans,
					s.ie_tipo_segurado
				from	pls_conta_proc cp,
					pls_conta c,
					pls_protocolo_conta p,
					ans_grupo_despesa h,
					pls_segurado s
				where	c.nr_sequencia = cp.nr_seq_conta
				and	cp.nr_seq_grupo_ans = h.nr_sequencia
				and	c.nr_seq_protocolo = p.nr_sequencia
				and	c.nr_seq_segurado is not null
				and	c.nr_seq_segurado = s.nr_sequencia
				and	c.cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento, c.cd_estabelecimento)) alias3
			group by dt_mes_competencia, ie_tipo_grupo_ans, ie_tipo_segurado)
	select	p.dt_mes_competencia dt_mes_competencia,
		p.ie_tipo_grupo_ans,
		(select	count(*)
		from	pls_segurado s,
			pessoa_fisica f
		where	s.cd_pessoa_fisica = f.cd_pessoa_fisica
		and	s.nr_seq_segurado_ant is null
		and	s.nr_seq_segurado_mig is null
		and	s.dt_liberacao is not null
		and	s.ie_tipo_segurado = p.ie_tipo_segurado
		and	pkg_date_utils.start_of(s.dt_contratacao, 'MONTH') <= p.dt_mes_competencia
		and	coalesce(pkg_date_utils.start_of(s.dt_rescisao, 'MONTH'),p.dt_mes_competencia) >= p.dt_mes_competencia)	 qt_beneficiarios,
		max(p.qt_benef_atendido) qt_benef_atendido,
		p.ie_tipo_segurado
	from	benef_w p
	group by p.dt_mes_competencia, p.ie_tipo_grupo_ans, p.ie_tipo_segurado
	) alias11
group by dt_mes_competencia, ie_tipo_grupo_ans, ie_tipo_segurado, qt_benef_atendido, qt_beneficiarios;

