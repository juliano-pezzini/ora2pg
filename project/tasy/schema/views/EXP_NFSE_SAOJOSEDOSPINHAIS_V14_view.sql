-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_saojosedospinhais_v14 (tp_registro, nr_nota_fiscal, cd_serie_nf, dt_emissao, tp_nota, vl_nota, ds_atividade, ds_sigla_pais, ds_empresa, ds_inf_gerais_empresa, ds_local_servico) AS select	'F' tp_registro,												--Indicador de Registro 
	lpad(n.nr_nota_fiscal,10,0) nr_nota_fiscal,									--Número da Nota Fiscal inicial 
	lpad(n.cd_serie_nf,10,' ') cd_serie_nf,										--Série da Nota Fiscal 
	n.dt_emissao dt_emissao,											--Data da emissão da Nota Fiscal 
	'6' tp_nota,													--Tipo da Nota Fiscal 
	lpad(somente_numero(CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  	CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END ),12,'0') vl_nota,					--Valor da Nota Fiscal 
	lpad(' ',10,' ') ds_atividade,											--Atividade ou serviço prestado	 
	obter_dados_pais(coalesce(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NP'), obter_dados_pf_pj(null, n.cd_cgc, 'P')), 'SG') ds_sigla_pais, --Sigla do país 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'N'),' '),100,' ') ds_empresa, 				--Nome da empresa 
	lpad(' ',100,' ') ds_inf_gerais_empresa, 									--Informações gerais sobre a empresa 
	'D' ds_local_servico 												--Local de prestação do serviço		 
FROM	nota_fiscal n,
	operacao_nota o 
where	o.cd_operacao_nf = n.cd_operacao_nf 
and	o.ie_operacao_fiscal = 'E' 
and	o.ie_servico = 'S' 
and	upper(coalesce(obter_dados_pais(coalesce(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NP'), obter_dados_pf_pj(null, n.cd_cgc, 'P')), 'SG'),'BR')) <> 'BR' 
and	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia);

