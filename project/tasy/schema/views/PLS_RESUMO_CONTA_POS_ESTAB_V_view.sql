-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_conta_pos_estab_v (ie_ordem, ie_ordem_titulo, nr_sequencia, nr_seq_conta, nr_seq_item, ds_item_despesa, cd_item, ds_tipo_despesa, ds_via_aces, nr_seq_prestador_exec, nm_prestador_exec, dt_item, ds_grau_part, ie_origem_proced, nr_seq_grau_partic, tx_item, qt_apresentado, qt_liberado, vl_unitario, vl_total, vl_unitario_apres, vl_total_apres, vl_calculado, ds_guia, nr_seq_conta_referencia, nr_guia, nr_seq_apres, ie_status_item, ie_situacao, ie_ocorrencia_glosa, nr_seq_protocolo, nm_prestador_pagamento, ie_status_conta, ds_status_conta, ds_seq_analise, nr_seq_mot_liberacao, cd_material, cd_porte_anestesico, nr_auxiliares, ie_tipo_despesa, nr_seq_guia, ie_autorizado, cd_classificacao_sip, cd_classif_cred, cd_classif_deb, ie_tipo_item, ie_carater_internacao, ie_exige_nf, cd_guia, ie_tipo_guia, nr_seq_res_conta_princ, nr_seq_analise, nr_seq_prestador_solic, nm_prestador_solic, ie_via_acesso, ds_fornecedor, ie_pagamento, nr_identificador, nr_seq_grupo_item, nr_seq_prestador_pgto, nr_seq_cbo_saude, nr_seq_item_ref, vl_uni_calculado, ds_item_despesa_order, nr_seq_apres_prof, ds_setor_atendimento, ds_unidade_medida, nr_seq_partic_proc, ie_tipo_glosa, ds_item_importacao, ds_medico_executor, cd_tiss, ie_faturamento, nr_seq_regra_preco_pos, nr_seq_pos_estab_interc, nr_seq_conta_proc, nr_seq_conta_mat, cd_item_convertido, ds_item_convertido) AS select	CASE WHEN ds_tipo_despesa='P1' THEN '1' WHEN ds_tipo_despesa='P2' THEN '3' WHEN ds_tipo_despesa='P3' THEN '2' WHEN ds_tipo_despesa='P4' THEN '4' WHEN ds_tipo_despesa='R1' THEN '1' WHEN ds_tipo_despesa='R2' THEN '3' WHEN ds_tipo_despesa='R3' THEN '2' WHEN ds_tipo_despesa='R4' THEN '4' WHEN ds_tipo_despesa='M1' THEN '6' WHEN ds_tipo_despesa='M2' THEN '5' WHEN ds_tipo_despesa='M3' THEN '7' END  ie_ordem,
	0 ie_ordem_titulo, 
	null nr_sequencia, 
	null nr_seq_conta, 
	null nr_seq_item, 
	substr(pls_obter_desc_item_desp(ds_tipo_despesa, 'P'),1,255) ds_item_despesa, 
	null cd_item, 
	ds_tipo_despesa, 
	null ds_via_aces, 
	null nr_seq_prestador_exec, 
	null nm_prestador_exec, 
	null dt_item,	 
	null ds_grau_part, 
	null ie_origem_proced, 
	null nr_seq_grau_partic, 
	null tx_item, 
	null qt_apresentado, 
	null qt_liberado, 
	null vl_unitario, 
	null vl_total, 
	null vl_unitario_apres,    
	null vl_total_apres,  
	null vl_calculado, 
	null ds_guia, 
	null nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	0 nr_seq_apres, 
	null ie_status_item, 
	null ie_situacao, 
	null ie_ocorrencia_glosa, 
	null nr_seq_protocolo, 
	null nm_prestador_pagamento, 
	null ie_status_conta, 
	null ds_status_conta, 
	null ds_seq_analise, 
	null nr_seq_mot_liberacao, 
	null cd_material, 
	null cd_porte_anestesico, 
	null nr_auxiliares, 
	ie_tipo_despesa, 
	null nr_seq_guia, 
	null ie_autorizado, 
	null cd_classificacao_sip, 
	null cd_classif_cred, 
	null cd_classif_deb, 
	null ie_tipo_item, 
	null ie_carater_internacao, 
	null ie_exige_nf, 
	null cd_guia, 
	null ie_tipo_guia, 
	null nr_seq_res_conta_princ, 
	nr_seq_analise nr_seq_analise, 
	null nr_seq_prestador_solic, 
	null nm_prestador_solic, 
	null ie_via_acesso, 
	'' ds_fornecedor, 
	null ie_pagamento, 
	null nr_identificador, 
	null nr_seq_grupo_item, 
	null nr_seq_prestador_pgto, 
	null nr_seq_cbo_saude, 
	null nr_seq_item_ref, 
	null vl_uni_calculado, 
	null ds_item_despesa_order, 
	null nr_seq_apres_prof, 
	null ds_setor_atendimento, 
	null ds_unidade_medida, 
	null nr_seq_partic_proc, 
	null ie_tipo_glosa, 
	null ds_item_importacao, 
	null ds_medico_executor, 
	null cd_tiss, 
	null ie_faturamento, 
	null nr_seq_regra_preco_pos, 
	null nr_seq_pos_estab_interc, 
	null nr_seq_conta_proc, 
	null nr_seq_conta_mat, 
	null cd_item_convertido, 
	null ds_item_convertido 
FROM	w_pls_resumo_conta y 
where	ie_tipo_item <> 'R' 
and	ie_tipo_guia <> 6 
group by ds_tipo_despesa, 
	 cd_item, 
	 dt_item, 
	 dt_inicio_item, 
	 ie_origem_proced, 
	 nr_seq_analise, 
	 ie_tipo_despesa, 
	 nr_seq_analise, 
	 ds_item, 
	 ie_tipo_guia, 
	 nr_seq_item_ref, 
	 ie_custo_operacional, 
	 cd_guia_referencia, 
	 cd_guia 

union
 
/*procedimento/material*/
 
select	CASE WHEN ds_tipo_despesa='P1' THEN '1' WHEN ds_tipo_despesa='P2' THEN '3' WHEN ds_tipo_despesa='P3' THEN '2' WHEN ds_tipo_despesa='P4' THEN '4' WHEN ds_tipo_despesa='R1' THEN '1' WHEN ds_tipo_despesa='R2' THEN '3' WHEN ds_tipo_despesa='R3' THEN '2' WHEN ds_tipo_despesa='R4' THEN '4' WHEN ds_tipo_despesa='M1' THEN '6' WHEN ds_tipo_despesa='M2' THEN '5' WHEN ds_tipo_despesa='M3' THEN '7' END  ie_ordem, 
	1 ie_ordem_titulo, 
	nr_sequencia, 
	nr_seq_conta, 
	nr_seq_item,	 
	substr('    ' ||CASE WHEN ie_custo_operacional='S' THEN  '     '||nm_prestador  ELSE CASE WHEN coalesce(coalesce(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),cd_item),0)=0 THEN InitCap(pls_obter_desc_item_desp(ds_tipo_despesa, 'S'))||' não reconhecido.'  ELSE ds_item END  END ,1,255) ds_item_despesa, 
	cd_item, 
	ds_tipo_despesa, 
	ds_via_acesso ds_via_aces, 
	nr_seq_prestador_exec, 
	nm_prestador nm_prestador_exec, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	ds_grau_participacao ds_grau_part, 
	ie_origem_proced, 
	nr_seq_grau_partic, 
	tx_item, 
	qt_apresentado, 
	qt_liberado, 
	vl_unitario, 
	vl_total, 
	vl_unitario_apres,    
	vl_total_apres, 
	vl_calculado, 
	ds_tipo_guia ds_guia, 
	nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	1 nr_seq_apres, 
	ie_status ie_status_item, 
	ie_situacao, 
	ie_ocorrencia_glosa, 
	nr_seq_protocolo, 
	nm_prestador_pagamento, 
	ie_status_conta, 
	ds_status_conta, 
	nr_seq_analise ds_seq_analise, 
	nr_seq_mot_liberacao, 
	substr(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),1,20) cd_material, 
	cd_porte_anestesico, 
	nr_auxiliares, 
	ie_tipo_despesa, 
	nr_seq_guia, 
	ie_autorizado, 
	cd_classificacao_sip, 
	cd_classif_cred, 
	cd_classif_deb, 
	ie_tipo_item, 
	ie_carater_internacao, 
	ie_exige_nf, 
	cd_guia, 
	ie_tipo_guia, 
	nr_seq_res_conta_princ, 
	nr_seq_analise, 
	nr_seq_prestador_solic, 
	nm_prestador_solic, 
	ie_via_acesso, 
	ds_fornecedor, 
	ie_pagamento, 
	nr_identificador, 
	nr_seq_grupo_item, 
	nr_seq_prestador_pgto, 
	nr_seq_cbo_saude, 
	nr_seq_item_ref, 
	dividir_sem_round(vl_calculado, qt_apresentado) vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	nr_seq_apres_prof, 
	ds_setor_atendimento, 
	CASE WHEN ie_tipo_item='M' THEN  substr(pls_obter_dados_material(cd_item,'UM'),1,255)  ELSE null END  ds_unidade_medida, 
	nr_seq_partic_proc, 
	pls_obter_ie_valor_glosa(nr_seq_item, ie_tipo_item) ie_tipo_glosa, 
	ds_item_importacao, 
	CASE WHEN ie_tipo_item='P' THEN  substr(cd_medico_executor||' - '||obter_nome_pf(cd_medico_executor),1,255)  ELSE null END  ds_medico_executor, 
	null cd_tiss, 
	ie_faturamento, 
	nr_seq_regra_preco_pos, 
	nr_seq_pos_estab_interc, 
	nr_seq_conta_proc, 
	nr_seq_conta_mat, 
	cd_item_convertido, 
	ds_item_convertido 
from	w_pls_resumo_conta 
where	ie_tipo_item <> 'R' 
and	ie_tipo_guia <> 6 

union
 
select	CASE WHEN ds_tipo_despesa='P1' THEN '1' WHEN ds_tipo_despesa='P2' THEN '3' WHEN ds_tipo_despesa='P3' THEN '2' WHEN ds_tipo_despesa='P4' THEN '4' WHEN ds_tipo_despesa='R1' THEN '1' WHEN ds_tipo_despesa='R2' THEN '3' WHEN ds_tipo_despesa='R3' THEN '2' WHEN ds_tipo_despesa='R4' THEN '4' WHEN ds_tipo_despesa='M1' THEN '6' WHEN ds_tipo_despesa='M2' THEN '5' WHEN ds_tipo_despesa='M3' THEN '7' END  ie_ordem, 
	1 ie_ordem_titulo, 
	null nr_sequencia, 
	null nr_seq_conta, 
	null nr_seq_item,	 
	substr('     ' ||CASE WHEN coalesce(coalesce(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),cd_item),0)=0 THEN InitCap(pls_obter_desc_item_desp(ds_tipo_despesa, 'S'))||' não reconhecido.'  ELSE ds_item END ,1,255) ds_item_despesa, 
	cd_item, 
	ds_tipo_despesa, 
	null ds_via_aces, 
	null nr_seq_prestador_exec, 
	null nm_prestador_exec, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	null ds_grau_part, 
	ie_origem_proced, 
	null nr_seq_grau_partic, 
	null tx_item, 
	(	select	coalesce(sum(x.qt_apresentado),0) 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) qt_apresentado, 
	null qt_liberado, 
	(	select	coalesce(sum(x.vl_unitario),0) 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_unitario, 
	(	select	coalesce(sum(x.vl_total),0) 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_total, 
	(	select	coalesce(sum(x.vl_unitario_apres),0) 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_unitario_apres,    
	(	select	coalesce(sum(x.vl_total_apres),0)	 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_total_apres, 
	(	select	coalesce(sum(x.vl_calculado),0) 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_calculado, 
	null ds_guia, 
	null nr_seq_conta_referencia, 
	null nr_guia, 
	CASE WHEN ie_custo_operacional='S' THEN  0  ELSE 1 END  nr_seq_apres, 
	'I' ie_status_item, 
	null ie_situacao, 
	null ie_ocorrencia_glosa, 
	null nr_seq_protocolo, 
	null nm_prestador_pagamento, 
	null ie_status_conta, 
	null ds_status_conta, 
	nr_seq_analise ds_seq_analise, 
	null nr_seq_mot_liberacao, 
	null cd_material, 
	null cd_porte_anestesico, 
	null nr_auxiliares, 
	ie_tipo_despesa, 
	null nr_seq_guia, 
	null ie_autorizado, 
	null cd_classificacao_sip, 
	null cd_classif_cred, 
	null cd_classif_deb, 
	'P' ie_tipo_item, 
	null ie_carater_internacao, 
	null ie_exige_nf, 
	null cd_guia, 
	ie_tipo_guia, 
	null nr_seq_res_conta_princ, 
	nr_seq_analise, 
	null nr_seq_prestador_solic, 
	null nm_prestador_solic, 
	null ie_via_acesso, 
	null ds_fornecedor, 
	pls_obter_status_item_inf(nr_seq_item_ref, nr_seq_analise) ie_pagamento, 
	null nr_identificador, 
	null nr_seq_grupo_item, 
	null nr_seq_prestador_pgto, 
	null nr_seq_cbo_saude, 
	nr_seq_item_ref, 
	(	select	sum(dividir_sem_round(x.vl_calculado, x.qt_apresentado))	 
		from	w_pls_resumo_conta x 
		where	x.nr_seq_item_ref = a.nr_seq_item_ref 
		and	x.nr_seq_analise = a.nr_seq_analise	) vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	null nr_seq_apres_prof, 
	null ds_setor_atendimento, 
	null ds_unidade_medida, 
	null nr_seq_partic_proc, 
	null ie_tipo_glosa, 
	null ds_item_importacao, 
	null ds_medico_executor, 
	null cd_tiss, 
	pls_obter_status_fat_item(nr_seq_item_ref, nr_seq_analise) ie_faturamento, 
	null nr_seq_regra_preco_pos, 
	null nr_seq_pos_estab_interc, 
	null nr_seq_conta_proc, 
	null nr_seq_conta_mat, 
	cd_item_convertido, 
	ds_item_convertido 
from	w_pls_resumo_conta a 
where	(((ie_tipo_guia = '6') 
and (not exists (	select	y.nr_sequencia 
				from	pls_conta_proc	x, 
					pls_conta	y 
				where	y.nr_sequencia	= x.nr_seq_conta 
				and	x.nr_sequencia	= a.nr_seq_item_ref 
				and	y.ie_tipo_guia = 5  
			 LIMIT 1))) 
or (ie_custo_operacional = 'S')) 
and	ie_tipo_item not in ('R','M') 

union
 
select	CASE WHEN ds_tipo_despesa='P1' THEN '1' WHEN ds_tipo_despesa='P2' THEN '3' WHEN ds_tipo_despesa='P3' THEN '2' WHEN ds_tipo_despesa='P4' THEN '4' WHEN ds_tipo_despesa='R1' THEN '1' WHEN ds_tipo_despesa='R2' THEN '3' WHEN ds_tipo_despesa='R3' THEN '2' WHEN ds_tipo_despesa='R4' THEN '4' WHEN ds_tipo_despesa='M1' THEN '6' WHEN ds_tipo_despesa='M2' THEN '5' WHEN ds_tipo_despesa='M3' THEN '7' END  ie_ordem, 
	1 ie_ordem_titulo, 
	nr_sequencia, 
	nr_seq_conta, 
	nr_seq_item,	 
	substr('         ' ||nm_participante,1,255) ds_item_despesa, 
	cd_item, 
	ds_tipo_despesa, 
	ds_via_acesso ds_via_aces, 
	nr_seq_prestador_exec, 
	nm_prestador nm_prestador_exec, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	ds_grau_participacao ds_grau_part, 
	ie_origem_proced, 
	nr_seq_grau_partic, 
	tx_item, 
	qt_apresentado, 
	qt_liberado, 
	vl_unitario, 
	vl_total, 
	vl_unitario_apres,    
	vl_total_apres, 
	vl_calculado, 
	ds_tipo_guia ds_guia, 
	nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	2 nr_seq_apres, 
	ie_status ie_status_item, 
	ie_situacao, 
	ie_ocorrencia_glosa, 
	nr_seq_protocolo, 
	nm_prestador_pagamento, 
	ie_status_conta, 
	ds_status_conta, 
	nr_seq_analise ds_seq_analise, 
	nr_seq_mot_liberacao, 
	substr(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),1,20) cd_material, 
	cd_porte_anestesico, 
	nr_auxiliares, 
	ie_tipo_despesa, 
	nr_seq_guia, 
	ie_autorizado, 
	cd_classificacao_sip, 
	cd_classif_cred, 
	cd_classif_deb, 
	ie_tipo_item, 
	ie_carater_internacao, 
	ie_exige_nf, 
	cd_guia, 
	ie_tipo_guia, 
	nr_seq_res_conta_princ, 
	nr_seq_analise, 
	nr_seq_prestador_solic, 
	nm_prestador_solic, 
	ie_via_acesso, 
	ds_fornecedor, 
	ie_pagamento, 
	nr_identificador, 
	nr_seq_grupo_item, 
	nr_seq_prestador_pgto, 
	nr_seq_cbo_saude, 
	nr_seq_item_ref, 
	dividir_sem_round(vl_calculado, qt_apresentado) vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	nr_seq_apres_prof, 
	ds_setor_atendimento, 
	CASE WHEN ie_tipo_item='M' THEN  substr(pls_obter_dados_material(cd_item,'UM'),1,255)  ELSE null END  ds_unidade_medida, 
	nr_seq_partic_proc, 
	pls_obter_ie_valor_glosa(nr_seq_item, ie_tipo_item) ie_tipo_glosa, 
	ds_item_importacao, 
	CASE WHEN ie_tipo_item='P' THEN  substr(cd_medico_executor||' - '||obter_nome_pf(cd_medico_executor),1,255)  ELSE null END  ds_medico_executor, 
	pls_obter_cd_tiss_participacao(nr_seq_grau_partic) cd_tiss, 
	ie_faturamento, 
	nr_seq_regra_preco_pos, 
	nr_seq_pos_estab_interc, 
	nr_seq_conta_proc, 
	nr_seq_conta_mat, 
	cd_item_convertido, 
	ds_item_convertido 
from	w_pls_resumo_conta 
where	ie_tipo_item = 'R';

