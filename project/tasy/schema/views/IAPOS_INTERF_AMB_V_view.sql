-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW iapos_interf_amb_v (tp_registro, cd_item_cab, cd_regional, cd_interno, dt_remessa, qt_conta, vl_total_conta, qt_conta_inter, vl_total_conta_inter, ds_blanco, nr_interno_conta, dt_periodo_inicial, cd_usuario_convenio, ie_tipo_documento_4, nr_documento, nm_paciente, ie_tipo_documento_5, nr_ordem, dt_autorizacao, cd_medico_executor, nm_profissional_solicitante, cd_cid_principal, ds_observacao, cd_profissional_intervinientes, nm_profissional_intervinientes, ie_tipo_nomenclador, cd_item_det, ds_item, dt_entrada_unidade, qt_item, vl_importe, cd_faturamento, tx_item, ds_blanco_2, nr_seq_protocolo) AS SELECT	1 TP_REGISTRO,
        LPAD(coalesce(B.CD_INTERNO, 0), 5, 0) CD_ITEM_CAB,
        LPAD(coalesce(B.CD_REGIONAL, 0), 3, 0) CD_REGIONAL,
        LPAD(coalesce(MAX((select max(x.cd_externo) FROM convenio x where x.cd_convenio = B.CD_CONVENIO)), 0), 2, 0) CD_INTERNO,
        B.DT_REMESSA DT_REMESSA,
        LPAD(coalesce(MAX((select count(x.nr_interno_conta)
             from conta_paciente x,
             atendimento_paciente y
             where x.nr_atendimento = y.nr_atendimento
             and x.nr_seq_protocolo = B.NR_SEQ_PROTOCOLO
             and x.ie_cancelamento is null
             and y.IE_TIPO_ATENDIMENTO <> 1)),0), 7, 0) QT_CONTA,
        LPAD(coalesce(MAX(( select sum(c.VL_TOTAL_CONTA)
                 from atendimento_paciente x
                 where x.nr_atendimento = c.nr_atendimento
                 and x.IE_TIPO_ATENDIMENTO <> 1)), 0), 15, 0) VL_TOTAL_CONTA,
        LPAD(coalesce(MAX(( select count(x.nr_interno_conta)
                 from conta_paciente x,
                 atendimento_paciente y
                 where x.nr_atendimento = y.nr_atendimento
                 and x.nr_seq_protocolo = B.NR_SEQ_PROTOCOLO
                 and x.ie_cancelamento is null
                 and y.IE_TIPO_ATENDIMENTO = 1)), 0), 7, 0) QT_CONTA_INTER,
        LPAD(coalesce(MAX(( select sum(c.VL_TOTAL_CONTA)
                 from atendimento_paciente x
                 where x.nr_atendimento = c.nr_atendimento
                 and x.IE_TIPO_ATENDIMENTO = 1)), 0), 15, 0) VL_TOTAL_CONTA_INTER,
        RPAD('', 38, ' ') DS_BLANCO,
    	LPAD(A.NR_INTERNO_CONTA, 7, 0) NR_INTERNO_CONTA,
		null DT_PERIODO_INICIAL,
		'' CD_USUARIO_CONVENIO,
		'' IE_TIPO_DOCUMENTO_4,
		LPAD(0, 9, 0) NR_DOCUMENTO,
		'' NM_PACIENTE,
		'' IE_TIPO_DOCUMENTO_5,
		'' NR_ORDEM,
		null DT_AUTORIZACAO,
		'' CD_MEDICO_EXECUTOR,
		'' NM_PROFISSIONAL_SOLICITANTE,
		'' CD_CID_PRINCIPAL,
		'' DS_OBSERVACAO,
		'' CD_PROFISSIONAL_INTERVINIENTES,
		'' NM_PROFISSIONAL_INTERVINIENTES,
		'' IE_TIPO_NOMENCLADOR,
		LPAD(0, 7, 0) CD_ITEM_DET,
		'' DS_ITEM,
		null DT_ENTRADA_UNIDADE,
		LPAD(0, 5, 0) QT_ITEM,
		LPAD(0, 15, 0) VL_IMPORTE,
		'' CD_FATURAMENTO,
		LPAD(0, 3, 0) TX_ITEM,
		'' DS_BLANCO_2,
		A.NR_SEQ_PROTOCOLO
FROM 	W_INTERF_CONTA_CAB A,	
		W_INTERF_CONTA_HEADER B,
		W_INTERF_CONTA_TOTAL C
WHERE 	A.NR_SEQ_PROTOCOLO = B.NR_SEQ_PROTOCOLO
AND 	A.NR_INTERNO_CONTA = C.NR_INTERNO_CONTA
GROUP BY   B.CD_REGIONAL, B.CD_INTERNO, B.DT_REMESSA, A.NR_SEQ_PROTOCOLO, A.NR_INTERNO_CONTA

UNION ALL

SELECT 	2 TP_REGISTRO,
		'' CD_ITEM_CAB,
		'' CD_REGIONAL,
		'' CD_INTERNO,
		null DT_REMESSA,
        LPAD(0, 7, 0) QT_CONTA,
        LPAD(0, 15, 0) VL_TOTAL_CONTA,
        LPAD(0, 7, 0) QT_CONTA_INTER,
        LPAD(0, 15, 0) VL_TOTAL_CONTA_INTER,
		'' DS_BLANCO,
		LPAD(A.NR_INTERNO_CONTA, 7, 0) NR_INTERNO_CONTA,
		A.DT_PERIODO_INICIAL DT_PERIODO_INICIAL,
		LPAD(A.CD_USUARIO_CONVENIO, 15, 0) CD_USUARIO_CONVENIO,
		'DNI' IE_TIPO_DOCUMENTO_4,
		LPAD(A.NR_IDENTIDADE, 9, 0) NR_DOCUMENTO,
		RPAD(A.NM_PACIENTE, 30, ' ') NM_PACIENTE,
		RPAD('', 2, ' ') IE_TIPO_DOCUMENTO_5,
        LPAD(
            coalesce(( SELECT MAX(QT_BONUS_APRES)
                from PROCEDIMENTO_AUTORIZADO x
                where x.NR_SEQ_AUTORIZACAO = b.NR_SEQ_AUTORIZACAO
                and x.nr_atendimento = b.nr_atendimento),0),
        7,0) NR_ORDEM,
        B.DT_AUTORIZACAO,
        LPAD(B.NR_CRM_SOLICITANTE, 7, 0) CD_MEDICO_EXECUTOR,
        RPAD(B.NM_MEDICO_SOLICITANTE, 30, ' ') NM_PROFISSIONAL_SOLICITANTE,
        RPAD(A.CD_CID_PRINCIPAL, 30, ' ') CD_CID_PRINCIPAL,
        RPAD(A.DS_OBSERVACAO, 30, ' ') DS_OBSERVACAO,
        LPAD(coalesce(C.NR_CRM_EXECUTOR,0), 7, 0) CD_PROFISSIONAL_INTERVINIENTES,
        RPAD(C.NM_MEDICO_EXECUTOR, 30, ' ') NM_PROFISSIONAL_INTERVINIENTES,
        RPAD(CASE WHEN C.CD_AREA_PROC=1 THEN  'N'  ELSE 'G' END , 1, ' ') IE_TIPO_NOMENCLADOR,
        LPAD(C.CD_ITEM, 7, 0) CD_ITEM_DET,
        RPAD(C.DS_ITEM, 30, ' ') DS_ITEM,
        C.DT_ENTRADA_UNIDADE,
        LPAD(C.QT_ITEM, 5, 0) QT_ITEM,
        LPAD(C.VL_TOTAL_ITEM, 15, 0) VL_IMPORTE,
        RPAD('', 1, ' ') CD_FATURAMENTO,
        LPAD(C.PR_FATURADO, 3, 0) TX_ITEM,
        RPAD('', 7, ' ') DS_BLANCO_2,
		A.NR_SEQ_PROTOCOLO
FROM	W_INTERF_CONTA_CAB A,
		W_INTERF_CONTA_AUTOR B,
		W_INTERF_CONTA_ITEM C,
		W_INTERF_CONTA_TOTAL D
WHERE 	A.NR_INTERNO_CONTA = B.NR_INTERNO_CONTA
AND 	A.NR_INTERNO_CONTA = C.NR_INTERNO_CONTA
AND     A.NR_SEQ_PROTOCOLO = B.NR_SEQ_PROTOCOLO
AND 	A.NR_INTERNO_CONTA = D.NR_INTERNO_CONTA
AND coalesce(B.NR_SEQUENCIA,0) =
    (SELECT coalesce(MAX(Y.NR_SEQUENCIA),0)
    FROM W_INTERF_CONTA_AUTOR Y 
    WHERE A.NR_INTERNO_CONTA = Y.NR_INTERNO_CONTA)
;

