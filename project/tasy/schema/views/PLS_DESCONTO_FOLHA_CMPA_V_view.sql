-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_desconto_folha_cmpa_v (tp_registro, cd_matricula, nr_vinculo_pmpa, id_empresa, vl_pago, nr_seq_cobranca, dt_referencia, nr_seq_empresa, nr_seq_pagador, especie, ie_empresa, cd_cgc) AS select	1				TP_REGISTRO,
	substr(d.cd_matricula,1,7)	CD_MATRICULA,
	d.nr_seq_vinculo_empresa	NR_VINCULO_PMPA,
	CASE WHEN d.nr_seq_empresa='80' THEN '7'  ELSE d.nr_seq_empresa END 		ID_EMPRESA,
	obter_Valor_sem_virgula(a.vl_cobranca) VL_PAGO,
	a.nr_seq_cobranca		NR_SEQ_COBRANCA,
	e.dt_remessa_retorno		DT_REFERENCIA,
	f.nr_sequencia			NR_SEQ_EMPRESA,
	d.nr_seq_pagador		NR_SEQ_PAGADOR,
	' '				ESPECIE,
	f.ie_empresa			IE_EMPRESA,
	f.cd_cgc			CD_CGC
FROM	titulo_receber_cobr		a,
	pls_mensalidade			b,
	pls_contrato_pagador		c,
	pls_contrato_pagador_fin	d,
	cobranca_escritural		e,
	pls_desc_empresa		f,
	titulo_receber			h
where	h.nr_seq_mensalidade	= b.nr_sequencia
and	h.nr_titulo		= a.nr_titulo
and	b.nr_seq_pagador	= c.nr_sequencia
and	d.nr_seq_pagador	= c.nr_sequencia
and	LOCALTIMESTAMP	between coalesce(d.dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(d.dt_fim_vigencia,LOCALTIMESTAMP)
and	a.nr_seq_cobranca	= e.nr_sequencia
and	e.nr_seq_empresa	= f.nr_sequencia
and	a.nr_seq_mensalidade	= b.nr_sequencia
and	e.ie_remessa_retorno	= 'R'
order by	tp_registro,
		f.ie_empresa desc,
		nr_vinculo_pmpa,
		(cd_matricula)::numeric;

