-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_envio_topazio_ub_v (nr_seq_protocolo, cd_convenio, tp_registro, ie_disquete, cd_tipo_registro, cd_federacao, nr_lote, cd_prestador, nr_seq_conta, nm_singular, ie_prestador, cd_cgc_hospital, nm_prestador, dt_remessa, nr_remessa, ds_espaco, nr_registro, nm_paciente, ie_sexo, dt_nascimento, nr_prontuario, cd_plano, cd_usuario, nm_convenio, qt_zeros, ie_tipo_nota, nr_nota, nr_conta_ambulat, tp_conta_origem, nr_conta_origem, cd_natureza, dt_competencia, ie_tipo_paciente, cd_tipo_atendimento, cd_classe_atend, cd_tipo_acomodacao, dt_entrada, hr_entrada, dt_saida, hr_saida, cd_motivo_alta, cd_cid, nr_crm, ds_uf_crm, nm_medico_resp, nr_crm_req, ds_uf_req, nm_medico_req, cd_medico_req, dt_req_assinada, cd_tipo_nasc, qt_eventos_nasc, qt_eventos_obito, nr_seq_autorizacao, cd_proc_autorizado, ds_proc_autorizado, cd_acomod_autorizado, qt_proc_autorizado, nr_guia, dt_guia, ds_senha, nm_autorizador, nr_seq_item_conta, cd_prest_exec, dt_procedimento, hr_procedimento, cd_funcao_executor, nr_porte_anestesico, ds_item, nr_crm_req_exa, nr_guia_exame, cd_prest_cobranca, cd_item, cd_unidade_medida, qt_item, qt_ch, vl_ch, vl_unitario, vl_total_item, ds_local_uso, cd_proc_referencia, cd_via_acesso, ie_tipo_item, qt_diarias_normais, qt_diarias_uti, qt_participantes, vl_honorarios, vl_diarias_normais, vl_diarias_uti, vl_tot_servicos, vl_tot_medicamentos, vl_tot_materiais, vl_sadt, vl_filmes, vl_tot_conta, nr_fatura, qt_conta_lote, vl_total_lote, qt_conta_remessa, vl_total_remessa, nr_interno_conta, dt_validade_carteira, nr_cns, qt_nasc_prematuro, qt_obito_nasc_precoce, qt_obito_nasc_tardio, ie_motivo_obito_mulher, ie_regime_internacao, tp_internacao, ie_motivo_saida_internacao, id_int_obstetricia_1, id_int_obstetricia_2, id_int_obstetricia_3, id_int_obstetricia_4, id_int_obstetricia_5, id_int_obstetricia_6, id_int_obstetricia_7, id_int_obstetricia_8, id_int_obstetricia_9, tp_doenca, tempo_doenca, ie_periodo_doenca, indicacao_acidente, cd_cid_diagnostico_2, cd_cid_diagnostico_3, cd_cid_diagnostico_4, tp_consulta, tp_saida_consulta_sadt, cd_cid_obito, nr_declaracao_obito, hr_fim_realiz_proc, fator_participacao, vl_total_gases_med, tp_faturamento, cd_proc_principal, ie_ordem_exames, nr_conta_ambulat2) AS select
/* 	header remessa		*/
 
	a.nr_seq_protocolo				NR_SEQ_PROTOCOLO, 
	a.cd_convenio					CD_CONVENIO, 
	0 						tp_registro, 
	'FATOU' 					ie_disquete, 
	0 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	substr(obter_dados_pf_pj(null,a.cd_cgc_convenio,'N'),1,40) nm_singular, 
	'J' 						ie_prestador, 
	a.cd_cgc_hospital 				cd_cgc_hospital, 
	substr(a.nm_hospital,1,40) 			nm_prestador, 
	a.dt_remessa 					dt_remessa, 
	a.nr_remessa 					nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	0 						nr_nota, 
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	0 						nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
FROM	w_interf_conta_header 	a 

union all
 
select 
/* 	cabeçalho da conta 1		*/
 
	a.nr_seq_protocolo				NR_SEQ_PROTOCOLO, 
	a.cd_convenio					CD_CONVENIO, 
	1 						tp_registro, 
	'FATOU' 					ie_disquete, 
	1 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	substr(b.nm_paciente,1,40) 			nm_paciente, 
	b.ie_sexo					ie_sexo, 
	b.dt_nascimento					dt_nascimento, 
	somente_numero(substr(b.nr_prontuario,1,7)) 	nr_prontuario, 
	substr(b.cd_categoria_convenio,1,2) 		cd_plano, 
	substr(b.cd_usuario_convenio,1,16) 		cd_usuario, 
	substr(c.ds_convenio,1,35) 			nm_convenio, 
	0 						qt_zeros,	 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'IE_TIPO_NOTA', 
		coalesce(substr(OBTER_TIPO_GUIA_CONVENIO(b.nr_atendimento),1,1), CASE WHEN b.ie_tipo_atendimento=1 THEN 'I' WHEN b.ie_tipo_atendimento=7 THEN 'E' WHEN b.ie_tipo_atendimento=8 THEN 'A' END )) 
							ie_tipo_nota, 
--	nvl(somente_numero(b.nr_doc_convenio),0)	nr_nota,   
	somente_numero(CASE WHEN b.ie_tipo_atendimento=1 THEN  obter_guia_conta(b.nr_interno_conta)  ELSE b.nr_doc_convenio END )	 
							nr_nota, 
	0 						nr_conta_ambulat, 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem, 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	b.nr_interno_conta 				nr_interno_conta, 
	b.dt_validade_carteira 				dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	convenio 		c, 
	w_interf_conta_header 	a, 
	w_interf_conta_cab	b 
where	a.nr_seq_protocolo 	= b.nr_seq_protocolo 
and	b.cd_convenio		= c.cd_convenio 

union all
 
select 
/* 	cabeçalho da conta 2		*/
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	2 						tp_registro, 
	'FATOU' 					ie_disquete, 
	2 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	coalesce(somente_numero(b.nr_doc_convenio),0)	nr_nota,  
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	c.dt_mesano_referencia 				dt_competencia, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN 'I'  ELSE 'E' END  	ie_tipo_paciente, 
	somente_numero(obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_TIPO_ATENDIMENTO',substr(b.ie_tipo_atendimento,1,2)))				cd_tipo_atendimento, 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_CLASSE_ATEND', substr(ie_carater_inter,1,1)) 
							cd_classe_atend, 
	substr(cd_tipo_acomodacao,1,1) 			cd_tipo_acomodacao, 
	b.dt_entrada 					dt_entrada, 
	b.dt_entrada 					hr_entrada, 
	coalesce(b.dt_alta,b.dt_periodo_final)		dt_saida, 
	coalesce(b.dt_alta,b.dt_periodo_final)		hr_saida, 
	coalesce(to_char(b.cd_motivo_alta),'16') 		cd_motivo_alta, 
	coalesce(substr(b.cd_cid_principal,1,6),'   ') 	cd_cid, 
	somente_numero(coalesce(b.nr_crm_medico_resp,'0')) 	nr_crm, 
	coalesce(b.uf_crm_medico_resp,' ') 			ds_uf_crm, 
	substr(b.nm_medico_resp,1,40) 			nm_medico_resp, 
	somente_numero(coalesce(b.nr_crm_medico_resp,'0')) 	nr_crm_req, 
	coalesce(b.uf_crm_medico_resp,' ') 			ds_uf_req, 
	substr(b.nm_medico_resp,1,40) 			nm_medico_req, 
	substr(b.cd_conv_medico_resp,1,12) 		cd_medico_req, 
	b.dt_entrada 					dt_req_assinada, 
	coalesce(somente_numero(b.ie_tipo_nascimento),0) 	cd_tipo_nasc, 
	obter_dados_parto(b.nr_atendimento,'1')		qt_eventos_nasc, 
	obter_dados_parto(b.nr_atendimento,'2')		qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	b.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	CASE WHEN b.ie_tipo_nascimento=3 THEN 1  ELSE 0 END 		qt_nasc_prematuro, 
	CASE WHEN b.ie_tipo_nascimento=8 THEN 1  ELSE 0 END 		qt_obito_nasc_precoce, 
	CASE WHEN b.ie_tipo_nascimento=7 THEN 1  ELSE 0 END 		qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	1 						ie_regime_internacao, 
	CASE WHEN b.ie_clinica=3 THEN  CASE WHEN b.ie_tipo_atendimento=8 THEN  1  ELSE b.ie_clinica END   ELSE b.ie_clinica END  					tp_internacao, 
	b.cd_motivo_alta 				ie_motivo_saida_internacao, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'1'),1,1) ID_INT_OBSTETRICIA_1, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'2'),1,1) ID_INT_OBSTETRICIA_2, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'3'),1,1) ID_INT_OBSTETRICIA_3, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'4'),1,1) ID_INT_OBSTETRICIA_4, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'5'),1,1) ID_INT_OBSTETRICIA_5, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'6'),1,1) ID_INT_OBSTETRICIA_6, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'7'),1,1) ID_INT_OBSTETRICIA_7, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'8'),1,1) ID_INT_OBSTETRICIA_8, 
	substr(obter_dados_int_obstetrica(b.nr_atendimento,'9'),1,1) ID_INT_OBSTETRICIA_9,	 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	protocolo_convenio 	c, 
	w_interf_conta_header 	a, 
	w_interf_conta_cab b 
where	a.nr_seq_protocolo	= c.nr_seq_protocolo 
and	a.nr_seq_protocolo	= b.nr_seq_protocolo 

union all
 
select 
/* 	autorizações 		*/
	 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	3 						tp_registro, 
	'FATOU' 					ie_disquete, 
	3 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	somente_numero(coalesce(max(substr(b.cd_autorizacao,1,15)),' ')) nr_nota,  
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' '						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	coalesce(max(substr(c.cd_autorizacao,1,15)),' ') 	nr_guia, 
	max(b.dt_autorizacao) 				dt_guia, 
	max(substr(b.cd_senha,1,10)) 			ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	b.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	1 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	w_interf_conta_header 	a, 
	w_interf_conta_autor 	b, 
	conta_paciente		c 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 
and 	c.nr_interno_conta = b.nr_interno_conta 
group by b.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12) 

union all
 
select 
/* 	ítem da conta Proc medico */
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	4 						tp_registro, 
	'FATOU' 					ie_disquete, 
	4 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	coalesce(somente_numero(c.nr_doc_convenio),0)	nr_nota,  
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END  
				 			cd_prest_exec, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  dt_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  
							cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) 			nr_porte_anestesico, 
	substr(b.ds_item,1,70) 				ds_item, 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0) 
							nr_crm_req_exa, 
	coalesce(somente_numero(b.nr_doc_convenio),0) 	nr_guia_exame, 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END  
							cd_prest_cobranca, 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0) 
							cd_item, 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)) 		cd_unidade_medida, 
	SUM(b.qt_item) 					qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0						vl_unitario, 
	0						vl_total_item, 
	' ' 						ds_local_uso, 
	CASE WHEN c.ie_tipo_atendimento=8 THEN  CASE WHEN b.nr_seq_proc_princ IS NULL THEN  somente_numero('00010073')  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE CASE WHEN coalesce(somente_numero(b.ie_emite_conta),0)=72 THEN CASE WHEN b.nr_seq_proc_princ IS NULL THEN  		coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 		b.nr_interno_conta, 'C'),1,8)),0)  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE coalesce(b.cd_procedimento_ref,0) END  END  cd_proc_referencia, 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')) 
							cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  
							ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	c.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	sum(b.PR_FATURADO) 				FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	max(CASE WHEN coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 				b.nr_interno_conta, 'C'),1,8)),0)=b.cd_item THEN b.cd_item  ELSE 0 END ) cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
FROM w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo and b.nr_seq_protocolo	= c.nr_seq_protocolo and b.nr_interno_conta	= c.nr_interno_conta and coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  and b.ie_tipo_item		 = 1 and b.qt_item		 <> 0 and b.cd_item in (select 	x.cd_procedimento 
		   from 	estrutura_procedimento_v x 
		   where 	x.cd_area_procedimento in (1,4,11,13)) group by 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12), 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
	coalesce(b.nr_porte_anestesico,0), 
	substr(b.ds_item,1,70), 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END , 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0), 
	coalesce(somente_numero(b.nr_doc_convenio),0), 
	coalesce(somente_numero(c.nr_doc_convenio),0), 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)), 
	b.vl_unitario_item, 
	CASE WHEN c.ie_tipo_atendimento=8 THEN  CASE WHEN b.nr_seq_proc_princ IS NULL THEN  somente_numero('00010073')  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE CASE WHEN coalesce(somente_numero(b.ie_emite_conta),0)=72 THEN CASE WHEN b.nr_seq_proc_princ IS NULL THEN  		coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 		b.nr_interno_conta, 'C'),1,8)),0)  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE coalesce(b.cd_procedimento_ref,0) END  END , 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')), 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
	c.nr_interno_conta 
having sum(b.qt_item) <> 0 

union all
 
select 
/* 	ítem da conta exames,servicos*/
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	4 						tp_registro, 
	'FATOU' 					ie_disquete, 
	4 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	coalesce(somente_numero(c.nr_doc_convenio),0)	nr_nota,  
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END  
							cd_prest_exec, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  dt_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  
							cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) 			nr_porte_anestesico, 
	substr(b.ds_item,1,70) 				ds_item, 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0) 
							nr_crm_req_exa, 
	coalesce(somente_numero(b.nr_doc_convenio),0) 	nr_guia_exame, 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END  
							cd_prest_cobranca, 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0) 
							cd_item, 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)) 		cd_unidade_medida, 
	SUM(b.qt_item) 					qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0						vl_unitario, 
	0						vl_total_item, 
	' ' 						ds_local_uso, 
	CASE WHEN c.ie_tipo_atendimento=8 THEN  CASE WHEN b.nr_seq_proc_princ IS NULL THEN  somente_numero('00010073')  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE CASE WHEN coalesce(somente_numero(b.ie_emite_conta),0)=72 THEN CASE WHEN b.nr_seq_proc_princ IS NULL THEN  		coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 		b.nr_interno_conta, 'C'),1,8)),0)  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE coalesce(b.cd_procedimento_ref,0) END  END  cd_proc_referencia, 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')) 
							cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  
							ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	c.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	sum(b.PR_FATURADO)				FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	max(CASE WHEN coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 				b.nr_interno_conta, 'C'),1,8)),0)=b.cd_item THEN b.cd_item  ELSE 0 END ) cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
FROM w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo and b.nr_seq_protocolo	= c.nr_seq_protocolo and b.nr_interno_conta	= c.nr_interno_conta and coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  and b.qt_item			<> 0 AND coalesce(b.ie_tipo_item,0) <> 2 and b.cd_item not in (select x.cd_procedimento 
		     from 	estrutura_procedimento_v x 
		     where 	x.cd_area_procedimento in (1,4,11,13) 
			 AND 	b.cd_item NOT IN (SELECT x.cd_procedimento 
 				    	   	 FROM estrutura_procedimento_v x 
 					   	 WHERE x.cd_grupo_proc IN (7,4))) group by 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12), 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
	coalesce(b.nr_porte_anestesico,0), 
	substr(b.ds_item,1,70), 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END , 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0), 
	coalesce(somente_numero(b.nr_doc_convenio),0), 
	coalesce(somente_numero(c.nr_doc_convenio),0), 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)), 
	b.vl_unitario_item, 
	CASE WHEN c.ie_tipo_atendimento=8 THEN  CASE WHEN b.nr_seq_proc_princ IS NULL THEN  somente_numero('00010073')  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE CASE WHEN coalesce(somente_numero(b.ie_emite_conta),0)=72 THEN CASE WHEN b.nr_seq_proc_princ IS NULL THEN  		coalesce(somente_numero(substr(obter_proc_principal(b.nr_atendimento, b.cd_convenio, c.ie_tipo_atendimento, 		b.nr_interno_conta, 'C'),1,8)),0)  ELSE coalesce(b.cd_procedimento_ref,0) END   ELSE coalesce(b.cd_procedimento_ref,0) END  END , 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')), 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
	c.nr_interno_conta 
having 	sum(b.qt_item) <> 0 

union all
 
SELECT 
	/*Materiais e Medicamentos */
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	4 						tp_registro, 
	'FATOU' 					ie_disquete, 
	4 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	coalesce(somente_numero(c.nr_doc_convenio),0)	nr_nota, 
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END  
				 			cd_prest_exec, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  dt_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  
							cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) 			nr_porte_anestesico, 
	substr(b.ds_item,1,70) 				ds_item, 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0) 
							nr_crm_req_exa, 
	coalesce(somente_numero(b.nr_doc_convenio),0) 	nr_guia_exame, 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END  
							cd_prest_cobranca, 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0) 
							cd_item, 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)) 		cd_unidade_medida, 
	SUM(b.qt_item) 					qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	CASE WHEN sum(b.qt_item)=0 THEN 0 WHEN sum(b.qt_item)=Round(sum(b.vl_total_item) / sum(b.qt_item)) THEN 2 END  
							vl_unitario, 
	sum(b.vl_total_item) 				vl_total_item, 
	' ' 						ds_local_uso, 
	coalesce(b.cd_procedimento_ref,0) 			cd_proc_referencia, 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')) 
							cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  
							ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	c.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
FROM w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo and b.nr_seq_protocolo	= c.nr_seq_protocolo and b.nr_interno_conta	= c.nr_interno_conta and coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  and b.qt_item			<> 0 and (coalesce(b.ie_tipo_item,0) = 2) group by 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12), 
	CASE WHEN b.ie_total_interf=4 THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE CASE WHEN trim(both SUBSTR(b.cd_medico_exec_conv,1,12))='' THEN SUBSTR(a.cd_interno,1,12)  ELSE trim(both SUBSTR(b.cd_medico_exec_conv,1,12)) END  END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
	coalesce(b.nr_porte_anestesico,0), 
	substr(b.ds_item,1,70), 
	CASE WHEN b.ie_total_interf=4 THEN CASE WHEN Obter_se_setor_proprio(b.cd_setor_atendimento)='N' THEN substr(obter_cod_prestador(a.cd_interno,b.cd_setor_atendimento),1,12)  ELSE ' ' END   ELSE ' ' END , 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0), 
	coalesce(somente_numero(b.nr_doc_convenio),0), 
	coalesce(somente_numero(c.nr_doc_convenio),0), 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
	obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_UNIDADE_MEDIDA', substr(b.cd_unidade_medida,1,3)), 
	b.vl_unitario_item, 
	coalesce(b.cd_procedimento_ref,0), 
	obter_conversao_externa(c.cd_cgc_convenio, 'INTERF_ENVIO_TOPAZIO_UB_V', 'CD_VIA_ACESSO', coalesce(b.ie_via_acesso_inf,'0')), 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
	c.nr_interno_conta 
having 	sum(b.qt_item) <> 0 

union all
 
select 
/* 	total da conta		*/
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	5 						tp_registro, 
	'FATOU' 					ie_disquete, 
	5 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	substr(a.cd_interno,1,12)			cd_prestador, 
	0 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	somente_numero(d.cd_autorizacao)			nr_nota, 
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	obter_resumo_diaria(1,1,b.nr_interno_conta)	qt_diarias_normais, 
	obter_resumo_diaria(2,1,b.nr_interno_conta)	qt_diarias_uti, 
	coalesce(somente_numero(substr(b.qt_participantes,1,1)),0) 
							qt_participantes, 
	0 						vl_honorarios, 
	0						vl_diarias_normais, 
	0						vl_diarias_uti, 
	0						vl_tot_servicos, 
	b.vl_medicamentos 				vl_tot_medicamentos, 
	b.vl_materiais 					vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	(b.vl_materiais + b.vl_medicamentos)		vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	b.nr_interno_conta 				nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	CASE WHEN substr(obter_dados_atendimento(d.nr_atendimento,'DA'),1,20) IS NULL THEN 'P'  ELSE 'T' END  tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	w_interf_conta_header 	a, 
	w_interf_conta_total 	b, 
	conta_paciente		d 
where	b.nr_seq_protocolo		= a.nr_seq_protocolo 
and  	b.nr_interno_conta 		= d.nr_interno_conta 

union all
 
select 
/* 	fim de lote 	*/
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	6 						tp_registro, 
	'FATOU' 					ie_disquete, 
	6 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	0 						nr_lote, 
	'999999999999' 					cd_prestador, 
	99999 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	0 						nr_nota, 
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	to_char(b.nr_seq_protocolo) 			nr_fatura, 
	count(b.qt_total_conta) 			qt_conta_lote, 
	sum(c.vl_materiais + c.vl_medicamentos)		vl_total_lote, 
	0 						qt_conta_remessa, 
	0 						vl_total_remessa, 
	999999999 					nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	w_interf_conta_header 		a, 
	w_interf_conta_trailler 	b, 
	w_interf_conta_total		c 
where 	a.nr_seq_protocolo = b.nr_seq_protocolo 
and 	b.nr_seq_protocolo = c.nr_seq_protocolo 
group by a.cd_convenio, 
	a.nr_seq_protocolo, 
	to_char(b.nr_seq_protocolo), 
	somente_numero(a.cd_regional) 

union all
 
select 
/* 	trailler 	*/
 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	a.cd_convenio					cd_convenio, 
	9 						tp_registro, 
	'FATOU' 					ie_disquete, 
	9 						cd_tipo_registro, 
	somente_numero(a.cd_regional) 			cd_federacao, 
	9999 						nr_lote, 
	'999999999999' 					cd_prestador, 
	99999 						nr_seq_conta, 
	' ' 						nm_singular, 
	' ' 						ie_prestador, 
	' ' 						cd_cgc_hospital, 
	' ' 						nm_prestador, 
	LOCALTIMESTAMP 					dt_remessa, 
	0 						nr_remessa, 
	' ' 						ds_espaco, 
	0 						nr_registro, 
	' ' 						nm_paciente, 
	' ' 						ie_sexo, 
	LOCALTIMESTAMP 					dt_nascimento, 
	0 						nr_prontuario, 
	' ' 						cd_plano, 
	' ' 						cd_usuario, 
	' ' 						nm_convenio, 
	0 						qt_zeros, 
	'0' 						ie_tipo_nota, 
	0 						nr_nota, 
	0 						nr_conta_ambulat,	 
	' ' 						tp_conta_origem, 
	0 						nr_conta_origem,	 
	0 						cd_natureza,	 
	LOCALTIMESTAMP 					dt_competencia, 
	' ' 						ie_tipo_paciente, 
	0 						cd_tipo_atendimento, 
	' ' 						cd_classe_atend, 
	' ' 						cd_tipo_acomodacao, 
	LOCALTIMESTAMP 					dt_entrada, 
	LOCALTIMESTAMP 					hr_entrada, 
	LOCALTIMESTAMP 					dt_saida, 
	LOCALTIMESTAMP 					hr_saida, 
	' ' 						cd_motivo_alta, 
	' ' 						cd_cid, 
	0 						nr_crm, 
	' ' 						ds_uf_crm, 
	' ' 						nm_medico_resp, 
	0 						nr_crm_req, 
	' ' 						ds_uf_req, 
	' ' 						nm_medico_req, 
	' ' 						cd_medico_req, 
	LOCALTIMESTAMP 					dt_req_assinada, 
	0 						cd_tipo_nasc, 
	0 						qt_eventos_nasc, 
	0 						qt_eventos_obito, 
	0 						nr_seq_autorizacao, 
	0 						cd_proc_autorizado, 
	' ' 						ds_proc_autorizado, 
	' ' 						cd_acomod_autorizado, 
	0 						qt_proc_autorizado, 
	' ' 						nr_guia, 
	LOCALTIMESTAMP 					dt_guia, 
	' ' 						ds_senha, 
	' ' 						nm_autorizador, 
	0 						nr_seq_item_conta, 
	' ' 						cd_prest_exec, 
	LOCALTIMESTAMP 					dt_procedimento, 
	LOCALTIMESTAMP 					hr_procedimento, 
	' ' 						cd_funcao_executor, 
	0 						nr_porte_anestesico, 
	' ' 						ds_item, 
	0 						nr_crm_req_exa, 
	0 						nr_guia_exame, 
	' ' 						cd_prest_cobranca, 
	0 						cd_item, 
	' ' 						cd_unidade_medida, 
	0 						qt_item, 
	0 						qt_ch, 
	0 						vl_ch, 
	0 						vl_unitario, 
	0 						vl_total_item, 
	' ' 						ds_local_uso, 
	0 						cd_proc_referencia, 
	' ' 						cd_via_acesso, 
	0 						ie_tipo_item, 
	0 						qt_diarias_normais, 
	0 						qt_diarias_uti, 
	0 						qt_participantes, 
	0 						vl_honorarios, 
	0 						vl_diarias_normais, 
	0 						vl_diarias_uti, 
	0 						vl_tot_servicos, 
	0 						vl_tot_medicamentos, 
	0 						vl_tot_materiais, 
	0 						vl_sadt, 
	0 						vl_filmes, 
	0 						vl_tot_conta, 
	' ' 						nr_fatura, 
	0 						qt_conta_lote, 
	0 						vl_total_lote,	 
	count(b.qt_total_conta) 			qt_conta_remessa, 
	sum(c.vl_materiais + c.vl_medicamentos)		vl_total_remessa, 
	9999999999 					nr_interno_conta, 
	LOCALTIMESTAMP 					dt_validade_carteira, 
	0 						nr_cns, 
	0 						qt_nasc_prematuro, 
	0 						qt_obito_nasc_precoce, 
	0 						qt_obito_nasc_tardio, 
	0 						ie_motivo_obito_mulher, 
	0 						ie_regime_internacao, 
	0 						tp_internacao, 
	0 						ie_motivo_saida_internacao, 
	' ' 						ID_INT_OBSTETRICIA_1, 
	' ' 						ID_INT_OBSTETRICIA_2, 
	' ' 						ID_INT_OBSTETRICIA_3, 
	' ' 						ID_INT_OBSTETRICIA_4, 
	' ' 						ID_INT_OBSTETRICIA_5, 
	' ' 						ID_INT_OBSTETRICIA_6, 
	' ' 						ID_INT_OBSTETRICIA_7, 
	' ' 						ID_INT_OBSTETRICIA_8, 
	' ' 						ID_INT_OBSTETRICIA_9, 
	' ' 						tp_doenca, 
	0 						tempo_doenca, 
	' ' 						ie_periodo_doenca, 
	0 						indicacao_acidente, 
	' ' 						cd_cid_diagnostico_2, 
	' ' 						cd_cid_diagnostico_3, 
	' ' 						cd_cid_diagnostico_4, 
	0 						tp_consulta, 
	0 						tp_saida_consulta_sadt, 
	' ' 						cd_cid_obito, 
	0 						nr_declaracao_obito, 
	LOCALTIMESTAMP 					HR_FIM_REALIZ_PROC, 
	0 						FATOR_PARTICIPACAO, 
	0 						vl_total_gases_med, 
	' ' 						tp_faturamento, 
	0						cd_proc_principal, 
	0						ie_ordem_exames, 
	0 						nr_conta_ambulat2 
from	w_interf_conta_header 		a, 
	w_interf_conta_trailler 	b, 
	w_interf_conta_total		c 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 
and 	b.nr_seq_protocolo	=	c.nr_seq_protocolo 
group by a.cd_convenio, 
	a.nr_seq_protocolo, 
	somente_numero(a.cd_regional);

