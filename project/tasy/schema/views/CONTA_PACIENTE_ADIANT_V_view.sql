-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_adiant_v (ie_tipo, nr_atendimento, dt_adiantamento, nr_adiantamento, cd_tipo_recebimento, vl_disponivel, nr_cheque, vl_saldo, cd_estabelecimento, nr_interno_conta) AS select	1 ie_tipo,				-- vl disponivel em especie
	a.nr_atendimento,		--Francisco - OS 35929 - Coloquei em todos vl_adiantamento  
	a.dt_adiantamento,		-- da conta_paciente_adiant um decode para ver se a conta ja 
	a.nr_adiantamento,		-- foi cancelada/estornada  
	a.cd_tipo_recebimento,		
	(a.vl_especie - coalesce(sum(CASE WHEN c.ie_cancelamento IS NULL THEN b.vl_adiantamento  ELSE 0 END ),0)) vl_disponivel, 
	0 nr_cheque,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
FROM adiantamento a
LEFT OUTER JOIN conta_paciente_adiant b ON (a.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN conta_paciente c ON (b.nr_interno_conta = c.nr_interno_conta)
WHERE a.vl_especie > (select	coalesce(sum(x.vl_adiantamento),0)
			from	conta_paciente_adiant x
			where	x.nr_adiantamento = b.nr_adiantamento) and a.vl_especie <> 0
group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	a.vl_especie,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
 
union

select	1 ie_tipo,				-- vl adiantado que nao foi em especie
	a.nr_atendimento,
	a.dt_adiantamento,
	a.nr_adiantamento,
	a.cd_tipo_recebimento,
	(coalesce(sum(CASE WHEN c.ie_cancelamento IS NULL THEN b.vl_adiantamento  ELSE 0 END ),0) - a.vl_especie) vl_disponivel,
	0 nr_cheque,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
FROM adiantamento a
LEFT OUTER JOIN conta_paciente_adiant b ON (a.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN conta_paciente c ON (b.nr_interno_conta = c.nr_interno_conta)
WHERE a.vl_especie < (select	coalesce(sum(x.vl_adiantamento),0)
			from	conta_paciente_adiant x
			where	a.nr_adiantamento = b.nr_adiantamento) and a.vl_especie <> 0
group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	a.vl_especie,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
 
union

select	2 ie_tipo,				-- vl disponivel n especie 
	a.nr_atendimento,
	a.dt_adiantamento,
	a.nr_adiantamento,
	a.cd_tipo_recebimento,
	((a.vl_adiantamento - a.vl_especie) - 
	coalesce(sum(CASE WHEN c.ie_cancelamento IS NULL THEN  b.vl_adiantamento  ELSE 0 END ),0)) vl_disponivel, -- edgar 04/02/2006 OS 29156, coloquei decode
	0 nr_cheque,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
FROM tipo_recebimento d, adiantamento a
LEFT OUTER JOIN conta_paciente_adiant b ON (a.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN conta_paciente c ON (b.nr_interno_conta = c.nr_interno_conta)
WHERE a.cd_tipo_recebimento		= d.cd_tipo_recebimento and d.ie_tipo_consistencia <> 3  -- Francisco - 09/04/07 - Estava tratando pelo cd_tipo_recebimento
  and coalesce(a.vl_especie,0) 		= 0
group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	a.vl_adiantamento,
	a.vl_especie,
	a.vl_saldo,
	c.cd_estabelecimento,
	b.nr_interno_conta
 
union

select	3 ie_tipo,			-- vl saldo cheque vinculado a somente um adiantamento
	a.nr_atendimento,
	a.dt_adiantamento,
	a.nr_adiantamento,
	a.cd_tipo_recebimento,
	CASE WHEN b.ie_tipo_adiant=3 THEN (c.vl_cheque - 		coalesce(sum(CASE WHEN d.ie_cancelamento IS NULL THEN b.vl_adiantamento  ELSE 0 END ),0))  ELSE c.vl_cheque END  vl_disponivel,
	c.nr_seq_cheque nr_cheque,
	a.vl_saldo,
	d.cd_estabelecimento,
	b.nr_interno_conta
FROM tipo_recebimento e, adiantamento a
LEFT OUTER JOIN conta_paciente_adiant b ON (a.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN cheque_cr c ON (a.nr_adiantamento = c.nr_adiantamento)
LEFT OUTER JOIN conta_paciente d ON (b.nr_interno_conta = d.nr_interno_conta)
WHERE a.cd_tipo_recebimento	= e.cd_tipo_recebimento and e.ie_tipo_consistencia = 3  -- Francisco - 09/04/07 - Estava tratando pelo cd_tipo_recebimento
  and not exists (select	1
			from	adiantamento_cheque_cr x
			where 	x.nr_seq_cheque 	= c.nr_seq_cheque)
group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	c.vl_cheque,
	c.nr_seq_cheque,
	b.ie_tipo_adiant,
	a.vl_saldo,
	d.cd_estabelecimento,
	b.nr_interno_conta
 
union

select	3 ie_tipo,	-- vl saldo de cheque vinculado a mais de um adiantamento, casos de cheque ligado pela tabela adiantamento_cheque_cr
	a.nr_atendimento,
	a.dt_adiantamento,
	a.nr_adiantamento,
	a.cd_tipo_recebimento,
	CASE WHEN b.ie_tipo_adiant=3 THEN (Obter_Valor_Menor(c.vl_cheque, a.vl_adiantamento) - 				coalesce(sum(CASE WHEN e.ie_cancelamento IS NULL THEN b.vl_adiantamento  ELSE 0 END ),0))  ELSE Obter_Valor_Menor(c.vl_cheque, a.vl_saldo) END  vl_disponivel,
	c.nr_seq_cheque nr_cheque,
	a.vl_saldo,
	e.cd_estabelecimento,
	b.nr_interno_conta
FROM tipo_recebimento f, cheque_cr c, adiantamento a, adiantamento_cheque_cr d
LEFT OUTER JOIN conta_paciente_adiant b ON (d.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN conta_paciente e ON (b.nr_interno_conta = e.nr_interno_conta)
WHERE d.nr_seq_cheque		= c.nr_seq_cheque and d.nr_adiantamento	= a.nr_adiantamento   and a.cd_tipo_recebimento	= f.cd_tipo_recebimento and f.ie_tipo_consistencia 	= 3  -- Francisco - 09/04/07 - Estava tratando pelo cd_tipo_recebimento
 group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	a.vl_adiantamento,
	c.vl_cheque,
	c.nr_seq_cheque,
	b.ie_tipo_adiant,
	a.vl_saldo,
	e.cd_estabelecimento,
	b.nr_interno_conta
 
union

select	3 ie_tipo,			-- vl saldo cheque vinculado a mais de um adiantamento, casos de cheque ligado diretamente
	a.nr_atendimento,
	a.dt_adiantamento,
	a.nr_adiantamento,
	a.cd_tipo_recebimento,
	CASE WHEN b.ie_tipo_adiant=3 THEN (Obter_Valor_Menor(c.vl_cheque, a.vl_adiantamento) - 					coalesce(sum(CASE WHEN d.ie_cancelamento IS NULL THEN b.vl_adiantamento  ELSE 0 END ),0))  ELSE Obter_Valor_Menor(c.vl_cheque, a.vl_adiantamento) END  vl_disponivel,
	c.nr_seq_cheque nr_cheque,
	a.vl_saldo,
	d.cd_estabelecimento,
	b.nr_interno_conta
FROM tipo_recebimento e, adiantamento a
LEFT OUTER JOIN conta_paciente_adiant b ON (a.nr_adiantamento = b.nr_adiantamento)
LEFT OUTER JOIN cheque_cr c ON (a.nr_adiantamento = c.nr_adiantamento)
LEFT OUTER JOIN conta_paciente d ON (b.nr_interno_conta = d.nr_interno_conta)
WHERE a.cd_tipo_recebimento	= e.cd_tipo_recebimento and e.ie_tipo_consistencia = 3  -- Francisco - 09/04/07 - Estava tratando pelo cd_tipo_recebimento
  and exists (select	1
		from	adiantamento_cheque_cr x
		where 	x.nr_seq_cheque 	= c.nr_seq_cheque)
group	by a.nr_atendimento,
	a.nr_adiantamento,
	a.dt_adiantamento,
	a.cd_tipo_recebimento,
	c.vl_cheque,
	c.nr_seq_cheque,
	b.ie_tipo_adiant,
	a.vl_saldo,
	a.vl_adiantamento,
	d.cd_estabelecimento,
	b.nr_interno_conta;

