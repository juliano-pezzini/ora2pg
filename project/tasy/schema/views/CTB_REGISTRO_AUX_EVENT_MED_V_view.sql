-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ctb_registro_aux_event_med_v (nr_evento, nr_contrato, dt_emissao, dt_rescisao, ie_ato_cooperado, ds_ato_cooperado, ie_modalidade_contrat, ds_modalidade_contrat, ie_regulamentacao, ds_tipo_regulamentacao, ie_tipo_contratacao, ds_tipo_contratacao, ie_segmentacao, ds_segmentacao, nm_usuario_princ, nr_cpf_cnpj, nm_usuario_evento, dt_ocorrencia, dt_conhecimento, nm_prestador, nr_cpf_cnpj_adic, ie_tipo_documento, ds_tipo_documento, dt_pagamento, nr_seq_protocolo, ie_tipo_protocolo, nr_documento, cd_procedimento, ie_origem_proced, cd_item_mat_proc, ds_item_mat_proc, nr_seq_material, cd_material_ops, cd_beneficiario, ie_tipo_operacao, ds_grupo_ans, ds_tipo_relacao, cd_conta_contabil, cd_conta_contrapartida, vl_evento, vl_glosa, nr_protocolo_ans, dt_glosa, cd_nono_dig, ie_tipo_livro, nr_seq_segurado, nr_seq_prestador, nr_seq_congenere, nr_seq_grupo_ans, dt_vencimento, dt_recuperacao, ie_tipo_segurado, nr_seq_pagador, ie_tipo_grupo_ans, dt_liberacao_pag, dt_apresentacao_lote, dt_competencia_lote, ie_tipo_evento, dt_mes_competencia) AS select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_procedimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),pls_obter_nome_congenere(r.nr_seq_congenere)),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	o.cd_procedimento,
	o.ie_origem_proced,
	o.cd_procedimento cd_item_mat_proc,
	substr(obter_descricao_procedimento(o.cd_procedimento,o.ie_origem_proced),1,255) ds_item_mat_proc,
	null nr_seq_material,
	null cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_deb_apres cd_conta_contabil,
	e.cd_conta_cred_apres cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_deb_apres,'X')='X' THEN  0  ELSE (coalesce(e.vl_glosa,0) + coalesce(e.vl_liberado,0)) END  *(-1) vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	g.dt_apresentacao_lote dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_deb_apres, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	1 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'APRES' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico_apres = h.cd_historico)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc o
LEFT OUTER JOIN pls_rec_glosa_proc d ON (o.nr_sequencia = d.nr_seq_conta_proc)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_proc_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia      and o.ie_status not in ('D','M')
 
union all

select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_atendimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),pls_obter_nome_congenere(r.nr_seq_congenere)),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN 			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	null cd_procedimento,
	null ie_origem_proced,
	o.nr_seq_material cd_item_mat_proc,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'D'),1,255) ds_item_mat_proc,
	o.nr_seq_material nr_seq_material,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'O'),1,255) cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_deb_apres cd_conta_contabil,
	e.cd_conta_cred_apres cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_deb_apres,'X')='X' THEN  0  ELSE (coalesce(e.vl_liberado,0) + coalesce(e.vl_glosa,0)) * (-1) END  vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	g.dt_apresentacao_lote dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_deb_apres, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	1 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'APRES' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico_apres = h.cd_historico)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat o
LEFT OUTER JOIN pls_rec_glosa_mat d ON (o.nr_sequencia = d.nr_seq_conta_mat)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_mat_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia      and o.ie_status not in ('D','M')
 
union all

select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_procedimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),CASE WHEN r.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(r.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN 			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	o.cd_procedimento,
	o.ie_origem_proced,
	o.cd_procedimento cd_item_mat_proc,
	substr(obter_descricao_procedimento(o.cd_procedimento,o.ie_origem_proced),1,255) ds_item_mat_proc,
	null nr_seq_material,
	null cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_cred cd_conta_contabil,
	e.cd_conta_deb cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_cred,'X')='X' THEN  0  ELSE coalesce(e.vl_glosa,0) END  vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	g.dt_liberacao_pag dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_cred, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	2 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'GLOSA' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico = h.cd_historico)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc o
LEFT OUTER JOIN pls_rec_glosa_proc d ON (o.nr_sequencia = d.nr_seq_conta_proc)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_proc_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia      and o.ie_status not in ('D','M')
 
union all

select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_atendimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),CASE WHEN r.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(r.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN 			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	null cd_procedimento,
	null ie_origem_proced,
	o.nr_seq_material cd_item_mat_proc,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'D'),1,255) ds_item_mat_proc,
	o.nr_seq_material nr_seq_material,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'O'),1,255) cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_cred cd_conta_contabil,
	e.cd_conta_deb cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_cred,'X')='X' THEN 0  ELSE coalesce(e.vl_glosa,0) END  vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	g.dt_liberacao_pag dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_deb_apres, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	2 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'GLOSA' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico = h.cd_historico)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat o
LEFT OUTER JOIN pls_rec_glosa_mat d ON (o.nr_sequencia = d.nr_seq_conta_mat)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_mat_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia      and o.ie_status not in ('D','M')
 
union all

select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_procedimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),CASE WHEN r.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(r.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN 			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	o.cd_procedimento,
	o.ie_origem_proced,
	o.cd_procedimento cd_item_mat_proc,
	substr(obter_descricao_procedimento(o.cd_procedimento,o.ie_origem_proced),1,255) ds_item_mat_proc,
	null nr_seq_material,
	null cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_deb_pag cd_conta_contabil,
	e.cd_conta_cred_pag cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_deb_apres,'X')='X' THEN  CASE WHEN coalesce(e.cd_conta_cred, 'X')='X' THEN  coalesce(e.vl_liberado,0)  * (-1)  ELSE 0 END   ELSE coalesce(e.vl_glosa,0) END  vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	coalesce(l.dt_mes_competencia, k.dt_mes_competencia) dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_deb_pag, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	1 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'LIB' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico_apres = h.cd_historico)
LEFT OUTER JOIN pls_lote_pagamento l ON (e.nr_seq_lote_pgto = l.nr_sequencia)
LEFT OUTER JOIN pls_pp_lote k ON (e.nr_seq_pp_lote = k.nr_sequencia)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc o
LEFT OUTER JOIN pls_rec_glosa_proc d ON (o.nr_sequencia = d.nr_seq_conta_proc)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_proc_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia        and o.ie_status not in ('D','M')
 
union all

select	c.nr_sequencia nr_evento,
	t.nr_contrato nr_contrato,
	c.dt_emissao dt_emissao,
	s.dt_rescisao dt_rescisao,
	coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado) ie_ato_cooperado,
	substr(obter_valor_dominio(3418,coalesce(e.ie_ato_cooperado,e.ie_ato_cooperado)),1,255) ds_ato_cooperado,
	pp.ie_preco ie_modalidade_contrat,
	substr(obter_valor_dominio(1669,pp.ie_preco),1,255) ds_modalidade_contrat,
	pp.ie_regulamentacao,
	substr(obter_valor_dominio(2157,pp.ie_regulamentacao),1,255) ds_tipo_regulamentacao,
	pp.ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,pp.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	pp.ie_segmentacao,
	substr(obter_valor_dominio(1665,pp.ie_segmentacao),1,255) ds_segmentacao,
	substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
	o.dt_atendimento dt_ocorrencia,
	coalesce(r.dt_recebimento, r.dt_mes_competencia) dt_conhecimento,
	substr(coalesce(pls_obter_dados_prestador(p.nr_sequencia,'N'),CASE WHEN r.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(r.nr_seq_congenere)  ELSE obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ),1,255) nm_prestador,
	substr(CASE WHEN c.nr_seq_prestador_exec IS NULL THEN 			pls_obter_cnpj_congenere(r.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'), pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')) END ,1,255) nr_cpf_cnpj_adic,
	'CM' ie_tipo_documento,
	CASE WHEN coalesce(c.cd_pessoa_fisica,'X')='X' THEN 'NOTA FISCAL'  ELSE 'RPA/FATURA' END  ds_tipo_documento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
	r.nr_sequencia nr_seq_protocolo,
	r.ie_tipo_protocolo ie_tipo_protocolo,
	c.nr_documento,
	null cd_procedimento,
	null ie_origem_proced,
	o.nr_seq_material cd_item_mat_proc,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'D'),1,255) ds_item_mat_proc,
	o.nr_seq_material nr_seq_material,
	substr(pls_obter_dados_conta_mat(o.nr_sequencia,'O'),1,255) cd_material_ops,
	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
	'G' ie_tipo_operacao,
	substr(pls_obter_dados_grupo_ans(o.nr_seq_grupo_ans,'D'),1,255) ds_grupo_ans,
	substr(pls_obter_dados_prestador(p.nr_sequencia,'TR'),1,255) ds_tipo_relacao,
	e.cd_conta_deb_pag cd_conta_contabil,
	e.cd_conta_cred_pag cd_conta_contrapartida,
	o.vl_provisao vl_evento,
	CASE WHEN coalesce(e.cd_conta_deb_apres,'X')='X' THEN  CASE WHEN coalesce(e.cd_conta_cred, 'X')='X' THEN  coalesce(e.vl_liberado,0)  * (-1)  ELSE 0 END   ELSE coalesce(e.vl_glosa,0) END  vl_glosa,
	CASE WHEN pp.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(pp.nr_protocolo_ans, pp.cd_scpa) END  nr_protocolo_ans,
	coalesce(l.dt_mes_competencia, k.dt_mes_competencia) dt_glosa,
	substr(somente_numero_char(ctb_obter_classif_conta(e.cd_conta_deb_pag, null, LOCALTIMESTAMP)),9,1) cd_nono_dig,
	1 ie_tipo_livro,
	s.nr_sequencia	nr_seq_segurado,
	c.nr_seq_prestador_exec nr_seq_prestador,
	r.nr_seq_congenere nr_seq_congenere,
	o.nr_seq_grupo_ans nr_seq_grupo_ans,
	s.dt_rescisao dt_vencimento,
	substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_recuperacao,
	c.ie_tipo_segurado ie_tipo_segurado,
	s.nr_seq_pagador,
	j.ie_tipo_grupo_ans,
	g.dt_liberacao_pag,
	g.dt_apresentacao_lote,
	g.dt_competencia_lote,
	'LIB' ie_tipo_evento,
	r.dt_mes_competencia
FROM pls_protocolo_conta r, pls_rec_glosa_protocolo g, pls_rec_glosa_conta f, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_prestador p ON (e.nr_seq_prestador_pgto = p.nr_sequencia)
LEFT OUTER JOIN historico_padrao h ON (e.cd_historico_apres = h.cd_historico)
LEFT OUTER JOIN pls_lote_pagamento l ON (e.nr_seq_lote_pgto = l.nr_sequencia)
LEFT OUTER JOIN pls_pp_lote k ON (e.nr_seq_pp_lote = k.nr_sequencia)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano pp ON (c.nr_seq_plano = pp.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat o
LEFT OUTER JOIN pls_rec_glosa_mat d ON (o.nr_sequencia = d.nr_seq_conta_mat)
LEFT OUTER JOIN ans_grupo_despesa j ON (o.nr_seq_grupo_ans = j.nr_sequencia)
WHERE d.nr_sequencia			= e.nr_seq_mat_rec and f.nr_sequencia			= e.nr_seq_conta_rec and g.nr_sequencia			= f.nr_seq_protocolo  and f.nr_seq_conta			= c.nr_sequencia  and c.nr_seq_protocolo 		= r.nr_sequencia        and o.ie_status not in ('D','M');

