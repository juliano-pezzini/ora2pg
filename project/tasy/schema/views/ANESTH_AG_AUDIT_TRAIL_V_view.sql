-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW anesth_ag_audit_trail_v (ie_remark, seq_ocorrencia, nr_seq_apresentacao, dt_inativacao, nm_usuario_inativacao, ds_agentes, ds_modo, qt_velocidade_inf, ds_velocidade_inf, ds_comercial, qt_dose, qt_dose_total, qt_halog_ins, ds_dose, dt_inicio_adm, dt_final_adm, ie_aplic_bolus, remark, ie_situacao_a, ie_situacao_b, nr_cirurgia) AS SELECT	
    'N' as ie_remark,
    b.nr_sequencia seq_ocorrencia,
    c.nr_seq_apresentacao,
    CASE WHEN b.ie_situacao = 'I' THEN b.dt_inativacao ELSE NULL END AS dt_inativacao,
    CASE WHEN b.ie_situacao = 'I' THEN b.nm_usuario_inativacao ELSE NULL END AS nm_usuario_inativacao,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_desc_agente(a.nr_seq_agente),1,40) || '</span>' ELSE to_char(SUBSTR(obter_desc_agente(a.nr_seq_agente),1,40)) END as ds_agentes,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_valor_dominio(1568,a.ie_modo_adm),1,40) || '</span>' ELSE SUBSTR(obter_valor_dominio(1568,a.ie_modo_adm),1,40) END as ds_modo,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.QT_VELOCIDADE_INF || '</span>' ELSE to_char(b.QT_VELOCIDADE_INF) END as QT_VELOCIDADE_INF,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,1),1,40) || '</span>' ELSE to_char(SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,1),1,40)) END as DS_VELOCIDADE_INF,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_desc_material(cd_material),1,40) || '</span>' ELSE to_char(SUBSTR(obter_desc_material(cd_material),1,40)) END as ds_comercial,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.QT_DOSE || '</span>' ELSE to_char(b.QT_DOSE) END as QT_DOSE,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.qt_dose_total || '</span>' ELSE to_char(b.qt_dose_total) END as qt_dose_total,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || QT_HALOG_INS || '</span>' ELSE to_char(QT_HALOG_INS) END as QT_HALOG_INS,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,2),1,40) || '</span>' ELSE to_char(SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,2),1,40)) END as ds_dose,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || to_char(b.DT_INICIO_ADM,  'HH24:MI') || '</span>' ELSE to_char(b.DT_INICIO_ADM,  'HH24:MI') END as DT_INICIO_ADM,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || to_char(CASE WHEN b.IE_APLIC_BOLUS='N' THEN b.DT_FINAL_ADM END ,  'HH24:MI') || '</span>' ELSE to_char(CASE WHEN b.IE_APLIC_BOLUS='N' THEN b.DT_FINAL_ADM END ,  'HH24:MI') END as DT_FINAL_ADM,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.IE_APLIC_BOLUS || '</span>' ELSE to_char(b.IE_APLIC_BOLUS) END as IE_APLIC_BOLUS,
    NULL as remark,
    a.ie_situacao IE_SITUACAO_A,
    b.ie_situacao IE_SITUACAO_B,
    a.NR_CIRURGIA
FROM	
    cirurgia_agente_anest_ocor b
RIGHT JOIN
    cirurgia_agente_anestesico a ON a.nr_sequencia = b.nr_seq_cirur_agente
INNER JOIN 
    agente_anestesico c ON a.nr_seq_agente = c.nr_sequencia
WHERE
    a.ie_tipo IN (1,2,3)
    AND	coalesce(c.ie_situacao,'A') = 'A'
    AND (select count(*) from cirurgia_agente_anest_ocor where b.nr_seq_cirur_agente = a.nr_sequencia) > 0

UNION

SELECT	
    'S' as ie_remark,
    b.nr_sequencia seq_ocorrencia,
    c.nr_seq_apresentacao,
    NULL AS dt_inativacao,
    NULL AS nm_usuario_inativacao,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_desc_agente(a.nr_seq_agente),1,40) || '</span>' ELSE to_char(SUBSTR(obter_desc_agente(a.nr_seq_agente),1,40)) END as ds_agentes,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_valor_dominio(1568,a.ie_modo_adm),1,40) || '</span>' ELSE SUBSTR(obter_valor_dominio(1568,a.ie_modo_adm),1,40) END as ds_modo,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.QT_VELOCIDADE_INF || '</span>' ELSE to_char(b.QT_VELOCIDADE_INF) END as QT_VELOCIDADE_INF,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,1),1,40) || '</span>' ELSE to_char(SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,1),1,40)) END as DS_VELOCIDADE_INF,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_desc_material(cd_material),1,40) || '</span>' ELSE to_char(SUBSTR(obter_desc_material(cd_material),1,40)) END as ds_comercial,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.QT_DOSE || '</span>' ELSE to_char(b.QT_DOSE) END as QT_DOSE,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.qt_dose_total || '</span>' ELSE to_char(b.qt_dose_total) END as qt_dose_total,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || QT_HALOG_INS || '</span>' ELSE to_char(QT_HALOG_INS) END as QT_HALOG_INS,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,2),1,40) || '</span>' ELSE to_char(SUBSTR(obter_dosagem_agente_grid(b.nr_sequencia,2),1,40)) END as ds_dose,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || to_char(b.DT_INICIO_ADM,  'HH24:MI') || '</span>' ELSE to_char(b.DT_INICIO_ADM,  'HH24:MI') END as DT_INICIO_ADM,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || to_char(CASE WHEN b.IE_APLIC_BOLUS='N' THEN b.DT_FINAL_ADM END ,  'HH24:MI') || '</span>' ELSE to_char(CASE WHEN b.IE_APLIC_BOLUS='N' THEN b.DT_FINAL_ADM END ,  'HH24:MI') END as DT_FINAL_ADM,
    CASE WHEN b.ie_situacao = 'I' THEN '<span style="text-decoration: line-through; color: gray;">' || b.IE_APLIC_BOLUS || '</span>' ELSE to_char(b.IE_APLIC_BOLUS) END as IE_APLIC_BOLUS,
    CASE WHEN o.ds_observao is not null THEN 'Remark: ' || o.ds_observao || ' - ' || (obter_nome_usuario(o.nm_usuario) || ' (' || o.dt_atualizacao || ')') ELSE '' END as remark ,
    a.ie_situacao IE_SITUACAO_A,
    b.ie_situacao IE_SITUACAO_B,
    a.NR_CIRURGIA
FROM	
    cirurgia_agente_anest_ocor b
RIGHT JOIN 
    cirurgia_agente_anestesico a ON a.nr_sequencia = b.nr_seq_cirur_agente
INNER JOIN 
    agente_anestesico c ON a.nr_seq_agente = c.nr_sequencia
INNER JOIN
    revisao_cirurgia r ON r.nr_seq_origem = b.nr_sequencia
INNER JOIN
    revisao_cirurgia_obs o ON o.nr_seq_revisao = r.nr_sequencia
WHERE
    a.ie_tipo IN (1,2,3)
    AND	coalesce(c.ie_situacao,'A') = 'A'
    AND (select count(*) from cirurgia_agente_anest_ocor where b.nr_seq_cirur_agente = a.nr_sequencia) > 0;

