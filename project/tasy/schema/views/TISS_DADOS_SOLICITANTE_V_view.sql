-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_dados_solicitante_v (ds_versao, ie_origem, nr_atendimento, nr_seq_agenda, cd_cgc, ds_razao_social, cd_cnes, dt_entrada, nm_medico_solicitante, sg_conselho, nr_crm, uf_crm, nr_cpf, ds_tipo_logradouro, ds_endereco, nr_endereco, ds_complemento, cd_municipio_ibge, sg_estado, cd_cep, ds_municipio, nr_seq_protocolo, nm_pessoa_fisica, nr_sequencia_autor, ds_carater_internacao, ie_clinica, qt_dia_solicitado, ds_indicacao_clinica, cd_interno, nr_interno_conta, cd_autorizacao, cd_medico_atendimento, cd_cbo_saude, cd_medico_convenio, cd_convenio, ie_conveniado, cd_medico_solic_tiss, nr_seq_cbo_saude, dt_entrada_prevista, cd_prestador_tiss, cd_interno_contrat_solic, cd_interno_contrat_exec, ds_contratado_exec_tiss, nr_seq_rec_glosa_prot_cancel) AS select	'2.01.01' ds_versao,
	'AC' ie_origem,
	a.nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	a.dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	CASE WHEN a.ie_carater_inter_sus='U' THEN 'U'  ELSE 'E' END  ds_carater_internacao,
	substr(tiss_obter_clinica(a.ie_clinica, a.nr_seq_classificacao),1,3) ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	coalesce(substr(tiss_obter_codigo_prestador(c.cd_convenio, f.cd_estabelecimento, null, c.cd_cgc_prestador, (null)::numeric , 'CI',null,a.ie_tipo_atendimento,null),1,255),
		substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15)) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	a.cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, a.ie_tipo_atendimento, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, atendimento_paciente a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_atendimento			= a.nr_atendimento and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica   and c.nr_seq_agenda			is null

union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	a.nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	a.dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	CASE WHEN a.ie_carater_inter_sus='U' THEN 'U'  ELSE 'E' END  ds_carater_internacao,
	substr(tiss_obter_clinica(a.ie_clinica, a.nr_seq_classificacao),1,3) ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	coalesce(substr(tiss_obter_codigo_prestador(c.cd_convenio, f.cd_estabelecimento, null, c.cd_cgc_prestador, (null)::numeric , 'CI',null,a.ie_tipo_atendimento,null),1,255),
		substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15)) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	a.cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, a.ie_tipo_atendimento, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, atendimento_paciente a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_atendimento			= a.nr_atendimento and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica   and c.nr_seq_agenda			is not null and c.nr_atendimento		is not null
 
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,	
	a.dt_agenda dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	a.cd_medico_exec cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,m.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(m.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,m.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM agenda m, pessoa_juridica h, convenio g, estabelecimento f, agenda_paciente a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE m.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_seq_agenda		= a.nr_sequencia and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) = h.cd_cgc and b.cd_pessoa_fisica		= i.cd_pessoa_fisica and a.cd_agenda			= m.cd_agenda   and c.nr_atendimento		is null
 
union

select	'2.01.01' ds_versao,
	'PC' ie_origem,
	c.nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	f.cd_cgc,
	substr(tiss_eliminar_caractere(i.ds_razao_social),1,100) ds_razao_social,
	coalesce(f.cd_cns, i.cd_cnes) cd_cnes,
	c.dt_entrada,
	substr(tiss_eliminar_caractere(j.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	h.nr_crm,
	substr(h.uf_crm,1,2) uf_crm,
	null	nr_cpf,
	'081' ds_tipo_logradouro,
	i.ds_endereco,
	i.nr_endereco,
	i.ds_complemento,
	substr(lpad(coalesce(i.cd_municipio_ibge, obter_municipio_ibge(somente_numero(i.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	i.sg_estado,
	lpad(to_char(somente_numero(i.cd_cep)),8,'0') cd_cep,
	i.ds_municipio,
	a.nr_seq_protocolo,
	substr(tiss_eliminar_caractere(j.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	(null)::numeric  nr_sequencia_autor,
	CASE WHEN c.ie_carater_inter_sus='U' THEN 'U'  ELSE 'E' END  ds_carater_internacao,
	substr(tiss_obter_clinica(c.ie_clinica, c.nr_seq_classificacao),1,3) ie_clinica,
	(null)::numeric  qt_dia_solicitado,
	null ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	b.nr_interno_conta,
	'0' cd_autorizacao,
	h.cd_pessoa_fisica cd_medico_atendimento,
	l.cd_cbo cd_cbo_saude,
	substr(obter_medico_convenio(b.cd_estabelecimento, h.cd_pessoa_fisica, b.cd_convenio_parametro, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	a.cd_convenio,
	null ie_conveniado,
	null,
	null,
	null DT_ENTRADA_PREVISTA,
	null cd_prestador_tiss,
	null CD_INTERNO_CONTRAT_SOLIC,
	null cd_interno_contrat_exec,
	null ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica i, convenio g, estabelecimento f, conta_paciente b, protocolo_convenio a, pessoa_fisica j
LEFT OUTER JOIN conselho_profissional k ON (j.nr_seq_conselho = k.nr_sequencia)
LEFT OUTER JOIN cbo_saude l ON (j.nr_seq_cbo_saude = l.nr_sequencia)
, atendimento_paciente c
LEFT OUTER JOIN medico h ON (c.cd_medico_resp = h.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 	= f.cd_estabelecimento and a.cd_convenio			= g.cd_convenio and a.nr_seq_protocolo		= b.nr_seq_protocolo and b.nr_atendimento		= c.nr_atendimento  and f.cd_cgc			= i.cd_cgc and h.cd_pessoa_fisica		= j.cd_pessoa_fisica   
union

select	'2.01.01' ds_versao,
	'AP' ie_origem,
	a.nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	f.cd_cgc,
	substr(tiss_eliminar_caractere(h.ds_razao_social),1,100) ds_razao_social,
	coalesce(f.cd_cns, h.cd_cnes) cd_cnes,
	a.dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100)  nm_medico_solicitante,
	coalesce(j.ie_conselho_prof_tiss,j.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge, obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100)  nm_pessoa_fisica,
	(null)::numeric  nr_sequencia_autor,
	CASE WHEN a.ie_carater_inter_sus='U' THEN 'U'  ELSE 'E' END  ds_carater_internacao,
	substr(tiss_obter_clinica(a.ie_clinica, a.nr_seq_classificacao),1,3)  ie_clinica,
	(null)::numeric  qt_dia_solicitado,
	null ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	'0' cd_autorizacao,
	b.cd_pessoa_fisica cd_medico_atendimento,
	k.cd_cbo cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, b.cd_pessoa_fisica, c.cd_convenio, null, null,null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	substr(obter_se_medico_conveniado(a.cd_estabelecimento,b.cd_pessoa_fisica, c.cd_convenio, null, null, null,null,null,null, a.ie_tipo_atendimento, null,
		a.ie_carater_inter_sus),1,20) ie_conveniado,
	null,
	null,
	null  DT_ENTRADA_PREVISTA,
	null cd_prestador_tiss,
	null CD_INTERNO_CONTRAT_SOLIC,
	null cd_interno_contrat_exec,
	null ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, atend_categoria_convenio c, pessoa_fisica i
LEFT OUTER JOIN conselho_profissional j ON (i.nr_seq_conselho = j.nr_sequencia)
LEFT OUTER JOIN cbo_saude k ON (i.nr_seq_cbo_saude = k.nr_sequencia)
, atendimento_paciente a
LEFT OUTER JOIN medico b ON (a.cd_medico_resp = b.cd_pessoa_fisica)
WHERE a.nr_atendimento			= c.nr_atendimento and obter_atecaco_atendimento(a.nr_atendimento) = c.nr_seq_interno  and a.cd_estabelecimento 		= f.cd_estabelecimento and c.cd_convenio				= g.cd_convenio and f.cd_cgc				= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica   
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,	
	a.dt_agenda dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	a.cd_medico cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,m.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(m.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,m.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM agenda m, pessoa_juridica h, convenio g, estabelecimento f, autorizacao_convenio c, medico b, agenda_consulta a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
WHERE m.cd_estabelecimento 		= f.cd_estabelecimento and ((m.cd_pessoa_fisica		= b.cd_pessoa_fisica) or (b.cd_pessoa_fisica 		= c.cd_medico_solicitante)) and c.nr_seq_agenda_consulta	= a.nr_sequencia and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) = h.cd_cgc and b.cd_pessoa_fisica		= i.cd_pessoa_fisica and a.cd_agenda			= m.cd_agenda   and c.nr_atendimento		is null
 
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	a.dt_solicitacao dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	a.cd_medico cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, autorizacao_convenio c, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, gestao_vaga a
LEFT OUTER JOIN medico b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_seq_gestao			= a.nr_sequencia and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica   and c.nr_atendimento		is null
 
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	c.dt_autorizacao dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	c.cd_medico_solicitante cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, autorizacao_convenio_tiss a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_sequencia			= a.nr_sequencia_autor and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica		= i.cd_pessoa_fisica   and c.nr_atendimento		is null and c.nr_seq_agenda			is null and c.nr_seq_agenda_consulta	is null and c.nr_seq_gestao			is null and c.nr_seq_paciente_setor		is null and c.cd_pessoa_fisica 		is not null
 
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	c.dt_autorizacao dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	c.cd_medico_solicitante cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(a.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,a.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, autorizacao_convenio_tiss a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE a.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_sequencia			= a.nr_sequencia_autor and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica		= i.cd_pessoa_fisica   and c.nr_atendimento		is null and c.nr_seq_agenda			is null and c.nr_seq_agenda_consulta	is null and c.nr_seq_gestao			is null and c.nr_seq_paciente_setor		is not null
 
union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	coalesce(c.cd_cgc_prestador, f.cd_cgc) cd_cgc,
	substr(coalesce(c.ds_prestador_tiss,coalesce(obter_nome_pf_pj(null, coalesce(c.cd_cgc_prestador, f.cd_cgc)), tiss_eliminar_caractere(h.ds_razao_social))),1,100) ds_razao_social,
	CASE WHEN coalesce(c.cd_cgc_prestador,'X')='X' THEN coalesce(f.cd_cns, h.cd_cnes)  ELSE obter_dados_pf_pj(null,c.cd_cgc_prestador,'CNES') END  cd_cnes,
	c.dt_autorizacao dt_entrada,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_medico_solicitante,
	coalesce(k.ie_conselho_prof_tiss,k.sg_conselho) sg_conselho,
	b.nr_crm,
	substr(b.uf_crm,1,2) uf_crm,
	i.nr_cpf,
	'081' ds_tipo_logradouro,
	h.ds_endereco,
	h.nr_endereco,
	h.ds_complemento,
	substr(lpad(coalesce(h.cd_municipio_ibge,obter_municipio_ibge(somente_numero(h.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	h.sg_estado,
	lpad(to_char(somente_numero(h.cd_cep)),8,'0') cd_cep,
	h.ds_municipio,
	(null)::numeric  nr_seq_protocolo,
	substr(tiss_eliminar_caractere(i.nm_pessoa_fisica),1,100) nm_pessoa_fisica,
	c.nr_sequencia nr_sequencia_autor,
	ie_carater_int_tiss ds_carater_internacao,
	null ie_clinica,
	c.qt_dia_solicitado,
	c.ds_indicacao ds_indicacao_clinica,
	substr(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,15) cd_interno,
	(null)::numeric  nr_interno_conta,
	c.cd_autorizacao,
	c.cd_medico_solicitante cd_medico_atendimento,
	TISS_OBTER_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,c.cd_estabelecimento),j.cd_cbo) cd_cbo_saude,
	substr(obter_medico_convenio(c.cd_estabelecimento, i.cd_pessoa_fisica, c.cd_convenio, null,null, null, null, null, null, null, null),1,20) cd_medico_convenio,
	c.cd_convenio,
	null ie_conveniado,
	c.cd_medico_solic_tiss,
	TISS_OBTER_SEQ_CBO_ESPEC_MED(c.cd_convenio,i.cd_pessoa_fisica,TISS_OBTER_VERSAO(c.cd_convenio,c.cd_estabelecimento),j.cd_cbo) nr_seq_cbo_saude,
	c.DT_ENTRADA_PREVISTA,
	c.cd_prestador_tiss,
	c.CD_INTERNO_CONTRAT_SOLIC,
	c.cd_interno_contrat_exec cd_interno_contrat_exec,
	c.ds_contratado_exec_tiss ds_contratado_exec_tiss,
	null	nr_seq_rec_glosa_prot_cancel
FROM pessoa_juridica h, convenio g, estabelecimento f, paciente_setor_convenio a, pessoa_fisica i
LEFT OUTER JOIN cbo_saude j ON (i.nr_seq_cbo_saude = j.nr_sequencia)
LEFT OUTER JOIN conselho_profissional k ON (i.nr_seq_conselho = k.nr_sequencia)
, autorizacao_convenio c
LEFT OUTER JOIN medico b ON (c.cd_medico_solicitante = b.cd_pessoa_fisica)
WHERE c.cd_estabelecimento 		= f.cd_estabelecimento  and c.nr_seq_paciente_setor		= a.nr_seq_paciente and c.cd_convenio			= g.cd_convenio and coalesce(c.cd_cgc_prestador, f.cd_cgc) 	= h.cd_cgc and b.cd_pessoa_fisica		= i.cd_pessoa_fisica   and c.nr_atendimento		is null and c.nr_seq_agenda			is null and c.nr_seq_agenda_consulta	is null and c.nr_seq_gestao			is null and c.nr_seq_paciente_setor		is not null
 
union

select	'2.01.01' ds_versao,
	-- GRG Cancel Protocol
	'GRG-CP' ie_origem,
	(null)::numeric  nr_atendimento,
	(null)::numeric  nr_seq_agenda,
	d.cd_cgc cd_cgc,
	substr(coalesce(obter_nome_pf_pj(null, d.cd_cgc), tiss_eliminar_caractere(f.ds_razao_social)),1,100) ds_razao_social,
	coalesce(g.cd_cns, f.cd_cnes) cd_cnes,
	null dt_entrada,
	null nm_medico_solicitante,
	null sg_conselho,
	null nr_crm,
	null uf_crm,
	null nr_cpf,
	null ds_tipo_logradouro,
	f.ds_endereco,
	f.nr_endereco,
	f.ds_complemento,
	substr(lpad(coalesce(f.cd_municipio_ibge,obter_municipio_ibge(somente_numero(f.cd_cep))),7,'0'), 1, 25) cd_municipio_ibge,
	f.sg_estado,
	lpad(to_char(somente_numero(f.cd_cep)),8,'0') cd_cep,
	f.ds_municipio,
	null nr_seq_protocolo,
	null nm_pessoa_fisica,
	null nr_sequencia_autor,
	null ds_carater_internacao,
	null ie_clinica,
	null qt_dia_solicitado,
	null ds_indicacao,
	e.cd_interno,
	null nr_interno_conta,
	null cd_autorizacao,
	null cd_medico_atendimento,
	null cd_cbo_saude,
	null cd_medico_convenio,
	d.cd_convenio,
	null ie_conveniado,
	null cd_medico_solic_tiss,
	null nr_seq_cbo_saude,
	null DT_ENTRADA_PREVISTA,
	null cd_prestador_tiss,
	null CD_INTERNO_CONTRAT_SOLIC,
	null cd_interno_contrat_exec,
	null ds_contratado_exec_tiss,
	a.nr_sequencia nr_seq_rec_glosa_prot_cancel
from	tiss_recurso_glosa_prot a,
	lote_audit_hist b,
	lote_auditoria c,
	convenio d,
	convenio_estabelecimento e,
	pessoa_juridica f,
	estabelecimento g
where	a.nr_seq_lote_hist 	= b.nr_sequencia
and	b.nr_seq_lote_audit 	= c.nr_sequencia
and	c.cd_convenio		= e.cd_convenio
and	c.cd_estabelecimento	= e.cd_estabelecimento
and	c.cd_convenio		= d.cd_convenio
and	f.cd_cgc		= d.cd_cgc
and	c.cd_estabelecimento 	= g.cd_estabelecimento;

