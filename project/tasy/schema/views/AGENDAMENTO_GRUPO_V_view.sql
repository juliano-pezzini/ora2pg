-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW agendamento_grupo_v (nr_seq_horario, cd_agenda, nr_seq_agenda, ds_agenda, cd_paciente, ie_sexo_paciente, cd_sexo_paciente, nm_paciente, dt_nascimento, cd_medico, nm_medico, cd_tipo_agenda, dt_agenda, nr_minuto_duracao, ie_status_agenda, ds_status_agenda, dt_confirmacao, hr_inicio, hr_fim, nr_atendimento, cd_procedimento, ie_origem_proced, ds_procedimento, nr_seq_proc_interno, nm_usuario, nr_seq_ageint, nr_sequencia_ageint, cd_convenio, ds_convenio, ds_tipo_convenio, nr_episodio, ds_tipo_episodio, nr_seq_lista_espera, ie_encaixe, ds_ie_encaixe, nr_seq_episodio, ie_isolated_patient, ds_paciente_isolado, nr_seq_interno, nr_acesso_dicom, ie_urgente, ie_patient_allergic, ds_allergic, ie_status_laudo, ie_delay_check, delaying_time) AS SELECT DISTINCT
    ap.NR_SEQ_HORARIO,
	a.cd_agenda,
	ap.NR_SEQUENCIA nr_seq_agenda,
	obter_desc_agenda_integrada(a.cd_agenda,a.cd_tipo_agenda,null,wheb_usuario_pck.get_cd_estabelecimento) ds_agenda,
	ap.cd_pessoa_fisica cd_paciente,
	Obter_Sexo_PF(ap.cd_pessoa_fisica,'D') ie_sexo_paciente,
	Obter_Sexo_PF(ap.cd_pessoa_fisica,'C') cd_sexo_paciente,
	coalesce((SELECT NM_PESSOA_FISICA FROM TABLE(search_names_dev(NULL,NULL,(select max(pf.nr_seq_person_name) from pessoa_fisica pf where pf.cd_pessoa_fisica = coalesce(ap.cd_pessoa_fisica,(SELECT max(b.cd_pessoa_fisica) from agenda_integrada b,agenda_integrada_item c where c.nr_seq_agenda_int = b.nr_sequencia and c.nr_seq_agenda_exame = ap.nr_sequencia))),'list','social,main'))),coalesce(obter_nome_pf(ap.cd_pessoa_fisica),ap.nm_paciente)) nm_paciente,
	to_char(OBTER_DATA_NASCTO_PF(ap.cd_pessoa_fisica),pkg_date_formaters.localize_mask('shortDate',pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento,wheb_usuario_pck.get_nm_usuario))) dt_nascimento,
	ap.cd_medico,
	obter_nome_medico(ap.cd_medico,'N') nm_medico,
	a.cd_tipo_agenda,
	ap.hr_inicio dt_agenda,
	CASE WHEN ap.nr_minuto_duracao=0 THEN 30  ELSE ap.nr_minuto_duracao END  nr_minuto_duracao,
	ap.ie_status_agenda,
	CASE WHEN ap.dt_confirmacao IS NULL THEN substr(obter_valor_dominio(83,ap.ie_status_agenda),1,200)  ELSE substr(obter_valor_dominio(83,'CN'),1,200) END  ds_status_agenda,
	ap.dt_confirmacao,
	TO_CHAR(ap.hr_inicio,'hh24:mi') hr_inicio,
	TO_CHAR(ap.hr_inicio+(ap.nr_minuto_duracao/1440),'hh24:mi') hr_fim,
	ap.nr_atendimento,
	ap.cd_procedimento,
	ap.ie_origem_proced,
	SUBSTR(obter_exame_agenda(ap.cd_procedimento,ap.ie_origem_proced,ap.nr_seq_proc_interno),1,240) ds_procedimento,
	ap.nr_seq_proc_interno,
	ap.nm_usuario,
	(SELECT max(nr_sequencia) from agenda_integrada_item where nr_seq_agenda_exame = ap.nr_sequencia) nr_seq_ageint,
	(SELECT max(b.nr_sequencia) from agenda_integrada b,agenda_integrada_item c where c.nr_seq_agenda_int = b.nr_sequencia and c.nr_seq_agenda_exame  = ap.nr_sequencia) nr_sequencia_ageint,
	coalesce(Obter_Convenio_Atendimento(ap.nr_atendimento),ap.cd_convenio) cd_convenio,
	coalesce(Obter_desc_convenio(Obter_Convenio_Atendimento(ap.nr_atendimento)),Obter_Nome_Convenio(ap.cd_convenio)) ds_convenio,
	coalesce(obter_desc_tipo_convenio(Obter_Convenio_Atendimento(ap.nr_atendimento)),obter_desc_tipo_convenio(ap.cd_convenio)) ds_tipo_convenio,
	CASE WHEN OBTER_EPISODIO_ATENDIMENTO(ap.nr_atendimento)=0 THEN null  ELSE obter_episodio_atend_tela(ap.nr_atendimento) END  nr_episodio,
	obter_nome_tipo_episodio((SELECT nr_seq_tipo_episodio FROM EPISODIO_PACIENTE WHERE NR_SEQUENCIA = OBTER_EPISODIO_ATENDIMENTO(ap.nr_atendimento))) ds_tipo_episodio,ap.NR_SEQ_LISTA NR_SEQ_LISTA_ESPERA,
	ap.ie_encaixe,
	obter_desc_expressao(289204) ds_ie_encaixe,
	CASE WHEN obter_episodio_atend(ap.nr_atendimento)=0 THEN ' '  ELSE obter_episodio_atend(ap.nr_atendimento) END  nr_seq_episodio,
	(select max(i.ie_paciente_isolado) from atendimento_paciente i where i.nr_atendimento = ap.nr_atendimento) ie_isolated_patient,
	obter_desc_expressao(295168) ds_paciente_isolado,
	(SELECT max(pp.nr_seq_interno) FROM prescr_procedimento pp,prescr_medica pm WHERE pp.nr_prescricao = pm.nr_prescricao AND pp.nr_seq_proc_interno = ap.nr_seq_proc_interno
	AND pm.nr_seq_agenda = ap.nr_sequencia) nr_seq_interno,
	(SELECT max(pp.nr_acesso_dicom) FROM prescr_procedimento pp,prescr_medica pm WHERE pp.nr_prescricao = pm.nr_prescricao AND pp.nr_seq_proc_interno = ap.nr_seq_proc_interno
	AND pm.nr_seq_agenda = ap.nr_sequencia) nr_acesso_dicom,
	(SELECT pp.ie_urgencia FROM	prescr_procedimento pp,prescr_medica pm WHERE pp.nr_prescricao = pm.nr_prescricao AND pp.nr_seq_proc_interno = ap.nr_seq_proc_interno
	AND pm.nr_seq_agenda = ap.nr_sequencia) ie_urgente,
	Obter_Se_Pac_Alerta_Alergia(ap.cd_pessoa_fisica) ie_patient_allergic,
	obter_desc_expressao(350887) ds_allergic,
    obter_status_laudo_agenda(ap.nr_sequencia, ap.nr_atendimento) ie_status_laudo,
    case when ap.ie_status_agenda = 'O' AND obter_status_laudo_agenda(ap.nr_sequencia, ap.nr_atendimento) = 'N' AND trunc(dt_agenda) = trunc(LOCALTIMESTAMP) THEN 'S' ELSE 'N' END ie_delay_check,
    CASE WHEN trunc(ap.dt_agenda) = trunc(LOCALTIMESTAMP) THEN CASE WHEN ap.nr_minuto_duracao=0 THEN  101  ELSE round((((LOCALTIMESTAMP - ap.hr_inicio) * 1440) * 100) / ap.nr_minuto_duracao) END  ELSE 0 END delaying_time
	
FROM agenda a,
	 agenda_paciente ap
	
WHERE ap.cd_agenda = a.cd_agenda;

