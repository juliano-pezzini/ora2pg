-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW aspb_pls_desconto_folha_mens_v (tp_registro, dt_lote, ds_brancos, cd_estabelecimento, cd_matricula, dt_competencia, dt_referencia, vl_mensalidade1, vl_mensalidade2, nr_seq_cobranca) AS select	1 tp_registro,
	e.dt_remessa_retorno dt_lote,
	null ds_brancos,
	null cd_estabelecimento,
	null cd_matricula,
	null dt_competencia,
	null dt_referencia,
	lpad(obter_Valor_sem_virgula(pls_obter_valores_cobr(e.nr_sequencia,1)), 17, '0') vl_mensalidade1,
	lpad(obter_valor_sem_virgula(pls_obter_valores_cobr(e.nr_sequencia,1)), 11, '0') vl_mensalidade2,
	d.nr_seq_cobranca
FROM	cobranca_escritural		e,
	titulo_receber_cobr		d,
	titulo_receber		c,
	pls_lote_mensalidade	b,
	pls_mensalidade		a
where	a.nr_seq_lote		= b.nr_sequencia
and	c.nr_seq_mensalidade	= a.nr_sequencia
and	c.nr_titulo 		= d.nr_titulo
and	d.nr_seq_cobranca		= e.nr_sequencia
group by	b.nr_sequencia, e.nr_seq_empresa, d.nr_seq_cobranca, e.dt_remessa_retorno, e.nr_sequencia

union

select	2 tp_registro,
	g.dt_remessa_retorno dt_lote,
	null ds_brancos,
	'    ' cd_estabelecimento,
	substr(d.cd_matricula, 1, 10) cd_matricula,
	g.dt_remessa_retorno dt_competencia,
	a.dt_referencia,
	lpad(obter_Valor_sem_virgula(sum(h.vl_mensalidade)), 17, '0') vl_mensalidade1,
	lpad(obter_Valor_sem_virgula(sum(h.vl_mensalidade)), 11, '0') vl_mensalidade2,
	f.nr_seq_cobranca
from	pls_segurado		i,
	pls_mensalidade_segurado	h,
	cobranca_escritural		g,
	titulo_receber_cobr		f,
	titulo_receber		e,
	pls_contrato_pagador_fin	d,
	pls_contrato_pagador	c,
	pls_lote_mensalidade	b,
	pls_mensalidade		a
where	a.nr_seq_lote		= b.nr_sequencia
and	a.nr_seq_pagador 		= c.nr_sequencia
and	d.nr_seq_pagador		= c.nr_sequencia
and	e.nr_seq_mensalidade	= a.nr_sequencia
and	f.nr_titulo 			= e.nr_titulo
and	f.nr_seq_cobranca		= g.nr_sequencia
and	h.nr_seq_mensalidade	= a.nr_sequencia
and	h.nr_seq_segurado		= i.nr_sequencia
and	a.dt_referencia		between coalesce(d.dt_inicio_vigencia,a.dt_referencia) and coalesce(d.dt_fim_vigencia,a.dt_referencia)
group by	g.dt_remessa_retorno, d.cd_matricula, g.dt_remessa_retorno, a.dt_referencia, f.nr_seq_cobranca

union

select	9 tp_registro,
	null dt_lote,
	' ' ds_brancos,
	null cd_estabelecimento,
	null cd_matricula,
	null dt_competencia,
	null dt_referencia,
	null vl_mensalidade1,
	null vl_mensalidade2,
	a.nr_seq_cobranca
from titulo_receber_cobr		a;

