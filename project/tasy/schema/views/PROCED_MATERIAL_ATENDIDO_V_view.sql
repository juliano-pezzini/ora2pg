-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW proced_material_atendido_v (nr_atendimento, nr_prescricao, dt_prescricao, ie_proc_mat, dt_conta, dt_acerto_conta, dt_acerto_convenio, dt_item, cd_item, qt_executada, qt_devolvida, qt_saldo, vl_item, cd_convenio, nm_usuario, dt_atualizacao, cd_setor_atendimento, dt_entrada_unidade, cd_motivo_exc_conta, cd_medico_executor, vl_unitario, ds_item, tp_item, ds_tp_item, ds_convenio, ds_setor_atendimento, nm_medico_executor) AS SELECT A.NR_ATENDIMENTO,
       A.NR_PRESCRICAO,
       A.DT_PRESCRICAO,
       1 IE_PROC_MAT,
       A.DT_CONTA,
       A.DT_ACERTO_CONTA,
       A.DT_ACERTO_CONVENIO,
       A.DT_PROCEDIMENTO      DT_ITEM,
       A.CD_PROCEDIMENTO      CD_ITEM,
       A.QT_PROCEDIMENTO      QT_EXECUTADA,
       coalesce(A.QT_DEVOLVIDA,0)  QT_DEVOLVIDA,
       (A.QT_PROCEDIMENTO - coalesce(A.QT_DEVOLVIDA,0)) QT_SALDO,
       A.VL_PROCEDIMENTO      VL_ITEM,
       A.CD_CONVENIO,
       A.NM_USUARIO,
       A.DT_ATUALIZACAO,
       A.CD_SETOR_ATENDIMENTO,
       A.DT_ENTRADA_UNIDADE,
       A.CD_MOTIVO_EXC_CONTA,
       A.CD_MEDICO_EXECUTOR,
       (A.VL_PROCEDIMENTO / CASE WHEN A.QT_PROCEDIMENTO=0 THEN 1  ELSE A.QT_PROCEDIMENTO END ) VL_UNITARIO,
       B.DS_PROCEDIMENTO      DS_ITEM,
       B.IE_CLASSIFICACAO     TP_ITEM		/* 1-AMB 2-SERVICOS 3-DIARIAS	*/
,
       CASE WHEN B.IE_CLASSIFICACAO=1 THEN 'Procedimentos' WHEN B.IE_CLASSIFICACAO=2 THEN 'Servicos'  ELSE 'Diarias' END  DS_TP_ITEM,
       C.DS_CONVENIO,
       D.DS_SETOR_ATENDIMENTO,
       E.NM_PESSOA_FISICA NM_MEDICO_EXECUTOR
FROM procedimento b, procedimento_paciente a
LEFT OUTER JOIN pessoa_fisica e ON (A.CD_MEDICO_EXECUTOR = E.CD_PESSOA_FISICA)
LEFT OUTER JOIN convenio c ON (A.CD_CONVENIO = C.CD_CONVENIO)
LEFT OUTER JOIN setor_atendimento d ON (A.CD_SETOR_ATENDIMENTO = D.CD_SETOR_ATENDIMENTO)
WHERE (A.CD_PROCEDIMENTO       = B.CD_PROCEDIMENTO) AND (A.IE_ORIGEM_PROCED      = B.IE_ORIGEM_PROCED)
UNION

SELECT /*+ index(A matpaci_i1) */       X.NR_ATENDIMENTO,
       X.NR_PRESCRICAO,
       X.DT_PRESCRICAO,
       2 IE_PROC_MAT,
       X.DT_CONTA,
       X.DT_ACERTO_CONTA,
       X.DT_ACERTO_CONVENIO,
       X.DT_ATENDIMENTO       DT_ITEM,
       X.CD_MATERIAL          CD_ITEM,
       X.QT_EXECUTADA         QT_EXECUTADA,
       coalesce(X.QT_DEVOLVIDA,0)  QT_DEVOLVIDA,
       X.QT_MATERIAL          QT_SALDO,
       X.VL_MATERIAL          VL_ITEM,
       X.CD_CONVENIO,
       X.NM_USUARIO,
       X.DT_ATUALIZACAO,
       X.CD_SETOR_ATENDIMENTO,
       X.DT_ENTRADA_UNIDADE,
       X.CD_MOTIVO_EXC_CONTA,
       NULL CD_MEDICO_EXECUTOR,
       X.VL_UNITARIO VL_UNITARIO,
       W.DS_MATERIAL          DS_ITEM,
       W.IE_TIPO_MATERIAL     TP_ITEM        /* 1-MATERIAL 2-MED.GENERICO 3-MED.COMERC. */
,
       CASE WHEN W.IE_TIPO_MATERIAL=1 THEN 'Materiais' WHEN W.IE_TIPO_MATERIAL=2 THEN 'Medicamentos' WHEN W.IE_TIPO_MATERIAL=3 THEN 'Medicamentos'  ELSE 'Extras' END  DS_TP_ITEM,
       C.DS_CONVENIO,
       D.DS_SETOR_ATENDIMENTO,
       NULL NM_MEDICO_EXECUTOR
FROM material w, material_atend_paciente x
LEFT OUTER JOIN convenio c ON (X.CD_CONVENIO = C.CD_CONVENIO)
LEFT OUTER JOIN setor_atendimento d ON (X.CD_SETOR_ATENDIMENTO = D.CD_SETOR_ATENDIMENTO)
WHERE (X.CD_MATERIAL           = W.CD_MATERIAL);

