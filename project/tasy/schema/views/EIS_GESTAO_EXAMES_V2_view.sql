-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_gestao_exames_v2 (nr_prescricao, nr_seq_proced, dt_prescricao, cd_pessoa_dia, cd_medico, nm_medico, nm_usuario, cd_pessoa_fisica, ds_status_execucao, cd_setor_atendimento, nm_medico_executor, nm_medico_laudo, nr_seq_propaci, ds_setor_atendimento, nm_usuario_exec, ds_tipo_atend, ds_convenio, cd_convenio, ds_proced_princ_int, ds_tipo_convenio, ds_hora_procedimento, ds_tipo_procedimento, ds_especialidade, ds_grupo_proc, ds_setor_prescricao, ds_proc_exec, qt_filme, cd_empresa, cd_estabelecimento, ie_tipo_atendimento, cd_procedimento, nr_seq_proc_interno, ie_status_execucao, cd_especialidade, cd_setor_prescricao, nm_usuario_aprovacao, cd_medico_executor, ds_procedimento, ie_tipo_convenio, ds_interv_prescr, ds_interv_liber, ds_interv_exame, cd_hora_procedimento, dt_procedimento, cd_tipo_procedimento, cd_proc_exec, cd_grupo_proc, nr_seq_tamanho_filme, ds_procedimento_cod, nr_seq_exame, ds_tamanho_filme) AS select	distinct
	a.nr_prescricao,
                a.nr_seq_proced,
	trunc(a.dt_prescricao) dt_prescricao,
	a.cd_pessoa_fisica || ' - ' || to_char(a.dt_prescricao,'dd/mm/yyyy') cd_pessoa_dia,
	a.cd_medico,
	(select nm_pessoa_fisica FROM pessoa_fisica where cd_pessoa_fisica = a.cd_medico) nm_medico,
	a.nm_usuario,
	a.cd_pessoa_fisica,
	(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio where cd_dominio	= 1226 and vl_dominio = a.ie_status_execucao) ds_status_execucao,
	a.cd_setor_atendimento,
	(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = a.cd_medico_exec) nm_medico_executor,
	(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = a.cd_medico_resp) nm_medico_laudo,
	a.nr_seq_propaci,
	substr(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor_atendimento,
	a.nm_usuario_exec,
	(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio where cd_dominio	= 12 and vl_dominio	= a.ie_tipo_atendimento) ds_tipo_atend,
	(select max(ds_convenio) from convenio where cd_convenio = (select coalesce(max(cd_convenio),0) from atend_categoria_convenio z where z.nr_atendimento = a.nr_atendimento and z.dt_inicio_vigencia = (select max(dt_inicio_vigencia) from atend_categoria_convenio b where b.nr_atendimento = a.nr_atendimento))) ds_convenio,
	obter_convenio_atendimento(a.nr_atendimento) cd_convenio,
	substr((select max(ds_proc_interno) from procedimento x where x.cd_procedimento	= a.cd_procedimento and	x.ie_origem_proced 	= a.ie_origem_proced),1,200) ds_proced_princ_int,
	substr(obter_desc_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,100) ds_tipo_convenio,
	to_char(a.dt_procedimento,'hh24') || ':00' ds_hora_procedimento,
	(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio where cd_dominio = 95 and vl_dominio = a.cd_tipo_procedimento) ds_tipo_procedimento,
	substr((select max(x.ds_especialidade) from estrutura_procedimento_v x where x.cd_procedimento = a.cd_procedimento and x.ie_origem_proced = a.ie_origem_proced),1,80) ds_especialidade,
	substr((select max(x.ds_grupo_proc) from estrutura_procedimento_v x where x.cd_procedimento = a.cd_procedimento and x.ie_origem_proced = a.ie_origem_proced),1,80) ds_grupo_proc,
	substr((select max(x.ds_setor_atendimento) from	setor_atendimento x where x.cd_setor_atendimento = a.cd_setor_prescricao),1,100) ds_setor_prescricao,
	substr(obter_desc_prescr_proc(a.cd_proc_exec, a.ie_origem_exec, a.nr_seq_proc_interno_exec),1,60) ds_proc_exec,
	a.qt_filme,
	a.cd_empresa,
	to_char(a.cd_estabelecimento) cd_estabelecimento,
	a.ie_tipo_atendimento,
	a.cd_procedimento cd_procedimento,
	a.nr_seq_proc_interno,
	a.ie_status_execucao,
	substr((select max(x.cd_especialidade) from estrutura_procedimento_v x where x.cd_procedimento = a.cd_procedimento and x.ie_origem_proced = a.ie_origem_proced),1,80) cd_especialidade,
	a.cd_setor_prescricao,
	a.nm_usuario_aprovacao,
	a.cd_medico_executor,
	substr(obter_desc_prescr_proc(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,60) ds_procedimento,
	obter_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)) ie_tipo_convenio,
	obter_intervalo_minutos(obter_minutos_espera(a.dt_prescricao, a.dt_liberacao)) ds_interv_prescr,
	obter_intervalo_minutos(obter_minutos_espera(a.dt_liberacao, a.dt_inicio_exame)) ds_interv_liber,
	obter_intervalo_minutos(obter_minutos_espera(a.dt_inicio_exame, a.dt_baixa)) ds_interv_exame,
	(to_char(a.dt_procedimento,'hh24'))::numeric  cd_hora_procedimento,
	a.dt_procedimento,
	a.cd_tipo_procedimento,
	a.cd_proc_exec,
	a.cd_grupo_proc,
	a.nr_seq_tamanho_filme,
	substr(obter_desc_prescr_proc(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,60) || ' - ' || a.cd_procedimento ds_procedimento_cod,
	a.nr_seq_exame,
	substr((select	max(x.ds_tamanho) ds from tamanho_filme_padrao x where	x.nr_sequencia = a.nr_seq_tamanho_filme),1,50) ds_tamanho_filme
from eis_gestao_exame a;

