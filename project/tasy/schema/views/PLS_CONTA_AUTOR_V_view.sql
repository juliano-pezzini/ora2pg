-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_autor_v (ie_tipo_item, nr_seq_conta, nr_seq_item, qt_procedimento, cd_procedimento, ie_origem_proced, cd_guia, cd_guia_referencia, cd_senha, cd_senha_externa, nr_seq_guia, nr_seq_material, nr_seq_grau_partic, ie_glosa, ie_estagio_complemento, ie_status, dt_item, cd_guia_ok, nr_seq_segurado) AS select	CASE WHEN ie_tipo_despesa='3' THEN 'D'  ELSE 'P' END  ie_tipo_item,
	nr_seq_conta,
	nr_seq_item,
	qt_procedimento,
	cd_procedimento,
	ie_origem_proced,
	cd_guia,
	cd_guia_referencia,
	cd_senha,
	cd_senha_externa,
	nr_seq_guia,
	null nr_seq_material,
	nr_seq_grau_partic,
	ie_glosa,
	ie_estagio_complemento,
	ie_status,
	dt_item,
	cd_guia_ok,
	nr_seq_segurado
	--Sub select referente a busca dos procedimento diferentes de diária
FROM	(select a.nr_sequencia		nr_seq_conta, /*Não intercâmbio e que já estão com o status igual a liberado*/
		b.nr_sequencia 		nr_seq_item,
		b.qt_procedimento  	qt_procedimento,
		b.cd_procedimento 	cd_procedimento,
		b.ie_origem_proced	ie_origem_proced,
		a.cd_guia		cd_guia,
		a.cd_guia_referencia 	cd_guia_referencia,
		a.cd_senha		cd_senha,
		a.cd_senha_externa	cd_senha_externa,
		a.nr_seq_guia		nr_seq_guia,
		-- para intercâmbio verifica participante
		coalesce(a.nr_seq_grau_partic,      (select 	max(c.nr_seq_grau_partic)
						from	pls_proc_participante 	c
						where	c.nr_seq_conta_proc = b.nr_sequencia)) nr_seq_grau_partic,
		b.ie_glosa,
		a.ie_estagio_complemento,
		b.ie_status,
		b.dt_procedimento	dt_item,
		b.ie_tipo_despesa,
		a.cd_guia_ok,
		a.nr_seq_segurado
	from    pls_conta a,
	        pls_conta_proc b
	where   b.nr_seq_conta 		= a.nr_sequencia
	and   	((b.ie_status	 in ('S','L')) and (b.ie_glosa is null or b.ie_glosa = 'N'))
	and	((b.nr_seq_proc_ref is null) or (b.nr_seq_proc_ref = b.nr_sequencia) or (exists
											(select 1
											from 	pls_conta_proc x
											where 	x.nr_sequencia = b.nr_seq_proc_ref
											and	((x.ie_status in ('U','D')) or (x.ie_glosa = 'S')))))
	
union all

	select  a.nr_sequencia		nr_seq_conta, /*Não intercâmbio e que já estão com o status diferente de  liberado, tratado ainda para buscar as contas de complemente desde que estas não estejam com o staus igual a cancelada*/
		b.nr_sequencia 		nr_seq_item,
		b.qt_procedimento_imp  	qt_procedimento,
		b.cd_procedimento 	cd_procedimento,
		b.ie_origem_proced	ie_origem_proced,
		a.cd_guia		cd_guia,
		a.cd_guia_referencia 	cd_guia_referencia,
		a.cd_senha		cd_senha,
		a.cd_senha_externa	cd_senha_externa,
		a.nr_seq_guia		nr_seq_guia,
		-- para intercâmbio verifica participante
		coalesce(a.nr_seq_grau_partic,      (select 	max(c.nr_seq_grau_partic)
						from	pls_proc_participante 	c
						where	c.nr_seq_conta_proc = b.nr_sequencia)) nr_seq_grau_partic,
		b.ie_glosa,
		a.ie_estagio_complemento,
		b.ie_status,
		b.dt_procedimento	dt_item,
		b.ie_tipo_despesa,
		a.cd_guia_ok,
		a.nr_seq_segurado
	from    pls_conta a,
		pls_conta_proc b
	where   b.nr_seq_conta 		= a.nr_sequencia
	and	((b.nr_seq_proc_ref is null) or (b.nr_seq_proc_ref = b.nr_sequencia) or (exists
											(select 1
											from 	pls_conta_proc x
											where 	x.nr_sequencia = b.nr_seq_proc_ref
											and	((x.ie_status in ('U','D')) or (x.ie_glosa = 'S')))))
	and   	(
		-- Considera qualquer item que esteja com a Operadora.
		(b.ie_status in ('P','C','A')) or
			-- Para contas no complemento (portal) deve considerar itens cancelados ou usuário aguardando ação também, desde que o complemento ainda seja válido.
			(
			-- Verifica se a conta ainda está no complemento.
			(a.ie_estagio_complemento in ('1', '2', '4', '5')) and
			-- Se estiver no complemento o item pode estar cancelado, usuário aguardando ação,  consistido ou glosado que o mesmo deve ser considerado.
			--Removida os itens cancelados da restrição(OS 1127414 à pedido do Carlos)
			(b.ie_status in ('U','C') or (b.ie_glosa = 'S'))
			)
		)
	
union all

	select	conta.nr_sequencia		nr_seq_conta,
		proc.nr_sequencia		nr_seq_item,
		proc.qt_executado		qt_procedimento,
		proc.cd_procedimento_conv	cd_procedimento,
		proc.ie_origem_proced_conv	ie_origem_proced,
		conta.cd_guia_operadora_conv	cd_guia,
		conta.cd_guia_principal_conv	cd_guia_referencia,
		conta.cd_senha			cd_senha,
		null				cd_senha_externa,
		conta.nr_seq_guia_conv		nr_seq_guia,
		null				nr_seq_grau_partic,
		'N'				ie_glosa,
		null				ie_estagio_complemento,
		'A'				ie_status,
		proc.dt_execucao_conv		dt_item,
		ie_tipo_despesa_conv		ie_tipo_desepesa,
		conta.cd_guia_ok_conv		cd_guia_ok,
		conta.nr_seq_segurado_conv	nr_seq_segurado
	from	pls_protocolo_conta_imp prot,
		pls_conta_imp conta,
		pls_conta_proc_imp proc
	where	prot.ie_situacao in ('A','D','I')
	and	conta.nr_seq_protocolo = prot.nr_sequencia
	and	proc.nr_seq_conta = conta.nr_sequencia
) alias38

union all

select	'M' ie_tipo_item,
	nr_seq_conta,
	nr_seq_item,
	qt_procedimento,
	null	cd_procedimento,
	null	ie_origem_proced,
	cd_guia,
	cd_guia_referencia,
	cd_senha,
	cd_senha_externa,
	nr_seq_guia,
	nr_seq_material,
	null nr_seq_grau_partic,
	ie_glosa,
	ie_estagio_complemento,
	ie_status,
	null dt_item,
	cd_guia_ok,
	nr_seq_segurado
from	(select a.nr_sequencia		nr_seq_conta,
		b.nr_sequencia 	nr_seq_item,
		b.qt_material  	qt_procedimento,
		a.cd_guia		cd_guia,
		a.cd_guia_referencia 	cd_guia_referencia,
		a.cd_senha		cd_senha,
		a.cd_senha_externa	cd_senha_externa,
		a.nr_seq_guia		nr_seq_guia,
		b.nr_seq_material	nr_seq_material,
		b.ie_glosa,
		a.ie_estagio_complemento,
		b.ie_status,
		a.cd_guia_ok,
		a.nr_seq_segurado
	from    pls_conta a,
	        pls_conta_mat b
	where   b.nr_seq_conta 		= a.nr_sequencia
	and   	((b.ie_status	 in ('S','L')) and (b.ie_glosa is null or b.ie_glosa = 'N'))
	
union all

	select  a.nr_sequencia		nr_seq_conta,
		b.nr_sequencia 		nr_seq_item,
		b.qt_material_imp 	qt_procedimento,
		a.cd_guia		cd_guia,
		a.cd_guia_referencia 	cd_guia_referencia,
		a.cd_senha		cd_senha,
		a.cd_senha_externa	cd_senha_externa,
		a.nr_seq_guia		nr_seq_guia,
		b.nr_seq_material	nr_seq_material,
		b.ie_glosa,
		a.ie_estagio_complemento,
		b.ie_status,
		a.cd_guia_ok,
		a.nr_seq_segurado
	from    pls_conta a,
		pls_conta_mat b
	where   b.nr_seq_conta 		= a.nr_sequencia
	and   	(
		-- Considera qualquer item que esteja com a Operadora.
		(b.ie_status in ('P','C','A')) or
			-- Para contas no complemento (portal) deve considerar itens cancelados ou usuário aguardando ação também, desde que o complemento ainda seja válido.
			(
			-- Verifica se a conta ainda está no complemento.
			(a.ie_estagio_complemento in ('1', '2', '4', '5')) and
			-- Se estiver no complemento o item pode estar cancelado, usuário aguardando ação,  consistido ou glosado que o mesmo deve ser considerado.
			--Removida os itens cancelados da restrição(OS 1127414 à pedido do Carlos)
			(b.ie_status in ('U','C') or (b.ie_glosa = 'S'))
			)
		)
	
union all

	select	conta.nr_sequencia		nr_seq_conta,
		mat.nr_sequencia		nr_seq_item,
		mat.qt_executado		qt_procedimento,
		conta.cd_guia_operadora_conv	cd_guia,
		conta.cd_guia_principal_conv	cd_guia_referencia,
		conta.cd_senha			cd_senha,
		null				cd_senha_externa,
		conta.nr_seq_guia_conv		nr_seq_guia,
		mat.nr_seq_material_conv	nr_seq_material,
		'N'				ie_glosa,
		null				ie_estagio_complemento,
		'A'				ie_status,
		conta.cd_guia_ok_conv		cd_guia_ok,
		conta.nr_seq_segurado_conv	nr_seq_segurado
	from	pls_protocolo_conta_imp prot,
		pls_conta_imp conta,
		pls_conta_mat_imp mat
	where	prot.ie_situacao in ('A','D','I')
	and	conta.nr_seq_protocolo	= prot.nr_sequencia
	and	mat.nr_seq_conta	= conta.nr_sequencia
) alias53;

