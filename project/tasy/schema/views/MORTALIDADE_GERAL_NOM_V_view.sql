-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mortalidade_geral_nom_v (nr_atendimento, defvio_fam, defactamp, defdesc_les, defdom_acc, defcol_acc, defent_acc, defdel_acc, defloc_acc, defnombinfor, defpatinfor, defmatinfor, defparentinfor) AS SELECT	a.nr_atendimento,
		coalesce((SELECT (CASE WHEN(MAX(x.ie_vinculo_conjuge) = '1') THEN '01'
		WHEN(MAX(x.ie_vinculo_filho) = '1') THEN '02'
		WHEN(MAX(x.ie_vinculo_ex_conjuge) = '1') THEN '03'
		WHEN(MAX(x.ie_vinculo_pai) = '1' OR MAX(x.ie_vinculo_mae) = '1') THEN '04'
		WHEN(MAX(x.ie_vinculo_irmao) = '1') THEN '05'
		WHEN(MAX(x.IE_VINCULO_PADASTRO) = '1') OR (MAX(x.IE_VINCULO_MADASTRA) = '1') OR (MAX(x.IE_VINCULO_NAMORADO) = '1') OR (MAX(x.IE_VINCULO_EX_NAMORADO) = '1') THEN '11'
		WHEN(MAX(x.IE_VINCULO_AMIGOS) = '1') OR (MAX(x.IE_VINCULO_DESCONHECIDO) = '1') OR (MAX(x.IE_VINCULO_CUIDADOR) = '1') OR (MAX(x.IE_VINCULO_CHEFE) = '1') OR (MAX(x.IE_VINCULO_INSTITUCIONAL) = '1') OR (MAX(x.IE_VINCULO_POLICIAL) = '1') THEN '12'
		ELSE '99' END)
		FROM sinan_dados_agressao x, notificacao_sinan z, cih_doenca_compulsoria w
		WHERE x.nr_seq_notificacao = z.nr_sequencia
		AND z.nr_seq_doenca_compulsoria = w.nr_sequencia
		AND w.ie_tipo_doenca = 'V'
		AND z.nr_atendimento = a.nr_atendimento),'88') DEFVIO_FAM,
	coalesce((SELECT TO_CHAR(MAX(x.nr_notificacao)) FROM notificacao_sinan x, notificacao_sinan z, cih_doenca_compulsoria w WHERE x.nr_sequencia = z.nr_sequencia AND z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento),'NO APLICA') DEFACTAMP,
	SUBSTR(coalesce(dd.ds_diagnostico,'NO APLICA'),1,150) DEFDESC_LES,
	SUBSTR(coalesce((SELECT UPPER(Elimina_Acentuacao(MAX(x.ds_endereco))) FROM cih_doenca_compulsoria w, notificacao_sinan z
LEFT OUTER JOIN sinan_dados_ocorrencia x ON (z.nr_sequencia = x.nr_seq_notificacao)
WHERE z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento ),'NO APLICA'),1,80) DEFDOM_ACC,
	SUBSTR(coalesce((SELECT UPPER(Elimina_Acentuacao(MAX(x.ds_bairro))) FROM cih_doenca_compulsoria w, notificacao_sinan z
LEFT OUTER JOIN sinan_dados_ocorrencia x ON (z.nr_sequencia = x.nr_seq_notificacao)
WHERE z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento ),'NO APLICA'),1,60) DEFCOL_ACC,
	LPAD(coalesce((SELECT MAX(x.nr_seq_entidade) FROM cih_doenca_compulsoria w, notificacao_sinan z
LEFT OUTER JOIN sinan_dados_ocorrencia x ON (z.nr_sequencia = x.nr_seq_notificacao)
WHERE z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento ),'88'),2,'0') DEFENT_ACC,
	LPAD(coalesce((SELECT MAX(x.nr_seq_municipio) FROM cih_doenca_compulsoria w, notificacao_sinan z
LEFT OUTER JOIN sinan_dados_ocorrencia x ON (z.nr_sequencia = x.nr_seq_notificacao)
WHERE z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento ),'888'),3,'0') DEFDEL_ACC,
	LPAD(coalesce((SELECT MAX(x.nr_seq_localidade) FROM cih_doenca_compulsoria w, notificacao_sinan z
LEFT OUTER JOIN sinan_dados_ocorrencia x ON (z.nr_sequencia = x.nr_seq_notificacao)
WHERE z.nr_seq_doenca_compulsoria = w.nr_sequencia AND w.ie_tipo_doenca = 'V' AND z.nr_atendimento = a.nr_atendimento ),'8888'),4,'0') DEFLOC_ACC,
	RPAD(coalesce(y.ds_given_name,'SIN INFORMACION'),40) DEFNOMBINFOR,
	RPAD(coalesce(y.ds_family_name,'SIN INFORMACION'),20) DEFPATINFOR,
	RPAD(coalesce(y.ds_component_name_1,'SIN INFORMACION'),20) DEFMATINFOR,
	coalesce(LPAD((SELECT x.cd_grau_parentesco_mx FROM cat_grau_parentesco x WHERE x.nr_sequencia = (SELECT p.cd_parentesco_mx FROM grau_parentesco p WHERE p.nr_sequencia = d.nr_seq_parentesco)),2,'0'),'99') DEFPARENTINFOR
FROM	atendimento_paciente a,
	declaracao_obito d,
	diagnostico_doenca dd,
	person_name y
WHERE 	a.nr_atendimento = d.nr_atendimento
and	d.nr_seq_person_name = y.nr_sequencia
AND	y.ds_type = 'main'
AND 	a.nr_atendimento = dd.nr_atendimento
AND	d.dt_inativacao IS NULL
AND 	d.dt_liberacao IS NOT NULL
AND 	d.dt_obito IS NOT NULL;

