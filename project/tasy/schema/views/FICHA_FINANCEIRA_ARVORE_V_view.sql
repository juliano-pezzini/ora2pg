-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ficha_financeira_arvore_v (cd, seq, compl, ds, ie_tipo, ie_tipo_pessoa, cd_perfil, tree_node, code, cd_pessoa, ie_limpar_node) AS SELECT a.cd_pessoa_fisica cd,
  '1' seq, 
  1 compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,100) ds, 
  'C' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  1 code, 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM pessoa_fisica a 
 
UNION ALL
 
 SELECT DISTINCT TO_CHAR(k.cd_cgc) cd, 
  '99' seq, 
  10 compl, 
  SUBSTR(obter_razao_social(k.cd_cgc),1,100) ds, 
  'P' ie_tipo, 
  'PJ' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  895152 tree_node, 
  -1 code, 
  k.cd_cgc cd_pessoa, 
  '' ie_limpar_node 
 FROM pessoa_juridica k 
 WHERE 1 = 1 
 
UNION ALL
 
 SELECT a.cd_pessoa_fisica_ref cd, 
  a.cd_pessoa_fisica_ref seq, 
  a.ie_tipo_complemento compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica_ref),1,100) ds, 
  'C' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  2 code, --Conjuje 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM compl_pessoa_fisica a 
 WHERE a.IE_TIPO_COMPLEMENTO = 6 
 AND a.cd_pessoa_fisica_ref IS NOT NULL 
 
UNION ALL
 
 SELECT a.cd_pessoa_fisica_ref cd, 
  a.cd_pessoa_fisica_ref seq, 
  a.ie_tipo_complemento compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica_ref),1,100) ds, 
  'C' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  2.1 code, --Pai 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM compl_pessoa_fisica a 
 WHERE a.IE_TIPO_COMPLEMENTO = 1 
 AND a.cd_pessoa_fisica_ref IS NOT NULL 
 
UNION ALL
 
 SELECT a.cd_pessoa_fisica_ref cd, 
  a.cd_pessoa_fisica_ref seq, 
  a.ie_tipo_complemento compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica_ref),1,100) ds, 
  'C' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  2.2 code , --Mae 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM compl_pessoa_fisica a 
 WHERE a.IE_TIPO_COMPLEMENTO = 5 
 AND a.cd_pessoa_fisica_ref IS NOT NULL 
 
UNION ALL
 
 SELECT DISTINCT a.cd_pessoa_dependente cd, 
  '99', 
  7 compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_dependente),1,100) ds, 
  'D' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  3 code, --DEPENDENTE 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM pessoa_fisica_dependente a 
 WHERE a.cd_pessoa_dependente <> a.cd_pessoa_fisica 
 
UNION ALL
 
 SELECT DISTINCT b.cd_pessoa_fisica cd, 
  '99', 
  8 compl, 
  SUBSTR(obter_nome_pf(b.cd_pessoa_fisica),1,100) ds, 
  'P' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  3 code, --DEPENDENTE 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM atendimento_pagador b, 
  atendimento_paciente a 
 WHERE a.nr_atendimento = b.nr_atendimento 
 AND b.cd_pessoa_fisica <> a.cd_pessoa_fisica 
 AND NOT EXISTS (SELECT 1 
  FROM compl_pessoa_fisica x 
  WHERE x.cd_pessoa_fisica  = a.cd_pessoa_fisica 
  AND x.cd_pessoa_fisica_ref = b.cd_pessoa_fisica 
  ) 
 
UNION ALL
 
 SELECT DISTINCT a.cd_pessoa_responsavel cd, 
  '99', 
  9 compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_responsavel),1,100) ds, 
  'R' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  6 code, -- Responsavel 
  a.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM atendimento_paciente a 
 WHERE a.cd_pessoa_responsavel <> a.cd_pessoa_fisica 
 AND NOT EXISTS (SELECT 1 
  FROM compl_pessoa_fisica x 
  WHERE x.cd_pessoa_fisica  = a.cd_pessoa_fisica 
  AND x.cd_pessoa_fisica_ref = a.cd_pessoa_fisica 
  ) 
 AND NOT EXISTS (SELECT 1 
  FROM atendimento_pagador x 
  WHERE x.nr_atendimento = a.nr_atendimento 
  AND x.cd_pessoa_fisica = a.CD_PESSOA_RESPONSAVEL 
  ) 
 
UNION ALL
 
 SELECT DISTINCT a.cd_pessoa_fisica cd, 
  '99', 
  10 compl, 
  SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,100) ds, 
  'P' ie_tipo, 
  'PF' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  894178 tree_node, 
  4 code, --PAGADOR OPS 
  b.cd_pessoa_fisica cd_pessoa, 
  '' ie_limpar_node 
 FROM pls_contrato_pagador a, 
  pls_segurado b 
 WHERE a.nr_sequencia  = b.nr_seq_pagador 
 AND a.cd_pessoa_fisica <> b.cd_pessoa_fisica 
 AND a.cd_pessoa_fisica IS NOT NULL 
 
UNION ALL
 
 SELECT DISTINCT TO_CHAR(a.cd_cgc) cd, 
  '99', 
  10 compl, 
  SUBSTR(obter_razao_social(a.cd_cgc),1,100) ds, 
  'P' ie_tipo, 
  'PJ' ie_tipo_pessoa, 
  wheb_usuario_pck.get_cd_perfil cd_perfil, 
  895152 tree_node, 
  4 code, --PAGADOR OPS 
  b.cd_pessoa_fisica cd_pessoa, 
  'N' ie_limpar_node 
 FROM pls_contrato_pagador a, 
  pls_segurado b 
 WHERE a.nr_sequencia = b.nr_seq_pagador 
 AND a.cd_cgc    IS NOT NULL;

