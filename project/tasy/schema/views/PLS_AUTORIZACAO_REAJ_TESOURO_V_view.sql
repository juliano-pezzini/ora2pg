-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_autorizacao_reaj_tesouro_v (nr_seq_pagador, cd_matricula_pag, ie_tipo_registro, ds_movimento, cd_consignatoria, cd_matricula, cd_vinculo_est, nr_pensao, ds_especie, cd_autenticidade, dt_referencia, vl_autorizado, dt_inicial, dt_final, ie_status, nm_usuario) AS select	null nr_seq_pagador,
	null cd_matricula_pag,
	1 ie_tipo_registro,
	'H' ds_movimento,
	'GOV627' cd_consignatoria,
	null cd_matricula,
	null cd_vinculo_est,
	null nr_pensao,
	null ds_especie,
	null cd_autenticidade,
	to_char(LOCALTIMESTAMP,'yyyymm') dt_referencia,
	null vl_autorizado,
	null dt_inicial,
	null dt_final,
	null ie_status,
	null nm_usuario


union all

select	rpad(b.nr_seq_pagador,40,0) nr_seq_pagador,
	'D' || rpad(e.cd_matricula,12,0) cd_matricula_pag,
	2 ie_tipo_registro,
	null ds_movimento,
	null cd_consignatoria,
	lpad(coalesce(cd_matricula_estipulante,0),8,0) cd_matricula,
	lpad(coalesce(a.nr_seq_vinculo_est,0),2,0) cd_vinculo_est,
	00 nr_pensao,
	rpad('MENSALIDADE',20,' ') ds_especie,
	lpad(0,10,0) cd_autenticidade,
	to_char(a.dt_mesano_referencia,'yyyymmdd') dt_referencia,
	lpad(obter_Valor_sem_virgula(sum(a.vl_agrupado)),9,0) vl_autorizado,
	to_char(a.dt_mesano_referencia,'yyyymmdd') dt_inicial,
	to_char(a.dt_mesano_referencia,'yyyymmdd') dt_final,
	'A' ie_status,
	a.nm_usuario
from	w_pls_interface_mens		a,
	pls_segurado			b,
	pls_mensalidade			c,
	pls_contrato_pagador		d,
	pls_contrato_pagador_fin	e
where	a.nr_seq_segurado	= b.nr_sequencia
and	a.nr_seq_mensalidade 	= c.nr_sequencia
and	b.nr_seq_pagador	= d.nr_sequencia
and	c.nr_seq_pagador	= d.nr_sequencia
and	d.nr_sequencia		= e.nr_seq_pagador
and	c.dt_referencia between e.dt_inicio_vigencia and coalesce(e.dt_fim_vigencia,c.dt_referencia)
and	c.dt_cancelamento is null
group by b.nr_seq_pagador, e.cd_matricula, cd_matricula_estipulante, a.nr_seq_vinculo_est, a.dt_mesano_referencia, a.nm_usuario;

