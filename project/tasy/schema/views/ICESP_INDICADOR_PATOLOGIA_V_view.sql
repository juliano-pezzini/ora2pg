-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW icesp_indicador_patologia_v (ie_tipo, qt, ds, dt_liberacao, dt_liberacao_laudo, qt_dias_etapa, nr_seq_morf_desc_adic) AS SELECT	1 ie_tipo,
	COUNT(DISTINCT b.nr_sequencia) qt,
	d.ds_amostra ds,
	a.dt_liberacao,
	c.dt_liberacao dt_liberacao_laudo,
	sum(c.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  b.NR_SEQ_MORF_DESC_ADIC
FROM tipo_amostra_patologia d, prescr_medica a, prescr_proc_peca b
LEFT OUTER JOIN laudo_paciente c ON (b.nr_seq_laudo = c.nr_sequencia)
WHERE a.nr_prescricao = b.nr_prescricao  and d.nr_sequencia = b.nr_seq_amostra_princ AND b.nr_seq_peca IS NULL and not exists (select 1 from prescr_proc_peca x where x.nr_seq_peca = b.nr_sequencia and b.NR_SEQ_EXAME_COMPLEMENTAR is not null) GROUP BY a.dt_liberacao,
	c.dt_liberacao,
	d.ds_amostra,
  NR_SEQ_MORF_DESC_ADIC

union

SELECT	2 ie_tipo,
	COUNT(DISTINCT b.nr_sequencia) qt,
	d.ds_tipo_amostra ds,
	a.dt_liberacao,
	c.dt_liberacao dt_liberacao_laudo,
	sum(c.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  b.NR_SEQ_MORF_DESC_ADIC
FROM tipo_amostra d, prescr_medica a, prescr_proc_peca b
LEFT OUTER JOIN laudo_paciente c ON (b.nr_seq_laudo = c.nr_sequencia)
WHERE a.nr_prescricao = b.nr_prescricao  and d.nr_sequencia = b.nr_seq_tipo AND b.nr_seq_peca IS NULL and not exists (select 1 from prescr_proc_peca x where x.nr_seq_peca = b.nr_sequencia and b.NR_SEQ_EXAME_COMPLEMENTAR is not null) GROUP BY a.dt_liberacao,
	c.dt_liberacao,
	d.ds_tipo_amostra,
  b.NR_SEQ_MORF_DESC_ADIC

union

SELECT	3 ie_tipo,
	COUNT(DISTINCT a.nr_sequencia) qt,
	CASE WHEN coalesce(a.NR_SEQ_EXAME_COMPLEMENTAR,0)=0 THEN  ''  ELSE 'Exame complementar - ' END ||SUBSTR(obter_valor_dominio(3253,IE_TIPO_DESIGNACAO),1,255) ds,
	d.dt_liberacao,
	e.dt_liberacao dt_liberacao_laudo,
	sum(e.dT_liberacao-d.dt_liberacao) qt_dias_etapa,
  a.NR_SEQ_MORF_DESC_ADIC
FROM prescr_medica d, prescr_proc_peca a
LEFT OUTER JOIN tipo_amostra b ON (a.NR_SEQ_TIPO = b.nr_sequencia)
LEFT OUTER JOIN tipo_amostra_patologia c ON (a.NR_SEQ_AMOSTRA_PRINC = c.nr_sequencia)
LEFT OUTER JOIN laudo_paciente e ON (a.nr_seq_laudo = e.nr_sequencia)
WHERE 1 = 1   AND d.nr_prescricao = a.nr_prescricao  AND a.ie_status <> 'C' GROUP BY CASE WHEN coalesce(a.NR_SEQ_EXAME_COMPLEMENTAR,0)=0 THEN  ''  ELSE 'Exame complementar - ' END ||SUBSTR(obter_valor_dominio(3253,IE_TIPO_DESIGNACAO),1,255),
	d.dt_liberacao,
	e.dt_liberacao,
  a.NR_SEQ_MORF_DESC_ADIC

union

SELECT	4 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	CASE WHEN coalesce(d.nr_Seq_superior,-1)=-1 THEN ''  ELSE 'Laudo complementar - ' END ||
	CASE
	WHEN d.dt_cancelamento IS NOT NULL THEN 'Cancelado'
	WHEN d.dt_liberacao IS NOT NULL THEN 'Laudo liberado'
	WHEN d.dt_liberacao IS NULL THEN 'Laudo não liberado' END ds_sit_laudo,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	coalesce(ie_anatomia_patologica,'S') = 'S'
GROUP BY CASE WHEN coalesce(d.nr_Seq_superior,-1)=-1 THEN ''  ELSE 'Laudo complementar - ' END ||
	CASE
	WHEN d.dt_cancelamento IS NOT NULL THEN 'Cancelado'
	WHEN d.dt_liberacao IS NOT NULL THEN 'Laudo liberado'
	WHEN d.dt_liberacao IS NULL THEN 'Laudo não liberado' END,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	5 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	substr(obter_desc_morfologia(e.cd_morfologia, e.NR_SEQ_MORF_DESC_ADIC),1,200) ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  e.NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d,
	LAUDO_CIDO_MORFOLOGIA e
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	d.nr_sequencia = e.nr_seq_laudo
and	coalesce(ie_anatomia_patologica,'S') = 'S'
GROUP BY substr(obter_desc_morfologia(e.cd_morfologia, e.NR_SEQ_MORF_DESC_ADIC),1,200),
	a.dt_liberacao,
	d.dt_liberacao,
  e.NR_SEQ_MORF_DESC_ADIC

union

select	6 ie_tipo,
	count(distinct a.nr_prescricao) qt,
	substr(obter_nome_setor(a.cd_setor_atendimento),1,200) ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM exame_laboratorio c, prescr_medica a, prescr_procedimento b
LEFT OUTER JOIN laudo_paciente d ON (b.nr_prescricao = d.nr_prescricao AND b.nr_sequencia = d.nr_seq_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.nr_seq_exame = c.nr_seq_exame   and coalesce(c.ie_anatomia_patologica,'S') = 'S' group by a.cd_setor_atendimento,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	7 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	CASE WHEN d.ie_tumor='N' THEN 'Não tumoral' WHEN d.ie_tumor='S' THEN 'Tumoral benigno' WHEN d.ie_tumor='M' THEN 'Tumoral maligno' END  ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	coalesce(ie_anatomia_patologica,'S') = 'S'
GROUP BY CASE WHEN d.ie_tumor='N' THEN 'Não tumoral' WHEN d.ie_tumor='S' THEN 'Tumoral benigno' WHEN d.ie_tumor='M' THEN 'Tumoral maligno' END ,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	8 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	substr(obter_nome_pf(e.cd_pessoa_fisica),1,200) ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d,
	usuario e
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	coalesce(ie_anatomia_patologica,'S') = 'S'
and	d.nm_usuario_liberacao = e.nm_usuario
and	d.dt_liberacao is not null
GROUP BY e.cd_pessoa_fisica,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	8 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	substr(obter_nome_pf(e.cd_medico),1,200) ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d,
	laudo_paciente_medico e
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	d.nr_sequencia = e.nr_seq_laudo
and	coalesce(ie_anatomia_patologica,'S') = 'S'
and	d.dt_liberacao is not null
and	not exists (select 1 from usuario x where x.cd_pessoa_fisica = e.cd_medico and x.nm_usuario = d.nm_usuario_liberacao)
GROUP BY e.cd_medico,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	9 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	'Médico Patologista' ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	coalesce(ie_anatomia_patologica,'S') = 'S'
and	d.dt_liberacao is not null
GROUP BY
	a.dt_liberacao,
	d.dt_liberacao  

union

SELECT	9 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	DS_LAUDO_MEDICO_CLASSIF ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d,
	laudo_paciente_medico e,
	laudo_medico_classif f
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	d.nr_sequencia = e.nr_seq_laudo
and	e.nr_seq_laudo_medico_classif = f.nr_sequencia
and	coalesce(ie_anatomia_patologica,'S') = 'S'
and	d.dt_liberacao is not null
and	not exists (select 1 from usuario x where x.cd_pessoa_fisica = e.cd_medico and x.nm_usuario = d.nm_usuario_liberacao)
GROUP BY  DS_LAUDO_MEDICO_CLASSIF,
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	10 ie_tipo,
	COUNT(DISTINCT d.nr_sequencia) qt,
	substr(obter_sexo_pf(a.cd_pessoa_fisica, 'D'),1,200) ds,
	a.dt_liberacao,
	d.dt_liberacao dt_liberacao_laudo,
	sum(d.dT_liberacao-a.dt_liberacao) qt_dias_etapa,
  0 NR_SEQ_MORF_DESC_ADIC
FROM  	prescR_medica a,
	prescr_procedimento b,
	exame_laboratorio c,
	laudo_paciente d
WHERE	a.nr_prescricao = b.nr_prescricao
AND	b.nr_seq_exame = c.nr_seq_exame
AND	b.nr_prescricao = d.nr_prescricao
AND	b.nr_sequencia = d.nr_Seq_prescricao
and	coalesce(ie_anatomia_patologica,'S') = 'S'
and	CASE WHEN d.ie_tumor='N' THEN 'Não tumoral' WHEN d.ie_tumor='S' THEN 'Tumoral benigno' WHEN d.ie_tumor='M' THEN 'Tumoral maligno' END  is not null
GROUP BY substr(obter_sexo_pf(a.cd_pessoa_fisica, 'D'),1,200),
	a.dt_liberacao,
	d.dt_liberacao

union

SELECT	11 ie_tipo,
	COUNT(DISTINCT a.nr_sequencia) qt,	
	SUBSTR(obter_descricao_padrao('PATOLOGIA_EXAME_COMPL','DS_EXAME_COMPL',a.NR_SEQ_PATO_EXAME),1,255) ds,
	d.dt_liberacao,
	e.dt_liberacao dt_liberacao_laudo,
	sum(e.dT_liberacao-d.dt_liberacao) qt_dias_etapa,
  a.NR_SEQ_MORF_DESC_ADIC
FROM prescr_medica d, prescr_proc_peca a
LEFT OUTER JOIN tipo_amostra b ON (a.NR_SEQ_TIPO = b.nr_sequencia)
LEFT OUTER JOIN tipo_amostra_patologia c ON (a.NR_SEQ_AMOSTRA_PRINC = c.nr_sequencia)
LEFT OUTER JOIN laudo_paciente e ON (a.nr_seq_laudo = e.nr_sequencia)
WHERE 1 = 1   AND d.nr_prescricao = a.nr_prescricao  AND a.ie_status <> 'C' and a.NR_SEQ_EXAME_COMPLEMENTAR is not null GROUP BY SUBSTR(obter_descricao_padrao('PATOLOGIA_EXAME_COMPL','DS_EXAME_COMPL',a.NR_SEQ_PATO_EXAME),1,255),
	d.dt_liberacao,
	e.dt_liberacao,
  a.NR_SEQ_MORF_DESC_ADIC;

