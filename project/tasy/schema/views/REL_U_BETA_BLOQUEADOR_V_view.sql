-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rel_u_beta_bloqueador_v (nr_atendimento, ie_uso) AS SELECT NR_ATENDIMENTO,
       IE_USO
  FROM (
        --beta blocker em uso
        SELECT DISTINCT PMU.NR_ATENDIMENTO,
               'S' IE_USO
          FROM PACIENTE_MEDIC_USO PMU
         WHERE OBTER_CLASSE_MATERIAL(PMU.CD_MATERIAL) IN (
                SELECT CD_CLASSE_MATERIAL
                  FROM CLASSE_MATERIAL
                 WHERE IE_CLASSE_MATERIAL_REL = 5
               )

UNION

        --evento
        SELECT DISTINCT APA.NR_ATENDIMENTO,
               'S' IE_USO
          FROM AVAL_PRE_ANESTESICA APA
         INNER JOIN CIRURGIA CIR
            ON CIR.NR_ATENDIMENTO = APA.NR_ATENDIMENTO
           AND CIR.CD_PROCEDIMENTO_PRINC = APA.CD_PROCEDIMENTO
          LEFT JOIN AVAL_PRE_ANEST_DIAG PAD
            ON PAD.NR_SEQ_AVAL_PRE = APA.NR_SEQUENCIA
           AND PAD.NR_SEQ_DIAG = 139 --NR_SEQ_DIAG
         
UNION

        --dentro do cc
        SELECT DISTINCT CIR.NR_ATENDIMENTO,
               'S' IE_USO
          FROM CIRURGIA_V CIR
         INNER JOIN CIRURGIA_AGENTE_ANESTESICO CAA
            ON CAA.NR_CIRURGIA = CIR.NR_CIRURGIA
           AND CAA.IE_SITUACAO = 'A'
         INNER JOIN CIRURGIA_AGENTE_ANEST_OCOR CAO
            ON CAO.NR_SEQ_CIRUR_AGENTE = CAA.NR_SEQUENCIA
           AND CAO.DT_FINAL_ADM IS NOT NULL
           AND CAO.IE_SITUACAO = 'A'
         WHERE OBTER_CLASSE_MATERIAL(CAA.CD_MATERIAL) IN (
                SELECT CD_CLASSE_MATERIAL
                  FROM CLASSE_MATERIAL
                 WHERE IE_CLASSE_MATERIAL_REL = 5
               )
         
UNION

        -- ajustar esse trecho
        --fora do cc
        SELECT DISTINCT PMA.NR_ATENDIMENTO,
               'S' IE_USO
          FROM PRESCR_MAT_ALTERACAO PMA
         INNER JOIN PRESCR_MEDICA PME
            ON PME.NR_PRESCRICAO = PMA.NR_PRESCRICAO
         INNER JOIN PRESCR_MATERIAL PRM
            ON PRM.NR_PRESCRICAO = PMA.NR_PRESCRICAO
         INNER JOIN MATERIAL MAT
            ON MAT.CD_MATERIAL = PRM.CD_MATERIAL
           AND MAT.CD_CLASSE_MATERIAL IN (
                SELECT CD_CLASSE_MATERIAL
                  FROM CLASSE_MATERIAL
                 WHERE IE_CLASSE_MATERIAL_REL = 5
               )
        -- ajustar esse trecho
) alias5;

