-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW material_em_devolucao_v (nr_atendimento, dt_entrada_unidade, cd_material, cd_material_dev, cd_material_prescricao, nr_prescricao, nr_sequencia_prescricao, dt_atendimento, qt_material, cd_unidade_medida, cd_local_estoque, cd_setor_atendimento, nr_sequencia, nr_interno_conta, dt_conta, dt_dia_conta, cd_motivo_baixa, ie_prescr_dev, nr_seq_cor_exec, nr_seq_lote_ap, cd_kit_material, nr_devolucao, nr_doc_interno, nr_seq_processo, nr_seq_lote_fornec, nr_kit_estoque, cd_convenio) AS SELECT	/*+ INDEX (A MATPACI_I2) */
	A.NR_ATENDIMENTO,
	A.DT_ENTRADA_UNIDADE,
	coalesce(A.CD_MATERIAL_EXEC, A.CD_MATERIAL) CD_MATERIAL,
	A.CD_MATERIAL CD_MATERIAL_DEV,
	A.cd_material_prescricao,
	A.NR_PRESCRICAO,
	A.NR_SEQUENCIA_PRESCRICAO,
	A.DT_ATENDIMENTO,
	coalesce(A.QT_ESTOQUE, A.QT_MATERIAL) QT_MATERIAL,
	A.CD_UNIDADE_MEDIDA,
	A.CD_LOCAL_ESTOQUE,
	A.CD_SETOR_ATENDIMENTO,
	CASE WHEN A.qt_devolvida IS NULL THEN  A.NR_SEQUENCIA  ELSE 0 END  nr_sequencia,
	A.NR_INTERNO_CONTA,
	coalesce(A.DT_CONTA, A.DT_ATENDIMENTO) DT_CONTA,
	trunc(coalesce(A.DT_CONTA, A.DT_ATENDIMENTO),'dd') DT_DIA_CONTA,
	Obter_Motivo_Baixa_Prescr_Mat(A.nr_prescricao, A.nr_sequencia_prescricao) cd_motivo_baixa,
	'P' ie_prescr_dev,
	nr_seq_cor_exec,
	A.nr_seq_lote_ap,
	A.cd_kit_material,
	A.nr_devolucao,
	A.nr_doc_interno,
	A.nr_seq_processo,
	A.nr_seq_lote_fornec,
	A.nr_seq_kit_estoque nr_kit_estoque,
	A.cd_convenio
FROM	MATERIAL_ATEND_PACIENTE A
WHERE	coalesce(A.QT_ESTOQUE, A.QT_MATERIAL) <> 0
and	coalesce(ie_glosado,'N') = 'N'
and	((obter_dados_param_estoque(obter_estab_atend(A.nr_atendimento), 'E') = 'S') or 
	 ((obter_dados_param_estoque(obter_estab_atend(A.nr_atendimento), 'E') = 'N') and A.cd_local_estoque is not null))
and not exists (	select	1
		from	item_devolucao_material_pac d
		where	d.nr_devolucao = A.nr_devolucao
		and	d.dt_recebimento is null)

UNION ALL

SELECT	/*+ INDEX (B ITEDEVP_PK) + INDEX(C DEVMATP_SETATE2_FK_I) */
	C.NR_ATENDIMENTO,
	B.DT_ENTRADA_UNIDADE,
	B.CD_MATERIAL,
	B.CD_MATERIAL CD_MATERIAL_DEV,
	B.CD_MATERIAL CD_MATERIAL_prescricao,
	B.NR_PRESCRICAO,
	B.NR_SEQUENCIA_PRESCRICAO,
	B.DT_ATENDIMENTO,
	(B.QT_MATERIAL * -1) QT_MATERIAL, 
	B.CD_UNIDADE_MEDIDA,
	B.CD_LOCAL_ESTOQUE,
	coalesce(b.cd_setor_atendimento,C.CD_SETOR_ATENDIMENTO),
	B.NR_SEQ_ATENDIMENTO,
	0, 
	B.DT_ATENDIMENTO DT_CONTA,
	trunc(b.DT_ATENDIMENTO,'dd') DT_DIA_CONTA, null,
	'D' ie_prescr_dev,
	null nr_seq_cor_exec,
	b.nr_seq_lote,
	null cd_kit_material,
	null nr_devolucao,
	null nr_doc_interno,
	null nr_seq_processo,
	b.nr_seq_lote_fornec,
	b.nr_kit_estoque,
	(select max(cd_convenio) from material_atend_paciente where nr_sequencia = b.nr_seq_atendimento) cd_convenio
FROM	ITEM_DEVOLUCAO_MATERIAL_PAC B,
	DEVOLUCAO_MATERIAL_PAC C
WHERE	B.NR_DEVOLUCAO           = C.NR_DEVOLUCAO
and	((obter_dados_param_estoque(obter_estab_atend(c.nr_atendimento), 'E') = 'S') or 
	 ((obter_dados_param_estoque(obter_estab_atend(c.nr_atendimento), 'E') = 'N') and b.cd_local_estoque is not null))
AND	B.DT_RECEBIMENTO IS NULL;

