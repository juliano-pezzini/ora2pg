-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_sinistralidade_v (dt_mes_competencia, cd_estabelecimento, ie_tipo_contratacao, ds_tipo_contratacao, nr_seq_contrato, nr_seq_faixa_etaria, ds_faixa_etaria, nr_seq_intercambio, nr_seq_pagador, nm_pagador, ie_pf_pj, ds_pf_pj, vl_assist, vl_receitas) AS select	--pkg_date_formaters.to_varchar(dt_mes_competencia,'shortDate',wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_mes_competencia,
	dt_mes_competencia,
	cd_estabelecimento,
	ie_tipo_contratacao,
	substr(obter_valor_dominio(1666,ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	nr_seq_contrato,
	nr_seq_faixa_etaria,
	substr(pls_obter_dados_faixa_etaria(nr_seq_faixa_etaria,'D'),1,255) ds_faixa_etaria,
	nr_seq_intercambio,
	nr_seq_pagador,
	substr(pls_obter_dados_pagador(nr_seq_pagador,'N'),1,255) nm_pagador,
	ie_pf_pj,
	substr(CASE WHEN ie_pf_pj='PF' THEN obter_desc_expressao(830225)  ELSE obter_desc_expressao(295845) END ,1,255) ds_pf_pj,
	vl_assist,
	vl_receitas
FROM (	select	c.dt_mes_competencia,
			a.cd_estabelecimento,
			a.ie_tipo_contratacao,
			a.nr_seq_contrato,
			a.nr_seq_faixa_etaria,
			a.nr_seq_intercambio,
			a.nr_seq_pagador,
			CASE WHEN coalesce(b.cd_cgc,'X')='X' THEN  'PF'  ELSE 'PJ' END  ie_pf_pj,
			sum(coalesce(a.vl_conta,0) + coalesce(a.vl_reembolso,0) + coalesce(a.vl_ressarcir,0) + coalesce(a.vl_recurso,0) - coalesce(a.vl_coparticipacao,0)) vl_assist,
			sum(a.vl_receitas) vl_receitas
		FROM pls_ar_lote c, pls_ar_dados_v a
LEFT OUTER JOIN pls_contrato_pagador b ON (a.nr_seq_pagador = b.nr_sequencia)
WHERE a.nr_seq_lote = c.nr_sequencia group by c.dt_mes_competencia,
			a.cd_estabelecimento,
			a.ie_tipo_contratacao,
			a.nr_seq_contrato,
			a.nr_seq_faixa_etaria,
			a.nr_seq_intercambio,
			a.nr_seq_pagador,
			b.cd_cgc) alias17;

