-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_custo_v (dt_mes_competencia, dt_mes_competencia_param, cd_estabelecimento, cd_item, ds_item, ie_auto_gerado, ds_auto_gerado, ds_tipo_item, nr_seq_prest_solic, nr_seq_prestador_exec, nm_prestador_exec, nr_seq_segurado, nm_segurado, ie_tipo_despesa, ie_classif_custo, ds_especialidade, nr_seq_conta, nr_seq_conta_proc, nr_seq_conta_mat, ds_faixa_etaria, ds_tipo_grupo_ans, qt_item, vl_item) AS select	--pkg_date_formaters.to_varchar(dt_mes_competencia,'shortDate',wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_mes_competencia,
	dt_mes_competencia,
	dt_mes_competencia dt_mes_competencia_param,
	cd_estabelecimento,
	cd_item,
	ds_item,
	ie_auto_gerado,
	CASE WHEN ie_auto_gerado='N' THEN  obter_desc_expressao(327114)  ELSE obter_desc_expressao(894247) END  ds_auto_gerado,
	ds_tipo_item,
	nr_seq_prestador nr_seq_prest_solic,
	nr_seq_prestador_exec,
	substr(pls_obter_dados_prestador(nr_seq_prestador_exec,'N'),1,255) nm_prestador_exec,
	nr_seq_segurado,
	substr(pls_obter_dados_segurado(nr_seq_segurado,'N'),1,255) nm_segurado,
	substr(obter_valor_dominio(1854,ie_tipo_despesa),1,255) ie_tipo_despesa,
	substr(obter_valor_dominio(1481,ie_classif_custo),1,255) ie_classif_custo,
	ds_especialidade,
	nr_seq_conta,
	nr_seq_conta_proc,
	nr_seq_conta_mat,
	substr(pls_obter_faixa_etaria_benef(nr_seq_segurado,'D'),1,255) ds_faixa_etaria,
	ds_tipo_grupo_ans,
	qt_item,
	vl_item
FROM (
	select	c.cd_procedimento cd_item,
		substr(obter_desc_expressao(296422),1,255) ds_tipo_item,
		substr(obter_descricao_procedimento(c.cd_procedimento,c.ie_origem_proced),1,255) ds_item,
		CASE WHEN coalesce(c.nr_seq_autogerado,0)=0 THEN 'N'  ELSE 'S' END  ie_auto_gerado,
		d.dt_mes_competencia,
		b.cd_estabelecimento,
		b.nr_seq_prestador,
		b.nr_seq_prestador_exec,
		b.nr_seq_segurado,
		'0' ie_tipo_despesa,
		p.ie_classif_custo,
		obter_cbo_saude(coalesce(b.nr_seq_cbo_saude,b.nr_seq_cbo_saude_solic)) ds_especialidade,
		b.nr_sequencia nr_seq_conta,
		c.nr_sequencia nr_seq_conta_proc,
		null nr_seq_conta_mat,
		substr(obter_valor_dominio(3579,h.ie_tipo_grupo_ans),1,255) ds_tipo_grupo_ans,
		count(*) qt_item,
		sum(c.vl_liberado) vl_item
	from	pls_ar_dados_v a,
		pls_conta b,
		pls_conta_proc c,
		pls_ar_lote d,
		procedimento p,
		ans_grupo_despesa h
	where	b.nr_sequencia = a.nr_seq_conta
	and	b.nr_sequencia = c.nr_seq_conta
	and	d.nr_sequencia = a.nr_seq_lote
	and	c.cd_procedimento = p.cd_procedimento
	and	c.ie_origem_proced = p.ie_origem_proced
	and	c.nr_seq_grupo_ans = h.nr_sequencia
	and	a.ds_tabela   = 'PLS_AR_CONTA'
	group by h.ie_tipo_grupo_ans, c.cd_procedimento,c.ie_origem_proced, c.nr_seq_autogerado, p.ie_classif_custo, d.dt_mes_competencia, b.nr_seq_prestador, b.nr_seq_prestador_exec, b.nr_seq_segurado, b.nr_sequencia, c.nr_sequencia, coalesce(b.nr_seq_cbo_saude,b.nr_seq_cbo_saude_solic), b.cd_estabelecimento
	
union all

	select	c.cd_material cd_item,
		substr(obter_desc_expressao(292952),1,255) ds_tipo_item,
		substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',nr_seq_material),1,255) ds_item,
		null ie_auto_gerado,
		d.dt_mes_competencia,
		b.cd_estabelecimento,
		b.nr_seq_prestador,
		b.nr_seq_prestador_exec,
		b.nr_seq_segurado,
		c.ie_tipo_despesa,
		e.ie_classif_custo,
		obter_cbo_saude(coalesce(b.nr_seq_cbo_saude,b.nr_seq_cbo_saude_solic)) ds_especialidade,
		b.nr_sequencia nr_seq_conta,
		null nr_seq_conta_proc,
		c.nr_sequencia nr_seq_conta_mat,
		substr(obter_valor_dominio(3579,h.ie_tipo_grupo_ans),1,255) ds_tipo_grupo_ans,
		count(*) qt_item,
		sum(c.vl_liberado) vl_item
	from	pls_ar_dados_v a,
		pls_conta b,
		pls_conta_mat c,
		material m,
		material_estab e,
		pls_ar_lote d,
		ans_grupo_despesa h
	where	b.nr_sequencia = a.nr_seq_conta
	and	b.nr_sequencia = c.nr_seq_conta
	and	d.nr_sequencia = a.nr_seq_lote
	and	c.cd_material  = m.cd_material
	and	m.cd_material  = e.cd_material
	and	c.nr_seq_grupo_ans = h.nr_sequencia
	and	a.ds_tabela   = 'PLS_AR_CONTA'
	and	e.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
	group by h.ie_tipo_grupo_ans, c.cd_material,nr_seq_material,c.ie_tipo_despesa, e.ie_classif_custo, d.dt_mes_competencia, b.nr_seq_prestador, b.nr_seq_prestador_exec, b.nr_seq_segurado, b.nr_sequencia, c.nr_sequencia, coalesce(b.nr_seq_cbo_saude,b.nr_seq_cbo_saude_solic), b.cd_estabelecimento) alias35
order by vl_item desc;

