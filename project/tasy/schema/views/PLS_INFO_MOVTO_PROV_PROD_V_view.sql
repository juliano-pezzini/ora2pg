-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_info_movto_prov_prod_v (ie_tipo_informacao, vl_provisao, vl_glosa, vl_ajuste, nr_seq_protocolo, nr_seq_conta, nr_seq_item, cd_estabelecimento, dt_mes_competencia, ie_tipo_protocolo) AS select	'R' ie_tipo_informacao,
	pls_obter_valor_prov_resumo(d.nr_seq_conta, d.nr_sequencia,d.vl_apresentado,d.vl_calculado, d.vl_liberado,d.vl_taxa_adm,d.vl_taxa_adm_co,d.vl_taxa_adm_mat, (	select	ie_forma_contab_taxa_pgto
																					FROM	pls_parametro_contabil x
																					where	x.cd_estabelecimento = a.cd_estabelecimento),'P') vl_provisao,
	coalesce(d.vl_glosa,0) vl_glosa,
	pls_obter_valor_prov_resumo(d.nr_seq_conta, d.nr_sequencia,d.vl_apresentado,d.vl_calculado, d.vl_liberado,d.vl_taxa_adm,d.vl_taxa_adm_co,d.vl_taxa_adm_mat, (	select	ie_forma_contab_taxa_pgto
																					from	pls_parametro_contabil x
																					where	x.cd_estabelecimento = a.cd_estabelecimento),'A') vl_ajuste,
	b.nr_seq_protocolo,
	b.nr_sequencia nr_seq_conta,
	d.nr_sequencia nr_seq_item,
	a.cd_estabelecimento,
	a.dt_mes_competencia,
	a.ie_tipo_protocolo
from	pls_conta_medica_resumo	d,
	pls_conta b,
	pls_protocolo_conta a
where	b.nr_sequencia = d.nr_seq_conta
and	a.nr_sequencia = b.nr_seq_protocolo
and	d.ie_situacao = 'A'
and	d.ie_tipo_item <> 'I'
and	a.ie_tipo_protocolo	= 'C'
and	a.ie_situacao not in ('RE','I')

union all

select	'P' ie_tipo_informacao,
	CASE WHEN a.ie_tipo_protocolo='F' THEN  coalesce(c.vl_liberado,0)  ELSE coalesce(c.vl_provisao,0) END  vl_provisao,
	null vl_glosa,
	coalesce(c.vl_provisao,0) - coalesce((	select	max(r.vl_liberado)
					from	pls_conta_medica_resumo	r
					where	c.nr_sequencia = r.nr_seq_conta_proc
					and	b.nr_sequencia = r.nr_seq_conta),0) vl_ajuste,
	b.nr_seq_protocolo,
	b.nr_sequencia nr_seq_conta,
	c.nr_sequencia nr_seq_item,
	a.cd_estabelecimento,
	a.dt_mes_competencia,
	a.ie_tipo_protocolo
from	pls_conta_proc c,
	pls_conta b,
	pls_protocolo_conta a
where	b.nr_sequencia = c.nr_seq_conta
and	a.nr_sequencia = b.nr_seq_protocolo
and	c.ie_status not in ('D','M')
and	a.ie_tipo_protocolo in ('C', 'F')
and	a.ie_situacao not in ('RE','I')

union all

select	'M' ie_tipo_informacao,
	CASE WHEN a.ie_tipo_protocolo='F' THEN  coalesce(c.vl_liberado,0)  ELSE coalesce(c.vl_provisao,0) END  vl_provisao,
	null vl_glosa,
	coalesce(c.vl_provisao,0) - coalesce((	select	max(r.vl_liberado)
					from	pls_conta_medica_resumo	r
					where	c.nr_sequencia = r.nr_seq_conta_mat
					and	b.nr_sequencia = r.nr_seq_conta),0) vl_ajuste,
	b.nr_seq_protocolo,
	b.nr_sequencia nr_seq_conta,
	c.nr_sequencia nr_seq_item,
	a.cd_estabelecimento,
	a.dt_mes_competencia,
	a.ie_tipo_protocolo
from	pls_conta_mat c,
	pls_conta b,
	pls_protocolo_conta a
where	b.nr_sequencia = c.nr_seq_conta
and	a.nr_sequencia = b.nr_seq_protocolo
and	c.ie_status not in ('D','M')
and	a.ie_tipo_protocolo in ('C', 'F')
and	a.ie_situacao not in ('RE','I');

