-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_pendencia_mensalidade_v (cd_pessoa_fisica, cd_cgc, ds_pendencia, qt_pendencia, ie_tipo) AS select	a.cd_pessoa_fisica,
	'' cd_cgc,
	a.ds_pendencia,
	a.qt_pendencia,
	a.ie_tipo
FROM (select	a.cd_pessoa_fisica, /* pagador */
		count(1) qt_pendencia,
		'P' ie_tipo,
		'Pagador' ds_pendencia
	from	titulo_receber		c,
		pls_mensalidade		b,
		pls_contrato_pagador	a
	where	a.nr_sequencia		= b.nr_seq_pagador
	and	b.nr_sequencia		= c.nr_seq_mensalidade
	and	c.dt_liquidacao is null
	group by a.cd_pessoa_fisica
	
union

	select	a.cd_pessoa_fisica, /* beneficiário */
		count(1) qt_pendencia,
		'B' ie_tipo,
		'Beneficiário' ds_pendencia
	from	titulo_receber		d,
		pls_mensalidade		c,
		pls_mensalidade_segurado	b,
		pls_segurado		a
	where	a.nr_sequencia		= b.nr_seq_segurado
	and	b.nr_seq_mensalidade	= c.nr_sequencia
	and	c.nr_sequencia		= d.nr_seq_mensalidade
	and	d.dt_liquidacao is null
	group by a.cd_pessoa_fisica
	
union

	select	a.cd_pf_estipulante cd_pessoa_fisica, /* estipulante */
		count(1) qt_pendencia,
		'E' ie_tipo,
		'Estipulante' ds_pendencia
	from	titulo_receber		d,
		pls_mensalidade		c,
		pls_contrato_pagador	b,
		pls_contrato		a
	where	c.nr_seq_pagador	= b.nr_sequencia
	and	b.nr_seq_contrato	= a.nr_sequencia
	and	c.nr_sequencia		= d.nr_seq_mensalidade
	and	d.dt_liquidacao is null
	group by a.cd_pf_estipulante) a
where	a.cd_pessoa_fisica is not null

union

select	'' cd_pessoa_fisica,
	a.cd_cgc,
	a.ds_pendencia,
	a.qt_pendencia,
	a.ie_tipo
from (select	a.cd_cgc,
		count(*) qt_pendencia,
		'P' ie_tipo,
		'Pagador' ds_pendencia
	from	titulo_receber		c,
		pls_mensalidade		b,
		pls_contrato_pagador	a
	where	a.nr_sequencia		= b.nr_seq_pagador
	and	b.nr_sequencia		= c.nr_seq_mensalidade
	and	c.dt_liquidacao is null
	group by a.cd_cgc
	
union

	select	a.cd_cgc_estipulante cd_cgc, /* estipulante */
		count(*) qt_pendencia,
		'E' ie_tipo,
		'Estipulante' ds_pendencia
	from	titulo_receber		d,
		pls_mensalidade		c,
		pls_contrato_pagador	b,
		pls_contrato		a
	where	c.nr_seq_pagador	= b.nr_sequencia
	and	b.nr_seq_contrato	= a.nr_sequencia
	and	c.nr_sequencia		= d.nr_seq_mensalidade
	and	d.dt_liquidacao is null
	group by a.cd_cgc_estipulante) a
where	a.cd_cgc is not null;

