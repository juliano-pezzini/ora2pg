-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW paciente_internado_v2 (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, cd_motivo_alta, dt_alta_interno, ie_permite_visita, ie_permite_visita_rel, ie_clinica, ie_clinica_ant, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, dt_saida_interno, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_unidade, cd_tipo_acomod_unid, cd_tipo_acomod_conv, nr_seq_atepacu, ds_setor_atendimento, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, cd_convenio, cd_categoria, cd_usuario_convenio, nr_doc_convenio, ds_convenio, ds_categoria, cd_classif_setor, ie_carater_inter_sus, nr_seq_indicacao, cd_estabelecimento, nr_seq_tipo_acidente, ie_paciente_isolado, dt_saida_real, nm_usuario_saida, dt_cancelamento, ds_nivel_urgencia, nr_seq_triagem_prioridade) AS select  a.nr_atendimento,
	a.nr_atend_original,
        a.dt_entrada,
        a.cd_pessoa_fisica,
        a.cd_procedencia,
        a.ie_tipo_atendimento,
        a.cd_medico_resp,
        a.dt_alta,
	a.cd_motivo_alta,
	a.dt_alta_interno,
	a.ie_permite_visita,
	a.ie_permite_visita_rel,
	a.ie_clinica,
	a.ie_clinica_ant,
	a.nr_seq_classificacao,
        b.dt_entrada_unidade,
        b.dt_saida_unidade,
	b.dt_saida_interno,
        b.cd_setor_atendimento,
        b.cd_unidade_basica,
        b.cd_unidade_compl,
        b.cd_unidade_basica ||' '||b.cd_unidade_compl cd_unidade,
        b.cd_tipo_acomodacao cd_tipo_acomod_unid,
        c.cd_tipo_acomodacao cd_tipo_acomod_conv,
	b.nr_seq_interno nr_seq_atepacu,	
        s.ds_setor_atendimento,
        m.nm_pessoa_fisica nm_medico,
        p.nm_pessoa_fisica nm_paciente,
        p.nr_prontuario,
        p.dt_nascimento,
        p.cd_religiao,
        c.cd_convenio,
	c.cd_categoria,
	c.cd_usuario_convenio,
	c.nr_doc_convenio,
	v.ds_convenio,
	t.ds_categoria,
        s.cd_classif_setor,
	a.ie_carater_inter_sus,
	a.nr_seq_indicacao,
	a.cd_estabelecimento,
	a.nr_seq_tipo_acidente,
	a.ie_paciente_isolado,
	a.dt_saida_real,
	a.nm_usuario_saida,
	a.dt_cancelamento,
	(select substr(coalesce(obter_nivel_urgencia(a.nr_atendimento),obter_desc_expressao(309956)),1,100) ) ds_nivel_urgencia,
	a.nr_seq_triagem_prioridade
from    atend_paciente_unidade b,
	atendimento_paciente a,
	setor_atendimento s,
        pessoa_fisica m,
        pessoa_fisica p,
	atend_categoria_convenio c,
        categoria_convenio t,
        convenio v
where   a.nr_atendimento = b.nr_atendimento
and     c.nr_atendimento = b.nr_atendimento
and     b.cd_setor_atendimento  = s.cd_setor_atendimento
and     s.cd_classif_setor in (3,4,8)
and     a.cd_medico_resp	= m.cd_pessoa_fisica
and     a.cd_pessoa_fisica	= p.cd_pessoa_fisica
and 	c.cd_convenio           = v.cd_convenio
and 	c.cd_convenio           = t.cd_convenio
and 	c.cd_categoria          = t.cd_categoria
and     c.nr_seq_interno	= (	select	coalesce(max(f.nr_seq_interno),0)
                                       	from 	atend_categoria_convenio f
                                       	where	f.nr_atendimento = a.nr_atendimento
                                       	and 	f.dt_inicio_vigencia =
                                       		(	select max(q.dt_inicio_vigencia)
                                       			from atend_categoria_convenio q
                                       			where q.nr_atendimento = a.nr_atendimento));

