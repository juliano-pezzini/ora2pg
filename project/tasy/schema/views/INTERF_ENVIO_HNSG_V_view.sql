-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_envio_hnsg_v (tp_registro, cd_convenio, nm_prestador, dt_geracao, remessa, nr_registro, cd_autorizacao, cd_senha, cd_paciente, nm_paciente, dt_nascimento, ie_sexo, nr_prontuario, cd_cid, cd_proc_principal, nr_crm, nm_medico, nr_crm2, dt_entrada, ie_tipo_atendimento, dt_saida, ie_tipo_atend_esp, dt_cirurgia, nr_dias, cd_acomodacao, tp_despesa, cd_item, cd_tipo_pessoa, nr_crm_executor, cd_prestador, nm_prestador_exec, qt_item, ie_unidade_medida, qt_filme, vl_unitario, vl_item, vl_filme, vl_total, ie_adicional, tp_escala, ie_funcao_medico, nr_seq_cirurgia, ie_via_acesso, nr_conta_paciente, nm_item, ie_resultado_exame, vl_honorario, vl_mat_med, vl_desp_hosp, vl_01, vl_02, vl_03, vl_04, vl_05, vl_total_conta, qt_conta, vl_total_lote, ds_espaco, nr_seq_protocolo, nr_interno_conta) AS select	01	tp_registro,
		somente_numero(coalesce(a.cd_interno,0))
							cd_convenio,
		substr(elimina_acentuacao(upper(a.nm_hospital)),1,40)
							nm_prestador,
		a.dt_remessa			dt_geracao,
		'REMESSA'				remessa,
		0					nr_registro,
		' '					cd_autorizacao,
		' '					cd_senha,
		' '					cd_paciente,
		' '					nm_paciente,
		LOCALTIMESTAMP				dt_nascimento,
		' '					ie_sexo,
		0					nr_prontuario,
		' '					cd_cid,
		0					cd_proc_principal,
		0					nr_crm,
		' '					nm_medico,
		0					nr_crm2,
		LOCALTIMESTAMP				dt_entrada,
		0					ie_tipo_atendimento,
		LOCALTIMESTAMP				dt_saida,
		' '					ie_tipo_atend_esp,
		LOCALTIMESTAMP				dt_cirurgia,
		0					nr_dias,
		' ' 					cd_acomodacao,
		0					tp_despesa,
		0					cd_item,
		' '					cd_tipo_pessoa,
		0					nr_crm_executor,
		0					cd_prestador,
		' '					nm_prestador_exec,
		0					qt_item,
		' '					ie_unidade_medida,
		0					qt_filme,
		0					vl_unitario,
		0					vl_item,
		0					vl_filme,
		0					vl_total,
		' '					ie_adicional,
		0					tp_escala,
		0					ie_funcao_medico,
		1					nr_seq_cirurgia,
		0					ie_via_acesso,
		0					nr_conta_paciente,
		' '					nm_item,
		' '					ie_resultado_exame,
		0					vl_honorario,
		0					vl_mat_med,
		0					vl_desp_hosp,
		0					vl_01,
		0					vl_02,
		0					vl_03,
		0					vl_04,
		0					vl_05,
		0					vl_total_conta,
		0					qt_conta,
		0					vl_total_lote,
		' '					ds_espaco,
		a.nr_seq_protocolo		nr_seq_protocolo,
		0					nr_interno_conta
FROM		w_interf_conta_header a

union all

select	10	tp_registro,
		0					cd_convenio,
		' '					nm_prestador,
		LOCALTIMESTAMP				dt_geracao,
		' '					remessa,
		0					nr_registro,
		substr(to_char(somente_numero(coalesce(a.cd_autorizacao, OBTER_GUIA_CONVENIO(a.nr_atendimento)))),1,16) cd_autorizacao,
		substr(b.cd_senha_guia,1,16)	cd_senha,
		substr(b.cd_usuario_convenio,1,17)
							cd_paciente,
		substr(b.nm_paciente,1,40)	nm_paciente,
		b.dt_nascimento			dt_nascimento,
		b.ie_sexo				ie_sexo,
		b.nr_prontuario			nr_prontuario,
		substr(b.cd_cid_principal,1,6)
							cd_cid,
		somente_numero(coalesce(b.cd_proc_principal,0))
							cd_proc_principal,
		somente_numero(coalesce(b.nr_crm_medico_resp,0))
							nr_crm,
		substr(b.nm_medico_resp,1,40)	nm_medico,
		0					nr_crm2,
		b.dt_entrada			dt_entrada,
		b.ie_tipo_atendimento		ie_tipo_atendimento,
		b.dt_alta				dt_saida,
		b.ie_carater_inter		ie_tipo_atend_esp,
		c.dt_inicio_real			dt_cirurgia,
		CASE WHEN(b.dt_alta - b.dt_entrada)=0 THEN 1  ELSE (b.dt_alta - b.dt_entrada) END 	nr_dias,
		to_char(b.cd_tipo_acomodacao) cd_acomodacao,
		0					tp_despesa,
		0					cd_item,
		' '					cd_tipo_pessoa,
		0					nr_crm_executor,
		0					cd_prestador,
		' '					nm_prestador_exec,
		0					qt_item,
		' '					ie_unidade_medida,
		0					qt_filme,
		0					vl_unitario,
		0					vl_item,
		0					vl_filme,
		0					vl_total,
		' '					ie_adicional,
		0					tp_escala,
		0					ie_funcao_medico,
		1					nr_seq_cirurgia,
		0					ie_via_acesso,
		0					nr_conta_paciente,
		' '					nm_item,
		' '					ie_resultado_exame,
		0					vl_honorario,
		0					vl_mat_med,
		0					vl_desp_hosp,
		0					vl_01,
		0					vl_02,
		0					vl_03,
		0					vl_04,
		0					vl_05,
		0					vl_total_conta,
		0					qt_conta,
		0					vl_total_lote,
		' '					ds_espaco,
		b.nr_seq_protocolo		nr_seq_protocolo,
		b.nr_interno_conta		nr_interno_conta
FROM conta_paciente a, w_interf_conta_cab b
LEFT OUTER JOIN cirurgia c ON (b.nr_cirurgia = c.nr_cirurgia)
WHERE b.nr_interno_conta		= a.nr_interno_conta

union all

select	21					tp_registro,
		0					cd_convenio,
		' '					nm_prestador,
		LOCALTIMESTAMP				dt_geracao,
		' '					remessa,
		0					nr_registro,
		' '					cd_autorizacao,
		' '					cd_senha,
		' '					cd_paciente,
		' '					nm_paciente,
		LOCALTIMESTAMP				dt_nascimento,
		' '					ie_sexo,
		0					nr_prontuario,
		' '					cd_cid,
		0					cd_proc_principal,
		0					nr_crm,
		' '					nm_medico,
		0					nr_crm2,
		LOCALTIMESTAMP				dt_entrada,
		0					ie_tipo_atendimento,
		LOCALTIMESTAMP				dt_saida,
		' '					ie_tipo_atend_esp,
		LOCALTIMESTAMP				dt_cirurgia,
		0					nr_dias,
		' ' 					cd_acomodacao,
		somente_numero(coalesce(b.ie_emite_conta,0))
							tp_despesa,
		somente_numero(coalesce(b.cd_item_convenio,0))
							cd_item,
		CASE WHEN b.ie_responsavel_credito='M' THEN 'F' WHEN b.ie_responsavel_credito='MN' THEN 'F' WHEN b.ie_responsavel_credito='RM' THEN 'F'  ELSE 'J' END 
							cd_tipo_pessoa,
		CASE WHEN b.ie_emite_conta='91' THEN  somente_numero(coalesce(b.nr_crm_executor,0))  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.nr_crm_executor,0)) WHEN b.ie_responsavel_credito='MN' THEN somente_numero(coalesce(b.nr_crm_executor,0)) WHEN b.ie_responsavel_credito='RM' THEN somente_numero(coalesce(b.nr_crm_executor,0))  ELSE 0 END  END  nr_crm_executor,
		CASE WHEN b.ie_emite_conta='91' THEN  somente_numero(coalesce(b.nr_cpf_executor,0))  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.nr_cpf_executor,0)) WHEN b.ie_responsavel_credito='MN' THEN somente_numero(coalesce(b.nr_cpf_executor,0)) WHEN b.ie_responsavel_credito='RM' THEN somente_numero(coalesce(b.nr_cpf_executor,0))  ELSE somente_numero(coalesce(b.cd_cgc_prestador,0)) END  END  cd_prestador,
		CASE WHEN b.ie_emite_conta='91' THEN  substr(b.nm_medico_executor,1,40)  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN substr(b.nm_medico_executor,1,40) WHEN b.ie_responsavel_credito='MN' THEN substr(b.nm_medico_executor,1,40) WHEN b.ie_responsavel_credito='RM' THEN substr(b.nm_medico_executor,1,40)  ELSE substr(a.nm_hospital,1,40) END  END  nm_prestador_exec,
		sum(b.qt_item)			qt_item,
		substr(b.cd_unidade_medida,1,8)
							ie_unidade_medida,
		coalesce(b.qt_filme,0)			qt_filme,
		0					vl_unitario,
		sum(CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='MN' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='RM' THEN  b.vl_honorario  ELSE b.vl_total_item - coalesce(b.vl_filme,0) END ) vl_item,
		sum(coalesce(b.vl_filme,0))		vl_filme,
		sum(CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='MN' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='RM' THEN  b.vl_honorario  ELSE b.vl_total_item END ) vl_total,
		CASE WHEN coalesce(b.pr_hora_extra,0)=0 THEN 'N'  ELSE 'S' END 
							ie_adicional,
		0					tp_escala,
		b.cd_funcao_executor		ie_funcao_medico,
		1					nr_seq_cirurgia,
		CASE WHEN b.ie_via_acesso='M' THEN 1 WHEN b.ie_via_acesso='D' THEN 2  ELSE 0 END 
							ie_via_acesso,
		b.nr_interno_conta		nr_conta_paciente,
		substr(b.ds_item,1,35)		nm_item,
		'S'					ie_resultado_exame,
		0					vl_honorario,
		0					vl_mat_med,
		0					vl_desp_hosp,
		0					vl_01,
		0					vl_02,
		0					vl_03,
		0					vl_04,
		0					vl_05,
		0					vl_total_conta,
		0					qt_conta,
		0					vl_total_lote,
		' '					ds_espaco,
		b.nr_seq_protocolo		nr_seq_protocolo,
		b.nr_interno_conta		nr_interno_conta
from		w_interf_conta_header a,
		w_interf_conta_item b
where		b.nr_seq_protocolo		= a.nr_seq_protocolo
group by
		somente_numero(coalesce(b.ie_emite_conta,0)),
		somente_numero(coalesce(b.cd_item_convenio,0)),
		CASE WHEN b.ie_responsavel_credito='M' THEN 'F' WHEN b.ie_responsavel_credito='MN' THEN 'F' WHEN b.ie_responsavel_credito='RM' THEN 'F'  ELSE 'J' END ,
		CASE WHEN b.ie_emite_conta='91' THEN  somente_numero(coalesce(b.nr_crm_executor,0))  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.nr_crm_executor,0)) WHEN b.ie_responsavel_credito='MN' THEN somente_numero(coalesce(b.nr_crm_executor,0)) WHEN b.ie_responsavel_credito='RM' THEN somente_numero(coalesce(b.nr_crm_executor,0))  ELSE 0 END  END ,
		CASE WHEN b.ie_emite_conta='91' THEN  somente_numero(coalesce(b.nr_cpf_executor,0))  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN somente_numero(coalesce(b.nr_cpf_executor,0)) WHEN b.ie_responsavel_credito='MN' THEN somente_numero(coalesce(b.nr_cpf_executor,0)) WHEN b.ie_responsavel_credito='RM' THEN somente_numero(coalesce(b.nr_cpf_executor,0))  ELSE somente_numero(coalesce(b.cd_cgc_prestador,0)) END  END ,
		CASE WHEN b.ie_emite_conta='91' THEN  substr(b.nm_medico_executor,1,40)  ELSE CASE WHEN b.ie_responsavel_credito='M' THEN substr(b.nm_medico_executor,1,40) WHEN b.ie_responsavel_credito='MN' THEN substr(b.nm_medico_executor,1,40) WHEN b.ie_responsavel_credito='RM' THEN substr(b.nm_medico_executor,1,40)  ELSE substr(a.nm_hospital,1,40) END  END ,
		substr(b.cd_unidade_medida,1,8),
		coalesce(b.qt_filme,0),
		CASE WHEN coalesce(b.pr_hora_extra,0)=0 THEN 'N'  ELSE 'S' END ,
		b.cd_funcao_executor,
		CASE WHEN b.ie_via_acesso='M' THEN 1 WHEN b.ie_via_acesso='D' THEN 2  ELSE 0 END ,
		b.nr_interno_conta,
		substr(b.ds_item,1,35),
		b.nr_seq_protocolo,
		b.nr_interno_conta

union all

select	29					tp_registro,
		0					cd_convenio,
		' '					nm_prestador,
		LOCALTIMESTAMP				dt_geracao,
		' '					remessa,
		0					nr_registro,
		' '					cd_autorizacao,
		' '					cd_senha,
		' '					cd_paciente,
		' '					nm_paciente,
		LOCALTIMESTAMP				dt_nascimento,
		' '					ie_sexo,
		0					nr_prontuario,
		' '					cd_cid,
		0					cd_proc_principal,
		0					nr_crm,
		' '					nm_medico,
		0					nr_crm2,
		LOCALTIMESTAMP				dt_entrada,
		0					ie_tipo_atendimento,
		LOCALTIMESTAMP				dt_saida,
		' '					ie_tipo_atend_esp,
		LOCALTIMESTAMP				dt_cirurgia,
		0					nr_dias,
		' ' 					cd_acomodacao,
		999					tp_despesa,
		0					cd_item,
		' '					cd_tipo_pessoa,
		0					nr_crm_executor,
		0					cd_prestador,
		' '					nm_prestador_exec,
		0					qt_item,
		' '					ie_unidade_medida,
		0					qt_filme,
		0					vl_unitario,
		0					vl_item,
		0					vl_filme,
		0					vl_total,
		' '					ie_adicional,
		0					tp_escala,
		0					ie_funcao_medico,
		1					nr_seq_cirurgia,
		0					ie_via_acesso,
		0					nr_conta_paciente,
		' '					nm_item,
		' '					ie_resultado_exame,
		b.vl_honorarios			vl_honorario,
		b.vl_matmed				vl_mat_med,
		(b.vl_total_conta - (b.vl_honorarios + b.vl_matmed))
							vl_desp_hosp,
		0					vl_01,
		0					vl_02,
		0					vl_03,
		0					vl_04,
		0					vl_05,
		b.vl_total_conta			vl_total_conta,
		0					qt_conta,
		0					vl_total_lote,
		' '					ds_espaco,
		b.nr_seq_protocolo		nr_seq_protocolo,
		b.nr_interno_conta		nr_interno_conta
from		w_interf_conta_total b

union all

select	99					tp_registro,
		0					cd_convenio,
		' '					nm_prestador,
		LOCALTIMESTAMP				dt_geracao,
		' '					remessa,
		0					nr_registro,
		' '					cd_autorizacao,
		' '					cd_senha,
		' '					cd_paciente,
		' '					nm_paciente,
		LOCALTIMESTAMP				dt_nascimento,
		' '					ie_sexo,
		0					nr_prontuario,
		' '					cd_cid,
		0					cd_proc_principal,
		0					nr_crm,
		' '					nm_medico,
		0					nr_crm2,
		LOCALTIMESTAMP				dt_entrada,
		0					ie_tipo_atendimento,
		LOCALTIMESTAMP				dt_saida,
		' '					ie_tipo_atend_esp,
		LOCALTIMESTAMP				dt_cirurgia,
		0					nr_dias,
		' ' 					cd_acomodacao,
		9999					tp_despesa,
		0					cd_item,
		' '					cd_tipo_pessoa,
		0					nr_crm_executor,
		0					cd_prestador,
		' '					nm_prestador_exec,
		0					qt_item,
		' '					ie_unidade_medida,
		0					qt_filme,
		0					vl_unitario,
		0					vl_item,
		0					vl_filme,
		0					vl_total,
		' '					ie_adicional,
		0					tp_escala,
		0					ie_funcao_medico,
		1					nr_seq_cirurgia,
		0					ie_via_acesso,
		0					nr_conta_paciente,
		' '					nm_item,
		' '					ie_resultado_exame,
		0					vl_honorario,
		0					vl_mat_med,
		0					vl_desp_hosp,
		0					vl_01,
		0					vl_02,
		0					vl_03,
		0					vl_04,
		0					vl_05,
		0					vl_total_conta,
		b.qt_total_conta			qt_conta,
		b.vl_total_conta			vl_total_lote,
		' '					ds_espaco,
		b.nr_seq_protocolo		nr_seq_protocolo,
		99999999				nr_interno_conta
from		w_interf_conta_trailler b;

