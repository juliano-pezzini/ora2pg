-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_contab_hmcc_relat_v (ie_union, cd_conta_contabil, ds_conta_contabil, vl_item, vl_titulo, dt_mesano_referencia, dt_vencimento, nr_titulo, nm_pessoa_titulo, ie_cancelamento, dt_emissao, ie_faturamento, dt_antecipacao, dt_liquidacao, vl_antecipacao, vl_pro_rata, dt_antecipacao_lote, dt_recebimento, dt_contrato) AS select	1 ie_union,
	d.cd_conta_deb_antecip cd_conta_contabil,
	obter_desc_conta_contabil(d.cd_conta_deb_antecip) ds_conta_contabil,
	sum(d.vl_item) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_referencia,
	e.dt_vencimento dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	b.ie_cancelamento ie_cancelamento,
	e.dt_emissao dt_emissao,
	'FA' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	e.dt_liquidacao,
	sum(d.vl_antecipacao) vl_antecipacao,
	sum(a.vl_pro_rata_dia)  vl_pro_rata,
	a.dt_contabilizacao dt_antecipacao_lote,
	null dt_recebimento,
	pls_obter_dados_contrato(f.nr_seq_contrato,'D') dt_contrato
FROM	pls_contrato_pagador		f,
	titulo_receber			e,
	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	pls_lote_mensalidade		a
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	f.nr_sequencia		= b.nr_seq_pagador
group	by	e.nr_titulo,
		e.vl_titulo,
		d.dt_antecipacao,
		e.dt_vencimento,
		a.dt_mesano_referencia,
		d.cd_conta_deb_antecip,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		b.ie_cancelamento,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato

union all

/* Coparticipação -  Conta 1844  - Sem valores diferentes */

select	2 ie_union,
	f.cd_conta_deb cd_conta_contabil,
	obter_desc_conta_contabil(f.cd_conta_deb) ds_conta_contabil,
	sum(f.vl_coparticipacao) vl_item,
	g.vl_titulo,
	a.dt_mesano_referencia dt_mesano_referencia,
	g.dt_vencimento,
	g.nr_titulo,
	substr(obter_nome_pf_pj(g.cd_pessoa_fisica,g.cd_cgc),1,200) nm_pessoa_titulo,
	b.ie_cancelamento,
	g.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	g.dt_liquidacao,
	null vl_antecipacao,
	null  vl_pro_rata,
	a.dt_contabilizacao dt_antecipacao_lote,
	null dt_recebimento,
	pls_obter_dados_contrato(h.nr_seq_contrato,'D') dt_contrato
from	pls_contrato_pagador		h,
	pls_conta_coparticipacao	f,
	pls_conta			e,
	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	pls_lote_mensalidade		a,
	titulo_receber			g
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	d.nr_seq_conta		= e.nr_sequencia
and	e.nr_sequencia		= f.nr_seq_conta
and	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	g.nr_seq_mensalidade	= b.nr_sequencia
and	h.nr_sequencia		= b.nr_seq_pagador
and	d.vl_item		= 	(select	sum(x.vl_coparticipacao)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta	= d.nr_seq_conta)
group	by	f.cd_conta_deb,
		g.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		g.dt_vencimento,
		g.nr_titulo,
		g.cd_pessoa_fisica,
		g.cd_cgc,
		b.ie_cancelamento,
		g.dt_emissao,
		g.dt_liquidacao,
		a.dt_contabilizacao,
		h.nr_seq_contrato

union all

/* Coparticipação - 1844  - Com diferença */

select	2 ie_union,
	'1844' cd_conta_contabil,
	obter_desc_conta_contabil('1844') ds_conta_contabil,
	sum(d.vl_item) vl_item,
	g.vl_titulo,
	a.dt_mesano_referencia dt_mesano_referencia,
	g.dt_vencimento,
	g.nr_titulo,
	substr(obter_nome_pf_pj(g.cd_pessoa_fisica,g.cd_cgc),1,200) nm_pessoa_titulo,
	b.ie_cancelamento,
	g.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	g.dt_liquidacao,
	null vl_antecipacao,
	null  vl_pro_rata,
	a.dt_contabilizacao dt_antecipacao_lote,
	null dt_recebimento,
	pls_obter_dados_contrato(f.nr_seq_contrato,'D') dt_contrato
from	pls_contrato_pagador		f,
	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	pls_lote_mensalidade		a,
	titulo_receber			g
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	g.nr_seq_mensalidade	= b.nr_sequencia
and	d.ie_tipo_item		= 3
and	f.nr_sequencia		= b.nr_seq_pagador
and	d.vl_item		<> 	(select	coalesce(sum(x.vl_coparticipacao),0)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta	= d.nr_seq_conta)
group	by	g.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		g.dt_vencimento,
		g.nr_titulo,
		g.cd_pessoa_fisica,
		g.cd_cgc,
		b.ie_cancelamento,
		g.dt_emissao,
		g.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato

union all

/* Mensalidades a receber - Contas 738 e 1264 (Resp. assumida)  e 2424 */

select	3 ie_union,
	d.cd_conta_deb cd_conta_contabil,
	obter_desc_conta_contabil(d.cd_conta_deb) ds_conta_contabil,
	sum(d.vl_item) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_referencia,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	b.ie_cancelamento,
	e.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(d.vl_antecipacao,0))  vl_antecipacao,
	sum(coalesce(d.vl_pro_rata_dia,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antecipacao_lote,
	null dt_recebimento,
	pls_obter_dados_contrato(f.nr_seq_contrato,'D') dt_contrato
from	pls_contrato_pagador		f,
	titulo_receber			e,
	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	pls_lote_mensalidade		a
where	a.nr_sequencia		= b.nr_seq_lote
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	f.nr_sequencia		= b.nr_seq_pagador
group	by	d.cd_conta_deb,
		e.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		b.ie_cancelamento,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato

union all

select	3 ie_union,
	f.cd_conta_rec_pls cd_conta_contabil,
	obter_desc_conta_contabil(f.cd_conta_rec_pls) ds_conta_contabil,
	sum(f.vl_recebido) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_referencia,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	b.ie_cancelamento,
	e.dt_emissao dt_emissao,
	'RA' ie_faturamento,
	d.dt_antecipacao_pls_mens dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(f.vl_antecipacao_mens,0))  vl_antecipacao,
	sum(coalesce(f.vl_pro_rata,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antecipacao_lote,
	d.dt_recebimento dt_recebimento,
	pls_obter_dados_contrato(g.nr_seq_contrato,'D') dt_contrato
from	pls_contrato_pagador		g,
	pls_lote_mensalidade		a,
	pls_mensalidade			b,
	titulo_receber			e,
	titulo_rec_liq_cc		f,
	titulo_receber_liq		d
where	a.nr_sequencia		= b.nr_seq_lote
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	d.nr_titulo		= e.nr_titulo
and	f.nr_titulo		= e.nr_titulo
and	f.nr_seq_baixa		= d.nr_sequencia
and	g.nr_sequencia		= b.nr_seq_pagador
group	by	f.cd_conta_rec_pls,
		e.vl_titulo,
		d.dt_antecipacao_pls_mens,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		b.ie_cancelamento,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		d.dt_recebimento,
		g.nr_seq_contrato;

