-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ordem_compra_v (nr_ordem_compra, nr_item_oci, cd_material, cd_unidade_medida_compra, vl_unitario_material, qt_material, dt_atualizacao, nm_usuario, ie_situacao, cd_pessoa_solicitante, qt_material_entregue, pr_descontos, cd_local_estoque, ds_material_direto, ds_observacao, cd_motivo_alteracao, nr_cot_compra, nr_item_cot_compra, ds_marca, vl_item_liquido, nr_seq_aprovacao, dt_aprovacao, cd_centro_custo, cd_conta_contabil, nr_solic_compra, nr_item_solic_compra, qt_conv_unid_fornec, ie_geracao_solic, nr_seq_proj_rec, pr_desc_financ, nr_seq_lic_item, nr_seq_conta_financ, qt_original, dt_validade, nr_seq_marca, dt_reprovacao, nr_seq_ordem_serv, vl_ultima_compra, vl_dif_ultima_compra, pr_dif_ultima_compra, nr_seq_unidade_adic, nr_seq_criterio_rateio, nr_serie_material, nr_solic_compra_cancel, vl_desconto, nr_seq_lote_fornec, nr_seq_proj_gpi, nr_seq_etapa_gpi, nr_seq_conta_gpi, dt_aprovacao_orig, dt_reprovacao_orig, nr_contrato, dt_inicio_garantia, dt_fim_garantia, nr_id_integracao, nr_seq_reg_lic_item, nr_seq_conta_bco, nr_seq_prescr_item, nr_empenho, dt_empenho, nr_ordem_agrup, nr_seq_orc_item_gpi, vl_unit_mat_original, nr_atendimento, qt_dias_garantia, dt_desdobr_aprov, dt_lib_estrut_pj, nm_usuario_lib, ds_justificativa_lib, cd_operacao_nf, cd_natureza_operacao, nr_seq_pendencia_transf, ie_motivo_reprovacao, ds_justificativa_reprov, ds_obs_item_forn, nr_seq_regra_contrato, nr_seq_preco_pj, nr_seq_agrup, ds_justif_diver, ds_lote, nr_documento_externo, dt_lib_conferencia, vl_total_item, nr_seq_proc_aprov, ie_servico_realizado, nr_seq_matpaci, nr_seq_ordem_prod, ds_marca_fornec, nr_seq_reg_pcs, nr_seq_op_comp_opm, ie_sistema_origem, vl_frete_rateio, ds_justif_escolha_fornec, cd_tributo, pr_tributo, vl_tot_liquido, vl_tributo, qt_prevista_entrega, dt_prevista_entrega, qt_real_entrega, dt_cancelamento, ds_lote_fornecedor, dt_valid_lt_forn) AS SELECT I.NR_ORDEM_COMPRA,I.NR_ITEM_OCI,I.CD_MATERIAL,I.CD_UNIDADE_MEDIDA_COMPRA,I.VL_UNITARIO_MATERIAL,I.QT_MATERIAL,I.DT_ATUALIZACAO,I.NM_USUARIO,I.IE_SITUACAO,I.CD_PESSOA_SOLICITANTE,I.QT_MATERIAL_ENTREGUE,I.PR_DESCONTOS,I.CD_LOCAL_ESTOQUE,I.DS_MATERIAL_DIRETO,I.DS_OBSERVACAO,I.CD_MOTIVO_ALTERACAO,I.NR_COT_COMPRA,I.NR_ITEM_COT_COMPRA,I.DS_MARCA,I.VL_ITEM_LIQUIDO,I.NR_SEQ_APROVACAO,I.DT_APROVACAO,I.CD_CENTRO_CUSTO,I.CD_CONTA_CONTABIL,I.NR_SOLIC_COMPRA,I.NR_ITEM_SOLIC_COMPRA,I.QT_CONV_UNID_FORNEC,I.IE_GERACAO_SOLIC,I.NR_SEQ_PROJ_REC,I.PR_DESC_FINANC,I.NR_SEQ_LIC_ITEM,I.NR_SEQ_CONTA_FINANC,I.QT_ORIGINAL,I.DT_VALIDADE,I.NR_SEQ_MARCA,I.DT_REPROVACAO,I.NR_SEQ_ORDEM_SERV,I.VL_ULTIMA_COMPRA,I.VL_DIF_ULTIMA_COMPRA,I.PR_DIF_ULTIMA_COMPRA,I.NR_SEQ_UNIDADE_ADIC,I.NR_SEQ_CRITERIO_RATEIO,I.NR_SERIE_MATERIAL,I.NR_SOLIC_COMPRA_CANCEL,I.VL_DESCONTO,I.NR_SEQ_LOTE_FORNEC,I.NR_SEQ_PROJ_GPI,I.NR_SEQ_ETAPA_GPI,I.NR_SEQ_CONTA_GPI,I.DT_APROVACAO_ORIG,I.DT_REPROVACAO_ORIG,I.NR_CONTRATO,I.DT_INICIO_GARANTIA,I.DT_FIM_GARANTIA,I.NR_ID_INTEGRACAO,I.NR_SEQ_REG_LIC_ITEM,I.NR_SEQ_CONTA_BCO,I.NR_SEQ_PRESCR_ITEM,I.NR_EMPENHO,I.DT_EMPENHO,I.NR_ORDEM_AGRUP,I.NR_SEQ_ORC_ITEM_GPI,I.VL_UNIT_MAT_ORIGINAL,I.NR_ATENDIMENTO,I.QT_DIAS_GARANTIA,I.DT_DESDOBR_APROV,I.DT_LIB_ESTRUT_PJ,I.NM_USUARIO_LIB,I.DS_JUSTIFICATIVA_LIB,I.CD_OPERACAO_NF,I.CD_NATUREZA_OPERACAO,I.NR_SEQ_PENDENCIA_TRANSF,I.IE_MOTIVO_REPROVACAO,I.DS_JUSTIFICATIVA_REPROV,I.DS_OBS_ITEM_FORN,I.NR_SEQ_REGRA_CONTRATO,I.NR_SEQ_PRECO_PJ,I.NR_SEQ_AGRUP,I.DS_JUSTIF_DIVER,I.DS_LOTE,I.NR_DOCUMENTO_EXTERNO,I.DT_LIB_CONFERENCIA,I.VL_TOTAL_ITEM,I.NR_SEQ_PROC_APROV,I.IE_SERVICO_REALIZADO,I.NR_SEQ_MATPACI,I.NR_SEQ_ORDEM_PROD,I.DS_MARCA_FORNEC,I.NR_SEQ_REG_PCS,I.NR_SEQ_OP_COMP_OPM,I.IE_SISTEMA_ORIGEM,I.VL_FRETE_RATEIO,I.DS_JUSTIF_ESCOLHA_FORNEC,
	T.CD_TRIBUTO, 
	coalesce(T.PR_TRIBUTO,0) PR_TRIBUTO, 
	CASE WHEN I.VL_ITEM_LIQUIDO IS NULL THEN   		(((I.VL_UNITARIO_MATERIAL * E.QT_PREVISTA_ENTREGA) + coalesce(T.VL_TRIBUTO,0)) - 		(((I.VL_UNITARIO_MATERIAL * E.QT_PREVISTA_ENTREGA) * I.PR_DESCONTOS) / 100))  ELSE (coalesce(I.VL_ITEM_LIQUIDO,0) + coalesce(T.VL_TRIBUTO,0)) END  VL_TOT_LIQUIDO, 
	T.VL_TRIBUTO, 
	E.QT_PREVISTA_ENTREGA, 
	E.DT_PREVISTA_ENTREGA, 
	E.QT_REAL_ENTREGA, 
	E.dt_cancelamento, 
	substr(coalesce(obter_dados_lote_fornec(nr_seq_lote_fornec, 'D'),ds_lote),1,25) DS_LOTE_FORNECEDOR, 
	substr(obter_dados_lote_fornec(nr_seq_lote_fornec, 'V'),1,20) DT_VALID_LT_FORN 
FROM ordem_compra_item i, ordem_compra_item_entrega e
LEFT OUTER JOIN ordem_compra_item_trib t ON (E.NR_ORDEM_COMPRA = T.NR_ORDEM_COMPRA AND E.NR_ITEM_OCI = T.NR_ITEM_OCI)
WHERE E.NR_ORDEM_COMPRA = I.NR_ORDEM_COMPRA AND E.NR_ITEM_OCI   = I.NR_ITEM_OCI;

