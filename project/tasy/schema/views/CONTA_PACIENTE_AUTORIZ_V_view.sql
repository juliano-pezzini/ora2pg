-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_autoriz_v (nr_atendimento, nr_seq_autorizacao, cd_convenio, cd_autorizacao, dt_autorizacao, dt_atualizacao, nm_usuario, dt_fim_vigencia, nm_responsavel, ds_observacao, cd_senha, cd_procedimento_principal, ie_origem_proced, dt_pedido_medico, cd_medico_solicitante, ie_tipo_guia, nr_interno_conta, ie_emite_conta, ds_procedimento_principal, ds_proc_convenio, cd_proc_convenio) AS select	
	a.nr_atendimento, 
	a.nr_seq_autorizacao, 
	a.cd_convenio, 
	a.cd_autorizacao, 
	a.dt_autorizacao, 
	a.dt_atualizacao, 
	a.nm_usuario, 
	a.dt_fim_vigencia, 
	a.nm_responsavel, 
	a.ds_observacao, 
	a.cd_senha, 
	a.cd_procedimento_principal, 
	a.ie_origem_proced, 
	a.dt_pedido_medico, 
	a.cd_medico_solicitante, 
	a.ie_tipo_guia, 
	b.nr_interno_conta, 
	'25' ie_emite_conta,	 
	c.ds_procedimento ds_procedimento_principal, 
	substr(Obter_Nome_Item_Convenio(a.cd_convenio,1,a.cd_procedimento_principal, 
			a.ie_origem_proced,'S', null, null, null, null),1,80) ds_proc_convenio, 
	substr(Obter_Codigo_Item_Convenio(a.cd_convenio,1,a.cd_procedimento_principal, 
			a.ie_origem_proced,'S', null, null, null),1,20) cd_proc_convenio 
FROM conta_paciente b, autorizacao_convenio a
LEFT OUTER JOIN procedimento c ON (a.cd_procedimento_principal = c.cd_procedimento AND a.ie_origem_proced = c.ie_origem_proced)
WHERE a.nr_atendimento 	= b.nr_atendimento   
union
 
select	a.nr_atendimento, 
	0, 
	a.cd_convenio, 
	a.nr_doc_convenio, 
	a.dt_inicio_vigencia, 
	a.dt_atualizacao, 
	a.nm_usuario, 
	a.dt_final_vigencia, 
	'', 
	a.ds_observacao, 
	a.cd_senha, 
	Somente_Numero(Obter_Proc_Principal(a.nr_atendimento, c.cd_convenio_parametro, 
		b.ie_tipo_atendimento, c.nr_interno_conta, 'C')) cd_procedimento_principal, 
	Obter_Origem_Proced_Cat(b.cd_estabelecimento, b.ie_tipo_atendimento, null, 
		c.cd_convenio_parametro, c.cd_categoria_parametro) ie_origem_proced_principal, 
	b.dt_entrada, 
	b.cd_medico_atendimento, 
	a.ie_tipo_guia, 
	c.nr_interno_conta, 
	'25' ie_emite_conta, 
	substr(Obter_Proc_Principal(a.nr_atendimento, c.cd_convenio_parametro, 
		b.ie_tipo_atendimento, c.nr_interno_conta, 'D'),1,80) ds_procedimento_principal, 
	substr(Obter_Proc_Principal(a.nr_atendimento, c.cd_convenio_parametro, 
		b.ie_tipo_atendimento, c.nr_interno_conta, 'D'),1,80) ds_proc_convenio, 
	substr(Obter_Proc_Principal(a.nr_atendimento, c.cd_convenio_parametro, 
		b.ie_tipo_atendimento, c.nr_interno_conta, 'C'),1,20) cd_proc_convenio 
from 	atend_categoria_convenio a, 
	atendimento_paciente b, 
	Conta_Paciente c 
where	b.nr_atendimento		= c.nr_atendimento 
 and	a.nr_atendimento		= b.nr_atendimento 
 and	a.dt_inicio_vigencia		= 
	(select max(x.dt_inicio_vigencia) 
	from 	atend_categoria_convenio x 
	where 	x.nr_atendimento	= c.nr_atendimento 
	 and  x.cd_convenio		= c.cd_convenio_parametro) 
 and	a.nr_doc_convenio		is not null;

