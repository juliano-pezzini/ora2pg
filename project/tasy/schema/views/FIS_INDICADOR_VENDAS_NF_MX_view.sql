-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW fis_indicador_vendas_nf_mx (vl_anos, cd_estabelecimento, nr_sequencia, nr_sequencia_ref, cd_operacao_nf, ie_situacao, ds_situacao_nf, cd_serie, nr_nota_fiscal, nr_atendimento, nr_interno_conta, ds_cliente, ds_diagnostico, sector_hab, vl_mercadoria, vl_descontos, cd_medico_resp, medico, ds_proce, medico_ref, procedencia, ds_convenio, vl_total_nota, dt_referencia, vl_iva, nr_recibo, canal_captacion) AS select 		FLOOR(MONTHS_BETWEEN(LOCALTIMESTAMP, (select pf.DT_NASCIMENTO FROM pessoa_fisica pf where pf.CD_PESSOA_FISICA = d.CD_PESSOA_FISICA) ) / 12) vl_anos,
			a.cd_estabelecimento,
			a.nr_sequencia,
			a.nr_sequencia_ref NR_SEQUENCIA_REF,
			a.cd_operacao_nf,
			a.ie_situacao,
			obter_valor_dominio(1056,a.ie_situacao) DS_SITUACAO_NF,
			a.cd_serie_nf CD_SERIE,
			a.nr_nota_fiscal,
			c.nr_atendimento,
			c.nr_interno_conta,
			obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc) DS_CLIENTE,
			(SELECT H.DS_DOENCA_CID FROM DIAGNOSTICO_DOENCA G INNER JOIN CID_DOENCA H ON G.CD_DOENCA=H.CD_DOENCA_CID WHERE G.NR_SEQ_INTERNO = (select max(I.NR_SEQ_INTERNO) SEQ from DIAGNOSTICO_DOENCA I where  I.NR_ATENDIMENTO = c.nr_atendimento) ) as DS_DIAGNOSTICO,
			(SELECT  obter_desc_setor_atend(au.CD_SETOR_ATENDIMENTO) || ' - '  || CD_UNIDADE_BASICA FROM ATEND_PACIENTE_UNIDADE au WHERE au.NR_ATENDIMENTO=c.NR_ATENDIMENTO AND au.NR_SEQUENCIA=(SELECT ap.NR_SEQ_UNID_ATUAL  FROM ATENDIMENTO_PACIENTE ap WHERE ap.NR_ATENDIMENTO=c.NR_ATENDIMENTO LIMIT 1) LIMIT 1)  as sector_hab,
			CASE WHEN a.ie_situacao=1 THEN  a.VL_MERCADORIA  ELSE 0 END  VL_MERCADORIA,
			CASE WHEN a.ie_situacao=1 THEN  a.VL_DESCONTOS  ELSE 0 END  VL_DESCONTOS,
			d.cd_medico_resp,
			UPPER(substr(obter_nome_medico_eup(d.CD_MEDICO_RESP, obter_estabelecimento_ativo), 1,60)) MEDICO,
			(SELECT C.ds_procedimento FROM cirurgia A INNER JOIN proc_interno B inner join procedimento C ON B.cd_procedimento = C.cd_procedimento ON A.NR_SEQ_PROC_INTERNO = B.NR_SEQUENCIA WHERE a.NR_ATENDIMENTO=c.NR_ATENDIMENTO LIMIT 1) as ds_proce,
			coalesce(substr(obter_nome_medico_eup(d.cd_medico_referido,obter_estabelecimento_ativo),1,60),'No Referido') MEDICO_REF,
			CASE WHEN d.cd_procedencia=1 THEN  'Hospital'  WHEN d.cd_procedencia=2 THEN 'Medico' END  procedencia,
			obter_nome_convenio(obter_convenio_nf(a.nr_sequencia))  ds_convenio,
			CASE WHEN a.ie_situacao=1 THEN  a.VL_TOTAL_NOTA  ELSE 0 END  VL_TOTAL_NOTA,
			a.dt_emissao dt_referencia,
			CASE WHEN a.ie_situacao=1 THEN  obter_vl_total_trib_nota(a.nr_sequencia,'IVA')  ELSE 0 END  VL_IVA,
			a.nr_recibo NR_RECIBO,
			obter_desc_forma_chegada(d.nr_seq_forma_chegada) CANAL_CAPTACION
from      	nota_fiscal a
left join 	conta_paciente c on c.nr_interno_conta = a.nr_interno_conta
left join 	atendimento_paciente d on c.nr_atendimento =  d.nr_atendimento
			and d.cd_estabelecimento = a.cd_estabelecimento
left join 	forma_chegada e on e.NR_SEQUENCIA = d.NR_SEQ_FORMA_CHEGADA
where   	a.ie_tipo_nota in ('SF','SE','SD')
and  		a.nr_nfe_imp is not null;

