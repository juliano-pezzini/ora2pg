-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW resumo_atendimentos_v (ds_convenio, nr_seq_protocolo, nr_protocolo, nm_medico, nm_paciente, cd_setor_atendimento, ds_setor_atendimento, cd_estrutura, ds_estrutura, nr_atendimento, nr_interno_conta, dt_referencia, cd_convenio, cd_medico, cd_item, ds_item, ie_tipo_atendimento, qt_resumo, vl_imposto, vl_item, vl_receita, vl_custo, ie_status_protocolo) AS select	substr(obter_nome_convenio(a.cd_convenio_parametro),1,100) ds_convenio,
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	substr(obter_nome_medico(t.cd_medico_atendimento,'N'),1,100) nm_medico, 
	x.nm_pessoa_fisica nm_paciente, 
	s.cd_setor_atendimento, 
	s.ds_setor_atendimento, 
	u.cd_estrutura, 
	u.ds_estrutura,  
	t.nr_atendimento, 
	a.nr_interno_conta, 
	b.dt_referencia, 
	a.cd_convenio_parametro cd_convenio, 
	t.cd_medico_atendimento cd_medico, 
	b.cd_material cd_item, 
	substr(obter_desc_material(b.cd_material),1,240) ds_item, 
	t.ie_tipo_atendimento, 
	sum(b.qt_resumo) qt_resumo, 
	sum(b.vl_imposto) vl_imposto, 
	sum(b.vl_Material) vl_item, 
	sum(b.vl_material + b.vl_procedimento) vl_receita, 
	sum(b.vl_custo) vl_custo, 
	Obter_Status_Protocolo(a.nr_seq_protocolo) ie_status_protocolo 
FROM 	conta_paciente_estrutura u, 
	setor_atendimento s,  
	pessoa_fisica x, 
	conta_paciente_resumo b, 
	atendimento_paciente t, 
	conta_paciente a 
where 	a.nr_interno_conta		= b.nr_interno_conta  
and  	a.nr_atendimento		= t.nr_atendimento  
and  	t.cd_pessoa_fisica		= x.cd_pessoa_fisica  
and 	b.cd_setor_atendimento	= s.cd_setor_atendimento  
and 	b.cd_estrutura_conta	= to_char(u.cd_estrutura) 
and	b.cd_material is not null 
group by	substr(obter_nome_convenio(a.cd_convenio_parametro),1,100), 
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	substr(obter_nome_medico(t.cd_medico_atendimento,'N'),1,100), 
	x.nm_pessoa_fisica, 
	s.cd_setor_atendimento, 
	s.ds_setor_atendimento, 
	u.cd_estrutura, 
	u.ds_estrutura,  
	t.nr_atendimento, 
	a.nr_interno_conta, 
	b.dt_referencia, 
	a.cd_convenio_parametro, 
	t.cd_medico_atendimento, 
	b.cd_material, 
	substr(obter_desc_material(b.cd_material),1,100), 
	t.ie_tipo_atendimento 

union
 
select	substr(obter_nome_convenio(a.cd_convenio_parametro),1,100) ds_convenio, 
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	substr(obter_nome_medico(t.cd_medico_atendimento,'N'),1,100) nm_medico, 
	x.nm_pessoa_fisica nm_paciente, 
	s.cd_setor_atendimento, 
	s.ds_setor_atendimento, 
	u.cd_estrutura, 
	u.ds_estrutura,  
	t.nr_atendimento, 
	a.nr_interno_conta, 
	b.dt_referencia, 
	a.cd_convenio_parametro cd_convenio, 
	t.cd_medico_atendimento cd_medico, 
	b.cd_procedimento cd_item, 
	substr(obter_descricao_procedimento(b.cd_procedimento,b.ie_origem_proced),1,240) ds_item, 
	t.ie_tipo_atendimento, 
	sum(b.qt_resumo) qt_resumo, 
	sum(b.vl_imposto) vl_imposto, 
	sum(b.vl_procedimento) vl_item, 
	sum(b.vl_procedimento + b.vl_material) vl_receita, 
	sum(b.vl_custo) vl_custo, 
	Obter_Status_Protocolo(a.nr_seq_protocolo) ie_status_protocolo 
from 	conta_paciente_estrutura u, 
	setor_atendimento s,  
	pessoa_fisica x, 
	atendimento_paciente t , 
	conta_paciente_resumo b, 
	conta_paciente a 
where 	a.nr_interno_conta		= b.nr_interno_conta  
and  	a.nr_atendimento		= t.nr_atendimento  
and  	t.cd_pessoa_fisica		= x.cd_pessoa_fisica  
and 	b.cd_setor_atendimento	= s.cd_setor_atendimento  
and 	b.cd_estrutura_conta 	= to_char(u.cd_estrutura) 
and	b.cd_procedimento is not null 
group by	substr(obter_nome_convenio(a.cd_convenio_parametro),1,100), 
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	substr(obter_nome_medico(t.cd_medico_atendimento,'N'),1,100), 
	x.nm_pessoa_fisica, 
	s.cd_setor_atendimento, 
	s.ds_setor_atendimento, 
	u.cd_estrutura, 
	u.ds_estrutura,  
	t.nr_atendimento, 
	a.nr_interno_conta, 
	b.dt_referencia, 
	a.cd_convenio_parametro, 
	t.cd_medico_atendimento, 
	b.cd_procedimento, 
	substr(obter_descricao_procedimento(b.cd_procedimento,b.ie_origem_proced),1,240), 
	t.ie_tipo_atendimento;

