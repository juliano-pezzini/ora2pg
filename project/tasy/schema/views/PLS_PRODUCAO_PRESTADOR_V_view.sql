-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_producao_prestador_v (dt_comptencia, dt_protocolo, nr_seq_protocolo, ie_tipo_protocolo, ie_status_protocolo, nr_seq_conta, nr_seq_prestador, nm_prestador, nr_seq_segurado, nr_seq_medico, nm_medico, nr_seq_especialidade, nm_especialidade, nr_seq_plano, ds_plano, ie_tipo_contratacao, nr_seq_tipo_acomodacao, nr_seq_tipo_atendimento, ds_tipo_item, nr_seq_item, dt_item, cd_codigo, ds_descricao_item, ie_origem_proced, nr_seq_grupo_ans, nr_seq_grupo_rec, vl_original, vl_liberado, vl_glosa, vl_nao_fixado, vl_item, vl_apresentado, qt_item, vl_unitario) AS SELECT	pc.dt_mes_competencia dt_comptencia,
		pc.dt_protocolo, 
		pc.nr_sequencia nr_seq_protocolo, 
		pc.ie_tipo_protocolo, 
		pc.ie_status ie_status_protocolo, 
		c.nr_sequencia nr_seq_conta, 
		c.nr_seq_prestador_exec nr_seq_prestador, 
		pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'N') nm_prestador, 
		c.nr_seq_segurado, 
		c.cd_medico_executor nr_seq_medico, 
		pf.nm_pessoa_fisica nm_medico, 
		obter_especialidade_medico(pf.cd_pessoa_fisica, 'C') nr_seq_especialidade, 
		obter_especialidade_medico(pf.cd_pessoa_fisica, 'D') nm_especialidade, 
		p.nr_sequencia nr_seq_plano, 
		p.ds_plano, 
		p.ie_tipo_contratacao, 
		pls_obter_dados_produto(p.nr_sequencia, 'AP') nr_seq_tipo_acomodacao, 
		CASE 
		WHEN c.ie_tipo_guia IN (5,6)                    THEN 'I' 
		WHEN c.ie_tipo_guia IN (4) AND c.nr_seq_tipo_atendimento = 8    THEN 'I' 
		WHEN c.ie_tipo_guia IN (4)                     THEN 'A' 
		WHEN c.ie_tipo_guia IN (3)                     THEN 'A' 
		END nr_seq_tipo_atendimento, 
		'Material' ds_tipo_item, 
		cm.nr_sequencia nr_seq_item, 
		pc.dt_protocolo dt_item, 
		To_Char(m.cd_material_ops) cd_codigo, 
		m.ds_material ds_descricao_item, 
		null ie_origem_proced, 
		cm.nr_seq_grupo_ans, 
		coalesce(m1.nr_seq_grupo_rec, -1) nr_seq_grupo_rec, 
		coalesce(cm.vl_liberado, 0) vl_original, 
		coalesce(cm.vl_liberado, 0) vl_liberado, 
		coalesce(cm.vl_glosa, 0) vl_glosa, 
		CASE	WHEN coalesce(ir.vl_item, 0) = 0	THEN coalesce(cm.vl_liberado, 0) 
		ELSE 0 
		END vl_nao_fixado, 
		coalesce(ir.vl_item, 0) vl_item, 
		coalesce(cm.vl_material_imp, 0) vl_apresentado, 
		coalesce(cm.QT_MATERIAL,0) qt_item, 
		coalesce(cm.VL_UNITARIO,0) vl_unitario 
	FROM pls_protocolo_conta pc, pls_conta c
LEFT OUTER JOIN pls_conta_mat cm ON (c.nr_sequencia = cm.nr_seq_conta)
LEFT OUTER JOIN pessoa_fisica pf ON (c.cd_medico_executor = pf.cd_pessoa_fisica)
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_material m ON (cm.nr_seq_material = m.nr_sequencia)
LEFT OUTER JOIN pls_item_recalculo ir ON (cm.nr_sequencia = ir.nr_seq_material)
LEFT OUTER JOIN material m1 ON (m.cd_material = m1.cd_material)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
WHERE c.nr_seq_protocolo = pc.nr_sequencia        AND pc.ie_tipo_protocolo IN ('C', 'R') 
	 
UNION ALL
 
	SELECT	pc.dt_mes_competencia dt_comptencia, 
		pc.dt_protocolo, 
		pc.nr_sequencia nr_seq_protocolo, 
		pc.ie_tipo_protocolo, 
		pc.ie_status ie_status_protocolo, 
		c.nr_sequencia nr_seq_conta, 
		c.nr_seq_prestador_exec nr_seq_prestador, 
		pls_obter_dados_prestador(c.nr_seq_prestador_exec, 'N') nm_prestador, 
		c.nr_seq_segurado, 
		c.cd_medico_executor nr_seq_medico, 
		pf.nm_pessoa_fisica nm_medico, 
		obter_especialidade_medico(pf.cd_pessoa_fisica, 'C') nr_seq_especialidade, 
		obter_especialidade_medico(pf.cd_pessoa_fisica, 'D') nm_especialidade, 
		p.nr_sequencia nr_seq_plano, 
		p.ds_plano, 
		p.ie_tipo_contratacao, 
		pls_obter_dados_produto(p.nr_sequencia, 'AP') nr_seq_tipo_acomodacao, 
		CASE 
		WHEN c.ie_tipo_guia IN (5,6)                    THEN 'I' 
		WHEN c.ie_tipo_guia IN (4) AND c.nr_seq_tipo_atendimento = 8    THEN 'I' 
		WHEN c.ie_tipo_guia IN (4)                     THEN 'A' 
		WHEN c.ie_tipo_guia IN (3)                     THEN 'A' 
		END, 
		'Procedimento' ds_tipo_item, 
		cp.nr_sequencia nr_seq_item, 
		coalesce(cp.dt_procedimento, pc.dt_protocolo) dt_item, 
		To_Char(cp.cd_procedimento) cd_codigo, 
		obter_descricao_procedimento(cp.cd_procedimento, cp.ie_origem_proced) ds_descricao_item, 
		cp.ie_origem_proced, 
		cp.nr_seq_grupo_ans, 
		coalesce(p1.nr_seq_grupo_rec, -1) nr_seq_grupo_rec, 
		coalesce(cph.vl_lib_anterior, coalesce(cp.vl_liberado, 0)) vl_original, 
		coalesce(cp.vl_liberado, 0) vl_liberado, 
		coalesce(cp.vl_glosa, 0) vl_glosa, 
		CASE	WHEN coalesce(ir.vl_item, 0) = 0 THEN coalesce(cp.vl_liberado, 0) 
		ELSE 0 
		END vl_nao_fixado, 
		coalesce(ir.vl_item, 0) vl_item, 
		coalesce(cp.vl_procedimento_imp, 0) vl_apresentado, 
		coalesce(cp.qt_procedimento,0) qtde_item, 
		coalesce(cp.VL_UNITARIO,0) vl_unitario 
	FROM pls_protocolo_conta pc, pls_conta c
LEFT OUTER JOIN pls_conta_proc cp ON (c.nr_sequencia = cp.nr_seq_conta)
LEFT OUTER JOIN pessoa_fisica pf ON (c.cd_medico_executor = pf.cd_pessoa_fisica)
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN (	SELECT	Max(nr_sequencia) nr_sequencia, 
				nr_seq_procedimento nr_seq_procedimento 
			FROM	pls_item_recalculo 
			GROUP BY nr_seq_procedimento) irr ON (cp.nr_sequencia = irr.nr_seq_procedimento)
LEFT OUTER JOIN procedimento p1 ON (cp.cd_procedimento = p1.cd_procedimento AND cp.ie_origem_proced = p1.ie_origem_proced)
LEFT OUTER JOIN (	SELECT 
			Min(nr_sequencia) nr_sequencia,	 
			nr_seq_proc 
			FROM	pls_conta_proc_hist 
			GROUP BY	nr_seq_proc) cphr ON (cp.nr_sequencia = cphr.nr_seq_proc)
LEFT OUTER JOIN pls_item_recalculo ir ON (irr.nr_sequencia = ir.nr_sequencia)
LEFT OUTER JOIN pls_conta_proc_hist cph ON (cphr.nr_sequencia = cph.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
WHERE c.nr_seq_protocolo = pc.nr_sequencia           AND pc.ie_tipo_protocolo IN ('C', 'R');

