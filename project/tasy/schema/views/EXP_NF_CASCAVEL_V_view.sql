-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nf_cascavel_v (ie_tipo_nota, cd_cfop, nr_nota_fiscal, dt_entrada_saida, dt_emissao, vl_contabil, cd_cgc_emitente, sg_estado_emitente, tp_emitente_nota, cd_municipio, vl_pis, vl_cofins, vl_total_itens, vl_icms_st, vl_base_calc_icms, vl_icms, vl_aliquota_icms, cd_sit_trib, cd_serie_nf, cd_sub_serie_nf, nr_inscricao_estadual, nr_inscricao_municipal, nr_chave_nfe, vl_aliquota, vl_imposto, vl_isentas, vl_outras, vl_ipi, vl_total_subst_trib, vl_base_icms_ipi, vl_total_ipi, cd_situacao_trib_icms, vl_total_bruto_produto, vl_total_desc_produto, vl_base_calc_icmsst, ds_incentivado, vl_subst_trib, vl_isenta_ipi, vl_outras_ipi, vl_icms_nfp, vl_total_unit_nf, vl_aliquota_subst_trib, cd_tributacao_ipi, vl_aliquota_ipi, vl_base_calc_issqn, vl_aliquota_issqn, vl_issqn, vl_aliquota_pis, vl_aliquota_cofins, vl_total_nota, cd_cst_pis, vl_base_calc_pis, cd_cst_cofins, vl_base_calc_cofins, ds_enquadramento_ipi, cd_estabelecimento) AS select	n.ie_tipo_nota												ie_tipo_nota,
	substr(elimina_caractere_especial(obter_dados_natureza_operacao(n.cd_natureza_operacao,'CF')),1,10)	cd_cfop, 
	'1'											nr_nota_fiscal, 
	n.dt_entrada_saida											dt_entrada_saida, 
	n.dt_emissao												dt_emissao, 
	n.nr_nota_fiscal													vl_contabil, 
	n.cd_cgc_emitente											cd_cgc_emitente, 
	substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'UF'),1,2) 						sg_estado_emitente, 
	CASE WHEN obter_se_nota_entrada_saida(n.nr_sequencia)='E' THEN  'T'  ELSE 'P' END  					tp_emitente_nota, 
	CASE WHEN obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CDM') IS NULL THEN obter_dados_pf_pj(n.cd_pessoa_fisica, null, 'CDM')  ELSE obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CDM') END 							cd_municipio, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'PIS')						vl_pis, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'COFINS')						vl_cofins, 
	obter_valor_item_nf(n.nr_sequencia,'VT')								vl_total_itens, 
	obter_base_icmsst_nf(n.nr_sequencia)									vl_icms_st, 
	obter_base_calc_icms_nf(n.nr_sequencia)									vl_base_calc_icms, 
	obter_valor_icms_nf(n.nr_sequencia)									vl_icms, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'ICMS')						vl_aliquota_icms, 
	'2'													cd_sit_trib, 
	n.cd_serie_nf												cd_serie_nf, 
	'3'													cd_sub_serie_nf, 
	obter_dados_pf_pj(null, n.cd_cgc_emitente, 'IE') 							nr_inscricao_estadual, 
	obter_dados_pf_pj(null, n.cd_cgc_emitente, 'IM') 							nr_inscricao_municipal, 
	'4'													nr_chave_nfe, 
--Imposto da nota 
--	n.nr_nota_fiscal											nr_nota_fiscal, 
--	obter_base_calc_icms_nf(n.nr_sequencia) 									vl_base_calc_icms, 
	obter_valor_tributo_nota(n.nr_sequencia,'X')								vl_aliquota, 
	obter_valor_icms_nf(n.nr_sequencia)									vl_imposto, 
	'5'													vl_isentas, 
	'6'													vl_outras, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'IPI')						vl_ipi, 
	'7'													vl_total_subst_trib, 
--	'8'													vl_contabil, 
--produtos da nota 
--	n.nr_nota_fiscal											nr_nota_fiscal, 
	obter_base_calc_icms_nf(n.nr_sequencia) + Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'B', 'IPI') 	vl_base_icms_ipi, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'IPI') 						vl_total_ipi, 
--	obter_base_calc_icms_nf(n.nr_sequencia)									vl_base_calc_icms, 
--	n.dt_emissao											dt_emissao, 
	'9'													cd_situacao_trib_icms, 
	obter_valor_item_nf(n.nr_sequencia,'VT')								vl_total_bruto_produto, 
	obter_valor_item_nf(n.nr_sequencia,'VD')								vl_total_desc_produto, 
--	obter_base_calc_icms_nf(n.nr_sequencia)									vl_base_calc_icms, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'B', 'ICMSST')						vl_base_calc_icmsst, 
--	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'ICMS')							vl_aliquota_icms, 
	'10'													ds_incentivado, 
--	obter_valor_icms_nf(n.nr_sequencia)									vl_icms, 
	'11'													vl_subst_trib, 
	'12'													vl_isenta_ipi, 
	'13'													vl_outras_ipi, 
	'14'													vl_icms_nfp, 
	obter_valor_item_nf(n.nr_sequencia,'VU')								vl_total_unit_nf, 
	'15'													vl_aliquota_subst_trib, 
	'16'													cd_tributacao_ipi, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'IPI')						vl_aliquota_ipi, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'B', 'ISSQN')						vl_base_calc_issqn, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'ISSQN')						vl_aliquota_issqn, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISSQN')						vl_issqn, 
--	substr(elimina_caractere_especial(obter_dados_natureza_operacao(n.cd_natureza_operacao,'CF')),1,10)	cd_cfop, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'PIS')						vl_aliquota_pis, 
--	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'PIS')						vl_pis, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'X', 'COFINS')						vl_aliquota_cofins, 
--	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'COFINS')							vl_cofins, 
	n.vl_total_nota												vl_total_nota, 
	'17'													cd_cst_pis, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'B', 'PIS')						vl_base_calc_pis, 
	'18'													cd_cst_cofins, 
	Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'B', 'COFINS')						vl_base_calc_cofins, 
	'19'													ds_enquadramento_ipi, 
	n.cd_estabelecimento											cd_estabelecimento 
FROM	nota_fiscal n;

