-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bhiss_nf_3_0_v (cd_estabelecimento, tp_registro, ds_registro, nr_inscricao_municipal, cd_versao, dt_referencia, dt_emissao, cd_serie_nf, tipo_negocio, cd_tributacao_municipio, item_lista_servico, cd_modelo, cd_natureza_operacao, nr_nota_fiscal, vl_bruto, vl_servico, ie_tipo_recolhimento, nr_nota_fiscal_deduzir, regime_especial_tributacao, vl_bruto_deduzir, exigibilidadeiss, vl_deduzir, tx_tributo, pais_tomador, nr_parcela, aliquota, simplesnacional, emailtomador, situacaodoc, telefonetomador, qt_parcela, ds_motivo_nao_retencao, recolhimentoissqn, nr_insc_munic_prestador, cd_cnpj_prestador, localincidencia, nr_cpf_prestador, nm_prestador, ie_tipo_rua, ds_endereco_prestador, nr_endereco_prestador, ds_compl_prestador, ie_tipo_bairro, ds_bairro_prestador, cd_municipio, sg_estado, cd_cep, nr_telefone_prestador, ds_email_prestador, cd_atividade_cnae, cd_subserie_nf, nr_nota_fiscal_final, ds_municipio_tomador, sg_estado_tomador, nr_insc_munic_tomador, cd_cnpj_tomador, nr_cpf_tomador, nm_tomador, ds_endereco_tomador, nr_endereco_tomador, ds_compl_tomador, ds_bairro_tomador, cd_cep_tomador, cd_operacao_nf, ie_situacao, nr_insc_munic_terceiro, cd_cnpj_terceiro, nr_cpf_terceiro, nm_terceiro, ds_endereco_terceiro, nr_endereco_terceiro, ds_compl_terceiro, ds_bairro_terceiro, cd_municipio_terceiro, pais_terceiro, cd_cep_terceiro, telefone_terceiro, email_terceiro, ds_evento, dt_evento, dt_competencia, dt_cancelamento, ds_motivo_cancelamento, ds_outro_motivo_cancel, nr_nota_substituidora) AS select	a.cd_estabelecimento cd_estabelecimento,
	1 						tp_registro,
	'H'						DS_REGISTRO,
	 						a.nr_inscricao_municipal,
	UPPER(obter_desc_expressao_br(301639) || '300')	 cd_versao,
	LOCALTIMESTAMP					dt_referencia,
	to_date(null)			dt_emissao,
	0						cd_serie_nf,
	' ' 					tipo_negocio,
 	' '						cd_tributacao_municipio,
	' ' 					item_lista_servico,
	'16' 					cd_modelo,
	'B' 					cd_natureza_operacao,
	'0'						nr_nota_fiscal,
	0		 				vl_bruto,
	0		 				vl_servico,
	'A' 					ie_tipo_recolhimento,
	'0'						nr_nota_fiscal_deduzir,
	' '						regime_especial_tributacao,
	0 						vl_bruto_deduzir,
	' '						ExigibilidadeISS,
	0 						vl_deduzir,
	0						tx_tributo,
	'  '					pais_tomador,
	0						nr_parcela,
	null 					Aliquota,
	' '						simplesNacional,
	' '						emailTomador,
	'1'						situacaoDoc,
	null					TelefoneTomador,
	0						qt_parcela,
	' '						DS_MOTIVO_NAO_RETENCAO,
	' '						RecolhimentoISSQN,
	'0'						NR_INSC_MUNIC_PRESTADOR,
	cnpj 					cd_cnpj_prestador,
	' ' 					LocalIncidencia,
	'0'						nr_cpf_prestador,
	' '						nm_prestador,
	'RUA' 					ie_tipo_rua,
	'  '					ds_endereco_prestador,
	'0'						nr_endereco_prestador,
	'0'						ds_compl_prestador,
	'BAIRRO' 				ie_tipo_bairro,
	' '						ds_bairro_prestador,
	' '						cd_municipio,
	' '						sg_estado,
	' '						cd_cep,
	''						nr_telefone_prestador,
	''						ds_email_prestador,
	'0'						cd_atividade_cnae,
	' '						cd_subserie_nf,
	' '						nr_nota_fiscal_final,
	' '						ds_municipio_tomador,
	' '						sg_estado_tomador,
	'0'						nr_insc_munic_tomador,
	'0'						cd_cnpj_tomador,
	'0'						nr_cpf_tomador,
	' '						nm_tomador,
	' '						ds_endereco_tomador,
	'0'						nr_endereco_tomador,
	' '						ds_compl_tomador,
	' '						ds_bairro_tomador,
	' '						cd_cep_tomador,
	0						cd_operacao_nf,
							a.ie_situacao,
	' '						NR_INSC_MUNIC_TERCEIRO,
	0						CD_CNPJ_TERCEIRO,
	0						NR_CPF_TERCEIRO,
	' '						NM_TERCEIRO,
	' '						DS_ENDERECO_TERCEIRO,
	0						NR_ENDERECO_TERCEIRO,
	' '						DS_COMPL_TERCEIRO,
	' '						DS_BAIRRO_TERCEIRO,
	0						CD_MUNICIPIO_TERCEIRO,
	0						PAIS_TERCEIRO,
	0						CD_CEP_TERCEIRO,
	0						TELEFONE_TERCEIRO,
	' '						EMAIL_TERCEIRO,
	''						DS_EVENTO,
	to_date(null)			DT_EVENTO,
	to_date(null)			DT_COMPETENCIA,
	to_date(null)			DT_CANCELAMENTO,
	0						DS_MOTIVO_CANCELAMENTO,
	' '						DS_OUTRO_MOTIVO_CANCEL,
	0						NR_NOTA_SUBSTITUIDORA
FROM	estabelecimento_v a

union

select	a.cd_estabelecimento			cd_estabelecimento,
	2 						tp_registro,
	'E'						DS_REGISTRO,
	'0'						cd_inscricao_municipal,
	UPPER(obter_desc_expressao_br(301639) || '300')	 cd_versao,
	a.dt_emissao			dt_referencia,
	a.dt_emissao			dt_emissao,
	0						cd_serie_nf,
	'1' 					tipo_negocio,
	obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'C') cd_tributacao_municipio,
	substr(obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'I'),1,2) || '.'  ||  substr(obter_cod_grupo_ativ(a.cd_estabelecimento, a.nr_sequencia, 'I'),3,2)	item_lista_servico, 	
	CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  '5'  ELSE '16' END  cd_modelo,
	'B' 					cd_natureza_operacao,
	a.nr_nota_fiscal		nr_nota_fiscal,
	a.vl_total_nota 		vl_bruto,
	a.vl_mercadoria 		vl_servico,
	'A' 					ie_tipo_recolhimento,
	'0'						nr_nota_fiscal_deduzir,
	'2' 						regime_especial_tributacao,
	0 						vl_bruto_deduzir,
	CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)=0 THEN  '3'  ELSE obter_dados_parametro_compras(a.cd_estabelecimento, 14) END  ExigibilidadeISS,
	0 						vl_deduzir,
	0						tx_tributo,
	'1058'					pais_tomador,
	0						nr_parcela,
	campo_mascara(coalesce(obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS'), 0), 2) Aliquota,
	'1'					simplesNacional,
	substr(CASE WHEN cd_cgc IS NULL THEN  CASE WHEN nfse_obter_compl_pf(cd_pessoa_fisica,'M') IS NULL THEN obter_dados_pf_pj(cd_pessoa_fisica, null, 'M')  ELSE nfse_obter_compl_pf(cd_pessoa_fisica,'M') END   ELSE obter_dados_pf_pj_estab(cd_estabelecimento, null, cd_cgc, 'M') END ,1,60) emailTomador,
	'1   '						situacaoDoc,
	coalesce(substr(tiss_eliminar_caractere(obter_dados_pf_pj(cd_pessoa_fisica, null, 'DDT') || obter_dados_pf_pj(cd_pessoa_fisica, '', 'T')), 1, 80), null) TelefoneTomador,
	0						qt_parcela,
	' '						DS_MOTIVO_NAO_RETENCAO,
	CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISSST')=0 THEN  CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  '1'  ELSE '2' END   ELSE 2 END  RecolhimentoISSQN,
	coalesce(substr(obter_dados_pf_pj(null,a.cd_cgc,'IE'),1,11),'00000000000') NR_INSC_MUNIC_PRESTADOR,
	coalesce(a.cd_cgc, '00000000000000') 	cd_cnpj_prestador,
	obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'CDMDV') LocalIncidencia,
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') 	nr_cpf_prestador,
	coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150),substr('DIVERSOS',1,150)) nm_prestador,
	'RUA' 					ie_tipo_rua,
	substr(OBTER_DADOS_PF_PJ(null, a.cd_cgc, 'E'),1,125) ds_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'NR'),1,10) nr_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CO'),1,60) ds_compl_prestador,
	'BAIRRO' 				ie_tipo_bairro,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'B'),1,60) ds_bairro_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CDMDV'),1,7) cd_municipio,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'UF'),1,2) sg_estado,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CEP'),1,10) cd_cep,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'T'),1,13) nr_telefone_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'M'),1,80) ds_email_prestador,
	coalesce(substr(obter_dados_pf(a.cd_pessoa_fisica,'ATC'),1,9),'000000000') cd_atividade_cnae,
	' '						cd_subserie_nf,
	a.nr_nota_fiscal				nr_nota_fiscal_final,
	' '						ds_municipio_tomador,
	' '						sg_estado_tomador,
	coalesce(substr(obter_dados_pf_pj(null,a.cd_cgc,'IE'),1,11),' ')	nr_insc_munic_tomador,
	coalesce(a.cd_cgc, ' ')		cd_cnpj_tomador,
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), ' ') nr_cpf_tomador,
	coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150)) nm_tomador,
	CASE WHEN coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150))='DIVERSO' THEN  ' '  ELSE substr(OBTER_DADOS_PF_PJ(null, a.cd_cgc, 'E'),1,125) END  ds_endereco_tomador,
	CASE WHEN coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150))='DIVERSO' THEN  ' '  ELSE substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'NR'),1,10) END  nr_endereco_tomador,
	CASE WHEN coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150))='DIVERSO' THEN  ' '  ELSE substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CO'),1,60) END  ds_compl_tomador,
	CASE WHEN coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150))='DIVERSO' THEN  ' '  ELSE substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'B'),1,60) END  ds_bairro_tomador,
	CASE WHEN coalesce(substr(obter_nome_pf(a.cd_pessoa_fisica),1,150), substr('DIVERSOS',1,150))='DIVERSO' THEN  ' '  ELSE substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CEP'),1,10) END  cd_cep_tomador,
	a.cd_operacao_nf		cd_operacao_nf,
							a.ie_situacao,
	' '						NR_INSC_MUNIC_TERCEIRO,
	0						CD_CNPJ_TERCEIRO,
	0						NR_CPF_TERCEIRO,
	' '						NM_TERCEIRO,
	' '						DS_ENDERECO_TERCEIRO,
	0						NR_ENDERECO_TERCEIRO,
	' '						DS_COMPL_TERCEIRO,
	' '						DS_BAIRRO_TERCEIRO,
	0						CD_MUNICIPIO_TERCEIRO,
	0						PAIS_TERCEIRO,
	0						CD_CEP_TERCEIRO,
	0						TELEFONE_TERCEIRO,
	' '						EMAIL_TERCEIRO,
	''						DS_EVENTO,
	to_date(null)			DT_EVENTO,
	to_date(null)			DT_COMPETENCIA,
	to_date(null)			DT_CANCELAMENTO,
	0						DS_MOTIVO_CANCELAMENTO,
	' '						DS_OUTRO_MOTIVO_CANCEL,
	0						NR_NOTA_SUBSTITUIDORA
from	nota_fiscal a,
		operacao_nota o
where	substr(Obter_Se_Nota_Entrada_Saida(a.nr_sequencia),1,1) = 'S'
and		a.cd_operacao_nf = o.cd_operacao_nf
and		o.ie_tipo_operacao = 0
and		o.ie_servico = 'S'
and		1 = 2

union

select	a.cd_estabelecimento cd_estabelecimento,
	4 						tp_registro,
	'R'						DS_REGISTRO,
	'0'						cd_inscricao_municipal,
	UPPER(obter_desc_expressao_br(301639) || '300')	 cd_versao,
	a.dt_emissao			dt_referencia,
	a.dt_emissao			dt_emissao,
	0						cd_serie_nf,
	' '						tipo_negocio,
	' '						cd_tributacao_municipio,
	' ' 					item_lista_servico,
	CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  '5'  ELSE '16' END  cd_modelo,
	'B' 					cd_natureza_operacao,
	a.nr_nota_fiscal		nr_nota_fiscal,
	a.vl_mercadoria 		vl_bruto,
	a.vl_total_nota 		vl_servico,
	'M' 					ie_tipo_recolhimento,
	'0'						nr_nota_fiscal_deduzir,
	'  '					regime_especial_tributacao,
	0		 				vl_bruto_deduzir,
	' '						 ExigibilidadeISS,
	0		 				vl_deduzir,
	0						tx_tributo,
	'1058'					pais_tomador,
	0						nr_parcela,
	campo_mascara(coalesce(obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS'), 0), 2) Aliquota,
	'1'					simplesNacional,
	' '						emailTomador,
	CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  '1'  ELSE CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISSST')=0 THEN  CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISS')=0 THEN  '7'  ELSE CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  '1'  ELSE '7' END  END   ELSE '7' END  END 	situacaoDoc,
	null  					TelefoneTomador,
	0						qt_parcela,
	CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISSST')=0 THEN  CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISS')=0 THEN  CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  '1'  ELSE '10' END   ELSE CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  '16'  ELSE '1' END  END   ELSE '16' END  ds_motivo_nao_retencao,
	CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISSST')=0 THEN  CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISS')=0 THEN  '2'  ELSE CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  '1'  ELSE '2' END  END   ELSE '1' END 	RecolhimentoISSQN,
	CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  coalesce(substr(obter_dados_pf_pj(null,a.cd_cgc_emitente,'IM'),1,20),'')  ELSE '' END  NR_INSC_MUNIC_PRESTADOR,
	coalesce(a.cd_cgc_emitente, ' ') 	cd_cnpj_prestador,
	obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'CDMDV') LocalIncidencia,
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), ' ') 	nr_cpf_prestador,
	coalesce(substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'N'),1,150), 'DIVERSOS') nm_prestador,
	'RUA' 					ie_tipo_rua,
	substr(OBTER_DADOS_PF_PJ(null, a.cd_cgc_emitente, 'E'),1,150) ds_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'NR'),1,10) nr_endereco_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CO'),1,40) ds_compl_prestador,
	'BAIRRO' 				ie_tipo_bairro,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'B'),1,60) ds_bairro_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV'),1,7) cd_municipio,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'UF'),1,2) sg_estado,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CEP'),1,8) cd_cep,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'T'),1,13) nr_telefone_prestador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'M'),1,80) ds_email_prestador,
	'0'						cd_atividade_cnae,
	' '						cd_subserie_nf,
	' '						nr_nota_fiscal_final,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CI'),1,30) ds_municipio_tomador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'UF'),1,2) sg_estado_tomador,
	CASE WHEN OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc_emitente, 'CDMDV')='3106200' THEN  coalesce(substr(obter_dados_pf_pj(null,a.cd_cgc,'IE'),1,20),'')  ELSE '' END  nr_insc_munic_tomador,
	coalesce(a.cd_cgc, ' ') 	cd_cnpj_tomador,
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), ' ') 	nr_cpf_tomador,
	coalesce(substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'N'),1,150), 'DIVERSOS') nm_tomador,
	substr(OBTER_DADOS_PF_PJ(null, a.cd_cgc, 'E'),1,30) ds_endereco_tomador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'NR'),1,10) nr_endereco_tomador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CO'),1,40) ds_compl_tomador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'B'),1,30) ds_bairro_tomador,
	substr(OBTER_DADOS_PF_PJ(a.cd_pessoa_fisica, a.cd_cgc, 'CEP'),1,10) cd_cep_tomador,
	a.cd_operacao_nf		cd_operacao_nf,
							a.ie_situacao,
	' '						NR_INSC_MUNIC_TERCEIRO,
	0						CD_CNPJ_TERCEIRO,
	0						NR_CPF_TERCEIRO,
	' '						NM_TERCEIRO,
	' '						DS_ENDERECO_TERCEIRO,
	0						NR_ENDERECO_TERCEIRO,
	' '						DS_COMPL_TERCEIRO,
	' '						DS_BAIRRO_TERCEIRO,
	0						CD_MUNICIPIO_TERCEIRO,
	0						PAIS_TERCEIRO,
	0						CD_CEP_TERCEIRO,
	0						TELEFONE_TERCEIRO,
	' '						EMAIL_TERCEIRO,
	''						DS_EVENTO,
	to_date(null)			DT_EVENTO,
	to_date(null)			DT_COMPETENCIA,
	to_date(null)			DT_CANCELAMENTO,
	0						DS_MOTIVO_CANCELAMENTO,
	' '						DS_OUTRO_MOTIVO_CANCEL,
	0						NR_NOTA_SUBSTITUIDORA
from	nota_fiscal a,
		operacao_nota o
where	substr(Obter_Se_Nota_Entrada_Saida(a.nr_sequencia),1,1) = 'E'
and		a.cd_operacao_nf = o.cd_operacao_nf
and		o.ie_tipo_operacao = 0
and		o.ie_servico = 'S';

