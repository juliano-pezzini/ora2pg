-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sus_cih_2008_v2 (nr_atendimento, cd_estabelecimento, cd_pessoa_fisica, dt_entrada, ie_tipo_atendimento, dt_alta, cd_motivo_alta, ie_tipo_convenio, nm_paciente, nr_prontuario, dt_nascimento, ie_sexo, nm_logradouro, nr_endereco, ds_complemento, sg_estado_paciente, cd_cep, cd_municipio, cd_cgc, sg_estado_cgc, cd_cep_cgc, ds_bairro_cgc, cd_procedimento, ie_origem_proced, cd_cid_primario, cd_cid_secundario, cd_municipio_ibge, cd_cns, cd_ans, ie_fonte_remuneracao, ie_fonte_remuner2, dt_competencia, cd_cnes, ds_procedimento, cd_cnpj, cd_usuario_convenio, nr_declaracao_obito, qt_dias_uti, cd_convenio, dt_inicio_vigencia, cd_categoria, qt_filhos_vivos, doc_nasc1, doc_nasc2, doc_nasc3, doc_nasc4, doc_nasc5, ie_tipo_reg_interface, ds_versao_interface, ie_alta_uti, ie_sexo_sus, cd_internacional, nm_usuario_atend) AS SELECT	0 NR_ATENDIMENTO,
	(D.cd_estabelecimento) CD_ESTABELECIMENTO, 
	null CD_PESSOA_FISICA, 
	LOCALTIMESTAMP DT_ENTRADA, 
	0 ie_tipo_atendimento, 
	LOCALTIMESTAMP DT_ALTA, 
	0 cd_motivo_alta, 
	0 IE_TIPO_CONVENIO, 
	null NM_PACIENTE, 
	0 NR_PRONTUARIO, 
	LOCALTIMESTAMP DT_NASCIMENTO, 
	null IE_SEXO, 
	null NM_LOGRADOURO, 
	0 NR_ENDERECO, 
	null DS_COMPLEMENTO, 
	null SG_ESTADO_PACIENTE, 
	null CD_CEP, 
	null CD_MUNICIPIO, 
	null CD_CGC, 
	null SG_ESTADO_CGC, 
	null CD_CEP_CGC, 
	null DS_BAIRRO_CGC, 
	0 CD_PROCEDIMENTO, 
	0 IE_ORIGEM_PROCED, 
	null CD_CID_PRIMARIO, 
	null CD_CID_SECUNDARIO, 
	null cd_municipio_ibge, 
	null CD_CNS, 
	null CD_ANS, 
	null IE_FONTE_REMUNERACAO, 
	null IE_FONTE_REMUNER2, 
	LOCALTIMESTAMP DT_COMPETENCIA, 
	(substr(D.cd_cns, 1,8)) CD_CNES, 
	null ds_procedimento, 
	null cd_cnpj, 
	null CD_USUARIO_CONVENIO, 
	null nr_declaracao_obito, 
	0 QT_DIAS_UTI, 
	0 cd_convenio, 
	LOCALTIMESTAMP dt_inicio_vigencia, 
	null cd_categoria, 
	0 qt_filhos_vivos, 
	null doc_nasc1, 
	null doc_nasc2, 
	null doc_nasc3, 
	null doc_nasc4, 
	null doc_nasc5, 
	1 IE_TIPO_REG_INTERFACE, 
	'4.0.0.0' DS_VERSAO_INTERFACE, 
	null ie_alta_uti, 
	null ie_sexo_sus, 
	null cd_internacional, 
	null nm_usuario_atend 
FROM	ESTABELECIMENTO D 
WHERE	D.cd_cns is not null 

union all
 
SELECT	A.NR_ATENDIMENTO, 
	A.CD_ESTABELECIMENTO, 
	A.CD_PESSOA_FISICA, 
    A.DT_ENTRADA, 
    A.IE_TIPO_ATENDIMENTO, 
    A.DT_ALTA, 
	A.CD_MOTIVO_ALTA, 
	A.IE_TIPO_CONVENIO, 
    B.NM_PESSOA_FISICA NM_PACIENTE, 
    B.NR_PRONTUARIO, 
    B.DT_NASCIMENTO, 
    B.IE_SEXO, 
	C.DS_ENDERECO NM_LOGRADOURO, 
	C.NR_ENDERECO, 
	C.DS_COMPLEMENTO, 
	C.SG_ESTADO SG_ESTADO_PACIENTE, 
	REPLACE(C.CD_CEP,'-','') CD_CEP, 
	F.CD_MUNICIPIO_SINPAS CD_MUNICIPIO, 
	E.CD_CGC, 
	E.SG_ESTADO SG_ESTADO_CGC, 
	E.CD_CEP CD_CEP_CGC, 
	E.DS_BAIRRO DS_BAIRRO_CGC, 
	G.CD_PROCEDIMENTO, 
	G.IE_ORIGEM_PROCED, 
	G.CD_CID_PRIMARIO, 
	G.CD_CID_SECUNDARIO, 
	C.CD_MUNICIPIO_IBGE, 
	' ' CD_CNS, 
	p.CD_ANS, 
	CASE WHEN A.IE_TIPO_CONVENIO=1 THEN 'P'  ELSE 'C' END  IE_FONTE_REMUNERACAO, 
	coalesce(v.cd_fonte_remuner_cih, CASE WHEN A.IE_TIPO_CONVENIO=1 THEN '2'  ELSE CASE WHEN A.IE_TIPO_CONVENIO=4 THEN '3' WHEN A.IE_TIPO_CONVENIO=6 THEN '6' WHEN A.IE_TIPO_CONVENIO=9 THEN '9'  ELSE '1' END  END ) IE_FONTE_REMUNER2, 
	A.DT_ALTA_INTERNO DT_COMPETENCIA, 
	(substr(D.cd_cns, 1,8)) CD_CNES, 
	substr(Obter_Desc_Proc_CIH(G.CD_PROCEDIMENTO, g.nr_atendimento),1,188) ds_procedimento, 
	CASE WHEN A.IE_TIPO_CONVENIO=1 THEN ''  ELSE v.cd_cgc END  cd_cnpj, 
	t.CD_USUARIO_CONVENIO CD_USUARIO_CONVENIO, 
	lpad(SUBSTR(Obter_Declaracao_Obito(a.nr_atendimento),1,11),11,'0') nr_declaracao_obito, 
--	substr(to_char(Obter_Declaracao_Obito(a.nr_atendimento), '00000000'),2,9) nr_declaracao_obito, 
	CASE WHEN SUS_Obter_Dias_UTI(a.nr_atendimento)=0 THEN  OBTER_DIAS_INTERNACAO_UTI(a.nr_atendimento)  ELSE SUS_Obter_Dias_UTI(a.nr_atendimento) END  QT_DIAS_UTI, 
	t.cd_convenio, 
	t.dt_inicio_vigencia, 
	t.cd_categoria, 
	OBTER_QT_NASCIDOS_CIH(G.CD_PROCEDIMENTO,a.nr_atendimento) qt_filhos_vivos, 
	OBTER_DNV_NASCIDOS_CIH(G.CD_PROCEDIMENTO,1,a.nr_atendimento) doc_nasc1, 
	OBTER_DNV_NASCIDOS_CIH(G.CD_PROCEDIMENTO,2,a.nr_atendimento) doc_nasc2, 
	OBTER_DNV_NASCIDOS_CIH(G.CD_PROCEDIMENTO,3,a.nr_atendimento) doc_nasc3, 
	OBTER_DNV_NASCIDOS_CIH(G.CD_PROCEDIMENTO,4,a.nr_atendimento) doc_nasc4, 
	OBTER_DNV_NASCIDOS_CIH(G.CD_PROCEDIMENTO,5,a.nr_atendimento) doc_nasc5, 
	2 IE_TIPO_REG_INTERFACE, 
	'4.0.0.0' DS_VERSAO_INTERFACE, 
	substr(OBTER_SE_ALTA_UTI(a.nr_atendimento), 1,1) ie_alta_uti, 
	h.ie_sexo_sus ie_sexo_sus, 
	p.cd_internacional, 
	a.nm_usuario_atend 
FROM convenio v, atend_categoria_convenio t, pessoa_juridica p, pessoa_juridica e, estabelecimento d, pessoa_fisica b
LEFT OUTER JOIN compl_pessoa_fisica c ON (B.CD_PESSOA_FISICA = C.CD_PESSOA_FISICA AND 1 = C.IE_TIPO_COMPLEMENTO)
LEFT OUTER JOIN sus_municipio f ON (C.CD_MUNICIPIO_IBGE = F.CD_MUNICIPIO_IBGE)
, procedimento_paciente_cih g
LEFT OUTER JOIN procedimento h ON (g.cd_procedimento = h.cd_procedimento AND g.ie_origem_proced = h.ie_origem_proced)
, atendimento_paciente a
LEFT OUTER JOIN procedimento_paciente_cih g ON (A.NR_ATENDIMENTO = G.NR_ATENDIMENTO)
WHERE A.CD_PESSOA_FISICA 		= B.CD_PESSOA_FISICA      AND coalesce(A.IE_TIPO_CONVENIO,1)	<> 3 AND A.CD_ESTABELECIMENTO		= D.CD_ESTABELECIMENTO AND D.CD_CGC			= E.CD_CGC  and a.nr_atendimento		= t.nr_atendimento and t.cd_convenio			= v.cd_convenio and v.cd_cgc			= p.cd_cgc and obter_atecaco_atendimento(t.nr_atendimento) 	= t.nr_seq_interno and coalesce(C.CD_MUNICIPIO_IBGE,1)		<> '999999' -- Bruna, OS61446 
  and t.dt_inicio_vigencia= 
	(select max(dt_inicio_vigencia) 
	from atend_categoria_convenio b 
	where nr_atendimento 		= a.nr_atendimento) AND EXISTS (SELECT	1 
       	FROM		SETOR_ATENDIMENTO Y, 
				ATEND_PACIENTE_UNIDADE Z 
		WHERE		Z.CD_SETOR_ATENDIMENTO = Y.CD_SETOR_ATENDIMENTO 
		AND		A.NR_ATENDIMENTO    = Z.NR_ATENDIMENTO 
		AND		Y.CD_CLASSIF_SETOR IN (2,3,4,8));

