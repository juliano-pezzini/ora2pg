-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_medico_v (cd_ano, cd_medico, nm_medico, ie_tipo_convenio, ds_tipo_convenio, ds_informacao, qt_jan, qt_fev, qt_mar, qt_abr, qt_mai, qt_jun, qt_jul, qt_ago, qt_set, qt_out, qt_nov, qt_dez, qt_total) AS SELECT 	TRUNC(A.DT_REFERENCIA,'YEAR') CD_ANO,
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA NM_MEDICO,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30) DS_TIPO_CONVENIO,
		obter_desc_expressao(287742, 'Daily') DS_INFORMACAO,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='01' THEN NR_PACIENTES  ELSE 0 END ) QT_JAN,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='02' THEN NR_PACIENTES  ELSE 0 END ) QT_FEV,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='03' THEN NR_PACIENTES  ELSE 0 END ) QT_MAR,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='04' THEN NR_PACIENTES  ELSE 0 END ) QT_ABR,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='05' THEN NR_PACIENTES  ELSE 0 END ) QT_MAI,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='06' THEN NR_PACIENTES  ELSE 0 END ) QT_JUN,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='07' THEN NR_PACIENTES  ELSE 0 END ) QT_JUL,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='08' THEN NR_PACIENTES  ELSE 0 END ) QT_AGO,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='09' THEN NR_PACIENTES  ELSE 0 END ) QT_SET,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='10' THEN NR_PACIENTES  ELSE 0 END ) QT_OUT,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='11' THEN NR_PACIENTES  ELSE 0 END ) QT_NOV,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='12' THEN NR_PACIENTES  ELSE 0 END ) QT_DEZ,
		SUM(NR_PACIENTES) QT_TOTAL
FROM   	CONVENIO C,
		MEDICO M,
		PESSOA_FISICA P,
		EIS_OCUPACAO_HOSPITALAR A
WHERE 	A.CD_CONVENIO		= C.CD_CONVENIO
AND		A.CD_MEDICO			= P.CD_PESSOA_FISICA
AND		P.CD_PESSOA_FISICA	= M.CD_PESSOA_FISICA	
AND		A.IE_PERIODO		= 'M'
GROUP BY	TRUNC(A.DT_REFERENCIA,'YEAR'),
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30)

UNION

SELECT 	TRUNC(A.DT_REFERENCIA,'YEAR') CD_ANO,
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA NM_MEDICO,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30) DS_TIPO_CONVENIO,
		CONCAT(obter_desc_expressao(308067, 'Discharges'), CONCAT('/', obter_desc_expressao(559671, 'Deaths'))) DS_INFORMACAO,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='01' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_JAN,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='02' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_FEV,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='03' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_MAR,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='04' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_ABR,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='05' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_MAI,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='06' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_JUN,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='07' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_JUL,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='08' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_AGO,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='09' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_SET,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='10' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_OUT,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='11' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_NOV,
		SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='12' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) QT_DEZ,
		SUM(NR_ALTAS + NR_OBITOS) QT_TOTAL
FROM   	CONVENIO C,
		MEDICO M,
		PESSOA_FISICA P,
		EIS_OCUPACAO_HOSPITALAR A
WHERE 	A.CD_CONVENIO		= C.CD_CONVENIO
AND		A.CD_MEDICO			= P.CD_PESSOA_FISICA
AND		P.CD_PESSOA_FISICA	= M.CD_PESSOA_FISICA	
AND		A.IE_PERIODO		= 'M'
GROUP BY	TRUNC(A.DT_REFERENCIA,'YEAR'),
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30)

UNION

SELECT 	TRUNC(A.DT_REFERENCIA,'YEAR') CD_ANO,
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA NM_MEDICO,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30) DS_TIPO_CONVENIO,
		obter_desc_expressao(560449, 'Average Stay') DS_INFORMACAO,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='01' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='01' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='01' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_JAN,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='02' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='02' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='02' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_FEV,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='03' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='03' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='03' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_MAR,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='04' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='04' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='04' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_ABR,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='05' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='05' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='05' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_MAI,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='06' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='06' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='06' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_JUN,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='07' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='07' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='07' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_JUL,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='08' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='08' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='08' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_AGO,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='09' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='09' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='09' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_SET,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='10' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='10' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='10' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_OUT,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='11' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='11' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='11' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_NOV,
		CASE WHEN SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='12' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END )=0 THEN 0  ELSE SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='12' THEN NR_PACIENTES  ELSE 0 END ) /			SUM(CASE WHEN TO_CHAR(A.DT_REFERENCIA,'MM')='12' THEN NR_ALTAS + NR_OBITOS  ELSE 0 END ) END  QT_DEZ,
		CASE WHEN SUM(NR_ALTAS + NR_OBITOS)=0 THEN 0  ELSE SUM(NR_PACIENTES) / SUM(NR_ALTAS + NR_OBITOS) END  QT_TOTAL
FROM   	CONVENIO C,
		MEDICO M,
		PESSOA_FISICA P,
		EIS_OCUPACAO_HOSPITALAR A
WHERE 	A.CD_CONVENIO		= C.CD_CONVENIO
AND		A.CD_MEDICO			= P.CD_PESSOA_FISICA
AND		P.CD_PESSOA_FISICA	= M.CD_PESSOA_FISICA	
AND		A.IE_PERIODO		= 'M'
GROUP BY	TRUNC(A.DT_REFERENCIA,'YEAR'),
		A.CD_MEDICO,
		P.NM_PESSOA_FISICA,
		C.IE_TIPO_CONVENIO,
		SUBSTR(OBTER_VALOR_DOMINIO(11,C.IE_TIPO_CONVENIO),1,30);

