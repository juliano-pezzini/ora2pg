-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW senne_v (tp_registro, cd_tipo_registro, nr_seq_registro, cd_empresa, nr_arquivo, dt_criacao, dt_inicio_referencia, dt_final_referencia, ds_campo, cd_convenio, ie_tipo_paciente, cd_identificacao, nm_paciente, cd_paciente_convenio, ds_complemento, ds_autorizacao_guia, ds_autorizacao_senha, dt_inicio_procedimento, hr_inicio_procedimento, dt_final_procedimento, hr_final_procedimento, cd_procedimento, ie_emergencia, ie_tipo_hora, cd_posicao, qt_ch, vl_total, qt_executada, qt_itens, qt_total_ch, vl_lote, nr_seq_protocolo, nr_interno_conta) AS select	1	tp_registro,
	0	cd_tipo_registro,
	0	nr_seq_registro,
	a.cd_interno cd_empresa,
	substr(b.nr_seq_doc_convenio,1,5) nr_arquivo,
	LOCALTIMESTAMP	dt_criacao,
	a.dt_inicio_protocolo dt_inicio_referencia,
	a.dt_fim_protocolo dt_final_referencia,
	' '	ds_campo,
	0	cd_convenio,
	0	ie_tipo_paciente,
	0	cd_identificacao,
	null	nm_paciente,
	0	cd_paciente_convenio,
	null	ds_complemento,
	null ds_autorizacao_guia,
	null ds_autorizacao_senha,
	LOCALTIMESTAMP dt_inicio_procedimento,
	LOCALTIMESTAMP hr_inicio_procedimento,
	LOCALTIMESTAMP dt_final_procedimento,
	LOCALTIMESTAMP hr_final_procedimento,
	null cd_procedimento,
	null ie_emergencia,
	null ie_tipo_hora,
	null cd_posicao,
	0 qt_ch,
	0 vl_total,
	0 qt_executada,
	0 qt_itens,
	0 qt_total_ch,
	0 vl_lote,
	a.nr_seq_protocolo,
	0 nr_interno_conta
FROM	w_interf_conta_header a,
	protocolo_convenio b
where	a.nr_seq_protocolo = b.nr_seq_protocolo

union all

select	2	tp_registro,
	1	cd_tipo_registro,
	0 nr_seq_registro,
	a.cd_interno cd_empresa,
	'0'	nr_arquivo,
	LOCALTIMESTAMP	dt_criacao,
	LOCALTIMESTAMP	dt_inicio_referencia,
	LOCALTIMESTAMP dt_final_referencia,
	' '	ds_campo,
	a.cd_convenio,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 1 WHEN a.ie_tipo_atendimento=3 THEN 2  ELSE 3 END  ie_tipo_paciente,
	a.nr_atendimento cd_identificacao,
	a.nm_paciente,
	(a.cd_usuario_convenio)::numeric  cd_paciente_convenio ,
	CASE WHEN a.cd_convenio=35 THEN a.cd_proc_principal  ELSE null END  ds_complemento,
	null ds_autorizacao_guia,
	null ds_autorizacao_senha,
	LOCALTIMESTAMP dt_inicio_procedimento,
	LOCALTIMESTAMP hr_inicio_procedimento,
	LOCALTIMESTAMP dt_final_procedimento,
	LOCALTIMESTAMP hr_final_procedimento,
	null cd_procedimento,
	null ie_emergencia,
	null ie_tipo_hora,
	null cd_posicao,
	0 qt_ch,
	0 vl_total,
	0 qt_executada,
	0 qt_itens,
	0 qt_total_ch,
	0 vl_lote,
	a.nr_seq_protocolo,
	a.nr_interno_conta
from	w_interf_conta_cab a
where	1 = 1

union all

select	3	tp_registro,
	2	cd_tipo_registro,
	0 nr_seq_registro,
	a.cd_interno cd_empresa,
	'0'	nr_arquivo,
	LOCALTIMESTAMP	dt_criacao,
	LOCALTIMESTAMP	dt_inicio_vigencia,
	LOCALTIMESTAMP dt_final_vigencia,
	' '	ds_campo,
	0	cd_convenio,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 1 WHEN a.ie_tipo_atendimento=3 THEN 2  ELSE 3 END  ie_tipo_paciente,
	a.nr_atendimento cd_identificacao,
	null	nm_paciente,
	0	cd_paciente_convenio,
	a.cd_cid_principal ds_complemento,
	b.nr_doc_convenio ds_autorizacao_guia,
	b.cd_senha_guia ds_autorizacao_senha,
	a.dt_entrada dt_inicio_procedimento,
	a.dt_entrada hr_inicio_procedimento,
	a.dt_entrada dt_final_procedimento,
	a.dt_entrada hr_final_procedimento,
	b.cd_item_convenio cd_procedimento,
	'N' ie_emergencia,
	'N' ie_tipo_hora,
	substr(obter_conversao_externa(b.cd_cgc_convenio, 'SENNE_V', 'CD_POSICAO', coalesce(b.cd_funcao_espec_med,0)),1,120) cd_posicao,
	b.qt_ch_item qt_ch,
	b.vl_total_item vl_total,
	b.qt_item qt_executada,
	0 qt_itens,
	0 qt_total_ch,
	0 vl_lote,
	a.nr_seq_protocolo,
	a.nr_interno_conta
from	w_interf_conta_cab 	a,
	w_interf_conta_item	b
where	a.nr_interno_conta = b.nr_interno_conta

union all

select	4	tp_registro,
	3	cd_tipo_registro,
	0	nr_seq_registro,
	a.cd_interno cd_empresa,
	'0'	nr_arquivo,
	LOCALTIMESTAMP	dt_criacao,
	LOCALTIMESTAMP	dt_inicio_referencia,
	LOCALTIMESTAMP dt_final_referencia,
	' '	ds_campo,
	0	cd_convenio,
	0	ie_tipo_paciente,
	0	cd_identificacao,
	null	nm_paciente,
	0	cd_paciente_convenio,
	null	ds_complemento,
	null ds_autorizacao_guia,
	null ds_autorizacao_senha,
	LOCALTIMESTAMP dt_inicio_procedimento,
	LOCALTIMESTAMP hr_inicio_procedimento,
	LOCALTIMESTAMP dt_final_procedimento,
	LOCALTIMESTAMP hr_final_procedimento,
	null cd_procedimento,
	null ie_emergencia,
	null ie_tipo_hora,
	null cd_posicao,
	0 qt_ch,
	0 vl_total,
	0 qt_executada,
	sum(b.qt_item) qt_itens,
	sum(b.qt_ch_item) qt_total_ch,
	sum(b.vl_total_item) vl_lote,
	a.nr_seq_protocolo,
	999999 nr_interno_conta
from	w_interf_conta_cab 	a,
	w_interf_conta_item	b
where	a.nr_interno_conta = b.nr_interno_conta
group by a.nr_seq_protocolo,
	a.cd_interno;

