-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_valores_contratos_plano_v (ds_acao_contrato, nr_seq_contrato, qt_ativo, qt_inativo, qt_aberto, vl_ativo, vl_inativo, vl_titlar_ativo, vl_dependente_ativo, vl_titlar_inativo, vl_dependente_inativo) AS select	substr(obter_valor_dominio(2115,ie_acao_contrato),1,150) ds_acao_contrato,
	nr_seq_contrato,
	sum(qt_ativos) qt_ativo,
	sum(qt_inativos) qt_inativo,
	sum(qt_abertos) qt_aberto,
	sum(vl_segurado_ativo) vl_ativo,
	sum(vl_segurado_inativo) vl_inativo,
	sum(vl_titlar_ativo)  vl_titlar_ativo,
	sum(vl_dependente_ativo)  vl_dependente_ativo,
	sum(vl_titlar_inativo)  vl_titlar_inativo,
	sum(vl_dependente_inativo)  vl_dependente_inativo
FROM (	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD'))  ELSE 0 END  vl_titlar_ativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN 0  ELSE sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) END  vl_dependente_ativo,
		0 vl_titlar_inativo,
		0 vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_liberacao is not null
	and	b.dt_rescisao is null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,b.nr_seq_titular,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		0 vl_titlar_ativo,
		0 vl_dependente_ativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD'))  ELSE 0 END  vl_titlar_inativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN 0  ELSE sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) END  vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,b.nr_seq_titular,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		0 vl_titlar_ativo,
		0 vl_dependente_ativo,
		0 vl_titlar_inativo,
		0 vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_liberacao is null
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),a.nr_sequencia) alias28
group by	ie_acao_contrato,nr_seq_contrato

UNION ALL

select	null ie_acao_contrato,
	nr_sequencia nr_seq_contrato,
	null qt_ativo,
	null qt_inativo,
	null qt_aberto,
	null vl_ativo,
	null vl_inativo,
	null vl_titlar_ativo,
	null vl_dependente_ativo,
	null vl_titlar_inativo,
	null vl_dependente_inativo
from	pls_contrato

UNION ALL

select	'Total' ie_acao_contrato,
	nr_seq_contrato,
	sum(qt_ativos) qt_ativo,
	sum(qt_inativos) qt_inativo,
	sum(qt_abertos) qt_aberto,
	sum(vl_segurado_ativo) vl_ativo,
	sum(vl_segurado_inativo) vl_inativo,
	sum(vl_titlar_ativo)  vl_titlar_ativo,
	sum(vl_dependente_ativo)  vl_dependente_ativo,
	sum(vl_titlar_inativo)  vl_titlar_inativo,
	sum(vl_dependente_inativo)  vl_dependente_inativo
from (	select	b.ie_acao_contrato,
		count(*) qt_ativos,
		0 qt_inativos,
		0 qt_abertos,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_ativo,
		0 vl_segurado_inativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD'))  ELSE 0 END  vl_titlar_ativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN 0  ELSE sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) END  vl_dependente_ativo,
		0 vl_titlar_inativo,
		0 vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_rescisao is null
	and	b.dt_liberacao is not null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,b.nr_seq_titular,a.nr_sequencia
	
UNION ALL

	select	b.ie_acao_contrato,
		0 qt_ativos,
		count(*) qt_inativos,
		0 qt_abertos,
		0 vl_segurado_ativo,
		sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) vl_segurado_inativo,
		0 vl_titlar_ativo,
		0 vl_dependente_ativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD'))  ELSE 0 END  vl_titlar_inativo,
		CASE WHEN b.nr_seq_titular IS NULL THEN 0  ELSE sum(pls_obter_valor_segurado(b.nr_sequencia,'VCD')) END  vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_rescisao is not null
	and	b.dt_liberacao is not null
	and	b.ie_acao_contrato is not null
	group by	b.ie_acao_contrato,b.nr_seq_titular,a.nr_sequencia
	
UNION ALL

	select	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ) ie_acao_contrato,
		0 qt_ativos,
		0 qt_inativos,
		count(*) qt_abertos,
		0 vl_segurado_ativo,
		0 vl_segurado_inativo,
		0 vl_titlar_ativo,
		0 vl_dependente_ativo,
		0 vl_titlar_inativo,
		0 vl_dependente_inativo,
		a.nr_sequencia nr_seq_contrato
	from	pls_contrato a,
		pls_segurado b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.dt_liberacao is null
	group by	coalesce(b.ie_acao_contrato,CASE WHEN a.dt_aprovacao IS NULL THEN 'A'  ELSE 'L' END ),a.nr_sequencia) alias55
group by nr_seq_contrato;

