-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_exp_st_flp_v (tp_registro, ds_versao, nr_cad_munic_contrib, cd_cnpj, ds_razao_social, nm_fantasia, nr_inscricao_estadual, nr_reg_junta_comercial, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_uf, cd_cep, cd_ddd, nr_telefone, nr_fax, ds_email, cmc_prestador, cd_cnpj_prestador, ds_razao_prestador, ds_nome_prestador, endereco_prestador, nr_endereco_prestador, complemento_prestador, bairro_prestador, cep_prestador, cidade_prestador, uf_prestador, ddd_prestador, fone_prestador, ie_grafica, nr_nota_fiscal, nr_serie, cd_cnae, data_emissao, vl_contabil, vl_base_calculo, ds_observacao, cd_cfps, cd_situacao_tributaria, vl_aliquota_iss, vl_iss, cd_estabelecimento, cd_cgc_emitente, dt_emissao) AS select distinct
    'H' TP_REGISTRO,
    '3.00.0001' DS_VERSAO,
    null NR_CAD_MUNIC_CONTRIB,
    null CD_CNPJ,
    null DS_RAZAO_SOCIAL,
    null NM_FANTASIA,
    null NR_INSCRICAO_ESTADUAL,
    null NR_REG_JUNTA_COMERCIAL,
    null DS_ENDERECO,
    null NR_ENDERECO,
    null DS_COMPLEMENTO,
    null DS_BAIRRO,
    null DS_MUNICIPIO,
    null SG_UF,
    null CD_CEP,
    null CD_DDD,
    null NR_TELEFONE,
    null NR_FAX,
    null DS_EMAIL,
    null CMC_PRESTADOR,
    null CD_CNPJ_PRESTADOR,
    null DS_RAZAO_PRESTADOR,
    null DS_NOME_PRESTADOR,
    null ENDERECO_PRESTADOR,
    null NR_ENDERECO_PRESTADOR,
    null COMPLEMENTO_PRESTADOR,
    null BAIRRO_PRESTADOR,
    null CEP_PRESTADOR,
    null CIDADE_PRESTADOR,
    null UF_PRESTADOR,
    null DDD_PRESTADOR,
    null FONE_PRESTADOR,
    null IE_GRAFICA,
    null NR_NOTA_FISCAL,
    null NR_SERIE,
    null CD_CNAE,
    null DATA_EMISSAO,
    null VL_CONTABIL,
    null VL_BASE_CALCULO,
    null DS_OBSERVACAO,
    null CD_CFPS,
    null CD_SITUACAO_TRIBUTARIA,
    null VL_ALIQUOTA_ISS,
    null VL_ISS,
    e.cd_estabelecimento,
    null cd_cgc_emitente,
    null dt_emissao
FROM estabelecimento e

union all

select distinct
    'C' TP_REGISTRO,
    null DS_VERSAO,
    lpad(substr(somente_numero(obter_dados_pf_pj(null,n.cd_cgc,'IM')),1,7), 7, '0000000') NR_CAD_MUNIC_CONTRIB,
    rpad(substr(n.cd_cgc, 1, 14), 14, ' ') CD_CNPJ,
    rpad(substr(elimina_caractere_especial(obter_nome_pj(n.cd_cgc)), 1, 80), 80, ' ') DS_RAZAO_SOCIAL,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(obter_nome_fantasia_pj(n.cd_cgc))), 1, 50), 50, ' ') NM_FANTASIA,
    rpad(substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'), 1, 20), 20, ' ') NR_INSCRICAO_ESTADUAL,
    rpad(e.nr_reg_junta_comercial, 20, ' ') NR_REG_JUNTA_COMERCIAL,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'EN'))), 1, 80), 80, ' ') DS_ENDERECO,
    rpad(somente_numero(substr(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'NR'), 1, 10)), 10, ' ') NR_ENDERECO,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'CO'))), 1, 30), 30, ' ') DS_COMPLEMENTO,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'B'))), 1, 50), 50, ' ') DS_BAIRRO,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'DM'))), 1, 50), 50, ' ') DS_MUNICIPIO,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'UF'))), 1, 50), 50, ' ') SG_UF,
    rpad(substr(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'CEP'), 1, 8), 8, ' ') CD_CEP,
    rpad(substr(somente_numero(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'DDT')), 1, 2), 2, ' ') CD_DDD,
    rpad(substr(somente_numero(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'T')), 1, 8), 8, ' ') NR_TELEFONE,
    rpad(substr(somente_numero(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'FAX')), 1, 8), 8, ' ') NR_FAX,
    rpad(substr(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc, 'M')), 1, 80), 80, ' ') DS_EMAIL,
    null CMC_PRESTADOR,
    null CD_CNPJ_PRESTADOR,
    null DS_RAZAO_PRESTADOR,
    null DS_NOME_PRESTADOR,
    null ENDERECO_PRESTADOR,
    null NR_ENDERECO_PRESTADOR,
    null COMPLEMENTO_PRESTADOR,
    null BAIRRO_PRESTADOR,
    null CEP_PRESTADOR,
    null CIDADE_PRESTADOR,
    null UF_PRESTADOR,
    null DDD_PRESTADOR,
    null FONE_PRESTADOR,
    null IE_GRAFICA,
    null NR_NOTA_FISCAL,
    null NR_SERIE,
    null CD_CNAE,
    null DATA_EMISSAO,
    null VL_CONTABIL,
    null VL_BASE_CALCULO,
    null DS_OBSERVACAO,
    null CD_CFPS,
    null CD_SITUACAO_TRIBUTARIA,
    null VL_ALIQUOTA_ISS,
    null VL_ISS,
    n.cd_estabelecimento,
    null cd_cgc_emitente,
    null dt_emissao
from nota_fiscal n, estabelecimento e
where	obter_se_nota_entrada_saida(n.nr_sequencia) = 'E'
and   n.cd_estabelecimento = e.cd_estabelecimento
and   e.cd_cgc = n.cd_cgc
and   n.ie_situacao = '1'

union all

select distinct
    'P' TP_REGISTRO,
    null DS_VERSAO,
    null NR_CAD_MUNIC_CONTRIB,
    null CD_CNPJ,
    null DS_RAZAO_SOCIAL,
    null NM_FANTASIA,
    null NR_INSCRICAO_ESTADUAL,
    null NR_REG_JUNTA_COMERCIAL,
    null DS_ENDERECO,
    null NR_ENDERECO,
    null DS_COMPLEMENTO,
    null DS_BAIRRO,
    null DS_MUNICIPIO,
    null SG_UF,
    null CD_CEP,
    null CD_DDD,
    null NR_TELEFONE,
    null NR_FAX,
    null DS_EMAIL,
    lpad(substr(somente_numero(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM')),1,7), 7, '000000') CMC_PRESTADOR,
    rpad(substr(n.cd_cgc_emitente, 1, 14), 14, ' ') CD_CNPJ_PRESTADOR,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(obter_nome_pj(n.cd_cgc_emitente))), 1, 80), 80, ' ') DS_RAZAO_PRESTADOR,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(obter_dados_pf_pj(null,n.cd_cgc_emitente,'F'))), 1, 50), 50, ' ') DS_NOME_PRESTADOR,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'EN'))), 1, 80), 80, ' ') ENDERECO_PRESTADOR,
    rpad(substr(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'NR'), 1, 10), 10, ' ')   NR_ENDERECO_PRESTADOR,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CO'))), 1, 30), 30, ' ') COMPLEMENTO_PRESTADOR,
    rpad(substr(elimina_caractere_especial(elimina_acentuacao(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'B'))), 1, 50), 50, ' ') BAIRRO_PRESTADOR,
    lpad(substr(somente_numero(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CEP')), 1, 8), 8, '0') CEP_PRESTADOR,
    rpad(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'DM'), 50, ' ') CIDADE_PRESTADOR,
    rpad(substr(nfse_obter_dados_pf_pj(null, n.cd_cgc_emitente, 'UF'), 1, 2), 2, ' ') UF_PRESTADOR,
    lpad(substr(somente_numero(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'DDT')), 1, 2), 2, '0') DDD_PRESTADOR,
    rpad(substr(somente_numero(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'T')), 1, 8), 8, ' ') FONE_PRESTADOR,
    null IE_GRAFICA,
    null NR_NOTA_FISCAL,
    null NR_SERIE,
    null CD_CNAE,
    null DATA_EMISSAO,
    null VL_CONTABIL,
    null VL_BASE_CALCULO,
    null DS_OBSERVACAO,
    null CD_CFPS,
    null CD_SITUACAO_TRIBUTARIA,
    null VL_ALIQUOTA_ISS,
    null VL_ISS,
    n.cd_estabelecimento,
    n.cd_cgc_emitente,
    null dt_emissao
from nota_fiscal n, estabelecimento e
where exists (
    select 1
    from w_nota_fiscal x
    where x.nr_seq_nota_fiscal = n.nr_sequencia)
and substr(obter_se_nota_entrada_saida(n.nr_sequencia), 1, 1) = 'E'
and n.cd_estabelecimento = e.cd_estabelecimento
and e.cd_cgc = n.cd_cgc
and n.cd_cgc is not null
and n.cd_cgc_emitente is not null
and n.vl_mercadoria > 0

union all

select distinct
    'R' TP_REGISTRO,
    null DS_VERSAO,
    lpad(substr(somente_numero(obter_dados_pf_pj(null,n.cd_cgc,'IM')),1,7), 7, '0000000') NR_CAD_MUNIC_CONTRIB,
    lpad(substr(n.cd_cgc, 1, 14), 14, '0') CD_CNPJ,
    null DS_RAZAO_SOCIAL,
    null NM_FANTASIA,
    null NR_INSCRICAO_ESTADUAL,
    null NR_REG_JUNTA_COMERCIAL,
    null DS_ENDERECO,
    null NR_ENDERECO,
    null DS_COMPLEMENTO,
    null DS_BAIRRO,
    null DS_MUNICIPIO,
    null SG_UF,
    null CD_CEP,
    null CD_DDD,
    null NR_TELEFONE,
    null NR_FAX,
    null DS_EMAIL,
    lpad(substr(somente_numero(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM')),1,7), 7, '000000') CMC_PRESTADOR,
    rpad(substr(n.cd_cgc_emitente, 1, 14), 14, ' ') CD_CNPJ_PRESTADOR,
    null DS_RAZAO_PRESTADOR,
    null DS_NOME_PRESTADOR,
    null ENDERECO_PRESTADOR,
    null NR_ENDERECO_PRESTADOR,
    null COMPLEMENTO_PRESTADOR,
    null BAIRRO_PRESTADOR,
    null CEP_PRESTADOR,
    null CIDADE_PRESTADOR,
    null UF_PRESTADOR,
    null DDD_PRESTADOR,
    null FONE_PRESTADOR,
    null IE_GRAFICA,
    lpad(substr(n.nr_nota_fiscal, 1, 15), 15, '0') NR_NOTA_FISCAL,
    rpad(substr(n.cd_serie_nf, 1, 10), 10, ' ') NR_SERIE,
    lpad(coalesce(obter_dados_cnae(obter_dados_pf_pj(null, n.cd_cgc_emitente,'CNAE'),'CD'),0),11,0) CD_CNAE,
    to_char(n.dt_emissao, 'DDMMYYYY') DATA_EMISSAO,
    lpad(replace(replace(to_char(n.vl_total_nota, 'FM999999999D90'), ',', null), ' ', null), 18, 0) VL_CONTABIL,
    lpad(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'B', 'ISS'), 'FM999999999D90'), ',', null), ' ', null), 18, 0) VL_BASE_CALCULO,
    rpad(substr(replace(replace(elimina_caractere_especial(n.ds_observacao), CHR(10), null), CHR(13), null),1,100),100,' ') DS_OBSERVACAO,
    obter_cfps_municipio(n.cd_estabelecimento,n.cd_cgc_emitente,n.cd_pessoa_fisica,'FLORIANOPOLIS') CD_CFPS,
    lpad(substr((select	max(s.cd_situacao) 
        from nota_fiscal_item_trib x, tributo t, situacao_trib_prest_serv s
        where x.nr_sequencia = n.nr_sequencia
        and	x.cd_tributo = t.cd_tributo
        and	x.nr_seq_sit_trib = s.nr_sequencia
        and	t.ie_tipo_tributo = 'ISS'),1,3),3,'0') CD_SITUACAO_TRIBUTARIA,
    lpad(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'X', 'ISS'), 'FM999999999D90'), ',', null), ' ', null), 18, 0) VL_ALIQUOTA_ISS,
    lpad(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'ISS'), 'FM999999999D90'), ',', null), ' ', null), 18, 0) VL_ISS,
    n.cd_estabelecimento,
    n.cd_cgc_emitente,
    n.dt_emissao dt_emissao
from nota_fiscal n, estabelecimento e
where exists (
    select 1
    from w_nota_fiscal x
    where  x.nr_seq_nota_fiscal = n.nr_sequencia)
and	  substr(obter_se_nota_entrada_saida(n.nr_sequencia), 1, 1) = 'E'
and		n.cd_estabelecimento = e.cd_estabelecimento
and   e.cd_cgc = n.cd_cgc
and n.cd_cgc is not null
and   n.cd_cgc_emitente is not null
and   n.vl_mercadoria > 0

union all

select distinct
    'L' TP_REGISTRO,
    null DS_VERSAO,
    null NR_CAD_MUNIC_CONTRIB,
    null CD_CNPJ,
    null DS_RAZAO_SOCIAL,
    null NM_FANTASIA,
    null NR_INSCRICAO_ESTADUAL,
    null NR_REG_JUNTA_COMERCIAL,
    null DS_ENDERECO,
    null NR_ENDERECO,
    null DS_COMPLEMENTO,
    null DS_BAIRRO,
    null DS_MUNICIPIO,
    null SG_UF,
    null CD_CEP,
    null CD_DDD,
    null NR_TELEFONE,
    null NR_FAX,
    null DS_EMAIL,
    null CMC_PRESTADOR,
    null CD_CNPJ_PRESTADOR,
    null DS_RAZAO_PRESTADOR,
    null DS_NOME_PRESTADOR,
    null ENDERECO_PRESTADOR,
    null NR_ENDERECO_PRESTADOR,
    null COMPLEMENTO_PRESTADOR,
    null BAIRRO_PRESTADOR,
    null CEP_PRESTADOR,
    null CIDADE_PRESTADOR,
    null UF_PRESTADOR,
    null DDD_PRESTADOR,
    null FONE_PRESTADOR,
    null IE_GRAFICA,
    null NR_NOTA_FISCAL,
    null NR_SERIE,
    null CD_CNAE,
    null DATA_EMISSAO,
    null VL_CONTABIL,
    null VL_BASE_CALCULO,
    null DS_OBSERVACAO,
    null CD_CFPS,
    null CD_SITUACAO_TRIBUTARIA,
    null VL_ALIQUOTA_ISS,
    null VL_ISS,
    e.cd_estabelecimento,
    null cd_cgc_emitente,
    null dt_emissao
from estabelecimento e;

