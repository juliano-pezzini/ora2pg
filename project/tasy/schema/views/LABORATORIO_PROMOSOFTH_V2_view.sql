-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW laboratorio_promosofth_v2 (cd_tipo_registro, ds_amostra, ie_reservado, ie_repeticao, qt_diluicao, cd_agrupamento, ie_reservado2, ds_coleta, dt_coleta, ie_prioridade, cd_material, cd_instrumento, nr_prescricao, ie_origem, ds_exames, nm_paciente, dt_idade, dt_nascimento, ie_sexo, ie_cor, cd_pessoa_fisica, cd_atributo, ds_valor, ie_digito, ds_sigla, cd_setor_prescr, result_ant, ds_exame_filho, ds_observacao) AS select      10 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	' ' ie_reservado,
	'N' ie_repeticao,
	' ' qt_diluicao,
	' ' cd_agrupamento,
	' ' ie_reservado2,
	' ' ds_coleta,
	max(b.dt_atualizacao) dt_coleta,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END  ie_prioridade,
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END  cd_material,
	' ' cd_instrumento,
	a.nr_prescricao,
	a.cd_setor_coleta ie_origem,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160) ds_exames,
	'' nm_paciente,
	'0' dt_idade,
	LOCALTIMESTAMP dt_nascimento,
	'' ie_sexo,
	0  ie_cor,
    '' cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'10' ie_digito,
	' ' ds_sigla,
	e.cd_setor_atendimento cd_setor_prescr,
	null result_ant,
	'' ds_exame_filho,
	'' ds_observacao
FROM prescr_medica e, material_exame_lab d, exame_laboratorio c, prescr_procedimento a
LEFT OUTER JOIN prescr_proc_etapa b ON (a.nr_prescricao = b.nr_prescricao AND a.nr_sequencia = b.nr_seq_prescricao)
LEFT OUTER JOIN lab_parametro f ON (b.ie_etapa = f.ie_status_envio)
WHERE a.nr_seq_exame = c.nr_seq_exame and ((a.nr_seq_lab is not null) or (f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = d.cd_material_exame  and a.nr_prescricao = e.nr_prescricao   and f.cd_estabelecimento = e.cd_estabelecimento and a.nr_prescricao = e.nr_prescricao and a.dt_integracao is null and length(substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null group by  Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia),
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END ,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END ,
	a.nr_prescricao,
	a.cd_setor_coleta,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160),
	e.cd_setor_atendimento

union

select  	10 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	' ' ie_reservado,
	'N' ie_repeticao,
	' ' qt_diluicao,
	' ' cd_agrupamento,
	' ' ie_reservado2,
	' ' ds_coleta,
	max(b.dt_atualizacao) dt_coleta,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END  ie_prioridade,
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END  cd_material,
	' ' cd_instrumento,
	a.nr_prescricao,
	a.cd_setor_coleta ie_origem,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160) ds_exames,
	'' nm_paciente,
	'0' dt_idade,
	LOCALTIMESTAMP dt_nascimento,
	'' ie_sexo,
	0  ie_cor,
    '' cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'10' ie_digito,
	' ' ds_sigla,
	e.cd_setor_atendimento cd_setor_prescr,
	null result_ant,
	'' ds_exame_filho,
	'' ds_observacao
FROM prescr_medica e, material_exame_lab d, exame_laboratorio c, prescr_procedimento a
LEFT OUTER JOIN prescr_proc_etapa b ON (a.nr_prescricao = b.nr_prescricao AND a.nr_sequencia = b.nr_seq_prescricao)
LEFT OUTER JOIN lab_parametro f ON (b.ie_etapa = f.ie_status_envio)
WHERE a.nr_seq_exame = c.nr_seq_exame and a.cd_material_exame = d.cd_material_exame and e.cd_estabelecimento = f.cd_estabelecimento and ((a.nr_seq_lab is not null) or (f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')  and a.nr_prescricao = e.nr_prescricao   and f.cd_estabelecimento = e.cd_estabelecimento and a.dt_integracao is null and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and length(substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160)) > 0 group by  Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia),
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END ,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END ,
	a.nr_prescricao,
	a.cd_setor_coleta,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160),
	e.cd_setor_atendimento

union

select  	distinct
	11 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	'' ds_coleta,
	LOCALTIMESTAMP dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	'' ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'11' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	null result_ant,
	'' ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	pessoa_fisica c,
	prescr_medica b,
	prescr_procedimento a
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null

union

/*anteriores 1*/

select  	distinct
	13 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',1) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',1) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where     y.nr_seq_resultado = m.nr_seq_resultado
		and     o.nr_prescricao = m.nr_prescricao
		and     n.nr_prescricao = o.nr_prescricao
		and     y.nr_seq_exame = n.nr_seq_exame
		and     y.nr_seq_prescr = n.nr_sequencia
		and     o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',1)  LIMIT 1),1,183) ds_observacao
FROM lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and a.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',1) is not null

union

/*filhos 1 */

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',1) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',1) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,1)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,1) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao =     (select	max(dt_atualizacao)
				from  	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 2*/

select    	distinct
	13 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',2) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',2) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',2)  LIMIT 1),1,183) ds_observacao
FROM lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and a.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',2) is not null
 
union

/*filhos 2*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',2) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',2) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao =  obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,2)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,2) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and    	m.ie_padrao = 'S'
and    	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and    	m.dt_atualizacao =     (select   max(dt_atualizacao)
				from     exame_lab_format
				where    ie_padrao = 'S'
				and      ie_mapa_laudo = 'L'
				and      nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 3*/

select  	distinct
	13 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',3) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',3) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',3)  LIMIT 1),1,183) ds_observacao
FROM lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and a.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',3) is not null
 
union

/*filhos 3*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',3) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',3) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,3)
and    	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,3) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao     = (select 	max(dt_atualizacao)
				from    exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 4*/

select  	distinct
	13 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',4)  ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',4) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',4)  LIMIT 1),1,183) ds_observacao
FROM lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and a.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',4) is not null
 
union

/*filhos 4*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',4) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',4) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,4)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,4) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao =     (select max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 5*/

select  	distinct
	13 cd_tipo_registro,
	Lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',5)  ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',5) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',5)  LIMIT 1),1,183) ds_observacao
FROM lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and a.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',5) is not null
 
union

/*filhos 5*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',5) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',5) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,5)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,5) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao    =  (select 	max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 6*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',6) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',6) result_ant,
	CASE WHEN d.cd_exame='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',6)  LIMIT 1),1,183) ds_observacao
FROM exame_laboratorio y, prescr_medica v, exame_lab_format_item n, exame_lab_format m, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame and v.nr_prescricao = x.nr_prescricao and n.nr_seq_exame = y.nr_seq_exame and y.nr_seq_superior is not null  and v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) and obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) is not null and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and m.ie_padrao = 'S' and m.ie_mapa_laudo = 'L' and n.nr_seq_formato = m.nr_seq_formato and m.nr_seq_exame = d.nr_seq_exame and a.dt_integracao is null and y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG') and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null and m.dt_atualizacao     = (select max(dt_atualizacao)
				from   exame_lab_format
				where  ie_padrao = 'S'
				and    ie_mapa_laudo = 'L'
				and    nr_seq_exame = d.nr_seq_exame)
 
union

/*filhos 6*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_amostra_prescr(f.ie_padrao_amostra,a.nr_prescricao,a.nr_seq_exame,a.nr_sequencia) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',6) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',6) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and    	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) IS NOT NULL
and     	((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')))
and     	f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	a.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao    =  (select 	max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

select distinct
	10 cd_tipo_registro,
 	 lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra)  ds_amostra,
	 ' ' ie_reservado,
	'N' ie_repeticao,
	' ' qt_diluicao,
	' ' cd_agrupamento,
	' ' ie_reservado2,
	' ' ds_coleta,
	max(a.dt_coleta) dt_coleta,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END  ie_prioridade,
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END  cd_material,
	' ' cd_instrumento,
	a.nr_prescricao,
	a.cd_setor_coleta ie_origem,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160) ds_exames,
	'' nm_paciente,
	'0' dt_idade,
	LOCALTIMESTAMP dt_nascimento,
	'' ie_sexo,
	0  ie_cor,
    '' cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'10' ie_digito,
	' ' ds_sigla,
	e.cd_setor_atendimento cd_setor_prescr,
	null result_ant,
	'' ds_exame_filho,
	'' ds_observacao
FROM (SELECT row_number() OVER () AS linha FROM tabela_sistema x LIMIT 12) x, prescr_proc_mat_item g, lab_parametro f, prescr_medica e, material_exame_lab d, exame_laboratorio c, prescr_procedimento a
LEFT OUTER JOIN origem_diagnostico o ON (a.cd_setor_coleta = o.nr_sequencia)
WHERE a.nr_seq_exame = c.nr_seq_exame and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = d.cd_material_exame and a.nr_prescricao 	= e.nr_prescricao and f.cd_estabelecimento = e.cd_estabelecimento and a.nr_prescricao 	= e.nr_prescricao and g.dt_integracao is null --and a.nr_prescricao  = 124957
  and g.nr_prescricao = a.nr_prescricao and g.nr_seq_prescr = a.nr_sequencia and length(substr(obter_exames_lab_integr_item(a.nr_prescricao, a.cd_setor_atendimento,'CI8','',f.ie_status_envio,'PROMO', g.nr_seq_prescr_proc_mat ,a.nr_seq_lote_externo,e.cd_estabelecimento), 1, 160)) > 0 and x.linha < (length(obter_exames_lab_integr_item(a.nr_prescricao, a.cd_setor_atendimento,'CI8','',f.ie_status_envio,'PROMO', g.nr_seq_prescr_proc_mat ,a.nr_seq_lote_externo,e.cd_estabelecimento))/160)+1 and obter_equipamento_exame(a.nr_seq_exame,null,'PROMO') is not null group by  lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra),
	CASE WHEN f.ie_gerar_result_prescr='S' THEN lab_obter_material_integracao(a.nr_prescricao, a.nr_sequencia,'C')  ELSE coalesce(d.cd_material_integracao, d.cd_material_exame) END ,
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END ,
	a.nr_prescricao,
	a.cd_setor_coleta,
	substr(Obter_Exames_Prescr_Lab_integr(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI8','',c.nr_seq_grupo_imp, nr_seq_lab, f.ie_status_envio, 'PROMO', null,nr_seq_lote_externo), 1, 160),
	e.cd_setor_atendimento

union

select	distinct
	 11 cd_tipo_registro,
 	 lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra)  ds_amostra,
	 '' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	'' ds_coleta,
	LOCALTIMESTAMP dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	'' ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'11' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	null result_ant,
	'' ds_exame_filho,
	'' ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_medica b, prescr_procedimento a
LEFT OUTER JOIN origem_diagnostico o ON (a.cd_setor_coleta = o.nr_sequencia)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and g.nr_prescricao = a.nr_prescricao and g.nr_seq_prescr = a.nr_sequencia and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame --and a.nr_prescricao  = 124957
  and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null  and length(substr(obter_exames_lab_integr_item(a.nr_prescricao, a.cd_setor_atendimento,'CI8','',f.ie_status_envio,'PROMO', g.nr_seq_prescr_proc_mat ,a.nr_seq_lote_externo,b.cd_estabelecimento), 1, 160)) > 0 and obter_equipamento_exame(a.nr_seq_exame,null,'PROMO') is not null
 
union

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',1) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',1) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where     y.nr_seq_resultado = m.nr_seq_resultado
		and     o.nr_prescricao = m.nr_prescricao
		and     n.nr_prescricao = o.nr_prescricao
		and     y.nr_seq_exame = n.nr_seq_exame
		and     y.nr_seq_prescr = n.nr_sequencia
		and     o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',1)  LIMIT 1),1,183) ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',1) is not null
 
union

/*filhos 1 */

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',1) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',1) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,1)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,1) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao =     (select	max(dt_atualizacao)
				from  	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 2*/

select    	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',2) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',2) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',2)  LIMIT 1),1,183) ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',2) is not null
 
union

/*filhos 2*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',2) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',2) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	v.nr_prescricao =  obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,2)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,2) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and    	m.ie_padrao = 'S'
and    	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and    	m.dt_atualizacao =     (select   max(dt_atualizacao)
				from     exame_lab_format
				where    ie_padrao = 'S'
				and      ie_mapa_laudo = 'L'
				and      nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 3*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',3) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',3) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',3)  LIMIT 1),1,183) ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',3) is not null
 
union

/*filhos 3*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',3) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',3) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,3)
and    	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,3) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao     = (select 	max(dt_atualizacao)
				from    exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 4*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',4)  ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',4) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',4)  LIMIT 1),1,183) ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',4) is not null
 
union

/*filhos 4*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',4) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',4) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,4)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,4) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao =     (select max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 5*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',5)  ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',5) result_ant,
	'' ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',5)  LIMIT 1),1,183) ds_observacao
FROM prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame  and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and ((a.nr_seq_lab is not null) or ( f.ie_padrao_amostra in ('PM','PM11','PMR11','PM13'))) and f.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and g.dt_integracao is null and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, NULL, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and Obter_Equipamento_Exame(a.nr_seq_exame,null,'PROMO') is not null and lab_obter_result_ant_seq(a.nr_prescricao,a.nr_seq_exame,'DH',5) is not null
 
union

/*filhos 5*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',5) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',5) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and     	v.nr_prescricao = x.nr_prescricao
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,5)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,5) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao    =  (select 	max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame)

union

/*anteriores 6*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'DH',6) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'R',6) result_ant,
	CASE WHEN d.cd_exame='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	substr((select replace(y.ds_observacao, chr(13)||chr(10), ' ') ds_observacao
		from exame_lab_result_item y,
		exame_lab_resultado m,
		prescr_procedimento n,
		prescr_medica o
		where y.nr_seq_resultado = m.nr_seq_resultado
		and o.nr_prescricao = m.nr_prescricao
		and n.nr_prescricao = o.nr_prescricao
		and y.nr_seq_exame = n.nr_seq_exame
		and y.nr_seq_prescr = n.nr_sequencia
		and o.nr_prescricao = lab_obter_result_ant_seq(a.nr_prescricao,d.nr_seq_exame,'P',6)  LIMIT 1),1,183) ds_observacao
FROM exame_laboratorio y, prescr_medica v, exame_lab_format_item n, exame_lab_format m, prescr_proc_mat_item g, lab_parametro f, material_exame_lab e, exame_laboratorio d, pessoa_fisica c, prescr_procedimento a, prescr_medica b
LEFT OUTER JOIN exame_lab_resultado x ON (b.nr_prescricao = x.nr_prescricao)
WHERE a.nr_prescricao = b.nr_prescricao and b.cd_pessoa_fisica = c.cd_pessoa_fisica and f.cd_estabelecimento = b.cd_estabelecimento and a.nr_seq_exame = d.nr_seq_exame and v.nr_prescricao = x.nr_prescricao and n.nr_seq_exame = y.nr_seq_exame and a.nr_prescricao = g.nr_prescricao and a.nr_sequencia = g.nr_seq_prescr and y.nr_seq_superior is not null  and v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) and obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) is not null and f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13') and a.cd_material_exame = e.cd_material_exame and m.ie_padrao = 'S' and m.ie_mapa_laudo = 'L' and n.nr_seq_formato = m.nr_seq_formato and m.nr_seq_exame = d.nr_seq_exame and g.dt_integracao is null and y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG') and length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0 and obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null and m.dt_atualizacao     = (select max(dt_atualizacao)
				from   exame_lab_format
				where  ie_padrao = 'S'
				and    ie_mapa_laudo = 'L'
				and    nr_seq_exame = d.nr_seq_exame)
 
union

/*filhos 6*/

select  	distinct
	13 cd_tipo_registro,
	lab_obter_caracteres_amostra(g.cd_barras,f.ie_padrao_amostra) ds_amostra,
	'' ie_reservado,
	'' ie_repeticao,
	'' qt_diluicao,
	'' cd_agrupamento,
	'' ie_reservado2,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'DH',6) ds_coleta,
	null dt_coleta,
	'' ie_prioridade,
	'' cd_material,
	'' cd_instrumento,
	a.nr_prescricao,
	0 ie_origem,
	d.cd_exame ds_exames,
	c.nm_pessoa_fisica nm_paciente,
	obter_idade(c.dt_nascimento, b.dt_prescricao, 'A') dt_idade,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_seq_cor_pele ie_cor,
    c.cd_pessoa_fisica,
	'' cd_atributo,
	'' ds_valor,
	'13' ie_digito,
	'',
	b.cd_setor_atendimento cd_setor_prescr,
	lab_obter_result_ant_seq(a.nr_prescricao,n.nr_seq_exame,'R',6) result_ant,
	CASE WHEN coalesce(obter_equipamento_exame_integr(d.nr_seq_exame,'PROMO'),d.cd_exame)='HEM' THEN CASE WHEN obter_desc_exame(n.nr_seq_exame)='Hematócrito' THEN 'Hematocrit' WHEN obter_desc_exame(n.nr_seq_exame)='Contagem de Plaquetas' THEN 'Plaquetas' WHEN obter_desc_exame(n.nr_seq_exame)='Hemoglobinas' THEN 'Hemoglobin' WHEN obter_desc_exame(n.nr_seq_exame)='Leucócitos' THEN 'Leucocitos' WHEN obter_desc_exame(n.nr_seq_exame)='Eritrocitos' THEN 'Hemacias'  ELSE elimina_acentos(obter_desc_exame(n.nr_seq_exame)) END   ELSE '' END  ds_exame_filho,
	'' ds_observacao
from    	material_exame_lab e,
	lab_parametro f,
	exame_laboratorio d,
	exame_laboratorio y,
	pessoa_fisica c,
	prescr_medica b,
	prescr_medica v,
	exame_lab_resultado x,
	prescr_procedimento a,
	prescr_proc_mat_item g,
	exame_lab_format_item n,
	exame_lab_format m
where   	a.nr_prescricao = b.nr_prescricao
and     	b.cd_pessoa_fisica = c.cd_pessoa_fisica
and     	f.cd_estabelecimento = b.cd_estabelecimento
and     	a.nr_seq_exame = d.nr_seq_exame
and 	   	v.nr_prescricao = x.nr_prescricao
and			a.nr_prescricao = g.nr_prescricao
and 		a.nr_sequencia = g.nr_seq_prescr
and     	n.nr_seq_exame = y.nr_seq_exame
and     	y.nr_seq_superior is not null
and     	v.nr_prescricao = obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6)
and     	obter_prescr_anterior_seq(b.nr_prescricao, b.cd_pessoa_fisica,a.nr_seq_exame,6) IS NOT NULL
and 		f.ie_padrao_amostra IN ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
and     	a.cd_material_exame = e.cd_material_exame
and     	g.dt_integracao is null
and     	((y.cd_exame in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')) or (obter_equipamento_exame_integr(y.nr_seq_exame,'PROMO') in ('LLEUCO','EERI','HPLA','HEMAT','HEMOG')))
and     	length(substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, d.nr_seq_grupo, null, 'CI8;' || f.ie_status_envio, '', 0), 1, 160)) > 0
and     	obter_equipamento_exame(n.nr_seq_exame,null,'PROMO') is not null
and     	m.ie_padrao = 'S'
and     	m.ie_mapa_laudo = 'L'
and     	n.nr_seq_formato = m.nr_seq_formato
and     	m.nr_seq_exame = d.nr_seq_exame
and     	m.dt_atualizacao    =  (select 	max(dt_atualizacao)
				from   	exame_lab_format
				where  	ie_padrao = 'S'
				and     ie_mapa_laudo = 'L'
				and     nr_seq_exame = d.nr_seq_exame);

