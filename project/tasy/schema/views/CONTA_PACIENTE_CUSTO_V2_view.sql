-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_custo_v2 (ie_proc_mat, cd_setor_atendimento, cd_conta_contabil, ds_tipo_item, ds_item, ds_convenio, ds_setor_atendimento, ds_conta_contabil, qt_resumo, cd_unidade_medida, ie_apuracao_custo, vl_preco_medio, vl_item, vl_original, vl_result_pacote, vl_imposto, vl_medico, vl_custo_medio, vl_resultado, cd_item, vl_custo, dt_mesano_referencia, nr_interno_conta, nr_atendimento, nr_seq_proc_pacote, nr_seq_protocolo, cd_medico_resp, ds_observacao) AS select 'M' ie_proc_mat,
	a.cd_setor_atendimento, 
	a.cd_conta_contabil, 
	substr(t.ds_tipo_material,1,40) ds_tipo_item, 
	substr(m.ds_material,1,80) ds_item, 
	substr(obter_nome_convenio(b.cd_convenio_parametro),1,40) ds_convenio, 
	substr(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor_atendimento, 
	substr(obter_desc_conta_contabil(a.cd_conta_contabil),1,255) ds_conta_contabil, 
	sum(a.qt_resumo) qt_resumo, 
	a.cd_unidade_medida, 
	'' ie_apuracao_custo, 
	CASE WHEN sum(a.qt_resumo)=0 THEN 0  ELSE (sum(a.vl_material) / sum(a.qt_resumo)) END  vl_preco_medio, 
	sum(a.vl_material) vl_item, 
	sum(coalesce(a.vl_original,0)) vl_original, 
	(sum(a.vl_material) - sum(coalesce(a.vl_original,0))) vl_result_pacote, 
	sum(coalesce(a.vl_imposto,0)) vl_imposto, 
	sum(coalesce(a.vl_medico,0)) vl_medico, 
	CASE WHEN sum(a.qt_resumo)=0 THEN 0  ELSE (sum(a.vl_custo) / sum(a.qt_resumo)) END  vl_custo_medio, 
	sum(a.vl_material) - sum(coalesce(a.vl_medico,0)) - sum(a.vl_custo) - sum(coalesce(a.vl_imposto,0)) vl_resultado, 
	a.cd_material cd_item, 
	sum(vl_custo) vl_custo, 
	b.dt_mesano_referencia, 
	b.nr_interno_conta, 
	b.nr_atendimento, 
	a.nr_seq_proc_pacote, 
	b.nr_seq_protocolo, 
	Obter_medico_resp_atend(b.nr_atendimento, 'C') cd_medico_resp, 
	'' ds_observacao 
FROM 	tipo_material_v t, 
	material m, 
	conta_paciente_resumo a, 
	conta_paciente b 
where 	a.cd_material 		= m.cd_material 
and 	m.ie_tipo_material		= t.cd_tipo_material 
and 	a.nr_interno_conta 		= b.nr_interno_conta 
group by 'M', 
	a.cd_setor_atendimento, 
	a.cd_conta_contabil, 
	t.ds_tipo_material, 
	m.ds_material, 
	obter_nome_setor(a.cd_setor_atendimento), 
	obter_nome_convenio(b.cd_convenio_parametro), 
	obter_desc_conta_contabil(a.cd_conta_contabil), 
	a.cd_unidade_medida, 
	a.cd_material, 
	b.dt_mesano_referencia, 
	b.nr_interno_conta, 
	b.nr_atendimento, 
	b.nr_seq_protocolo, 
	Obter_medico_resp_atend(b.nr_atendimento, 'C'), 
	a.nr_seq_proc_pacote 

union
 
select 'P' ie_proc_mat, 
	a.cd_setor_atendimento, 
	a.cd_conta_contabil, 
	substr(t.ds_classif_proc,1,40) ds_tipo_item, 
	substr(m.ds_procedimento,1,80) ds_item, 
	substr(obter_nome_convenio(b.cd_convenio_parametro),1,40) ds_convenio, 
	substr(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor_atendimento, 
	substr(obter_desc_conta_contabil(a.cd_conta_contabil),1,255) ds_conta_contabil, 
	sum(a.qt_resumo) qt_resumo, 
	' ' cd_unidade_medida , 
	m.ie_apuracao_custo, 
	CASE WHEN sum(a.qt_resumo)=0 THEN 0  ELSE (sum(a.vl_procedimento) / sum(a.qt_resumo)) END  vl_preco_medio, 
	sum(a.vl_procedimento) vl_item, 
	sum(coalesce(a.vl_original,0)) vl_original, 
	(sum(a.vl_material) - sum(coalesce(a.vl_original,0))) vl_result_pacote, 
	sum(coalesce(a.vl_imposto,0)) vl_imposto, 
	sum(coalesce(a.vl_medico,0)) vl_medico, 
	CASE WHEN sum(a.qt_resumo)=0 THEN 0  ELSE (sum(a.vl_custo) / sum(a.qt_resumo)) END  vl_custo_medio, 
	sum(a.vl_procedimento) - sum(coalesce(a.vl_medico,0)) - sum(a.vl_custo) - sum(coalesce(a.vl_imposto,0)) vl_resultado, 
	a.cd_procedimento cd_item, 
	sum(a.vl_custo) vl_custo, 
	b.dt_mesano_referencia, 
	b.nr_interno_conta, 
	b.nr_atendimento, 
	a.nr_seq_proc_pacote, 
	b.nr_seq_protocolo, 
	Obter_medico_resp_atend(b.nr_atendimento, 'C') cd_medico_resp, 
	CASE WHEN m.ie_apuracao_custo='N' THEN  'Não Calcula Custo' WHEN m.ie_apuracao_custo='X' THEN  obter_tempo_cirurgia(a.nr_cirugia) || ' Min' WHEN m.ie_apuracao_custo='T' THEN  obter_tempo_cirurgia(a.nr_cirugia) || ' Min'  ELSE m.ie_apuracao_custo END  ds_observacao 
from 	classif_proc_v t, 
	procedimento m, 
	conta_paciente_resumo a, 
	conta_paciente b 
where 	a.cd_procedimento 		= m.cd_procedimento 
and 	a.ie_origem_proced 	= m.ie_origem_proced 
and 	m.ie_classificacao 		= t.cd_classif_proc 
and 	a.nr_interno_conta 		= b.nr_interno_conta 
group by 'P', 
	a.cd_setor_atendimento, 
	a.cd_conta_contabil, 
	 t.ds_classif_proc, 
	m.ds_procedimento, 
	obter_nome_setor(a.cd_setor_atendimento), 
	obter_nome_convenio(b.cd_convenio_parametro), 
	obter_desc_conta_contabil(a.cd_conta_contabil), 
	m.ie_apuracao_custo, 
	a.cd_material, 
	a.cd_procedimento, 
	b.dt_mesano_referencia, 
	b.nr_interno_conta, 
	b.nr_atendimento, 
	a.nr_seq_proc_pacote, 
	b.nr_seq_protocolo, 
	Obter_medico_resp_atend(b.nr_atendimento, 'C'), 
	CASE WHEN m.ie_apuracao_custo='N' THEN  'Não Calcula Custo' WHEN m.ie_apuracao_custo='X' THEN  obter_tempo_cirurgia(a.nr_cirugia) || ' Min' WHEN m.ie_apuracao_custo='T' THEN  obter_tempo_cirurgia(a.nr_cirugia) || ' Min'  ELSE m.ie_apuracao_custo END  
order by 7,4,6,5;

