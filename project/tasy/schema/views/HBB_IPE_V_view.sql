-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hbb_ipe_v (tp_registro, nr_seq_protocolo, nm_sistema, cd_cgc_hospital, qt_total_conta, qt_total_lancamento, cd_interno, nm_hospital, ds_espaco, ie_zeros, tp_nota, nr_folha, cd_usuario_convenio, cd_cid, cd_prestador, tp_prestador, cd_motivo_cobranca, dt_entrada, dt_alta, nr_guia, nr_interno_conta, vl_total_conta, nr_folha_ini_despesa, nr_folha_fim_despesa, vl_total_despesa, nr_folha_ini_servico, nr_folha_fim_servico, vl_total_servico, vl_total_honorario, nr_linha, dt_item, cd_item_convenio, qt_dias_executado, qt_ocorrencia_dia, cd_funcao_executor, ie_via_acesso, ie_urgencia, vl_honorario, vl_total_item, vl_total_matmed, cd_brasindice, cd_unidade_medida) AS Select
	1				tp_registro,
	a.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	a.cd_cgc_hospital		cd_cgc_hospital,
	b.qt_total_conta		qt_total_conta,
	count(*)			qt_total_lancamento,
	('3' || lpad(coalesce(a.cd_interno,0),6,'0'))::numeric 	cd_interno,
	substr(a.nm_hospital,1,45)	nm_hospital,
	' '				ds_espaco,
	0				ie_zeros,
	0				tp_nota,
	0				nr_folha,
	' '				cd_usuario_convenio,
	' '				cd_cid,
	''				cd_prestador,
	3				tp_prestador,
	0				cd_motivo_cobranca,
	LOCALTIMESTAMP				dt_entrada,
	LOCALTIMESTAMP				dt_alta,
	' '				nr_guia,
	0				nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0				vl_total_honorario,
	0				nr_linha,
	LOCALTIMESTAMP				dt_item,
	0				cd_item_convenio,
	0				qt_dias_executado,
	0				qt_ocorrencia_dia,
	0				cd_funcao_executor,
	0				ie_via_acesso,
	0				ie_urgencia,
	0				vl_honorario,
	0				vl_total_item,
	0				vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
FROM	w_interf_conta_item_ipe c,
	w_interf_conta_trailler b,
	w_interf_conta_header a
where	a.nr_seq_protocolo		= b.nr_seq_protocolo
and	a.nr_seq_protocolo		= c.nr_seq_protocolo
and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'
group by
	a.nr_seq_protocolo,
	a.cd_cgc_hospital,
	b.qt_total_conta,
	('3' || lpad(coalesce(a.cd_interno,0),6,'0'))::numeric ,
	substr(a.nm_hospital,1,45)

union all

select
	2				tp_registro,
	a.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	''		cd_cgc_hospital,
	0				qt_total_conta,
	max(CASE WHEN c.tp_nota=75 THEN c.nr_linha WHEN c.tp_nota=85 THEN c.nr_linha END ) qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 75 WHEN a.ie_tipo_atendimento=8 THEN 85  ELSE 0 END
					tp_nota,
	0				nr_folha,
	substr(a.cd_usuario_convenio,1,13)
					cd_usuario_convenio,
	substr(a.cd_cid_principal,1,6)	cd_cid,
	a.cd_interno			cd_prestador,
	3				tp_prestador,
	CASE WHEN a.ie_tipo_atendimento=1 THEN CASE WHEN a.cd_motivo_alta=11 THEN 3 WHEN a.cd_motivo_alta=6 THEN 2 WHEN a.cd_motivo_alta=7 THEN 2  ELSE 1 END   ELSE 0 END 
					cd_motivo_cobranca,
	a.dt_entrada			dt_entrada,
	a.dt_alta			dt_alta,
	substr(a.nr_doc_convenio,1,6)	nr_guia,
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
		(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric )
					nr_interno_conta,
	(sum(CASE WHEN c.tp_nota=76 THEN CASE WHEN c.ie_tipo_item=1 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END  WHEN c.tp_nota=86 THEN CASE WHEN c.ie_tipo_item=1 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END   ELSE 0 END ) +
	sum(CASE WHEN c.tp_nota=77 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.vl_honorario  ELSE c.vl_total_item END  WHEN c.tp_nota=87 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.vl_honorario  ELSE c.vl_total_item END   ELSE 0 END ) +
	sum(CASE WHEN c.tp_nota=75 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END  WHEN c.tp_nota=85 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE 0 END )) vl_total_conta,
	min(CASE WHEN c.tp_nota=76 THEN c.nr_folha WHEN c.tp_nota=86 THEN c.nr_folha END )	nr_folha_ini_despesa,
	max(CASE WHEN c.tp_nota=76 THEN c.nr_folha WHEN c.tp_nota=86 THEN c.nr_folha END )	nr_folha_fim_despesa,
	sum(CASE WHEN c.tp_nota=76 THEN CASE WHEN c.ie_tipo_item=1 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END  WHEN c.tp_nota=86 THEN CASE WHEN c.ie_tipo_item=1 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END   ELSE 0 END ) vl_total_despesa,
	min(CASE WHEN c.tp_nota=77 THEN c.nr_folha WHEN c.tp_nota=87 THEN c.nr_folha END )	nr_folha_ini_servico,
	max(CASE WHEN c.tp_nota=77 THEN c.nr_folha WHEN c.tp_nota=87 THEN c.nr_folha END )	nr_folha_fim_servico,
	sum(CASE WHEN c.tp_nota=77 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.vl_honorario  ELSE c.vl_total_item END   WHEN c.tp_nota=87 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.vl_honorario  ELSE c.vl_total_item END   ELSE 0 END ) vl_total_servico,
	sum(CASE WHEN c.tp_nota=75 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END  WHEN c.tp_nota=85 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE 0 END ) vl_total_honorario,
	0				nr_linha,
	LOCALTIMESTAMP				dt_item,
	0				cd_item_convenio,
	0				qt_dias_executado,
	0				qt_ocorrencia_dia,
	0				cd_funcao_executor,
	0				ie_via_acesso,
	0				ie_urgencia,
	0				vl_honorario,
	0				vl_total_item,
	0				vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_total b,
	w_interf_conta_cab a
where	a.nr_interno_conta		= b.nr_interno_conta
  and	a.nr_interno_conta		= c.nr_interno_conta
  and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'
group by
	a.nr_seq_protocolo,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 75 WHEN a.ie_tipo_atendimento=8 THEN 85  ELSE 0 END , a.cd_interno,
	substr(a.cd_usuario_convenio,1,13),
	substr(a.cd_cid_principal,1,6),
	CASE WHEN a.ie_tipo_atendimento=1 THEN CASE WHEN a.cd_motivo_alta=11 THEN 3 WHEN a.cd_motivo_alta=6 THEN 2 WHEN a.cd_motivo_alta=7 THEN 2  ELSE 1 END   ELSE 0 END ,
	a.dt_entrada,
	a.dt_alta,
	substr(a.nr_doc_convenio,1,6),
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
		(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric )

union all

select
	3				tp_registro,
	c.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	a.cd_cgc_hospital		cd_cgc_hospital,
	0				qt_total_conta,
	0 				qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	c.tp_nota			tp_nota,
	0				nr_folha,
	' '				cd_usuario_convenio,
	' '				cd_cid,
	CASE WHEN obter_se_medico_conveniado(Obter_estab_atend(c.nr_atendimento),c.cd_medico_executor,	c.cd_convenio, null, null,null,null,null,null, null, null)='S' THEN 		c.NR_CPF_EXECUTOR  ELSE c.cd_cgc_prestador END  cd_prestador,
	3				tp_prestador,
	0 				cd_motivo_cobranca,
	LOCALTIMESTAMP				dt_entrada,
	LOCALTIMESTAMP				dt_alta,
	' '				nr_guia,
	coalesce((substr(lpad(c.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
		(substr(lpad(c.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0 				vl_total_honorario,
	c.nr_linha			nr_linha,
	c.dt_item			dt_item,
	c.cd_item_convenio	cd_item_convenio,
	c.qt_item			qt_dias_executado,
	1				qt_ocorrencia_dia,
	c.cd_funcao_executor	cd_funcao_executor,
	c.ie_via_acesso			ie_via_acesso,
	c.ie_urgencia			ie_urgencia,
	CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END 
					vl_honorario,
	c.vl_total_item			vl_total_item,
	0				vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_cab a
where	c.tp_nota	in (75,85)
  and	a.nr_interno_conta		= c.nr_interno_conta
  and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'

union all

select
	4				tp_registro,
	a.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	a.cd_cgc_hospital		cd_cgc_hospital,
	0				qt_total_conta,
	max(CASE WHEN c.tp_nota=76 THEN c.nr_linha WHEN c.tp_nota=86 THEN c.nr_linha END ) qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 76 WHEN a.ie_tipo_atendimento=8 THEN 86  ELSE 0 END 
					tp_nota,
	c.nr_folha			nr_folha,
	substr(a.cd_usuario_convenio,1,13)
					cd_usuario_convenio,
	substr(a.cd_cid_principal,1,6)	cd_cid,
	a.cd_interno		cd_prestador,
	3				tp_prestador,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE 0 END 
					cd_motivo_cobranca,
	a.dt_entrada			dt_entrada,
	a.dt_alta			dt_alta,
	substr(a.nr_doc_convenio,1,6)	nr_guia,
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
 		(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0				vl_total_honorario,
	0				nr_linha,
	LOCALTIMESTAMP				dt_item,
	0				cd_item_convenio,
	0				qt_dias_executado,
	0				qt_ocorrencia_dia,
	0				cd_funcao_executor,
	0				ie_via_acesso,
	0				ie_urgencia,
	0				vl_honorario,
	sum(CASE WHEN c.ie_tipo_item=1 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END ),
	sum(CASE WHEN c.ie_responsavel_credito='MEDIC' THEN c.vl_total_item  ELSE 0 END )
					vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_total b,
	w_interf_conta_cab a
where	a.nr_interno_conta		= b.nr_interno_conta
and	a.nr_interno_conta		= c.nr_interno_conta
and	c.tp_nota			in (76,86)
and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'
group by
	a.nr_seq_protocolo,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 76 WHEN a.ie_tipo_atendimento=8 THEN 86  ELSE 0 END ,
	c.nr_folha, a.cd_cgc_hospital		,
	substr(a.cd_usuario_convenio,1,13),
	substr(a.cd_cid_principal,1,6),
	a.cd_interno,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE 0 END ,
	a.dt_entrada,
	a.dt_alta,
	substr(a.nr_doc_convenio,1,6),
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric )

union all

select
	5				tp_registro,
	c.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	' '				cd_cgc_hospital,
	0				qt_total_conta,
	0 				qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	c.tp_nota			tp_nota,
	c.nr_folha			nr_folha,
	' '				cd_usuario_convenio,
	' '				cd_cid,
	CASE WHEN obter_se_medico_conveniado(Obter_estab_atend(c.nr_atendimento),c.cd_medico_executor,	c.cd_convenio, null, null,null,null,null,null, null, null)='S' THEN 		c.NR_CPF_EXECUTOR  ELSE c.cd_cgc_prestador END 	cd_prestador,
	3				tp_prestador,
	0 				cd_motivo_cobranca,
	LOCALTIMESTAMP				dt_entrada,
	LOCALTIMESTAMP				dt_alta,
	' '				nr_guia,
	coalesce((substr(lpad(c.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(c.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0 				vl_total_honorario,
	c.nr_linha			nr_linha,
	c.dt_item			dt_item,
	CASE WHEN c.cd_brasindice IS NULL THEN  c.cd_item_convenio  ELSE CASE WHEN to_char(c.cd_item_convenio)=to_char(c.cd_item) THEN  701  ELSE c.cd_item_convenio END  END  cd_item_convenio,
	CASE WHEN c.ie_tipo_item=1 THEN c.qt_item WHEN c.ie_tipo_item=3 THEN c.qt_item  ELSE 1 END 
					qt_dias_executado,
	CASE WHEN c.cd_item_convenio=8001 THEN 1  ELSE CASE WHEN c.ie_tipo_item=1 THEN 1 WHEN c.ie_tipo_item=3 THEN 1  ELSE c.qt_item END  END 
					qt_ocorrencia_dia,
	c.cd_funcao_executor		cd_funcao_executor,
	c.ie_via_acesso			ie_via_acesso,
	c.ie_urgencia			ie_urgencia,
	0				vl_honorario,
	CASE WHEN c.ie_tipo_item=1 THEN CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END  vl_total_item,
	0				vl_total_matmed,
	CASE WHEN to_char(c.cd_item_convenio)=to_char(c.cd_item) THEN  lpad(trim(both c.cd_brasindice),'13','0')  ELSE ' ' END  cd_brasindice,
	CASE WHEN to_char(c.cd_item_convenio)=to_char(c.cd_item) THEN  c.cd_unidade_medida  ELSE ' ' END  cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_cab a
where	c.tp_nota	in (76,86)
and	c.cd_item_convenio	<> '701'
  and	a.nr_interno_conta		= c.nr_interno_conta
  and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'

union all

select
	5				tp_registro,
	c.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	' '				cd_cgc_hospital,
	0				qt_total_conta,
	0 				qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	c.tp_nota			tp_nota,
	c.nr_folha			nr_folha,
	' '				cd_usuario_convenio,
	' '				cd_cid,
	CASE WHEN obter_se_medico_conveniado(Obter_estab_atend(c.nr_atendimento),c.cd_medico_executor,	c.cd_convenio, null, null,null,null,null,null, null, null)='S' THEN 		c.NR_CPF_EXECUTOR  ELSE c.cd_cgc_prestador END  cd_prestador,
	3				tp_prestador,
	0 				cd_motivo_cobranca,
	LOCALTIMESTAMP				dt_entrada,
	LOCALTIMESTAMP				dt_alta,
	' '				nr_guia,
	coalesce((substr(lpad(c.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(c.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0 				vl_total_honorario,
	c.nr_linha			nr_linha,
	c.dt_item			dt_item,
	c.cd_item_convenio		cd_item_convenio,
	CASE WHEN c.ie_tipo_item=1 THEN c.qt_item WHEN c.ie_tipo_item=3 THEN c.qt_item  ELSE 1 END 
					qt_dias_executado,
	CASE WHEN c.cd_item_convenio=8001 THEN 1  ELSE CASE WHEN c.ie_tipo_item=1 THEN 1 WHEN c.ie_tipo_item=3 THEN 1  ELSE c.qt_item END  END 
					qt_ocorrencia_dia,
	c.cd_funcao_executor		cd_funcao_executor,
	c.ie_via_acesso			ie_via_acesso,
	c.ie_urgencia			ie_urgencia,
	0				vl_honorario,
	CASE WHEN c.ie_tipo_item=1 THEN  CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario WHEN c.ie_responsavel_credito='RM' THEN c.vl_honorario  ELSE CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END  END   ELSE CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.qt_item * c.vl_unitario_item WHEN c.ie_responsavel_credito='M' THEN  c.qt_item * c.vl_unitario_item  ELSE c.vl_total_item END  END  vl_total_item,
	0				vl_total_matmed,
	CASE WHEN c.cd_item_convenio='701' THEN CASE WHEN substr(c.cd_brasindice,1,13) IS NULL THEN ' '  ELSE lpad(trim(both c.cd_brasindice),'13','0') END   ELSE ' ' END  cd_brasindice,
	CASE WHEN c.cd_item_convenio='701' THEN c.cd_unidade_medida  ELSE ' ' END  cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_cab a
where	c.tp_nota	in (76,86)
and	c.cd_item_convenio	= '701'
  and	a.nr_interno_conta		= c.nr_interno_conta
  and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'

union all

select
	6				tp_registro,
	a.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	' '				cd_cgc_hospital,
	0				qt_total_conta,
	max(CASE WHEN c.tp_nota=77 THEN c.nr_linha WHEN c.tp_nota=87 THEN c.nr_linha END ) qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 77 WHEN a.ie_tipo_atendimento=8 THEN 87  ELSE 0 END 
					tp_nota,
	c.nr_folha			nr_folha,
	substr(a.cd_usuario_convenio,1,13)
					cd_usuario_convenio,
	substr(a.cd_cid_principal,1,6)	cd_cid,
	a.cd_interno		cd_prestador,
	3				tp_prestador,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE 0 END 
					cd_motivo_cobranca,
	a.dt_entrada			dt_entrada,
	a.dt_alta			dt_alta,
	substr(a.nr_doc_convenio,1,6)	nr_guia,
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0				vl_total_honorario,
	0				nr_linha,
	LOCALTIMESTAMP				dt_item,
	0				cd_item_convenio,
	0				qt_dias_executado,
	0				qt_ocorrencia_dia,
	0				cd_funcao_executor,
	0				ie_via_acesso,
	0				ie_urgencia,
	0				vl_honorario,
	sum(CASE WHEN c.ie_responsavel_credito='M IPE' THEN c.vl_honorario  ELSE c.vl_total_item END ) vl_total_item,
	sum(CASE WHEN c.cd_item_convenio=8001 THEN c.vl_total_item WHEN c.cd_item_convenio=32200005 THEN c.vl_total_item  ELSE 0 END )
					vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_total b,
	w_interf_conta_cab a
where	a.nr_interno_conta		= b.nr_interno_conta
and	a.nr_interno_conta		= c.nr_interno_conta
and	c.tp_nota			in (77,87)
and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N'
group by
	a.nr_seq_protocolo,
	CASE WHEN a.ie_tipo_atendimento=1 THEN 77 WHEN a.ie_tipo_atendimento=8 THEN 87  ELSE 0 END ,
	c.nr_folha,
	substr(a.cd_usuario_convenio,1,13),
	substr(a.cd_cid_principal,1,6),
	a.cd_interno,
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE 0 END ,
	a.dt_entrada,
	a.dt_alta,
	substr(a.nr_doc_convenio,1,6),
	coalesce((substr(lpad(a.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(a.nr_interno_conta,10,'0'),6,5))::numeric )

union all

select
	7				tp_registro,
	c.nr_seq_protocolo		nr_seq_protocolo,
	'SMH'				nm_sistema,
	' '				cd_cgc_hospital,
	0				qt_total_conta,
	0 				qt_total_lancamento,
	0				cd_interno,
	' '				nm_hospital,
	' '				ds_espaco,
	0 				ie_zeros,
	c.tp_nota			tp_nota,
	c.nr_folha			nr_folha,
	' '				cd_usuario_convenio,
	' '				cd_cid,
	CASE WHEN obter_se_medico_conveniado(Obter_estab_atend(c.nr_atendimento),c.cd_medico_executor	,c.cd_convenio, null, null,null,null,null,null, null, null)='S' THEN 		c.NR_CPF_EXECUTOR  ELSE c.cd_cgc_prestador END  cd_prestador,
	3				tp_prestador,
	0 				cd_motivo_cobranca,
	LOCALTIMESTAMP				dt_entrada,
	LOCALTIMESTAMP				dt_alta,
	' '				nr_guia,
	coalesce((substr(lpad(c.nr_seq_conta_convenio,10,'0'),6,5))::numeric ,
	(substr(lpad(c.nr_interno_conta,10,'0'),6,5))::numeric ) nr_interno_conta,
	0				vl_total_conta,
	0				nr_folha_ini_despesa,
	0				nr_folha_fim_despesa,
	0				vl_total_despesa,
	0				nr_folha_ini_servico,
	0				nr_folha_fim_servico,
	0				vl_total_servico,
	0 				vl_total_honorario,
	c.nr_linha			nr_linha,
	c.dt_item			dt_item,
	c.cd_item_convenio		cd_item_convenio,
	1				qt_dias_executado,
	c.qt_item			qt_ocorrencia_dia,
	c.cd_funcao_executor		cd_funcao_executor,
	c.ie_via_acesso			ie_via_acesso,
	c.ie_urgencia			ie_urgencia,
	CASE WHEN c.vl_total_item=0 THEN c.vl_honorario  ELSE c.vl_total_item END 
					vl_honorario,
	CASE WHEN c.ie_responsavel_credito='M IPE' THEN  c.vl_honorario  ELSE c.vl_total_item END  vl_total_item,
	0				vl_total_matmed,
	' '				cd_brasindice,
	' '				cd_unidade_medida
from	w_interf_conta_item_ipe c,
	w_interf_conta_cab a
where	c.tp_nota	in (77,87)
  and	a.nr_interno_conta		= c.nr_interno_conta
  and 	obter_se_conta_cancelada(c.nr_interno_conta) = 'N';

