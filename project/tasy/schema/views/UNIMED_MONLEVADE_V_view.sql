-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_monlevade_v (nr_seq_protocolo, cd_convenio, tp_registro, ie_disquete, cd_tipo_registro, cd_federacao, nr_lote, cd_prestador, nr_seq_conta, nm_singular, ie_prestador, cd_cgc_hospital, nm_prestador, dt_remessa, nr_remessa, ds_espaco, nr_registro, nm_paciente, ie_sexo, dt_nascimento, nr_prontuario, cd_plano, cd_usuario, nm_convenio, qt_zeros, ie_tipo_nota, nr_nota, nr_conta_ambulat, tp_conta_origem, nr_conta_origem, cd_natureza, dt_competencia, ie_tipo_paciente, cd_tipo_atendimento, cd_classe_atend, cd_tipo_acomodacao, dt_entrada, hr_entrada, dt_saida, hr_saida, cd_motivo_alta, cd_cid, nr_crm, ds_uf_crm, nm_medico_resp, nr_crm_req, ds_uf_req, nm_medico_req, cd_medico_req, dt_req_assinada, cd_tipo_nasc, qt_eventos_nasc, qt_eventos_obito, nr_seq_autorizacao, cd_proc_autorizado, ds_proc_autorizado, cd_acomod_autorizado, qt_proc_autorizado, nr_guia, dt_guia, ds_senha, nm_autorizador, nr_seq_item_conta, cd_prest_exec, dt_procedimento, hr_procedimento, cd_funcao_executor, nr_porte_anestesico, ds_item, nr_crm_req_exa, nr_guia_exame, cd_prest_cobranca, cd_item, cd_unidade_medida, qt_item, qt_ch, vl_ch, vl_unitario, vl_total_item, ds_local_uso, cd_proc_referencia, cd_via_acesso, ie_tipo_item, qt_diarias_normais, qt_diarias_uti, qt_participantes, vl_honorarios, vl_diarias_normais, vl_diarias_uti, vl_tot_servicos, vl_tot_medicamentos, vl_tot_materiais, vl_sadt, vl_filmes, vl_tot_conta, nr_fatura, qt_conta_lote, vl_total_lote, qt_conta_remessa, vl_total_remessa, nr_interno_conta) AS select
/* 	header remessa		*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	0 tp_registro, 
	'FATOU' ie_disquete, 
	0 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	substr(a.nm_convenio,1,40) nm_singular, 
	'J' ie_prestador, 
	a.cd_cgc_hospital cd_cgc_hospital, 
	substr(a.nm_hospital,1,40) nm_prestador, 
	a.dt_remessa dt_remessa, 
	a.nr_remessa nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	0 nr_interno_conta 
FROM	w_interf_conta_header a 

union all
 
select 
/* 	cabeçalho da conta 1		*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	1 tp_registro, 
	'FATOU' ie_disquete, 
	1 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	substr(b.nm_paciente,1,40) nm_paciente, 
	b.ie_sexo, 
	b.dt_nascimento, 
	somente_numero(substr(b.nr_prontuario,1,7)) nr_prontuario, 
	substr(b.cd_categoria_convenio,1,2) cd_plano, 
	substr(b.cd_usuario_convenio,1,16) cd_usuario, 
	substr(c.ds_convenio,1,35) nm_convenio, 
	0 qt_zeros, 
	b.ie_tipo_atendimento ie_tipo_nota, 
	b.nr_interno_conta nr_nota, 
	0 nr_conta_ambulat, 
	' ' tp_conta_origem, 
	0 nr_conta_origem, 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	b.nr_interno_conta nr_interno_conta 
from	convenio c, 
	w_interf_conta_header a, 
	w_interf_conta_cab b 
where	a.nr_seq_protocolo 	= b.nr_seq_protocolo 
and	b.cd_convenio		= c.cd_convenio 

union all
 
select 
/* 	cabeçalho da conta 2		*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	2 tp_registro, 
	'FATOU' ie_disquete, 
	2 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	c.dt_mesano_referencia dt_competencia, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN 'I'  ELSE 'E' END  ie_tipo_paciente, 
	ie_clinica cd_tipo_atendimento, 
	substr(ie_carater_inter,1,1) cd_classe_atend, 
	substr(cd_tipo_acomodacao,1,1) cd_tipo_acomodacao, 
	b.dt_entrada dt_entrada, 
	b.dt_entrada hr_entrada, 
	b.dt_alta dt_saida, 
	b.dt_alta hr_saida, 
	coalesce(to_char(b.cd_motivo_alta),' ') cd_motivo_alta, 
	coalesce(substr(b.cd_cid_principal,1,6),'   ') cd_cid, 
	somente_numero(coalesce(b.nr_crm_medico_resp,'0')) nr_crm, 
	coalesce(b.uf_crm_medico_resp,' ') ds_uf_crm, 
	substr(b.nm_medico_resp,1,40) nm_medico_resp, 
	somente_numero(coalesce(b.nr_crm_medico_resp,'0')) nr_crm_req, 
	coalesce(b.uf_crm_medico_resp,' ') ds_uf_req, 
	substr(b.nm_medico_resp,1,40) nm_medico_req, 
	substr(b.cd_conv_medico_resp,1,12) cd_medico_req, 
	b.dt_entrada dt_req_assinada, 
	coalesce(somente_numero(b.ie_tipo_nascimento),0) cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	b.nr_interno_conta nr_interno_conta 
from	protocolo_convenio c, 
	w_interf_conta_header a, 
	w_interf_conta_cab b 
where	a.nr_seq_protocolo	= c.nr_seq_protocolo 
and	a.nr_seq_protocolo	= b.nr_seq_protocolo 

union all
 
select 
/* 	autorizações 		*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	3 tp_registro, 
	'FATOU' ie_disquete, 
	3 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	coalesce(substr(b.cd_autorizacao,1,15),' ') nr_guia, 
	b.dt_autorizacao dt_guia, 
	substr(b.cd_senha,1,10) ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	b.nr_interno_conta nr_interno_conta 
from	w_interf_conta_header a, 
	w_interf_conta_autor b 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 

union all
 
select 
/* 	ítem da conta Proc medico */
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	4 tp_registro, 
	'FATOU' ie_disquete, 
	4 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	substr(a.cd_interno,1,12) cd_prest_exec, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  dt_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) nr_porte_anestesico, 
	substr(b.ds_item,1,75) ds_item, 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0) nr_crm_req_exa, 
	coalesce(somente_numero(b.nr_doc_convenio),0) nr_guia_exame, 
	' ' cd_prest_cobranca, 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0) cd_item, 
	substr(b.cd_unidade_medida,1,3) cd_unidade_medida, 
	SUM(b.qt_item) qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	CASE WHEN sum(b.qt_item)=0 THEN 0  ELSE (sum(coalesce(b.vl_honorario,0) 		+ coalesce(b.vl_custo_oper,0)) / sum(b.qt_item)) END  vl_unitario, 
	sum(coalesce(b.vl_honorario,0) + coalesce(b.vl_custo_oper,0)) vl_total_item, 
	' ' ds_local_uso, 
	coalesce(b.cd_procedimento_ref,0) cd_proc_referencia, 
	coalesce(b.ie_via_acesso_inf,'0') cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	c.nr_interno_conta nr_interno_conta 
FROM w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo and b.nr_seq_protocolo	= c.nr_seq_protocolo and b.nr_interno_conta	= c.nr_interno_conta and coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  and coalesce(z.ie_entra_conta,'S') = 'S' and b.ie_tipo_item		= 1 and b.qt_item			<> 0 and b.cd_item in (select x.cd_procedimento 
		from estrutura_procedimento_v x 
		where x.cd_area_procedimento in (1,4,11,13)) group by 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12), 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
	coalesce(b.nr_porte_anestesico,0), 
	substr(b.ds_item,1,75), 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0), 
	coalesce(somente_numero(b.nr_doc_convenio),0), 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
	substr(b.cd_unidade_medida,1,3), 
	b.vl_unitario_item, 
	coalesce(b.cd_procedimento_ref,0), 
	coalesce(b.ie_via_acesso_inf,'0'), 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
	c.nr_interno_conta 
having sum(b.qt_item) <> 0 

union all
 
select 
/* 	ítem da conta exames,servicos e matmed */
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	4 tp_registro, 
	'FATOU' ie_disquete, 
	4 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	substr(a.cd_interno,1,12) cd_prest_exec, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  dt_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END  hr_procedimento, 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END  cd_funcao_executor, 
	coalesce(b.nr_porte_anestesico,0) nr_porte_anestesico, 
	substr(b.ds_item,1,75) ds_item, 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0) nr_crm_req_exa, 
	coalesce(somente_numero(b.nr_doc_convenio),0) nr_guia_exame, 
	' ' cd_prest_cobranca, 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0) cd_item, 
	substr(b.cd_unidade_medida,1,3) cd_unidade_medida, 
	SUM(b.qt_item) qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	CASE WHEN sum(b.qt_item)=0 THEN 0  ELSE (sum(b.vl_total_item) / sum(b.qt_item)) END  vl_unitario, 
	sum(b.vl_total_item) vl_total_item, 
	' ' ds_local_uso, 
	coalesce(b.cd_procedimento_ref,0) cd_proc_referencia, 
	coalesce(b.ie_via_acesso_inf,'0') cd_via_acesso, 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END  ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	c.nr_interno_conta nr_interno_conta 
FROM w_interf_conta_cab c, w_interf_conta_header a, w_interf_conta_item b
LEFT OUTER JOIN regra_honorario z ON (b.ie_responsavel_credito = z.cd_regra)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo and b.nr_seq_protocolo	= c.nr_seq_protocolo and b.nr_interno_conta	= c.nr_interno_conta and coalesce(b.nr_seq_proc_pacote,b.nr_seq_item) = b.nr_seq_item  and coalesce(z.ie_entra_conta,'S') = 'S' and b.qt_item			<> 0 and b.cd_item not in (select x.cd_procedimento 
		from estrutura_procedimento_v x 
		where x.cd_area_procedimento in (1,4,11,13)) group by 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	somente_numero(a.cd_regional), 
	substr(a.cd_interno,1,12), 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN c.dt_entrada  ELSE b.dt_item END , 
	CASE WHEN b.ie_tipo_item=2 THEN ' '  ELSE to_char(b.cd_funcao_executor) END , 
	coalesce(b.nr_porte_anestesico,0), 
	substr(b.ds_item,1,75), 
	coalesce(somente_numero(coalesce(b.nr_crm_requisitante,b.nr_crm_executor)),0), 
	coalesce(somente_numero(b.nr_doc_convenio),0), 
	coalesce(somente_numero(coalesce(b.cd_item_convenio,b.cd_item)),0), 
	substr(b.cd_unidade_medida,1,3), 
	b.vl_unitario_item, 
	coalesce(b.cd_procedimento_ref,0), 
	coalesce(b.ie_via_acesso_inf,'0'), 
	CASE WHEN b.cd_tipo_item_interf=1 THEN 1 WHEN b.cd_tipo_item_interf=2 THEN 2 WHEN b.cd_tipo_item_interf=3 THEN 2 WHEN b.cd_tipo_item_interf=4 THEN 4 WHEN b.cd_tipo_item_interf=5 THEN 3  ELSE 0 END , 
	c.nr_interno_conta 
having sum(b.qt_item) <> 0 

union all
 
select 
/* 	total da conta		*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	5 tp_registro, 
	'FATOU' ie_disquete, 
	5 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	substr(a.cd_interno,1,12) cd_prestador, 
	0 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	obter_resumo_diaria(1,1,b.nr_interno_conta)qt_diarias_normais, 
	obter_resumo_diaria(2,1,b.nr_interno_conta)qt_diarias_uti, 
	coalesce(somente_numero(substr(b.qt_participantes,1,1)),0) qt_participantes, 
	0 vl_honorarios, 
	obter_resumo_diaria(1,2,b.nr_interno_conta)vl_diarias_normais, 
	obter_resumo_diaria(2,2,b.nr_interno_conta)vl_diarias_uti, 
	(b.vl_taxas + b.vl_servico) vl_tot_servicos, 
	b.vl_medicamentos vl_tot_medicamentos, 
	b.vl_materiais vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	b.vl_total_conta vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	b.nr_interno_conta nr_interno_conta 
from	w_interf_conta_header a, 
	w_interf_conta_total b 
where	b.nr_seq_protocolo		= a.nr_seq_protocolo 

union all
 
select 
/* 	fim de lote 	*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	6 tp_registro, 
	'FATOU' ie_disquete, 
	6 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	0 nr_lote, 
	'999999999999' cd_prestador, 
	99999 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	to_char(b.nr_seq_protocolo) nr_fatura, 
	b.qt_total_conta qt_conta_lote, 
	b.vl_total_conta vl_total_lote,	 
	0 qt_conta_remessa, 
	0 vl_total_remessa, 
	999999999 nr_interno_conta 
from	w_interf_conta_header a, 
	w_interf_conta_trailler b 
where a.nr_seq_protocolo = b.nr_seq_protocolo 

union all
 
select 
/* 	trailler 	*/
 
	a.nr_seq_protocolo, 
	a.cd_convenio, 
	9 tp_registro, 
	'FATOU' ie_disquete, 
	9 cd_tipo_registro, 
	somente_numero(a.cd_regional) cd_federacao, 
	9999 nr_lote, 
	'999999999999' cd_prestador, 
	99999 nr_seq_conta, 
	' ' nm_singular, 
	' ' ie_prestador, 
	' ' cd_cgc_hospital, 
	' ' nm_prestador, 
	LOCALTIMESTAMP dt_remessa, 
	0 nr_remessa, 
	' ' ds_espaco, 
	0 nr_registro, 
	' ' nm_paciente, 
	' ' ie_sexo, 
	LOCALTIMESTAMP dt_nascimento, 
	0 nr_prontuario, 
	' ' cd_plano, 
	' ' cd_usuario, 
	' ' nm_convenio, 
	0 qt_zeros, 
	0 ie_tipo_nota, 
	0 nr_nota, 
	0 nr_conta_ambulat,	 
	' ' tp_conta_origem, 
	0 nr_conta_origem,	 
	0 cd_natureza,	 
	LOCALTIMESTAMP dt_competencia, 
	' ' ie_tipo_paciente, 
	0 cd_tipo_atendimento, 
	' ' cd_classe_atend, 
	' ' cd_tipo_acomodacao, 
	LOCALTIMESTAMP dt_entrada, 
	LOCALTIMESTAMP hr_entrada, 
	LOCALTIMESTAMP dt_saida, 
	LOCALTIMESTAMP hr_saida, 
	' ' cd_motivo_alta, 
	' ' cd_cid, 
	0 nr_crm, 
	' ' ds_uf_crm, 
	' ' nm_medico_resp, 
	0 nr_crm_req, 
	' ' ds_uf_req, 
	' ' nm_medico_req, 
	' ' cd_medico_req, 
	LOCALTIMESTAMP dt_req_assinada, 
	0 cd_tipo_nasc, 
	0 qt_eventos_nasc, 
	0 qt_eventos_obito, 
	0 nr_seq_autorizacao, 
	0 cd_proc_autorizado, 
	' ' ds_proc_autorizado, 
	' ' cd_acomod_autorizado, 
	0 qt_proc_autorizado, 
	' ' nr_guia, 
	LOCALTIMESTAMP dt_guia, 
	' ' ds_senha, 
	' ' nm_autorizador, 
	0 nr_seq_item_conta, 
	' ' cd_prest_exec, 
	LOCALTIMESTAMP dt_procedimento, 
	LOCALTIMESTAMP hr_procedimento, 
	' ' cd_funcao_executor, 
	0 nr_porte_anestesico, 
	' ' ds_item, 
	0 nr_crm_req_exa, 
	0 nr_guia_exame, 
	' ' cd_prest_cobranca, 
	0 cd_item, 
	' ' cd_unidade_medida, 
	0 qt_item, 
	0 qt_ch, 
	0 vl_ch, 
	0 vl_unitario, 
	0 vl_total_item, 
	' ' ds_local_uso, 
	0 cd_proc_referencia, 
	' ' cd_via_acesso, 
	0 ie_tipo_item, 
	0 qt_diarias_normais, 
	0 qt_diarias_uti, 
	0 qt_participantes, 
	0 vl_honorarios, 
	0 vl_diarias_normais, 
	0 vl_diarias_uti, 
	0 vl_tot_servicos, 
	0 vl_tot_medicamentos, 
	0 vl_tot_materiais, 
	0 vl_sadt, 
	0 vl_filmes, 
	0 vl_tot_conta, 
	' ' nr_fatura, 
	0 qt_conta_lote, 
	0 vl_total_lote,	 
	b.qt_total_conta qt_conta_remessa, 
	b.vl_total_conta vl_total_remessa, 
	9999999999 nr_interno_conta 
from	w_interf_conta_header a, 
	w_interf_conta_trailler b 
where	a.nr_seq_protocolo = b.nr_seq_protocolo;

