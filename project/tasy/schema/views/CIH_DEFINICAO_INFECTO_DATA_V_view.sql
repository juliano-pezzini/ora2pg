-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cih_definicao_infecto_data_v (nr_atendimento, ie_tipo_definicao, nr_prescricao, dt_prescricao, dt_banda, nm_paciente, nm_medico_prescritor, ds_material, ds_indicacao, ds_observacao) AS select distinct
	a.nr_atendimento, 
	'N' ie_tipo_definicao, 
	y.nr_prescricao, 
	y.dt_prescricao, 
	to_date(to_char(y.dt_liberacao,'dd/mm/yyyy'),'dd/mm/yyyy') dt_banda, 
	p.nm_pessoa_fisica nm_paciente, 
	substr(obter_nome_pf(y.cd_medico),1,100) nm_medico_prescritor, 
	substr(z.ds_material,1,100) ds_material, 
	(	select	max(x.ds_valor_dominio) 
		FROM	valor_dominio x 
		where	x.cd_dominio	= 1927 
		and	x.ie_situacao	= 'A' 
		and	x.vl_dominio	= s.ie_indicacao) ds_indicacao, 
	'' ds_observacao 
FROM material z, prescr_medica y, convenio v, unidade_atendimento u, categoria_convenio t, prescr_material s, pessoa_fisica p, atend_categoria_convenio c, atend_paciente_unidade b, atendimento_paciente a
LEFT OUTER JOIN cih_ficha_ocorrencia_hist h ON (a.nr_atendimento = h.nr_atendimento)
WHERE (s.cd_classif_setor in (3,4)) and (s.cd_setor_atendimento = u.cd_setor_atendimento) and (z.cd_material = s.cd_material) and (s.nr_prescricao = y.nr_prescricao) and (u.nr_atendimento    = a.nr_atendimento) and (a.nr_atendimento    = y.nr_atendimento) and (u.nr_atendimento 	= b.nr_atendimento) and (u.dt_entrada_unidade	= b.dt_entrada_unidade) and (a.cd_pessoa_fisica   = p.cd_pessoa_fisica) and (c.nr_seq_interno	= obter_atecaco_atendimento(u.nr_atendimento)) and a.cd_estabelecimento = 1 and (c.cd_convenio     = v.cd_convenio) and (c.cd_convenio     = t.cd_convenio) and (c.cd_categoria     = t.cd_categoria)  and z.cd_classe_material = 62 and not exists (	select 1 
			from cih_def_infect o 
			where a.nr_atendimento = o.nr_atendimento) 
 
union
 
select distinct 
	a.nr_atendimento, 
	'S' ie_tipo_definicao, 
	y.nr_prescricao, 
	y.dt_prescricao, 
	to_date(to_char(y.dt_liberacao,'dd/mm/yyyy'),'dd/mm/yyyy') dt_banda, 
	p.nm_pessoa_fisica nm_paciente, 
	substr(obter_nome_pf(y.cd_medico),1,100) nm_medico_prescritor, 
	substr(z.ds_material,1,100) ds_material, 
	(	select	max(x.ds_valor_dominio) 
		from	valor_dominio x 
		where	x.cd_dominio	= 1927 
		and	x.ie_situacao	= 'A' 
		and	x.vl_dominio	= s.ie_indicacao) ds_indicacao, 
	o.ds_observacao 
FROM material z, prescr_medica y, convenio v, unidade_atendimento u, categoria_convenio t, prescr_material s, pessoa_fisica p, cih_def_infect o, atend_categoria_convenio c, atend_paciente_unidade b, atendimento_paciente a
LEFT OUTER JOIN cih_ficha_ocorrencia_hist h ON (a.nr_atendimento = h.nr_atendimento)
WHERE (s.cd_classif_setor in (3,4)) and (s.cd_setor_atendimento = u.cd_setor_atendimento) and (z.cd_material = s.cd_material) and (s.nr_prescricao = y.nr_prescricao) and (u.nr_atendimento    = a.nr_atendimento) and (a.nr_atendimento    = y.nr_atendimento) and (a.nr_atendimento    = o.nr_atendimento) and ((y.nr_prescricao	= o.nr_prescricao) or (o.nr_prescricao is null)) and (u.nr_atendimento 	= b.nr_atendimento) and (u.dt_entrada_unidade	= b.dt_entrada_unidade) and (a.cd_pessoa_fisica   = p.cd_pessoa_fisica) and (c.nr_seq_interno	= obter_atecaco_atendimento(u.nr_atendimento)) and a.cd_estabelecimento = 1 and (c.cd_convenio     = v.cd_convenio) and (c.cd_convenio     = t.cd_convenio) and (c.cd_categoria     = t.cd_categoria)  and z.cd_classe_material = 62 and o.cd_material is not null order by	2, 1;

