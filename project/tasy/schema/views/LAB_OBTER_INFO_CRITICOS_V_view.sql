-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_obter_info_criticos_v (qt_hora_aviso_crit, ds_setor_paciente, ds_setor_execucao, ie_tipo_atendimento, nm_exame, dt_referencia, dt_prescricao, nr_prescricao, nr_seq_exame) AS select     trunc(lab_dif_aprov_infor_crit(b.nr_prescricao,e.dt_aprovacao)*24,2) qt_hora_aviso_crit,
        substr(obter_ds_descricao_setor(f.cd_setor_atendimento),1,255) ds_setor_paciente,
        substr(obter_ds_descricao_setor(c.cd_setor_atendimento),1,255) ds_setor_execucao,
        substr(OBTER_NOME_TIPO_ATEND(a.ie_tipo_atendimento),1,255) ie_tipo_atendimento,
        substr(obter_desc_exame(c.nr_seq_exame),1,255) nm_exame,
        b.dt_prescricao dt_referencia,
	b.dt_prescricao,
        b.nr_prescricao,
	c.nr_seq_exame
FROM  	atend_paciente_unidade f,
	atendimento_paciente a,
        prescr_medica b,
        prescr_procedimento c,
        exame_lab_resultado d,
        exame_lab_result_item e
where  a.nr_atendimento   = b.nr_atendimento
and    a.nr_atendimento   = f.nr_atendimento
and    b.nr_prescricao    = c.nr_prescricao
and    b.nr_prescricao    = d.nr_prescricao
and    d.nr_seq_resultado = e.nr_seq_resultado
and    c.nr_sequencia    = e.nr_seq_prescr
and    e.nr_seq_material is not null
and    e.dt_aprovacao is not null
and    c.ie_status_atend >= 35
and    c.nr_seq_exame is not null
and    f.nr_seq_interno = (  select	coalesce(max(nr_seq_interno),0)
			from 	atend_paciente_unidade y
			where	y.nr_atendimento 		= b.nr_atendimento
			  and 	coalesce(y.dt_saida_unidade, y.dt_entrada_unidade + 9999)	= (select max(coalesce(z.dt_saida_unidade, b.dt_entrada_unidade + 9999))
											   from atend_paciente_unidade z
											   where z.nr_atendimento 	= b.nr_atendimento))
and    exists (select t.nr_seq_resultado, t.nr_seq_prescr from exame_lab_result_item t where t.nr_seq_resultado = e.nr_seq_resultado and t.nr_seq_prescr = e.nr_seq_prescr and t.IE_RESULTADO_CRITICO = 'S')
order by 2;

