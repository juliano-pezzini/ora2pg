-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW scs_eis_horas_consultoria (dt_fim_ativ, dt_mes, cd_executor, nm_consultor, cd_gerente_projeto, nm_gerente_projeto, ie_cobrado, qt_min_ativ_cobrada, qt_min_ativ_n_cobrada, qt_total_ativ, dt_mes_fim_ativ, ds_projeto) AS SELECT   dt_fim_ativ,
         DT_MES,
         CD_EXECUTOR,
         NM_CONSULTOR,
         CD_GERENTE_PROJETO,
         NM_GERENTE_PROJETO,
         IE_COBRADO,
         QT_MIN_ATIV_COBRADA,
         QT_MIN_ATIV_N_COBRADA,
         (QT_MIN_ATIV_COBRADA + QT_MIN_ATIV_N_COBRADA)QT_TOTAL_ATIV,
         DT_MES_FIM_ATIV,
         DS_PROJETO

         FROM(


select    a.dt_fim_ativ,
          SubStr(obter_data_extenso(trunc(a.dt_fim_ativ,'month'),4),1,255) dt_mes,
          b.cd_executor,
          substr(obter_nome_pf(b.cd_executor),1,100) nm_consultor,
          h.cd_gerente_projeto,
          substr(obter_nome_pf(h.cd_gerente_projeto),1,255)nm_gerente_projeto,
          d.ie_cobrado,
          Sum(a.QT_MIN_ATIV / 60) QT_MIN_ATIV_COBRADA,
          NULL QT_MIN_ATIV_N_COBRADA,
          trunc(a.dt_fim_ativ,'month') dt_mes_fim_ativ,
          (h.DS_TITULO || '     -    ' || d.ds_objetivo) ds_projeto
from      proj_cronograma d,
          proj_cron_etapa c,
          proj_rat b,
          proj_rat_ativ a,
          proj_projeto h,
          com_canal_consultor w
where     a.nr_seq_rat = b.nr_sequencia
and       a.nr_seq_etapa_cron = c.nr_sequencia
AND       w.cd_pessoa_fisica  = b.cd_executor
and       c.nr_seq_cronograma = d.nr_sequencia
and       w.ie_situacao = 'A'
and       d.nr_seq_proj = h.nr_sequencia
and       d.ie_cobrado = 'S'
group by	b.cd_executor,
		a.dt_fim_ativ,
		trunc(a.dt_fim_ativ,'month'),
		h.DS_TITULO,
		d.ds_objetivo,
		b.cd_executor,
		d.ie_cobrado,
		h.cd_gerente_projeto


union all


select    a.dt_fim_ativ,
          SubStr(obter_data_extenso(trunc(a.dt_fim_ativ,'month'),4),1,255) dt_mes,
          b.cd_executor,
          substr(obter_nome_pf(b.cd_executor),1,100) nm_consultor,
          h.cd_gerente_projeto,
          substr(obter_nome_pf(h.cd_gerente_projeto),1,255)nm_gerente_projeto,
          d.ie_cobrado,
          0 QT_MIN_ATIV_COBRADA,
          Sum(a.QT_MIN_ATIV / 60) QT_MIN_ATIV_N_COBRADA,
          trunc(a.dt_fim_ativ,'month') dt_mes_fim_ativ,
          h.DS_TITULO || '     -    ' || d.ds_objetivo ds_projeto
from      proj_cronograma d,
          proj_cron_etapa c,
          proj_rat b,
          proj_rat_ativ a,
          proj_projeto h,
          com_canal_consultor w
where     a.nr_seq_rat = b.nr_sequencia
and       a.nr_seq_etapa_cron = c.nr_sequencia
AND       w.cd_pessoa_fisica  = b.cd_executor
and       c.nr_seq_cronograma = d.nr_sequencia
and       w.ie_situacao = 'A'
and       d.nr_seq_proj = h.nr_sequencia
and       d.ie_cobrado = 'N'
group by	b.cd_executor,
		a.dt_fim_ativ,
		trunc(a.dt_fim_ativ,'month'),
		h.DS_TITULO,
		d.ds_objetivo,
		b.cd_executor,
		d.ie_cobrado,
		h.cd_gerente_projeto
    );

