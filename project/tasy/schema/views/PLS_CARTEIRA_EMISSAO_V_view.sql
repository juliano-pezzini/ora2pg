-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_carteira_emissao_v (nr_sequencia, nm_pessoa_fisica, cd_usuario_plano, nr_seq_seg_carteira, ds_status_carteira, nm_estipulante, nm_subestipulante, dt_solicitacao, dt_inicio_vigencia, dt_validade_carteira, nm_usuario_solicitante, ds_observacao, ds_titularidade, ds_trilha1, ds_trilha2, ds_trilha3, dt_recebimento, dt_entrega_beneficiario, nm_usuario_entrega, ie_situacao, nr_via_emissao, ie_status_emissao, nr_seq_segurado, ds_motivo_via_adic, ds_interface, cd_pf_estipulante, cd_cgc_estipulante, nr_seq_subestipulante, nr_seq_lote) AS select	d.nr_sequencia nr_sequencia,
	e.nm_pessoa_fisica, 
	c.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provis贸rio' END  ds_status_carteira, 
	(	select	k.nm_pessoa_fisica 
		FROM	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pf_estipulante 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc_estipulante) nm_estipulante, 
	(	select	m.nm_pessoa_fisica 
		from	pessoa_fisica m, 
			pls_sub_estipulante pm 
		where	m.cd_pessoa_fisica = pm.cd_pessoa_fisica 
		and	pm.nr_sequencia = b.nr_seq_subestipulante 
		
union
 
		select	n.ds_razao_social 
		from	pessoa_juridica n, 
			pls_sub_estipulante pn 
		where	n.cd_cgc = pn.cd_cgc 
		and	pn.nr_sequencia = b.nr_seq_subestipulante)nm_subestipulante,	 
	c.dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(c.dt_validade_carteira,'dd') dt_validade_carteira, 
	c.nm_usuario_solicitante, 
	substr(c.ds_observacao,1,255) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	c.ds_trilha1, 
	c.ds_trilha2, 
	c.ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	substr(pls_obter_dados_motivo_via(c.nr_seq_motivo_via,'N'),1,255) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	a.cd_pf_estipulante, 
	a.cd_cgc_estipulante, 
	b.nr_seq_subestipulante, 
	d.nr_seq_lote 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_carteira	c, 
	pls_segurado		b, 
	pls_contrato		a 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica	 
and	d.nr_seq_seg_carteira	= c.nr_sequencia 
and	c.nr_seq_lote_emissao	= d.nr_seq_lote 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_contrato	= a.nr_sequencia 

union
 
select	d.nr_sequencia nr_sequencia, 
	e.nm_pessoa_fisica, 
	f.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provis贸rio' END  ds_status_carteira, 
	(	select	k.nm_pessoa_fisica 
		from	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pf_estipulante 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc_estipulante) nm_estipulante, 
	(	select	m.nm_pessoa_fisica 
		from	pessoa_fisica m, 
			pls_sub_estipulante pm 
		where	m.cd_pessoa_fisica = pm.cd_pessoa_fisica 
		and	pm.nr_sequencia = b.nr_seq_subestipulante 
		
union
 
		select	n.ds_razao_social 
		from	pessoa_juridica n, 
			pls_sub_estipulante pn 
		where	n.cd_cgc = pn.cd_cgc 
		and	pn.nr_sequencia = b.nr_seq_subestipulante)nm_subestipulante,	 
	c.dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(f.dt_validade_carteira,'dd') dt_validade_carteira, 
	f.nm_usuario_solicitante, 
	substr(c.ds_observacao,1,255) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	c.ds_trilha1, 
	c.ds_trilha2, 
	c.ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	substr(pls_obter_dados_motivo_via(c.nr_seq_motivo_via,'N'),1,255) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	a.cd_pf_estipulante, 
	a.cd_cgc_estipulante, 
	b.nr_seq_subestipulante, 
	d.nr_seq_lote 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_cart_ant	c, 
	pls_segurado		b, 
	pls_contrato		a, 
	pls_segurado_carteira	f 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica	 
and	d.nr_seq_seg_carteira	= f.nr_sequencia 
and	c.nr_seq_lote_emissao	= d.nr_seq_lote 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_contrato	= a.nr_sequencia 
and	f.nr_seq_segurado	= b.nr_sequencia 

union all
 
select	d.nr_sequencia nr_sequencia, 
	e.nm_pessoa_fisica, 
	c.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provis贸rio' END  ds_status_carteira, 
	(	select	k.nm_pessoa_fisica 
		from	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pessoa_fisica 
		and	a.cd_cgc is null 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc 
		and	a.cd_pessoa_fisica is null) nm_estipulante, 
	'' nm_subestipulante, 
	c.dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(c.dt_validade_carteira,'dd') dt_validade_carteira, 
	c.nm_usuario_solicitante, 
	substr(c.ds_observacao,1,255) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	c.ds_trilha1, 
	c.ds_trilha2, 
	c.ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	substr(pls_obter_dados_motivo_via(c.nr_seq_motivo_via,'N'),1,255) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	null, 
	d.nr_seq_lote 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_carteira	c, 
	pls_segurado		b, 
	pls_intercambio		a 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica	 
and	d.nr_seq_seg_carteira	= c.nr_sequencia 
and	c.nr_seq_lote_emissao	= d.nr_seq_lote 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_intercambio	= a.nr_sequencia 

union
 
select	d.nr_sequencia nr_sequencia, 
	e.nm_pessoa_fisica, 
	f.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provis贸rio' END  ds_status_carteira, 
	(	select	k.nm_pessoa_fisica 
		from	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pessoa_fisica 
		and	a.cd_cgc is null 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc 
		and	a.cd_pessoa_fisica is null) nm_estipulante, 
	'' nm_subestipulante, 
	c.dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(f.dt_validade_carteira,'dd') dt_validade_carteira, 
	f.nm_usuario_solicitante, 
	substr(c.ds_observacao,1,255) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	c.ds_trilha1, 
	c.ds_trilha2, 
	c.ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	substr(pls_obter_dados_motivo_via(c.nr_seq_motivo_via,'N'),1,255) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	null, 
	d.nr_seq_lote 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_cart_ant	c, 
	pls_segurado		b, 
	pls_intercambio		a, 
	pls_segurado_carteira	f 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica	 
and	d.nr_seq_seg_carteira	= f.nr_sequencia 
and	c.nr_seq_lote_emissao	= d.nr_seq_lote 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_intercambio	= a.nr_sequencia 
and	f.nr_seq_segurado	= b.nr_sequencia;

