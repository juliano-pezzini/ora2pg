-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_resultado_valor_base_v (dt_referencia, ie_periodo, cd_estabelecimento, cd_convenio, cd_setor_atendimento, ie_tipo_atendimento, dt_receita, ie_protocolo, ie_proc_mat, cd_especialidade, cd_conta_contabil, nr_seq_conta_financ, nr_seq_grupo_rec, cd_estrutura_conta, vl_procedimento, vl_material, vl_terceiro, vl_custo, vl_imposto, ie_complexidade, vl_desconto, ie_pacote, vl_original, cd_categoria, vl_hospital, qt_dia_internacao, dt_entrega, vl_repasse_calc, qt_atendimento, qt_conta, ie_nota_fiscal, cd_plano, nr_atendimento, nr_interno_conta, ie_conveniado, ie_tipo_financ_proc, vl_custo_excluido, cd_grupo, cd_subgrupo, cd_forma_organizacao, ie_complexidade_sus, cd_setor_paciente, cd_centro_custo_setor, cd_conv_atend, nr_seq_agrup_classif, nr_seq_classif_medico, nr_seq_classificacao, qt_resumo, cd_cgc_prestador, nr_prescricao, cd_medico_prescr, ds_tipo_atend, ds_grupo_rec, ds_complexidade_proc, cd_classificacao_setor, ds_classificacao_setor, ds_convenio_categoria, cd_convenio_categoria, ds_convenio_plano, ds_conv_nac, ds_conv_int, ie_conv_nac, ds_classif_convenio, ds_centro_custo_setor, ds_tipo_financiamento, cd_empresa_estab, ds_municipio_ibge_pf, ie_clinica_atend, ds_clinica_atend, nr_seq_prot, ds_setor_atend, ds_setor_pac, nr_prot, ds_espec, nm_medico_atend, cd_cid_doenca, ds_cid_doenca, ie_tipo_prot, ds_tipo_prot, ds_proced_atend, ds_estab, ds_grupo_sus, ds_subgrupo_sus, ds_forma_org_sus, ds_complex_sus, ds_conv_atend, nm_medico_ref, cd_pessoa_fisica, cd_categ_cid, ds_categ_cid, ds_agrupamento_classif, cd_estabelecimento_atend, ds_classificacao_medico, ds_classificacao_atend, ds_prest, nm_medico_prescricao, ds_ie_pacote, ds_ie_proc_mat, ds_ie_protocolo, ds_estabelecimento_atend, ds_motivo_atendimento, ds_origem_convenio, cd_proced_atend, ds_conv_conta, ie_tipo_conv, ds_tipo_conv, ds_idade_pf, ie_complex_princ_sus, ie_tipo_fin_princ_sus, nr_seq_patient_category, ds_procedimento, ds_grupo_proc, ds_patient_category, vl_medico, ie_proc_material, ie_tipo_convenio, ds_convenio, ds_entrega, ds_ano, dt_ano, ds_grupo_receita, cd_estrutura, ds_complexidade, vl_faturado, vl_total, vl_total_sem_repasse, vl_total_sem_imposto, vl_result_pacote, vl_margem, pr_margem, cd_classif_setor, ds_classif_setor, ds_categoria, ds_conv_categ, ds_plano, ds_convenio_nacional, ds_convenio_internacional, ie_nacional, ds_classificacao, cd_centro_custo, ds_centro_custo, ds_tipo_financ_proc, cd_empresa, ds_municipio_ibge, ie_clinica, ds_clinica, nr_seq_protocolo, ds_setor_atendimento, ds_setor_paciente, nr_protocolo, ds_especialidade, nm_medico_atendimento, ds_cid, cd_cid, ie_tipo_protocolo, ds_tipo_protocolo, cd_procedencia, ds_idade, ds_estabelecimento, ds_grupo, ds_subgrupo, ds_forma_organizacao, ds_complexidade_sus, cd_convenio_atend, ds_convenio_atend, vl_resultado_sem_rep, nm_medico_referido, cd_paciente, cd_categoria_cid, vl_total_sem_repasses, ds_agrup_classif, cd_estab_atend, ds_classif_medico, ds_classif_atend, ds_prestador, nm_medico_prescr, ds_pacote, ds_tipo_atendimento, ds_tipo_convenio, ds_proc_mat, ds_protocolo, ds_procedencia, ds_estab_atend, ds_protocolo_conv, ds_motivo_atend, ds_categoria_doenca, ds_origem_conv, vl_total_sem_repasse_calc, vl_margem_calc, vl_base_sem_imposto, vl_base_com_imposto, vl_honorario_medico, vl_desconto_conta, vl_margem_material, vl_margem_procedimento) AS select	a.DT_REFERENCIA,a.IE_PERIODO,a.CD_ESTABELECIMENTO,a.CD_CONVENIO,a.CD_SETOR_ATENDIMENTO,a.IE_TIPO_ATENDIMENTO,a.DT_RECEITA,a.IE_PROTOCOLO,a.IE_PROC_MAT,a.CD_ESPECIALIDADE,a.CD_CONTA_CONTABIL,a.NR_SEQ_CONTA_FINANC,a.NR_SEQ_GRUPO_REC,a.CD_ESTRUTURA_CONTA,a.VL_PROCEDIMENTO,a.VL_MATERIAL,a.VL_TERCEIRO,a.VL_CUSTO,a.VL_IMPOSTO,a.IE_COMPLEXIDADE,a.VL_DESCONTO,a.IE_PACOTE,a.VL_ORIGINAL,a.CD_CATEGORIA,a.VL_HOSPITAL,a.QT_DIA_INTERNACAO,a.DT_ENTREGA,a.VL_REPASSE_CALC,a.QT_ATENDIMENTO,a.QT_CONTA,a.IE_NOTA_FISCAL,a.CD_PLANO,a.NR_ATENDIMENTO,a.NR_INTERNO_CONTA,a.IE_CONVENIADO,a.IE_TIPO_FINANC_PROC,a.VL_CUSTO_EXCLUIDO,a.CD_GRUPO,a.CD_SUBGRUPO,a.CD_FORMA_ORGANIZACAO,a.IE_COMPLEXIDADE_SUS,a.CD_SETOR_PACIENTE,a.CD_CENTRO_CUSTO_SETOR,a.CD_CONV_ATEND,a.NR_SEQ_AGRUP_CLASSIF,a.NR_SEQ_CLASSIF_MEDICO,a.NR_SEQ_CLASSIFICACAO,a.QT_RESUMO,a.CD_CGC_PRESTADOR,a.NR_PRESCRICAO,a.CD_MEDICO_PRESCR,a.DS_TIPO_ATEND,a.DS_GRUPO_REC,a.DS_COMPLEXIDADE_PROC,a.CD_CLASSIFICACAO_SETOR,a.DS_CLASSIFICACAO_SETOR,a.DS_CONVENIO_CATEGORIA,a.CD_CONVENIO_CATEGORIA,a.DS_CONVENIO_PLANO,a.DS_CONV_NAC,a.DS_CONV_INT,a.IE_CONV_NAC,a.DS_CLASSIF_CONVENIO,a.DS_CENTRO_CUSTO_SETOR,a.DS_TIPO_FINANCIAMENTO,a.CD_EMPRESA_ESTAB,a.DS_MUNICIPIO_IBGE_PF,a.IE_CLINICA_ATEND,a.DS_CLINICA_ATEND,a.NR_SEQ_PROT,a.DS_SETOR_ATEND,a.DS_SETOR_PAC,a.NR_PROT,a.DS_ESPEC,a.NM_MEDICO_ATEND,a.CD_CID_DOENCA,a.DS_CID_DOENCA,a.IE_TIPO_PROT,a.DS_TIPO_PROT,a.DS_PROCED_ATEND,a.DS_ESTAB,a.DS_GRUPO_SUS,a.DS_SUBGRUPO_SUS,a.DS_FORMA_ORG_SUS,a.DS_COMPLEX_SUS,a.DS_CONV_ATEND,a.NM_MEDICO_REF,a.CD_PESSOA_FISICA,a.CD_CATEG_CID,a.DS_CATEG_CID,a.DS_AGRUPAMENTO_CLASSIF,a.CD_ESTABELECIMENTO_ATEND,a.DS_CLASSIFICACAO_MEDICO,a.DS_CLASSIFICACAO_ATEND,a.DS_PREST,a.NM_MEDICO_PRESCRICAO,a.DS_IE_PACOTE,a.DS_IE_PROC_MAT,a.DS_IE_PROTOCOLO,a.DS_ESTABELECIMENTO_ATEND,a.DS_MOTIVO_ATENDIMENTO,a.DS_ORIGEM_CONVENIO,a.CD_PROCED_ATEND,a.DS_CONV_CONTA,a.IE_TIPO_CONV,a.DS_TIPO_CONV,a.DS_IDADE_PF,a.IE_COMPLEX_PRINC_SUS,a.IE_TIPO_FIN_PRINC_SUS,a.NR_SEQ_PATIENT_CATEGORY,a.DS_PROCEDIMENTO,a.DS_GRUPO_PROC,a.DS_PATIENT_CATEGORY,a.VL_MEDICO,
	somente_numero(a.ie_proc_mat) ie_proc_material,
	IE_TIPO_CONV	ie_tipo_convenio,
	DS_CONV_CONTA	ds_convenio,
	to_char(a.dt_entrega, 'dd/mm/yyyy') ds_entrega,
	to_char(a.dt_referencia, 'yyyy') ds_ano,
	trunc(a.dt_referencia, 'year') dt_ano,
	DS_GRUPO_REC ds_grupo_receita,
	somente_numero(a.cd_estrutura_conta) cd_estrutura,
	DS_COMPLEXIDADE_PROC ds_complexidade,
	(a.vl_Procedimento + a.vl_terceiro + a.vl_Material) vl_faturado,
	(a.vl_Procedimento + a.vl_Material + a.Vl_terceiro + a.vl_imposto) vl_total,
	(a.vl_Procedimento + a.vl_terceiro + a.vl_Material + a.vl_imposto - a.vl_repasse_calc) vl_total_sem_repasse,
	(a.vl_Procedimento + a.vl_Material + a.Vl_terceiro - a.vl_imposto) vl_total_sem_imposto,
	(a.vl_procedimento + a.vl_terceiro + a.vl_material - coalesce(a.vl_original,0)) vl_result_pacote,
	(a.vl_Procedimento + a.vl_terceiro + a.vl_Material - a.vl_custo) vl_margem,
	(dividir((a.vl_Procedimento + a.vl_Material + a.vl_terceiro - a.vl_custo), CASE WHEN(a.vl_Procedimento + a.vl_terceiro + a.vl_Material)=0 THEN 1  ELSE (a.vl_Procedimento + a.vl_terceiro + a.vl_Material) END ) * 100) pr_margem,
	CD_CLASSIFICACAO_SETOR cd_classif_setor,
	DS_CLASSIFICACAO_SETOR ds_classif_setor,
	DS_CONVENIO_CATEGORIA ds_categoria,
	CD_CONVENIO_CATEGORIA DS_CONV_CATEG,
	DS_CONVENIO_PLANO ds_plano,
	DS_CONV_NAC ds_convenio_nacional,
	DS_CONV_INT ds_convenio_internacional,
	IE_CONV_NAC ie_nacional,
	DS_CLASSIF_CONVENIO ds_classificacao,
	a.cd_centro_custo_setor cd_centro_custo,
	DS_CENTRO_CUSTO_SETOR ds_centro_custo,
	DS_TIPO_FINANCIAMENTO ds_tipo_financ_proc,
	CD_EMPRESA_ESTAB cd_empresa,
	DS_MUNICIPIO_IBGE_PF ds_municipio_ibge,
	IE_CLINICA_ATEND ie_clinica,
	DS_CLINICA_ATEND ds_clinica,
	NR_SEQ_PROT nr_seq_protocolo,
	DS_SETOR_ATEND ds_setor_atendimento,
	DS_SETOR_PAC ds_setor_paciente,
	NR_PROT nr_protocolo,
	DS_ESPEC ds_especialidade,
	NM_MEDICO_ATEND nm_medico_atendimento,
	DS_CID_DOENCA ds_cid,
	CD_CID_DOENCA cd_cid,
	IE_TIPO_PROT ie_tipo_protocolo,
	DS_TIPO_PROT ds_tipo_protocolo,
	CD_PROCED_ATEND cd_procedencia,
	ds_idade_pf ds_idade,
	DS_ESTAB ds_estabelecimento,
	DS_GRUPO_SUS ds_grupo,
	DS_SUBGRUPO_SUS ds_subgrupo,
	DS_FORMA_ORG_SUS ds_forma_organizacao,
	DS_COMPLEX_SUS ds_complexidade_sus,
	a.cd_conv_atend cd_convenio_atend,
	DS_CONV_ATEND ds_convenio_atend,
	coalesce(a.vl_Procedimento + a.vl_material + a.vl_terceiro,0) - coalesce(a.vl_custo,0) - coalesce(a.vl_repasse_calc,0) vl_resultado_sem_rep,
	NM_MEDICO_REF nm_medico_referido,
	CD_PESSOA_FISICA cd_paciente,
	CD_CATEG_CID cd_categoria_cid,
	((a.vl_Procedimento + a.vl_Material + a.vl_terceiro) - a.VL_REPASSE_CALC) VL_TOTAL_SEM_REPASSES,
	DS_AGRUPAMENTO_CLASSIF ds_agrup_classif,
	CD_ESTABELECIMENTO_ATEND cd_estab_atend,
	DS_CLASSIFICACAO_MEDICO ds_classif_medico,
	DS_CLASSIFICACAO_ATEND ds_classif_atend,
	DS_PREST ds_prestador,
	NM_MEDICO_PRESCRICAO nm_medico_prescr,
	DS_IE_PACOTE ds_pacote,
	DS_TIPO_ATEND ds_tipo_atendimento,
	DS_TIPO_CONV ds_tipo_convenio,
	DS_IE_PROC_MAT ds_proc_mat,
	DS_IE_PROTOCOLO ds_protocolo,
	DS_PROCED_ATEND	ds_procedencia,
	DS_ESTABELECIMENTO_ATEND ds_estab_atend,
	NR_PROT ds_protocolo_conv,
	DS_MOTIVO_ATENDIMENTO ds_motivo_atend,
	DS_CATEG_CID ds_categoria_doenca,
	DS_ORIGEM_CONVENIO ds_origem_conv,
	((a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) + a.vl_imposto - a.VL_REPASSE_CALC) VL_TOTAL_SEM_REPASSE_CALC,
	((a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) - vl_repasse_calc - a.vl_custo) vl_margem_calc,
        CASE WHEN vl_imposto=0 THEN  coalesce(vl_procedimento + a.vl_terceiro, 0) + coalesce(vl_material, 0)  ELSE 0 END  vl_base_sem_imposto,
        CASE WHEN vl_imposto=0 THEN  0  ELSE coalesce(vl_procedimento + a.vl_terceiro, 0) + coalesce(vl_material, 0) END  vl_base_com_imposto,
        a.vl_medico vl_honorario_medico,
        a.vl_desconto vl_desconto_conta,
        CASE WHEN a.vl_material=0 THEN  0  ELSE (a.vl_Material - CASE WHEN a.vl_material=0 THEN  0  ELSE a.vl_custo END ) END  vl_margem_material,
        CASE WHEN a.vl_procedimento + a.vl_terceiro - CASE WHEN a.vl_procedimento + a.vl_terceiro=0 THEN  0  ELSE a.vl_custo END =0 THEN  0  ELSE (a.vl_Procedimento + a.vl_terceiro - CASE WHEN a.vl_procedimento + a.vl_terceiro=0 THEN  0  ELSE a.vl_custo END ) END  vl_margem_procedimento
FROM	Eis_Resultado a
where	1 = 1;

