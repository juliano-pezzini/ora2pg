-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_pessoa_relacionamento_v (cd_pessoa_fisica, ds_funcao, ds_tipo_relacionamento, ds_observacao) AS select	a.cd_pessoa_fisica,
	'Plano de Saúde' ds_funcao, 
	'Beneficiário de plano de saúde' ds_tipo_relacionamento, 
	substr('Contrato: ' || b.nr_contrato,1,255) ds_observacao 
FROM	pls_segurado	a, 
	pls_contrato	b 
where	a.nr_seq_contrato	= b.nr_sequencia 
and	a.ie_tipo_segurado	= 'B' 

union all
 
select	a.cd_pessoa_fisica, 
	'Acidente de trabalho' ds_funcao, 
	'Beneficiário de acidente de trabalho' ds_tipo_relacionamento, 
	substr('Contrato: ' || b.nr_contrato,1,255) ds_observacao 
from	pls_segurado	a, 
	pls_contrato	b 
where	a.nr_seq_contrato	= b.nr_sequencia 
and	a.ie_tipo_segurado	= 'A' 

union all
 
select	cd_pessoa_fisica, 
	'Perícia médica' ds_funcao, 
	'Usuário de perícia médica' ds_tipo_relacionamento, 
	substr('',1,255) ds_observacao 
from	pls_segurado 
where	ie_tipo_segurado	= 'P' 

union all
 
select	b.cd_pessoa_fisica, 
	'Terceiro' ds_funcao, 
	'Convênio: ' || substr(obter_nome_convenio(a.cd_convenio),1,50) ds_tipo_relacionamento, 
	substr('Categoria: ' || substr(obter_categoria_convenio(a.cd_convenio, a.cd_categoria),1,50),1,255) ds_observacao 
from	terceiro	a, 
	pessoa_fisica	b 
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 

union all
 
select	b.cd_pessoa_fisica, 
	'Médico' ds_funcao, 
	'Especialidade: ' || substr(obter_especialidade_medico(a.cd_pessoa_fisica, 'D'),1,50) ds_tipo_relacionamento, 
	substr(substr(a.nm_guerra,1,100) || ' - CRM: ' || a.nr_crm || ' - UF: ' || a.uf_crm,1,255) ds_observacao 
from	medico		a, 
	pessoa_fisica	b 
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 

union all
 
select	cd_pessoa_fisica, 
	'Usuário' ds_funcao, 
	'Usuário do sistema' ds_tipo_relacionamento, 
	substr(nm_usuario,1,255) ds_observacao 
from	usuario 
where	ie_situacao	= 'A' 

union all
 
select	b.cd_pessoa_fisica, 
	'Paciente' ds_funcao, 
	'Prontuário: ' || b.nr_prontuario ds_tipo_relacionamento, 
	substr('Último atendimento: ' || to_char(a.dt_entrada, 'dd/mm/yyyy hh24:mi:ss'),1,255) ds_observacao 
from	atendimento_paciente	a, 
	pessoa_fisica		b 
where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica 
and	a.nr_atendimento	= (	select	max(x.nr_atendimento) 
					from	atendimento_paciente	x 
					where	x.cd_pessoa_fisica	= b.cd_pessoa_fisica) 
order by ds_funcao;

