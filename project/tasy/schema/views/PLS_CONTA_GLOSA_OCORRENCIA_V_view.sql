-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_glosa_ocorrencia_v (ie_tipo, ds_tipo, nr_sequencia, cd_codigo, ds_descricao_glosa_ocor, ds_grupo, ds_observacao, nr_regra_ocor, nr_seq_conta, nr_seq_proc, nr_seq_mat, nr_ocorrencia, ie_fechar_conta, dt_liberacao, nm_usuario_lib, nr_nivel_liberacao, ie_situacao, ds_glosa_vinculada, qt_glosa, vl_glosa, ds_documentacao, nr_seq_motivo_glosa, nr_seq_proc_partic, nm_participante, ie_lib_manual) AS select	'G' ie_tipo,
	'Glosa' ds_tipo,
	a.nr_sequencia,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'C'),1,10) cd_codigo,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'D'),1,255) ds_descricao_glosa_ocor,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'DG'),1,255) ds_grupo,
	substr(ds_observacao,1,255) ds_observacao,	
	0 nr_regra_ocor,
	a.nr_seq_conta 		nr_seq_conta,
	a.nr_seq_conta_proc	nr_seq_proc,
	a.nr_seq_conta_mat	nr_seq_mat,
	a.nr_seq_ocorrencia	nr_ocorrencia,	
	a.ie_fechar_conta	ie_fechar_conta,
	a.dt_liberacao,
	a.nm_usuario_lib,
	null nr_nivel_liberacao,
	ie_situacao,
	'' ds_glosa_vinculada,
	a.qt_glosa, 
	a.vl_glosa,
	a.ds_documentacao,
	a.nr_seq_motivo_glosa,
	a.nr_seq_proc_partic nr_seq_proc_partic,
	(select  substr(coalesce(pls_obter_dados_prestador(i.nr_seq_prestador,'N'),obter_nome_medico(i.cd_medico,'N')),1,255) 
	FROM  	 pls_proc_participante i
	where    i.nr_sequencia = a.nr_seq_proc_partic) nm_participante,
	a.ie_lib_manual
from	pls_conta_glosa	a
where	coalesce(nr_seq_ocorrencia_benef,0) = 0 -- Diego 29/06/2011 -  OS 318128  = So ira mostrar glosas na analise se estas nao foram GERADAS POR OCORRENCIAS ou geram ocorrencias ou sejam Nao possuem representante em ocorrencias
and	not exists (	select	x.nr_sequencia
			from	pls_ocorrencia_benef x
			where	((x.nr_seq_glosa = a.nr_sequencia) or (a.nr_seq_ocorrencia_benef = x.nr_sequencia)))

union

select	'O' ie_tipo,
	'Ocorrencia' ds_tipo,
	a.nr_sequencia,
	substr(pls_obter_dados_ocorrencia(a.nr_seq_ocorrencia,'C'),1,255) cd_codigo,
	substr(pls_obter_dados_ocorrencia(a.nr_seq_ocorrencia,'D'),1,255) ds_descricao_glosa_ocor,
	'' ds_grupo,
	a.ds_observacao		ds_observacao,--jjung Removido a observacao da glosa, a mesma ja e gravada na pls_gravar_conta_glosa
	coalesce(a.nr_seq_oc_cta_comb,a.nr_seq_regra)	nr_regra_ocor,
	a.nr_seq_conta		nr_seq_conta,
	a.nr_seq_conta_proc	nr_seq_proc,
	a.nr_seq_conta_mat	nr_seq_mat,
	a.nr_seq_ocorrencia 	nr_ocorrencia,
	pls_obter_perm_fec_conta(a.nr_sequencia, coalesce(a.nr_seq_glosa, (select	max(x.nr_sequencia)
						 from	pls_conta_glosa x
						 where	x.nr_seq_ocorrencia_benef = a.nr_sequencia ))) ie_fechar_conta,
	a.dt_liberacao,
	a.nm_usuario_lib,
	a.nr_nivel_liberacao nr_nivel_liberacao,
	ie_situacao,
	substr(pls_obter_desc_glosa(coalesce(a.nr_seq_glosa, (select	max(x.nr_sequencia)
							 from	pls_conta_glosa x
							 where	x.nr_seq_ocorrencia_benef = a.nr_sequencia ))),1,255)	ds_glosa_vinculada,
	a.qt_glosa, 
	a.vl_glosa,
	a.ds_documentacao,
	(select	x.nr_seq_motivo_glosa
	from	pls_ocorrencia x
	where	x.nr_sequencia	= a.nr_seq_ocorrencia) nr_seq_motivo_glosa,
	a.nr_seq_proc_partic nr_seq_proc_partic,
	(select   substr(coalesce(pls_obter_dados_prestador(i.nr_seq_prestador,'N'),obter_nome_medico(i.cd_medico,'N')),1,255) 
	from  	 pls_proc_participante i
	where    i.nr_sequencia = a.nr_seq_proc_partic) nm_participante,
	null ie_lib_manual
from	pls_ocorrencia_benef	a
where	nr_seq_guia_plano is null
and	nr_seq_requisicao is null
and	nr_seq_execucao	is null
and	nr_seq_conta_pos_estab is null;

