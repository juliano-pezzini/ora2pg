-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW gpt_doc_reval_events_v (nr_atendimento, nr_sequencia, dt_validacao, ie_pendente_reval, cd_setor_atendimento, nr_seq_cpoe, cd_estabelecimento, dt_atualizacao_nrec, nm_tabela) AS select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento,
			a.nr_seq_dialysis nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_DIALISE' nm_tabela
FROM		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_dialysis is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_dialysis,
			b.cd_estabelecimento

union all

select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
			a.nr_seq_material nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_MATERIAL' nm_tabela
from		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_material is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_material,
			b.cd_estabelecimento

union all

select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
			a.nr_seq_diet nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_DIETA' nm_tabela
from		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_diet is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_diet,
			b.cd_estabelecimento

union all

select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
			a.nr_seq_exam nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_PROCEDIMENTO' nm_tabela
from		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_exam is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_exam,
			b.cd_estabelecimento

union all

select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
			a.nr_seq_gasotherapy nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_GASOTERAPIA' nm_tabela
from		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_gasotherapy is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_gasotherapy,
			b.cd_estabelecimento

union all

select		a.nr_atendimento,
			max(a.nr_sequencia) nr_sequencia,
			max(a.dt_validacao) dt_validacao,
			gpt_obter_se_doc_reval(max(a.dt_validacao), max(a.nr_seq_revalidation_rule)) ie_pendente_reval,
			obter_setor_atendimento(a.nr_atendimento) cd_setor_atendimento, 
			a.nr_seq_recomendation nr_seq_cpoe,
			b.cd_estabelecimento,
			max(a.dt_atualizacao_nrec) dt_atualizacao_nrec,
			'CPOE_RECOMENDACAO' nm_tabela
from		cpoe_revalidation_events a,
			cpoe_revalidation_rule b
where		a.nr_seq_revalidation_rule = b.nr_sequencia
and			coalesce(b.ie_situacao, 'A') in ('A', 'I')
and			a.dt_validacao between gpt_get_doc_reval_period() and fim_dia(LOCALTIMESTAMP)
and			a.nr_atendimento is not null
and			a.dt_validacao is not null
and			a.nr_seq_hemotherapy is null
and			a.nr_seq_recomendation is not null
and 		coalesce(wheb_usuario_pck.get_cd_estabelecimento, obter_estab_atendimento(a.nr_atendimento)) = obter_estab_atendimento(a.nr_atendimento)	
and			coalesce(obter_se_atendimento_alta(a.nr_atendimento), 'N') = 'N'
group by	a.nr_atendimento,
			a.nr_seq_recomendation,
			b.cd_estabelecimento;

