-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pfcs_discharge_manager_v (vl_indicator, vl_target, vl_aux, cd_establishment, nr_seq_indicator, cd_type, ie_std_deviation) AS SELECT concat(pfcs_get_percentage_value(sum(p.vl_indicator_help), sum(p.vl_indicator)),'%') VL_INDICATOR,
    (pfcs_get_percentage_value(sum(p.vl_indicator_help), sum(p.vl_indicator)))::numeric  VL_TARGET,
    sum(p.vl_indicator) VL_AUX,
    p.nr_seq_operational_level CD_ESTABLISHMENT,
    210 NR_SEQ_INDICATOR,
    'CAP' CD_TYPE,
    'N' IE_STD_DEVIATION
FROM pfcs_panel p
WHERE p.nr_seq_indicator = 100
    and p.ie_situation = 'A'
    and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
group by p.nr_seq_indicator, p.nr_seq_operational_level

UNION ALL

-- Census
SELECT (sum(p.vl_indicator_help) || '/' || sum(p.vl_indicator)) VL_INDICATOR,
    null VL_TARGET,
    null VL_AUX,
    p.nr_seq_operational_level CD_ESTABLISHMENT,
    211 NR_SEQ_INDICATOR,
    'CEN' CD_TYPE,
    'N' IE_STD_DEVIATION
FROM pfcs_panel p
WHERE p.nr_seq_indicator = 100
    and p.ie_situation = 'A'
    and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
group by p.nr_seq_indicator, p.nr_seq_operational_level

UNION ALL

-- Available beds
SELECT to_char(sum(p.vl_indicator)) VL_INDICATOR,
    sum(p.vl_indicator) VL_TARGET,
    sum(p.vl_indicator_help) VL_AUX,
    p.nr_seq_operational_level CD_ESTABLISHMENT,
    212 NR_SEQ_INDICATOR,
    'AVB' CD_TYPE,
    'N' IE_STD_DEVIATION
FROM pfcs_panel p
WHERE p.nr_seq_indicator = 102
    and p.ie_situation = 'A'
    and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
group by p.nr_seq_indicator, p.nr_seq_operational_level

UNION ALL

-- Predicted beds
SELECT null VL_INDICATOR,
    null VL_TARGET,
    null VL_AUX,
    p.nr_seq_operational_level CD_ESTABLISHMENT,
    214 NR_SEQ_INDICATOR,
    'DIS' CD_TYPE,
    'N' IE_STD_DEVIATION
FROM pfcs_panel p
WHERE p.nr_seq_indicator = 100
    and p.ie_situation = 'A'
    and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
    and pfcs_get_algorithm_visibility('SIM', obter_perfil_ativo, obter_estabelecimento_ativo, obter_usuario_ativo) = 'Y'
group by p.nr_seq_indicator, p.nr_seq_operational_level

UNION ALL

-- Total discharges today
SELECT to_char(sum(p.vl_indicator)) VL_INDICATOR,
    sum(p.vl_indicator) VL_TARGET,
    null VL_AUX,
    p.nr_seq_operational_level CD_ESTABLISHMENT,
    215 NR_SEQ_INDICATOR,
    null CD_TYPE,
    null IE_STD_DEVIATION
FROM pfcs_panel p
WHERE p.nr_seq_indicator = 215
    and p.ie_situation = 'A'
    and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
group by p.nr_seq_indicator, p.nr_seq_operational_level

UNION ALL

-- Discharges by noon
SELECT to_char(v.vl_reference) VL_INDICATOR,
    v.vl_reference VL_TARGET,
    null VL_AUX,
    v.CD_ESTABLISHMENT,
    216 NR_SEQ_INDICATOR,
    null CD_TYPE,
    null IE_STD_DEVIATION
FROM (
    SELECT pfcs_pck_census.get_discharges_by_noon(p.nr_seq_operational_level) VL_REFERENCE,
        p.nr_seq_operational_level CD_ESTABLISHMENT
    FROM pfcs_panel p
    WHERE p.nr_seq_indicator = 100
        and p.ie_situation = 'A'
        and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
    group by p.nr_seq_indicator, p.nr_seq_operational_level
) v

UNION ALL

-- % discharges by noon
SELECT concat(v.vl_reference,'%') VL_INDICATOR,
    v.vl_reference VL_TARGET,
    null VL_AUX,
    v.CD_ESTABLISHMENT,
    221 NR_SEQ_INDICATOR,
    null CD_TYPE,
    null IE_STD_DEVIATION
FROM (
    SELECT pfcs_pck_census.get_pr_discharges_by_noon(p.nr_seq_operational_level) VL_REFERENCE,
        p.nr_seq_operational_level CD_ESTABLISHMENT
    FROM pfcs_panel p
    WHERE p.nr_seq_indicator = 100
        and p.ie_situation = 'A'
        and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
    group by p.nr_seq_indicator, p.nr_seq_operational_level
) v

UNION ALL

-- AVG discharge order time
SELECT CASE WHEN v.vl_reference IS NULL THEN  null  ELSE date_as_varchar2(v.vl_reference, 'shortTime') END  VL_INDICATOR,
    (to_char(VL_REFERENCE, 'HH24Mi'))::numeric  VL_TARGET,
    null VL_AUX,
    v.CD_ESTABLISHMENT,
    217 NR_SEQ_INDICATOR,
    null CD_TYPE,
    null IE_STD_DEVIATION
FROM (
    SELECT PFCS_PCK_CENSUS.GET_AVG_DISCHARGE_ORDER_TIME(p.nr_seq_operational_level) VL_REFERENCE,
        p.nr_seq_operational_level CD_ESTABLISHMENT
    FROM pfcs_panel p
    WHERE p.nr_seq_indicator = 100
        and p.ie_situation = 'A'
        and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
    group by p.nr_seq_indicator, p.nr_seq_operational_level
) v

UNION ALL

-- AVG discharge time
SELECT CASE WHEN v.vl_reference IS NULL THEN  null  ELSE date_as_varchar2(v.vl_reference, 'shortTime') END  VL_INDICATOR,
    (to_char(VL_REFERENCE, 'HH24Mi'))::numeric  VL_TARGET,
    null VL_AUX,
    v.CD_ESTABLISHMENT,
    218 NR_SEQ_INDICATOR,
    null CD_TYPE,
    null IE_STD_DEVIATION
FROM (
    SELECT PFCS_PCK_CENSUS.GET_AVG_DISCHARGE_TIME(p.nr_seq_operational_level) VL_REFERENCE,
        p.nr_seq_operational_level CD_ESTABLISHMENT
    FROM pfcs_panel p
    WHERE p.nr_seq_indicator = 100
        and p.ie_situation = 'A'
        and pfcs_pck_utils.get_ie_hospital_occupancy(p.cd_reference_value) = 'S'
    group by p.nr_seq_indicator, p.nr_seq_operational_level
) v;

