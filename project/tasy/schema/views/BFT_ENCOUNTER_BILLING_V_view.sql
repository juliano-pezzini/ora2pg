-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_encounter_billing_v (clientsurgicalepisodeid, admissiontypeid, appointmentid, caretypeid, chargeablestatusid, dc_client_id, compensablestatusid, episodestatusid, fundingsourceid, invoiceid, contracttypeid, modeofseparationid, principaldiagnosisid, principalprocedureid, readmission28daysid, referraltoid, samedaybandid, sourceofreferralid, transferredfromid, transferredtoid, transferoutcodeid, transferincodeid, dischargecodeid, anaesthetictypeid, admissioncodeid, mentalhealthlegalstatusid, interhospitalcontractid, samedaystatusid, paymenttypeid, reportid, paymentother, acutelengthstay, accommodationcodeid, admissiondatetime, proceduredate, dischargedatetime, theatrefrom, theatreto, contractrole, ambulancecasenumber, icudays, icuhours, babyagedays, babybeddays, babyadmissionweight, firstpsychadmission, lastyearpsychadmission, dayspsychunit, drg, drgver, mechventhours, totalleavedays, nonacutelengthstay, coronarycareunithours, specialcarenuseryhours, hospitalinhomedays, daysclaimed, datefirstaware, datefirstconsultation, standardwardcode, admittingward, admittingunit, standardunitcode, plannedsameday, electivepatientstatusid, qualificationstatusid, dischargeintentionid, totalinvoluntarydays, financialprogram, leaveperiods, drgmentalhealthlegalstatus, noncertifieddaysofstay, specialcarenurserydays, coronarycareunitdays, qualifieddaysfornewborns, hithcarecommencement, hithcarecompleteddate, hithcarevisitdays, palliativecaredays, admissionlegalstatusid, firstpsychadmissionid, usualaccommodationtypeid, unplannedvisitid, fundingarrangementid, intentiontoreadmitid, accountclassonadmissionid, accountclassonseparationid, careravailabilityid, criterionforadmissionid, accommocdonseperationid, transmissiondate, reportstatusid, employmentstatusid, prevspecialisedtreatmentid, isdeleted, palliativecare, principaldiagpresonadmission, encounter_id, nr_account_id, certificate_text) AS select	(obter_conversao_externa_int(null, 'CONTA_PACIENTE','NR_ATENDIMENTO',b.nr_interno_conta,'DC'))::numeric  clientsurgicalepisodeid,
		a.ie_tipo_atendimento admissiontypeid, --2
		dc_obter_conversao_externa_int(null, 'AUTORIZACAO_CONVENIO','NR_SEQ_AGENDA', (select max(x.nr_sequencia) FROM autorizacao_convenio x where x.nr_atendimento = a.nr_atendimento), 'DC') appointmentid, --536
		a.ie_clinica  caretypeid, --1
		d.cd_tipo_acomodacao chargeablestatusid,
		dc_obter_conversao_externa_int(null, 'PESSOA_FISICA','CD_PESSOA_FISICA', a.cd_pessoa_fisica, 'DC') dc_client_id, --100
		a.ie_tipo_convenio compensablestatusid, -- 104
		CASE WHEN a.dt_cancelamento IS NULL THEN 2  ELSE 1 END  episodestatusid, -- 2 Valid / 1 Invalid
		null fundingsourceid,
		obter_conversao_externa_int(null, 'AUTORIZACAO_CONVENIO','CD_AUTORIZACAO', (select max(x.nr_sequencia) from autorizacao_convenio x where x.nr_atendimento = a.nr_atendimento), 'DC') invoiceid,-- 89
		null contracttypeid,
		a.cd_motivo_alta  modeofseparationid, --101
		obter_cod_diagnostico_atend(a.nr_atendimento, 'N') principaldiagnosisid,
		null principalprocedureid,
		nr_readmission_days readmission28daysid, -- 4
		null referraltoid,
		100 samedaybandid,
		a.cd_procedencia sourceofreferralid,
		null transferredfromid,
		null transferredtoid,
		null transferoutcodeid,
		null transferincodeid,
		null dischargecodeid,
		null anaesthetictypeid,
		null admissioncodeid,
		c.cd_mental_health_status mentalhealthlegalstatusid,
		c.cd_inter_hospital interhospitalcontractid, -- 11
		a.nr_seq_classificacao samedaystatusid,
		null paymenttypeid,
		null reportid,
		null paymentother,
		null acutelengthstay,
		d.cd_tipo_acomodacao accommodationcodeid,
		a.dt_entrada admissiondatetime,
		null proceduredate,
		a.dt_alta dischargedatetime,
		null theatrefrom,
		null theatreto,
		null contractrole,
		null ambulancecasenumber,
		get_days_by_classification(a.nr_atendimento,4) icudays,
		null icuhours,
		null babyagedays,
		null babybeddays,
		null babyadmissionweight,
		null firstpsychadmission,
		null lastyearpsychadmission,
		0 dayspsychunit,
		substr(obter_dados_drg((select max(x.nr_seq_drg_proc) from episodio_paciente_drg x where x.nr_atendimento = a.nr_atendimento),'C'),1,255) drg,
		somente_numero(obtain_drg_version(a.nr_atendimento, null)) drgver,
		0 mechventhours,
		coalesce(c.nr_total_leave_days,0) totalleavedays,
		null nonacutelengthstay,
		null coronarycareunithours,
		null specialcarenuseryhours,
		c.cd_num_day_hosp hospitalinhomedays,
		null daysclaimed,
		null datefirstaware,
		null datefirstconsultation,
		null standardwardcode,
		null admittingward,
		null admittingunit,
		null standardunitcode,
		null plannedsameday,
		null electivepatientstatusid,
		null qualificationstatusid,
		null dischargeintentionid,
		null totalinvoluntarydays,
		null financialprogram,
		null leaveperiods,
		null drgmentalhealthlegalstatus,
		null noncertifieddaysofstay,
		null specialcarenurserydays,
		null coronarycareunitdays,
		c.nr_quaday_newborns qualifieddaysfornewborns,
		null hithcarecommencement,
		null hithcarecompleteddate,
		null hithcarevisitdays,
		0 palliativecaredays,
		null admissionlegalstatusid,
		null firstpsychadmissionid,
		null usualaccommodationtypeid,
		c.cd_unplanned_theatre unplannedvisitid, --2
		null fundingarrangementid,
		null intentiontoreadmitid,
		null accountclassonadmissionid,
		null accountclassonseparationid,
		null careravailabilityid,
		null criterionforadmissionid,
		null accommocdonseperationid,
		null transmissiondate,
		null reportstatusid,
		null employmentstatusid,
		null prevspecialisedtreatmentid,
		'false' isdeleted,
		null palliativecare,
		null principaldiagpresonadmission,
		a.nr_atendimento encounter_id,
		b.nr_interno_conta nr_account_id,
		get_text_certificate(a.nr_atendimento) certificate_text
FROM atend_categoria_convenio d, conta_paciente b, atendimento_paciente a
LEFT OUTER JOIN hcp_assessment_data c ON (a.nr_atendimento = c.nr_atendimento)
WHERE a.nr_atendimento = b.nr_atendimento  and d.nr_seq_interno	= (	select	/*+ INDEX(Z ATECACO_ATEPACI_FK_I)*/
								coalesce(max(nr_seq_interno),0)
								from 	atend_categoria_convenio z
								where	z.nr_atendimento = a.nr_atendimento
								and 	z.dt_inicio_vigencia	=
									(select	max(x.dt_inicio_vigencia)
									from 	atend_categoria_convenio x
									where 	x.nr_atendimento = a.nr_atendimento));

