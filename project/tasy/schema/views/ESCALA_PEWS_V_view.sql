-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW escala_pews_v (nr_atendimento, fld_nm_first_col_content, fld_nm_second_col_sub_info, fld_nm_chart_tooltip, fld_nm_chart_first_val, fld_nm_chart_seccond_val, fld_nm_third_col_content, fld_nm_second_col_content, fld_nm_sub_content, nr_delta_view) AS select  c.nr_atendimento,
          d.fld_nm_first_col_content,
          d.fld_nm_second_col_sub_info,
          d.fld_nm_chart_first_val || ' - ' || d.fld_nm_chart_seccond_val fld_nm_chart_tooltip,
          d.fld_nm_chart_first_val,
          d.fld_nm_chart_seccond_val,
          coalesce(to_char(d.fld_nm_chart_seccond_val), '--') fld_nm_third_col_content,
          d.fld_nm_second_col_content,
          suep_severidade_pews(d.fld_nm_chart_seccond_val) fld_nm_sub_content,
          d.fld_nm_chart_seccond_val - d.fld_nm_chart_first_val nr_delta_view
  FROM (select b.nr_atendimento from escala_pews b group by b.nr_atendimento) c,
        (select a.nr_sequencia,
            a.nr_atendimento,
            substr(obter_desc_expressao_idioma(314055, null, wheb_usuario_pck.get_nr_seq_idioma), 1, 255) fld_nm_second_col_content,
            null fld_nm_second_col_sub_info,
            obter_pontuacao_telehealth(a.nr_atendimento, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 2) fld_nm_chart_first_val,
            obter_pontuacao_telehealth(a.nr_atendimento, 'escala_pews', 'qt_pontuacao', 'dt_avaliacao', 1) fld_nm_chart_seccond_val,
            a.qt_pontuacao,
            null fld_nm_first_col_content,
            a.dt_avaliacao
        from escala_pews a
    where a.dt_liberacao is not null
    and a.dt_inativacao is null ) d
  where c.nr_atendimento = d.nr_atendimento
  and d.qt_pontuacao = (select max(b.qt_pontuacao) from escala_pews b where b.nr_atendimento = c.nr_atendimento and b.dt_liberacao is not null and b.dt_inativacao is null)
  and d.nr_sequencia = (select max(b.nr_sequencia) from escala_pews b where b.qt_pontuacao = d.qt_pontuacao and b.dt_liberacao is not null and b.dt_inativacao is null);

