-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_aux_deb_nao_relac_v (nm_pessoa, cd_cpf_cnpj, ie_tipo_prestador, nr_titulo, dt_vencimento_atual, dt_contabil, dt_vencimento_original, dt_liquidacao) AS select	obter_nome_pf_pj(t.cd_pessoa_fisica,t.cd_cgc) nm_pessoa,
	      coalesce(f.nr_cpf,t.cd_cgc) cd_cpf_cnpj,
            initcap(select tp.ds_tipo_prestador
            FROM pls_pagamento_prestador x, pls_prestador y
LEFT OUTER JOIN pls_tipo_prestador tp ON (y.nr_seq_tipo_prestador = tp.nr_sequencia)
WHERE x.nr_seq_prestador	=     y.nr_sequencia and x.nr_sequencia		=     t.nr_seq_pls_pag_prest  ) ie_tipo_prestador,
            t.nr_titulo nr_titulo,
            t.dt_vencimento_atual dt_vencimento_atual,
            l.dt_mes_competencia dt_contabil,
            t.dt_vencimento_original dt_vencimento_original,
            t.dt_liquidacao dt_liquidacao
FROM pls_lote_pagamento l, pls_pagamento_prestador a, titulo_pagar t
LEFT OUTER JOIN pessoa_fisica f ON (t.cd_pessoa_fisica = f.cd_pessoa_fisica)
WHERE a.nr_sequencia	      =     t.nr_seq_pls_pag_prest  and l.nr_sequencia	      =     a.nr_seq_lote and (exists (select 1 from pls_protocolo_conta r, pls_conta c, pls_segurado s
                  where r.nr_sequencia = c.nr_seq_protocolo
                  and c.nr_seq_segurado = s.nr_sequencia
                  and s.ie_tipo_segurado in ('T', 'C', 'I')
                  and exists ( select 1
                              from pls_conta_medica_resumo x
                              where x.nr_seq_prestador_pgto = a.nr_seq_prestador
                              and x.nr_seq_lote_pgto = l.nr_sequencia
                              and x.nr_seq_conta = c.nr_sequencia))
                  OR exists (Select 1
                              from Pls_Periodo_Pagamento pgto, pls_evento_regra regra
                              where pgto.nr_sequencia = regra.nr_seq_periodo
                              and regra.ie_tipo_evento = 'G'
                              and regra.nr_seq_periodo = l.nr_seq_periodo
                              and regra.dt_inicio_vigencia <= l.dt_mes_competencia
                              and coalesce(regra.dt_fim_vigencia, l.dt_mes_competencia + 1) >=  l.dt_mes_competencia
                              and Exists (select 1
                                          from pls_rec_glosa_conta glosa, pls_conta conta, pls_segurado seg
                                          where conta.nr_sequencia = glosa.nr_seq_conta
                                          and seg.nr_sequencia = conta.nr_seq_segurado
                                          and seg.ie_tipo_segurado <> 'B'
                                          and exists (select 1 from pls_rec_glosa_proc c, pls_pagamento_prestador d
                                                      where glosa.nr_sequencia = c.nr_seq_conta_rec
                                                      and c.nr_seq_pag_prest = d.nr_sequencia
                                                      and d.nr_sequencia = A.Nr_Sequencia

union all

                                                      select 1 from pls_rec_glosa_mat c, pls_pagamento_prestador d
                                                      where glosa.nr_sequencia = c.nr_seq_conta_rec
                                                      and c.nr_seq_pag_prest = d.nr_sequencia
                                                      and d.nr_sequencia = A.Nr_Sequencia )
                                          and glosa.vl_total_acatado > 0 )
                              )
      ) and t.ie_origem_titulo  in ( 20, 19)
 
union

select	obter_nome_pf_pj(t.cd_pessoa_fisica,t.cd_cgc) nm_pessoa,
            coalesce(f.nr_cpf,t.cd_cgc) cd_cpf_cnpj,
            initcap(	select 	tp.ds_tipo_prestador
            FROM pls_prestador y
LEFT OUTER JOIN pls_tipo_prestador tp ON (y.nr_seq_tipo_prestador = tp.nr_sequencia)
WHERE a.nr_seq_prestador	= y.nr_sequencia  ) ie_tipo_prestador,
            t.nr_titulo,
            t.dt_vencimento_atual,
            l.dt_mes_competencia dt_contabil,
            t.dt_vencimento_original dt_vencimento_original,
            t.dt_liquidacao dt_liquidacao
FROM pls_pp_lote l, pls_pp_prestador a, titulo_pagar t
LEFT OUTER JOIN pessoa_fisica f ON (t.cd_pessoa_fisica = f.cd_pessoa_fisica)
WHERE l.nr_sequencia 		=     a.nr_seq_lote and a.nr_titulo_pagar 	=     t.nr_titulo  and exists (select 1
             from 	pls_protocolo_conta r,
                        pls_conta c,
                        pls_segurado s
            where 	r.nr_sequencia =      c.nr_seq_protocolo
            and 	  c.nr_seq_segurado =   s.nr_sequencia
            and 	  s.ie_tipo_segurado in ('T', 'C', 'I')
            and exists ( 	select 	1
            from 	pls_conta_medica_resumo x,
                  pls_pp_item_lote i
            where 	x.nr_sequencia	= i.nr_seq_resumo
            and	c.nr_sequencia	= i.nr_seq_conta
            and	l.nr_sequencia	= i.nr_seq_lote
            and 	x.nr_seq_conta 	= c.nr_sequencia)
            );

