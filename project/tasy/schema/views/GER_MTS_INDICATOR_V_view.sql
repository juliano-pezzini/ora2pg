-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ger_mts_indicator_v (nr_seq_classificacao, paciente, nr_atendimento, nr_seq_classif, dia_admissao_pa, nr_mes_admissao_pa, mes_admissao_pa, hora_admissao_pa, ano_admissao_pa, classificacao, cd_classificacao, minuto_porta_triagem, minuto_porta_medico, dt_entrada, qt_reclassificassao_calc, minuto_porta_porta, ds_tipo_tratamento, classificado_em_tempo, classificado_fora_tempo, ds_classificado_em_tempo, classificado, qt_reclassificassao) AS select x.NR_SEQ_CLASSIFICACAO,x.PACIENTE,x.NR_ATENDIMENTO,x.NR_SEQ_CLASSIF,x.DIA_ADMISSAO_PA,x.NR_MES_ADMISSAO_PA,x.MES_ADMISSAO_PA,x.HORA_ADMISSAO_PA,x.ANO_ADMISSAO_PA,x.CLASSIFICACAO,x.CD_CLASSIFICACAO,x.MINUTO_PORTA_TRIAGEM,x.MINUTO_PORTA_MEDICO,x.DT_ENTRADA,x.QT_RECLASSIFICASSAO_CALC,x.MINUTO_PORTA_PORTA,x.DS_TIPO_TRATAMENTO ,
        case  
            when cd_classificacao = 'V'  and coalesce(minuto_porta_medico, 0) <=   0 then 1
            when cd_classificacao = 'L'  and coalesce(minuto_porta_medico, 0) <=  10 then 1
            when cd_classificacao = 'A'  and coalesce(minuto_porta_medico, 0) <=  30 then 1
            when cd_classificacao = 'VE' and coalesce(minuto_porta_medico, 0) <=  90 then 1
            when cd_classificacao = 'AZ' and coalesce(minuto_porta_medico, 0) <= 120 then 1
            else 0
        end classificado_em_tempo,
        case  
            when cd_classificacao = 'V'  and coalesce(minuto_porta_medico, 0) >   0 then 1
            when cd_classificacao = 'L'  and coalesce(minuto_porta_medico, 0) >  10 then 1
            when cd_classificacao = 'A'  and coalesce(minuto_porta_medico, 0) >  30 then 1
            when cd_classificacao = 'VE' and coalesce(minuto_porta_medico, 0) >  90 then 1
            when cd_classificacao = 'AZ' and coalesce(minuto_porta_medico, 0) > 120 then 1
            else 0
        end classificado_fora_tempo,
        case  
            when cd_classificacao = 'V'  and coalesce(minuto_porta_medico, 0) <=   0 then 'in time' 
            when cd_classificacao = 'V'  and coalesce(minuto_porta_medico, 0) >    0 then 'not in time' 
            when cd_classificacao = 'L'  and coalesce(minuto_porta_medico, 0) <=  10 then 'in time'
            when cd_classificacao = 'L'  and coalesce(minuto_porta_medico, 0)  >  10 then 'not in time'
            when cd_classificacao = 'A'  and coalesce(minuto_porta_medico, 0) <=  30 then 'in time'
            when cd_classificacao = 'A'  and coalesce(minuto_porta_medico, 0)  >  30 then 'not in time'
            when cd_classificacao = 'VE' and coalesce(minuto_porta_medico, 0) <=  90 then 'in time'
            when cd_classificacao = 'VE' and coalesce(minuto_porta_medico, 0) >   90 then 'not in time'
            when cd_classificacao = 'AZ' and coalesce(minuto_porta_medico, 0) <= 120 then 'in time'
            when cd_classificacao = 'AZ' and coalesce(minuto_porta_medico, 0) >  120 then 'not in time'            
            else 'not classified'
        end ds_classificado_em_tempo,
        case 
            when classificacao is null then 'not classified' 
            else 'Classified' 
        end classificado,
        case 
            when qt_reclassificassao_calc < 0 then 0
            else qt_reclassificassao_calc
        end qt_reclassificassao
    FROM (
    select	a.nr_sequencia                                                              nr_seq_classificacao,
            a.cd_pessoa_fisica                                                          paciente,
            a.nr_atendimento                                                            nr_atendimento,  
            a.nr_seq_classif                                                            nr_seq_classif,
            obter_dia_semana(b.dt_entrada)                                              dia_admissao_pa,
            obter_mes_ano_dt(b.dt_entrada, 'M')                                         nr_mes_admissao_pa,  
            Obter_desc_mes_data(b.dt_entrada, 'D')                                      mes_admissao_pa,
            to_char(b.dt_entrada,'hh24')||':00'                                         hora_admissao_pa,
            to_char(b.dt_entrada,'yyyy')                                                ano_admissao_pa,
            obter_valor_dominio(6673, obter_classific_manchester(nr_seq_classif))       classificacao,
            obter_classific_manchester(nr_seq_classif)                                  cd_classificacao,
            obter_min_entre_datas_null(b.dt_entrada, a.dt_inicio_triagem, 1)            minuto_porta_triagem,
            obter_min_entre_datas_null(b.dt_entrada, b.dt_atend_medico, 1)              minuto_porta_medico,
            b.dt_entrada                                                                dt_entrada,
            (select count(1) 
            from triagem_pronto_atend x 
            where a.nr_atendimento = x.nr_atendimento 
             and obter_classific_manchester(a.nr_seq_classif) is not null
             and obter_classific_manchester(x.nr_seq_classif)  is not null) -1          qt_reclassificassao_calc,
            --10 Number of secondary triage within timeout in percent 
            obter_min_entre_datas_null(b.dt_entrada, b.dt_alta, 1)                      minuto_porta_porta,
            --13 Type of treatment of patients after completion of treatment in ED, differentiated accord-ing to urgency, sorting criteria outpatient / inpatient / other
            obter_info_desfecho(a.nr_atendimento)                                       ds_tipo_tratamento
    from    triagem_pronto_atend a
    left outer join atendimento_paciente b on a.nr_atendimento = b.nr_atendimento
    ) x;

