-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW sla_information_v (ds_type, ie_type, opened_defects, reclassified_defects, response_breached, resolution_breached, sla_achievement, qt_meta, generate_date) AS select	'SLA with penalty' ds_type,
			'SWP' ie_type,
			sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END ) opened_defects,
			sum(CASE WHEN ie_indicador=2 THEN 1  ELSE 0 END ) reclassified_defects,
			sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END ) RESPONSE_BREACHED,
			sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ) resolution_breached,
			(100-dividir(((sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END )+sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ))*100),(sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END )*2))) sla_achievement,
			obter_meta_bsc_sla(2627,extract_date) qt_meta,
			trunc(extract_date, 'month') generate_date
FROM		sla_information_v2
where	1 = 1
and		develop_management_id <> 68
and	sla_detail in ('CSFP', 'COSP')
group by	'SWP',obter_meta_bsc_sla(2627,extract_date), trunc(extract_date, 'month')

union all

select	'SLA with contract' ds_type,
			'SWC' ie_type,
			sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END ) opened_defects,
			sum(CASE WHEN ie_indicador=2 THEN 1  ELSE 0 END ) reclassified_defects,
			sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END ) RESPONSE_BREACHED,
			sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ) resolution_breached,
			(100-dividir(((sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END )+sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ))*100),(sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END )*2))) sla_achievement,
			obter_meta_bsc_sla(2628,extract_date) qt_meta,
			trunc(extract_date, 'month') generate_date
from		sla_information_v2
where	1 = 1
and		develop_management_id <> 68
and		sla_detail in ('CSFNP', 'COSNP', 'CSFP', 'COSP')
group by	'SWC', obter_meta_bsc_sla(2628,extract_date), trunc(extract_date, 'month')

union all

select	'All SLAs' ds_type,
			'ASLA' ie_type,
			sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END ) opened_defects,
			sum(CASE WHEN ie_indicador=2 THEN 1  ELSE 0 END ) reclassified_defects,
			sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END ) RESPONSE_BREACHED,
			sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ) resolution_breached,
			(100-dividir(((sum(CASE WHEN ie_indicador=3 THEN 1  ELSE 0 END )+sum(CASE WHEN ie_indicador=4 THEN 1  ELSE 0 END ))*100),(sum(CASE WHEN ie_indicador=1 THEN 1  ELSE 0 END )*2))) sla_achievement,
			obter_meta_bsc_sla(2637,extract_date) qt_meta,
			trunc(extract_date, 'month') generate_date
from		sla_information_v2 a
where	1 = 1
and		develop_management_id <> 68
group by	'ASLA', trunc(extract_date, 'month'), obter_meta_bsc_sla(2637,extract_date)

union all

select	'Official BSC indicator' ds_type,
	'OBI' ie_type,
	OBTER_TOTAIS_SLA_INFORMATION(trunc(a.extract_date, 'month'),'OPENED_DEFECTS') OPENED_DEFECTS, 	
	sum(CASE WHEN customer_classification=philips_classification THEN  0  ELSE 1 END ) RECLASSIFIED_DEFECTS,
	OBTER_TOTAIS_SLA_INFORMATION(trunc(a.extract_date, 'month'),'RESPONSE_BREACHED') RESPONSE_BREACHED,
	OBTER_TOTAIS_SLA_INFORMATION(trunc(a.extract_date, 'month'),'RESOLUTION_BREACHED') RESOLUTION_BREACHED,
	obter_resultado_sla(trunc(extract_date,'month'),fim_mes(extract_date),null) sla_achievement,  
	obter_meta_bsc_sla(852,extract_date) qt_meta,
	trunc(extract_date, 'month') generate_date
from	sla_informations a
where	1 = 1
group by 'OBI', trunc(extract_date, 'month'), fim_mes(extract_date), obter_meta_bsc_sla(852,extract_date)
order by ds_type desc;

