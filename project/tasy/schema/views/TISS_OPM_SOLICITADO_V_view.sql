-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_opm_solicitado_v (ds_versao, ie_origem, cd_material, ds_procedimento, qt_solicitada, qt_autorizada, nr_sequencia_autor, cd_edicao_amb, cd_procedimento_convenio, cd_edicao_relat, cd_cgc_fabricante, nr_prescricao, vl_unitario, ds_fabricante) AS select	/*+ INDEX (D AUTCONV_PK) */ '2.01.01' ds_versao,
	'AC' ie_origem,
	a.cd_material,
	substr(coalesce(a.ds_mat_convenio, obter_desc_material(a.cd_material)),1,60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	a.nr_sequencia_autor,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(null, a.cd_material, c.cd_estabelecimento, b.cd_convenio, b.cd_categoria, null, d.dt_autorizacao,null,'X',null,null, a.cd_material_tuss),1,20) cd_edicao_amb,
	lpad(CASE WHEN a.cd_material_convenio=0 THEN a.cd_material WHEN a.cd_material_convenio IS NULL THEN a.cd_material  ELSE a.cd_material_convenio END ,10,'0') cd_procedimento_convenio,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(null, a.cd_material, c.cd_estabelecimento, b.cd_convenio, b.cd_categoria, null,  d.dt_autorizacao,null,'R',null,null, a.cd_material_tuss),1,20) cd_edicao_relat,
	a.cd_cgc_fabricante,
	(null)::numeric  nr_prescricao,
	a.vl_unitario,
	substr(OBTER_DESC_FABRIC_MAT(a.nr_seq_fabricante),1,255) ds_fabricante
FROM	classe_material f,
	material e,
	material_autorizado a,
	atend_categoria_convenio b,
	atendimento_paciente c,
	autorizacao_convenio d
where	d.nr_atendimento				= c.nr_atendimento
and	c.nr_atendimento				= b.nr_atendimento
and	obter_atecaco_atendimento(b.nr_atendimento) 	= b.nr_seq_interno
and	a.nr_sequencia_autor			= d.nr_sequencia
and	a.cd_material				= e.cd_material
and	e.cd_classe_material			= f.cd_classe_material
and	f.ie_tipo_classe				in ('O','P','M')

union

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	a.cd_material,
	substr(coalesce(a.ds_mat_convenio, obter_desc_material(a.cd_material)),1,60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	a.nr_sequencia_autor,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(a.ie_origem_preco, a.cd_material, coalesce(d.cd_estabelecimento,c.cd_estabelecimento), b.cd_convenio, b.cd_categoria, null, d.dt_autorizacao,null,'X',null,null, a.cd_material_tuss),1,20) cd_edicao_amb,
	lpad(CASE WHEN a.cd_material_convenio=0 THEN a.cd_material WHEN a.cd_material_convenio IS NULL THEN a.cd_material  ELSE a.cd_material_convenio END ,10,'0') cd_procedimento_convenio,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(a.ie_origem_preco, a.cd_material, coalesce(d.cd_estabelecimento,c.cd_estabelecimento), b.cd_convenio, b.cd_categoria, null, d.dt_autorizacao,null,'R',null,null, a.cd_material_tuss),1,20) cd_edicao_relat,
	a.cd_cgc_fabricante,
	(null)::numeric  nr_prescricao,
	a.vl_unitario,
	substr(OBTER_DESC_FABRIC_MAT(a.nr_seq_fabricante),1,255) ds_fabricante
from	classe_material f,
	material e,
	material_autorizado a,
	autorizacao_convenio d,
	agenda_paciente b,
	agenda c
where	c.cd_agenda				= b.cd_agenda
and	b.nr_sequencia				= d.nr_seq_agenda
and	a.nr_sequencia_autor			= d.nr_sequencia
and	a.cd_material				= e.cd_material
and	e.cd_classe_material			= f.cd_classe_material
and	f.ie_tipo_classe				in ('O','P','M')
and	d.nr_atendimento is null

union

select	'2.01.01' ds_versao,
	'RE' ie_origem,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,60) ds_procedimento,
	a.qt_dose,
	a.qt_dose,
	(null)::numeric  nr_sequencia_autor,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(null, a.cd_material, c.cd_estabelecimento, b.cd_convenio, b.cd_categoria, null, LOCALTIMESTAMP,null,'X',null,null),1,20) cd_edicao_amb,
	lpad(a.cd_material,10,'0') cd_procedimento_convenio,
	substr(TISS_OBTER_ORIGEM_PRECO_MAT(null, a.cd_material, c.cd_estabelecimento, b.cd_convenio, b.cd_categoria, null, LOCALTIMESTAMP,null,'R',null,null),1,20) cd_edicao_relat,
	null cd_cgc_fabricante,
	a.nr_prescricao,
	(null)::numeric  vl_unitario,
	null ds_fabricante
from	atendimento_paciente c,
	atend_categoria_convenio b,
	prescr_medica x,
	classe_material f,
	material e,
	prescr_material a
where	x.nr_atendimento				= b.nr_atendimento
and	x.nr_prescricao				= a.nr_prescricao
and	b.nr_atendimento				= c.nr_atendimento
and	e.cd_classe_material			= f.cd_classe_material
and	f.ie_tipo_classe				in ('O','P','M')
and	a.cd_material				= e.cd_material
and	obter_atecaco_atendimento(b.nr_atendimento) 	= b.nr_seq_interno;

