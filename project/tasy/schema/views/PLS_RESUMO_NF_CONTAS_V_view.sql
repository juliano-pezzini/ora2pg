-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_nf_contas_v (cd_conta, vl_credito, vl_debito, dt_referencia) AS select	cd_conta,
	sum(vl_credito) vl_credito,
	sum(vl_debito) vl_debito,
	dt_referencia
FROM (
	select	d.cd_conta_rec cd_conta,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN abs(d.vl_item)  ELSE 0 END  vl_credito,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN 0  ELSE abs(d.vl_item) END  vl_debito,
		trunc(f.dt_lote,'month') dt_referencia
	from	pls_mensalidade_seg_item	d,
		pls_mensalidade_segurado	c,
		pls_mensalidade			b,
		pls_lote_mensalidade		a,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.ie_tipo_item	<> '3'
	and	not exists (	select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= d.ie_tipo_item)
	and	c.dt_mesano_referencia = trunc(f.dt_lote,'month')
	
UNION ALL

	select	f.cd_conta_cred cd_conta,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN abs(d.vl_item)  ELSE 0 END  vl_credito,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN 0  ELSE abs(d.vl_item) END  vl_debito,
		trunc(h.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_conta			e,
		pls_conta_coparticipacao	f,
		pls_lote_nf_mens_item		g,
		pls_lote_nf_mensalidade		h
	where	g.nr_seq_lote	= h.nr_sequencia
	and	b.nr_sequencia	= g.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.nr_seq_conta	= e.nr_sequencia
	and	e.nr_sequencia	= f.nr_seq_conta
	and	d.ie_tipo_item	= '3'
	and	c.dt_mesano_referencia = trunc(h.dt_lote,'month')
	
UNION ALL

	select	d.cd_conta_rec_antecip cd_conta,
		CASE WHEN d.vl_antecipacao=abs(d.vl_antecipacao) THEN abs(d.vl_antecipacao)  ELSE 0 END  vl_credito,
		CASE WHEN d.vl_antecipacao=abs(d.vl_antecipacao) THEN 0  ELSE abs(d.vl_antecipacao) END  vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.vl_antecipacao <> 0
	and	a.dt_contabilizacao is null
	and	c.dt_mesano_referencia = trunc(f.dt_lote,'month')
	
UNION ALL

	select	d.cd_conta_rec_antecip cd_conta,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN abs(d.vl_item)  ELSE 0 END  vl_credito,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN 0  ELSE abs(d.vl_item) END  vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	a.dt_contabilizacao = trunc(f.dt_lote,'month')
	
UNION ALL

	select	d.cd_conta_rec cd_conta,
		CASE WHEN d.vl_pro_rata_dia=abs(d.vl_pro_rata_dia) THEN abs(d.vl_pro_rata_dia)  ELSE 0 END  vl_credito,
		CASE WHEN d.vl_pro_rata_dia=abs(d.vl_pro_rata_dia) THEN 0  ELSE abs(d.vl_pro_rata_dia) END  vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.vl_pro_rata_dia <> 0
	and	exists (select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= d.ie_tipo_item)
	and	c.dt_mesano_referencia = trunc(f.dt_lote,'month')
	
UNION ALL

	select	d.cd_conta_deb cd_conta,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN 0  ELSE abs(d.vl_item) END  vl_credito,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN abs(d.vl_item)  ELSE 0 END  vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.ie_tipo_item	<> '3'
	and	coalesce(a.dt_contabilizacao,c.dt_mesano_referencia) = trunc(f.dt_lote,'month')
	
UNION ALL

	select	f.cd_conta_deb cd_conta,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN 0  ELSE abs(f.vl_coparticipacao) END  vl_credito,
		CASE WHEN d.vl_item=abs(d.vl_item) THEN abs(f.vl_coparticipacao)  ELSE 0 END  vl_debito,
		trunc(h.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_conta			e,
		pls_conta_coparticipacao	f,
		pls_lote_nf_mens_item		g,
		pls_lote_nf_mensalidade		h
	where	g.nr_seq_lote	= h.nr_sequencia
	and	b.nr_sequencia	= g.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.nr_seq_conta	= e.nr_sequencia
	and	e.nr_sequencia	= f.nr_seq_conta
	and	d.ie_tipo_item	= '3'
	and	c.dt_mesano_referencia = trunc(h.dt_lote,'month')
	
union all
 /* Lepinski - in√≠cio contas imposto */
	select  substr(pls_obter_conta_imposto('C',b.nr_sequencia,a.cd_estabelecimento),1,255) cd_conta,
		coalesce(e.vl_tributo,0) vl_credito,
		0 vl_debito,
		trunc(g.dt_lote,'month')
	FROM pls_lote_nf_mensalidade g, pls_lote_nf_mens_item f, pls_lote_mensalidade a, pls_mensalidade b
LEFT OUTER JOIN titulo_receber c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN nota_fiscal d ON (b.nr_sequencia = d.nr_seq_mensalidade)
LEFT OUTER JOIN nota_fiscal_trib e ON (d.nr_sequencia = e.nr_sequencia)
WHERE f.nr_seq_lote	= g.nr_sequencia and b.nr_sequencia	= f.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote    and e.vl_tributo <> 0 and b.dt_referencia = trunc(g.dt_lote,'month')
	
union all

	select  substr(pls_obter_conta_imposto('D',b.nr_sequencia,a.cd_estabelecimento),1,255) cd_conta,
		0 vl_credito,
		coalesce(e.vl_tributo,0) vl_debito,
		trunc(g.dt_lote,'month')
	FROM pls_lote_nf_mensalidade g, pls_lote_nf_mens_item f, pls_lote_mensalidade a, pls_mensalidade b
LEFT OUTER JOIN titulo_receber c ON (b.nr_sequencia = c.nr_seq_mensalidade)
LEFT OUTER JOIN nota_fiscal d ON (b.nr_sequencia = d.nr_seq_mensalidade)
LEFT OUTER JOIN nota_fiscal_trib e ON (d.nr_sequencia = e.nr_sequencia)
WHERE f.nr_seq_lote	= g.nr_sequencia and b.nr_sequencia	= f.nr_seq_mensalidade and a.nr_sequencia			= b.nr_seq_lote    and e.vl_tributo <> 0 and b.dt_referencia = trunc(g.dt_lote,'month') /* Lepinski - fim contas imposto */
 
union all

	select	d.cd_conta_rec_antecip cd_conta,
		0 vl_credito,
		d.vl_antecipacao vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.vl_antecipacao <> 0
	and	d.dt_antecipacao = trunc(f.dt_lote,'month')
	
union all

	select	d.cd_conta_deb_antecip cd_conta,
		0 vl_credito,
		d.vl_pro_rata_dia vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and     a.dt_contabilizacao is not null
	and	d.vl_pro_rata_dia <> 0
	and	c.dt_mesano_referencia = trunc(f.dt_lote,'month')
	
union all

	select	d.cd_conta_rec cd_conta,
		d.vl_antecipacao vl_credito,
		0 vl_debito,
		trunc(f.dt_lote,'month')
	from	pls_lote_mensalidade		a,
		pls_mensalidade			b,
		pls_mensalidade_segurado	c,
		pls_mensalidade_seg_item	d,
		pls_lote_nf_mens_item		e,
		pls_lote_nf_mensalidade		f
	where	e.nr_seq_lote	= f.nr_sequencia
	and	b.nr_sequencia	= e.nr_seq_mensalidade
	and	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_sequencia	= d.nr_seq_mensalidade_seg
	and	d.vl_antecipacao <> 0
	and	d.dt_antecipacao = trunc(f.dt_lote,'month')
) alias63
group by cd_conta, dt_referencia;

