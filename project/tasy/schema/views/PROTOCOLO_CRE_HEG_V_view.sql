-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW protocolo_cre_heg_v (cd_empresa, cd_filial, nr_interno_conta, nr_seq_protocolo, dt_emissao, cd_cliente, dt_vencimento, ds_observacao, cd_setor_atendimento, nr_cpf, nm_cliente, nr_cpf_medico, vl_movimento) AS select	d.cd_estabelecimento cd_empresa,
	d.cd_estabelecimento cd_filial, 
	c.nr_interno_conta,	 
	a.nr_seq_protocolo, 
   	coalesce(a.dt_entrega_convenio, a.dt_mesano_referencia) dt_emissao, 
	d.cd_pessoa_fisica cd_cliente, 
	a.dt_vencimento, 
	to_char(d.dt_entrada,'ddmmyyyy') || '-' || p.nm_pessoa_fisica ds_observacao, 
	substr(obter_unidade_atendimento(d.nr_atendimento, 'A', 'CS'),1,5) cd_setor_atendimento, 
	p.nr_cpf, 
	p.nm_pessoa_fisica nm_cliente, 
	m.nr_cpf nr_cpf_medico, 
   	sum(e.vl_guia) vl_movimento 
FROM 	pessoa_fisica m, 
	pessoa_fisica p, 
	Conta_Paciente_Guia e, 
   	Atendimento_Paciente d, 
	conta_paciente c, 
 	Convenio b, 
	protocolo_convenio a    
where 	a.cd_convenio			= b.cd_convenio 
and	a.nr_seq_protocolo      	= c.nr_seq_protocolo 
and  	c.nr_interno_conta      	= e.nr_interno_conta 
and	c.nr_atendimento		= d.nr_atendimento 
and	d.cd_pessoa_fisica		= p.cd_pessoa_fisica 
and	d.cd_medico_resp		= m.cd_pessoa_fisica 
group by 
	d.cd_estabelecimento, 
	d.cd_estabelecimento, 
	c.nr_interno_conta,	 
   	coalesce(a.dt_entrega_convenio, a.dt_mesano_referencia), 
	d.cd_pessoa_fisica, 
	a.nr_seq_protocolo, 
	a.dt_vencimento, 
	to_char(d.dt_entrada,'ddmmyyyy') || '-' || p.nm_pessoa_fisica, 
	substr(obter_unidade_atendimento(d.nr_atendimento, 'A', 'CS'),1,5), 
	p.nr_cpf, 
	p.nm_pessoa_fisica, 
	m.nr_cpf;

