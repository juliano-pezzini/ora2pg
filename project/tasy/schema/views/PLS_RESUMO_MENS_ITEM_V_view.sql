-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_mens_item_v (ie_reg, dt_mesano_referencia, ds_item, vl_item_individual, vl_item_coletivo, vl_item_cancelado_individual, vl_item_cancelado_coletivo, vl_item_cancelado, vl_item_estorno, vl_item_estorno_individual, vl_item_estorno_coletivo, vl_antec_estorno, vl_antec_estorno_individual, vl_antec_estorno_coletivo, vl_aberto, vl_pro_rata_dia, vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao, vl_antec_pro_rata_individual, vl_antec_pro_rata_coletivo, vl_antecipacao_individual, vl_antecipacao_coletivo, vl_antec_rata_ant_individual, vl_antec_rata_ant_coletivo, cd_estabelecimento) AS select	1 ie_reg,
	dt_mesano_referencia,
	ds_item,
	sum(vl_item_individual) 			vl_item_individual,
	sum(vl_item_coletivo) 				vl_item_coletivo,
	sum(vl_item_cancelado_individual) 		vl_item_cancelado_individual,
	sum(vl_item_cancelado_coletivo) 		vl_item_cancelado_coletivo,
	sum(vl_item_cancelado)				vl_item_cancelado,
	sum(vl_item_estorno)				vl_item_estorno,
	sum(vl_item_estorno_individual) 		vl_item_estorno_individual,
	sum(vl_item_estorno_coletivo) 			vl_item_estorno_coletivo,
	sum(vl_antec_estorno)				vl_antec_estorno,
	sum(vl_antec_estorno_individual) 		vl_antec_estorno_individual,
	sum(vl_antec_estorno_coletivo) 			vl_antec_estorno_coletivo,
	sum(vl_aberto) 					vl_aberto,
	sum(vl_pro_rata_dia) 				vl_pro_rata_dia,
	sum(vl_pro_rata_individual) 			vl_pro_rata_individual,
	sum(vl_pro_rata_coletivo) 			vl_pro_rata_coletivo,
	sum(vl_antecipacao) 				vl_antecipacao,
	sum(vl_antec_pro_rata_individual)		vl_antec_pro_rata_individual,
	sum(vl_antec_pro_rata_coletivo)			vl_antec_pro_rata_coletivo,
	sum(vl_antecipacao_individual) 			vl_antecipacao_individual,
	sum(vl_antecipacao_coletivo) 			vl_antecipacao_coletivo,
	sum(vl_antec_rata_ant_individual)		vl_antec_rata_ant_individual,
	sum(vl_antec_rata_ant_coletivo)			vl_antec_rata_ant_coletivo,
	cd_estabelecimento
FROM (	select	b.dt_mesano_referencia dt_mesano_referencia,
		substr(obter_valor_dominio(1930,a.ie_tipo_item),1,55) ds_item,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END ) vl_item_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END ) vl_antec_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN abs(a.vl_item) END   ELSE 0 END ) vl_aberto,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END ) vl_pro_rata_dia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antecipacao,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	exists (select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	a.ie_tipo_item,
			b.dt_mesano_referencia,
			f.cd_estabelecimento
	
UNION ALL

	select	b.dt_mesano_referencia dt_mesano_referencia,
		substr(obter_valor_dominio(1930,a.ie_tipo_item),1,55) ds_item,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END ) vl_antec_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN abs(a.vl_item) END   ELSE 0 END ) vl_aberto,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END ) vl_pro_rata_dia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antecipacao,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	not exists (	select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	a.ie_tipo_item,
			b.dt_mesano_referencia,
			f.cd_estabelecimento
	
union all

	select	trunc(f.dt_contabilizacao,'month') dt_mesano_referencia,
		substr(obter_valor_dominio(1930,a.ie_tipo_item),1,55) ds_item,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado_individual,
		0 vl_item_cancelado_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_item_estorno_individual,
		0 vl_item_estorno_coletivo,
		0 vl_antec_estorno,
		0 vl_antec_estorno_individual,
		0 vl_antec_estorno_coletivo,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_pro_rata_individual,
		0 vl_pro_rata_coletivo,
		0 vl_antecipacao,
		0 vl_antec_pro_rata_individual,
		0 vl_antec_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_antecipacao_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	group by	a.ie_tipo_item,
			trunc(f.dt_contabilizacao,'month'),
			f.cd_estabelecimento
	
union all

	select	trunc(add_months(b.dt_mesano_referencia,1),'month') dt_mesano_referencia,
		substr(obter_valor_dominio(1930,a.ie_tipo_item),1,55) ds_item,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado_individual,
		0 vl_item_cancelado_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_item_estorno_individual,
		0 vl_item_estorno_coletivo,
		0 vl_antec_estorno,
		0 vl_antec_estorno_individual,
		0 vl_antec_estorno_coletivo,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_pro_rata_individual,
		0 vl_pro_rata_coletivo,
		0 vl_antecipacao,
		0 vl_antec_pro_rata_individual,
		0 vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao)  ELSE 0 END   ELSE 0 END ) vl_antec_rata_ant_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao)  ELSE 0 END   ELSE 0 END ) vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	e.ie_cancelamento is null
	group by	a.ie_tipo_item,
			trunc(add_months(b.dt_mesano_referencia,1),'month'),
			f.cd_estabelecimento) alias134
group by	dt_mesano_referencia,
		ds_item,
		cd_estabelecimento

UNION ALL

/* Lepinski - Comentado pois n√£o tem mais item para o pagador
select	2 ie_reg,
	e.dt_referencia dt_mesano_referencia,
	substr(obter_valor_dominio(1930,a.ie_tipo_item),1,55)||'/ destacado' ds_item,
	sum(decode(d.ie_tipo_contratacao,'I',abs(a.vl_item))) vl_item_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',abs(a.vl_item))) vl_item_coletivo,
	sum(decode(d.ie_tipo_contratacao,'I',decode(e.ie_cancelamento,'C',abs(a.vl_item)),0)) vl_item_cancelado_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',decode(e.ie_cancelamento,'C',abs(a.vl_item)),0)) vl_item_cancelado_coletivo,
	sum(decode(e.ie_cancelamento,'C',abs(a.vl_item))) vl_item_cancelado,
	sum(decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',abs(a.vl_pro_rata_dia),'12',abs(a.vl_pro_rata_dia),abs(a.vl_item)))) vl_item_estorno,
	sum(decode(d.ie_tipo_contratacao,'I',decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',abs(a.vl_pro_rata_dia),'12',abs(a.vl_pro_rata_dia),abs(a.vl_item))),0)) vl_item_estorno_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',abs(a.vl_pro_rata_dia),'12',abs(a.vl_pro_rata_dia),abs(a.vl_item))),0)) vl_item_estorno_coletivo,
	sum(decode(d.ie_tipo_contratacao,'I',decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',abs(a.vl_antecipacao),'12',abs(a.vl_antecipacao))),0)) vl_antec_estorno_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',decode(e.ie_cancelamento,'E',decode(a.ie_tipo_item,'1',abs(a.vl_antecipacao),'12',abs(a.vl_antecipacao))),0)) vl_antec_estorno_coletivo,
	sum(decode(e.ie_cancelamento,'E',decode(f.dt_contabilizacao,null,abs(a.vl_antecipacao),0))) vl_antec_estorno,
	sum(decode(f.ie_status,'3',abs(a.vl_item))) vl_aberto,
	sum(abs(a.vl_pro_rata_dia)) vl_pro_rata_dia,
	sum(decode(d.ie_tipo_contratacao,'I',abs(a.vl_pro_rata_dia))) vl_pro_rata_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',abs(a.vl_pro_rata_dia))) vl_pro_rata_coletivo,
	sum(abs(a.vl_antecipacao)) vl_antecipacao,
	sum(decode(d.ie_tipo_contratacao,'I',abs(a.vl_antecipacao))) vl_antecipacao_individual,
	sum(decode(substr(d.ie_tipo_contratacao,1,1),'C',abs(a.vl_antecipacao))) vl_antecipacao_coletivo,
	f.cd_estabelecimento
from	pls_mensalidade_seg_item 	a,
	pls_contrato_pagador		b,
	pls_contrato			c,
	pls_plano               	d,
	pls_mensalidade         	e,
	pls_lote_mensalidade    	f
where	a.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	e.nr_seq_pagador	= b.nr_sequencia
and	b.nr_seq_contrato	= c.nr_sequencia
and	d.nr_sequencia		= (	select	max(nr_seq_plano)
					from	pls_contrato_plano x
					where	x.nr_seq_contrato = c.nr_sequencia
					and	x.ie_situacao		= 'A')
and	a.nr_seq_mensalidade_seg is null
and	a.ie_tipo_item  = '17'
group by	a.ie_tipo_item,
		e.dt_referencia,
		f.cd_estabelecimento
UNION ALL*/
select	3 ie_reg,
	dt_mes_competencia dt_mesano_referencia,
	'' ds_item,
	0 vl_item_individual,
	0 vl_item_coletivo,
	0 vl_item_cancelado_individual,
	0 vl_item_cancelado_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,
	0 vl_item_estorno_individual,
	0 vl_item_estorno_coletivo,
	0 vl_antec_estorno,
	0 vl_antec_estorno_individual,
	0 vl_antec_estorno_coletivo,
	0 vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_pro_rata_individual,
	0 vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	cd_estabelecimento
from	pls_competencia

UNION ALL

select	4 ie_reg,
	dt_mesano_referencia,
	'Total' ds_item,
	sum(vl_item_individual) vl_item_individual,
	sum(vl_item_coletivo) vl_item_coletivo,
	sum(vl_item_cancelado_individual) vl_item_cancelado_individual,
	sum(vl_item_cancelado_coletivo) vl_item_cancelado_coletivo,
	sum(vl_item_cancelado)	vl_item_cancelado,
	sum(vl_item_estorno) vl_item_estorno,
	sum(vl_item_estorno_individual) vl_item_estorno_individual,
	sum(vl_item_estorno_coletivo) vl_item_estorno_coletivo,
	sum(vl_antec_estorno) vl_antec_estorno,
	sum(vl_antec_estorno_individual) vl_antec_estorno_individual,
	sum(vl_antec_estorno_coletivo) vl_antec_estorno_coletivo,
	sum(vl_aberto) vl_aberto,
	sum(vl_pro_rata_dia) vl_pro_rata_dia,
	sum(vl_pro_rata_individual) vl_pro_rata_individual,
	sum(vl_pro_rata_coletivo) vl_pro_rata_coletivo,
	sum(vl_antecipacao) vl_antecipacao,
	sum(vl_antec_pro_rata_individual) vl_antec_pro_rata_individual,
	sum(vl_antec_pro_rata_coletivo) vl_antec_pro_rata_coletivo,
	sum(vl_antecipacao_individual) vl_antecipacao_individual,
	sum(vl_antecipacao_coletivo) vl_antecipacao_coletivo,
	sum(vl_antec_rata_ant_individual) vl_antec_rata_ant_individual,
	sum(vl_antec_rata_ant_coletivo) vl_antec_rata_ant_coletivo,
	cd_estabelecimento
from (	select	b.dt_mesano_referencia dt_mesano_referencia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END ) vl_item_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END ) vl_antec_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN abs(a.vl_item) END   ELSE 0 END ) vl_aberto,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END ) vl_pro_rata_dia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antecipacao,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	exists (select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	b.dt_mesano_referencia,
			f.cd_estabelecimento
	
UNION ALL

	select	b.dt_mesano_referencia dt_mesano_referencia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END   ELSE 0 END ) vl_item_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN abs(a.vl_item) END   ELSE 0 END ) vl_aberto,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_pro_rata_dia)  ELSE 0 END ) vl_pro_rata_dia,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antecipacao,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	not exists (	select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
	group by	b.dt_mesano_referencia,
			f.cd_estabelecimento
	
union all

	select	trunc(f.dt_contabilizacao,'month') dt_mesano_referencia,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado_individual,
		0 vl_item_cancelado_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_item_estorno_individual,
		0 vl_item_estorno_coletivo,
		0 vl_antec_estorno,
		0 vl_antec_estorno_individual,
		0 vl_antec_estorno_coletivo,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_pro_rata_individual,
		0 vl_pro_rata_coletivo,
		0 vl_antecipacao,
		0 vl_antec_pro_rata_individual,
		0 vl_antec_pro_rata_coletivo,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_antecipacao_individual,
		sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_antecipacao_coletivo,
		0 vl_antec_rata_ant_individual,
		0 vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	group by	trunc(f.dt_contabilizacao,'month'),
			f.cd_estabelecimento
	
union all

	select	trunc(add_months(b.dt_mesano_referencia,1),'month') dt_mesano_referencia,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado_individual,
		0 vl_item_cancelado_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_item_estorno_individual,
		0 vl_item_estorno_coletivo,
		0 vl_antec_estorno,
		0 vl_antec_estorno_individual,
		0 vl_antec_estorno_coletivo,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_pro_rata_individual,
		0 vl_pro_rata_coletivo,
		0 vl_antecipacao,
		0 vl_antec_pro_rata_individual,
		0 vl_antec_pro_rata_coletivo,
		0 vl_antecipacao_individual,
		0 vl_antecipacao_coletivo,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao)  ELSE 0 END   ELSE 0 END ) vl_antec_rata_ant_individual,
		sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao)  ELSE 0 END   ELSE 0 END ) vl_antec_rata_ant_coletivo,
		f.cd_estabelecimento
	from	pls_mensalidade_seg_item 	a,
		pls_mensalidade_segurado 	b,
		pls_segurado			c,
		pls_plano			d,
		pls_mensalidade			e,
		pls_lote_mensalidade		f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_segurado = c.nr_sequencia
	and	c.nr_seq_plano = d.nr_sequencia
	and	b.nr_seq_mensalidade = e.nr_sequencia
	and	e.nr_seq_lote = f.nr_sequencia
	and	e.ie_cancelamento is null
	group by	a.ie_tipo_item,
			trunc(add_months(b.dt_mesano_referencia,1),'month'),
			f.cd_estabelecimento) alias260
group by	dt_mesano_referencia,
		cd_estabelecimento;

