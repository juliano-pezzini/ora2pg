-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_clinica_v (cd_estabelecimento, dt_referencia, ie_clinica, nm_clinica, ie_periodo, nr_unidades_setor, qt_disponiveis, nr_leitos_ocupados, nr_leitos_livres, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, nr_dias_periodo, cd_medico, nm_medico, cd_setor_atendimento, ie_tipo_atendimento, ie_clinica_alta, nr_seq_origem, ie_sexo, cd_cid_principal, ie_tipo_convenio, qt_hora_alta, cd_procedencia, cd_tipo_acomodacao, hr_alta, ie_temp, cd_convenio) AS SELECT 	A.cd_estabelecimento,
		A.DT_REFERENCIA, 
		A.ie_clinica, 
		obter_valor_dominio(17,A.ie_clinica) nm_clinica, 
		A.IE_PERIODO, 
		count(*) NR_UNIDADES_SETOR, 
		sum(CASE WHEN Obter_Se_Leito_Disp(A.cd_setor_atendimento, A.cd_unidade_basica, A.cd_unidade_compl)='S' THEN  1  ELSE 0 END ) qt_disponiveis, 
    	SUM(CASE WHEN A.IE_SITUACAO='P' THEN NR_PACIENTES  ELSE 0 END ) NR_LEITOS_OCUPADOS, 
		SUM(coalesce(QT_LEITO_LIVRE,0)) NR_LEITOS_Livres, 
    	SUM(NR_ADMISSOES) NR_ADMISSOES, 
    	SUM(NR_ALTAS) NR_ALTAS, 
    	SUM(NR_OBITOS) NR_OBITOS, 
    	SUM(NR_TRANSF_ENTRADA) NR_TRANSF_ENTRADA, 
    	SUM(NR_TRANSF_SAIDA) NR_TRANSF_SAIDA, 
	    	avg(CASE WHEN A.IE_PERIODO='M' THEN  (TO_CHAR(LAST_DAY(A.DT_REFERENCIA),'DD'))::numeric   ELSE 1 END ) NR_DIAS_PERIODO, 
		A.cd_medico, 
		obter_nome_medico(A.cd_medico, 'N') nm_medico, 
		A.cd_setor_atendimento, 
		A.ie_tipo_atendimento, 
		A.ie_clinica_alta, 
		A.nr_seq_origem, 
		obter_sexo_pf(A.cd_pessoa_fisica,'C') ie_sexo, 
		A.cd_cid_principal, 
		obter_tipo_convenio(A.cd_convenio) ie_tipo_convenio, 
		to_char(A.hr_alta,'00') qt_hora_alta, 
		A.cd_procedencia, 
		A.cd_tipo_acomodacao, 
		A.hr_alta, 
		substr(Obter_Se_Unidade_Temp(A.cd_setor_atendimento, A.dt_referencia, A.cd_unidade_basica, A.cd_unidade_compl),1,1) ie_temp, 
		A.cd_convenio 
FROM  	EIS_OCUPACAO_HOSPITALAR A 
WHERE 	1 = 1 
GROUP BY 	A.cd_estabelecimento, 
		A.DT_REFERENCIA, 
		A.ie_clinica, 
		obter_valor_dominio(17,A.ie_clinica), 
		A.IE_PERIODO, 
		A.cd_medico, 
		obter_nome_medico(A.cd_medico, 'N'), 
		A.cd_setor_atendimento, 
		A.ie_tipo_atendimento, 
		A.ie_clinica_alta, 
		A.nr_seq_origem, 
		obter_sexo_pf(A.cd_pessoa_fisica,'C'), 
		A.cd_cid_principal, 
		obter_tipo_convenio(A.cd_convenio), 
		to_char(A.hr_alta,'00'), 
		A.cd_procedencia, 
		A.cd_tipo_acomodacao, 
		A.hr_alta, 
		substr(Obter_Se_Unidade_Temp(A.cd_setor_atendimento, A.dt_referencia, A.cd_unidade_basica, A.cd_unidade_compl),1,1), 
		cd_convenio;

