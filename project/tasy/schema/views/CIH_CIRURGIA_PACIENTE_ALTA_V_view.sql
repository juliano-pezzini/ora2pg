-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cih_cirurgia_paciente_alta_v (nr_ficha_ocorrencia, dt_alta, cd_medico_cirurgiao, limpa, potenc_conta, contaminada, infectada, nao_avaliado, menos_horas, mais_horas, inf_hospitalar, inf_comunitaria, inf_outras, profilatico, total) AS SELECT /*+ ORDERED */       A.NR_FICHA_OCORRENCIA,
       F.DT_ALTA,
       C.CD_MEDICO_CIRURGIAO,
       SUM(CASE WHEN C.CD_TIPO_CIRURGIA=1 THEN  1  ELSE 0 END ) LIMPA,
       SUM(CASE WHEN C.CD_TIPO_CIRURGIA=2 THEN  1  ELSE 0 END ) POTENC_CONTA,
       SUM(CASE WHEN C.CD_TIPO_CIRURGIA=3 THEN  1  ELSE 0 END ) CONTAMINADA,
       SUM(CASE WHEN C.CD_TIPO_CIRURGIA=4 THEN  1  ELSE 0 END ) INFECTADA,
       SUM(CASE WHEN C.IE_DURACAO_CIRURGIA=1 THEN  1  ELSE 0 END ) NAO_AVALIADO,
       SUM(CASE WHEN C.IE_DURACAO_CIRURGIA=2 THEN  1  ELSE 0 END ) MENOS_HORAS,
       SUM(CASE WHEN C.IE_DURACAO_CIRURGIA=3 THEN  1  ELSE 0 END ) MAIS_HORAS,
       SUM(CASE WHEN A.CD_CASO_INFECCAO=1 THEN  1  ELSE 0 END ) INF_HOSPITALAR,
       SUM(CASE WHEN A.CD_CASO_INFECCAO=2 THEN  1  ELSE 0 END ) INF_COMUNITARIA,
       SUM(CASE WHEN A.CD_CASO_INFECCAO=1 THEN  0 WHEN A.CD_CASO_INFECCAO=2 THEN  0 WHEN A.CD_CASO_INFECCAO=3 THEN  0  ELSE 1 END ) INF_OUTRAS,
       SUM(CASE WHEN D.IE_TIPO_UTILIZACAO=1 THEN  1  ELSE 0 END ) PROFILATICO,
       COUNT(*) TOTAL
FROM  CIH_FICHA_OCORRENCIA A,
      ATENDIMENTO_PACIENTE F,
      CIH_CIRURGIA C,
      CIH_MEDIC_UTILIZADO D
WHERE F.NR_ATENDIMENTO      = A.NR_ATENDIMENTO
AND   C.NR_FICHA_OCORRENCIA = A.NR_FICHA_OCORRENCIA
AND   D.NR_FICHA_OCORRENCIA = A.NR_FICHA_OCORRENCIA
GROUP BY A.NR_FICHA_OCORRENCIA,
         F.DT_ALTA,
         C.CD_MEDICO_CIRURGIAO;

