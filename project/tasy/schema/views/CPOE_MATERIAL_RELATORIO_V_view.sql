-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cpoe_material_relatorio_v (nm_medicamento, ds_com_medicamento, ds_alto_risco, ds_do_paciente, ds_componente, ds_tempo_adm, dt_suspensao, ie_baixado_por_alta, dt_inicio, ds_fim, nr_sequencia_p, dt_liberacao, nm_usuario, dt_fim, ie_administracao, ie_duracao, nm_usuario_susp, dt_lib_suspensao, cd_material, ie_controle_tempo, ie_tipo_solucao, ie_via_aplicacao, nr_atendimento, qt_dose_terapeutica, cd_unid_medic_terap, nm_medicamento_1, nm_medicamento_2, nm_medicamento_3, nm_medicamento_4, nm_medicamento_5, nm_medicamento_6, nm_medicamento_7, nm_reconstituicao, nm_diluicao, nm_rediluicao, ds_justificativa, ds_observacao, ds_horarios, dt_liberacao_enf, nm_usuario_nrec, nr_dia_util, ds_orientacao_preparo, qt_solucao) AS select	CASE WHEN a.cd_material IS NULL THEN  null  ELSE substr(cpoe_obter_desc_material_rel(a.cd_material, a.nr_seq_hemoterapia),1,255) END  nm_medicamento,
		substr(cpoe_obter_desc_comp_rel(null, a.nr_seq_hemoterapia,ie_via_aplicacao, qt_dose, cd_unidade_medida, cd_intervalo, ds_dose_diferenciada,ie_administracao,ie_urgencia,nr_seq_adicional, nr_seq_ataque),1,255) ds_com_medicamento,
		SUBSTR(CASE WHEN obter_se_medicam_alto_risco(a.cd_material)='S' THEN '('||wheb_mensagem_pck.get_texto(391170, null)||')'  ELSE null END ,1,255) ds_alto_risco,
		SUBSTR(CASE WHEN coalesce(a.ie_medicacao_paciente,'N')='S' THEN '('||wheb_mensagem_pck.get_texto(779513, null)||')'  ELSE null END ,1,255) ds_do_paciente,
		cpoe_obter_comp_mat_rel(ie_controle_tempo, ie_tipo_solucao, qt_dose, cd_unidade_medida,ie_administracao,ie_ref_calculo,ie_bomba_infusao,null,a.ie_via_aplicacao,hr_min_aplicacao,qt_solucao,ie_aplic_bolus, ie_aplic_lenta, qt_dose_ataque, qt_dose_adicional, nr_seq_procedimento, ds_dose_diferenciada,qt_dosagem,ie_tipo_dosagem,qt_volume,nr_sequencia, qt_hora_fase, ie_urgencia, qt_dose_terapeutica, cd_unid_medic_terap) ds_componente,	
		to_date(substr(cpoe_obter_proxima_adm_grid(nr_sequencia, 'M', nm_usuario, nr_atendimento, ie_administracao, cd_intervalo, coalesce(dt_prox_geracao, LOCALTIMESTAMP),dt_inicio, hr_prim_horario, dt_fim, 'prescr_material',  'nr_seq_mat_cpoe', 'prescr_mat_hor', 'nr_seq_material') ,7,100), 'dd/mm/yyyy hh24:mi') || ' ' ||
		substr(cpoe_obter_proxima_adm_grid(nr_sequencia, 'M', nm_usuario, nr_atendimento, ie_administracao, cd_intervalo,coalesce(dt_prox_geracao, LOCALTIMESTAMP), dt_inicio, hr_prim_horario, dt_fim, 'prescr_material',  'nr_seq_mat_cpoe', 'prescr_mat_hor', 'nr_seq_material') ,1,5) ds_tempo_adm,
		a.dt_suspensao,
		a.ie_baixado_por_alta,
		to_date(to_char(cpoe_obter_data_hora_form(a.dt_inicio, a.hr_prim_horario), 'dd/mm/yyyy hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') dt_inicio,
		CASE WHEN a.dt_fim='' THEN obter_desc_expressao(689989, '')  ELSE to_char(a.dt_fim,'dd/mm/yyyy hh24:mi:ss') END  ds_fim,
		a.nr_sequencia nr_sequencia_p,
		a.dt_liberacao,
		a.nm_usuario,
		a.dt_fim,
		a.ie_administracao,
		a.ie_duracao,
		a.nm_usuario_susp,
		a.dt_lib_suspensao,
		a.cd_material,
		a.ie_controle_tempo, 
		a.ie_tipo_solucao, 
		a.ie_via_aplicacao,
		a.nr_atendimento,
		qt_dose_terapeutica, 
		cd_unid_medic_terap,
		CASE WHEN a.cd_mat_comp1 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp1),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp1, a.cd_unid_med_dose_comp1,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp1) END nm_medicamento_1, 
		CASE WHEN a.cd_mat_comp2 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp2),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp2, a.cd_unid_med_dose_comp2,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp2) END nm_medicamento_2,
		CASE WHEN a.cd_mat_comp3 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp3),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp3, a.cd_unid_med_dose_comp3,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp3) END  nm_medicamento_3,
		CASE WHEN a.cd_mat_comp4 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp4),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp4, a.cd_unid_med_dose_comp4,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp4) END  nm_medicamento_4,
		CASE WHEN a.cd_mat_comp5 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp5),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp5, a.cd_unid_med_dose_comp5,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp5) END  nm_medicamento_5,
		CASE WHEN a.cd_mat_comp6 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp6),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp6, a.cd_unid_med_dose_comp6,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp6) END  nm_medicamento_6,		
		CASE WHEN a.cd_mat_comp7 IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_comp7),1,255) ||' '|| cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_comp7, a.cd_unid_med_dose_comp7,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_comp7) END  nm_medicamento_7,
		CASE WHEN a.cd_mat_recons IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_recons),1,255) ||' '||	cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_recons, a.cd_unid_med_dose_recons,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_rec) END  nm_reconstituicao,
		CASE WHEN a.cd_mat_dil IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_dil),1,255) ||' '||	cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_dil, a.cd_unid_med_dose_dil,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_dil, null, null, null,a.nr_sequencia) END  nm_diluicao,
		CASE WHEN a.cd_mat_red IS NULL THEN  null  ELSE substr(obter_desc_material(a.cd_mat_red),1,255) ||' '||	cpoe_obter_comp_mat_rel('SI', null, a.qt_dose_red, a.cd_unid_med_dose_red,null, null, null,null, null, null, null,null,null,null,null,null,a.ds_dose_diferenciada_red) END   nm_rediluicao,
		CASE WHEN ds_justificativa IS NULL THEN null  ELSE substr(substr(obter_desc_expressao(341044, ''),1,70) || ' ' ||  substr(ds_justificativa,1,3900),1,4000) END  ds_justificativa,
		CASE WHEN ds_observacao IS NULL THEN null  ELSE substr(obter_desc_expressao(329252, ''),1,255) || ' ' || substr(ds_observacao,1,3500) END  ds_observacao,
		a.ds_horarios,
		a.dt_liberacao_enf,
		a.nm_usuario_nrec,
		a.nr_dia_util,
		a.ds_orientacao_preparo,
		a.qt_solucao
FROM 	cpoe_material a
where 	a.ie_controle_tempo = 'N' 
and (coalesce(cpoe_obter_se_assoc_adm_adep(nr_seq_procedimento,cd_material),'S') = 'S' OR nr_seq_procedimento IS NULL);

