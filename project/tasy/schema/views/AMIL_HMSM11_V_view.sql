-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW amil_hmsm11_v (tp_registro, cd_registro, cd_prestador, dt_referencia, qt_consulta, vl_consulta, qt_exames, vl_exames, qt_lpi, vl_lpi, cd_beneficiario, dt_item, vl_item, cd_item, dt_sessao, qt_sessao, vl_total_item, cd_interno, cd_autorizacao, cd_regional, cd_cgc_prestador, nm_prestador, nm_medico_solic, cd_conselho_solic, nr_crm_solic, sg_conselho_solic, ie_carater_internacao, cd_cid, cd_cnes, nm_medico_exec, cd_conselho_exec, nr_crm_exec, sg_conselho_exec, ie_tipo_atendimento, cd_motivo_alta, ds_indicacao_clinica, nr_seq_protocolo, nr_interno_conta, dt_geracao_arquivo, qt_total_reg) AS select	0						tp_registro,
	0						cd_registro, 
	somente_numero(a.cd_interno)			cd_prestador, 
	b.dt_mesano_referencia				dt_referencia, 
  	sum(CASE WHEN c.cd_area_proc=1 THEN c.qt_item WHEN c.cd_area_proc=11 THEN c.qt_item  ELSE 0 END ) qt_consulta, 
	sum(CASE WHEN c.cd_area_proc=1 THEN c.vl_total_item WHEN c.cd_area_proc=11 THEN c.vl_total_item  ELSE 0 END ) vl_consulta, 
  	sum(CASE WHEN c.cd_area_proc=2 THEN c.qt_item WHEN c.cd_area_proc=3 THEN c.qt_item WHEN c.cd_area_proc=14 THEN c.qt_item WHEN c.cd_area_proc=12 THEN c.qt_item  ELSE 0 END ) qt_exames, 
	sum(CASE WHEN c.cd_area_proc=2 THEN c.vl_total_item WHEN c.cd_area_proc=3 THEN c.vl_total_item WHEN c.cd_area_proc=14 THEN c.vl_total_item WHEN c.cd_area_proc=12 THEN c.vl_total_item  ELSE 0 END ) vl_exames, 
  	sum(CASE WHEN c.ie_total_interf IS NULL THEN 0  ELSE (CASE WHEN c.cd_area_proc=4 THEN c.qt_item WHEN c.cd_area_proc=13 THEN c.qt_item  ELSE 0 END ) END ) qt_lpi, 
  	sum(CASE WHEN c.ie_total_interf IS NULL THEN 0  ELSE (CASE WHEN c.cd_area_proc=4 THEN c.vl_total_item WHEN c.cd_area_proc=13 THEN c.vl_total_item  ELSE 0 END ) END ) vl_lpi, 
	0						cd_beneficiario, 
	LOCALTIMESTAMP						dt_item, 
	0						vl_item, 
	0						cd_item, 
	LOCALTIMESTAMP						dt_sessao, 
	0						qt_sessao, 
	0						vl_total_item, 
	0						cd_interno, 
	' '						cd_autorizacao, 
	0						cd_regional, 
	' '						cd_cgc_prestador, 
	' '						nm_prestador, 
	' '						nm_medico_solic, 
	' '						cd_conselho_solic, 
	' '						nr_crm_solic, 
	' '						sg_conselho_solic, 
	' '						ie_carater_internacao, 
	' '						cd_cid, 
	' '						cd_cnes, 
	' '						nm_medico_exec, 
	' '						cd_conselho_exec, 
	' '						nr_crm_exec, 
	' '						sg_conselho_exec, 
	' '						ie_tipo_atendimento, 
	0						cd_motivo_alta, 
	' '						ds_indicacao_clinica, 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	0						nr_interno_conta, 
	LOCALTIMESTAMP						dt_geracao_arquivo, 
	0						qt_total_reg 
FROM	protocolo_convenio b, 
	w_interf_conta_header a, 
	w_interf_conta_item c 
where	c.nr_seq_protocolo	= b.nr_seq_protocolo 
and	c.nr_seq_protocolo	= a.nr_seq_protocolo 
group by	somente_numero(a.cd_interno), 
		b.dt_mesano_referencia, 
		a.nr_seq_protocolo 

union all
 
select 
	2						tp_registro, 
	2						cd_registro, 
	0						cd_prestador, 
	LOCALTIMESTAMP						dt_referencia, 
	0						qt_consulta, 
	0						vl_consulta, 
	0						qt_exames, 
	0						vl_exames, 
	0						qt_lpi, 
	0						vl_lpi, 
	coalesce(somente_numero(b.cd_usuario_convenio),0)	cd_beneficiario, 
	trunc(c.dt_item)				dt_item, 
	sum(CASE WHEN c.cd_item=9099 THEN vl_total_item-obter_preco_procedimento(1,c.cd_convenio,'1',c.dt_item,10014,1,0,0,0,0,0,0,0,0,0,'P') WHEN c.cd_item=9101 THEN vl_total_item-obter_preco_procedimento(1,c.cd_convenio,'1',c.dt_item,10014,1,0,0,0,0,0,0,0,0,0,'P') WHEN c.cd_item=9100 THEN vl_total_item-obter_preco_procedimento(1,c.cd_convenio,'1',c.dt_item,10014,1,0,0,0,0,0,0,0,0,0,'P')  ELSE vl_total_item-obter_preco_procedimento(1,c.cd_convenio,'1',c.dt_item,c.cd_item,1,0,0,0,0,0,0,0,0,0,'P') END ) vl_item, 
	coalesce(somente_numero(c.cd_item_convenio),0)	cd_item, 
	trunc(CASE WHEN c.cd_item_convenio=25040014 THEN c.dt_item WHEN c.cd_item_convenio=25070037 THEN c.dt_item WHEN c.cd_item_convenio=25040030 THEN c.dt_item WHEN c.cd_item_convenio=23006021 THEN c.dt_item  ELSE LOCALTIMESTAMP END ) dt_sessao, 
	sum(CASE WHEN c.cd_item_convenio=25040014 THEN c.qt_item WHEN c.cd_item_convenio=25070037 THEN c.qt_item WHEN c.cd_item_convenio=25040030 THEN c.qt_item WHEN c.cd_item_convenio=23006021 THEN c.qt_item  ELSE 0 END )	qt_sessao, 
	coalesce(sum(c.vl_total_item),0)			vl_total_item, 
	coalesce(somente_numero(d.cd_interno),0)		cd_interno, 
	b.nr_doc_convenio				cd_autorizacao, 
	coalesce(somente_numero(d.cd_regional),0)		cd_regional, 
	d.cd_cgc_hospital				cd_cgc_prestador, 
	d.nm_hospital					nm_prestador, 
	b.nm_medico_resp				nm_medico_solic, 
	'CRM'						cd_conselho_solic, 
	b.nr_crm_medico_resp				nr_crm_solic, 
	b.uf_crm_medico_resp				sg_conselho_solic, 
	b.ie_carater_inter				ie_carater_internacao, 
	b.cd_cid_principal				cd_cid, 
	substr(obter_cnes_estab(f.cd_estabelecimento),1,7) cd_cnes, 
	c.nm_medico_executor				nm_medico_exec, 
	'CRM'						cd_conselho_exec, 
	c.nr_crm_executor				nr_crm_exec, 
	c.uf_crm_executor				sg_conselho_exec, 
	a.ie_tipo_guia					ie_tipo_atendimento, 
	b.cd_motivo_alta				cd_motivo_alta, 
	'0'						ds_indicacao_clinica, 
	b.nr_seq_protocolo				nr_seq_protocolo, 
	c.nr_interno_conta				nr_interno_conta, 
	LOCALTIMESTAMP						dt_geracao_arquivo, 
	0						qt_total_reg 
FROM conta_paciente f, w_interf_conta_header d, w_interf_conta_item c, w_interf_conta_cab b
LEFT OUTER JOIN w_interf_conta_autor a ON (b.nr_interno_conta = a.nr_interno_conta)
WHERE c.nr_interno_conta	= b.nr_interno_conta and d.nr_seq_protocolo	= b.nr_seq_protocolo and b.nr_interno_conta	= f.nr_interno_conta group by	coalesce(somente_numero(b.cd_usuario_convenio),0), 
		trunc(c.dt_item), 
		coalesce(somente_numero(c.cd_item_convenio),0), 
		trunc(CASE WHEN c.cd_item_convenio=25040014 THEN c.dt_item WHEN c.cd_item_convenio=25070037 THEN c.dt_item WHEN c.cd_item_convenio=25040030 THEN c.dt_item WHEN c.cd_item_convenio=23006021 THEN c.dt_item  ELSE LOCALTIMESTAMP END ), 
		coalesce(somente_numero(d.cd_interno),0), 
		b.nr_doc_convenio, 
		coalesce(somente_numero(d.cd_regional),0), 
		d.cd_cgc_hospital, 
		d.nm_hospital, 
		b.nm_medico_resp, 
		b.nr_crm_medico_resp, 
		b.uf_crm_medico_resp, 
		b.ie_carater_inter, 
		b.cd_cid_principal, 
		substr(obter_cnes_estab(f.cd_estabelecimento),1,7), 
		c.nm_medico_executor, 
		c.nr_crm_executor, 
		c.uf_crm_executor, 
		a.ie_tipo_guia, 
		b.cd_motivo_alta, 
		b.nr_seq_protocolo, 
		c.nr_interno_conta 

union all
 
select	4						tp_registro, 
	4						cd_registro, 
	0						cd_prestador, 
	LOCALTIMESTAMP						dt_referencia, 
	0						qt_consulta, 
	0						vl_consulta, 
	0						qt_exames, 
	0						vl_exames, 
	0						qt_lpi, 
	0						vl_lpi, 
	0						cd_beneficiario, 
	LOCALTIMESTAMP						dt_item, 
	0						vl_item, 
	0						cd_item, 
	LOCALTIMESTAMP						dt_sessao, 
	0						qt_sessao, 
	0						vl_total_item, 
	0						cd_interno, 
	' '						cd_autorizacao, 
	0						cd_regional, 
	' '						cd_cgc_prestador, 
	' '						nm_prestador, 
	' '						nm_medico_solic, 
	' '						cd_conselho_solic, 
	' '						nr_crm_solic, 
	' '						sg_conselho_solic, 
	' '						ie_carater_internacao, 
	' '						cd_cid, 
	' '						cd_cnes, 
	' '						nm_medico_exec, 
	' '						cd_conselho_exec, 
	' '						nr_crm_exec, 
	' '						sg_conselho_exec, 
	' '						ie_tipo_atendimento, 
	0						cd_motivo_alta, 
	' '						ds_indicacao_clinica, 
	a.nr_seq_protocolo				nr_seq_protocolo, 
	9999999999					nr_interno_conta, 
	a.dt_remessa					dt_geracao_arquivo, 
	0						qt_total_reg 
from	w_interf_conta_header a;

