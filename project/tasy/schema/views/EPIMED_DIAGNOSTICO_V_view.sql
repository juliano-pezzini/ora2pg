-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW epimed_diagnostico_v (visit_id, diagnosis_id, diagnosis_origin_code, diagnosis_code, diagnosis_date, is_main_diagnosis, diagnosis_event, diagnosis_created_on, updatetimestampfilter, cd_multi_empresa) AS SELECT
	A.NR_ATENDIMENTO VISIT_ID,
	A.NR_SEQ_INTERNO DIAGNOSIS_ID,
	OBTER_SETOR_ATENDIMENTO(A.NR_ATENDIMENTO) DIAGNOSIS_ORIGIN_CODE,
	A.CD_DOENCA DIAGNOSIS_CODE,
	TO_CHAR(A.DT_DIAGNOSTICO, 'YYYY-MM-DD"T"HH24:MI:SS."000"') DIAGNOSIS_DATE,
	CASE WHEN A.IE_CLASSIFICACAO_DOENCA='P' THEN 1  ELSE 2 END  IS_MAIN_DIAGNOSIS,
	CASE WHEN A.IE_SITUACAO='I' THEN 2  ELSE 1 END  DIAGNOSIS_EVENT,
	CASE WHEN A.IE_SITUACAO='A' THEN TO_CHAR(A.DT_ATUALIZACAO,'YYYY-MM-DD"T"HH24:MI:SS."000"')  ELSE TO_CHAR(A.DT_INATIVACAO,'YYYY-MM-DD"T"HH24:MI:SS."000"') END  DIAGNOSIS_CREATED_ON,
	TO_DATE(A.DT_ATUALIZACAO) UPDATETIMESTAMPFILTER,
	OBTER_ESTAB_ATENDIMENTO(A.NR_ATENDIMENTO) CD_MULTI_EMPRESA
FROM DIAGNOSTICO_DOENCA A
WHERE A.DT_LIBERACAO IS NOT NULL
AND OBTER_SETOR_ATUAL_PACIENTE(A.NR_ATENDIMENTO) IN (SELECT CD_SETOR_ATENDIMENTO
FROM SETOR_ATENDIMENTO
WHERE IE_EPIMED = 'S'
AND IE_SITUACAO = 'A');

