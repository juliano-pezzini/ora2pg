-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_glosa_detalhe_prestador_v (nr_seq_protocolo, nr_seq_conta, dt_mes_competencia, nr_seq_prestador_atend, nr_seq_prestador_exec, dt_protocolo, ie_status_protocolo, nm_segurado, nr_seq_item, cd_item, ds_item, vl_apres, vl_glosa, vl_liberado, cd_motivo_glosa, ds_motivo_glosa, ie_tipo, nr_seq_tipo_prestador, ds_observacao, qt_mat_proc_imp, qt_mat_proc, ie_situacao, nr_seq_segurado, cd_segurado, dt_item, ds_cid, qt_glosa, ie_glosa, ie_lib_manual, cd_procedimento, nr_seq_prestador, cd_guia_ok) AS select	a.nr_sequencia nr_seq_protocolo,
	b.nr_sequencia nr_seq_conta, 
	a.dt_mes_competencia dt_mes_competencia, 
	a.nr_seq_prestador nr_seq_prestador_atend, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	a.dt_protocolo dt_protocolo, 
	a.ie_status	ie_status_protocolo, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado, 
	null nr_seq_item, 
	null cd_item, 
	'' ds_item, 
	b.vl_cobrado vl_apres, 
	b.vl_glosa vl_glosa, 
	b.vl_total vl_liberado, 
	g.cd_motivo_tiss cd_motivo_glosa, 
	g.ds_motivo_tiss ds_motivo_glosa, 
	'C' ie_tipo, 
	d.nr_seq_tipo_prestador nr_seq_tipo_prestador, 
	substr(e.ds_observacao,1,255) ds_observacao, 
	0 qt_mat_proc_imp, 
	0 qt_mat_proc, 
	e.ie_situacao ie_situacao, 
	b.nr_seq_segurado nr_seq_segurado, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_segurado, 
	b.dt_emissao dt_item, 
	coalesce(pls_obter_cid_conta(b.nr_sequencia),'N達o informado') DS_cid, 
	0 qt_glosa, 
	b.ie_glosa, 
	e.ie_lib_manual, 
	'N達o inform.' cd_procedimento, 
	d.nr_sequencia nr_seq_prestador, 
	b.cd_guia_ok cd_guia_ok 
FROM	pls_protocolo_conta a, 
	pls_conta b, 
	pls_prestador d, 
	pls_conta_glosa e, 
	tiss_motivo_glosa g 
where	d.nr_sequencia = a.nr_seq_prestador 
and	g.nr_sequencia = e.nr_seq_motivo_glosa 
and	e.nr_seq_conta = b.nr_sequencia 
and	a.nr_sequencia = b.nr_seq_protocolo 
and 	a.ie_situacao not in ('I','RE','A') 
and 	coalesce(a.ie_tipo_protocolo,'C') in ('C','I') 

union
 
select	a.nr_sequencia nr_seq_protocolo, 
	b.nr_sequencia nr_seq_conta, 
	a.dt_mes_competencia dt_mes_competencia, 
	a.nr_seq_prestador nr_seq_prestador_atend, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	a.dt_protocolo dt_protocolo, 
	a.ie_status	ie_status_protocolo, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado, 
	c.nr_sequencia nr_seq_item, 
	c.cd_procedimento cd_item, 
	substr(obter_descricao_procedimento(c.cd_procedimento,c.ie_origem_proced),1,255) ds_item, 
	coalesce(c.vl_procedimento_imp,0) vl_apres, 
	coalesce(c.vl_glosa,0) vl_glosa, 
	coalesce(c.vl_liberado,0) vl_liberado, 
	g.cd_motivo_tiss cd_motivo_glosa, 
	g.ds_motivo_tiss ds_motivo_glosa, 
	'P' ie_tipo, 
	d.nr_seq_tipo_prestador nr_seq_tipo_prestador, 
	substr(e.ds_observacao,1,255)ds_observacao, 
	c.qt_procedimento_imp qt_mat_proc_imp, 
	c.qt_procedimento qt_mat_proc, 
	e.ie_situacao ie_situacao, 
	b.nr_seq_segurado nr_seq_segurado, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_segurado, 
	c.dt_procedimento dt_item, 
	coalesce(pls_obter_cid_conta(b.nr_sequencia),'N達o informado') DS_cid, 
	CASE WHEN SIGN(c.qt_procedimento_imp - c.qt_procedimento)=0 THEN  0  ELSE (c.qt_procedimento_imp - c.qt_procedimento) END  qt_glosa, 
	b.ie_glosa, 
	e.ie_lib_manual, 
	to_char(c.cd_procedimento) cd_procedimento, 
	d.nr_sequencia nr_seq_prestador, 
	b.cd_guia_ok cd_guia_ok 
from	pls_protocolo_conta a, 
	pls_conta b, 
	pls_conta_proc c, 
	pls_prestador d, 
	pls_conta_glosa e, 
	tiss_motivo_glosa g 
where	d.nr_sequencia = a.nr_seq_prestador 
and	g.nr_sequencia = e.nr_seq_motivo_glosa 
and	e.nr_seq_conta_proc = c.nr_sequencia 
and	b.nr_sequencia = c.nr_seq_conta 
and	a.nr_sequencia = b.nr_seq_protocolo 
and 	a.ie_situacao not in ('I','RE','A') 
and 	coalesce(a.ie_tipo_protocolo,'C') in ('C','I') 

union
 
select	a.nr_sequencia nr_seq_protocolo, 
	b.nr_sequencia nr_seq_conta, 
	a.dt_mes_competencia dt_mes_competencia, 
	a.nr_seq_prestador nr_seq_prestador_atend, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	a.dt_protocolo dt_protocolo, 
	a.ie_status	ie_status_protocolo, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_segurado, 
	f.nr_sequencia nr_seq_item, 
	f.nr_seq_material cd_item, 
	substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',f.nr_seq_material),1,255) ds_item, 
	coalesce(f.vl_material_imp,0) vl_apres, 
	coalesce(f.vl_glosa,0) vl_glosa, 
	coalesce(f.vl_liberado,0) vl_liberado, 
	g.cd_motivo_tiss cd_motivo_glosa, 
	g.ds_motivo_tiss ds_motivo_glosa, 
	'M' ie_tipo, 
	d.nr_seq_tipo_prestador nr_seq_tipo_prestador, 
	substr(e.ds_observacao,1,255) ds_observacao, 
	qt_material_imp qt_mat_proc_imp, 
	qt_material qt_mat_proc, 
	e.ie_situacao ie_situacao, 
	b.nr_seq_segurado nr_seq_segurado, 
	substr(pls_obter_dados_segurado(b.nr_seq_segurado,'C'),1,255) cd_segurado, 
	f.dt_atendimento dt_item, 
	coalesce(pls_obter_cid_conta(b.nr_sequencia),'N達o informado') DS_cid, 
	CASE WHEN SIGN(f.qt_material_imp - f.qt_material)=0 THEN 0  ELSE (f.qt_material_imp - f.qt_material) END  qt_glosa, 
	b.ie_glosa, 
	e.ie_lib_manual, 
	substr(pls_obter_seq_codigo_material(f.nr_seq_material,''),1,255) cd_procedimento, 
	d.nr_sequencia nr_seq_prestador, 
	b.cd_guia_ok cd_guia_ok 
from	pls_protocolo_conta a, 
	pls_conta b, 
	pls_conta_glosa e, 
	pls_prestador d, 
	pls_conta_mat f, 
	tiss_motivo_glosa g 
where	d.nr_sequencia = a.nr_seq_prestador 
and	g.nr_sequencia = e.nr_seq_motivo_glosa 
and	e.nr_seq_conta_mat = f.nr_sequencia 
and	b.nr_sequencia = f.nr_seq_conta 
and	a.nr_sequencia = b.nr_seq_protocolo 
and 	a.ie_situacao not in ('I','RE','A') 
and 	coalesce(a.ie_tipo_protocolo,'C') in ('C','I');

