-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_consulta_mens_contr_v (nr_seq_lote, dt_referencia, vl_mensalidade, nr_seq_contrato, nr_contrato, nm_estipulante, nr_seq_pagador, nm_pagador, nr_titulo, dt_vencimento, dt_contrato, dt_cancelamento, vl_coparticipacao, dt_liquidacao, nr_nota_fiscal, ds_situacao, nr_seq_mensalidade, cd_cgc_pagador, cd_pf_pagador, vl_bonificacao, vl_sca, vl_reajuste_faixa, vl_reajuste_var, ie_varios_titulos, dt_pagamento_previsto, nr_parcela, dt_inicio_geracao, dt_fim_geracao, nm_usuario_geracao, ie_cancelamento) AS select	a.nr_seq_lote,
	a.dt_referencia,
	max(a.vl_mensalidade) vl_mensalidade,
	e.nr_seq_contrato nr_seq_contrato,
	d.nr_contrato nr_contrato,
	substr((select	obter_nome_pf(d.cd_pf_estipulante)
		FROM 	pessoa_fisica x
		where 	x.cd_pessoa_fisica = d.cd_pf_estipulante
		
union all

		select 	y.ds_razao_social
		from 	pessoa_juridica y
		where 	y.cd_cgc = d.cd_cgc_estipulante),1,200) nm_estipulante,
	e.nr_sequencia nr_seq_pagador,
	substr(pls_obter_dados_pagador(e.nr_sequencia,'D'),1,200) nm_pagador,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE f.nr_titulo END  nr_titulo,
	a.dt_vencimento,
	d.dt_contrato,
	a.dt_cancelamento,
	(select	sum(vl_item)
	from 	pls_mensalidade x,
		pls_mensalidade_segurado y,
		pls_mensalidade_seg_item z
	where 	z.nr_seq_mensalidade_seg = y.nr_sequencia
	and 	y.nr_seq_mensalidade = x.nr_sequencia
	and 	z.ie_tipo_item = '3'
	and 	x.nr_sequencia = a.nr_sequencia) vl_coparticipacao,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE f.dt_liquidacao END  dt_liquidacao,
	g.nr_nota_fiscal,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE substr(obter_valor_dominio(710,f.ie_situacao),1,60) END  ds_situacao,
	a.nr_sequencia nr_seq_mensalidade,
	e.cd_cgc cd_cgc_pagador,
	e.cd_pessoa_fisica cd_pf_pagador,
	(select	sum(vl_item)
	from 	pls_mensalidade x,
		pls_mensalidade_segurado y,
		pls_mensalidade_seg_item z
	where 	z.nr_seq_mensalidade_seg = y.nr_sequencia
	and 	y.nr_seq_mensalidade = x.nr_sequencia
	and 	z.ie_tipo_item = '14'
	and 	x.nr_sequencia = a.nr_sequencia) vl_bonificacao,
	(select	sum(vl_item)
	from 	pls_mensalidade x,
		pls_mensalidade_segurado y,
		pls_mensalidade_seg_item z
	where 	z.nr_seq_mensalidade_seg = y.nr_sequencia
	and 	y.nr_seq_mensalidade = x.nr_sequencia
	and 	z.ie_tipo_item = '15'
	and 	x.nr_sequencia = a.nr_sequencia) vl_sca,
	(select	sum(vl_item)
	from 	pls_mensalidade x,
		pls_mensalidade_segurado y,
		pls_mensalidade_seg_item z
	where 	z.nr_seq_mensalidade_seg = y.nr_sequencia
	and 	y.nr_seq_mensalidade = x.nr_sequencia
	and 	z.ie_tipo_item = '5'
	and 	x.nr_sequencia = a.nr_sequencia) vl_reajuste_faixa,
	(select	sum(vl_item)
	from 	pls_mensalidade x,
		pls_mensalidade_segurado y,
		pls_mensalidade_seg_item z
	where 	z.nr_seq_mensalidade_seg = y.nr_sequencia
	and 	y.nr_seq_mensalidade = x.nr_sequencia
	and 	z.ie_tipo_item in ('4','25','35')
	and 	x.nr_sequencia = a.nr_sequencia) vl_reajuste_var,
	a.ie_varios_titulos,
	f.dt_pagamento_previsto dt_pagamento_previsto,
	a.nr_parcela,
	b.dt_inicio_geracao,
	b.dt_fim_geracao,
	b.nm_usuario_geracao,
	a.ie_cancelamento
FROM pls_contrato_pagador e, pls_contrato d, pls_lote_mensalidade b, pls_mensalidade a
LEFT OUTER JOIN titulo_receber f ON (a.nr_sequencia = f.nr_seq_mensalidade)
LEFT OUTER JOIN nota_fiscal g ON (a.nr_sequencia = g.nr_seq_mensalidade)
WHERE d.nr_sequencia = e.nr_seq_contrato and e.nr_sequencia = a.nr_seq_pagador   and b.nr_sequencia = a.nr_seq_lote group by
	a.nr_seq_lote,
	a.dt_referencia,
	a.nr_sequencia,
	d.nr_contrato,
	e.nr_seq_contrato,
	d.cd_pf_estipulante,
	d.cd_cgc_estipulante,
	e.nr_sequencia,
	e.cd_pessoa_fisica,
	e.cd_cgc,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE f.nr_titulo END ,
	a.dt_vencimento,
	d.dt_contrato,
	a.dt_cancelamento,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE f.dt_liquidacao END ,
	g.nr_nota_fiscal,
	CASE WHEN a.ie_varios_titulos='S' THEN null  ELSE substr(obter_valor_dominio(710,f.ie_situacao),1,60) END ,
	e.cd_cgc,
	e.cd_pessoa_fisica,
	a.ie_varios_titulos,
	f.dt_pagamento_previsto,
	a.nr_parcela,
	b.dt_inicio_geracao,
	b.dt_fim_geracao,
	b.nm_usuario_geracao,
	a.ie_cancelamento
order by
	a.nr_seq_lote desc;

