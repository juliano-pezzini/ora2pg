-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_demonst_serv_faturados_v (nr_seq_lote, ds_beneficiario, dt_emissao, cd_item, ds_item, ds_grau_participacao, qt_item, vl_liberado, ds_moeda, vl_faturado, cd_prestador, ie_tipo_guia, ds_plano, ie_valor, cd_guia, vl_administracao, nr_seq_conta_pos_estab, nr_seq_pagador, nr_seq_fatura, nr_seq_evento, ie_status, dt_mesano_referencia, cd_empresa_op, nr_seq_conta_proc, nr_seq_conta_mat, ds_tipo_guia, vl_conta, vl_tx_adm_glosa, vl_total_glosa, vl_unitario, cd_usuario_plano, ds_usuario_plano) AS select	b.nr_seq_lote,
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'CR')||' '||pls_obter_dados_segurado(d.nr_seq_segurado,'N'),1,33) ds_beneficiario, 
	e.dt_emissao, 
	to_char(g.cd_procedimento) cd_item, 
	substr(pls_obter_dados_conta_proc(f.nr_seq_conta_proc,'D'),1,20) ds_item, 
	substr(coalesce(pls_obter_ds_grau_participacao(i.nr_seq_grau_partic),pls_obter_ds_grau_participacao(e.nr_seq_grau_partic)),1,15) ds_grau_participacao, 
	z.qt_item qt_item, 
	--g.vl_liberado_hi vl_liberado, 
	z.vl_tabela_preco vl_liberado, 
	obter_desc_moeda(z.cd_moeda_calculo) ds_moeda, 
	coalesce(z.vl_medico,f.vl_faturado) vl_faturado, 
	substr(coalesce(pls_obter_cod_prestador(coalesce(e.nr_seq_prestador,e.nr_seq_prestador_imp),null),pls_obter_dados_cooperativa(u.nr_seq_congenere,'C')),1,20) cd_prestador, 
	e.ie_tipo_guia, 
	substr(pls_obter_acomodacoes_plano(x.nr_seq_plano),1,1) ds_plano, 
	'HM' ie_valor, 
	e.cd_guia, 
	coalesce(z.vl_administracao,0) vl_administracao, 
	z.nr_sequencia nr_seq_conta_pos_estab, 
	b.nr_seq_pagador, 
	c.nr_seq_fatura, 
	c.nr_seq_evento, 
	r.ie_status, 
	trunc(a.dt_mesano_referencia,'month') dt_mesano_referencia, 
	substr(pls_obter_dados_pagador(b.nr_seq_pagador,'OE'),1,10) cd_empresa_op, 
	g.nr_sequencia nr_seq_conta_proc, 
	null nr_seq_conta_mat, 
	upper(replace(replace(coalesce(CASE WHEN e.ie_tipo_guia='3' THEN 'Consulta' WHEN e.ie_tipo_guia='4' THEN 'Exames' WHEN e.ie_tipo_guia='5' THEN 'Internação' END ,substr(obter_valor_dominio(1746,e.ie_tipo_guia),1,255)),'Guia ',''),'Guia de ','')) ds_tipo_guia, 
	coalesce(g.vl_liberado,0) vl_conta, 
	(coalesce(z.vl_glosa_taxa_co,0) + coalesce(z.vl_glosa_taxa_material,0) + coalesce(z.vl_glosa_taxa_servico,0)) vl_tx_adm_glosa, 
	(coalesce(vl_glosa_co_fat,0) + coalesce(vl_glosa_hi_fat,0) + coalesce(vl_glosa_material_fat,0)) vl_total_glosa, 
	coalesce(coalesce(g.vl_unitario,g.vl_unitario_imp),0) vl_unitario, 
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'CR'),1,33) cd_usuario_plano, 
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'N'),1,50) ds_usuario_plano 
FROM pls_conta_pos_estabelecido z, pls_segurado x, pls_protocolo_conta u, pls_fatura_proc f, pls_fatura_conta d, pls_fatura_evento c, pls_fatura b, pls_lote_faturamento a, pls_conta_proc g
LEFT OUTER JOIN pls_proc_participante i ON (g.nr_sequencia = i.nr_seq_conta_proc)
, pls_conta e
LEFT OUTER JOIN pls_analise_conta r ON (e.nr_seq_analise = r.nr_sequencia)
WHERE g.nr_sequencia	= f.nr_seq_conta_proc and d.nr_sequencia	= f.nr_seq_fatura_conta and e.nr_sequencia	= d.nr_seq_conta and c.nr_sequencia	= d.nr_seq_fatura_evento and b.nr_sequencia	= c.nr_seq_fatura and a.nr_sequencia	= b.nr_seq_lote and z.nr_sequencia	= f.nr_seq_conta_pos_estab and x.nr_sequencia	= e.nr_seq_segurado and u.nr_sequencia	= e.nr_seq_protocolo   
union
 
select	b.nr_seq_lote, 
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'CR')||' '||pls_obter_dados_segurado(d.nr_seq_segurado,'N'),1,33) ds_beneficiario, 
	e.dt_emissao, 
	substr(pls_obter_seq_codigo_material(g.nr_seq_material,null),1,20) cd_item, 
	substr(coalesce(trim(both g.ds_material_imp),pls_obter_dados_material(g.nr_seq_material,'DS')),1,25) ds_item, 
	substr(pls_obter_ds_grau_participacao(e.nr_seq_grau_partic),1,15) ds_grau_participacao, 
	z.qt_item qt_item, 
	--g.vl_liberado vl_liberado, 
	z.vl_tabela_preco vl_liberado, 
	obter_desc_moeda(z.cd_moeda_calculo) ds_moeda, 
	coalesce(z.vl_materiais,f.vl_faturado) vl_faturado, 
	substr(coalesce(pls_obter_cod_prestador(coalesce(e.nr_seq_prestador,e.nr_seq_prestador_imp),null),pls_obter_dados_cooperativa(u.nr_seq_congenere,'C')),1,20) cd_prestador, 
	e.ie_tipo_guia, 
	substr(pls_obter_acomodacoes_plano(x.nr_seq_plano),1,1) ds_plano, 
	'HM' ie_valor, 
	e.cd_guia, 
	coalesce(z.vl_administracao,0) vl_administracao, 
	z.nr_sequencia nr_seq_conta_pos_estab, 
	b.nr_seq_pagador, 
	c.nr_seq_fatura, 
	c.nr_seq_evento, 
	r.ie_status, 
	trunc(a.dt_mesano_referencia,'month') dt_mesano_referencia, 
	substr(pls_obter_dados_pagador(b.nr_seq_pagador,'OE'),1,10) cd_empresa_op, 
	null nr_seq_conta_proc, 
	g.nr_sequencia nr_seq_conta_mat, 
	upper(replace(replace(coalesce(CASE WHEN e.ie_tipo_guia='3' THEN 'Consulta' WHEN e.ie_tipo_guia='4' THEN 'Exames' WHEN e.ie_tipo_guia='5' THEN 'Internação' END ,substr(obter_valor_dominio(1746,e.ie_tipo_guia),1,255)),'Guia ',''),'Guia de ','')) ds_tipo_guia, 
	coalesce(g.vl_liberado,0) vl_conta, 
	(coalesce(z.vl_glosa_taxa_co,0) + coalesce(z.vl_glosa_taxa_material,0) + coalesce(z.vl_glosa_taxa_servico,0)) vl_tx_adm_glosa, 
	(coalesce(vl_glosa_co_fat,0) + coalesce(vl_glosa_hi_fat,0) + coalesce(vl_glosa_material_fat,0)) vl_total_glosa, 
	coalesce(coalesce(g.vl_unitario,g.vl_unitario_imp),0) vl_unitario, 
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'CR'),1,33) cd_usuario_plano, 
	substr(pls_obter_dados_segurado(d.nr_seq_segurado,'N'),1,50) ds_usuario_plano 
FROM pls_conta_pos_estabelecido z, pls_segurado x, pls_protocolo_conta u, pls_conta_mat g, pls_fatura_mat f, pls_fatura_conta d, pls_fatura_evento c, pls_fatura b, pls_lote_faturamento a, pls_conta e
LEFT OUTER JOIN pls_analise_conta r ON (e.nr_seq_analise = r.nr_sequencia)
WHERE g.nr_sequencia	= f.nr_seq_conta_mat and d.nr_sequencia	= f.nr_seq_fatura_conta and e.nr_sequencia	= d.nr_seq_conta and c.nr_sequencia	= d.nr_seq_fatura_evento and b.nr_sequencia	= c.nr_seq_fatura and a.nr_sequencia	= b.nr_seq_lote and z.nr_sequencia	= f.nr_seq_conta_pos_estab and x.nr_sequencia	= e.nr_seq_segurado and u.nr_sequencia	= e.nr_seq_protocolo;

