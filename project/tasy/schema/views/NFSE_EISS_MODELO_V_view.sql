-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nfse_eiss_modelo_v (nr_sequencia, tiporps, nr_seq_nota, serierps, numrps, dtemissaorps, sitrps, vlservicos, codativ, aliq, vlimposto, tiporecol, identtomador, tipoident, rzsocial, endereco, bairro, cep, cidade, uf, email, localtom, simples, vlpis, vlcofins, vlir, vlinss, vlcsll, vldeducoes, competencia, municipioserv, ufserv, tipoconvenio, descservicos_um, descservicos_dois, descservicos_tres) AS select	a.nr_sequencia nr_sequencia,
		   '0' tipoRPS, 
	    a.nr_sequencia nr_seq_nota, 
	    a.cd_serie_nf serieRPS, 
	    a.nr_nota_fiscal numRPS, 
	    to_char(a.dt_emissao,'yyyymmdd') dtEmissaoRPS, 
		'1' sitRPS, 
		campo_mascara(a.vl_mercadoria - a.vl_descontos,2) vlServicos, 
		--substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),5,'0'),1,5) codAtiv, 
		obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C') codAtiv, 
		(campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISSST')/100, 4)) aliq, 
		campo_mascara(CASE WHEN obter_se_nf_retem_iss(a.nr_sequencia)='S' THEN  null  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'ISSST') END  , 2) vlImposto, 
		CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN '1'  ELSE '2' END  tipoRecol, 
		coalesce(nfse_obter_dados_pf_pj(null,a.cd_cgc,'IM'),CASE WHEN a.cd_cgc IS NULL THEN LPAD(Obter_Cpf_Pessoa_Fisica(a.cd_pessoa_fisica),11,0)  ELSE a.cd_cgc END ) identTomador, 
		CASE WHEN nfse_obter_dados_pf_pj(null,a.cd_cgc,'IM') IS NULL THEN CASE WHEN a.cd_cgc IS NULL THEN '1'  ELSE '0' END   ELSE '2' END  tipoIdent, 
		NFE_ELIMINA_CARACTERE_ESPECIAL(elimina_acentos(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_NOME_PF(a.cd_pessoa_fisica)  ELSE nfe_obter_dados_pj(a.cd_cgc,'RZ') END ,1,60))) rzSocial, 
		substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'EN'))), 1, 255) endereco, 
		substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'B')  ELSE nfe_obter_dados_pj(a.cd_cgc,'BA') END ,'S','N'),1,60) bairro, 
		substr(CASE WHEN a.cd_cgc IS NULL THEN CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica,null)='N' THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CEP')  ELSE null END   ELSE CASE WHEN obter_se_pf_pj_estrangeiro(null,a.cd_cgc)='N' THEN nfe_obter_dados_pj(a.cd_cgc,'CEP')  ELSE null END  END ,1,8) Cep, 
		substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN  CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica,null)='N' THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DM')  ELSE 'EXTERIOR' END   ELSE CASE WHEN obter_se_pf_pj_estrangeiro(null,a.cd_cgc)='N' THEN nfe_obter_dados_pj(a.cd_cgc,'MU')  ELSE 'EXTERIOR' END  END ,'S','N'),1,60) cidade, 
		substr(CASE WHEN a.cd_cgc IS NULL THEN CASE WHEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'UF')='IN' THEN 'EX'  ELSE OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'UF') END   ELSE CASE WHEN nfe_obter_dados_pj(a.cd_cgc,'UF')='IN' THEN 'EX'  ELSE nfe_obter_dados_pj(a.cd_cgc,'UF') END  END ,1,2) uf, 
		CASE WHEN cd_pessoa_fisica='' THEN  		    coalesce(substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj_estab(a.cd_estabelecimento, '', a.cd_cgc, 'M'))), 1, 80), '')  ELSE coalesce(substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj(a.cd_pessoa_fisica, '', 'M'))), 1, 80), '') END  email, 
		CASE WHEN substr(elimina_caractere_esp_asc(nfe_obter_dados_pj(a.cd_cgc_emitente,'MU'),'S','N'),1,60)=substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN  CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica,null)='N' THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DM')  ELSE 'EXTERIOR' END   ELSE CASE WHEN obter_se_pf_pj_estrangeiro(null,a.cd_cgc)='N' THEN nfe_obter_dados_pj(a.cd_cgc,'MU')  ELSE 'EXTERIOR' END  END ,'S','N'),1,60) THEN '0'  ELSE '1' END  localTom, 
		'N' simples, 
		campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'PIS'),2) vlPIS, 
		campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'COFINS'),2) vlCOFINS, 
		campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'IR'),2) vlIR, 
		campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'INSS'),2) vlINSS, 
		campo_mascara(obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'CSLL'),2) vlCSLL, 
		'0.00' vlDeducoes, 
		to_char(a.dt_emissao,'yyyymm') competencia, 
		substr(elimina_caractere_esp_asc(nfe_obter_dados_pj(a.cd_cgc_emitente,'MU'),'S','N'),1,60) municipioServ, 
		substr(elimina_caractere_esp_asc(nfe_obter_dados_pj(a.cd_cgc_emitente,'UF'),'S','N'),1,60) ufServ, 
		'0' tipoConvenio, 
		tiss_eliminar_caractere(elimina_acentuacao(coalesce(substr(obter_descricao_rps(a.cd_estabelecimento,a.nr_sequencia,'DS_SERVICOS'),1,249),'Sem descricao de servicos'))) descServicos_um, 
		tiss_eliminar_caractere(elimina_acentuacao(substr(obter_descricao_rps(a.cd_estabelecimento,a.nr_sequencia,'DS_SERVICOS'),250,499))) descServicos_dois, 
		tiss_eliminar_caractere(elimina_acentuacao(substr(obter_descricao_rps(a.cd_estabelecimento,a.nr_sequencia,'DS_SERVICOS'),500,749))) descServicos_tres 
	FROM	nota_fiscal a 
	order by a.nr_nota_fiscal;

