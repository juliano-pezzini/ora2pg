-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_encounter_v (encounter_id, patient_id, patient_class, encounter_doctor_id, encounter_doctor_provider_num, encounter_doctor_given_name, encounter_doctor_last_name, encounter_doctor_middle_name, referred_doctor_doctor_id, referred_doctor_provider_num, referred_doctor_given_name, referred_doctor_last_name, referred_doctor_middle_name, referral_date, validity_date, type_encounter_id, icd, clinic_id, encouter_admit_date, encounter_discharge_date, type_discharge_date, prior_location_id, type_health_insurance_id, establishment_id, establishment_name, establishment_phone, health_insurance_id, insurance_category_id, insurance_plan_id, insurance_name, validity_insurance_start_date, effective_insurance_end_date, department_id, room_id, bed_id, integration_bed_code, department_name, external_department_id, insurance_document_number, user_insurance_code, insurance_password, insurance_card_validity_date, main_insurance_document_number, complaint_id, encounter_classification_id, admission_type, re_admission_indicator, department_admit_date, department_exit_date, discharge_doctor_date, encounter_start_date, triage_end_date, ed_location, department_classification_id, encounter_cancelation_date, company_id, room_bed_id, point_of_care, nr_atendimento, type_schedule_id, schedule_status_id, notes, reason_for_encounter, patient_symptoms, insurance_company_id, patient_pregnant, patient_fasting, unit_admission_number, displayed_in_epimed_view, room_name, department_building, departmen_floor, external_dep_code, medical_department_id, medical_department_name, last_menstruation_period, interface_bed_name, previous_unit, previous_complement_unit, previous_point_of_care, doctor_code, visit_number, medical_record_id) AS select	a.nr_atendimento encounter_id,
	a.cd_pessoa_fisica patient_id,
	CASE WHEN a.ie_tipo_atendimento=1 THEN  'I' WHEN a.ie_tipo_atendimento=3 THEN 'E' WHEN a.ie_tipo_atendimento=8 THEN 'O' END  patient_class,
	a.cd_medico_resp encounter_doctor_id,
	get_provider_details(a.cd_medico_resp, a.cd_estabelecimento, c.cd_setor_atendimento) encounter_doctor_provider_num,
	obter_dados_pf(a.cd_medico_resp,'PNG') Encounter_Doctor_Given_Name,
	obter_dados_pf(a.cd_medico_resp,'PNL') Encounter_Doctor_Last_Name,
	obter_dados_pf(a.cd_medico_resp,'PNM') Encounter_Doctor_Middle_Name,
	a.cd_medico_referido referred_doctor_doctor_id,
	get_provider_details(a.cd_medico_referido, a.cd_estabelecimento, c.cd_setor_atendimento) referred_doctor_provider_num,
	obter_dados_pf(a.cd_medico_referido,'PNG') referred_Doctor_Given_Name,
	obter_dados_pf(a.cd_medico_referido,'PNL') referred_Doctor_Last_Name,
	obter_dados_pf(a.cd_medico_referido,'PNM') referred_Doctor_Middle_Name,
	get_referral_letter_details(1, a.nr_atendimento) referral_date,
	get_referral_letter_details(2, a.nr_atendimento) validity_date,
	a.ie_tipo_atendimento type_encounter_id,
	Obter_cid_princ_atendimento(a.nr_atendimento) ICD,
	a.ie_clinica clinic_id,
	a.dt_entrada encouter_admit_date,
	a.dt_alta encounter_discharge_date,
	a.cd_motivo_alta type_discharge_date,
	a.cd_procedencia prior_location_id,
	a.ie_tipo_convenio type_health_insurance_id,
	a.cd_estabelecimento establishment_id,
	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,400) establishment_Name,
	substr(obter_compl_pj(obter_cgc_estabelecimento(a.cd_estabelecimento),1,'T'),1,400) establishment_Phone,
	b.cd_convenio health_insurance_id,
	b.cd_categoria Insurance_category_id,
	b.cd_plano_convenio insurance_plan_id,
	d.ds_convenio insurance_name,
	b.dt_inicio_vigencia Validity_insurance_start_date,
	b.dt_final_vigencia Effective_insurance_end_date,
	c.cd_setor_atendimento department_id,
	c.cd_unidade_basica room_id,
	trim(both c.cd_unidade_compl) bed_id,
    f.nm_leito_integracao integration_bed_code,
	e.ds_setor_atendimento department_name,
	e.cd_setor_externo external_department_id,
	b.nr_doc_convenio insurance_document_number,
	b.cd_usuario_convenio user_insurance_code,
	b.cd_senha insurance_password,
	b.DT_VALIDADE_CARTEIRA  insurance_card_validity_date,
	b.NR_DOC_CONV_PRINCIPAL main_insurance_document_number,
	a.nr_seq_queixa complaint_id,
	a.nr_seq_classificacao encounter_classification_id,
	get_admission_type_hl7(a.nr_atendimento,c.nr_seq_interno) admission_type,
	a.nr_atend_original re_admission_indicator,
	c.dt_entrada_unidade department_admit_date,
	c.dt_saida_unidade department_exit_date,
	a.dt_alta_medico discharge_doctor_date,
	a.dt_inicio_atendimento encounter_start_date,
	a.dt_fim_triagem triage_end_date,
	a.nr_seq_local_pa ed_location,
	e.CD_CLASSIF_SETOR department_classification_id,
	a.dt_cancelamento encounter_cancelation_date,
	b.cd_empresa company_id,
	c.CD_UNIDADE_BASICA || ' ' ||c.CD_UNIDADE_COMPL  room_bed_id,
	Obter_point_of_care(c.cd_setor_atendimento,c.cd_unidade_basica,c.cd_unidade_compl) point_of_care,
	a.nr_atendimento,
	null type_schedule_id,
	null schedule_status_id,
	a.ds_observacao notes,
	obter_desc_motivo_atendimento(a.nr_seq_queixa) reason_for_encounter,
	a.ds_sintoma_paciente patient_symptoms,
	d.cd_externo insurance_company_id,
	a.ie_paciente_gravida patient_pregnant,   
	cpoe_obter_se_jejum(a.nr_atendimento,null) patient_fasting,
	c.nr_seq_interno unit_admission_number,
	coalesce(e.IE_EPIMED, 'N') displayed_in_epimed_view,
	f.nr_seq_interno room_name,
	(select n.DS_BLOCO FROM BLOCO_SETOR n where n.NR_SEQUENCIA = e.NR_SEQ_BLOCO) department_building,
	(select m.DS_ANDAR from ANDAR_SETOR m where m.NR_SEQUENCIA = e.NR_SEQ_ANDAR) departmen_floor,
	get_external_department_code(a.nr_atendimento) external_dep_code,
	c.cd_departamento medical_department_id,
	obter_nome_departamento_medico(c.cd_departamento) medical_department_name,
	a.dt_ultima_menstruacao last_menstruation_period,
	f.nm_leito_integracao interface_bed_name,
	Obter_leito_setor_ant(a.nr_atendimento, 'L') previous_unit,
	Obter_leito_setor_ant(a.nr_atendimento, 'C') previous_complement_unit,
	Obter_leito_setor_ant(a.nr_atendimento, 'S') previous_point_of_care,	
	obter_dados_pf(a.cd_medico_resp,'CURP') doctor_code,
	(select nr_episodio from episodio_paciente ep where cd_estabelecimento=wheb_usuario_pck.get_cd_estabelecimento and ep.nr_sequencia = a.nr_seq_episodio) visit_number,
	case(select vl_parametro from FUNCAO_PARAMETRO where cd_funcao=0 and nr_sequencia=120)
    when 'BASE' then OBTER_PRONTUARIO_ATENDIMENTO(a.nr_atendimento)
    when 'ESTAB' then (select pfpe.nr_prontuario from pessoa_fisica_pront_estab pfpe where pfpe.cd_pessoa_fisica=a.cd_pessoa_fisica and pfpe.cd_estabelecimento=wheb_usuario_pck.get_cd_estabelecimento)
    end medical_record_id
from	setor_atendimento e,
	convenio d,
	atend_paciente_unidade c,
	atend_categoria_convenio b,
	atendimento_paciente a,
	unidade_atendimento f
where	a.nr_atendimento = c.nr_atendimento
and 	c.nr_seq_interno =  (	select	coalesce(max(x.nr_seq_interno),0)
					from 	atend_paciente_unidade x
					where	X.nr_atendimento = a.nr_atendimento
					and 	coalesce(x.dt_saida_unidade, x.dt_entrada_unidade + 9999)	= 
						(select max(coalesce(v.dt_saida_unidade, v.dt_entrada_unidade + 9999))
						from atend_paciente_unidade v
						where v.nr_atendimento 	= a.nr_atendimento))
and	a.nr_atendimento	= b.nr_atendimento
and	b.nr_seq_interno	= (	SELECT	/*+ INDEX(Z ATECACO_ATEPACI_FK_I)*/						coalesce(MAX(nr_seq_interno),0)
					FROM 	atend_categoria_convenio z
					WHERE	z.nr_atendimento = a.nr_atendimento
					AND 	z.dt_inicio_vigencia	=	
						(SELECT	MAX(x.dt_inicio_vigencia)
						FROM 	atend_categoria_convenio x
						WHERE 	x.nr_atendimento = a.nr_atendimento))
and	c.cd_setor_atendimento	= e.cd_setor_atendimento
and	b.cd_convenio		=d.cd_convenio
and 	c.cd_setor_atendimento = f.cd_setor_atendimento
and 	c.cd_unidade_basica = f.cd_unidade_basica
and 	c.cd_unidade_compl  = f.cd_unidade_compl;

