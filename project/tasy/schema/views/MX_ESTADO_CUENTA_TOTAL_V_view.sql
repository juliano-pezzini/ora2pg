-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mx_estado_cuenta_total_v (tipo, vl_impuesto_0, vl_base_0, vl_impuesto_16, vl_base_16, vl_imposto, vl_adiantamento, vl_titulo_rec, nr_atendimento, nr_interno_conta, vl_original, vl_imposto_deducao, vl_deducao_16, vl_deducao_0, vl_deducible_16, vl_coseg_hosp_16, vl_coseg_honor_16, vl_coseg_penal_16, vl_coseg_max_16, vl_deducible_0, vl_coseg_hosp_0, vl_coseg_honor_0, vl_coseg_penal_0, vl_coseg_max_0, vl_desc_16, vl_desc_0, tx_tributo) AS SELECT		1 tipo,
		(0) vl_impuesto_0,
		0 vl_base_0,
		(coalesce(CASE WHEN coalesce(b.vl_procedimento,0)=0 THEN b.vl_medico  ELSE b.vl_procedimento END ,0)) vl_impuesto_16,
		coalesce(b.vl_procedimento,0) vl_base_16,
		(SELECT SUM(coalesce(x.vl_imposto,0)) FROM propaci_imposto x WHERE x.nr_seq_propaci = b.nr_sequencia) vl_imposto,
		0 vl_adiantamento,
		0 vl_titulo_rec,
		a.nr_atendimento,
		a.nr_interno_conta,
		coalesce(obter_vl_item_conta_original(b.nr_sequencia, null),b.vl_procedimento) vl_original,
		(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'I')) vl_imposto_deducao,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'CI'),0) vl_deducao_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'SI'),0) vl_deducao_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'D','CI'), 0) vl_deducible_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'H','CI'), 0) vl_coseg_hosp_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'N','CI'), 0) vl_coseg_honor_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'A','CI'), 0) vl_coseg_penal_16,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'T','CI'), 0) vl_coseg_max_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'D','SI'), 0) vl_deducible_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'H','SI'), 0) vl_coseg_hosp_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'N','SI'), 0) vl_coseg_honor_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'A','SI'), 0) vl_coseg_penal_0,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'T','SI'), 0) vl_coseg_max_0,
		coalesce(obter_desconto_matproc(b.nr_sequencia,'P'), 0) +
		CASE WHEN coalesce(obter_vl_item_conta_original(b.nr_sequencia, null),0)=0 THEN (hsj_obter_valor_rel_conta2(b.nr_interno_conta,b.nr_sequencia,null,null,'D') * b.qt_procedimento)  ELSE ( round((obter_vl_item_conta_original(b.nr_sequencia, null) * b.qt_procedimento)::numeric,2) -					b.vl_procedimento -					obter_desconto_matproc(b.nr_sequencia,'P') -					obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,null)) END  vl_desc_16,
		0 vl_desc_0,
		(SELECT SUM(coalesce(x.pr_imposto / 100,0)) FROM propaci_imposto x WHERE x.nr_seq_propaci = b.nr_sequencia) tx_tributo
FROM	procedimento c,
		procedimento_paciente b,
		conta_paciente a
WHERE	b.nr_interno_conta = a.nr_interno_conta
and		b.cd_procedimento = c.cd_procedimento
and		c.ie_origem_proced	= b.ie_origem_proced
AND		EXISTS (SELECT 1 FROM propaci_imposto x WHERE x.nr_seq_propaci = b.nr_sequencia and x.pr_imposto > 0)
AND		((b.nr_seq_proc_pacote IS NULL)
OR	 	(b.nr_sequencia = (SELECT 	z.nr_seq_procedimento
						FROM 	atendimento_pacote z
						WHERE  	z.nr_seq_procedimento = b.nr_sequencia
						AND  	z.nr_atendimento = a.nr_atendimento)
AND (b.nr_seq_proc_pacote IS NOT NULL)))

UNION ALL

SELECT	2 tipo,
	(coalesce(CASE WHEN coalesce(b.vl_procedimento,0)=0 THEN b.vl_medico  ELSE b.vl_procedimento END ,0)) vl_impuesto_0,
		coalesce(b.vl_procedimento,0) vl_base_0,
		(0) vl_impuesto_16,
		0 vl_base_16,
		0 vl_imposto,
		0 vl_adiantamento,
		0 vl_titulo_rec,
		a.nr_atendimento,
		a.nr_interno_conta,
		coalesce(obter_vl_item_conta_original(b.nr_sequencia, null),b.vl_procedimento) vl_original,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'I'), 0) vl_imposto_deducao,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'CI'), 0) vl_deducao_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,'SI'), 0) vl_deducao_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'D','CI'), 0) vl_deducible_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'H','CI'), 0) vl_coseg_hosp_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'N','CI'), 0) vl_coseg_honor_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'A','CI'), 0) vl_coseg_penal_16,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'T','CI'), 0) vl_coseg_max_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'D','SI'), 0) vl_deducible_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'H','SI'), 0) vl_coseg_hosp_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'N','SI'), 0) vl_coseg_honor_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'A','SI'), 0) vl_coseg_penal_0,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,'T','SI'), 0) vl_coseg_max_0,
		0 vl_desc_16,
		coalesce(obter_desconto_matproc(b.nr_sequencia,'P'), 0) +
		CASE WHEN coalesce(obter_vl_item_conta_original(b.nr_sequencia, null),0)=0 THEN (hsj_obter_valor_rel_conta2(b.nr_interno_conta,b.nr_sequencia,null,null,'D') * b.qt_procedimento)  ELSE ((obter_vl_item_conta_original(b.nr_sequencia, null) * b.qt_procedimento) -					b.vl_procedimento -					obter_desconto_matproc(b.nr_sequencia,'P') -					obter_valor_deducao_conv(b.nr_interno_conta,b.nr_sequencia,null,null,null)) END  vl_desc_0,
		(SELECT SUM(coalesce(x.pr_imposto / 100,0)) FROM propaci_imposto x WHERE x.nr_seq_propaci = b.nr_sequencia) tx_tributo
FROM	procedimento c,
		procedimento_paciente b,
		conta_paciente a
WHERE	b.nr_interno_conta = a.nr_interno_conta
and		b.cd_procedimento = c.cd_procedimento
and		b.ie_origem_proced = c.ie_origem_proced
AND		NOT EXISTS (SELECT 1 FROM propaci_imposto x WHERE x.nr_seq_propaci = b.nr_sequencia and x.pr_imposto > 0)
AND		((b.nr_seq_proc_pacote IS NULL)
OR		(b.nr_sequencia = (SELECT 	z.nr_seq_procedimento
						FROM 	atendimento_pacote z
						WHERE  	z.nr_seq_procedimento = b.nr_sequencia
						AND  	z.nr_atendimento = a.nr_atendimento)
AND (b.nr_seq_proc_pacote IS NOT NULL)))

UNION ALL

SELECT	3 tipo,
	(0) vl_impuesto_0,
		0 vl_base_0,
		(coalesce(b.vl_material,0)) vl_impuesto_16,
		coalesce(b.vl_material,0) vl_base_0,
		(SELECT SUM(coalesce(x.vl_imposto,0)) FROM matpaci_imposto x WHERE x.nr_seq_matpaci = b.nr_sequencia) vl_imposto,
		0 vl_adiantamento,
		0 vl_titulo_rec,
		a.nr_atendimento,
		a.nr_interno_conta,
		coalesce(obter_vl_item_conta_original(null,b.nr_sequencia),b.vl_material) vl_original,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'I'), 0) vl_imposto_deducao,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'CI'), 0) vl_deducao_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'SI'), 0) vl_deducao_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'D','CI'), 0) vl_deducible_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'H','CI'), 0) vl_coseg_hosp_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'N','CI'), 0) vl_coseg_honor_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'A','CI'), 0) vl_coseg_penal_16,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'T','CI'), 0) vl_coseg_max_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'D','SI'), 0) vl_deducible_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'H','SI'), 0) vl_coseg_hosp_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'N','SI'), 0) vl_coseg_honor_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'A','SI'), 0) vl_coseg_penal_0,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'T','SI'), 0) vl_coseg_max_0,
		coalesce(obter_desconto_matproc(b.nr_sequencia,'M'), 0) +
		CASE WHEN coalesce(obter_vl_item_conta_original(null,b.nr_sequencia),0)=0 THEN (hsj_obter_valor_rel_conta2(b.nr_interno_conta,null,b.nr_sequencia,null,'D'))  ELSE ( round((obter_vl_item_conta_original(null, b.nr_sequencia) * b.qt_material)::numeric,2) -					b.vl_material -					obter_desconto_matproc(b.nr_sequencia,'M') -					obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,null)) END  vl_desc_16,
		0 vl_desc_0,
		(SELECT SUM(coalesce(x.pr_imposto / 100,0)) FROM matpaci_imposto x WHERE x.nr_seq_matpaci = b.nr_sequencia) tx_tributo
FROM	conta_paciente a,
		material_atend_paciente b
WHERE	b.nr_interno_conta = a.nr_interno_conta
AND		EXISTS (SELECT 1 FROM matpaci_imposto x WHERE x.nr_seq_matpaci = b.nr_sequencia and x.pr_imposto > 0)
AND		b.nr_seq_proc_pacote IS NULL

UNION ALL

SELECT	4 tipo,
	(coalesce(b.vl_material,0)) vl_impuesto_0,
		coalesce(b.vl_material,0) vl_base_0,
		(0) vl_impuesto_16,
		0 vl_base_0,
		0 vl_imposto,
		0 vl_adiantamento,
		0 vl_titulo_rec,
		a.nr_atendimento,
		a.nr_interno_conta,
		coalesce(obter_vl_item_conta_original(null,b.nr_sequencia),b.vl_material) vl_original,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'I'), 0) vl_imposto_deducao,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'CI'), 0) vl_deducao_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,'SI'), 0) vl_deducao_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'D','CI'), 0) vl_deducible_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'H','CI'), 0) vl_coseg_hosp_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'N','CI'), 0) vl_coseg_honor_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'A','CI'), 0) vl_coseg_penal_16,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'T','CI'), 0) vl_coseg_max_16,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'D','SI'), 0) vl_deducible_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'H','SI'), 0) vl_coseg_hosp_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'N','SI'), 0) vl_coseg_honor_0,
		coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'A','SI'), 0) vl_coseg_penal_0,
        coalesce(obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,'T','SI'), 0) vl_coseg_max_0,
		0 vl_desc_16,
		coalesce(obter_desconto_matproc(b.nr_sequencia,'M'), 0) +
		CASE WHEN coalesce(obter_vl_item_conta_original(null,b.nr_sequencia),0)=0 THEN (hsj_obter_valor_rel_conta2(b.nr_interno_conta,null,b.nr_sequencia,null,'D'))  ELSE ((obter_vl_item_conta_original(null, b.nr_sequencia) * b.qt_material) -					b.vl_material -					obter_desconto_matproc(b.nr_sequencia,'M') -					obter_valor_deducao_conv(b.nr_interno_conta,null,b.nr_sequencia,null,null)) END   vl_desc_0,
		(SELECT SUM(coalesce(x.pr_imposto / 100,0)) FROM matpaci_imposto x WHERE x.nr_seq_matpaci = b.nr_sequencia) tx_tributo
FROM	conta_paciente a,
		material_atend_paciente b
WHERE	b.nr_interno_conta = a.nr_interno_conta
AND		NOT EXISTS (SELECT 1 FROM matpaci_imposto x WHERE x.nr_seq_matpaci = b.nr_sequencia and x.pr_imposto > 0)
AND		b.nr_seq_proc_pacote IS NULL

UNION ALL

SELECT  5 tipo,
	0 vl_impuesto_0,
		0 vl_base_0,
		0 vl_impuesto_16,
		0 vl_base_16,
		0 vl_imposto,
		coalesce(b.vl_adiantamento,0) vl_adiantamento,
		0 vl_titulo_rec,
		a.nr_atendimento,
		a.nr_interno_conta,
		0 vl_original,
		0 vl_imposto_deducao,
		0 vl_deducao_16,
		0 vl_deducao_0,
		0 vl_deducible_16,
		0 vl_coseg_hosp_16,
		0 vl_coseg_honor_16,
		0 vl_coseg_penal_16,
        0 vl_coseg_max_16,
		0 vl_deducible_0,
		0 vl_coseg_hosp_0,
		0 vl_coseg_honor_0,
		0 vl_coseg_penal_0,
        0 vl_coseg_max_0,
		0 vl_desc_16,
		0 vl_desc_0,
		0 tx_tributo
FROM    conta_paciente         a,
		conta_paciente_adiant  b
WHERE   a.nr_interno_conta = b.nr_interno_conta

UNION ALL

SELECT	6 tipo,
0 vl_impuesto_0,
		0 vl_base_0,
		0 vl_impuesto_16,
		0 vl_base_16,
		0 vl_imposto,
		0 vl_adiantamento,
		coalesce(a.vl_recebido,0) vl_titulo_rec,
		c.nr_atendimento,
		c.nr_interno_conta,
		0 vl_original,
		0 vl_imposto_deducao,
		0 vl_deducao_16,
		0 vl_deducao_0,
		0 vl_deducible_16,
		0 vl_coseg_hosp_16,
		0 vl_coseg_honor_16,
		0 vl_coseg_penal_16,
        0 vl_coseg_max_16,
		0 vl_deducible_0,
		0 vl_coseg_hosp_0,
		0 vl_coseg_honor_0,
		0 vl_coseg_penal_0,
        0 vl_coseg_max_0,
		0 vl_desc_16,
		0 vl_desc_0,
		0 tx_tributo
FROM 	titulo_receber_liq a,
		titulo_receber b,
		conta_paciente c
WHERE 	a.nr_titulo = b.nr_titulo
AND	  	b.nr_interno_Conta = c.nr_interno_conta
AND	  	b.ie_situacao <> 3
AND	  	a.cd_tipo_recebimento <> 21;

