-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nf_credito_v (clave, clave_unidade, identificacion, cantidad, descripcion, valor_unitario, importe, unidad, descuento, nr_item, nr_sequencia, iva_zero, vl_liquido, vl_tributo, vl_base, ie_nota_credito, nr_sequencia_ref) AS select 	CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  '84111506'  ELSE CASE WHEN fis_obter_usocfdi(a.nr_sequencia)='G02' THEN  '84111506'  ELSE coalesce(coalesce(b.cd_clave_agrup, obter_nr_proc_interno(cd_procedimento, ie_origem_proced)), coalesce(CASE WHEN c.ie_devolucao='S' THEN  b.cd_mat_proc_fornec  ELSE obter_classif_fiscal(b.cd_material) END , '84111506')) END  END  clave,
	CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_vinculo_adiantamento(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_usocfdi(a.nr_sequencia)='G02' THEN  'ACT'  ELSE CASE WHEN(SELECT	coalesce(p.ie_rateio_trib, 'N')FROM 	procedimento_fiscal pwhere 	p.cd_procedimento = b.cd_procedimento)='S' THEN  '10'  ELSE CASE WHEN b.cd_procedimento IS NULL THEN  obter_conversao_externa(NULL, 'UNIDADE_MEDIDA', 'CD_SISTEMA_ANT', b.cd_unidade_medida_compra)  ELSE 'E48' END  END  END  END  END  clave_unidade,
	1 identificacion,
	b.qt_item_nf cantidad,
	CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  'Aplicacion de anticipo'  ELSE CASE WHEN fis_obter_usocfdi(b.nr_sequencia)='G02' THEN  'Descuentos, devoluciones o bonificaciones a CFDI relacionado'  ELSE CASE WHEN cd_material IS NULL THEN  CASE WHEN b.cd_procedimento IS NULL THEN  obter_desc_proc_interno(nr_seq_proc_interno)  ELSE obter_desc_proc_material(NULL, b.cd_procedimento, ie_origem_proced) END   ELSE obter_desc_material(b.cd_material) END  END  END  descripcion,
	b.vl_unitario_item_nf valor_unitario,
	b.vl_total_item_nf importe,
	CASE WHEN CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_vinculo_adiantamento(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_usocfdi(a.nr_sequencia)='G02' THEN  'ACT'  ELSE CASE WHEN(SELECT	coalesce(p.ie_rateio_trib, 'N')from 	procedimento_fiscal pwhere 	p.cd_procedimento = b.cd_procedimento)='S' THEN  '10'  ELSE 'E48' END  END  END  END ='ACT' THEN  'Actividad' WHEN CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_vinculo_adiantamento(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_usocfdi(a.nr_sequencia)='G02' THEN  'ACT'  ELSE CASE WHEN(SELECT	coalesce(p.ie_rateio_trib, 'N')from 	procedimento_fiscal pwhere 	p.cd_procedimento = b.cd_procedimento)='S' THEN  '10'  ELSE 'E48' END  END  END  END ='10' THEN  'Grupo' WHEN CASE WHEN obter_se_anticipo(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_vinculo_adiantamento(a.nr_sequencia)='S' THEN  'ACT'  ELSE CASE WHEN fis_obter_usocfdi(a.nr_sequencia)='G02' THEN  'ACT'  ELSE CASE WHEN(SELECT	coalesce(p.ie_rateio_trib, 'N')from 	procedimento_fiscal pwhere 	p.cd_procedimento = b.cd_procedimento)='S' THEN  '10'  ELSE 'E48' END  END  END  END ='E48' THEN  CASE WHEN b.cd_procedimento IS NULL THEN  obter_desc_unidade_medida(b.cd_unidade_medida_compra)  ELSE 'Unidad de servicio' END   ELSE 'Unidad de servicio' END  unidad,
	b.vl_desconto descuento,
	b.nr_item_nf nr_item,
	a.nr_sequencia nr_sequencia,
	obter_se_possui_iva_zero(a.nr_sequencia,b.nr_item_nf) iva_zero,
	b.vl_liquido vl_liquido,
	nfe_obter_valor_trib_item(a.nr_sequencia,b.nr_item_nf,null,'TRIB') vl_tributo,
	nfe_obter_valor_trib_item(a.nr_sequencia,b.nr_item_nf,null,'BC') vl_base,
	coalesce(c.ie_nota_credito,'N') ie_nota_credito,
	a.nr_sequencia_ref nr_sequencia_ref
from 	nota_fiscal a,
	nota_fiscal_item b,
	operacao_nota c
where 	a.nr_sequencia = b.nr_sequencia
and 	a.cd_operacao_nf = c.cd_operacao_nf;

