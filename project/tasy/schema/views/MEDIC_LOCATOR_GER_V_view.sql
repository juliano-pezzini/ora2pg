-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW medic_locator_ger_v (cd_pessoa_fisica, nm_pessoa_fisica_sem_acento, ds_fonetica, ds_fonetica_cns, nr_crm, ds_bsnr, nm_guerra, ie_corpo_clinico, ie_corpo_assist, nm_usuario, dt_atualizacao, ds_especialidade, ds_vinculo, ie_vinculo_medico, nr_cpf, ds_categoria_medico, nr_seq_categoria, nr_seq_conselho, uf_crm, ds_conselho, nr_seq_person_name, ds_fone_adic, ds_municipio, ds_endereco_compl, ds_compl) AS SELECT A.CD_PESSOA_FISICA, 	
	A.NM_PESSOA_FISICA_SEM_ACENTO,
	A.DS_FONETICA,
	A.DS_FONETICA_CNS, 
	OBTER_CRM_ESP_MEDICO(A.CD_PESSOA_FISICA) NR_CRM,
	OBTER_BSNR_VALORES(A.CD_PESSOA_FISICA) DS_BSNR, 
	B.NM_GUERRA, 
	B.IE_CORPO_CLINICO, 
	B.IE_CORPO_ASSIST, 
	A.NM_USUARIO, 
	A.DT_ATUALIZACAO, 
	SUBSTR(OBTER_ESPECIALIDADES_MEDICO(A.CD_PESSOA_FISICA),1,255) DS_ESPECIALIDADE, 
	SUBSTR(OBTER_VALOR_DOMINIO(3,B.IE_VINCULO_MEDICO),1,120) DS_VINCULO, 
	B.IE_VINCULO_MEDICO, 
	A.NR_CPF, 
	SUBSTR(OBTER_DESC_CATEG_MEDICO(B.NR_SEQ_CATEGORIA),1,80) DS_CATEGORIA_MEDICO, 
	B.NR_SEQ_CATEGORIA, 
	A.NR_SEQ_CONSELHO, 
	SUBSTR(coalesce(UF_CRM,OBTER_COMPL_PF(A.CD_PESSOA_FISICA,1,'UF')),1,2) UF_CRM, 
	SUBSTR(OBTER_CONSELHO_PROFISSIONAL(A.NR_SEQ_CONSELHO,'S'),1,255) DS_CONSELHO,
  A.NR_SEQ_PERSON_NAME,
  (select CASE WHEN max(compl.ds_fone_adic) IS NULL THEN  null  ELSE max(compl.ds_fone_adic) || ' / ' END  || max(compl.nr_telefone) 
      FROM compl_pessoa_fisica compl 
      where compl.cd_pessoa_fisica = a.cd_pessoa_fisica 
      and compl.IE_TIPO_COMPLEMENTO = 2) ds_fone_adic,
  (select max(compl.DS_MUNICIPIO) 
      from compl_pessoa_fisica compl 
      where compl.cd_pessoa_fisica = a.cd_pessoa_fisica 
      and compl.IE_TIPO_COMPLEMENTO = 2) ds_municipio,
      (select substr((
      CASE WHEN compl.ds_endereco IS NULL THEN  null  ELSE compl.ds_endereco || ', ' END  ||
      CASE WHEN compl.DS_COMPL_END IS NULL THEN  null  ELSE compl.DS_COMPL_END || ', ' END  ||
      CASE WHEN compl.ds_municipio IS NULL THEN  null  ELSE compl.ds_municipio || ', ' END  ||
      CASE WHEN compl.CD_CEP IS NULL THEN  null  ELSE compl.CD_CEP || ', ' END ), 0,  length(CASE WHEN compl.ds_endereco IS NULL THEN  null  ELSE compl.ds_endereco || ', ' END  ||
      CASE WHEN compl.DS_COMPL_END IS NULL THEN  null  ELSE compl.DS_COMPL_END || ', ' END  ||
      CASE WHEN compl.ds_municipio IS NULL THEN  null  ELSE compl.ds_municipio || ', ' END  ||
      CASE WHEN compl.CD_CEP IS NULL THEN  null  ELSE compl.CD_CEP || ', ' END) -2)    ds_end_compl
    from compl_pessoa_fisica compl
    where compl.cd_pessoa_fisica = a.cd_pessoa_fisica 
    and compl.IE_TIPO_COMPLEMENTO = 2
    ) ds_endereco_compl,
    (select max(compl.ds_complemento)
        from compl_pessoa_fisica compl
        where compl.cd_pessoa_fisica = a.cd_pessoa_fisica
        and   compl.ie_tipo_complemento = 2) ds_compl
	FROM  PESSOA_FISICA A,
	      MEDICO B
	WHERE A.CD_PESSOA_FISICA = B.CD_PESSOA_FISICA
	AND   B.IE_SITUACAO = 'A'
	and   b.ie_vinculo_medico <> 1;

