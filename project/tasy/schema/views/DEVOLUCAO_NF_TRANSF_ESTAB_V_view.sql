-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW devolucao_nf_transf_estab_v (nr_sequencia, cd_estabelecimento, cd_cgc_emitente, cd_serie_nf, nr_sequencia_nf, cd_operacao_nf, dt_emissao, dt_entrada_saida, ie_acao_nf, ie_emissao_nf, ie_tipo_frete, vl_mercadoria, vl_total_nota, nm_usuario, cd_condicao_pagamento, dt_contabil, cd_cgc, cd_pessoa_fisica, vl_ipi, vl_descontos, vl_frete, vl_seguro, vl_despesa_acessoria, ds_observacao, nr_nota_referencia, cd_serie_referencia, cd_natureza_operacao, dt_atualizacao_estoque, vl_desconto_rateio, nr_ordem_compra, nr_lote_contabil, nr_sequencia_ref, nr_interno_conta, nr_seq_protocolo, cd_moeda, vl_conv_moeda, ds_inconsistencia, dt_impressao, ds_obs_desconto_nf, nr_seq_classif_fiscal, ie_entregue_bloqueto, ie_status_envio, nr_seq_exportada, ie_tipo_nota, cd_setor_impressao, nr_seq_motivo_cancel, nr_seq_motivo_devol, nr_recibo, nr_seq_mensalidade, cd_setor_digitacao, cd_conv_integracao, nr_nota_fiscal, nr_nota_frete, nr_danfe, nr_seq_lote_prot, nr_nfe_imp, nr_seq_agenda_pac, cd_tipo_servico, nr_seq_reg_inspecao, ie_nf_eletronica, ie_compl_tributo, nr_seq_importada, nr_nfe_imp_protocolo, cd_conv_entrada, ds_dados_adic_itens, qt_especie, ds_especie, nr_seq_nf_lote_nfe, ie_status_nfe, dt_autor_prot_nfe, dt_cancelamento_nfe, nr_rps, cd_serie_rps, nr_contrato, nr_seq_modelo, nr_seq_romaneio, cd_assinatura_rps, cd_verificacao_nfse, cd_paciente_inf, nr_seq_pgto_prest, nr_formulario, ie_nat_oper_rps, vl_despesa_doc, nr_seq_cme_envio_ext, nm_arquivo_nfse, dt_integracao, dt_emissao_nfe, nr_seq_transf_cme, nr_seq_resp_consig, nr_seq_eme_fatura, nr_seq_cob_previa, nr_nf_externo, nr_seq_grupo_prod, nr_seq_nf_ref, cd_fab_estrangeiro, nr_lacre, nr_seq_fatura, nr_seq_forma_pagto, ds_link_rps, dt_liberacao, nm_usuario_lib, dt_aprovacao, nm_usuario_aprov, ds_versao_aplic_nfe, ds_digest_value_nfe, uf_embarque, ds_local_embarque, dt_cancelamento, nm_usuario_cancel, nr_danfe_referencia, dt_mes_ref_fatur, dt_mes_recebimento, vl_recebido, nr_seq_trans_financ, nr_seq_cliente, dt_competencia, nr_seq_nf_ref_consumo, nr_seq_nf_pagador, nm_usuario_calc, nr_seq_classificacao, cd_moeda_estrangeira, vl_conv_estrangeiro, ds_selo_digital_emissor, nr_seq_far_venda, ie_tipo_recebimento, ds_motivo_cancel_nfe, cd_estabelecimento_conv, cd_cgc_emitente_conv, cd_operacao_nf_conv, cd_condicao_pagto_conv, cd_natureza_operacao_conv) AS select	a.nr_sequencia,
	a.cd_estabelecimento, 
	a.cd_cgc cd_cgc_emitente, 
	a.cd_serie_nf, 
	a.nr_sequencia_nf, 
	a.cd_operacao_nf, 
	a.dt_emissao, 
	a.dt_entrada_saida, 
	a.ie_acao_nf, 
	a.ie_emissao_nf, 
	a.ie_tipo_frete, 
	a.vl_mercadoria, 
	a.vl_total_nota, 
	a.nm_usuario, 
	a.cd_condicao_pagamento, 
	a.dt_contabil, 
	a.cd_cgc, 
	a.cd_pessoa_fisica, 
	a.vl_ipi, 
	a.vl_descontos, 
	a.vl_frete, 
	a.vl_seguro, 
	a.vl_despesa_acessoria, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_observacao) ds_observacao, 
	a.nr_nota_referencia, 
	a.cd_serie_referencia, 
	a.cd_natureza_operacao, 
	a.dt_atualizacao_estoque, 
	a.vl_desconto_rateio, 
	a.nr_ordem_compra, 
	a.nr_lote_contabil, 
	a.nr_sequencia_ref, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.cd_moeda, 
	a.vl_conv_moeda, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_inconsistencia) ds_inconsistencia, 
	a.dt_impressao, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_obs_desconto_nf) ds_obs_desconto_nf, 
	a.nr_seq_classif_fiscal, 
	a.ie_entregue_bloqueto, 
	a.ie_status_envio, 
	a.nr_seq_exportada, 
	a.ie_tipo_nota, 
	a.cd_setor_impressao, 
	a.nr_seq_motivo_cancel, 
	a.nr_seq_motivo_devol, 
	a.nr_recibo, 
	a.nr_seq_mensalidade, 
	a.cd_setor_digitacao, 
	a.cd_conv_integracao, 
	a.nr_nota_fiscal, 
	a.nr_nota_frete, 
	a.nr_danfe, 
	a.nr_seq_lote_prot, 
	a.nr_nfe_imp, 
	a.nr_seq_agenda_pac, 
	a.cd_tipo_servico, 
	a.nr_seq_reg_inspecao, 
	a.ie_nf_eletronica, 
	a.ie_compl_tributo, 
	a.nr_seq_importada, 
	a.nr_nfe_imp_protocolo, 
	a.cd_conv_entrada, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_dados_adic_itens) ds_dados_adic_itens, 
	a.qt_especie, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_especie) ds_especie, 
	a.nr_seq_nf_lote_nfe, 
	a.ie_status_nfe, 
	a.dt_autor_prot_nfe, 
	a.dt_cancelamento_nfe, 
	a.nr_rps, 
	a.cd_serie_rps, 
	a.nr_contrato, 
	a.nr_seq_modelo, 
	a.nr_seq_romaneio, 
	a.cd_assinatura_rps, 
	a.cd_verificacao_nfse, 
	a.cd_paciente_inf, 
	a.nr_seq_pgto_prest, 
	a.nr_formulario, 
	a.ie_nat_oper_rps, 
	a.vl_despesa_doc, 
	a.nr_seq_cme_envio_ext, 
	ELIMINA_CARACTERE_ESPECIAL(a.nm_arquivo_nfse) nm_arquivo_nfse, 
	a.dt_integracao, 
	a.dt_emissao_nfe, 
	a.nr_seq_transf_cme, 
	a.nr_seq_resp_consig, 
	a.nr_seq_eme_fatura, 
	a.nr_seq_cob_previa, 
	a.nr_nf_externo, 
	a.nr_seq_grupo_prod, 
	a.nr_seq_nf_ref, 
	a.cd_fab_estrangeiro, 
	a.nr_lacre, 
	a.nr_seq_fatura, 
	a.nr_seq_forma_pagto, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_link_rps) ds_link_rps, 
	a.dt_liberacao, 
	a.nm_usuario_lib, 
	a.dt_aprovacao, 
	a.nm_usuario_aprov, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_versao_aplic_nfe) ds_versao_aplic_nfe, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_digest_value_nfe) ds_digest_value_nfe, 
	a.uf_embarque, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_local_embarque) ds_local_embarque, 
	a.dt_cancelamento, 
	a.nm_usuario_cancel, 
	a.nr_danfe_referencia, 
	a.dt_mes_ref_fatur, 
	a.dt_mes_recebimento, 
	a.vl_recebido, 
	a.nr_seq_trans_financ, 
	a.nr_seq_cliente, 
	a.dt_competencia, 
	a.nr_seq_nf_ref_consumo, 
	a.nr_seq_nf_pagador, 
	a.nm_usuario_calc, 
	a.nr_seq_classificacao, 
	a.cd_moeda_estrangeira, 
	a.vl_conv_estrangeiro, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_selo_digital_emissor) ds_selo_digital_emissor, 
	a.nr_seq_far_venda, 
	a.ie_tipo_recebimento, 
	ELIMINA_CARACTERE_ESPECIAL(a.ds_motivo_cancel_nfe) ds_motivo_cancel_nfe, 
	substr(bkf_obter_conv_externa('','ESTABELECIMENTO','CD_ESTABELECIMENTO',a.CD_ESTABELECIMENTO,'BKF'),1,30) CD_ESTABELECIMENTO_CONV, 
	substr(obter_dados_pf_pj(null,a.cd_cgc,'CSA'),1,80) cd_cgc_emitente_CONV, 
	substr(bkf_obter_conv_externa('','OPERACAO_NOTA','CD_OPERACAO_NF',a.cd_operacao_nf,'BKF'),1,30) cd_operacao_nf_CONV, 
	substr(bkf_obter_conv_externa('','CONDICAO_PAGAMENTO','CD_CONDICAO_PAGAMENTO',a.cd_condicao_pagamento,'BKF'),1,30) cd_condicao_pagto_CONV, 
	substr(bkf_obter_conv_externa('','NATUREZA_OPERACAO','CD_NATUREZA_OPERACAO',a.cd_natureza_operacao,'BKF'),1,30) cd_natureza_operacao_CONV 
FROM	nota_fiscal a, 
	operacao_nota b 
where	a.cd_operacao_nf = b.cd_operacao_nf 
and	a.dt_atualizacao_estoque is not null 
and	a.ie_situacao = '1' 
and	b.ie_devolucao = 'S' 
and a.nr_sequencia_ref > 0 
and exists (	select 1 
		from  nota_fiscal_item x, 
			ordem_compra y 
		where	x.nr_ordem_compra= y.nr_ordem_compra 
		and	x.nr_sequencia = a.nr_sequencia 
		and	y.ie_tipo_ordem = 'T');

