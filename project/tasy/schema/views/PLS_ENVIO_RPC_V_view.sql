-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_envio_rpc_v (ie_registro, ie_tipo_registro, cd_ans, cd_cgc_operadora, ds_razao_social, dt_comunicado, nr_registro, cd_plano_operadora, nm_comercial, nr_contrato, cd_participacao, dt_inicio_aplicacao_reaj, dt_fim_aplicacao_reaj, dt_inicio_analise, dt_fim_analise, nr_beneficiarios, ie_percentual, pr_reajuste, uf_contrato, ie_contrato_uf, ie_reajuste, ie_reajuste_linear, ie_franquia_copartic, ie_sinal_copartic_franquia, pr_copartic_franquia, ie_caracteristica, ds_justificativa, cd_item_cobertura, vl_ant_alteracao, vl_alteracao, pr_ant_alteracao, pr_alteracao, qt_total_c2, qt_total_c3, qt_total_c4, qt_total_registro, ds_observacao, nr_seq_justificativa, nr_sequencia, nr_seq_plano, nr_seq_lote, nr_seq_reaj_tab) AS select	1			ie_registro,
	'C1' 			ie_tipo_registro, 
	a.cd_ans 		cd_ans, 
	a.cd_cgc_outorgante 	cd_cgc_operadora, 
	b.ds_razao_social 	ds_razao_social, 
	c.dt_reajuste		dt_comunicado, 
	null			nr_registro, 
	null			cd_plano_operadora, 
	null			nm_comercial, 
	null			nr_contrato, 
	null			cd_participacao, 
	null			dt_inicio_aplicacao_reaj, 
	null			dt_fim_aplicacao_reaj, 
	null			dt_inicio_analise, 
	null			dt_fim_analise, 
	null			nr_beneficiarios, 
	null			ie_percentual, 
	null			pr_reajuste, 
	null			uf_contrato, 
	null			ie_contrato_uf, 
	null			ie_reajuste, 
	null			ie_reajuste_linear, 
	null			ie_franquia_copartic, 
	null			ie_sinal_copartic_franquia, 
	null			pr_copartic_franquia, 
	null			ie_caracteristica, 
	null			ds_justificativa, 
	null			cd_item_cobertura, 
	null			vl_ant_alteracao, 
	null			vl_alteracao, 
	null			pr_ant_alteracao, 
	null			pr_alteracao, 
	null			qt_total_c2, 
	null			qt_total_c3, 
	null			qt_total_c4, 
	null	 		qt_total_registro, 
	null			ds_observacao, 
	null			nr_seq_justificativa, 
	c.nr_sequencia		nr_sequencia, 
	0			nr_seq_plano, 
	e.nr_seq_lote		nr_seq_lote, 
	0			nr_seq_reaj_tab 
FROM pls_contrato d, pessoa_juridica b, pls_outorgante a, pls_reajuste c
LEFT OUTER JOIN pls_rpc_contrato e ON (c.nr_sequencia = e.nr_seq_reajuste)
WHERE a.nr_sequencia		= d.nr_seq_operadora and c.nr_seq_contrato	= d.nr_sequencia and a.cd_cgc_outorgante	= b.cd_cgc  and exists (select	1 
		from	pls_reajuste_tabela	x, 
			pls_plano		y 
		where	x.nr_seq_plano		= y.nr_sequencia 
		and	x.nr_seq_reajuste	= c.nr_sequencia 
		and	y.ie_tipo_operacao	= 'B') 
 
union all
 
select 	2						ie_registro, 
	'C2' 						ie_tipo_registro, 
	null						cd_ans, 
	null						cd_cgc_operadora, 
	null						ds_razao_social, 
	LOCALTIMESTAMP 					dt_comunicado, 
	coalesce(c.nr_protocolo_ans,999999999) 		nr_registro, 
	CASE WHEN c.nr_protocolo_ans IS NULL THEN ''  ELSE 999999999 END  	cd_plano_operadora, 
	c.ds_plano					nm_comercial, 
	coalesce(e.nr_contrato_arquivo,d.nr_contrato)	nr_contrato, 
	CASE WHEN c.ie_participacao='C' THEN 1 WHEN c.ie_participacao='S' THEN 2  ELSE 2 END  	cd_participacao, 
	coalesce(a.dt_periodo_inicial,trunc(a.dt_reajuste,'month'))	dt_inicio_aplicacao_reaj, 
	coalesce(a.dt_periodo_final,last_day(a.dt_reajuste))	dt_fim_aplicacao_reaj, 
	a.dt_reajuste					dt_inicio_analise, 
	a.dt_reajuste					dt_fim_analise, 
	(	select	count(1) 
		from	pls_segurado x 
		where	x.nr_seq_contrato = e.nr_seq_contrato 
		and	x.dt_liberacao is not null 
		and	((x.dt_rescisao is null) or (x.dt_rescisao > a.dt_reajuste)))	nr_beneficiarios, 
	CASE WHEN a.tx_deflator='' THEN 'P'  ELSE 'N' END  		ie_percentual, 
	--replace(a.tx_reajuste,',','')			pr_reajuste, 
	round((a.tx_reajuste)::numeric,2)				pr_reajuste,	 
	substr(obter_dados_pf_pj(d.cd_pf_estipulante,d.cd_cgc_estipulante,'UF'),1,255) uf_contrato, 
	'E' 						ie_contrato_uf, 
	2						ie_reajuste, 
	'S' 						ie_reajuste_linear, 
	c.ie_franquia 					ie_franquia_copartic, 
	CASE WHEN a.tx_reajuste IS NULL THEN 'N'  ELSE 'P' END  		ie_sinal_copartic_franquia, 
	CASE WHEN c.ie_franquia='N' THEN 0  ELSE round((a.tx_reajuste)::numeric,2) END 	pr_copartic_franquia, 
	e.ie_caracteristica				ie_caracteristica, 
	null						ds_justificativa, 
	null						cd_item_cobertura, 
	null						vl_ant_alteracao, 
	null						vl_alteracao, 
	null						pr_ant_alteracao, 
	null						pr_alteracao, 
	null						qt_total_c2, 
	null						qt_total_c3, 
	null						qt_total_c4, 
	null						qt_total_registro, 
	null						ds_observacao, 
	null						nr_seq_justificativa, 
	a.nr_sequencia					nr_sequencia, 
	c.nr_sequencia					nr_seq_plano, 
	e.nr_seq_lote					nr_seq_lote, 
	0						nr_seq_reaj_tab 
FROM pls_contrato d, pls_plano c, pls_reajuste_tabela b, pls_reajuste a
LEFT OUTER JOIN pls_rpc_contrato e ON (a.nr_sequencia = e.nr_seq_reajuste)
WHERE b.nr_seq_reajuste	= a.nr_sequencia and b.nr_seq_plano		= c.nr_sequencia and a.nr_seq_contrato	= d.nr_sequencia  and c.ie_tipo_operacao	= 'B' group by c.nr_protocolo_ans, 
	c.nr_sequencia, 
	c.ds_plano, 
	d.nr_contrato, 
	c.ie_participacao, 
	a.dt_reajuste, 
	a.dt_reajuste, 
	a.dt_periodo_inicial, 
 	a.dt_periodo_final, 
	a.tx_deflator, 
	a.tx_reajuste, 
	d.cd_pf_estipulante, 
	d.cd_cgc_estipulante, 
	c.ie_franquia, 
	c.ie_coparticipacao, 
	a.tx_deflator, 
	a.tx_reajuste, 
	c.nr_protocolo_ans, 
	a.nr_sequencia, 
	e.nr_seq_lote, 
	e.ie_caracteristica, 
	e.nr_contrato_arquivo, 
	e.nr_seq_contrato 

union all
 
select	3			ie_registro, 
	'C3'          ie_tipo_registro, 
	null			cd_ans, 
	null			cd_cgc_operadora, 
	null			ds_razao_social, 
	LOCALTIMESTAMP			dt_comunicado, 
	null			nr_registro, 
	null			cd_plano_operadora, 
	null			nm_comercial, 
	null			nr_contrato, 
	null			cd_participacao, 
	null			dt_inicio_aplicacao_reaj, 
	null			dt_fim_aplicacao_reaj, 
	null			dt_inicio_analise, 
	null			dt_fim_analise, 
	null			nr_beneficiarios, 
	null			ie_percentual, 
	null			pr_reajuste, 
	null			uf_contrato, 
	null			ie_contrato_uf, 
	null			ie_reajuste, 
	null			ie_reajuste_linear, 
	null			ie_franquia_copartic, 
	null			ie_sinal_copartic_franquia, 
	null			pr_copartic_franquia, 
	null			ie_caracteristica, 
	coalesce(e.ds_justificativa,'Justificado')	ds_justificativa , 
	null			cd_item_cobertura, 
	null			vl_ant_alteracao, 
	null			vl_alteracao, 
	null			pr_ant_alteracao, 
	null			pr_alteracao, 
	null			qt_total_c2, 
	null			qt_total_c3, 
	null			qt_total_c4, 
	null			qt_total_registro, 
	a.nr_sequencia		ds_observacao, 
	null			nr_seq_justificativa, 
	a.nr_sequencia		nr_sequencia, 
	c.nr_sequencia		nr_seq_plano, 
	e.nr_seq_lote		nr_seq_lote, 
	b.nr_sequencia		nr_seq_reaj_tab 
FROM pls_contrato d, pls_plano c, pls_reajuste_tabela b, pls_reajuste a
LEFT OUTER JOIN pls_rpc_contrato e ON (a.nr_sequencia = e.nr_seq_reajuste)
WHERE b.nr_seq_reajuste	= a.nr_sequencia and b.nr_seq_plano		= c.nr_sequencia and a.nr_seq_contrato	= d.nr_sequencia  and c.ie_tipo_operacao	= 'B' 
 
union all
 
select	4			ie_registro, 
	'C4'			ie_tipo_registro, 
	null			cd_ans, 
	null			cd_cgc_operadora, 
	null			ds_razao_social, 
	LOCALTIMESTAMP			dt_comunicado, 
	null			nr_registro, 
	null			cd_plano_operadora, 
	null			nm_comercial, 
	null			nr_contrato, 
	null			cd_participacao, 
	null			dt_inicio_aplicacao_reaj, 
	null			dt_fim_aplicacao_reaj, 
	null			dt_inicio_analise, 
	null			dt_fim_analise, 
	null			nr_beneficiarios, 
	null			ie_percentual, 
	null			pr_reajuste, 
	null			uf_contrato, 
	null			ie_contrato_uf, 
	null			ie_reajuste, 
	null			ie_reajuste_linear, 
	null			ie_franquia_copartic, 
	null			ie_sinal_copartic_franquia, 
	null			pr_copartic_franquia, 
	null			ie_caracteristica, 
	null			ds_justificativa, 
	--g.cd_tipo_cobertura 	cd_item_cobertura, 
	(	select	max(g.cd_tipo_cobertura) 
		from	pls_cobertura		f, 
			pls_tipo_cobertura	g 
		where	f.nr_seq_plano		= e.nr_sequencia 
		and	f.nr_seq_tipo_cobertura	= g.nr_sequencia) cd_item_cobertura, 
	obter_Valor_sem_virgula(b.vl_preco_inicial)	vl_ant_alteracao, 
	obter_Valor_sem_virgula(b.vl_preco_atual)	vl_alteracao, 
	replace(substr(pls_utimo_registros_reajuste(a.nr_seq_preco,1),1,10),',','')	pr_ant_alteracao, 
	replace(substr(pls_utimo_registros_reajuste(a.nr_seq_preco,2),1,10),',','')	pr_alteracao, 
	null			qt_total_c2, 
	null			qt_total_c3,	 
	null			qt_total_c4, 
	null			qt_total_registro, 
	null			nr_seq_justificativa, 
	c.ds_observacao		ds_observacao, 
	c.nr_sequencia		nr_sequencia, 
	e.nr_sequencia		nr_seq_plano, 
	f.nr_seq_lote		nr_seq_lote, 
	d.nr_sequencia		nr_seq_reaj_tab 
FROM pls_plano e, pls_reajuste_tabela d, pls_plano_preco b, pls_reajuste_preco a, pls_reajuste c
LEFT OUTER JOIN pls_rpc_contrato f ON (c.nr_sequencia = f.nr_seq_reajuste)
WHERE a.nr_seq_preco		= b.nr_sequencia and a.nr_seq_reajuste	= c.nr_sequencia and a.nr_seq_tabela		= d.nr_sequencia and d.nr_seq_reajuste	= c.nr_sequencia and d.nr_seq_plano		= e.nr_sequencia  and e.ie_tipo_operacao	= 'B' and e.ie_franquia		= 'S' 
 
union all
 
select	5			ie_registro, 
	'C9'			ie_tipo_registro, 
	null			cd_ans, 
	null			cd_cgc_operadora, 
	null			ds_razao_social, 
	LOCALTIMESTAMP			dt_comunicado, 
	null			nr_registro, 
	null			cd_plano_operadora, 
	null			nm_comercial, 
	null			nr_contrato, 
	null			cd_participacao, 
	null			dt_inicio_aplicacao_reaj, 
	null			dt_fim_aplicacao_reaj, 
	null			dt_inicio_analise, 
	null			dt_fim_analise, 
	null			nr_beneficiarios, 
	null			ie_percentual, 
	null			pr_reajuste, 
	null			uf_contrato, 
	null			ie_contrato_uf, 
	null			ie_reajuste, 
	null			ie_reajuste_linear, 
	null			ie_franquia_copartic, 
	null			ie_sinal_copartic_franquia, 
	null			pr_copartic_franquia, 
	null			ie_caracteristica, 
	null			ds_justificativa, 
	null			cd_item_cobertura, 
	null			vl_ant_alteracao, 
	null			vl_alteracao, 
	null			pr_ant_alteracao, 
	null			pr_alteracao, 
	substr(obter_quantidade_registros('C2',a.nr_sequencia),1,255)		qt_total_c2, 
	substr(obter_quantidade_registros('C3',a.nr_sequencia),1,255) 		qt_total_c3, 
	substr(obter_quantidade_registros('C4',a.nr_sequencia),1,255) 		qt_total_c4, 
	substr(obter_quantidade_registros('Total',a.nr_sequencia),1,255) 	qt_total_registro, 
	null			ds_observacao, 
	null			nr_seq_justificativa, 
	a.nr_sequencia		nr_sequencia, 
	9999999999999		nr_seq_plano, 
	b.nr_seq_lote		nr_seq_lote, 
	0			nr_seq_reaj_tab 
FROM pls_reajuste a
LEFT OUTER JOIN pls_rpc_contrato b ON (a.nr_sequencia = b.nr_seq_reajuste);

