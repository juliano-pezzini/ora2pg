-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW solicitacao_compra_html_v (nr_solic_compra, ds_observacao, ie_urgente, ds_pessoa_solicitante, cd_pessoa_solicitante, ds_local_estoque, cd_local_estoque, ds_centro_custo, cd_centro_custo, ds_estagio, dt_solicitacao_compra, ds_comprador, nr_cot_compra, ie_estagio, dt_retorno_prev, ds_material, cd_material, ds_material_direto, nr_ordem_compra, cd_comprador_resp, ds_processo_aprov, dt_prevista_entrega, dt_solic_item, ds_justificativa, ds_obs_item, qt_pendente_entrega, qt_entregue, qt_material, cd_motivo_baixa, dt_baixa, nr_contrato, dt_autorizacao, nr_item_solic_compra, ds_aprovador, dt_impressao, ds_tipo_servico, ds_motivo_cancel, nr_seq_motivo_cancel, ds_estabelecimento, cd_estab, dt_liberacao) AS select
    distinct 
    a.nr_solic_compra, 
    substr(a.ds_observacao,1,255) ds_observacao, 
    a.ie_urgente, 
    substr(obter_nome_pf(a.cd_pessoa_solicitante),1,100) ds_pessoa_solicitante, 
	a.cd_pessoa_solicitante, 
    substr(obter_desc_local_estoque(a.cd_local_estoque),1,100) ds_local_estoque, 
	a.cd_local_estoque, 
    substr(obter_desc_centro_custo(a.cd_centro_custo),1,100) ds_centro_custo, 
	a.cd_centro_custo, 
    substr(obter_valor_dominio(1964,obter_estagio_solic_compra(a.nr_solic_compra, b.nr_item_solic_compra)),1,100) ds_estagio, 
    dt_solicitacao_compra, 
    substr(obter_nome_pf(obter_dados_ordem_compra(obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra),'C')),1,100) ds_comprador, 
    b.nr_cot_compra, 
    substr(obter_estagio_solic_compra(a.nr_solic_compra, b.nr_item_solic_compra),1,5) ie_estagio, 
    (select	max(c.dt_retorno_prev) 
    FROM	  cot_compra c 
    where	  c.nr_cot_compra = b.nr_cot_compra) dt_retorno_prev, 
    substr(obter_desc_material(b.cd_material),1,100) ds_material, 
    b.cd_material, 
    substr(b.ds_material_direto,1,255) ds_material_direto, 
    obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra) nr_ordem_compra, 
    a.cd_comprador_resp, 
    substr(obter_processo_aprov_compra(b.nr_seq_aprovacao),1,100) ds_processo_aprov, 
    (select	max(o.dt_entrega) 
    from	  ordem_compra o 
    where	  o.nr_ordem_compra = obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra)) dt_prevista_entrega, 
    b.dt_solic_item, 
    (select substr(substr(obter_select_concatenado('select	ds_justificativa 
						from	ordem_divergencia_solic 
						where	ds_justificativa is not null 
						and	nr_item_oci = ' || b.nr_item_solic_compra || ' 
						and	nr_ordem_compra = ' || obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra), 
    '', '; '),1,255),1,length(substr( 
    obter_select_concatenado(' 
    select	ds_justificativa 
    from	ordem_divergencia_solic 
    where	ds_justificativa is not null 
    and	nr_item_oci = ' || b.nr_item_solic_compra || ' 
    and	nr_ordem_compra = ' || obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra), 
    '', '; '),1,255))-2) ) ds_justificativa, 
    b.ds_observacao ds_obs_item, 
    obter_qt_pendente_entrega(b.nr_solic_compra,b.nr_item_solic_compra) qt_pendente_entrega, 
    coalesce(obter_qt_entregue_solic_nf(b.nr_solic_compra, b.nr_item_solic_compra),0) qt_entregue, 
    b.qt_material, 
    b.cd_motivo_baixa, 
    b.dt_baixa, 
    b.nr_contrato, 
    a.dt_autorizacao, 
    b.nr_item_solic_compra, 
    substr(CASE WHEN a.dt_autorizacao IS NULL THEN ''  ELSE obter_nome_pf(coalesce(a.cd_pessoa_autoriza,obter_pessoa_fisica_usuario(a.nm_usuario_lib,'C'))) END ,1,100) ds_aprovador, 
    a.dt_impressao, 
    substr(obter_valor_dominio(4803,coalesce(a.ie_tipo_servico,'ES')),1,100) ds_tipo_servico, 
    substr(obter_motivo_cancel_oc(coalesce(b.nr_seq_motivo_cancel,a.nr_seq_motivo_cancel)),1,255) ds_motivo_cancel, 
	coalesce(b.nr_seq_motivo_cancel,a.nr_seq_motivo_cancel) nr_seq_motivo_cancel, 
    SUBSTR(obter_nome_estabelecimento(a.cd_estabelecimento),1,255) ds_estabelecimento, 
    a.cd_estabelecimento cd_estab , 
	a.dt_liberacao 
    from	solic_compra a, 
    solic_compra_item b 
    where	a.nr_solic_compra = b.nr_solic_compra 
    
union
 
    select 
    distinct 
     a.nr_solic_compra, 
     substr(a.ds_observacao,1,255) ds_observacao, a.ie_urgente, 
    substr(obter_nome_pf(a.cd_pessoa_solicitante),1,100) ds_pessoa_solicitante, 
	a.cd_pessoa_solicitante, 
    substr(obter_desc_local_estoque(a.cd_local_estoque),1,100) ds_local_estoque, 
	a.cd_local_estoque, 
    substr(obter_desc_centro_custo(a.cd_centro_custo),1,100) ds_centro_custo, 
	a.cd_centro_custo, 
    substr(obter_valor_dominio(1964,obter_estagio_solic_compra(a.nr_solic_compra, b.nr_item_solic_compra)),1,100) ds_estagio, 
    dt_solicitacao_compra, 
    substr(obter_nome_pf(obter_dados_ordem_compra(obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra),'C')),1,100) ds_comprador, 
    b.nr_cot_compra, 
    substr(obter_estagio_solic_compra(a.nr_solic_compra, b.nr_item_solic_compra),1,5) ie_estagio, 
    (select	max(c.dt_retorno_prev) 
    from	  cot_compra c 
    where	  c.nr_cot_compra = b.nr_cot_compra) dt_retorno_prev, 
    substr(obter_desc_material(b.cd_material),1,100) ds_material, 
    b.cd_material, 
    substr(b.ds_material_direto,1,255) ds_material_direto, 
    obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra) nr_ordem_compra, 
    a.cd_comprador_resp, 
    substr(obter_processo_aprov_compra(b.nr_seq_aprovacao),1,100) ds_processo_aprov, 
    (select	max(o.dt_entrega) 
    from	  ordem_compra o 
    where	  o.nr_ordem_compra = obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra)) dt_prevista_entrega, 
    b.dt_solic_item, 
    (select substr(substr(obter_select_concatenado(' 
    select	ds_justificativa 
    from	  ordem_divergencia_solic 
    where	  ds_justificativa is not null 
    and	  nr_item_oci = ' || b.nr_item_solic_compra || ' 
    and	  nr_ordem_compra = ' || obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra), 
    '', '; '),1,255),1,length(substr( 
    obter_select_concatenado(' 
    select	ds_justificativa 
    from	ordem_divergencia_solic 
    where	ds_justificativa is not null 
    and	nr_item_oci = ' || b.nr_item_solic_compra || ' 
    and	nr_ordem_compra = ' || obter_ordem_solic_compra(a.nr_solic_compra,b.nr_item_solic_compra), 
    '', '; '),1,255))-2) ) ds_justificativa, b.ds_observacao ds_obs_item, 
    obter_qt_pendente_entrega(b.nr_solic_compra,b.nr_item_solic_compra) qt_pendente_entrega, 
    coalesce(obter_qt_entregue_solic_nf(b.nr_solic_compra, b.nr_item_solic_compra),0) qt_entregue, 
    b.qt_material   , b.cd_motivo_baixa, b.dt_baixa, b.nr_contrato, a.dt_autorizacao, 
    b.nr_item_solic_compra, 
    substr(CASE WHEN a.dt_autorizacao IS NULL THEN ''  ELSE obter_nome_pf(coalesce(a.cd_pessoa_autoriza,obter_pessoa_fisica_usuario(a.nm_usuario_lib,'C'))) END ,1,100) ds_aprovador, 
    a.dt_impressao, 
    substr(obter_valor_dominio(4803,coalesce(a.ie_tipo_servico,'ES')),1,100) ds_tipo_servico, 
    substr(obter_motivo_cancel_oc(coalesce(b.nr_seq_motivo_cancel,a.nr_seq_motivo_cancel)),1,255) ds_motivo_cancel, 
	coalesce(b.nr_seq_motivo_cancel,a.nr_seq_motivo_cancel) nr_seq_motivo_cancel, 
    substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,255) ds_estabelecimento, 
    a.cd_estabelecimento cd_estab , 
	a.dt_liberacao 
    from	solic_compra a, solic_compra_item b, ordem_compra_item o, nota_fiscal n 
    where	a.nr_solic_compra = b.nr_solic_compra 
    and	o.nr_solic_compra = b.nr_solic_compra 
    and	o.nr_item_solic_compra = b.nr_item_solic_compra 
    and	n.nr_ordem_compra = o.nr_ordem_compra 
    and	n.dt_atualizacao_estoque is not null 
    and	n.ie_situacao = 1;

