-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_resultado_v (dt_referencia, ie_periodo, cd_estabelecimento, cd_convenio, cd_setor_atendimento, ie_tipo_atendimento, dt_receita, ie_protocolo, ie_proc_mat, cd_especialidade, cd_conta_contabil, nr_seq_conta_financ, nr_seq_grupo_rec, cd_estrutura_conta, vl_procedimento, vl_material, vl_terceiro, vl_custo, vl_imposto, ie_complexidade, vl_desconto, ie_pacote, vl_original, cd_categoria, vl_hospital, qt_dia_internacao, dt_entrega, vl_repasse_calc, qt_atendimento, qt_conta, ie_nota_fiscal, cd_plano, nr_atendimento, nr_interno_conta, ie_conveniado, ie_tipo_financ_proc, vl_custo_excluido, cd_grupo, cd_subgrupo, cd_forma_organizacao, ie_complexidade_sus, cd_setor_paciente, cd_centro_custo_setor, cd_conv_atend, nr_seq_agrup_classif, nr_seq_classif_medico, nr_seq_classificacao, qt_resumo, cd_cgc_prestador, nr_prescricao, cd_medico_prescr, ds_tipo_atend, ds_grupo_rec, ds_complexidade_proc, cd_classificacao_setor, ds_classificacao_setor, ds_convenio_categoria, cd_convenio_categoria, ds_convenio_plano, ds_conv_nac, ds_conv_int, ie_conv_nac, ds_classif_convenio, ds_centro_custo_setor, ds_tipo_financiamento, cd_empresa_estab, ds_municipio_ibge_pf, ie_clinica_atend, ds_clinica_atend, nr_seq_prot, ds_setor_atend, ds_setor_pac, nr_prot, ds_espec, nm_medico_atend, cd_cid_doenca, ds_cid_doenca, ie_tipo_prot, ds_tipo_prot, ds_proced_atend, ds_estab, ds_grupo_sus, ds_subgrupo_sus, ds_forma_org_sus, ds_complex_sus, ds_conv_atend, nm_medico_ref, cd_pessoa_fisica, cd_categ_cid, ds_categ_cid, ds_agrupamento_classif, cd_estabelecimento_atend, ds_classificacao_medico, ds_classificacao_atend, ds_prest, nm_medico_prescricao, ds_ie_pacote, ds_ie_proc_mat, ds_ie_protocolo, ds_estabelecimento_atend, ds_motivo_atendimento, ds_origem_convenio, cd_proced_atend, ds_conv_conta, ie_tipo_conv, ds_tipo_conv, ds_idade_pf, ie_complex_princ_sus, ie_tipo_fin_princ_sus, ie_proc_material, ie_tipo_convenio, ds_convenio, ds_entrega, ds_ano, dt_ano, ds_grupo_receita, cd_estrutura, ds_complexidade, vl_faturado, vl_total, vl_total_sem_repasse, vl_total_sem_imposto, vl_result_pacote, vl_margem, pr_margem, cd_classif_setor, ds_classif_setor, ds_categoria, ds_conv_categ, ds_plano, ds_convenio_nacional, ds_convenio_internacional, ie_nacional, ds_classificacao, cd_centro_custo, ds_centro_custo, ds_tipo_financ_proc, cd_empresa, ds_municipio_ibge, ie_clinica, ds_clinica, nr_seq_protocolo, ds_setor_atendimento, ds_setor_paciente, nr_protocolo, ds_especialidade, nm_medico_atendimento, ds_cid, cd_cid, ie_tipo_protocolo, ds_tipo_protocolo, cd_procedencia, ds_idade, ds_estabelecimento, ds_grupo, ds_subgrupo, ds_forma_organizacao, ds_complexidade_sus, ds_complex_princ_sus, ds_tipo_fin_princ_sus, cd_convenio_atend, ds_convenio_atend, vl_resultado_sem_rep, nm_medico_referido, cd_paciente, cd_categoria_cid, vl_total_sem_repasses, ds_agrup_classif, cd_estab_atend, ds_classif_medico, ds_classif_atend, ds_prestador, nm_medico_prescr, ds_pacote, ds_tipo_atendimento, ds_tipo_convenio, ds_proc_mat, ds_protocolo, ds_procedencia, ds_estab_atend, ds_protocolo_conv, ds_motivo_atend, ds_categoria_doenca, ds_origem_conv, vl_total_sem_repasse_calc, vl_margem_calc) AS select	a.DT_REFERENCIA,a.IE_PERIODO,a.CD_ESTABELECIMENTO,a.CD_CONVENIO,a.CD_SETOR_ATENDIMENTO,a.IE_TIPO_ATENDIMENTO,a.DT_RECEITA,a.IE_PROTOCOLO,a.IE_PROC_MAT,a.CD_ESPECIALIDADE,a.CD_CONTA_CONTABIL,a.NR_SEQ_CONTA_FINANC,a.NR_SEQ_GRUPO_REC,a.CD_ESTRUTURA_CONTA,a.VL_PROCEDIMENTO,a.VL_MATERIAL,a.VL_TERCEIRO,a.VL_CUSTO,a.VL_IMPOSTO,a.IE_COMPLEXIDADE,a.VL_DESCONTO,a.IE_PACOTE,a.VL_ORIGINAL,a.CD_CATEGORIA,a.VL_HOSPITAL,a.QT_DIA_INTERNACAO,a.DT_ENTREGA,a.VL_REPASSE_CALC,a.QT_ATENDIMENTO,a.QT_CONTA,a.IE_NOTA_FISCAL,a.CD_PLANO,a.NR_ATENDIMENTO,a.NR_INTERNO_CONTA,a.IE_CONVENIADO,a.IE_TIPO_FINANC_PROC,a.VL_CUSTO_EXCLUIDO,a.CD_GRUPO,a.CD_SUBGRUPO,a.CD_FORMA_ORGANIZACAO,a.IE_COMPLEXIDADE_SUS,a.CD_SETOR_PACIENTE,a.CD_CENTRO_CUSTO_SETOR,a.CD_CONV_ATEND,a.NR_SEQ_AGRUP_CLASSIF,a.NR_SEQ_CLASSIF_MEDICO,a.NR_SEQ_CLASSIFICACAO,a.QT_RESUMO,a.CD_CGC_PRESTADOR,a.NR_PRESCRICAO,a.CD_MEDICO_PRESCR,a.DS_TIPO_ATEND,a.DS_GRUPO_REC,a.DS_COMPLEXIDADE_PROC,a.CD_CLASSIFICACAO_SETOR,a.DS_CLASSIFICACAO_SETOR,a.DS_CONVENIO_CATEGORIA,a.CD_CONVENIO_CATEGORIA,a.DS_CONVENIO_PLANO,a.DS_CONV_NAC,a.DS_CONV_INT,a.IE_CONV_NAC,a.DS_CLASSIF_CONVENIO,a.DS_CENTRO_CUSTO_SETOR,a.DS_TIPO_FINANCIAMENTO,a.CD_EMPRESA_ESTAB,a.DS_MUNICIPIO_IBGE_PF,a.IE_CLINICA_ATEND,a.DS_CLINICA_ATEND,a.NR_SEQ_PROT,a.DS_SETOR_ATEND,a.DS_SETOR_PAC,a.NR_PROT,a.DS_ESPEC,a.NM_MEDICO_ATEND,a.CD_CID_DOENCA,a.DS_CID_DOENCA,a.IE_TIPO_PROT,a.DS_TIPO_PROT,a.DS_PROCED_ATEND,a.DS_ESTAB,a.DS_GRUPO_SUS,a.DS_SUBGRUPO_SUS,a.DS_FORMA_ORG_SUS,a.DS_COMPLEX_SUS,a.DS_CONV_ATEND,a.NM_MEDICO_REF,a.CD_PESSOA_FISICA,a.CD_CATEG_CID,a.DS_CATEG_CID,a.DS_AGRUPAMENTO_CLASSIF,a.CD_ESTABELECIMENTO_ATEND,a.DS_CLASSIFICACAO_MEDICO,a.DS_CLASSIFICACAO_ATEND,a.DS_PREST,a.NM_MEDICO_PRESCRICAO,a.DS_IE_PACOTE,a.DS_IE_PROC_MAT,a.DS_IE_PROTOCOLO,a.DS_ESTABELECIMENTO_ATEND,a.DS_MOTIVO_ATENDIMENTO,a.DS_ORIGEM_CONVENIO,a.CD_PROCED_ATEND,a.DS_CONV_CONTA,a.IE_TIPO_CONV,a.DS_TIPO_CONV,a.DS_IDADE_PF,a.IE_COMPLEX_PRINC_SUS,a.IE_TIPO_FIN_PRINC_SUS,
	somente_numero(a.ie_proc_mat) ie_proc_material, 
	b.ie_tipo_convenio, 
	b.ds_convenio, 
	to_char(a.dt_entrega, 'dd/mm/YYYY') ds_entrega, 
	to_char(a.dt_referencia, 'YYYY') ds_ano, 
	trunc(a.dt_referencia, 'year') dt_ano, 
	substr(obter_desc_grupo_rec(a.nr_seq_grupo_rec),1,200) ds_grupo_receita, 
	somente_numero(a.cd_estrutura_conta) cd_estrutura, 
	substr(obter_valor_dominio(1074, a.ie_complexidade),1,200) ds_complexidade, 
	(a.vl_Procedimento + a.vl_Material - a.vl_imposto) vl_faturado, 
	(a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) vl_total, 
	(a.vl_Procedimento + a.vl_Material) vl_total_sem_repasse, 
	(a.vl_Procedimento + a.vl_Material + a.Vl_terceiro - a.vl_imposto) vl_total_sem_imposto, 
	(a.vl_procedimento + a.vl_material - coalesce(a.vl_original,0)) vl_result_pacote, 
	(a.vl_Procedimento + a.vl_Material - a.vl_custo - a.vl_imposto) vl_margem, 
	(dividir((a.vl_Procedimento + a.vl_Material - a.vl_custo - a.vl_imposto), 
		CASE WHEN(a.vl_Procedimento + a.vl_Material)=0 THEN 1  ELSE (a.vl_Procedimento + a.vl_Material) END ) * 100) pr_margem, 
	obter_classif_setor(a.cd_setor_atendimento) cd_classif_setor, 
	substr(obter_valor_dominio(1, obter_classif_setor(a.cd_setor_atendimento)),1,125) ds_classif_setor, 
	--substr(b.ds_convenio || ' - ' || obter_categoria_convenio(a.cd_convenio, a.cd_categoria),1,200) ds_categoria, 
	substr(b.ds_convenio || ' - ' || (select ds_categoria FROM categoria_convenio x where x.cd_convenio = a.cd_convenio and x.cd_categoria = a.cd_categoria),1,200) ds_categoria, 
	substr(a.cd_convenio || a.cd_categoria,1,60) DS_CONV_CATEG, 
	substr(b.ds_convenio || ' - ' || obter_desc_plano(a.cd_convenio, a.cd_plano),1,200) ds_plano, 
	substr(CASE WHEN OBTER_SE_CONV_BRASIL(b.cd_convenio)='S' THEN  b.ds_convenio  ELSE null END ,1,255) ds_convenio_nacional, 
	substr(CASE WHEN OBTER_SE_CONV_BRASIL(b.cd_convenio)='N' THEN  b.ds_convenio  ELSE null END ,1,255) ds_convenio_internacional, 
	substr(CASE WHEN b.cd_convenio IS NULL THEN  'X'  ELSE OBTER_SE_CONV_BRASIL(b.cd_convenio) END ,1,2) ie_nacional, 
	(select	max(x.ds_classificacao) from convenio_classif y, classificacao_convenio x where	x.nr_sequencia	= y.nr_seq_classificacao and y.cd_convenio = a.cd_convenio) ds_classificacao, 
	coalesce(a.cd_centro_custo_setor,obter_centro_custo_setor(a.cd_setor_atendimento, 'C')) cd_centro_custo, 
	CASE WHEN a.cd_centro_custo_setor IS NULL THEN  substr(obter_centro_custo_setor(a.cd_setor_atendimento, 'D'),1,200)  ELSE substr(obter_desc_centro_custo(a.cd_centro_custo_setor),1,200) END  ds_centro_custo, 
	substr(obter_valor_dominio(2135, a.IE_TIPO_FINANC_PROC), 1, 200) ds_tipo_financ_proc, 
	(select	max(cd_empresa) from estabelecimento where	cd_estabelecimento = a.cd_estabelecimento) cd_empresa, 
	substr(Obter_municipio_ibge_atend(a.nr_atendimento),1,200) ds_municipio_ibge, 
	somente_numero(obter_clinica_atend(a.nr_Atendimento,'C')) ie_clinica, 
	substr(obter_clinica_atend(a.nr_Atendimento,'D'),1,200) ds_clinica, 
	Obter_Protocolo_Conpaci(a.nr_interno_conta) nr_seq_protocolo, 
	substr(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor_atendimento, 
	substr(obter_nome_setor(a.cd_setor_paciente),1,100) ds_setor_paciente, 
	substr(OBTER_DESCRICAO_PROTOCOLO(Obter_Protocolo_Conpaci(a.nr_interno_conta)),1,40) nr_protocolo, 
	substr(obter_nome_especialidade(a.cd_especialidade),1,100) ds_especialidade, 
	(select	substr(y.nm_pessoa_fisica,1,100) from	atendimento_paciente x, pessoa_fisica y where	x.nr_atendimento = a.nr_atendimento 
	  and	x.cd_medico_resp = y.cd_pessoa_fisica) nm_medico_atendimento, 
	substr(Obter_Desc_CID_Doenca(obter_cid_atendimento(a.nr_atendimento, 'P')), 1, 200) ds_cid, 
	substr(obter_cid_atendimento(a.nr_atendimento, 'P'),1,255) cd_cid, 
	obter_tipo_protocolo(coalesce(Obter_Protocolo_Conpaci(a.nr_interno_conta),0)) ie_tipo_protocolo, 
	substr(obter_valor_dominio(73,obter_tipo_protocolo(coalesce(Obter_Protocolo_Conpaci(a.nr_interno_conta),0))),1,120) ds_tipo_protocolo, 
	substr(obter_procedencia_atend(nr_atendimento, 'C'),1,255) cd_procedencia, 
	substr(obter_idade_pf(obter_pessoa_atendimento(nr_atendimento,'C'),LOCALTIMESTAMP,'E'),1,60) ds_idade, 
	substr(obter_nome_estabelecimento(cd_estabelecimento),1,220) ds_estabelecimento, 
	substr(Sus_Obter_Desc_Grupo(a.cd_grupo),1,100) ds_grupo, 
	substr(Sus_obter_Desc_Subgrupo(a.cd_subgrupo),1,100) ds_subgrupo, 
	substr(Sus_obter_Desc_Forma_Org(a.cd_forma_organizacao),1,100) ds_forma_organizacao, 
	substr(obter_valor_dominio(1763,a.ie_complexidade_sus),1,120) ds_complexidade_sus, 
	substr(obter_valor_dominio(1763,a.ie_complex_princ_sus),1,120) ds_complex_princ_sus, 
	substr(obter_valor_dominio(2135,a.ie_tipo_fin_princ_sus),1,120) ds_tipo_fin_princ_sus,	 
	coalesce(a.cd_conv_atend, obter_convenio_atendimento(a.nr_atendimento)) cd_convenio_atend, 
	substr(obter_nome_convenio(coalesce(a.cd_conv_atend, obter_convenio_atendimento(a.nr_atendimento))),1,100) ds_convenio_atend, 
	coalesce(a.vl_Procedimento + a.vl_material + a.vl_terceiro,0) - coalesce(a.vl_custo,0) - coalesce(a.vl_repasse_calc,0) vl_resultado_sem_rep, 
	coalesce((select	substr(y.nm_pessoa_fisica,1,100) from	atendimento_paciente x, pessoa_fisica y where	x.nr_atendimento = a.nr_atendimento 
	  and	x.cd_medico_referido = y.cd_pessoa_fisica), 'Não informado') nm_medico_referido, 
	(select	substr(x.cd_pessoa_fisica,1,10) from atendimento_paciente x, conta_paciente y where	x.nr_atendimento = y.nr_atendimento 
	  and y.nr_interno_conta = a.nr_interno_conta) cd_paciente, 
	substr(obter_categoria_cid(obter_cid_atendimento(a.nr_atendimento, 'P')),1,10) cd_categoria_cid, 
	((a.vl_Procedimento + a.vl_Material) - A.VL_REPASSE_CALC) VL_TOTAL_SEM_REPASSES, 
	(select max(ds_agrupamento) from agrupamento_setor b where b.nr_sequencia = a.NR_SEQ_AGRUP_CLASSIF) ds_agrup_classif, 
	obter_estab_atend(a.nr_atendimento) cd_estab_atend, 
	coalesce(substr(obter_medico_classif_atend(a.nr_seq_classif_medico),1,180),'Não informado') ds_classif_medico, 
	substr(obter_desc_classif_atend(a.nr_seq_classificacao),1,60) ds_classif_atend, 
	substr(obter_dados_pf_pj(null, a.cd_cgc_prestador, 'N'),1,100) ds_prestador, 
	coalesce((select substr(y.nm_pessoa_fisica,1,100) from pessoa_fisica y where y.cd_pessoa_fisica = a.cd_medico_prescr), 'Não informado') nm_medico_prescr, 
	SUBSTR(OBTER_VALOR_DOMINIO(6, A.IE_PACOTE),1,200) ds_pacote, 
	SUBSTR(OBTER_VALOR_DOMINIO(12, A.IE_TIPO_ATENDIMENTO),1,200) ds_tipo_atendimento, 
	SUBSTR(OBTER_VALOR_DOMINIO(11, B.IE_TIPO_CONVENIO),1,200) ds_tipo_convenio, 
	SUBSTR(OBTER_VALOR_DOMINIO(1077, A.IE_PROC_MAT),1,200) ds_proc_mat, 
	SUBSTR(OBTER_VALOR_DOMINIO(1076, A.IE_PROTOCOLO),1,200) ds_protocolo, 
	SUBSTR(OBTER_PROCEDENCIA_ATEND(NR_ATENDIMENTO,'D'),1,200) ds_procedencia, 
	SUBSTR(OBTER_NOME_ESTABELECIMENTO(obter_estab_atend(a.nr_atendimento)),1,220) ds_estab_atend, 
	SUBSTR(OBTER_DESCRICAO_PROTOCOLO(OBTER_PROTOCOLO_CONPACI(A.NR_INTERNO_CONTA)),1,40) ds_protocolo_conv, 
	SUBSTR(OBTER_DESC_QUEIXA(OBTER_MOTIVO_ATENDIMENTO(A.NR_ATENDIMENTO)),1,200) ds_motivo_atend, 
	SUBSTR(OBTER_DESC_CATEGORIA_CID(substr(obter_categoria_cid(obter_cid_atendimento(a.nr_atendimento, 'P')),1,10)),1,200) ds_categoria_doenca, 
	SUBSTR(OBTER_CONV_ORIGEM_USUARIO(OBTER_ORIGEM_CONV_ATEND(NR_ATENDIMENTO,'C')),1,60) ds_origem_conv, 
	((a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) - A.VL_REPASSE_CALC) VL_TOTAL_SEM_REPASSE_CALC, 
        ((a.vl_Procedimento + a.vl_Material + a.Vl_terceiro) - vl_repasse_calc - a.vl_custo - a.vl_imposto) vl_margem_calc 
FROM eis_resultado a
LEFT OUTER JOIN convenio b ON (a.cd_convenio = b.cd_convenio);

