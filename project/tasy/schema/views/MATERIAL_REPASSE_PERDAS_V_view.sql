-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW material_repasse_perdas_v (cd_conta_contabil, cd_medico, dt_atualizacao, dt_atualizacao_nrec, dt_contabil, dt_contabil_titulo, ie_analisado, ie_desc_caixa, ie_repasse_calc, nm_usuario, nm_usuario_nrec, nr_interno_conta_est, nr_repasse_terceiro, nr_seq_criterio, nr_seq_motivo_des, nr_seq_ret_glosa, nr_seq_terceiro, nr_seq_trans_fin, nr_seq_trans_fin_rep_maior, vl_original_repasse, nr_seq_material, vl_repasse, vl_liberado, nr_lote_contabil, nr_seq_origem, cd_regra, nr_sequencia, ds_observacao, nm_usuario_lib, dt_liberacao, ie_estorno, nr_seq_regra_item, nr_interno_conta, nr_seq_mat_crit_repasse, dt_atendimento, ds_convenio, dt_mesano_protoc, cd_material, ds_material, nr_atendimento, cd_paciente, nm_pessoa_fisica, ie_status, nr_seq_protocolo, nr_protocolo, nr_seq_item_retorno, ds_status, ds_transacao, ds_retorno, nm_medico, qt_material, ie_analis, dt_mesano_referencia, ds_tipo_atendimento, ds_setor_atendimento, nm_usuario_original, nm_medico_referido, ds_titulo, nr_nota_fiscal, dt_emissao_nota_fiscal, nr_seq_nota_fiscal, cd_unidade_basica, ds_tipo_conv, vl_material, nm_terceiro, dt_definitivo, vl_desp_cartao, vl_repasse_cheque) AS select  /*+ CHOOSE */       a.cd_conta_contabil,
       a.cd_medico,
       a.dt_atualizacao,
       a.dt_atualizacao_nrec,
       a.dt_contabil,
       a.dt_contabil_titulo,
       a.ie_analisado,
       a.ie_desc_caixa,
       a.ie_repasse_calc,
       a.nm_usuario,
       a.nm_usuario_nrec,
       a.nr_interno_conta_est,
       a.nr_repasse_terceiro,
       a.nr_seq_criterio,
       a.nr_seq_motivo_des,
       a.nr_seq_ret_glosa,
       a.nr_seq_terceiro,
       a.nr_seq_trans_fin,
       a.nr_seq_trans_fin_rep_maior,
       a.vl_original_repasse,
       a.nr_seq_material,
       a.VL_REPASSE,
       a.VL_LIBERADO,
       a.NR_LOTE_CONTABIL,
	     a.NR_SEQ_ORIGEM,
	     a.CD_REGRA,
	     a.NR_SEQUENCIA,
	     substr(a.DS_OBSERVACAO,1,255) ds_observacao,
	     a.NM_USUARIO_LIB,
	     a.DT_LIBERACAO,
	     a.IE_ESTORNO,
	     a.NR_SEQ_REGRA_ITEM,
		  b.nr_interno_conta,
       b.nr_seq_mat_crit_repasse,
       b.dt_atendimento,
       substr(obter_nome_convenio(b.cd_convenio),1,80) ds_convenio,
       trunc(to_date(substr(obter_descricao_padrao('PROTOCOLO_CONVENIO','DT_MESANO_REFERENCIA',T.NR_SEQ_PROTOCOLO),1,10),'dd/mm/yy')) dt_mesano_protoc,
       c.cd_material,
       c.ds_material,
       coalesce(d.nr_atendimento_mae,d.nr_atendimento) nr_atendimento,
       e.cd_pessoa_fisica cd_paciente,
       substr(CASE WHEN coalesce(d.nr_atendimento_mae,0)=0 THEN e.nm_pessoa_fisica  ELSE Obter_Dados_Atendimento(d.nr_atendimento_mae,'NP') END ,1,255) nm_pessoa_fisica,
       a.ie_status,
       t.nr_seq_protocolo,
       t.nr_protocolo,
       a.nr_seq_item_retorno,
       substr(obter_valor_dominio(1129, a.ie_status),1,50) ds_status,
       substr(obter_desc_trans_financ(a.nr_seq_trans_fin),1,100) ds_transacao,
       substr(obter_dados_retorno_convenio(a.nr_seq_item_retorno),1,100) ds_retorno,
       substr(obter_nome_pf_pj(a.cd_medico, null),1,100) nm_medico,
       b.qt_material,
       coalesce(a.ie_analisado, 'N') ie_analis,
       to_char(t.dt_mesano_referencia, 'dd/mm/yyyy') dt_mesano_referencia,
       substr(obter_nome_tipo_atend(d.ie_tipo_atendimento),1,80) ds_tipo_atendimento,
       substr(obter_nome_setor(b.cd_setor_atendimento),1,255) ds_setor_atendimento,
       b.NM_USUARIO_ORIGINAL,
       substr(obter_nome_pf_pj(d.cd_medico_referido,null),1,255) nm_medico_referido,
       (substr(obter_titulo_conta_protocolo(0,t.NR_INTERNO_CONTA),1,100)||substr(obter_titulo_conta_protocolo(t.nr_seq_protocolo,0),1,100)) ds_titulo,
       substr(obter_nota_fiscal_repasse(b.nr_interno_conta, 'N', p.nr_seq_protocolo, p.nr_seq_lote_protocolo),1,255) nr_nota_fiscal,
       obter_dt_emissao_nf(b.nr_interno_conta) dt_emissao_nota_fiscal,
       somente_numero(obter_nota_fiscal_repasse(b.nr_interno_conta, 'S', p.nr_seq_protocolo, p.nr_seq_lote_protocolo)) nr_seq_nota_fiscal,
       f.cd_unidade_basica,
       substr(obter_valor_dominio(11,g.ie_tipo_convenio),1,255) ds_tipo_conv,
		  b.vl_material,
       substr(obter_nome_terceiro(a.nr_seq_terceiro),1,255) nm_terceiro,
       (select max(w.dt_definitivo) FROM protocolo_convenio w where w.nr_seq_protocolo = t.nr_seq_protocolo) dt_definitivo,
       a.vl_desp_cartao
       , null vl_repasse_cheque
FROM convenio g, atend_paciente_unidade f, pessoa_fisica e, atendimento_paciente d, material c, material_atend_paciente b, material_repasse a, conta_paciente t
LEFT OUTER JOIN protocolo_convenio p ON (t.nr_seq_protocolo = p.nr_seq_protocolo)
WHERE a.nr_seq_material       = b.nr_sequencia and b.cd_material           = c.cd_material and t.nr_interno_conta      = b.nr_interno_conta and b.nr_atendimento        = d.nr_atendimento and d.cd_pessoa_fisica      = e.cd_pessoa_fisica and b.nr_seq_atepacu        = f.nr_seq_interno and t.cd_convenio_parametro = g.cd_convenio  and a.ie_status             = 'P' and a.nr_repasse_terceiro   is null;

