-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW man_sup_dashboard_sla_v (nr_sequencia, nr_seq_gerencia, nr_seq_grupo_sup, dt_ordem, ds_localizacao, dt_triagem, ds_dano_breve, ds_grupo_des, ie_sla_leg, min_aguardando_triagem, nr_atraso) AS select	t.NR_SEQUENCIA,t.NR_SEQ_GERENCIA,t.NR_SEQ_GRUPO_SUP,t.DT_ORDEM,t.DS_LOCALIZACAO,t.DT_TRIAGEM,t.DS_DANO_BREVE,t.DS_GRUPO_DES,t.IE_SLA_LEG,
		man_obter_min_com(1, t.dt_ordem, t.dt_triagem) || ' min' min_aguardando_triagem,
		case	when	man_obter_min_com(1, t.dt_ordem, t.dt_triagem) <= 30
				then 1
			else 3
		end nr_atraso
	FROM	(
			select	a.nr_sequencia,
				a.nr_seq_gerencia_sup nr_seq_gerencia,
				a.nr_seq_grupo_sup,
				a.dt_ordem_servico dt_ordem,
				a.ds_localizacao,
				(
					select	coalesce(min(a2.dt_atualizacao), LOCALTIMESTAMP)
					from	man_ordem_serv_estagio a2
					where	a2.nr_seq_ordem = a.nr_sequencia
					and	a2.nr_sequencia =
						(
							select	min(a1.nr_sequencia)
							from	man_ordem_serv_estagio a1
							where	a1.nr_seq_estagio <> 231
							and	a1.nr_seq_ordem = a2.nr_seq_ordem
						)
				)
				dt_triagem,
				a.ds_dano_breve,
				substr(obter_desc_expressao(b.cd_exp_grupo, b.ds_grupo), 1, 255) ds_grupo_des,
				man_obter_sla_leg(a.nr_sequencia) ie_sla_leg
			from man_ordem_servico_v a,
				grupo_suporte b
			where	a.nr_seq_grupo_sup = b.nr_sequencia
			and	a.ie_classificacao = 'E'
			and	a.ie_terceiro        = 'S'
			and	a.ie_status_ordem   <> 3
			and	a.nr_seq_grupo_sup  <> 85
				/*-- não foi triada ainda*/


				/*--/**/


			and not exists (
					select	1
					from	man_ordem_serv_estagio a1
					where	a1.nr_seq_estagio <> 231
					and	a1.nr_seq_ordem = a.nr_sequencia
				)
				/*
				31	Suporte - Análise
				121	Aguardando Conexão
				151	Retorno Cliente
				311	Aguardando Auxílio Externo
				861	Em conexão
				1341	Aguardando Inf. do Cliente - Suporte
				1371	Aguardando Auxílio Interno - Grupo
				1431	Aguardando Auxílio Interno - Analista
				1821	Suporte nível 2
				2113	Triada
				231	Aguardando Triagem
				*/

			and a.nr_seq_estagio in (31, 121, 151, 311, 861, 1341, 1371, 1431, 1821, 2113, 231)
		) t;

