-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pagamento_escrit_caixa_v (ie_registro, tp_registro, nr_inscricao, nr_contrato, nr_seq_envio, nr_seq_remessa, cd_agencia, cd_conta, nr_digito_conta, nm_empresa, dt_arquivo, hr_arquivo, ie_tipo_servico, ie_forma_lancamento, ds_mensagem, ds_endereco, nr_endereco, ds_complemento, ds_cidade, cd_cep, cd_compl_cep, sg_estado, ie_emissao_lote, ie_tipo_movimento, cd_movimento, cd_banco, cd_compensacao, nm_favorecido, nr_documento, dt_lancamento, vl_saldo_titulo, ie_emissao_individual, vl_pagamento, dt_pagamento, nm_pagador, ds_informacoes, ds_aviso, qt_registros, vl_total_pagto, cd_moeda, cd_barras, dt_vencimento, dt_dia_venc, vl_titulo, vl_desconto, vl_acrescimo, vl_pagto, qt_moeda, cd_sacado, qt_lotes_arquivos, qt_total_registros, ds_bairro, tp_inscricao, cd_cgc_fornecedor, nr_titulo, nr_remessa, cd_convenio) AS select	1						ie_registro,
	0						tp_registro, 
	a.cd_cgc					nr_inscricao, 
	g.cd_interno					nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	coalesce(e.nr_remessa,e.nr_sequencia)		nr_seq_remessa, 
	somente_numero(g.cd_agencia_bancaria)		cd_agencia, 
	(g.cd_conta)::numeric 				cd_conta, 
	g.ie_digito_conta				nr_digito_conta, 
	upper(p.ds_razao_social)			nm_empresa, 
	e.dt_remessa_retorno				dt_arquivo, 
	to_char(e.dt_remessa_retorno,'hh24miss')	hr_arquivo, 
	0						ie_tipo_servico, 
	'0'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	g.cd_convenio_banco				cd_convenio 
FROM	estabelecimento a, 
	banco_estabelecimento_v g, 
	pessoa_juridica p, 
	banco_escritural e 
where	e.cd_estabelecimento  	= a.cd_estabelecimento 
 and	a.cd_cgc		= p.cd_cgc 
 and	g.nr_sequencia		= e.nr_seq_conta_banco 
 and	g.ie_tipo_relacao   	in ('EP','ECC') 

union
 
/*	Header do Lote		*/
 
select	distinct 2					ie_registro, 
	1						tp_registro, 
	e.cd_cgc					nr_inscricao, 
	b.cd_interno					nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	coalesce(a.nr_remessa,a.nr_sequencia)		nr_seq_remessa, 
	somente_numero(b.cd_agencia_bancaria)		cd_agencia, 
	(b.cd_conta)::numeric 				cd_conta, 
	b.ie_digito_conta				nr_digito_conta, 
	upper(j.ds_razao_social)			nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	20						ie_tipo_servico, 
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_lancamento, 
	' '						ds_mensagem, 
	upper(j.ds_endereco)				ds_endereco, 
	' '						nr_endereco, 
	upper(j.ds_complemento)				ds_complemento, 
	upper(j.ds_municipio)				ds_cidade, 
	substr(j.cd_cep,1,5)				cd_cep, 
	substr(j.cd_cep,6,3)				cd_compl_cep, 
	upper(j.sg_estado)				sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	pessoa_juridica j, 
	Estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_escrit c 
where	a.nr_sequencia		= c.nr_seq_escrit 
 and	e.cd_cgc		= j.cd_cgc 
 and	a.cd_estabelecimento  = e.cd_estabelecimento 
 and	b.ie_tipo_relacao    in ('EP','ECC') 
 and	b.nr_sequencia		= a.nr_seq_conta_banco 
 and	c.ie_tipo_pagamento	in ('DOC','TED','CC','CCP','OP','PC') 

union
 
/*	Detalhe Documento - Segmento A	*/
 
select	distinct 3					ie_registro, 
	2						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	coalesce(a.nr_remessa,a.nr_sequencia)		nr_seq_remessa, 
	somente_numero(c.cd_agencia_bancaria)		cd_agencia, 
	(c.nr_conta)::numeric 				cd_conta, 
	c.ie_digito_conta				nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	c.cd_banco					cd_banco, 
	c.cd_camara_compensacao				cd_compensacao, 
	d.nm_favorecido					nm_favorecido, 
	d.nr_titulo					nr_documento, 
	d.dt_emissao					dt_lancamento, 
	coalesce(d.vl_saldo_titulo,0)			vl_saldo_titulo, 
	'S'						ie_emissao_individual, 
	c.vl_escritural					vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	'' 						cd_moeda, 
	' '						cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	substr(d.dt_vencimento_atual,1,2)			dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	d.cd_favorecido 				cd_cgc_fornecedor, 
	d.nr_titulo					nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_v2 d, 
	titulo_pagar_escrit c 
where	c.nr_titulo		= d.nr_titulo 
and	a.nr_sequencia		= c.nr_seq_escrit 
and	a.cd_estabelecimento	= e.cd_estabelecimento 
and 	b.ie_tipo_relacao	in ('EP','ECC') 
and	b.nr_sequencia		= a.nr_seq_conta_banco 
and 	c.ie_tipo_pagamento	in ('DOC','TED','CC','CCP','OP','PC') 

Union
 
/*	Detalhe Documento - Segmento B	*/
 
select	distinct 3					ie_registro, 
	3						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	coalesce(e.nr_remessa,e.nr_sequencia)		nr_seq_remessa, 
	0						cd_agencia, 
	0						cd_conta, 
	' '		 				nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_lancamento, 
	' '						ds_mensagem, 
	SUBSTR(upper(d.ds_endereco),1,30)		ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	upper(d.ds_cidade)				ds_cidade, 
	d.cd_cep					cd_cep, 
	' '						cd_compl_cep, 
	d.ds_estado					sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	d.nr_documento					nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	d.vl_saldo_titulo				vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	null						dt_dia_venc, 
	d.vl_titulo					vl_titulo, 
	c.vl_desconto					vl_desconto, 
	c.vl_acrescimo					vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	upper(d.ds_bairro)				ds_bairro, 
	d.ie_tipo_favorecido 				tp_inscricao, 
	upper(d.cd_favorecido)				cd_cgc_fornecedor, 
	d.nr_titulo					nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	banco_estabelecimento b, 
	titulo_pagar_v2 d, 
	estabelecimento a, 
	banco_escritural e, 
	titulo_pagar_escrit c 
where	e.nr_sequencia			= c.nr_seq_escrit 
and	e.cd_banco       	= b.cd_banco 
and	c.nr_titulo			= d.nr_titulo 
and	e.cd_estabelecimento  	= b.cd_estabelecimento 
and	e.cd_estabelecimento  	= a.cd_estabelecimento 
and	b.ie_tipo_relacao    	in ('EP','ECC') 
and 	c.ie_tipo_pagamento	in ('DOC','TED','CC','CCP','OP','PC') 

Union
 
/*	Trailler do Lote		*/
 
select	distinct 4					ie_registro, 
	4						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	coalesce(e.nr_remessa,e.nr_sequencia)		nr_seq_remessa, 
	0						cd_agencia, 
	0						cd_conta, 
	' '		 				nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	(COUNT(*)) + 2					qt_registros, 
	sum(coalesce(c.vl_escritural,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0)) vl_total_pagto, 
	'' 						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	banco_estabelecimento_v b, 
	estabelecimento a,    
	banco_escritural e, 
	titulo_pagar_escrit c 
where	e.nr_sequencia		= c.nr_seq_escrit 
and	e.cd_estabelecimento  = a.cd_estabelecimento 
and	b.ie_tipo_relacao   	in ('EP','ECC') 
and	b.nr_sequencia		= e.nr_seq_conta_banco 
and 	c.ie_tipo_pagamento	in ('DOC','TED','CC','CCP','OP','PC') 
group by	e.nr_sequencia, 
		e.nr_remessa, 
		b.cd_convenio_banco, 
		CASE WHEN c.ie_tipo_pagamento='CC' THEN '01' WHEN c.ie_tipo_pagamento='CCP' THEN '05' WHEN c.ie_tipo_pagamento='TED' THEN '41' WHEN c.ie_tipo_pagamento='OP' THEN '10' WHEN c.ie_tipo_pagamento='BLQ' THEN CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  WHEN c.ie_tipo_pagamento='DOC' THEN '03' END  

union
 
/*	Header do Lote - Bloquetos	*/
 
select	distinct 5					ie_registro, 
	5						tp_registro, 
	e.cd_cgc					nr_inscricao, 
	b.cd_interno					nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	coalesce(a.nr_remessa,a.nr_sequencia)		nr_seq_remessa, 
	somente_numero(b.cd_agencia_bancaria)		cd_agencia, 
	(b.cd_conta)::numeric 				cd_conta, 
	b.ie_digito_conta				nr_digito_conta, 
	upper(j.ds_razao_social)			nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	01						ie_tipo_servico, 
	CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END 			ie_forma_lancamento, 
	' '						ds_mensagem, 
	upper(j.ds_endereco)				ds_endereco, 
	j.nr_endereco					nr_endereco, 
	j.ds_complemento				ds_complemento, 
	j.ds_municipio					ds_cidade, 
	substr(j.cd_cep,1,5)				cd_cep, 
	substr(j.cd_cep,6,3)				cd_compl_cep, 
	j.sg_estado					sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	upper(j.ds_razao_social)			nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	a.nr_remessa					nr_remesssa, 
	b.cd_convenio_banco				cd_convenio 
from	pessoa_juridica j, 
	Estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar k, 
	titulo_pagar_escrit c 
where	e.cd_cgc			= j.cd_cgc 
 and	a.nr_sequencia     	= c.nr_seq_escrit 
 and	a.cd_estabelecimento  	= e.cd_estabelecimento 
 and	b.ie_tipo_relacao    	in ('EP','ECC') 
 and	a.nr_seq_conta_banco		= b.nr_sequencia 
 and	c.nr_titulo			= k.nr_titulo 
 and 	c.ie_tipo_pagamento		= 'BLQ' 

union
 
/*	Detalhe Bloquetos	*/
 
select	distinct 6					ie_registro, 
	6						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	coalesce(a.nr_remessa,a.nr_sequencia)		nr_seq_remessa, 
	somente_numero(c.cd_agencia_bancaria)		cd_agencia, 
	(c.nr_conta)::numeric 				cd_conta, 
	c.ie_digito_conta				nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END 			ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	00						cd_movimento, 
	c.cd_banco					cd_banco, 
	0						cd_compensacao, 
	d.nm_favorecido					nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	'09'						cd_moeda, 
	d.nr_bloqueto					cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	substr(d.dt_vencimento_atual,1,2)			dt_dia_venc, 
	coalesce(d.vl_titulo,0)				vl_titulo, 
	coalesce(c.vl_desconto,0)				vl_desconto, 
	coalesce(c.vl_acrescimo,0)				vl_acrescimo, 
	coalesce(c.vl_escritural,0)				vl_pagto, 
	0						qt_moeda, 
	C.NR_TITULO					cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_v2 d,	 
	titulo_pagar_v k, 
	titulo_pagar_escrit c 
where	c.nr_titulo			= d.nr_titulo 
and	k.nr_titulo			= d.nr_titulo 
and	a.nr_sequencia			= c.nr_seq_escrit 
and	a.cd_estabelecimento		= e.cd_estabelecimento 
and 	b.ie_tipo_relacao		in ('EP','ECC') 
and	a.nr_seq_conta_banco		= b.nr_sequencia 
and 	c.ie_tipo_pagamento		= 'BLQ' 

Union
 
/*	Trailler do Lote - Bloquetos	*/
 
select	distinct 7					ie_registro, 
	7						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	coalesce(e.nr_remessa,e.nr_sequencia)		nr_seq_remessa, 
	0						cd_agencia, 
	0						cd_conta, 
	' '						nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  			ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	00						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	'S'						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	(COUNT(*) + 2)				qt_registros, 
	sum(coalesce(c.vl_escritural,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0)) vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	0						qt_lotes_arquivos, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	estabelecimento a, 
	banco_estabelecimento_v b, 
	banco_escritural e, 
	titulo_pagar_v2 d,	 
	titulo_pagar_v k, 
	titulo_pagar_escrit c 
where	c.nr_titulo			= d.nr_titulo 
and	k.nr_titulo			= d.nr_titulo 
and	e.nr_sequencia			= c.nr_seq_escrit 
and	e.cd_estabelecimento		= a.cd_estabelecimento 
and 	b.ie_tipo_relacao		in ('EP','ECC') 
and	e.nr_seq_conta_banco		= b.nr_sequencia 
and 	c.ie_tipo_pagamento		= 'BLQ' 
group by	e.nr_sequencia, 
		e.nr_remessa, 
	b.cd_convenio_banco, 
	CASE WHEN c.cd_banco=104 THEN '30'  ELSE '31' END  

union
 
/*	Trailler do Arquivo	*/
 
select	distinct 8					ie_registro, 
	8						tp_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	coalesce(e.nr_remessa,e.nr_sequencia)		nr_seq_remessa, 
	0						cd_agencia, 
	0						cd_conta, 
	' '						nr_digito_conta, 
	' '						nm_empresa, 
	LOCALTIMESTAMP						dt_arquivo, 
	to_char(LOCALTIMESTAMP,'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'999'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	0						nr_documento, 
	LOCALTIMESTAMP						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	LOCALTIMESTAMP						dt_pagamento, 
	' '						nm_pagador, 
	' '						ds_informacoes, 
	' '						ds_aviso, 
	0						qt_registros, 
	0						vl_total_pagto, 
	''						cd_moeda, 
	' '						cd_barras, 
	LOCALTIMESTAMP						dt_vencimento, 
	null						dt_dia_venc, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						cd_sacado, 
	count(*)					qt_lotes_arquivos, 
	count(*)					qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	0						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio 
from	banco_estabelecimento_v b, 
	estabelecimento a,    
	banco_escritural e 
where	e.cd_estabelecimento  = a.cd_estabelecimento 
and	b.ie_tipo_relacao    in ('EP','ECC') 
and	b.nr_sequencia		= e.nr_seq_conta_banco 
group by	e.nr_sequencia, 
		e.nr_remessa, 
		b.cd_convenio_banco 
order by tp_registro, 
	 nr_documento;

