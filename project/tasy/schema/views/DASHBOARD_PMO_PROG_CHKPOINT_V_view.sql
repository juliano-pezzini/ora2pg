-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW dashboard_pmo_prog_chkpoint_v (nr_sequencia, ds_programa, qt_checkpoint_prev, qt_checkpoint_real, ie_status_checkpoint, qt_total_checkpoint) AS select x.NR_SEQUENCIA,x.DS_PROGRAMA,x.QT_CHECKPOINT_PREV,x.QT_CHECKPOINT_REAL,x.IE_STATUS_CHECKPOINT,x.QT_TOTAL_CHECKPOINT
FROM   ( select t.nr_sequencia,
                t.ds_programa,
				/*Total de checkpoint previsto para estar concluído até a data de hoje*/

                ( select   count(e.nr_sequencia) qt_checkpoint_prev
                  from     proj_programa pr,
                           proj_projeto p,
                           proj_cronograma c,
                           proj_cron_etapa e
                  where    pr.nr_sequencia = p.nr_seq_programa
                  and      p.nr_sequencia  = c.nr_seq_proj
                  and      c.nr_sequencia  = e.nr_seq_cronograma
                  and      c.ie_situacao   = 'A'
                  and      e.ie_checkpoint = 'S'
                  and      pr.nr_sequencia =  t.nr_sequencia
				  and	   trunc(e.dt_fim_prev)	<= trunc(LOCALTIMESTAMP)
                ) qt_checkpoint_prev,
				/*Total de checkpoint concluídos/realizados*/

                ( select   count(e.nr_sequencia) qt_checkpoint_real
                  from     proj_programa pr,
                           proj_projeto p,
                           proj_cronograma c,
                           proj_cron_etapa e
                  where    pr.nr_sequencia = p.nr_seq_programa
                  and      p.nr_sequencia  = c.nr_seq_proj
                  and      c.nr_sequencia  = e.nr_seq_cronograma
                  and      c.ie_situacao   = 'A'
                  and      e.ie_checkpoint  = 'S'
                  and      pr.nr_sequencia =  t.nr_sequencia
                  and      e.dt_fim_real is not null
                 ) qt_checkpoint_real,
                obter_status_ckp_dashboard_pmo('PR', t.nr_sequencia) ie_status_checkpoint,
				/*Total de checkpoint do projeto*/

				( select   count(e.nr_sequencia) qt_total_checkpoint
                  from     proj_programa pr,
                           proj_projeto p,
                           proj_cronograma c,
                           proj_cron_etapa e
                  where    pr.nr_sequencia = p.nr_seq_programa
                  and      p.nr_sequencia  = c.nr_seq_proj
                  and      c.nr_sequencia  = e.nr_seq_cronograma
                  and      c.ie_situacao   = 'A'
                  and      e.ie_checkpoint = 'S'
                  and      pr.nr_sequencia =  t.nr_sequencia
                ) qt_total_checkpoint
        from   proj_programa t
       ) x
where  x.qt_total_checkpoint > 0;

