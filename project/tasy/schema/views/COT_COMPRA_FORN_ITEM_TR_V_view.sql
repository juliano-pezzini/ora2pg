-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cot_compra_forn_item_tr_v (nr_seq_fornecedor, nr_seq_item_fornec, nr_cot_compra, nr_item_cot_compra, nr_solic_compra, cd_cgc_fornecedor, cd_pessoa_fisica, qt_material, vl_unitario_material, vl_preco_liquido, vl_frete_rateio, vl_presente, dt_validade, pr_desconto, ds_observacao, ds_marca, ds_marca_fornec, nr_ordem_compra, qt_prioridade, vl_unitario_liquido, ie_situacao, cd_cgc_fornecedor_venc_alt, cd_material, cd_unidade_medida_compra, dt_limite_entrega, nm_fornecedor, vl_tributo, cd_condicao_pagamento, vl_unid_fornec, qt_conv_unid_fornec, ds_material_cadastro, ds_material_direto, ds_material, vl_minimo_nf, vl_preco, ie_regra_preco, ie_status, vl_resultado, cd_estabelecimento, ie_frete, vl_desconto, ds_motivo_venc_alt, nr_contrato, nr_seq_contrato, nr_id_integracao, dt_cot_compra, ie_finalidade_cotacao, vl_unitario_ref_moeda, dt_reprovacao, nr_seq_motivo_cancel, nr_seq_proj_rec, vl_unit_previsto, ds_status_marca, ds_justif_escolha_fornec, ds_paciente, cd_paciente_forn_item) AS select	a.nr_sequencia nr_seq_fornecedor,
	i.nr_sequencia nr_seq_item_fornec,
	i.nr_cot_compra,
	i.nr_item_cot_compra,
	c.nr_solic_compra,
	a.cd_cgc_fornecedor,
	a.cd_pessoa_fisica,
	i.qt_material,
	i.vl_unitario_material,
	i.vl_preco_liquido,
	i.vl_frete_rateio,
	i.vl_presente,
	i.dt_validade,
	i.pr_desconto,
	i.ds_observacao,
	i.ds_marca,
	i.ds_marca_fornec,
	i.nr_ordem_compra,
	i.qt_prioridade,
	i.vl_unitario_liquido,
	c.ie_situacao,
	c.cd_cgc_fornecedor_venc_alt,
	coalesce(i.cd_material, c.cd_material) cd_material,
	c.cd_unidade_medida_compra,
	c.dt_limite_entrega,
	substr(OBTER_NOME_PF_PJ(a.cd_pessoa_fisica,a.cd_cgc_fornecedor),1,80) nm_fornecedor,
	(select sum(t.vl_tributo) FROM cot_compra_forn_item_tr t where i.nr_sequencia = t.nr_seq_cot_item_forn) vl_tributo,
	a.cd_condicao_pagamento,
	i.vl_unid_fornec,
	i.qt_conv_unid_fornec,
	substr(obter_desc_material(coalesce(i.cd_material, c.cd_material)),1,100) ds_material_cadastro,
	coalesce(i.ds_material_direto, c.ds_material_direto_w) ds_material_direto,
	coalesce(coalesce(i.ds_material_direto, c.ds_material_direto_w),
		substr(obter_desc_material(coalesce(i.cd_material, c.cd_material)),1,255)) ds_material,
	coalesce(obter_dados_pf_pj_estab(b.cd_estabelecimento,a.cd_pessoa_fisica,a.cd_cgc_fornecedor,'EVM'),0) vl_minimo_nf,
	i.vl_preco,
	c.ie_regra_preco,
	a.ie_status,
	Obter_Result_Cot_Fornec_item(i.nr_sequencia) vl_resultado,
	c.cd_estab_item cd_estabelecimento,
	a.ie_frete,
	coalesce(i.vl_desconto,0) vl_desconto,
	c.ds_motivo_venc_alt,
	i.nr_contrato,
	i.nr_seq_contrato,
	i.nr_id_integracao,
	b.dt_cot_compra,
	b.ie_finalidade_cotacao,
	i.vl_unitario_ref_moeda,
	c.dt_reprovacao,
	b.nr_seq_motivo_cancel,
	c.nr_seq_proj_rec,
	c.vl_unit_previsto,
	substr(CASE WHEN i.nr_seq_status_marca IS NULL THEN obter_dados_marca_material(i.ds_marca,i.cd_material,'SD')  ELSE obter_desc_status_aval_marca(i.nr_seq_status_marca) || ' - ' || i.dt_status_marca END ,1,255) ds_status_marca,
	i.ds_justif_escolha_fornec,
	substr(obter_nome_pf(i.cd_paciente_forn_item), 1, 255) ds_paciente,
	i.cd_paciente_forn_item
FROM cot_compra b, cot_compra_forn a, cot_compra_forn_item i
LEFT OUTER JOIN cot_compra_item c ON (i.nr_cot_compra = c.nr_cot_compra AND i.nr_item_cot_compra = c.nr_item_cot_compra)
WHERE i.nr_seq_cot_forn		= a.nr_sequencia   and i.vl_unitario_material	> 0 and i.nr_cot_compra		= b.nr_cot_compra and not exists (
	select	1
	from	cot_compra_solic_agrup x
	where	i.nr_item_cot_compra = x.nr_item_cot_compra
	and	i.nr_cot_compra = x.nr_cot_compra
	and	x.cd_estabelecimento <> b.cd_estabelecimento)

union all

select	a.nr_sequencia nr_seq_fornecedor,
	i.nr_sequencia nr_seq_item_fornec,
	i.nr_cot_compra,
	i.nr_item_cot_compra,
	x.nr_solic_compra,
	a.cd_cgc_fornecedor,
	a.cd_pessoa_fisica,
	x.qt_material,
	i.vl_unitario_material,
	(x.qt_material * i.vl_unitario_material) vl_preco_liquido,
	i.vl_frete_rateio,
	(x.qt_material * i.vl_unitario_material) vl_presente,
	i.dt_validade,
	i.pr_desconto,
	i.ds_observacao,
	i.ds_marca,
	i.ds_marca_fornec,
	x.nr_ordem_compra,
	i.qt_prioridade,
	i.vl_unitario_liquido,
	c.ie_situacao,
	c.cd_cgc_fornecedor_venc_alt,
	coalesce(i.cd_material, c.cd_material) cd_material,
	c.cd_unidade_medida_compra,
	c.dt_limite_entrega,
	substr(OBTER_NOME_PF_PJ(a.cd_pessoa_fisica,a.cd_cgc_fornecedor),1,80) nm_fornecedor,
	(select sum(t.vl_tributo) from cot_compra_forn_item_tr t where i.nr_sequencia = t.nr_seq_cot_item_forn) vl_tributo,
	a.cd_condicao_pagamento,
	i.vl_unid_fornec,
	i.qt_conv_unid_fornec,
	substr(obter_desc_material(coalesce(i.cd_material, c.cd_material)),1,100) ds_material_cadastro,
	coalesce(i.ds_material_direto, c.ds_material_direto_w) ds_material_direto,
	coalesce(coalesce(i.ds_material_direto, c.ds_material_direto_w),
		substr(obter_desc_material(coalesce(i.cd_material, c.cd_material)),1,255)) ds_material,
	coalesce(obter_dados_pf_pj_estab(b.cd_estabelecimento,a.cd_pessoa_fisica,a.cd_cgc_fornecedor,'EVM'),0) vl_minimo_nf,
	i.vl_preco,
	c.ie_regra_preco,
	a.ie_status,
	Obter_Result_Cot_Fornec_item(i.nr_sequencia) vl_resultado,
	x.cd_estabelecimento,
	a.ie_frete,
	coalesce(i.vl_desconto,0) vl_desconto,
	c.ds_motivo_venc_alt,
	i.nr_contrato,
	i.nr_seq_contrato,
	i.nr_id_integracao,
	b.dt_cot_compra,
	b.ie_finalidade_cotacao,
	i.vl_unitario_ref_moeda,
	c.dt_reprovacao,
	b.nr_seq_motivo_cancel,
	c.nr_seq_proj_rec,
	c.vl_unit_previsto,
	substr(CASE WHEN i.nr_seq_status_marca IS NULL THEN obter_dados_marca_material(i.ds_marca,i.cd_material,'SD')  ELSE obter_desc_status_aval_marca(i.nr_seq_status_marca) || ' - ' || i.dt_status_marca END ,1,255) ds_status_marca,
	i.ds_justif_escolha_fornec,
	substr(obter_nome_pf(i.cd_paciente_forn_item), 1, 255) ds_paciente,
	i.cd_paciente_forn_item
FROM cot_compra_solic_agrup x, cot_compra b, cot_compra_forn a, cot_compra_forn_item i
LEFT OUTER JOIN cot_compra_item c ON (i.nr_cot_compra = c.nr_cot_compra AND i.nr_item_cot_compra = c.nr_item_cot_compra)
WHERE i.nr_seq_cot_forn		= a.nr_sequencia  and i.nr_cot_compra		= b.nr_cot_compra  and i.vl_unitario_material	> 0 and i.nr_item_cot_compra = x.nr_item_cot_compra and i.nr_cot_compra = x.nr_cot_compra and exists (
	select	1
	from	cot_compra_solic_agrup z
	where	i.nr_item_cot_compra = z.nr_item_cot_compra
	and	i.nr_cot_compra = z.nr_cot_compra
	and	z.cd_estabelecimento <> b.cd_estabelecimento);

