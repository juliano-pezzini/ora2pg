-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW isscamp_notas_fiscais_v (tp_registro, cd_estabelecimento, cd_inscricao_municipal, dt_emissao, cd_serie_nf, cd_modelo, cd_natureza_operacao, nr_nota_fiscal, vl_bruto, vl_servico, ie_tipo_recolhimento, tx_tributo, cd_cnpj_tomador, nr_cpf_tomador, nm_tomador, cd_municipio_tomador, ie_situacao, ie_simples_nacional, cd_operacao_nf, nr_parcela, qt_parcela, ds_motivo_nao_retencao) AS select	1 					tp_registro,
	a.cd_estabelecimento, 
	a.cd_inscricao_municipal, 
	to_date(null)				dt_emissao, 
	' '					cd_serie_nf, 
	'1' 					cd_modelo, 
	'C' 					cd_natureza_operacao, 
	'000000000'				nr_nota_fiscal, 
	0		 			vl_bruto, 
	0					vl_servico, 
	'A' 					ie_tipo_recolhimento, 
	0					tx_tributo, 
	'00000000000000'		 		cd_cnpj_tomador, 
	'00000000000'				nr_cpf_tomador, 
	' '					nm_tomador, 
	'0'					cd_municipio_tomador, 
	' '					ie_situacao, 
	'N'					ie_simples_nacional, 
	0					cd_operacao_nf, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao 
FROM	estabelecimento_v a 

union
 
select	2 					tp_registro, 
	a.cd_estabelecimento, 
	'0' 					cd_inscricao_municipal, 
	a.dt_emissao, 
	a.cd_serie_nf, 
	'1' 					cd_modelo, 
	'C' 					cd_natureza_operacao, 
	a.nr_nota_fiscal, 
	a.vl_total_nota 				vl_bruto, 
	a.vl_mercadoria 				vl_servico, 
	'A' 					ie_tipo_recolhimento, 
	0					tx_tributo, 
	coalesce(a.cd_cgc, '00000000000000') 		cd_cnpj_tomador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') nr_cpf_tomador, 
	CASE WHEN a.cd_cgc IS NULL THEN 'diversos'  ELSE substr(obter_nome_pf_pj(null,a.cd_cgc),1,40) END  nm_tomador, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CDM'),1,10) cd_municipio_tomador, 
	CASE WHEN a.ie_situacao='1' THEN 'A' WHEN a.ie_situacao='2' THEN 'A'  ELSE 'C' END  		ie_situacao, 
	'N'					ie_simples_nacional, 
	a.cd_operacao_nf				cd_operacao_nf, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao 
from	nota_fiscal a 
where	substr(obter_se_nota_entrada_saida(a.nr_sequencia),1,1) = 'S' 

union
 
select	3 					tp_registro, 
	a.cd_estabelecimento, 
	'0' 					cd_inscricao_municipal, 
	a.dt_emissao, 
	a.cd_serie_nf, 
	'1' 					cd_modelo, 
	'C' 					cd_natureza_operacao, 
	a.nr_nota_fiscal, 
	a.vl_total_nota 				vl_bruto, 
	a.vl_mercadoria 				vl_servico, 
	'A' 					ie_tipo_recolhimento, 
	0					tx_tributo, 
	coalesce(a.cd_cgc, '00000000000000') 		cd_cnpj_tomador, 
	coalesce(substr(obter_cpf_pessoa_fisica(a.cd_pessoa_fisica),1,14), '00000000000') nr_cpf_tomador, 
	CASE WHEN a.cd_cgc IS NULL THEN 'diversos'  ELSE substr(obter_nome_pf_pj(null,a.cd_cgc),1,40) END  nm_tomador, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'CDM'),1,10) cd_municipio_tomador, 
	CASE WHEN a.ie_situacao='1' THEN 'A' WHEN a.ie_situacao='2' THEN 'A'  ELSE 'C' END 		ie_situacao, 
	'N'					ie_simples_nacional, 
	a.cd_operacao_nf				cd_operacao_nf, 
	0					nr_parcela, 
	0					qt_parcela, 
	' '					ds_motivo_nao_retencao 
from	nota_fiscal a 
where	substr(obter_se_nota_entrada_saida(a.nr_sequencia),1,1) = 'E';

