-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_guias_spsadt_v (ds_versao, cd_autorizacao, ds_carater_internacao, ds_tipo_saida, ie_tipo_atend_tiss, nr_interno_conta, nr_seq_protocolo, nr_atendimento, dt_entrada, ie_tipo_saida, ie_tipo_protocolo, cd_autorizacao_tag, cd_convenio, cd_medico_executor, cd_autorizacao_princ, cd_cgc_prestador) AS select	'2.01.01' ds_versao,
	c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	a.ie_tipo_atend_tiss, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('SPSADT', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END  CD_AUTORIZACAO_TAG, 
	a.cd_convenio_parametro cd_convenio, 
	b.cd_medico_resp cd_medico_executor, 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255) cd_autorizacao_princ, 
	coalesce(coalesce(e.cd_cgc_prestador_tiss, e.cd_cgc_prestador), h.cd_cgc) cd_cgc_prestador 
FROM estabelecimento h, conta_paciente_guia c, conta_paciente a, procedimento_paciente e
LEFT OUTER JOIN regra_honorario g ON (e.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento and a.nr_interno_conta	= c.nr_interno_conta  and e.nr_interno_conta	= c.nr_interno_conta and e.nr_doc_convenio	= c.cd_autorizacao  and a.cd_estabelecimento		= h.cd_estabelecimento and ((TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				e.ie_tiss_tipo_guia) = '4') or (TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia) = '4')) and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null and ((b.ie_tipo_atendimento	<> 1 AND e.ie_tiss_tipo_guia is null) or (e.ie_tiss_tipo_guia = '4')) 
 
union
 
select	'2.01.01' ds_versao, 
	'Não Informada' cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	a.ie_tipo_atend_tiss, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('SPSADT', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	null CD_AUTORIZACAO_TAG, 
	a.cd_convenio_parametro cd_convenio, 
	b.cd_medico_resp cd_medico_executor, 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255) cd_autorizacao_princ, 
	coalesce(coalesce(e.cd_cgc_prestador_tiss, e.cd_cgc_prestador), h.cd_cgc) cd_cgc_prestador 
FROM estabelecimento h, conta_paciente a, procedimento_paciente e
LEFT OUTER JOIN regra_honorario g ON (e.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento  and a.nr_interno_conta	= e.nr_interno_conta and coalesce(e.nr_doc_convenio, 'Não Informada') = 'Não Informada'  and a.cd_estabelecimento		= h.cd_estabelecimento and ((TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				e.ie_tiss_tipo_guia) = '4') or (TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia) = '4')) and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null and ((b.ie_tipo_atendimento	<> 1 AND e.ie_tiss_tipo_guia is null) or (e.ie_tiss_tipo_guia = '4')) 
 
union
 
select	'2.01.01' ds_versao, 
	c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	a.ie_tipo_atend_tiss, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('SPSADT', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END  CD_AUTORIZACAO_TAG, 
	a.cd_convenio_parametro cd_convenio, 
	b.cd_medico_resp cd_medico_executor, 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255) cd_autorizacao_princ, 
	coalesce(f.cd_cgc, h.cd_cgc) cd_cgc_prestador 
FROM estabelecimento h, procedimento_paciente e, conta_paciente_guia c, conta_paciente a, procedimento_participante f
LEFT OUTER JOIN regra_honorario g ON (f.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento		= b.nr_atendimento and a.nr_interno_conta		= c.nr_interno_conta  and e.nr_interno_conta		= c.nr_interno_conta and e.nr_doc_convenio		= c.cd_autorizacao  and e.nr_sequencia			= f.nr_sequencia and a.cd_estabelecimento		= h.cd_estabelecimento and TISS_OBTER_GUIA_PROC(	b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				f.ie_tiss_tipo_guia) = '4' and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia)	= '6' -- Edgar 08/06/2007 - só imprimir participante na SADT se o superioor for honorário 
  and e.cd_motivo_exc_conta	is null 
 
union
 
select	'2.01.01' ds_versao, 
	'Não Informada' cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	a.ie_tipo_atend_tiss, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('SPSADT', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	null CD_AUTORIZACAO_TAG, 
	a.cd_convenio_parametro cd_convenio, 
	b.cd_medico_resp cd_medico_executor, 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255) cd_autorizacao_princ, 
	coalesce(f.cd_cgc, h.cd_cgc) cd_cgc_prestador 
FROM estabelecimento h, procedimento_paciente e, conta_paciente a, procedimento_participante f
LEFT OUTER JOIN regra_honorario g ON (f.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento				= b.nr_atendimento  and a.nr_interno_conta				= e.nr_interno_conta and coalesce(e.nr_doc_convenio, 'Não Informada') 	= 'Não Informada'  and e.nr_sequencia			= f.nr_sequencia and a.cd_estabelecimento		= h.cd_estabelecimento and TISS_OBTER_GUIA_PROC(	b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				f.ie_tiss_tipo_guia) = '4' and TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia)	= '6' -- Edgar 08/06/2007 - só imprimir participante na SADT se o superioor for honorário 
  and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null;

