-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW obter_cpoe_pos_alta_enf_2 (ds, tipo_cpoe, ie_usuario_enf, dt_prev_execucao, ie_tipo_item, nr_sequencia, nr_seq_cpoe_rp, nr_atendimento, dt_suspensao, nr_seq_order_type) AS SELECT DISTINCT substr((CASE WHEN cp.DT_SUSPENSAO IS NOT NULL THEN  obter_desc_expressao_idioma(782908, null, wheb_usuario_pck.get_nr_seq_idioma) || ' ' ELSE '' END) || obter_desc_material(cp.cd_material), 1, 255) DS,
                Obter_Descricao_Dominio((7768), 'M') || ' - '|| pkg_date_formaters.to_varchar(cp.dt_inicio, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO) tipo_cpoe,
                obter_funcao_usuario(cp.nm_usuario) ie_usuario_enf,
                TO_DATE(cp.DT_INICIO) dt_prev_execucao,
                CASE WHEN cp.ie_material='S' THEN 'MA'  ELSE 'M' END  IE_TIPO_ITEM,
                cp.nr_sequencia nr_sequencia,
                NULL nr_seq_cpoe_rp,
                cp.nr_atendimento,
                cp.DT_SUSPENSAO,
                mot.nr_seq_order_type nr_seq_order_type
FROM CPOE_MATERIAL cp,
    material_order_type mot
WHERE mot.cd_material = cp.cd_material
AND cp.dt_liberacao IS NOT NULL
AND    ((cp.dt_fim > LOCALTIMESTAMP) or (cp.dt_fim is null))

UNION ALL

/* Procedure */

SELECT DISTINCT ((CASE WHEN cp.DT_SUSPENSAO IS NOT NULL THEN  obter_desc_expressao_idioma(782908, null, wheb_usuario_pck.get_nr_seq_idioma) || ' ' ELSE '' END) || Obter_Desc_Proc_Interno(cp.NR_SEQ_PROC_INTERNO) || ' - ' || Obter_desc_intervalo(cp.cd_intervalo)) DS,
                Obter_Descricao_Dominio((7768), 'P') || ' - ' ||
				pkg_date_formaters.to_varchar(cp.dt_prev_execucao, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO) tipo_cpoe,
                obter_funcao_usuario(cp.nm_usuario) ie_usuario_enf,
                TO_DATE(cp.dt_prev_execucao) dt_prev_execucao,
                'P' IE_TIPO_ITEM,
                cp.nr_sequencia nr_sequencia,
                NULL nr_seq_cpoe_rp,
                cp.nr_atendimento,
                cp.DT_SUSPENSAO,
                pot.nr_seq_order_type nr_seq_order_type
FROM CPOE_PROCEDIMENTO cp,
    proc_order_type pot
WHERE cp.dt_liberacao IS NOT NULL
AND    ((cp.dt_fim > LOCALTIMESTAMP) or (cp.dt_fim is null))
AND pot.nr_seq_proc_interno = cp.nr_seq_proc_interno

UNION ALL

/* Interventions and Recommendations */

SELECT DISTINCT(CASE WHEN cp.DT_SUSPENSAO IS NOT NULL THEN  obter_desc_expressao_idioma(782908, null, wheb_usuario_pck.get_nr_seq_idioma) || ' ' ELSE '' END) || obter_desc_recomendacao(cd_recomendacao) DS,
                Obter_Descricao_Dominio((7768), 'R') || ' - ' || pkg_date_formaters.to_varchar(cp.dt_inicio, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO) tipo_cpoe,
                obter_funcao_usuario(cp.nm_usuario) ie_usuario_enf,
                TO_DATE(cp.DT_INICIO) dt_prev_execucao,
                'R' IE_TIPO_ITEM,
                cp.nr_sequencia nr_sequencia,
                NULL nr_seq_cpoe_rp,
                cp.nr_atendimento,
                cp.DT_SUSPENSAO,
                null nr_seq_order_type
FROM CPOE_RECOMENDACAO cp
WHERE cp.dt_liberacao IS NOT NULL
AND    ((cp.dt_fim > LOCALTIMESTAMP) or (cp.dt_fim is null))

UNION ALL

/* Nursing interventions */

SELECT DISTINCT substr((CASE WHEN cp.DT_SUSPENSAO IS NOT NULL THEN  obter_desc_expressao_idioma(782908, null, wheb_usuario_pck.get_nr_seq_idioma) || ' ' ELSE '' END) || Obter_desc_intervencoes(nr_seq_proc) || ' - ' || obter_desc_intervalo_prescr(cd_intervalo), 1, 255) DS,
                Obter_Descricao_Dominio((7768), 'I')|| ' - ' || pkg_date_formaters.to_varchar(cp.dt_inicio, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO) tipo_cpoe,
                obter_funcao_usuario(cp.nm_usuario) ie_usuario_enf,
                TO_DATE(cp.DT_INICIO) dt_prev_execucao,
                'I' IE_TIPO_ITEM,
                cp.nr_sequencia nr_sequencia,
                NULL nr_seq_cpoe_rp,
                cp.nr_atendimento,
                cp.DT_SUSPENSAO,
                null nr_seq_order_type
FROM CPOE_INTERVENCAO cp
WHERE cp.dt_liberacao IS NOT NULL
AND    ((cp.dt_fim > LOCALTIMESTAMP) or (cp.dt_fim is null));

