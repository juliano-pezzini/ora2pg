-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pep_exames_laboratoriais_v (ie_tipo_resultado, dt_prescricao, nr_prescricao, ds_procedimento, ds_exame, nr_atendimento, ie_recem_nato, nm_medico, dt_coleta, nr_controle, ds_material, nr_seq_prescr_proc, dt_prev_execucao, dt_aprovacao, dt_impressao, dt_emissao_resultado, nm_usuario_aprovacao, ds_status_lab, nr_seq_exame, ie_status_atend, cd_pessoa_fisica, nr_seq_result) AS select	1 ie_tipo_resultado,
	b.dt_prescricao, 
	--c.cd_procedimento cr_procedimento, 
	--c.ie_origem_proced ie_origem_proced, 
	a.nr_prescricao, 
	--a.nr_sequencia, 
	--'', 
	substr(obter_descricao_procedimento(c.cd_procedimento,c.ie_origem_proced),1,200) ds_procedimento, 
	substr(obter_desc_exame(coalesce(a.nr_seq_exame,c.nr_seq_exame)),1,200) ds_exame, 
	--0, 
	--0, 
	b.nr_atendimento, 
	b.ie_recem_nato, 
	--a.nr_sequencia nr_seq_result, 
	substr(obter_nome_medico(b.cd_medico,'N'),1,60) nm_medico, 
	coalesce(med_obter_data_coleta(c.nr_prescricao, c.nr_sequencia,20),a.dt_coleta) dt_coleta, 
	coalesce(b.nr_controle,0) nr_controle, 
	substr(obter_material_exame_lab(obter_mat_exame_lab_prescr(c.nr_prescricao, c.nr_sequencia, 1),null,3),1,90) ds_material, 
	c.nr_sequencia nr_seq_prescr_proc, 
	to_char(dt_prev_execucao,'dd/mm/yyyy hh24:mi:ss') dt_prev_execucao, 
	obter_data_aprov_lab(b.nr_prescricao,c.nr_sequencia) dt_aprovacao, 
	obter_data_impressao_result(c.nr_sequencia,b.nr_prescricao,0) dt_impressao, 
	c.dt_emissao_resultado, 
	substr(obter_nome_usuario(obter_usuario_aprov_lab(b.nr_prescricao,c.nr_sequencia)),1,255) nm_usuario_aprovacao, 
	substr(obter_valor_dominio(1030,ie_status_atend),1,60) ds_status_lab, 
	c.nr_seq_exame, 
	c.ie_status_atend, 
	b.cd_pessoa_fisica, 
	a.nr_sequencia nr_seq_result 
FROM  	result_laboratorio a, 
	prescr_procedimento c, 
	prescr_medica b 
where 	a.nr_prescricao = b.nr_prescricao 
--and 	b.nr_atendimento = :nr_atendimento 
--and 	1 = :varieresultado 
and 	a.nr_prescricao = c.nr_prescricao 
and 	a.nr_seq_prescricao = c.nr_sequencia 
and 	a.ds_resultado is not null 
--and 	'S' = ( select obter_se_permite_ver_result(c.nr_seq_exame,:cd_perfil,:nm_usuario) from dual) 
--and 	c.ie_status_atend >= :ie_status_atend 
union
 
select	2 ie_tipo_resultado, 
	a.dt_prescricao, 
	--b.cd_procedimento, 
	--b.ie_origem_proced, 
	b.nr_prescricao, 
	--b.nr_sequencia, 
	--c.cd_exame, 
	c.nm_exame ds_procedimento, 
	c.nm_exame ds_exame, 
	--0, 
	--0, 
	a.nr_atendimento, 
	a.ie_recem_nato, 
	--0 nr_seq_result, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,60) nm_medico, 
	LOCALTIMESTAMP dt_coleta, 
	0 nr_controle, 
	substr(obter_material_exame_lab(obter_mat_exame_lab_prescr(b.nr_prescricao, b.nr_sequencia, 1),null,3),1,90) ds_material, 
	b.nr_sequencia nr_seq_prescr_proc, 
	to_char(dt_prev_execucao,'dd/mm/yyyy hh24:mi:ss') dt_prev_execucao, 
	obter_data_aprov_lab(a.nr_prescricao,b.nr_sequencia) dt_aprovacao, 
	obter_data_impressao_result(b.nr_sequencia,a.nr_prescricao,0) dt_impressao, 
	b.dt_emissao_resultado, 
	substr(obter_nome_usuario(obter_usuario_aprov_lab(a.nr_prescricao,b.nr_sequencia)),1,255) nm_usuario_aprovacao, 
	substr(obter_valor_dominio(1030,ie_status_atend),1,60) ds_status_lab, 
	b.nr_seq_exame, 
	b.ie_status_atend, 
	a.cd_pessoa_fisica, 
	0 nr_seq_result 
from 	exame_laboratorio c, 
	prescr_procedimento b, 
	prescr_medica a 
where 	b.nr_prescricao = a.nr_prescricao 
--and 	a.nr_atendimento = :nr_atendimento 
--and 	2 = :varieresultado 
and 	b.nr_seq_exame = c.nr_seq_exame 
and (a.dt_liberacao is not null or a.dt_liberacao_medico is not null) 
--and 	'S' = ( select obter_se_permite_ver_result(b.nr_seq_exame,:cd_perfil,:nm_usuario) from dual) 
union
 
select	3 ie_tipo_resultado, 
	a.dt_prescricao, 
	--0 cd_procedimento, 
	--0 ie_origem_proced, 
	a.nr_prescricao, 
	--0 nr_sequencia, 
	--'' cd_exame, 
	substr(obter_prescr_exames_lab(a.nr_prescricao, null, null, null, null, 'CEI', ' ', null, null),1,40) ds_procedimento, 
	null ds_exame,    
	--0, 
	--0, 
	a.nr_atendimento, 
	a.ie_recem_nato, 
	--0 nr_seq_result, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,60) nm_medico, 
	max(b.dt_coleta) dt_coleta, 
	a.nr_controle, 
	null ds_material, 
	0 nr_seq_prescr_proc, 
	null dt_prev_execucao, 
	obter_data_aprov_lab(a.nr_prescricao,b.nr_sequencia) dt_aprovacao, 
	obter_data_impressao_result(b.nr_sequencia,a.nr_prescricao,0) dt_impressao, 
	b.dt_emissao_resultado, 
	substr(obter_nome_usuario(obter_usuario_aprov_lab(a.nr_prescricao,b.nr_sequencia)),1,255) nm_usuario_aprovacao, 
	substr(obter_valor_dominio(1030,ie_status_atend),1,60) ds_status_lab, 
	b.nr_seq_exame, 
	b.ie_status_atend, 
	a.cd_pessoa_fisica, 
	0 nr_seq_result 
from 	exame_laboratorio c, 
	prescr_procedimento b, 
	prescr_medica a 
where 	b.nr_prescricao = a.nr_prescricao 
--and 	a.nr_atendimento = :nr_atendimento 
--and 	3 = :varieresultado 
and 	a.nr_controle is not null 
and 	b.nr_seq_exame = c.nr_seq_exame 
and (a.dt_liberacao is not null or a.dt_liberacao_medico is not null) 
--and 	'S' = ( select obter_se_permite_ver_result(b.nr_seq_exame,:cd_perfil,:nm_usuario) from dual) 
group by 
	3, 
	a.dt_prescricao, 
	--0 cd_procedimento, 
	--0 ie_origem_proced, 
	a.nr_prescricao, 
	--0 nr_sequencia, 
	--'' cd_exame, 
	substr(obter_prescr_exames_lab(a.nr_prescricao, null, null, null, null, 'CEI', ' ', null, null),1,40), 
	null,    
	--0, 
	--0, 
	a.nr_atendimento, 
	a.ie_recem_nato, 
	--0 nr_seq_result, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,60), 
	--max(b.dt_coleta), 
	a.nr_controle, 
	null, 
	--0 nr_seq_prescr_proc, 
	null, 
	obter_data_aprov_lab(a.nr_prescricao,b.nr_sequencia), 
	obter_data_impressao_result(b.nr_sequencia,a.nr_prescricao,0), 
	b.dt_emissao_resultado, 
	substr(obter_nome_usuario(obter_usuario_aprov_lab(a.nr_prescricao,b.nr_sequencia)),1,255), 
	substr(obter_valor_dominio(1030,ie_status_atend),1,60), 
	b.nr_seq_exame, 
	b.ie_status_atend, 
	a.cd_pessoa_fisica, 
	0 

union
 
select	4 ie_tipo_resultado, 
	a.dt_prescricao, 
	--b.cd_procedimento, 
	--b.ie_origem_proced, 
	b.nr_prescricao, 
	--b.nr_sequencia, 
	--c.cd_exame, 
	c.nm_exame ds_procedimento, 
	c.nm_exame ds_exame, 
	--0, 
	--0, 
	a.nr_atendimento, 
	a.ie_recem_nato, 
	--0 nr_seq_result, 
	substr(obter_nome_medico(a.cd_medico,'N'),1,60) nm_medico, 
	LOCALTIMESTAMP dt_coleta, 
	0 nr_controle, 
	substr(obter_material_exame_lab(obter_mat_exame_lab_prescr(b.nr_prescricao, b.nr_sequencia, 1),null,3),1,90) ds_material, 
	b.nr_sequencia nr_seq_prescr_proc, 
	to_char(dt_prev_execucao,'dd/mm/yyyy hh24:mi:ss') dt_prev_execucao, 
	obter_data_aprov_lab(a.nr_prescricao,b.nr_sequencia) dt_aprovacao, 
	obter_data_impressao_result(b.nr_sequencia,a.nr_prescricao,0) dt_impressao, 
	b.dt_emissao_resultado, 
	substr(obter_nome_usuario(obter_usuario_aprov_lab(a.nr_prescricao,b.nr_sequencia)),1,255) nm_usuario_aprovacao, 
	substr(obter_valor_dominio(1030,ie_status_atend),1,60) ds_status_lab, 
	b.nr_seq_exame, 
	b.ie_status_atend, 
	a.cd_pessoa_fisica, 
	0 nr_seq_result 
from 	exame_laboratorio c, 
	prescr_procedimento b, 
	prescr_medica a 
where 	b.nr_prescricao = a.nr_prescricao 
--and 	a.nr_atendimento = :nr_atendimento 
--and 	4 = :varieresultado 
and 	b.nr_seq_exame = c.nr_seq_exame 
and (a.dt_liberacao is not null or a.dt_liberacao_medico is not null) 
--and 	'S' = obter_se_permite_ver_result(b.nr_seq_exame,:cd_perfil,:nm_usuario) 
and 	lab_obter_se_gravar_result(b.nr_seq_exame) = 'S'  
and 	exists ( 
		select	1 
		from 	exame_lab_result_item x, 
			exame_lab_resultado y 
		where 	x.nr_seq_resultado = y.nr_seq_resultado 
		and 	b.nr_prescricao = y.nr_prescricao 
		and 	b.nr_sequencia = x.nr_seq_prescr);

