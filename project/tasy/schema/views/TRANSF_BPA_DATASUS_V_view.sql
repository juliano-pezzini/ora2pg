-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW transf_bpa_datasus_v (ie_reg, nr_seq_protocolo, dt_mesano_ref, cd_unidade_bpa, cd_procedimento, cd_atividade_prof_bpa, ie_tipo_atend_bpa, ie_grupo_atend_bpa, cd_faixa_etaria, qt_procedimento, ie_tipo_bpa) AS select	1 ie_reg,
	x.nr_seq_protocolo,
	to_char(x.dt_periodo_final, 'yyyymm') dt_mesano_ref,
	Sus_Obter_Substituir_Cnes(c.cd_unidade_bpa,a.cd_setor_atendimento,c.cd_estabelecimento,e.ie_tipo_atendimento) cd_unidade_bpa,
	a.cd_procedimento,
	a.cd_atividade_prof_bpa,
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T') ie_tipo_atend_bpa,
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G') ie_grupo_atend_bpa,
	g.cd_faixa_etaria,
	sum(a.qt_procedimento) qt_procedimento,
	x.ie_tipo_bpa
FROM protocolo_convenio x, atendimento_paciente e, estabelecimento d, sus_parametros c, conta_paciente b, procedimento_paciente a
LEFT OUTER JOIN sus_valor_proc_paciente g ON (a.nr_sequencia = g.nr_sequencia)
WHERE a.nr_interno_conta 	= b.nr_interno_conta and b.nr_seq_protocolo 	= x.nr_seq_protocolo and b.nr_atendimento 	= e.nr_atendimento and e.cd_estabelecimento 	= c.cd_estabelecimento and e.cd_estabelecimento 	= d.cd_estabelecimento and a.cd_motivo_exc_conta 	is null  and a.vl_procedimento 	> 0 and a.ie_origem_proced	= 3 group by	x.nr_seq_protocolo,
		to_char(x.dt_periodo_final, 'yyyymm'),
		Sus_Obter_Substituir_Cnes(c.cd_unidade_bpa,a.cd_setor_atendimento,c.cd_estabelecimento,e.ie_tipo_atendimento),
		a.cd_procedimento,
		a.cd_atividade_prof_bpa,
		Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T'),
		Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G'),
		g.cd_faixa_etaria,
		x.ie_tipo_bpa

union

select	2 ie_reg,
	x.nr_seq_protocolo,
	to_char(e.dt_mesano_referencia, 'yyyymm') dt_mesano_ref,
	0 cd_unidade_bpa,
	c.cd_procedimento,
	c.cd_atividade_prof_bpa,
	Obter_Tipo_grupo_Proced_Bpa(c.nr_sequencia, 'T') ie_tipo_atend_bpa,
	Obter_Tipo_grupo_Proced_Bpa(c.nr_sequencia, 'G') ie_grupo_atend_bpa,
	g.cd_faixa_etaria,
	SUM(c.qt_procedimento) qt_procedimento,
	x.ie_tipo_bpa
from	medico_convenio		h,
	medico			b,
	sus_preco_procbpa	d,
	atendimento_paciente 	a,
	protocolo_convenio	x,
	conta_paciente 		e,
	procedimento_paciente 	c,
	sus_valor_proc_paciente	g
where	a.nr_atendimento 	= c.nr_atendimento
and	e.nr_seq_protocolo = x.nr_seq_protocolo
and	a.nr_atendimento 	= e.nr_atendimento
and 	e.nr_interno_conta 	= c.nr_interno_conta
and	c.cd_procedimento 	= d.cd_procedimento
and 	c.ie_origem_proced	= d.ie_origem_proced
and 	c.cd_medico_executor 	= b.cd_pessoa_fisica
and 	b.cd_pessoa_fisica 	= h.cd_pessoa_fisica
and 	h.cd_convenio 		= c.cd_convenio
and 	c.nr_sequencia 		= g.nr_sequencia
and 	c.cd_motivo_exc_conta 	is null
and 	c.cd_medico_executor 	is not null
and 	a.ie_tipo_atend_bpa 	IN (14,15)
and 	h.ie_plantonista 	= 'S'
and 	d.vl_plantonista 	<> 0
and 	d.dt_competencia 	=	(select	max(f.dt_competencia)
					from 	sus_preco_procbpa	f
					where 	f.cd_procedimento	= c.cd_procedimento
					and 	f.ie_origem_proced 	= c.ie_origem_proced)
group by	x.nr_seq_protocolo,
		to_char(e.dt_mesano_referencia, 'yyyymm'),
		c.cd_procedimento,
      		c.cd_atividade_prof_bpa,
		Obter_Tipo_grupo_Proced_Bpa(c.nr_sequencia, 'T'),
		Obter_Tipo_grupo_Proced_Bpa(c.nr_sequencia, 'G'),
		g.cd_faixa_etaria,
		x.ie_tipo_bpa
ORDER BY 1, 5, 6, 7, 8, 9;

