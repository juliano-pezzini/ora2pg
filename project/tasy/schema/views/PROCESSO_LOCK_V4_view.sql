-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW processo_lock_v4 (lev1, min_in_wait, username, osuser, sql_id, programa, blocking_session, event, sid, "serial#", acao, modulo) AS WITH RECURSIVE cte AS (
WITH A AS
	(WITH RECURSIVE cte AS (
	SELECT 1 LEV,CONNECT_BY_ROOT COL1 BLOCKER,COL1 LEV1
		FROM ((	SELECT	INST_ID || ',' || SID COL1,
						EVENT,
						SQL_ID,
						PROGRAM,
						BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
						SECONDS_IN_WAIT
				FROM	GV$SESSION)) alias1 WHERE COL2 IN (	SELECT	BLOCKING_INSTANCE || ',' || BLOCKING_SESSION
								FROM	GV$SESSION
								WHERE	BLOCKING_SESSION IS NOT NULL)
  UNION ALL
	SELECT (c.level+1) LEV,CONNECT_BY_ROOT COL1 BLOCKER,COL1 LEV1
		FROM ((	SELECT	INST_ID || ',' || SID COL1,
						EVENT,
						SQL_ID,
						PROGRAM,
						BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
						SECONDS_IN_WAIT
				FROM	GV$SESSION)) JOIN cte c ON (c.COL2 = COL1)

) SELECT * FROM cte;
),
B AS (	SELECT	DISTINCT LEV1
		FROM	A
		WHERE (A.LEV, A.BLOCKER) IN (SELECT	MAX(LEV), BLOCKER FROM A GROUP BY BLOCKER))
SELECT	LPAD(' ', 3 * (1 - 1)) || COL1 LEV1,ROUND(SECONDS_IN_WAIT / 60) MIN_IN_WAIT,TO_CHAR(username) username,osuser,sql_id,programa,BLOCKING_SESSION,event,SID,Serial#,Acao,Modulo
FROM	((SELECT	a.INST_ID || ',' || a.SID COL1,
					a.EVENT,
					a.SQL_ID,
					a.PROGRAM,
					a.BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
					a.SECONDS_IN_WAIT,
					a.username,
					a.osuser,
					a.machine,
					a.program programa,
					a.serial#,
					a.SID,
					a.INST_ID,
					SUBSTR(a.action,1,15) acao,
					SUBSTR(a.MODULE,1,15) modulo,
					a.BLOCKING_SESSION
		FROM GV$SESSION a
)) WHERE COL1 IN(SELECT LEV1 FROM B)
  UNION ALL
WITH A AS
	(WITH RECURSIVE cte AS (
	SELECT 1 LEV,CONNECT_BY_ROOT COL1 BLOCKER,COL1 LEV1
		FROM ((	SELECT	INST_ID || ',' || SID COL1,
						EVENT,
						SQL_ID,
						PROGRAM,
						BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
						SECONDS_IN_WAIT
				FROM	GV$SESSION)) alias1 WHERE COL2 IN (	SELECT	BLOCKING_INSTANCE || ',' || BLOCKING_SESSION
								FROM	GV$SESSION
								WHERE	BLOCKING_SESSION IS NOT NULL)
  UNION ALL
	SELECT (c.level+1) LEV,CONNECT_BY_ROOT COL1 BLOCKER,COL1 LEV1
		FROM ((	SELECT	INST_ID || ',' || SID COL1,
						EVENT,
						SQL_ID,
						PROGRAM,
						BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
						SECONDS_IN_WAIT
				FROM	GV$SESSION)) JOIN cte c ON (c.COL2 = COL1)

) SELECT * FROM cte;
),
B AS (	SELECT	DISTINCT LEV1
		FROM	A
		WHERE (A.LEV, A.BLOCKER) IN (SELECT	MAX(LEV), BLOCKER FROM A GROUP BY BLOCKER))
SELECT	LPAD(' ', 3 * ((c.level+1) - 1)) || COL1 LEV1,ROUND(SECONDS_IN_WAIT / 60) MIN_IN_WAIT,TO_CHAR(username) username,osuser,sql_id,programa,BLOCKING_SESSION,event,SID,Serial#,Acao,Modulo
FROM	((SELECT	a.INST_ID || ',' || a.SID COL1,
					a.EVENT,
					a.SQL_ID,
					a.PROGRAM,
					a.BLOCKING_INSTANCE || ',' || BLOCKING_SESSION COL2,
					a.SECONDS_IN_WAIT,
					a.username,
					a.osuser,
					a.machine,
					a.program programa,
					a.serial#,
					a.SID,
					a.INST_ID,
					SUBSTR(a.action,1,15) acao,
					SUBSTR(a.MODULE,1,15) modulo,
					a.BLOCKING_SESSION
		FROM GV$SESSION a
)) JOIN cte c ON (c.COL1 = COL2)

) SELECT * FROM cte;


