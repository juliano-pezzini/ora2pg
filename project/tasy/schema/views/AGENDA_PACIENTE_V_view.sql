-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW agenda_paciente_v (cd_estabelecimento, cd_agenda, dt_agenda_dia, ds_agenda, dt_agenda, hr_inicio, nr_minuto_duracao, cd_medico, cd_procedimento, nm_pessoa_contato, ds_observacao_completa, ds_observacao, cd_convenio, cd_plano, nr_cirurgia, nm_usuario, dt_atualizacao, ie_origem_proced, ie_ortese_protese, ie_cdi, ie_uti, ie_leito, ie_anestesia, ie_banco_sangue, ie_serv_especial, ie_video, cd_motivo_cancelamento, cd_pessoa_fisica, nm_paciente_pf, nm_paciente, dt_nascimento, nm_medico, nm_guerra, ds_convenio, ds_procedimento, nm_instrumentador, nm_circulante, ds_proc_cirurgia, cd_tipo_agenda, cd_setor_exclusivo, ds_cirurgia, qt_idade_paciente, cd_tipo_anestesia, ds_tipo_anestesia, ie_status_agenda, ds_status_agenda, ds_tipo_anestesia_3, ie_turno, cd_turno, nr_sequencia, ds_senha, cd_pediatra, cd_anestesista, ds_proc_conv, nr_telefone_pac, nr_atendimento, ds_idade, ds_idade_abrev, qt_anos, ds_turno, cd_unidade, nm_pediatra, nm_anestesista, ie_carater_cirurgia, ds_carater_cirurgia, nm_guerra_anest, nr_seq_apresent, cd_usuario_convenio, nm_usuario_orig, qt_idade_mes, nr_telefone, dt_agendamento, ie_autorizacao, ie_sexo, nr_telefone_celular, ds_idade_grid, nr_controle, ie_status_laudo, ie_equipamento, cd_autorizacao, nr_seq_age_cons, cd_medico_exec, nm_medico_exec, ds_proced_adic, nr_seq_classif_agenda, ie_uc, ie_situacao, cd_procedencia, cd_categoria, cd_tipo_acomodacao, nr_doc_convenio, dt_validade_carteira, ds_tipo_autorizacao, dt_confirmacao, nm_usuario_confirm, ie_lado, nr_seq_proc_interno, ie_tipo_classif, ds_status_paciente, ds_cor_fundo_status, ds_cor_fonte_status, ie_biopsia, ie_congelacao, ds_laboratorio, qt_min_padrao, dt_nascimento_pac, cd_doenca_cid, ds_doenca_cid, nr_seq_sala, ds_sala, nm_medico_externo, nr_seq_status_pac, dt_entrada_tasy, ie_tipo_atendimento, ie_consulta_anestesica, ie_pre_internacao, ie_reserva_leito, ie_tipo_anestesia, dt_chegada, cd_medico_req, qt_min_espera_tasy, qt_min_espera, nr_seq_pq_proc, ds_proc_pesquisa, ds_classif_agenda_pac, dt_chegada_fim, ie_arco_c, ds_cor_classif, nr_seq_indicacao, ds_indicacao, cd_pessoa_indicacao, nm_pessoa_indicacao, ds_categoria, ds_dia_semana, ie_encaixe, nr_seq_oftalmo, dt_chegada_prev, ds_motivo_status, nm_usuario_acesso, cd_perfil_exclusivo, nr_seq_tipo_classif_pac, qt_altura_cm, qt_peso, cd_setor_atendimento, ds_protocolo, ie_forma_agendamento, ds_senha_pac, nr_seq_fila_espera, cd_senha_gerada, qt_chamadas, nr_seq_pac_senha_fila, ds_inf_pendente, ie_autor_desdobrada, nr_prontuario, cd_rfc, ds_cirurgia_completo, ds_sala_cir, cd_departamento_medico) AS select 	a.cd_estabelecimento,
	a.cd_agenda,
	trunc(b.dt_agenda,'dd') dt_agenda_dia,
        a.ds_agenda,
        b.dt_agenda,
        b.hr_inicio,
        b.nr_minuto_duracao,
        b.cd_medico,
        b.cd_procedimento,
        b.nm_pessoa_contato,
	b.ds_observacao ds_observacao_completa,
        substr(b.ds_observacao,1,250) ds_observacao,
        b.cd_convenio,
	b.cd_plano,
        b.nr_cirurgia,
	b.nm_usuario,
	b.dt_atualizacao,
     	b.ie_origem_proced,
	b.ie_ortese_protese,
        b.ie_cdi,
        b.ie_uti,
	b.ie_leito,
	b.ie_anestesia,
  	b.ie_banco_sangue,
 	b.ie_serv_especial,
	b.ie_video,
     	b.cd_motivo_cancelamento,
        b.cd_pessoa_fisica,
	substr(CASE WHEN b.IE_STATUS_AGENDA='B' THEN	CASE WHEN b.ds_observacao IS NULL THEN  'Bloqueado'  ELSE 'Bloqueado('|| b.ds_observacao || ')' END   ELSE coalesce(substr(obter_nome_pf(p.cd_pessoa_fisica),1,200),substr(b.nm_paciente,1,200)) END ,1,200) nm_paciente_pf,
        b.nm_paciente,
        p.dt_nascimento,
        substr(obter_nome_pf(b.cd_medico),1,200) nm_medico,
        substr(OBTER_NOME_MEDICO(b.cd_medico, 'G'),1,200) nm_guerra,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	substr(Obter_Desc_Prescr_Proc(b.CD_PROCEDIMENTO, b.IE_ORIGEM_PROCED, b.nr_seq_proc_interno),1,240) ds_procedimento,
	b.nm_instrumentador,
       	b.nm_circulante,
       	substr(coalesce(substr(obter_Nome_Item_Convenio(b.cd_convenio, 1,
	b.cd_procedimento, b.ie_origem_proced,'N', null, null, null, null),1,80),
	substr(obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced),1,150)),1,250) ds_proc_cirurgia,
       	a.cd_tipo_agenda,
	a.cd_setor_exclusivo,
       	substr(b.ds_cirurgia,1,250) ds_cirurgia,
       	b.qt_idade_paciente,
       	b.cd_tipo_anestesia,
	substr(obter_valor_dominio(36, b.cd_tipo_anestesia),1,30) ds_tipo_anestesia,
       	b.ie_status_agenda,
	substr(obter_valor_dominio(83, b.ie_status_agenda),1,30) ds_status_agenda,
       	CASE WHEN b.cd_tipo_anestesia IS NULL THEN 	ie_anestesia  ELSE substr(obter_valor_dominio(36, b.cd_tipo_anestesia),1,15) END  ds_Tipo_Anestesia_3,
       	substr(to_char((b.hr_inicio- 2/24),'hh24'),1,1) ie_turno,
	b.cd_turno,
	b.nr_sequencia,
	b.ds_senha,
	b.cd_pediatra,
	b.cd_anestesista,
	CASE WHEN b.nr_seq_proc_interno IS NULL THEN 	substr(obter_Nome_Item_Convenio(b.cd_convenio, 1,	b.cd_procedimento, b.ie_origem_proced,'N', null, null, null, null),1,80)  ELSE substr(Obter_Desc_Prescr_Proc(CD_PROCEDIMENTO,IE_ORIGEM_PROCED, nr_seq_proc_interno),1,240) END  ds_proc_conv,
	coalesce(b.nr_telefone, p.nr_telefone_celular) nr_telefone_pac,
	b.nr_atendimento,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'C'),1,20) ds_idade,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'S'),1,20) ds_idade_abrev,
	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'A'),1,3) qt_anos,
	CASE WHEN b.cd_turno=0 THEN  OBTER_DESC_EXPRESSAO(487774,'Manha') WHEN b.cd_turno=1 THEN OBTER_DESC_EXPRESSAO(487775,'Tarde') WHEN b.cd_turno=3 THEN OBTER_DESC_EXPRESSAO(498843,'Noturno') END  ds_turno,
	substr(obter_unidade_paciente(b.nr_cirurgia, b.cd_pessoa_fisica, b.nr_atendimento),1,100) cd_unidade,
	substr(obter_nome_medico(b.cd_pediatra, 'N'),1,100) nm_pediatra,
	substr(obter_nome_medico(b.cd_anestesista,'N'),1,100) nm_anestesista,
	b.ie_carater_cirurgia,
	substr(obter_valor_dominio(1016, b.ie_carater_cirurgia),1,30) ds_carater_cirurgia,
	substr(obter_nome_medico(b.cd_anestesista, 'G'),1,100) nm_guerra_anest,
	a.nr_seq_apresent,
	b.cd_usuario_convenio,
	b.nm_usuario_orig,
	b.qt_idade_mes,
	b.nr_telefone,
	b.dt_agendamento,
	b.ie_autorizacao,
	p.ie_sexo,
	p.nr_telefone_celular,
	CASE WHEN coalesce(b.qt_idade_paciente,0) + coalesce(b.qt_idade_mes,0)=0 THEN 	substr(obter_idade(p.dt_nascimento, LOCALTIMESTAMP, 'S'),1,20)  ELSE CASE WHEN coalesce(b.qt_idade_paciente,0)=0 THEN ''  ELSE coalesce(b.qt_idade_paciente,0) || ' A ' END  ||	CASE WHEN coalesce(b.qt_idade_mes,0)=0 THEN ''  ELSE coalesce(b.qt_idade_mes,0) || ' M' END  END  ds_idade_Grid,
	obter_controle_prescricao(nr_atendimento, b.nr_sequencia) nr_controle,
	substr(coalesce(obter_status_laudo_agenda(b.nr_sequencia, b.nr_atendimento),'N'),1,3) ie_status_laudo,
	ie_equipamento,
	substr(Obter_Autorizacao_cirurgia(b.nr_sequencia),1,50) cd_autorizacao,
	b.nr_seq_age_cons,
	b.cd_medico_exec,
	substr(obter_nome_pf(b.cd_medico_exec),1,200) nm_medico_exec,
	substr(Obter_Proced_Adicional_Agenda(b.nr_sequencia),1,250) ds_proced_adic,
	b.nr_seq_classif_agenda,
	b.ie_uc,
	a.ie_situacao,
	b.cd_procedencia,
	b.cd_categoria,
	b.cd_tipo_acomodacao,
	b.nr_doc_convenio,
	b.dt_validade_carteira,
	substr(obter_valor_dominio(1227, b.IE_AUTORIZACAO),1,200) ds_tipo_autorizacao,
	b.dt_confirmacao,
	b.nm_usuario_confirm,
	b.ie_lado,
	b.nr_seq_proc_interno,
	x.ie_tipo_classif,
	s.ds_status_paciente,
	s.ds_cor_fundo ds_cor_fundo_status,
	s.ds_cor_fonte ds_cor_fonte_status,
	b.IE_BIOPSIA,
	b.IE_CONGELACAO,
	b.DS_LABORATORIO,
	b.QT_MIN_PADRAO,
	b.DT_NASCIMENTO_PAC,
	b.cD_DOENCA_CID,
	substr(obter_desc_cid(b.cD_DOENCA_CID),1,200) DS_DOENCA_CID,
	b.nr_seq_sala,
	substr(OBTER_DESC_SALA_CONSULTA(b.nr_seq_sala),1,150) ds_sala,
	b.NM_MEDICO_EXTERNO,
	b.nr_seq_status_pac,
	OBTER_DATA_ENTRADA(b.nr_atendimento) dt_entrada_tasy,
	b.ie_tipo_atendimento,
	b.IE_CONSULTA_ANESTESICA,
	b.IE_PRE_INTERNACAO,
	b.ie_reserva_leito,
	b.ie_tipo_anestesia,
	b.dt_chegada,
	b.cd_medico_req,
	Obter_Tempo_Espera_Atend(b.nr_atendimento) qt_min_espera_tasy,
	Obter_Min_Entre_Datas(b.dt_chegada, coalesce(coalesce(to_date(obter_dados_atendimento(b.nr_atendimento,'DE'),'dd/mm/yyyy hh24:mi:ss'), b.dt_chegada_fim), LOCALTIMESTAMP), null) qt_min_espera,
	b.nr_seq_pq_proc,
	substr(obter_desc_proc_pesq(b.nr_seq_pq_proc),1,255) ds_proc_pesquisa,
	substr(OBTER_DESC_CLASSIF_AGENDA_PAC(NR_SEQ_CLASSIF_AGENDA),1,200) ds_classif_agenda_pac,
	b.dt_chegada_fim,
	b.ie_arco_c,
	substr(obter_cor_classif_agepac(b.nr_seq_classif_agenda),1,25) ds_cor_classif,
	b.nr_seq_indicacao,
	substr(obter_desc_indicacao(b.nr_seq_indicacao),1,40) ds_indicacao,
	b.cd_pessoa_indicacao,
	substr(obter_nome_pf(b.cd_pessoa_indicacao),1,60) nm_pessoa_indicacao,
	substr(obter_categoria_convenio(b.cd_convenio, b.cd_categoria),1,60) ds_categoria,
	substr(obter_dia_semana(b.dt_agenda),1,20) ds_dia_semana,
	b.ie_encaixe,
	b.nr_seq_oftalmo,
	b.dt_chegada_prev,
	b.ds_motivo_status,
	b.nm_usuario_acesso,
	a.cd_perfil_exclusivo,
	b.nr_seq_tipo_classif_pac,
	b.qt_altura_cm,
	b.qt_peso,
	b.cd_setor_atendimento,
	b.ds_protocolo,
	b.ie_forma_agendamento,
	substr(obter_letra_verifacao_senha(coalesce(sf.nr_seq_fila_senha_origem, sf.nr_seq_fila_senha)),1,10) || sf.cd_senha_gerada,
	sf.nr_seq_fila_senha nr_seq_fila_espera,
	sf.cd_senha_gerada,
	sf.qt_chamadas,
	sf.nr_sequencia nr_seq_pac_senha_fila,
	b.ds_inf_pendente,
	substr(obter_se_autor_desdob_agenda(b.nr_sequencia),1,1) ie_autor_desdobrada,
	p.nr_prontuario,
	p.cd_rfc,
	b.ds_cirurgia ds_cirurgia_completo,
   SUBSTR(obter_nome_sala_cirur(b.nr_seq_sala_cir,NULL),1,255) ds_sala_cir,
   a.cd_departamento_medico
	--substr(obter_prontuario_pf(a.cd_estabelecimento, p.cd_pessoa_fisica), 1, 255) nr_prontuario

FROM agenda a, agenda_paciente b
LEFT OUTER JOIN pessoa_fisica p ON (b.cd_pessoa_fisica = p.cd_pessoa_fisica)
LEFT OUTER JOIN agenda_paciente_classif x ON (b.nr_seq_classif_agenda = x.nr_sequencia)
LEFT OUTER JOIN status_paciente_agenda s ON (b.nr_seq_status_pac = s.nr_sequencia)
LEFT OUTER JOIN paciente_senha_fila sf ON (b.nr_seq_pac_senha_fila = sf.nr_sequencia)
WHERE a.cd_agenda = b.cd_agenda;

