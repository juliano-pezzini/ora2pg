-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_aacd_gestao_exames_v (nr_prescricao, dt_prescricao, cd_pessoa_dia, cd_medico, nm_medico, dt_liberacao_medico, nm_usuario_original, nm_usuario, dt_emissao_setor_atend, dt_liberacao, cd_pessoa_fisica, dt_prev_execucao, nr_sequencia, dt_liberacao_laudo, ie_status_execucao, ie_status_filtro, ds_status_execucao, cd_setor_atendimento, cd_procedimento, ie_origem_proced, nm_usuario_laudo, nm_usuario_aprovacao, nm_usuario_seg_aprov, cd_medico_exec, nm_medico_prev_exec, cd_medico_executor, nm_medico_executor, cd_medico_resp, nm_medico_laudo, ds_autorizacao, ds_observacao, ds_procedimento, ds_procedimento_cod, nr_seq_proced, nr_seq_propaci, ds_dado_clinico, ds_motivo_parada, ds_senha, cd_material_exame, nr_prontuario, ds_setor_atendimento, cd_setor_entrega, dt_baixa, dt_procedimento, ds_motivo_baixa, ds_arquivo, nm_convenio, ie_laudo_ant, dt_ditado, ds_procedencia, dt_inicio, ds_lado_proced, cd_estabelecimento, nm_usuario_exec, ie_mat_med, ds_urgencia, ds_tipo_atend, ds_idade, dt_nascimento, ds_convenio, cd_usuario_convenio, nr_crm, ds_uf_medico, ds_senha_laudo_medico, ie_executar_leito, ds_local, ie_obs_proced, dt_inicio_exame, qt_prescrito, qt_liberado, qt_exame, ds_status_agenda, ds_exame_lab, ds_material_exame, ds_interv_prescr, ds_interv_liber, ds_interv_exame, ds_proced_princ_int, ds_tipo_convenio, ie_tipo_convenio, cd_convenio, ie_tipo_atendimento, ds_hora_procedimento, cd_hora_procedimento, cd_tipo_procedimento, ds_tipo_procedimento, cd_especialidade, ds_especialidade, cd_grupo_proc, ds_grupo_proc, cd_empresa, cd_setor_prescricao, ds_setor_prescricao, cd_proc_exec, ie_origem_exec, ds_proc_exec, qt_filme, nr_seq_proc_interno, nr_seq_exame, nr_seq_tamanho_filme, ds_tamanho_filme, ds_hora_prescricao, cd_hora_prescricao, nm_paciente, cd_paciente, ds_interv_exec, nm_medico_externo, qt_proc_presc, qt_proc_pac) AS select  distinct a.nr_prescricao,
     trunc(a.dt_prescricao) dt_prescricao, 
	z.cd_pessoa_fisica || ' - ' || to_char(a.dt_prescricao,'dd/mm/yyyy') cd_pessoa_dia, 
     a.cd_medico, 
	 substr((select nm_pessoa_fisica 
		FROM pessoa_fisica 
		where cd_pessoa_fisica = a.cd_medico),1,60) nm_medico, 
     a.dt_liberacao_medico, 
     a.nm_usuario_original, 
     a.nm_usuario, 
     b.dt_emissao_setor_atend, 
     a.dt_liberacao, 
     a.cd_pessoa_fisica, 
     b.dt_prev_execucao, 
     d.nr_sequencia, 
     d.dt_liberacao dt_liberacao_laudo, 
     b.ie_status_execucao, 
		 CASE WHEN b.ie_status_execucao='BE' THEN 01  ELSE b.ie_status_execucao END  ie_status_filtro, 
	 substr((select ds_valor_dominio 
		from	 valor_dominio 
		where	 vl_dominio	= b.ie_status_execucao 
		and cd_dominio = 1226),1,40) ds_status_execucao, 
     coalesce(b.cd_setor_atendimento, coalesce(a.cd_setor_entrega, a.cd_setor_atendimento)) cd_setor_atendimento, 
     b.cd_procedimento, 
     b.ie_origem_proced, 
     d.nm_usuario nm_usuario_laudo, 
     d.nm_usuario_aprovacao, 
     d.nm_usuario_seg_aprov, 
     b.cd_medico_exec, 
	 substr((select nm_pessoa_fisica 
		from pessoa_fisica 
		where cd_pessoa_fisica = b.cd_medico_exec),1,60) nm_medico_prev_exec, 
     c.cd_medico_executor, 
	 substr((select nm_pessoa_fisica 
		from pessoa_fisica 
		where cd_pessoa_fisica = c.cd_medico_executor),1,60) nm_medico_executor, 
     d.cd_medico_resp, 
	 substr((select nm_pessoa_fisica 
		from pessoa_fisica 
		where cd_pessoa_fisica = d.cd_medico_resp),1,60) nm_medico_laudo, 
	 substr((select ds_valor_dominio 
		from	 valor_dominio 
		where	 vl_dominio	= b.ie_autorizacao 
		and cd_dominio = 1227),1,20) ds_autorizacao, 
     substr(b.ds_observacao,1,255) ds_observacao, 
     substr(obter_desc_prescr_proc(b.cd_procedimento,b.ie_origem_proced, b.nr_seq_proc_interno),1,60) ds_procedimento, 
	 substr(obter_desc_prescr_proc(b.cd_procedimento,b.ie_origem_proced, b.nr_seq_proc_interno),1,60) || ' - ' || b.cd_procedimento ds_procedimento_cod, 
     b.nr_sequencia nr_seq_proced, 
     c.nr_sequencia nr_seq_propaci, 
     b.ds_dado_clinico, 
	 substr((select	ds_motivo 
		from	motivo_laudo_parado 
		where	nr_sequencia	= d.nr_seq_motivo_parada),1,80) ds_motivo_parada, 
     substr(Obter_senha_autoriz_proced(a.nr_prescricao,a.nr_atendimento,b.cd_procedimento,b.ie_origem_proced),1,20) ds_senha, 
     b.cd_material_exame, 
     substr((select nr_prontuario 
		from pessoa_fisica 
		where cd_pessoa_fisica = a.cd_pessoa_fisica),1,20) nr_prontuario,	 
	 substr((select	max(ds_setor_atendimento) 
		from	setor_atendimento 
		where	cd_setor_atendimento = coalesce(b.cd_setor_atendimento, coalesce(a.cd_setor_entrega, a.cd_setor_atendimento))),1,100) ds_setor_atendimento, 
     a.cd_setor_entrega, 
     b.dt_baixa, c.dt_procedimento, 
	 substr((select	ds_tipo_baixa 
        from	tipo_baixa_prescricao 
	    where	cd_tipo_baixa		= b.cd_motivo_baixa 
	    and	ie_prescricao_devolucao	= 'P'),1,60) ds_motivo_baixa, 
	 substr((select	coalesce(max(ds_arquivo),'Sem arquivo') 
		from 	prescr_proc_ditado 
		where nr_seq_prescr_proc = b.nr_seq_interno),1,80) ds_arquivo,	 
	 substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,100) nm_convenio, 
	 substr((select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
		from  	laudo_paciente z, 
			atendimento_paciente x 
		where	z.nr_atendimento = x.nr_atendimento 
		and 	x.cd_pessoa_fisica = a.cd_pessoa_fisica 
		and	z.dt_liberacao is not null),1,1) ie_laudo_ant, 
	(select	max(dt_atualizacao) 
	 from	prescr_proc_ditado 
     where	nr_seq_prescr_proc = b.nr_seq_interno)dt_ditado,	 
	 substr((select	ds_procedencia 
		from	procedencia 
		where 	cd_procedencia = z.cd_procedencia),1,40) ds_procedencia, 
     obter_hora_inicio_agenda(a.nr_seq_agenda) dt_inicio,	 
	 substr((select ds_valor_dominio 
		from	 valor_dominio 
		where	 vl_dominio	= b.ie_lado 
		and cd_dominio = 1372),1,100) ds_lado_proced, 
	 to_char(a.cd_estabelecimento) cd_estabelecimento, 
     c.nm_usuario_original nm_usuario_exec, 
     substr(obter_se_item_lancado_atend(a.nr_atendimento),1,1) ie_mat_med, 
     CASE WHEN b.ie_urgencia='S' THEN 'Urgente' END  ds_urgencia, 
	 substr((select ds_valor_dominio 
		from	 valor_dominio 
		where	 vl_dominio	= z.ie_tipo_atendimento 
		and cd_dominio = 12),1,60) ds_tipo_atend, 
     substr((select obter_idade(dt_nascimento,coalesce(to_date(i.dt_obito,'dd/mm/yyyy'), LOCALTIMESTAMP),'AM') 
		from pessoa_fisica i 
		where i.cd_pessoa_fisica = a.cd_pessoa_fisica),1,100) ds_idade, 
	(select to_char(dt_nascimento,'DD/MM/YYYY') from pessoa_fisica 
	 where cd_pessoa_fisica = a.cd_pessoa_fisica) dt_nascimento, 
     substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,100) ds_convenio, 
     substr(obter_dados_categ_conv(a.nr_atendimento, 'U'),1,100) cd_usuario_convenio, 
	 substr((select max(nr_crm) from medico 
		 where cd_pessoa_fisica = d.cd_medico_resp),1,6) nr_crm, 
	 substr((select max(uf_crm) from medico 
		 where cd_pessoa_fisica = d.cd_medico_resp),1,2) ds_uf_medico, 
	 substr((select coalesce(max(ds_senha_laudo),null) 
		 from	usuario 
		 where	cd_pessoa_fisica = d.cd_medico_resp),1,15) ds_senha_laudo_medico, 
     coalesce(b.ie_executar_leito,'N') ie_executar_leito, 
     CASE WHEN ((select max(cd_classif_setor) 		from	setor_atendimento 		where cd_setor_atendimento = b.cd_setor_atendimento))=1 THEN  substr((SELECT DS_ABREV 									FROM	PA_LOCAL 									WHERE	NR_SEQUENCIA = obter_nr_seq_local_pa(a.nr_atendimento)),1,80)  ELSE substr((select 	cd_unidade_basica || ' ' || cd_unidade_compl 			from	atend_paciente_unidade 			where	nr_seq_interno = obter_atepacu_paciente(a.nr_atendimento, 'IAA')),1,80) END  ds_local,		 
    substr((select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
		from	prescr_procedimento_obs 
 		where	nr_prescricao		= b.nr_prescricao 
		and	nr_seq_prescricao	= b.nr_sequencia),1,1) ie_obs_proced, 
     b.dt_inicio_exame, 
     obter_minutos_espera(a.dt_prescricao, a.dt_liberacao) qt_prescrito, 
     obter_minutos_espera(a.dt_liberacao, b.dt_inicio_exame) qt_liberado, 
     obter_minutos_espera(b.dt_inicio_exame, b.dt_baixa) qt_exame, 
     substr(Obter_status_Agenda_Paciente(a.nr_seq_agenda),1,200) ds_status_agenda, 
     substr(obter_desc_exame_lab(b.nr_seq_exame, '', b.cd_procedimento, b.ie_origem_proced),1,100) ds_exame_lab, 
     substr(obter_material_exame_lab(null, b.cd_material_exame, 3),1,80) ds_material_exame,     
	 obter_intervalo_minutos(obter_minutos_espera(a.dt_prescricao, a.dt_liberacao)) ds_interv_prescr, 
	 obter_intervalo_minutos(obter_minutos_espera(a.dt_liberacao, b.dt_inicio_exame)) ds_interv_liber, 
	 obter_intervalo_minutos(obter_minutos_espera(b.dt_inicio_exame, b.dt_baixa)) ds_interv_exame, 
	 substr((select	ds_proc_interno 
		from	procedimento 
		where	cd_procedimento	 =	w.cd_procedimento 
		and	ie_origem_proced =	w.ie_origem_proced),1,200) ds_proced_princ_int, 
	 substr(obter_desc_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,100) ds_tipo_convenio, 
	 obter_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)) ie_tipo_convenio, 
	 obter_convenio_atendimento(a.nr_atendimento) cd_convenio, 
	 z.ie_tipo_atendimento, 
	 to_char(c.dt_procedimento,'hh24') || ':00' ds_hora_procedimento, 
	 (to_char(c.dt_procedimento,'hh24'))::numeric  cd_hora_procedimento, 
	 w.cd_tipo_procedimento, 
	 substr((select ds_valor_dominio 
		from	 valor_dominio 
		where	 vl_dominio	= w.cd_tipo_procedimento 
		and cd_dominio = 95),1,255) ds_tipo_procedimento, 
	 substr((select cd_especialidade 
		from estrutura_procedimento_v 
		where cd_procedimento = w.cd_procedimento 
		and ie_origem_proced = w.ie_origem_proced),1,80) cd_especialidade, 
	 substr((select ds_especialidade 
		from estrutura_procedimento_v 
		where cd_procedimento = w.cd_procedimento 
		and ie_origem_proced = w.ie_origem_proced),1,80) ds_especialidade,		 
	 w.cd_grupo_proc, 
	 substr((select ds_grupo_proc 
		from estrutura_procedimento_v 
		where cd_procedimento = w.cd_procedimento 
		and ie_origem_proced = w.ie_origem_proced),1,80) ds_grupo_proc,	 
	 e.cd_empresa, 
	 a.cd_setor_atendimento cd_setor_prescricao, 
	 substr((select	ds_setor_atendimento 
		from	setor_atendimento 
		where	cd_setor_atendimento	= a.cd_setor_atendimento),1,100) ds_setor_prescricao,	 
	 c.cd_procedimento cd_proc_exec, 
	 c.ie_origem_proced ie_origem_exec, 
	 substr(obter_desc_prescr_proc(c.cd_procedimento,c.ie_origem_proced, c.nr_seq_proc_interno),1,60) ds_proc_exec, 
	 c.QT_FILME, 
	 b.nr_seq_proc_interno, 
	 b.nr_seq_exame, 
	 c.NR_SEQ_TAMANHO_FILME, 
	 substr((select	ds_tamanho ds 
		from	tamanho_filme_padrao x 
		where	nr_sequencia = c.NR_SEQ_TAMANHO_FILME),1,50) ds_tamanho_filme, 
	 to_char(a.dt_prescricao,'hh24') || ':00' ds_hora_prescricao, 
	 (to_char(a.dt_prescricao,'hh24'))::numeric  cd_hora_prescricao, 
	 substr((select nm_pessoa_fisica 
		from pessoa_fisica 
		where cd_pessoa_fisica = z.cd_pessoa_fisica),1,60) nm_paciente, 
	 z.cd_pessoa_fisica cd_paciente, 
	 obter_intervalo_minutos(obter_minutos_espera(a.dt_prescricao, c.dt_procedimento)) ds_interv_exec, 
	initcap(lower(trim(both a.nm_medico_externo))) nm_medico_externo, 
	b.qt_procedimento qt_proc_presc, 
	c.qt_procedimento qt_proc_pac 
FROM procedimento w, procedimento_paciente c
LEFT OUTER JOIN laudo_paciente d ON (c.nr_laudo = d.nr_sequencia)
LEFT OUTER JOIN conta_paciente f ON (c.nr_interno_conta = f.nr_interno_conta)
, prescr_procedimento b
LEFT OUTER JOIN procedimento_paciente c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_sequencia_prescricao)
, prescr_medica a
LEFT OUTER JOIN atendimento_paciente z ON (a.nr_atendimento = z.nr_atendimento)
LEFT OUTER JOIN estabelecimento e ON (z.cd_estabelecimento = e.cd_estabelecimento)
WHERE w.cd_procedimento = b.cd_procedimento and w.ie_origem_proced = b.ie_origem_proced  and a.nr_prescricao = b.nr_prescricao      and ((b.cd_motivo_baixa = 0) or (b.ie_status_execucao <> '10')) and f.ie_cancelamento is null and b.ie_suspenso <> 'S' and a.dt_suspensao is null;

