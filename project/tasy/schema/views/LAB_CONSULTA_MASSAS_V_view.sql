-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_consulta_massas_v (ie_ordem, nm_exame, nr_seq_grupo_pat, nr_seq2, nr_seq_exam, ie_acao_criterio_lote, qt_result, qt_resultado, pr_resultado, ds_resultado, nr_seq_prescr, nr_seq_resultado, nr_seq_material, ds_frase_patol, nr_prescricao, ie_primario, nr_seq_ficha, nr_seq_item_pat, nr_sequencia, nm_usuario, dt_atualizacao, ds_acao_criterio_lote, ie_formato_resultado, ie_campo_calculo, ie_status_atend, dt_aprovacao, ds_mensagem_criterio_massas, ds_acao_criterio_massas, ie_acao_criterio_massas, ds_resultado_sugerido, ds_material_criterio, ds_metodo_criterio, cd_material_exame, ds_lote_result_p, ds_lote_result_s, ds_lote_result_t, ds_lote_result_q, ds_lote_result_qui, ds_lote_result_sex, ie_exame_bloqueado, nr_seq_metodo, nr_linha) AS select a.IE_ORDEM,a.NM_EXAME,a.NR_SEQ_GRUPO_PAT,a.NR_SEQ2,a.NR_SEQ_EXAM,a.IE_ACAO_CRITERIO_LOTE,a.QT_RESULT,a.QT_RESULTADO,a.PR_RESULTADO,a.DS_RESULTADO,a.NR_SEQ_PRESCR,a.NR_SEQ_RESULTADO,a.NR_SEQ_MATERIAL,a.DS_FRASE_PATOL,a.NR_PRESCRICAO,a.IE_PRIMARIO,a.NR_SEQ_FICHA,a.NR_SEQ_ITEM_PAT,a.NR_SEQUENCIA,a.NM_USUARIO,a.DT_ATUALIZACAO,a.DS_ACAO_CRITERIO_LOTE,a.IE_FORMATO_RESULTADO,a.IE_CAMPO_CALCULO,a.IE_STATUS_ATEND,a.DT_APROVACAO,a.DS_MENSAGEM_CRITERIO_MASSAS,a.DS_ACAO_CRITERIO_MASSAS,a.IE_ACAO_CRITERIO_MASSAS,a.DS_RESULTADO_SUGERIDO,a.DS_MATERIAL_CRITERIO,a.DS_METODO_CRITERIO,a.CD_MATERIAL_EXAME,a.DS_LOTE_RESULT_P,a.DS_LOTE_RESULT_S,a.DS_LOTE_RESULT_T,a.DS_LOTE_RESULT_Q,a.DS_LOTE_RESULT_QUI,a.DS_LOTE_RESULT_SEX,a.IE_EXAME_BLOQUEADO,a.NR_SEQ_METODO, row_number() OVER () AS nr_linha FROM (
 SELECT 	1 ie_ordem, 
    	w.nm_exame, 
    	0 nr_seq_grupo_pat, 
    	0 nr_seq2, 
    	m.nr_seq_exame nr_seq_exam, 
    	NULL IE_ACAO_CRITERIO_LOTE, 
    	NULL qt_result, 
    	to_char(m.qt_resultado) qt_resultado, 
    	m.pr_resultado, 
 	  	substr(m.ds_resultado,1,255) ds_resultado, 
    	m.nr_seq_prescr, 
    	m.nr_seq_resultado, 
    	m.nr_seq_material, 
    	'' ds_frase_patol, 
    	p.nr_prescricao, 
    	'' ie_primario, 
    	x.nr_sequencia nr_seq_ficha, 
    	0 nr_seq_item_pat, 
    	m.nr_sequencia, 
    	NULL nm_usuario, 
    	NULL dt_atualizacao, 
    	NULL ds_acao_criterio_lote, 
    	NULL ie_formato_resultado, 
   	NULL ie_campo_calculo, 
    0 ie_status_atend, 
    NULL dt_aprovacao, 
    NULL DS_MENSAGEM_CRITERIO_MASSAS, 
    NULL DS_ACAO_CRITERIO_MASSAS, 
    NULL IE_ACAO_CRITERIO_MASSAS, 
    NULL DS_RESULTADO_SUGERIDO, 
    NULL ds_material_criterio, 
    NULL ds_metodo_criterio, 
    NULL CD_MATERIAL_EXAME, 
     substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 1),1,255) DS_LOTE_RESULT_P, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 2),1,255) DS_LOTE_RESULT_S, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 3),1,255) DS_LOTE_RESULT_T, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 4),1,255) DS_LOTE_RESULT_Q, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 5),1,255) DS_LOTE_RESULT_QUI, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(m.nr_seq_resultado), m.nr_seq_prescr, m.nr_seq_resultado, m.nr_seq_exame, 6),1,255) DS_LOTE_RESULT_SEX, 
    p.ie_exame_bloqueado, 
    m.nr_seq_metodo 
 FROM	lab_patologia_exame a, 
 	   	lab_patologia b, 
 	   	exame_lab_resultado g, 
 	   	prescr_procedimento p, 
 	   	exame_laboratorio w, 
 	   	lote_ent_sec_ficha x, 
 	   	lote_ent_sec_ficha_exam y, 
 	   	exame_laboratorio z, 
			exame_lab_result_item m 
 WHERE	a.nr_seq_patologia = b.nr_sequencia 
 AND  	w.nr_seq_exame = p.nr_seq_exame 
 AND  	p.nr_prescricao = g.nr_prescricao 
 AND  	coalesce(p.ie_suspenso,'N') <> 'S' 
 AND  	z.nr_seq_superior = p.nr_seq_exame 
 AND  	z.nr_seq_exame = a.nr_seq_exame 
 AND  	x.nr_sequencia = y.nr_seq_ficha 
 AND  	y.nr_seq_exame = p.nr_seq_exame 
 AND  	p.nr_seq_exame = y.nr_seq_exame 
 AND  	p.nr_prescricao = x.nr_prescricao 
 AND m.nr_seq_resultado = g.nr_seq_resultado 
 AND m.nr_seq_prescr = p.nr_sequencia  
 AND m.nr_seq_material IS NOT NULL 
 AND  	p.ie_status_atend >= 30 
 AND  	EXISTS (SELECT 	1 
 	   			FROM	LOTE_ENT_EXAME_MASSA l 
 	   			WHERE	l.nr_seq_exame = p.nr_seq_exame 
 	   			AND		l.ie_situacao = 'A') 
 
union all
 
 SELECT	4 ie_ordem, 
 	  	SUBSTR(obter_desc_exame(a.nr_seq_exame),1,255) nm_exame, 
 	  	b.nr_seq_grupo_pat, 
 	  	a.nr_seq_patologia nr_seq2, 
 	  	a.nr_seq_exame nr_seq_exam, 
 	  	d.IE_ACAO_CRITERIO_LOTE IE_ACAO_CRITERIO_LOTE, 
    	SUBSTR(CASE WHEN coalesce(d.qt_resultado,d.pr_resultado)='' THEN d.ds_resultado  ELSE coalesce(d.qt_resultado,d.pr_resultado) END ,1,255) qt_result, 
 	   substr(coalesce(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,8, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),d.qt_resultado),1,255) qt_resultado, 
 	  	d.pr_resultado pr_resultado, 
 	  	substr(d.ds_resultado,1,255) ds_resultado, 
 	  	d.nr_seq_prescr nr_seq_prescr, 
 	  	d.nr_seq_resultado nr_seq_resultado, 
 	  	d.nr_seq_material nr_seq_material, 
 	  	d.ds_obs_lote_ent ds_frase_patol, 
 	  	p.nr_prescricao nr_prescricao, 
 	  	coalesce(coalesce(a.IE_PRIMARIO_LOTE_ENT,w.IE_PRIMARIO_LOTE_ENT),'N') ie_primario, 
 	  	x.nr_sequencia nr_seq_ficha,  
 	  	a.nr_sequencia nr_seq_item_pat, 
 	  	d.nr_sequencia, 
 	  	d.nm_usuario, 
    d.dt_atualizacao, 
 	  	CASE WHEN d.ie_acao_criterio_lote='T' THEN  'Repetir o teste' WHEN d.ie_acao_criterio_lote='R' THEN  'Reconvocado' WHEN d.ie_acao_criterio_lote='S' THEN  'Sem ação' END  ds_acao_criterio_lote, 
 	  	substr(obter_formato_result_exame(d.nr_seq_exame, d.nr_seq_material),1,255) ie_formato_resultado, 
 	  	w.ie_campo_calculo, 
    p.ie_status_atend, 
    d.dt_aprovacao dt_aprovacao, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,3, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) DS_MENSAGEM_CRITERIO_MASSAS, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,4, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) DS_ACAO_CRITERIO_MASSAS, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,7, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) IE_ACAO_CRITERIO_MASSAS, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,8, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) DS_RESULTADO_SUGERIDO, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,9, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) ds_material_criterio, 
    SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,10, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) ds_metodo_criterio, 
    p.cd_material_exame CD_MATERIAL_EXAME, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 1),1,255) DS_LOTE_RESULT_P, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 2),1,255) DS_LOTE_RESULT_S, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 3),1,255) DS_LOTE_RESULT_T, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 4),1,255) DS_LOTE_RESULT_Q, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 5),1,255) DS_LOTE_RESULT_QUI, 
    substr(lote_ent_obter_result_ant(lab_obter_prescr_resultado(d.nr_seq_resultado), d.nr_seq_prescr, d.nr_seq_resultado, d.nr_seq_exame, 6),1,255) DS_LOTE_RESULT_SEX, 
		  null ie_exame_bloqueado, 
    d.nr_seq_metodo nr_seq_metodo 
 FROM	lab_patologia_exame a, 
 	  	lab_patologia b, 
 	  	exame_lab_result_item d, 
 	  	exame_lab_resultado g, 
 	  	prescr_procedimento p, 
 	  	exame_laboratorio w, 
 	  	lote_ent_sec_ficha x, 
 	  	lote_ent_sec_ficha_exam y, 
 	  	exame_laboratorio k, 
    material_exame_lab m 
 WHERE	a.nr_seq_patologia = b.nr_sequencia 
 AND  m.cd_material_exame = p.cd_material_exame 
 AND  	d.nr_seq_exame = k.nr_seq_exame 
 AND  	w.nr_seq_exame = p.nr_seq_exame 
 AND  	d.nr_seq_prescr = p.nr_sequencia 
 AND  	d.nr_seq_resultado = g.nr_seq_resultado 
 AND  	p.nr_prescricao = g.nr_prescricao 
 AND  coalesce(p.ie_suspenso,'N') <> 'S' 
 and  	k.nr_seq_superior = p.nr_seq_exame 
 and  	k.nr_seq_exame = a.nr_seq_exame 
 AND  	x.nr_sequencia = y.nr_seq_ficha 
 AND  	y.nr_seq_exame = p.nr_seq_exame 
 AND  	p.nr_seq_exame = y.nr_seq_exame 
 AND  	p.nr_prescricao = x.nr_prescricao 
 AND  	p.ie_status_atend >= 30 
 AND  	EXISTS (SELECT 	1 
 	   			FROM	LOTE_ENT_EXAME_MASSA l 
 	   			WHERE	l.nr_seq_exame = p.nr_seq_exame 
 	   			AND		l.ie_situacao = 'A') LIMIT 1) a 
 ORDER BY 3,4,1,18,2;

