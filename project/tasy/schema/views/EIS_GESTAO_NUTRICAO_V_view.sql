-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_gestao_nutricao_v (ie_tipo, nr_sequencia, nr_seq_servico, ds_servico, dt_servico, cd_setor_atendimento, nr_atendimento, dt_liberacao, qt_dieta_acomp, qt_dieta_prescrita, cd_convenio, ie_sexo, ds_sexo, ds_setor_atendimento, cd_dieta, nr_seq_classif, nm_dieta, ds_classif, nm_convenio, cd_estabelecimento, ds_estabelecimento) AS select 	a.ie_tipo,
	a.nr_sequencia,
	a.nr_seq_servico,
	SUBSTR(obter_desc_nut_servico(a.nr_seq_servico),1,250) ds_servico,
	a.dt_servico,
	a.cd_setor_atendimento,
	a.nr_atendimento,
	a.dt_liberacao,
	(SELECT	COUNT(1)
	FROM	nut_atend_acomp_dieta b,
		nut_atend_acompanhante c
	WHERE	c.nr_seq_atend_serv_dia = a.nr_sequencia
	AND	b.nr_seq_atend_acomp	= c.nr_sequencia) qt_dieta_acomp,
	qt_dieta_prescrita,
	cd_convenio,
	Obter_Sexo_PF(a.cd_pessoa_fisica,'C') ie_sexo,
	Obter_Sexo_PF(a.cd_pessoa_fisica,'D') ds_sexo,
	obter_nome_setor(a.cd_setor_atendimento) ds_setor_atendimento,
	cd_dieta,
	nr_seq_classif,
	substr(nm_dieta,1,200) nm_dieta,
	substr(ds_classif,1,200) ds_classif,
	SUBSTR(obter_nome_convenio(cd_convenio),1,200) nm_convenio,
	obter_estabelecimento_setor(a.cd_setor_atendimento) cd_estabelecimento,
	SUBSTR(obter_nome_estabelecimento(obter_estabelecimento_setor(a.cd_setor_atendimento)),1,60) ds_estabelecimento	
from 	(
	SELECT	'S' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	prescr_medica e
		WHERE	a.nr_atendimento = e.nr_atendimento
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and ((x.nr_prescr_oral = e.nr_prescricao)
			or (x.nr_prescr_jejum = e.nr_prescricao)
			or (x.nr_prescr_compl = e.nr_prescricao)
			or (x.nr_prescr_enteral = e.nr_prescricao)
			or (x.nr_prescr_npt_adulta  = e.nr_prescricao)
			or (x.nr_prescr_npt_neo  = e.nr_prescricao)))) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		NULL cd_dieta,
		NULL nr_seq_classif,
		NULL nm_dieta,
		NULL ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	prescr_dieta d,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	x.nr_prescr_oral = d.nr_prescricao)) qt_dieta_prescrita,		
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		g.cd_dieta,
		h.nr_seq_classif,
		h.nm_dieta nm_dieta,
		obter_desc_classif_dieta(g.cd_dieta) ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		prescr_dieta g,
		dieta h
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.nr_prescr_oral = g.nr_prescricao
	AND	g.cd_dieta = h.cd_dieta
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	prescr_material d,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		and 	d.ie_agrupador = 12
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	x.nr_prescr_compl = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		g.cd_material,
		99999991,
		h.ds_material nm_dieta,
		'Suplemen/Modul/Pediat' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		prescr_material g,
			material h
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.nr_prescr_compl = g.nr_prescricao
	AND	g.cd_material = h.cd_material
	AND	g.ie_agrupador = 12
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	prescr_material d,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		and 	d.ie_agrupador = 8
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	x.nr_prescr_compl = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		g.cd_material,
		99999992,
		h.ds_material nm_dieta,
		'Suporte Nutricional Enteral' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		prescr_material g,
		material h
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.nr_prescr_compl = g.nr_prescricao
	AND	g.cd_material = h.cd_material
	AND	g.ie_agrupador = 8
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	prescr_material d,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		and 	d.ie_agrupador = 16
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	f.nr_prescr_leite_deriv = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		g.cd_material,
		99999993,
		obter_desc_material(g.cd_material) nm_dieta,
		'Leites e derivados' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		prescr_material g
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.nr_prescr_leite_deriv = g.nr_prescricao
	AND g.ie_agrupador = 16
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	REP_JEJUM d,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and x.nr_prescr_jejum = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		g.NR_SEQ_TIPO,
		99999994,
		obter_desc_tipo_jejum(g.nr_seq_tipo) nm_dieta,
		'Jejum' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		REP_JEJUM g
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.NR_PRESCR_JEJUM = g.nr_prescricao
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	NUT_PAC d,
			NUT_PAC_ELEMENTO a,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		and	a.nr_seq_nut_pac = d.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	x.nr_prescr_npt_neo  = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		b.NR_SEQ_ELEMENTO,
		99999995,
		obter_descricao_padrao('NUT_ELEMENTO','DS_ELEMENTO',b.NR_SEQ_ELEMENTO) nm_dieta,
		'NPT Neonatal' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		NUT_PAC g, NUT_PAC_ELEMENTO b
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.NR_PRESCR_NPT_NEO = g.nr_prescricao
	AND	b.nr_seq_nut_pac = g.nr_Sequencia
	
UNION

	SELECT	'D' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_servico,
		a.dt_servico,
		a.cd_setor_atendimento,
		a.nr_atendimento,
		a.dt_liberacao,
		(SELECT	COUNT(1)
		FROM	NUT_PAC d,
			NUT_PAC_ELEM_MAT a,
			prescr_medica e
		WHERE	d.nr_prescricao = e.nr_prescricao
		and	a.nr_seq_nut_pac = d.nr_prescricao
		AND	a.nr_atendimento = e.nr_atendimento
		AND	exists (select 	1
			from	nut_atend_serv_dia_rep x
			where	x.nr_seq_serv_dia = a.nr_sequencia
			and 	x.nr_prescr_npt_adulta  = d.nr_prescricao)) qt_dieta_prescrita,
		Obter_Convenio_Atendimento(a.nr_atendimento) cd_convenio,
		b.cd_material,
		99999996,
		obter_desc_material(b.cd_material) nm_dieta,
		'NPT Adulta' ds_classif,
		obter_pessoa_atendimento(a.nr_atendimento,'C') cd_pessoa_fisica
	FROM	nut_atend_serv_dia a,
		nut_atend_serv_dia_rep f,
		NUT_PAC g, NUT_PAC_ELEM_MAT b
	WHERE	a.nr_sequencia = f.nr_seq_serv_dia
	AND	f.NR_PRESCR_NPT_ADULTA = g.nr_prescricao
	AND	b.nr_seq_nut_pac = g.nr_sequencia) a;

