-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_interf_socimed_v (tp_registro, ds_registro, cd_cgc_declarante, dt_geracao, dt_vigencia, cd_cgc_cnpj, cd_atividade, cd_modelo_nf, cd_serie_nf, cd_operacao_nf, dt_emissao, nr_nota_fiscal, vl_total_nota, ie_recolhe_iss, cd_estabelecimento) AS select	1 tp_registro,
	'H' ds_registro,
	e.cd_cgc cd_cgc_declarante,
	LOCALTIMESTAMP dt_geracao,
	LOCALTIMESTAMP dt_vigencia,
	' ' cd_cgc_cnpj,
	' ' cd_atividade,
	0 cd_modelo_nf,
	0 cd_serie_nf,
	0 cd_operacao_nf,
	LOCALTIMESTAMP dt_emissao,
	'0' nr_nota_fiscal,
	0 vl_total_nota,
	' ' ie_recolhe_iss,
	e.cd_estabelecimento
FROM	estabelecimento_v e

union

select	3 tp_registro,
	'D' ds_registro,
	' ' cd_cgc_cnpj_declarante,
	LOCALTIMESTAMP dt_geracao,
	n.dt_entrada_saida dt_vigencia,
	coalesce(n.cd_cgc,n.cd_pessoa_fisica) cd_cgc_cnpj,
	e.cd_inscricao_municipal cd_atividade,
	2 cd_modelo_nf,
	1 cd_serie_nf,
	1 cd_operacao_nf,
	n.dt_emissao,
	n.nr_nota_fiscal,
	n.vl_total_nota,
	CASE WHEN substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,5)='E' THEN '1'  ELSE '2' END  ie_recolhe_iss,
	e.cd_estabelecimento
from	estabelecimento_v e,
	nota_fiscal n
where	n.cd_estabelecimento = e.cd_estabelecimento

union

select	9 tp_registro,
	'T' ds_registro,
	' ' cd_cgc_cnpj_declarante,
	LOCALTIMESTAMP dt_geracao,
	LOCALTIMESTAMP dt_vigencia,
	' ' cd_cgc_cnpj,
	' ' cd_atividade,
	0 cd_modelo_nf,
	0 cd_serie_nf,
	0 cd_operacao_nf,
	LOCALTIMESTAMP dt_emissao,
	'0' nr_nota_fiscal,
	0 vl_total_nota,
	' ' ie_recolhe_iss,
	e.cd_estabelecimento
from	estabelecimento_v e
order by tp_registro
;

