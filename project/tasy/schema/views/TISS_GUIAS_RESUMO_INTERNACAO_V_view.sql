-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_guias_resumo_internacao_v (ds_versao, cd_autorizacao, ds_carater_internacao, ds_tipo_saida, ie_tipo_atendimento, nr_interno_conta, nr_seq_protocolo, nr_atendimento, dt_entrada, ie_tipo_saida, ie_tipo_protocolo, cd_tipo_acomodacao, ie_regime_internacao, ie_clinica, ds_tipo_faturamento, ds_observacao, dt_alta, ie_tipo_atend_tiss, cd_autorizacao_tag, ie_tiss_tipo_guia, cd_convenio, cd_autorizacao_princ, cd_cgc_prestador) AS select	'2.01.01' ds_versao,
	c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END  ie_tipo_atendimento, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40) cd_tipo_acomodacao, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5) ie_regime_internacao, 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3) ie_clinica, 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END  ds_tipo_faturamento, 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END  CD_AUTORIZACAO_TAG, 
	'5' ie_tiss_tipo_guia, 
	a.cd_convenio_parametro cd_convenio, 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255) cd_autorizacao_princ, 
	coalesce(e.cd_cgc_prestador_tiss, i.cd_cgc) cd_cgc_prestador 
FROM estabelecimento i, atend_categoria_convenio h, conta_paciente_guia c, conta_paciente a, procedimento_paciente e
LEFT OUTER JOIN regra_honorario g ON (e.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento and a.nr_interno_conta	= c.nr_interno_conta  and e.nr_interno_conta	= c.nr_interno_conta and e.nr_doc_convenio	= c.cd_autorizacao and b.nr_atendimento	= h.nr_atendimento and obter_atecaco_atendimento(b.nr_atendimento) = h.nr_seq_interno and a.cd_estabelecimento	= i.cd_estabelecimento  and ((TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				e.ie_tiss_tipo_guia) = '5') or (TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia) = '5')) and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null and ((b.ie_tipo_atendimento	= 1 AND e.ie_tiss_tipo_guia is null) or (e.ie_tiss_tipo_guia = '5')) 
group	by c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END , 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END , 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3), 
	obter_tipo_protocolo(a.nr_seq_protocolo), 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40), 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3), 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END , 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END , 
	a.cd_convenio_parametro, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5), 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255), 
	coalesce(e.cd_cgc_prestador_tiss, i.cd_cgc) 
 
union
 
select	'2.01.01' ds_versao, 
	'Não Informada' cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END  ie_tipo_atendimento, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40) cd_tipo_acomodacao, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5) ie_regime_internacao, 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3) ie_clinica, 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END  ds_tipo_faturamento, 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	null CD_AUTORIZACAO_TAG, 
	'5' ie_tiss_tipo_guia, 
	a.cd_convenio_parametro cd_convenio, 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255) cd_autorizacao_princ, 
	coalesce(e.cd_cgc_prestador_tiss, i.cd_cgc) cd_cgc_prestador 
FROM estabelecimento i, atend_categoria_convenio h, conta_paciente a, procedimento_paciente e
LEFT OUTER JOIN regra_honorario g ON (e.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento  and a.nr_interno_conta	= e.nr_interno_conta and coalesce(e.nr_doc_convenio, 'Não Informada') = 'Não Informada'  and b.nr_atendimento			= h.nr_atendimento and obter_atecaco_atendimento(b.nr_atendimento) = h.nr_seq_interno and a.cd_estabelecimento			= i.cd_estabelecimento and ((TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				e.ie_tiss_tipo_guia) = '5') or (TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				null, 
				null, 
				e.ie_tiss_tipo_guia) = '5')) and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null and ((b.ie_tipo_atendimento	= 1 AND e.ie_tiss_tipo_guia is null) or (e.ie_tiss_tipo_guia = '5')) 
group 	by CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END , 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END , 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3), 
	obter_tipo_protocolo(a.nr_seq_protocolo), 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40), 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3), 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END , 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	a.cd_convenio_parametro, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5), 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255), 
	coalesce(e.cd_cgc_prestador_tiss, i.cd_cgc) 
 
union
 
select	'2.01.01' ds_versao, 
	c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END  ie_tipo_atendimento, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40) cd_tipo_acomodacao, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5) ie_regime_internacao, 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3) ie_clinica, 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END  ds_tipo_faturamento, 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END  CD_AUTORIZACAO_TAG, 
	'5' ie_tiss_tipo_guia, 
	a.cd_convenio_parametro cd_convenio, 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255) cd_autorizacao_princ, 
	i.cd_cgc cd_cgc_prestador 
FROM estabelecimento i, atend_categoria_convenio h, procedimento_paciente e, conta_paciente_guia c, conta_paciente a, procedimento_participante f
LEFT OUTER JOIN regra_honorario g ON (f.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento and a.nr_interno_conta	= c.nr_interno_conta  and e.nr_interno_conta	= c.nr_interno_conta and e.nr_doc_convenio	= c.cd_autorizacao and b.nr_atendimento	= h.nr_atendimento and obter_atecaco_atendimento(b.nr_atendimento) = h.nr_seq_interno and e.nr_sequencia	= f.nr_sequencia  and a.cd_estabelecimento			= i.cd_estabelecimento and TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				f.ie_tiss_tipo_guia) = '5' and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null 
group	by c.cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END , 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END , 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3), 
	obter_tipo_protocolo(a.nr_seq_protocolo), 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40), 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3), 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END , 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END , 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5), 
	a.cd_convenio_parametro, 
	substr(coalesce(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro), CASE WHEN c.cd_autorizacao='Não Informada' THEN  null  ELSE c.cd_autorizacao END ),1,255), 
	i.cd_cgc 
 
union
 
select	'2.01.01' ds_versao, 
	'Não Informada' cd_autorizacao, 
	CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END  DS_CARATER_INTERNACAO, 
	'A' ds_tipo_saida, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END  ie_tipo_atendimento, 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3) ie_tipo_saida, 
	obter_tipo_protocolo(a.nr_seq_protocolo) ie_tipo_protocolo, 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40) cd_tipo_acomodacao, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5) ie_regime_internacao, 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3) ie_clinica, 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END  ds_tipo_faturamento, 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	null CD_AUTORIZACAO_TAG, 
	'5' ie_tiss_tipo_guia, 
	a.cd_convenio_parametro cd_convenio, 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255) cd_autorizacao_princ, 
	i.cd_cgc cd_cgc_prestador 
FROM estabelecimento i, atend_categoria_convenio h, procedimento_paciente e, conta_paciente a, procedimento_participante f
LEFT OUTER JOIN regra_honorario g ON (f.ie_responsavel_credito = g.cd_regra)
, atendimento_paciente b
LEFT OUTER JOIN motivo_alta d ON (b.cd_motivo_alta = d.cd_motivo_alta)
WHERE a.nr_atendimento	= b.nr_atendimento  and a.nr_interno_conta	= e.nr_interno_conta and coalesce(e.nr_doc_convenio, 'Não Informada') = 'Não Informada'  and b.nr_atendimento	= h.nr_atendimento and obter_atecaco_atendimento(b.nr_atendimento) = h.nr_seq_interno and e.nr_sequencia	= f.nr_sequencia and a.cd_estabelecimento			= i.cd_estabelecimento and TISS_OBTER_GUIA_PROC(b.ie_tipo_atendimento, 
				e.cd_procedimento, 
				e.ie_origem_proced, 
				g.ie_entra_conta, 
				g.ie_repassa_medico, 
				f.ie_tiss_tipo_guia) = '5' and coalesce(e.nr_seq_proc_pacote, e.nr_sequencia) = e.nr_sequencia and e.cd_motivo_exc_conta	is null 
group 	by CASE WHEN b.ie_carater_inter_sus='1' THEN 'E'  ELSE 'U' END , 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  '7' WHEN b.ie_tipo_atendimento=3 THEN  '4' WHEN b.ie_tipo_atendimento=7 THEN  '6' WHEN b.ie_tipo_atendimento=8 THEN '4' END , 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	a.nr_atendimento, 
	b.dt_entrada, 
	substr(TISS_OBTER_TIPO_SAIDA('I', a.nr_interno_conta),1,3), 
	obter_tipo_protocolo(a.nr_seq_protocolo), 
	substr(tiss_obter_tipo_acomod(h.cd_tipo_acomodacao),1,40), 
	substr(TISS_OBTER_CLINICA(b.ie_clinica, b.nr_seq_classificacao),1,3), 
	CASE WHEN b.dt_fim_conta IS NULL THEN  'P'  ELSE 'T' END , 
	a.DS_OBSERVACAO, 
	b.dt_alta, 
	a.ie_tipo_atend_tiss, 
	a.cd_convenio_parametro, 
	substr(tiss_obter_regime_atend(h.nr_atendimento, h.cd_convenio),1,5), 
	substr(TISS_OBTER_GUIA_PRINCIPAL(b.nr_atendimento, a.cd_convenio_parametro),1,255), 
	i.cd_cgc;

