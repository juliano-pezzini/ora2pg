-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pfcs_hah_filter_v (nm_patient, ds_mrn, ds_marital_status, ds_postal_code, ds_gender, ds_age, qt_age, nm_physician, ds_location, ds_problem, qt_trs, ie_show_trs_popover, ds_trs_color, ds_edi_contrb, ds_edi_vitals_warn, ds_dnr_status_color, ds_dnr_status, care_status, care_status_count, care_status_color, checklist, ds_admit, ds_readmission_risk, qt_readmission_risk, ie_frequent_flyer, ds_recurring_pat_adm_data, ds_recurring_pat_comorbitites, ds_recurring_pat_reason, ds_recurring_pat_contributors, ds_current_los, ds_remaining_los, vl_los_remaining, ds_special_request, nr_seq_operational_level, nr_seq_indicator, ie_classification) AS select pat.nm_patient NM_PATIENT,
    pat.id_patient DS_MRN,
	pfcs_pck_utils.get_marital_status(pat.id_patient) DS_MARITAL_STATUS,
	pfcs_pck_utils.get_postal_code(pat.id_patient) DS_POSTAL_CODE,
    substr(pat.ds_gender, 1, 1) DS_GENDER,
    pfcs_get_patient_age(pat.ds_age_range) DS_AGE,
	trunc(pat.ds_age_range/12) QT_AGE,
    pat.ds_physician NM_PHYSICIAN,
    bed.ds_location DS_LOCATION,
    pat.ds_symptoms DS_PROBLEM,
    pat.qt_edi_score QT_TRS,
    pfcs_get_indicator_rule(145, pat.qt_edi_score, pd.nr_seq_operational_level, 'SHOW_POPOVER') IE_SHOW_TRS_POPOVER,
    pfcs_get_indicator_rule(145,pat.qt_edi_score,pd.nr_seq_operational_level,'COLOR') DS_TRS_COLOR,
    pat.ds_edi_contrb DS_EDI_CONTRB,
    pat.ds_edi_vitals_warn DS_EDI_VITALS_WARN,
    substr(pat.ds_dnr_status, position('color' in pat.ds_dnr_status) + 5, 255) DS_DNR_STATUS_COLOR,
    substr(pat.ds_dnr_status, 1, position('color' in pat.ds_dnr_status) - 1)  DS_DNR_STATUS,
    substr(obter_desc_expressao(substr(pat.ds_care_status,1,6)),1,50) CARE_STATUS,
    substr(pat.ds_care_status, position(';' in pat.ds_care_status) + 1, 255) CARE_STATUS_COUNT,
    substr(substr(pat.ds_care_status, position('color' in pat.ds_care_status) + 5, 255), 1, position(';' in substr(pat.ds_care_status, position('color' in pat.ds_care_status) + 5, 255)) - 1) CARE_STATUS_COLOR,
    pat.ds_checklist CHECKLIST,
    date_as_varchar2(pat.dt_entrance, 'shortThreeLetterMonth') DS_ADMIT,
    pat.ds_readmission_risk DS_READMISSION_RISK,
	(replace(pat.ds_readmission_risk,'%',' '))::numeric  QT_READMISSION_RISK,
    pat.ie_freq_flyer IE_FREQUENT_FLYER,
    pat.ds_rec_pat_adm_data DS_RECURRING_PAT_ADM_DATA,
    pat.ds_rec_pat_comorbd DS_RECURRING_PAT_COMORBITITES,
    pat.ds_rec_pat_reasons DS_RECURRING_PAT_REASON,
    pat.ds_readm_risk_contrb DS_RECURRING_PAT_CONTRIBUTORS,
    get_time_by_minutes((LOCALTIMESTAMP - pat.dt_entrance) * 1440) DS_CURRENT_LOS,
    pfcs_pck_los.get_description(pat.vl_los_remaining) DS_REMAINING_LOS,
	pat.vl_los_remaining,
    pat.ds_special_request DS_SPECIAL_REQUEST,
	pd.nr_seq_operational_level,
	pd.nr_seq_indicator,
	bed.ie_classification
FROM pfcs_detail_patient pat,
    pfcs_detail_bed bed,
    pfcs_panel_detail pd
where pat.nr_seq_detail = pd.nr_sequencia
    and bed.nr_seq_detail = pd.nr_sequencia
    and pd.nr_seq_indicator = 100
    and bed.ie_classification in ('4', '3', 'SD')
    and pd.ie_situation = 'A'

union all

select pat.nm_patient NM_PATIENT,
    pat.id_patient DS_MRN,
	pfcs_pck_utils.get_marital_status(pat.id_patient) DS_MARITAL_STATUS,
	pfcs_pck_utils.get_postal_code(pat.id_patient) DS_POSTAL_CODE,
    substr(pat.ds_gender, 1, 1) DS_GENDER,
    pfcs_get_patient_age(pat.ds_age_range) DS_AGE,
	trunc(pat.ds_age_range/12) QT_AGE,
    pat.ds_physician NM_PHYSICIAN,
    bed.ds_location DS_LOCATION,
    pat.ds_symptoms DS_PROBLEM,
    pat.qt_edi_score QT_TRS,
    pfcs_get_indicator_rule(145, pat.qt_edi_score, pd.nr_seq_operational_level, 'SHOW_POPOVER') IE_SHOW_TRS_POPOVER,
    pfcs_get_indicator_rule(145,pat.qt_edi_score,pd.nr_seq_operational_level,'COLOR') DS_TRS_COLOR,
    pat.ds_edi_contrb DS_EDI_CONTRB,
    pat.ds_edi_vitals_warn DS_EDI_VITALS_WARN,
    substr(pat.ds_dnr_status, position('color' in pat.ds_dnr_status) + 5, 255) DS_DNR_STATUS_COLOR,
    substr(pat.ds_dnr_status, 1, position('color' in pat.ds_dnr_status) - 1)  DS_DNR_STATUS,
    substr(obter_desc_expressao(substr(pat.ds_care_status,1,6)),1,50) CARE_STATUS,
    substr(pat.ds_care_status, position(';' in pat.ds_care_status) + 1, 255) CARE_STATUS_COUNT,
    substr(substr(pat.ds_care_status, position('color' in pat.ds_care_status) + 5, 255), 1, position(';' in substr(pat.ds_care_status, position('color' in pat.ds_care_status) + 5, 255)) - 1) CARE_STATUS_COLOR, 
    pat.ds_checklist CHECKLIST,
    date_as_varchar2(pat.dt_entrance, 'shortThreeLetterMonth') DS_ADMIT,
    pat.ds_readmission_risk DS_READMISSION_RISK,
	(replace(pat.ds_readmission_risk,'%',' '))::numeric  QT_READMISSION_RISK,
    pat.ie_freq_flyer IE_FREQUENT_FLYER,
    pat.ds_rec_pat_adm_data DS_RECURRING_PAT_ADM_DATA,
    pat.ds_rec_pat_comorbd DS_RECURRING_PAT_COMORBITITES,
    pat.ds_rec_pat_reasons DS_RECURRING_PAT_REASON,
    pat.ds_readm_risk_contrb DS_RECURRING_PAT_CONTRIBUTORS,
    get_time_by_minutes((LOCALTIMESTAMP - pat.dt_entrance) * 1440) DS_CURRENT_LOS,
    pfcs_pck_los.get_description(pat.vl_los_remaining) DS_REMAINING_LOS,
	pat.vl_los_remaining,
    pat.ds_special_request DS_SPECIAL_REQUEST,
	pd.nr_seq_operational_level,
	pd.nr_seq_indicator,
	'ED' ie_classification
from pfcs_detail_patient pat,
    pfcs_detail_bed bed,
    pfcs_panel_detail pd
where pat.nr_seq_detail = pd.nr_sequencia
    and bed.nr_seq_detail = pd.nr_sequencia
    and pd.nr_seq_indicator = 306
    and pd.ie_situation = 'A';

