-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rmv_antibiotico (codcoligada, prontuario, paciente, codclinica, codespecialidade, crm, datadispensacao, nomeantibiotico, via, concentracao, quantidade, dosetotal, indicacao, profilaxia, infeccao, outrasinformacoes, numpedidoantibiotico, numitempedidoantibiotico) AS select	distinct '1' codcoligada,
	substr(a.nr_prontuario,1,9) prontuario, 
	substr(a.nm_pessoa_fisica,1,50) paciente, 
	substr(b.cd_setor_atendimento,1,50) codclinica, 
	substr(obter_especialidade_pf(b.cd_medico),1,50) codespecialidade, 
	substr(obter_crm_medico(b.cd_medico),1,50) crm, 
	to_date(to_char(c.dt_baixa,'dd/mm/yyyy')) datadispensacao, 
	substr(obter_desc_material(c.cd_material),1,50) nomeantibiotico, 
	CASE WHEN c.ie_via_aplicacao='Ent' THEN 'O' WHEN c.ie_via_aplicacao='In' THEN 'O' WHEN c.ie_via_aplicacao='IA' THEN 'P' WHEN c.ie_via_aplicacao='ID' THEN 'P' WHEN c.ie_via_aplicacao='IM' THEN 'P' WHEN c.ie_via_aplicacao='IP' THEN 'P' WHEN c.ie_via_aplicacao='IT' THEN 'P' WHEN c.ie_via_aplicacao='ITR' THEN 'O' WHEN c.ie_via_aplicacao='IVag' THEN 'T' WHEN c.ie_via_aplicacao='IV' THEN 'P' WHEN c.ie_via_aplicacao='MC' THEN 'O' WHEN c.ie_via_aplicacao='Nas' THEN 'O' WHEN c.ie_via_aplicacao='Oft' THEN 'T' WHEN c.ie_via_aplicacao='VO' THEN 'O' WHEN c.ie_via_aplicacao='Oto' THEN 'T' WHEN c.ie_via_aplicacao='Per' THEN 'P' WHEN c.ie_via_aplicacao='Ret' THEN 'T' WHEN c.ie_via_aplicacao='SNE' THEN 'O' WHEN c.ie_via_aplicacao='SNG' THEN 'O' WHEN c.ie_via_aplicacao='SC' THEN 'P' WHEN c.ie_via_aplicacao='SL' THEN 'O' WHEN c.ie_via_aplicacao='UT' THEN 'T' WHEN c.ie_via_aplicacao='Vag' THEN 'T' END  via, 
	(select qt_conversao_mg FROM material where cd_material = c.cd_material) concentracao, 
	c.qt_total_dispensar quantidade, 
	c.qt_dose dosetotal, 
	CASE WHEN c.ie_objetivo='T' THEN 'T' WHEN c.ie_objetivo='P' THEN 'P' WHEN c.ie_objetivo='C' THEN 'P'  ELSE 'S' END  indicacao, 
	(select CASE WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='LIMPA' THEN 'L' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='POTENCIALMENTE CONTAMINADA' THEN  'P' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='POT. CONTAMINADA' THEN 'P' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='CONTAMINADA' THEN 'C' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='INFECTADA' THEN 'I' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='INDICACAO CLINICA' THEN 'D' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='INDICAÇÃO CLINICA' THEN 'D' WHEN(upper(substr(rtrim(OBTER_DESC_TIPO_CIRURGIA(x.cd_tipo_cirurgia),' '),1,100)))='INDICAÇÃO CLÍNICA' THEN 'D'  ELSE '' END  
	 FROM b
LEFT OUTER JOIN cirurgia x ON (b.nr_prescricao = x.nr_prescricao)
WHERE x.cd_pessoa_fisica = e.cd_pessoa_fisica and x.nr_atendimento = e.nr_atendimento  and x.nr_cirurgia = (select max(nr_cirurgia) 
	 			 FROM cirurgia, b 
WHERE cd_pessoa_fisica = e.cd_pessoa_fisica  and nr_atendimento = e.nr_atendimento ) 
	 ) profilaxia, 
	'' infeccao, 
	substr(c.ds_justificativa,1,255) outrasinformacoes, 
	substr(b.nr_prescricao,1,50) numpedidoantibiotico, 
	substr(b.nr_prescricao||c.nr_sequencia,1,50) numitempedidoantibiotico 
from 	pessoa_fisica a, 
	prescr_medica b, 
	prescr_material c, 
	atendimento_paciente e, 
	material f 
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
and	b.nr_prescricao = c.nr_prescricao 
and 	e.nr_atendimento = b.nr_atendimento 
and	e.ie_tipo_atendimento = 1 
and	c.cd_material = f.cd_material 
and	c.dt_baixa is not null 
and	c.ie_objetivo is not null 
and	coalesce(f.ie_controle_medico,0) <> 0;

