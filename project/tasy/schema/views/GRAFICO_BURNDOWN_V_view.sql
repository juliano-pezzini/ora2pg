-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW grafico_burndown_v (nr_seq_proj, dt_ref, qt_hr_previstas, qt_hr_residuais) AS SELECT r.nr_seq_proj,
		r.dt_ref
	  ,(r.qt_hr_prev_acu - r.qt_horas_prev) qt_hr_previstas
	  ,CASE
		WHEN(r.qt_hr_cron = r.qt_hr_real_acu)
		  AND (r.qt_horas_real = 0)
		  AND r.dt_ref < TRUNC(LOCALTIMESTAMP)
		  THEN r.qt_hr_cron
		WHEN(r.qt_hr_cron = r.qt_hr_real_acu)
		  AND (r.qt_horas_real > 0)
		  AND r.dt_ref < TRUNC(LOCALTIMESTAMP)
		  THEN r.qt_hr_real_acu - r.qt_horas_real
		WHEN(r.qt_hr_cron <> r.qt_hr_real_acu)
		  AND (r.qt_horas_real = 0)
		  AND r.dt_ref < TRUNC(LOCALTIMESTAMP)
		  THEN r.qt_hr_real_acu - r.qt_horas_real
		WHEN(r.qt_hr_cron <> r.qt_hr_real_acu)
		  AND (r.qt_horas_real > 0)
		  AND r.dt_ref < TRUNC(LOCALTIMESTAMP)
		  THEN r.qt_hr_real_acu - r.qt_horas_real
		ELSE 0
		END qt_hr_residuais
	FROM (
	  SELECT t.*
		,coalesce((
			SELECT (MAX(c1.qt_total_horas) - SUM(e1.qt_hora_prev)) qt_hr_prev_acu
			FROM proj_projeto p1
			  ,proj_cronograma c1
			  ,proj_cron_etapa e1
			WHERE p1.nr_sequencia = c1.nr_seq_proj
			  AND c1.nr_sequencia = e1.nr_seq_cronograma
			  AND c1.ie_situacao = 'A'
			  AND p1.nr_sequencia = t.nr_seq_proj
			  AND e1.ie_fase = 'N'
			  AND c1.ie_classificacao = 'D'
			  AND c1.IE_TIPO_CRONOGRAMA = 'E'
			  AND  NOT EXISTS (SELECT 1 FROM proj_cron_etapa xx WHERE xx.nr_seq_superior =  e1.nr_sequencia)
			  AND e1.dt_fim_prev < t.dt_ref
			GROUP BY c1.nr_seq_proj
			), t.qt_hr_cron) qt_hr_prev_acu
		,coalesce((
			SELECT (MAX(c1.qt_total_horas) - SUM(e1.qt_hora_prev)) qt_hr_real_acu
			FROM proj_projeto p1
			  ,proj_cronograma c1
			  ,proj_cron_etapa e1
			WHERE p1.nr_sequencia = c1.nr_seq_proj
			  AND c1.nr_sequencia = e1.nr_seq_cronograma
			  AND c1.ie_situacao = 'A'
			  AND p1.nr_sequencia = t.nr_seq_proj
			  AND e1.ie_fase = 'N'
			  AND c1.ie_classificacao = 'D'
			  AND  NOT EXISTS (SELECT 1 FROM proj_cron_etapa xx WHERE xx.nr_seq_superior =  e1.nr_sequencia)
			  AND c1.IE_TIPO_CRONOGRAMA = 'E'
			  AND e1.dt_fim_real < t.dt_ref
			GROUP BY c1.nr_seq_proj
			), t.qt_hr_cron) qt_hr_real_acu
	  FROM (
		SELECT q.nr_seq_proj
		  ,q.dt_ref
		  ,SUM(q.qt_horas_prev) qt_horas_prev
		  ,SUM(q.qt_horas_real) qt_horas_real
		  ,q.qt_hr_cron
		FROM (
		  SELECT c.nr_seq_proj
			,coalesce(TRUNC(e.dt_fim_prev), LOCALTIMESTAMP) dt_ref
			,SUM(e.qt_hora_prev) qt_horas_prev
			,SUM(0) qt_horas_real
			,MAX(c.qt_total_horas) qt_hr_cron
		  FROM proj_projeto p
			,proj_cronograma c
			,proj_cron_etapa e
		  WHERE p.nr_sequencia = c.nr_seq_proj
			AND c.nr_sequencia = e.nr_seq_cronograma
			AND c.ie_situacao = 'A'
			AND c.ie_classificacao = 'D'
			AND c.IE_TIPO_CRONOGRAMA = 'E'
			AND  NOT EXISTS (SELECT 1 FROM proj_cron_etapa xx WHERE xx.nr_seq_superior =  e.nr_sequencia)
			AND e.ie_fase = 'N'
		  GROUP BY c.nr_seq_proj
			,TRUNC(e.dt_fim_prev)
		
UNION ALL

		  SELECT c.nr_seq_proj
			,coalesce(TRUNC(e.dt_fim_real), LOCALTIMESTAMP) dt_ref
			,SUM(0) qt_horas_prev
			,SUM(e.qt_hora_prev) qt_horas_real
			,MAX(c.qt_total_horas) qt_hr_cron
		  FROM proj_projeto p
			,proj_cronograma c
			,proj_cron_etapa e
		  WHERE p.nr_sequencia = c.nr_seq_proj
			AND c.nr_sequencia = e.nr_seq_cronograma
			AND c.ie_situacao = 'A'
			AND c.ie_classificacao = 'D'
			AND  NOT EXISTS (SELECT 1 FROM proj_cron_etapa xx WHERE xx.nr_seq_superior =  e.nr_sequencia)
			AND c.IE_TIPO_CRONOGRAMA = 'E'
			AND e.ie_fase = 'N'
			AND e.dt_fim_real IS NOT NULL
		  GROUP BY c.nr_seq_proj
			,TRUNC(e.dt_fim_real)
		  ) q
		GROUP BY q.nr_seq_proj
		  ,q.dt_ref
		  ,q.qt_hr_cron
		ORDER BY 2
		) t
	  ) r;

