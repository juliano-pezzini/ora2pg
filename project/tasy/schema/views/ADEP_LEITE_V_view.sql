-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW adep_leite_v (nr_seq_apresent, ie_tipo_consulta, ie_tipo_item, ds_tipo_item, ds_tipo_item_plural, ie_laboratorio, cd_estabelecimento, nr_atendimento, nr_prescricao, cd_prescritor, nm_prescritor, ds_horarios_adm, ds_prescricao, dt_prescricao, dt_inicio_prescr, dt_validade_prescr, dt_lib_horario, dt_liberacao, cd_setor_prescr, ie_setor_processo_gedipa, nr_seq_item, ie_acm_sn, ie_di, cd_item, ie_origem_proced, nr_seq_proc_interno, ds_item, nr_agrupamento, cd_intervalo, ds_diluente, ds_topografia, ie_assoc_adep, nr_seq_area_prep, nr_seq_lote, nr_seq_processo, nr_seq_horario, dt_horario, dt_susp, dt_adm, qt_adm, qt_susp, qt_pend, cd_um, qt_dose, cd_unidade_medida_dose, ie_via, nr_seq_evento, ie_evento, dt_evento, cd_pessoa_evento, nm_pessoa_evento, ds_evento, ie_urgencia, cd_local_estoque, nr_seq_superior, ie_item_superior, ds_horarios, nm_usuario_adm, ds_observacao_sae, ds_obs_prescr, ds_justificativa, nr_sequencia_proc, cd_local_estoque_mat, cd_local_estoque_aux, cd_setor_aux, ie_conferencia, ie_higienizacao, ie_preparo, ds_observacao, ie_medicacao_paciente, qt_total_dispensar, cd_unidade_disp, ie_dose_especial, nr_seq_cpoe) AS select 16 nr_seq_apresent,
		'P' ie_tipo_consulta,
		'LD' ie_tipo_item,
		/*'Leites e Derivados'*/
 obter_desc_expressao(341829) ds_tipo_item,
		/*'Leites e Derivados'*/
 obter_desc_expressao(341829) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		substr(Adep_obter_horarios_adm(a.nr_prescricao,c.nr_seq_material,'S'),1,100) ds_horarios_adm,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,b.ie_acm,b.ie_se_necessario),1,100) ds_prescricao,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		c.dt_lib_horario,
		a.dt_liberacao,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.dt_suspensao dt_susp,
		c.dt_fim_horario dt_adm,
		null qt_adm,
		null qt_susp,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		null nr_seq_evento,
		null ie_evento,
		null dt_evento,
		null cd_pessoa_evento,
		null nm_pessoa_evento,
		null ds_evento,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_horarios ds_horarios,
		c.nm_usuario_adm,
		null ds_observacao_sae,
		null ds_obs_prescr,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		'N' ie_medicacao_paciente,
		b.qt_total_dispensar,
		b.cd_unidade_medida cd_unidade_disp,
		'N' ie_dose_especial,
		b.nr_seq_mat_cpoe nr_seq_cpoe
FROM	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
AND	b.ie_agrupador IN (16,17)
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union all

--Administrados
select	16 nr_seq_apresent,
	'A' ie_tipo_consulta,
	'LD' ie_tipo_item,
	'Leites e Derivados' ds_tipo_item,
	'Leites e Derivados' ds_tipo_item_plural,
	'N' ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	substr(p.nm_pessoa_fisica,1,60) nm_prescritor,
	substr(Adep_obter_horarios_adm(a.nr_prescricao,c.nr_seq_material,'S'),1,100) ds_horarios_adm,
	substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,b.ie_acm,b.ie_se_necessario),1,100) ds_prescricao,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	c.dt_lib_horario,
	a.dt_liberacao,
	a.cd_setor_atendimento cd_setor_prescr,
	substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
	b.nr_sequencia nr_seq_item,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	coalesce(b.ie_bomba_infusao,'N') ie_di,
	to_char(b.cd_material) cd_item,
	(null)::numeric  ie_origem_proced,
	(null)::numeric  nr_seq_proc_interno,
	substr(x.ds_material,1,240) ds_item,
	b.nr_agrupamento nr_agrupamento,
	b.cd_intervalo cd_intervalo,
	substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
	null ds_topografia,
	'N' ie_assoc_adep,
	(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
	c.nr_seq_lote nr_seq_lote,
	c.nr_seq_processo nr_seq_processo,
	c.nr_sequencia nr_seq_horario,
	c.dt_horario,
	c.dt_suspensao dt_susp,
	c.dt_fim_horario dt_adm,
	c.qt_dispensar_hor qt_adm,
	null qt_susp,
	c.qt_dispensar_hor qt_pend,
	c.cd_unidade_medida cd_um,
	coalesce(b.qt_dose,d.qt_dose_adm) qt_dose,
	c.cd_unidade_medida_dose,
	b.ie_via_aplicacao ie_via,
	d.nr_sequencia nr_seq_evento,
	d.ie_alteracao ie_evento,
	d.dt_alteracao dt_evento,
	d.cd_pessoa_fisica cd_pessoa_evento,
	substr(obter_nome_pf(d.cd_pessoa_fisica),1,60) nm_pessoa_evento,
	coalesce(coalesce(d.ds_observacao,d.ds_justificativa),b.ds_observacao) ds_evento,
	b.ie_urgencia,
	obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
	c.nr_seq_superior,
	b.ie_item_superior,
	b.ds_horarios ds_horarios,
	c.nm_usuario_adm,
	null ds_observacao_sae,
	null ds_obs_prescr,
	d.ds_justificativa,
	null nr_sequencia_proc,
	b.cd_local_estoque cd_local_estoque_mat,
	obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
	Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
	coalesce(b.ie_conferencia,'S') ie_conferencia,
	coalesce(b.ie_higienizacao,'S') ie_higienizacao,
	coalesce(b.ie_preparo,'S') ie_preparo,
	substr(b.ds_observacao,1,4000) ds_observacao,
	b.ie_medicacao_paciente,
	b.qt_total_dispensar,
	b.cd_unidade_medida cd_unidade_disp,
	'N' ie_dose_especial,
    b.nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
	material x,
	prescr_mat_alteracao d,
	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	d.nr_seq_horario = c.nr_sequencia
and	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material = x.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is not null
AND c.DT_SUSPENSAO IS NULL
and	coalesce(c.ie_situacao,'A') = 'A'
and	b.ie_agrupador IN (16,17)
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union all

--Suspensos
select	16 nr_seq_apresent,
	'S' ie_tipo_consulta,
	'LD' ie_tipo_item,
	'Leites e Derivados' ds_tipo_item,
	'Leites e Derivados' ds_tipo_item_plural,
	'N' ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	substr(obter_nome_pf(a.cd_prescritor),1,60) nm_prescritor,
	substr(Adep_obter_horarios_adm(a.nr_prescricao,c.nr_seq_material,'S'),1,100) ds_horarios_adm,
	substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,b.ie_acm,b.ie_se_necessario),1,100) ds_prescricao,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	c.dt_lib_horario,
	a.dt_liberacao,
	a.cd_setor_atendimento cd_setor_prescr,
	substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
	b.nr_sequencia nr_seq_item,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	coalesce(b.ie_bomba_infusao,'N') ie_di,
	to_char(b.cd_material) cd_item,
	(null)::numeric  ie_origem_proced,
	(null)::numeric  nr_seq_proc_interno,
	substr(obter_desc_material(b.cd_material),1,240) ds_item,
	b.nr_agrupamento nr_agrupamento,
	b.cd_intervalo cd_intervalo,
	substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
	null ds_topografia,
	'N' ie_assoc_adep,
	(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
	c.nr_seq_lote nr_seq_lote,
	c.nr_seq_processo nr_seq_processo,
	c.nr_sequencia nr_seq_horario,
	c.dt_horario,
	c.dt_suspensao dt_susp,
	c.dt_fim_horario dt_adm,
	null qt_adm,
	c.qt_dispensar_hor qt_susp,
	c.qt_dispensar_hor qt_pend,
	c.cd_unidade_medida cd_um,
	c.qt_dose,
	c.cd_unidade_medida_dose,
	b.ie_via_aplicacao ie_via,
	d.nr_sequencia nr_seq_evento,
	d.ie_alteracao ie_evento,
	d.dt_alteracao dt_evento,
	d.cd_pessoa_fisica cd_pessoa_evento,
	substr(obter_nome_pf(d.cd_pessoa_fisica),1,60) nm_pessoa_evento,
	coalesce(d.ds_observacao,d.ds_justificativa) ds_evento,
	b.ie_urgencia,
	obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
	c.nr_seq_superior,
	b.ie_item_superior,
	b.ds_horarios ds_horarios,
	c.nm_usuario_adm,
	null ds_observacao_sae,
	null ds_obs_prescr,
	d.ds_justificativa,
	null nr_sequencia_proc,
	b.cd_local_estoque cd_local_estoque_mat,
	obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
	Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
	coalesce(b.ie_conferencia,'S') ie_conferencia,
	coalesce(b.ie_higienizacao,'S') ie_higienizacao,
	coalesce(b.ie_preparo,'S') ie_preparo,
	substr(b.ds_observacao,1,4000) ds_observacao,
	b.ie_medicacao_paciente,
	b.qt_total_dispensar,
	b.cd_unidade_medida cd_unidade_disp,
	'N' ie_dose_especial,
    b.nr_seq_mat_cpoe nr_seq_cpoe
from	prescr_mat_alteracao d,
	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	d.nr_seq_horario = c.nr_sequencia
and	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	c.dt_suspensao is not null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	b.ie_agrupador in (16, 17)
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S';

