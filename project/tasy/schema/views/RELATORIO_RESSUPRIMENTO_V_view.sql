-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW relatorio_ressuprimento_v (cd_material, cd_mat, cd_material_generico, qt_estoque, qt_ordem_compra, qt_solic_compra, qt_cotacao_compra, dt_atualizacao, nm_usuario, dt_entrega_ordem, vl_excedente, nr_ordem_compra, qt_cons_prev_mes, cd_estabelecimento, cd_estab, dt_entrega_ordem_item, qt_compra_alterada, qt_compra, cd_grupo_material, cd_subgrupo_material, ds_grupo_material, ds_subgrupo_material, ds_material_ressup, ds_material_comercial, ds_comercial_estoque, ds_material, cd_unidade_medida_estoque, qt_dia_interv_ressup, qt_dia_ressup_forn, qt_dia_estoque_minimo, qt_estoque_minimo, qt_estoque_maximo, qt_consumo_mensal, qt_ponto_pedido, ie_curva_abc, ie_curva_abc_grupo, cd_material_comercial, cd_comercial_estoque, ie_cons_prev_mes, ie_padronizado, ie_controlado, ie_temperatura, qt_desvio_padrao, ds_observacao, ie_consignado, ie_situacao, vl_custo_medio, qt_consumo, qt_cons_mat, qt_consumo6, qt_consumo5, qt_consumo4, qt_consumo3, qt_consumo2, qt_consumo1, qt_consumo_mes, qt_media6, qt_media3, qt_pendente, qt_dia_estoque, ds_curva) AS select	a.cd_material,
	a.cd_material cd_mat,
	a.cd_material_generico,
	a.qt_estoque,
	a.qt_ordem_compra,
	a.qt_solic_compra,
	a.qt_cotacao_compra,
	a.dt_atualizacao,
	a.nm_usuario,
	a.dt_entrega_ordem,
	a.vl_excedente,
	a.nr_ordem_compra,
	a.qt_cons_prev_mes,
	a.cd_estabelecimento,
	a.cd_estabelecimento cd_estab,
	a.dt_entrega_ordem_item,
	a.qt_compra_alterada,
	a.qt_compra,
	b.cd_grupo_material,
	a.cd_subgrupo_material,
	a.ds_grupo_material,
	a.ds_subgrupo_material,
	a.ds_material_ressup,
	a.ds_material_comercial,
	a.ds_comercial_estoque,
	a.ds_material,
	a.cd_unidade_medida_estoque,
	a.qt_dia_interv_ressup,
	a.qt_dia_ressup_forn,
	a.qt_dia_estoque_minimo,
	a.qt_estoque_minimo,
	a.qt_estoque_maximo,
	a.qt_consumo_mensal,
	a.qt_ponto_pedido,
	a.ie_curva_abc,
	a.ie_curva_abc_grupo,
	a.cd_material_comercial,
	a.cd_comercial_estoque,
	a.ie_cons_prev_mes,
	a.ie_padronizado,
	a.ie_controlado,
	a.ie_temperatura,
	a.qt_desvio_padrao,
	a.ds_observacao,
	a.ie_consignado,
	c.ie_situacao,
	obter_custo_medio_material(a.cd_estabelecimento, trunc(LOCALTIMESTAMP,'mm'), a.cd_material) vl_custo_medio,
	obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material, null) qt_consumo,
	obter_mat_estabelecimento(a.cd_estabelecimento, a.cd_estabelecimento, a.cd_material, 'CM') qt_cons_mat,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-6)),0) qt_consumo6,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-5)),0) qt_consumo5,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-4)),0) qt_consumo4,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-3)),0) qt_consumo3,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-2)),0) qt_consumo2,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-1)),0) qt_consumo1,
	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,trunc(LOCALTIMESTAMP,'mm')),0) qt_consumo_mes,
	dividir((	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-6)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-5)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-4)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-3)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-2)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-1)),0)),6) qt_media6,
	dividir((	coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-3)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-2)),0) +
		coalesce(obter_consumo_mensal_material('Q', a.cd_estabelecimento, a.cd_material,add_months(trunc(LOCALTIMESTAMP,'mm'),-1)),0)),3) qt_media3,
	(a.qt_ordem_compra + a.qt_solic_compra + a.qt_cotacao_compra) qt_pendente,
	dividir(a.qt_estoque, dividir(a.qt_consumo_mensal, 30)) qt_dia_estoque,
	CASE WHEN a.ie_curva_abc='X' THEN ''  ELSE a.ie_curva_abc END  || ' - ' || substr(obter_curva_xyz(a.cd_estabelecimento,a.cd_material),1,1) ds_curva
FROM	material c,
	estrutura_material_v b,
	material_Ressuprimento_v a
where	a.cd_material = b.cd_material
and	a.cd_material = c.cd_material;

