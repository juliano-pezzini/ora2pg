-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_cartao_unimed_sjrp_v (tp_registro, nr_seq_lote, cd_usuario, nm_usuario, dt_nascimento, dt_val_carteira, cd_plano, ds_produto, ds_acomodacao, nr_tarja, dt_geracao, nr_via, ie_nova_regulamentacao, dt_contrato, tp_contrato, ds_registro_ans, msg_cadastro, msg_area, dt_pre_existencia, msg_contrato, cobertura_consulta, cobertura_exame, cobertura_proc_especial, cobertura_cirurgica, cobertura_obs, ds_nova_legislacao, cd_contratacao, cd_area_cobranca, cd_natureza, cod_empresa, cd_rede, ie_abrange, ds_desc_abrang, cd_rede_atend, byte, nr_seq_segurado) AS select	1		tp_registro,
	nr_sequencia	nr_seq_lote, 
	' '		cd_usuario, 
	' '		nm_usuario, 
	null		dt_nascimento, 
	null		dt_val_carteira, 
	' '		cd_plano, 
	' '		ds_produto, 
	' '		ds_acomodacao, 
	' '		nr_tarja, 
	null		dt_geracao, 
	null		nr_via, 
	' '		ie_nova_regulamentacao, 
	null		dt_contrato, 
	' '		tp_contrato, 
	' '		ds_registro_ans, 
	' '		msg_cadastro, 
	' '		msg_area, 
	' '		dt_pre_existencia, 
	' '		msg_contrato, 
	' '		cobertura_consulta, 
	' '		cobertura_exame, 
	' '		cobertura_proc_especial, 
	' '		cobertura_cirurgica, 
	' '		cobertura_obs, 
	' '		ds_nova_legislacao, 
	null		cd_contratacao, 
	' '		cd_area_cobranca, 
	' '		cd_natureza, 
	' '		cod_empresa, 
	' '		cd_rede, 
	' '		ie_abrange, 
	' '		ds_desc_abrang, 
	' '		cd_rede_atend, 
	' '		byte, 
	null		nr_seq_segurado 
FROM	pls_lote_carteira	 

union
 
select	2		tp_registro, 
	c.nr_sequencia	nr_seq_lote, 
	substr(b.cd_usuario_plano,1,1) ||' ' || substr(b.cd_usuario_plano,2,3) ||' '|| substr(b.cd_usuario_plano,5,12) || ' '|| substr(b.cd_usuario_plano,17,1) cd_usuario, 
	Elimina_Acentuacao(substr(pls_gerar_nome_abreviado(h.nm_pessoa_fisica),1,25)) nm_usuario, 
	h.dt_nascimento, 
	b.dt_validade_carteira, 
	e.cd_codigo_ant, 
	Elimina_Acentuacao(e.ds_plano), 
	Elimina_Acentuacao(substr(pls_obter_dados_cart_unimed(a.nr_sequencia,a.nr_seq_plano,'DASJ',0),1,13)) ds_acomodacao, 
	Elimina_Acentuacao(replace(replace(ds_trilha2,';',''),'?',''))	nr_tarja, 
	b.dt_solicitacao dt_geracao, 
	adiciona_zeros_esquerda(b.nr_via_solicitacao,2) nr_via, 
	CASE WHEN e.ie_regulamentacao='P' THEN 'SIM'  ELSE 'NAO' END  ie_nova_regulamentacao, 
	d.dt_contrato, 
	CASE WHEN e.ie_tipo_contratacao='I' THEN 'Particular'  ELSE 'Empresa' END  tp_contrato, 
	elimina_caracteres_especiais(e.nr_protocolo_ans) ds_registro_ans, 
	Elimina_Acentuacao(substr((	select	max(ds_mensagem) 
		from	pls_plano_mensagem_cart x 
		where	x.nr_seq_plano	= e.nr_sequencia 
		and	LOCALTIMESTAMP between coalesce(dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(dt_fim_vigencia,LOCALTIMESTAMP) 
		and	ie_situacao	= 'A'),1,216)) msg_cadastro, 
	coalesce((	select	max(ds_mensagem) 
		from	pls_contrato_mensagem_cart x 
		where	x.nr_seq_contrato	= d.nr_sequencia 
		and	LOCALTIMESTAMP between coalesce(dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(dt_fim_vigencia,LOCALTIMESTAMP) 
		and	ie_situacao	= 'A'),'Atendimento restrito a area de acao da Unimed Sao Jose do Rio Preto-SP. Outras localidades somente em caso de urgencia') msg_area, 
	pls_obter_cpt_usjrp(a.nr_sequencia) dt_pre_existencia, 
	Elimina_Acentuacao(substr(obter_valor_dominio(1667,e.ie_abrangencia),1,60))	msg_contrato, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',1),'              ;     '))	cobertura_consulta, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',2),'              ;     '))	cobertura_exame, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',3),'              ;     '))	cobertura_proc_especial, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',4),'              ;     '))	cobertura_cirurgica, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',5),'              ;     '))	cobertura_obs, 
	CASE WHEN e.ie_regulamentacao='P' THEN 'Produto Regulamentado'  ELSE 'Produto nao Regulamentado' END  ds_nova_legislacao, 
	a.cd_operadora_empresa cd_contratacao, 
	lpad(substr(pls_obter_area_cobranca(a.nr_sequencia,e.cd_estabelecimento),1,4),4,'0') cd_area_cobranca, 
	CASE WHEN e.ie_tipo_contratacao='I' THEN '2-Fisica' WHEN e.ie_tipo_contratacao='CA' THEN '4-Adesao' WHEN e.ie_tipo_contratacao='CE' THEN '3-Empresarial' END  cd_natureza, 
	'' cod_empresa, 
	'' cd_rede, 
	CASE WHEN e.ie_abrangencia='GM' THEN 'Abrangencia'  ELSE '' END  ie_abrange, 
	upper(Elimina_Acentuacao(CASE WHEN e.ie_abrangencia='GM' THEN substr(pls_obter_dados_cart_unimed(a.nr_sequencia,a.nr_seq_plano,'DR',1),1,610) END )) ds_desc_abrang, 
	lpad(substr(pls_obter_rede_atendimento(a.nr_sequencia,a.nr_seq_plano),1,4),4,'0') cd_rede_atend, 
	' '		byte, 
	a.nr_sequencia	nr_seq_segurado 
FROM pessoa_fisica h, pls_plano e, pls_contrato d, pls_segurado a, pls_carteira_emissao f
LEFT OUTER JOIN pls_lote_carteira c ON (f.nr_seq_lote = c.nr_sequencia)
, pls_segurado_carteira b
LEFT OUTER JOIN pls_carteira_emissao f ON (b.nr_sequencia = f.nr_seq_seg_carteira)
WHERE a.nr_seq_plano		= e.nr_sequencia and a.nr_seq_contrato	= d.nr_sequencia and b.nr_seq_segurado	= a.nr_sequencia   and a.cd_pessoa_fisica	= h.cd_pessoa_fisica 
 
union all
 
select	2		tp_registro, 
	c.nr_sequencia	nr_seq_lote, 
	substr(b.cd_usuario_plano,1,1) ||' ' || substr(b.cd_usuario_plano,2,3) ||' '|| substr(b.cd_usuario_plano,5,12) || ' '|| substr(b.cd_usuario_plano,17,1) cd_usuario, 
	Elimina_Acentuacao(substr(pls_gerar_nome_abreviado(h.nm_pessoa_fisica),1,25)) nm_usuario, 
	h.dt_nascimento, 
	b.dt_validade_carteira, 
	e.cd_codigo_ant, 
	Elimina_Acentuacao(e.ds_plano), 
	Elimina_Acentuacao(substr(pls_obter_dados_cart_unimed(a.nr_sequencia,a.nr_seq_plano,'DASJ',0),1,13)) ds_acomodacao, 
	Elimina_Acentuacao(replace(replace(ds_trilha2,';',''),'?',''))	nr_tarja, 
	b.dt_solicitacao dt_geracao, 
	adiciona_zeros_esquerda(b.nr_via_solicitacao,2) nr_via, 
	CASE WHEN e.ie_regulamentacao='P' THEN 'SIM'  ELSE 'NAO' END  ie_nova_regulamentacao, 
	d.dt_inclusao, 
	CASE WHEN e.ie_tipo_contratacao='I' THEN 'Particular'  ELSE 'Empresa' END  tp_contrato, 
	elimina_caracteres_especiais(e.nr_protocolo_ans) ds_registro_ans, 
	Elimina_Acentuacao(substr((	select	max(ds_mensagem) 
		from	pls_plano_mensagem_cart x 
		where	x.nr_seq_plano	= e.nr_sequencia 
		and	LOCALTIMESTAMP between coalesce(dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(dt_fim_vigencia,LOCALTIMESTAMP) 
		and	ie_situacao	= 'A'),1,216)) msg_cadastro, 
	coalesce((	select	max(ds_mensagem) 
		from	pls_contrato_mensagem_cart x 
		where	x.nr_seq_contrato	= d.nr_sequencia 
		and	LOCALTIMESTAMP between coalesce(dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(dt_fim_vigencia,LOCALTIMESTAMP) 
		and	ie_situacao	= 'A'),'Atendimento restrito a area de acao da Unimed Sao Jose do Rio Preto-SP. Outras localidades somente em caso de urgencia') msg_area, 
	pls_obter_cpt_usjrp(a.nr_sequencia) dt_pre_existencia, 
	Elimina_Acentuacao(substr(obter_valor_dominio(1667,e.ie_abrangencia),1,60))	msg_contrato, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',1),'              ;     '))	cobertura_consulta, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',2),'              ;     '))	cobertura_exame, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',3),'              ;     '))	cobertura_proc_especial, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',4),'              ;     '))	cobertura_cirurgica, 
	Elimina_Acentuacao(coalesce(pls_obter_dados_cart_unimed(a.nr_sequencia, e.nr_sequencia,'CAR',5),'              ;     '))	cobertura_obs, 
	CASE WHEN e.ie_regulamentacao='P' THEN 'Produto Regulamentado'  ELSE 'Produto nao Regulamentado' END  ds_nova_legislacao, 
	a.cd_operadora_empresa cd_contratacao, 
	lpad(substr(pls_obter_area_cobranca(a.nr_sequencia,e.cd_estabelecimento),1,4),4,'0') cd_area_cobranca, 
	CASE WHEN e.ie_tipo_contratacao='I' THEN '2-Fisica' WHEN e.ie_tipo_contratacao='CA' THEN '4-Adesao' WHEN e.ie_tipo_contratacao='CE' THEN '3-Empresarial' END  cd_natureza, 
	'' cod_empresa, 
	'' cd_rede, 
	CASE WHEN e.ie_abrangencia='GM' THEN 'Abrangencia'  ELSE '' END  ie_abrange, 
	upper(Elimina_Acentuacao(CASE WHEN e.ie_abrangencia='GM' THEN substr(pls_obter_dados_cart_unimed(a.nr_sequencia,a.nr_seq_plano,'DR',1),1,610) END )) ds_desc_abrang, 
	lpad(substr(pls_obter_rede_atendimento(a.nr_sequencia,a.nr_seq_plano),1,4),4,'0') cd_rede_atend, 
	' '		byte, 
	a.nr_sequencia	nr_seq_segurado 
FROM pessoa_fisica h, pls_plano e, pls_intercambio d, pls_segurado a, pls_carteira_emissao f
LEFT OUTER JOIN pls_lote_carteira c ON (f.nr_seq_lote = c.nr_sequencia)
, pls_segurado_carteira b
LEFT OUTER JOIN pls_carteira_emissao f ON (b.nr_sequencia = f.nr_seq_seg_carteira)
WHERE a.cd_pessoa_fisica	= h.cd_pessoa_fisica and b.nr_seq_segurado	= a.nr_sequencia and a.nr_seq_plano		= e.nr_sequencia and a.nr_seq_intercambio	= d.nr_sequencia;

