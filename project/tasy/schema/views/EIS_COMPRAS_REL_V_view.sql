-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_compras_rel_v (ie_grupo_material, vl_compra_ano, vl_compra_12m, vl_compra_ant, vl_compra_atual, vl_anual, vl_ultimos_12m, vl_mensal, vl_atual, pr_ano, pr_12meses, pr_mes_anterior, pr_mes_atual, ds_descricao, cd_grupo_material, cd_estabelecimento, cd_material) AS select
	'G' ie_grupo_material,
	sum(CASE WHEN trunc(e.dt_referencia, 'year')=trunc(b.dt_parametro,'year') THEN  vl_compra  ELSE 0 END ) vl_compra_ano,
	coalesce(sum(vl_compra),0) vl_compra_12m,
	sum(CASE WHEN trunc(e.dt_referencia, 'month')=add_months(b.dt_parametro,-1) THEN  vl_compra  ELSE 0 END ) vl_compra_ant,
	sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN  e.vl_compra  ELSE 0 END ) vl_compra_atual,
	sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) vl_anual,
	coalesce(sum(e.vl_custo_padrao - e.vl_compra),0) vl_ultimos_12m,
	sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro, -1) THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) vl_mensal,
	sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) vl_atual,
	CASE WHEN sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),		sum(CASE WHEN trunc(e.dt_referencia, 'year')=trunc(b.dt_parametro,'year') THEN  vl_compra  ELSE 0 END )) END   pr_ano,
	dividir(CASE WHEN sum(e.vl_custo_padrao - e.vl_compra)=0 THEN 0  ELSE sum(e.vl_custo_padrao - e.vl_compra) * 100 END , sum(vl_compra)) pr_12meses,
	CASE WHEN sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro, -1) THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro, -1) THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),		sum(CASE WHEN trunc(e.dt_referencia, 'month')=add_months(b.dt_parametro, -1) THEN  vl_compra  ELSE 0 END )) END  pr_mes_anterior,
	CASE WHEN sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),		sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN e.vl_compra  ELSE 0 END )) END   pr_mes_atual,
	substr(obter_desc_estrut_mat(e.cd_grupo_material,null,null, null),1,40) ds_descricao,
	e.cd_grupo_material,
	e.cd_estabelecimento,
	0 cd_material
FROM 	relatorio_param_exec b,
	eis_compras e
where	b.nr_sequencia	= obter_seq_param_exec(613, 'DT_REFERENCIA')
and	e.dt_referencia >= add_months(b.dt_parametro, -12)
and	ie_periodo	= 'M'
group  by
	substr(obter_desc_estrut_mat(e.cd_grupo_material,null,null, null),1,40),
	e.cd_grupo_material,
	e.cd_estabelecimento

union

select
	'M' ie_grupo_material,
	sum(CASE WHEN trunc(e.dt_referencia, 'year')=trunc(b.dt_parametro,'year') THEN  vl_compra  ELSE 0 END ) vl_compra_ano,
	coalesce(sum(vl_compra),0) vl_compra_12m,
	sum(CASE WHEN trunc(e.dt_referencia, 'month')=add_months(b.dt_parametro,-1) THEN  vl_compra  ELSE 0 END ) vl_compra_ant,
	sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN  e.vl_compra  ELSE 0 END ) vl_compra_atual,
	sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) vl_anual,
	coalesce(sum(e.vl_custo_padrao - e.vl_compra),0) vl_ultimos_12m,
	sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro, -1) THEN (e.vl_custo_padrao - e.vl_compra)   ELSE 0 END ) vl_mensal,
	sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) vl_atual,
	CASE WHEN sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN trunc(e.dt_referencia,'year')=trunc(b.dt_parametro,'year') THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),			sum(CASE WHEN trunc(e.dt_referencia, 'year')=trunc(b.dt_parametro,'year') THEN  vl_compra  ELSE 0 END )) END   pr_ano,
	dividir(CASE WHEN sum(e.vl_custo_padrao - e.vl_compra)=0 THEN 0  ELSE sum(e.vl_custo_padrao - e.vl_compra) * 100 END , sum(vl_compra)) pr_12meses,
	CASE WHEN sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro, -1) THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN trunc(e.dt_referencia,'month')=add_months(b.dt_parametro,-1) THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),			sum(CASE WHEN trunc(e.dt_referencia, 'month')=add_months(b.dt_parametro, -1) THEN  vl_compra  ELSE 0 END )) END  pr_mes_anterior,
	CASE WHEN sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END )=0 THEN 0  ELSE dividir((sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN (e.vl_custo_padrao - e.vl_compra)  ELSE 0 END ) * 100),			sum(CASE WHEN e.dt_referencia=b.dt_parametro THEN e.vl_compra  ELSE 0 END )) END   pr_mes_atual,
	substr(obter_desc_material(e.cd_material),1,40) ds_descricao,
	e.cd_grupo_material,
	e.cd_estabelecimento,
	e.cd_material
from	relatorio_param_exec b,
	eis_compras e
where	b.nr_sequencia	= obter_seq_param_exec(613,'DT_REFERENCIA')
and	e.dt_referencia >= add_months(b.dt_parametro, -12)
and	ie_periodo 	= 'M'
group  by
	obter_desc_material(e.cd_material),
	e.cd_grupo_material,
	e.cd_estabelecimento,
	e.cd_material;

