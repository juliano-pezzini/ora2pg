-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_escala_eca_fugulin_v (nr_atendimento, cd_setor_atendimento, ds_estabelecimento, cd_convenio, ds_convenio, ds_setor_atendimento, ie_sexo, ds_sexo, nm_medico, cd_pessoa_fisica, ie_faixa_etaria, ds_unidade, dt_avaliacao, cd_empresa, qt_pontuacao, cd_estabelecimento, ds_gradacao, ie_turno, cd_paciente, nm_paciente) AS select  	distinct a.nr_atendimento,
  	coalesce(cd_setor_paciente,obter_setor_atend_data(a.nr_atendimento, g.dt_avaliacao)) cd_setor_atendimento, 
  	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento, 
  	obter_convenio_atendimento(a.nr_atendimento) cd_convenio, 
  	substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,150) 
  	ds_convenio, 
  	obter_nome_setor(coalesce(cd_setor_paciente,obter_setor_atend_data(a.nr_atendimento, g.dt_avaliacao))) 
  	ds_setor_atendimento, 
  	obter_sexo_pf(a.cd_pessoa_fisica,'C') ie_sexo, 
  	obter_sexo_pf(a.cd_pessoa_fisica,'D') ds_sexo, 
  	obter_nome_pessoa_fisica(g.cd_pessoa_fisica, null) nm_medico, 
  	g.cd_pessoa_fisica, 
  	substr(obter_idade(obter_data_nascto_pf(a.cd_pessoa_fisica),LOCALTIMESTAMP,'E'),1,10) 
  	ie_faixa_etaria, 
  	obter_unidade_atendimento(a.nr_atendimento,'A','U') ds_unidade, 
  	trunc(g.dt_avaliacao)dt_avaliacao, 
  	f.cd_empresa, 
  	g.qt_pontuacao, 
  	a.cd_estabelecimento, 
  	d.ds_gradacao, 
  	substr(obter_turno_data(dt_avaliacao),1,200) ie_turno, 
	a.cd_pessoa_fisica CD_PACIENTE, 
    obter_nome_pf(a.cd_pessoa_fisica) NM_PACIENTE 
FROM  gca_atendimento g, 
  	estabelecimento f, 
  	atendimento_paciente a, 
  	gca_gradacao d 
where  a.nr_atendimento = g.nr_atendimento 
and  	d.nr_sequencia = g.nr_seq_gradacao 
and  	a.cd_estabelecimento = f.cd_estabelecimento 
and  	g.dt_liberacao is not null 
and	g.ie_autor = 'F' 
and   g.ie_situacao = 'A';

