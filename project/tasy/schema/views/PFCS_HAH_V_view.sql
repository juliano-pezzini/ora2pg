-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pfcs_hah_v (ds_unit, ds_unit_classification, cd_unit_classification, cd_department, ds_census, qt_admission_orders, qt_special_request, qt_avg_waiting, qt_transf_order, qt_delays, qt_dis_orders, qt_exp_discharges, qt_discharges, qt_exp_transfers_in, qt_exp_transfers_out, qt_admissions, qt_exp_admissions, cd_estabelecimento, qt_admission_orders_color, qt_special_request_color, qt_avg_waiting_color, qt_transf_order_color, qt_delays_color, qt_dis_orders_color, qt_exp_discharges_color, qt_discharges_color, qt_exp_transfers_in_color, qt_exp_transfers_out_color, qt_exp_admissions_color, qt_admissions_color) AS select v.DS_UNIT,
    v.DS_UNIT_CLASSIFICATION,
    v.CD_UNIT_CLASSIFICATION,
    v.CD_DEPARTMENT,
    v.DS_CENSUS,
    v.QT_ADMISSION_ORDERS,
    v.QT_SPECIAL_REQUEST,
    get_time_by_minutes(v.QT_AVG_WAITING) QT_AVG_WAITING,
    v.QT_TRANSF_ORDER,
    v.QT_DELAYS,
    v.QT_DIS_ORDERS,
    v.QT_EXP_DISCHARGES,
    v.QT_DISCHARGES,
    QT_EXP_TRANSFERS_IN,
    QT_EXP_TRANSFERS_OUT,
    (QT_EXP_ADMISSIONS+QT_ADMISSION_ORDERS) QT_ADMISSIONS,
    QT_EXP_ADMISSIONS,
    v.CD_ESTABELECIMENTO,
    pfcs_get_indicator_rule(347,v.QT_ADMISSION_ORDERS,v.cd_estabelecimento,'COLOR') QT_ADMISSION_ORDERS_COLOR,
    pfcs_get_indicator_rule(348,v.QT_SPECIAL_REQUEST,v.cd_estabelecimento,'COLOR') QT_SPECIAL_REQUEST_COLOR,
    pfcs_get_indicator_rule(349,v.QT_AVG_WAITING,v.cd_estabelecimento,'COLOR') QT_AVG_WAITING_COLOR,
    pfcs_get_indicator_rule(350,v.QT_TRANSF_ORDER,v.cd_estabelecimento,'COLOR') QT_TRANSF_ORDER_COLOR,
    pfcs_get_indicator_rule(351,v.QT_DELAYS,v.cd_estabelecimento,'COLOR') QT_DELAYS_COLOR,
    pfcs_get_indicator_rule(352,v.QT_DIS_ORDERS,v.cd_estabelecimento,'COLOR') QT_DIS_ORDERS_COLOR,
    pfcs_get_indicator_rule(353,v.QT_EXP_DISCHARGES,v.cd_estabelecimento,'COLOR') QT_EXP_DISCHARGES_COLOR,
    pfcs_get_indicator_rule(354,v.QT_DISCHARGES,v.cd_estabelecimento,'COLOR') QT_DISCHARGES_COLOR,
    pfcs_get_indicator_rule(355,v.QT_EXP_TRANSFERS_IN,v.cd_estabelecimento,'COLOR') QT_EXP_TRANSFERS_IN_COLOR,
    pfcs_get_indicator_rule(356,v.QT_EXP_TRANSFERS_OUT,v.cd_estabelecimento,'COLOR') QT_EXP_TRANSFERS_OUT_COLOR,
    pfcs_get_indicator_rule(357,QT_EXP_ADMISSIONS,v.cd_estabelecimento,'COLOR') QT_EXP_ADMISSIONS_COLOR,
    pfcs_get_indicator_rule(358,(QT_EXP_ADMISSIONS+QT_ADMISSION_ORDERS),v.cd_estabelecimento,'COLOR') QT_ADMISSIONS_COLOR
FROM (
    SELECT distinct p.ds_reference_value DS_UNIT,
        pfcs_get_ds_unit_classif(p.cd_reference_aux, wheb_usuario_pck.get_nr_seq_idioma, 'S') DS_UNIT_CLASSIFICATION,
        p.cd_reference_aux CD_UNIT_CLASSIFICATION,
        p.cd_reference_value CD_DEPARTMENT,
        (SUM(CASE WHEN p.nr_seq_indicator=100 THEN p.vl_indicator_help END )) DS_CENSUS,
        pfcs_pck_census.get_special_requests(
            p.nr_seq_operational_level,
            p.cd_reference_value) QT_SPECIAL_REQUEST,
        pfcs_get_avg_request_time(94,p.nr_seq_operational_level,p.cd_reference_value) QT_AVG_WAITING,
        SUM(CASE WHEN p.nr_seq_indicator=97 THEN p.vl_indicator  ELSE 0 END ) QT_TRANSF_ORDER,
        SUM(CASE WHEN p.nr_seq_indicator=98 THEN p.vl_indicator  ELSE 0 END ) QT_DELAYS,
        pfcs_pck_bed_requests.get_transfer_in(
            p.nr_seq_operational_level,
            null,
            cd_reference_value,
            'P') QT_EXP_TRANSFERS_IN,
        pfcs_pck_bed_requests.get_transfer_out(
            p.nr_seq_operational_level,
            null,
            cd_reference_value,
            'P') QT_EXP_TRANSFERS_OUT,
        SUM(CASE WHEN p.nr_seq_indicator=112 THEN p.vl_indicator  ELSE 0 END ) QT_DIS_ORDERS,
        pfcs_pck_discharge_manager.get_anticipated_discharges(
            p.nr_seq_operational_level,
            p.cd_reference_value,
            null,
            LOCALTIMESTAMP) QT_EXP_DISCHARGES,
        (SUM(CASE WHEN p.nr_seq_indicator=112 THEN p.vl_indicator  ELSE 0 END )
            + pfcs_pck_discharge_manager.get_anticipated_discharges(
                p.nr_seq_operational_level,
                p.cd_reference_value,
                null,
                LOCALTIMESTAMP,
                'N')
        ) QT_DISCHARGES,
        pfcs_pck_bed_requests.get_admission_orders(
            p.nr_seq_operational_level,
            null,
            p.cd_reference_value) QT_ADMISSION_ORDERS,
            pfcs_pck_bed_requests.get_expected_admissions(
            p.nr_seq_operational_level,
            null,
            p.cd_reference_value) QT_EXP_ADMISSIONS,
        null QT_TRANS_REVIEW,
        p.nr_seq_operational_level CD_ESTABELECIMENTO
    FROM pfcs_panel p
    WHERE p.nr_seq_indicator IN (100, 112, 97, 98)
        AND p.cd_reference_aux in ('8')
    GROUP BY p.ds_reference_value, p.cd_reference_value, p.cd_reference_aux, p.nr_seq_operational_level
) v;

