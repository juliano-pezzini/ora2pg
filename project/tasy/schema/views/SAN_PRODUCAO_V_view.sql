-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_producao_v (ie_interno_externo, ie_avaliacao_final, cd_estabelecimento, nr_sangue, ds_derivado, ie_tipo_derivado, sg_sigla, nm_pessoa_fisica, ie_tipo_sangue, ie_fator_rh, ds_tipo_doacao, nr_seq_doacao, dt_doacao, nr_bolsa, nr_sequencia, dt_producao, dt_vencimento, nm_usuario, dt_atualizacao, nr_seq_transfusao, nr_seq_inutil, nr_seq_emp_saida, nr_seq_propaci, ie_reservado, cd_pf_realizou, ie_reacao, ie_irradiado, ie_lavado, ie_filtrado, ie_aliquotado, nr_seq_derivado, nr_sec_saude, nm_usuario_lib, dt_liberacao, nm_iniciais, qt_volume, qt_vol_transf, nr_seq_reserva, nr_agrupamento, dt_emprestimo, nr_seq_apresent, cd_barras, dt_inicio, dt_fim, dt_utilizacao, dt_termino_util, nr_controle_atual, nr_transfusao_controle, ie_aferese, cd_barras_integracao, dt_fim_producao, dt_recebimento, dt_liberacao_bolsa, dt_fim_prod_emprestimo, dt_inicio_prod_emprestimo, nr_seq_emp_ent, cd_barras_doacao, dt_conf_transf, nm_usuario_conf_trans, ie_pai_reproduzido, dt_inicio_infusao, nm_usuario_ini_infusao, dt_fim_infusao, nm_usuario_fim_infusao, ie_local_inutilizacao, cd_doador, cd_responsavel, cd_pessoa_fisica, ie_realiza_nat, ie_bloqueado, ie_reproduzido, cd_estab_atual, cd_estab_producao, ie_encaminhado, dt_entrada_estoque, nr_seq_entidade, nr_seq_tipo, dt_inutilizacao, nm_usuario_inut, nr_lote_bolsa, ds_justificativa, ie_sangue_vencido, cd_isbt, dt_coleta, cd_identificacao_isbt, dt_coleta_isbt, cd_divisao_isbt, nr_seq_tipo_isbt, ds_observacao, nm_usuario_resp, ds_seq_atend_pac_unid, nr_seq_conservante, ie_pool, cd_produto_isbt, dt_irradiacao, dt_fim_coleta, dt_reintegracao, qt_unidade_derivado, dt_dispensacao, nm_usuario_dispensacao, nr_seq_isbt) AS select	CASE WHEN g.nr_sequencia IS NULL THEN  'I'  ELSE 'R' END  ie_interno_externo,
	a.ie_avaliacao_final,
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.ie_tipo_derivado,
	e.sg_sigla,
	substr(obter_nome_pf(b.cd_pessoa_fisica),1,255) nm_pessoa_fisica,
	b.ie_tipo_sangue,
	b.ie_fator_rh,
	c.ds_tipo_doacao,
	a.nr_sequencia nr_seq_doacao,
	a.dt_doacao,
	a.nr_bolsa,
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	CASE WHEN g.nr_sequencia IS NULL THEN  d.nr_seq_emp_saida  ELSE null END  nr_seq_emp_saida,
	d.nr_seq_propaci,
	CASE WHEN obter_se_san_prod_disp(d.nr_sequencia)='R' THEN 'S'  ELSE 'N' END  ie_reservado,
	d.cd_pf_realizou,
	substr(obter_se_houve_reacao(d.nr_seq_transfusao, d.nr_sequencia),1,1) ie_reacao,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	substr(obter_iniciais_nome(a.cd_pessoa_fisica,null),1,50) nm_iniciais,
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	substr(san_obter_agrup_exame(d.nr_seq_transfusao,d.nr_seq_reserva,d.nr_sequencia),1,10) nr_agrupamento,
	null dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.dt_termino_util,
	substr(san_numero_atual_prod_transf(d.nr_sequencia),1,10) nr_controle_atual,
	d.nr_transfusao_controle,
	d.ie_aferese,
	a.cd_barras_integracao,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_liberacao dt_liberacao_bolsa,
	d.dt_fim_prod_emprestimo,
	d.dt_inicio_prod_emprestimo,
	d.nr_seq_emp_ent,
	a.cd_barras cd_barras_doacao,
	d.dt_conf_transf,
	d.nm_usuario_conf_trans,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	d.dt_inicio_infusao,
	d.nm_usuario_ini_infusao,
	d.dt_fim_infusao,
	d.nm_usuario_fim_infusao,
	d.ie_local_inutilizacao,
	a.cd_pessoa_fisica cd_doador,
	a.cd_pf_realizou cd_responsavel,
	b.cd_pessoa_fisica,
	a.ie_realiza_nat,
	(select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  FROM san_producao where nr_sequencia = d.nr_sequencia and dt_bloqueio is not null) ie_bloqueado,
	d.ie_reproduzido ie_reproduzido,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	d.dt_entrada_estoque,
	null nr_seq_entidade,
	a.nr_seq_tipo,
	d.dt_inutilizacao,
	d.nm_usuario_inut,
	a.nr_lote_bolsa,
	d.ds_justificativa,
	CASE WHEN obter_data_maior(d.dt_vencimento,LOCALTIMESTAMP)=d.dt_vencimento THEN 'N'  ELSE 'S' END  ie_sangue_vencido,
	c.cd_isbt,
	a.dt_coleta,
	coalesce(d.cd_identificacao_isbt,SUBSTR(obter_isbt_doador( a.nr_sequencia, null,'B'),2,13)) cd_identificacao_isbt,
	coalesce(d.dt_coleta_isbt,a.dt_coleta) dt_coleta_isbt,
	d.cd_divisao_isbt,
	a.nr_seq_tipo nr_seq_tipo_isbt,
	d.ds_observacao,
	d.nm_usuario_resp,
	substr(san_obter_local_transf(d.nr_seq_atend_pac_unid),1,100) ds_seq_atend_pac_unid,
	d.nr_seq_conservante,
	d.ie_pool,
	d.cd_produto_isbt,
  d.dt_irradiacao,
  a.dt_fim_coleta,
	g.dt_reintegracao,
  d.qt_unidade_derivado,
	d.dt_dispensacao,
  d.nm_usuario_dispensacao,
  san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_tipo_doacao c, pessoa_fisica b, san_doacao a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
LEFT OUTER JOIN san_derivado_reintegrado g ON (d.nr_sequencia = g.nr_seq_producao)
LEFT OUTER JOIN san_emprestimo i ON (d.nr_seq_emp_saida = i.nr_sequencia)
WHERE a.cd_pessoa_fisica	= b.cd_pessoa_fisica and a.nr_seq_tipo		= c.nr_sequencia and a.nr_sequencia		= d.nr_seq_doacao and d.nr_seq_derivado	= e.nr_sequencia    and (i.dt_emprestimo < g.dt_reintegracao
    or g.dt_reintegracao is null) and d.nr_seq_emp_ent is null
 
union

select	'E' ie_interno_externo,
	'A',
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.ie_tipo_derivado,
	e.sg_sigla,
	b.ds_entidade,
	d.ie_tipo_sangue,
	d.ie_fator_rh,
	wheb_mensagem_pck.get_Texto(1125870),--'Emprestimo',
	null,
	d.dt_producao,
	d.nr_bolsa,
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	d.nr_seq_emp_saida,
	d.nr_seq_propaci,
	CASE WHEN obter_se_san_prod_disp(d.nr_sequencia)='R' THEN 'S'  ELSE 'N' END  ie_reservado,
	d.cd_pf_realizou,
	substr(obter_se_houve_reacao(d.nr_seq_transfusao, d.nr_sequencia),1,1) ie_reacao,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	substr(d.nm_doador,1,50),
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	substr(san_obter_agrup_exame(d.nr_seq_transfusao,d.nr_seq_reserva,d.nr_sequencia),1,10) nr_agrupamento,
	a.dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.dt_termino_util,
	substr(san_numero_atual_prod_transf(d.nr_sequencia),1,10) nr_controle_atual,
	d.nr_transfusao_controle,
	d.ie_aferese,
	null,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_emprestimo dt_liberacao_bolsa,
	d.dt_fim_prod_emprestimo,
	d.dt_inicio_prod_emprestimo,
	d.nr_seq_emp_ent,
	null,
	d.dt_conf_transf,
	d.nm_usuario_conf_trans,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	d.dt_inicio_infusao,
	d.nm_usuario_ini_infusao,
	d.dt_fim_infusao,
	d.nm_usuario_fim_infusao,
	d.ie_local_inutilizacao,
	null cd_doador,
	d.cd_pf_realizou cd_responsavel,
	null cd_pessoa_fisica,
	null ie_realiza_nat,
	(select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  from san_producao where nr_sequencia = d.nr_sequencia and dt_bloqueio is not null) ie_bloqueado,
	d.ie_reproduzido ,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	d.dt_entrada_estoque,
	a.nr_seq_entidade ,
	null,
	d.dt_inutilizacao, 
	d.nm_usuario_inut,
	d.nr_seq_lote,
	d.ds_justificativa,
	CASE WHEN obter_data_maior(d.dt_vencimento,LOCALTIMESTAMP)=d.dt_vencimento THEN 'N'  ELSE 'S' END  ie_sangue_vencido,
	San_obter_tipo_doacao_isbt(d.nr_seq_tipo_doacao_isbt),
	null,
	d.cd_identificacao_isbt,
	d.dt_coleta_isbt,
	d.cd_divisao_isbt,
	d.nr_seq_tipo_doacao_isbt,
	d.ds_observacao,
	d.nm_usuario_resp,
	substr(san_obter_local_transf(d.nr_seq_atend_pac_unid),1,100) ds_seq_atend_pac_unid,
	d.nr_seq_conservante,
	d.ie_pool,
	d.cd_produto_isbt,
    d.dt_irradiacao,
    null,
    null dt_reintegracao,
    d.qt_unidade_derivado,
		d.dt_dispensacao,
    d.nm_usuario_dispensacao,
    san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_entidade b, san_emprestimo a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_derivado	= e.nr_sequencia and d.nr_seq_emp_ent	= a.nr_sequencia and a.nr_seq_entidade	= b.nr_sequencia  
union

select	'A' ie_interno_externo,
	'A',
	a.cd_estabelecimento,
	d.nr_sangue,
	e.ds_derivado,
	e.ie_tipo_derivado,
	e.sg_sigla,
	'Agrupamento',
	d.ie_tipo_sangue,
	d.ie_fator_rh,
	'Agrupamento',
	null nr_seq_agrupamento,
	d.dt_producao,
	'',
	d.nr_sequencia,
	d.dt_producao,
	d.dt_vencimento,
	d.nm_usuario,
	d.dt_atualizacao,
	d.nr_seq_transfusao,
	d.nr_seq_inutil,
	d.nr_seq_emp_saida,
	d.nr_seq_propaci,
	CASE WHEN obter_se_san_prod_disp(d.nr_sequencia)='R' THEN 'S'  ELSE 'N' END  ie_reservado,
	d.cd_pf_realizou,
	substr(obter_se_houve_reacao(d.nr_seq_transfusao, d.nr_sequencia),1,1) ie_reacao,
	d.ie_irradiado,
	d.ie_lavado,
	d.ie_filtrado,
	d.ie_aliquotado,
	d.nr_seq_derivado,
	d.nr_sec_saude,
	d.nm_usuario_lib,
	d.dt_liberacao,
	substr(d.nm_doador,1,50),
	d.qt_volume,
	d.qt_vol_transf,
	d.nr_seq_reserva,
	substr(san_obter_agrup_exame(d.nr_seq_transfusao,d.nr_seq_reserva,d.nr_sequencia),1,10) nr_agrupamento,
	null dt_emprestimo,
	coalesce(e.nr_seq_apresent,'9999') nr_seq_apresent,
	d.cd_barras,
	h.dt_inicio,
	h.dt_fim,
	d.dt_utilizacao,
	d.dt_termino_util,
	substr(san_numero_atual_prod_transf(d.nr_sequencia),1,10) nr_controle_atual,
	d.nr_transfusao_controle,
	d.ie_aferese,
	null,
	d.dt_fim_producao,
	d.dt_recebimento,
	a.dt_liberacao dt_liberacao_bolsa,
	d.dt_fim_prod_emprestimo,
	d.dt_inicio_prod_emprestimo,
	d.nr_seq_emp_ent,
	null,
	d.dt_conf_transf,
	d.nm_usuario_conf_trans,
	coalesce(d.ie_pai_reproduzido,'N') ie_pai_reproduzido,
	d.dt_inicio_infusao,
	d.nm_usuario_ini_infusao,
	d.dt_fim_infusao,
	d.nm_usuario_fim_infusao,
	d.ie_local_inutilizacao,
	null cd_doador,
	d.cd_pf_realizou cd_responsavel,
	null cd_pessoa_fisica,
	null ie_realiza_nat,
	(select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  from san_producao where nr_sequencia = d.nr_sequencia and dt_bloqueio is not null) ie_bloqueado,
	d.ie_reproduzido,
	d.cd_estab_atual,
	d.cd_estabelecimento cd_estab_producao,
	coalesce(d.ie_encaminhado,'N') ie_encaminhado,
	d.dt_entrada_estoque,
	null nr_seq_entidade,
	null,
	d.dt_inutilizacao, 
	d.nm_usuario_inut,
	null,
	d.ds_justificativa,
	CASE WHEN obter_data_maior(d.dt_vencimento,LOCALTIMESTAMP)=d.dt_vencimento THEN 'N'  ELSE 'S' END  ie_sangue_vencido,
	San_obter_tipo_doacao_isbt(d.nr_seq_tipo_doacao_isbt),
	null,
	d.cd_identificacao_isbt,
	d.dt_coleta_isbt,
	d.cd_divisao_isbt,
	d.nr_seq_tipo_doacao_isbt,
	d.ds_observacao,
	d.nm_usuario_resp,
	substr(san_obter_local_transf(d.nr_seq_atend_pac_unid),1,100) ds_seq_atend_pac_unid,
	d.nr_seq_conservante, 
	d.ie_pool,
	d.cd_produto_isbt,
    d.dt_irradiacao,
    null,
    null dt_reintegracao,
    d.qt_unidade_derivado,
		d.dt_dispensacao,
    d.nm_usuario_dispensacao,
    san_busca_nr_seq_isbt(d.nr_sequencia) nr_seq_isbt
FROM san_derivado e, san_agrupamento a, san_producao d
LEFT OUTER JOIN san_producao_lib_venc h ON (d.nr_sequencia = h.nr_seq_producao)
WHERE d.nr_seq_derivado	= e.nr_sequencia and a.nr_sequencia		= d.nr_seq_agrupamento;

