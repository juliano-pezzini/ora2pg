-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW procedimento_cirurgia_v3 (cd_medico_cirurgiao, dt_termino, ie_status_cirurgia, ie_video, cd_convenio, cd_procedimento, cd_pessoa_fisica, cd_medico_anestesista, cd_setor_atendimento, dt_entrada_unidade, cd_tipo_anestesia, dt_inicio_real, nr_min_duracao_real, nr_atendimento, ds_procedimento, nm_paciente, nr_prontuario, ie_tipo, nr_seq_proc_interno, nr_cirurgia, dt_nascimento, ds_observacao) AS select	a.cd_medico_cirurgiao,
		a.dt_termino,
		a.ie_status_cirurgia,
		(SELECT coalesce(MAX(x.ie_video),'N') FROM	procedimento_paciente x WHERE x.nr_cirurgia = a.nr_cirurgia) ie_video,
		a.cd_convenio,
		a.cd_procedimento_princ cd_procedimento,
		a.cd_pessoa_fisica,
		a.cd_medico_anestesista,
		b.cd_setor_atendimento,
		a.dt_entrada_unidade,
		a.cd_tipo_anestesia,
		a.DT_INICIO_REAL,
		a.nr_min_duracao_real,
		a.nr_atendimento,
		e.ds_procedimento,
		p.nm_pessoa_fisica nm_paciente,
		p.nr_prontuario,
		'C' ie_tipo,
		a.nr_seq_proc_interno,
		a.nr_cirurgia,
		dt_nascimento,
		a.ds_observacao
FROM pessoa_fisica p, procedimento e, cirurgia a
LEFT OUTER JOIN atend_paciente_unidade b ON (a.nr_atendimento = b.nr_atendimento AND a.dt_entrada_unidade = b.dt_entrada_unidade)
WHERE a.cd_procedimento_princ = e.cd_procedimento AND a.ie_origem_proced =	   	 e.ie_origem_proced   AND a.cd_pessoa_fisica =			 p.cd_pessoa_fisica

UNION

SELECT 	coalesce(y.CD_MEDICO_EXEC,a.cd_medico_cirurgiao)
		cd_medico_cirurgiao,
		a.dt_termino,
		a.ie_status_cirurgia,
		(SELECT coalesce(MAX(x.ie_video),'N') FROM	   procedimento_paciente x WHERE x.nr_cirurgia = a.nr_cirurgia) ie_video,
		coalesce(y.cd_convenio,a.cd_convenio) cd_convenio,
		y.cd_procedimento,
		a.cd_pessoa_fisica,
		a.cd_medico_anestesista,
		b.cd_setor_atendimento,
		a.dt_entrada_unidade,
		coalesce(a.cd_tipo_anestesia,y.cd_tipo_anestesia) cd_tipo_anestesia,
		a.DT_INICIO_REAL,
		a.nr_min_duracao_real,
		a.nr_atendimento,
		e.ds_procedimento,
		p.nm_pessoa_fisica nm_paciente,
		p.nr_prontuario,
		'A' ie_tipo,
		y.nr_seq_proc_interno,
		a.nr_cirurgia,
		dt_nascimento,
		a.ds_observacao
FROM prescr_procedimento y, pessoa_fisica p, procedimento e, cirurgia a
LEFT OUTER JOIN atend_paciente_unidade b ON (a.nr_atendimento = b.nr_atendimento AND a.dt_entrada_unidade = b.dt_entrada_unidade)
WHERE a.nr_prescricao = y.nr_prescricao AND y.cd_procedimento =
		e.cd_procedimento AND a.ie_origem_proced = 	e.ie_origem_proced   AND a.cd_pessoa_fisica = 	p.cd_pessoa_fisica;

