-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hd_dados_agenda_ocupacao_v (nm_pessoa_fisica, ds_convenio, ds_tratamento, ds_prontuario, dt_nascimento, ds_sexo, ie_sexo, ds_idade, hr_inicio, hr_final, duracao, cd_pessoa_fisica, nr_seq_turno, ds_ponto_acesso, agenda_id, nr_seq_schedule, cd_convenio, ds_autorizacao, dt_fim_dialise, nr_seq_agenda_sessao, ie_situacao, nr_seq_ponto_acesso, nr_seq_unidade, dt_agenda, ie_agenda_identificacao, nr_seq_dialise, nr_sequencia) AS SELECT  NM_PESSOA_FISICA,
        DS_CONVENIO,
        DS_TRATAMENTO,
        DS_PRONTUARIO,
        DT_NASCIMENTO,
        DS_SEXO,
        IE_SEXO,
        DS_IDADE,
        HR_INICIO,
        HR_FINAL,
        DURACAO,
        CD_PESSOA_FISICA,
        NR_SEQ_TURNO,
        DS_PONTO_ACESSO,
        AGENDA_ID,
        NR_SEQ_SCHEDULE,
        CD_CONVENIO,
        DS_AUTORIZACAO,
        DT_FIM_DIALISE,
        NR_SEQ_AGENDA_SESSAO,
        IE_SITUACAO,
        NR_SEQ_PONTO_ACESSO,
        NR_SEQ_UNIDADE,
        DT_AGENDA,
        IE_AGENDA_IDENTIFICACAO,
        NR_SEQ_DIALISE,
        NR_SEQUENCIA
FROM	(
SELECT
obter_nome_pessoa_fisica(ad.cd_pessoa_fisica, NULL) AS nm_pessoa_fisica,
SUBSTR(obter_nome_convenio(ad.cd_convenio), 1, 255) ds_convenio,
SUBSTR(hd_obter_tratamento(ad.cd_pessoa_fisica, '/ '), 1, 255) AS ds_tratamento,
SUBSTR(obter_prontuario_paciente(ad.cd_pessoa_fisica), 1, 25) ds_prontuario,
obter_data_nascto_pf(ad.cd_pessoa_fisica) AS dt_nascimento,
obter_sexo_pf(ad.cd_pessoa_fisica, 'D') AS ds_sexo,
obter_sexo_pf(ad.cd_pessoa_fisica, 'C') AS ie_sexo,
obter_idade(obter_data_nascto_pf(ad.cd_pessoa_fisica), ad.dt_agenda, 'AM') AS ds_idade,
TO_CHAR(ht.dt_inicio, 'hh24:mi') AS hr_inicio,
TO_CHAR(ht.dt_fim, 'hh24:mi') AS hr_final,  
(ROUND((TO_CHAR(ht.dt_fim, 'SSSSS'))::numeric  / 60) - ROUND((TO_CHAR(ht.dt_inicio, 'SSSSS'))::numeric  / 60)) AS duracao,
ad.cd_pessoa_fisica,
ht.nr_sequencia nr_seq_turno,
pa.ds_ponto_acesso,
ad.nr_sequencia AS agenda_id,
ht.nr_sequencia AS nr_seq_schedule,
ad.cd_convenio,
obter_estagio_autor_agedialise(ad.nr_seq_agenda) AS ds_autorizacao,
(SELECT MAX(dt_fim_dialise)
FROM	hd_dialise hd
WHERE hd.nr_sequencia = ad.nr_seq_dialise) dt_fim_dialise,
ac.nr_seq_agenda_sessao,
ad.ie_situacao,
ad.nr_seq_ponto_acesso,
ad.nr_seq_unidade,
ad.dt_agenda,
'P' AS IE_AGENDA_IDENTIFICACAO,
ad.nr_seq_dialise,
pa.nr_sequencia
FROM	hd_agenda_dialise ad,
hd_turno  ht,
hd_ponto_acesso pa,
agenda_consulta ac
WHERE ht.ie_situacao = 'A'
	AND	pa.ie_situacao = 'A'
	AND	coalesce(ad.ie_situacao, 'A') IN ('A', 'T')
	AND	ac.nr_sequencia = ad.nr_seq_agenda
	AND	ht.cd_estabelecimento = pa.cd_estabelecimento
	AND (ht.nr_seq_unid_exclus IS NULL OR ht.nr_seq_unid_exclus is NULL)
	AND	ad.nr_seq_turno = ht.nr_sequencia
	AND	ad.nr_seq_ponto_acesso = pa.nr_sequencia
        AND	(TO_CHAR(ht.dt_fim, 'SSSSS'))::numeric  - (TO_CHAR(ht.dt_inicio, 'SSSSS'))::numeric  > 0

UNION ALL

select 
obter_nome_pessoa_fisica(ad.cd_pessoa_fisica, NULL) AS nm_pessoa_fisica,
SUBSTR(obter_nome_convenio(ad.cd_convenio), 1, 255) ds_convenio,
SUBSTR(hd_obter_tratamento(ad.cd_pessoa_fisica, '/ '), 1, 255) AS ds_tratamento,
SUBSTR(obter_prontuario_paciente(ad.cd_pessoa_fisica), 1, 25) ds_prontuario,
obter_data_nascto_pf(ad.cd_pessoa_fisica) AS dt_nascimento,
obter_sexo_pf(ad.cd_pessoa_fisica, 'D') AS ds_sexo,
obter_sexo_pf(ad.cd_pessoa_fisica, 'C') AS ie_sexo,
obter_idade(obter_data_nascto_pf(ad.cd_pessoa_fisica), ad.dt_agenda, 'AM') AS ds_idade,
TO_CHAR(ad.hr_inicio, 'hh24:mi') AS hr_inicio,
TO_CHAR(ad.hr_inicio + NUMTODSINTERVAL(ad.qt_hora_min_sessao,'MINUTE'), 'hh24:mi') AS hr_final,  
ad.qt_hora_min_sessao AS duracao,
ad.cd_pessoa_fisica,
null nr_seq_turno,
pa.ds_ponto_acesso,
ad.nr_sequencia AS agenda_id,
null AS nr_seq_schedule,
ad.cd_convenio,
obter_estagio_autor_agedialise(ad.nr_seq_agenda) AS ds_autorizacao,
(SELECT MAX(dt_fim_dialise)
FROM	hd_dialise hd
WHERE hd.nr_sequencia = ad.nr_seq_dialise) dt_fim_dialise,
ac.nr_seq_agenda_sessao,
ad.ie_situacao,
ad.nr_seq_ponto_acesso,
ad.nr_seq_unidade,
ad.dt_agenda,
'H' AS IE_AGENDA_IDENTIFICACAO,
ad.nr_seq_dialise,
pa.nr_sequencia
FROM	hd_agenda_dialise ad,
hd_ponto_acesso pa,
agenda_consulta ac
WHERE 1 = 1
    AND ad.nr_seq_superior is not null
    AND	pa.ie_situacao = 'A'
    AND	coalesce(ad.ie_situacao, 'A') IN ('A', 'T')
    AND	ac.nr_sequencia = ad.nr_seq_agenda
    AND	ad.nr_seq_ponto_acesso = pa.nr_sequencia
) ad
WHERE ((coalesce(ie_situacao,'A') = 'A')
OR (coalesce(ie_situacao,'A') = 'T'	AND NOT EXISTS (SELECT 1
                                                FROM	hd_agenda_dialise ad2 
                                                WHERE ad2.dt_agenda = ad.dt_agenda 
                                                AND ad2.nr_seq_unidade = ad.nr_seq_unidade 
	                                        AND ad2.nr_seq_ponto_acesso = ad.nr_seq_ponto_acesso
                                                AND ad2.nr_seq_turno = ad.nr_seq_turno
                                                AND coalesce(ad2.ie_situacao, 'A') = 'A')));

