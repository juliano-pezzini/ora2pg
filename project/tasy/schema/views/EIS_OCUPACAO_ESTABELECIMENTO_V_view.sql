-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_estabelecimento_v (cd_estabelecimento, nm_estabelecimento, cd_unidade_basica, cd_unidade_compl, dt_referencia, cd_setor_atendimento, ds_setor_atendimento, ie_periodo, cd_classif_setor, qt_obito_apos24h, nr_unidades_setor, qt_disponiveis, qt_ind, nr_leitos_ocupados, nr_leitos_livres, nr_admissoes, nr_altas, nr_obitos, nr_transf_entrada, nr_transf_saida, nr_dias_periodo, ie_ocup_hospitalar, ie_temp, ie_situacao, nr_unidades_temporarias, nr_unidades_ocupadas, qt_unidade_acomp, nr_unidades_interditadas, nr_unidades_livres, nr_unidades_higienizacao, nr_unidades_reservadas, qt_unidades_isolamento, qt_unidades_alta, nr_unid_temp_ocup) AS select 		a.cd_estabelecimento,
		substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,255) nm_estabelecimento,
		a.cd_unidade_basica,
		a.cd_unidade_compl,
		a.dt_referencia,
		a.cd_setor_atendimento,
 		s.ds_setor_atendimento,
		a.ie_periodo,
		s.cd_classif_setor,
		sum(qt_obito_apos24h) qt_obito_apos24h,
		sum(CASE WHEN a.ie_situacao='P' THEN nr_pacientes  ELSE 1 END ) nr_unidades_setor,
		sum(CASE WHEN obter_se_leito_disp(a.cd_setor_atendimento, a.cd_unidade_basica, a.cd_unidade_compl)='S' THEN  1  ELSE 0 END ) qt_disponiveis,
		sum(CASE WHEN obter_se_leito_disp(a.cd_setor_atendimento, a.cd_unidade_basica, a.cd_unidade_compl)='N' THEN  1  ELSE 0 END ) qt_ind,
		--decode(obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl), 'N',
	        --	sum(decode(a.ie_situacao,'P',nr_pacientes,0)),
		--	sum(decode(a.cd_pessoa_fisica, null, 0, 1))) nr_leitos_ocupados,
		CASE WHEN Obter_Se_Unidade_Temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl)='N' THEN 	        	sum(CASE WHEN a.IE_SITUACAO='P' THEN NR_PACIENTES  ELSE 0 END )  ELSE sum(CASE WHEN a.cd_pessoa_fisica IS NULL THEN  0  ELSE NR_PACIENTES END ) END  NR_LEITOS_OCUPADOS,
		CASE WHEN coalesce(a.ie_temp, Obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl))='N' THEN 			sum(CASE WHEN a.cd_pessoa_fisica IS NULL THEN  1  ELSE CASE WHEN a.IE_SITUACAO='L' THEN nr_pacientes  ELSE 0 END  END )  ELSE --sum(decode(a.cd_pessoa_fisica, null, 0, decode(a.ie_situacao,'L',1,0))), Jerusa em 27/01/2009 - Mudei pela linha acima OS 123768
			sum(CASE WHEN a.cd_pessoa_fisica IS NULL THEN  1  ELSE 0 END ) END  nr_leitos_livres,
        	sum(nr_admissoes) nr_admissoes,
        	sum(nr_altas) nr_altas,
        	sum(nr_obitos) nr_obitos,
        	sum(nr_transf_entrada) nr_transf_entrada,
        	sum(nr_transf_saida)  nr_transf_saida,
		avg(CASE WHEN a.ie_periodo='M' THEN  (to_char(last_day(a.dt_referencia),'dd'))::numeric   ELSE 1 END ) nr_dias_periodo,
		coalesce(ie_ocup_hospitalar,'S') ie_ocup_hospitalar,
		substr(obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl),1,1) ie_temp,
		a.ie_situacao,
		sum(CASE WHEN obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl)='S' THEN  1  ELSE 0 END ) nr_unidades_temporarias,
		sum(CASE WHEN a.ie_situacao='P' THEN  1  ELSE 0 END ) nr_unidades_ocupadas,
		sum(CASE WHEN a.ie_situacao='M' THEN  1  ELSE 0 END ) qt_unidade_acomp,
		sum(CASE WHEN a.ie_situacao='I' THEN  1  ELSE 0 END ) nr_unidades_interditadas,
		sum(CASE WHEN a.ie_situacao='L' THEN  1  ELSE 0 END ) nr_unidades_livres,
		sum(CASE WHEN a.ie_situacao='H' THEN  1  ELSE 0 END ) nr_unidades_higienizacao,
		sum(CASE WHEN a.ie_situacao='R' THEN  1  ELSE 0 END ) nr_unidades_reservadas,
		sum(CASE WHEN a.ie_situacao='O' THEN  1  ELSE 0 END ) qt_unidades_isolamento,
		sum(CASE WHEN a.ie_situacao='A' THEN  1  ELSE 0 END ) qt_unidades_alta,
		sum(CASE WHEN obter_se_unidade_temp(a.cd_setor_atendimento, a.dt_referencia, a.cd_unidade_basica, a.cd_unidade_compl)='S' THEN 		CASE WHEN a.ie_situacao='P' THEN  1  ELSE 0 END   ELSE 0 END ) nr_unid_temp_ocup
FROM   		setor_atendimento s,
        	eis_ocupacao_hospitalar a
where 		a.cd_setor_atendimento = s.cd_setor_atendimento
group by 	a.cd_estabelecimento,
		a.dt_referencia,
		a.cd_unidade_basica,
		a.cd_unidade_compl,
		a.cd_setor_atendimento,
	       	s.ds_setor_atendimento,
		a.ie_periodo,
		s.cd_classif_setor,
		a.ie_temp,
		coalesce(ie_ocup_hospitalar,'S'),
		a.ie_situacao;

