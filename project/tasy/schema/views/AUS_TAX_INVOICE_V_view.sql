-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW aus_tax_invoice_v (itemt, dt_item, ds_item, itemc, nr_amount, gst, qt_item, nr_total, nr_interno_conta, sort_priority) AS select 'P' itemt,
	e.dt_procedimento dt_item,
	coalesce(case when upper(e.ds_observacao) like '%EVENT%' or upper(e.ds_observacao) like '%DAILY RATE%' then null else e.ds_observacao end,
	obter_desc_procedimento(e.cd_procedimento,e.ie_origem_proced)||' '||coalesce(e.dt_procedimento,LOCALTIMESTAMP)||' - '||trunc(coalesce(e.dt_procedimento,LOCALTIMESTAMP) + a.qt_item_nf - 1)||' '||a.qt_item_nf||' Days @ $'||e.vl_procedimento) ds_item,
	OBTER_COD_PROC_LOC(a.cd_procedimento,a.ie_origem_proced) itemc,
	a.vl_total_item_nf/coalesce(a.qt_item_nf,1) nr_amount,
	coalesce((select	coalesce(sum(x.vl_tributo),0) FROM nota_fiscal_item_trib x where x.nr_sequencia =d.nr_sequencia and x.nr_item_nf = a.nr_item_nf),0) gst,
	a.qt_item_nf qt_item,
	(a.vl_total_item_nf+coalesce((select	coalesce(sum(x.vl_tributo),0) from nota_fiscal_item_trib x where x.nr_sequencia =d.nr_sequencia and x.nr_item_nf = a.nr_item_nf),0)) nr_total,
	c.nr_interno_conta,
	case when p.ie_origem_proced=15 then 1
	when p.cd_grupo_proc=5000 then 1
	when p.ie_classificacao = 2 then 3 
	else 4 end sort_priority
from 	conta_paciente c, 
	nota_fiscal d, 
	nota_fiscal_item a,  
	procedimento_paciente e,
	procedimento p
where 	d.nr_sequencia=(select max(x.nr_sequencia) from nota_fiscal x where x.nr_interno_conta=c.nr_interno_conta and x.nr_sequencia_ref is null )
and 	d.nr_sequencia=a.nr_sequencia
and 	e.nr_interno_conta=c.nr_interno_conta
and 	a.cd_procedimento=e.cd_procedimento
and 	a.ie_origem_proced=e.ie_origem_proced
and 	p.cd_procedimento=e.cd_procedimento
and 	p.ie_origem_proced=e.ie_origem_proced
and 	p.ie_classificacao<>1
and 	e.dt_procedimento=(	select	min(dt_procedimento) 
				from 	procedimento_paciente x
				where 	x.nr_interno_conta=c.nr_interno_conta
				and 	x.cd_procedimento=e.cd_procedimento
				group by x.cd_procedimento,x.ie_origem_proced)

union all

select 'P' itemt,
	e.dt_procedimento dt_item,
	coalesce(case when upper(e.ds_observacao) not like upper('AP Rule%') then e.ds_observacao else null end,substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced)||chr(10)|| case when a.ie_origem_proced=15 then (select ' '||DS_EDITION from EDITION_DRG where NR_SEQUENCIA = (
	select max(a.nr_seq_edition) from HEALTH_FUND_DRG a where a.cd_health_fund = c.cd_convenio_parametro ))||'_'|| a.cd_procedimento_loc else '' end,1,255)) ds_item,
	OBTER_COD_PROC_LOC(coalesce(a.cd_procedimento,e.cd_procedimento),a.ie_origem_proced) itemc,
	e.vl_procedimento/coalesce(e.qt_procedimento,1) nr_amount,
	coalesce((select	coalesce(sum(x.vl_tributo),0) from nota_fiscal_item_trib x where x.nr_sequencia =d.nr_sequencia and x.nr_item_nf = a.nr_item_nf),0) gst,
	e.qt_procedimento qt_item,
	(e.vl_procedimento + coalesce((select coalesce(sum(x.vl_tributo),0) from nota_fiscal_item_trib x where x.nr_sequencia =d.nr_sequencia and x.nr_item_nf = a.nr_item_nf),0)) nr_total,
	c.nr_interno_conta,
	2 sort_priority
from 	conta_paciente c, 
	nota_fiscal d, 
	nota_fiscal_item a, 
	procedimento_paciente e,
	procedimento p
where 	d.nr_sequencia=(select max(x.nr_sequencia) from nota_fiscal x where x.nr_interno_conta=c.nr_interno_conta and x.nr_sequencia_ref is null )
and 	d.nr_sequencia=a.nr_sequencia
and 	a.cd_procedimento is not null
and 	a.ie_origem_proced is not null
and 	e.nr_interno_conta=c.nr_interno_conta
and 	a.cd_procedimento=e.cd_procedimento
and 	a.ie_origem_proced=e.ie_origem_proced
and 	p.cd_procedimento=e.cd_procedimento
and 	p.ie_origem_proced=e.ie_origem_proced
and 	p.ie_classificacao=1
and 	((p.ie_origem_proced=15 and e.vl_procedimento> 0)or (p.ie_origem_proced<>15))

union all

select 'M' itemt,
	coalesce(e.dt_conta,e.dt_atendimento) dt_item,
	obter_desc_material(d.cd_material) ds_item,
	coalesce(OBTER_DADOS_MATERIAL(coalesce(e.cd_material_convenio,d.cd_material),'CSA'),coalesce(e.cd_material_convenio,to_char(d.cd_material))) itemc,
	d.vl_total_item_nf nr_amount,
	coalesce((select	coalesce(sum(x.vl_tributo),0) from nota_fiscal_item_trib x where x.nr_sequencia =a.nr_sequencia and x.nr_item_nf = d.nr_item_nf),0) gst,
	d.qt_item_nf qt_item,
	(d.vl_total_item_nf+coalesce((select	coalesce(sum(x.vl_tributo),0) from nota_fiscal_item_trib x where x.nr_sequencia =a.nr_sequencia and x.nr_item_nf = d.nr_item_nf),0)) nr_total,
	c.nr_interno_conta,
	5 sort_priority
from 	conta_paciente c,
	nota_fiscal a,
	nota_fiscal_item d,
	material_atend_paciente e
where	a.nr_sequencia=(select max(x.nr_sequencia) from nota_fiscal x where x.nr_interno_conta=c.nr_interno_conta and x.nr_sequencia_ref is null)
and 	a.nr_sequencia=d.nr_sequencia
and 	d.cd_material is not null
and 	e.nr_interno_conta=c.nr_interno_conta
and 	d.cd_material=e.cd_material
and 	d.vl_total_item_nf>0
order by dt_item ASC,itemt desc;

