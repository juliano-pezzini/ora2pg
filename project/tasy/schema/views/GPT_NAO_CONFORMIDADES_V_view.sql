-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW gpt_nao_conformidades_v (nr_sequencia, ds_material, ie_libera, ds_erro_compl, ds_dose_intervalo, ds_justificativa, ds_observacao, ds_orientacao, dt_prescricao, ds_incons_farmacia, nr_prescricao, ie_ciente, ds_motivo, cd_material, nr_atendimento, cd_pessoa_fisica, ie_tipo_perfil, ie_cpoe, ie_quimio, dt_confirmacao, nm_usuario_ciente, nr_seq_mat_cpoe, ie_origem_informacao, ds_origem_informacao) AS select
	b.nr_sequencia,
	substr(obter_desc_material(a.cd_material), 1, 255) ds_material,
	b.ie_libera,
	substr(coalesce(ds_erro, '')
				 || ' '
				 || coalesce(ds_compl_erro, ''), 1, 255) ds_erro_compl,
	substr(obter_um_dosagem_prescr(a.nr_prescricao, a.nr_sequencia), 1, 100) ds_dose_intervalo,
	substr(a.ds_justificativa, 1, 255) ds_justificativa,
	substr(b.ds_inf_adicional, 1, 255) ds_observacao,
	substr('', 1, 255) ds_orientacao,
	c.dt_prescricao,
	'' ds_incons_farmacia,
	c.nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	b.ds_motivo,
	TO_CHAR(a.cd_material) cd_material,
	c.nr_atendimento,
	c.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'N' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	a.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
FROM
	prescr_medica		c,
	prescr_material		a,
	prescr_medica_erro	b		
where
	a.nr_prescricao = b.nr_prescricao
	and b.nr_seq_medic = a.nr_sequencia
	and c.nr_prescricao = a.nr_prescricao
	and a.ie_agrupador in (1, 5)
	and c.dt_prescricao between( LOCALTIMESTAMP - interval '1000 days' ) and ( LOCALTIMESTAMP + interval '1 days' )
	and c.dt_suspensao is null
	and a.dt_suspensao is null
	and exists ( select 1
				   from regra_consiste_prescr d
				  where b.nr_regra = d.nr_sequencia
					and coalesce(ie_exibe_farmacia, 'S') = 'S' )

union all

select
	a.nr_sequencia,
	substr(obter_desc_material(a.cd_material), 1, 255) ds_material,
	'',
	substr(obter_descricao_padrao('RISCO_MEDICAMENTO', 'DS_RISCO', c.nr_seq_risco), 1, 255),
	substr(obter_um_dosagem_prescr(a.nr_prescricao, a.nr_sequencia), 1, 100) ds_dose_intervalo,
	substr(a.ds_justificativa, 1, 255) ds_justificativa,
	substr(c.ds_observacao, 1, 255) ds_observacao,
	substr(c.ds_orientacao, 1, 255) ds_orientacao,
	d.dt_prescricao,
	'' ds_incons_farmacia,
	d.nr_prescricao,
	coalesce(e.ie_ciente, 'N') ie_ciente,
	'',
	TO_CHAR(a.cd_material) cd_material,
	d.nr_atendimento,
	d.cd_pessoa_fisica,
	'F' ie_tipo_perfil,
	'N' ie_cpoe,
	'N' ie_quimio,
    e.dt_confirmacao,
    e.nm_usuario_ciente,
	a.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	prescr_medica		d,
	prescr_material		a,
	medicamento_risco	c,
	prescr_medica_risco	e
where
	a.cd_material = c.cd_material
	and d.nr_prescricao = a.nr_prescricao
    and e.nr_prescricao = a.nr_prescricao
	and e.nr_seq_risco = c.nr_sequencia
	and a.ie_agrupador in (1, 5)
	and d.dt_suspensao is null
	and a.dt_suspensao is null
	and coalesce(c.ie_nao_conformidade, 'N') = 'S'
	and d.dt_prescricao between( LOCALTIMESTAMP - interval '1000 days' ) and ( LOCALTIMESTAMP + interval '1 days' )
	and coalesce(c.ie_situacao, 'A') = 'A'

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from	
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_material) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_material
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)	

union all
 
select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp1) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp1
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)	

union all
 
select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp2) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp2
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)	

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp3) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp3
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)	

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp4) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp4
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)	

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp5) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp5
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp6) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp6		
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)

union all

select 
	b.nr_sequencia,
	substr(obter_desc_material(b.cd_item), 1, 255) ds_material,
	'S' ie_libera,
	cpoe_obter_just_item(
		'E',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_erro_compl,
	substr(obter_um_dosagem_prescr(c.nr_prescricao, c.nr_sequencia), 1, 100) ds_dose_intervalo,
	cpoe_obter_just_item(
		'M',
		b.ie_duplicado,
		b.ds_just_duplicado,
		b.ie_interacao_medic,
		b.ds_just_interacao_medic,
		b.ie_nao_padronizado,
		b.ds_just_nao_padronizado,
		b.ie_alergia,
		b.ds_just_alergia,
		b.ie_dose_limite,
		b.ds_just_dose_limite,
		b.ie_via_nao_recomendada,
		b.ds_just_via_nao_recom,
		b.ie_interacao_dieta,
		b.ds_just_interacao_dieta,
		b.ie_permite_lactante,
		b.ds_justificativa_lactante,
		b.ie_dose_minima,
		b.ds_just_dose_minima,
		b.ie_exame_lab,
		b.ds_exame_lab,
		b.ie_especialidade_medica,
		b.ds_just_especialidade_med,
		b.ie_permite_dil,
		b.ds_justificativa_dil,
		b.ie_latex,
		b.ds_just_latex,
		'S',
		b.ie_intolerancia,
		b.ds_just_intolerancia) ds_justificativa,
	'' ds_observacao,
	'' ds_orientacao,
	a.dt_atualizacao_nrec dt_prescricao,
	'' ds_incons_farmacia,
	cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento) nr_prescricao,
	coalesce(b.ie_ciente, 'N') ie_ciente,
	'' ds_motivo,
	b.cd_item cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	'A' ie_tipo_perfil,
	'S' ie_cpoe,
	'N' ie_quimio,
    b.dt_confirmacao,
    b.nm_usuario_ciente,
	c.nr_seq_mat_cpoe,
	'T' ie_origem_informacao,
	obter_desc_expressao(314318) ds_origem_informacao
from
	cpoe_material 			a,
	cpoe_justificativa_item b,
	prescr_material 		c
where
	a.nr_sequencia = b.nr_seq_material
	and to_char(a.cd_mat_comp7) = b.cd_item
	and c.nr_seq_mat_cpoe = a.nr_sequencia				
	and c.nr_prescricao = cpoe_obter_prescr_original(a.nr_sequencia, 'M', a.nr_atendimento)
	and c.cd_material = a.cd_mat_comp7
	and (a.dt_lib_suspensao is null or a.dt_suspensao > LOCALTIMESTAMP)
/* INTEGRACAO*/

union all

select 
	a.nr_sequencia,
	a.ds_material,
	a.ie_libera,
	a.ds_erro_compl,
	a.ds_dose_intervalo,
	a.ds_justificativa,
	a.ds_observacao,
	a.ds_orientacao,
	a.dt_prescricao,
	a.ds_incons_farmacia,
	a.nr_prescricao,
	a.ie_ciente,
	a.ds_motivo,
	a.cd_material,
	a.nr_atendimento,
	a.cd_pessoa_fisica,
	a.ie_tipo_perfil,
	a.ie_cpoe,
	a.ie_quimio,
	a.dt_confirmacao,
	a.nm_usuario_ciente,
	a.nr_seq_mat_cpoe,
	a.ie_origem_informacao,
	a.ds_origem_informacao
from	
	gpt_nao_conformid_interacao_v a

union all

select	f.nr_sequencia,
		substr(obter_desc_material(a.cd_material), 1, 255) ds_material,
		'S' ie_libera,
		(select max(g.ds_regra) from regra_consiste_onc g where g.nr_sequencia = f.nr_seq_regra) ds_erro_compl,
		substr(obter_um_dosagem_prescr(a.nr_prescricao, a.nr_sequencia), 1, 100) ds_dose_intervalo,
		substr(f.ds_justif_incons_quimio, 1, 255) ds_justificativa,
		null ds_observacao,
		null ds_orientacao,
		b.dt_prescricao,
		null ds_incons_farmacia,
		b.nr_prescricao,
		coalesce(f.ie_ciente, 'N') ie_ciente,
		f.ds_motivo,
		to_char(a.cd_material) cd_material,
		b.nr_atendimento,
		b.cd_pessoa_fisica,
		'F' ie_tipo_perfil,
		'N' ie_cpoe,
		'S' ie_quimio,
		f.dt_atualizacao_nrec,
		f.nm_usuario,
		a.nr_seq_mat_cpoe,
		'T' ie_origem_informacao,
		obter_desc_expressao(314318) ds_origem_informacao
from	prescr_material a,
		prescr_medica b,
		paciente_setor c,
		paciente_atendimento d,
		paciente_atend_medic e,
		paciente_atend_erro_just f
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = d.nr_prescricao
and		d.nr_seq_paciente = c.nr_seq_paciente
and		d.nr_seq_atendimento = e.nr_seq_atendimento
and		a.nr_seq_atend_medic = e.nr_seq_interno
and		f.nr_seq_material = e.nr_seq_material
and		f.nr_seq_paciente = c.nr_seq_paciente
and		f.nr_seq_paciente = d.nr_seq_paciente
and		f.nr_seq_paciente = e.nr_seq_paciente
and		f.nr_seq_atendimento is null
and		a.dt_suspensao is null
and		b.dt_suspensao is null

union all

select	e.nr_sequencia,
		substr(obter_desc_material(a.cd_material), 1, 255) ds_material,
		'S' ie_libera,
		(select max(f.ds_regra) from regra_consiste_onc f where f.nr_sequencia = e.nr_seq_regra) ds_erro_compl,
		substr(obter_um_dosagem_prescr(a.nr_prescricao, a.nr_sequencia), 1, 100) ds_dose_intervalo,
		substr(e.ds_justif_incons_quimio, 1, 255) ds_justificativa,
		null ds_observacao,
		null ds_orientacao,
		b.dt_prescricao,
		null ds_incons_farmacia,
		b.nr_prescricao,
		coalesce(e.ie_ciente, 'N') ie_ciente,
		e.ds_motivo,
		to_char(a.cd_material) cd_material,
		b.nr_atendimento,
		b.cd_pessoa_fisica,
		'F' ie_tipo_perfil,
		'N' ie_cpoe,
		'S' ie_quimio,
		e.dt_atualizacao_nrec,
		e.nm_usuario,
		a.nr_seq_mat_cpoe,
		'T' ie_origem_informacao,
		obter_desc_expressao(314318) ds_origem_informacao
from	prescr_material a,
		prescr_medica b,
		paciente_atendimento c,
		paciente_atend_medic d,
		paciente_atend_erro_just e
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = c.nr_prescricao
and		c.nr_seq_atendimento = d.nr_seq_atendimento
and		a.nr_seq_atend_medic = d.nr_seq_interno
and		e.nr_seq_atendimento = c.nr_seq_atendimento
and		e.nr_seq_atendimento = d.nr_seq_atendimento
and		e.nr_seq_material = d.nr_seq_material
and		e.nr_seq_paciente is null
and		a.dt_suspensao is null
and		b.dt_suspensao is null;

