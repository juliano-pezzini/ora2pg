-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_interface_mens_trevel_v (vg_competencia, cd_geracao, cd_documento, sg_lanc_crb, cd_unimed, cd_empresa, cr_lancam, ds_item, tp_debcre, nr_matricula, tp_dependencia, nm_pessoa, dt_servico, ds_procedimento, nm_executor, nm_usuario, vl_cobranca) AS select	VG_COMPETENCIA,
	cd_geracao, 
	cd_documento, 
	sg_lanc_crb, 
	cd_unimed, 
	cd_empresa, 
	cr_lancam, 
	ds_item, 
	TP_DEBCRE, 
	nr_matricula, 
	tp_dependencia, 
	substr(nm_pessoa,1,80) nm_pessoa, 
	dt_servico, 
	ds_procedimento, 
	NM_EXECUTOR, 
	nm_usuario, 
	replace(vl_cobranca,',','.') vl_cobranca 
FROM (	select	dt_vigencia VG_COMPETENCIA, 
			cd_geracao, 
			cd_documento, 
			sg_lanc_crb, 
			cd_unimed, 
			cd_empresa, 
			cr_lancam, 
			ds_item, 
			TP_DEBCRE, 
			nr_matricula, 
			tp_dependencia, 
			substr(nm_pessoa,1,80) nm_pessoa, 
			dt_servico, 
			ds_procedimento, 
			NM_EXECUTOR, 
			nm_usuario, 
			sum(vl_cobranca) vl_cobranca 
		from (	select	b.dt_mesano_referencia dt_vigencia, 
					c.nr_seq_lote cd_geracao, 
					h.nr_titulo cd_documento, 
					a.nr_sequencia sg_lanc_crb, 
					'242' cd_unimed, 
					a.CD_OPERADORA_EMPRESA cd_empresa, 
					d.ie_tipo_item cr_lancam, 
					substr(obter_valor_dominio(1930,d.ie_tipo_item),1,255) ds_item, 
					CASE WHEN d.ie_tipo_item=14 THEN 'D'  ELSE 'C' END  tp_debcre, 
					a.cd_matricula_estipulante nr_matricula, 
					CASE WHEN a.nr_seq_titular IS NULL THEN 0  ELSE (	select	x.cd_ptu 										from	grau_parentesco	x 										where	x.nr_sequencia	= a.nr_seq_parentesco) END  tp_dependencia, 
					i.nm_pessoa_fisica nm_pessoa, 
					null dt_servico, 
					' ' ds_procedimento, 
					' ' nm_executor, 
					g.nm_usuario nm_usuario, 
					SUM(d.vl_item) vl_cobranca 
				from	pessoa_fisica			i, 
					PLS_SEGURADO 			a, 
					titulo_receber			h, 
					pls_mensalidade_segurado 	b, 
					pls_mensalidade_seg_item	d, 
					PLS_MENSALIDADE			C, 
					W_PLS_INTERFACE_MENS		g 
				where	i.cd_pessoa_fisica		= a.cd_pessoa_fisica 
				and	b.nr_seq_segurado		= a.nr_sequencia 
				and	b.nr_seq_mensalidade		= c.nr_sequencia 
				and	d.nr_seq_mensalidade_seg	= b.nr_sequencia 
				and	G.NR_SEQ_MENSALIDADE_SEG	= B.NR_SEQUENCIA 
				and	h.nr_seq_mensalidade		= c.nr_sequencia 
				and	d.ie_tipo_item			<> 3 
				group by b.dt_mesano_referencia, 
					c.nr_seq_lote, 
					h.nr_titulo, 
					a.cd_matricula_estipulante, 
					a.CD_OPERADORA_EMPRESA, 
					d.ie_tipo_item, 
					a.nr_seq_titular, 
					a.nr_seq_parentesco, 
					i.nm_pessoa_fisica, 
					g.nm_usuario, 
					a.NR_SEQUENCIA) alias8 
		group by dt_vigencia, 
			cd_geracao, 
			cd_documento, 
			sg_lanc_crb, 
			cd_unimed, 
			cd_empresa, 
			cr_lancam, 
			ds_item, 
			TP_DEBCRE, 
			nr_matricula, 
			tp_dependencia, 
			nm_pessoa, 
			DT_SERVICO, 
			nm_executor, 
			DS_PROCEDIMENTO, 
			nm_usuario 
		
union all
 
		select	dt_vigencia VG_COMPETENCIA, 
			cd_geracao, 
			cd_documento, 
			sg_lanc_crb, 
			cd_unimed, 
			cd_empresa, 
			cr_lancam, 
			ds_item, 
			TP_DEBCRE, 
			nr_matricula, 
			tp_dependencia, 
			substr(nm_pessoa,1,80) nm_pessoa, 
			TO_CHAR(DT_SERVICO,'dd/mm/yyyy') DT_SERVICO, 
			substr(nm_executor,1,255) nm_executor, 
			SUBSTR(DS_PROCEDIMENTO,1,255) DS_PROCEDIMENTO, 
			nm_usuario, 
			sum(vl_coparticipacao) vl_cobranca 
		from (	select	b.dt_mesano_referencia dt_vigencia, 
					c.nr_seq_lote cd_geracao, 
					h.nr_titulo cd_documento, 
					a.nr_sequencia sg_lanc_crb, 
					'242' cd_unimed, 
					a.CD_OPERADORA_EMPRESA cd_empresa, 
					'3' cr_lancam, 
					'Coparticipação' ds_item, 
					'C' tp_debcre, 
					a.cd_matricula_estipulante nr_matricula, 
					CASE WHEN a.nr_seq_titular IS NULL THEN 0  ELSE (	select	x.cd_ptu 										from	grau_parentesco	x 										where	x.nr_sequencia	= a.nr_seq_parentesco) END  tp_dependencia, 
					i.nm_pessoa_fisica nm_pessoa, 
					trunc(d.dt_emissao,'dd') dt_servico, 
					coalesce(substr(pls_obter_dados_conta_proc(e.nr_seq_conta_proc,'D'),1,255),substr(pls_obter_dados_conta_mat(e.nr_seq_conta_mat,'D'),1,255)) ds_procedimento, 
					substr(obter_nome_medico(d.cd_medico_executor,'N'),1,255) nm_executor, 
					g.nm_usuario nm_usuario, 
					SUM(E.VL_COPARTICIPACAO) VL_COPARTICIPACAO 
				from	pessoa_fisica			i, 
					PLS_SEGURADO 			a, 
					PLS_CONTA_COPARTICIPACAO	E, 
					titulo_receber			h, 
					pls_conta			d, 
					PLS_MENSALIDADE			C, 
					pls_mensalidade_segurado 	b, 
					W_PLS_INTERFACE_MENS		g 
				where	i.cd_pessoa_fisica		= a.cd_pessoa_fisica 
				and	d.nr_seq_segurado		= a.nr_sequencia 
				and	b.nr_seq_segurado		= a.nr_sequencia 
				and	b.nr_seq_mensalidade		= c.nr_sequencia 
				and	e.nr_seq_conta			= d.nr_sequencia 
				and	E.NR_SEQ_MENSALIDADE_SEG	= B.NR_SEQUENCIA 
				and	G.NR_SEQ_MENSALIDADE_SEG	= B.NR_SEQUENCIA 
				and	H.NR_SEQ_MENSALIDADE		= C.NR_SEQUENCIA 
				group by b.dt_mesano_referencia, 
					c.nr_seq_lote, 
					h.nr_titulo, 
					a.cd_matricula_estipulante, 
					a.CD_OPERADORA_EMPRESA, 
					d.DT_EMISSAO, 
					e.nr_seq_conta_proc, 
					e.nr_seq_conta_mat, 
					a.nr_seq_titular, 
					a.nr_seq_parentesco, 
					d.cd_medico_executor, 
					i.nm_pessoa_fisica, 
					g.nm_usuario, 
					a.nr_sequencia) alias24 
		group by dt_vigencia, 
			cd_geracao, 
			cd_documento, 
			sg_lanc_crb, 
			cd_unimed, 
			cd_empresa, 
			cr_lancam, 
			ds_item, 
			TP_DEBCRE, 
			nr_matricula, 
			tp_dependencia, 
			nm_pessoa, 
			DT_SERVICO, 
			NM_EXECUTOR, 
			DS_PROCEDIMENTO, 
			nm_usuario) alias25 
order by nm_pessoa,cr_lancam;

