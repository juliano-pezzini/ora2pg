-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_campinas_hosp_v (tp_registro, tp_arquivo, cd_local_prestador, tp_local, mes_ano_producao, dt_recebimento, nr_seq_grade, dt_entrega_unimed, nr_unimed, ds_espacos, ds_complemento, nr_seq_protocolo, nr_interno_conta, dt_entrada, cd_autorizacao, cd_usuario_convenio, tp_servico, cd_servico, qt_item, vl_item, cd_cid_principal, cd_cid_secundario, cd_solicitante, cd_executante, ie_via_acesso, ie_partic_medica, ie_internado, ie_atend_urgencia, ie_acidente, nm_paciente, ie_sexo, ie_estado_civil, dt_nascimento, nr_cpf_rne, tp_origem_usuario, cd_origem_usuario, ds_nacionalidade, dt_internacao, dt_alta, tp_alta, ie_ordem) AS select	/* CabeÃ§alho */
	1				tp_registro, 
	'AH'				tp_arquivo, 
	substr(coalesce(cd_interno,'UNCPXXXX'),1,8) cd_local_prestador, 
	21				tp_local, 
	dt_inicio_protocolo		mes_ano_producao, 
	LOCALTIMESTAMP				dt_recebimento, 
	nr_remessa			nr_seq_grade, 
	LOCALTIMESTAMP				dt_entrega_unimed, 
	' '				nr_unimed, 
	' '				ds_espacos,	 
	substr(nm_hospital,1,40)	ds_complemento, 
	nr_seq_protocolo		nr_seq_protocolo, 
	0				nr_interno_conta, 
	LOCALTIMESTAMP				dt_entrada, 
	' '				cd_autorizacao, 
	' '				cd_usuario_convenio, 
	0				tp_servico, 
	' '				cd_servico, 
	0				qt_item, 
	0				vl_item, 
	' '				cd_cid_principal, 
	' '				cd_cid_secundario, 
	' ' 				cd_solicitante, 
	' ' 				cd_executante, 
	' '				ie_via_acesso, 
	0				ie_partic_medica, 
	' '				ie_internado, 
	' '				ie_atend_urgencia, 
	0				ie_acidente, 
	' '				nm_paciente, 
	' '				ie_sexo, 
	0				ie_estado_civil, 
	0				dt_nascimento, 
	' '				nr_cpf_rne, 
	0				tp_origem_usuario, 
	' '				cd_origem_usuario, 
	' '				ds_nacionalidade, 
	LOCALTIMESTAMP				dt_internacao, 
	LOCALTIMESTAMP				dt_alta,	 
	0				tp_alta, 
	0				ie_ordem 
FROM 	w_interf_conta_header 

union
 
select	/* Movimento */
 
	2				tp_registro, 
	'AH'				tp_arquivo, 
	'UNCPXXXX'			cd_local_prestador, 
	0				tp_local, 
	LOCALTIMESTAMP				mes_ano_producao, 
	LOCALTIMESTAMP				dt_recebimento, 
	0				nr_seq_grade, 
	LOCALTIMESTAMP				dt_entrega_unimed, 
	' '				nr_unimed, 
	' '				ds_espacos, 
	' '				ds_complemento, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	a.nr_interno_conta		nr_interno_conta, 
	max(a.dt_entrada)		dt_entrada, 
	substr(somente_numero(a.nr_doc_convenio),1,11)	cd_autorizacao, 
	substr(a.cd_usuario_convenio,1,17) cd_usuario_convenio, 
	CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END  tp_servico, 
	substr(b.cd_item_convenio,1,8)	cd_servico, 
	sum(b.qt_item)			qt_item, 
	sum(b.vl_total_item)		vl_item, 
	a.cd_cid_principal		cd_cid_principal, 
	a.cd_cid_secundario		cd_cid_secundario, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null, null, null, null,null, null,null,null), a.cd_medico_resp),1,6) 
					cd_solicitante, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null, null, null, null,null, null,null,null), a.cd_medico_resp),1,6) 
					cd_executante, 
	'1' 				ie_via_acesso, 
	0				ie_partic_medica, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END  ie_internado, 
	CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END  ie_atend_urgencia, 
	obter_acidente_tiss_atend(a.nr_atendimento) ie_acidente, 
	' '				nm_paciente, 
	' '				ie_sexo, 
	0				ie_estado_civil, 
	0				dt_nascimento, 
	' '				nr_cpf_rne, 
	0				tp_origem_usuario, 
	' '				cd_origem_usuario, 
	' '				ds_nacionalidade, 
	max(a.dt_entrada)		dt_internacao, 
	max(a.dt_alta)			dt_alta,	 
	a.cd_motivo_alta		tp_alta, 
	CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  ie_ordem 
from 	w_interf_conta_cab	a,	 
	w_interf_conta_item 	b 
where	a.nr_interno_conta = b.nr_interno_conta 
and 	somente_numero(coalesce(b.ie_emite_conta,0)) in (51,52,53,72,74,75,98) 
group by 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	substr(somente_numero(a.nr_doc_convenio),1,11), 
	substr(a.cd_usuario_convenio,1,17), 
	CASE WHEN somente_numero(b.ie_emite_conta)=51 THEN 4 WHEN somente_numero(b.ie_emite_conta)=52 THEN 4 WHEN somente_numero(b.ie_emite_conta)=53 THEN 5 WHEN somente_numero(b.ie_emite_conta)=72 THEN 6 WHEN somente_numero(b.ie_emite_conta)=74 THEN 7 WHEN somente_numero(b.ie_emite_conta)=75 THEN 2  ELSE 8 END , 
	substr(b.cd_item_convenio,1,8), 
	a.cd_cid_principal, 
	a.cd_cid_secundario, 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null, null, null, null, null, null,null,null), a.cd_medico_resp),1,6), 
	'   ' || substr(coalesce(obter_medico_convenio(obter_estab_atend(a.nr_atendimento),a.cd_paciente,a.cd_convenio, null, null, null, null, null, null,null,null), a.cd_medico_resp),1,6), 
	CASE WHEN a.ie_tipo_atendimento=1 THEN 'S'  ELSE 'N' END , 
	CASE WHEN coalesce(a.ie_carater_inter,'U')='U' THEN 'S'  ELSE 'N' END , 
	obter_acidente_tiss_atend(a.nr_atendimento), 
	a.cd_motivo_alta, 
	CASE WHEN somente_numero(coalesce(b.ie_emite_conta,0))=74 THEN 1 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=72 THEN 2 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=75 THEN 3 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=53 THEN 4 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=52 THEN 5 WHEN somente_numero(coalesce(b.ie_emite_conta,0))=51 THEN 6  ELSE 7 END  
having	sum(b.qt_item) > 0;

