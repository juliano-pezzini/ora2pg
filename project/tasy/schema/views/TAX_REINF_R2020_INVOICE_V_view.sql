-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tax_reinf_r2020_invoice_v (tpservico, nr_seq_reinf, nr_seq_nota, vlrretencao, vlrbaseret, vlrnretprinc, vlrservicos15, vlrservicos20, vlrservicos25, vlradicional) AS select  tpservico,
          nr_seq_reinf,
          nr_seq_nota,
          campo_mascara_casas(sum(vlrRetencao), 2) vlrRetencao,
          campo_mascara_casas(sum(vlrBaseRet), 2) vlrBaseRet, 
          campo_mascara_casas(sum(vlrNRetPrinc), 2) vlrNRetPrinc,
          campo_mascara_casas(sum(vlrServicos15), 2) vlrServicos15,
          campo_mascara_casas(sum(vlrServicos20), 2) vlrServicos20,
          campo_mascara_casas(sum(vlrServicos25), 2) vlrServicos25,
          campo_mascara_casas(sum(vlrAdicional), 2) vlrAdicional 
  FROM    (
            select  ie_tipo_servico tpservico, 
                    fr.nr_sequencia nr_seq_reinf,
                    i.nr_sequencia nr_seq_nota,
                    (t.vl_base_calculo * 0.11) vlrRetencao,
                    t.vl_base_calculo vlrBaseRet,
                    CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END  vlrNRetPrinc,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 6) vlrServicos15,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 7) vlrServicos20,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 8) vlrServicos25,
                    (fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 2) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 3) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 4)) vlrAdicional
            from    nota_fiscal_trib t,
                    material_fiscal m,
                    nota_fiscal_item i,
                    fis_reinf_r2020 fr,
                    fis_reinf_notas_r2020 n
            where   t.nr_sequencia = i.nr_sequencia 
            and     n.nr_seq_nota = i.nr_sequencia
            and     m.cd_material = i.cd_material 
            and     fr.cd_tributo = t.cd_tributo
            and     t.vl_tributo <> 0
            group by  ie_tipo_servico,
                      fr.nr_sequencia,
                      i.nr_sequencia,
                      (t.vl_base_calculo * 0.11),
                      t.vl_base_calculo, 
                      CASE WHEN obter_se_possui_processo(n.nr_seq_nota,fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END ,
                      t.tx_tributo,
                      t.vl_base_calculo                   
            
union

            select  ie_tipo_servico tpservico, 
                    fr.nr_sequencia nr_seq_reinf,
                    i.nr_sequencia nr_seq_nota, 
                    (t.vl_base_calculo * 0.11) vlrRetencao,
                    sum(t.vl_base_calculo) vlrBaseRet,
                    CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END  vlrNRetPrinc,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 6) vlrServicos15,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 7) vlrServicos20,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 8) vlrServicos25,
                    (fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 2) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 3) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 4)) vlrAdicional
            from    nota_fiscal_item_trib t,
                    material_fiscal m,
                    nota_fiscal_item i,
                    fis_reinf_r2020 fr,
                    fis_reinf_notas_r2020 n
            where   m.cd_material = i.cd_material 
            and     i.nr_item_nf = t.nr_item_nf 
            and     i.nr_sequencia = t.nr_sequencia  
            and     fr.cd_tributo = t.cd_tributo 
            and     n.nr_seq_nota = i.nr_sequencia	
            and     t.vl_tributo <> 0
            group by  ie_tipo_servico,
                      fr.nr_sequencia,
                      i.nr_sequencia,
                      (t.vl_base_calculo * 0.11),
                      t.vl_base_calculo, 
                      CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END ,
                      t.tx_tributo,
                      t.vl_base_calculo    
            
union

            select  ie_tipo_servico  tpservico, 
                    fr.nr_sequencia nr_seq_reinf,
                    i.nr_sequencia nr_seq_nota,
                    (t.vl_base_calculo * 0.11) vlrRetencao,
                    t.vl_base_calculo vlrBaseRet,
                    CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END  vlrNRetPrinc,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 6) vlrServicos15,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 7) vlrServicos20,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 8) vlrServicos25,
                    (fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 2) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 3) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 4)) vlrAdicional
            from    nota_fiscal_trib t, 
                    procedimento_fiscal pf,
                    nota_fiscal_item i,
                    fis_reinf_r2020 fr,
                    fis_reinf_notas_r2020 n
            where   t.nr_sequencia = i.nr_sequencia 
            and     n.nr_seq_nota = i.nr_sequencia
            and     pf.cd_procedimento = i.cd_procedimento 
            and     fr.cd_tributo = t.cd_tributo       
            and     t.vl_tributo <> 0                  
            group by  ie_tipo_servico,
                      fr.nr_sequencia,
                      i.nr_sequencia,
                      (t.vl_base_calculo * 0.11),
                      t.vl_base_calculo, 
                      CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END ,
                      t.tx_tributo,
                      t.vl_base_calculo
            
union

            select  ie_tipo_servico tpservico, 
                    fr.nr_sequencia nr_seq_reinf,
                    i.nr_sequencia nr_seq_nota,
                    (t.vl_base_calculo * 0.11) vlrretencao, 
                    sum(t.vl_base_calculo) vlrbaseret,
                    CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END  vlrNRetPrinc,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 6) vlrServicos15,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 7) vlrServicos20,
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 8) vlrServicos25,
                    (fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 2) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 3) +
                    fis_obter_valor_apo_esp_2010(t.tx_tributo, t.vl_base_calculo, 4)) vlrAdicional
            from    nota_fiscal_item_trib t,
                    procedimento_fiscal pf,
                    nota_fiscal_item i,
                    fis_reinf_r2020 fr,
                    fis_reinf_notas_r2020 n
            where   pf.cd_procedimento = i.cd_procedimento 
            and     i.nr_item_nf = t.nr_item_nf 
            and     i.nr_sequencia = t.nr_sequencia 
            and     fr.cd_tributo = t.cd_tributo 
            and     n.nr_seq_nota = i.nr_sequencia  
            and     t.vl_tributo <> 0 
            group by  ie_tipo_servico,
                      fr.nr_sequencia,
                      i.nr_sequencia,
                      (t.vl_base_calculo * 0.11),     
                      CASE WHEN obter_se_possui_processo(n.nr_seq_nota, fr.nr_sequencia, '2020')='S' THEN  t.vl_tributo  ELSE 0 END ,
                      t.tx_tributo,
                      t.vl_base_calculo
          ) alias60
  group by  tpservico,
            nr_seq_reinf,
            nr_seq_nota;

