-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rel_c_beta_bloqueador_v (nr_cirurgia, dt_inicio_cirurgia, dt_termino_cirurgia, nr_atendimento, cd_setor_atendimento, cd_pessoa_fisica, cd_medico_cirurgiao, cd_procedimento_princ, ie_origem_proced, conforme, nao_conforme) AS SELECT DISTINCT NR_CIRURGIA,
       DT_INICIO_CIRURGIA,
       DT_TERMINO_CIRURGIA,
       NR_ATENDIMENTO,
       CD_SETOR_ATENDIMENTO,
       CD_PESSOA_FISICA,
       CD_MEDICO_CIRURGIAO,
       CD_PROCEDIMENTO_PRINC,
       IE_ORIGEM_PROCED,
       SUM(CONFORME) CONFORME,
       SUM(NAO_CONFORME) NAO_CONFORME
  FROM (
        SELECT DISTINCT CIR.NR_CIRURGIA,
               CIR.DT_INICIO_REAL DT_INICIO_CIRURGIA,
               CIR.DT_TERMINO DT_TERMINO_CIRURGIA,
               CIR.NR_ATENDIMENTO,
               CIR.CD_SETOR_ATENDIMENTO,
               CIR.CD_PESSOA_FISICA,
               CIR.CD_MEDICO_CIRURGIAO,
               CIR.CD_PROCEDIMENTO_PRINC,
               CIR.IE_ORIGEM_PROCED,
               CASE WHEN(PMA.DT_ATUALIZACAO - CIR.DT_INICIO_REAL)*24 BETWEEN 0 AND 24 THEN 1 ELSE 0 END CONFORME,
               CASE WHEN(PMA.DT_ATUALIZACAO - CIR.DT_INICIO_REAL)*24 > 24 THEN 1 ELSE 0 END NAO_CONFORME
          FROM CIRURGIA CIR
         INNER JOIN PRESCR_MEDICA PME
            ON CIR.NR_ATENDIMENTO = PME.NR_ATENDIMENTO
         INNER JOIN PRESCR_MATERIAL PRM
            ON PRM.NR_PRESCRICAO = PME.NR_PRESCRICAO
         INNER JOIN PRESCR_MAT_ALTERACAO PMA
            ON PRM.NR_PRESCRICAO = PMA.NR_PRESCRICAO
         INNER JOIN MATERIAL MAT
            ON MAT.CD_MATERIAL = PRM.CD_MATERIAL
           AND MAT.CD_CLASSE_MATERIAL IN(
                SELECT CD_CLASSE_MATERIAL
                  FROM CLASSE_MATERIAL
                 WHERE IE_CLASSE_MATERIAL_REL = 5
               )
        WHERE PMA.DT_ATUALIZACAO < CIR.DT_INICIO_REAL

UNION

       SELECT DISTINCT CIR.NR_CIRURGIA,
              coalesce(CIR.DT_INICIO_REAL,
              CIR.DT_INICIO_PREVISTA) DT_INICIO_CIRURGIA,
              coalesce(CIR.DT_TERMINO, CIR.DT_TERMINO_PREVISTA) DT_TERMINO_CIRURGIA,
              CIR.NR_ATENDIMENTO,
              CIR.CD_SETOR_ATENDIMENTO,
              CIR.CD_PESSOA_FISICA,
              CIR.CD_MEDICO_CIRURGIAO,
              CIR.CD_PROCEDIMENTO_PRINC,
              CIR.IE_ORIGEM_PROCED,
              CASE WHEN(CAO.DT_INICIO_ADM - CIR.DT_INICIO_REAL)*24 BETWEEN 0 AND 24 THEN 1 ELSE 0 END CONFORME,
              CASE WHEN(CAO.DT_INICIO_ADM - CIR.DT_INICIO_REAL)*24 > 24 THEN 1 ELSE 0 END NAO_CONFORME
         FROM CIRURGIA CIR
        INNER JOIN CIRURGIA_AGENTE_ANESTESICO CAA
           ON CAA.NR_CIRURGIA = CIR.NR_CIRURGIA
          AND CAA.IE_SITUACAO = 'A'
        INNER JOIN CIRURGIA_AGENTE_ANEST_OCOR CAO
           ON CAO.NR_SEQ_CIRUR_AGENTE = CAA.NR_SEQUENCIA
          AND CAO.DT_FINAL_ADM IS NOT NULL
          AND CAO.IE_SITUACAO = 'A'
        WHERE CAO.DT_INICIO_ADM > coalesce(CIR.DT_INICIO_REAL, CIR.DT_INICIO_PREVISTA)
          AND OBTER_CLASSE_MATERIAL(CAA.CD_MATERIAL) IN (
                SELECT CD_CLASSE_MATERIAL
                  FROM CLASSE_MATERIAL
                 WHERE IE_CLASSE_MATERIAL_REL = 5
               )
     ) alias12
 GROUP BY NR_CIRURGIA,
          NR_ATENDIMENTO,
          CD_SETOR_ATENDIMENTO,
          CD_PESSOA_FISICA,
          CD_MEDICO_CIRURGIAO,
          DT_INICIO_CIRURGIA,
          DT_TERMINO_CIRURGIA,
          CD_PROCEDIMENTO_PRINC,
          IE_ORIGEM_PROCED;

