-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW export_nursing_submission_v (evaluation_date, departament, room_number, bed, patient_id, patient_name, gender, date_of_birth, medical_con_departament_code, medical_con_departament_name, hospitalization_date, time_patient_hospitalization, discharge_date, time_of_discharge, team, group_code, item_code, item_name, option_code, option_name, score, total_a_score, total_b_score, total_c_score, judgment, judgment_1, judgment_2, judgment_3, ds_addition_comprehensive, data_referencia) AS SELECT
    coalesce(TO_CHAR(a.DT_AVALIACAO, 'YYYY-MM-DD'),'00000000') EVALUATION_DATE,
    cd_setor_usuario_atend DEPARTAMENT,
    g.cd_unidade_basica  ROOM_NUMBER,
    g.cd_unidade_compl BED,
    b.CD_PESSOA_FISICA PATIENT_ID,
    c.nm_pessoa_fisica PATIENT_NAME,
    c.ie_sexo GENDER,
    coalesce(TO_CHAR(c.DT_NASCIMENTO, 'YYYY-MM-DD'),'00000000') DATE_OF_BIRTH,
    OBTER_DEPARTAMENTO_SETOR(cd_setor_usuario_atend) MEDICAL_CON_DEPARTAMENT_CODE,
    OBTER_NOME_DEPART_POR_SETOR(cd_setor_usuario_atend) MEDICAL_CON_DEPARTAMENT_NAME,
    coalesce(TO_CHAR(b.dt_entrada, 'YYYY-MM-DD'),'00000000') HOSPITALIZATION_DATE,
    TO_CHAR(b.dt_entrada, 'HH:MI:SS') TIME_PATIENT_HOSPITALIZATION,
    coalesce(TO_CHAR(b.dt_alta, 'YYYY-MM-DD'),'00000000') DISCHARGE_DATE,
    TO_CHAR(b.dt_alta, 'HH:MI:SS') TIME_OF_DISCHARGE,
    obter_time_atend(b.NR_ATENDIMENTO) TEAM,
    e.NR_SEQ_CLASSIFICACAO GROUP_CODE,
    e.CD_PAYLOAD ITEM_CODE,
    e.DS_ITEM ITEM_NAME,
    f.NR_SEQ_APRES OPTION_CODE,
    f.DS_RESULTADO OPTION_NAME,
    SUM(a.QT_PONTUACAO_A + a.QT_PONTUACAO_B + a.QT_PONTUACAO_C) SCORE,
    SUM(a.QT_PONTUACAO_A) TOTAL_A_SCORE,
    SUM(a.QT_PONTUACAO_B) TOTAL_B_SCORE,
    SUM(a.QT_PONTUACAO_C) TOTAL_C_SCORE,
    RETORNA_CRITERIO_ATENDIMENTO(b.NR_ATENDIMENTO,1,a.NR_SEQUENCIA) JUDGMENT,
    RETORNA_CRITERIO_ATENDIMENTO(b.NR_ATENDIMENTO,2,a.NR_SEQUENCIA) JUDGMENT_1,
    '' JUDGMENT_2,
    '' JUDGMENT_3,
    CASE WHEN SUM(a.QT_PONTUACAO_A) > 0 and SUM(a.QT_PONTUACAO_B) > 0 AND h.IE_TIPO_FORMULARIO = 'G' THEN 'Yes' END  DS_ADDITION_COMPREHENSIVE,
    b.dt_entrada DATA_REFERENCIA
FROM  NURSING_CARE_ENCOUNTER a
INNER JOIN ATENDIMENTO_PACIENTE b ON
    b.NR_ATENDIMENTO = a.NR_ATENDIMENTO
INNER JOIN PESSOA_FISICA c ON
    c.CD_PESSOA_FISICA = b.CD_PESSOA_FISICA
INNER JOIN nursing_care_enc_result d ON
    d.nr_seq_avaliacao = a.nr_sequencia
INNER JOIN nursing_care_item e ON
    e.NR_SEQUENCIA = d.nr_seq_item
INNER JOIN nursing_care_result f ON
    f.NR_SEQUENCIA = d.nr_seq_item_result AND
    f.nr_seq_item  = d.nr_seq_item
LEFT JOIN unidade_atendimento g ON
    g.NR_ATENDIMENTO = b.NR_ATENDIMENTO
INNER JOIN nursing_care_version h ON
    h.NR_SEQUENCIA = a.nr_seq_nursing_care
GROUP BY
    coalesce(TO_CHAR(a.DT_AVALIACAO, 'YYYY-MM-DD'),'00000000'),
    cd_setor_usuario_atend,
    b.dt_entrada,
    g.cd_unidade_basica,
    g.cd_unidade_compl,
    b.CD_PESSOA_FISICA,
    c.nm_pessoa_fisica,
    c.ie_sexo,
    coalesce(TO_CHAR(c.DT_NASCIMENTO, 'YYYY-MM-DD'),'00000000'),
    OBTER_DEPARTAMENTO_SETOR(cd_setor_usuario_atend),
    OBTER_NOME_DEPART_POR_SETOR(cd_setor_usuario_atend),
    coalesce(TO_CHAR(b.dt_entrada, 'YYYY-MM-DD'),'00000000'),
    TO_CHAR(b.dt_entrada, 'HH:MI:SS'),
    coalesce(TO_CHAR(b.dt_alta, 'YYYY-MM-DD'),'00000000'),
    TO_CHAR(b.dt_alta, 'HH:MI:SS'),
    obter_time_atend(b.NR_ATENDIMENTO),
    e.NR_SEQ_CLASSIFICACAO,
    e.CD_PAYLOAD,
    e.DS_ITEM,
    f.NR_SEQ_APRES,
    f.DS_RESULTADO,
    RETORNA_CRITERIO_ATENDIMENTO(b.NR_ATENDIMENTO,1,a.NR_SEQUENCIA),
    RETORNA_CRITERIO_ATENDIMENTO(b.NR_ATENDIMENTO,2,a.NR_SEQUENCIA),
    h.IE_TIPO_FORMULARIO
ORDER BY
    coalesce(TO_CHAR(a.DT_AVALIACAO, 'YYYY-MM-DD'),'00000000'),
    coalesce(TO_CHAR(b.dt_entrada, 'YYYY-MM-DD'),'00000000');

