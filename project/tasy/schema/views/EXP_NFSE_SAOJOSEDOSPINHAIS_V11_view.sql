-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_saojosedospinhais_v11 (tp_registro, nr_nota_fiscal, cd_serie_nf, dt_emissao, tp_nota, vl_nota, ds_atividade, ie_prestador, ie_prestador_municipio, ds_razao_social, nr_inscricao_municipal, ds_digito_inscricao_municipal, cd_cpf_cnpj_prest, ie_inscricao_estadual, nr_inscricao_estadual, cd_cep_prest, ds_tipo_logradouro, ds_titulo_logradouro, ds_endereco_prest, ds_complemento_prest, nr_endereco_prest, ds_bairro_prest, sg_estado_prest, ds_municipio_prest, ds_local_servico, ds_simples_nacional, ds_aliquota_simples_nacional, cd_estabelecimento) AS select	'T' tp_registro,												--Indicador de Registro 
	lpad(n.nr_nota_fiscal,10,0) nr_nota_fiscal,									--Número da Nota Fiscal inicial 
	lpad(n.cd_serie_nf,10,' ') cd_serie_nf,										--Série da Nota Fiscal 
	n.dt_emissao dt_emissao,											--Data da emissão da Nota Fiscal 
	'6' tp_nota,													--Tipo da Nota Fiscal 
	lpad(somente_numero(CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  	CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END ),12,'0') vl_nota,					--Valor da Nota Fiscal 
	lpad(' ',10,' ') ds_atividade,											--Atividade ou serviço prestado 
	CASE WHEN n.cd_pessoa_fisica IS NULL THEN 2  ELSE 1 END  ie_prestador,								--Prestador 
	CASE WHEN obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente,'CDM')=412550 THEN 'S'  ELSE 'N' END  ie_prestador_municipio,	--Prestador estabelecido no Município 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente,'N'),' '),100,' ') ds_razao_social,		--Razão Social do prestador 
	lpad(somente_numero(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente,'IM')),10,' ') nr_inscricao_municipal,--Inscrição municipal do prestador 
	lpad(' ',2,' ') ds_digito_inscricao_municipal, 									--Dígito da inscrição Municipal 
	lpad(CASE WHEN n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN  	'0'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END ,14,0) cd_cpf_cnpj_prest, 					--CNPJ ou CPF do prestador 
	CASE WHEN somente_numero(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc_emitente,'IE'))=0 THEN 'S'  ELSE 'N' END  ie_inscricao_estadual,--Prestador isento de inscrição estadual 
	rpad(somente_numero(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc_emitente,'IE')),15,'0') nr_inscricao_estadual,	--Inscrição estadual do prestador 
	lpad(somente_numero(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'CEP')),8,0) cd_cep_prest,		--CEP referente ao logradouro do prestador 
	'Rua '	ds_tipo_logradouro,											--Tipo de logradouro do prestador 
	lpad(' ',5,' ') ds_titulo_logradouro,										--Título do logradouro do prestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'EN'),' '),50,' ') ds_endereco_prest,		--Logradouro do prestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'CO'),' '),40,' ') ds_complemento_prest,	--Complemento do logradouro doprestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'NR'),' '),10,' ') nr_endereco_prest,		--Número do logradouro do prestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'B'),' '),50,' ') ds_bairro_prest,		--Bairro referente ao logradouro do prestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'UF'),' '),2,' ') sg_estado_prest,		--Estado(UF) referente ao logradouro do prestador 
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente, 'CI'),' '),50,' ') ds_municipio_prest,		--Cidade referente ao logradouro do prestador 
	'D' ds_local_servico,												--Local de prestação do serviço 
	' ' ds_simples_nacional,											--Prestador Optante pelo Simples Nacional 
	lpad(' ',5,' ')	ds_aliquota_simples_nacional,									--Aliquota do Simples Nacional 
	n.cd_estabelecimento cd_estabelecimento										--Código do estabelecimento 
FROM	nota_fiscal n,
	operacao_nota o 
where	o.cd_operacao_nf = n.cd_operacao_nf 
and	o.ie_operacao_fiscal = 'E' 
and	o.ie_servico = 'S' 
and	upper(coalesce(obter_dados_pais(coalesce(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NP'), obter_dados_pf_pj(null, n.cd_cgc, 'P')), 'SG'),'BR')) = 'BR' 
and	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia);

