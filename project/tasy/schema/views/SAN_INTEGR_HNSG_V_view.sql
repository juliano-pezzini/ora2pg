-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_integr_hnsg_v (ie_tipo, cd_tipo, ds_tipo, nr_identidade, ds_sexo, dt_nascimento, tp_trandfusao, qt_peso, convenio, cd_matricula_usuario, setor_paciente, cd_setor_atendimento, nr_prontuario, nat_hospital, qt_hematocrito, qt_hemoglobina, ind_transfusao, nr_doc_solicitacao, nr_seq_prescr, dt_solicitacao, obs_procedimento, obs_solicitacao, nm_medico, nm_pessoa_fisica, cd_convenio, cd_crm, qt_procedimento, nr_atendimento, ds_convenio, ds_tipo_acomodacao, cd_tipo_acomodacao, cd_usuario_convenio, dt_validade_carteira, nr_guia_atendimento, cd_senha_atendimento, dt_inicio_vigencia, dt_fim_vigencia, dt_entrada, nm_medico_atend, nr_crm, cd_doenca) AS select 'P' ie_tipo,
	nr_seq_proc_interno cd_tipo, 
	DS_PROC_EXAME ds_tipo, 
	d.nr_identidade, 
	CASE WHEN d.ie_sexo='M' THEN 'Masculino'  ELSE CASE WHEN d.ie_sexo='F' THEN 'Feminino'  ELSE 'Indefinido' END  END  ds_sexo, 
	d.dt_nascimento, 
	CASE WHEN c.IE_TIPO=1 THEN 'Programa'  ELSE CASE WHEN c.IE_TIPO=2 THEN 'Não urgente'  ELSE CASE WHEN c.IE_TIPO=3 THEN 'Urgente'  ELSE 'Extrema Urgência' END  END  END  
tp_trandfusao, 
	b.qt_peso, 
	substr(obter_nome_convenio(obter_convenio_atendimento(e.nr_atendimento)),1,50) convenio, 
	OBTER_CODIGO_USUARIO_ATECACO(e.nr_atendimento,obter_convenio_atendimento(e.nr_atendimento)) cd_matricula_usuario, 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,60) setor_paciente, 
	b.cd_setor_atendimento cd_setor_atendimento, 
	d.nr_prontuario, 
	CASE WHEN e.ie_tipo_atendimento=8 THEN 'A'  ELSE 'H' END  Nat_hospital, 
	c.QT_HEMATOCRITO, 
	c.QT_HEMOGLOBINA, 
	CASE WHEN c.IE_TRANS_ANTERIOR='S' THEN 'S'  ELSE 'N' END  ind_transfusao, 
	a.nr_prescricao nr_doc_solicitacao, 
	a.nr_sequencia nr_seq_prescr, 
	b.dt_liberacao dt_solicitacao, 
	a.ds_observacao obs_procedimento, 
	d.ds_observacao obs_solicitacao, 
	obter_nome_pessoa_fisica(b.cd_medico,NULL) nm_medico, 
	substr(d.nm_pessoa_fisica,1,60) nm_pessoa_fisica, 
	obter_convenio_atendimento(e.nr_atendimento) cd_convenio, 
	obter_crm_medico(b.cd_medico) cd_crm, 
	a.qt_procedimento, 
	e.nr_atendimento, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'NC'),1,60) ds_convenio, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'D'),1,60) ds_tipo_acomodacao, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'C'),1,60) cd_tipo_acomodacao, 
	substr(obter_codigo_usuario_atecaco(e.nr_atendimento, obter_dados_atendimento(e.nr_atendimento, 'CC')),1,60) cd_usuario_convenio, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'V'),1,60) dt_validade_carteira, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'G'),1,60) nr_guia_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'S'),1,60) cd_senha_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'DIV'),1,60) dt_inicio_vigencia, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'CFV'),1,60) dt_fim_vigencia, 
	e.dt_entrada dt_entrada, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'MR'),1,60) nm_medico_atend, 
	substr(obter_dados_medico(e.cd_medico_resp, 'CRM'),1,20) nr_crm, 
	substr(tiss_obter_cid_atendimento(e.nr_atendimento, 'C'),1,10) cd_doenca	 
FROM  	prescr_medica b, 
	prescr_solic_bco_sangue c, 
	atendimento_paciente e, 
	prescr_procedimento a, 
	proc_interno f, 
	pessoa_fisica d 
where 	b.nr_prescricao = a.nr_prescricao 
and	b.nr_atendimento = e.nr_atendimento 
and	c.nr_prescricao = a.nr_prescricao 
and	c.nr_sequencia = a.nr_seq_solic_sangue 
and	d.cd_pessoa_fisica = b.cd_pessoa_fisica 
and	f.nr_sequencia = nr_seq_proc_interno 
and	nr_seq_solic_sangue is not null 
and	nr_seq_proc_interno is not null 
and  	b.dt_liberacao is not null 
and	a.dt_integracao is null 
and	a.ie_suspenso = 'N' 

union
 
select 'H' ie_tipo, 
	nr_seq_derivado cd_tipo, 
	ds_derivado	ds_tipo, 
	d.nr_identidade, 
	CASE WHEN d.ie_sexo='M' THEN 'Masculino'  ELSE CASE WHEN d.ie_sexo='F' THEN 'Feminino'  ELSE 'Indefinido' END  END  ds_sexo, 
	d.dt_nascimento, 
	CASE WHEN c.IE_TIPO=1 THEN 'Programa'  ELSE CASE WHEN c.IE_TIPO=2 THEN 'Não 
urgente'  ELSE CASE WHEN c.IE_TIPO=3 THEN 'Urgente'  ELSE 'Extrema Urgência' END  END  END  tp_trandfusao, 
	b.qt_peso, 
	substr(obter_nome_convenio(obter_convenio_atendimento(e.nr_atendimento)),1,50) convenio, 
	OBTER_CODIGO_USUARIO_ATECACO(e.nr_atendimento,obter_convenio_atendimento(e.nr_atendimento)) 
cd_matricula_usuario, 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,60) setor_paciente, 
	b.cd_setor_atendimento cd_setor_atendimento, 
	d.nr_prontuario, 
	CASE WHEN e.ie_tipo_atendimento=8 THEN 'A'  ELSE 'H' END  Nat_hospital, 
	c.QT_HEMATOCRITO, 
	c.QT_HEMOGLOBINA, 
	CASE WHEN c.IE_TRANS_ANTERIOR='S' THEN 'S'  ELSE 'N' END  ind_transfusao, 
	a.nr_prescricao nr_doc_solicitacao, 
	a.nr_sequencia nr_seq_prescr, 
	b.dt_liberacao dt_solicitacao, 
	a.ds_observacao obs_procedimento, 
	d.ds_observacao obs_solicitacao, 
	obter_nome_pessoa_fisica(b.cd_medico,NULL) nm_medico, 
	substr(d.nm_pessoa_fisica,1,60) nm_pessoa_fisica, 
	obter_convenio_atendimento(e.nr_atendimento) cd_convenio, 
	obter_crm_medico(b.cd_medico) cd_crm, 
	a.qt_procedimento, 
	e.nr_atendimento, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'NC'),1,60) ds_convenio, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'D'),1,60) ds_tipo_acomodacao, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'C'),1,60) cd_tipo_acomodacao, 
	substr(obter_codigo_usuario_atecaco(e.nr_atendimento, obter_dados_atendimento(e.nr_atendimento, 'CC')),1,60) cd_usuario_convenio, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'V'),1,60) dt_validade_carteira, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'G'),1,60) nr_guia_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'S'),1,60) cd_senha_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'DIV'),1,60) dt_inicio_vigencia, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'CFV'),1,60) dt_fim_vigencia, 
	e.dt_entrada dt_entrada, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'MR'),1,60) nm_medico_atend, 
	substr(obter_dados_medico(e.cd_medico_resp, 'CRM'),1,20) nr_crm, 
	substr(tiss_obter_cid_atendimento(e.nr_atendimento, 'C'),1,10) cd_doenca 
from  	prescr_medica b, 
	prescr_solic_bco_sangue c, 
	atendimento_paciente e, 
	prescr_procedimento a, 
	san_derivado f,					 
	pessoa_fisica d 
where	b.nr_prescricao = a.nr_prescricao 
and	b.nr_atendimento = e.nr_atendimento 
and	c.nr_prescricao = a.nr_prescricao 
and	c.nr_sequencia = a.nr_seq_solic_sangue 
and	d.cd_pessoa_fisica = b.cd_pessoa_fisica 
and	f.nr_sequencia = a.nr_seq_derivado 
and	nr_seq_solic_sangue is not null 
and	nr_seq_derivado is not null 
and	a.dt_integracao is null 
and	b.dt_liberacao is not null 
and	a.ie_suspenso = 'N' 

union
 
select 'M' ie_tipo, 
	a.cd_material cd_tipo, 
	f.ds_material ds_tipo, 
	d.nr_identidade, 
	CASE WHEN d.ie_sexo='M' THEN 'Masculino'  ELSE CASE WHEN d.ie_sexo='F' THEN 'Feminino'  ELSE 'Indefinido' END  END  ds_sexo, 
	d.dt_nascimento, 
	CASE WHEN c.ie_tipo=1 THEN 'programada'  ELSE CASE WHEN c.ie_tipo=2 THEN 'não 
urgente'  ELSE CASE WHEN c.ie_tipo=3 THEN 'urgente'  ELSE 'extrema urgência' END  END  END  tp_trandfusao, 
	b.qt_peso, 
	substr(obter_nome_convenio(obter_convenio_atendimento(e.nr_atendimento)),1,50) convenio, 
	obter_codigo_usuario_atecaco(e.nr_atendimento,obter_convenio_atendimento(e.nr_atendimento)) 
	cd_matricula_usuario, 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,60) setor_paciente, 
	b.cd_setor_atendimento cd_setor_atendimento, 
	d.nr_prontuario, 
	CASE WHEN e.ie_tipo_atendimento=8 THEN 'A'  ELSE 'H' END  nat_hospital, 
	c.qt_hematocrito, 
	c.qt_hemoglobina, 
	CASE WHEN c.ie_trans_anterior='S' THEN 'S'  ELSE 'N' END  ind_transfusao, 
	a.nr_prescricao nr_doc_solicitacao, 
	a.nr_sequencia nr_seq_prescr, 
	b.dt_liberacao dt_solicitacao, 
	a.ds_observacao obs_procedimento, 
	d.ds_observacao obs_solicitacao, 
	obter_nome_pessoa_fisica(b.cd_medico,null) nm_medico, 
	substr(d.nm_pessoa_fisica,1,60) nm_pessoa_fisica, 
	obter_convenio_atendimento(e.nr_atendimento) cd_convenio, 
	obter_crm_medico(b.cd_medico) cd_crm, 
	a.qt_material, 
	e.nr_atendimento, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'NC'),1,60) ds_convenio, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'D'),1,60) ds_tipo_acomodacao, 
	substr(obter_tipo_acomod_atual(e.nr_atendimento,'C'),1,60) cd_tipo_acomodacao, 
	substr(obter_codigo_usuario_atecaco(e.nr_atendimento, obter_dados_atendimento(e.nr_atendimento, 'CC')),1,60) cd_usuario_convenio, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'V'),1,60) dt_validade_carteira, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'G'),1,60) nr_guia_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'S'),1,60) cd_senha_atendimento, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'DIV'),1,60) dt_inicio_vigencia, 
	substr(obter_dados_categ_conv(e.nr_atendimento, 'CFV'),1,60) dt_fim_vigencia, 
	e.dt_entrada dt_entrada, 
	substr(obter_dados_atendimento(e.nr_atendimento, 'MR'),1,60) nm_medico_atend, 
	substr(obter_dados_medico(e.cd_medico_resp, 'CRM'),1,20) nr_crm, 
	substr(tiss_obter_cid_atendimento(e.nr_atendimento, 'C'),1,10) cd_doenca 
from 	pessoa_fisica d, 
	material f, 
	prescr_medica b, 
	prescr_solic_bco_sangue c, 
	atendimento_paciente e, 
	prescr_material a 
where 	b.nr_atendimento = e.nr_atendimento 
and 	f.cd_material  = a.cd_material 
and 	d.cd_pessoa_fisica = b.cd_pessoa_fisica 
and 	b.nr_prescricao = a.nr_prescricao 
and 	a.nr_prescricao = c.nr_prescricao 
and 	c.nr_sequencia is not null 
and 	b.dt_liberacao is not null 
and	a.ie_suspenso = 'N' 
and 	exists (select 1 from prescr_procedimento g 
 		where c.nr_sequencia = g.nr_seq_solic_sangue 
		and a.nr_prescricao = g.nr_prescricao 
		and g.dt_integracao is null);

