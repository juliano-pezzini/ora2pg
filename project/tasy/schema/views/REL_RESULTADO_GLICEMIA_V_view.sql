-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rel_resultado_glicemia_v (nr_atendimento, nr_sequencia, cd_pessoa_fisica, dt_controle, nr_seq_protocolo, dt_inclusao, tipo, qtd, ds_resultado, qt_glicemia) AS SELECT NR_ATENDIMENTO, NR_SEQUENCIA, CD_PESSOA_FISICA, DT_CONTROLE, NR_SEQ_PROTOCOLO, DT_INCLUSAO, TIPO, COUNT(DT_CONTROLE) QTD, DS_RESULTADO, QT_GLICEMIA
FROM (
  SELECT DISTINCT AG.NR_ATENDIMENTO, GP.NR_SEQUENCIA, AP.CD_PESSOA_FISICA, AG.DT_CONTROLE, GP.NR_SEQ_PROTOCOLO, GP.DT_INCLUSAO, CASE WHEN RL.NR_SEQUENCIA IS NULL THEN 'FSBG'  ELSE 'Glucose' END  TIPO,
     CASE WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) < 29 AND AG.QT_GLICEMIA BETWEEN 50 AND 80) THEN 'Glucose Compliance'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) BETWEEN 28 AND 6570 AND AG.QT_GLICEMIA BETWEEN 60 AND 100) THEN 'Glucose Compliance'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) > 6570 AND AG.QT_GLICEMIA BETWEEN 80 AND 110) THEN 'Glucose Compliance'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) < 29 AND AG.QT_GLICEMIA < 50) THEN 'Low Glucose'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) BETWEEN 28 AND 6570 AND AG.QT_GLICEMIA < 60) THEN 'Low Glucose'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) > 6570 AND AG.QT_GLICEMIA < 80) THEN 'Low Glucose'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) < 29 AND AG.QT_GLICEMIA > 80) THEN 'High Glucose'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) BETWEEN 28 AND 6570 AND AG.QT_GLICEMIA > 100) THEN 'High Glucose'
          WHEN(TRUNC(LOCALTIMESTAMP - coalesce(PF.DT_NASCIMENTO,LOCALTIMESTAMP)) > 6570 AND AG.QT_GLICEMIA > 110) THEN 'High Glucose'
     END DS_RESULTADO, AG.QT_GLICEMIA
  FROM ATENDIMENTO_GLICEMIA AG
  INNER JOIN ATENDIMENTO_PACIENTE AP ON AP.NR_ATENDIMENTO = AG.NR_ATENDIMENTO
  INNER JOIN PESSOA_FISICA PF ON PF.CD_PESSOA_FISICA = AP.CD_PESSOA_FISICA
  INNER JOIN GQA_PROTOCOLO_PAC GP ON GP.NR_ATENDIMENTO = AP.NR_ATENDIMENTO AND GP.IE_SITUACAO = 'A' AND GP.NR_SEQ_PROTOCOLO = 1302
  LEFT JOIN RESULT_LABORATORIO RL ON OBTER_DADOS_PRESCRICAO(RL.NR_PRESCRICAO, 'A') = AG.NR_ATENDIMENTO AND TO_CHAR(RL.DT_COLETA,'YYYY-MM') = TO_CHAR(AG.DT_CONTROLE,'YYYY-MM')
) alias31
GROUP BY NR_ATENDIMENTO, NR_SEQUENCIA, CD_PESSOA_FISICA, DT_CONTROLE, TIPO, DS_RESULTADO, QT_GLICEMIA, NR_SEQ_PROTOCOLO, DT_INCLUSAO;

