-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW gratuidade_v (dt_mesano_referencia, nr_seq_protocolo, nr_atendimento, nr_interno_conta, qt_resumo, qt_diaria, vl_rec_material, vl_custo_material, vl_rec_diaria, vl_custo_diaria, vl_rec_proc, vl_custo_proc, ie_cancelamento, cd_centro_custo) AS select
	c.dt_mesano_referencia,
	c.nr_seq_protocolo,
	a.nr_atendimento,
	a.nr_interno_conta,
	sum(b.qt_resumo) qt_resumo,
	sum(CASE WHEN b.ie_diaria='S' THEN b.qt_resumo   ELSE 0 END ) qt_diaria,
	sum(b.vl_material) vl_Rec_material,
	sum(CASE WHEN b.cd_material IS NULL THEN 0  ELSE b.vl_custo END ) vl_custo_Material,
	sum(CASE WHEN b.ie_diaria='S' THEN  b.vl_procedimento  ELSE 0 END ) vl_Rec_diaria,
	sum(CASE WHEN b.ie_diaria='S' THEN  b.vl_custo  ELSE 0 END ) vl_custo_diaria,
	sum(CASE WHEN b.ie_diaria='S' THEN 0  ELSE CASE WHEN b.cd_procedimento IS NULL THEN  0  ELSE CASE WHEN b.ie_origem_proced=2 THEN (b.vl_custo_operacional + b.vl_materiais)  ELSE CASE WHEN b.vl_procedimento=0 THEN  0   ELSE (b.vl_procedimento -			(b.vl_medico + b.vl_anestesista + b.vl_auxiliares)) END  END  END  END ) vl_Rec_Proc,
	sum(CASE WHEN b.ie_diaria='S' THEN 0  ELSE CASE WHEN b.cd_procedimento IS NULL THEN  0  ELSE b.vl_custo END  END ) vl_custo_Proc,
	a.ie_cancelamento,
	s.cd_centro_custo
FROM	conta_paciente a,
	conta_paciente_resumo b,
	protocolo_convenio c,
	setor_atendimento s
where 	c.nr_seq_protocolo = a.nr_seq_protocolo
and 	a.nr_interno_conta = b.nr_interno_conta
and	b.cd_setor_atendimento = s.cd_setor_atendimento
group by
	c.dt_mesano_referencia,
	c.nr_seq_protocolo,
	a.nr_atendimento,
	a.nr_interno_conta,
	a.ie_cancelamento,
	s.cd_centro_custo;

