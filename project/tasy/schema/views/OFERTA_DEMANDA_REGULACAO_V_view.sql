-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW oferta_demanda_regulacao_v (dt_tempo_espera, qt_alerta_minimo, qt_alerta_maximo, ie_tipo_alerta, ie_tipo_servico, cd_procedimento, cd_material, cd_estabelecimento, dt_requisicao) AS Select   y.DT_TEMPO_ESPERA DT_TEMPO_ESPERA,
        (Select max(qt_valor)
              FROM   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			  and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'T'
              and    IE_CALCULO  = 'AB') qt_alerta_minimo,
        (Select max(qt_valor)
              from   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			  and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'T'
              and    IE_CALCULO  = 'AC') qt_alerta_Maximo,
         'T' ie_tipo_alerta,
         y.IE_TIPO_REGULACAO IE_TIPO_SERVICO,
		 y.CD_PROCEDIMENTO CD_PROCEDIMENTO,
		 y.CD_material CD_material,
         y.cd_estabelecimento cd_estabelecimento,
         y.DT_REQUISICAO
from     eis_gestao_regulacao_v y
where   y.DS_SERVICO is not null

Union all

Select   y.DT_TEMPO_ESPERA DT_TEMPO_ESPERA,
         (Select max(qt_valor)
              from   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			    and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'R'
              and    IE_CALCULO  = 'AB') qt_alerta_minimo,
         (Select max(qt_valor)
              from   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			   and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'R'
              and    IE_CALCULO  = 'AC') qt_alerta_Maximo,
         'R' ie_tipo_alerta,
        y.IE_TIPO_REGULACAO IE_TIPO_SERVICO,
		y.CD_PROCEDIMENTO CD_PROCEDIMENTO,
		y.CD_material CD_material,
         y.cd_estabelecimento cd_estabelecimento,
        y.DT_REQUISICAO
from     eis_gestao_regulacao_v y
where   y.DS_SERVICO is not null

union all

Select   y.DT_TEMPO_ESPERA DT_TEMPO_ESPERA,
         (Select max(qt_valor)
              from   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			   and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'P'
              and    IE_CALCULO  = 'AB') qt_alerta_minimo,
         (Select max(qt_valor)
              from   REGRA_META_REGULACAO a,
                     REGRA_META_REGULACAO_NIVEL b
              where  IE_TIPO_SERVICO = IE_TIPO_REGULACAO
			    and (a.CD_PROCEDIMENTO =  y.CD_PROCEDIMENTO or (a.CD_PROCEDIMENTO is null and y.CD_PROCEDIMENTO is null))
			  and (a.CD_material =  y.CD_material or (a.CD_material is null and y.CD_material is null))
              and    b.NR_SEQ_REGRA_META_REG = a.nr_sequencia
              AND    b.IE_TIPO_ALERTA = 'P'
              and    IE_CALCULO  = 'AC') qt_alerta_Maximo,
         'P' ie_tipo_alerta,
         y.IE_TIPO_REGULACAO IE_TIPO_SERVICO,
		 y.CD_PROCEDIMENTO CD_PROCEDIMENTO,
		 y.CD_material CD_material,
         y.cd_estabelecimento cd_estabelecimento,
        y.DT_REQUISICAO
from     eis_gestao_regulacao_v y
where    y.DS_SERVICO is not null;

