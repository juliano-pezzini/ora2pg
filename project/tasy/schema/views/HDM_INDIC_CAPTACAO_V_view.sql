-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hdm_indic_captacao_v (dt_captacao, mes_captacao, ano_captacao, nr_seq_programa, nr_seq_campanha, ds_campanha, ds_programa, nr_seq_equipe, ds_equipe, qt_realizada, qt_aceita, qt_prevista, qt_total_prevista) AS select	/* Filtros data */
	a.dt_inclusao dt_captacao,
	/* Dimensões */

	to_char(a.dt_inclusao,'mm/yyyy') mes_captacao,
	to_char(a.dt_inclusao,'yyyy') ano_captacao,
	b.nr_seq_programa,
	b.nr_seq_campanha,
	substr(mprev_obter_desc_campanha(b.nr_seq_campanha),1,255) ds_campanha,
	substr(mprev_obter_desc_programa(b.nr_seq_programa),1,255) ds_programa,
	b.nr_seq_equipe,
	substr(mprev_obter_dados_equipe(b.nr_seq_equipe,LOCALTIMESTAMP,'NM'),1,255) ds_equipe,
	/* Informações */

	CASE WHEN a.ie_status='A' THEN 1 WHEN a.ie_status='R' THEN 1  ELSE null END  qt_realizada,
	CASE WHEN a.ie_status='A' THEN 1  ELSE null END  qt_aceita,
	1 qt_prevista,
	--COUNT(1) OVER (PARTITION BY a.nr_sequencia) qt_prevista,
	(select	count(distinct x.nr_sequencia)
	FROM	mprev_captacao_destino y,
		mprev_captacao x
	where	x.nr_sequencia	= y.nr_seq_captacao
	and	x.ie_status <> 'C'
	and (y.nr_seq_programa = b.nr_seq_programa or b.nr_seq_programa is null)
	and (y.nr_seq_campanha = b.nr_seq_campanha or b.nr_seq_campanha is null)
	) qt_total_prevista
FROM mprev_captacao a
LEFT OUTER JOIN mprev_captacao_destino b ON (a.nr_sequencia = b.nr_seq_captacao)
WHERE a.ie_status	<> 'C';

