-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pfcs_module_v (cd_function, pr_capacity, vl_census, vl_pred_census, qt_avail_beds, qt_pred_avail_beds, qt_blocked_beds, qt_discharge_orders, qt_discharge_delays, qt_pred_discharge, qt_total_admissions, qt_total_discharges, cd_establishment, qt_hour) AS select	438 cd_function, --> Admission Prioritizer
		(to_char(coalesce(pfcs_get_percentage_value(sum(cap.vl_indicator_help), sum(cap.vl_indicator)),0))||'%') pr_capacity,
		(sum(cap.vl_indicator_help) || '/' || sum(cap.vl_indicator)) vl_census,
		pfcs_pck_sim.get_simulation_value(cap.nr_seq_operational_level, aux.qt_hour, 'CEN', '1', 'Y', null) vl_pred_census,
		to_char(coalesce((	select	sum(ava.vl_indicator)
							  FROM	pfcs_panel ava
							 where	ava.nr_seq_indicator = 102
							   and	ava.nr_seq_operational_level = cap.nr_seq_operational_level),0)) qt_avail_beds,
		pfcs_pck_sim.get_simulation_value(cap.nr_seq_operational_level, aux.qt_hour, 'AVB', null, 'Y', (
						select	sum(ava.vl_indicator_help)
						  from	pfcs_panel ava
						 where	ava.nr_seq_indicator = 102
						   and	ava.nr_seq_operational_level = cap.nr_seq_operational_level)) qt_pred_avail_beds,
		to_char(coalesce(sum(cap.vl_indicator_collab),0)) qt_blocked_beds,
		to_char(coalesce((select	sum(dis.vl_indicator)
							from	pfcs_panel dis
						   where	dis.nr_seq_indicator = 139
							 and	dis.nr_seq_operational_level = cap.nr_seq_operational_level),0)) qt_discharge_orders,
		to_char(coalesce((select	sum(dis.vl_indicator_aux)
							from	pfcs_panel dis
						   where	dis.nr_seq_indicator = 139
							 and	dis.nr_seq_operational_level = cap.nr_seq_operational_level),0)) qt_discharge_delays,
		pfcs_pck_sim.get_simulation_value(cap.nr_seq_operational_level, aux.qt_hour, 'DIS', '1', 'Y', null) qt_pred_discharge,
		obter_desc_expressao(344145) qt_total_admissions,
		obter_desc_expressao(344145) qt_total_discharges,
		cap.nr_seq_operational_level cd_establishment,
		aux.qt_hour qt_hour
  from	pfcs_panel cap join(WITH RECURSIVE cte AS (
select ( row_number() OVER () - 1 ) qt_hour  level <= 48  UNION ALL
select ( row_number() OVER () - 1 ) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
 where	cap.nr_seq_indicator = 114
group by cap.nr_seq_operational_level, aux.qt_hour

union all

select 461 cd_function, --> acu
    pfcs_pck_indicators.get_value_panel(263, acu.nr_seq_operational_level) pr_capacity,
    pfcs_pck_indicators.get_value_panel(264, acu.nr_seq_operational_level) vl_census,
    pfcs_pck_sim.get_simulation_value(acu.nr_seq_operational_level, aux.qt_hour, 'CEN', '3', 'Y', null) vl_pred_census,
    pfcs_pck_indicators.get_value_panel(255, acu.nr_seq_operational_level) qt_avail_beds,
    pfcs_pck_sim.get_simulation_value(acu.nr_seq_operational_level, aux.qt_hour, 'AVB', '3', 'Y', sum(acu.vl_indicator_help)) qt_pred_avail_beds,
    pfcs_pck_indicators.get_value_panel(256, acu.nr_seq_operational_level) qt_blocked_beds,
    pfcs_pck_indicators.get_value_panel(270, acu.nr_seq_operational_level) qt_discharge_orders,
    to_char(pfcs_pck_discharge_manager.get_discharge_orders(acu.nr_seq_operational_level, null, '3', null, null, 'Y')) qt_discharge_delays,
    pfcs_pck_sim.get_simulation_value(acu.nr_seq_operational_level, aux.qt_hour, 'DIS', '3', 'Y', null) vl_pred_census,
    to_char(pfcs_pck_bed_requests.get_total_admissions(acu.nr_seq_operational_level,'3')) qt_total_admissions,
    to_char(pfcs_pck_discharge_manager.get_anticipated_discharges(acu.nr_seq_operational_level, null, '3', LOCALTIMESTAMP, 'N')
        + pfcs_pck_discharge_manager.get_discharge_orders(acu.nr_seq_operational_level, null, '3', null, null, null)) qt_total_discharges,
    acu.nr_seq_operational_level cd_establishment,
    aux.qt_hour qt_hour
from pfcs_panel acu join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where acu.nr_seq_indicator = 102
    and acu.cd_reference_aux = '3'
    and acu.ie_situation = 'A'
group by acu.nr_seq_operational_level, aux.qt_hour

union all

select 462 cd_function, --> tcu
    pfcs_pck_indicators.get_value_panel(251, tcu.nr_seq_operational_level) pr_capacity,
    pfcs_pck_indicators.get_value_panel(252, tcu.nr_seq_operational_level) vl_census,
    pfcs_pck_sim.get_simulation_value(tcu.nr_seq_operational_level, aux.qt_hour, 'CEN', 'SD', 'Y', null) vl_pred_census,
    pfcs_pck_indicators.get_value_panel(243, tcu.nr_seq_operational_level) qt_avail_beds,
    pfcs_pck_sim.get_simulation_value(tcu.nr_seq_operational_level, aux.qt_hour, 'AVB', 'SD', 'Y', sum(tcu.vl_indicator_help)) qt_pred_avail_beds,
    pfcs_pck_indicators.get_value_panel(244, tcu.nr_seq_operational_level) qt_blocked_beds,
    pfcs_pck_indicators.get_value_panel(279, tcu.nr_seq_operational_level) qt_discharge_orders,
    to_char(pfcs_pck_discharge_manager.get_discharge_orders(tcu.nr_seq_operational_level, null, 'SD', null, null, 'Y')) qt_discharge_delays,
    pfcs_pck_sim.get_simulation_value(tcu.nr_seq_operational_level, aux.qt_hour, 'DIS', 'SD', 'Y', null) vl_pred_census,
    to_char(pfcs_pck_bed_requests.get_total_admissions(tcu.nr_seq_operational_level,'SD')) qt_total_admissions,
    to_char(pfcs_pck_discharge_manager.get_anticipated_discharges(tcu.nr_seq_operational_level, null, 'SD', LOCALTIMESTAMP, 'N')
        + pfcs_pck_discharge_manager.get_discharge_orders(tcu.nr_seq_operational_level, null, 'SD', null, null, null)) qt_total_discharges,
    tcu.nr_seq_operational_level cd_establishment,
    aux.qt_hour qt_hour
from pfcs_panel tcu join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where tcu.nr_seq_indicator = 102
    and tcu.cd_reference_aux = 'SD'
    and tcu.ie_situation = 'A'
group by tcu.nr_seq_operational_level, aux.qt_hour

union all

select 428 cd_function, --> icu
    pfcs_pck_indicators.get_value_panel(90, icu.nr_seq_operational_level) pr_capacity,
    pfcs_pck_indicators.get_value_panel(91, icu.nr_seq_operational_level) vl_census,
    pfcs_pck_sim.get_simulation_value(icu.nr_seq_operational_level, aux.qt_hour, 'CEN', '4', 'Y', null) vl_pred_census,
    pfcs_pck_indicators.get_value_panel(92, icu.nr_seq_operational_level) qt_avail_beds,
    pfcs_pck_sim.get_simulation_value(icu.nr_seq_operational_level, aux.qt_hour, 'AVB', '4', 'Y', sum(icu.vl_indicator_help)) qt_pred_avail_beds,
    pfcs_pck_indicators.get_value_panel(93, icu.nr_seq_operational_level) qt_blocked_beds,
    pfcs_pck_indicators.get_value_panel(300, icu.nr_seq_operational_level) qt_discharge_orders,
    to_char(pfcs_pck_discharge_manager.get_discharge_orders(icu.nr_seq_operational_level, null, '4', null, null, 'Y')) qt_discharge_delays,
    pfcs_pck_sim.get_simulation_value(icu.nr_seq_operational_level, aux.qt_hour, 'DIS', '4', 'Y', null) vl_pred_census,
    to_char(pfcs_pck_bed_requests.get_total_admissions(icu.nr_seq_operational_level,'4')) qt_total_admissions,
    to_char(pfcs_pck_discharge_manager.get_anticipated_discharges(icu.nr_seq_operational_level, null, '4', LOCALTIMESTAMP, 'N')
        + pfcs_pck_discharge_manager.get_discharge_orders(icu.nr_seq_operational_level, null, '4', null, null, null)) qt_total_discharges,
    icu.nr_seq_operational_level cd_establishment,
    aux.qt_hour qt_hour
from pfcs_panel icu join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where icu.nr_seq_indicator = 102
    and icu.cd_reference_aux = '4'
    and icu.ie_situation = 'A'
group by icu.nr_seq_operational_level, aux.qt_hour

union all

select 439 cd_function, --> tele
    pfcs_pck_indicators.get_value_panel(447, tele.nr_seq_operational_level) pr_capacity,
    pfcs_pck_indicators.get_value_panel(446, tele.nr_seq_operational_level) vl_census,
    obter_desc_expressao(344145) vl_pred_census,
    pfcs_pck_indicators.get_value_panel(48, tele.nr_seq_operational_level) qt_avail_beds,
    obter_desc_expressao(344145) qt_pred_avail_beds,
    pfcs_pck_indicators.get_value_panel(135, tele.nr_seq_operational_level) qt_blocked_beds,
    pfcs_pck_indicators.get_value_panel(50, tele.nr_seq_operational_level) qt_discharge_orders,
    obter_desc_expressao(344145) qt_discharge_delays,
    obter_desc_expressao(344145) vl_pred_census,
    obter_desc_expressao(344145) qt_total_admissions,
    obter_desc_expressao(344145) qt_total_discharges,
    tele.nr_seq_operational_level cd_establishment,
    aux.qt_hour qt_hour
from pfcs_panel tele join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where tele.nr_seq_indicator = 46
    and tele.ie_situation = 'A'
group by tele.nr_seq_operational_level, aux.qt_hour

union all

select 455 cd_function, --> discharge manager
    pfcs_pck_indicators.get_value_panel(100, dm.nr_seq_operational_level) pr_capacity,
    pfcs_pck_indicators.get_value_panel(101, dm.nr_seq_operational_level) vl_census,
    pfcs_pck_sim.get_simulation_value(dm.nr_seq_operational_level, aux.qt_hour, 'CEN', null, 'Y', null) vl_pred_census,
    pfcs_pck_indicators.get_value_panel(102, dm.nr_seq_operational_level) qt_avail_beds,
    pfcs_pck_sim.get_simulation_value(dm.nr_seq_operational_level, aux.qt_hour, 'AVB', null, 'Y', sum(dm.vl_indicator_help)) qt_pred_avail_beds,
    pfcs_pck_indicators.get_value_panel(111, dm.nr_seq_operational_level) qt_blocked_beds,
    pfcs_pck_indicators.get_value_panel(112, dm.nr_seq_operational_level) qt_discharge_orders,
    to_char(pfcs_pck_discharge_manager.get_discharge_orders(dm.nr_seq_operational_level, null, null, null, null, 'Y')) qt_discharge_delays,
    pfcs_pck_sim.get_simulation_value(dm.nr_seq_operational_level, aux.qt_hour, 'DIS', null, 'Y', null) vl_pred_census,
    to_char(pfcs_pck_bed_requests.get_total_admissions(dm.nr_seq_operational_level, null, null, 'S')) qt_total_admissions,
    to_char(pfcs_pck_discharge_manager.get_anticipated_discharges(dm.nr_seq_operational_level, null, null, LOCALTIMESTAMP, 'N', 'S')
        + pfcs_pck_discharge_manager.get_discharge_orders(dm.nr_seq_operational_level, null, null, null, null, null, 'S')) qt_total_discharges,
    dm.nr_seq_operational_level cd_establishment,
    aux.qt_hour qt_hour
from pfcs_panel dm join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where dm.nr_seq_indicator = 102
    and pfcs_pck_utils.get_ie_hospital_occupancy(isnumber(dm.cd_reference_value)) = 'S'
    and dm.ie_situation = 'A'
group by dm.nr_seq_operational_level, aux.qt_hour

union all

select 464 cd_function, --> emergency department
	obter_desc_expressao(344145) pr_capacity,
	obter_desc_expressao(344145) vl_census,
	obter_desc_expressao(344145) vl_pred_census,
	obter_desc_expressao(344145) qt_avail_beds,
	obter_desc_expressao(344145) qt_pred_avail_beds,
	obter_desc_expressao(344145) qt_blocked_beds,
	obter_desc_expressao(344145) qt_discharge_orders,
	obter_desc_expressao(344145) qt_discharge_delays,
	obter_desc_expressao(344145) qt_pred_discharge,
	obter_desc_expressao(344145) qt_total_admissions,
	obter_desc_expressao(344145) qt_total_discharges,
	cap.nr_seq_operational_level cd_establishment,
	aux.qt_hour qt_hour
from pfcs_panel cap join(WITH RECURSIVE cte AS (
select ( row_number() OVER () - 1 ) qt_hour  level <= 48  UNION ALL
select ( row_number() OVER () - 1 ) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48
where cap.nr_seq_indicator in (313,306,305)
group by cap.nr_seq_operational_level, aux.qt_hour

union all

select	466 cd_function, --> hospital at home
		obter_desc_expressao(344145) pr_capacity,
		to_char(sum(cap.vl_indicator_help)) vl_census,
		obter_desc_expressao(344145) vl_pred_census,
		obter_desc_expressao(344145) qt_avail_beds,
		obter_desc_expressao(344145) qt_pred_avail_beds,
		obter_desc_expressao(344145) qt_blocked_beds,
		to_char(coalesce(sum(dor.vl_indicator),0)) qt_discharge_orders,
		to_char(coalesce(sum(dly.vl_indicator),0)) qt_discharge_delays,
		obter_desc_expressao(344145) ds_pred_discharge,
		to_char(pfcs_pck_bed_requests.get_total_admissions(cap.nr_seq_operational_level,'8')) qt_total_admissions,
		to_char(pfcs_pck_discharge_manager.get_anticipated_discharges(cap.nr_seq_operational_level, null, '8', LOCALTIMESTAMP, 'N')+sum(dor.vl_indicator)) qt_total_discharges,
		cap.nr_seq_operational_level cd_establishment,
		aux.qt_hour qt_hour
from pfcs_panel cap join(WITH RECURSIVE cte AS (
select (rownum - 1) qt_hour  level <= 48  UNION ALL
select (rownum - 1) qt_hour  level <= 48 JOIN cte c ON ()

) SELECT * FROM cte;
) aux on aux.qt_hour <= 48,
    pfcs_panel dor,
    pfcs_panel dly
where cap.nr_seq_indicator = 100
    and dor.nr_seq_indicator = 112
    and dly.nr_seq_indicator = 110
    and dor.nr_seq_operational_level = cap.nr_seq_operational_level
    and dly.nr_seq_operational_level = cap.nr_seq_operational_level
    and dor.cd_reference_value = cap.cd_reference_value
    and dly.cd_reference_value = cap.cd_reference_value
    and cap.cd_reference_aux = '8'
    and dor.cd_reference_aux = '8'
    and dly.cd_reference_aux = '8'
group by cap.nr_seq_operational_level, aux.qt_hour;

