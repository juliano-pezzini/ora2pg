-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_ptu_pos_estab_v (ie_ordem, ie_ordem_titulo, nr_sequencia, nr_seq_conta, nr_seq_item, ds_item_despesa, cd_item, ds_tipo_despesa, ds_via_aces, nr_seq_prestador_exec, nm_prestador_exec, dt_item, ds_grau_part, ie_origem_proced, nr_seq_grau_partic, tx_item, qt_apresentado, qt_liberado, vl_unitario, vl_total, vl_unitario_apres, vl_total_apres, vl_calculado, ds_guia, nr_seq_conta_referencia, nr_guia, nr_seq_apres, ie_status_item, ie_situacao, ie_ocorrencia_glosa, nr_seq_protocolo, nm_prestador_pagamento, ie_status_conta, ds_status_conta, ds_seq_analise, nr_seq_mot_liberacao, cd_material, cd_porte_anestesico, nr_auxiliares, ie_tipo_despesa, nr_seq_guia, ie_autorizado, cd_classificacao_sip, cd_classif_cred, cd_classif_deb, ie_tipo_item, ie_carater_internacao, ie_exige_nf, cd_guia, ie_tipo_guia, nr_seq_res_conta_princ, nr_seq_analise, nr_seq_prestador_solic, nm_prestador_solic, ie_via_acesso, ds_fornecedor, ie_pagamento, nr_identificador, nr_seq_grupo_item, nr_seq_prestador_pgto, nr_seq_cbo_saude, nr_seq_item_ref, vl_uni_calculado, ds_item_despesa_order, nr_seq_apres_prof, ds_setor_atendimento, ds_unidade_medida, nr_seq_partic_proc, ie_tipo_glosa, ds_item_importacao, ds_medico_executor, cd_tiss, ie_faturamento, nr_seq_regra_preco_pos, nr_seq_pos_estab_interc, nr_seq_conta_proc, nr_seq_conta_mat, cd_item_convertido, ds_item_convertido) AS select	nr_ordem ie_ordem,
	0 ie_ordem_titulo, 
	null nr_sequencia, 
	null nr_seq_conta, 
	null nr_seq_item, 
	substr(pls_obter_desc_item_desp_int(nr_ordem, 'P'),1,255) ds_item_despesa, 
	null cd_item, 
	null ds_tipo_despesa, 
	null ds_via_aces, 
	null nr_seq_prestador_exec, 
	null nm_prestador_exec, 
	null dt_item,	 
	null ds_grau_part, 
	null ie_origem_proced, 
	null nr_seq_grau_partic, 
	null tx_item, 
	null qt_apresentado, 
	null qt_liberado, 
	null vl_unitario, 
	null vl_total, 
	null vl_unitario_apres,    
	null vl_total_apres,  
	null vl_calculado, 
	null ds_guia, 
	null nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	0 nr_seq_apres, 
	null ie_status_item, 
	null ie_situacao, 
	null ie_ocorrencia_glosa, 
	null nr_seq_protocolo, 
	null nm_prestador_pagamento, 
	null ie_status_conta, 
	null ds_status_conta, 
	null ds_seq_analise, 
	null nr_seq_mot_liberacao, 
	null cd_material, 
	null cd_porte_anestesico, 
	null nr_auxiliares, 
	null ie_tipo_despesa, 
	null nr_seq_guia, 
	null ie_autorizado, 
	null cd_classificacao_sip, 
	null cd_classif_cred, 
	null cd_classif_deb, 
	null ie_tipo_item, 
	null ie_carater_internacao, 
	null ie_exige_nf, 
	null cd_guia, 
	null ie_tipo_guia, 
	null nr_seq_res_conta_princ, 
	nr_seq_analise nr_seq_analise, 
	null nr_seq_prestador_solic, 
	null nm_prestador_solic, 
	null ie_via_acesso, 
	'' ds_fornecedor, 
	null ie_pagamento, 
	null nr_identificador, 
	null nr_seq_grupo_item, 
	null nr_seq_prestador_pgto, 
	null nr_seq_cbo_saude, 
	null nr_seq_item_ref, 
	null vl_uni_calculado, 
	null ds_item_despesa_order, 
	null nr_seq_apres_prof, 
	null ds_setor_atendimento, 
	null ds_unidade_medida, 
	null nr_seq_partic_proc, 
	null ie_tipo_glosa, 
	null ds_item_importacao, 
	null ds_medico_executor, 
	null cd_tiss, 
	null ie_faturamento, 
	null nr_seq_regra_preco_pos, 
	null nr_seq_pos_estab_interc, 
	null nr_seq_conta_proc, 
	null nr_seq_conta_mat, 
	null cd_item_convertido, 
	null ds_item_convertido 
FROM	w_pls_resumo_conta y 
group by ds_tipo_despesa, ie_tipo_despesa, nr_ordem, coalesce(cd_guia_referencia,cd_guia), nr_seq_analise 

union
 
/*procedimento/material*/
 
select	nr_ordem ie_ordem, 
	1 ie_ordem_titulo, 
	nr_sequencia, 
	nr_seq_conta, 
	nr_seq_item,	 
	substr('     ' ||CASE WHEN coalesce(coalesce(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),cd_item),0)=0 THEN InitCap(pls_obter_desc_item_desp(ds_tipo_despesa, 'S'))||' não reconhecido.'  ELSE ds_item END ,1,255) ds_item_despesa, 
	cd_item, 
	ds_tipo_despesa, 
	ds_via_acesso ds_via_aces, 
	nr_seq_prestador_exec, 
	nm_prestador nm_prestador_exec, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	ds_grau_participacao ds_grau_part, 
	ie_origem_proced, 
	nr_seq_grau_partic, 
	tx_item, 
	qt_apresentado, 
	qt_liberado, 
	vl_unitario, 
	vl_total, 
	vl_unitario_apres,    
	vl_total_apres, 
	vl_calculado, 
	ds_tipo_guia ds_guia, 
	nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	1 nr_seq_apres, 
	ie_status ie_status_item, 
	ie_situacao, 
	ie_ocorrencia_glosa, 
	nr_seq_protocolo, 
	nm_prestador_pagamento, 
	ie_status_conta, 
	ds_status_conta, 
	nr_seq_analise ds_seq_analise, 
	nr_seq_mot_liberacao, 
	substr(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),1,20) cd_material, 
	cd_porte_anestesico, 
	nr_auxiliares, 
	ie_tipo_despesa, 
	nr_seq_guia, 
	ie_autorizado, 
	cd_classificacao_sip, 
	cd_classif_cred, 
	cd_classif_deb, 
	ie_tipo_item, 
	ie_carater_internacao, 
	ie_exige_nf, 
	cd_guia, 
	ie_tipo_guia, 
	nr_seq_res_conta_princ, 
	nr_seq_analise, 
	nr_seq_prestador_solic, 
	nm_prestador_solic, 
	ie_via_acesso, 
	ds_fornecedor, 
	ie_pagamento, 
	nr_identificador, 
	nr_seq_grupo_item, 
	nr_seq_prestador_pgto, 
	nr_seq_cbo_saude, 
	nr_seq_item_ref, 
	dividir_sem_round(vl_calculado, qt_apresentado) vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	nr_seq_apres_prof, 
	ds_setor_atendimento, 
	CASE WHEN ie_tipo_item='M' THEN  substr(pls_obter_dados_material(cd_item,'UM'),1,255)  ELSE null END  ds_unidade_medida, 
	nr_seq_partic_proc, 
	pls_obter_ie_valor_glosa(nr_seq_item, ie_tipo_item) ie_tipo_glosa, 
	ds_item_importacao, 
	CASE WHEN ie_tipo_item='P' THEN  substr(cd_medico_executor||' - '||obter_nome_pf(cd_medico_executor),1,255)  ELSE null END  ds_medico_executor, 
	null cd_tiss, 
	ie_faturamento, 
	nr_seq_regra_preco_pos, 
	nr_seq_pos_estab_interc, 
	nr_seq_conta_proc, 
	nr_seq_conta_mat, 
	cd_item_convertido, 
	ds_item_convertido 
from	w_pls_resumo_conta 
where	ie_tipo_item <> 'R' 
and	ie_tipo_guia <> 6 

union
 
select	nr_ordem ie_ordem, 
	1 ie_ordem_titulo, 
	nr_sequencia, 
	nr_seq_conta, 
	nr_seq_item,	 
	substr('         ' ||nm_participante,1,255) ds_item_despesa, 
	cd_item, 
	ds_tipo_despesa, 
	ds_via_acesso ds_via_aces, 
	nr_seq_prestador_exec, 
	nm_prestador nm_prestador_exec, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	ds_grau_participacao ds_grau_part, 
	ie_origem_proced, 
	nr_seq_grau_partic, 
	tx_item, 
	qt_apresentado, 
	qt_liberado, 
	vl_unitario, 
	vl_total, 
	vl_unitario_apres,    
	vl_total_apres, 
	vl_calculado, 
	ds_tipo_guia ds_guia, 
	nr_seq_conta_referencia, 
	coalesce(cd_guia_referencia,cd_guia) nr_guia, 
	2 nr_seq_apres, 
	ie_status ie_status_item, 
	ie_situacao, 
	ie_ocorrencia_glosa, 
	nr_seq_protocolo, 
	nm_prestador_pagamento, 
	ie_status_conta, 
	ds_status_conta, 
	nr_seq_analise ds_seq_analise, 
	nr_seq_mot_liberacao, 
	substr(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),1,20) cd_material, 
	cd_porte_anestesico, 
	nr_auxiliares, 
	ie_tipo_despesa, 
	nr_seq_guia, 
	ie_autorizado, 
	cd_classificacao_sip, 
	cd_classif_cred, 
	cd_classif_deb, 
	ie_tipo_item, 
	ie_carater_internacao, 
	ie_exige_nf, 
	cd_guia, 
	ie_tipo_guia, 
	nr_seq_res_conta_princ, 
	nr_seq_analise, 
	nr_seq_prestador_solic, 
	nm_prestador_solic, 
	ie_via_acesso, 
	ds_fornecedor, 
	ie_pagamento, 
	nr_identificador, 
	nr_seq_grupo_item, 
	nr_seq_prestador_pgto, 
	nr_seq_cbo_saude, 
	nr_seq_item_ref, 
	dividir_sem_round(vl_calculado, qt_apresentado) vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	nr_seq_apres_prof, 
	ds_setor_atendimento, 
	CASE WHEN ie_tipo_item='M' THEN  substr(pls_obter_dados_material(cd_item,'UM'),1,255)  ELSE null END  ds_unidade_medida, 
	nr_seq_partic_proc, 
	pls_obter_ie_valor_glosa(nr_seq_item, ie_tipo_item) ie_tipo_glosa, 
	ds_item_importacao, 
	CASE WHEN ie_tipo_item='P' THEN  substr(cd_medico_executor||' - '||obter_nome_pf(cd_medico_executor),1,255)  ELSE null END  ds_medico_executor, 
	pls_obter_cd_tiss_participacao(nr_seq_grau_partic) cd_tiss, 
	ie_faturamento, 
	nr_seq_regra_preco_pos, 
	nr_seq_pos_estab_interc, 
	nr_seq_conta_proc, 
	nr_seq_conta_mat, 
	cd_item_convertido, 
	ds_item_convertido 
from	w_pls_resumo_conta 
where	ie_tipo_item = 'R' 

union
 
select	nr_ordem ie_ordem, 
	1 ie_ordem_titulo, 
	null, 
	null, 
	null,	 
	substr('     ' ||CASE WHEN coalesce(coalesce(pls_obter_cod_mat_analise(cd_item, ds_tipo_despesa),cd_item),0)=0 THEN InitCap(pls_obter_desc_item_desp(ds_tipo_despesa, 'S'))||' não reconhecido.'  ELSE ds_item END ,1,255) ds_item_despesa, 
	cd_item, 
	null, 
	null, 
	null, 
	null, 
	trunc(dt_item)||' '||to_char(dt_inicio_item, 'hh24:mi:ss') dt_item, 
	null, 
	ie_origem_proced, 
	null, 
	null, 
	null qt_apresentado, 
	null qt_liberado, 
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'UL') vl_unitario, 
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'TL') vl_total, 
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'UA') vl_unitario_apres,    
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'TA') vl_total_apres, 
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'TC') vl_calculado, 
	null, 
	null, 
	null, 
	1 nr_seq_apres, 
	CASE WHEN ie_status='C' THEN  'C'  ELSE 'I' END  ie_status_item, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	nr_seq_analise, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	nr_seq_analise, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	nr_seq_item_ref, 
	pls_obter_vl_item_ptu(nr_seq_item_ref, nr_seq_analise, 'UC') vl_uni_calculado, 
	ds_item ds_item_despesa_order, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null,	 
	null, 
	null, 
	null, 
	null, 
	null nm_usuario_liberacao, 
	null nr_seq_conta_proc, 
	null nr_seq_conta_mat, 
	null cd_item_convertido, 
	null ds_item_convertido 
from	w_pls_resumo_conta 
where	ie_tipo_item = 'R' 
group by nr_ordem, 
	 ds_tipo_despesa, 
	 cd_item,	 
	 dt_item, 
	 dt_inicio_item, 
	 ie_origem_proced, 
	 nr_seq_analise, 
	 ie_tipo_despesa, 
	 nr_seq_analise, 
	 nr_seq_item_ref, 
	 ds_item, 
	 ie_status;

