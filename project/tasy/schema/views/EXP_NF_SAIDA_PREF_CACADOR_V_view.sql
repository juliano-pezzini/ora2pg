-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nf_saida_pref_cacador_v (nr_nota_fiscal, tp_registro, cd_cgc_prefeitura, ie_tipo_toma_prest, ie_tipo_inscricao, cd_cpf_cnpj_prest, cd_cpf_cnpj_tomador, nm_prestador, nm_tomador, cd_serie_nf, nr_primeira_nota, nr_ultima_nota, dt_emissao, ie_tipo_documento, ie_situacao_nota, vl_total_nota, ds_local_tomador, cd_municipio_ibge_toma, cd_cnae, vl_servico, cd_municipio_ibge_prest, ie_opcao_simples_nacional, cd_estabelecimento, ds_motivo_cancel) AS select	0					nr_nota_fiscal,
	0					tp_registro, 
	'83074302000131001'			cd_cgc_prefeitura, 
	'P'					ie_tipo_toma_prest, 
	1					ie_tipo_inscricao, 
	''					cd_cpf_cnpj_prest, 
	null					cd_cpf_cnpj_tomador, 
	''					nm_prestador, 
	''					nm_tomador, 
	null					cd_serie_nf, 
	null					nr_primeira_nota, 
	''					nr_ultima_nota, 
	null					dt_emissao, 
	''					ie_tipo_documento, 
	''					ie_situacao_nota, 
	null					vl_total_nota, 
	''					ds_local_tomador, 
	null					cd_municipio_ibge_toma, 
	null					cd_cnae, 
	null					vl_servico, 
	null					cd_municipio_ibge_prest, 
	''					ie_opcao_simples_nacional, 
	cd_estabelecimento				cd_estabelecimento, 
	''					ds_motivo_cancel 
FROM	estabelecimento 

union
 
--declaração prestador 
select	0					nr_nota_fiscal, 
	1					tp_registro, 
	''					cd_cgc_prefeitura, 
	'P'					ie_tipo_toma_prest, 
	1					ie_tipo_inscricao, 
	lpad(Obter_cgc_estabelecimento(cd_estabelecimento),14,' ') cd_cpf_cnpj_prest, 
	null					cd_cpf_cnpj_tomador, 
	rpad(obter_razao_social(Obter_cgc_estabelecimento(cd_estabelecimento)),50,' ') nm_prestador, 
	''					nm_tomador, 
	null					cd_serie_nf, 
	null					nr_primeira_nota, 
	''					nr_ultima_nota, 
	null					dt_emissao, 
	''					ie_tipo_documento, 
	''					ie_situacao_nota, 
	null					vl_total_nota, 
	''					ds_local_tomador, 
	null					cd_municipio_ibge_toma, 
	null					cd_cnae, 
	null					vl_servico, 
	null					cd_municipio_ibge_prest, 
	''					ie_opcao_simples_nacional, 
	cd_estabelecimento				cd_estabelecimento, 
	''					ds_motivo_cancel 
from	estabelecimento 

union
 
--documentos tomador 
select	n.nr_sequencia					nr_nota_fiscal, 
	2						tp_registro, 
	''						cd_cgc_prefeitura, 
	''						ie_tipo_toma_prest, 
	1						ie_tipo_inscricao, 
	null						cd_cpf_cnpj_prest, 
	lpad(CASE WHEN(coalesce(n.cd_cgc,'X'))='X' THEN obter_dados_pf(n.cd_pessoa_fisica,'CPF')  ELSE n.cd_cgc END ,14,' ') cd_cpf_cnpj_tomador, 
	''						nm_prestador, 
	rpad(obter_dados_nota_fiscal(n.nr_sequencia, 5),50,' ') nm_tomador, 
	n.cd_serie_nf					cd_serie_nf, 
	n.nr_nota_fiscal				nr_primeira_nota, 
	''						nr_ultima_nota, 
	n.dt_emissao					dt_emissao, 
	'N'						ie_tipo_documento, 
	CASE WHEN n.ie_situacao=1 THEN 'N' WHEN n.ie_situacao=9 THEN 'C' END 		ie_situacao_nota, 
	lpad(CASE WHEN n.ie_situacao=9 THEN  0  ELSE elimina_caractere_especial(campo_mascara(n.vl_total_nota,2)) END ,15,0)	vl_total_nota, 
	CASE WHEN obter_dados_pf_pj(n.cd_pessoa_fisica, null, 'CI')='Caçador' THEN 'D'  ELSE 'F' END  ds_local_tomador, 
	substr((obter_compl_pf(n.cd_pessoa_fisica, 1, 'CDMDV')),1,7) cd_municipio_ibge_toma, 
	null					cd_cnae, 
	null					vl_servico, 
	null					cd_municipio_ibge_prest, 
	'N'					ie_opcao_simples_nacional, 
	n.cd_estabelecimento			cd_estabelecimento, 
	substr(obter_motivo_cancel_conta(a.nr_seq_motivo_cancel), 1, 255) ds_motivo_cancel 
FROM nota_fiscal n
LEFT OUTER JOIN conta_paciente a ON (n.nr_interno_conta = a.nr_interno_conta)
WHERE exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
 
union
 
--serviços 
select	n.nr_sequencia				nr_nota_fiscal, 
	3					tp_registro, 
	''					cd_cgc_prefeitura, 
	''					ie_tipo_toma_prest, 
	null					ie_tipo_inscricao, 
	null					cd_cpf_cnpj_prest, 
	null					cd_cpf_cnpj_tomador, 
	''					nm_prestador, 
	''					nm_tomador, 
	null					cd_serie_nf, 
	null					nr_primeira_nota, 
	''					nr_ultima_nota, 
	null					dt_emissao, 
	''					ie_tipo_documento, 
	''					ie_situacao_nota, 
	null					vl_total_nota, 
	''					ds_local_tomador, 
	null					cd_municipio_ibge_toma, 
	lpad(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), 
	obter_procedimento_nfse(n.nr_sequencia,'O')),'CD'),7,' ') cd_cnae, 
	lpad(CASE WHEN n.ie_situacao=9 THEN  0  ELSE elimina_caractere_especial(campo_mascara(sum(i.vl_total_item_nf),2)) END ,15,0) vl_servico, 
	obter_dados_pf_pj(null, n.cd_cgc_emitente,'CDMDV') cd_municipio_ibge_prest, 
	''					ie_opcao_simples_nacional, 
	n.cd_estabelecimento			cd_estabelecimento, 
	''					ds_motivo_cancel 
from	operacao_nota o, 
	nota_fiscal n, 
	nota_fiscal_item i 
where	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
and	o.cd_operacao_nf = n.cd_operacao_nf 
and	i.nr_sequencia = n.nr_sequencia 
group by n.nr_sequencia, n.cd_cgc_emitente, n.cd_estabelecimento, n.ie_situacao 
order by nr_nota_fiscal;

