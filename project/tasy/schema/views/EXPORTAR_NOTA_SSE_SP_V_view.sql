-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exportar_nota_sse_sp_v (tp_registro, nr_sequencia, dt_emissao, dt_entrada_saida, cd_estabelecimento, valor_registro) AS SELECT	1 																TP_REGISTRO,
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	null																DT_ENTRADA_SAIDA, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'COD_UNIDADE;DT_ENVIO;TIPO' 													VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
  
--Valor Cabecalho 
SELECT	2 																TP_REGISTRO, 
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	null																DT_ENTRADA_SAIDA, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'ATIV')								||';'|| 
	to_char(LOCALTIMESTAMP,'yyyy-mm-dd') 													||';'|| 
	'NF' VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
 
--Texto Nota Fiscal 
SELECT	3 																TP_REGISTRO, 
	0																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	null																DT_ENTRADA_SAIDA, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'N;NUMERO_NF;SERIE_NF;NATUREZA_OPERACAO;TOTAL_DUPLICATAS;BASE_CALCULO_ICMS;VALOR_ICMS;BASE_CALCULO_ICMS_ST;VALOR_ICMS_ST;VALOR_TOTAL_PROD;VALOR_FRETE;VALOR_SEGURO;DESCONTO;DESPESAS_ACESSORIAS;VALOR_IPI_ISS;VALOR_NF;DT_EMISSAO;RAZAO_SOCIAL;CNPJ;INSCRICAO_ESTADUAL;ENDERECO;ENDERECO_NUMERO;ENDERECO_COMPLEMENTO;BAIRRO;ESTADO;MUNICIPIO;CEP;DDD;TELEFONE' 	VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
 
--Texto Duplicata 
SELECT	4 																TP_REGISTRO, 
	0 																NR_SEQUENCIA, 
	null																 
	, 
	null																DT_ENTRADA_SAIDA, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'D;NUMERO_NF;SERIE_NF;DUPLICATA;VALOR_DUPLICATA;DT_VENCIMENTO;VALOR_PAGO;DT_PAGAMENTO'						VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

union
 
--Texto Itens 
SELECT	5 																TP_REGISTRO, 
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	null																DT_ENTRADA_SAIDA, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'I;NUMERO_NF;SERIE_NF;COD_PROD;DESCRICAO_PRODUTO;NCM;CFOP;COD_SERVICO;ID_DESPESA;UNIDADE_MEDIDA;QUANTIDADE;VALOR_UNITARIO;DESCONTO_PERCENTUAL;VALOR_TOTAL;BASE_CALCULO_ICMS;VALOR_ICMS;VALOR_IPI_ISS;ALIQ_ICMS;ALIQ_IPI_ISS' 	  												VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
  
--Valores Nota Fiscal 
select	6 																TP_REGISTRO, 
	n.nr_sequencia 															NR_SEQUENCIA, 
	(	select	min(p.dt_liquidacao) 
		from	titulo_pagar p, 
			nota_fiscal_venc v 
		where  v.nr_sequencia = n.nr_sequencia	 
		and	v.nr_sequencia = p.nr_seq_nota_fiscal 
		and	p.ie_situacao = 'L')												DT_EMISSAO, 
	n.dt_entrada_saida														DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'N' 																||';'|| 
	n.nr_nota_fiscal 														||';'|| 
	n.cd_serie_nf 															||';'|| 
	Obter_Desc_Natureza_Operacao(n.cd_natureza_operacao) 										||';'|| 
	(select count(*) from nota_fiscal_venc v where v.nr_sequencia = n.nr_sequencia) 						||';'|| 
	Campo_Mascara(obter_base_calc_icms_nf(n.nr_sequencia),2)									||';'|| 
	Campo_Mascara(obter_valor_tipo_trib_item_nf(n.nr_sequencia,null,'ICMS'),2)							||';'|| 
	Campo_Mascara(obter_base_icmsst_nf(n.nr_sequencia),2)										||';'|| 
	Campo_Mascara(obter_valor_tipo_trib_item_nf(n.nr_sequencia,null,'ICMSST'),2)							||';'|| 
	Campo_Mascara(n.vl_mercadoria,2)												||';'|| 
	Campo_Mascara(n.vl_frete,2)													||';'|| 
	Campo_Mascara(coalesce(n.vl_seguro,0),2)												||';'|| 
	Campo_Mascara((select sum(vl_desconto) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia),2)			||';'|| 
	Campo_Mascara((select sum(i.vl_despesa_acessoria) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia),2)		||';'|| 
	Campo_Mascara(CASE WHEN n.vl_ipi=0 THEN  obter_valor_tipo_trib_item_nf(n.nr_sequencia,null,'ISS')  ELSE n.vl_ipi END ,2)				||';'|| 
	Campo_Mascara((coalesce(n.vl_mercadoria,0) + coalesce(n.vl_frete,0) + coalesce(n.vl_seguro,0) + coalesce(n.vl_despesa_acessoria,0) + coalesce(n.vl_ipi,0) - coalesce(n.vl_descontos,0)),2)					||';'|| 
	to_char(TRUNC(n.dt_emissao),'yyyy-mm-dd') 											||';'|| 
	OBTER_RAZAO_SOCIAL(n.cd_cgc_emitente) 												||';'|| 
	(SubStr(n.cd_cgc_emitente,1,2) || '.' ||SubStr(n.cd_cgc_emitente,3,3) || '.' ||SubStr(n.cd_cgc_emitente,6,3) || '/' ||SubStr(n.cd_cgc_emitente,9,4) || '-' ||SubStr(n.cd_cgc_emitente,13,2))	||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'IE')											||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'EN') 											||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'NR') 											||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'CO') 											||';'||	 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'B') 											||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'UF') 											||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'CI') 											||';'|| 
	CASE WHEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP') IS NULL THEN ''  ELSE substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP'),1,5)||'-'||substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP'),-3) END  	||';'|| 
	obter_dados_pf_pj(null,n.cd_cgc_emitente,'DDT') 												||';'|| 
	CASE WHEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'T') IS NULL THEN ''  ELSE substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'T'),1,4)||'-'||substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'T'),-4) END 	VALOR_REGISTRO 
from 	nota_fiscal n, 
	natureza_operacao t, 
	operacao_nota o 
where 	t.cd_natureza_operacao = n.cd_natureza_operacao 
and	o.cd_operacao_nf = n.cd_operacao_nf 
and	n.ie_situacao = 1 
and 	((o.ie_tipo_operacao = 1) or (o.ie_servico = 'S')) 
and	exists (	select	1 
		from	titulo_pagar p, 
			nota_fiscal_venc v 
		where  	v.nr_sequencia = n.nr_sequencia	 
		and	v.nr_sequencia = p.nr_seq_nota_fiscal 
		and	v.nr_titulo_pagar = p.nr_titulo 
		and	p.ie_situacao = 'L') 

UNION
  
--Valores Duplicata da Nota 
select	TP_REGISTRO, 
	NR_SEQUENCIA, 
	DT_EMISSAO, 
	DT_ENTRADA_SAIDA, 
	CD_ESTABELECIMENTO, 
	VALOR_REGISTRO 
from	( 
	select 7 															TP_REGISTRO, 
		n.nr_sequencia 														NR_SEQUENCIA, 
		(	select	min(p.dt_liquidacao) 
			from	titulo_pagar p, 
				nota_fiscal_venc v 
			where 	v.nr_sequencia = n.nr_sequencia	 
			and	v.nr_sequencia = p.nr_seq_nota_fiscal 
			and	p.ie_situacao = 'L')											DT_EMISSAO, 
		n.dt_entrada_saida													DT_ENTRADA_SAIDA, 
		n.cd_estabelecimento 													CD_ESTABELECIMENTO, 
		'D' 															||';'|| 
		n.nr_nota_fiscal 													||';'|| 
		n.cd_serie_nf 														||';'|| 
		coalesce(CASE WHEN t.NR_PARCELAS=0 THEN 1  ELSE t.NR_PARCELAS END ,1) 										||';'|| 
		Campo_Mascara((t.vl_titulo)::numeric ,2)											||';'|| 
		to_char(TRUNC(T.dt_vencimento_atual),'yyyy-mm-dd')									||';'|| 
		CASE WHEN t.ie_situacao='L' THEN Campo_Mascara((CASE WHEN obter_valor_pago_tit_pagar(nr_titulo)=0 THEN obter_dados_tit_pagar(nr_titulo,'A')  ELSE obter_valor_pago_tit_pagar(nr_titulo) END  )::numeric ,2)  ELSE '' END  	||';'|| 
		CASE WHEN t.ie_situacao='L' THEN to_char(TRUNC(t.dt_liquidacao),'yyyy-mm-dd')  ELSE '' END 						VALOR_REGISTRO 
	from 	nota_fiscal n, 
		nota_fiscal_venc v, 
		titulo_pagar t, 
		operacao_nota o 
	where 	v.nr_sequencia = n.nr_sequencia 
	and	o.cd_operacao_nf = n.cd_operacao_nf 
	and  	v.nr_sequencia = t.nr_seq_nota_fiscal 
	and	t.nr_titulo = v.nr_titulo_pagar 
	and	n.ie_situacao = 1 
	and 	((o.ie_tipo_operacao = 1) or (o.ie_servico = 'S')) 
	and	exists (	select	1 
			from	titulo_pagar p, 
				nota_fiscal_venc x 
			where  	x.nr_sequencia = n.nr_sequencia	 
			and	x.nr_sequencia = p.nr_seq_nota_fiscal 
			and	x.nr_titulo_pagar = p.nr_titulo 
			and	p.ie_situacao = 'L') 
	order by t.NR_PARCELAS 
	) alias84	 

UNION
  
--Valores Item da Nota 
select 8 																TP_REGISTRO, 
	n.nr_sequencia 															NR_SEQUENCIA, 
	(	select	min(p.dt_liquidacao) 
		from	titulo_pagar p, 
			nota_fiscal_venc v 
		where  v.nr_sequencia = n.nr_sequencia	 
		and	v.nr_sequencia = p.nr_seq_nota_fiscal 
		and	p.ie_situacao = 'L')												DT_EMISSAO, 
	n.dt_entrada_saida														DT_ENTRADA_SAIDA, 
	n.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'I' 																||';'|| 
	n.nr_nota_fiscal 														||';'|| 
	n.cd_serie_nf 															||';'|| 
	CASE WHEN o.ie_nf_eletronica='S' THEN '0'  ELSE CASE WHEN i.CD_MATERIAL IS NULL THEN '0'  ELSE i.CD_MATERIAL END  END 						||';'||			 
	CASE WHEN i.CD_MATERIAL IS NULL THEN Obter_Desc_Procedimento(i.CD_PROCEDIMENTO,i.IE_ORIGEM_PROCED)  ELSE Obter_Desc_Material(i.CD_MATERIAL) END  	||';'|| 
	CASE WHEN o.ie_nf_eletronica='S' THEN ''  ELSE CASE WHEN i.CD_MATERIAL IS NULL THEN ''  ELSE obter_dados_ncm(m.nr_seq_ncm,'C') END  END 		||';'|| 
	obter_dados_natureza_operacao(i.cd_natureza_operacao,'CF') 									||';'||	 
	CASE WHEN o.ie_servico='S' THEN obter_item_servico_proced_mat(n.nr_sequencia)  ELSE '' END 							||';'||	 
	obter_despesa_proc_mat(i.cd_material,i.cd_procedimento,i.ie_origem_proced)							||';'|| 
	i.cd_unidade_medida_estoque 													||';'|| 
	CASE WHEN i.CD_MATERIAL IS NULL THEN ''  ELSE Campo_Mascara(i.qt_item_nf,2) END 									||';'|| 
	Campo_Mascara(i.vl_unitario_item_nf,4)												||';'|| 
	Campo_Mascara(i.vl_desconto,2)													||';'|| 
	Campo_Mascara(i.vl_total_item_nf,2)												||';'|| 
	Campo_Mascara(coalesce(obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'ICMS','BC'),0),2)						||';'|| 
	Campo_Mascara(coalesce(obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'ICMS','VT'),0),2)						||';'|| 
	Campo_Mascara(coalesce(CASE WHEN o.ie_servico='S' THEN  obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'ISS','VT')  ELSE obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'IPI','VT') END ,0),2)	||';'|| 
	Campo_Mascara(coalesce(obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'ICMS','TX'),0),2)						||';'|| 
	Campo_Mascara(coalesce(CASE WHEN o.ie_servico='S' THEN  obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'ISS','VT')  ELSE obter_valor_nf_item(n.nr_sequencia,i.nr_item_nf,'IPI','TX') END ,0),2)	VALOR_REGISTRO 
from 	nota_fiscal n, 
	nota_fiscal_item i, 
	operacao_nota o, 
	material_fiscal m 
where 	i.nr_sequencia = n.nr_sequencia 
and	m.cd_material = i.cd_material 
and	o.cd_operacao_nf = n.cd_operacao_nf 
and	n.ie_situacao = 1 
and 	((o.ie_tipo_operacao = 1) or (o.ie_servico = 'S')) 
and	exists (	select	1 
		from	titulo_pagar p, 
			nota_fiscal_venc v 
		where  	v.nr_sequencia = n.nr_sequencia	 
		and	v.nr_sequencia = p.nr_seq_nota_fiscal 
		and	v.nr_titulo_pagar = p.nr_titulo 
		and	p.ie_situacao = 'L');

