-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW atendimento_acerto_pend_v (nr_atendimento, dt_alta, cd_motivo_alta, cd_pessoa_fisica, ie_tipo_atendimento, dt_entrada, cd_setor_atendimento, cd_unidade, cd_convenio, cd_categoria, ds_setor_atendimento, ds_convenio, nm_paciente, nr_prontuario, dt_nascimento, dt_fim_conta) AS SELECT /*+ ORDERED index(C atecaco_i2) */       A.NR_ATENDIMENTO,
       A.DT_ALTA,
       A.CD_MOTIVO_ALTA,
       A.CD_PESSOA_FISICA,
       A.IE_TIPO_ATENDIMENTO,
       A.DT_ENTRADA,
       B.CD_SETOR_ATENDIMENTO,
       B.CD_UNIDADE_BASICA || ' ' ||B.CD_UNIDADE_COMPL  cd_unidade,
       C.CD_CONVENIO,
       C.CD_CATEGORIA,
       S.DS_SETOR_ATENDIMENTO,
       V.DS_CONVENIO,
       P.NM_PESSOA_FISICA NM_PACIENTE,
       P.NR_PRONTUARIO,
       P.DT_NASCIMENTO,
       A.DT_FIM_CONTA
FROM   ATENDIMENTO_PACIENTE A,
       ATEND_CATEGORIA_CONVENIO C,
       CONVENIO V,
       ATEND_PACIENTE_UNIDADE B,
       SETOR_ATENDIMENTO S,
       PESSOA_FISICA P
WHERE (A.DT_FIM_CONTA IS NULL)
  AND (A.DT_ALTA IS NOT NULL)
  AND (A.NR_ATENDIMENTO = B.NR_ATENDIMENTO)
  AND (B.DT_ENTRADA_UNIDADE =
      (SELECT /*+ ORDERED */              MAX(X.DT_ENTRADA_UNIDADE) DT_ULTIMA_ENTRADA
       FROM  ATEND_PACIENTE_UNIDADE X, SETOR_ATENDIMENTO Y
       WHERE X.NR_ATENDIMENTO = A.NR_ATENDIMENTO
         AND X.CD_SETOR_ATENDIMENTO = Y.CD_SETOR_ATENDIMENTO
         AND Y.CD_CLASSIF_SETOR IN (3,4,8)) )
  AND (A.NR_ATENDIMENTO = C.NR_ATENDIMENTO)
  AND (C.DT_INICIO_VIGENCIA =
      (SELECT MAX(W.DT_INICIO_VIGENCIA) DT_ULTIMA_VIGENCIA
       FROM ATEND_CATEGORIA_CONVENIO W
       WHERE W.NR_ATENDIMENTO = A.NR_ATENDIMENTO) )
  AND (A.CD_PESSOA_FISICA      = P.CD_PESSOA_FISICA)
  AND (B.CD_SETOR_ATENDIMENTO  = S.CD_SETOR_ATENDIMENTO)
  AND (C.CD_CONVENIO           = V.CD_CONVENIO);

