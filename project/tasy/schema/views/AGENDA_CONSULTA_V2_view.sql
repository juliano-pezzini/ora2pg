-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW agenda_consulta_v2 (nr_sequencia, cd_agenda, ds_agenda, dt_agenda, nr_minuto_duracao, ie_status_agenda, ie_classif_agenda, dt_atualizacao, nm_usuario, cd_convenio, cd_pessoa_fisica, nm_pessoa_contato, ds_observacao, ie_status_paciente, nr_seq_consulta, nm_paciente, nr_atendimento, dt_confirmacao, ds_confirmacao, nr_telefone, qt_idade_pac, nr_seq_plano, nr_seq_classif_med, nm_usuario_origem, ie_necessita_contato, nr_seq_sala, cd_categoria, cd_tipo_acomodacao, cd_usuario_convenio, cd_complemento, dt_validade_carteira, nr_doc_convenio, cd_senha, nr_seq_agepaci, ds_senha, dt_nascimento_pac, cd_turno, dt_agendamento, cd_medico, nr_seq_hora, nr_seq_pq_proc, cd_motivo_cancelamento, cd_procedimento, nr_seq_proc_interno, qt_total_secao, nr_secao, ie_origem_proced, dt_aguardando, dt_consulta, dt_atendido, cd_medico_solic, nr_seq_indicacao, cd_pessoa_indicacao, cd_setor_atendimento, dt_provavel_term, ie_encaixe, ie_retorno, ds_motivo_copia_trans, nm_usuario_acesso, nm_usuario_copia_trans, dt_copia_trans, nr_seq_motivo_transf, nm_usuario_horario, cd_medico_req, cd_plano, nm_usuario_confirm, nr_seq_turno, dt_status, ds_motivo_status, nm_usuario_status, nr_seq_oftalmo, nm_usuario_aguardando, nm_usuario_consulta, nm_usuario_atendido, nr_seq_preferencia, nr_seq_agenda_rxt, cd_cid, cd_procedencia, dt_horario_forcado, nr_seq_agenda_sessao, nr_seq_exame, nr_seq_forma_confirmacao, nr_seq_motivo_encaixe, cd_setor_coleta, cd_setor_entrega, ie_forma_agendamento, nr_seq_status_pac, cd_empresa_ref, ie_bloqueado_manual, nr_seq_turno_esp, qt_procedimento, nr_atend_pls, nr_seq_motivo_bloq, nr_seq_evento_atend, qt_peso, qt_altura_cm, cd_especialidade, ie_autorizacao, nr_seq_rp_mod_item, nr_seq_rp_item_ind, nr_controle_secao, nr_seq_fa_entrega, nr_seq_agend_coletiva, ie_transferido, ds_dados_cobranca, ie_confirmacao_aut, ie_classif_agenda_origem, nm_usuario_confirm_encaixe, dt_confirm_encaixe, nm_medico_externo, crm_medico_externo, nr_seq_segurado, dt_chegada, nr_seq_pac_senha_fila, cd_agendamento_externo, nr_seq_motivo_agendamento, nr_reserva, nr_seq_pac_reab, nr_seq_lista_espera, nm_usuario_cancelamento, qt_diaria_prev, dt_cancelamento, nr_seq_unidade, nr_seq_classif, ie_carater_inter_sus, ie_tipo_atendimento, ie_chamada_painel, ie_regra, nr_seq_regra, ie_glosa, ie_agenda_web, nr_seq_paciente_pmc, nr_seq_apres_classif, qt_valor_cobranca, cd_pessoa_responsavel, nr_tel_responsavel, nm_pessoa_responsavel, nr_controle_sus, ds_motivo_atraso, dt_status_atendido, dt_em_exame, ie_agenda_transf, nr_seq_motivo_atraso, ie_horario_forcado, nr_transacao_sus, ds_observacao_fat, cd_convenio_turno, cd_material_exame, ie_envio_sms, nr_seq_agendamento, nr_matricula_ageweb, dt_vinculacao_atendimento, nr_seq_motivo_prazo, ds_motivo_prazo, cd_cgc_indicacao, cd_regulacao_sus, cd_chave_regulacao_sus, nr_seq_motivo_reserva, nr_seq_transporte, nm_pessoa_indicacao, nr_seq_tipo_midia, qt_anos, nm_pessoa_fisica, ds_idade, nr_telefone_celular, nr_telefone_contato, nr_prontuario, ds_status_agenda, ds_classif_agenda, ds_classif_agenda_tasy, cd_classif_tasy, ds_convenio, ds_status_paciente, nr_seq_agenda, dt_entrada, dt_saida, qt_min_espera_tasy, qt_min_espera, qt_min_consulta, ds_convenio_plano, nr_minutos_atraso, ds_classif_pac, ds_cor_fonte, ds_cor_fundo, ds_cor_fonte_pac, ds_cor_fundo_pac, dt_entrada_tasy, nm_agenda, qt_aguardando, qt_consulta, ds_indicacao, nm_pessoa_indicacao_agenda, cd_sistema_ant, ds_obs_agenda, dt_agepaci, ds_motivo, nm_medico_req, ds_plano, dt_nasc, ie_enviar_email_confirmacao, ie_chamado, ds_classif_proced, nm_usuario_alteracao, dt_alteracao, ie_classif_agenda2, ds_senha_pac, nr_seq_fila_espera, cd_senha_gerada, qt_chamadas, nm_medico_residente, nr_seq_captacao, ds_cor_fundo_classif, ds_cor_fonte_classif, dt_geracao_senha, nr_ddi, nr_ddi_celular, ie_reference_letter, ie_emergency_response_required, ds_procedencia, cd_tipo_agenda) AS select	a.nr_sequencia,
	a.cd_agenda,
	x.ds_agenda,
	a.dt_agenda,
	a.nr_minuto_duracao,
	a.ie_status_agenda,
	a.ie_classif_agenda,
	a.dt_atualizacao,
	a.nm_usuario,
	a.cd_convenio,
	a.cd_pessoa_fisica,
	a.nm_pessoa_contato,
	a.ds_observacao,
	a.ie_status_paciente,
	a.nr_seq_consulta,
	a.nm_paciente,
	a.nr_atendimento,
	a.dt_confirmacao,
	a.ds_confirmacao,
	a.nr_telefone,
	a.qt_idade_pac,
	a.nr_seq_plano,
	a.nr_seq_classif_med,
	a.nm_usuario_origem,
	a.ie_necessita_contato,
	a.nr_seq_sala,
	a.cd_categoria,
	a.cd_tipo_acomodacao,
	a.cd_usuario_convenio,
	a.cd_complemento,
	a.dt_validade_carteira,
	a.nr_doc_convenio,
	a.cd_senha,
	a.nr_seq_agepaci,
	a.ds_senha,
	a.dt_nascimento_pac,
	a.cd_turno,
	a.dt_agendamento,
	a.cd_medico,
	a.nr_seq_hora,
	a.nr_seq_pq_proc,
	a.cd_motivo_cancelamento,
	a.cd_procedimento,
	a.nr_seq_proc_interno,
	a.qt_total_secao,
	a.nr_secao,
	a.ie_origem_proced,
	a.dt_aguardando,
	a.dt_consulta,
	a.dt_atendido,
	a.cd_medico_solic,
	a.nr_seq_indicacao,
	a.cd_pessoa_indicacao,
	a.cd_setor_atendimento,
	a.dt_provavel_term,
	a.ie_encaixe,
	a.ie_retorno,
	a.ds_motivo_copia_trans,
	a.nm_usuario_acesso,
	a.nm_usuario_copia_trans,
	a.dt_copia_trans,
	a.nr_seq_motivo_transf,
	a.nm_usuario_horario,
	a.cd_medico_req,
	a.cd_plano,
	a.nm_usuario_confirm,
	a.nr_seq_turno,
	a.dt_status,
	a.ds_motivo_status,
	a.nm_usuario_status,
	a.nr_seq_oftalmo,
	a.nm_usuario_aguardando,
	a.nm_usuario_consulta,
	a.nm_usuario_atendido,
	a.nr_seq_preferencia,
	a.nr_seq_agenda_rxt,
	a.cd_cid,
	a.cd_procedencia,
	a.dt_horario_forcado,
	a.nr_seq_agenda_sessao,
	a.nr_seq_exame,
	a.nr_seq_forma_confirmacao,
	a.nr_seq_motivo_encaixe,
	a.cd_setor_coleta,
	a.cd_setor_entrega,
	a.ie_forma_agendamento,
	a.nr_seq_status_pac,
	a.cd_empresa_ref,
	a.ie_bloqueado_manual,
	a.nr_seq_turno_esp,
	a.qt_procedimento,
	a.nr_atend_pls,
	a.nr_seq_motivo_bloq,
	a.nr_seq_evento_atend,
	a.qt_peso,
	a.qt_altura_cm,
	a.cd_especialidade,
	a.ie_autorizacao,
	a.nr_seq_rp_mod_item,
	a.nr_seq_rp_item_ind,
	a.nr_controle_secao,
	a.nr_seq_fa_entrega,
	a.nr_seq_agend_coletiva,
	a.ie_transferido,
	a.ds_dados_cobranca,
	a.ie_confirmacao_aut,
	a.ie_classif_agenda_origem,
	a.nm_usuario_confirm_encaixe,
	a.dt_confirm_encaixe,
	a.nm_medico_externo,
	a.crm_medico_externo,
	a.nr_seq_segurado,
	a.dt_chegada,
	a.nr_seq_pac_senha_fila,
	a.cd_agendamento_externo,
	a.nr_seq_motivo_agendamento,
	a.nr_reserva,
	a.nr_seq_pac_reab,
	a.nr_seq_lista_espera,
	a.nm_usuario_cancelamento,
	a.qt_diaria_prev,
	a.dt_cancelamento,
	a.nr_seq_unidade,
	a.nr_seq_classif,
	a.ie_carater_inter_sus,
	a.ie_tipo_atendimento,
	a.ie_chamada_painel,
	a.ie_regra,
	a.nr_seq_regra,
	a.ie_glosa,
	a.ie_agenda_web,
	a.nr_seq_paciente_pmc,
	a.nr_seq_apres_classif,
	a.qt_valor_cobranca,
	a.cd_pessoa_responsavel,
	a.nr_tel_responsavel,
	a.nm_pessoa_responsavel,
	a.nr_controle_sus,
	a.ds_motivo_atraso,
	a.dt_status_atendido,
	a.dt_em_exame,
	a.ie_agenda_transf,
	a.nr_seq_motivo_atraso,
	a.ie_horario_forcado,
	a.nr_transacao_sus,
	a.ds_observacao_fat,
	a.cd_convenio_turno,
	a.cd_material_exame,
	a.ie_envio_sms,
	a.nr_seq_agendamento,
	a.nr_matricula_ageweb,
	a.dt_vinculacao_atendimento,
	a.nr_seq_motivo_prazo,
	a.ds_motivo_prazo,
	a.cd_cgc_indicacao,
	a.cd_regulacao_sus,
	a.cd_chave_regulacao_sus,
	a.nr_seq_motivo_reserva,
	a.nr_seq_transporte,
	a.nm_pessoa_indicacao,
	a.nr_seq_tipo_midia,
	coalesce(qt_idade_pac, substr(obter_idade(b.dt_nascimento, LOCALTIMESTAMP, 'A'),1,3)) 	qt_anos,
	coalesce(b.nm_pessoa_fisica,a.nm_paciente) nm_pessoa_fisica,
	substr(obter_idade(coalesce(a.DT_NASCIMENTO_PAC, b.dt_nascimento), LOCALTIMESTAMP, 'S'),1,30) ds_idade,
	b.nr_telefone_celular,
	coalesce(a.nr_telefone, b.nr_telefone_celular) nr_telefone_contato,
	b.nr_prontuario,
	c.ds_status_agenda,
	substr(obter_classif_agenda_turno(a.ie_classif_agenda, a.nr_seq_classif_med),1,60) ds_classif_agenda,
	substr(obter_classif_agenda_consulta(ie_classif_agenda),1,40) ds_classif_agenda_tasy,
	Obter_classif_tasy_Agecons(a.ie_classif_agenda) cd_classif_tasy,
	e.ds_convenio,
	g.ds_status_paciente,
	f.nr_seq_agenda,
	f.dt_entrada,
	f.dt_saida,
	Obter_Tempo_Espera_Atend(a.nr_atendimento) qt_min_espera_tasy,
	to_number(CASE WHEN f.dt_entrada IS NULL THEN  null  ELSE CASE WHEN a.ie_status_agenda='N' THEN  null  ELSE round((coalesce(f.dt_inicio_consulta, LOCALTIMESTAMP) - f.dt_entrada) *			1440) END  END ) qt_min_espera,
	to_number(CASE WHEN f.dt_inicio_consulta IS NULL THEN  null  ELSE round((coalesce(f.dt_saida,LOCALTIMESTAMP) - f.dt_inicio_consulta) * 1440) END ) 	qt_min_Consulta,
	e.ds_convenio || '  ' || substr(Obter_descricao_padrao('MED_PLANO', 'DS_PLANO', a.nr_seq_plano),1,150) ds_convenio_plano,
	obter_minutos_atraso_agenda(a.nr_sequencia) nr_minutos_atraso,
	substr(Obter_Med_Classif_Paciente(
	obter_codigo_sist_orig(a.cd_pessoa_fisica, x.cd_pessoa_fisica), x.cd_pessoa_fisica),1,100) ds_classif_pac,
	substr(Obter_Cor_Classif_Agenda(x.cd_pessoa_fisica, a.ie_classif_agenda, 'F'),1,20) ds_cor_fonte,
	substr(Obter_Cor_Classif_Agenda(x.cd_pessoa_fisica, a.ie_classif_agenda, 'U'),1,20) ds_cor_fundo,
	substr(obter_cor_status_pac(nr_seq_status_pac,2),1,20) DS_COR_FONTE_PAC,
	substr(obter_cor_status_pac(nr_seq_status_pac,1),1,20) DS_COR_FUNDO_PAC,
	OBTER_DATA_ENTRADA(a.nr_atendimento) dt_entrada_tasy,
	substr(obter_nome_agenda_cons(a.cd_agenda),1,80) nm_agenda,
	obter_minutos_espera(dt_aguardando, dt_consulta) qt_aguardando,
	obter_minutos_espera(dt_consulta, dt_atendido) qt_consulta,
	substr(obter_desc_indicacao(a.nr_seq_indicacao),1,40) ds_indicacao,
	coalesce(substr(obter_nome_pf(a.cd_pessoa_indicacao),1,60),a.nm_pessoa_indicacao) nm_pessoa_indicacao_agenda,
	b.cd_sistema_ant,
	substr(a.ds_observacao,1,255) ds_obs_agenda,
	obter_hora_inicio_agenda(nr_seq_agepaci) dt_agepaci,
	substr(coalesce(obter_motivo_consulta(a.nr_sequencia),a.ds_motivo_copia_trans),1,255) ds_motivo,
	substr(obter_nome_pf(a.cd_medico_req),1,60) nm_medico_req,
	substr(obter_desc_plano(a.cd_convenio, a.cd_plano),1,60) ds_plano,
	substr(to_char(b.dt_nascimento,'DD/MM/YYYY'),1,15) dt_nasc,
	x.ie_enviar_email_confirmacao,
	substr(coalesce(Obter_Dados_Atendimento(a.nr_atendimento,'CHA'),'N'),1,10) ie_chamado,
	substr(Obter_Dados_Atendimento(a.nr_atendimento,'CLP'),1,255) ds_classif_proced,
	a.nm_usuario nm_usuario_alteracao,
	a.dt_atualizacao dt_alteracao,
	a.ie_classif_agenda	ie_classif_agenda2,
	substr(obter_letra_verifacao_senha(coalesce(s.nr_seq_fila_senha_origem, s.nr_seq_fila_senha)),1,10) || s.cd_senha_gerada ds_senha_pac,
	s.nr_seq_fila_senha nr_seq_fila_espera,
	s.cd_senha_gerada,
	s.qt_chamadas,
	substr(Obter_Desc_Usuario_biometria(a.nm_usuario_residente),1,60) nm_medico_residente,
	a.nr_seq_captacao,
	substr(obter_cor_classif_agecons(ie_classif_agenda,'B'),1,15) ds_cor_fundo_classif,
	substr(obter_cor_classif_agecons(ie_classif_agenda,'F'),1,15) ds_cor_fonte_classif,
	s.dt_geracao_senha,
	a.nr_ddi,
	b.nr_ddi_celular,
	adic.ie_reference_letter,
	adic.ie_emergency_response_required,
	substr(coalesce(obter_desc_procedencia(a.cd_procedencia), adic.ds_procedencia_var),1,150) ds_procedencia,
	x.cd_tipo_agenda
FROM agenda x, status_agenda_v c, agenda_consulta a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
LEFT OUTER JOIN status_paciente_v g ON (a.ie_status_paciente = g.cd_status_paciente)
LEFT OUTER JOIN convenio e ON (a.cd_convenio = e.cd_convenio)
LEFT OUTER JOIN med_atendimento f ON (a.nr_sequencia = f.nr_seq_agenda)
LEFT OUTER JOIN paciente_senha_fila s ON (a.nr_seq_pac_senha_fila = s.nr_sequencia)
LEFT OUTER JOIN agenda_consulta_adic adic ON (a.nr_sequencia = adic.nr_seq_agenda)
WHERE a.ie_status_agenda	= c.cd_status_agenda and a.cd_agenda		= x.cd_agenda;

