-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ptu_litoral_sos_unisanta_v (nr_seq_benef, nr_seq_lote, cd_cartao_unimed, nm_beneficiario, ie_sexo, ie_estado_civil, dt_nascimento, ie_tipo_cliente, nr_cpf, ds_empresa, ie_home_care, ie_regulamentacao, ie_cartao_facil, ie_possui_sos, ie_tipo_acomodacao, ds_plano_sos, dt_inclusao_sos, dt_exclusao_sos, ie_tab_unisanta, dt_inclusao_unisanta, ds_periodo_inclu_unisanta, dt_exclusao_unisanta, ds_periodo_excl_unisanta, dt_carencia_unisanta, cd_tab_preco, ie_comissao_vend, cd_unimed_atend, ie_cooperado, cd_unimed_coop, ie_colaborador, nr_ddd_cel, nr_celular, ds_contrato, nr_ddd_contato, nr_fone_contato, ds_endereco_resc, ds_bairro_resc, cd_cep_resc, cd_cidade_resc, uf_sg_resc, ds_complemento_resc, nr_ddd_resc, nr_fone_resc, ds_endereco_comer, ds_bairro_comer, cd_cep_comer, ds_cidade_comer, uf_sg_comer, ds_complemento_comer, nr_ddd_comer, nr_fone_comer, nm_mae, dt_atualizaco, ie_possui_unimed, cd_unimed_origem, ie_ativo) AS select	d.nr_sequencia									nr_seq_benef,
	a.nr_sequencia									nr_seq_lote,
	d.cd_unimed||d.cd_usuario_plano							cd_cartao_unimed,
	d.nm_beneficiario								nm_beneficiario,
	d.ie_sexo									ie_sexo,
	d.ie_estado_civil								ie_estado_civil,
	d.dt_nascimento									dt_nascimento,
	'1'										ie_tipo_cliente,
	d.cd_cgc_cpf									nr_cpf,
	coalesce((	select	z.ds_razao_social
		FROM	pls_segurado		x,
			pls_contrato		y,
			pessoa_juridica		z
		where	x.nr_seq_contrato	= y.nr_sequencia
		and	z.cd_cgc		= y.cd_cgc_estipulante
		and	x.nr_sequencia		= d.nr_seq_segurado),
			(select	x.ds_plano
			from	pls_segurado	y,
				pls_plano	x
			where	y.nr_seq_plano	= x.nr_sequencia
			and	y.nr_sequencia	= d.nr_seq_segurado))			ds_empresa,
	'N'										ie_home_care,
	(	select	CASE WHEN max(x.ie_regulamentacao)='1' THEN 'N'  ELSE 'S' END
		from	pls_segurado	y,
			pls_plano	x
		where	y.nr_seq_plano	= x.nr_sequencia
		and	y.nr_sequencia	= d.nr_seq_segurado)				ie_regulamentacao,
	'N'										ie_cartao_facil,
	CASE WHEN(select  count(1)		from	pls_sca_vinculo x,			pls_plano y,			pls_sca_classificacao z		where	x.nr_seq_segurado = d.nr_seq_segurado		and 	y.nr_sequencia = x.nr_seq_plano		and	z.nr_sequencia = y.nr_seq_classificacao		and	x.dt_liberacao is not null		and	a.dt_mesano_referencia between coalesce(x.dt_inicio_vigencia, a.dt_mesano_referencia) and fim_mes(coalesce(x.dt_fim_vigencia, a.dt_mesano_referencia))		and	z.ds_classificacao like 'SOS%')=0 THEN  'N'  ELSE 'S' END  ie_possui_sos,
	CASE WHEN d.ie_tipo_acomodacao='A' THEN 1 WHEN d.ie_tipo_acomodacao='B' THEN 2  ELSE 0 END 					ie_tipo_acomodacao,
	substr(pls_obter_dados_vinc_sca(d.nr_seq_vinculo_sca_sub,'N'),1,255)		ds_plano_sos,
	to_date(pls_obter_dados_vinc_sca(d.nr_seq_vinculo_sca_sub,'I'))			dt_inclusao_sos,
	to_date(pls_obter_dados_vinc_sca(d.nr_seq_vinculo_sca_sub,'E'))			dt_exclusao_sos,
	CASE WHEN d.ie_area_abrangencia='L' THEN 2 WHEN d.ie_area_abrangencia='E' THEN 0 WHEN d.ie_area_abrangencia='N' THEN 1 END 					ie_tab_unisanta,
	d.dt_repasse									dt_inclusao_unisanta,
	to_char(d.dt_repasse,'YYYYMM')							ds_periodo_inclu_unisanta,
	d.dt_exclusao									dt_exclusao_unisanta,
	to_char(d.dt_exclusao,'YYYYMM')							ds_periodo_excl_unisanta,
	d.dt_ultima_carencia								dt_carencia_unisanta,
	d.cd_plano									cd_tab_preco,
	'N'										ie_comissao_vend,
	d.cd_unimed									cd_unimed_atend,
	CASE WHEN d.cd_empresa_origem=5002 THEN CASE WHEN d.cd_dependencia=0 THEN 'S'  ELSE 'N' END  WHEN d.cd_empresa_origem=8005 THEN CASE WHEN d.cd_dependencia=0 THEN 'S'  ELSE 'N' END   ELSE 'N' END  	ie_cooperado,
	CASE WHEN d.cd_empresa_origem=5002 THEN CASE WHEN d.cd_dependencia=0 THEN '0242'  ELSE ' ' END  WHEN d.cd_empresa_origem=8005 THEN CASE WHEN d.cd_dependencia=0 THEN '0242'  ELSE ' ' END   ELSE ' ' END  	cd_unimed_coop,
	CASE WHEN d.cd_empresa_origem=2744 THEN 'S' WHEN d.cd_empresa_origem=3687 THEN 'S' WHEN d.cd_empresa_origem=4783 THEN 'S' WHEN d.cd_empresa_origem=3999 THEN 'S' WHEN d.cd_empresa_origem=3490 THEN 'S'  ELSE 'N' END 	ie_colaborador,
	' ' 										nr_ddd_cel,
	' ' 										nr_celular,
	' ' 										ds_contrato,
	' ' 										nr_ddd_contato,
	' ' 										nr_fone_contato,
	e.ds_endereco									ds_endereco_resc,
	e.ds_bairro									ds_bairro_resc,
	e.cd_cep									cd_cep_resc,
	e.nm_municipio									cd_cidade_resc,
	e.sg_uf										uf_sg_resc,
	e.ds_complemento								ds_complemento_resc,
	e.nr_ddd									nr_ddd_resc,
	e.nr_fone									nr_fone_resc,
	' '										ds_endereco_comer,
	' '										ds_bairro_comer,
	' '										cd_cep_comer,
	' ' 										ds_cidade_comer,
	' '										uf_sg_comer,
	' '										ds_complemento_comer,
	' ' 										nr_ddd_comer,
	' ' 										nr_fone_comer,
	(	select	x.nm_contato
		from	compl_pessoa_fisica x
		where	x.cd_pessoa_fisica	= d.cd_pessoa_fisica
		and	x.ie_tipo_complemento	= 5   LIMIT 1)							nm_mae,
	LOCALTIMESTAMP										dt_atualizaco,
	'S'										ie_possui_unimed,
	d.cd_unimed									cd_unimed_origem,
	'S'										ie_ativo
FROM ptu_mov_produto_empresa c, ptu_movimentacao_produto b, ptu_mov_produto_lote a, ptu_mov_produto_benef d
LEFT OUTER JOIN ptu_movimento_benef_compl e ON (d.nr_sequencia = e.nr_seq_beneficiario)
WHERE d.nr_seq_empresa		= c.nr_sequencia and c.nr_seq_mov_produto		= b.nr_sequencia and b.nr_seq_lote			= a.nr_sequencia;

