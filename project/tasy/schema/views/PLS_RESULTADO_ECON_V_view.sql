-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resultado_econ_v (dt_mes, nr_contrato, qt_vidas_ativas, qt_consultas, vl_percentual, vl_consultas, vl_honorario, vl_diarias, vl_mat_med, vl_sp_sadt_internado, vl_total_internacao, vl_sp_sadt, vl_despesa_total, vl_carregamento, vl_receita_total, vl_porcentagem_carreg_usado, vl_resultado_mes, ie_nivel) AS select	to_char(dt_mes,'mm/yyyy') dt_mes,
	nr_seq_contrato nr_contrato, 
	qt_vidas_ativas qt_vidas_ativas, 
	qt_consultas qt_consultas, 
	CASE WHEN qt_vidas_ativas=0 THEN 0  ELSE round(((qt_consultas / qt_vidas_ativas) * 100)) END  vl_percentual, 
	vl_consultas vl_consultas, 
	vl_honorario vl_honorario, 
	vl_diarias vl_diarias, 
	vl_mat_med vl_mat_med, 
	vl_sp_sadt_internado vl_sp_sadt_internado, 
	(vl_honorario+vl_diarias+vl_mat_med+vl_sp_sadt_internado) vl_total_internacao, 
	vl_sp_sadt vl_sp_sadt, 
	(vl_consultas+vl_honorario+vl_diarias+vl_mat_med+vl_sp_sadt_internado+vl_sp_sadt) vl_despesa_total, 
	(vl_receita_total*coalesce((vl_carregamento/100),1)) vl_carregamento, 
	vl_receita_total vl_receita_total, 
	vl_carregamento vl_porcentagem_carreg_usado , 
	(vl_receita_total - (vl_consultas+vl_honorario+vl_diarias+vl_mat_med+vl_sp_sadt_internado+vl_sp_sadt)) vl_resultado_mes, 
	ie_nivel ie_nivel 
FROM	( 
	select	dt_mes dt_mes, 
		nr_seq_contrato nr_seq_contrato, 
		sum(coalesce(qt_vidas_ativas,0)) qt_vidas_ativas, 
		sum(coalesce(qt_consultas,0)) qt_consultas, 
		sum(coalesce(vl_consultas,0)) vl_consultas, 
		sum(coalesce(vl_honorario,0)) vl_honorario, 
		sum(coalesce(vl_diarias,0)) vl_diarias, 
		sum(coalesce(vl_mat_med,0)) vl_mat_med, 
		sum(coalesce(vl_sp_sadt_internado,0)) vl_sp_sadt_internado, 
		sum(coalesce(vl_sp_sadt,0)) vl_sp_sadt, 
		sum(coalesce(vl_receita_paga,0)) vl_receita_paga, 
		sum(coalesce(vl_receita_total,0)) vl_receita_total, 
		ie_nivel ie_nivel, 
		vl_carregamento vl_carregamento 
	from	( 
		-- retorna a qtde de vidas ativas no contrato no período 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	count(c.nr_sequencia)				qt_vidas_ativas, 
				null 						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				d.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(c.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_segurado 		c, 
				pls_contrato		d 
			where	a.nr_contrato is not null 
			and	d.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and d.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and d.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	d.ie_situacao = '2' 
			and	d.dt_aprovacao is not null 
			and	d.dt_rescisao_contrato is null 
			and	c.nr_seq_contrato = d.nr_sequencia 
			and	((c.dt_rescisao > b.dt_retorno) or (c.dt_rescisao is null)) 
			group by	b.dt_retorno, 
					d.nr_sequencia, 
					d.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(c.nr_sequencia) 
			
union
 
			select	count(c.nr_sequencia)				qt_vidas_ativas, 
				null 						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				d.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(c.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_segurado 		c, 
				pls_contrato		d 
			where	a.nr_contrato is null 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and d.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and d.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	d.ie_situacao = '2' 
			and	d.dt_aprovacao is not null 
			and	d.dt_rescisao_contrato is null 
			and	c.nr_seq_contrato = d.nr_sequencia 
			and	((c.dt_rescisao <= b.dt_retorno) or (c.dt_rescisao is null)) 
			group by	b.dt_retorno, 
					d.nr_sequencia, 
					d.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(c.nr_sequencia) 
		
union
 
		-- qtde de consultas e valor total das consultas no período 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null 						qt_vidas_ativas, 
				count(d.nr_sequencia)				qt_consultas, 
				sum(d.vl_total)					vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is not null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_tipo_guia in ('4','3') 
			and	c.ie_status in ('3','5','6') 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia in ('4','3') 
			and	d.ie_status in ('F','L') 
			and	(((d.ie_tipo_guia = '4') and (pls_obter_cd_tiss_atendimento(d.nr_seq_tipo_atendimento) = '04')) or (d.ie_tipo_guia = '3')) 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	f.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
			
union
 
			select	null 						qt_vidas_ativas, 
				count(d.nr_sequencia)				qt_consultas, 
				sum(d.vl_total)					vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_tipo_guia in ('4','3') 
			and	c.ie_status in ('3','5','6') 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia in ('4','3') 
			and	d.ie_status in ('F','L') 
			and	(((d.ie_tipo_guia = '4') and (pls_obter_cd_tiss_atendimento(d.nr_seq_tipo_atendimento) = '04')) or (d.ie_tipo_guia = '3')) 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
		
union
 
		-- valor de honorário médico das internações 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				sum(coalesce(e.vl_liberado_hi,0))			vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_conta_proc		e, 
				pls_segurado		f, 
				pls_contrato		g 
			where	a.nr_contrato is not null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	e.nr_seq_conta = d.nr_sequencia 
			and	e.ie_status in ('L','S') 
			and	f.nr_sequencia = d.nr_seq_segurado 
			and	g.nr_sequencia = f.nr_seq_contrato 
			and	g.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					g.nr_sequencia, 
					g.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(f.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				sum(coalesce(e.vl_liberado_hi,0))			vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_conta_proc		e, 
				pls_segurado		f, 
				pls_contrato		g 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	e.nr_seq_conta = d.nr_sequencia 
			and	e.ie_status in ('L','S') 
			and	f.nr_sequencia = d.nr_seq_segurado 
			and	g.nr_sequencia = f.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					g.nr_sequencia, 
					g.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	 
		
union
 
		-- valor ds diárias de internações 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				sum(coalesce(d.vl_diarias,0))			vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is not null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	d.nr_seq_segurado = e.nr_sequencia 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	f.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				sum(coalesce(d.vl_diarias,0))			vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a,		 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	d.nr_seq_segurado = e.nr_sequencia 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
		
union
 
		-- valor dos materiais e medicamentos das internações 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				sum(e.vl_liberado)				vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_conta_mat		e, 
				pls_segurado		f, 
				pls_contrato		g 
			where	a.nr_contrato is not null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	e.nr_seq_conta = d.nr_sequencia 
			and	e.ie_status in ('L','S') 
			and	d.nr_seq_segurado = f.nr_sequencia 
			and	g.nr_sequencia = f.nr_seq_contrato 
			and	g.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					g.nr_sequencia, 
					g.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(f.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				sum(e.vl_liberado)				vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_conta_mat		e, 
				pls_segurado		f, 
				pls_contrato		g 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_status in ('F','L') 
			and	e.nr_seq_conta = d.nr_sequencia 
			and	e.ie_status in ('L','S') 
			and	d.nr_seq_segurado = f.nr_sequencia 
			and	g.nr_sequencia = f.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					g.nr_sequencia, 
					g.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(f.nr_sequencia) 
		
union
 
		-- valor de SP/SADT que está dentro de internação 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				sum(d.vl_total)					vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia = '4' 
			and (pls_obter_se_internado(d.nr_sequencia,null) = 'S') 
			and	d.ie_status in ('F','L') 
			and	d.nr_seq_segurado = e.nr_sequencia 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	f.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				sum(d.vl_total)					vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_status in ('3','5','6') 
			and	c.ie_tipo_guia = '5' 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia = '4' 
			and (pls_obter_se_internado(d.nr_sequencia,null) = 'S') 
			and	d.ie_status in ('F','L') 
			and	d.nr_seq_segurado = e.nr_sequencia 
			and	e.nr_seq_contrato = f.nr_sequencia 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
		
union
 
		-- tudo que é SP/SADT que não está dentro de uma internação e que não é guia de SP/SADT consulta 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				sum(d.vl_total)					vl_sp_sadt,		 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is not null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_tipo_guia = '4' 
			and	c.ie_status in ('3','5','6') 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia = '4' 
			and (pls_obter_cd_tiss_atendimento(d.nr_seq_atendimento)) <> '04' 
			and	d.ie_status in ('F','L') 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	f.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				sum(d.vl_total)					vl_sp_sadt,		 
				null						vl_receita_paga, 
				null						vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434	a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_protocolo_conta	c, 
				pls_conta		d, 
				pls_segurado		e, 
				pls_contrato		f 
			where	a.nr_contrato is null 
			and	c.dt_mes_competencia between b.dt_retorno and last_day(b.dt_retorno) 
			and	c.ie_tipo_guia = '4' 
			and	c.ie_status in ('3','5','6') 
			and	d.nr_seq_protocolo = c.nr_sequencia 	 
			and	d.ie_tipo_guia = '4' 
			and (pls_obter_cd_tiss_atendimento(d.nr_seq_atendimento)) <> '04' 
			and	d.ie_status in ('F','L') 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by	b.dt_retorno, 
					f.nr_sequencia, 
					f.nr_contrato, 
					a.ie_nivel, 
					pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
		
union
 
		-- receitas com mensalidades no período 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				sum(c.vl_titulo)				vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434		a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				titulo_receber			c, 
				pls_mensalidade			d, 
				pls_mensalidade_segurado	e, 
				pls_segurado			f, 
				pls_contrato			g 
			where	c.dt_liquidacao between b.dt_retorno and last_day(b.dt_retorno) 
			and	d.nr_sequencia = c.nr_seq_mensalidade 
			and	e.nr_seq_mensalidade = d.nr_sequencia 
			and	f.nr_sequencia = e.nr_seq_segurado 
			and 	g.nr_sequencia = f.nr_seq_contrato 
			and 	g.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by b.dt_retorno, g.nr_sequencia, g.nr_contrato, a.ie_nivel,pls_obter_vl_carreg_rel_2434(f.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				sum(c.vl_titulo)				vl_receita_paga, 
				null						vl_receita_total, 
				g.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(f.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434		a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				titulo_receber			c, 
				pls_mensalidade			d, 
				pls_mensalidade_segurado	e, 
				pls_segurado			f, 
				pls_contrato			g 
			where	a.nr_contrato is null 
			and	c.dt_liquidacao between b.dt_retorno and last_day(b.dt_retorno) 
			and	d.nr_sequencia = c.nr_seq_mensalidade 
			and	e.nr_seq_mensalidade = d.nr_sequencia 
			and	f.nr_sequencia = e.nr_seq_segurado 
			and 	g.nr_sequencia = f.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and g.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and g.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	g.ie_situacao = '2' 
			and	g.dt_aprovacao is not null 
			and	g.dt_rescisao_contrato is null 
			group by b.dt_retorno, g.nr_sequencia, g.nr_contrato, a.ie_nivel,pls_obter_vl_carreg_rel_2434(f.nr_sequencia) 
		
union
 
		-- Valor das mensalidades independentes de terem sido pagas ou não 
		-- está sendo usado o union para que o otimizador do oracle não abra a pls_contrato cada vez que o select for executado 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				sum(d.vl_mensalidade)				vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434		a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_mensalidade			c, 
				pls_mensalidade_segurado	d, 
				pls_segurado			e, 
				pls_contrato			f 
			where	a.nr_contrato is not null 
			and	c.dt_vencimento between b.dt_retorno and last_day(b.dt_retorno) 
			and	d.nr_seq_mensalidade = c.nr_sequencia 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	f.nr_contrato = a.nr_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by b.dt_retorno, f.nr_sequencia, f.nr_contrato, a.ie_nivel,pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
			
union
 
			select	null						qt_vidas_ativas, 
				null						qt_consultas, 
				null						vl_consultas, 
				b.dt_retorno					dt_mes, 
				null						vl_honorario, 
				null						vl_diarias, 
				null						vl_mat_med, 
				null						vl_sp_sadt_internado, 
				null						vl_sp_sadt, 
				null						vl_receita_paga, 
				sum(d.vl_mensalidade)				vl_receita_total, 
				f.nr_contrato					nr_seq_contrato, 
				a.ie_nivel					ie_nivel, 
				pls_obter_vl_carreg_rel_2434(e.nr_sequencia)	vl_carregamento 
			from	w_pls_param_relat_2434		a, 
				table(pls_manipulacao_datas_pck.obter_intervalo_datas(a.dt_inicio,a.dt_fim,'M')) b, 
				pls_mensalidade			c, 
				pls_mensalidade_segurado	d, 
				pls_segurado			e, 
				pls_contrato			f 
			where	a.nr_contrato is null 
			and	c.dt_vencimento between b.dt_retorno and last_day(b.dt_retorno) 
			and	d.nr_seq_mensalidade = c.nr_sequencia 
			and	e.nr_sequencia = d.nr_seq_segurado 
			and	f.nr_sequencia = e.nr_seq_contrato 
			and	((case 
				when(a.ie_nivel in ('PF','PFS') and f.cd_pf_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'PJ' and f.cd_cgc_estipulante is not null) then 'S' 
				when(a.ie_nivel = 'T') then 'S' 
				else 'N' 
				end) = 'S') 
			and	f.ie_situacao = '2' 
			and	f.dt_aprovacao is not null 
			and	f.dt_rescisao_contrato is null 
			group by b.dt_retorno, f.nr_sequencia, f.nr_contrato, a.ie_nivel,pls_obter_vl_carreg_rel_2434(e.nr_sequencia) 
	) alias309 
	group by dt_mes, 
		 nr_seq_contrato, 
		 ie_nivel, 
		 vl_carregamento 
	order by dt_mes 
) alias310;

