-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_analise_autorizacao_v (ie_tipo_despesa, ie_tipo_item, ie_ordem_titulo, cd_proc_mat, ds_proc_mat, cd_material, qt_original, qt_ajuste, ie_status, ie_status_solicitacao, ds_status_sol, ds_status, ds_acao, nr_seq_origem, qt_tempo, nr_sequencia, nr_seq_prest_fornec, ds_fornecedor, vl_item, ie_origem_proced, nr_seq_auditoria) AS select	ie_tipo_despesa																	ie_tipo_despesa,
	'P' 																		ie_tipo_item, 
	0																		ie_ordem_titulo, 
	null																		cd_proc_mat, 
	CASE WHEN ie_tipo_despesa=1 THEN  'PROCEDIMENTOS' WHEN ie_tipo_despesa=2 THEN  'TAXAS' WHEN ie_tipo_despesa=3 THEN  'DI√ÅRIAS' END  										ds_proc_mat, 
	null																		cd_material, 
	null																		qt_original, 
	null																		qt_ajuste, 
	null																		ie_status, 
	null																		ie_status_solicitacao, 
	null																		ds_status_sol, 
	null																		ds_status, 
	null																		ds_acao, 
	null																		nr_seq_origem, 
	null																		qt_tempo, 
	null																		nr_sequencia, 
	null																		nr_seq_prest_fornec, 
	null																		ds_fornecedor, 
	null																		vl_item, 
	null																		ie_origem_proced, 
	nr_seq_auditoria																nr_seq_auditoria 
FROM	pls_auditoria_item 
where	cd_procedimento is not null 
group by ie_tipo_despesa, nr_seq_auditoria 

union
 
select	ie_tipo_despesa																	ie_tipo_despesa, 
	'P' 																		ie_tipo_item, 
	1																		ie_ordem_titulo, 
	cd_procedimento 																cd_proc_mat, 
	substr(Obter_Descricao_Procedimento(cd_procedimento,ie_origem_proced),1,255) 									ds_proc_mat, 
	'' 																		cd_material, 
	qt_original																	qt_original, 
	qt_ajuste																	qt_ajuste, 
	ie_status																	ie_status, 
	ie_status_solicitacao																ie_status_solicitacao, 
	substr(obter_valor_dominio(3544,ie_status_solicitacao),1,255) 											ds_status_sol, 
	substr(obter_valor_dominio(3544,IE_STATUS),1,255) 												ds_status, 
	substr(obter_valor_dominio(3339,ie_acao_auditor),1,255) 											ds_acao, 
	nr_seq_proc_origem 																nr_seq_origem, 
	CASE WHEN ie_status='S' THEN 0  ELSE round((CASE WHEN ie_status='P' THEN dt_atualizacao  ELSE CASE WHEN ie_Status='M' THEN dt_atualizacao  ELSE LOCALTIMESTAMP END  END  - dt_atualizacao_nrec) * 24,2) END 	qt_tempo, 
	nr_sequencia																	nr_sequencia, 
	nr_seq_prest_fornec																nr_seq_prest_fornec, 
	'' 																		ds_fornecedor, 
	vl_item																		vl_item, 
	ie_origem_proced 																ie_origem_proced, 
	nr_seq_auditoria																nr_seq_auditoria 
from	pls_auditoria_item 
where	cd_procedimento is not null 

union
 
select	ie_tipo_despesa																	ie_tipo_despesa, 
	'M' 																		ie_tipo_item, 
	0																		ie_ordem_titulo, 
	null																		cd_proc_mat, 
	CASE WHEN ie_tipo_despesa=1 THEN  'GASES MEDICINAIS' WHEN ie_tipo_despesa=2 THEN  'MEDICAMENTOS' WHEN ie_tipo_despesa=3 THEN  'MATERIAIS' WHEN ie_tipo_despesa=7 THEN  'OPM' END 							ds_proc_mat, 
	null																		cd_material, 
	null																		qt_original, 
	null																		qt_ajuste, 
	null																		ie_status, 
	null																		ie_status_solicitacao, 
	null																		ds_status_sol, 
	null																		ds_status, 
	null																		ds_acao, 
	null																		nr_seq_origem, 
	null																		qt_tempo, 
	null																		nr_sequencia, 
	null																		nr_seq_prest_fornec, 
	null																		ds_fornecedor, 
	null																		vl_item, 
	null																		ie_origem_proced, 
	nr_seq_auditoria																nr_seq_auditoria 
from	pls_auditoria_item 
where	nr_seq_material is not null 
group by ie_tipo_despesa, nr_sequencia, nr_seq_auditoria 

union
 
select	ie_tipo_despesa																	ie_tipo_despesa, 
	'M' 																		ie_tipo_item, 
	1																		ie_ordem_titulo, 
	nr_seq_material 																cd_proc_mat, 
	substr(pls_obter_desc_material(nr_seq_material),1,255) 												ds_proc_mat, 
	substr(pls_obter_seq_codigo_material(nr_seq_material,''),1,10) 											cd_material, 
	qt_original																	qt_original, 
	qt_ajuste																	qt_ajuste, 
	ie_status																	ie_status, 
	ie_status_solicitacao																ie_status_solicitacao, 
	substr(obter_valor_dominio(3544,ie_status_solicitacao),1,255) 											ds_status_sol, 
	substr(obter_valor_dominio(3544,IE_STATUS),1,255) 												ds_status, 
	substr(obter_valor_dominio(3339,ie_acao_auditor),1,255) 											ds_acao, 
	nr_seq_mat_origem 																nr_seq_origem, 
	CASE WHEN ie_status='S' THEN 0  ELSE round((CASE WHEN ie_status='P' THEN dt_atualizacao  ELSE CASE WHEN ie_Status='M' THEN dt_atualizacao  ELSE LOCALTIMESTAMP END  END  - dt_atualizacao_nrec) * 24,2) END  qt_tempo, 
	nr_sequencia																	nr_sequencia, 
	nr_seq_prest_fornec																nr_seq_prest_fornec, 
	substr(pls_obter_dados_prestador(nr_seq_prest_fornec,'N'),1,255) 										ds_fornecedor, 
	vl_item																		vl_item, 
	0 																		ie_origem_proced, 
	nr_seq_auditoria																nr_seq_auditoria 
from	pls_auditoria_item 
where	nr_seq_material is not null;

