-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_checklist_matrix_v (nr_prescricao, cd_estabelecimento, nr_seq_prescr, nr_seq_exame, ie_padrao_amostra, nr_seq_lab, padrao_amostra_nr_seq_lab, integra_amostra, dt_integracao, integra_dt_integracao, ie_status_atend, ds_status_atend, integra_envio, equip_exame, integra_equip, nr_seq_grupo_imp, ds_grupo_imp, integra_grupo_imp, ds_material_especial, integra_mat_especial, equip_exame_duplicado, integra_equip_exame_dup, ie_suspenso, integra_suspenso, dt_liberacao, integra_dt_liberacao) AS select	a.nr_prescricao,
	a.cd_estabelecimento,
	b.nr_sequencia nr_seq_prescr,
	b.nr_seq_exame,
	c.ie_padrao_amostra,
	b.nr_seq_lab,
	c.ie_padrao_amostra || '/' || coalesce(b.nr_seq_lab, 0) padrao_amostra_nr_seq_lab,
	case
		when c.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')
		then 'Sim'
		else CASE WHEN coalesce(b.nr_seq_lab,0)=0 THEN  'Não'  ELSE 'Sim' END
	end integra_amostra,
	b.dt_integracao,
	CASE WHEN b.dt_integracao IS NULL THEN  'Sim'  ELSE 'Não' END  integra_dt_integracao,
	b.ie_status_atend,
	b.ie_status_atend || ' - ' || obter_valor_dominio(1030, b.ie_status_atend) ds_status_atend,
	CASE WHEN b.ie_status_atend=c.ie_status_envio THEN  'Sim'  ELSE 'Não' END  integra_envio,
	Obter_Equipamento_Exame(b.nr_seq_exame, null, 'MATRIX') equip_exame,
	CASE WHEN Obter_Equipamento_Exame(b.nr_seq_exame, null, 'MATRIX') IS NULL THEN  'Não'  ELSE 'Sim' END  integra_equip,
	d.nr_seq_grupo_imp,
	d.nr_seq_grupo_imp || ' - ' || obter_desc_grupo_imp_lab(d.nr_seq_grupo_imp)  ds_grupo_imp,
	CASE WHEN coalesce(d.nr_seq_grupo_imp, 0)=0 THEN  'Não'  ELSE 'Sim' END  integra_grupo_imp,
	b.ds_material_especial,
	CASE WHEN b.ds_material_especial IS NULL THEN  'Sim'  ELSE 'Não' END  integra_mat_especial,
	obter_equip_exame_duplicado(b.nr_seq_exame, 'MATRIX') equip_exame_duplicado,
	CASE WHEN obter_equip_exame_duplicado(b.nr_seq_exame, 'MATRIX') IS NULL THEN  'Sim'  ELSE 'Não' END  integra_equip_exame_dup,
	b.ie_suspenso,
	CASE WHEN coalesce(b.ie_suspenso, 'N')='N' THEN  'Sim'  ELSE 'Não' END  integra_suspenso,
	coalesce(a.dt_liberacao_medico, a.dt_liberacao) dt_liberacao,
	CASE WHEN coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NULL THEN  'Não'  ELSE 'Sim' END  integra_dt_liberacao
FROM 	prescr_medica a,
	prescr_procedimento b,
	lab_parametro c,
	exame_laboratorio d
where a.nr_prescricao = b.nr_prescricao
  and a.cd_estabelecimento = c.cd_estabelecimento
  and b.nr_seq_exame = d.nr_seq_exame
  and ((c.ie_padrao_amostra in ('PM','PM11','PMR11','PM13')) or (b.nr_seq_lab is not null))
  and c.ie_padrao_amostra not in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
  and b.cd_material_exame is not null
  and b.nr_seq_exame is not null

union

select	a.nr_prescricao,
	a.cd_estabelecimento,
	b.nr_sequencia nr_seq_prescr,
	b.nr_seq_exame,
	c.ie_padrao_amostra,
	b.nr_seq_lab,
	c.ie_padrao_amostra || '/' || coalesce(b.nr_seq_lab, 0) padrao_amostra_nr_seq_lab,
	case
		when c.ie_padrao_amostra in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13','EAM10')
		then CASE WHEN coalesce(b.nr_seq_lab,0)=0 THEN  'Não'  ELSE 'Sim' END 
		else 'Não'
	end integra_amostra,
	b.dt_integracao,
	CASE WHEN b.dt_integracao IS NULL THEN  'Sim'  ELSE 'Não' END  integra_dt_integracao,
	b.ie_status_atend,
	b.ie_status_atend || ' - ' || obter_valor_dominio(1030, b.ie_status_atend) ds_status_atend,
	CASE WHEN b.ie_status_atend=c.ie_status_envio THEN  'Sim'  ELSE 'Não' END  integra_envio,
	Obter_Equipamento_Exame(b.nr_seq_exame, null, 'MATRIX') equip_exame,
	CASE WHEN Obter_Equipamento_Exame(b.nr_seq_exame, null, 'MATRIX') IS NULL THEN  'Não'  ELSE 'Sim' END  integra_equip,
	d.nr_seq_grupo_imp,
	d.nr_seq_grupo_imp || ' - ' || obter_desc_grupo_imp_lab(d.nr_seq_grupo_imp)  ds_grupo_imp,
	CASE WHEN coalesce(d.nr_seq_grupo_imp, 0)=0 THEN  'Não'  ELSE 'Sim' END  integra_grupo_imp,
	b.ds_material_especial,
	CASE WHEN b.ds_material_especial IS NULL THEN  'Sim'  ELSE 'Não' END  integra_mat_especial,
	obter_equip_exame_duplicado(b.nr_seq_exame, 'MATRIX') equip_exame_duplicado,
	CASE WHEN obter_equip_exame_duplicado(b.nr_seq_exame, 'MATRIX') IS NULL THEN  'Sim'  ELSE 'Não' END  integra_equip_exame_dup,
	b.ie_suspenso,
	CASE WHEN coalesce(b.ie_suspenso, 'N')='N' THEN  'Sim'  ELSE 'Não' END  integra_suspenso,
	coalesce(a.dt_liberacao_medico, a.dt_liberacao) dt_liberacao,
	CASE WHEN coalesce(a.dt_liberacao_medico, a.dt_liberacao) IS NULL THEN  'Não'  ELSE 'Sim' END  integra_dt_liberacao
from 	prescr_medica a,
	prescr_procedimento b,
	lab_parametro c,
	exame_laboratorio d
where a.nr_prescricao = b.nr_prescricao
  and a.cd_estabelecimento = c.cd_estabelecimento
  and b.nr_seq_exame = d.nr_seq_exame
  and c.ie_padrao_amostra in ('AMO9','AMO10','AMO11','AM10F','AM11F','AMO13')
  and b.cd_material_exame is not null
  and b.nr_seq_exame is not null
order by 3;

