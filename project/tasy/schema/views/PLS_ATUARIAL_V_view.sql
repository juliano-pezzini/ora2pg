-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_atuarial_v (ie_tipo_registro, cd_interno, cd_ans, cd_segmentacao, cd_acomodacao, cd_contratacao, cd_abrangencia, ie_franquia, ie_coparticipacao, cd_beneficiario, cd_matricula_principal, cd_matricula_secundaria, dt_nascimento, ie_tipo_beneficiario, ie_sexo, dt_adesao, dt_exclusao, cd_cpt, dt_final_cpt, cd_empresa, ie_tipo_patrocinio, cd_historico_beneficiario, cd_mensalidade, cd_matricula_principal_1, cd_matricula_secundaria_1, dt_mesano_competencia, vl_contraprestacao, cd_prestador, ie_tipo_prestador, ie_tipo_rede, cd_ibge, cd_especialidade, cd_sinistro, cd_matricula_principal_2, cd_matricula_secundaria_2, dt_ocorrencia, dt_aviso, dt_pagamento, ie_tipo_evento, nr_documento, cd_classif_sinistro, nr_diarias, nr_diarias_uti, nm_tabela, cd_procedimento, vl_despesa, vl_coparticipacao, vl_franquia, ie_tipo_despesa, cd_prestador_sinistro, ie_carencia, dt_referencia) AS select	1 ie_tipo_registro,
	a.nr_sequencia cd_interno, 
	a.nr_protocolo_ans cd_ans, 
	CASE WHEN a.ie_segmentacao='12' THEN '14' WHEN a.ie_segmentacao='11' THEN '13' WHEN a.ie_segmentacao='10' THEN '11' WHEN a.ie_segmentacao='9' THEN '10'  ELSE a.ie_segmentacao END  cd_segmentacao, 
	CASE WHEN a.ie_acomodacao='N' THEN '1' WHEN a.ie_acomodacao='C' THEN '2' WHEN a.ie_acomodacao='I' THEN '4' END  cd_acomodacao, 
	CASE WHEN a.ie_tipo_contratacao='I' THEN '1' WHEN a.ie_tipo_contratacao='CE' THEN '2' WHEN a.ie_tipo_contratacao='CA' THEN '3' END  cd_contratacao, 
	CASE WHEN a.ie_abrangencia='N' THEN '1' WHEN a.ie_abrangencia='GE' THEN '2' WHEN a.ie_abrangencia='E' THEN '3' WHEN a.ie_abrangencia='GM' THEN '4' WHEN a.ie_abrangencia='M' THEN '5'  ELSE '6' END  cd_abrangencia, 
	CASE WHEN a.ie_franquia='S' THEN '1'  ELSE '0' END  ie_franquia, 
	CASE WHEN a.ie_coparticipacao='S' THEN '1'  ELSE '0' END  ie_coparticipacao, 
	-- Registro 2 
	'0' cd_beneficiario, 
	'0' cd_matricula_principal, 
	'0' cd_matricula_secundaria, 
	'00000000' dt_nascimento, 
	0 ie_tipo_beneficiario, 
	0 ie_sexo, 
	'0' dt_adesao, 
	'0' dt_exclusao, 
	0 cd_cpt, 
	LOCALTIMESTAMP dt_final_cpt, 
	null cd_empresa, 
	0 ie_tipo_patrocinio, 
	0 cd_historico_beneficiario, 
	-- Registro 3 
	'0' cd_mensalidade, 
	'0' cd_matricula_principal_1, 
	'0' cd_matricula_secundaria_1, 
	'0' dt_mesano_competencia, 
	'0' vl_contraprestacao, 
	-- Registro 4 
	0 cd_prestador, 
	0 ie_tipo_prestador, 
	0 ie_tipo_rede, 
	'0' cd_ibge, 
	'0' cd_especialidade, 
	-- Registro 5 
	'0' cd_sinistro, 
	'0' cd_matricula_principal_2, 
	'0' cd_matricula_secundaria_2, 
	'' dt_ocorrencia, 
	'' dt_aviso, 
	'' dt_pagamento, 
	0 ie_tipo_evento, 
	null nr_documento, 
	'0' cd_classif_sinistro, 
	0 nr_diarias, 
	0 nr_diarias_uti, 
	'0' nm_tabela, 
	0 cd_procedimento, 
	'0' vl_despesa, 
	'0' vl_coparticipacao, 
	0 vl_franquia, 
	0 ie_tipo_despesa, 
	0 cd_prestador_sinistro, 
	0 ie_carencia, 
	trunc(c.dt_contrato,'month') dt_referencia 
FROM	pls_plano a, 
	pls_contrato_plano b, 
	pls_contrato c 
where	a.nr_sequencia	= b.nr_seq_plano 
and	b.nr_seq_contrato	= c.nr_sequencia 

UNION ALL
 
/* 2 - Beneficiários */
 
select	2 ie_tipo_registro, 
	0 cd_interno, 
	'0' cd_ans, 
	'0' cd_segmentacao, 
	'0' cd_acomodacao, 
	'0' cd_contratacao, 
	'0' cd_abrangencia, 
	'0' ie_franquia, 
	'0' ie_coparticipacao, 
	-- Registro 2 - Beneficiários 
	to_char(a.nr_seq_plano) cd_beneficiario, 
	to_char(a.nr_seq_contrato) cd_matricula_principal, 
	to_char(a.nr_sequencia) cd_matricula_secundaria, 
	coalesce(to_char(b.dt_nascimento,'yyyymmdd'),'00000000') dt_nascimento, 
	CASE WHEN a.nr_seq_titular IS NULL THEN 1  ELSE 3 END  ie_tipo_beneficiario, 
	CASE WHEN b.ie_sexo='M' THEN 1 WHEN b.ie_sexo='F' THEN 3 END  ie_sexo, 
	coalesce(to_char(a.dt_contratacao,'yyyymmdd'),'00000000') dt_adesao, 
	coalesce(to_char(a.dt_rescisao,'yyyymmdd'),'00000000') dt_exclusao, 
	CASE WHEN(select	count(*) 		from	pls_carencia x 		where	a.nr_sequencia = x.nr_seq_segurado)=0 THEN 0  ELSE 1 END  cd_cpt, 
	null dt_final_cpt, 
	CASE WHEN d.ie_tipo_contratacao='I' THEN null  ELSE lpad(c.cd_cgc_estipulante,14,0) END  cd_empresa, 
	0 ie_tipo_patrocinio, 
	0 cd_historico_beneficiario, 
	-- Registro 3 
	'0' cd_mensalidade, 
	'0' cd_matricula_principal_1, 
	'0' cd_matricula_secundaria_1, 
	'0' dt_mesano_competencia, 
	'0' vl_contraprestacao, 
	-- Registro 4 
	0 cd_prestador, 
	0 ie_tipo_prestador, 
	0 ie_tipo_rede, 
	'0' cd_ibge, 
	'0' cd_especialidade, 
	-- Registro 5 
	'0' cd_sinistro, 
	'0' cd_matricula_principal_2, 
	'0' cd_matricula_secundaria_2, 
	'' dt_ocorrencia, 
	'' dt_aviso, 
	'' dt_pagamento, 
	0 ie_tipo_evento, 
	null nr_documento, 
	'0' cd_classif_sinistro, 
	0 nr_diarias, 
	0 nr_diarias_uti, 
	'0' nm_tabela, 
	0 cd_procedimento, 
	'0' vl_despesa, 
	'0' vl_coparticipacao, 
	0 vl_franquia, 
	0 ie_tipo_despesa, 
	0 cd_prestador_sinistro, 
	0 ie_carencia, 
	trunc(a.dt_contratacao,'month') dt_referencia 
from	pls_segurado a, 
	pessoa_fisica b, 
	pls_contrato c, 
	pls_plano d 
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
and	a.nr_seq_contrato	= c.nr_sequencia 
and	a.nr_seq_plano		= d.nr_sequencia 

UNION ALL
 
/* 3 - Mensalidades */
 
select	3 ie_tipo_registro, 
	0 cd_interno, 
	'0' cd_ans, 
	'0' cd_segmentacao, 
	'0' cd_acomodacao, 
	'0' cd_contratacao, 
	'0' cd_abrangencia, 
	'0' ie_franquia, 
	'0' ie_coparticipacao, 
	-- Registro 2 
	'0' cd_beneficiario, 
	'0' cd_matricula_principal, 
	'0' cd_matricula_secundaria, 
	'00000000' dt_nascimento, 
	0 ie_tipo_beneficiario, 
	0 ie_sexo, 
	'0' dt_adesao, 
	'0' dt_exclusao, 
	0 cd_cpt, 
	LOCALTIMESTAMP dt_final_cpt, 
	null cd_empresa, 
	0 ie_tipo_patrocinio, 
	0 cd_historico_beneficiario, 
	-- Registro 3 
	to_char(d.nr_seq_plano) cd_mensalidade, 
	to_char(d.nr_seq_contrato) cd_matricula_principal_1, 
	to_char(d.nr_sequencia) cd_matricula_secundaria_1, 
	to_char(a.dt_mesano_referencia,'yyyymm') dt_mesano_competencia, 
	replace(replace(c.vl_mensalidade,'.',''),',','') vl_contraprestacao, 
	-- Registro 4 
	0 cd_prestador, 
	0 ie_tipo_prestador, 
	0 ie_tipo_rede, 
	'0' cd_ibge, 
	'0' cd_especialidade, 
	-- Registro 5 
	'0' cd_sinistro, 
	'0' cd_matricula_principal_2, 
	'0' cd_matricula_secundaria_2, 
	'' dt_ocorrencia, 
	'' dt_aviso, 
	'' dt_pagamento, 
	0 ie_tipo_evento, 
	null nr_documento, 
	'0' cd_classif_sinistro, 
	0 nr_diarias, 
	0 nr_diarias_uti, 
	'0' nm_tabela, 
	0 cd_procedimento, 
	'0' vl_despesa, 
	'0' vl_coparticipacao, 
	0 vl_franquia, 
	0 ie_tipo_despesa, 
	0 cd_prestador_sinistro, 
	0 ie_carencia, 
	trunc(a.dt_mesano_referencia,'month') dt_referencia 
from	pls_segurado d, 
	pls_lote_mensalidade a, 
	pls_mensalidade b, 
	pls_mensalidade_segurado c 
where	a.nr_sequencia	= b.nr_seq_lote 
and	b.nr_sequencia	= c.nr_seq_mensalidade	 
and	d.nr_sequencia	= c.nr_seq_segurado 

UNION ALL
 
/* 4 - Prestadores */
 
select	4 ie_tipo_registro, 
	0 cd_interno, 
	'0' cd_ans, 
	'0' cd_segmentacao, 
	'0' cd_acomodacao, 
	'0' cd_contratacao, 
	'0' cd_abrangencia, 
	'0' ie_franquia, 
	'0' ie_coparticipacao, 
	-- Registro 2 
	'0' cd_beneficiario, 
	'0' cd_matricula_principal, 
	'0' cd_matricula_secundaria, 
	'00000000' dt_nascimento, 
	0 ie_tipo_beneficiario, 
	0 ie_sexo, 
	'0' dt_adesao, 
	'0' dt_exclusao, 
	0 cd_cpt, 
	LOCALTIMESTAMP dt_final_cpt, 
	null cd_empresa, 
	0 ie_tipo_patrocinio, 
	0 cd_historico_beneficiario, 
	-- Registro 3 
	'0' cd_mensalidade, 
	'0' cd_matricula_principal_1, 
	'0' cd_matricula_secundaria_1, 
	'0' dt_mesano_competencia, 
	'0' vl_contraprestacao, 
	-- Registro 4 
	a.nr_sequencia cd_prestador, 
	0 ie_tipo_prestador, 
	CASE WHEN a.ie_tipo_relacao='P' THEN 1 WHEN a.ie_tipo_relacao='N' THEN 2  ELSE 3 END  ie_tipo_rede, 
	substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'CDM'),1,10) cd_ibge, 
	to_char(a.nr_seq_tipo_prestador) cd_especialidade, 
	-- Registro 5 
	'0' cd_sinistro, 
	'0' cd_matricula_principal_2, 
	'0' cd_matricula_secundaria_2, 
	'' dt_ocorrencia, 
	'' dt_aviso, 
	'' dt_pagamento, 
	0 ie_tipo_evento, 
	null nr_documento, 
	'0' cd_classif_sinistro, 
	0 nr_diarias, 
	0 nr_diarias_uti, 
	'0' nm_tabela, 
	0 cd_procedimento, 
	'0' vl_despesa, 
	'0' vl_coparticipacao, 
	0 vl_franquia, 
	0 ie_tipo_despesa, 
	0 cd_prestador_sinistro, 
	0 ie_carencia, 
	trunc(a.dt_cadastro,'month') dt_referencia 
from	pls_prestador a 

UNION ALL
 
/* 5 - Sinistros */
 
select	5 ie_tipo_registro, 
	0 cd_interno, 
	'0' cd_ans, 
	'0' cd_segmentacao, 
	'0' cd_acomodacao, 
	'0' cd_contratacao, 
	'0' cd_abrangencia, 
	'0' ie_franquia, 
	'0' ie_coparticipacao, 
	-- Registro 2 
	'0' cd_beneficiario, 
	'0' cd_matricula_principal, 
	'0' cd_matricula_secundaria, 
	'00000000' dt_nascimento, 
	0 ie_tipo_beneficiario, 
	0 ie_sexo, 
	'0' dt_adesao, 
	'0' dt_exclusao, 
	0 cd_cpt, 
	LOCALTIMESTAMP dt_final_cpt, 
	null cd_empresa, 
	0 ie_tipo_patrocinio, 
	0 cd_historico_beneficiario, 
	-- Registro 3 
	'0' cd_mensalidade, 
	'0' cd_matricula_principal_1, 
	'0' cd_matricula_secundaria_1, 
	'0' dt_mesano_competencia, 
	'0' vl_contraprestacao, 
	-- Registro 4 
	0 cd_prestador, 
	0 ie_tipo_prestador, 
	0 ie_tipo_rede, 
	'0' cd_ibge, 
	'0' cd_especialidade, 
	-- Registro 5 
	to_char(d.nr_seq_plano) cd_sinistro, 
	to_char(d.nr_seq_contrato) cd_matricula_principal_2, 
	to_char(d.nr_sequencia) cd_matricula_secundaria_2, 
	to_char(coalesce(coalesce(c.dt_procedimento,b.dt_emissao),a.dt_mes_competencia),'yyyymmdd') dt_ocorrencia, 
	to_char(LOCALTIMESTAMP,'yyyymmdd') dt_aviso, 
	to_char(LOCALTIMESTAMP,'yyyymmdd') dt_pagamento, 
	0 ie_tipo_evento, 
	coalesce(cd_guia,cd_guia_referencia) nr_documento, 
	CASE WHEN pls_obter_se_internado(b.nr_sequencia,'C')='S' THEN (	select	CASE WHEN x.cd_tiss='1' THEN '3' WHEN x.cd_tiss='2' THEN '2' WHEN x.cd_tiss='3' THEN '4' WHEN x.cd_tiss='5' THEN '7' END  								from	pls_clinica	x 								where	x.nr_sequencia	= b.nr_seq_clinica)  ELSE '1' END  cd_classif_sinistro, 
	CASE WHEN pls_obter_se_internado(b.nr_sequencia,'C')='S' THEN (trunc(b.dt_alta)-trunc(b.dt_entrada))  ELSE 0 END  nr_diarias, 
	0 nr_diarias_uti, 
	(select	substr(ds_valor_dominio,1,255) 
	from	valor_dominio 
	where	cd_dominio	= 30 
	and	vl_dominio	= c.ie_origem_proced) nm_tabela, 
	c.cd_procedimento, 
	replace(replace(coalesce(c.vl_procedimento,0),'.',''),',','') vl_despesa, 
	(	select	replace(replace(coalesce(sum(x.vl_coparticipacao),0),'.',''),',','') 
		from	pls_conta_coparticipacao	x 
		where	x.nr_seq_conta_proc	= c.nr_sequencia) vl_coparticipacao, 
	0 vl_franquia, 
	0 ie_tipo_despesa, 
	a.nr_seq_prestador cd_prestador_sinistro, 
	0 ie_carencia, 
	coalesce(c.dt_procedimento,a.dt_mes_competencia) dt_referencia 
from	pls_protocolo_conta a, 
	pls_conta b, 
	pls_conta_proc c, 
	pls_segurado d 
where	d.nr_sequencia	= b.nr_seq_segurado 
and	b.nr_seq_protocolo	= a.nr_sequencia 
and	b.nr_sequencia	= c.nr_seq_conta;

