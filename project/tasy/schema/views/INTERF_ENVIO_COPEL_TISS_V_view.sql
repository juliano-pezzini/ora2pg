-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_envio_copel_tiss_v (tp_registro, cd_registro, cd_prestador, nm_prestador, dt_geracao, dt_geracao_orig, nr_seq_orig, ds_espaco, ie_congenere, ie_tipo_prestador, nr_beneficiario, tp_transacao, tp_despesa, cd_procedimento, nr_documento, dt_documento, vl_despesa, nr_guia, qt_procedimento, nr_conselho, cd_conselho, cd_cid, cd_dente, cd_convenio_sec, dt_entrada, nr_doc_conv_sec, ie_pessoa, qt_registro, vl_total, nr_seq_protocolo, nr_doc_convenio, nr_guia_principal, ie_carater_solic, cd_cbo, ie_acidente, tp_saida, cd_tabela, ie_via_acesso, ie_tecnica, uf_conselho, tp_consulta, pr_reducao_acres) AS select
	0 						tp_registro,
	0						cd_registro,
	(coalesce(a.cd_interno,'0'))::numeric 		cd_prestador,
	substr(a.nm_convenio,1,30)			nm_prestador,
	a.dt_remessa					dt_geracao,
	' '						dt_geracao_orig,
	0						nr_seq_orig,
	' '						ds_espaco,
	'N'						ie_congenere,
	'J'						ie_tipo_prestador,
	0						nr_beneficiario,
	0						tp_transacao,
	0						tp_despesa,
	0						cd_procedimento,
	0						nr_documento,
	LOCALTIMESTAMP						dt_documento,
	0						vl_despesa,
	0						nr_guia,
	0						qt_procedimento,
	0						nr_conselho,
	0						cd_conselho,
	' '						cd_cid,
	0						cd_dente,
	0						cd_convenio_sec,
	LOCALTIMESTAMP						dt_entrada,
	0						nr_doc_conv_sec,
	' '						ie_pessoa,
	0						qt_registro,
	0						vl_total,
	a.nr_seq_protocolo				nr_seq_protocolo,
		' '						nr_doc_convenio,
	' '						nr_guia_principal,
	' '						ie_carater_solic,
	0						cd_cbo,
	0						ie_acidente,
	0						tp_saida,
	' '						cd_tabela,
	' '						ie_via_acesso,
	' '						ie_tecnica,
	' '						uf_conselho,
	' '						tp_consulta,
	0						pr_reducao_acres
FROM	w_interf_conta_header a

union all

/* Movimento do Documento */

select
	1 						tp_registro,
	1						cd_registro,
	0						cd_prestador,
	' '						nm_prestador,
	LOCALTIMESTAMP						dt_geracao,
	' '						dt_geracao_orig,
	0						nr_seq_orig,
	' '						ds_espaco,
	' '						ie_congenere,
	' '						ie_tipo_prestador,
	somente_numero(substr(a.cd_usuario_convenio,1,9))
							nr_beneficiario,
	1						tp_transacao,
	coalesce(b.cd_funcao_executor,a.ie_clinica)
							tp_despesa,
	(substr(b.cd_item_convenio,1,8))::numeric
							cd_procedimento,
	a.nr_interno_conta				nr_documento,
	a.dt_alta					dt_documento,
	sum(CASE WHEN b.cd_area_proc=1 THEN (coalesce(b.vl_honorario,0) + coalesce(b.vl_custo_oper,0)) WHEN b.cd_area_proc=4 THEN (coalesce(b.vl_honorario,0) + coalesce(b.vl_custo_oper,0))  ELSE b.vl_total_item END )	vl_despesa,
	(coalesce(substr(b.cd_senha_guia,1,8),'0'))::numeric 	nr_guia,
	sum(b.qt_item)					qt_procedimento,
	coalesce(somente_numero(substr(b.nr_crm_executor,1,10)),0)
							nr_conselho,
	2						cd_conselho,
	substr(a.cd_cid_principal,1,5)			cd_cid,
	0						cd_dente,
	0						cd_convenio_sec,
	a.dt_entrada					dt_entrada,
	0						nr_doc_conv_sec,
	' '						ie_pessoa,
	0						qt_registro,
	0						vl_total,
	a.nr_seq_protocolo				nr_seq_protocolo,
	b.nr_doc_convenio				nr_doc_convenio,
	b.nr_doc_convenio				nr_guia_principal,
	CASE WHEN a.ie_carater_inter='1' THEN 'E' WHEN a.ie_carater_inter=5 THEN 'U' WHEN a.ie_carater_inter=20 THEN 'U'  ELSE ' ' END 
							ie_carater_solic,
	b.cd_especialidade				cd_cbo,
	c.nr_seq_tipo_acidente				ie_acidente,
	a.cd_motivo_alta				tp_saida,
	' '						cd_tabela,
	b.ie_via_acesso					ie_via_acesso,
	CASE WHEN b.ie_video='S' THEN 'V'  ELSE 'C' END 			ie_tecnica,
	b.uf_crm_executor				uf_conselho,
	'1'						tp_consulta,
	b.pr_faturado					pr_reducao_acres
from	atendimento_paciente	c,
	w_interf_conta_item 	b,
	w_interf_conta_cab 	a
where	a.nr_seq_protocolo	= b.nr_seq_protocolo
and	a.nr_interno_conta	= b.nr_interno_conta
and 	a.nr_atendimento	= c.nr_atendimento
group by
	LOCALTIMESTAMP,
	somente_numero(substr(a.cd_usuario_convenio,1,9)),
	coalesce(b.cd_funcao_executor,a.ie_clinica),
	(substr(b.cd_item_convenio,1,8))::numeric ,
	a.nr_interno_conta,
	a.dt_alta,
	(coalesce(substr(b.cd_senha_guia,1,8),'0'))::numeric ,
	coalesce(somente_numero(substr(b.nr_crm_executor,1,10)),0),
	substr(a.cd_cid_principal,1,5),
	a.dt_entrada,
	a.nr_seq_protocolo,
	b.nr_doc_convenio,
	CASE WHEN a.ie_carater_inter='1' THEN 'E' WHEN a.ie_carater_inter=5 THEN 'U' WHEN a.ie_carater_inter=20 THEN 'U'  ELSE ' ' END ,
	b.cd_especialidade,
	c.nr_seq_tipo_acidente,
	a.cd_motivo_alta,
	b.ie_via_acesso,
	CASE WHEN b.ie_video='S' THEN 'V'  ELSE 'C' END ,
	b.uf_crm_executor,
	b.pr_faturado

union all

/* Totais do Documento */

select
	9 						tp_registro,
	9						cd_registro,
	0						cd_prestador,
	' '						nm_prestador,
	LOCALTIMESTAMP						dt_geracao,
	' '						dt_geracao_orig,
	0						nr_seq_orig,
	' '						ds_espaco,
	' '						ie_congenere,
	' '						ie_tipo_prestador,
	0						nr_beneficiario,
	0						tp_transacao,
	0						tp_despesa,
	0						cd_procedimento,
	9999999999					nr_documento,
	LOCALTIMESTAMP						dt_documento,
	0						vl_despesa,
	0						nr_guia,
	0						qt_procedimento,
	0						nr_conselho,
	0						cd_conselho,
	' '						cd_cid,
	0						cd_dente,
	0						cd_convenio_sec,
	LOCALTIMESTAMP						dt_entrada,
	0						nr_doc_conv_sec,
	' '						ie_pessoa,
	a.qt_total_conta				qt_registro,
	sum(CASE WHEN b.cd_area_proc=1 THEN (coalesce(b.vl_honorario,0) + coalesce(b.vl_custo_oper,0)) WHEN b.cd_area_proc=4 THEN (coalesce(b.vl_honorario,0) + coalesce(b.vl_custo_oper,0))  ELSE b.vl_total_item END )	vl_total,
	a.nr_seq_protocolo				nr_seq_protocolo,
	' '						nr_doc_convenio,
	' '						nr_guia_principal,
	' '						ie_carater_solic,
	0						cd_cbo,
	0						ie_acidente,
	0						tp_saida,
	' '						cd_tabela,
	' '						ie_via_acesso,
	' '						ie_tecnica,
	' '						uf_conselho,
	' '						tp_consulta,
	0						pr_reducao_acres
from	w_interf_conta_item 	b,
	w_interf_conta_trailler a
where	a.nr_seq_protocolo	= b.nr_seq_protocolo
group by
	LOCALTIMESTAMP,
	a.qt_total_conta,
	a.nr_seq_protocolo;

