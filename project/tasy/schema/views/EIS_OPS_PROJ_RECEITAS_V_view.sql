-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_proj_receitas_v (nr_seq_contrato, nr_mes_reajuste, cd_estabelecimento, nr_seq_segurado, nm_segurado, dt_competencia, vl_anterior, vl_atual, vl_antes_reajuste, pr_reajuste_op1, vl_com_rejuste_op1, vl_total_op1, pr_reajuste_op2, vl_com_rejuste_op2, vl_total_op2, pr_reajuste_op3, vl_com_rejuste_op3, vl_total_op3) AS select	nr_seq_contrato,
	nr_mes_reajuste,
	cd_estabelecimento,
	nr_seq_segurado,
	substr(pls_obter_dados_segurado(nr_seq_segurado,'N'),1,255) nm_segurado,
	LOCALTIMESTAMP dt_competencia,
	vl_preco_anterior vl_anterior,
	vl_preco_atual vl_atual,
	vl_antes_reajuste,
	pr_reajuste_op1,
	round((vl_com_rej_op1)::numeric,2) vl_com_rejuste_op1,
	round((vl_antes_reajuste + vl_com_rej_op1)::numeric,2) vl_total_op1,
	pr_reajuste_op2,
	round((vl_com_rej_op2)::numeric,2) vl_com_rejuste_op2,
	round((vl_antes_reajuste + vl_com_rej_op2)::numeric,2) vl_total_op2,
	pr_reajuste_op3,
	round((vl_com_rej_op3)::numeric,2) vl_com_rejuste_op3,
	round((vl_antes_reajuste + vl_com_rej_op3)::numeric,2) vl_total_op3
FROM	(
	select	c.nr_sequencia nr_seq_contrato,
		c.nr_contrato,
		c.nr_mes_reajuste,
		s.cd_estabelecimento,
		s.nr_sequencia nr_seq_segurado,
		sp.nr_sequencia nr_seq_seg_preco,
		sum(sp.vl_preco_ant) vl_preco_anterior,
		sum(sp.vl_preco_atual - coalesce(sp.vl_desconto,0)) vl_preco_atual,
		sum(sp.vl_preco_ant * (c.nr_mes_reajuste - 1)) vl_antes_reajuste,
		null pr_reajuste_op1,
		sum((sp.vl_preco_atual - coalesce(sp.vl_desconto,0)) * (12 - c.nr_mes_reajuste + 1)) vl_com_rej_op1,
		null pr_reajuste_op2,
		sum((sp.vl_preco_atual - coalesce(sp.vl_desconto,0)) * (12 - c.nr_mes_reajuste + 1)) vl_com_rej_op2,
		null pr_reajuste_op3,
		sum((sp.vl_preco_atual - coalesce(sp.vl_desconto,0)) * (12 - c.nr_mes_reajuste + 1)) vl_com_rej_op3
	from	pls_segurado_preco sp,
		pls_segurado s,
		pls_contrato c
	where	s.nr_sequencia = sp.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	sp.cd_motivo_reajuste = 'I'
	and	sp.dt_reajuste between pkg_date_utils.start_of(LOCALTIMESTAMP,'YEAR',0) and pkg_date_utils.end_of(LOCALTIMESTAMP,'YEAR',0)
	group by c.nr_sequencia,
		 c.nr_contrato,
		 c.nr_mes_reajuste,
		 s.cd_estabelecimento,
		 s.nr_sequencia,
		 sp.nr_sequencia
	
union all

	select	nr_seq_contrato,
		nr_contrato,
		nr_mes_reajuste,
		cd_estabelecimento,
		nr_seq_segurado,
		nr_seq_seg_preco,
		vl_preco_anterior,
		vl_preco_atual,
		vl_preco_anterior * (nr_mes_reajuste - 1) vl_antes_reajuste,
		pr_reajuste_op1 * 100 pr_reajuste_op1,
		vl_preco_atual * (1 + pr_reajuste_op1) * (12 - nr_mes_reajuste + 1) vl_com_rej_op1,
		pr_reajuste_op2 * 100 pr_reajuste_op2,
		vl_preco_atual * (1 + pr_reajuste_op2) * (12 - nr_mes_reajuste + 1) vl_com_rej_op2,
		pr_reajuste_op3 * 100 pr_reajuste_op3,
		vl_preco_atual * (1 + pr_reajuste_op3) * (12 - nr_mes_reajuste + 1) vl_com_rej_op3		
	from	(
		select	c.nr_sequencia nr_seq_contrato,
			c.nr_contrato,
			s.nr_sequencia nr_seq_segurado,
			sp.nr_sequencia nr_seq_seg_preco,
			sp.vl_preco_ant vl_preco_anterior,
			sp.vl_preco_atual - coalesce(sp.vl_desconto,0) vl_preco_atual,
			dividir((sp.vl_preco_atual - coalesce(sp.vl_desconto,0) - sp.vl_preco_ant), sp.vl_preco_ant) pr_reajuste_op1,
			((	select	dividir((sum(v.vl_preco_atual) - sum(v.vl_preco_ant)),sum(v.vl_preco_ant))
				from	eis_ops_ind_reajuste_v v
				where	v.dt_reajuste_ref between pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'YEAR',0) and pkg_date_utils.end_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'YEAR',0))) pr_reajuste_op2,
			((	select	dividir((sum(v.vl_preco_atual) - sum(v.vl_preco_ant)),sum(v.vl_preco_ant))
				from	eis_ops_ind_reajuste_v v
				where	v.dt_reajuste_ref between pkg_date_utils.start_of(LOCALTIMESTAMP,'YEAR',0) and pkg_date_utils.end_of(LOCALTIMESTAMP,'YEAR',0))) pr_reajuste_op3,
			c.nr_mes_reajuste,
			s.cd_estabelecimento
		from	pls_segurado_preco sp,
			pls_segurado s,
			pls_contrato c
		where	s.nr_sequencia = sp.nr_seq_segurado
		and	c.nr_sequencia = s.nr_seq_contrato
		and	sp.cd_motivo_reajuste = 'I'
		and	not exists (	select	1
					from	pls_segurado_preco x
					where	x.nr_seq_segurado = s.nr_sequencia
					and	x.dt_reajuste between pkg_date_utils.start_of(LOCALTIMESTAMP,'YEAR',0) and pkg_date_utils.end_of(LOCALTIMESTAMP,'YEAR',0))
		and	sp.dt_reajuste between pkg_date_utils.start_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'YEAR',0) and pkg_date_utils.end_of(pkg_date_utils.add_month(LOCALTIMESTAMP,-12),'YEAR',0)
		) alias71
	where	1 = 1
	) alias72
order by nr_seq_contrato;

