-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_fibria_lote_externo_v (cd_registro, ds_fixo, ie_tipo_operacao, ie_tipo_exame, cd_empresa, cd_unidade, cd_matricula_empregado, dt_prescricao_exame, cd_integracao_exame, cd_exame_resultado, nr_seq_item, ds_resultado_linha, nr_sequencia, nr_seq_prescr, linha, nr_seq_exame, ordenar, nr_seq_lote_externo, cd_exame_integracao, cd_paciente, total) AS select CD_REGISTRO,DS_FIXO,IE_TIPO_OPERACAO,IE_TIPO_EXAME,CD_EMPRESA,CD_UNIDADE,CD_MATRICULA_EMPREGADO,DT_PRESCRICAO_EXAME,CD_INTEGRACAO_EXAME,CD_EXAME_RESULTADO,NR_SEQ_ITEM,DS_RESULTADO_LINHA,NR_SEQUENCIA,NR_SEQ_PRESCR,LINHA,NR_SEQ_EXAME,ORDENAR,NR_SEQ_LOTE_EXTERNO,CD_EXAME_INTEGRACAO,CD_PACIENTE,TOTAL
FROM (
select 1  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
	   rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       substr( Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA'), 1, 7) cd_integracao_exame,
       '010' cd_exame_resultado,
	   '01' nr_seq_item,
	   to_char(a.dt_prescricao, 'yyyymmdd') ds_resultado_linha,
	   0 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   1 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = t.nr_seq_exame --and	 t.nr_seq_material is not null
  and d.ie_status_atend > 30 and d.nr_seq_exame <> 31 --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  and Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') is not null --and	 e.cd_exame_integracao is not null
union all

select 2  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       substr(Obter_Equipamento_Exame(u.nr_seq_exame,null,'FIBRIA'), 1, 7) cd_integracao_exame,
       LPAD(substr(obter_equip_analito_fibria(e.nr_seq_exame), 0, 3 ),3,0) cd_exame_resultado,
	     '01' nr_seq_item,
       lab_formata_resultado_fibria( Obter_Equipamento_Exame(u.nr_seq_exame,null,'FIBRIA'), obter_equip_analito_fibria(e.nr_seq_exame), CASE WHEN d.nr_seq_exame=630 THEN lab_obter_resultado_fator_rh(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000),t.nr_seq_resultado,t.nr_seq_prescr)  ELSE lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) END ) ds_resultado_linha,
	   t.nr_sequencia,
		d.nr_sequencia nr_seq_prescr,
	   coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
  	   2 ordenar,
	   d.nr_seq_lote_externo,	  obter_equip_analito_fibria(e.nr_seq_exame) cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_laboratorio u, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and z.cd_cgc		  = u.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0)) --and	 t.nr_seq_exame not in (select y.nr_seq_exame from prescr_procedimento y where y.nr_prescricao = d.nr_prescricao and y.nr_sequencia = d.nr_sequencia)
  --and	 t.nr_seq_material is not null
  --and	 t.nr_seq_material is null
  and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = u.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame <> 31 --and	 e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(t.nr_seq_exame,null,'FIBRIA') is not null
     
union all

select 3  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       substr( Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA'), 1, 7) cd_integracao_exame,
       CASE WHEN d.nr_seq_exame=233 THEN '026'  ELSE '140' END  cd_exame_resultado,
	   '01' nr_seq_item,
	   'D' ds_resultado_linha,
	   90 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   3 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = t.nr_seq_exame --and	 t.nr_seq_material is not null
  and d.ie_status_atend > 30 and d.nr_seq_exame <> 31 and d.nr_seq_exame <> 630 --and	 e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
 
union all

select 4  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       substr( Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA'), 1, 7) cd_integracao_exame,
       CASE WHEN d.nr_seq_exame=233 THEN '027'  ELSE '150' END  cd_exame_resultado,
	   '01' nr_seq_item,
	   '1' ds_resultado_linha, -- Resultado ds_linha,
	   91 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
	   coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
  	   4 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = t.nr_seq_exame --and	 t.nr_seq_material is not null
  and d.ie_status_atend > 30 and d.nr_seq_exame <> 31 --and	 e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
 order by cd_paciente, nr_seq_prescr, ordenar, cd_exame_integracao
  ) alias81

union all

select "CD_REGISTRO","DS_FIXO","IE_TIPO_OPERACAO","IE_TIPO_EXAME","CD_EMPRESA","CD_UNIDADE","CD_MATRICULA_EMPREGADO","DT_PRESCRICAO_EXAME","CD_INTEGRACAO_EXAME","CD_EXAME_RESULTADO","NR_SEQ_ITEM","DS_RESULTADO_LINHA","NR_SEQUENCIA","NR_SEQ_PRESCR","LINHA","NR_SEQ_EXAME","ORDENAR","NR_SEQ_LOTE_EXTERNO","CD_EXAME_INTEGRACAO","CD_PACIENTE","TOTAL"
from (
select  -- eritrocitos cabecalho
		1  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0003',7,0) cd_integracao_exame,
       '010' cd_exame_resultado,
	      '01' nr_seq_item,
	   to_char(a.dt_prescricao, 'yyyymmdd') ds_resultado_linha, -- Resultado ds_linha,
	   0 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   1 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = t.nr_seq_exame --and	 t.nr_seq_material is not null
  and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 
union all

  select *
  from (
  select -- eritrocitos resultado
		2  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0003',7,0) cd_integracao_exame,
       LPAD(substr(e.cd_exame_integracao, 0, 3 ),3,0) cd_exame_resultado,
       '01' nr_seq_item,
       CASE WHEN t.nr_seq_exame=536 THEN  to_char(lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) * 1000000)  ELSE lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) END  ds_resultado_linha, -- Resultado ds_linha,
     t.nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
     t.nr_seq_exame,
        2 ordenar,
      d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_laboratorio u, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and a.nr_atendimento = g.nr_atendimento and t.nr_seq_exame is not null and ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0)) --and   t.nr_seq_material is null
  and t.nr_seq_exame not in (select y.nr_seq_exame from prescr_procedimento y where y.nr_prescricao = d.nr_prescricao and y.nr_sequencia = d.nr_sequencia) and z.cd_cgc		  = u.cd_cgc_externo and d.nr_seq_exame = u.nr_seq_exame and z.cd_estabelecimento = a.cd_estabelecimento and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and d.nr_prescricao = a.nr_prescricao and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = 31 and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_exame in (select nr_seq_exame from exame_laboratorio where nr_seq_superior = 535) and d.ie_status_atend > 30 --and 	e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(t.nr_seq_exame,null,'FIBRIA') is not null order by cd_exame_integracao
  ) alias134

union all

select -- eritrocitos rodape
		3  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
      lpad('EHA0003',7,0) cd_integracao_exame,
       '140' cd_exame_resultado,
	   '01' nr_seq_item,
	   'D' ds_resultado_linha, -- Resultado ds_linha,
	   90 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   3 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 
union all

select
		4  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0003',7,0) cd_integracao_exame,
       '150' cd_exame_resultado,
	   '01' nr_seq_item,
	   '1' ds_resultado_linha, -- Resultado ds_linha,
	   91 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
	   coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
  	   4 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame = 31 --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null order by cd_paciente, nr_seq_prescr, ordenar, cd_exame_integracao
  ) alias159
 
union all

 select "CD_REGISTRO","DS_FIXO","IE_TIPO_OPERACAO","IE_TIPO_EXAME","CD_EMPRESA","CD_UNIDADE","CD_MATRICULA_EMPREGADO","DT_PRESCRICAO_EXAME","CD_INTEGRACAO_EXAME","CD_EXAME_RESULTADO","NR_SEQ_ITEM","DS_RESULTADO_LINHA","NR_SEQUENCIA","NR_SEQ_PRESCR","LINHA","NR_SEQ_EXAME","ORDENAR","NR_SEQ_LOTE_EXTERNO","CD_EXAME_INTEGRACAO","CD_PACIENTE","TOTAL"
 from (
  select  -- leucocitos cabecalho
		1  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0006',7,0) cd_integracao_exame,
       '010' cd_exame_resultado,
	      '01' nr_seq_item,
	   to_char(a.dt_prescricao, 'yyyymmdd') ds_resultado_linha, -- Resultado ds_linha,
	   0 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   1 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.ie_status_atend > 30 and d.nr_seq_exame = 31 --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 e.cd_exame_integracao is not null
 
union all

  select *
  from (
  select -- leucocitos
		2  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0006',7,0) cd_integracao_exame,
       LPAD(substr(e.cd_exame_integracao, 0, 3 ),3,0) cd_exame_resultado,
       '01' nr_seq_item,
       CASE WHEN t.nr_seq_exame=536 THEN  to_char(lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) * 1000000)  ELSE lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) END  ds_resultado_linha, -- Resultado ds_linha,
     t.nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
     t.nr_seq_exame,
        2 ordenar,
      d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_laboratorio u, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and a.nr_atendimento = g.nr_atendimento and t.nr_seq_exame is not null and ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0)) --and   t.nr_seq_material is null
  and t.nr_seq_exame not in (select y.nr_seq_exame from prescr_procedimento y where y.nr_prescricao = d.nr_prescricao and y.nr_sequencia = d.nr_sequencia) and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and d.nr_prescricao = a.nr_prescricao and t.nr_seq_prescr = d.nr_sequencia and z.cd_cgc		  = u.cd_cgc_externo and d.nr_seq_exame = u.nr_seq_exame and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame = 31 and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_exame in (select nr_seq_exame from exame_laboratorio where nr_seq_superior = 32) and d.ie_status_atend > 30 --and e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(t.nr_seq_exame,null,'FIBRIA') is not null order by cd_exame_integracao
  ) alias212
  
union all

select --
		3  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0006',7,0) cd_integracao_exame,
       '140' cd_exame_resultado,
	   '01' nr_seq_item,
	   'D' ds_resultado_linha, -- Resultado ds_linha,
	   90 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   3 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 
union all

select 4  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0006',7,0) cd_integracao_exame,
       '150' cd_exame_resultado,
	   '01' nr_seq_item,
	   '1' ds_resultado_linha, -- Resultado ds_linha,
	   91 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
	   coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
  	   4 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 e.cd_exame_integracao is not null
 order by cd_paciente, nr_seq_prescr, ordenar, cd_exame_integracao
  ) alias237

union all

select "CD_REGISTRO","DS_FIXO","IE_TIPO_OPERACAO","IE_TIPO_EXAME","CD_EMPRESA","CD_UNIDADE","CD_MATRICULA_EMPREGADO","DT_PRESCRICAO_EXAME","CD_INTEGRACAO_EXAME","CD_EXAME_RESULTADO","NR_SEQ_ITEM","DS_RESULTADO_LINHA","NR_SEQUENCIA","NR_SEQ_PRESCR","LINHA","NR_SEQ_EXAME","ORDENAR","NR_SEQ_LOTE_EXTERNO","CD_EXAME_INTEGRACAO","CD_PACIENTE","TOTAL"
from (
  select  -- plaquetas
		1  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
        coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0009',7,0) cd_integracao_exame,
       '010' cd_exame_resultado,
	      '01' nr_seq_item,
	   to_char(a.dt_prescricao, 'yyyymmdd') ds_resultado_linha, -- Resultado ds_linha,
	   0 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   1 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 
union all

  select *
  from (
  select --plaquetas
		2  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
       coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0009',7,0) cd_integracao_exame,
       LPAD(substr(e.cd_exame_integracao, 0, 3 ),3,0) cd_exame_resultado,
       '01' nr_seq_item,
       CASE WHEN t.nr_seq_exame=536 THEN  to_char(lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) * 1000000)  ELSE lab_obter_result_valor_format(substr(upper( (CASE WHEN t.pr_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.pr_resultado ),'.','') ELSE (CASE WHEN t.qt_resultado IS NOT NULL THEN replace(campo_mascara_virgula( t.qt_resultado ),'.','') ELSE t.ds_resultado  END)  END) ),1,1000)) END  ds_resultado_linha, -- Resultado ds_linha,
     t.nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
     t.nr_seq_exame,
       2 ordenar,
      d.nr_seq_lote_externo,	 Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_laboratorio u, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and a.nr_atendimento = g.nr_atendimento and t.nr_seq_exame is not null and ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0)) --and   t.nr_seq_material is null
  and t.nr_seq_exame not in (select y.nr_seq_exame from prescr_procedimento y where y.nr_prescricao = d.nr_prescricao and y.nr_sequencia = d.nr_sequencia) and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and d.nr_prescricao = a.nr_prescricao and t.nr_seq_prescr = d.nr_sequencia and d.nr_seq_exame = 31 and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_exame in (select nr_seq_exame from exame_laboratorio where nr_seq_superior = 33) and z.cd_cgc		  = u.cd_cgc_externo and d.nr_seq_exame = u.nr_seq_exame and z.cd_estabelecimento = a.cd_estabelecimento and d.ie_status_atend > 30 --and e.cd_exame_integracao is not null
  and Obter_Equipamento_Exame(t.nr_seq_exame,null,'FIBRIA') is not null order by e.cd_exame_integracao
  ) alias290
  
union all

select -- eritrocitos rodape
		3  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
       coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0009',7,0) cd_integracao_exame,
       '140' cd_exame_resultado,
	   '01' nr_seq_item,
	   'D' ds_resultado_linha, -- Resultado ds_linha,
	   90 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
     coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
	   3 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --  and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 
union all

select 4  cd_registro,
       'D' ds_fixo,
       'I' ie_tipo_operacao,
       'P' ie_tipo_exame,
       coalesce(z.cd_interno_lab,'3023') cd_empresa,
       rpad(h.CD_PESSOA_FISICA_EXTERNO,15,' ') cd_unidade,
       lpad(b.CD_SISTEMA_ANT,15) cd_matricula_empregado,
       to_char( trunc(coalesce(a.dt_solic_prescr, LOCALTIMESTAMP),'MONTH'), 'yyyymmdd') dt_prescricao_exame,
       lpad('EHA0009',7,0) cd_integracao_exame,
       '150' cd_exame_resultado,
	   '01' nr_seq_item,
	   '1' ds_resultado_linha, -- Resultado ds_linha,
	   91 nr_sequencia,
     d.nr_sequencia nr_seq_prescr,
	   coalesce(lab_obter_sequencia_exame(a.nr_prescricao, d.nr_sequencia, t.nr_seq_exame),01) linha,
	   t.nr_seq_exame,
  	   4 ordenar,
	   d.nr_seq_lote_externo,	  Obter_Equipamento_Exame(e.nr_seq_exame,null,'FIBRIA') cd_exame_integracao, lpad( b.CD_SISTEMA_ANT, 15) cd_paciente, 0 Total
FROM pessoa_juridica_estab z, exame_lab_result_item t, atendimento_paciente g, exame_lab_resultado f, exame_laboratorio e, prescr_procedimento d, pessoa_fisica c, prescr_medica a, pessoa_fisica b
LEFT OUTER JOIN pf_codigo_externo h ON (b.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_medico = c.cd_pessoa_fisica  and d.nr_prescricao = a.nr_prescricao and a.nr_atendimento = g.nr_atendimento and z.cd_cgc		  = e.cd_cgc_externo and z.cd_estabelecimento = a.cd_estabelecimento and d.nr_seq_exame is not null and t.nr_seq_exame  = e.nr_seq_exame and f.nr_prescricao = a.nr_prescricao and f.nr_seq_resultado = t.nr_seq_resultado and t.nr_seq_prescr = d.nr_sequencia --and	 t.nr_seq_material is not null
  and d.nr_seq_exame = t.nr_seq_exame and d.ie_status_atend > 30 and d.nr_seq_exame = 31 and Obter_Equipamento_Exame(d.nr_seq_exame,null,'FIBRIA') is not null --and	 ((t.ds_resultado is not null) or (t.qt_resultado <> 0) or (t.pr_resultado <> 0))
  --and	 e.cd_exame_integracao is not null
 order by cd_paciente, nr_seq_prescr, ordenar, cd_exame_integracao
  ) alias315;

