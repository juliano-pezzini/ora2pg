-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_material_v2 (nr_sequencia, cd_convenio, ie_emite_conta, nr_interno_conta, cd_material, ds_reduzida, ds_material_sem_acento, ds_material, cd_unidade_medida_consumo, dt_atendimento, dt_conta, dt_conta_dia, qt_material, vl_unitario, vl_unit_sem_round, vl_unitario_simpro, vl_material, vl_mat_total, vl_mat_iss, vl_iss, cd_material_convenio, ds_material_convenio, cd_unidade_medida_convenio, qt_material_convenio, vl_material_convenio, tx_conversao_qtde, cd_setor_atendimento, ds_setor_atendimento, ds_classif_setor, nr_seq_proc_pacote, vl_unitario_convenio, vl_unitario_conv_round, cd_classif_setor, vl_desconto, vl_bruto, vl_unitario_bruto, vl_unit_bruto, cd_simpro, cd_lab_brasindice, ds_lab_brasindice, ie_brasindice, ds_fabricante, cd_cgc_fornecedor, nm_fornecedor_consig, nm_fornececdor_lote, nm_fornecedor, cd_brasindice, ds_fabric_bras_simpro, ds_fornec_fabric_bras_simpro, ds_material_bras, ds_material_simpro, ds_simpro_ou_material, ds_simpro_ou_material_ic, cd_motivo_exc_conta, ds_marca, ds_fornec_ultima_compra, ds_fabricante_mat, ds_fabricante_mat_bras_simpro, ds_mat_matricial, ds_mat_matricial_conv, ie_espaco, cd_sistema_ant, cd_medic_brasindice, cd_simpro_brasindice, cd_grupo_convenio, cd_cgc_prestador, ds_cgc_prestador, ds_fabric_cad_mat, ds_fabric_cad_mat_bras_simpro, cd_material_tiss, ds_observacao, vl_unitario_conv, nr_seq_protocolo) AS select	a.nr_sequencia,
	a.cd_convenio, 
	a.ie_emite_conta, 
	a.nr_interno_conta, 
	a.cd_material, 
	b.ds_reduzida, 
	ds_material_sem_acento, 
	(b.ds_material || '                         ') ds_material, 
	substr(obter_dados_material_estab(b.cd_material, c.cd_estabelecimento,'UMS'),1,30) cd_unidade_medida_consumo, 
	trunc(a.dt_atendimento,'DD') dt_atendimento, 
	a.dt_conta, 
	trunc(a.dt_conta,'DD') dt_conta_dia, 
	a.qt_material, 
	a.vl_unitario, 
	a.vl_unitario vl_unit_sem_round, 
	a.vl_unitario vl_unitario_simpro, 
	a.vl_material, 
	(a.qt_material * a.vl_unitario) vl_mat_total, 
	(a.vl_material + obter_valor_iss_item(a.cd_convenio, a.vl_material)) vl_mat_iss, 
	obter_valor_iss_item(a.cd_convenio, a.vl_material) vl_iss, 
	coalesce(e.cd_material,coalesce(a.cd_material_convenio,a.cd_material)) cd_material_convenio, 
	coalesce(e.ds_material,b.ds_material) ds_material_convenio, 
	coalesce(e.cd_unidade_medida, substr(obter_dados_material_estab(b.cd_material, c.cd_estabelecimento,'UMS'),1,30)) cd_unidade_medida_convenio, 
	(a.qt_material * CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END ) qt_material_convenio, 
	a.vl_material vl_material_convenio, 
	e.tx_conversao_qtde, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	substr(obter_valor_dominio(1,c.cd_classif_setor),0,30) ds_classif_setor, 
	a.nr_seq_proc_pacote, 
--	(a.vl_material) / (decode(a.qt_material,0,1,a.qt_material) * 
--	 decode(nvl(e.tx_conversao_qtde,0),0,1,e.tx_conversao_qtde)) vl_unitario_convenio, 
	(dividir(a.vl_material,a.qt_material * CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END )) vl_unitario_convenio, 
	round((a.vl_material) / 
	(CASE WHEN a.qt_material=0 THEN 1  ELSE a.qt_material END  * 
	 CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END ),2) vl_unitario_conv_round, 
	c.cd_classif_setor, 
	coalesce(f.vl_material,0) vl_desconto, 
	a.vl_material + coalesce(f.vl_material,0) vl_bruto, 
	dividir((a.vl_material + coalesce(f.vl_material,0)),a.qt_material) vl_unitario_bruto, 
	(a.vl_unitario + dividir(coalesce(f.vl_material,0),a.qt_material)) vl_unit_bruto, 
	obter_codigo_simpro(a.cd_material) cd_simpro, 
	substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 
				a.cd_material, a.dt_atendimento, a.cd_convenio, 'CLAB'),1,6) cd_lab_brasindice, 
	substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 
				a.cd_material, a.dt_atendimento, a.cd_convenio, 'DLAB'),1,40) ds_lab_brasindice, 
	CASE WHEN Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 				a.cd_material, a.dt_atendimento, a.cd_convenio, 'CMED') IS NULL THEN 'N'  ELSE 'S' END  ie_brasindice, 
	substr(obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material),1,10) ds_fabricante, 
	a.cd_cgc_fornecedor, 
	substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,80) nm_fornecedor_consig, 
	substr(obter_dados_lote_fornec(a.nr_seq_lote_fornec,'DF'),1,80) nm_fornececdor_lote, 
	substr(coalesce(obter_dados_lote_fornec(a.nr_seq_lote_fornec,'DF'), 
		  obter_nome_pf_pj(null,a.cd_cgc_fornecedor)),1,80) nm_fornecedor, 
	coalesce(substr(Obter_Codigo_Brasindice(coalesce(d.cd_estabelecimento,1), 
			a.cd_material,a.dt_atendimento, d.cd_convenio_parametro),1,20),' ') cd_brasindice, 
	CASE WHEN obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material) IS NULL THEN  		substr(substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 				a.cd_material, a.dt_atendimento, a.cd_convenio, 'DLAB'),1,6),1,40)  ELSE substr(obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material),1,10) END  ds_fabric_bras_simpro, 
	substr(coalesce(obter_dados_lote_fornec(a.nr_seq_lote_fornec,'DF'), 
		  coalesce( obter_nome_pf_pj(null,a.cd_cgc_fornecedor), 
			coalesce(substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 
				a.cd_material, a.dt_atendimento, a.cd_convenio, 'DLAB'),1,6), 
			  obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material)))),1,80) ds_fornec_fabric_bras_simpro, 
	substr(substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 
				a.cd_material, a.dt_atendimento, a.cd_convenio, 'DMED'),1,6),1,100) ds_material_bras, 
	substr(obter_desc_material_simpro(a.cd_material),1,100) ds_material_simpro, 
	substr(coalesce(obter_desc_material_simpro(a.cd_material),b.ds_material),1,100) ds_simpro_ou_material, 
	initcap(substr(coalesce(obter_desc_material_simpro(a.cd_material),b.ds_material),1,100)) ds_simpro_ou_material_ic, 
	a.cd_motivo_exc_conta, 
	substr(Obter_Marca_Material(b.cd_material, 'D'),1,50) ds_marca, 
substr(obter_nome_pf_pj(null,obter_fornecedor_ultima_compra(a.cd_material,obter_estab_atend(a.nr_atendimento))),1,100) 
ds_fornec_ultima_compra, 
	substr(obter_desc_mat_fabricante(b.cd_material),1,80) ds_fabricante_mat, 
	substr(coalesce(CASE WHEN obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material) IS NULL THEN  		substr(substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), 				a.cd_material, a.dt_atendimento, a.cd_convenio, 'DLAB'),1,6),1,40)  ELSE substr(obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material),1,10) END , 
		obter_desc_mat_fabricante(b.cd_material)),1,80) ds_fabricante_mat_bras_simpro, 
	substr(b.ds_material,1,30) ds_mat_matricial, 
	substr(coalesce(e.ds_material,b.ds_material),1,30) ds_mat_matricial_conv, 
	' ' ie_espaco, 
	substr(obter_dados_material_estab(a.cd_material,d.cd_estabelecimento,'CSA'),1,20) CD_SISTEMA_ANT, 
	coalesce(substr(Obter_medic_Brasindice(coalesce(d.cd_estabelecimento,1), 
			a.cd_material,a.dt_atendimento),1,20),' ') cd_medic_brasindice, 
	coalesce(to_char(obter_codigo_simpro(a.cd_material)), coalesce(substr(Obter_medic_Brasindice(coalesce(d.cd_estabelecimento,1), 
			a.cd_material,a.dt_atendimento),1,20),' ')) cd_simpro_brasindice, 
	e.cd_grupo cd_grupo_convenio, 
	a.cd_cgc_prestador, 
	substr(obter_razao_social(a.cd_cgc_prestador),1,200) ds_cgc_prestador, 
	substr(OBTER_DESC_MAT_FABRICANTE(b.cd_material),1,150) DS_FABRIC_CAD_MAT, 
	substr(coalesce(OBTER_DESC_MAT_FABRICANTE(b.cd_material), 
		CASE WHEN obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material) IS NULL THEN  			substr(Obter_Dados_Brasindice(coalesce(c.cd_estabelecimento, c.cd_estabelecimento_base), a.cd_material, a.dt_atendimento, a.cd_convenio, 'DLAB'),1,6)  ELSE obter_fabric_mat_simpro_estab(d.cd_estabelecimento, a.cd_material) END ),1,150) ds_fabric_cad_mat_bras_simpro, 
	a.cd_material_tiss, 
	substr(a.ds_observacao,1, 255) ds_observacao, 
	(dividir(a.vl_material,a.qt_material * CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END )) vl_unitario_conv, 
	d.nr_seq_protocolo 
FROM conta_paciente d, setor_atendimento c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio e ON (a.nr_sequencia = e.nr_seq_material)
LEFT OUTER JOIN mat_atend_paciente_valor f ON (a.nr_sequencia = f.nr_seq_material AND 3 = f.ie_tipo_valor)
WHERE a.cd_material = b.cd_material and a.cd_setor_atendimento 	= c.cd_setor_atendimento and a.nr_interno_conta	= d.nr_interno_conta;

