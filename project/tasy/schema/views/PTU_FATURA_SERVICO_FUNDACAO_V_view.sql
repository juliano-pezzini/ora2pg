-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ptu_fatura_servico_fundacao_v (nr_seq_servico, tp_registro, nr_sequencia, nr_seq_fatura, cd_unimed, nr_seq_contrato, nr_contrato_interno, cd_familia, cd_dependente, nm_beneficiario, nr_seq_guia, dt_emissao, dt_mes_fatura, dt_ano_fatura, ie_tipo_prestador, nm_prestador_exec, ds_especialidade, cd_servico, ds_servico, nm_solicitante, qt_servico, vl_carga_horaria, vl_procedimento, vl_total_servicos, vl_retencao_ir, vl_filme, cd_participacao, hr_execucao, cd_especialidade_prest, dt_internacao, dt_alta, cd_ato, cd_cid, ind_ato_cooperativo, tx_administrativa, ind_via_acesso, hr_entrada, hr_saida, cd_prestador_executor, ie_classif_hosp, nr_seq_contrato_interno, cd_sublocal, vl_um, vl_dois, vl_tres, vl_integral, nr_matricula, cd_tiss_operadora, cd_tiss_prof_exec, nr_cons_prof_exec, sg_cons_prof_exec, ie_tipo_consulta, ie_tipo_saida, cd_carater_solic, ie_ind_clinica, cd_cnes_executor, ie_tipo_atend_sadt, ie_carater_internacao, ie_tipo_internacao, ie_regime_internacao, qt_diarias_solic, ie_tipo_acomodacao, cd_motivo_saida, nr_seq_procedimento, ie_ind_faturamento, nr_guia_referencia, cd_cod_despesa, ie_tabela, nr_cpf_cnpj_executor, dt_atendimento, nr_cpf_cnpj_solic, ie_obito_mulher, ie_obito_neonatal_precoce, ie_obito_neonatal_tardio, qt_nasc_vivos, qt_nasc_vivos_termo, qt_nasc_mortos, qt_nasc_prematuro, cd_cid_obito, qt_obito_prematuro, qt_obito_termo, qt_declara_obito, ie_tipo_guia, ds_campo, ie_ano_campo, nr_seq_lote, ie_iden_guia, nr_seq_procedimento_2, cd_unimed_executora, ie_int_gestacao, ie_int_aborto, ie_int_trans_mat, ie_int_complic_puerperio, ie_int_atend_parto, ie_int_complic_neonatal, ie_int_baixo_peso, ie_int_parto_cesareo, ie_int_parto_normal) AS select	c.nr_seq_serv_pre_pagto 											nr_seq_servico,
	1 														tp_registro,
	1 														nr_sequencia,
	e.nr_sequencia 													nr_seq_fatura,
	lpad(somente_numero(c.cd_unimed),3,'0') 									cd_unimed,
	lpad(coalesce(substr(coalesce(h.nr_seq_contrato,pls_obter_dados_intercambio(h.nr_seq_intercambio,'OE')),1,4),'0'),4,'0') 	nr_seq_contrato,
	lpad(coalesce(substr(coalesce(h.nr_seq_contrato,pls_obter_dados_intercambio(h.nr_seq_intercambio,'OE')),1,4),'0'),4,'0') 	nr_contrato_interno,
	lpad(coalesce(substr(h.cd_matricula_familia,1,6),'0'),6,'0') 							cd_familia,
	lpad(coalesce(substr(pls_obter_dados_segurado(h.nr_sequencia,'C'),1,2),'0'),2,'0') 					cd_dependente,
	rpad(coalesce(substr(c.nm_beneficiario,1,25),' '),25,' ') 								nm_beneficiario,	
	lpad(coalesce(substr(g.cd_guia,1,11),'0'),11,'0') 									nr_seq_guia,
	to_char(g.dt_emissao,'ddmmyyyy') 										dt_emissao,
	null 														dt_mes_fatura,
	null 														dt_ano_fatura,
	lpad(coalesce(d.ie_tipo_prestador,'0'),2,'0') 									ie_tipo_prestador,
	rpad(coalesce(substr(d.nm_prestador,1,40),' '),40,' ') 								nm_prestador_exec,
	lpad(coalesce(substr(pls_obter_desc_espec_ptu(d.cd_especialidade),1,11),'0'),11,'0') 				ds_especialidade,
	lpad(coalesce(substr(pls_obter_dados_conta_proc(d.nr_seq_conta_proc,'C'),1,7),substr(pls_obter_dados_conta_mat(d.nr_seq_conta_mat,'C'),1,7)),7,'0')	cd_servico,
	rpad(coalesce(substr(pls_obter_dados_conta_proc(d.nr_seq_conta_proc,'D'),1,50),substr(pls_obter_dados_conta_mat(d.nr_seq_conta_mat,'D'),1,50)),50,' ') ds_servico,	
	rpad(substr(coalesce(obter_nome_medico(g.cd_medico_solicitante,'N'),' '),1,30),30,' ') 					nm_solicitante,
	lpad(substr(d.qt_procedimento,1,5),5,'0') 										qt_servico,
	'000000' 														vl_carga_horaria,
	lpad(substr(somente_numero(Campo_Mascara_virgula(coalesce(d.vl_procedimento,'0'))),1,13),13,'0') 				vl_procedimento,
	null															vl_total_servicos,
	null															vl_retencao_ir,
	lpad(coalesce(substr(d.vl_filme,1,13),'0'),13,'0')										vl_filme,
	coalesce(d.ie_tipo_participacao,'0')												cd_participacao,
	substr(replace(d.ds_hora_procedimento,':',''),1,4)									hr_execucao,
	CASE WHEN pls_obter_dados_prestador(g.nr_seq_prestador_exec,'CGC') IS NULL THEN lpad(substr(d.cd_especialidade,1,3),3,'0')  ELSE '00' END 	cd_especialidade_prest,
	coalesce(to_char(a.dt_internacao,'ddmmyyyy'),'00000000')									dt_internacao,
	coalesce(to_char(a.dt_alta,'ddmmyyyy'),'00000000')										dt_alta,
	coalesce((select 'I'  where	d.cd_ato is null or g.ie_tipo_guia = 1 or g.ie_tipo_guia = 5),'E') 			cd_ato,	
	rpad(substr(coalesce(c.cd_cid,' '),1,6),6,' ')				cd_cid,
	CASE WHEN coalesce(k.ie_ato_cooperado,3)=3 THEN 'N'  ELSE 'S' END 				ind_ato_cooperativo,
	lpad(coalesce(elimina_caracteres_especiais(k.tx_prestador_item),0),6,'0')	tx_administrativa,
	substr(coalesce(d.ie_via_acesso,'0'),1,1)					ind_via_acesso,
	coalesce(to_char(g.dt_entrada, 'hhmi'),'    ')				hr_entrada,
	coalesce(to_char(g.dt_alta, 'hhmi'),'    ')					hr_saida,
	lpad(coalesce(substr(d.cd_prestador,1,8),'0'),8,'0')				cd_prestador_executor,
	'0'									ie_classif_hosp,
	lpad(coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'OE'),'0'),4,'0')	nr_seq_contrato_interno,
	'00000'									cd_sublocal,
	'0000000000000'								vl_um,
	'0000000000000'								vl_dois,
	'0000000000000'								vl_tres,
	coalesce(j.vl_materiais,0) + coalesce(j.vl_administracao,0)			vl_integral,
	'0000000000'								nr_matricula, 
	lpad(coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'OE'),'0'),14,'0')	cd_tiss_operadora,
	lpad(coalesce(substr(d.sg_cons_prof_prest,1,7),' '),7,' ')	cd_tiss_prof_exec,
	lpad(coalesce(substr(d.nr_cons_prof_prest,1,15),0),15,0)	nr_cons_prof_exec,
	lpad(coalesce(substr(d.sg_uf_cons_prest,1,2),' '),2,' ')	sg_cons_prof_exec,
	lpad(coalesce(g.ie_tipo_consulta,''),1,' ') 			ie_tipo_consulta,
	lpad(coalesce(c.ie_tipo_saida_spdat,' '),1,1)		ie_tipo_saida,
	lpad(coalesce(g.ie_carater_internacao,' '),1,1)		cd_carater_solic,
	lpad(' ',100,' ')					ie_ind_clinica,
	lpad(coalesce(substr(g.cd_cnes,1,7),'0'),7,'0')		cd_cnes_executor,
	lpad(coalesce(substr(c.ie_tipo_atendimento,1,2),'0'),2,'0')	ie_tipo_atend_sadt,
	lpad(CASE WHEN c.ie_tipo_saida_spdat=4 THEN coalesce(g.ie_carater_internacao,' ')  ELSE ' ' END ,1,1)		ie_carater_internacao,
	lpad(coalesce(a.ie_tipo_internacao,'0'),1,1)			ie_tipo_internacao,
	lpad(coalesce(g.ie_regime_internacao,'0'),1,1)		ie_regime_internacao,
	'000'							qt_diarias_solic,
	lpad(coalesce(a.ie_tipo_acomodacao,'0'),2,'0')		ie_tipo_acomodacao,
	'00'							cd_motivo_saida,
	'00'							nr_seq_procedimento,
	'0'							ie_ind_faturamento,
	'00000000000000000000'					nr_guia_referencia,
	'0'							cd_cod_despesa,
	'00'							ie_tabela,
	lpad(coalesce(substr(d.nr_cgc_cpf,1,14),'0'),14,'0')		nr_cpf_cnpj_executor,
	coalesce(to_char(c.dt_atendimento,'ddmmyyyy'),'        ')  	dt_atendimento,
	lpad(coalesce(substr(d.nr_cgc_cpf_req,1,14),'0'),14,'0') 	nr_cpf_cnpj_solic,
	lpad(coalesce(a.ie_obito_mulher,'0'),1,1)			ie_obito_mulher,
	'0'							ie_obito_neonatal_precoce,
	'0'							ie_obito_neonatal_tardio,
	lpad(coalesce(substr(a.qt_nasc_vivos,1,15),'0'),15,'0')	qt_nasc_vivos,
	lpad(coalesce(substr(a.qt_nasc_vivos,1,2),'0'),2,'0')	qt_nasc_vivos_termo,
	lpad(coalesce(substr(a.qt_nasc_mortos,1,2),'0'),2,'0')	qt_nasc_mortos,
	lpad(coalesce(substr(a.qt_nasc_vivos_pre,1,2),'0'),2,'0')	qt_nasc_prematuro,
	lpad(coalesce(substr(a.cd_cid_obito,1,5),'0'),5,'0')		cd_cid_obito,
	lpad(coalesce(substr(a.qt_obito_precoce,1,5),'0'),5,'0')	qt_obito_prematuro,
	a.qt_obito_tardio					qt_obito_termo,
	'0000000'						qt_declara_obito,
	lpad(coalesce(g.ie_tipo_guia,'0'),1,1)			ie_tipo_guia, 
	'0000000000'						ds_campo,
	'0000'							ie_ano_campo,
	'00000000'						nr_seq_lote,
	'000000000000000000'					ie_iden_guia, 
	'00000'							nr_seq_procedimento_2,
	lpad(coalesce(substr(d.cd_unimed_prestador,1,4),'0'),4,'0') 	cd_unimed_executora,
	coalesce(a.ie_int_gestacao,'0')				ie_int_gestacao,
	coalesce(a.ie_int_aborto,'0')				ie_int_aborto,
	coalesce(a.ie_int_transtorno,'0')				ie_int_trans_mat,
	coalesce(a.ie_int_puerperio,'0')				ie_int_complic_puerperio,
	'0'							ie_int_atend_parto,
	coalesce(a.ie_int_neonatal,'0')				ie_int_complic_neonatal,
	coalesce(a.ie_int_baixo_peso,'0')				ie_int_baixo_peso,
	coalesce(a.ie_int_parto_cesarea,'0')				ie_int_parto_cesareo,
	coalesce(a.ie_int_parto_normal,'0')				ie_int_parto_normal
FROM pls_conta_proc k, pls_conta_pos_estabelecido j, pls_segurado h, pls_conta g, pls_fatura f, ptu_fatura e, ptu_nota_servico d, ptu_nota_cobranca c
LEFT OUTER JOIN ptu_nota_hospitalar a ON (c.nr_sequencia = a.nr_seq_nota_cobr)
WHERE d.nr_seq_nota_cobr	= c.nr_sequencia and g.nr_sequencia		= c.nr_nota and f.nr_sequencia		= e.nr_seq_pls_fatura and e.nr_sequencia		= c.nr_seq_fatura and g.nr_seq_segurado	= h.nr_sequencia and g.nr_sequencia		= j.nr_seq_conta and g.nr_sequencia		= k.nr_seq_conta
 
union all

select	max(c.nr_seq_serv_pre_pagto)	nr_seq_servico,
	2				tp_registro,
	2				nr_sequencia,
	e.nr_sequencia			nr_seq_fatura,
	lpad(somente_numero(max(c.cd_unimed)),3,'0')		cd_unimed,
	'0'				nr_seq_contrato,
	null				nr_contrato_interno,
	'0'				cd_familia,
	max(c.cd_usuario_plano)		cd_dependente,
	max(c.nm_beneficiario)		nm_beneficiario,
	null				nr_seq_guia,
	max(to_char(f.dt_mes_competencia,'ddmmyyyy'))	dt_emissao,
	max(trunc(f.dt_mes_competencia,'mm'))	dt_mes_fatura,
	max(trunc(f.dt_mes_competencia,'yyyy'))	dt_ano_fatura,
	null				ie_tipo_prestador,
	null				nm_prestador_exec,
	null				cd_especialidade,
	null				cd_servico,
	null				ds_servico,
	null				nm_solicitante,
	null				qt_servico,
	null				vl_carga_horaria,
	null				vl_procedimento,
	sum(d.vl_procedimento)		vl_total_servicos,
	0				vl_retencao_ir,
	null				vl_filme,
	null				cd_participacao,
	null				hr_execucao,
	null				cd_especialidade_prest,
	null				dt_internacao,
	null				dt_alta,
	null				cd_ato,
	null				cd_cid,
	null				ind_ato_cooperativo,
	null				tx_administrativa,
	null				ind_via_acesso,
	null				hr_entrada,
	null				hr_saida,
	null				cd_prestador_executor,
	null				ie_classif_hosp,
	null				nr_seq_contrato_interno,
	null				cd_sublocal,
	null				vl_um,
	null				vl_dois,
	null				vl_tres,
	null				vl_integral,
	null				nr_matricula,
	null				cd_tiss_operadora,
	null				cd_tiss_prof_exec,
	null				nr_cons_prof_exec,
	null				sg_cons_prof_exec,
	null				ie_tipo_consulta,
	null				ie_tipo_saida,
	null				cd_carater_solic,
	null				ie_ind_clinica,
	null				cd_cnes_executor,
	null				ie_tipo_atend_sadt,
	null				ie_carater_internacao,
	null				ie_tipo_internacao,
	null				ie_regime_internacao,
	null				qt_diarias_solic,
	null				ie_tipo_acomodacao,
	null				cd_motivo_saida,
	null				nr_seq_procedimento,
	null				ie_ind_faturamento,
	null				nr_guia_referencia,
	null				cd_cod_despesa,
	null				ie_tabela,
	null				nr_cpf_cnpj_executor,
	null				dt_atendimento,
	null				nr_cpf_cnpj_solic,
	null				ie_obito_mulher,
	null				ie_obito_neonatal_precoce,
	null				ie_obito_neonatal_tardio,
	null				qt_nasc_vivos,
	null				qt_nasc_vivos_termo,
	null				qt_nasc_mortos,
	null				qt_nasc_prematuro,
	null				qt_obito_prematuro,
	null				qt_obito_termo,
	null				cd_cid_obito,
	null				qt_declara_obito,
	null				ie_tipo_guia,
	null				ds_campo,
	null				ie_ano_campo,
	null				nr_seq_lote,
	null				ie_iden_guia,
	null				nr_seq_procedimento_2,
	null				cd_unimed_executora,
	null				ie_int_gestacao,
	null				ie_int_aborto,
	null				ie_int_trans_mat,
	null				ie_int_complic_puerperio,
	null				ie_int_atend_parto,
	null				ie_int_complic_neonatal,
	null				ie_int_baixo_peso,
	null				ie_int_parto_cesareo,
	null				ie_int_parto_normal
from	ptu_nota_cobranca	c,
	ptu_nota_servico	d,
	ptu_fatura		e,
	pls_fatura		f
where	d.nr_seq_nota_cobr	= c.nr_sequencia
and	e.nr_seq_pls_fatura	= f.nr_sequencia
and	c.nr_seq_fatura		= e.nr_sequencia
group by e.nr_sequencia;

