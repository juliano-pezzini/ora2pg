-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cih_consulta_v (ie_origem_inf, dt_ficha, dt_alta, nr_ficha_ocorrencia, cd_clinica, cd_medico, ie_retardou_alta, cd_doenca_cid, cd_topografia, cd_caso_infeccao, ds_clinica, nm_medico_atend, ds_retard_alta, ds_doenca, ds_topografia, ds_caso_infec, qt_todos, qt_nao_infec, qt_infectados, ie_sexo, ie_faixa_etaria, ds_setor_atendimento, cd_empresa) AS select		distinct 1 ie_origem_inf,
		a.dt_ficha, 
		null dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		count(distinct a.nr_ficha_ocorrencia) qt_todos, 
		0 qt_nao_infec, 
		0 qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia) group BY	a.dt_ficha, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select		2 ie_origem_inf, /* Não infectado */
 
		a.dt_ficha, 
		null dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		0 qt_todos, 
		count(distinct a.nr_ficha_ocorrencia) qt_nao_infec, 
		0 qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
WHERE cd_topografia is null group by	a.dt_ficha, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select		3 ie_origem_inf, /* Infectado */
 
		a.dt_ficha, 
		null dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		0 qt_todos, 
		0 qt_nao_infec, 
		count(distinct a.nr_ficha_ocorrencia) qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
WHERE b.cd_topografia is not null group by	a.dt_ficha, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select		distinct 1 ie_origem_inf, 
		null dt_ficha, 
		g.dt_alta dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		count(distinct a.nr_ficha_ocorrencia) qt_todos, 
		0 qt_nao_infec, 
		0 qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento  group by	g.dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select		2 ie_origem_inf, /* Não infectado */
 
		null dt_ficha, 
		g.dt_alta dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		0 qt_todos, 
		count(distinct a.nr_ficha_ocorrencia) qt_nao_infec, 
		0 qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento  and b.cd_topografia is null group by	g.dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select		3 ie_origem_inf, /* Infectado */
 
		null dt_ficha, 
		g.dt_alta dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60) ds_clinica, 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40) nm_medico_atend, 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END  ds_retard_alta, 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60) ds_doenca, 
		substr(obter_desc_topografia(b.cd_topografia),1,60) ds_topografia, 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60) ds_caso_infec, 
		0 qt_todos, 
		0 qt_nao_infec, 
		count(distinct a.nr_ficha_ocorrencia) qt_infectados, 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10) ie_sexo, 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100) ds_setor_atendimento, 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento  and b.cd_topografia is not null group by	g.dt_alta, 
		a.nr_ficha_ocorrencia, 
		a.cd_clinica, 
		a.cd_medico, 
		a.ie_retardou_alta, 
		a.cd_doenca_cid, 
		b.cd_topografia, 
		b.cd_caso_infeccao, 
		substr(obter_nome_clinica(a.cd_clinica),1,60), 
		substr(obter_nome_medico(a.cd_medico, 'N'),1,40), 
		CASE WHEN a.ie_retardou_alta=1 THEN 'Sim' WHEN a.ie_retardou_alta=2 THEN 'Não'  END , 
		substr(obter_desc_cid_doenca(a.cd_doenca_cid),1,60), 
		substr(obter_desc_topografia(b.cd_topografia),1,60), 
		substr(obter_desc_caso_infeccao(b.cd_caso_infeccao),1,60), 
		substr(obter_sexo_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'D'),1,10), 
		substr(obter_idade(to_date(obter_dados_pf(obter_pessoa_atendimento(a.nr_atendimento,'C'),'DN'),'dd/mm/yyyy'),LOCALTIMESTAMP,'E'),1,10), 
		substr(obter_nome_setor(obter_setor_atend_data(cih_obter_dados_ficha(b.nr_ficha_ocorrencia,1),b.dt_infeccao)),1,100), 
		obter_empresa_estab(obter_estab_atend(a.nr_atendimento));

