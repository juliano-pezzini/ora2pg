-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nfeserv_dest_v310_homol_v (nr_sequencia, cnpj, email, cpf, idestrangeiro, xnome, xfant, ie, indiedest, iest, im, cnae, crt, xlgr, nro, xcpl, xbairro, cmun, xmun, uf, cep, cpais, xpais, fone, cd_pessoa_fisica) AS select 	a.nr_sequencia nr_sequencia,
		CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica, a.cd_cgc)='S' THEN 'IMPORTACAO'  ELSE '00000000000191' END  CNPJ,     
		elimina_caractere_esp_asc(substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'M'),1,60),'S','N') email, 
		null CPF, 
		CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica, a.cd_cgc)='S' THEN  		CASE WHEN a.cd_pessoa_fisica IS NULL THEN obter_dados_pf_pj(null,a.cd_cgc,'CINT')  ELSE obter_dados_pf(cd_pessoa_fisica,'PA') END   ELSE null END  idEstrangeiro,	 
		'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL' xNome, 	 
		elimina_acentos(substr(CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'NM') END ,1,60)) xFant, 	 
		substr(CASE WHEN  upper(CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'IN') END )='ISENTO' THEN  				null  ELSE CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'IN') END  END ,1,14) IE, 
		CASE WHEN upper(CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'IN') END )='ISENTO' THEN '9' WHEN upper(CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'IN') END ) IS NULL THEN '9'  ELSE 1 END  indIEDest, 
		null IEST, 
		null IM, 
		null CNAE, 
		'3' CRT, 	 
		elimina_acentos(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'EN')  ELSE nfe_obter_dados_pj(a.cd_cgc,'EN') END ,1,60)) xLgr, 	 
		substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'NR')  ELSE nfe_obter_dados_pj(a.cd_cgc,'NR') END ,1,60) nro, 	 
		elimina_caractere_esp_asc(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CO')  ELSE nfe_obter_dados_pj(a.cd_cgc,'CM') END ,1,60),'S','N') xCpl, 	 
		substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'B')  ELSE nfe_obter_dados_pj(a.cd_cgc,'BA') END ,'S','N'),1,60) xBairro, 
		LPAD(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CDMDV')  ELSE nfe_obter_dados_pj(a.cd_cgc,'IBGE') END ,1,60),7,'0') cMun, 	 
		substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DM')  ELSE nfe_obter_dados_pj(a.cd_cgc,'MU') END ,'S','N'),1,60) xMun, 	 
		substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'UF')  ELSE nfe_obter_dados_pj(a.cd_cgc,'UF') END ,1,2) UF, 	 
		substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CEP')  ELSE nfe_obter_dados_pj(a.cd_cgc,'CEP') END ,1,8) CEP, 
		'1058' cPais, 
		'BRASIL' xPais, 
		Elimina_Caracteres_Especiais(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DDT') ||OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'T')  ELSE nfe_obter_dados_pj(a.cd_cgc,'DDDT') END ,1,14)) fone, 
		a.cd_pessoa_fisica 
	FROM 	nota_fiscal a, 
		natureza_operacao n 
	where	a.cd_natureza_operacao = n.cd_natureza_operacao 
	and	n.ie_tipo_natureza <> 'I' 
	
union all
 
	select 	a.nr_sequencia nr_sequencia, 
		CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica, a.cd_cgc)='S' THEN 'IMPORTACAO'  ELSE '00000000000191' END  CNPJ,   
		elimina_caractere_esp_asc(substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'M'),1,60),'S','N') email, 
		null CPF, 
		CASE WHEN obter_se_pf_pj_estrangeiro(a.cd_pessoa_fisica, a.cd_cgc)='S' THEN  		CASE WHEN a.cd_pessoa_fisica IS NULL THEN obter_dados_pf_pj(null,a.cd_cgc,'CINT')  ELSE obter_dados_pf(cd_pessoa_fisica,'PA') END   ELSE null END  idEstrangeiro, 
		'NF-E EMITIDA EM AMBIENTE DE HOMOLOGACAO - SEM VALOR FISCAL' xNome, 
		elimina_caractere_esp_asc(substr(CASE WHEN a.cd_cgc IS NULL THEN ''  ELSE nfe_obter_dados_pj(a.cd_cgc,'NM') END ,1,60),'S','N') xFant, 	 
		'' IE, 
		'9' indIEDest, 
		null IEST, 
		null IM, 
		null CNAE, 
		'3' CRT, 	 
		elimina_caractere_esp_asc(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'EN')  ELSE nfe_obter_dados_pj(a.cd_cgc,'EN') END ,1,60),'S','N') xLgr, 	 
		substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'NR')  ELSE nfe_obter_dados_pj(a.cd_cgc,'NR') END ,1,60) nro, 	 
		elimina_caractere_esp_asc(substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CO')  ELSE nfe_obter_dados_pj(a.cd_cgc,'CM') END ,'S','N'),1,60),'S','N') xCpl, 	 
		substr(elimina_caractere_esp_asc(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'B')  ELSE nfe_obter_dados_pj(a.cd_cgc,'BA') END ,'S','N'),1,60) xBairro, 
		'9999999' cMun, 
		'EXTERIOR' xMun, 
		'EX' UF, 	 
		substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CEP')  ELSE nfe_obter_dados_pj(a.cd_cgc,'CEP') END ,1,8) CEP, 
		substr(lpad(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'CPAIS')   ELSE obter_dados_pf_pj(null, a.cd_cgc, 'CDPAIS') END , 5,'0'), 1, 9) cPais, 
		elimina_caractere_esp_asc(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'PAIS')  ELSE obter_dados_pf_pj(null, a.cd_cgc, 'PAIS') END , 1, 60),'S','N') xPais, 
		Elimina_Caracteres_Especiais(substr(CASE WHEN a.cd_cgc IS NULL THEN OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'DDT') ||OBTER_COMPL_PF(a.cd_pessoa_fisica,1,'T')  ELSE nfe_obter_dados_pj(a.cd_cgc,'DDDT') END ,1,14)) fone, 
		a.cd_pessoa_fisica 
	from 	nota_fiscal a, 
		natureza_operacao n 
	where	a.cd_natureza_operacao = n.cd_natureza_operacao 
	and	n.ie_tipo_natureza = 'I';

