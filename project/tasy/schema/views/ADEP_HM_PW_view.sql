-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW adep_hm_pw (nr_prescricao, nr_seq_procedimento, cd_procedimento, ds_procedimento, ie_acm_sn, cd_intervalo, qt_procedimento, ie_status_solucao, ie_suspenso, nr_seq_proc_interno, nr_seq_lab, ie_util_hemocomponente, ie_tipo_proced, dt_inicio_prescr, nr_atendimento) AS SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_procedimento,
		x.cd_procedimento,
		CASE WHEN x.nr_seq_exame_sangue IS NULL THEN CASE WHEN x.ie_util_hemocomponente IS NULL THEN NULL  ELSE '('|| SUBSTR(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado,y.ds_procedimento)  ELSE SUBSTR(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,80) END  || ' ' || SUBSTR(obter_interv_cuidados_hm(a.nr_prescricao, x.nr_sequencia, 'N'),1,100) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_vol_hemocomp qt_procedimento,
		SUBSTR(obter_status_solucao_prescr(3,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		coalesce(x.nr_seq_proc_interno,0) nr_seq_proc_interno,
		x.nr_seq_lab,
		x.ie_util_hemocomponente,
		SUBSTR(obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia),1,100) ie_tipo_proced,
		a.dt_inicio_prescr,
		a.nr_atendimento
		FROM procedimento y, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento AND y.ie_origem_proced = x.ie_origem_proced AND x.nr_prescricao = a.nr_prescricao AND x.nr_seq_proc_interno IS NULL AND x.nr_seq_exame IS NULL AND x.nr_seq_solic_sangue IS NOT NULL GROUP BY
			a.dt_inicio_prescr,
    		a.nr_atendimento,
			a.nr_prescricao,
			x.nr_sequencia,
			x.cd_procedimento,
			coalesce(z.ds_derivado,y.ds_procedimento),
			x.ie_acm,
			x.ie_se_necessario,
			x.cd_intervalo,
			x.qt_vol_hemocomp,
			x.ie_suspenso,
			x.nr_seq_proc_interno,
			CASE WHEN x.nr_seq_exame_sangue IS NULL THEN CASE WHEN x.ie_util_hemocomponente IS NULL THEN NULL  ELSE '('|| SUBSTR(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado,y.ds_procedimento)  ELSE SUBSTR(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,80) END  || ' ' || SUBSTR(obter_interv_cuidados_hm(a.nr_prescricao, x.nr_sequencia, 'N'),1,100),
			x.nr_seq_lab,
			x.ie_util_hemocomponente,
			SUBSTR(CASE WHEN obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia)='BSHE' THEN  Obter_dados_prescr_hm(a.nr_prescricao, x.nr_sequencia, x.cd_procedimento)  ELSE adep_obter_dados_prescr_proc(a.nr_prescricao,x.nr_sequencia,'QIL','S',x.ie_acm,x.ie_se_necessario) END ,1,100),
			SUBSTR(obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia),1,100)
		
UNION ALL

SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_procedimento,
		x.cd_procedimento,
		CASE WHEN x.nr_seq_exame_sangue IS NULL THEN CASE WHEN x.ie_util_hemocomponente IS NULL THEN NULL  ELSE '('|| SUBSTR(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado, w.ds_proc_exame)  ELSE SUBSTR(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,80) END  || ' ' || SUBSTR(obter_interv_cuidados_hm(a.nr_prescricao, x.nr_sequencia, 'N'),1,100) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_vol_hemocomp qt_procedimento,
		SUBSTR(obter_status_solucao_prescr(3,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.nr_seq_proc_interno,
		x.nr_seq_lab,
		x.ie_util_hemocomponente,
		SUBSTR(obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia),1,100) ie_tipo_proced,
		a.dt_inicio_prescr,
		a.nr_atendimento
	FROM procedimento y, proc_interno w, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN san_derivado z ON (x.nr_seq_derivado = z.nr_sequencia)
WHERE y.cd_procedimento = x.cd_procedimento AND y.ie_origem_proced = x.ie_origem_proced AND w.nr_sequencia = x.nr_seq_proc_interno AND x.nr_prescricao = a.nr_prescricao AND coalesce(w.ie_tipo,'O') <> 'G' AND coalesce(w.ie_ivc,'N') <> 'S' AND coalesce(w.ie_ctrl_glic,'NC') = 'NC' AND x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_prot_glic IS NULL AND x.nr_seq_solic_sangue IS NOT NULL GROUP BY
		a.dt_inicio_prescr,
		a.nr_atendimento,
		a.nr_prescricao,
		x.nr_sequencia,
		x.cd_procedimento,
		coalesce(z.ds_derivado, w.ds_proc_exame),
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_vol_hemocomp,
		x.ie_suspenso,
		x.nr_seq_proc_interno,
		x.nr_seq_lab,
		x.ie_util_hemocomponente,
		CASE WHEN x.nr_seq_exame_sangue IS NULL THEN CASE WHEN x.ie_util_hemocomponente IS NULL THEN NULL  ELSE '('|| SUBSTR(obter_valor_dominio(2247,x.ie_util_hemocomponente),1,20) ||') ' END  || coalesce(z.ds_derivado, w.ds_proc_exame)  ELSE SUBSTR(Obter_desc_san_exame(x.nr_seq_exame_sangue),1,80) END  || ' ' || SUBSTR(obter_interv_cuidados_hm(a.nr_prescricao, x.nr_sequencia, 'N'),1,100),
		SUBSTR(CASE WHEN obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia)='BSHE' THEN  Obter_dados_prescr_hm(a.nr_prescricao, x.nr_sequencia, x.cd_procedimento)  ELSE adep_obter_dados_prescr_proc(a.nr_prescricao,x.nr_sequencia,'QIL','S',x.ie_acm,x.ie_se_necessario) END ,1,100),
		SUBSTR(obter_tipo_proc_bs(a.nr_prescricao, x.nr_sequencia),1,100);

