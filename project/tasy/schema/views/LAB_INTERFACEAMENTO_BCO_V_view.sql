-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_interfaceamento_bco_v (cd_pessoa_fisica, ds_obs_prescr, ds_medicamento, ds_amostra, dt_coleta, ie_prioridade, cd_material, nr_prescricao, ie_origem, ds_exames, cd_equipamento, nm_paciente, dt_idade, dt_nascimento, ie_sexo, ie_cor, cd_setor_prescr) AS select 	 b.cd_pessoa_fisica,
	 a.ds_observacao ds_obs_prescr, 
	 obter_inf_hist_saude(b.cd_pessoa_fisica,'M') ds_medicamento, 
	 lab_obter_caracteres_amostra(a.cd_barras,a.ie_padrao_amostra) ds_amostra, 
	 max(a.dt_coleta) dt_coleta, 
	 max(CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END ) ie_prioridade, 
	 coalesce(d.cd_material_integracao, d.cd_material_exame) cd_material,	 
	 a.nr_prescricao, 
	 a.cd_setor_atendimento ie_origem,	 
	 SUBSTR(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'CETUS', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160) ds_exames, 
	 Lab_obter_codigo_equip_interf(c.nr_seq_exame,'CETUS','SE',h.ie_tipo_atendimento,h.cd_estabelecimento, a.cd_setor_atendimento) cd_equipamento, 
	 b.nm_pessoa_fisica nm_paciente, 
	 obter_idade(b.dt_nascimento, a.dt_prescricao, 'A') dt_idade, 
	 b.dt_nascimento, 
	 b.ie_sexo, 
	 b.nr_seq_cor_pele ie_cor, 
	 a.cd_setor_prescr cd_setor_prescr 
FROM 	material_exame_lab d, 
	exame_laboratorio c, 
	atendimento_paciente h, 
	pessoa_fisica b,		 
	(select 	a.dt_coleta, 
		a.nr_seq_lote_externo, 
		a.ie_urgencia, 
		a.nr_seq_lab, 
		a.nr_prescricao, 
		a.cd_setor_atendimento, 
		a.cd_material_exame, 
		a.nr_seq_exame, 
		a.nr_sequencia, 
		a.cd_motivo_baixa, 
		g.cd_barras, 
		g.NR_SEQ_PRESCR_PROC_MAT nr_seq_prescr_proc, 
		g.ie_status, 
		f.ie_padrao_amostra, 
		f.cd_estabelecimento, 
		f.ie_status_envio, 
		e.ds_observacao, 
		e.dt_prescricao, 
		e.cd_setor_atendimento cd_setor_prescr, 
		e.nr_atendimento 
	from	lab_parametro f, 
		prescr_medica e, 
		prescr_proc_mat_item g, 
		prescr_procedimento a 
	where	f.cd_estabelecimento = e.cd_estabelecimento 
	and	e.nr_prescricao = a.nr_prescricao 
	and	a.nr_prescricao = g.nr_prescricao 
	and	a.nr_sequencia	= g.nr_seq_prescr 
	and 	f.ie_status_envio = g.ie_status 
	and	f.ie_padrao_amostra IN ('AMO9','AMO10', 'AMO11','AM10F','AM11F','AMO13') 
	and 	g.dt_integracao is null  
	and	e.dt_prescricao between LOCALTIMESTAMP - interval '300 days' and LOCALTIMESTAMP + interval '30 days' 
	and 	a.nr_seq_exame is not null 
	and 	a.cd_motivo_baixa = 0) a 
where a.nr_seq_exame = c.nr_seq_exame 
 and h.cd_pessoa_fisica = b.cd_pessoa_fisica 
 and a.cd_material_exame = d.cd_material_exame   
  and a.nr_atendimento = h.nr_atendimento  
 and LAB_Obter_Codigo_Exame_Equip('CETUS',a.nr_seq_exame,h.ie_tipo_atendimento,a.ie_urgencia,d.nr_sequencia,'CEX') is not null 
 and length(substr(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'CETUS', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160)) > 0 
 and Obter_Equip_Exame_online_bco(a.nr_seq_exame,null,'CETUS',h.ie_tipo_atendimento, h.cd_estabelecimento) is not null  
group by  	 a.cd_barras, 
 	 lab_obter_caracteres_amostra(a.cd_barras,a.ie_padrao_amostra), 
	coalesce(d.cd_material_integracao, d.cd_material_exame), 
	 a.nr_prescricao, 
	 a.cd_setor_atendimento,	 
	SUBSTR(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'CETUS', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160), 
	Lab_obter_codigo_equip_interf(c.nr_seq_exame,'CETUS','SE',h.ie_tipo_atendimento,h.cd_estabelecimento, a.cd_setor_atendimento), 
	 b.nm_pessoa_fisica, 
	 obter_idade(b.dt_nascimento, a.dt_prescricao, 'A'), 
	 b.dt_nascimento, 
	 b.ie_sexo, 
	 b.nr_seq_cor_pele,	 
	 b.cd_pessoa_fisica, 
	 a.ds_observacao, 
	 a.cd_setor_prescr 

union
 
select 	 b.cd_pessoa_fisica, 
	 a.ds_observacao ds_obs_prescr, 
	 obter_inf_hist_saude(b.cd_pessoa_fisica,'M') ds_medicamento, 
	 lab_obter_caracteres_amostra(a.cd_barras,a.ie_padrao_amostra) ds_amostra, 
	 max(a.dt_coleta) dt_coleta, 
	 max(CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END ) ie_prioridade, 
	 coalesce(d.cd_material_integracao, d.cd_material_exame) cd_material,	 
	 a.nr_prescricao, 
	 a.cd_setor_atendimento ie_origem,	 
	 SUBSTR(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'LABEXT', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160) ds_exames, 
	 Lab_obter_codigo_equip_interf(c.nr_seq_exame,'LABEXT','SE',h.ie_tipo_atendimento,h.cd_estabelecimento, a.cd_setor_atendimento) cd_equipamento, 
	 b.nm_pessoa_fisica nm_paciente, 
	 obter_idade(b.dt_nascimento, a.dt_prescricao, 'A') dt_idade, 
	 b.dt_nascimento, 
	 b.ie_sexo, 
	 b.nr_seq_cor_pele ie_cor, 
	 a.cd_setor_prescr cd_setor_prescr 
from 	material_exame_lab d, 
	exame_laboratorio c, 
	atendimento_paciente h, 
	pessoa_fisica b,		 
	(select 	a.dt_coleta, 
		a.nr_seq_lote_externo, 
		a.ie_urgencia, 
		a.nr_seq_lab, 
		a.nr_prescricao, 
		a.cd_setor_atendimento, 
		a.cd_material_exame, 
		a.nr_seq_exame, 
		a.nr_sequencia, 
		a.cd_motivo_baixa, 
		g.cd_barras, 
		g.NR_SEQ_PRESCR_PROC_MAT nr_seq_prescr_proc, 
		g.ie_status, 
		f.ie_padrao_amostra, 
		f.cd_estabelecimento, 
		f.ie_status_envio, 
		e.ds_observacao, 
		e.dt_prescricao, 
		e.cd_setor_atendimento cd_setor_prescr, 
		e.nr_atendimento 
	from	lab_parametro f, 
		prescr_medica e, 
		prescr_proc_mat_item g, 
		prescr_procedimento a 
	where	f.cd_estabelecimento = e.cd_estabelecimento 
	and	e.nr_prescricao = a.nr_prescricao 
	and	a.nr_prescricao = g.nr_prescricao 
	and	a.nr_sequencia	= g.nr_seq_prescr 
	and 	f.ie_status_envio = g.ie_status 
	and	f.ie_padrao_amostra IN ('AMO9','AMO10', 'AMO11','AM10F','AM11F','AMO13') 
	and 	g.dt_integracao is null  
	and	e.dt_prescricao between LOCALTIMESTAMP - interval '300 days' and LOCALTIMESTAMP + interval '30 days' 
	and 	a.nr_seq_exame is not null 
	and 	a.cd_motivo_baixa = 0) a 
where a.nr_seq_exame = c.nr_seq_exame 
 and h.cd_pessoa_fisica = b.cd_pessoa_fisica 
 and a.cd_material_exame = d.cd_material_exame   
  and a.nr_atendimento = h.nr_atendimento  
 and LAB_Obter_Codigo_Exame_Equip('LABEXT',a.nr_seq_exame,h.ie_tipo_atendimento,a.ie_urgencia,d.nr_sequencia,'CEX') is not null 
 and length(substr(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'LABEXT', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160)) > 0 
 and Obter_Equip_Exame_online_bco(a.nr_seq_exame,null,'LABEXT',h.ie_tipo_atendimento, h.cd_estabelecimento) is not null  
group by  	 a.cd_barras, 
 	 lab_obter_caracteres_amostra(a.cd_barras,a.ie_padrao_amostra), 
	coalesce(d.cd_material_integracao, d.cd_material_exame), 
	 a.nr_prescricao, 
	 a.cd_setor_atendimento,	 
	SUBSTR(Obter_Exames_Lab_integr_online(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, c.nr_seq_grupo, NULL, 'CI9','',c.nr_seq_grupo_imp, nr_seq_lab, a.ie_status_envio, 'LABEXT', null,nr_seq_lote_externo,h.ie_tipo_atendimento,a.nr_seq_prescr_proc), 1, 160), 
	Lab_obter_codigo_equip_interf(c.nr_seq_exame,'LABEXT','SE',h.ie_tipo_atendimento,h.cd_estabelecimento, a.cd_setor_atendimento), 
	 b.nm_pessoa_fisica, 
	 obter_idade(b.dt_nascimento, a.dt_prescricao, 'A'), 
	 b.dt_nascimento, 
	 b.ie_sexo, 
	 b.nr_seq_cor_pele,	 
	 b.cd_pessoa_fisica, 
	 a.ds_observacao, 
	 a.cd_setor_prescr;

