-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_outras_despesas_v (ds_versao, ie_tipo_despesa, vl_item, dt_item, qt_item, vl_unitario, ie_proc_mat, cd_edicao_amb, ds_procedimento, cd_procedimento, cd_autorizacao, nr_interno_conta, vl_reducao_acrescimo, cd_medico_atendimento, nr_seq_protocolo, nr_atendimento, cd_procedimento_convenio, cd_edicao_relat, cd_cgc_prestador, ie_tiss_tipo_guia_desp) AS select	'2.01.01' ds_versao,
	CASE WHEN b.ie_tipo_material=1 THEN  '3' WHEN b.ie_tipo_material=2 THEN  '2' WHEN b.ie_tipo_material=3 THEN  '2'  ELSE '3' END  ie_tipo_despesa,
	sum(a.vl_material) vl_item,
	TISS_OBTER_DT_DESPESA(h.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,a.cd_material) dt_item,
	sum(a.qt_material * CASE WHEN coalesce(f.tx_conversao_qtde,0)=0 THEN 1  ELSE f.tx_conversao_qtde END) qt_item,
	a.vl_unitario,
	'M' ie_proc_mat,
	substr(tiss_obter_origem_preco_mat(a.ie_origem_preco, a.cd_material, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento,'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),1,5) CD_EDICAO_AMB,
	substr(TISS_ELIMINAR_CARACTERE(coalesce(f.ds_material,b.ds_material)),1,60) ds_procedimento,
	lpad(b.cd_material,10,'0') cd_procedimento,
	coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)) cd_autorizacao,
	a.nr_interno_conta,
	0 vl_reducao_acrescimo,
	d.cd_medico_atendimento,
	e.nr_seq_protocolo,
	a.nr_atendimento,
	substr(TISS_OBTER_COD_MAT(coalesce(f.CD_MATERIAL, a.cd_material_convenio), e.cd_estabelecimento,  a.cd_material, a.dt_conta, 
					tiss_obter_origem_preco_mat(a.ie_origem_preco, 
									a.cd_material, 
									e.cd_estabelecimento, 
									e.cd_convenio_parametro, 
									e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss), e.cd_convenio_parametro),1,20) CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_origem_preco_mat(a.ie_origem_preco, a.cd_material, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento, 'R',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),1,5) cd_edicao_relat,
	coalesce(a.cd_cgc_prestador, h.cd_cgc) cd_cgc_prestador,
	a.ie_tiss_tipo_guia_desp
FROM classe_material i, estabelecimento h, conta_paciente e, atendimento_paciente d, convenio c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE a.cd_material		= b.cd_material and c.cd_convenio		= a.cd_convenio and a.nr_atendimento	= d.nr_atendimento and a.cd_motivo_exc_conta	is null and a.nr_interno_conta	= e.nr_interno_conta  and a.nr_seq_proc_pacote	is null and e.cd_estabelecimento	= h.cd_estabelecimento and b.cd_classe_material	= i.cd_classe_material and coalesce(i.IE_TIPO_CLASSE,'X') not in ('O','P','M')
having	sum(a.vl_material) 	<> 0
group 	by CASE WHEN b.ie_tipo_material=1 THEN  '3' WHEN b.ie_tipo_material=2 THEN  '2' WHEN b.ie_tipo_material=3 THEN  '2'  ELSE '3' END ,
	TISS_OBTER_DT_DESPESA(h.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'S',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,a.cd_material),
	a.vl_unitario,
	substr(tiss_obter_origem_preco_mat(a.ie_origem_preco, a.cd_material, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento, 'X',a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),1,5),
	substr(TISS_ELIMINAR_CARACTERE(coalesce(f.ds_material,b.ds_material)),1,60),
	lpad(b.cd_material,10,'0'),
	coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)),
	a.nr_interno_conta,
	d.cd_medico_atendimento,
	e.nr_seq_protocolo,
	a.nr_atendimento,
	substr(TISS_OBTER_COD_MAT(coalesce(f.CD_MATERIAL, a.cd_material_convenio), e.cd_estabelecimento,  a.cd_material, a.dt_conta, 
					tiss_obter_origem_preco_mat(a.ie_origem_preco, 
									a.cd_material, 
									e.cd_estabelecimento, 
									e.cd_convenio_parametro, 
									e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento, 'X', a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss), e.cd_convenio_parametro),1,20),
	substr(tiss_obter_origem_preco_mat(a.ie_origem_preco, a.cd_material, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.cd_tab_preco_material, a.dt_conta, a.cd_setor_atendimento, 'R', a.nr_seq_proc_pacote,a.nr_sequencia, a.cd_material_tuss),1,5),
	coalesce(a.cd_cgc_prestador, h.cd_cgc),
	a.ie_tiss_tipo_guia_desp
 
union 	all

select	'2.01.01' ds_versao,
	a.ie_tiss_tipo_despesa ie_tipo_despesa,
	sum(a.vl_procedimento) vl_item,
	TISS_OBTER_DT_DESPESA(h.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,null) dt_item,
	sum(a.qt_procedimento) qt_item,
	dividir_sem_round(a.vl_procedimento, a.qt_procedimento) vl_unitario,
	'P' ie_proc_mat,
	coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta,'X', b.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20),'00') CD_EDICAO_AMB,
	substr(TISS_ELIMINAR_CARACTERE(b.ds_procedimento),1,60) ds_procedimento,
	lpad(b.cd_procedimento,10,'0') cd_procedimento,
	coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)) cd_autorizacao,
	a.nr_interno_conta,
	0 vl_reducao_acrescimo,
	d.cd_medico_atendimento,
	e.nr_seq_protocolo,
	a.nr_atendimento,
	replace(replace(lpad(coalesce(a.cd_procedimento_convenio, a.cd_procedimento),10,'0'),'.',''),'-','') CD_PROCEDIMENTO_CONVENIO,
	coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta, 'R', b.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20),'00') CD_EDICAO_RELAT,
	coalesce(coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador), h.cd_cgc) cd_cgc_prestador,
	a.ie_tiss_tipo_guia_desp
FROM estabelecimento h, conta_paciente e, atendimento_paciente d, convenio c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN regra_honorario f ON (a.ie_responsavel_credito = f.cd_regra)
WHERE a.cd_procedimento	= b.cd_procedimento and a.ie_origem_proced	= b.ie_origem_proced and c.cd_convenio		= a.cd_convenio and a.nr_atendimento	= d.nr_atendimento  and TISS_OBTER_GUIA_PROC(d.ie_tipo_atendimento, 
				a.cd_procedimento, 
				a.ie_origem_proced,
				f.ie_entra_conta,
				f.ie_repassa_medico,
				a.ie_tiss_tipo_guia) = '7' and a.nr_interno_conta	= e.nr_interno_conta and coalesce(a.nr_seq_proc_pacote, a.nr_sequencia) = a.nr_sequencia and a.cd_motivo_exc_conta	is null and e.cd_estabelecimento		= h.cd_estabelecimento
having	sum(a.vl_procedimento) <> 0	
group	by a.ie_tiss_tipo_despesa,
	TISS_OBTER_DT_DESPESA(h.cd_estabelecimento, c.cd_convenio, a.dt_conta, e.dt_periodo_inicial, e.dt_periodo_final, 'N',e.ie_tipo_atend_conta,e.nr_interno_conta,'D',a.ie_tiss_tipo_despesa,null),
	dividir_sem_round(a.vl_procedimento, a.qt_procedimento),
	coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta,'X', b.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20),'00'),
	substr(TISS_ELIMINAR_CARACTERE(b.ds_procedimento),1,60),
	lpad(b.cd_procedimento,10,'0'),
	coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)),
	a.nr_interno_conta,
	d.cd_medico_atendimento,
	e.nr_seq_protocolo,
	a.nr_atendimento,
	replace(replace(lpad(coalesce(a.cd_procedimento_convenio, a.cd_procedimento),10,'0'),'.',''),'-',''),
	coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb, e.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta,'R', b.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20),'00'),
	coalesce(coalesce(a.cd_cgc_prestador_tiss, a.cd_cgc_prestador), h.cd_cgc),
	a.ie_tiss_tipo_guia_desp;

