-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW man_ordem_serv_prev_dia_v (ie_tipo, ds_tipo, nr_sequencia, ie_classificacao, dt_ordem_servico, ds_prioridade, ds_setor, nm_solicitante, nm_exec, ds_dano_breve, ds_classificacao, ds_estagio, ds_localizacao, ie_prior_desen, qt_volta_os, qt_min_prev, qt_min_exec, ds_tipo_os_meta, ie_prioridade, qt_min_hoje, nr_seq_estagio, dt_atividade, nm_usuario_exec, nm_usuario_prev, dt_prevista, ie_situacao_os) AS select	'AP' ie_tipo,
	'Atividades previstas' ds_tipo, 
	a.nr_sequencia, 
	a.ie_classificacao, 
	a.dt_ordem_servico, 
	substr(obter_valor_dominio(1046, a.ie_prioridade),1,40) ds_prioridade, 
	substr(a.ds_setor_atendimento, 1,60) ds_setor, 
	substr(obter_nome_pf_pj(a.cd_pessoa_solicitante, ''),1,60) nm_solicitante, 
	substr(obter_nome_usuario(a.nm_usuario_exec_prev),1,40) nm_exec, 
	a.ds_dano_breve, 
	a.ds_classificacao, 
	a.ds_estagio, 
	a.ds_localizacao, 
	coalesce(a.ie_prioridade_desen, 0) ie_prior_desen, 
	obter_qt_volta_os(a.nr_sequencia) qt_volta_os, 
	sum(y.qt_min_prev) qt_min_prev, 
	man_obter_min_ordem_real_usu(y.nr_seq_ordem_serv,y.nm_usuario_prev, y.dt_prevista) qt_min_exec, 
	substr(obter_valor_dominio(3419, substr(obter_plano_meta_tipo_os(a.nr_seq_gerencia_des,a.nr_sequencia),1,15)),1,100) ds_tipo_os_meta, 
	a.ie_prioridade, 
	max(substr(man_obter_min_os_execucao(a.nr_sequencia,LOCALTIMESTAMP,y.nm_usuario_prev),1,10)) qt_min_hoje, 
	b.nr_sequencia nr_seq_estagio, 
	null dt_atividade, 
	null nm_usuario_exec, 
	y.nm_usuario_prev, 
	max(y.dt_prevista) dt_prevista, 
	b.ie_situacao_os 
FROM	man_ordem_ativ_prev	y, 
	man_estagio_processo	b, 
	man_ordem_servico_v	a 
where	a.nr_seq_estagio		= b.nr_sequencia 
and	a.nr_sequencia		= y.nr_seq_ordem_serv 
group by 
	a.nr_sequencia, 
	a.ie_classificacao, 
	a.dt_ordem_servico, 
	a.ie_prioridade, 
	a.ds_setor_atendimento, 
	a.cd_pessoa_solicitante, 
	a.nm_usuario_exec_prev, 
	a.ds_dano_breve, 
	a.ds_classificacao, 
	a.ds_estagio, 
	a.ds_localizacao, 
	a.ie_prioridade_desen, 
	man_obter_min_ordem_real_usu(y.nr_seq_ordem_serv,y.nm_usuario_prev, y.dt_prevista), 
	obter_plano_meta_tipo_os(a.nr_seq_gerencia_des,a.nr_sequencia), 
	b.nr_sequencia, 
	y.nm_usuario_prev, 
	b.ie_situacao_os 

union
 
select	'ESP' ie_tipo, 
	'Executadas s/ previs√£o' ds_tipo, 
	a.nr_sequencia, 
	a.ie_classificacao, 
	a.dt_ordem_servico, 
	substr(obter_valor_dominio(1046,a.ie_prioridade),1,40) ds_prioridade, 
	substr(a.ds_setor_atendimento, 1,60) ds_setor, 
	substr(obter_nome_pf_pj(a.cd_pessoa_solicitante,''),1,60) nm_solicitante, 
	substr(obter_nome_usuario(a.nm_usuario_exec_prev),1,40) nm_exec, 
	a.ds_dano_breve, 
	a.ds_classificacao, 
	a.ds_estagio, 
	a.ds_localizacao, 
	coalesce(a.ie_prioridade_desen,0) ie_prior_desen, 
	obter_qt_volta_os(a.nr_sequencia) qt_volta_os, 
	man_obter_min_ordem_prev_usu(y.nr_seq_ordem_serv,y.nm_usuario_exec, y.dt_atividade) qt_min_prev, 
	sum(y.qt_minuto) qt_min_exec, 
	substr(obter_valor_dominio(3419, substr(obter_plano_meta_tipo_os(a.nr_seq_gerencia_des, a.nr_sequencia),1,15)),1,100) ds_tipo_os_meta, 
	a.ie_prioridade, 
	max(substr(man_obter_min_os_execucao(a.nr_sequencia,LOCALTIMESTAMP,y.nm_usuario_exec),1,10)) qt_min_hoje, 
	null nr_seq_estagio, 
	max(y.dt_atividade), 
	y.nm_usuario_exec, 
	null nm_usuario_prev, 
	null dt_prevista, 
	null ie_situacao_os 
from	man_ordem_serv_ativ	y, 
	man_ordem_servico_v	a 
where	a.nr_sequencia	= y.nr_seq_ordem_serv 
group by 
	a.nr_sequencia, 
	a.ie_classificacao, 
	a.dt_ordem_servico, 
	substr(obter_valor_dominio(1046,a.ie_prioridade),1,40), 
	substr(a.ds_setor_atendimento,1,60), 
	substr(obter_nome_pf_pj(a.cd_pessoa_solicitante, ''),1,60), 
	substr(obter_nome_usuario(a.nm_usuario_exec_prev),1,40), 
	a.ds_dano_breve, 
	a.ds_classificacao, 
	a.ds_estagio, 
	a.ds_localizacao, 
	coalesce(a.ie_prioridade_desen, 0), 
	obter_qt_volta_os(a.nr_sequencia), 
	substr(obter_valor_dominio(3419, substr(obter_plano_meta_tipo_os(a.nr_seq_gerencia_des,a.nr_sequencia),1,15)),1,100), 
	man_obter_min_ordem_prev_usu(y.nr_seq_ordem_serv, y.nm_usuario_exec, y.dt_atividade), 
	a.ie_prioridade, 
	y.nm_usuario_exec;

