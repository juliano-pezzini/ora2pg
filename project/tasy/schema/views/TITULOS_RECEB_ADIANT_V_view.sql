-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW titulos_receb_adiant_v (estabelecimento, dt_dia, nm_convenio, dt_pagto_prev, vl_nt_cred, nr_nf, ds_tipo_receb, ds_conta, ds_transacao, dt_recebimento, nr_titulo, vl_recebido, vl_descontos, vl_rec_maior, vl_glosa, vl_juros, vl_multa, vl_perdas, vl_cambial_ativo, vl_cambial_passivo, nr_seq_grupo, sub_grupo, ds_produto, nr_seq_prod, cd_convenio, cd_portador, cd_tipo_portador, cd_tipo_recebimento, ie_situacao, ie_tipo_titulo, nr_seq_conta_banco, nr_seq_trans_fin, cd_conta_financ) AS SELECT OBTER_NOME_FANTASIA_ESTAB(b.cd_estabelecimento) ESTABELECIMENTO,
    TRUNC(a.dt_recebimento,'dd')  dt_dia,
	SUBSTR(obter_nome_convenio(b.cd_convenio),1,40)  nm_convenio,
	b.dt_pagamento_previsto dt_pagto_prev,
    a.vl_nota_credito vl_nt_cred,
	b.nr_nota_fiscal nr_nf,
	c.ds_tipo_recebimento ds_tipo_receb,
	TO_CHAR(x.cd_banco, '000') || ' / ' || x.cd_conta || ' - ' || x.ie_digito_conta || ' - '
|| CASE WHEN x.nr_seq_tipo_conta=1 THEN 'Inv.'  ELSE 'CC' END  ds_conta,
	SUBSTR(obter_desc_trans_financ(a.nr_seq_trans_fin),1,35) ds_transacao,
	TRUNC(a.dt_recebimento,'dd') dt_recebimento,
	a.nr_titulo nr_titulo,
	coalesce(SUM(a.vl_recebido),0) vl_recebido,
	coalesce(SUM(a.vl_descontos),0) vl_descontos,
	coalesce(SUM(a.vl_rec_maior),0) vl_rec_maior,
	coalesce(SUM(a.vl_glosa),0) vl_glosa,
	coalesce(SUM(a.vl_juros),0) vl_juros,
	coalesce(SUM(a.vl_multa),0) vl_multa,
	coalesce(SUM(a.vl_perdas),0) vl_perdas,
                coalesce(SUM(a.vl_cambial_ativo),0) vl_cambial_ativo,
                coalesce(SUM(a.vl_cambial_passivo),0) vl_cambial_passivo,
	d.nr_seq_grupo nr_seq_grupo,
	OBTER_PROD_FINANC(b.NR_TITULO,'TR','S') sub_grupo,
	d.ds_produto ds_produto,
	d.nr_sequencia NR_SEQ_PROD,
	b.cd_convenio cd_convenio,
	b.cd_portador cd_portador,
	b.cd_tipo_portador cd_tipo_portador,
	a.cd_tipo_recebimento cd_tipo_recebimento,
	b.ie_situacao	ie_situacao,
	b.ie_tipo_titulo ie_tipo_titulo,
	a.nr_seq_conta_banco nr_seq_conta_banco,
	a.nr_seq_trans_fin nr_seq_trans_fin,
	t.cd_conta_financ cd_conta_financ
FROM banco_estabelecimento_v x, tipo_recebimento c, titulo_receber_liq a, titulo_receber_v b
LEFT OUTER JOIN titulo_receber_classif t ON (b.nr_titulo = t.nr_titulo)
LEFT OUTER JOIN produto_financeiro d ON (t.nr_seq_produto = d.nr_sequencia)
WHERE a.nr_titulo			= b.nr_titulo AND a.nr_titulo			= b.nr_titulo AND b.CD_ESTABELECIMENTO <> 41 AND a.cd_tipo_recebimento	= c.cd_tipo_recebimento AND a.nr_seq_conta_banco = x.nr_sequencia  AND a.NR_SEQ_TRANS_FIN IS NOT NULL AND coalesce(t.nr_sequencia,0)= (SELECT	coalesce(MIN(z.nr_sequencia),0)
	FROM	titulo_receber_classif z
	WHERE	z.nr_titulo	= a.nr_titulo/*
		*/
) GROUP BY	b.cd_estabelecimento, TRUNC(a.dt_recebimento,'dd'),
	SUBSTR(obter_nome_convenio(b.cd_convenio),1,40),
	b.dt_pagamento_previsto,
                a.vl_nota_credito,
	b.nr_nota_fiscal,
	c.ds_tipo_recebimento,
	TO_CHAR(x.cd_banco, '000') || ' / ' || x.cd_conta || ' - ' || x.ie_digito_conta || ' - '
|| CASE WHEN x.nr_seq_tipo_conta=1 THEN 'Inv.'  ELSE 'CC' END ,
	SUBSTR(obter_desc_trans_financ(a.nr_seq_trans_fin),1,35),
	TRUNC(a.dt_recebimento,'dd'),
	a.nr_titulo,
	d.nr_seq_grupo,
	d.ds_produto,
	b.NR_TITULO,
	d.nr_sequencia,
	b.cd_convenio ,
	b.cd_portador ,
	b.cd_tipo_portador ,
	a.cd_tipo_recebimento ,
	b.ie_situacao	,
	b.ie_tipo_titulo ,
	a.nr_seq_conta_banco ,
	a.nr_seq_trans_fin,
	t.cd_conta_financ
 HAVING	COUNT(*) > 0

UNION ALL

SELECT 	OBTER_NOME_FANTASIA_ESTAB(b.cd_estabelecimento) ESTABELECIMENTO,
     TRUNC(a.dt_recebimento,'dd')  dt_dia,
	SUBSTR(obter_nome_convenio(b.cd_convenio),1,40)  nm_convenio,
	b.dt_pagamento_previsto dt_pagto_prev,
                a.vl_nota_credito vl_nt_cred,
	b.nr_nota_fiscal nr_nf,
	c.ds_tipo_recebimento ds_tipo_receb,
	' ' ds_conta,
	SUBSTR(obter_desc_trans_financ(a.nr_seq_trans_fin),1,35) ds_transacao,
	TRUNC(a.dt_recebimento,'dd') dt_recebimento,
	a.nr_titulo nr_titulo,
	coalesce(SUM(a.vl_recebido),0) vl_recebido,
	coalesce(SUM(a.vl_descontos),0) vl_descontos,
	coalesce(SUM(a.vl_rec_maior),0) vl_rec_maior,
	coalesce(SUM(a.vl_glosa),0) vl_glosa,
	coalesce(SUM(a.vl_juros),0) vl_juros,
	coalesce(SUM(a.vl_multa),0) vl_multa,
	coalesce(SUM(a.vl_perdas),0) vl_perdas,
                coalesce(SUM(a.vl_cambial_ativo),0) vl_cambial_ativo,
                coalesce(SUM(a.vl_cambial_passivo),0) vl_cambial_passivo,
	d.nr_seq_grupo nr_seq_grupo,
	OBTER_PROD_FINANC(b.NR_TITULO,'TR','S') sub_grupo,
	d.ds_produto ds_produto,
	d.nr_sequencia NR_SEQ_PROD,
	b.cd_convenio cd_convenio,
	b.cd_portador cd_portador,
	b.cd_tipo_portador cd_tipo_portador,
	a.cd_tipo_recebimento cd_tipo_recebimento,
	b.ie_situacao	ie_situacao,
	b.ie_tipo_titulo ie_tipo_titulo,
	a.nr_seq_conta_banco nr_seq_conta_banco,
	a.nr_seq_trans_fin nr_seq_trans_fin,
	t.cd_conta_financ cd_conta_financ
FROM tipo_recebimento c, titulo_receber_liq a, titulo_receber_v b
LEFT OUTER JOIN titulo_receber_classif t ON (b.nr_titulo = t.nr_titulo)
LEFT OUTER JOIN produto_financeiro d ON (t.nr_seq_produto = d.nr_sequencia)
WHERE a.nr_titulo			= b.nr_titulo AND b.CD_ESTABELECIMENTO <> 41 AND a.cd_tipo_recebimento	= c.cd_tipo_recebimento  AND a.nr_seq_conta_banco IS NULL AND a.NR_SEQ_TRANS_FIN IS NOT NULL AND coalesce(t.nr_sequencia,0)= (SELECT	coalesce(MIN(z.nr_sequencia),0)
		FROM	titulo_receber_classif z
		WHERE	z.nr_titulo	= a.nr_titulo/*
		*/
) GROUP BY	b.cd_estabelecimento, TRUNC(a.dt_recebimento,'dd'),
SUBSTR(obter_nome_convenio(b.cd_convenio),1,40),
b.dt_pagamento_previsto,
a.vl_nota_credito,
b.nr_nota_fiscal,
c.ds_tipo_recebimento,
SUBSTR(obter_desc_trans_financ(a.nr_seq_trans_fin),1,35),
TRUNC(a.dt_recebimento,'dd'),
a.nr_titulo,
d.nr_seq_grupo,
d.ds_produto,
b.NR_TITULO,
d.nr_sequencia,
b.cd_convenio ,
b.cd_portador ,
b.cd_tipo_portador ,
a.cd_tipo_recebimento ,
b.ie_situacao	,
b.ie_tipo_titulo ,
a.nr_seq_conta_banco ,
a.nr_seq_trans_fin,
t.cd_conta_financ
 HAVING	COUNT(*) > 0
ORDER BY 	1,2,3,4;

