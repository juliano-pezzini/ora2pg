-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW surgery_statistics_v (actual_start, planned_start, op_name, cd_agenda, diff_planned_actual, op_seq, hr_inicio, nr_min_duracao_prev, actual_duration, diff_surgery_time, establishment_name) AS SELECT ACTUAL_START,PLANNED_START,OP_NAME,CD_AGENDA,DIFF_PLANNED_ACTUAL,OP_SEQ,HR_INICIO,NR_MIN_DURACAO_PREV,ACTUAL_DURATION,DIFF_SURGERY_TIME,ESTABLISHMENT_NAME
FROM (SELECT c.dt_inicio_real actual_start,
    c.dt_inicio_prevista planned_start,
    upper(obter_nome_agenda(ap.cd_agenda)) op_name,
    ap.cd_agenda cd_agenda,
    obter_min_entre_datas(c.dt_inicio_prevista, c.dt_inicio_real, NULL) diff_planned_actual,
    RANK() OVER ( PARTITION BY ap.dt_agenda, ap.cd_agenda ORDER BY ap.hr_inicio ) op_seq,
    ap.hr_inicio hr_inicio,
    nr_min_duracao_prev nr_min_duracao_prev,
    nr_min_duracao_real actual_duration,
   CASE WHEN NR_MIN_DURACAO_PREV=0 THEN ''  ELSE (NR_MIN_DURACAO_PREV - NR_MIN_DURACAO_REAL)/NR_MIN_DURACAO_PREV END *100 diff_surgery_time,
    upper(obter_nome_estabelecimento(obter_estab_agenda(cd_agenda))) establishment_name
FROM agenda_paciente ap
INNER JOIN cirurgia c
  ON ap.nr_cirurgia          = c.nr_cirurgia
WHERE ap.cd_pessoa_fisica IS NOT NULL) alias9;

