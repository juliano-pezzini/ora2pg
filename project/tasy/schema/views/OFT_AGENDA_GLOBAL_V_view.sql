-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW oft_agenda_global_v (ds_agenda, cd_tipo_agenda, ds_tipo_agenda, ds_estabelecimento, nr_sequencia, hr_hora, nr_minuto_duracao, ie_status_agenda, ds_status_agenda, ds_classif_agenda, cd_pessoa_fisica, nm_paciente, ds_convenio, nr_atendimento, ds_procedimento, nr_telefone, ds_telefone_cad, ds_idade, qt_min_espera_tasy, ds_observacao, dt_confirmacao, nr_seq_motivo_transf, cd_motivo_cancelamento, ie_situacao, cd_medico, dt_agenda, cd_estabelecimento, cd_turno, cd_agenda, cd_setor_agenda, nm_cliente, nr_seq_status_pac, cd_medico_agenda, cd_medico_exec, nm_medico_agenda, dt_entrada, nr_seq_oftalmo, dt_inicio_consulta, dt_recebimento_senha) AS select
	a.ds_agenda,
	a.cd_tipo_agenda,
	substr(Obter_Valor_Dominio(34, a.cd_tipo_agenda),1,60) ds_tipo_agenda,
	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento,
	b.nr_sequencia,
	to_char(b.dt_agenda,'hh24:mi') hr_hora,
	b.nr_minuto_duracao,
	b.ie_status_agenda,
	substr(Obter_Valor_Dominio(83, b.ie_status_agenda),1,60) ds_status_agenda,
	substr(Obter_classif_agenda_consulta(b.ie_classif_agenda),1,80) ds_classif_agenda,
	b.cd_pessoa_fisica,
	b.nm_paciente,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	b.nr_atendimento,
	substr(obter_exame_agenda(b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),1,240) ds_procedimento,
	b.nr_telefone,
	substr(obter_fone_pac_agenda(b.cd_pessoa_fisica),1,255) ds_telefone_cad,
	substr(obter_idade(c.dt_nascimento, LOCALTIMESTAMP, 'S'),1,30) ds_idade,
	round((coalesce(y.dt_alta, LOCALTIMESTAMP) - y.dt_entrada) * 1440) qt_min_espera_tasy,
	substr(b.ds_observacao,1,255) ds_observacao,
	b.dt_confirmacao,
	b.nr_seq_motivo_transf,
	b.cd_motivo_cancelamento,
	a.ie_situacao,
	b.cd_medico,
	trunc(b.dt_agenda,'dd') dt_agenda,
	a.cd_estabelecimento,
	b.cd_turno,
	a.cd_agenda,
	a.cd_setor_agenda,
	CASE WHEN b.cd_pessoa_fisica IS NULL THEN b.nm_paciente  ELSE substr(c.nm_pessoa_fisica,1,60) END  nm_cliente,
	b.nr_seq_status_pac,
	a.cd_pessoa_fisica cd_medico_agenda,
	'' cd_medico_exec,
	substr(p.nm_pessoa_fisica,1,60) nm_medico_agenda,
	y.dt_entrada,
   b.nr_seq_oftalmo,
   d.dt_inicio_consulta,
   y.dt_recebimento_senha
FROM agenda_consulta b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
LEFT OUTER JOIN atendimento_paciente y ON (b.nr_atendimento = y.nr_atendimento)
LEFT OUTER JOIN oft_consulta d ON (b.nr_seq_oftalmo = d.nr_sequencia)
, agenda a
LEFT OUTER JOIN pessoa_fisica p ON (a.cd_pessoa_fisica = p.cd_pessoa_fisica)
WHERE a.cd_agenda				= b.cd_agenda and a.cd_tipo_agenda		= 3     
union

select
	a.ds_agenda,
	a.cd_tipo_agenda,
	substr(Obter_Valor_Dominio(34, a.cd_tipo_agenda),1,60) ds_tipo_agenda,
	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento,
	b.nr_sequencia,
	to_char(b.hr_inicio,'hh24:mi') hr_hora,
	b.nr_minuto_duracao,
	b.ie_status_agenda,
	substr(Obter_Valor_Dominio(83, b.ie_status_agenda),1,60) ds_status_agenda,
	substr(obter_desc_classif_agenda_pac(b.nr_seq_classif_agenda),1,80) ds_classif_agenda,
	b.cd_pessoa_fisica,
	b.nm_paciente,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	b.nr_atendimento,
	substr(obter_exame_agenda(b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),1,240) ds_procedimento,
	b.nr_telefone,
	substr(obter_fone_pac_agenda(b.cd_pessoa_fisica),1,255) ds_telefone_cad,
	substr(obter_idade(c.dt_nascimento, LOCALTIMESTAMP, 'S'),1,30) ds_idade,
	round((coalesce(y.dt_alta, LOCALTIMESTAMP) - y.dt_entrada) * 1440) qt_min_espera_tasy,
	substr(b.ds_observacao,1,255) ds_observacao,
	b.dt_confirmacao,
	b.nr_seq_motivo_transf,
	b.cd_motivo_cancelamento,
	a.ie_situacao,
	b.cd_medico,
	b.dt_agenda,
	a.cd_estabelecimento,
	b.cd_turno,
	a.cd_agenda,
	a.cd_setor_agenda,
	CASE WHEN b.cd_pessoa_fisica IS NULL THEN b.nm_paciente  ELSE substr(c.nm_pessoa_fisica,1,60) END  nm_cliente,
	b.nr_seq_status_pac,
	a.cd_pessoa_fisica cd_medico_agenda,
	b.cd_medico_exec,
	obter_nome_pf(a.cd_pessoa_fisica) nm_medico_agenda,
	y.dt_entrada,
   b.nr_seq_oftalmo,
   d.dt_inicio_consulta,
   y.dt_recebimento_senha
FROM agenda a, agenda_paciente b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
LEFT OUTER JOIN atendimento_paciente y ON (b.nr_atendimento = y.nr_atendimento)
LEFT OUTER JOIN oft_consulta d ON (b.nr_seq_oftalmo = d.nr_sequencia)
WHERE a.cd_agenda				= b.cd_agenda and a.cd_tipo_agenda		in (1,2)    
union

select
	a.ds_agenda,
	a.cd_tipo_agenda,
	substr(Obter_Valor_Dominio(34, a.cd_tipo_agenda),1,60) ds_tipo_agenda,
	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento,
	b.nr_sequencia,
	to_char(b.hr_inicio,'hh24:mi') hr_hora,
	b.nr_minuto_duracao,
	b.ie_status_agenda,
	substr(Obter_Valor_Dominio(83, b.ie_status_agenda),1,60) ds_status_agenda,
	substr(obter_desc_classif_agenda_pac(b.nr_seq_classif_agenda),1,80) ds_classif_agenda,
	b.cd_pessoa_fisica,
	b.nm_paciente,
	substr(obter_nome_convenio(b.cd_convenio),1,40) ds_convenio,
	b.nr_atendimento,
	substr(obter_exame_agenda(b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),1,240) ds_procedimento,
	b.nr_telefone,
	substr(obter_fone_pac_agenda(b.cd_pessoa_fisica),1,255) ds_telefone_cad,
	substr(obter_idade(c.dt_nascimento, LOCALTIMESTAMP, 'S'),1,30) ds_idade,
	round((coalesce(y.dt_alta, LOCALTIMESTAMP) - y.dt_entrada) * 1440) qt_min_espera_tasy,
	substr(b.ds_observacao,1,255) ds_observacao,
	b.dt_confirmacao,
	b.nr_seq_motivo_transf,
	b.cd_motivo_cancelamento,
	a.ie_situacao,
	x.cd_profissional cd_medico,
	b.dt_agenda,
	a.cd_estabelecimento,
	b.cd_turno,
	a.cd_agenda,
	a.cd_setor_agenda,
	CASE WHEN b.cd_pessoa_fisica IS NULL THEN b.nm_paciente  ELSE substr(c.nm_pessoa_fisica,1,60) END  nm_cliente,
	b.nr_seq_status_pac,
	a.cd_pessoa_fisica cd_medico_agenda,
	b.cd_medico_exec,
	obter_nome_pf(a.cd_pessoa_fisica) nm_medico_agenda,
	y.dt_entrada,
   b.nr_seq_oftalmo,
   d.dt_inicio_consulta,
   y.dt_recebimento_senha
FROM profissional_agenda x, agenda a, agenda_paciente b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
LEFT OUTER JOIN oft_consulta d ON (b.nr_seq_oftalmo = d.nr_sequencia)
LEFT OUTER JOIN atendimento_paciente y ON (b.nr_atendimento = y.nr_atendimento)
WHERE a.cd_agenda				= b.cd_agenda and x.nr_seq_agenda		= b.nr_sequencia and a.cd_tipo_agenda		in (1,2);

