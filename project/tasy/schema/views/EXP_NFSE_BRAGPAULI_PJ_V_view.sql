-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nfse_bragpauli_pj_v (nr_nota_fiscal, tp_registro, cd_serie_nf, dt_emissao, ie_situacao_nota, vl_total_nota, cd_servico, ie_tipo_toma_prest, ds_local_tomador, nm_tomador, nr_insc_munic_tomador, ds_digito_insc_municipal, cd_cgc_tomador, ds_insc_estad_tomador, nr_insc_estad_tomador, cd_cep_tomador, ds_tipo_logradouro, ds_titulo_logradouro, ds_logradouro_tomador, ds_complemento_tomador, nr_endereco_tomador, ds_bairro_tomador, sg_uf_tomador, ds_municipio_tomador, ds_local_prest_servico, cd_estabelecimento) AS select	nr_sequencia						nr_nota_fiscal,
	'C'							tp_registro, 
	n.cd_serie_nf						cd_serie_nf, 
	n.dt_emissao						dt_emissao, 
	CASE WHEN n.ie_situacao=1 THEN 1  ELSE 2 END 					ie_situacao_nota,	     
	lpad(elimina_caracteres_especiais(n.vl_total_nota),12,0)		vl_total_nota, 
	lpad(elimina_caractere_especial(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), 
	obter_procedimento_nfse(n.nr_sequencia,'O')),'CD')),10,' ') 		cd_servico, 
	2							ie_tipo_toma_prest, 
	CASE WHEN upper(elimina_caracteres_especiais(obter_dados_pf_pj(null, cd_cgc, 'CI')))=(upper(elimina_caracteres_especiais(obter_dados_pf_pj(null,(obter_dados_nota_fiscal(n.nr_sequencia,2)),'CI')))) THEN 'S'  ELSE 'N' END  ds_local_tomador, 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,75) 	nm_tomador, 
	CASE WHEN coalesce(substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,10),'X')='X' THEN 'Isento'  ELSE substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,10) END 	nr_insc_munic_tomador, 
	' '							ds_digito_insc_municipal, 
	n.cd_cgc							cd_cgc_tomador, 
	CASE WHEN coalesce(substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20),'X')='X' THEN 'S'  ELSE 'N' END  ds_insc_estad_tomador, 
	substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20)	nr_insc_estad_tomador, 
	coalesce(to_char(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,15)='N/D' THEN  	to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,15) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CEP'),1,15) END ), 
	to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))) cd_cep_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'LO'),1,5)		ds_tipo_logradouro, 
	lpad(' ',5,' ')						ds_titulo_logradouro, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'R'),1,50)		ds_logradouro_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'CO'),1,40)		ds_complemento_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'NR'),1,10)		nr_endereco_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'B'),1,50)		ds_bairro_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'UF'),1,2)		sg_uf_tomador, 
	substr(obter_dados_pf_pj(NULL,n.cd_cgc,'CI'),1,50)		ds_municipio_tomador, 
	'D'							ds_local_prest_servico, 
	n.cd_estabelecimento					cd_estabelecimento 
FROM	nota_fiscal n, 
	operacao_nota o 
where	n.cd_operacao_nf = o.cd_operacao_nf 
and	o.ie_servico = 'S' 
and	n.cd_cgc is not null 
and	n.cd_pessoa_fisica is null 
and (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S');

