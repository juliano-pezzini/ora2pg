-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW adep_cig_palm_v (ds_material, qt_dispensar, cd_unidade_medida, cd_unid_med_ext, dt_horario, cd_material, nr_seq_lote_fornec, chave, qt_dose, cd_unidade_medida_dose, ie_endovenosa, ie_ordem, cd_um_disp, ie_regra_disp, ie_medic_fracionado, nr_seq_lote, nr_prescricao, nr_seq_procedimento, ie_conferido) AS SELECT	DISTINCT SUBSTR(obter_desc_material(h.cd_material),1,255) ds_material,
		h.qt_dispensar_hor qt_dispensar,
	   	h.cd_unidade_medida_dose cd_unidade_medida,
		SUBSTR(obter_desc_unid_med(h.cd_unidade_medida_dose),1,200) cd_unid_med_ext,
	   	h.dt_horario,
		h.cd_material,
		coalesce((SELECT	MAX(c.nr_seq_lote_fornec)
             FROM	material_atend_paciente c
             WHERE	x.nr_sequencia = c.nr_sequencia_prescricao
             AND	x.nr_prescricao = c.nr_prescricao
             AND	x.cd_material = c.cd_material_prescricao),0) nr_seq_lote_fornec,
		h.nr_sequencia chave,
		h.qt_dose qt_dose,
		h.cd_unidade_medida_dose cd_unidade_medida_dose,
		obter_se_via_endovenosa(x.ie_via_aplicacao) ie_endovenosa,
		2 ie_ordem,
		h.cd_unidade_medida cd_um_disp,
		x.ie_regra_disp ie_regra_disp,
		obter_se_medic_fracionado(h.nr_sequencia) ie_medic_fracionado,
		h.nr_seq_lote,
		a.nr_prescricao,
		y.nr_sequencia nr_seq_procedimento,
		OBTER_SE_ITEM_CONF_PDA(h.nr_sequencia, a.nr_prescricao, y.nr_sequencia, h.dt_horario, coalesce(w.ie_ctrl_glic,'NC')) ie_conferido
FROM	material z,
		proc_interno w,
		prescr_procedimento y,
		prescr_material x,
		prescr_medica a,
		prescr_mat_hor h,
		ap_lote b,
		ap_lote_item d
WHERE 	z.cd_material  	 = x.cd_material
AND		w.nr_sequencia	 = y.nr_seq_proc_interno
AND		y.nr_prescricao	 = x.nr_prescricao
AND		y.nr_sequencia	 = x.nr_sequencia_proc
AND		y.nr_prescricao	 = a.nr_prescricao
AND		x.nr_prescricao	 = a.nr_prescricao
AND		x.nr_prescricao  = h.nr_prescricao
AND		x.nr_sequencia   = h.nr_seq_material
AND		h.nr_seq_lote	 =	b.nr_sequencia
AND		b.nr_sequencia	 =	d.nr_seq_lote
AND		d.nr_seq_mat_hor = 	h.nr_sequencia
AND		coalesce(w.ie_tipo,'O')	<> 'BS'
AND		coalesce(w.ie_ivc,'N') <> 'S'
AND		y.nr_seq_proc_interno IS NOT NULL
AND		y.nr_seq_prot_glic	  IS NOT NULL
AND		y.nr_seq_exame		  IS NULL
AND		y.nr_seq_solic_sangue IS NULL
AND		y.nr_seq_derivado	  IS NULL
AND		y.nr_seq_exame_sangue IS NULL
AND		h.dt_suspensao IS NULL
AND		h.dt_fim_horario IS NULL
AND		coalesce(h.ie_horario_especial,'N') <> 'S'
AND		x.ie_agrupador = 5
AND		z.ie_tipo_material <> 1
AND		coalesce(w.ie_ctrl_glic,'NC') IN ('CCG', 'CIG')

UNION

SELECT	DISTINCT SUBSTR(obter_desc_material(h.cd_material),1,255) ds_material,
	   	CASE WHEN coalesce(h.qt_dispensar_hor,0) =0 THEN 1  ELSE h.qt_dispensar_hor END  qt_dispensar,
	   	h.cd_unidade_medida_dose cd_unidade_medida,
		SUBSTR(obter_desc_unid_med(h.cd_unidade_medida_dose),1,200) cd_unid_med_ext,
	   	h.dt_horario,
		h.cd_material,
		0 nr_seq_lote_fornec,
		h.nr_sequencia chave,
		h.qt_dose qt_dose,
		h.cd_unidade_medida_dose cd_unidade_medida_dose,
		obter_se_via_endovenosa(x.ie_via_aplicacao) ie_endovenosa,
		1 ie_ordem,
		h.cd_unidade_medida cd_um_disp,
		x.ie_regra_disp ie_regra_disp,
		obter_se_medic_fracionado(h.nr_sequencia) ie_medic_fracionado,
		0 nr_seq_lote,
		a.nr_prescricao,
		y.nr_sequencia nr_seq_procedimento,
		OBTER_SE_ITEM_CONF_PDA(h.nr_sequencia, a.nr_prescricao, y.nr_sequencia, h.dt_horario, coalesce(w.ie_ctrl_glic,'NC')) ie_conferido
FROM	material z,
		proc_interno w,
		prescr_procedimento y,
		prescr_material x,
		prescr_medica a,
		prescr_mat_hor h
WHERE	z.cd_material  = x.cd_material
AND		w.nr_sequencia	 = y.nr_seq_proc_interno
AND		y.nr_prescricao	 = x.nr_prescricao
AND		y.nr_sequencia	 = x.nr_sequencia_proc
AND		y.nr_prescricao	 = a.nr_prescricao
AND		x.nr_prescricao	 = a.nr_prescricao
AND		x.nr_prescricao  = h.nr_prescricao
AND 	x.nr_sequencia   = h.nr_seq_material
AND		coalesce(w.ie_tipo,'O') <> 'BS'
AND 	coalesce(w.ie_ivc,'N') <> 'S'
AND		y.nr_seq_proc_interno IS NOT NULL
AND		y.nr_seq_prot_glic IS NOT NULL
AND		y.nr_seq_exame IS NULL
AND		y.nr_seq_solic_sangue IS NULL
AND		y.nr_seq_derivado IS NULL
AND 	y.nr_seq_exame_sangue IS NULL
AND		h.dt_suspensao IS NULL
AND 	h.dt_fim_horario IS NULL
AND 	coalesce(h.ie_horario_especial,'N') <> 'S'
AND 	x.ie_agrupador = 5
AND 	z.ie_tipo_material <> 1
AND		coalesce(w.ie_ctrl_glic,'NC') IN ('CCG', 'CIG')
AND 	h.nr_seq_lote IS NULL;

