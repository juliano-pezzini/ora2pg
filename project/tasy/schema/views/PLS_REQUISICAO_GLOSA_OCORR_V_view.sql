-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_requisicao_glosa_ocorr_v (ie_tipo, nr_sequencia, nr_codigo, ds_descricao_glosa_ocor, ds_grupo, ds_observacao, ds_msg_externa, ds_documentacao, nr_regra_ocor, nr_seq_requisicao, nr_seq_proc, nr_seq_mat, nr_ocorrencia, ie_vinculo, nr_nivel_liberacao, ie_status, nr_seq_motivo_glosa) AS select	'G' ie_tipo,
	a.nr_sequencia,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'C'),1,10) nr_codigo,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'D'),1,255) ds_descricao_glosa_ocor,
	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'DG'),1,255) ds_grupo,
	substr(ds_observacao,1,255) ds_observacao,
	substr(pls_obter_dados_msg_glosa(nr_seq_motivo_glosa,'ME'),1,255) ds_msg_externa,
	'' ds_documentacao,
	0 nr_regra_ocor,
	a.nr_seq_requisicao 	nr_seq_requisicao,
	a.nr_seq_req_proc	nr_seq_proc,
	a.nr_seq_req_mat	nr_seq_mat,
	a.nr_seq_ocorrencia 	nr_ocorrencia,
	CASE WHEN a.nr_seq_ocorrencia IS NULL THEN 'G'  ELSE 'O' END  ie_vinculo,
 	(select b.nr_nivel_liberacao
	FROM	pls_analise_ocor_glosa_aut b
	where 	a.nr_sequencia = b.nr_seq_glosa  LIMIT 1) nr_nivel_liberacao,
  	(select b.ie_status
	from	pls_analise_ocor_glosa_aut b
	where 	a.nr_sequencia = b.nr_seq_glosa  LIMIT 1) ie_status,
	nr_seq_motivo_glosa	
from	pls_requisicao_glosa	a
where	nr_seq_execucao is null

union

select	'O' ie_tipo,
	a.nr_sequencia,	
	substr(pls_obter_dados_ocorrencia(nr_seq_ocorrencia,'C'),1,255) nr_codigo,
	substr(pls_obter_dados_ocorrencia(nr_seq_ocorrencia,'D'),1,255) ds_descricao_glosa_ocor,
	'' ds_grupo,
	coalesce(substr(ds_observacao,1,255),substr(pls_obter_dados_ocorrencia(nr_seq_ocorrencia,'DO'),1,255)) ds_observacao,
	substr(pls_obter_dados_ocorrencia(nr_seq_ocorrencia,'DE'),1,255) ds_msg_externa,
	substr(pls_obter_dados_ocorrencia(nr_seq_ocorrencia,'DO'),1,255) ds_documentacao,
	a.nr_seq_regra nr_regra_ocor,
	a.nr_seq_requisicao nr_seq_requisicao,
	a.nr_seq_proc nr_seq_proc,
	a.nr_seq_mat nr_seq_mat,
	a.nr_seq_ocorrencia nr_ocorrencia,
	CASE WHEN a.nr_seq_glosa_req IS NULL THEN 'O'  ELSE 'G' END  ie_vinculo,
	(select b.nr_nivel_liberacao
	from	pls_analise_ocor_glosa_aut b
	where 	a.nr_sequencia = b.nr_seq_glosa  LIMIT 1) nr_nivel_liberacao,
  	(select b.ie_status
	from	pls_analise_ocor_glosa_aut b
	where 	a.nr_sequencia = b.nr_seq_glosa  LIMIT 1) ie_status,
	null nr_seq_motivo_glosa
from	pls_ocorrencia_benef	a
where	nr_seq_conta is null
and	nr_seq_guia_plano is null
and	nr_seq_execucao is null
and	nr_seq_conta_pos_estab is null;

