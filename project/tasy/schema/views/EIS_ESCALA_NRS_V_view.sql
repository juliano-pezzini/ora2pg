-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_escala_nrs_v (cd_setor_atendimento, ds_estabelecimento, cd_convenio, ds_convenio, ds_setor_atendimento, ie_sexo, ds_sexo, nm_medico, cd_pessoa_fisica, cd_medico_resp, ie_faixa_etaria, ds_unidade, dt_avaliacao, qt_ponto, cd_estabelecimento, ds_ponto, nr_atendimento, cd_paciente, ds_resultado, ds_imc) AS select	distinct
  	CASE WHEN eis_obter_setor_atend_data(a.nr_atendimento, e.dt_avaliacao)=0 THEN a.cd_setor_atendimento  ELSE eis_obter_setor_atend_data(a.nr_atendimento, e.dt_avaliacao) END  cd_setor_atendimento, 
  	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento, 
  	obter_convenio_atendimento(a.nr_atendimento) cd_convenio, 
  	substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,150) ds_convenio, 
  	substr(obter_nome_setor(CASE WHEN eis_obter_setor_atend_data(a.nr_atendimento, e.dt_avaliacao)=0 THEN a.cd_setor_atendimento  ELSE eis_obter_setor_atend_data(a.nr_atendimento, e.dt_avaliacao) END ),1,255)ds_setor_atendimento, 
  	obter_sexo_pf(a.cd_pessoa_fisica,'C') ie_sexo, 
  	obter_sexo_pf(a.cd_pessoa_fisica,'D') ds_sexo, 
  	obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null) nm_medico, 
  	a.cd_pessoa_fisica, 
  	a.cd_medico_resp, 
  	substr(obter_idade(obter_data_nascto_pf(a.cd_pessoa_fisica),LOCALTIMESTAMP,'E'),1,10) ie_faixa_etaria, 
  	substr(obter_unidade_atend_data(a.nr_atendimento, e.dt_avaliacao),1,255) ds_unidade, 
  	e.dt_avaliacao, 
  	e.qt_pontuacao qt_ponto, 
  	a.cd_estabelecimento, 
  	substr(obter_resul_nrs(qt_pontuacao),1,255)|| ' - '||qt_pontuacao||' Pontos' ds_ponto, 
  	a.nr_atendimento, 
  	a.cd_pessoa_fisica cd_paciente, 
  	substr(obter_resul_nrs(qt_pontuacao),1,255) ds_resultado, 
		substr(Obter_Desc_IMC(e.qt_imc,obter_idade_pf(cd_pessoa_fisica,e.dt_avaliacao,'A')),1,90) ds_imc 
FROM  escala_nrs e, 
  	atendimento_paciente_v a 
where	a.nr_atendimento= e.nr_atendimento 
and	e.dt_liberacao is not null 
and		e.ie_situacao = 'A' 
order 	by ds_ponto;

