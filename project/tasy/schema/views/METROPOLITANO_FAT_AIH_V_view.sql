-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW metropolitano_fat_aih_v (tp_registro, nr_seq_laudo, nr_laud_medi, cd_crat_intc, dt_digt, nr_cpf_medi_solc, nr_cpf_medi_resp, cd_tip_catg_pros_autz, nr_catg_pros_autz, cd_tip_catg_pros_supv, nr_catg_pros_supv, dt_emis, cd_unsa_orig, cd_unsa_dsno, cd_tip_proc_solc, cd_tip_orig_solc, cd_proc_solc, cd_tip_proc_autd, cd_tip_orig_autd, cd_proc_autd, cd_cid, dt_intc, cd_clin, nr_enfe, nr_leit, nr_laud_alto_csto, cd_ind_tipo_laud, nr_idnt_usua, nm_idnt_usua, nm_mae_usua, dt_nasc_usua, nr_munc_nasc, cd_sig_uf_nasc, cd_tip_sexo_usua, nr_iden_usua, cd_sig_uf_iden_usua, cd_tip_orga_emsr, dt_emis_iden, cd_tabe_tipo_cert, cd_tip_cert_usua, nm_catr_cert, nr_livr_cert, nr_folh_cert, nr_term_cert, dt_emis_cert, cd_tabe_escd, cd_escd_usua, cd_tabe_cor, cd_cor_usua, qt_ida_aprn_usua, cd_tip_idad_usua, dt_cadt_usua, nr_pips_cdtr, nr_prtu_usua, cd_ser_cart_trab, nr_cart_trab, nr_zona_eltl, nr_seca_eltl, nr_titu_eltl, cd_cpf_usua, cd_naci_usua, dt_entr_usua, nr_crto_sus, nr_munc_crto_sus, dt_ulti_altr, nr_locl_nasc, ds_munc_nao_cada, cd_func_digt, nr_endr, nr_logr, cd_tip_logr, nm_logr, nr_imov_logr, cd_ind_letr_imov, nr_kilm_refe, des_cmpl_endr, nm_refe_locz, nr_bair, nm_bair, cd_cep, cd_munc, cd_sig_uf, nr_pais, vl_cood_x, vl_cood_y, cd_idn_sitc, dt_ulti_mant, nr_locl, nr_sequ_logr, nm_imov_logr_aprx, vl_aprx, cd_prob, nr_lote, nr_ctrl, dt_rems_expo, cd_ind_situ_laud, nm_medi_solc, nr_catg_pros_solc, nr_crto_sus_medi_solc, cd_ind_cpf_cns_supv, cd_ind_cpf_cns_autz, cd_cid_scdr, cd_cid_asso, dt_pros_autz, dt_pros_supv, cd_ind_cpf_cns_solc, nr_tel_usua, cd_idn_cor_usua, nr_cartao_sus, cd_procedimento_solc, cd_procedimento_autd, nm_resp_usua) AS select	1 tp_registro,
	s.nr_seq_interno nr_seq_laudo, 
	lpad(somente_numero(s.nr_protocolo_sisreg),11,'0') nr_laud_medi, 
	a.ie_carater_inter_sus cd_crat_intc, 
	to_char(s.dt_emissao, 'ddmmyyyy') dt_digt, 
	obter_dados_pf(s.cd_medico_requisitante, 'CPF') nr_cpf_medi_solc, 
	obter_dados_pf(sus_obter_dados_param_aih(a.cd_estabelecimento,'DC'), 'CPF') nr_cpf_medi_resp, 
	'0000' cd_tip_catg_pros_autz, 
	'     ' nr_catg_pros_autz, 
	0000 cd_tip_catg_pros_supv, 
	'     ' nr_catg_pros_supv, 
	to_char(s.dt_emissao, 'ddmmyyyy') dt_emis, 
	lpad(p.cd_procedencia_externo,7,'0') cd_unsa_orig, 
	lpad(obter_valor_conv_estab(c.cd_convenio,a.cd_estabelecimento,'CD_REGIONAL'),7,'0') cd_unsa_dsno, 
	2 cd_tip_proc_solc, 
	1 cd_tip_orig_solc, 
	00000000 cd_proc_solc, 
	2 cd_tip_proc_autd, 
	0 cd_tip_orig_autd, 
	00000000 cd_proc_autd, 
	s.cd_cid_principal cd_cid, 
	to_char(a.dt_entrada, 'ddmmyyyy') dt_intc, 
	lpad(Obter_Conversao_Externa(obter_cgc_conv(c.cd_convenio), 'METROPOLITANO','IE_CLINICA',a.ie_clinica),2,'0') cd_clin, 
	lpad(coalesce(u.cd_setor_atendimento,'0'),10,'0') nr_enfe, 
	obter_prim_unid_setor_atend(a.nr_atendimento, 'U') nr_leit, 
	00000000000 nr_laud_alto_csto, 
	'M' cd_ind_tipo_laud, 
	lpad(f.nr_prontuario,11,'0') nr_idnt_usua, 
	--'      ' nr_Idnt_Usua, 
	substr(elimina_caractere_especial(obter_nome_pf(a.cd_pessoa_fisica)),1,70) nm_idnt_usua, 
	substr(elimina_caractere_especial(obter_nome_mae_pf(a.cd_pessoa_fisica)),1,70) nm_mae_usua, 
	to_char(f.dt_nascimento, 'ddmmyyyy') dt_nasc_usua, 
	lpad(obter_municipio_ibge(f.nr_cep_cidade_nasc)||Calcula_Digito('MODULO10',obter_municipio_ibge(f.nr_cep_cidade_nasc)),7,'0') nr_munc_nasc, 
	' ' cd_sig_uf_nasc, 
	f.ie_sexo cd_tip_sexo_usua, 
	somente_numero(f.nr_identidade) nr_iden_usua, 
	substr(CASE WHEN f.nr_identidade='' THEN ' '  ELSE f.sg_emissora_ci END ,1,2) cd_sig_uf_iden_usua, 
	lpad(CASE WHEN f.nr_identidade IS NULL THEN  0  ELSE somente_numero(substr(f.ds_orgao_emissor_ci,1,4)) END ,4,'0') cd_tip_orga_emsr,--este alterar para varhcar na interface 
	CASE WHEN f.nr_identidade='' THEN '00000000'  ELSE CASE WHEN to_char(f.dt_emissao_ci, 'ddmmyyyy')='' THEN '00000000'  ELSE to_char(f.dt_emissao_ci, 'ddmmyyyy') END  END  dt_emis_iden, 
	18 cd_tabe_tipo_cert, 
	lpad(CASE WHEN f.nr_cert_nasc IS NULL THEN  CASE WHEN f.nr_cert_casamento IS NULL THEN  0  ELSE 92 END   ELSE 91 END ,4,'0')cd_tip_cert_usua, --SE A CERTIDÃO ENVIADA FOR A DE NASCIMENTO ENVIAR 91, SE FOR A DE CASAMENTO ENVIAR 92 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'NCN') nm_catr_cert, 
	lpad(coalesce(f.nr_livro_cert_nasc,'0'),8,'0') nr_livr_cert, 
	lpad(coalesce(f.nr_folha_cert_nasc, '0'),4,'0') nr_folh_cert, 
	coalesce(f.nr_termo_cert_nasc, '') nr_term_cert, 
	lpad(coalesce(to_char(f.dt_emissao_cert_nasc, 'ddmmyyyy'),'0'), 8, '0') dt_emis_cert, 
	19 cd_tabe_escd, 
	lpad(obter_conversao_externa(obter_cgc_conv(c.cd_convenio), 'METROPOLITANO_FAT_AIH_V','CD_ESCD_USUA', f.ie_grau_instrucao), 4, '0') cd_escd_usua, 
	21 cd_tabe_cor, 
	lpad(obter_conversao_externa(obter_cgc_conv(c.cd_convenio), 'METROPOLITANO_FAT_AIH_V','CD_COR_USUA', f.nr_seq_cor_pele), 2, '0') cd_cor_usua, 
	substr(obter_idade_pf(f.cd_pessoa_fisica, LOCALTIMESTAMP, 'A'),1,100) qt_ida_aprn_usua, 
	' ' cd_tip_idad_usua, --NÃO EXISTE O CAMPO NO TASY. CLIENTE PEDIU PRA SER CRIADO (IDADE APARENTE DIGITADA MANUALMENTE) 
	'00000000' dt_cadt_usua, 
	coalesce(f.nr_pis_pasep, '00000000') nr_pips_cdtr, 
	lpad(f.nr_prontuario,8,'0') nr_prtu_usua, 
	coalesce(lpad(f.nr_serie_ctps,4,'0'), '0000') cd_ser_cart_trab, 
	coalesce(lpad(f.nr_ctps,4,'0'),'0000') nr_cart_trab, 
	coalesce(f.nr_zona, '000') nr_zona_eltl, 
	coalesce(f.nr_secao, '0000') nr_seca_eltl, 
	coalesce(f.nr_titulo_eleitor, '00000000') nr_titu_eltl, 
	f.nr_cpf cd_cpf_usua, 
	lpad(f.cd_nacionalidade,4,'0') cd_naci_usua, 
	lpad(coalesce(to_char(dt_naturalizacao_pf,'ddmmyyyy'),'0'), 8, '0') dt_entr_usua, 
	f.nr_cartao_nac_sus nr_crto_sus, 
	'0000000' nr_munc_crto_sus, 
	s.dt_emissao dt_ulti_altr, 
	'0000000' nr_locl_nasc, 
	'                       ' ds_munc_nao_cada, 
	' ' cd_func_digt, 
	'00000000000' nr_endr, 
	lpad(Obter_Conversao_Externa(obter_cgc_conv(c.cd_convenio),'METROPOLITANO','LOGRADOURO',obter_compl_pf(f.cd_pessoa_fisica, 1, 'CEP')),6,'0') nr_logr, 
	substr(Obter_Conversao_Externa(obter_cgc_conv(c.cd_convenio),'METROPOLITANO','TIPO_LOG',sus_obter_desc_tipo_logr(obter_compl_pf(f.cd_pessoa_fisica, 1, 'TLS'))),1,3) cd_tip_logr, 
	substr(elimina_caractere_especial(obter_compl_pf(f.cd_pessoa_fisica, 1, 'EN')),1,50) nm_logr, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'NR') nr_imov_logr, 
	' ' cd_ind_letr_imov, 
	'00000' nr_kilm_refe, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'CO') des_cmpl_endr, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'O') nm_refe_locz, 
	'0000' nr_bair, --TAB 2 DA PLANILHA TEM O DE-PARA 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'B') nm_bair, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'CEP') cd_cep, 
	lpad(obter_compl_pf(f.cd_pessoa_fisica,1,'CDM')||Calcula_Digito('MODULO10',obter_compl_pf(f.cd_pessoa_fisica,1,'CDM')),7,'0') cd_munc, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'UF') cd_sig_uf, 
	'0001' nr_pais, --FIXO 
	' ' vl_cood_x, 
	' ' vl_cood_y, 
	'A' cd_idn_sitc, 
	to_char(s.dt_atualizacao,'ddmmyyyy') dt_ulti_mant, 
	'0000000' nr_locl, 
	'00' nr_sequ_logr, 
	' ' nm_imov_logr_aprx, 
	'000' vl_aprx, 
	'0000' cd_prob, 
	lpad(l.nr_sequencia,12,'0') nr_lote, 
	'000000000000000' nr_ctrl, 
	lpad(to_char(l.dt_envio, 'yyyymmdd'), 15, '0') dt_rems_expo, 
	' ' cd_ind_situ_laud, 
	elimina_caractere_especial(obter_nome_medico(s.cd_medico_requisitante,'N')) nm_medi_solc, 
	substr(obter_crm_medico(s.cd_medico_requisitante),1,30) nr_catg_pros_solc, 
	substr(obter_dados_pf(s.cd_medico_requisitante, 'CNS'),1,15) nr_crto_sus_medi_solc, 
	' ' cd_ind_cpf_cns_supv, 
	' ' cd_ind_cpf_cns_autz, 
	s.cd_cid_secundario cd_cid_scdr, 
	s.cd_cid_causa_assoc cd_cid_asso, 
	'00000000' dt_pros_autz, 
	'00000000' dt_pros_supv, 
	CASE WHEN coalesce(obter_dados_pf(s.cd_medico_requisitante, 'CNS'),'X')='X' THEN CASE WHEN coalesce(obter_dados_pf(s.cd_medico_requisitante, 'CPF'),'X')='X' THEN ' '  ELSE '1' END   ELSE '2' END  cd_ind_cpf_cns_solc, 
	obter_compl_pf(f.cd_pessoa_fisica, 1, 'T') nr_tel_usua, 
	obter_conversao_externa(obter_cgc_conv(c.cd_convenio), 'METROPOLITANO_FAT_AIH_V','CD_COR_USUA', f.nr_seq_cor_pele) cd_idn_cor_usua, 
	f.nr_cartao_nac_sus nr_cartao_sus, 
	lpad(s.cd_procedimento_solic,10,'0') cd_procedimento_solc, 
	lpad(s.cd_procedimento_solic,10,'0') cd_procedimento_autd, 
	substr(elimina_caractere_especial(coalesce(obter_nome_pf(a.cd_pessoa_responsavel),obter_compl_pf(f.cd_pessoa_fisica, 3, 'N'))),1,70) nm_resp_usua 
FROM atend_paciente_unidade u, sus_laudo_paciente s, sus_lote_autor l, pessoa_fisica f, atend_categoria_convenio c, atendimento_paciente a
LEFT OUTER JOIN procedencia p ON (a.cd_procedencia = p.cd_procedencia)
WHERE a.nr_atendimento = c.nr_atendimento and obter_atepacu_paciente(a.nr_atendimento,'IA') = u.nr_seq_interno and a.cd_pessoa_fisica = f.cd_pessoa_fisica and s.nr_atendimento = a.nr_atendimento and l.nr_sequencia = s.nr_seq_lote;

