-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ugf_nota_interf_gifdes_sp_v (tp_registro, ds_registro, nr_cad_munic_contrib, cd_cnpj, nr_serie, nr_nf_inicial_talao, nr_nf_final_talao, ds_razao_social, nm_fantasia, nr_inscricao_estadual, nr_reg_junta_comercial, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_estado, cd_cep, cd_ddd, nr_telefone, nr_fax, ds_email, cd_cnpj_grafica, ds_razao_social_grafica, nm_fantasia_grafica, ds_endereco_grafica, nr_endereco_grafica, ds_complemento_grafica, ds_bairro_grafica, cd_cep_grafica, ds_municipio_grafica, sg_uf_grafica, cd_ddd_grafica, nr_telefone_grafica, ie_grafica, ie_grafica_florianopolis, cd_cnpj_grafica_talao, nr_aidf, dt_emissao, nr_nota_fiscal, cmc_tomador, cd_cgc_emitente, cd_atividade_cnae, ie_tipo, vl_contabil, vl_base_calculo, ds_observacao, cd_cfps, cd_situacao_tributaria, vl_aliquota_iss, vl_iss, cd_estabelecimento) AS select	1						tp_registro,
	'H'						ds_registro, 
	0						nr_cad_munic_contrib, 
	' '						cd_cnpj, 
	' '						nr_serie, 
	0 						nr_nf_inicial_talao, 
	0						nr_nf_final_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	to_date(null)					dt_emissao, 
	'000000000000000'				nr_nota_fiscal,	 
	' '						cmc_tomador, 
	' '						cd_cgc_emitente, 
	' '						cd_atividade_cnae, 
	' '						ie_tipo, 
	' '						vl_contabil, 
	' '						vl_base_calculo, 
	' '						ds_observacao, 
	'0'						cd_cfps, 
	' '						cd_situacao_tributaria, 
	' '						vl_aliquota_iss, 
	' '						vl_iss, 
	cd_estabelecimento					cd_estabelecimento 
FROM	estabelecimento 

union
  
select	2						tp_registro, 
	'C'						ds_registro, 
	986283						nr_cad_munic_contrib, 
	a.cd_cgc					cd_cnpj, 
	' '						nr_serie, 
	0 						nr_nf_inicial_talao, 
	0						nr_nf_final_talao, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_razao_social)), 1, 80)	ds_razao_social, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.nm_fantasia)), 1, 50)	nm_fantasia, 
	a.nr_inscricao_estadual				nr_inscricao_estadual, 
	b.nr_reg_junta_comercial			nr_reg_junta_comercial, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_endereco)), 1, 80)	ds_endereco, 
	a.nr_endereco					nr_endereco, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_complemento)), 1, 30)	ds_complemento, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_bairro)), 1, 50)		ds_bairro, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_municipio)), 1, 50)	ds_municipio, 
	a.sg_estado					sg_estado, 
	a.cd_cep					cd_cep, 
	a.nr_ddd_telefone				cd_ddd, 
	a.nr_telefone					nr_telefone, 
	a.nr_fax					nr_fax, 
	a.ds_email					ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	to_date(null)					dt_emissao, 
	'000000000000000'				nr_nota_fiscal, 
	' '						cmc_tomador, 
	' '						cd_cgc_emitente, 
	' '						cd_atividade_cnae, 
	' '						ie_tipo, 
	' '						vl_contabil, 
	' '						vl_base_calculo, 
	' '						ds_observacao, 
	'0'						cd_cfps, 
	' '						cd_situacao_tributaria, 
	' '						vl_aliquota_iss, 
	' '						vl_iss, 
	b.cd_estabelecimento 
from	pessoa_juridica a, 
	estabelecimento b 
where	a.cd_cgc		= b.cd_cgc 

union
 
select	3						tp_registro,	 
	'P'						ds_registro, 
	0						nr_cad_munic_contrib, 
	' '						cd_cnpj, 
	' '						nr_serie, 
	0 						nr_nf_inicial_talao, 
	0						nr_nf_final_talao, 
	''						ds_razao_social, 
	''						nm_fantasia, 
	a.nr_inscricao_estadual				nr_inscricao_estadual, 
	b.nr_reg_junta_comercial			nr_reg_junta_comercial, 
	''						ds_endereco, 
	''						nr_endereco, 
	''						ds_complemento, 
	''						ds_bairro, 
	''						ds_municipio, 
	''						sg_estado, 
	''						cd_cep, 
	''						cd_ddd, 
	''						nr_telefone, 
	a.nr_fax					nr_fax, 
	a.ds_email					ds_email, 
	a.cd_cgc					cd_cnpj_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_razao_social)), 1, 80) ds_razao_social_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.nm_fantasia)), 1, 50) nm_fantasia_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_endereco)), 1, 80) ds_endereco_grafica, 
	a.nr_endereco					nr_endereco_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_complemento)), 1, 30) ds_complemento_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_bairro)), 1, 50)	ds_bairro_grafica, 
	a.cd_cep					cd_cep_grafica, 
	substr(tiss_eliminar_caractere(elimina_acentuacao(a.ds_municipio)), 1, 50) ds_municipio_grafica, 
	a.sg_estado					sg_uf_grafica, 
	a.nr_ddd_telefone				cd_ddd_grafica, 
	a.nr_telefone					nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	to_date(null)					dt_emissao, 
	'000000000000000'				Nr_nota_fiscal, 
	CASE WHEN obter_dados_pf_pj(NULL,a.cd_cgc,'CDM')='420540' THEN obter_dados_pf_pj(NULL,a.cd_cgc,'IM')  ELSE '0000000' END  cmc_tomador, 
	' '						cd_cgc_emitente, 
	' '						cd_atividade_cnae, 
	' '						ie_tipo, 
	' '						vl_contabil, 
	' '						vl_base_calculo, 
	' '						ds_observacao, 
	'0'						cd_cfps, 
	' '						cd_situacao_tributaria, 
	' '						vl_aliquota_iss, 
	' '						vl_iss, 
	cd_estabelecimento 
from	pessoa_juridica a, 
	estabelecimento b 
where	a.cd_cgc		= b.cd_cgc 

union
 
select	4						tp_registro,     
	'T'						ds_registro, 
	986283						nr_cad_munic_contrib, 
							e.cd_cgc, 
	obter_dados_nota_fiscal_aidf(n.nr_sequencia,'S') nr_serie, 
	(coalesce(obter_dados_nota_fiscal_aidf(n.nr_sequencia,'NI'),'0'))::numeric  nr_nf_inicial_talao, 
	(coalesce(obter_dados_nota_fiscal_aidf(n.nr_sequencia,'NF'),'0'))::numeric  nr_nf_final_talao,	 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	obter_dados_nota_fiscal_aidf(n.nr_sequencia,'C') cd_cnpj_grafica_talao, 
	substr(obter_dados_nota_fiscal_aidf(n.nr_sequencia,'N'),1,40)	nr_aidf, 
	to_date(null)					dt_emissao, 
	'000000000000000'				nr_nota_fiscal, 
	' '						cmc_tomador, 
	' '						cd_cgc_emitente, 
	' '						cd_atividade_cnae, 
	' '						ie_tipo, 
	' '						vl_contabil, 
	' '						vl_base_calculo, 
	' '						ds_observacao, 
	'0'						cd_cfps, 
	' '						cd_situacao_tributaria, 
	' '						vl_aliquota_iss, 
	' '						vl_iss, 
	e.cd_estabelecimento 
from	estabelecimento e, 
	nota_fiscal n	 
where 	n.cd_estabelecimento = e.cd_estabelecimento	 
and	substr(obter_nr_aidf_nota_fiscal(n.nr_sequencia),1,40) is not null 

union
 
select	5						tp_registro, 
	'E'						ds_registro, 
	986283						nr_cad_munic_contrib,	 
	substr(n.cd_cgc_emitente,1,14)			cd_cnpj, 
	obter_dados_nota_fiscal_aidf(n.nr_sequencia,'S') nr_serie, 
	(coalesce(obter_dados_nota_fiscal_aidf(n.nr_sequencia,'NI'),'0'))::numeric  nr_nf_inicial_talao, 
	0						nr_nf_final_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	n.dt_emissao					dt_emissao, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	CASE WHEN obter_dados_pf_pj(NULL,n.cd_cgc,'CDM')='420540' THEN obter_dados_pf_pj(NULL,n.cd_cgc,'IM')  ELSE '0000000' END  cmc_tomador, 
	n.cd_cgc					cd_cgc_emitente, 
	obter_dados_cnae(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CNAE'),'ID')		cd_atividade_cnae, --verificar pois esta fixo 
	CASE WHEN n.ie_situacao=1 THEN 'E' WHEN n.ie_situacao=9 THEN 'C' END 		ie_tipo, 
	elimina_caracteres_especiais(LPAD(campo_mascara(n.vl_mercadoria,2),18,0))	vl_contabil, 
	elimina_caracteres_especiais(LPAD(campo_mascara(Obter_Valor_Tributo_Nota(n.nr_sequencia,'B'),2),18,0))	vl_base_calculo, 
	substr(n.ds_observacao,1,50)		ds_observacao, 
	obter_dados_pf_pj_estab(n.cd_estabelecimento, null, n.cd_cgc_emitente, 'ATIV') cd_cfps, 
	-- to_number(substr(obter_descricao_padrao('CLASSIF_FISCAL_PREST_SERV','CD_CLASSIFICACAO',n.NR_SEQ_CLASSIF_FISCAL),1,100)) cd_cfps, 
	to_char((select	max(substr(obter_descricao_padrao('SITUACAO_TRIB_PREST_SERV','CD_SITUACAO',c.NR_SEQ_SIT_TRIB),1,2)) 
	from	nota_fiscal_item y, 
		nota_fiscal_item_trib c 
	where	c.nr_sequencia= n.nr_sequencia 
	and	n.nr_sequencia= y.nr_sequencia 
	and	y.nr_item_nf 	= c.nr_item_nf 
	and	y.nr_item_nf 	= (select min(z.nr_item_nf) from nota_fiscal_item z where z.nr_sequencia = n.nr_sequencia) 
	and	c.cd_tributo in (select x.cd_tributo from tributo x where x.ie_tipo_tributo = 'ISS'))) cd_situacao_tributaria, 
	elimina_caracteres_especiais(LPAD(campo_mascara((Obter_Valor_tipo_Tributo_nota(n.nr_sequencia, 'X', 'ISS')),2),18,0)) vl_aliquota_iss, 
	elimina_caracteres_especiais(LPAD(campo_mascara((Obter_Valor_tipo_Tributo_nota(n.nr_sequencia, 'V', 'ISS')),2),18,0)) vl_iss, 
	n.cd_estabelecimento 
from	nota_fiscal n 
where (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S') 
and	n.cd_cgc is not null 

union
 
select	6						tp_registro, 
	'F'						ds_registro, 
	986283						nr_cad_munic_contrib, 
	substr(n.cd_cgc_emitente,1,14)			cd_cnpj, 
	obter_dados_nota_fiscal_aidf(n.nr_sequencia,'S') nr_serie, 
	(coalesce(obter_dados_nota_fiscal_aidf(n.nr_sequencia,'NI'),'0'))::numeric  nr_nf_inicial_talao, 
	0						nr_nf_final_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	n.dt_emissao					dt_emissao, 
	n.nr_nota_fiscal				nr_nota_fiscal, 
	' '						cmc_tomador, 
	' '						cd_cgc_emitente, 
	obter_dados_cnae(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CNAE'),'ID')					cd_atividade_cnae, -- ta fixo, verificar 
	CASE WHEN n.ie_situacao=1 THEN 'E' WHEN n.ie_situacao=9 THEN 'C' END 		ie_tipo, 
	elimina_caracteres_especiais(LPAD(campo_mascara(n.vl_mercadoria,2),18,0))	vl_contabil, 
	elimina_caracteres_especiais(LPAD(campo_mascara(Obter_Valor_Tributo_Nota(n.nr_sequencia,'B'),2),18,0))	vl_base_calculo, 
	substr(n.ds_observacao,1,50)		ds_observacao, 
	obter_dados_pf_pj_estab(n.cd_estabelecimento, null, n.cd_cgc_emitente, 'ATIV') cd_cfps, 
	-- to_number(substr(obter_descricao_padrao('CLASSIF_FISCAL_PREST_SERV','CD_CLASSIFICACAO',n.NR_SEQ_CLASSIF_FISCAL),1,100)) cd_cfps, 
	to_char((select	max(substr(obter_descricao_padrao('SITUACAO_TRIB_PREST_SERV','CD_SITUACAO',c.NR_SEQ_SIT_TRIB),1,2)) 
	from	nota_fiscal_item y, 
		nota_fiscal_item_trib c 
	where	c.nr_sequencia= n.nr_sequencia 
	and	n.nr_sequencia= y.nr_sequencia 
	and	y.nr_item_nf 	= c.nr_item_nf 
	and	y.nr_item_nf 	= (select min(z.nr_item_nf) from nota_fiscal_item z where z.nr_sequencia = n.nr_sequencia) 
	and	c.cd_tributo in (select x.cd_tributo from tributo x where x.ie_tipo_tributo = 'ISS'))) cd_situacao_tributaria, 
	elimina_caracteres_especiais(LPAD(campo_mascara((Obter_Valor_tipo_Tributo_nota(n.nr_sequencia, 'X', 'ISS')),2),18,0)) vl_aliquota_iss, 
	elimina_caracteres_especiais(LPAD(campo_mascara((Obter_Valor_tipo_Tributo_nota(n.nr_sequencia, 'V', 'ISS')),2),18,0)) vl_iss, 
	n.cd_estabelecimento 
from	nota_fiscal n 
where (substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) = 'S') 
and	n.cd_pessoa_fisica is not null 

union
 
select	99						tp_registro, 
	'L'						ds_registro, 
	0						nr_cad_munic_contrib, 
	' '						cd_cnpj, 
	' '						nr_serie, 
	0 						nr_nf_inicial_talao,	 
	0						nr_nf_final_talao, 
	' '						ds_razao_social, 
	' '						nm_fantasia, 
	' '						nr_inscricao_estadual, 
	' '						nr_reg_junta_comercial, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_bairro, 
	' '						ds_municipio, 
	' '						sg_estado, 
	' '						cd_cep, 
	' '						cd_ddd, 
	' '						nr_telefone, 
	' '						nr_fax, 
	' '						ds_email, 
	' '						cd_cnpj_grafica, 
	' '						ds_razao_social_grafica, 
	' '						nm_fantasia_grafica, 
	' '						ds_endereco_grafica, 
	' '						nr_endereco_grafica, 
	' '						ds_complemento_grafica, 
	' '						ds_bairro_grafica, 
	' '						cd_cep_grafica, 
	' '						ds_municipio_grafica, 
	' '						sg_uf_grafica, 
	' '						cd_ddd_grafica, 
	' '						nr_telefone_grafica, 
	0						ie_grafica, 
	0						ie_grafica_florianopolis, 
	' '						cd_cnpj_grafica_talao, 
	' '						nr_aidf, 
	to_date(null)					dt_emissao, 
	'000000000000000'				nr_nota_fiscal, 
	' '						cmc_tomador, 
	' '						cd_cgc_emitente, 
	' '						cd_atividade_cnae, 
	' '						ie_tipo, 
	' '						vl_contabil, 
	' '						vl_base_calculo, 
	' '						ds_observacao, 
	'0'						cd_cfps, 
	' '						cd_situacao_tributaria, 
	' '						vl_aliquota_iss, 
	' '						vl_iss, 
	cd_estabelecimento				cd_estabelecimento 
from	estabelecimento;

