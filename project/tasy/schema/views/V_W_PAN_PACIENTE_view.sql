-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW v_w_pan_paciente (nr_atendimento, cd_pessoa_paciente, cd_unidade_basica, cd_unidade_compl, cd_perfil, ds_cor_risco, cd_medico, nm_medico, ie_vip, ds_vip, ie_alergia, ie_sexo, nr_seq_interno, cd_exp_alergia, nr_seq_texto_alergia, ie_classif_paciente, cd_exp_sexo, ds_sexo, ie_concluido, ds_classif_paciente, ds_classif_risco, ie_exibe_classif, cd_exp_acao_alergia, ds_alergias, nr_seq_texto_acao_alergia, cd_depart_atend, dt_nascimento, ds_idade, dt_atualizacao, ie_pendencia_adep, nr_encounter_status, nr_seq_texto_nasc, nm_paciente, ds_cor_regra_leito, icon_legend, icon_ambig_legend, ie_ambiguous_name, ds_risco_queda, ie_risco_queda, nr_encounter_status_panorama, ds_nome_rn, ds_idade_rn, ie_sexo_rn, ds_departament, ds_short_departament, cd_departament, nr_case, ie_uso_case, dt_entrada, cd_setor_atendimento, ds_mascara, classif_esp_paciente, ds_motivo_isolamento, ie_planejado, cd_classif_setor, ie_paciente_jejum, ds_paciente_jejum, ie_exame_nao_checado, dt_obito, patient_age, id_validacao_duplicidade_w) AS select x.NR_ATENDIMENTO,x.CD_PESSOA_PACIENTE,x.CD_UNIDADE_BASICA,x.CD_UNIDADE_COMPL,x.CD_PERFIL,x.DS_COR_RISCO,x.CD_MEDICO,x.NM_MEDICO,x.IE_VIP,x.DS_VIP,x.IE_ALERGIA,x.IE_SEXO,x.NR_SEQ_INTERNO,x.CD_EXP_ALERGIA,x.NR_SEQ_TEXTO_ALERGIA,x.IE_CLASSIF_PACIENTE,x.CD_EXP_SEXO,x.DS_SEXO,x.IE_CONCLUIDO,x.DS_CLASSIF_PACIENTE,x.DS_CLASSIF_RISCO,x.IE_EXIBE_CLASSIF,x.CD_EXP_ACAO_ALERGIA,x.DS_ALERGIAS,x.NR_SEQ_TEXTO_ACAO_ALERGIA,x.CD_DEPART_ATEND,x.DT_NASCIMENTO,x.DS_IDADE,x.DT_ATUALIZACAO,x.IE_PENDENCIA_ADEP,x.NR_ENCOUNTER_STATUS,x.NR_SEQ_TEXTO_NASC,x.NM_PACIENTE,x.DS_COR_REGRA_LEITO,x.ICON_LEGEND,x.ICON_AMBIG_LEGEND,x.IE_AMBIGUOUS_NAME,x.DS_RISCO_QUEDA,x.IE_RISCO_QUEDA,x.NR_ENCOUNTER_STATUS_PANORAMA,x.DS_NOME_RN,x.DS_IDADE_RN,x.IE_SEXO_RN,x.DS_DEPARTAMENT,x.DS_SHORT_DEPARTAMENT,x.CD_DEPARTAMENT,x.NR_CASE,x.IE_USO_CASE,x.DT_ENTRADA,x.CD_SETOR_ATENDIMENTO,x.DS_MASCARA,x.CLASSIF_ESP_PACIENTE,x.DS_MOTIVO_ISOLAMENTO,x.IE_PLANEJADO,x.CD_CLASSIF_SETOR,x.IE_PACIENTE_JEJUM,x.DS_PACIENTE_JEJUM,x.IE_EXAME_NAO_CHECADO,x.DT_OBITO,x.PATIENT_AGE,x.ID_VALIDACAO_DUPLICIDADE_W FROM (
	select	a.nr_atendimento,
		a.cd_pessoa_paciente,
		a.cd_unidade_basica,
		a.cd_unidade_compl,
		a.cd_perfil,
		a.ds_cor_risco,
		a.cd_medico,
		a.nm_medico,
		a.ie_vip,
		a.ds_vip,
		a.ie_alergia,
		a.ie_sexo,
		a.nr_seq_interno,
		a.cd_exp_alergia,
		a.nr_seq_texto_alergia,
		a.ie_classif_paciente,
		a.cd_exp_sexo,
		a.ds_sexo,
		a.ie_concluido,
		a.ds_classif_paciente,
		a.ds_classif_risco,
		a.ie_exibe_classif,
		a.cd_exp_acao_alergia,
		a.ds_alergias,
		a.nr_seq_texto_acao_alergia,
		a.cd_depart_atend,
		a.dt_nascimento,
		a.ds_idade,
		a.dt_atualizacao,
		a.ie_pendencia_adep,
		a.nr_encounter_status,
		a.nr_seq_texto_nasc,
		coalesce(obter_nome_paciente_panorama(cd_pessoa_paciente, somente_numero(wheb_usuario_pck.get_cd_perfil), a.nm_paciente), a.nm_paciente) nm_paciente,
		obter_cor_leito_mapa(2462, '3', a.nr_atendimento, 'S') ds_cor_regra_leito,
		obter_desc_expressao(283172) icon_legend,
		obter_desc_expressao(1044211) icon_ambig_legend,
		obter_paciente_mesmo_nome(a.cd_pessoa_paciente) ie_ambiguous_name,
		Obter_desc_escala_queda(a.cd_setor_atendimento, a.nr_atendimento, 'D') ds_risco_queda,
		Obter_desc_escala_queda(a.cd_setor_atendimento, a.nr_atendimento, 'R') ie_risco_queda,
		CASE WHEN obter_status_alta_panora(a.nr_atendimento, 						somente_numero(wheb_usuario_pck.get_cd_perfil))=0 THEN 						substr(nr_encounter_Status, 0, 10)  ELSE obter_status_alta_panora(a.nr_atendimento,									somente_numero(wheb_usuario_pck.get_cd_perfil)) END  nr_encounter_status_panorama,
		(	select	substr(nm_pessoa_fisica, 1, 60)
			from	table( search_names_dev(null,a.cd_pessoa_fisica_rn, null, null, null, null)) ) ds_nome_rn,
		CASE WHEN obter_idade(a.dt_nascimento_rn, LOCALTIMESTAMP, 'AM')='N/A' THEN 			obter_idade(a.dt_nascimento_rn, LOCALTIMESTAMP, 'S')  ELSE obter_idade(a.dt_nascimento_rn, LOCALTIMESTAMP, 'AM') END  ds_idade_rn,
		obter_sexo_pf(a.cd_pessoa_fisica_rn, 'D') ie_sexo_rn,
		a.ds_departament,
		a.ds_short_departament,
		a.cd_departament,
		a.nr_case,
		obter_uso_case(wheb_usuario_pck.get_nm_usuario) ie_uso_case,
		a.dt_entrada,
		a.cd_setor_atendimento,
		'date(shortDate)' ds_mascara,
		a.ds_classif_esp_paciente classif_esp_paciente,
		(	select max(x.ds_info_adic)
			from w_pan_info_adicional x
			where x.ie_concluido = 'S'
				and x.ie_campo_panorama = 39
				and x.nr_seq_interno = a.nr_seq_interno
			) ds_motivo_isolamento,
		obter_se_case_atend_planejado(a.nr_atendimento) ie_planejado,
		obter_classif_setor_atend(a.nr_atendimento) cd_classif_setor,
		cpoe_obter_se_jejum(a.nr_atendimento, cd_pessoa_paciente) ie_paciente_jejum,
		cpoe_obter_tipo_jejum(a.nr_atendimento, cd_pessoa_paciente) ds_paciente_jejum,
		cpoe_obter_exame_nao_checado(a.nr_atendimento, cd_pessoa_paciente) ie_exame_nao_checado,
		a.dt_obito,
		obter_idade(a.dt_nascimento, LOCALTIMESTAMP, 'A') patient_age,
		row_number() over (partition by a.nr_seq_interno, a.nr_atendimento, a.cd_pessoa_paciente order by a.dt_atualizacao desc) id_validacao_duplicidade_w
	from w_pan_paciente a
	where a.ie_concluido = 'S') x
where x.id_validacao_duplicidade_w = 1;

