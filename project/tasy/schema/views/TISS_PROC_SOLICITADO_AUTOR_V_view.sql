-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_proc_solicitado_autor_v (ds_versao, ie_origem, cd_procedimento, ds_procedimento, qt_solicitada, qt_autorizada, nr_sequencia_autor, cd_edicao_amb, cd_procedimento_convenio, cd_edicao_relat, nr_atendimento, ie_origem_proced, cd_procedimento_tuss, nr_seq_proc_autor) AS select	'2.01.01' ds_versao,
	'AC' ie_origem,
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'C'),a.CD_PROCEDIMENTO),10,'0') cd_procedimento,
	substr(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'D'),TISS_ELIMINAR_CARACTERE(CASE WHEN a.cd_procedimento_convenio IS NULL THEN  obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)  ELSE Obter_Proced_Conversao_Conv(d.cd_convenio, a.cd_procedimento, a.ie_origem_proced, 'D') END )), 1, 60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	d.nr_sequencia nr_sequencia_autor,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, d.cd_convenio, b.cd_categoria, d.dt_autorizacao,'X', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, c.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_amb,	
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'C'),coalesce(CASE WHEN a.CD_PROCEDIMENTO_CONVENIO='0' THEN  null  ELSE a.CD_PROCEDIMENTO_CONVENIO END , a.CD_PROCEDIMENTO)),10,'0') CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, d.cd_convenio, b.cd_categoria, d.dt_autorizacao,'R', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, c.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_relat,
	c.nr_atendimento,
	a.ie_origem_proced,
	a.cd_procedimento_tuss,
	a.nr_sequencia nr_seq_proc_autor
FROM	procedimento h,
	atend_categoria_convenio b,
	atendimento_paciente c,
	procedimento_autorizado a,
	autorizacao_convenio d
where	d.nr_atendimento				= c.nr_atendimento
and	c.nr_atendimento				= b.nr_atendimento
and	a.nr_sequencia_autor				= d.nr_sequencia
and	obter_atecaco_atendimento(b.nr_atendimento) 	= b.nr_seq_interno
and	a.cd_procedimento				= h.cd_procedimento
and	a.ie_origem_proced				= h.ie_origem_proced
and	d.nr_seq_gestao  is null

union all

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	lpad(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'C'),a.CD_PROCEDIMENTO),10,'0') cd_procedimento,
	substr(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'D'),TISS_ELIMINAR_CARACTERE(CASE WHEN a.cd_procedimento_convenio IS NULL THEN  obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)  ELSE Obter_Proced_Conversao_Conv(d.cd_convenio, a.cd_procedimento, a.ie_origem_proced, 'D') END )), 1, 60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	d.nr_sequencia nr_sequencia_autor,
	substr(tiss_obter_tabela(null, e.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_agenda,'X', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced,null, null, c.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_amb,
	lpad(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'C'),coalesce(CASE WHEN a.CD_PROCEDIMENTO_CONVENIO='0' THEN null  ELSE a.CD_PROCEDIMENTO_CONVENIO END , a.CD_PROCEDIMENTO)),10,'0') CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_tabela(null, e.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_agenda,'R', h.ie_classificacao, a.cd_procedimento, a.ie_origem_proced,null, null, c.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_relat,
	(null)::numeric  nr_atendimento,
	a.ie_origem_proced,
	a.cd_procedimento_tuss,
	a.nr_sequencia nr_seq_proc_autor
from	procedimento h,
	agenda e,
	agenda_paciente c,
	procedimento_autorizado a,
	autorizacao_convenio d
where	d.nr_seq_agenda		= c.nr_sequencia
and	d.nr_sequencia		= a.nr_sequencia_autor
and	a.cd_procedimento	= h.cd_procedimento
and	a.ie_origem_proced	= h.ie_origem_proced
and	c.nr_atendimento is null
and	c.cd_agenda		= e.cd_agenda
and	d.nr_seq_gestao  is null

union all

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	lpad(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento, c.cd_convenio, a.nr_sequencia, 'C'),a.CD_PROCEDIMENTO),10,'0') cd_procedimento,
	substr(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento, c.cd_convenio, a.nr_sequencia, 'D'),TISS_ELIMINAR_CARACTERE(CASE WHEN a.cd_procedimento_convenio IS NULL THEN  obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)  ELSE Obter_Proced_Conversao_Conv(d.cd_convenio, a.cd_procedimento, a.ie_origem_proced, 'D') END )), 1, 60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	d.nr_sequencia nr_sequencia_autor,
	substr(tiss_obter_tabela(null, e.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_agenda,'X', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_amb,
	lpad(coalesce(tiss_obter_proc_tuss_autor(e.cd_estabelecimento, c.cd_convenio, a.nr_sequencia, 'C'),coalesce(CASE WHEN a.CD_PROCEDIMENTO_CONVENIO='0' THEN null  ELSE a.CD_PROCEDIMENTO_CONVENIO END , a.CD_PROCEDIMENTO)),10,'0') CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_tabela(null, e.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_agenda,'R', h.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_relat,
	(null)::numeric  nr_atendimento,
	a.ie_origem_proced,
	a.cd_procedimento_tuss,
	a.nr_sequencia nr_seq_proc_autor
from	procedimento h,
	agenda e,
	agenda_consulta c,
	procedimento_autorizado a,
	autorizacao_convenio d
where	d.nr_seq_agenda_consulta = c.nr_sequencia
and	d.nr_sequencia		= a.nr_sequencia_autor
and	a.cd_procedimento	= h.cd_procedimento
and	a.ie_origem_proced	= h.ie_origem_proced
and	c.cd_agenda		= e.cd_agenda
and	d.nr_seq_gestao  is null

union all

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'C'),a.CD_PROCEDIMENTO),10,'0') cd_procedimento,
	substr(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'D'),TISS_ELIMINAR_CARACTERE(CASE WHEN a.cd_procedimento_convenio IS NULL THEN  obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)  ELSE Obter_Proced_Conversao_Conv(d.cd_convenio, a.cd_procedimento, a.ie_origem_proced, 'D') END )), 1, 60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	d.nr_sequencia nr_sequencia_autor,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_solicitacao,'X', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_amb,
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,c.cd_convenio,a.nr_sequencia,'C'),coalesce(CASE WHEN a.CD_PROCEDIMENTO_CONVENIO='0' THEN null  ELSE a.CD_PROCEDIMENTO_CONVENIO END , a.CD_PROCEDIMENTO)),10,'0') CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, c.cd_convenio, c.cd_categoria, c.dt_solicitacao,'R', h.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_relat,
	(null)::numeric  nr_atendimento,
	a.ie_origem_proced,
	a.cd_procedimento_tuss,
	a.nr_sequencia nr_seq_proc_autor
from	procedimento h,
	gestao_vaga c,
	procedimento_autorizado a,
	autorizacao_convenio d
where	d.nr_seq_gestao 	= c.nr_sequencia
and	d.nr_sequencia		= a.nr_sequencia_autor
and	a.cd_procedimento	= h.cd_procedimento
and	a.ie_origem_proced	= h.ie_origem_proced

union all

select	'2.01.01' ds_versao,
	'AC' ie_origem,
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'C'),a.CD_PROCEDIMENTO),10,'0') cd_procedimento,
	substr(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'D'),TISS_ELIMINAR_CARACTERE(CASE WHEN a.cd_procedimento_convenio IS NULL THEN  obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)  ELSE Obter_Proced_Conversao_Conv(d.cd_convenio, a.cd_procedimento, a.ie_origem_proced, 'D') END )), 1, 60) ds_procedimento,
	a.qt_solicitada,
	a.qt_autorizada,
	d.nr_sequencia nr_sequencia_autor,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, d.cd_convenio, c.cd_categoria, d.dt_autorizacao,'X', h.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_amb,
	lpad(coalesce(tiss_obter_proc_tuss_autor(c.cd_estabelecimento,d.cd_convenio,a.nr_sequencia,'C'),coalesce(CASE WHEN a.CD_PROCEDIMENTO_CONVENIO='0' THEN null  ELSE a.CD_PROCEDIMENTO_CONVENIO END , a.CD_PROCEDIMENTO)),10,'0') CD_PROCEDIMENTO_CONVENIO,
	substr(tiss_obter_tabela(null, c.cd_estabelecimento, d.cd_convenio, c.cd_categoria, d.dt_autorizacao,'R', h.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, d.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20) cd_edicao_relat,
	(null)::numeric  nr_atendimento,
	a.ie_origem_proced,
	a.cd_procedimento_tuss,
	a.nr_sequencia nr_seq_proc_autor
from	procedimento h,
	autorizacao_convenio_tiss c,
	procedimento_autorizado a,
	autorizacao_convenio d
where	d.nr_sequencia 		= c.nr_sequencia_autor
and	d.nr_sequencia		= a.nr_sequencia_autor
and	a.cd_procedimento		= h.cd_procedimento
and	a.ie_origem_proced	= h.ie_origem_proced
and	d.nr_atendimento		is null
and	d.nr_seq_agenda			is null
and	d.nr_seq_agenda_consulta	is null
and	d.nr_seq_gestao			is null
and	d.cd_pessoa_fisica 		is not null;

