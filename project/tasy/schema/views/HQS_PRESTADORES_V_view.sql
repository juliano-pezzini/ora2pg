-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hqs_prestadores_v (nr_seq_prestador, ie_situacao, ie_tipo_pessoa, cd_prestador, nm_fantasia, cd_pf_pj, ds_razao_social, ds_especialidade, ds_tipo_prestador, ds_endereco, nr_endereco, ds_bairro, ds_cidade, ds_estado, nr_telefone, ds_complemento, ds_cep, ds_logradouro, cd_especialidade, cd_crm, nr_seq_tipo_prestador) AS select	a.nr_sequencia nr_seq_prestador,
	a.ie_situacao, 
	0 ie_tipo_pessoa, 
	substr(pls_obter_cod_prestador(a.nr_sequencia,null),1,255) cd_prestador, 
	' ' nm_fantasia, 
	a.cd_pessoa_fisica cd_pf_pj, 
	initcap(substr(obter_nome_pf(a.cd_pessoa_fisica),1,255)) ds_razao_social, 
	pls_obter_espec_prestador(a.nr_sequencia) ds_especialidade, 
	(select	max(x.ds_tipo_prestador) 
	FROM	pls_tipo_prestador x 
	where	x.nr_sequencia = a.nr_seq_tipo_prestador)	ds_tipo_prestador, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'E'),1,255) ds_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'NE'),1,255) nr_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'B'),1,255) ds_bairro, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'C'),1,255) ds_cidade, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'ES'),1,255) ds_estado, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'T'),1,255) nr_telefone, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'COMP'),1,255) ds_complemento, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'CEP'),1,255) ds_cep, 
	substr(Sus_Obter_Desc_TipoLog(b.cd_tipo_logradouro),1,40) ds_logradouro, 
	d.cd_especialidade, 
	obter_crm_medico(a.cd_pessoa_fisica) cd_crm, 
	a.nr_seq_tipo_prestador nr_seq_tipo_prestador 
FROM pessoa_fisica c
LEFT OUTER JOIN compl_pessoa_fisica b ON (c.cd_pessoa_fisica = b.cd_pessoa_fisica)
, pls_prestador a
LEFT OUTER JOIN pls_prestador_med_espec d ON (a.nr_sequencia = d.nr_seq_prestador)
WHERE c.cd_pessoa_fisica	= a.cd_pessoa_fisica  and LOCALTIMESTAMP between coalesce(dt_inicio_vigencia, LOCALTIMESTAMP) and coalesce(dt_fim_vigencia, LOCALTIMESTAMP) and a.cd_pessoa_fisica is not null 
 
union
 
select	a.nr_sequencia nr_seq_prestador, 
	a.ie_situacao, 
	1 ie_tipo_pessoa, 
	substr(pls_obter_cod_prestador(a.nr_sequencia,null),1,255) cd_prestador, 
	initcap(substr(obter_dados_pf_pj(null,a.cd_cgc,'F'),1,255)) nm_fantasia, 
	a.cd_cgc cd_pf_pj, 
	initcap(substr(obter_dados_pf_pj(null,a.cd_cgc,'N'),1,255)) ds_razao_social, 
	pls_obter_espec_prestador(a.nr_sequencia) ds_especialidade, 
	(select	max(x.ds_tipo_prestador) 
	from	pls_tipo_prestador x 
	where	x.nr_sequencia = a.nr_seq_tipo_prestador)	ds_tipo_prestador, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'E'),1,255) ds_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'NE'),1,255) nr_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'B'),1,255) ds_bairro, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'C'),1,255) ds_cidade, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'ES'),1,255) ds_estado, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'T'),1,255) nr_telefone, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'COMP'),1,255) ds_complemento, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'CEP'),1,255) ds_cep, 
	substr(obter_dados_pf_pj(null,a.cd_cgc,'LO'),1,40) ds_logradouro, 
	d.cd_especialidade, 
	null cd_crm, 
	a.nr_seq_tipo_prestador nr_seq_tipo_prestador 
FROM pls_prestador a
LEFT OUTER JOIN pls_prestador_med_espec d ON (a.nr_sequencia = d.nr_seq_prestador)
WHERE a.cd_cgc is not null and LOCALTIMESTAMP between coalesce(dt_inicio_vigencia, LOCALTIMESTAMP) and coalesce(dt_fim_vigencia, LOCALTIMESTAMP) 
 
union
 
select	a.nr_sequencia nr_seq_prestador, 
	a.ie_situacao, 
	2 ie_tipo_pessoa, 
	substr(pls_obter_cod_prestador(a.nr_sequencia,null),1,255) cd_prestador, 
	initcap(substr(obter_dados_pf_pj(null,a.cd_cgc,'F'),1,255)) nm_fantasia, 
	coalesce(a.cd_cgc,a.cd_pessoa_fisica) cd_pf_pj, 
	coalesce(initcap(substr(obter_nome_pf(a.cd_pessoa_fisica),1,255)), 
	initcap(substr(obter_dados_pf_pj(null,a.cd_cgc,'N'),1,255))) ds_razao_social, 
	pls_obter_espec_prestador(a.nr_sequencia) ds_especialidade, 
	(select	max(x.ds_tipo_prestador) 
	from	pls_tipo_prestador x 
	where	x.nr_sequencia = a.nr_seq_tipo_prestador)	ds_tipo_prestador, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'E'),1,255) ds_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'NE'),1,255) nr_endereco, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'B'),1,255) ds_bairro, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'C'),1,255) ds_cidade, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'ES'),1,255) ds_estado, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'T'),1,255) nr_telefone, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'COMP'),1,255) ds_complemento, 
	substr(pls_obter_dados_prest_end(a.nr_sequencia,null,null,'CEP'),1,255) ds_cep, 
	coalesce(substr(Sus_Obter_Desc_TipoLog(b.cd_tipo_logradouro),1,40),substr(obter_dados_pf_pj(null,a.cd_cgc,'LO'),1,40)) ds_logradouro, 
	d.cd_especialidade, 
	CASE WHEN a.cd_cgc IS NULL THEN obter_crm_medico(a.cd_pessoa_fisica)  ELSE null END  cd_crm, 
	a.nr_seq_tipo_prestador nr_seq_tipo_prestador 
FROM pessoa_fisica c
LEFT OUTER JOIN compl_pessoa_fisica b ON (c.cd_pessoa_fisica = b.cd_pessoa_fisica)
, pls_prestador a
LEFT OUTER JOIN pls_prestador_med_espec d ON (a.nr_sequencia = d.nr_seq_prestador)
WHERE c.cd_pessoa_fisica	= a.cd_pessoa_fisica  and LOCALTIMESTAMP between coalesce(dt_inicio_vigencia, LOCALTIMESTAMP) and coalesce(dt_fim_vigencia, LOCALTIMESTAMP) order by 
	ds_razao_social;

