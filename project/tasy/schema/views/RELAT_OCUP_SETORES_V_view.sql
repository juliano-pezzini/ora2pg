-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW relat_ocup_setores_v (tipo, cd_classif_setor, cd_setor_atendimento, ds_setor_atendimento, nm_unidade, nr_unidades_setor, nr_unidades_ocupadas, nr_unidades_temporarias, nr_unid_ocup, nr_unidades_reservadas, nr_unidades_higienizacao, nr_unidades_livres, nr_unid_temp_ocup, qt_unidade_acomp, qt_unidade_saida_inter, qt_unidades_isolamento, nr_unidades_interditadas, qt_unidades_alta, qt_unidade_chamad_manut, qt_unidade_manutencao, qt_ocupadas, qt_livres, qt_livres_sem_temp, nr_unidades_normais, pr_ocupacao, pr_ocupacao_acomp, pr_ocupacao_total, pr_ocupacao_total2, pr_olf, pr_ohr, qt_pac_isolado, nr_unidades_tot_int) AS SELECT	1 tipo,
		cd_classif_setor,                             
		cd_setor_atendimento,                           
		ds_setor_atendimento,                           
		nm_unidade,                                
		nr_unidades_setor,                            
		nr_unidades_ocupadas,                           
		nr_unidades_temporarias,                         
		(nr_unidades_ocupadas - nr_unid_temp_ocup) nr_unid_ocup,         
		nr_unidades_reservadas,                          
		nr_unidades_higienizacao,                         
		nr_unidades_livres,                            
		nr_unid_temp_ocup,                            
		qt_unidade_acomp,                             
		qt_unidade_saida_inter,                          
		qt_unidades_isolamento,                          
		nr_unidades_interditadas,                         
		qt_unidades_alta,  
		qt_unidade_chamad_manut, 
		qt_unidade_manutencao, 
		(nr_unidades_ocupadas - nr_unidades_higienizacao) qt_ocupadas,      
		(nr_unidades_livres + qt_unidades_alta + nr_unidades_higienizacao) qt_livres,                                       
		((nr_unidades_livres + qt_unidades_alta + nr_unidades_higienizacao) - (nr_unid_temp_livres + qt_unid_temp_alta + nr_unid_temp_higienizacao)) qt_livres_sem_temp,                                
		(nr_unidades_setor - nr_unidades_temporarias) nr_unidades_normais,     
		/*   dividir((nr_unidades_ocupadas * 100),(nr_unidades_setor - nr_unidades_te 
		mporarias + nr_unid_temp_ocup)) pr_ocupacao,*/
                  
		Obter_percetual_ocupacao(                         
		nr_unidades_setor,                        
		nr_unidades_temporarias,                     
		nr_unidades_ocupadas,                       
		qt_unidade_acomp,                         
		nr_unidades_interditadas,                     
		nr_unidades_livres,                        
		nr_unidades_higienizacao,                     
		nr_unidades_reservadas,                      
		qt_unidades_isolamento,                      
		qt_unidades_alta,                         
		nr_unid_temp_ocup,                        
		nr_unid_temp_ocupadas,                      
		qt_unid_temp_acomp,                        
		nr_unid_temp_interditadas,                    
		nr_unid_temp_livres,                       
		nr_unid_temp_higienizacao,                    
		nr_unid_temp_reservadas,                     
		qt_unid_temp_isolamento,                     
		qt_unid_temp_alta, 
		qt_unidade_manutencao, 
		'1') pr_ocupacao,               
		dividir((nr_unidades_ocupadas + qt_unidade_acomp) * 100,nr_unidades_setor) pr_ocupacao_acomp,                               
		(dividir((nr_unidades_setor - qt_disponiveis), nr_unidades_setor) * 100) pr_ocupacao_total,                               
		dividir((nr_unidades_ocupadas + qt_unidade_acomp + qt_unidades_isolamento + nr_unidades_interditadas + nr_unidades_reservadas + nr_unid_temp_ocup) * 100 , (nr_unidades_setor + nr_unid_temp_ocup)) pr_ocupacao_total2,                      
		dividir(nr_unidades_ocupadas * 100, (nr_unidades_setor - nr_unidades_temporarias)) pr_olf,                                 
		dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, (nr_unidades_setor - nr_unidades_interditadas)) pr_ohr, qt_pac_isolado,  
		(nr_unidades_setor - nr_unidades_interditadas) nr_unidades_tot_int     
FROM 		ocupacao_setores_v2                            
WHERE 		ie_ocup_hospitalar IN ('S','M','T') AND ie_situacao = 'A'         
AND  		((('N' = 'N') AND (cd_classif_setor IN (3,4))) OR             
		(('N' = 'S') AND (cd_classif_setor IN (1,3,4))) OR            
	    (('N' = 'S') AND (cd_classif_setor IN (9,3,4))) OR              
		(('N' = 'S') AND ('N' = 'S') AND (cd_classif_setor IN (1,9,3,4))))      
AND  		Obter_se_exibe_estab(cd_estabelecimento_base,1,'007129','N') = 'S'     
AND  		(('N' = 'N') OR (('N' = 'S') AND (obter_se_setor_usuario(cd_setor_atendimento, '007129') = 'S')))                             

UNION
                                      
SELECT 		2 tipo,                                  
		'0',                                   
		0,                                    
		'   ' || SUBSTR(obter_valor_dominio(1, cd_classif_setor),1,200) ds_setor_atendimento,                                  
		'' nm_unidade,                              
		SUM(nr_unidades_setor),                          
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_ocupadas END ) nr_unidades_ocupadas,                                  
		SUM(nr_unidades_temporarias),                       
		SUM(nr_unidades_ocupadas - nr_unid_temp_ocup) nr_unid_ocup,        
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_reservadas END ) nr_unidades_reservadas,                                
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_higienizacao END ) nr_unidades_higienizacao,                              
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_livres END ) nr_unidades_livres,                                    
		SUM(nr_unid_temp_ocup) NR_UNID_TEMP_OCUP,                 
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_acomp END ) qt_unidade_acomp,                                      
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_saida_inter END ) qt_unidade_saida_inter,                                
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_isolamento END ) qt_unidades_isolamento,                                
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_interditadas END ) nr_unidades_interditadas,                              
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidades_alta END ) qt_unidades_alta, 
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_chamad_manut END ) qt_unidade_chamad_manut, 
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE qt_unidade_manutencao END ) qt_unidade_manutencao, 
		(SUM(nr_unidades_ocupadas) - SUM(nr_unidades_higienizacao)) qt_ocupadas, 
		(SUM(nr_unidades_livres) + SUM(qt_unidades_alta) + SUM(nr_unidades_higienizacao)) qt_livres,                               
		((SUM(nr_unidades_livres) + SUM(qt_unidades_alta) + SUM(nr_unidades_higienizacao)) -                                   
		(SUM(nr_unid_temp_livres) + SUM(qt_unid_temp_alta) + SUM(nr_unid_temp_higienizacao))) qt_livres_sem_temp,                        
		SUM(CASE WHEN ie_ocup_hospitalar='M' THEN 0 WHEN ie_ocup_hospitalar='T' THEN 0  ELSE nr_unidades_setor - nr_unidades_temporarias END ) nr_unidades_normais,                       
		/*   dividir(sum(nr_unidades_ocupadas * 100),sum(nr_unidades_setor - nr_unida 
		des_temporarias + nr_unid_temp_ocup)) pr_ocupacao,*/
               
		Obter_percetual_ocupacao(                         
		SUM(nr_unidades_setor),                            
		SUM(nr_unidades_temporarias),                         
		SUM(nr_unidades_ocupadas),                          
		SUM(qt_unidade_acomp),                            
		SUM(nr_unidades_interditadas),                        
		SUM(nr_unidades_livres),                           
		SUM(nr_unidades_higienizacao),                        
		SUM(nr_unidades_reservadas),                         
		SUM(qt_unidades_isolamento),                         
		SUM(qt_unidades_alta),                            
		SUM(nr_unid_temp_ocup),                            
		SUM(nr_unid_temp_ocupadas),                          
		SUM(qt_unid_temp_acomp),                           
		SUM(nr_unid_temp_interditadas),                        
		SUM(nr_unid_temp_livres),                           
		SUM(nr_unid_temp_higienizacao),                        
		SUM(nr_unid_temp_reservadas),                         
		SUM(qt_unid_temp_isolamento),                         
		SUM(qt_unid_temp_alta), 
		SUM(qt_unidade_manutencao),	 
		'1') pr_ocupacao,                           
		dividir((SUM(nr_unidades_ocupadas) + SUM(qt_unidade_acomp)) * 100,SUM(nr_unidades_setor)) pr_ocupacao_acomp,                        
		((dividir((SUM(nr_unidades_setor) - SUM(qt_disponiveis)), SUM(nr_unidades_setor)) * 100)) pr_ocupacao_total,                        
		dividir((SUM(nr_unidades_ocupadas) + SUM(qt_unidade_acomp) + SUM(qt_unidades_isolamento) + SUM(nr_unidades_interditadas) +                 
	 	SUM(nr_unidades_reservadas) + SUM(nr_unid_temp_ocup)) * 100 ,        
		(SUM(nr_unidades_setor) + SUM(nr_unid_temp_ocup))),           
		dividir(SUM(nr_unidades_ocupadas * 100), SUM(nr_unidades_setor - nr_unidades_temporarias)) pr_olf,                             
		dividir(SUM((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100),       
		SUM(nr_unidades_setor - nr_unidades_interditadas)) pr_ohr, SUM(qt_pac_isolado) qt_pac_isolado,                               
		SUM(nr_unidades_setor - nr_unidades_interditadas) NR_UNIDADES_TOT_INT   
FROM  		ocupacao_setores_v2                            
WHERE 		ie_ocup_hospitalar IN ('S','M','T') AND ie_situacao = 'A'         
AND 		Obter_se_exibe_estab(cd_estabelecimento_base,1,'007129','N') = 'S'      
AND  		(('N' = 'N') OR (('N' = 'S') AND (obter_se_setor_usuario(cd_setor_atendimento, '007129') = 'S')))                             
AND  		((('N' = 'N') AND (cd_classif_setor IN (3,4))) OR             
		(('N' = 'S') AND (cd_classif_setor IN (1,3,4))))              
GROUP BY 	SUBSTR(obter_valor_dominio(1, cd_classif_setor),1,200)         
ORDER BY 	1, 
		cd_classif_setor, 
		ds_setor_atendimento;

