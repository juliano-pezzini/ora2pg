-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_contab_hmcc_relat_v2 (ie_union, cd_conta_contabil, ds_conta_contabil, vl_item, vl_titulo, dt_mesano_ref, dt_vencimento, nr_titulo, nm_pessoa_titulo, dt_emissao, ie_faturamento, dt_antecipacao, dt_liquidacao, vl_antecipacao, vl_pro_rata, dt_antec_lote, dt_recebimento, dt_contrato, nr_contrato, dt_rescisao, ds_natureza, cd_pessoa_princ, nm_pessoa_princ, ds_tipo_doc, ie_tipo_titulo, nr_documento, nr_parcela, dt_venc_mens, vl_mens, ds_cober, vl_bx, dt_icob, dt_fcob, ie_lote_pro_rata) AS select	/* +USE_CONCAT */
	1 ie_union,
	d.cd_conta_deb_antecip cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		FROM	conta_contabil y
		where	y.cd_conta_contabil = d.cd_conta_deb_antecip) ds_conta_contabil,
	sum(d.vl_item) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'FA' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	e.dt_liquidacao,
	sum(d.vl_antecipacao) vl_antecipacao,
	sum(a.vl_pro_rata_dia)  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	null dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_contrato,
	(	select	max(k.nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(f.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_plano		v
		where	v.nr_sequencia	= c.nr_seq_plano) ds_cober,
	(	select	coalesce(sum(x.vl_recebido),0)
		from	titulo_receber_liq x
		where	e.nr_titulo	= x.nr_titulo) vl_bx,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_icob,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_fcob,
	null ie_lote_pro_rata
from	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	titulo_receber			e,
	pls_contrato_pagador		f,
	pls_lote_mensalidade		a
where	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	f.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	b.ie_cancelamento is null
--and	((nvl(d.vl_item,0) > 0))-- or (d.ie_tipo_item = 14))
group	by	e.nr_titulo,
		e.vl_titulo,
		d.dt_antecipacao,
		e.dt_vencimento,
		a.dt_mesano_referencia,
		d.cd_conta_deb_antecip,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		c.nr_seq_plano

union all

/* Coparticipação -  Conta 1844  - Sem valores diferentes */

/*select	2 ie_union,
	f.cd_conta_deb cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = f.cd_conta_deb) ds_conta_contabil,
	sum(f.vl_coparticipacao) vl_item,
	g.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	g.dt_vencimento,
	g.nr_titulo,
	substr(obter_nome_pf_pj(g.cd_pessoa_fisica,g.cd_cgc),1,200) nm_pessoa_titulo,
	g.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	g.dt_liquidacao,
	null vl_antecipacao,
	null  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	null dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= h.nr_seq_contrato) dt_contrato,
	(	select	max(k.nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= h.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= h.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(h.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(nvl(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= h.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= h.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	g.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(w.nr_sequencia)
		from	pls_tipo_cobertura	w,
			pls_cobertura		y,
			pls_plano		v
		where	w.nr_sequencia	= y.nr_seq_tipo_cobertura
		and	v.nr_sequencia	= y.nr_seq_plano
		and	v.nr_sequencia	= c.nr_seq_plano) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob
from	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	pls_conta_coparticipacao	f,
	pls_conta			e,
	titulo_receber			g,
	pls_contrato_pagador		h,
	pls_lote_mensalidade		a
where	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	d.nr_seq_conta		= e.nr_sequencia
and	e.nr_sequencia		= f.nr_seq_conta
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	a.nr_sequencia		= b.nr_seq_lote
and	h.nr_sequencia		= b.nr_seq_pagador
and	g.nr_seq_mensalidade	= b.nr_sequencia
and	d.vl_item		= 	(select	sum(x.vl_coparticipacao)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta	= d.nr_seq_conta)
and	nvl(f.vl_coparticipacao,0) > 0
and	b.ie_cancelamento is null
group	by	f.cd_conta_deb,
		g.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		g.dt_vencimento,
		g.nr_titulo,
		g.cd_pessoa_fisica,
		g.cd_cgc,
		g.dt_emissao,
		g.dt_liquidacao,
		a.dt_contabilizacao,
		h.nr_seq_contrato,
		ie_tipo_titulo,
		g.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		c.nr_seq_plano
union all*/
/* Coparticipação - 1844  - Com diferença */

select	3 ie_union,
	'1844' cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = '1844') ds_conta_contabil,
	sum(d.vl_item) vl_item,
	g.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	g.dt_vencimento,
	g.nr_titulo,
	substr(obter_nome_pf_pj(g.cd_pessoa_fisica,g.cd_cgc),1,200) nm_pessoa_titulo,
	g.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	g.dt_liquidacao,
	null vl_antecipacao,
	null  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	null dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_contrato,
	(	select	max(k.nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) nr_rescisao,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(f.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	g.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_plano		v
		where	v.nr_sequencia	= c.nr_seq_plano) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	null ie_lote_pro_rata
from	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	titulo_receber			g,
	pls_contrato_pagador		f,
	pls_lote_mensalidade		a
where	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	g.nr_seq_mensalidade	= b.nr_sequencia
and	f.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	d.ie_tipo_item		= 3
/*and	d.vl_item		<> 	(select	nvl(sum(x.vl_coparticipacao),0)
					from	pls_conta_coparticipacao x
					where	x.nr_seq_conta	= d.nr_seq_conta) Retirado por não trazer determinados títulos, não sei em qual situação isto é válido*/
and	b.ie_cancelamento is null
group	by	g.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		g.dt_vencimento,
		g.nr_titulo,
		g.cd_pessoa_fisica,
		g.cd_cgc,
		g.dt_emissao,
		g.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato,
		ie_tipo_titulo,
		g.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		c.nr_seq_plano,
		d.cd_conta_deb

union all

/* Mensalidades a receber - Contas 738 e 1264 (Resp. assumida)  e 2424 */

select	4 ie_union,
	d.cd_conta_deb cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = d.cd_conta_deb) ds_conta_contabil,
	sum(d.vl_item) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'F' ie_faturamento,
	d.dt_antecipacao dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(d.vl_antecipacao,0))  vl_antecipacao,
	sum(coalesce(d.vl_pro_rata_dia,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	null dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_contrato,
	(	select	max(k.nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= f.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(f.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= f.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_plano		v
		where	v.nr_sequencia	= c.nr_seq_plano) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	null ie_lote_pro_rata
from	pls_mensalidade_seg_item	d,
	pls_mensalidade_segurado	c,
	pls_mensalidade			b,
	titulo_receber			e,
	pls_contrato_pagador		f,
	pls_lote_mensalidade		a
where	c.nr_sequencia		= d.nr_seq_mensalidade_seg
and	b.nr_sequencia		= c.nr_seq_mensalidade
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	f.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	b.ie_cancelamento is null
group	by	d.cd_conta_deb,
		e.vl_titulo,
		d.dt_antecipacao,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		f.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		c.nr_seq_plano

union all

select	5 ie_union,
	coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls) cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls)) ds_conta_contabil,
	coalesce(sum(f.vl_contab_pro_rata),0) vl_item,
	e.vl_titulo,
	h.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'RA' ie_faturamento,
	d.dt_antecipacao_pls_mens dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(f.vl_antecipacao_mens,0))  vl_antecipacao,
	sum(coalesce(f.vl_pro_rata,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	d.dt_recebimento dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_contrato,
	(	select	max(nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(g.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_mensalidade_segurado	j,
			pls_plano			v
		where	j.nr_seq_plano		= v.nr_sequencia
		and	j.nr_seq_mensalidade	= b.nr_sequencia) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	null ie_lote_pro_rata
from	titulo_rec_liq_cc		f,
	titulo_receber_liq		d,
	titulo_receber			e,
	pls_mensalidade_segurado	h,
	pls_mensalidade			b,
	pls_contrato_pagador		g,
	pls_lote_mensalidade		a
where	f.nr_seq_baixa		= d.nr_sequencia
and	f.nr_titulo		= e.nr_titulo
and	d.nr_titulo		= e.nr_titulo
and	h.nr_seq_mensalidade	= b.nr_sequencia
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	g.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	f.ie_lote_pro_rata is not null
and	b.ie_cancelamento is null
and	exists (select	1
		from	pls_mensalidade_segurado x
		where	x.nr_seq_mensalidade	= b.nr_sequencia
		and	x.dt_mesano_referencia	<> a.dt_mesano_referencia)
group	by	coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls),
		e.vl_titulo,
		d.dt_antecipacao_pls_mens,
		h.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		d.dt_recebimento,
		g.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		b.nr_sequencia

union all

select	6 ie_union,
	coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls) cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls)) ds_conta_contabil,
	coalesce(sum(f.vl_contab_pro_rata),0) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'RA' ie_faturamento,
	d.dt_antecipacao_pls_mens dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(f.vl_antecipacao_mens,0))  vl_antecipacao,
	sum(coalesce(f.vl_pro_rata,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	d.dt_recebimento dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_contrato,
	(	select	max(nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(g.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_mensalidade_segurado	j,
			pls_plano			v
		where	j.nr_seq_plano		= v.nr_sequencia
		and	j.nr_seq_mensalidade	= b.nr_sequencia) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	f.ie_lote_pro_rata
from	titulo_rec_liq_cc		f,
	titulo_receber_liq		d,
	titulo_receber			e,
	pls_mensalidade			b,
	pls_contrato_pagador		g,
	pls_lote_mensalidade		a
where	f.nr_seq_baixa		= d.nr_sequencia
and	f.nr_titulo		= e.nr_titulo
and	d.nr_titulo		= e.nr_titulo
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	g.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	f.ie_lote_pro_rata = 'PR'
and	b.ie_cancelamento is null
group	by	f.ie_lote_pro_rata,
		coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls),
		e.vl_titulo,
		d.dt_antecipacao_pls_mens,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		d.dt_recebimento,
		g.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		b.nr_sequencia

union all

select	7 ie_union,
	coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls) cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls)) ds_conta_contabil,
	coalesce(sum(f.vl_contab_pro_rata),0) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'RA' ie_faturamento,
	d.dt_antecipacao_pls_mens dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(f.vl_antecipacao_mens,0))  vl_antecipacao,
	sum(coalesce(f.vl_pro_rata,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	d.dt_recebimento dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_contrato,
	(	select	max(nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(g.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_mensalidade_segurado	j,
			pls_plano			v
		where	j.nr_seq_plano		= v.nr_sequencia
		and	j.nr_seq_mensalidade	= b.nr_sequencia) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	f.ie_lote_pro_rata
from	titulo_rec_liq_cc		f,
	titulo_receber_liq		d,
	titulo_receber			e,
	pls_mensalidade			b,
	pls_contrato_pagador		g,
	pls_lote_mensalidade		a
where	f.nr_seq_baixa		= d.nr_sequencia
and	f.nr_titulo		= e.nr_titulo
and	d.nr_titulo		= e.nr_titulo
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	g.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	f.ie_lote_pro_rata = 'BA'
and	b.ie_cancelamento is null
and	not exists (select	1
			from	pls_mensalidade_segurado x
			where	x.nr_seq_mensalidade	= b.nr_sequencia
			and	x.dt_mesano_referencia	<> a.dt_mesano_referencia)
group	by	f.ie_lote_pro_rata,
		coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls),
		e.vl_titulo,
		d.dt_antecipacao_pls_mens,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		d.dt_recebimento,
		g.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		b.nr_sequencia

union all

select	8 ie_union,
	coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls) cd_conta_contabil,
	(	select	max(substr(y.ds_conta_contabil,1,255))
		from	conta_contabil y
		where	y.cd_conta_contabil = coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls)) ds_conta_contabil,
	coalesce(sum(f.vl_contab_pro_rata),0) vl_item,
	e.vl_titulo,
	a.dt_mesano_referencia dt_mesano_ref,
	e.dt_vencimento,
	e.nr_titulo,
	substr(obter_nome_pf_pj(e.cd_pessoa_fisica,e.cd_cgc),1,200) nm_pessoa_titulo,
	e.dt_emissao dt_emissao,
	'RA' ie_faturamento,
	d.dt_antecipacao_pls_mens dt_antecipacao,
	e.dt_liquidacao,
	sum(coalesce(f.vl_antecipacao_mens,0))  vl_antecipacao,
	sum(coalesce(f.vl_pro_rata,0))  vl_pro_rata,
	a.dt_contabilizacao dt_antec_lote,
	d.dt_recebimento dt_recebimento,
	(	select	max(k.dt_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_contrato,
	(	select	max(nr_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) nr_contrato,
	(	select	max(k.dt_rescisao_contrato)
		from	pls_contrato  k
		where	k.nr_sequencia	= g.nr_seq_contrato) dt_rescisao,
	pls_obter_dados_produto_contr(g.nr_seq_contrato,'TC') ds_natureza,
	(	select	max(coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),x.cd_cgc))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') cd_pessoa_princ,
	(	select	max(substr(obter_nome_pf_pj(x.cd_pessoa_fisica,x.cd_cgc),1,255))
		from	pls_contrato_pagador	x
		where	x.nr_seq_contrato	= g.nr_seq_contrato
		and	x.ie_tipo_pagador	= 'P') nm_pessoa_princ,
	(	select	substr(ds_valor_dominio,1,254)
		from 	valor_dominio
		where 	cd_dominio	= 712
		and	vl_dominio	= ie_tipo_titulo) ds_tipo_doc,
	ie_tipo_titulo,
	e.nr_documento,
	b.nr_parcela,
	b.dt_vencimento dt_venc_mens,
	b.vl_mensalidade vl_mens,
	(	select	max(v.ie_segmentacao)
		from	pls_mensalidade_segurado	j,
			pls_plano			v
		where	j.nr_seq_plano		= v.nr_sequencia
		and	j.nr_seq_mensalidade	= b.nr_sequencia) ds_cober,
	null vl_bx,
	null dt_icob,
	null dt_fcob,
	f.ie_lote_pro_rata
from	titulo_rec_liq_cc		f,
	titulo_receber_liq		d,
	titulo_receber			e,
	pls_mensalidade			b,
	pls_contrato_pagador		g,
	pls_lote_mensalidade		a
where	f.nr_seq_baixa		= d.nr_sequencia
and	f.nr_titulo		= e.nr_titulo
and	d.nr_titulo		= e.nr_titulo
and	e.nr_seq_mensalidade	= b.nr_sequencia
and	g.nr_sequencia		= b.nr_seq_pagador
and	a.nr_sequencia		= b.nr_seq_lote
and	f.ie_lote_pro_rata = 'AN'
and	b.ie_cancelamento is null
and	not exists (select	1
			from	pls_mensalidade_segurado x
			where	x.nr_seq_mensalidade	= b.nr_sequencia
			and	x.dt_mesano_referencia	<> a.dt_mesano_referencia)
group	by	f.ie_lote_pro_rata,
		coalesce(f.cd_conta_deb_pls,cd_conta_rec_pls),
		e.vl_titulo,
		d.dt_antecipacao_pls_mens,
		a.dt_mesano_referencia,
		e.dt_vencimento,
		e.nr_titulo,
		e.cd_pessoa_fisica,
		e.cd_cgc,
		e.dt_emissao,
		e.dt_liquidacao,
		a.dt_contabilizacao,
		d.dt_recebimento,
		g.nr_seq_contrato,
		ie_tipo_titulo,
		e.nr_documento,
		b.nr_parcela,
		b.dt_vencimento,
		b.vl_mensalidade,
		b.nr_sequencia;

