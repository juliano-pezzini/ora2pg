-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW medic_dose_periodo_relat_v (ds_princ_ativo, ds_medicamento, ds_potencia, ds_form, qt_manha, qt_almoco, qt_tarde, qt_noite, ds_unidade_medida, ds_observacao, ds_motivo, ds_intervalo, nr_seq_versao, cd_classificacao, ds_complementar, cd_material, ds_orientacao, nr_sequencia) AS select  substr(CASE WHEN obter_ficha_tecnica_medic(a.cd_material)=0 THEN  obter_desc_material(obter_mat_generico(a.cd_material))  ELSE obter_princ_ativo_matmed(a.cd_material) END ,1,255) ds_princ_ativo,
            		substr(obter_desc_material(a.cd_material), 1, 255) ds_medicamento,
            		a.ds_potencia ds_potencia,
		(select ds_nome_amigavel FROM forma_dosagem_ger where cd_codigo_ifa = a.ds_forma_medicamento) ds_form,
	    CASE WHEN a.qt_dose_manha IS NULL THEN  to_char(a.qt_dose_manha)  ELSE converte_fracao_dose(b.cd_unidade_medida_consumo, a.qt_dose_manha) END  qt_manha,
	    CASE WHEN a.qt_dose_almoco IS NULL THEN  to_char(a.qt_dose_almoco)  ELSE converte_fracao_dose(b.cd_unidade_medida_consumo, a.qt_dose_almoco) END  qt_almoco,
		CASE WHEN a.qt_dose_tarde IS NULL THEN  to_char(a.qt_dose_tarde)  ELSE converte_fracao_dose(b.cd_unidade_medida_consumo, a.qt_dose_tarde) END  qt_tarde,
		CASE WHEN a.qt_dose_noite IS NULL THEN  to_char(a.qt_dose_noite)  ELSE converte_fracao_dose(b.cd_unidade_medida_consumo, a.qt_dose_noite) END  qt_noite,
		a.ds_unidade_medida ds_unidade_medida,
		a.ds_observacao ds_observacao,
		a.ds_motivo ds_motivo,
		a.ds_horario_especial ds_intervalo,
		a.nr_seq_versao nr_seq_versao,
		a.ie_classificacao cd_classificacao,
		a.ds_descricao_complementar ds_complementar,
		a.cd_material cd_material,
		a.ds_orientacao ds_orientacao,
		a.nr_sequencia nr_sequencia
	from	paciente_medic_uso a,
          		material b
	where 	b.cd_material      = a.cd_material
	and   	((coalesce(a.qt_dose_manha, 0) != 0
	or    	coalesce(a.qt_dose_almoco, 0)  != 0
	or    	coalesce(a.qt_dose_tarde, 0)   != 0
	or	coalesce(a.qt_dose_noite, 0)   != 0)
	and   	a.ds_horario_especial   is null)
	
union all

    	select	'' ds_princ_ativo,
	                substr(a.ds_medicamento, 1, 255) ds_medicamento,
	                a.ds_potencia ds_potencia,
	                (select ds_nome_amigavel from forma_dosagem_ger where cd_codigo_ifa = a.ds_forma_medicamento) ds_form,
	                to_char(a.qt_dose_manha) qt_manha,
	                to_char(a.qt_dose_almoco) qt_almoco,
	                to_char(a.qt_dose_tarde) qt_tarde,
	                to_char(a.qt_dose_noite) qt_noite,
            		a.cd_unidade_medida_plano cd_unidade_medida,
	                a.ds_observacao ds_observacao,
	                a.ds_motivo ds_motivo,
	                a.ds_horario_especial ds_intervalo,
	                a.nr_seq_versao nr_seq_versao,
	                a.ie_classificacao cd_classificacao,
	                a.ds_descricao_complementar ds_complementar,
	                a.cd_material cd_material,
	                a.ds_orientacao ds_orientacao,
					a.nr_sequencia nr_sequencia
	from  	paciente_medic_uso a
	where 	a.cd_material         is null
	and   	((coalesce(a.qt_dose_manha, 0) != 0
	or	coalesce(a.qt_dose_almoco, 0)  != 0
	or	coalesce(a.qt_dose_tarde, 0)   != 0
	or	coalesce(a.qt_dose_noite, 0)   != 0)
  	and   	a.ds_horario_especial   is null);

