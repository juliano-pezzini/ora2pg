-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW monitoramento_user_logados (nm_usuario, ds_status_usuario, ds_maquina_chamada, ds_local, ie_usuario_logado, cd_senha, tempo_atendimento, qt_pacientes_atendidos, ds_estrategia, nr_seq_local_senha, nr_sequencia, ds_cor_status, dt_login, dt_inicio_status, dt_inicio_pausa, ds_observacao_pausa, ds_motivo_pausa, cd_estabelecimento) AS with	pac_fila_hist as (	select	max(f.nr_seq_senha) nr_seq_senha,
					f.nm_usuario,
					f.ds_maquina_chamada
				FROM	paciente_senha_fila_hist f
				where	f.dt_atualizacao_nrec between trunc(LOCALTIMESTAMP) and (trunc(LOCALTIMESTAMP) + 86399/86400)
				group by f.nm_usuario, f.ds_maquina_chamada),
	ultimo_status_usuario as (	select	nr_seq_status,
						dt_inicio_status,
						dt_fim_status,
						nm_usuario,
						ds_status,
						ds_cor_status,
						ie_permite_chamada
					from (	select	
							a.nr_seq_status,
							a.dt_inicio_status,
							a.dt_fim_status,
							a.nm_usuario,
							b.ds_status,
							b.ds_cor_status,
							coalesce(b.ie_permite_chamada,'S') ie_permite_chamada,
							row_number() over (partition by a.nm_usuario order by a.dt_inicio_status desc ) nr_linha
						from	usuario_status_senha a,
							status_atendente_senha b
						where	a.nr_seq_status = b.nr_sequencia
						) alias8
					where nr_linha = 1),
	ultimo_motivo_pausa as (	select	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_motivo,
						ds_observacao,
						ds_motivo_pausa
					from (	select	
							a.nr_sequencia,
							a.dt_atualizacao,
							a.nm_usuario,
							a.nr_seq_motivo,
							a.ds_observacao,
							b.ds_motivo_pausa,
							row_number() over (partition by a.nm_usuario order by a.dt_atualizacao desc ) nr_linha
						from	log_motivo_pausa_senha a,
							motivo_pausa_senha b
						where	a.nr_seq_motivo = b.nr_sequencia) alias12
					where nr_linha = 1)
select	nm_usuario,
	ds_status_usuario,
	ds_maquina_chamada,
	ds_local,
	ie_usuario_logado,
	cd_senha,
	tempo_atendimento,
	qt_pacientes_atendidos,
	ds_estrategia,
	nr_seq_local_senha,
	nr_sequencia,
	ds_cor_status,
	dt_login,
	dt_inicio_status,
	dt_inicio_pausa,
	ds_observacao_pausa,
	ds_motivo_pausa,
	cd_estabelecimento
from	(
	select	a.nm_usuario,
		substr(d.ds_status,1,255) ds_status_usuario,
		a.ds_maquina_chamada,
		b.ds_local,
		'S' ie_usuario_logado,
		(	select max(e.cd_senha_gerada)
			from	paciente_senha_fila e
			where a.nr_seq_senha = e.nr_sequencia) cd_senha,
		substr(obter_tempo_senha(a.nr_seq_senha),1,30) tempo_atendimento,
		substr(obter_qt_senha_atend_usu(b.nr_sequencia, a.nm_usuario),1,30) qt_pacientes_atendidos,
		substr(obter_desc_estrategia_senha(b.nr_seq_estrategia_senha),1,255) ds_estrategia,
		b.nr_sequencia nr_seq_local_senha,
		c.nr_sequencia,
		substr(d.ds_cor_status,1,10) ds_cor_status,
		substr(obter_dt_utm_acesso_tasy(a.nm_usuario),1,20) dt_login,
		d.dt_inicio_status,
		e.dt_atualizacao dt_inicio_pausa,
		e.ds_observacao ds_observacao_pausa,
		e.ds_motivo_pausa,
		b.cd_estabelecimento
	from	pac_fila_hist a
		left outer join ultimo_status_usuario d on d.nm_usuario = a.nm_usuario
		left outer join ultimo_motivo_pausa e on e.nm_usuario = a.nm_usuario and d.ie_permite_chamada = 'N',
		maquina_local_senha b,
		computador c
	where	b.nr_seq_computador = c.nr_sequencia
	and	upper(c.nm_computador) = upper(a.ds_maquina_chamada)
	and	exists (	select 1
				from	tasy_controle_login g
				where trunc(g.dt_acesso) = trunc(LOCALTIMESTAMP)
					and	g.ds_aplicacao = 'TasySwing'
					and	g.dt_saida is null
					and	upper(g.ds_maquina) = upper(a.ds_maquina_chamada))
	) alias33
where 1 = 1
order by 1;

