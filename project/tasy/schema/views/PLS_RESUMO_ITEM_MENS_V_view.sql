-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_resumo_item_mens_v (dt_referencia, cd_estabelecimento, nr_seq_lote, ie_cancelamento, ie_tipo_vinculo_operadora, ie_tipo_item, nr_seq_tipo_lanc, ie_segmentacao, vl_item_individual, vl_item_coletivo, vl_item_cancelado_individual, vl_item_cancelado_coletivo, vl_item_cancelado, vl_item_estorno, vl_item_estorno_individual, vl_item_estorno_coletivo, vl_antec_estorno, vl_antec_estorno_individual, vl_antec_estorno_coletivo, vl_aberto, vl_pro_rata_dia, vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao, vl_antec_pro_rata_individual, vl_antec_pro_rata_coletivo, vl_antecipacao_individual, vl_antecipacao_coletivo, vl_antec_rata_ant_individual, vl_antec_rata_ant_coletivo, ie_regulamentacao, ie_tipo_contratacao, dt_geracao_nf) AS select	trunc(e.dt_referencia,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_individual,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE abs(a.vl_pro_rata_dia) END  END   ELSE 0 END ) vl_item_coletivo,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)*-1  ELSE 0 END  END ) vl_item_estorno,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_pro_rata_dia)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END ) vl_antec_estorno,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN a.vl_pro_rata_dia  ELSE 0 END ) vl_pro_rata_dia,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_individual,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_pro_rata_dia) END   ELSE 0 END ) vl_pro_rata_coletivo,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao,
	sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
	sum(CASE WHEN f.dt_contabilizacao IS NULL THEN CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao) END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
FROM	pls_mensalidade_seg_item_v 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_plano			d,
	pls_mensalidade			e,
	pls_lote_mensalidade		f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_segurado	= c.nr_sequencia
and	c.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	f.ie_status	= '2'
and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
and	exists (select	1
		from	pls_regra_pro_rata_dia x
		where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(e.dt_referencia,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf

UNION ALL

select	trunc(e.dt_referencia,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_individual,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_coletivo,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END ) vl_item_estorno,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END ) vl_antec_estorno,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_antecipacao)*-1  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_pro_rata_individual,
	0 vl_pro_rata_coletivo,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
FROM pls_lote_mensalidade f, pls_mensalidade e, pls_plano d, pls_segurado c, pls_mensalidade_segurado b, pls_mensalidade_seg_item_v a
LEFT OUTER JOIN pls_tipo_lanc_adic g ON (a.nr_seq_tipo_lanc = g.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg = b.nr_sequencia  and b.nr_seq_segurado	= c.nr_sequencia and c.nr_seq_plano		= d.nr_sequencia and b.nr_seq_mensalidade	= e.nr_sequencia and e.nr_seq_lote		= f.nr_sequencia and f.ie_status	= '2' and coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N' and ((a.ie_tipo_item <> '20') or (a.ie_tipo_item = '20' and g.ie_considera_receita = 'S')) and not exists (	select	1
			from	pls_regra_pro_rata_dia x
			where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item) group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(e.dt_referencia,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf

union all

select	trunc(f.dt_contabilizacao,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	0 vl_item_individual,
	0 vl_item_coletivo,
	0 vl_item_cancelado_individual,
	0 vl_item_cancelado_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,	
	0 vl_item_estorno_individual,
	0 vl_item_estorno_coletivo,
	0 vl_antec_estorno,
	0 vl_antec_estorno_individual,
	0 vl_antec_estorno_coletivo,
	0 vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_pro_rata_individual,
	0 vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END ) vl_antecipacao_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END ) vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
from	pls_mensalidade_seg_item_v 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_plano			d,
	pls_mensalidade			e,
	pls_lote_mensalidade		f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_segurado	= c.nr_sequencia
and	c.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	e.ie_cancelamento is null
and	f.ie_status	= '2'
and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(f.dt_contabilizacao,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf

union all

select	trunc(a.dt_antecipacao,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	0 vl_item_individual,
	0 vl_item_coletivo,
	0 vl_item_cancelado_individual,
	0 vl_item_cancelado_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,	
	0 vl_item_estorno_individual,
	0 vl_item_estorno_coletivo,
	0 vl_antec_estorno,
	0 vl_antec_estorno_individual,
	0 vl_antec_estorno_coletivo,
	0 vl_aberto,
	0 vl_pro_rata_dia,
	0 vl_pro_rata_individual,
	0 vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antec_rata_ant_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
from	pls_mensalidade_seg_item_v 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_plano			d,
	pls_mensalidade			e,
	pls_lote_mensalidade		f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_segurado	= c.nr_sequencia
and	c.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	e.ie_cancelamento is null
and	f.dt_contabilizacao is null
and	f.ie_status	= '2'
and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(a.dt_antecipacao,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf

union all
 /* contabilizar a antecipacao das mensalidades adiantadas */

select	trunc(a.dt_antecipacao,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_item_individual,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN 0  ELSE abs(a.vl_antecipacao) END ) vl_item_coletivo,
	0 vl_item_cancelado_individual,
	0 vl_item_cancelado_coletivo,
	0 vl_item_cancelado,
	0 vl_item_estorno,	
	0 vl_item_estorno_individual,
	0 vl_item_estorno_coletivo,
	0 vl_antec_estorno,
	0 vl_antec_estorno_individual,
	0 vl_antec_estorno_coletivo,
	0 vl_aberto,
	sum(a.vl_antecipacao) vl_pro_rata_dia,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_antecipacao)  ELSE 0 END ) vl_pro_rata_individual,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN 0  ELSE abs(a.vl_antecipacao) END ) vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
from	pls_mensalidade_seg_item_v 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_plano			d,
	pls_mensalidade			e,
	pls_lote_mensalidade		f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_segurado	= c.nr_sequencia
and	c.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	e.ie_cancelamento is null
and	f.dt_contabilizacao is not null
and	f.ie_status	= '2'
and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(a.dt_antecipacao,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf

UNION ALL
 /* Resumo para mensalidades anteriores */

select	trunc(f.dt_mesano_referencia,'month') dt_referencia,
	f.cd_estabelecimento,
	f.nr_sequencia nr_seq_lote,
	e.ie_cancelamento,
	c.ie_tipo_vinculo_operadora,
	a.ie_tipo_item,
	a.nr_seq_tipo_lanc,
	d.ie_segmentacao,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_individual,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_item_coletivo,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
	sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)  ELSE 0 END  END ) vl_item_cancelado,
	sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END ) vl_item_estorno,
	sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
	sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN f.dt_contabilizacao IS NULL THEN abs(a.vl_item)*-1  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
	0 vl_antec_estorno,
	0 vl_antec_estorno_individual,
	0 vl_antec_estorno_coletivo,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN abs(a.vl_item)  ELSE 0 END ) vl_pro_rata_dia,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN d.ie_tipo_contratacao='I' THEN abs(a.vl_item) END   ELSE 0 END ) vl_pro_rata_individual,
	sum(CASE WHEN e.ie_cancelamento IS NULL THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN abs(a.vl_item) END   ELSE 0 END ) vl_pro_rata_coletivo,
	0 vl_antecipacao,
	0 vl_antec_pro_rata_individual,
	0 vl_antec_pro_rata_coletivo,
	0 vl_antecipacao_individual,
	0 vl_antecipacao_coletivo,
	0 vl_antec_rata_ant_individual,
	0 vl_antec_rata_ant_coletivo,
	d.ie_regulamentacao,
	d.ie_tipo_contratacao,
	f.dt_geracao_nf
from	pls_mensalidade_seg_item_v 	a,
	pls_mensalidade_segurado 	b,
	pls_segurado			c,
	pls_plano			d,
	pls_mensalidade			e,
	pls_lote_mensalidade		f
where	a.nr_seq_mensalidade_seg = b.nr_sequencia
and	b.nr_seq_segurado	= c.nr_sequencia
and	c.nr_seq_plano		= d.nr_sequencia
and	b.nr_seq_mensalidade	= e.nr_sequencia
and	e.nr_seq_lote		= f.nr_sequencia
and	f.ie_status	= '2'
and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
group by	a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		trunc(f.dt_mesano_referencia,'month'),
		f.cd_estabelecimento,
		f.nr_sequencia,
		e.ie_cancelamento,
		c.ie_tipo_vinculo_operadora,
		d.ie_segmentacao,
		d.ie_regulamentacao,
		d.ie_tipo_contratacao,
		f.dt_geracao_nf;

