-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_hist_audit_conpaci_v (dt_referencia, cd_estabelecimento, cd_convenio, ds_convenio, nr_seq_historico, cd_tipo_portador, cd_portador, nr_interno_conta, ds_conta_paciente, ds_historico, vl_total_convenio, vl_vencido_quinze, vl_vencido_trinta, vl_vencido_sessenta, vl_vencido_noventa, vl_vencido_acima_nov, vl_total_vencido) AS select	dt_referencia,
	cd_estabelecimento, 
	cd_convenio, 
	ds_convenio, 
	nr_seq_historico, 
	cd_tipo_portador, 
	cd_portador, 
	nr_interno_conta, 
	substr(nr_interno_conta||' - '||Obter_Paciente_Conta(nr_interno_conta,'D'),1,255) ds_conta_paciente, 
	substr(CASE WHEN nr_seq_historico IS NULL THEN obter_desc_portador(cd_tipo_portador,cd_portador)  ELSE obter_descricao_padrao('HIST_AUDIT_CONTA_PACIENTE','DS_HISTORICO',nr_seq_historico) END ,1,255) ds_historico, 
	sum(vl_historico) vl_total_convenio, 
	sum(CASE WHEN ie_tipo_vencimento=6 THEN vl_historico  ELSE 0 END ) vl_vencido_quinze, 
	sum(CASE WHEN ie_tipo_vencimento=7 THEN vl_historico  ELSE 0 END ) vl_vencido_trinta, 
	sum(CASE WHEN ie_tipo_vencimento=8 THEN vl_historico  ELSE 0 END ) vl_vencido_Sessenta, 
	sum(CASE WHEN ie_tipo_vencimento=9 THEN vl_historico  ELSE 0 END ) vl_vencido_Noventa, 
	sum(CASE WHEN ie_tipo_vencimento=10 THEN vl_historico WHEN ie_tipo_vencimento=12 THEN vl_historico  ELSE 0 END ) vl_vencido_Acima_Nov, 
	sum(CASE WHEN ie_tipo_vencimento=6 THEN vl_historico WHEN ie_tipo_vencimento=7 THEN vl_historico WHEN ie_tipo_vencimento=8 THEN vl_historico WHEN ie_tipo_vencimento=9 THEN vl_historico WHEN ie_tipo_vencimento=10 THEN vl_historico WHEN ie_tipo_vencimento=12 THEN vl_historico  ELSE 0 END ) vl_total_Vencido	 
FROM	eis_hist_audit_conpaci 
group by dt_referencia, 
	cd_estabelecimento, 
	cd_convenio, 
	ds_convenio, 
	nr_seq_historico, 
	cd_tipo_portador, 
	cd_portador, 
	nr_interno_conta;

