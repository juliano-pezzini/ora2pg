-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_desconto_folha_emp_v (tp_registro, dt_competencia, cd_matricula, cd_matricula_reparticao, cd_matricula_6, cd_matricula_8, cd_matricula_10, cd_matricula_12, cd_matricula_13, vl_pago, vl_pensionista, vl_pago_positivo, vl_pago_negativo, nr_seq_cobranca, vl_tot_pago, vl_tot_titulos, cd_codigo, cd_matricula_reparticao2, vl_pago2, especie, cd_funcao, ie_identificador_6, vl_incluir, vl_excluir, nr_pensionista, nr_seq_pagador) AS select	1				TP_REGISTRO,
	c.dt_remessa_retorno		DT_COMPETENCIA,
	null				CD_MATRICULA,
	null				CD_MATRICULA_REPARTICAO,
	null				CD_MATRICULA_6,
	null				CD_MATRICULA_8,
	null				CD_MATRICULA_10,
	null				CD_MATRICULA_12,
	null				CD_MATRICULA_13,
	null				VL_PAGO,
	null				VL_PENSIONISTA,
	null				VL_PAGO_POSITIVO,
	null				VL_PAGO_NEGATIVO,
	a.nr_seq_cobranca		NR_SEQ_COBRANCA,
	null				VL_TOT_PAGO,
	obter_Valor_sem_virgula(sum(a.vl_cobranca))	VL_TOT_TITULOS,
	null				CD_CODIGO,
	null				CD_MATRICULA_REPARTICAO2,
	obter_Valor_sem_virgula(sum(a.vl_cobranca))	VL_PAGO2,
	'mensalidade'			ESPECIE,
	null				CD_FUNCAO,
	null				IE_IDENTIFICADOR_6,
	null				VL_INCLUIR,
	null				VL_EXCLUIR,
	null				NR_PENSIONISTA,
	null				NR_SEQ_PAGADOR
FROM	titulo_receber_cobr		a,
	pls_mensalidade			b,
	cobranca_escritural		c,
	titulo_receber			d
where	d.nr_seq_mensalidade	= b.nr_sequencia
and	d.nr_titulo		= a.nr_titulo
and	a.nr_seq_cobranca = c.nr_sequencia
group by	c.dt_remessa_retorno,
		a.nr_seq_cobranca

union

select	2				TP_REGISTRO,
	d.dt_remessa_retorno		DT_COMPETENCIA,
	c.cd_matricula			CD_MATRICULA,
	c.cd_matricula			CD_MATRICULA_REPARTICAO,
	substr(c.cd_matricula,1,6)	CD_MATRICULA_6,
	substr(c.cd_matricula,1,8)	CD_MATRICULA_8,
	substr(c.cd_matricula,1,10)	CD_MATRICULA_10,
	substr(c.cd_matricula,1,12)	CD_MATRICULA_12,
	substr(c.cd_matricula,1,13)	CD_MATRICULA_13,
	obter_Valor_sem_virgula(a.vl_cobranca)	VL_PAGO,
	CASE WHEN substr(a.vl_cobranca,1,1)='-' THEN '0000000099999'  ELSE obter_Valor_sem_virgula(a.vl_cobranca) END 	VL_PENSIONISTA,
	CASE WHEN substr(a.vl_cobranca,1,1)='-' THEN '0'  ELSE obter_Valor_sem_virgula(a.vl_cobranca) END 	VL_PAGO_POSITIVO,
	CASE WHEN substr(a.vl_cobranca,1,1)='-' THEN obter_Valor_sem_virgula(a.vl_cobranca)  ELSE '0' END 	VL_PAGO_NEGATIVO,
	a.nr_seq_cobranca		NR_SEQ_COBRANCA,
	null				VL_TOT_PAGO,
	null				VL_TOT_TITULOS,
	pls_obter_codigo_corsan(c.cd_matricula) CD_CODIGO,
	null				CD_MATRICULA_REPARTICAO2,
	null				VL_PAGO2,
	'mensalidade'			ESPECIE,
	c.cd_profissao			CD_FUNCAO,
	null				IE_IDENTIFICADOR_6,
	pls_obter_vl_excluir_afpergs(a.vl_cobranca, d.dt_remessa_retorno, a.nr_titulo, 'I','N') VL_INCLUIR,
	pls_obter_vl_excluir_afpergs(a.vl_cobranca, d.dt_remessa_retorno, a.nr_titulo, 'E','N') VL_EXCLUIR,
	coalesce(substr(c.nr_pensionista,1,2),00)	NR_PENSIONISTA,
	c.nr_seq_pagador			NR_SEQ_PAGADOR
from	titulo_receber_cobr		a,
	pls_mensalidade			b,
	pls_contrato_pagador_fin	c,
	cobranca_escritural		d,
	titulo_receber			e
where	e.nr_seq_mensalidade	= b.nr_sequencia
and	e.nr_titulo		= a.nr_titulo
and	b.nr_seq_pagador	= c.nr_seq_pagador
and	LOCALTIMESTAMP	between coalesce(c.dt_inicio_vigencia,LOCALTIMESTAMP) and coalesce(c.dt_fim_vigencia,LOCALTIMESTAMP)
and	a.nr_seq_cobranca = d.nr_sequencia

union all

select	3				TP_REGISTRO,
	null				DT_COMPETENCIA,
	null				CD_MATRICULA,
	null				CD_MATRICULA_REPARTICAO,
	null				CD_MATRICULA_6,
	null				CD_MATRICULA_8,
	null				CD_MATRICULA_10,
	null				CD_MATRICULA_12,
	null				CD_MATRICULA_13,
	null				VL_PAGO,
	null				VL_PENSIONISTA,
	null				VL_PAGO_POSITIVO,
	null				VL_PAGO_NEGATIVO,
	nr_seq_cobranca			NR_SEQ_COBRANCA,
	obter_Valor_sem_virgula(sum(vl_cobranca))	VL_TOT_PAGO,
	null				VL_TOT_TITULOS,
	null				CD_CODIGO,
	null				CD_MATRICULA_REPARTICAO2,
	null				VL_PAGO2,
	null				ESPECIE,
	null				CD_FUNCAO,
	rpad(9,82,0)			IE_IDENTIFICADOR_6,
	null				VL_INCLUIR,
	null				VL_EXCLUIR,
	null				NR_PENSIONISTA,
	null				NR_SEQ_PAGADOR
from	titulo_receber_cobr
group by nr_seq_cobranca;

