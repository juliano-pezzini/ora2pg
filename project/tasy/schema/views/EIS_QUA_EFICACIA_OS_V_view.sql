-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_qua_eficacia_os_v (cd_ano, nr_ano, cd_estabelecimento, qt_jan, qt_fev, qt_mar, qt_abr, qt_mai, qt_jun, qt_jul, qt_ago, qt_set, qt_out, qt_nov, qt_dez, qt_media, cd_setor_atendimento) AS select	to_char(add_months(trunc(LOCALTIMESTAMP, 'yy'), -12), 'yyyy') cd_ano,
	somente_numero(to_char(add_months(trunc(LOCALTIMESTAMP, 'yy'), -12), 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='01' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='02' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='03' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='04' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='05' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='06' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='07' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='08' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='09' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_set,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='10' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_out,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='11' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='12' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_dez,
	round((dividir(SUM(dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100) , COUNT(*)))::numeric,2) qt_media,
	cd_setor_atendimento
FROM 	eis_qua_eficacia_os
where	trunc(dt_mes_ref, 'yy') = add_months(trunc(LOCALTIMESTAMP, 'yy'), -12)
group	by	cd_estabelecimento, 	cd_setor_atendimento

union all

select	to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy') cd_ano,
	somente_numero(to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='01' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='02' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='03' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='04' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='05' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='06' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='07' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='08' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='09' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_set,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='10' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_out,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='11' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='12' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_dez,
	round((dividir(SUM(dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100) , COUNT(*)))::numeric,2) qt_media,
	-1 cd_setor_atendimento
from 	eis_qua_eficacia_os
where	trunc(dt_mes_ref, 'yy') = trunc(LOCALTIMESTAMP, 'yy')
group	by	cd_estabelecimento

union all

select	to_char(add_months(trunc(LOCALTIMESTAMP, 'yy'), -12), 'yyyy') cd_ano,
	somente_numero(to_char(add_months(trunc(LOCALTIMESTAMP, 'yy'), -12), 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='01' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='02' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='03' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='04' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='05' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='06' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='07' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='08' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='09' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_set,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='10' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_out,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='11' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='12' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_dez,
	round((dividir(SUM(dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100) , COUNT(*)))::numeric,2) qt_media,
	-1 cd_setor_atendimento
from 	eis_qua_eficacia_os
where	trunc(dt_mes_ref, 'yy') = add_months(trunc(LOCALTIMESTAMP, 'yy'), -12)
group	by	cd_estabelecimento

union all

select	to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy') cd_ano,
	somente_numero(to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy')) nr_ano,
	cd_estabelecimento,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='01' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jan,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='02' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_fev,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='03' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mar,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='04' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_abr,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='05' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_mai,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='06' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jun,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='07' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_jul,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='08' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_ago,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='09' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_set,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='10' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_out,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='11' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_nov,
	coalesce(max(CASE WHEN to_char(dt_mes_ref, 'mm')='12' THEN  dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100  ELSE 0 END ),0) qt_dez,
	round((dividir(SUM(dividir(QT_ORDEM_EFICACIA, QT_ORDEM) * 100) , COUNT(*)))::numeric,2) qt_media,
	cd_setor_atendimento
from 	eis_qua_eficacia_os
where	trunc(dt_mes_ref, 'yy') = trunc(LOCALTIMESTAMP, 'yy')
group	by	cd_estabelecimento,	cd_setor_atendimento

union all

select	cd_ano,
	nr_ano,
	cd_estabelecimento,
	qt_sem_um qt_jan,
	qt_sem_um qt_fev,
	qt_sem_um qt_mar,
	qt_sem_um qt_abr,
	qt_sem_um qt_mai,
	qt_sem_um qt_jun,
	qt_sem_dois qt_jul,
	qt_sem_dois qt_ago,
	qt_sem_dois qt_set,
	qt_sem_dois qt_out,
	qt_sem_dois qt_nov,
	qt_sem_dois qt_dez,
	qt_media,
	cd_setor_atendimento
from (select	'Meta' cd_ano,
		0 nr_ano,
		cd_estabelecimento,
		Eis_Obter_Meta_Indicador(cd_estabelecimento, 450, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'P') qt_sem_um,
		Eis_Obter_Meta_Indicador(cd_estabelecimento, 450, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'P') qt_sem_dois,
		0 qt_media,
		0 cd_setor_atendimento
	from 	estabelecimento
	group by cd_estabelecimento) alias258

union all

select	cd_ano,
	nr_ano,
	cd_estabelecimento,
	qt_sem_um qt_jan,
	qt_sem_um qt_fev,
	qt_sem_um qt_mar,
	qt_sem_um qt_abr,
	qt_sem_um qt_mai,
	qt_sem_um qt_jun,
	qt_sem_dois qt_jul,
	qt_sem_dois qt_ago,
	qt_sem_dois qt_set,
	qt_sem_dois qt_out,
	qt_sem_dois qt_nov,
	qt_sem_dois qt_dez,
	qt_media,
	cd_setor_atendimento
from (select	'Bench' cd_ano,
		1 nr_ano,
		cd_estabelecimento,
		Eis_Obter_Meta_Indicador(cd_estabelecimento, 450, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 1, 'B') qt_sem_um,
		Eis_Obter_Meta_Indicador(cd_estabelecimento, 450, (to_char(trunc(LOCALTIMESTAMP, 'yy'), 'yyyy'))::numeric , 2, 'B') qt_sem_dois,
		0 qt_media,
		0 cd_setor_atendimento
	from 	estabelecimento
	group by	cd_estabelecimento) alias267;

