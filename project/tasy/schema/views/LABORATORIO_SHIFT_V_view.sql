-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW laboratorio_shift_v (cd_tipo_registro, nr_prescricao, ie_linha, ie_tipo_linha, ds_cabecalho, dt_liberacao, cd_pessoa_fisica, nm_paciente, dt_nascimento, ie_sexo, qt_altura_cm, qt_peso, ds_dado_clinico, ds_observacao, nr_amostra, ds_exames, ie_prioridade, dt_coleta, ds_material_exame) AS select	distinct
	1 cd_tipo_registro, 
	a.nr_prescricao, 
	'1H' ie_linha, 
	'H' ie_tipo_linha, 
	'\^&|INTERLIS-X||CLIENT*'|| lab_obter_convenio_shift(b.nr_atendimento) || '^INTERLIS-X V2.3||||||' || to_char(b.dt_liberacao,'YYYY') || '-0001-001||' ds_cabecalho, 
	to_char(b.dt_liberacao,'yyyymmddhh24miss') || chr(3) dt_liberacao, 
	'' cd_pessoa_fisica, 
	'' nm_paciente, 
	LOCALTIMESTAMP dt_nascimento, 
	'' ie_sexo, 
	0 qt_altura_cm, 
	0 qt_peso, 
	'' ds_dado_clinico, 
	'' ds_observacao, 
	'' nr_amostra, 
	'' ds_exames, 
	'' ie_prioridade, 
	LOCALTIMESTAMP dt_coleta, 
	'' ds_material_exame 
FROM 	exame_laboratorio c, 
	prescr_medica b, 
	prescr_procedimento a 
where a.nr_seq_exame = c.nr_seq_exame 
 and a.nr_prescricao = b.nr_prescricao 
 and a.dt_integracao is null 
 and length(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;'||a.ds_material_especial, '\^^^',0)) > 0 

union
 
select	distinct 
	2 cd_tipo_registro, 
	a.nr_prescricao, 
	'2P' ie_linha, 
	'P' ie_tipo_linha, 
	'' ds_cabecalho, 
	'' dt_liberacao, 
	coalesce(b.cd_recem_nato,b.cd_pessoa_fisica), 
	'|' || obter_nome_pessoa_fisica(coalesce(b.cd_recem_nato,b.cd_pessoa_fisica),null) || '|' nm_paciente, 
	obter_nascimento_prescricao(b.nr_prescricao) dt_nascimento, 
	obter_sexo_prescricao(b.nr_prescricao) || '|||||||' ie_sexo, 
	b.qt_altura_cm, 
	b.qt_peso, 
	'|' || b.ds_dado_clinico, 
	'|' || b.ds_observacao || chr(3), 
	'' nr_amostra, 
	'' ds_exames, 
	'' ie_prioridade, 
	LOCALTIMESTAMP dt_coleta, 
	'' ds_material_exame 
from exame_laboratorio d, 
	prescr_medica b, 
	prescr_procedimento a 
where a.nr_prescricao = b.nr_prescricao 
 and a.nr_seq_exame = d.nr_seq_exame 
 and a.dt_integracao is null 
 and length(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;'||a.ds_material_especial, '\^^^',0)) > 0 

union
 
select	distinct 
	3 cd_tipo_registro, 
	a.nr_prescricao, 
	to_char(3 + lab_obter_seq_exame_shift(a.nr_prescricao, coalesce(a.ds_material_especial,a.cd_material_exame))) || 'O' ie_linha, 
	'O' ie_tipo_linha, 
	'' ds_cabecalho, 
	to_char(e.dt_liberacao,'dd/mm/yyyyhh24:mi:ss') || chr(3) dt_liberacao, 
	'' cd_pessoa_fisica, 
	'' nm_paciente, 
	LOCALTIMESTAMP dt_nascimento, 
	'' ie_sexo, 
	0 qt_altura_cm, 
	0 qt_peso, 
	'' ds_dado_clinico, 
	'' ds_observacao, 
	coalesce(d.cd_material_integracao, d.cd_material_exame) nr_amostra, 
	max('|^^^' || substr(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;' || a.ds_material_especial, '\^^^', 0),1, 
			length(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;' || a.ds_material_especial, '\^^^', 0)) - 4)) ds_exames, 
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END  ie_prioridade, 
	max(coalesce(b.dt_atualizacao, a.dt_coleta)) dt_coleta, 
	'||||||||' || coalesce(a.ds_material_especial,d.ds_material_exame) || chr(3) 
FROM prescr_medica e, material_exame_lab d, exame_laboratorio c, prescr_procedimento a
LEFT OUTER JOIN prescr_proc_etapa b ON (a.nr_prescricao = b.nr_prescricao AND a.nr_sequencia = b.nr_seq_prescricao AND 10 = b.ie_etapa)
WHERE a.nr_seq_exame = c.nr_seq_exame and a.cd_material_exame = d.cd_material_exame  and a.nr_prescricao = e.nr_prescricao   and a.dt_integracao is null and length(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;'||a.ds_material_especial, '\^^^',0)) > 0 group by to_char(e.dt_liberacao,'dd/mm/yyyyhh24:mi:ss'), 
	coalesce(d.cd_material_integracao, d.cd_material_exame), 
	CASE WHEN a.ie_urgencia='S' THEN  'U'  ELSE 'R' END , 
	coalesce(a.ds_material_especial,d.ds_material_exame), 
	a.nr_prescricao, 
	to_char(3 + lab_obter_seq_exame_shift(a.nr_prescricao, coalesce(a.ds_material_especial,a.cd_material_exame))) 

union
 
select	4 cd_tipo_registro, 
	a.nr_prescricao, 
	to_char(count(distinct coalesce(a.ds_material_especial,a.cd_material_exame)) + 3) || 'L|1|N' || chr(3) ie_linha, 
	'L' ie_tipo_linha, 
	'N' ds_cabecalho, 
	'' dt_liberacao, 
	'' cd_pessoa_fisica, 
	'' nm_paciente, 
	LOCALTIMESTAMP dt_nascimento, 
	'' ie_sexo, 
	0 qt_altura_cm, 
	0 qt_peso, 
	'' ds_dado_clinico, 
	'' ds_observacao, 
	'' nr_amostra, 
	'' ds_exames, 
	'' ie_prioridade, 
	LOCALTIMESTAMP dt_coleta, 
	'' ds_material_exame 
from 	exame_laboratorio c, 
	prescr_medica b, 
	prescr_procedimento a 
where a.nr_seq_exame = c.nr_seq_exame 
 and a.nr_prescricao = b.nr_prescricao 
 and a.dt_integracao is null 
 and length(obter_exames_prescr_lab(a.nr_prescricao, a.cd_setor_atendimento, a.cd_material_exame, null, null, 'CI;10;'||a.ds_material_especial, '\^^^',0)) > 0 
group by	a.nr_prescricao;

