-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_rps_prefeitura_jacarei_v (nr_sequencia, tp_registro, cd_serie_nf, nr_nota_fiscal, cd_natureza_operacao, dt_emissao, ie_iss_retido, cpf_cnpj_prestador, insc_mun_prestador, cd_mun_prestador, cd_cgc_tomador, nm_tomador, nm_fantasia_tomador, ds_endereco_tomador, ds_bairro_tomador, ds_municipio_tomador, sg_estado_tomador, cd_cep_tomador, cd_fone_tomador, ds_email_tomador, vl_pis, vl_cofins, vl_csll, vl_irrf, vl_inss, ds_iss, vl_iss, dt_emissao_rps, cd_serie_rps, cd_num_rps, ds_pais, nr_inscricao_estad_tomador, nr_inscricao_munic_tomador, cd_ativ_mun, qt_item_nf, ds_procedimento, vl_aliquota, vl_unitario_item_nf, ie_trib_serv, ie_servico_tributado, vl_desconto, nr_fatura, dt_vencimento, vl_fatura, dt_entrada_saida, cd_estabelecimento) AS Select	n.nr_sequencia									nr_sequencia,
	991										tp_registro, 
	lpad(substr(n.cd_serie_nf,1,2),2,0)						cd_serie_nf, 
	lpad(substr(n.nr_nota_fiscal,1,7),7,0)						nr_nota_fiscal, 
	lpad(substr(n.ie_nat_oper_rps,1,1),1,0)						cd_natureza_operacao, 
	n.dt_emissao									dt_emissao, 
	coalesce(CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='S' THEN 'S'  ELSE 'N' END ,' ')	ie_iss_retido, 
	rpad(substr(n.cd_cgc_emitente,1,14),14,' ')					cpf_cnpj_prestador, 
	lpad(substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM'),1,20),20,' ')	insc_mun_prestador, 
	lpad(003,3,0)									cd_mun_prestador, 
	rpad(substr(n.cd_cgc,1,14),14,' ')						cd_cgc_tomador, 
	rpad(substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,50),50,' ')		nm_tomador, 
	rpad(substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,50),50,' ')		nm_fantasia_tomador, 
	rpad(coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'E'),1,40)='N/D' THEN  						substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'E'),1,40) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'EN'),1,50) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)),50,' ')	ds_endereco_tomador, 
	rpad(coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'B'),1,20)='N/D' THEN  						 substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,20)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'B'),1,20) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'B'),1,20) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,20)),20,' ')	ds_bairro_tomador, 
	rpad(coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CI'),1,30)='N/D' THEN  						substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,30)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CI'),1,30) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CI'),1,30) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,30)),30,' ')	ds_municipio_tomador, 
	rpad(coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'UF'),1,2)=substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2) THEN  substr(obter_compl_pj(n.cd_cgc,1,'UF'),1,2) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'UF'),1,2) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2)),2,' ')	sg_estado_tomador, 
	lpad(coalesce(to_char(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,8)='N/D' THEN  							to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,8)))  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,8) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CEP'),1,8) END ), 
		to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,8)))),8,0)	cd_cep_tomador, 
	rpad(' ',10,' ')	cd_fone_tomador, 
	rpad(coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN substr(obter_dados_pf_pj_estab(n.cd_estabelecimento,n.cd_pessoa_fisica, n.cd_cgc, 'M'),1,50)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'M'),1,50) END ,''),50,' ')				ds_email_tomador,	 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V','PIS'),0), 12, 0) 				vl_pis, 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V','COFINS'),0), 12, 0)				vl_cofins, 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V','CSLL'),0), 12, 0)				vl_csll, 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V','IR'),0), 12, 0) 				vl_irrf, 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V','INSS'),0), 12, 0)				vl_inss, 
	lpad(' ',100,' ') 											ds_iss, 
	lpad(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS'),0),12,0)		 		vl_iss, 
	n.dt_emissao	 											dt_emissao_rps, 
	substr(n.cd_serie_rps,1,2)										cd_serie_rps, 
	lpad(n.nr_rps,10,0)											cd_num_rps, 
	rpad('Brasil',20,' ') 											ds_pais, 
	rpad(substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20),20,' ')						nr_inscricao_estad_tomador, 
	rpad(CASE WHEN elimina_acentuacao(elimina_caracteres_especiais(upper(substr(obter_dados_pf_pj(null,n.cd_cgc,'CI'),1,50))))='JACAREI' THEN  		substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,8)  ELSE '00000000' END ,20,' ')				nr_inscricao_munic_tomador, 
	rpad(' ',8,' ')												cd_ativ_mun, 
	lpad(0,6,0)												qt_item_nf, 
	lpad(' ',100,' ')											ds_procedimento, 
	lpad(0,5,0)												vl_aliquota, 
	lpad(0,12,0)												vl_unitario_item_nf, 
	' '													ie_trib_serv, 
	'S'													ie_servico_tributado, 
	lpad(0,12,0)												vl_desconto, 
	rpad(' ',10,' ')											nr_fatura, 
	null													dt_vencimento, 
	lpad(0,12,0)												vl_fatura, 
	n.dt_entrada_saida									dt_entrada_saida,	 
	n.cd_estabelecimento											cd_estabelecimento 
FROM	nota_fiscal n 
where	exists ( 
			select	1 
			from	w_nota_fiscal x 
			where	x.nr_seq_nota_fiscal = n.nr_sequencia) 

union
 
select	n.nr_sequencia										nr_sequencia, 
	992											tp_registro, 
	lpad(0,2,0)										cd_serie_nf, 
	lpad(substr(n.nr_nota_fiscal,1,7),7,0)			nr_nota_fiscal, 
	lpad(0,1,0)										cd_natureza_operacao, 
	n.dt_emissao										dt_emissao, 
	' '											ie_iss_retido, 
	rpad(' ',14,' ')									cpf_cnpj_prestador, 
	lpad(' ',20,' ')									insc_mun_prestador, 
	lpad(003,3,0)										cd_mun_prestador, 
	rpad(' ',14,' ')									cd_cgc_tomador, 
	rpad(' ',50,' ')									nm_tomador, 
	rpad(' ',50,' ')									nm_fantasia_tomador, 
	rpad(' ',50,' ')									ds_endereco_tomador, 
	rpad(' ',20,' ')									ds_bairro_tomador, 
	rpad(' ',30,' ')									ds_municipio_tomador, 
	' '											sg_estado_tomador, 
	lpad(0,8,0)										cd_cep_tomador, 
	rpad(' ',10,' ')									cd_fone_tomador, 
	rpad(' ',50,' ')									ds_email_tomador, 
	lpad(0, 12, 0)										vl_pis, 
	lpad(0, 12, 0)										vl_cofins, 
	lpad(0, 12, 0)										vl_csll, 
	lpad(0, 12, 0)										vl_irrf, 
	lpad(0, 12, 0)										vl_inss, 
	lpad(' ',100,' ') 									ds_iss, 
	lpad(0, 12, 0)										vl_iss, 
	LOCALTIMESTAMP											dt_emissao_rps, 
	lpad(0,2,0)										cd_serie_rps, 
	lpad(0,10,0)										cd_num_rps, 
	rpad('Brasil',20,' ')							 		ds_pais, 
	rpad(' ',20,' ')									nr_inscricao_estad_tomador, 
	rpad(' ',20,' ')									nr_inscricao_munic_tomador, 
	lpad(substr(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(n.nr_sequencia,'P'), obter_procedimento_nfse(n.nr_sequencia,'O')), 'CD'),1,8),8,' ') cd_ativ_mun, 
	lpad(replace(campo_mascara_virgula(i.qt_item_nf),',',''),6,0)				qt_item_nf, 
	rpad(substr(obter_descricao_procedimento(i.cd_procedimento,null),1,100),100,' ')	ds_procedimento, 
	lpad(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia,'X','ISS'),5,0)			vl_aliquota, 
	lpad(replace(replace(campo_mascara_virgula(i.vl_unitario_item_nf),',',''),'.',''),12,0)	vl_unitario_item_nf, 
	coalesce(CASE WHEN substr(obter_se_nf_retem_iss(i.nr_sequencia),1,1)='S' THEN 'S'  ELSE 'N' END ,' ')		ie_trib_serv, 
	'S'											ie_servico_tributado, 
	lpad(i.vl_desconto,12,0)								vl_desconto, 
	rpad(' ',10,' ')									nr_fatura, 
	null											dt_vencimento, 
	lpad(0,12,0)										vl_fatura, 
	n.dt_entrada_saida									dt_entrada_saida,	 
	i.cd_estabelecimento									cd_estabelecimento 
from	nota_fiscal n, 
	nota_fiscal_item i 
where	n.nr_sequencia = i.nr_sequencia 
and exists ( 
		select	1 
		from	w_nota_fiscal x 
		where	x.nr_seq_nota_fiscal = n.nr_sequencia) 

union
 
select	n.nr_sequencia										nr_sequencia, 
	993											tp_registro, 
	lpad(0,2,0)										cd_serie_nf, 
	lpad(substr(n.nr_nota_fiscal,1,7),7,0)			nr_nota_fiscal, 
	lpad(0,1,0)										cd_natureza_operacao, 
	n.dt_emissao										dt_emissao, 
	' '											ie_iss_retido, 
	rpad(' ',14,' ')									cpf_cnpj_prestador, 
	lpad(' ',20,' ')									insc_mun_prestador, 
	lpad(003,3,0)										cd_mun_prestador, 
	rpad(' ',14,' ')									cd_cgc_tomador, 
	rpad(' ',50,' ')									nm_tomador, 
	rpad(' ',50,' ')									nm_fantasia_tomador, 
	rpad(' ',50,' ')									ds_endereco_tomador, 
	rpad(' ',20,' ')									ds_bairro_tomador, 
	rpad(' ',30,' ')									ds_municipio_tomador, 
	' '											sg_estado_tomador, 
	lpad(0,8,0)										cd_cep_tomador, 
	rpad(' ',10,' ')									cd_fone_tomador, 
	rpad(' ',50,' ')									ds_email_tomador, 
	lpad(0, 12, 0)										vl_pis, 
	lpad(0, 12, 0)										vl_cofins, 
	lpad(0, 12, 0)										vl_csll, 
	lpad(0, 12, 0)										vl_irrf, 
	lpad(0, 12, 0)										vl_inss, 
	lpad(' ',100,' ') 									ds_iss, 
	lpad(0, 12, 0)										vl_iss, 
	LOCALTIMESTAMP											dt_emissao_rps, 
	lpad(0,2,0)										cd_serie_rps, 
	lpad(0,10,0)										cd_num_rps, 
	rpad('Brasil',20,' ')							 		ds_pais, 
	rpad(' ',20,' ')									nr_inscricao_estad_tomador, 
	rpad(' ',20,' ')									nr_inscricao_munic_tomador, 
	rpad(' ',8,' ')										cd_ativ_mun, 
	lpad(0,6,0)										qt_item_nf, 
	lpad(' ',100,' ')									ds_procedimento, 
	lpad(0,5,0)										vl_aliquota, 
	lpad(0,12,0)										vl_unitario_item_nf, 
	' '											ie_trib_serv, 
	'S'											ie_servico_tributado, 
	lpad(0,12,0)										vl_desconto, 
	rpad(' ',10,' ')									nr_fatura, 
	LOCALTIMESTAMP											dt_vencimento, 
	lpad(0,12,0)										vl_fatura, 
	n.dt_entrada_saida									dt_entrada_saida,	 
	n.cd_estabelecimento									cd_estabelecimento 
from	nota_fiscal n 
where	exists ( 
			select	1 
			from	w_nota_fiscal x 
			where	x.nr_seq_nota_fiscal = n.nr_sequencia);

