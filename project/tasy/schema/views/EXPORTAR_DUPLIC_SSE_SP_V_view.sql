-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exportar_duplic_sse_sp_v (tp_registro, nr_sequencia, dt_emissao, cd_estabelecimento, valor_registro) AS SELECT	1 																TP_REGISTRO,
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'COD_UNIDADE;DT_ENVIO;TIPO' 													VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
  
--Valor Cabecalho 
SELECT	2 																TP_REGISTRO, 
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	obter_dados_pf_pj_estab(a.cd_estabelecimento,null,a.cd_cgc,'ATIV')										||';'|| 
	to_char(LOCALTIMESTAMP,'yyyy-mm-dd') 														||';'|| 
	'DP' VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
 
--Texto Duplicata 
SELECT	4 																TP_REGISTRO, 
	0 																NR_SEQUENCIA, 
	null																DT_EMISSAO, 
	a.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	'NUMERO_NF;SERIE_NF;VALOR_NF;DT_EMISSAO;CNPJ;DUPLICATA;VALOR_DUPLICATA;DT_VENCIMENTO;VALOR_PAGO;DT_PAGAMENTO'			VALOR_REGISTRO 
FROM 	estabelecimento_v a 
WHERE	1 = 1 

UNION
  
--Valores Duplicata da Nota 
select 7 																	TP_REGISTRO, 
	n.nr_sequencia 															NR_SEQUENCIA, 
	t.dt_liquidacao															DT_EMISSAO, 
	n.cd_estabelecimento 														CD_ESTABELECIMENTO, 
	n.nr_nota_fiscal 															||';'|| 
	n.cd_serie_nf 															||';'|| 
	Campo_Mascara(n.vl_total_nota,2)													||';'|| 
	to_char(TRUNC(n.dt_emissao),'yyyy-mm-dd')												||';'|| 
	(SubStr(n.cd_cgc_emitente,1,2) || '.' ||SubStr(n.cd_cgc_emitente,3,3) || '.' ||SubStr(n.cd_cgc_emitente,6,3) || '/' ||SubStr(n.cd_cgc_emitente,9,4) || '-' ||SubStr(n.cd_cgc_emitente,13,2))	||';'|| 
	coalesce(CASE WHEN t.NR_PARCELAS=0 THEN 1  ELSE t.NR_PARCELAS END ,1) 											||';'|| 
	Campo_Mascara((t.vl_titulo)::numeric ,2)											   	||';'|| 
	to_char(TRUNC(T.dt_vencimento_atual),'yyyy-mm-dd')											||';'|| 
	Campo_Mascara((obter_valor_pago_tit_pagar(nr_titulo))::numeric ,2) 										||';'|| 
	to_char(TRUNC(t.dt_liquidacao),'yyyy-mm-dd')												VALOR_REGISTRO 
from 	nota_fiscal n, 
	nota_fiscal_venc v, 
	titulo_pagar t 
where 	v.nr_sequencia = n.nr_sequencia 
and   v.nr_sequencia = t.nr_seq_nota_fiscal 
and	t.dt_liquidacao is not null 
and (	select	count(*) 
		from	titulo_pagar p, 
			nota_fiscal_venc v 
		where 	v.nr_sequencia = n.nr_sequencia	 
		and	v.nr_sequencia = p.nr_seq_nota_fiscal 
		and	p.ie_situacao = 'L') > 1;

