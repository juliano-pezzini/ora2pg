-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_danamed_v (tp_registro, nr_seq_protocolo, dt_envio, cgc_prestador, nm_prestador, cd_especialidade, ds_especialidade, nr_atendimento, nr_doc_convenio, dt_entrada, nr_filial_prestador, cd_usuario_convenio, nm_paciente, nr_crm_medico_resp, filler, cd_procedimento, qt_procedimento, dt_mesano_referencia, vl_unitario_item, qt_filme, vl_filme, vl_total_item, qt_tot_itens, vl_tot_itens, nr_seq_proced_atend, qt_reg_tp1, qt_reg_tp2) AS select	0							tp_registro,
	a.NR_SEQ_PROTOCOLO					NR_SEQ_PROTOCOLO, 
	LOCALTIMESTAMP							dt_envio, 
	a.cd_cgc_hospital					cgc_prestador, 
	substr(obter_nome_pf_pj(null,a.cd_cgc_hospital),1,35)	nm_prestador, 
	(obter_conversao_externa(a.cd_cgc_convenio, 'INTERF_DANAMED_V', 'CD_ESPECIALIDADE', coalesce(b.cd_setor_atendimento,0)))::numeric  cd_especialidade,						 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,100)	ds_especialidade, 
	'00000000'						nr_atendimento, 
	' '							nr_doc_convenio, 
	LOCALTIMESTAMP							dt_entrada, 
	0							nr_filial_prestador, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	' '							nr_crm_medico_resp, 
	00							filler, 
	0							cd_procedimento, 
	0							qt_procedimento, 
	LOCALTIMESTAMP							dt_mesano_referencia, 
	0							vl_unitario_item, 
	0							qt_filme, 
	0							vl_filme, 
	0							vl_total_item, 
	0							qt_tot_itens, 
	0							vl_tot_itens, 
	0							NR_SEQ_PROCED_ATEND, 
	0							qt_reg_tp1, 
	0							qt_reg_tp2 
FROM	w_interf_conta_header a, 
	protocolo_convenio b 
where	a.nr_seq_protocolo = b.nr_seq_protocolo	 

union all
 
select	1							tp_registro, 
	b.NR_SEQ_PROTOCOLO					NR_SEQ_PROTOCOLO, 
	LOCALTIMESTAMP							dt_geracao, 
	' '							cgc_prestador, 
	' '							nm_prestador, 
	(obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_DANAMED_V', 'CD_ESPECIALIDADE', coalesce(b.cd_setor_atendimento,0)))::numeric  cd_especialidade, 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,100)	ds_especialidade, 
	substr(b.nr_atendimento,1,7)				nr_atendimento, 
	coalesce(substr(b.nr_doc_convenio,1,7),'000000')		nr_doc_convenio, 
	b.dt_entrada						dt_entrada, 
	0							nr_filial_prestador, 
	substr(b.cd_usuario_convenio,1,15)			cd_usuario_convenio, 
	substr(b.nm_paciente,1,40)				nm_paciente, 
	SUBSTR(b.nr_crm_medico_resp,1,6)			nr_crm_medico_resp, 
	00							filler, 
	0							cd_procedimento, 
	0							qt_procedimento, 
	LOCALTIMESTAMP							dt_mesano_referencia, 
	0							vl_unitario_item, 
	0							qt_filme, 
	0							vl_filme, 
	0							vl_total_item, 
	0							qt_tot_itens, 
	0							vl_tot_itens, 
	0							NR_SEQ_PROCED_ATEND, 
	0							qt_reg_tp1, 
	0							qt_reg_tp2 
from	w_interf_conta_cab	b 

union all
 
select	2							tp_registro, 
	b.NR_SEQ_PROTOCOLO					NR_SEQ_PROTOCOLO, 
	LOCALTIMESTAMP							dt_geracao, 
	' '							cgc_prestador, 
	' '							nm_prestador, 
	(obter_conversao_externa(b.cd_cgc_convenio, 'INTERF_DANAMED_V', 'CD_ESPECIALIDADE', coalesce(b.cd_setor_atendimento,0)))::numeric  cd_especialidade, 
	substr(obter_nome_setor(b.cd_setor_atendimento),1,100) 	ds_especialidade, 
	substr(b.nr_atendimento,1,7)				nr_atendimento, 
	coalesce(substr(b.nr_doc_convenio,1,7),'000000')		nr_doc_convenio, 
	b.dt_entrada						dt_entrada, 
	0							nr_filial_prestador, 
	substr(b.cd_usuario_convenio,1,15)			cd_usuario_convenio, 
	substr(b.nm_paciente,1,40)				nm_paciente, 
	b.nr_crm_medico_resp					nr_crm_medico_resp, 
	00							filler, 
	coalesce((a.cd_item_convenio)::numeric ,a.cd_item)		cd_procedimento, 
	a.qt_item						qt_procedimento, 
	LOCALTIMESTAMP							dt_mesano_referencia, 
	/*a.vl_unitario_item					vl_unitario_item,   OS 51746 */
 
	a.vl_total_item						vl_unitario_item, 
	a.qt_filme						qt_filme, 
	a.vl_filme						vl_filme, 
	a.vl_total_item						vl_total_item, 
	0							qt_tot_itens, 
	0							vl_tot_itens, 
	0							NR_SEQ_PROCED_ATEND, 
	0							qt_reg_tp1, 
	0							qt_reg_tp2 
from	w_interf_conta_cab	b, 
	w_interf_conta_item 	a 
where	a.nr_interno_conta	= b.nr_interno_conta 
and	a.ie_tipo_item		in (1,2) 

union all
 
select	9							tp_registro, 
	a.nr_seq_protocolo					NR_SEQ_PROTOCOLO, 
	LOCALTIMESTAMP							dt_geracao, 
	' '							cgc_prestador, 
	' '							nm_prestador, 
	0							cd_especialidade, 
	' '							ds_especialidade, 
	'99999999'						nr_atendimento, 
	' '							nr_doc_convenio, 
	LOCALTIMESTAMP							dt_entrada, 
	0							nr_filial_prestador, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	' '							nr_crm_medico_resp, 
	00							filler, 
	0							cd_procedimento, 
	0							qt_procedimento, 
	LOCALTIMESTAMP							dt_mesano_referencia, 
	0							vl_unitario_item, 
	0							qt_filme, 
	0							vl_filme, 
	0							vl_total_item, 
	sum(a.qt_item)						qt_tot_itens, 
	sum(a.vl_total_item)					vl_tot_itens, 
	0							NR_SEQ_PROCED_ATEND, 
	0							qt_reg_tp1, 
	0							qt_reg_tp2 
from	w_interf_conta_item 	a 
where	a.ie_tipo_item		in (1,2) 
group by 9, 
	a.nr_seq_protocolo;

