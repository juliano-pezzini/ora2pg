-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW consumo_ultimos_meses_v (cd_material, qt_consumo_mes3, qt_consumo_mes2, qt_consumo_mes1) AS select a.cd_material,
       sum(CASE WHEN a.dt_mesano_referencia=p.dt_mesano_relat THEN             CASE WHEN o.ie_consumo='A' THEN  a.qt_estoque WHEN o.ie_consumo='D' THEN  a.qt_estoque * -1  ELSE 0 END  END ) qt_consumo_Mes3,
       sum(CASE WHEN a.dt_mesano_referencia=ADD_MONTHS(p.dt_mesano_relat, -1) THEN             CASE WHEN o.ie_consumo='A' THEN  a.qt_estoque WHEN o.ie_consumo='D' THEN  a.qt_estoque * -1  ELSE 0 END  END ) qt_consumo_mes2,
       sum(CASE WHEN a.dt_mesano_referencia=ADD_MONTHS(p.dt_mesano_relat, -2) THEN             CASE WHEN o.ie_consumo='A' THEN  a.qt_estoque WHEN o.ie_consumo='D' THEN  a.qt_estoque * -1  ELSE 0 END  END ) qt_consumo_mes1
FROM   parametro_estoque p,
       operacao_estoque o,
       Resumo_movto_estoque a
where a.dt_mesano_referencia between ADD_MONTHS(p.dt_mesano_relat, -2) and p.dt_mesano_relat
  and a.cd_operacao_estoque = o.cd_operacao_estoque
group by a.cd_material;

