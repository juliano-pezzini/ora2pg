-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_qua_doc_treinamento_v (cd_indicador, dt_referencia, qt_min_real, cd_pessoa_trein, nm_pessoa_trein, cd_pessoa_resp, nm_pessoa_resp, ie_local, ds_local, cd_setor_pessoa_trein, ds_setor_pessoa_trein, qt_total, qt_min_previsto, qt_ausencia, qt_presenca, qt_ausencia_com_obs, qt_ausencia_sem_obs, nr_seq_tipo, ds_tipo_doc) AS select	1 cd_indicador,
	trunc(a.dt_prevista) dt_referencia, 
	sum(a.qt_tempo_real) qt_min_real, 
	b.cd_pessoa_fisica cd_pessoa_trein, 
	substr(obter_nome_pf(b.cd_pessoa_fisica),1,60) nm_pessoa_trein, 
	'' cd_pessoa_resp, 
	'' nm_pessoa_resp, 
	'' ie_local, 
	'' ds_local, 
	b.cd_setor_atendimento cd_setor_pessoa_trein, 
	substr(obter_desc_setor_atend(b.cd_setor_atendimento),1,100) ds_setor_pessoa_trein, 
	count(distinct a.nr_sequencia) qt_total, 
	sum(a.qt_tempo_previsto) qt_min_previsto, 
	sum(CASE WHEN b.ie_faltou='S' THEN 1  ELSE 0 END ) qt_ausencia, 
	sum(CASE WHEN b.ie_faltou='S' THEN 0  ELSE 1 END ) qt_presenca, 
	sum(CASE WHEN b.ie_faltou='S' THEN CASE WHEN b.ds_observacao IS NULL THEN 0  ELSE 1 END   ELSE 0 END ) qt_ausencia_com_obs, 
	sum(CASE WHEN b.ie_faltou='S' THEN CASE WHEN b.ds_observacao IS NULL THEN 1  ELSE 0 END   ELSE 0 END ) qt_ausencia_sem_obs, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc 
FROM	qua_tipo_doc d, 
	qua_documento c, 
	qua_doc_treinamento a, 
	qua_doc_trein_pessoa b 
where	a.nr_sequencia = b.nr_seq_treinamento 
and	a.nr_seq_documento = c.nr_sequencia 
and	c.nr_seq_tipo = d.nr_sequencia 
group by	b.cd_pessoa_fisica, 
	b.cd_setor_atendimento, 
	a.dt_prevista, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc 

union all
 
/* Pessoa Respons√°vel */
 
select	1 cd_indicador, 
	trunc(a.dt_prevista) dt_referencia, 
	sum(a.qt_tempo_real) qt_min_real, 
	'' cd_pessoa_trein, 
	'' nm_pessoa_trein, 
	b.cd_pessoa_resp cd_pessoa_resp, 
	substr(obter_nome_pf(b.cd_pessoa_resp),1,60) nm_pessoa_resp, 
	'' ie_local, 
	'' ds_local, 
	null cd_setor_pessoa_trein, 
	'' ds_setor_pessoa_trein, 
	count(distinct a.nr_sequencia) qt_total, 
	sum(a.qt_tempo_previsto) qt_min_previsto, 
	0 qt_ausencia, 
	1 qt_presenca, 
	0 qt_ausencia_com_obs, 
	0 qt_ausencia_sem_obs, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc 
from	qua_tipo_doc d, 
	qua_documento c, 
	qua_doc_treinamento a, 
	qua_doc_trein_resp b 
where	a.nr_sequencia = b.nr_seq_treinamento 
and	a.nr_seq_documento = c.nr_sequencia 
and	c.nr_seq_tipo = d.nr_sequencia 
group by	b.cd_pessoa_resp, 
	a.dt_prevista, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc 

union all
 
/* Tipo de Local */
 
select	1 cd_indicador, 
	trunc(a.dt_prevista) dt_referencia, 
	sum(a.qt_tempo_real) qt_min_real, 
	'' cd_pessoa_trein, 
	'' nm_pessoa_trein, 
	'' cd_pessoa_resp, 
	'' nm_pessoa_resp, 
	coalesce(a.ie_interno_externo,'I') ie_local, 
	CASE WHEN a.ie_interno_externo='E' THEN 'Externo'  ELSE 'Interno' END  ds_local, 
	null cd_setor_pessoa_trein, 
	'' ds_setor_pessoa_trein, 
	count(distinct a.nr_sequencia) qt_total, 
	sum(a.qt_tempo_previsto) qt_min_previsto, 
	sum(CASE WHEN b.ie_faltou='S' THEN 1  ELSE 0 END ) qt_ausencia, 
	sum(CASE WHEN b.ie_faltou IS NULL THEN 0  ELSE CASE WHEN b.ie_faltou='S' THEN 0  ELSE 1 END  END ) qt_presenca, 
	sum(CASE WHEN b.ie_faltou='S' THEN CASE WHEN b.ds_observacao IS NULL THEN 0  ELSE 1 END   ELSE 0 END ) qt_ausencia_com_obs, 
	sum(CASE WHEN b.ie_faltou='S' THEN CASE WHEN b.ds_observacao IS NULL THEN 1  ELSE 0 END   ELSE 0 END ) qt_ausencia_sem_obs, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc 
FROM qua_tipo_doc d, qua_documento c, qua_doc_treinamento a
LEFT OUTER JOIN qua_doc_trein_pessoa b ON (a.nr_sequencia = b.nr_seq_treinamento)
WHERE a.nr_seq_documento = c.nr_sequencia and c.nr_seq_tipo = d.nr_sequencia group by	a.ie_interno_externo, 
	a.dt_prevista, 
	c.nr_seq_tipo, 
	d.ds_tipo_doc;

