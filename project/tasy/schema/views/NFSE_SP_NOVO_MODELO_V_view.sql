-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nfse_sp_novo_modelo_v (assinatura, nr_seq_nota, inscricaoprestador, serierps, numerorps, tiporps, dataemissao, statusrps, tributacaorps, valorservicos, valordeducoes, valorpis, valorcofins, valorinss, valorir, valorcsll, codigoservico, aliquotaservicos, issretido, inscricaomunicipaltomador, inscricaoestadualtomador, razaosocialtomador, tipologradouro, logradouro, numeroendereco, complementoendereco, bairro, cidade, uf, cep, emailtomador, inscricaomunicipalintermed, issretidointermediario, emailintermediario, discriminacao, nr_seq_transmissao) AS select	cd_assinatura_rps Assinatura, 	
		a.nr_sequencia nr_seq_nota,
		coalesce(substr(lpad(obter_dados_pf_pj('',a.cd_cgc_emitente,'IM'),8,'0'),1,30),'00000000') InscricaoPrestador,
		a.cd_serie_nf SerieRPS,
		a.nr_nota_fiscal NumeroRPS,
		'RPS' TipoRPS,
		to_char(a.dt_emissao,'yyyy-mm-dd') DataEmissao,
		CASE WHEN a.ie_situacao=1 THEN 'N' WHEN a.ie_situacao=2 THEN 'C' WHEN a.ie_situacao=3 THEN 'C'  ELSE 'N' END  StatusRPS,
			CASE WHEN obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') IS NULL THEN CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END   ELSE obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') END  TributacaoRPS,
		campo_mascara((a.vl_mercadoria - a.vl_descontos),2) ValorServicos,
		campo_mascara(0,2) ValorDeducoes,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','PIS') END ,2)  ValorPIS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','COFINS') END ,2) ValorCOFINS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','INSS') END ,2) ValorINSS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','IR') END ,2) ValorIR,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia,'V','CSLL') END ,2)  ValorCSLL,	
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),5,'0'),1,5) CodigoServico,	
		campo_mascara(CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISSST')=0 THEN  CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISS')=0 THEN  2  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISS') END   ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISSST') END /100, 2) AliquotaServicos,
		CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN 'true'  ELSE 'false' END  ISSRetido,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(lpad(obter_dados_nfse_sp(cd_pessoa_fisica,cd_cgc,'IM'),8,'0'),1,30) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','IM')  ELSE null END  InscricaoMunicipalTomador,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica,cd_cgc,'IE'),1,19) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','IE')  ELSE null END  InscricaoEstadualTomador,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(nfe_elimina_caractere_especial(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc)),1,255) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','RS')  ELSE null END  RazaoSocialTomador,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN coalesce(obter_logr_abreviado_sp(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'LO')),'Rua') WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','TL')  ELSE null END  TipoLogradouro,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'LG') ,1,50) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','L')  ELSE null END  Logradouro,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'NR'),1,25) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','NE')  ELSE null END  NumeroEndereco,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'COM'),1,30) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','CE')  ELSE null END  ComplementoEndereco,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'BAI'),1,30) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','B')  ELSE null END  Bairro,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'CID'),1,7) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','C')  ELSE null END  Cidade,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'UF'),1,2) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','UF')  ELSE null END  UF,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN lpad(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'CEP'),8,'0') WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','CEP')  ELSE null END  CEP,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='S' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'EML'),1,75) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','ET')  ELSE null END  EmailTomador,
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='N' THEN substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'N','II'),1,8) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'C','II'),1,8)  ELSE substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'N','II'),1,8) END InscricaoMunicipalIntermed,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null  ELSE coalesce(CASE WHEN fis_obter_dados_intermediario(a.nr_sequencia,'S','RI')='S' THEN 'true'  ELSE 'false' END ,'false') END  ISSRetidoIntermediario,	
		CASE WHEN obter_se_tomador_intermed(a.nr_sequencia)='N' THEN substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'N','EI'),1,75) WHEN obter_se_tomador_intermed(a.nr_sequencia)='C' THEN substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'C','EI'),1,75)  ELSE substr(nfse_obter_dados_sp_intermed(a.nr_sequencia,'N','EI'),1,75) END  EmailIntermediario,
		coalesce(substr(obter_descricao_rps(a.cd_estabelecimento,a.nr_sequencia,'DS_SERVICOS'),1,1000),'Servicos') Discriminacao,
		t.nr_sequencia nr_seq_transmissao
	FROM	nota_fiscal_lote_nfe l,
		nfe_transmissao_nf n,
		nfe_transmissao t,
		nota_fiscal a
	where	l.nr_seq_transmissao = t.nr_sequencia
	and	t.nr_sequencia	= n.nr_seq_transmissao
	and	a.nr_sequencia = n.nr_seq_nota_fiscal
	and	l.nr_sequencia = (select max(nr_sequencia) from nota_fiscal_lote_nfe f where f.nr_seq_transmissao = t.nr_sequencia)
	order by a.nr_nota_fiscal;

