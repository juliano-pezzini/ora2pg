-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW grafico_burndown_port_v (nr_seq_portifolio, dt_ref, qt_hr_previstas, qt_hr_residuais) AS select	r.nr_seq_portifolio,
		r.dt_ref,
		(r.qt_hr_prev_acu - r.qt_horas_prev) qt_hr_previstas,
	  case
		when(r.qt_hr_cron = r.qt_hr_real_acu)
		  and (r.qt_horas_real = 0)
		  and r.dt_ref < trunc(LOCALTIMESTAMP)
		  then r.qt_hr_cron
		when(r.qt_hr_cron = r.qt_hr_real_acu)
		  and (r.qt_horas_real > 0)
		  and r.dt_ref < trunc(LOCALTIMESTAMP)
		  then r.qt_hr_real_acu - r.qt_horas_real
		when(r.qt_hr_cron <> r.qt_hr_real_acu)
		  and (r.qt_horas_real = 0)
		  and r.dt_ref < trunc(LOCALTIMESTAMP)
		  then r.qt_hr_real_acu - r.qt_horas_real
		when(r.qt_hr_cron <> r.qt_hr_real_acu)
		  and (r.qt_horas_real > 0)
		  and r.dt_ref < trunc(LOCALTIMESTAMP)
		  then r.qt_hr_real_acu - r.qt_horas_real
		else 0
		end qt_hr_residuais
	FROM (
	  select t.*
		,coalesce((
			select (max(c1.qt_total_horas) - sum(e1.qt_hora_prev)) qt_hr_prev_acu
			from 	proj_portifolio pf,
					proj_programa pr,
					proj_projeto p1,
					proj_cronograma c1,
					proj_cron_etapa e1
			where  	pf.nr_sequencia = pr.nr_seq_portifolio
			  and 	pr.nr_sequencia = p1.nr_seq_programa
			  and 	p1.nr_sequencia = c1.nr_seq_proj
			  and 	c1.nr_sequencia = e1.nr_seq_cronograma
			  and 	c1.ie_situacao = 'A'
			  and 	pf.nr_sequencia = t.nr_seq_portifolio
			  and 	e1.ie_fase = 'N'
			  and 	c1.ie_classificacao = 'D'
			  and 	c1.ie_tipo_cronograma = 'E'
			  and  	not exists (select 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e1.nr_sequencia)
			  and 	e1.dt_fim_prev < t.dt_ref
			group by pf.nr_sequencia
			), t.qt_hr_cron) qt_hr_prev_acu
		,coalesce((
			select (max(c1.qt_total_horas) - sum(e1.qt_hora_prev)) qt_hr_real_acu
			from 	proj_portifolio pf,
					proj_programa pr,
					proj_projeto p1,
					proj_cronograma c1,
					proj_cron_etapa e1
			where   pf.nr_sequencia = pr.nr_seq_portifolio
			  and 	pr.nr_sequencia = p1.nr_seq_programa
			  and	p1.nr_sequencia = c1.nr_seq_proj
			  and 	c1.nr_sequencia = e1.nr_seq_cronograma
			  and 	c1.ie_situacao = 'A'
			  and 	pf.nr_sequencia = t.nr_seq_portifolio
			  and 	e1.ie_fase = 'N'
			  and 	c1.ie_classificacao = 'D'
			  and  	not exists (select 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e1.nr_sequencia)
			  and 	c1.ie_tipo_cronograma = 'E'
			  and 	e1.dt_fim_real < t.dt_ref
			group by pf.nr_sequencia
			), t.qt_hr_cron) qt_hr_real_acu
	  from (
		select	q.nr_seq_portifolio,
				q.dt_ref,
				sum(q.qt_horas_prev) qt_horas_prev,
				sum(q.qt_horas_real) qt_horas_real,
				q.qt_hr_cron
		from (
			select	pr.nr_seq_portifolio,
					coalesce(trunc(e.dt_fim_prev), LOCALTIMESTAMP) dt_ref,
					sum(e.qt_hora_prev) qt_horas_prev,
					sum(0) qt_horas_real,
					max(c.qt_total_horas) qt_hr_cron
			from 	proj_portifolio pf,
					proj_programa pr,
					proj_projeto p,
					proj_cronograma c,
					proj_cron_etapa e
			where 	pf.nr_sequencia = pr.nr_seq_portifolio
			and 	pr.nr_sequencia = p.nr_seq_programa
			and 	p.nr_sequencia = c.nr_seq_proj
			and 	c.nr_sequencia = e.nr_seq_cronograma
			and	 	c.ie_situacao = 'A'
			and 	c.ie_classificacao = 'D'
			and		c.ie_tipo_cronograma = 'E'
			and		not exists (select 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
			and 	e.ie_fase = 'N'
		  group by 	pr.nr_seq_portifolio,
					trunc(e.dt_fim_prev)
		
union all

			select	pr.nr_seq_portifolio,
					coalesce(trunc(e.dt_fim_real), LOCALTIMESTAMP) dt_ref,
					sum(0) qt_horas_prev,
					sum(e.qt_hora_prev) qt_horas_real,
					max(c.qt_total_horas) qt_hr_cron
			from	proj_portifolio pf,
					proj_programa pr,
					proj_projeto p,
					proj_cronograma c,
					proj_cron_etapa e
			where	pf.nr_sequencia = pr.nr_seq_portifolio
			and 	pr.nr_sequencia = p.nr_seq_programa
			and 	p.nr_sequencia = c.nr_seq_proj
			and 	c.nr_sequencia = e.nr_seq_cronograma
			and 	c.ie_situacao = 'A'
			and 	c.ie_classificacao = 'D'
			and  	not exists (select 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia)
			and 	c.ie_tipo_cronograma = 'E'
			and 	e.ie_fase = 'N'
			and 	e.dt_fim_real is not null
		  group by	pr.nr_seq_portifolio,
					trunc(e.dt_fim_real)
		  ) q
		group by q.nr_seq_portifolio,
		    q.dt_ref,
			q.qt_hr_cron
		order by 2
		) t
	  ) r;

