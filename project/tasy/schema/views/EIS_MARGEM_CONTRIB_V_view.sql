-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_margem_contrib_v (cd_estabelecimento, nr_interno_conta, dt_ref_fat, ie_tipo_atend, cd_convenio, ie_clinica, cd_medico, cd_procedimento, ie_origem_proced, cd_categoria_parametro, ds_tipo_atend, ds_convenio, ds_clinica, nm_medico, ds_procedimento, ie_tipo_procedimento, ds_tipo_procedimento, ds_categoria, cd_pessoa_fisica, nm_paciente, ds_plano, vl_receita, vl_custo_variavel, vl_desp_variavel, vl_margem_contrib, vl_total_custo, vl_receita_bruta, vl_margem_rec_bruta, vl_repasse_calc, vl_faturado_calc, nr_atendimento, dt_alta, dt_entrada) AS select	a.cd_estabelecimento,
	a.nr_interno_conta, 
	a.dt_ref_fat, 
	a.ie_tipo_atend, 
	a.cd_convenio, 
	a.ie_clinica, 
	a.cd_medico, 
	a.cd_procedimento, 
	a.ie_origem_proced, 
	b.cd_categoria_parametro, 
	substr(obter_valor_dominio(12, a.ie_tipo_atend),1,200) ds_tipo_atend, 
	substr(obter_nome_convenio(a.cd_convenio),1,200) ds_convenio, 
	substr(obter_valor_dominio(17, a.ie_clinica),1,200) ds_clinica, 
	substr(obter_nome_pf(a.cd_medico),1,60) nm_medico, 
	substr(CASE WHEN coalesce(cd_procedimento,0)=0 THEN ''  ELSE obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced) END ,1,255) ds_procedimento, 
	somente_numero(Obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C')) ie_tipo_procedimento, 
	substr(Obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'D'),1,200) ds_tipo_procedimento, 
	substr(obter_nome_convenio(a.cd_convenio) || ' - ' || obter_categoria_convenio(a.cd_convenio, b.cd_categoria_parametro),1,200) ds_categoria, 
	substr(Obter_Pessoa_Conta(a.nr_interno_conta, 'C') || ' - ' || b.nr_atendimento,1,100) cd_pessoa_fisica, 
	substr(Obter_Pessoa_Conta(a.nr_interno_conta, 'N') || ' - ' || b.nr_atendimento,1,100) nm_paciente, 
	substr(obter_nome_convenio(a.cd_convenio) || ' - ' || obter_plano_convenio_atend(b.nr_atendimento, 'D'),1,200) ds_plano, 
	a.vl_receita, 
	a.vl_custo_variavel, 
	a.vl_desp_variavel, 
	a.vl_margem_contrib, 
	(a.vl_custo_variavel + a.vl_desp_variavel) vl_total_custo, 
	a.vl_receita_bruta, 
	(a.vl_receita_bruta - a.vl_custo_variavel -	a.vl_desp_variavel) vl_margem_rec_bruta, 
	vl_repasse_calc, 
	vl_faturado_calc, 
	b.nr_atendimento, 
	a.dt_alta, 
	a.dt_entrada 
FROM	conta_paciente b, 
	eis_margem_contrib a 
where	a.nr_interno_conta	= b.nr_interno_conta;

