-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW protocolo_convenio_item_v4 (nr_atendimento, ie_proc_mat, dt_conta, dt_item, cd_item, cd_item_convenio, qt_item, vl_item, vl_medico, vl_anestesista, vl_filme, vl_auxiliares, vl_custo_operacional, nr_interno_conta, nr_conta_convenio, dt_acerto_conta, dt_acerto_convenio, cd_convenio, cd_categoria, cd_setor_atendimento, ds_item, tp_item, cd_subgrupo_item, ds_subgrupo_item, ds_unidade, cd_motivo_exc_conta, nr_protocolo, nr_seq_protocolo, cd_convenio_protocolo, dt_mesano_protocolo, cd_convenio_parametro, dt_mesano_referencia, dt_periodo_inicial, dt_periodo_final, ie_status_acerto, ie_cancelamento, cd_autorizacao, nr_sequencia, nr_prescricao, nr_sequencia_prescricao, cd_medico_executor, nr_lote_contabil, ie_funcao_medico, ie_origem_proced, ie_tipo_servico_sus, nr_seq_proc_pacote, cd_cgc_prestador, nr_seq_apresent, tx_procedimento, ie_status_protocolo, dt_vencimento, ie_video, cd_grupo_proc, dt_entrega_convenio, cd_tipo_item, nr_seq_proc_interno, cd_estabelecimento, ie_emite_conta, cd_categoria_parametro, cd_especialidade, nr_seq_bras_preco) AS SELECT	A.NR_ATENDIMENTO,
	1 IE_PROC_MAT, 
	A.DT_CONTA, 
	A.DT_PROCEDIMENTO   	DT_ITEM, 
	A.CD_PROCEDIMENTO   	CD_ITEM, 
	A.CD_PROCEDIMENTO_CONVENIO  CD_ITEM_CONVENIO, 
	A.QT_PROCEDIMENTO   	QT_ITEM, 
	A.VL_PROCEDIMENTO   	VL_ITEM, 
	A.VL_MEDICO      	VL_MEDICO, 
	A.VL_ANESTESISTA    	VL_ANESTESISTA, 
	A.VL_MATERIAIS     	VL_FILME, 
	A.VL_AUXILIARES    	VL_AUXILIARES, 
	A.VL_CUSTO_OPERACIONAL 	VL_CUSTO_OPERACIONAL, 
    	A.NR_INTERNO_CONTA, 
	B.NR_CONTA_CONVENIO, 
    	A.DT_ACERTO_CONTA, 
    	A.DT_ACERTO_CONVENIO, 
    	A.CD_CONVENIO, 
    	A.CD_CATEGORIA, 
    	A.CD_SETOR_ATENDIMENTO, 
    	C.DS_PROCEDIMENTO   	DS_ITEM, 
    	C.IE_CLASSIFICACAO   	TP_ITEM     /* 1-AMB 2-SERVICOS 3-DIARIAS */
, 
	C.IE_CLASSIFICACAO CD_SUBGRUPO_ITEM, 
    	CASE WHEN C.IE_CLASSIFICACAO=1 THEN 'Procedimentos Médicos' WHEN C.IE_CLASSIFICACAO=2 THEN 'Servicos Hospitalares'  ELSE 'Diarias' END  DS_SUBGRUPO_ITEM, 
    	'Un' DS_UNIDADE, 
    	A.CD_MOTIVO_EXC_CONTA, 
	D.NR_PROTOCOLO, 
	D.NR_SEQ_PROTOCOLO, 
	D.CD_CONVENIO	CD_CONVENIO_PROTOCOLO, 
    	D.DT_MESANO_REFERENCIA DT_MESANO_PROTOCOLO, 
	B.CD_CONVENIO_PARAMETRO, 
    	B.DT_MESANO_REFERENCIA, 
    	B.DT_PERIODO_INICIAL, 
    	B.DT_PERIODO_FINAL, 
	B.IE_STATUS_ACERTO, 
	B.IE_CANCELAMENTO, 
	A.NR_DOC_CONVENIO CD_AUTORIZACAO, 
	A.NR_SEQUENCIA, 
	A.NR_PRESCRICAO, 
	A.NR_SEQUENCIA_PRESCRICAO, 
	A.CD_MEDICO_EXECUTOR	CD_MEDICO_EXECUTOR, 
	A.NR_LOTE_CONTABIL, 
	A.IE_FUNCAO_MEDICO IE_FUNCAO_MEDICO, 
	A.IE_ORIGEM_PROCED, 
	A.IE_TIPO_SERVICO_SUS, 
	A.NR_SEQ_PROC_PACOTE, 
	A.CD_CGC_PRESTADOR CD_CGC_PRESTADOR, 
	B.NR_SEQ_APRESENT, 
	coalesce(A.TX_PROCEDIMENTO,100) TX_PROCEDIMENTO, 
	D.IE_STATUS_PROTOCOLO, 
	D.DT_VENCIMENTO, 
	A.ie_video, 
	C.CD_GRUPO_PROC, 
	D.dt_entrega_convenio, 
	C.cd_tipo_procedimento cd_tipo_item, 
	A.nr_seq_proc_interno, 
	B.cd_estabelecimento, 
	A.ie_emite_conta, 
	B.CD_CATEGORIA_PARAMETRO, 
	A.cd_especialidade, 
	null nr_seq_bras_preco 
FROM  	PROCEDIMENTO C, 
	PROCEDIMENTO_PACIENTE A, 
	CONTA_PACIENTE B, 
	PROTOCOLO_CONVENIO D 
WHERE	D.NR_SEQ_PROTOCOLO	= B.NR_SEQ_PROTOCOLO 
AND	A.CD_MOTIVO_EXC_CONTA IS NULL 
AND	A.CD_PROCEDIMENTO    = C.CD_PROCEDIMENTO 
AND 	A.IE_ORIGEM_PROCED   = C.IE_ORIGEM_PROCED 
AND	A.NR_INTERNO_CONTA  	= B.NR_INTERNO_CONTA 

UNION ALL
 
SELECT	X.NR_ATENDIMENTO, 
    	2 IE_PROC_MAT, 
    	X.DT_CONTA, 
    	X.DT_ATENDIMENTO    	DT_ITEM, 
    	X.CD_MATERIAL     	CD_ITEM, 
    	X.CD_MATERIAL_CONVENIO	CD_ITEM_CONVENIO, 
    	X.QT_MATERIAL     	QT_ITEM, 
    	(select CASE WHEN Obter_Tipo_Convenio(z.cd_convenio)=3 THEN 0  ELSE X.VL_MATERIAL END  ) VL_ITEM, 
    	0           	VL_MEDICO, 
    	0           	VL_ANESTESISTA, 
    	0           	VL_FILME, 
    	0           	VL_AUXILIARES, 
    	0           	VL_CUSTO_OPERACIONAL, 
    	X.NR_INTERNO_CONTA, 
	Y.NR_CONTA_CONVENIO, 
    	X.DT_ACERTO_CONTA, 
    	X.DT_ACERTO_CONVENIO, 
    	X.CD_CONVENIO, 
    	X.CD_CATEGORIA, 
    	X.CD_SETOR_ATENDIMENTO, 
    	W.DS_MATERIAL     DS_ITEM, 
    	CASE WHEN W.IE_TIPO_MATERIAL=1 THEN '1' WHEN W.IE_TIPO_MATERIAL=2 THEN '2' WHEN W.IE_TIPO_MATERIAL=3 THEN '2'  ELSE '5' END    TP_ITEM    /* 1-MATERIAL 2-MED.GENERICO 3-MED.COMERC. */
, 
	IE_TIPO_MATERIAL CD_SUBGRUPO_ITEM, 
    	CASE WHEN IE_TIPO_MATERIAL=1 THEN 'Materiais' WHEN IE_TIPO_MATERIAL=2 THEN 'Medicamentos (Comercial)' WHEN IE_TIPO_MATERIAL=3 THEN 'Medicamentos (Genérico)'  ELSE 'Extras' END  DS_SUBGRUPO_ITEM, 
    	substr(obter_dados_material_estab(x.cd_material,y.cd_estabelecimento,'UMS'),1,30) DS_UNIDADE, 
    	X.CD_MOTIVO_EXC_CONTA, 
	Z.NR_PROTOCOLO, 
	Z.NR_SEQ_PROTOCOLO, 
	Z.CD_CONVENIO CD_CONVENIO_PROTOCOLO, 
    	Z.DT_MESANO_REFERENCIA DT_MESANO_PROTOCOLO, 
	Y.CD_CONVENIO_PARAMETRO, 
    	Y.DT_MESANO_REFERENCIA, 
    	Y.DT_PERIODO_INICIAL, 
    	Y.DT_PERIODO_FINAL, 
	Y.IE_STATUS_ACERTO, 
	Y.IE_CANCELAMENTO, 
	X.NR_DOC_CONVENIO CD_AUTORIZACAO, 
	X.NR_SEQUENCIA, 
	X.NR_PRESCRICAO, 
	X.NR_SEQUENCIA_PRESCRICAO, 
	'' CD_MEDICO_EXECUTOR, 
	X.NR_LOTE_CONTABIL, 
	'' IE_FUNCAO_MEDICO, 
	0 IE_ORIGEM_PROCED, 
	0 IE_TIPO_SERVICO_SUS, 
	X.NR_SEQ_PROC_PACOTE, 
	'' CD_CGC_PRESTADOR, 
	Y.NR_SEQ_APRESENT, 
	100 TX_PROCEDIMENTO, 
	Z.IE_STATUS_PROTOCOLO, 
	Z.DT_VENCIMENTO, 
	'N', 0, 
	z.dt_entrega_convenio, 
	0, 
	0, 
	y.cd_estabelecimento, 
	x.ie_emite_conta, 
	Y.CD_CATEGORIA_PARAMETRO, 
	0 cd_especialidade, 
	x.nr_seq_bras_preco 
FROM  	MATERIAL W, 
	MATERIAL_ATEND_PACIENTE X, 
	CONTA_PACIENTE Y, 
	PROTOCOLO_CONVENIO Z 
WHERE 	Z.NR_SEQ_PROTOCOLO = Y.NR_SEQ_PROTOCOLO 
AND	X.CD_MOTIVO_EXC_CONTA IS NULL 
AND 	X.CD_MATERIAL   = W.CD_MATERIAL 
AND 	X.NR_INTERNO_CONTA = Y.NR_INTERNO_CONTA;

