-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_nossa_saude_v (tp_registro, nr_seq_protocolo, nm_hospital, cd_cgc_hospital, dt_arquivo, ds_remessa, cd_autorizacao, ds_senha, cd_usuario_convenio, nm_paciente, dt_nascimento, ie_sexo, cd_pessoa_fisica, cd_cid_princ, cd_edicao_amb, nr_crm, nm_medico, nr_crm_auxiliar, dt_hr_atendimento, ie_tipo_atendimento, dt_hr_termino_atend, ie_carater_inter, dt_hr_cirurgia, qt_dia_atendimento, cd_acomod_abramge, ie_clinica, ie_tipo_nascimento, cd_motivo_alta, cd_tipo_despesa, cd_setor_despesa, ie_tipo_prestador, nr_crm_prestador, cd_prestador, nm_prestador, cd_item, qt_item, ds_unid_consumo, qt_filme, vl_unitario, vl_tot_proced, vl_filme, vl_total_despesa, ie_vl_adicional, ie_tipo_escala, cd_funcao_executor, nr_ordem_cirurgia, ie_via_acesso, nr_interno_conta, ds_item, ie_result_exame, hr_execucao, cd_brasindice, cd_simpro, vl_01, vl_02, vl_03, vl_04, vl_05, branco, vl_tot_honorarios, vl_tot_tx_diaria, vl_tot_mat_medic, vl_tot_geral, qt_total_atend, vl_total_atend) AS select	01							tp_registro,
	c.nr_seq_protocolo					nr_seq_protocolo, 
	substr(elimina_acentuacao(upper(c.nm_hospital)),1,40)	nm_hospital, 
	c.cd_cgc_hospital 					cd_cgc_hospital, 
	c.dt_remessa						dt_arquivo, 
	'REMESSA'						ds_remessa, 
	' '							cd_autorizacao, 
	' '							ds_senha, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	LOCALTIMESTAMP							dt_nascimento, 
	' '							ie_sexo, 
	' '							cd_pessoa_fisica, 
	' '							cd_cid_princ, 
	' '							cd_edicao_amb, 
	' '							nr_crm, 
	' '							nm_medico, 
	' '							nr_crm_auxiliar, 
	' '							dt_hr_atendimento, 
	0							ie_tipo_atendimento, 
	' '							dt_hr_termino_atend, 
	' '							ie_carater_inter, 
	' '							dt_hr_cirurgia, 
	0							qt_dia_atendimento, 
	0							cd_acomod_abramge, 
	0							ie_clinica, 
	' '							ie_tipo_nascimento, 
	0							cd_motivo_alta, 
	0							cd_tipo_despesa, 
	0							cd_setor_despesa, 
	' '							ie_tipo_prestador, 
	' '							nr_crm_prestador, 
	' '							cd_prestador, 
	' '							nm_prestador, 
	0							cd_item, 
	0							qt_item, 
	' '							ds_unid_consumo, 
	0							qt_filme, 
	0							vl_unitario, 
	0							vl_tot_proced, 
	0							vl_filme, 
	0							vl_total_despesa, 
	' '							ie_vl_adicional, 
	0							ie_tipo_escala, 
	0							cd_funcao_executor, 
	0							nr_ordem_cirurgia, 
	0							ie_via_acesso, 
	0							nr_interno_conta, 
	' '							ds_item, 
	' '							ie_result_exame, 
	to_char(LOCALTIMESTAMP,'hh24:mi')				hr_execucao, 
	' '							cd_brasindice, 
	0							cd_simpro, 
	0							vl_01, 
	0							vl_02, 
	0							vl_03, 
	0							vl_04, 
	0							vl_05, 
	' '							branco, 
	0							vl_tot_honorarios, 
	0							vl_tot_tx_diaria, 
	0							vl_tot_mat_medic, 
	0							vl_tot_geral, 
	0							qt_total_atend, 
	0							vl_total_atend 
FROM	w_interf_conta_header c 

union all
 
select	10							tp_registro, 
	b.nr_seq_protocolo					nr_seq_protocolo, 
	' ' 							nm_hospital, 
	' ' 							cd_cgc_hospital, 
	LOCALTIMESTAMP							dt_arquivo, 
	' '							ds_remessa, 
	substr(to_char(somente_numero(coalesce(c.cd_autorizacao, OBTER_GUIA_CONVENIO(c.nr_atendimento)))),1,16) cd_autorizacao, 
	substr(b.cd_senha_guia,1,16)				ds_senha, 
	substr(b.cd_usuario_convenio,1,17)			cd_usuario_convenio, 
	substr(b.nm_paciente,1,40)				nm_paciente, 
	b.dt_nascimento						dt_nascimento, 
	b.ie_sexo						ie_sexo, 
	b.cd_paciente						cd_pessoa_fisica,	 
	substr(b.cd_cid_principal,1,6)				cd_cid_princ, 
	coalesce(b.cd_proc_principal,' ')				cd_edicao_amb, 
	coalesce(b.nr_crm_medico_resp,' ')				nr_crm, 
	substr(b.nm_medico_resp,1,40)				nm_medico, 
	substr(obter_nome_medico(b.cd_medico_resp,'C'),1,5)	nr_crm_auxiliar, 
	to_char(b.dt_entrada, 'ddmmyyhh24miss') 	dt_hr_atendimento, 
	b.ie_tipo_atendimento					ie_tipo_atendimento, 
	to_char(b.dt_alta,'ddmmyyhh24miss') 		dt_hr_termino_atend, 
	b.ie_carater_inter					ie_carater_inter, 
	to_char(obter_data_cirurgia(b.cd_paciente),'ddmmyyhh24miss') dt_hr_cirurgia, 
	b.qt_dia_internacao					qt_dia_atendimento, 
	b.cd_tipo_acomodacao					cd_acomod_abramge, 
	b.ie_clinica						ie_clinica, 
	b.ie_tipo_nascimento					ie_tipo_nascimento, 
	b.cd_motivo_alta					cd_motivo_alta, 
	0							cd_tipo_despesa, 
	0							cd_setor_despesa, 
	' '							ie_tipo_prestador, 
	' ' 							nr_crm_prestador, 
	' '							cd_prestador, 
	' '							nm_prestador, 
	0							cd_item, 
	0							qt_item, 
	' '							ds_unid_consumo, 
	0							qt_filme, 
	0							vl_unitario, 
	0							vl_tot_proced, 
	0							vl_filme, 
	0							vl_total_despesa, 
	' '							ie_vl_adicional,	 
	0							ie_tipo_escala, 
	0							cd_funcao_executor, 
	0							nr_ordem_cirurgia, 
	0							ie_via_acesso, 
	b.nr_interno_conta					nr_interno_conta, 
	' '							ds_item, 
	' '							ie_result_exame, 
	to_char(LOCALTIMESTAMP,'hh24:mi')				hr_execucao, 
	' '							cd_brasindice,	 
	0							cd_simpro, 
	0							vl_01, 
	0							vl_02, 
	0							vl_03, 
	0							vl_04, 
	0							vl_05, 
	' '							branco, 
	0							vl_tot_honorarios, 
	0							vl_tot_tx_diaria, 
	0							vl_tot_mat_medic, 
	0							vl_tot_geral, 
	0							qt_total_atend, 
	0							vl_total_atend 
from	conta_paciente c, 
	w_interf_conta_cab b 
where	b.nr_interno_conta	= c.nr_interno_conta 

union all
 
select	21							tp_registro, 
	b.nr_seq_protocolo					nr_seq_protocolo, 
	' '							nm_hospital, 
	' '							cd_cgc_hospital, 
	LOCALTIMESTAMP							dt_arquivo, 
	' '							ds_remessa, 
	' '							cd_autorizacao, 
	' '							ds_senha, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	LOCALTIMESTAMP							dt_nascimento, 
	' '							ie_sexo, 
	' '							cd_pessoa_fisica, 
	' '							cd_cid_princ, 
	' '							cd_edicao_amb, 
	' '							nr_crm, 
	' '							nm_medico, 
	' '							nr_crm_auxiliar, 
	' '							dt_hr_atendimento, 
	0							ie_tipo_atendimento, 
	' '							dt_hr_termino_atend, 
	' '							ie_carater_inter, 
	' ' 							dt_hr_cirurgia, 
	0							qt_dia_atendimento, 
	0							cd_acomod_abramge, 
	0							ie_clinica, 
	' '							ie_tipo_nascimento, 
	0							cd_motivo_alta, 
	CASE WHEN b.ie_tipo_item=1 THEN CASE WHEN b.cd_tipo_item_interf=4 THEN 4  ELSE 3 END   ELSE CASE WHEN b.cd_tipo_item_interf=4 THEN 1  ELSE 2 END  END 		cd_tipo_despesa, 
	b.cd_setor_atendimento					cd_setor_despesa, 
	CASE WHEN b.cd_medico_executor='' THEN  'J'  ELSE 'F' END 		ie_tipo_prestador, 
	CASE WHEN b.cd_medico_executor=0 THEN ' '  ELSE b.nr_crm_executor END 	nr_crm_prestador, 
	CASE WHEN b.cd_medico_executor='' THEN  d.cd_cgc_hospital  ELSE b.nr_cpf_executor END  cd_prestador, 
	CASE WHEN b.cd_medico_executor='' THEN  upper(d.nm_hospital)  ELSE b.nm_medico_executor END  nm_prestador, 
	b.cd_item						cd_item, 
	sum(b.qt_item)						qt_item, 
	substr(b.cd_unidade_medida,1,8)				cd_unidade_medida, 
	coalesce(b.qt_filme,0)					qt_filme, 
	b.vl_unitario_item					vl_unitario, 
	sum(CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='MN' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='RM' THEN  b.vl_honorario  ELSE b.vl_total_item - coalesce(b.vl_filme,0) END ) vl_tot_proced, 
	sum(coalesce(b.vl_filme,0))					vl_filme, 
	sum(CASE WHEN b.ie_responsavel_credito='M' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='MN' THEN  b.vl_honorario WHEN b.ie_responsavel_credito='RM' THEN  b.vl_honorario  ELSE b.vl_total_item END ) 	vl_total_despesa, 
	CASE WHEN coalesce(b.pr_hora_extra,0)=0 THEN 'N'  ELSE 'S' END 		ie_vl_adicional,	 
	0							ie_tipo_escala, 
	b.cd_funcao_executor					cd_funcao_executor, 
	1							nr_ordem_cirurgia, 
	CASE WHEN b.ie_via_acesso='M' THEN 1 WHEN b.ie_via_acesso='D' THEN 2  ELSE 0 END 			ie_via_acesso, 
	b.nr_interno_conta					nr_interno_conta, 
	substr(b.ds_item,1,35)					ds_item, 
	'S'							ie_result_exame, 
	to_char(LOCALTIMESTAMP,'hh24:mi')				hr_execucao, 
	b.cd_brasindice						cd_brasindice,	 
	b.cd_simpro						cd_simpro, 
	0							vl_01, 
	0							vl_02, 
	0							vl_03, 
	0							vl_04, 
	0							vl_05, 
	' '							branco, 
	0							vl_tot_honorarios, 
	0							vl_tot_tx_diaria, 
	0							vl_tot_mat_medic, 
	0							vl_tot_geral, 
	0							qt_total_atend, 
	0							vl_total_atend 
from	w_interf_conta_item b, 
	w_interf_conta_header d 
where	b.nr_seq_protocolo	= d.nr_seq_protocolo 
group by		b.nr_seq_protocolo, 
			CASE WHEN b.ie_tipo_item=1 THEN CASE WHEN b.cd_tipo_item_interf=4 THEN 4  ELSE 3 END   ELSE CASE WHEN b.cd_tipo_item_interf=4 THEN 1  ELSE 2 END  END , 
			b.cd_setor_atendimento, 
			CASE WHEN b.cd_medico_executor='' THEN  'J'  ELSE 'F' END , 
			CASE WHEN b.cd_medico_executor=0 THEN ' '  ELSE b.nr_crm_executor END , 
			CASE WHEN b.cd_medico_executor='' THEN  d.cd_cgc_hospital  ELSE b.nr_cpf_executor END , 
			CASE WHEN b.cd_medico_executor='' THEN  upper(d.nm_hospital)  ELSE b.nm_medico_executor END , 
			substr(b.cd_unidade_medida,1,8), 
			b.cd_item, 
			b.vl_unitario_item, 
			coalesce(b.qt_filme,0), 
			b.cd_unidade_medida, 
			CASE WHEN coalesce(b.pr_hora_extra,0)=0 THEN 'N'  ELSE 'S' END , 
			b.cd_funcao_executor, 
			CASE WHEN b.ie_via_acesso='M' THEN 1 WHEN b.ie_via_acesso='D' THEN 2  ELSE 0 END , 
			b.nr_interno_conta, 
			substr(b.ds_item,1,35), 
			to_char(LOCALTIMESTAMP,'hh24:mi'), 
			b.cd_brasindice, 
			b.cd_simpro, 
			LOCALTIMESTAMP 

union all
 
select	29							tp_registro, 
	a.nr_seq_protocolo					nr_seq_protocolo, 
	' ' 							nm_hospital, 
	' '							cd_cgc_hospital, 
	LOCALTIMESTAMP							dt_arquivo, 
	' '							ds_remessa, 
	' '							cd_autorizacao, 
	' '							ds_senha, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	LOCALTIMESTAMP							dt_nascimento, 
	' '							ie_sexo, 
	' '							cd_pessoa_fisica, 
	' '							cd_cid_princ, 
	' '							cd_edicao_amb, 
	' '							nr_crm, 
	' '							nm_medico, 
	' '							nr_crm_auxiliar, 
	' '							dt_hr_atendimento, 
	0							ie_tipo_atendimento, 
	' '							dt_hr_termino_atend, 
	' '							ie_carater_inter, 
	' '							dt_hr_cirurgia, 
	0							qt_dia_atendimento, 
	0							cd_acomod_abramge, 
	0							ie_clinica, 
	' '							ie_tipo_nascimento, 
	0							cd_motivo_alta, 
	0							cd_tipo_despesa, 
	0							cd_setor_despesa, 
	' '							ie_tipo_prestador, 
	' '							nr_crm_prestador, 
	' '							cd_prestador, 
	' '							nm_prestador, 
	0							cd_item, 
	0							qt_item, 
	' '							ds_unid_consumo, 
	0							qt_filme, 
	0							vl_unitario, 
	0							vl_tot_proced, 
	0							vl_filme, 
	0							vl_total_despesa, 
	' '							ie_vl_adicional,	 
	0							ie_tipo_escala, 
	0							cd_funcao_executor, 
	0							nr_ordem_cirurgia, 
	0							ie_via_acesso, 
	a.nr_interno_conta					nr_interno_conta, 
	''							ds_item, 
	''							ie_result_exame, 
	to_char(LOCALTIMESTAMP,'hh24:mi')				hr_execucao, 
	' '							cd_brasindice,	 
	0							cd_simpro, 
	0							vl_01, 
	0							vl_02, 
	0							vl_03, 
	0							vl_04, 
	0							vl_05, 
	' '							branco, 
	a.vl_honorarios						vl_tot_honorarios, 
	(a.vl_taxas + a.vl_diarias)				vl_tot_tx_diaria, 
	(a.vl_matmed + a.vl_procedimento)			vl_tor_mat_medic, 
	a.vl_total_conta 					vl_tot_geral, 
	0							qt_total_atend, 
	0							vl_total_atend 
from	w_interf_conta_total a 

union all
 
select	99							tp_registro, 
	a.nr_seq_protocolo					nr_seq_protocolo, 
	' ' 							nm_hospital, 
	' ' 							cd_cgc_hospital, 
	LOCALTIMESTAMP							dt_arquivo, 
	' '							ds_remessa, 
	' '							cd_autorizacao, 
	' '							ds_senha, 
	' '							cd_usuario_convenio, 
	' '							nm_paciente, 
	LOCALTIMESTAMP							dt_nascimento, 
	' '							ie_sexo, 
	' '							cd_pessoa_fisica, 
	' ' 							cd_cid_princ, 
	' '							cd_edicao_amb, 
	' '							nr_crm, 
	' '							nm_medico, 
	' '							nr_crm_auxiliar, 
	' '							dt_hr_atendimento, 
	0							ie_tipo_atendimento, 
	' '							dt_hr_termino_atend, 
	' '							ie_carater_inter, 
	' ' 							dt_hr_cirurgia, 
	0							qt_dia_atendimento, 
	0							cd_acomod_abramge, 
	0 							ie_clinica, 
	' '							ie_tipo_nascimento, 
	0							cd_motivo_alta, 
	0							cd_tipo_despesa, 
	0							cd_setor_despesa, 
	' '							ie_tipo_prestador, 
	' '							nr_crm_prestador, 
	' '							cd_prestador, 
	' '							nm_prestador, 
	0							cd_item, 
	0							qt_item, 
	' '							ds_unid_consumo, 
	0							qt_filme, 
	0							vl_unitario, 
	0							vl_tot_proced, 
	0							vl_filme, 
	0 							vl_total_despesa, 
	' '							ie_vl_adicional,	 
	0							ie_tipo_escala, 
	0							cd_funcao_executor, 
	0							nr_ordem_cirurgia, 
	0							ie_via_acesso, 
	99999999						nr_interno_conta, 
	' '							ds_item, 
	' '							ie_result_exame, 
	to_char(LOCALTIMESTAMP,'hh24:mi')				hr_execucao, 
	' '							cd_brasindice,	 
	0							cd_simpro, 
	0							vl_01, 
	0							vl_02, 
	0							vl_03, 
	0							vl_04, 
	0							vl_05, 
	' '							branco, 
	0							vl_tot_honorarios, 
	0							vl_tot_tx_diaria, 
	0							vl_tot_mat_medic, 
	0							vl_tot_geral, 
	a.qt_total_conta					qt_total_atend, 
	a.vl_total_conta					vl_total_atend 
from	w_interf_conta_trailler a;

