-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ordem_compra_distribuidor_v2 (ds_razao_social, nr_ordem_compra, dt_ordem_compra, dt_aprovacao, nr_sequencia, nr_nota_fiscal, ds_fornecedor, vl_ordem_compra, ds_complemento, dt_vencimento, nr_titulo, nm_fantasia, cd_fornec, dt_baixa, cd_material) AS select	distinct
	ds_razao_social, 
	nr_ordem_compra, 
	dt_ordem_compra, 
	dt_aprovacao, 
	nr_sequencia, 
	nr_nota_fiscal, 
	ds_fornecedor, 
	vl_ordem_compra, 
	ds_complemento, 
	dt_vencimento, 
	nr_titulo, 
	nm_fantasia, 
	cd_fornec, 
	dt_baixa, 
	cd_material 
FROM(	select	distinct 
		substr(obter_nome_pf_pj(o.cd_pessoa_fisica, o.cd_cgc_fornecedor),1,255) ds_razao_social, 
		a.nr_ordem_compra, 
		o.dt_ordem_compra, 
		o.dt_aprovacao, 
		a.nr_seq_nf nr_sequencia, 
		substr(obter_dados_nota_fiscal(a.nr_seq_nf,0),1,255) nr_nota_fiscal, 
		substr(obter_nome_pf_pj(n.cd_pessoa_fisica, n.cd_cgc),1,255) ds_fornecedor, 
		obter_valor_liquido_ordem(o.nr_ordem_compra) vl_ordem_compra, 
		substr(substr(obter_select_concatenado_bv('		 
		select	ds_complemento 
		from	nota_fiscal_item 
		where	nr_sequencia = :nr_sequencia', 
		'nr_sequencia='|| n.nr_sequencia || ';',', '),1,4000),1,4000) ds_complemento, 
		(select	min(x.dt_vencimento) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) dt_vencimento, 
		(select	max(x.nr_titulo_pagar) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) nr_titulo, 
		substr(obter_nome_fantasia_pj(n.cd_cgc),1,255) nm_fantasia, 
		coalesce(o.cd_pessoa_fisica, o.cd_cgc_fornecedor) cd_fornec, 
		o.dt_baixa, 
		oi.cd_material 
	from	nota_fiscal_item_rep a, 
		ordem_compra o, 
		nota_fiscal n, 
		nota_fiscal_item i, 
		ordem_compra_item oi 
	where	a.nr_ordem_compra = o.nr_ordem_compra 
	and	o.nr_ordem_compra = oi.nr_ordem_compra 
	and	a.nr_seq_nf = n.nr_sequencia 
	and	a.nr_seq_nf = i.nr_sequencia 
	and	a.nr_seq_item_nf = i.nr_item_nf 
	and	o.nr_seq_motivo_cancel is null 
	
union all
 
	select	distinct 
		substr(obter_nome_pf_pj(o.cd_pessoa_fisica, o.cd_cgc_fornecedor),1,255) ds_razao_social, 
		a.nr_ordem_compra, 
		o.dt_ordem_compra, 
		o.dt_aprovacao, 
		a.nr_seq_nf nr_sequencia, 
		substr(obter_dados_nota_fiscal(a.nr_seq_nf,0),1,255) nr_nota_fiscal, 
		substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,255) ds_fornecedor, 
		obter_valor_liquido_ordem(o.nr_ordem_compra) vl_ordem_compra, 
		substr(substr(obter_select_concatenado_bv('		 
		select	ds_material_direto 
		from	ordem_compra_item 
		where	nr_ordem_compra = :nr_ordem_compra', 
		'nr_ordem_compra='|| o.nr_ordem_compra || ';',', '),1,4000),1,4000) ds_complemento, 
		(select	min(x.dt_vencimento) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) dt_vencimento, 
		(select	max(x.nr_titulo_pagar) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) nr_titulo, 
		substr(obter_nome_fantasia_pj(n.cd_cgc),1,255) nm_fantasia, 
		coalesce(o.cd_pessoa_fisica, o.cd_cgc_fornecedor) cd_fornec, 
		o.dt_baixa, 
		oi.cd_material 
	FROM ordem_compra_item oi, ordem_compra o, proj_rat a
LEFT OUTER JOIN nota_fiscal n ON (a.nr_seq_nf = n.nr_sequencia)
LEFT OUTER JOIN nota_fiscal_item i ON (n.nr_sequencia = i.nr_sequencia)
WHERE a.nr_ordem_compra = o.nr_ordem_compra and o.nr_ordem_compra = oi.nr_ordem_compra   and o.nr_seq_motivo_cancel is null 
	 
union all
 
	select	distinct 
		substr(obter_nome_pf_pj(o.cd_pessoa_fisica, o.cd_cgc_fornecedor),1,255) ds_razao_social, 
		o.nr_ordem_compra, 
		o.dt_ordem_compra, 
		o.dt_aprovacao, 
		n.nr_sequencia, 
		n.nr_nota_fiscal,	 
		substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,255) ds_fornecedor, 
		obter_valor_liquido_ordem(o.nr_ordem_compra) vl_ordem_compra, 
		substr(substr(obter_select_concatenado_bv('		 
		select	ds_material_direto 
		from	ordem_compra_item 
		where	nr_ordem_compra = :nr_ordem_compra', 
		'nr_ordem_compra='|| o.nr_ordem_compra || ';',', '),1,4000),1,4000) ds_complemento, 
		(select	min(x.dt_vencimento) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) dt_vencimento, 
		(select	max(x.nr_titulo_pagar) 
		from	ordem_compra_venc x 
		where	x.nr_ordem_compra = o.nr_ordem_compra) nr_titulo, 
		substr(obter_nome_fantasia_pj(n.cd_cgc),1,255) nm_fantasia, 
		coalesce(o.cd_pessoa_fisica, o.cd_cgc_fornecedor) cd_fornec, 
		o.dt_baixa, 
		oi.cd_material 
	FROM ordem_compra_item oi, ordem_compra o
LEFT OUTER JOIN nota_fiscal n ON (o.nr_ordem_compra = n.nr_ordem_compra)
LEFT OUTER JOIN nota_fiscal_item i ON (n.nr_sequencia = i.nr_sequencia)
WHERE o.nr_ordem_compra = oi.nr_ordem_compra   and o.nr_seq_motivo_cancel is null and not exists (	select	1 
			from	proj_rat x 
			where	x.nr_ordem_compra = o.nr_ordem_compra) and not exists (	select	1 
			from	nota_fiscal_item_rep x 
			where	x.nr_ordem_compra = o.nr_ordem_compra) ) 
order by	nr_ordem_compra;

