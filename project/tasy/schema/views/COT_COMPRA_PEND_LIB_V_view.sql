-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cot_compra_pend_lib_v (nr_cot_compra, nr_item_cot_compra, cd_material, ds_material, cd_unidade_medida_compra, qt_material, vl_unitario_material, vl_preco_liquido, nr_seq_cot_item_forn, dt_geracao_ordem_compra, dt_liberacao, cd_cgc_fornecedor, nm_fornecedor, cd_estabelecimento) AS select	b.nr_cot_compra,
	b.nr_item_cot_compra, 
	a.cd_material, 
	substr(obter_desc_material(a.cd_material),1,255) ds_material, 
	(select w.cd_unidade_medida_compra 
		FROM	cot_compra_item w 
		where	w.nr_cot_compra = c.nr_cot_compra 
		and	w.nr_item_cot_compra = a.nr_item_cot_compra) cd_unidade_medida_compra, 
	b.qt_material, 
	b.vl_unitario_material, 
	b.vl_preco_liquido, 
	b.nr_seq_cot_item_forn, 
	c.dt_geracao_ordem_compra, 
	a.dt_liberacao, 
	a.cd_cgc_fornecedor, 
	substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,255) nm_fornecedor, 
	(select w.cd_estab_item 
	from	cot_compra_item w 
	where	w.nr_cot_compra = c.nr_cot_compra 
	and	w.nr_item_cot_compra = a.nr_item_cot_compra) cd_estabelecimento 
from	cot_compra c,	 
	cot_compra_resumo b, 
	cot_compra_forn_item a	 
where	a.nr_cot_compra = b.nr_cot_compra 
and	a.nr_sequencia	= b.nr_seq_cot_item_forn 
and	a.nr_cot_compra = c.nr_cot_compra 
and not exists (select 1 
		from cot_compra_solic_agrup x 
		where a.nr_item_cot_compra	= x.nr_item_cot_compra 
		and a.nr_cot_compra		= x.nr_cot_compra 
		and c.cd_estabelecimento	<> x.cd_estabelecimento 
		and (select	count(distinct cd_estabelecimento) 
			from	cot_compra_solic_agrup y 
			where	y.nr_cot_compra = x.nr_cot_compra 
			and	y.nr_item_cot_compra = x.nr_item_cot_compra) > 1) 

union all
 
select	b.nr_cot_compra, 
	b.nr_item_cot_compra, 
	a.cd_material, 
	substr(obter_desc_material(a.cd_material),1,255) ds_material, 
	(select w.cd_unidade_medida_compra 
		from	cot_compra_item w 
		where	w.nr_cot_compra = c.nr_cot_compra 
		and	w.nr_item_cot_compra = a.nr_item_cot_compra) cd_unidade_medida_compra,	 
	x.qt_material, 
	b.vl_unitario_material, 
	(b.vl_unitario_material * x.qt_material) vl_preco_liquido, 
	b.nr_seq_cot_item_forn, 
	c.dt_geracao_ordem_compra, 
	a.dt_liberacao,	 
	a.cd_cgc_fornecedor, 
	substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,255) nm_fornecedor, 
	x.cd_estabelecimento 
from	cot_compra c, 
	cot_compra_resumo b, 
	cot_compra_forn_item a, 
	cot_compra_solic_agrup x 
where	c.nr_cot_compra 	= b.nr_cot_compra 
and	a.nr_sequencia		= b.nr_seq_cot_item_forn 
and	a.nr_cot_compra 	= c.nr_cot_compra 
and	a.nr_item_cot_compra	= x.nr_item_cot_compra 
and	a.nr_cot_compra		= x.nr_cot_compra 
and exists (select 1 
		from cot_compra_solic_agrup y 
		where a.nr_item_cot_compra	= y.nr_item_cot_compra 
		and a.nr_cot_compra		= y.nr_cot_compra 
		and c.cd_estabelecimento	<> y.cd_estabelecimento 
		and (select	count(distinct cd_estabelecimento) 
			from	cot_compra_solic_agrup x 
			where	y.nr_cot_compra = x.nr_cot_compra 
			and	y.nr_item_cot_compra = x.nr_item_cot_compra) > 1);

