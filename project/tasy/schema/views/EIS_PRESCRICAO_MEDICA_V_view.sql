-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_prescricao_medica_v (dt_referencia, ds_data_refer, cd_setor_usuario, ds_setor_usuario, cd_setor_atendimento, ds_setor_atendimento, ie_tipo_atendimento, ds_tipo_atendimento, ds_tipo_evolucao, cd_medico, nm_medico, nm_usuario_original, nm_pf_original, qt_prescr_medico, qt_prescr_nao_medico, qt_prescr_rep_pt, qt_prescr_rep, nr_prescricao, cd_estabelecimento, ds_agrupamento, nr_seq_agrupamento) AS select	trunc(a.dt_prescricao,'dd') dt_referencia,
	to_char(a.dt_prescricao,'dd/mm/yyyy') ds_data_refer, 
	obter_setor_usuario(a.nm_usuario_original) cd_setor_usuario, 
	substr(coalesce(obter_nome_setor(u.cd_setor_atendimento),'Não informado'),1,120) ds_setor_usuario, 
	a.cd_setor_atendimento, 
	substr(coalesce(s.ds_setor_atendimento,'Não informado'),1,120) ds_setor_atendimento, 
	b.ie_tipo_atendimento, 
	substr(obter_valor_dominio(12,b.ie_tipo_atendimento),1,120) ds_tipo_atendimento, 
	substr(Obter_funcao_usuario_orig(a.nm_usuario_original),1,240) ds_tipo_evolucao, 
	a.cd_medico, 
	substr(p.nm_pessoa_fisica,1,120) nm_medico, 
	a.nm_usuario_original, 
	substr(ds_usuario,1,120) nm_pf_original, 
	CASE WHEN substr(Obter_se_pf_Medico(u.cd_pessoa_fisica),1,1)='S' THEN 1  ELSE 0 END  qt_prescr_medico, 
	CASE WHEN substr(Obter_se_pf_Medico(u.cd_pessoa_fisica),1,1)='N' THEN 1  ELSE 0 END  qt_prescr_nao_medico, 
	CASE WHEN cd_funcao_origem=950 THEN 1  ELSE 0 END  qt_prescr_rep_pt, 
	CASE WHEN cd_funcao_origem=950 THEN 0  ELSE 1 END  qt_prescr_rep, 
	a.nr_prescricao, 
	a.cd_estabelecimento, 
	substr(Obter_desc_agrupamento_setor(a.cd_setor_atendimento),1,120) ds_agrupamento, 
	substr(Obter_agrup_setor(a.cd_setor_atendimento,'C'),1,50) nr_seq_agrupamento 
FROM pessoa_fisica p, prescr_medica a
LEFT OUTER JOIN atendimento_paciente b ON (a.nr_atendimento = b.nr_atendimento)
LEFT OUTER JOIN usuario u ON (a.nm_usuario_original = u.nm_usuario)
LEFT OUTER JOIN setor_atendimento s ON (a.cd_setor_atendimento = s.cd_setor_atendimento)
WHERE p.cd_pessoa_fisica = a.cd_medico   and a.dt_liberacao is not null;

