-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW lab_int_sislab_v (matricula, consulta, nr_seq_lote_externo, data_geracao_xml, hora_geracao_xml, cod_procedimento, nr_seq_interno, data_solicit_exame, hora_solicit_exame, data_realiz_exame, hora_realiz_exame, nr_prescricao, lab_cnes, prof_resp_nr_conselho, prof_resp_uf_conselho, prof_resp_sigla_conselho, prof_resp_cbo, prof_soli_nr_conselho, prof_soli_uf_conselho, prof_soli_sigla_conselho, prof_soli_cbo, resultado_rtf) AS select  substr(obter_somente_numero(acc.cd_usuario_convenio),0,6) as matricula,
        obter_somente_numero(acc.cd_complemento) consulta,
        li.nr_seq_lote_externo,
        to_char(LOCALTIMESTAMP, 'yyyy-mm-dd') data_geracao_xml,
        to_char(LOCALTIMESTAMP, 'hh24:mi:ss') hora_geracao_xml,
        -- Paliativo
        case when length(a.cd_procedimento) = 8   then
        lpad((select max(cn.cd_procedimento) FROM exame_lab_convenio cn where cn.nr_seq_exame = a.nr_seq_exame
                                                  and cn.CD_CONVENIO = 203),10,'0')
        else lpad(a.cd_procedimento,10,'0')
        end cod_procedimento,
        --Fim paliativo
        a.nr_seq_interno,
        to_char(b.dt_liberacao, 'yyyy-mm-dd') as data_solicit_exame,
        to_char(b.dt_liberacao, 'hh24:mi:ss') as hora_solicit_exame,
        to_char(obter_data_aprov_lab(a.nr_prescricao,a.nr_sequencia) , 'yyyy-mm-dd') as data_realiz_exame,
        to_char(Obter_data_aprov_lab(a.nr_prescricao,a.nr_sequencia) , 'hh24:mi:ss') as hora_realiz_exame,
        a.nr_prescricao,
        a.nr_seq_lab_ext lab_cnes,
        obter_somente_numero(obter_dados_medico(652639, 'CRM')) prof_resp_nr_conselho,
        (obter_dados_medico(652639, 'UFCRM')) prof_resp_uf_conselho,
        (obter_dados_medico(652639, 'SGCRM')) prof_resp_sigla_conselho,
        (select max(cd_cbo) from sus_cbo_pessoa_fisica ) prof_resp_CBO,
        obter_somente_numero(obter_dados_medico(b.cd_medico, 'CRM')) prof_soli_nr_conselho,
        (obter_dados_medico(b.cd_medico, 'UFCRM')) prof_soli_UF_conselho,
        (obter_dados_medico(b.cd_medico, 'SGCRM')) prof_soli_sigla_conselho,
        (select max(cd_cbo) from sus_cbo_pessoa_fisica ) prof_soli_cbo,
        relab.ds_resultado resultado_rtf
 from prescr_procedimento a
 join lab_lote_item li on li.nr_prescricao=a.nr_prescricao and li.nr_seq_prescr=a.nr_sequencia
 inner join prescr_medica b on a.nr_prescricao = b.nr_prescricao
 inner join exame_lab_resultado elr on elr.nr_prescricao = a.nr_prescricao
 inner join procedimento_paciente pp on pp.nr_prescricao = elr.nr_prescricao and pp.nr_sequencia_prescricao = a.nr_sequencia
 inner join atend_categoria_convenio acc on acc.nr_atendimento = b.nr_atendimento
 inner join result_laboratorio relab on relab.nr_prescricao = b.nr_prescricao  and  relab.nr_seq_prescricao=a.nr_sequencia
 inner join lab_lote_externo l      on l.nr_sequencia = a.nr_seq_lote_externo
 where a.nr_seq_exame is not null;

