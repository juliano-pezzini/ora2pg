-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_conta_pos_dados_contab_v (ie_proc_mat, ie_tipo_movto, dt_mes_competencia, cd_beneficiario, nm_beneficiario, nr_cpf_cnpj_benef, ie_preco, ie_regulamentacao, ds_tipo_contratacao, ds_segmentacao, ie_ato_cooperado, vl_provisao, vl_administracao, vl_fat_ndc, cd_conta_deb_provisao, cd_conta_cred_provisao, cd_classif_credito, nr_seq_conta, nr_contrato, nm_prestador, nr_cpf_cnpj, ie_tipo_contratacao, nr_seq_segurado, nr_seq_prestador, nm_pagador, nr_cpf_cnpj_pagador, nr_seq_pagador, nr_seq_lote_fat, dt_contratacao, nr_protocolo_ans, ds_item_mat_proc, dt_mes_competencia_pos, ie_pos_novo, nr_seq_conta_pos_estab, dt_atendimento_referencia, ds_grupo_ans, ds_modalidade_contrat, nr_seq_protocolo, cd_procedimento, nr_seq_material, ds_tipo_segurado, ie_tipo_segurado, ds_tipo_protocolo, ds_tipo_vinculo_operadora, nm_usuario_princ, cd_estabelecimento, dt_contrato, dt_inicio_cobertura, dt_fim_cobertura, nr_seq_congenere) AS select	'A' ie_proc_mat,
	'X' ie_tipo_movto,
	p.dt_mes_competencia dt_mes_competencia,
	substr(pls_obter_dados_segurado(c.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
	substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_beneficiario,
	pls_obter_dados_segurado(s.nr_sequencia,'CPF') nr_cpf_cnpj_benef,
	d.ie_preco,
	d.ie_regulamentacao,
	substr(obter_valor_dominio(1666, d.ie_tipo_contratacao),1,255) ds_tipo_contratacao,
	substr(obter_valor_dominio(1665, d.ie_segmentacao),1,255) ds_segmentacao,
	(	select	b.ie_ato_cooperado
		FROM	pls_conta_proc b
		where	e.nr_seq_conta_proc = b.nr_sequencia
		and	b.nr_seq_conta = c.nr_sequencia
		
union all

		select	b.ie_ato_cooperado
		from	pls_conta_mat b
		where	e.nr_seq_conta_mat = b.nr_sequencia
		and	b.nr_seq_conta = c.nr_sequencia)ie_ato_cooperado,
	b.vl_provisao vl_provisao,
	0 vl_administracao,
	0 vl_fat_ndc,
	coalesce(b.cd_conta_deb_provisao, b.cd_conta_deb_ndc) cd_conta_deb_provisao,
	coalesce(b.cd_conta_cred_provisao, b.cd_conta_cred_ndc) cd_conta_cred_provisao,
	'' cd_classif_credito,
	c.nr_sequencia nr_seq_conta,
	t.nr_contrato,
	substr(CASE WHEN p.ie_tipo_protocolo='I' THEN pls_obter_nome_congenere(p.nr_seq_congenere)  ELSE pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'N') END ,1,255) nm_prestador,
	substr(CASE WHEN p.ie_tipo_protocolo='I' THEN pls_obter_cnpj_congenere(p.nr_seq_congenere)  ELSE coalesce(pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'CGC'),		pls_obter_dados_prestador(coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec),'CPF')) END ,1,14) nr_cpf_cnpj,
	d.ie_tipo_contratacao,
	s.nr_sequencia nr_seq_segurado,
	c.nr_seq_prestador,
	substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
	coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj_pagador,
	s.nr_seq_pagador,
	e.nr_seq_lote_fat,
	s.dt_contratacao,
	CASE WHEN d.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(d.nr_protocolo_ans, d.cd_scpa) END  nr_protocolo_ans,
	coalesce(substr(obter_descricao_procedimento(e.cd_procedimento,e.ie_origem_proced),1,255), substr(pls_obter_dados_conta_mat(e.nr_seq_conta_mat,'D'),1,255)) ds_item_mat_proc,
	b.dt_mes_competencia dt_mes_competencia_pos,
	'AA' ie_pos_novo,
	e.nr_sequencia nr_seq_conta_pos_estab,
	c.dt_atendimento_referencia,
	(	select	substr(pls_obter_dados_grupo_ans(b.nr_seq_grupo_ans,'D'),1,255)
		from	pls_conta_proc b
		where	e.nr_seq_conta_proc = b.nr_sequencia
		and	b.nr_seq_conta = c.nr_sequencia
		
union all

		select	substr(pls_obter_dados_grupo_ans(b.nr_seq_grupo_ans,'D'),1,255)
		from	pls_conta_mat b
		where	e.nr_seq_conta_mat = b.nr_sequencia
		and	b.nr_seq_conta = c.nr_sequencia) ds_grupo_ans,
	substr(obter_valor_dominio(1669,d.ie_preco),1,255) ds_modalidade_contrat,
	p.nr_sequencia nr_seq_protocolo,
	e.cd_procedimento,
	e.nr_seq_material,
	substr(obter_valor_dominio(2406,c.ie_tipo_segurado),1,255) ds_tipo_segurado,
	c.ie_tipo_segurado,
	substr(obter_valor_dominio(3648,p.ie_tipo_protocolo),1,255) ds_tipo_protocolo,
	substr(pls_obter_dados_prestador(CASE WHEN p.ie_tipo_protocolo='I' THEN p.nr_seq_congenere  ELSE coalesce(c.nr_seq_prestador,c.nr_seq_prestador_exec) END ,'TR'),1,255) ds_tipo_vinculo_operadora,
	substr(pls_obter_dados_segurado(coalesce(s.nr_seq_titular,s.nr_sequencia),'N'),1,255)  nm_usuario_princ,
	c.cd_estabelecimento,
	t.dt_contrato,
	s.dt_rescisao dt_inicio_cobertura,
	(s.dt_rescisao + 30) dt_fim_cobertura,
	p.nr_seq_congenere
FROM pls_protocolo_conta p, pls_plano d, pls_conta c, pls_conta_pos_estab_contab b, pls_conta_pos_estabelecido e
LEFT OUTER JOIN pls_lote_faturamento l ON (e.nr_seq_lote_fat = l.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE p.nr_sequencia 		= c.nr_seq_protocolo and c.nr_sequencia 		= e.nr_seq_conta and e.nr_sequencia 		= b.nr_seq_conta_pos and s.nr_sequencia 		= c.nr_seq_segurado and d.nr_sequencia 		= s.nr_seq_plano;

