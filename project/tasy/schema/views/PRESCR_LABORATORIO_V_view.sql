-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW prescr_laboratorio_v (nr_prescricao, nr_sequencia, cd_procedimento, ds_procedimento, qt_procedimento, dt_atualizacao, nm_usuario, ds_observacao, ie_origem_proced, ie_urgencia, ds_dado_clinico, ie_suspenso, cd_setor_atendimento, nr_atendimento, cd_medico, dt_prescricao, dt_liberacao, dt_liberacao_medico, ie_recem_nato, cd_setor_paciente, nm_paciente, nm_paciente_sem_acento, nr_identidade, dt_nascimento, ie_sexo, nr_cpf, nr_prontuario, nm_medico, nr_cpf_medico, nr_crm, uf_crm, cd_convenio, cd_categoria, cd_usuario_convenio, dt_validade_carteira, nr_doc_convenio, ie_tipo_guia, ds_convenio, cd_cgc_conv, cd_regional_conv, cd_material_exame, ds_material_exame, cd_exame, nm_exame, ds_material_especial, ie_amostra_entregue, ds_horarios, nr_seq_exame, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_estado, nr_telefone, cd_cep, dt_prev_execucao, ds_setor_paciente, cd_unidade, cd_unidade_basica, cd_unidade_compl, vl_procedimento, ie_executar_leito, cd_recem_nato, nm_recem_nato, nr_seq_grupo, cd_estabelecimento, nr_seq_proc_interno, cd_interno_integracao, cd_exame_integracao, ds_classif_risco, nr_seq_condicao, ds_condicao_exame, ds_plano_convenio, cd_plano_convenio, nr_seq_prioridade, nr_controle, dt_entrada, dt_atendimento, dt_mestruacao, qt_peso, dt_resultado, dt_coleta, cd_procedencia, ds_procedencia, ds_medicamento, nm_pessoa_responsavel, nr_telefone_resp, nr_telefone_celular, nr_ddd_celular, ie_autorizacao, ds_autorizacao, nr_controle_exame, ds_senha, cd_material_integracao, ds_obs_prescr, ds_medic_atend, ds_email, dt_fim_conta, nr_seq_forma_laudo) AS SELECT
	a.NR_PRESCRICAO,
	a.NR_SEQUENCIA,
	a.CD_PROCEDIMENTO,
	p.ds_procedimento,
	a.QT_PROCEDIMENTO,
	a.DT_ATUALIZACAO,
	a.NM_USUARIO,
	a.DS_OBSERVACAO,
	a.IE_ORIGEM_PROCED,
	CASE WHEN r.nr_seq_prioridade=1 THEN  'S' WHEN r.nr_seq_prioridade=2 THEN  'S'  ELSE a.ie_urgencia END  ie_urgencia,
	a.DS_DADO_CLINICO,
	a.IE_SUSPENSO,
	a.cd_setor_atendimento,
	a.NR_ATENDIMENTO,
 	a.CD_MEDICO,
 	a.DT_PRESCRICAO,
	a.DT_LIBERACAO,
	a.DT_LIBERACAO_MEDICO,
	a.IE_RECEM_NATO,
	g.cd_setor_atendimento cd_setor_paciente,
	CASE WHEN a.CD_RECEM_NATO IS NULL THEN c.NM_PESSOA_FISICA  ELSE SUBSTR(obter_nome_pf(a.CD_RECEM_NATO),1,80) ||' RN de '||c.NM_PESSOA_FISICA END  NM_PACIENTE,
	elimina_acentuacao(UPPER(CASE WHEN a.CD_RECEM_NATO IS NULL THEN c.NM_PESSOA_FISICA  ELSE SUBSTR(obter_nome_pf(a.CD_RECEM_NATO),1,80) ||' RN de '||c.NM_PESSOA_FISICA END )) NM_PACIENTE_SEM_ACENTO,
	c.NR_IDENTIDADE,
	c.DT_NASCIMENTO,
	c.IE_SEXO,
	c.NR_CPF,
	c.NR_PRONTUARIO,
	d.NM_PESSOA_FISICA NM_MEDICO,
	d.nr_cpf nr_cpf_medico,		/*Elemar - 27/08/2008*/

	e.NR_CRM,
	e.UF_CRM,			/*Elemar - 27/08/2008*/

	F.CD_CONVENIO,
	F.CD_CATEGORIA,
	F.CD_USUARIO_CONVENIO,
	F.DT_VALIDADE_CARTEIRA, 	/*Elemar - 27/08/2008*/

	F.NR_DOC_CONVENIO,		/*Elemar - 27/08/2008*/

	F.IE_TIPO_GUIA,			/*Elemar - 27/08/2008*/

	V.DS_CONVENIO,
	V.CD_CGC CD_CGC_CONV,		/*Elemar - 27/08/2008*/

	V.CD_REGIONAL CD_REGIONAL_CONV,	/*Elemar - 27/08/2008*/

	A.CD_MATERIAL_EXAME,
	m.ds_material_exame,
	Y.CD_EXAME,
	y.nm_exame,
	A.DS_MATERIAL_ESPECIAL,
	coalesce(a.ie_amostra,'N') ie_amostra_entregue,
	a.ds_horarios,
	a.nr_seq_exame,
	z.ds_endereco,
	z.nr_endereco,
	z.ds_complemento,
	z.ds_bairro,
	z.ds_municipio,
	z.sg_estado,
	z.nr_telefone,
	z.cd_cep,
	a.dt_prev_execucao,
	s.ds_setor_atendimento ds_setor_paciente,
	g.cd_unidade_basica || ' ' || cd_unidade_compl cd_unidade,
	g.cd_unidade_basica,
	cd_unidade_compl,
	obter_preco_procedimento(t.cd_estabelecimento, f.cd_convenio, f.cd_categoria,
		a.dt_prescricao, a.cd_procedimento, a.ie_origem_proced,
		f.cd_tipo_acomodacao, t.ie_tipo_atendimento, g.cd_setor_atendimento,
		a.cd_medico, NULL,
		f.cd_usuario_convenio, f.cd_plano_convenio, t.ie_clinica, f.cd_empresa,
		'P') vl_procedimento,
	a.ie_executar_leito,
	a.CD_RECEM_NATO,
	SUBSTR(obter_nome_pf(a.CD_RECEM_NATO),1,80) NM_RECEM_NATO,
	y.nr_seq_grupo,
	a.cd_estabelecimento,
	a.nr_seq_proc_interno,
	SUBSTR(obter_proc_interno(a.nr_seq_proc_interno,'CI'),1,20) cd_interno_integracao,
	y.cd_exame_integracao cd_exame_integracao,
	r.ds_classificacao ds_classif_risco,
	a.nr_seq_condicao,
	SUBSTR(obter_desc_condicao_exame(nr_seq_condicao),1,255) ds_condicao_exame,
	(SELECT ds_plano ds
	 FROM 	convenio_plano
	 WHERE 	cd_convenio = f.cd_convenio
	 AND	cd_plano    = f.cd_plano_convenio) ds_plano_convenio,
	f.cd_plano_convenio,
	r.nr_seq_prioridade,
	a.NR_CONTROLE NR_CONTROLE,
	t.dt_entrada,
	t.dt_entrada dt_atendimento,
	a.DT_MESTRUACAO,
	a.QT_PESO,
	a.DT_RESULTADO,
	a.DT_COLETA,
	t.CD_PROCEDENCIA,
	substr(Obter_Desc_Procedencia(t.CD_PROCEDENCIA),1,90) ds_procedencia,
	substr(obter_inf_hist_saude(t.cd_pessoa_fisica,'M'),1,2000) ds_medicamento,
	substr((select max(nm_pessoa_fisica) from pessoa_fisica where cd_pessoa_fisica = t.cd_pessoa_responsavel),1,40) nm_pessoa_responsavel,
	(select max(nr_telefone_celular) from pessoa_fisica where cd_pessoa_fisica = t.cd_pessoa_responsavel) nr_telefone_resp,
	(select max(nr_telefone_celular) from pessoa_fisica where cd_pessoa_fisica = c.cd_pessoa_fisica) nr_telefone_celular,
	(select max(NR_DDD_CELULAR) from pessoa_fisica where cd_pessoa_fisica = c.cd_pessoa_fisica) NR_DDD_CELULAR,
	a.IE_AUTORIZACAO,
	substr(OBTER_VALOR_DOMINIO(1227,a.IE_AUTORIZACAO),1,255) ds_AUTORIZACAO,
	a.nr_controle_exame,
	substr(t.ds_senha,1,20) ds_senha,
	m.cd_material_integracao,
	a.ds_obs_prescr,
	substr(obter_inf_hist_saude_med_atend(t.nr_atendimento,'M'),1,2000) ds_medic_atend,
	substr(z.ds_email,1,255) ds_email,
	t.dt_fim_conta,
              a.NR_SEQ_FORMA_LAUDO
FROM convenio v, setor_atendimento s, procedimento p, atend_paciente_unidade g, atend_categoria_convenio f, pessoa_fisica d, pessoa_fisica c, atendimento_paciente t
LEFT OUTER JOIN tipo_indicacao h ON (t.nr_seq_indicacao = h.nr_sequencia)
LEFT OUTER JOIN triagem_classif_risco r ON (t.nr_seq_triagem = r.nr_sequencia)
, (SELECT a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_exame,
		a.cd_material_exame,
		a.NR_PRESCRICAO,
		a.NR_SEQUENCIA,
		a.QT_PROCEDIMENTO,
		a.DT_ATUALIZACAO,
		a.NM_USUARIO,
		a.DS_OBSERVACAO,
		a.IE_URGENCIA,
		a.DS_DADO_CLINICO,
		a.IE_SUSPENSO,
		a.cd_setor_atendimento,
		A.DS_MATERIAL_ESPECIAL,
		a.ie_amostra,
		a.ds_horarios,
		a.dt_prev_execucao,
		a.ie_executar_leito,
		a.nr_seq_proc_interno,
		a.nr_seq_condicao,
		b.NR_ATENDIMENTO,
		b.CD_MEDICO,
		b.DT_PRESCRICAO,
		b.DT_LIBERACAO,
		b.DT_LIBERACAO_MEDICO,
		b.IE_RECEM_NATO,
		b.CD_RECEM_NATO,
		b.cd_estabelecimento,
		b.cd_pessoa_fisica,
		b.NR_CONTROLE,
		b.DT_MESTRUACAO,
		b.QT_PESO,
		a.DT_RESULTADO,
		a.DT_COLETA,
		a.IE_AUTORIZACAO,
		a.nr_controle_exame,
		b.ds_observacao ds_obs_prescr,
                                b.NR_SEQ_FORMA_LAUDO
	FROM	prescr_medica b,
		prescr_procedimento a
	WHERE	a.nr_prescricao 		= b.nr_prescricao
	AND 	a.dt_integracao IS NULL
	AND	a.nr_seq_exame IS NOT NULL
	AND 	coalesce(dt_liberacao_medico, dt_liberacao) IS NOT NULL
	AND 	coalesce(A.IE_SUSPENSO,'N')	= 'N'
	AND	A.CD_SETOR_ATENDIMENTO IN (SELECT S.CD_SETOR_ATENDIMENTO	FROM SETOR_ATENDIMENTO S	WHERE S.NM_USUARIO_BANCO IN (SELECT USER ))
	AND	b.dt_prescricao BETWEEN LOCALTIMESTAMP - interval '30 days' AND LOCALTIMESTAMP + interval '10 days'
	) a
LEFT OUTER JOIN compl_pessoa_fisica z ON (a.cd_pessoa_fisica = z.cd_pessoa_fisica AND 1 = Z.IE_TIPO_COMPLEMENTO)
LEFT OUTER JOIN medico e ON (a.cd_medico = e.cd_pessoa_fisica)
LEFT OUTER JOIN material_exame_lab m ON (a.cd_material_exame = m.cd_material_exame)
, coalesce(a
LEFT OUTER JOIN exame_laboratorio y ON (coalesce(a.nr_seq_exame,obter_exame_lab_proc_int(a.nr_seq_proc_interno)) = y.nr_seq_exame)
WHERE a.cd_procedimento		= p.cd_procedimento AND a.ie_origem_proced		= p.ie_origem_proced AND a.cd_pessoa_fisica 		= c.cd_pessoa_fisica  AND a.cd_medico 			= d.cd_pessoa_fisica    AND G.NR_SEQ_INTERNO		= obter_atepacu_paciente(a.nr_atendimento,'A') AND G.CD_SETOR_ATENDIMENTO		= S.CD_SETOR_ATENDIMENTO  AND F.NR_ATENDIMENTO  		= a.NR_ATENDIMENTO AND T.NR_ATENDIMENTO  		= a.nR_ATENDIMENTO  AND coalesce(h.ie_integra,'S')		= 'S' AND F.DT_INICIO_VIGENCIA 		= (SELECT MAX(W.DT_INICIO_VIGENCIA) FROM ATEND_CATEGORIA_CONVENIO W WHERE W.NR_ATENDIMENTO  = a.NR_ATENDIMENTO) AND F.CD_CONVENIO          		= V.CD_CONVENIO  AND lab_valida_realiza_integracao(a.nr_prescricao, a.nr_sequencia) = 'S';

