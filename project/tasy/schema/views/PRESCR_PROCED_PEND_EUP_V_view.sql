-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW prescr_proced_pend_eup_v (nr_atendimento, dt_prescricao, nm_usuario, nm_usuario_original, nm_paciente, dt_nascimento, nm_medico, nr_prescricao, cd_setor_atendimento, dt_emissao_setor_atend, ie_status_atend, dt_liberacao, dt_liberacao_medico, dt_entrega, cd_setor_entrega, cd_setor_usuario, cd_estabelecimento, qt_peso, qt_altura_cm, cd_procedimento, ie_origem_proced, nr_seq_proc_interno, dt_prev_execucao) AS SELECT	B.NR_ATENDIMENTO,
	B.DT_PRESCRICAO, 
	B.NM_USUARIO, 
	B.NM_USUARIO_ORIGINAL, 
	P.NM_PESSOA_FISICA NM_PACIENTE, 
	P.DT_NASCIMENTO, 
	M.NM_PESSOA_FISICA NM_MEDICO, 
	A.NR_PRESCRICAO, 
	A.CD_SETOR_ATENDIMENTO, 
	A.DT_EMISSAO_SETOR_ATEND, 
	A.IE_STATUS_ATEND, 
	B.DT_LIBERACAO, 
	B.DT_LIBERACAO_MEDICO, 
	B.dt_entrega, 
	B.cd_setor_entrega, 
	coalesce(A.cd_setor_atendimento, coalesce(B.cd_setor_entrega, B.cd_setor_atendimento)) cd_setor_usuario, 
	obter_estab_atend(B.nr_atendimento) cd_estabelecimento, 
	B.QT_PESO, 
	B.QT_ALTURA_CM, 
	A.CD_PROCEDIMENTO, 
	A.IE_ORIGEM_PROCED, 
	A.NR_SEQ_PROC_INTERNO, 
	coalesce(A.DT_PREV_EXECUCAO, B.DT_PRESCRICAO) DT_PREV_EXECUCAO 
FROM	Atendimento_paciente t, 
	PESSOA_FISICA M, 
	PESSOA_FISICA P, 
	PRESCR_MEDICA B, 
	PRESCR_PROCEDIMENTO A 
WHERE	B.CD_PESSOA_FISICA	= P.CD_PESSOA_FISICA 
AND	B.CD_MEDICO		= M.CD_PESSOA_FISICA 
AND	A.NR_PRESCRICAO	= B.NR_PRESCRICAO 
AND	A.CD_MOTIVO_BAIXA	= 0  
and	B.nr_atendimento	= t.nr_atendimento 
and 	A.ie_suspenso		<> 'S' 
and 	B.dt_suspensao is null 
and	not exists (	select	1 
			from	procedimento_paciente c 
			where	c.nr_prescricao			= A.nr_prescricao 
			and	c.nr_sequencia_prescricao	= A.nr_sequencia) 
and	((B.dt_liberacao is not null) or (B.dt_liberacao_medico is not null) or (t.ie_tipo_atendimento	= 7))	 
and	consiste_se_proced_pendente(A.cd_procedimento, A.ie_origem_proced, A.nr_seq_proc_interno) = 'S' 
GROUP BY B.NR_ATENDIMENTO, 
	B.DT_PRESCRICAO, 
	B.NM_USUARIO, 
	P.NM_PESSOA_FISICA, 
	P.DT_NASCIMENTO, 
	B.NM_USUARIO_ORIGINAL, 
	M.NM_PESSOA_FISICA, 
	A.NR_PRESCRICAO, 
	A.CD_SETOR_ATENDIMENTO, 
	A.DT_EMISSAO_SETOR_ATEND, 
	A.IE_STATUS_ATEND, 
	B.DT_LIBERACAO, 
	B.DT_LIBERACAO_MEDICO, 
	B.dt_entrega, 
	B.cd_setor_entrega, 
	coalesce(A.cd_setor_atendimento, coalesce(B.cd_setor_entrega, B.cd_setor_atendimento)), 
	B.QT_PESO, 
	B.QT_ALTURA_CM, 
	A.CD_PROCEDIMENTO, 
	A.IE_ORIGEM_PROCED, 
	A.NR_SEQ_PROC_INTERNO, 
	coalesce(A.DT_PREV_EXECUCAO, B.DT_PRESCRICAO);

