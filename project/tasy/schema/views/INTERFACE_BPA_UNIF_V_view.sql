-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interface_bpa_unif_v (cd_convenio, nr_protocolo, nr_seq_protocolo, dt_periodo_final, dt_competencia_bpa, dt_procedimento, cd_procedimento, ie_origem_proced, cd_atividade_prof_bpa, ie_tipo_atend_bpa, ie_grupo_atend_bpa, cd_faixa_etaria, qt_procedimento, vl_procedimento, cd_cnes_hospital, cd_estabelecimento, cd_interface_envio, cd_orgao_responsavel, ie_cnes_prestador, ie_orgao_destino, nm_orgao_destino, qt_digitos_bpa, ie_tipo_atendimento, cd_cbo) AS select b.cd_convenio_parametro cd_convenio,
	b.nr_protocolo, 
	x.nr_seq_protocolo, 
	x.dt_periodo_final, 
	Sus_Obter_Competencia(d.cd_estabelecimento,'BPA') dt_competencia_bpa, 
	to_date('01/' || substr(to_char(x.dt_periodo_final,'mm/yyyy'),0,7)) dt_procedimento, 
	a.cd_procedimento, 
	a.ie_origem_proced, 
	a.cd_atividade_prof_bpa, 
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T') ie_tipo_atend_bpa,	 
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G') ie_grupo_atend_bpa, 
	g.cd_faixa_etaria, 
	sum(a.qt_procedimento) qt_procedimento, 
	sum(a.vl_procedimento) vl_procedimento, 
	c.cd_cnes_hospital, 
	c.cd_estabelecimento, 
	c.cd_interface_envio, 
	c.cd_orgao_responsavel, 
	c.ie_cnes_prestador, 
	c.ie_orgao_destino, 
	c.nm_orgao_destino, 
	c.qt_digitos_bpa, 
	e.ie_tipo_atendimento, 
	a.cd_cbo 
FROM	estabelecimento d, 
	sus_parametros_bpa c, 
	atendimento_paciente e, 
	protocolo_convenio x, 
	conta_paciente b, 
	procedimento_paciente a, 
	sus_valor_proc_paciente g 
where	a.nr_interno_conta 		= b.nr_interno_conta 
and 	b.nr_seq_protocolo 		= x.nr_seq_protocolo 
and 	b.nr_atendimento 		= e.nr_atendimento 
and 	e.cd_estabelecimento 	= c.cd_estabelecimento 
and 	e.cd_estabelecimento 	= d.cd_estabelecimento 
and 	a.cd_motivo_exc_conta is null 
and 	a.nr_sequencia 		= g.nr_sequencia 
and 	a.vl_procedimento 		> 0 
and 	a.ie_origem_proced		= 7 
group by 	b.cd_convenio_parametro, 
	b.nr_protocolo, 
	x.nr_seq_protocolo, 
	x.dt_periodo_final, 
	Sus_Obter_Competencia(d.cd_estabelecimento,'BPA'), 
	to_date('01/' || substr(to_char(x.dt_periodo_final,'mm/yyyy'),0,7)), 
	a.cd_procedimento, 
	a.ie_origem_proced, 
	a.cd_atividade_prof_bpa, 
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'T'),	 
	Obter_Tipo_grupo_Proced_Bpa(a.nr_sequencia, 'G'), 
	g.cd_faixa_etaria, 
	c.cd_cnes_hospital, 
	c.cd_estabelecimento, 
	c.cd_interface_envio, 
	c.cd_orgao_responsavel, 
	c.ie_cnes_prestador, 
	c.ie_orgao_destino, 
	c.nm_orgao_destino, 
	c.qt_digitos_bpa, 
	e.ie_tipo_atendimento, 
	a.cd_cbo;

