-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW exp_nre_prefeitura_blu_v (tp_registro, nr_versao, nr_inscricao_municipal, nr_nota_servico, dt_nota_servico, cd_verificacao_nfse, ds_tipo_rps, cd_serie_nf, nr_nota_fiscal, dt_emissao, ie_cpf_cnpj_prest, cd_cpf_cnpj_prest, nr_inscricao_munic_prest, nr_inscricao_estad_prest, nm_prestador, ds_tipo_logradouro, ds_endereco_prest, nr_endereco_prest, ds_complemento_prest, ds_bairro_prest, ds_municipio_prest, sg_estado_prest, cd_cep_prest, ds_email_prest, ie_situacao, dt_cancelamento, nr_guia, dt_liquidacao_guia, vl_servico, vl_descontos, cd_servico, vl_aliquota, vl_iss, vl_credito, ie_iss_retido, ie_cpf_cnpj_tomador, cd_cpf_cnpj_tomador, nr_inscricao_munic_tomador, nr_inscricao_estad_tomador, nm_tomador, ds_endereco_tomador, nr_endereco_tomador, ds_complemento_tomador, ds_bairro_tomador, ds_municipio_tomador, sg_estado_tomador, cd_cep_tomador, ds_email_tomador, vl_cofins, vl_csll, vl_inss, vl_irpj, vl_pis, ds_servicos, vl_total_servicos, vl_total_descontos, qt_linhas, cd_estabelecimento, vl_total_deducoes, vl_total_nota_fiscal) AS select	1					tp_registro,
	'002'					nr_versao, 
	a.cd_inscricao_municipal		nr_inscricao_municipal, 
	''					nr_nota_servico, 
	null					dt_nota_servico, 
	null					cd_verificacao_nfse, 
	''					ds_tipo_rps, 
	''					cd_serie_nf, 
	'0'					nr_nota_fiscal, 
	null					dt_emissao, 
	null					ie_cpf_cnpj_prest, 
	''					cd_cpf_cnpj_prest, 
	''					nr_inscricao_munic_prest, 
	''					nr_inscricao_estad_prest, 
	''					nm_prestador, 
	''					ds_tipo_logradouro, 
	''					ds_endereco_prest, 
	''					nr_endereco_prest, 
	''					ds_complemento_prest, 
	''					ds_bairro_prest, 
	''					ds_municipio_prest, 
	''					sg_estado_prest, 
	''					cd_cep_prest, 
	''					ds_email_prest, 
	''					ie_situacao, 
	null					dt_cancelamento, 
	null					nr_guia, 
	null					dt_liquidacao_guia, 
	0					vl_servico, 
	0					vl_descontos, 
	''					cd_servico, 
	0					vl_aliquota, 
	''					vl_iss, 
	0					vl_credito, 
	''					ie_iss_retido, 
	null					ie_cpf_cnpj_tomador, 
	''					cd_cpf_cnpj_tomador, 
	''					nr_inscricao_munic_tomador, 
	''					nr_inscricao_estad_tomador, 
	''					nm_tomador, 
	''					ds_endereco_tomador, 
	''					nr_endereco_tomador, 
	''					ds_complemento_tomador, 
	''					ds_bairro_tomador, 
	''					ds_municipio_tomador, 
	''					sg_estado_tomador, 
	''					cd_cep_tomador, 
	''					ds_email_tomador, 
	''					vl_cofins, 
	''					vl_csll, 
	''					vl_inss, 
	''					vl_irpj, 
	''					vl_pis, 
	' '					ds_servicos, 
	0					vl_total_servicos, 
	0					vl_total_descontos, 
	0					qt_linhas, 
	a.cd_estabelecimento, 
	0					vl_total_deducoes, 
	0					vl_total_nota_fiscal 
FROM	estabelecimento a 

union
 
select	2					tp_registro, 
	'002'					nr_versao, 
	null 					nr_inscricao_municipal, 
	substr(coalesce(n.nr_nfe_imp,''), 1 ,15)	nr_nota_servico, 
	LOCALTIMESTAMP					dt_nota_servico, 
	n.cd_verificacao_nfse			cd_verificacao_nfse, 
	'0'					ds_tipo_rps, 
	n.cd_serie_nf				cd_serie_nf, 
	n.nr_nota_fiscal			nr_nota_fiscal, 
	n.dt_emissao				dt_emissao, 
	CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2)='IN' THEN 3  ELSE CASE WHEN n.cd_pessoa_fisica IS NULL THEN 2  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN 3  ELSE 1 END  END  END  ie_cpf_cnpj_prest,			 
	CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2)='IN' THEN '00000000000000'  ELSE CASE WHEN 	n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN '00000000000000'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END  END  cd_cpf_cnpj_prest, 
	CASE WHEN elimina_acentuacao(elimina_caracteres_especiais(upper(substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CI'),1,50))))='BLUMENAU' THEN  	substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM'),1,8)  ELSE '00000000' END  nr_inscricao_munic_prest, 
	substr(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IE'),1,20) nr_inscricao_estad_prest, 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente),1,75) nm_prestador, 
	'Rua'					ds_tipo_logradouro, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'E'),1,40)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'EN'),1,50)  ELSE substr(obter_compl_pj(n.cd_cgc_emitente,1,'E'),1,40) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'EN'),1,50) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'EN'),1,50)) ds_endereco_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'NR'),1,10)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'NR'),1,10)  ELSE substr(obter_compl_pj(n.cd_cgc_emitente,1,'NR'),1,10) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NR'),1,10) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'NR'),1,10)) nr_endereco_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'CO'),1,30)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CO'),1,30)  ELSE substr(obter_compl_pj(n.cd_cgc_emitente,1,'CO'),1,30) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CO'),1,30) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CO'),1,30)) ds_complemento_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'B'),1,30)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'B'),1,30)  ELSE substr(obter_compl_pj(n.cd_cgc_emitente,1,'B'),1,30) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'B'),1,30) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'B'),1,30)) ds_bairro_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'CI'),1,50)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CI'),1,50)  ELSE substr(obter_compl_pj(n.cd_cgc_emitente,1,'CI'),1,50) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CI'),1,50) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CI'),1,50)) ds_municipio_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'UF'),1,2)=substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'UF'),1,2) THEN  substr(obter_compl_pj(n.cd_cgc_emitente,1,'UF'),1,2) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'UF'),1,2) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'UF'),1,2)) sg_estado_prest, 
	coalesce(to_char(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc_emitente,1,'CEP'),1,15)=to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CEP'),1,15))) THEN  			substr(obter_compl_pj(n.cd_cgc_emitente,1,'CEP'),1,15) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CEP'),1,15) END ), 
		to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc_emitente, 'CEP'),1,15)))) cd_cep_prest, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN substr(obter_dados_pf_pj_estab(n.cd_estabelecimento,null, n.cd_cgc_emitente, 'M'),1,60)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'M'),1,60) END ,'') ds_email_prest, 
	CASE WHEN  n.ie_situacao=1 THEN  		CASE WHEN coalesce((	select	count(*) 				from	nota_fiscal_trib a, 					tributo c 				where	a.cd_tributo 	 = c.cd_tributo 				and	c.ie_tipo_tributo	= 'ISS' 				and 	a.nr_sequencia 	= n.nr_sequencia),0)=0 THEN 'I'  ELSE 'T' END  WHEN  n.ie_situacao=3 THEN  CASE WHEN n.ie_status_envio IS NULL THEN  				CASE WHEN coalesce((	select	count(*) 					from	nota_fiscal_trib a, 						tributo c 					where	a.cd_tributo 	 = c.cd_tributo 					and	c.ie_tipo_tributo	= 'ISS' 					and 	a.nr_sequencia 	= n.nr_sequencia),0)=0 THEN 'I'  ELSE 'T' END   ELSE 'C' END   ELSE 'C' END  ie_situacao, 
	n.dt_cancelamento_nfe			dt_cancelamento, 
	lpad(0,15,0)			nr_guia, --preencher 
	lpad(' ',8,' ')			dt_liquidacao_guia, --preencher 
	CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END  vl_servico, 
	n.vl_descontos				vl_descontos, 
	o.nr_codigo_serv_prest			cd_servico, 
	0					vl_aliquota, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'ISS', 'VL')), 15, 0) vl_iss, 
	null					vl_credito, -- preencher 
	CASE WHEN substr(obter_se_nf_retem_iss(n.nr_sequencia),1,1)='S' THEN '1'  ELSE '0' END  ie_iss_retido, 
	CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2)='IN' THEN 3  ELSE CASE WHEN n.cd_pessoa_fisica IS NULL THEN 2  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN 3  ELSE 1 END  END  END  ie_cpf_cnpj_tomador,			 
	CASE WHEN substr(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),1,2)='IN' THEN '00000000000000'  ELSE CASE WHEN 	n.cd_pessoa_fisica IS NULL THEN n.cd_cgc  ELSE CASE WHEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) IS NULL THEN '00000000000000'  ELSE obter_cpf_pessoa_fisica(n.cd_pessoa_fisica) END  END  END  cd_cpf_cnpj_tomador, 
	CASE WHEN elimina_acentuacao(elimina_caracteres_especiais(upper(substr(obter_dados_pf_pj(null,n.cd_cgc,'CI'),1,50))))='BLUMENAU' THEN  	substr(obter_dados_pf_pj(null,n.cd_cgc,'IM'),1,8)  ELSE '00000000' END  nr_inscricao_munic_tomador, 
	substr(obter_dados_pf_pj(null,n.cd_cgc,'IE'),1,20) nr_inscricao_estad_tomador, 
	substr(obter_nome_pf_pj(n.cd_pessoa_fisica,n.cd_cgc),1,75) nm_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'E'),1,40)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'E'),1,40) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'EN'),1,50) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'EN'),1,50)) ds_endereco_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'NR'),1,10)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),1,10)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'NR'),1,10) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'NR'),1,10) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),1,10)) nr_endereco_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CO'),1,30)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CO'),1,30)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CO'),1,30) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CO'),1,30) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CO'),1,30)) ds_complemento_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'B'),1,30)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,30)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'B'),1,30) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'B'),1,30) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),1,30)) ds_bairro_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CI'),1,50)='N/D' THEN  			substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,50)  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CI'),1,50) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CI'),1,50) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),1,50)) ds_municipio_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'UF'),1,2)=substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2) THEN  substr(obter_compl_pj(n.cd_cgc,1,'UF'),1,2) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'UF'),1,2) END , 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2)) sg_estado_tomador, 
	coalesce(to_char(CASE WHEN n.cd_pessoa_fisica IS NULL THEN CASE WHEN substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,15)='N/D' THEN  			to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))  ELSE substr(obter_compl_pj(n.cd_cgc,1,'CEP'),1,15) END   ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'CEP'),1,15) END ), 
		to_char(somente_numero(substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),1,15)))) cd_cep_tomador, 
	coalesce(CASE WHEN n.cd_pessoa_fisica IS NULL THEN substr(obter_dados_pf_pj_estab(n.cd_estabelecimento,n.cd_pessoa_fisica, n.cd_cgc, 'M'),1,60)  ELSE substr(obter_compl_pf(n.cd_pessoa_fisica, 1, 'M'),1,60) END ,'') ds_email_tomador, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'COFINS', 'VL')), 15, 0) vl_cofins, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, '', 'VL')), 15, 0) vl_csll, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'INSS', 'VL')), 15, 0) vl_inss, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'IR', 'VL')), 15, 0) vl_irpj, 
	lpad(elimina_caractere_especial(nfe_obter_valores_totais_num(n.nr_sequencia, 'PIS', 'VL')), 15, 0) vl_pis, 
	CASE WHEN nr_seq_protocolo IS NULL THEN  	 substr((select	substr(obter_nome_pf(a.cd_pessoa_fisica),1,150) 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || '  ' || 		(select	substr(obter_dados_pf(a.cd_pessoa_fisica,'CPF'),1,11) 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || ' |' || 		substr(Obter_select_concatenado( 			'select decode(a.cd_material, null, 
				substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240), 
					substr(obter_desc_material(a.cd_material),1,100)) || chr(32) || chr(47) || chr(32) || b.ds_observacao 
			from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = ' || n.nr_sequencia,null,'|'),1,1000) || '  ' || 		'Período de fechamento ' || 		(select	c.dt_periodo_inicial 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta) || ' a ' || 		(select	c.dt_periodo_final 		from	atendimento_paciente a, 			conta_paciente c 		where	a.nr_atendimento = c.nr_atendimento 		and	c.nr_interno_conta = n.nr_interno_conta),1,1000)  ELSE substr(Obter_select_concatenado( 		'select decode(a.cd_material, null, 
			substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240), 
			substr(obter_desc_material(a.cd_material),1,100)) || chr(32) || chr(47) || chr(32) || b.ds_observacao 
		from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = ' || n.nr_sequencia,null,'|'),1,1000) END  ds_servicos, 
	0				vl_total_servicos, 
	0				vl_total_descontos, 
	0				qt_linhas, 
	n.cd_estabelecimento, 
	0				vl_total_deducoes, 
	0				vl_total_nota_fiscal 
  from	operacao_nota o, 
	nota_fiscal n 
where	o.cd_operacao_nf = n.cd_operacao_nf 

union
 
select	9					tp_registro, 
	''					nr_versao, 
	''					nr_inscricao_municipal, 
	''					nr_nota_servico, 
	null					dt_nota_servico, 
	null					cd_verificacao_nfse, 
	'RPS'					ds_tipo_rps, 
	''					cd_serie_nf, 
	'0'					nr_nota_fiscal, 
	null					dt_emissao, 
	null					ie_cpf_cnpj_prest, 
	''					cd_cpf_cnpj_prest, 
	''					nr_inscricao_munic_prest, 
	''					nr_inscricao_estad_prest, 
	''					nm_prestador, 
	''					ds_tipo_logradouro, 
	''					ds_endereco_prest, 
	''					nr_endereco_prest, 
	''					ds_complemento_prest, 
	''					ds_bairro_prest, 
	''					ds_municipio_prest, 
	''					sg_estado_prest, 
	''					cd_cep_prest, 
	''					ds_email_prest, 
	''					ie_situacao, 
	null					dt_cancelamento, 
	null					nr_guia, 
	null					dt_liquidacao_guia, 
	0					vl_servico, 
	0					vl_descontos, 
	''					cd_servico, 
	0					vl_aliquota, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, 'ISS', 'VL'))), 15, 0) vl_iss, 
	0					vl_credito, 
	''					ie_iss_retido, 
	null					ie_cpf_cnpj_tomador, 
	''					cd_cpf_cnpj_tomador, 
	''					nr_inscricao_munic_tomador, 
	''					nr_inscricao_estad_tomador, 
	''					nm_tomador, 
	''					ds_endereco_tomador, 
	''					nr_endereco_tomador, 
	''					ds_complemento_tomador, 
	''					ds_bairro_tomador, 
	''					ds_municipio_tomador, 
	''					sg_estado_tomador, 
	''					cd_cep_tomador, 
	''					ds_email_tomador, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, 'COFINS', 'VL'))), 15, 0) vl_cofins, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, '', 'VL'))), 15, 0) vl_csll, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, 'INSS', 'VL'))), 15, 0) vl_inss, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, 'IR', 'VL'))), 15, 0) vl_irpj, 
	lpad(elimina_caractere_especial(sum(nfe_obter_valores_totais_num(n.nr_sequencia, 'PIS', 'VL'))), 15, 0) vl_pis, 
	' '					ds_servicos, 
	sum(CASE WHEN n.ie_situacao=1 THEN  n.vl_mercadoria WHEN n.ie_situacao=3 THEN  CASE WHEN n.ie_status_envio IS NULL THEN  n.vl_mercadoria  ELSE 0 END   ELSE 0 END ) vl_total_servicos, 
	sum(n.vl_descontos)			vl_total_descontos, 
	0					qt_linhas, 
	n.cd_estabelecimento, 
	sum(coalesce(Obter_Valor_tipo_Tributo_Nota(n.nr_sequencia, 'V', 'ISS'),0)) vl_total_deducoes, 
	sum(coalesce(CASE WHEN n.ie_situacao=1 THEN n.vl_total_nota  ELSE 0 END ,0)) vl_total_nota_fiscal 
from	nota_fiscal n 
where	exists ( 
	select	1 
	from	w_nota_fiscal x 
	where	x.nr_seq_nota_fiscal = n.nr_sequencia) 
group by n.cd_estabelecimento;

