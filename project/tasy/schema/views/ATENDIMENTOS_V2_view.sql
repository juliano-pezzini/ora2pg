-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW atendimentos_v2 (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, cd_motivo_alta, ie_permite_visita, ie_permite_visita_rel, ie_clinica, ie_clinica_ant, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_tipo_acomod_unid, cd_convenio, cd_categoria, cd_usuario_convenio, cd_empresa, cd_tipo_acomod_conv, nr_doc_convenio, ds_setor_atendimento, ds_convenio, ds_categoria, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, ie_carater_inter_sus, nr_seq_indicacao, nr_seq_interno, cd_estabelecimento, nr_seq_tipo_acidente, dt_saida_real, nm_usuario_saida, dt_cancelamento, dt_chegada_paciente, ie_paciente_isolado) AS select	a.nr_atendimento,
	a.nr_atend_original,
	a.dt_entrada,
	a.cd_pessoa_fisica,
	a.cd_procedencia,
	a.ie_tipo_atendimento,
	a.cd_medico_resp,
	a.dt_alta,
	a.cd_motivo_alta,
	a.ie_permite_visita,
	a.ie_permite_visita_rel,
	a.ie_clinica,
	a.ie_clinica_ant,
	a.nr_seq_classificacao,
	b.dt_entrada_unidade,
	b.dt_saida_unidade,
	b.cd_setor_atendimento,
	b.cd_unidade_basica,
	b.cd_unidade_compl,
	b.cd_tipo_acomodacao cd_tipo_acomod_unid,
	c.cd_convenio,
	c.cd_categoria,
	c.cd_usuario_convenio,
	c.cd_empresa,
	c.cd_tipo_acomodacao cd_tipo_acomod_conv,
	c.nr_doc_convenio,
	s.ds_setor_atendimento,
	v.ds_convenio,
	t.ds_categoria,
	m.nm_pessoa_fisica nm_medico,
	p.nm_pessoa_fisica nm_paciente,
	p.nr_prontuario,
	p.dt_nascimento,
	p.cd_religiao,
	a.ie_carater_inter_sus,
	a.nr_seq_indicacao,
	c.nr_seq_interno,
	a.cd_estabelecimento,
	a.nr_seq_tipo_acidente,
	a.dt_saida_real,
	a.nm_usuario_saida,
	a.dt_cancelamento,
	a.dt_chegada_paciente,
        a.ie_paciente_isolado
FROM	convenio v,
	categoria_convenio t,
	setor_atendimento s,
	pessoa_fisica m,
	pessoa_fisica p,
	atend_paciente_unidade b,
	atend_categoria_convenio c,
	atendimento_paciente a
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_atendimento = c.nr_atendimento
and	c.dt_inicio_vigencia =	(select	max(w.dt_inicio_vigencia) dt_primeira_vigencia
				from	atend_categoria_convenio w
				where	w.nr_atendimento = a.nr_atendimento)
and	b.nr_seq_interno 	=
	(	select	coalesce(max(x.nr_seq_interno),0)
		from 	atend_paciente_unidade x
		where	x.nr_atendimento = a.nr_atendimento
	  	and 	coalesce(x.dt_saida_unidade, x.dt_entrada_unidade + 9999)	=
			(select max(coalesce(y.dt_saida_unidade, y.dt_entrada_unidade + 9999))
			from 	atend_paciente_unidade y
			where 	y.nr_atendimento 	= a.nr_atendimento))
and	b.cd_setor_atendimento  = s.cd_setor_atendimento
and	c.cd_convenio           = v.cd_convenio
and	a.cd_medico_resp        = m.cd_pessoa_fisica
and	a.cd_pessoa_fisica      = p.cd_pessoa_fisica
and	c.cd_convenio           = t.cd_convenio
and	c.cd_categoria          = t.cd_categoria;

