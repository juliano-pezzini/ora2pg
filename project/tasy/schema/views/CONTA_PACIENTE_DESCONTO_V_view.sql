-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_desconto_v (ds_desconto, cd_convenio, ie_emite_conta, nr_interno_conta, cd_item, ds_item, dt_item, qt_item, vl_unitario_item, vl_item, cd_setor_atendimento, ds_setor_atendimento, cd_item_convenio, ds_item_convenio, cd_unidade_medida_convenio, qt_item_convenio, vl_item_convenio, tx_conversao_qtde, nr_sequencia, nr_seq_proc_pacote, tx_item, vl_unitario_convenio, cd_unidade_medida, cd_proc_orig_pacote, vl_desconto, vl_original) AS select 'Procedimento' ds_desconto,
	a.cd_convenio, 
	'22' ie_emite_conta, 
	a.nr_interno_conta, 
	a.cd_procedimento cd_item, 
	substr(b.ds_procedimento,0,180) ds_item, 
	a.dt_procedimento dt_item, 
	a.qt_procedimento qt_item, 
	(a.vl_procedimento / a.qt_procedimento) vl_unitario_item, 
	a.vl_procedimento vl_item, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	coalesce(g.cd_procedimento,coalesce(a.cd_procedimento_convenio,a.cd_procedimento)) cd_item_convenio, 
	coalesce(g.ds_procedimento,b.ds_procedimento) ds_item_convenio, 
	g.cd_unidade_medida cd_unidade_medida_convenio, 
	(a.qt_procedimento * CASE WHEN coalesce(g.tx_conversao_qtde,0)=0 THEN 1  ELSE g.tx_conversao_qtde END ) qt_item_convenio, 
	a.vl_procedimento vl_item_convenio, 
	g.tx_conversao_qtde, 
	a.nr_sequencia, 
	a.nr_seq_proc_pacote, 
	a.tx_procedimento tx_item, 
	(a.vl_procedimento) / 
	(CASE WHEN a.qt_procedimento=0 THEN 1  ELSE a.qt_procedimento END  * 
	 CASE WHEN coalesce(g.tx_conversao_qtde,0)=0 THEN 1  ELSE g.tx_conversao_qtde END ) vl_unitario_convenio, 
	Obter_Unid_Med_Servico(a.cd_convenio,a.cd_categoria,a.cd_procedimento,a.ie_origem_proced,obter_estab_atend(a.nr_atendimento)) cd_unidade_medida, 
	CASE WHEN a.nr_seq_proc_pacote IS NULL THEN null  ELSE Obter_Proc_Origem_Pacote(a.nr_seq_proc_pacote) END  cd_proc_orig_pacote, 
	f.vl_procedimento vl_desconto, 
	(f.vl_procedimento + a.vl_procedimento) vl_original 
FROM setor_atendimento c, procedimento b, procedimento_paciente a
LEFT OUTER JOIN proc_paciente_valor f ON (a.nr_sequencia = f.nr_seq_procedimento AND 3 = f.ie_tipo_valor)
LEFT OUTER JOIN proc_paciente_convenio g ON (a.nr_sequencia = g.nr_seq_procedimento)
WHERE a.cd_procedimento = b.cd_procedimento and a.ie_origem_proced = b.ie_origem_proced and a.cd_setor_atendimento = c.cd_setor_atendimento   and coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia  
union
 
select	'Material' ds_desconto, 
	a.cd_convenio, 
	'22' ie_emite_conta, 
	a.nr_interno_conta, 
	a.cd_material cd_item, 
	(b.ds_material || '                         ') ds_item, 
	a.dt_atendimento	dt_item, 
	a.qt_material	qt_item, 
	a.vl_unitario	vl_unitario_item, 
	a.vl_material	vl_item, 
	c.cd_setor_atendimento, 
	c.ds_setor_atendimento, 
	coalesce(e.cd_material,coalesce(a.cd_material_convenio,a.cd_material)) cd_item_convenio, 
	coalesce(e.ds_material,b.ds_material) ds_item_convenio, 
	coalesce(e.cd_unidade_medida,b.cd_unidade_medida_consumo) cd_unidade_medida_convenio, 
	(a.qt_material * CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END ) qt_item_convenio, 
	a.vl_material vl_item_convenio, 
	e.tx_conversao_qtde , 
	a.nr_sequencia, 
	a.nr_seq_proc_pacote, 
	100 tx_item, 
	(a.vl_material) / 
	(CASE WHEN a.qt_material=0 THEN 1  ELSE a.qt_material END  * 
	 CASE WHEN coalesce(e.tx_conversao_qtde,0)=0 THEN 1  ELSE e.tx_conversao_qtde END ) vl_unitario_convenio, 
	a.cd_unidade_medida, 
	null, 
	f.vl_material vl_desconto, 
	(f.vl_material + a.vl_material) vl_original 
FROM setor_atendimento c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio e ON (a.nr_sequencia = e.nr_seq_material)
LEFT OUTER JOIN mat_atend_paciente_valor f ON (a.nr_sequencia = f.nr_seq_material AND 3 = f.ie_tipo_valor)
WHERE a.cd_material = b.cd_material and a.cd_setor_atendimento = c.cd_setor_atendimento;

