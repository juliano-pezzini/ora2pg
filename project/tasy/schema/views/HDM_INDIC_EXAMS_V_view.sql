-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hdm_indic_exams_v (nr_day_of_week, nr_day, si_holiday, si_weekend, dt_day, ds_day_of_week, nr_year, nr_month, nr_semester, nr_quarter, dt_month, nr_seq_patient_group, si_sex, ds_sex, nm_age_range, ds_participant, nr_seq_dm_program, nr_seq_program, nm_program, nm_program_module, nr_seq_campaign, nm_campaign, nr_seq_dm_group, nm_group, nm_group_class, nr_seq_turma, nr_seq_disease_risk, nm_disease_risk, nr_seq_reference, nm_reference_range, nm_reference_in_out, nr_seq_exam, nm_exam, nr_seq_fact, ds_result, qt_result, nr_dif_person, qt_by_fact, avg_qt_by_fact, med_qt_by_fact, avg_pr_by_fact, med_pr_by_fact) AS SELECT	/* Dados dia */
	c.nr_day_of_week,
	c.nr_day,
	c.si_holiday,
	c.si_weekend,
	c.dt_complete_date dt_day,
	c.ds_day_of_week,
	/* Dados mês */

	b.nr_year,
	b.nr_month,
	b.nr_semester,
	b.nr_quarter,
	b.dt_complete_date dt_month,
	/* Dados grupo paciente */

	a.nr_seq_patient_group,
	d.si_sex,
	d.ds_sex,
	d.nm_age_range,
	d.ds_participant,
	/* Dados programa */

	e.nr_sequencia nr_seq_dm_program,
	e.nr_seq_program nr_seq_program,
	e.nm_program,
	e.nm_program_module nm_program_module,
	/* Dados campanha */

	g.nr_sequencia nr_seq_campaign,
	g.nm_campaign,
	/* Dados grupo atividade */

	i.nr_sequencia nr_seq_dm_group,
	i.nm_group,
	i.nm_class nm_group_class,
	i.nr_seq_turma,
	/* Patologia */

	n.nr_sequencia nr_seq_disease_risk,
	n.nm_disease_risk,
	/* Dados referência */

	a.nr_seq_reference,
	k.nm_range nm_reference_range,
	CASE WHEN k.si_reference='=' THEN wheb_mensagem_pck.get_texto(309708)  ELSE wheb_mensagem_pck.get_texto(309709) END  nm_reference_in_out,
	/* Dados exame */

	l.nr_seq_exam,
	l.nm_exam,
	/* Dados fato */

	a.nr_sequencia nr_seq_fact,
	OBTER_DESC_EXPRESSAO(303885) ds_result,
	a.qt_result,
	a.nr_dif_person,
	(a.qt_result / COUNT(1) OVER (PARTITION BY a.nr_sequencia)) qt_by_fact,
	(a.vl_med_result / COUNT(1) OVER (PARTITION BY a.nr_sequencia)) AVG_QT_BY_FACT,
	(a.vl_med_result / COUNT(1) OVER (PARTITION BY a.nr_sequencia)) MED_QT_BY_FACT,
	(a.vl_avg_result / COUNT(1) OVER (PARTITION BY a.nr_sequencia)) AVG_PR_BY_FACT,
	(a.vl_avg_result / COUNT(1) OVER (PARTITION BY a.nr_sequencia)) MED_PR_BY_FACT
FROM	hdm_indic_dm_risk_disease n,
	hdm_indic_dm_activ_group i,
	hdm_indic_dm_campaign g,
	hdm_indic_dm_program e,
	hdm_indic_ft_exam_pr f,
	hdm_indic_ft_exam_cp h,
	hdm_indic_ft_exam_ag j,
	hdm_indic_ft_exam_rd o,
	hdm_indic_dm_reference k,
	hdm_indic_dm_exam l,
	hdm_indic_dm_patient_group d,
	hdm_indic_dm_month b,
	hdm_indic_dm_day c,
	hdm_indic_ft_exam a
WHERE	1 = 1
AND	f.nr_seq_dimension = e.nr_sequencia
AND	h.nr_seq_dimension = g.nr_sequencia
AND	j.nr_seq_dimension = i.nr_sequencia
AND	o.nr_seq_dimension = n.nr_sequencia
AND	a.nr_sequencia = f.nr_seq_fact
AND	a.nr_sequencia = h.nr_seq_fact
AND	a.nr_sequencia = j.nr_seq_fact
AND	a.nr_sequencia = o.nr_seq_fact
AND	a.nr_seq_reference = k.nr_sequencia
AND	a.nr_seq_exam = l.nr_sequencia
AND	a.nr_seq_patient_group = d.nr_sequencia
AND	a.nr_seq_month = b.nr_sequencia
AND	a.nr_seq_day = c.nr_sequencia;

