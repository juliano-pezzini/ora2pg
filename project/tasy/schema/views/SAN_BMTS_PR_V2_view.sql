-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_bmts_pr_v2 (cd_regional_saude, cd_banco_sangue, cd_agencia_transf, dt_mesano_transfusao, nr_bolsa, dt_transfusao, cd_hemocomponente, cd_destino_hemocomp, cd_reacao_transf, dt_dia_transfusao, dt_nascimento, nm_receptor, cd_motivo_inutil, cd_bs_destino, cd_agencia_destino, cd_vinculo_paciente) AS select	distinct(select max(cd_regional) FROM san_parametro) cd_regional_saude,
	(select coalesce(cd_externo,nr_sequencia) 
		from san_entidade 
		where nr_sequencia = f.nr_seq_entidade 
		and ie_tipo_entidade = 'B') cd_banco_sangue, 
	(select coalesce(cd_externo,nr_sequencia) 
		from san_entidade 
		where nr_sequencia = a.nr_seq_entidade 
		and ie_tipo_entidade = 'A') cd_agencia_transf, 
	dt_transfusao dt_mesano_transfusao, 
	coalesce(b.NR_SEC_SAUDE,coalesce(c.nr_bolsa,b.nr_sangue)) nr_bolsa, 
	a.dt_transfusao, 
	d.sg_sigla cd_hemocomponente, 
	CASE WHEN b.nr_seq_inutil IS NULL THEN '1'  ELSE '3' END  cd_destino_hemocomp, 
	e.nr_seq_reacao cd_reacao_transf, 
	dt_transfusao dt_dia_transfusao, 
	obter_dados_pf(a.cd_pessoa_fisica,'DN') dt_nascimento, 
	rpad(obter_nome_pf(a.cd_pessoa_fisica),60,' ') nm_receptor, 
	b.nr_seq_inutil cd_motivo_inutil, 
	(select coalesce(cd_externo,nr_sequencia) 
		from san_entidade 
		where nr_sequencia = g.nr_seq_entidade 
		and ie_tipo_entidade = 'B') cd_bs_destino, 
	(select coalesce(cd_externo,nr_sequencia) 
		from san_entidade 
		where nr_sequencia = g.nr_seq_entidade 
		and ie_tipo_entidade = 'A') cd_agencia_destino, 
	CASE WHEN obter_dados_atendimento(a.nr_atendimento,'TC')=1 THEN 03 WHEN obter_dados_atendimento(a.nr_atendimento,'TC')=2 THEN 02 WHEN obter_dados_atendimento(a.nr_atendimento,'TC')=3 THEN 01  ELSE null END  cd_vinculo_paciente 
FROM san_derivado d, san_transfusao a, san_producao b
LEFT OUTER JOIN san_doacao c ON (b.nr_seq_doacao = c.nr_sequencia)
LEFT OUTER JOIN san_trans_reacao e ON (b.nr_sequencia = e.nr_seq_producao)
LEFT OUTER JOIN san_emprestimo g ON (b.nr_seq_emp_saida = g.nr_sequencia)
LEFT OUTER JOIN san_emprestimo f ON (b.nr_seq_emp_ent = f.nr_sequencia)
WHERE a.nr_sequencia = b.nr_seq_transfusao  and d.nr_sequencia = b.nr_seq_derivado    and a.ie_status = 'F';

