-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW prescr_proc_pacs_mmed_v (cd_pessoa_fisica, nr_seq_interno, nr_prescricao, nr_sequencia, cd_procedimento, ds_procedimento, cd_tipo_procedimento, qt_procedimento, dt_atualizacao, nm_usuario, ds_observacao, ie_origem_proced, ie_urgencia, ds_dado_clinico, ie_suspenso, cd_setor_atendimento, nr_atendimento, cd_medico, dt_prescricao, dt_liberacao, dt_liberacao_medico, ie_recem_nato, cd_setor_paciente, nm_paciente, dt_nascimento, ie_sexo, nr_cpf, nr_prontuario, nm_medico, nr_crm, cd_convenio, cd_categoria, cd_usuario_convenio, ds_convenio, cd_material_exame, ds_material_especial, ie_amostra_entregue, ds_horarios, nr_seq_exame, ds_endereco, nr_endereco, ds_complemento, ds_bairro, ds_municipio, sg_estado, nr_telefone, cd_cep, dt_prev_execucao, ds_setor_paciente, cd_unidade, ie_executar_leito, ds_modalidade, na_accessionnumber, ie_tipo_atendimento, nr_seq_proc_interno, cd_plano_convenio, cd_plano, cd_agenda, ds_agenda, cd_procedencia, ds_procedencia, cd_compl_conv, dt_validade_carteira, dt_resultado, ds_senha, dt_agenda, ds_classif_triagem, nr_classif_triagem) AS select  b.cd_pessoa_fisica,
	a.nr_seq_interno,
	a.nr_prescricao,
	a.nr_sequencia,
	a.cd_procedimento,
	p.ds_procedimento,
	p.cd_tipo_procedimento,
	a.qt_procedimento,
	a.dt_atualizacao,
	a.nm_usuario,
	a.ds_observacao,
	a.ie_origem_proced,
	a.ie_urgencia,
	a.ds_dado_clinico,
	a.ie_suspenso,
	a.cd_setor_atendimento,
	b.nr_atendimento,
 	b.cd_medico,
 	b.dt_prescricao,
	b.dt_liberacao,
	b.dt_liberacao_medico,
	b.ie_recem_nato,
	g.cd_setor_atendimento cd_setor_paciente,
	c.nm_pessoa_fisica nm_paciente,
	c.dt_nascimento,
	c.ie_sexo,
	c.nr_cpf,
	c.nr_prontuario,
	d.nm_pessoa_fisica nm_medico,
	e.nr_crm,
	f.cd_convenio,	
	f.cd_categoria,
	f.cd_usuario_convenio,
	v.ds_convenio,
	a.cd_material_exame,
	a.ds_material_especial,
	coalesce(a.ie_amostra,'N') ie_amostra_entregue,
	a.ds_horarios,
	a.nr_seq_exame,
	z.ds_endereco,
	z.nr_endereco,
	z.ds_complemento,
	z.ds_bairro,
	z.ds_municipio,
	z.sg_estado,
	z.nr_telefone,
	z.cd_cep,
	a.dt_prev_execucao,
	s.ds_setor_atendimento ds_setor_paciente,
	g.cd_unidade_basica || ' ' || cd_unidade_compl cd_unidade,
	a.ie_executar_leito,
	obter_modalidade_wtt(p.cd_tipo_procedimento) ds_modalidade,
	a.nr_acesso_dicom na_accessionnumber,
	t.ie_tipo_atendimento,
	a.nr_seq_proc_interno,
	f.cd_plano_convenio,
	f.cd_plano_convenio cd_plano,
	h.cd_agenda,
	(select	x.ds_agenda
	FROM 	agenda x
	where 	x.cd_agenda = h.cd_agenda) ds_agenda,
	coalesce(n.cd_procedencia_externo, n.cd_procedencia) cd_procedencia,
	n.ds_procedencia ds_procedencia,
	f.cd_complemento cd_compl_conv,
	f.dt_validade_carteira,
	a.dt_resultado,
	t.ds_senha,
	h.hr_inicio dt_agenda,
	substr(obter_desc_triagem(obter_classif_triagem_mmed(t.nr_atendimento)),1,255) ds_classif_triagem,
	obter_classif_triagem_mmed(t.nr_atendimento) nr_classif_triagem	
FROM dual x, convenio v, atendimento_paciente t, setor_atendimento s, procedimento p, procedencia n, atend_paciente_unidade g, atend_categoria_convenio f, pessoa_fisica d, pessoa_fisica c, prescr_medica b
LEFT OUTER JOIN compl_pessoa_fisica z ON (b.cd_pessoa_fisica = z.cd_pessoa_fisica AND 1 = z.ie_tipo_complemento)
LEFT OUTER JOIN medico e ON (b.cd_medico = e.cd_pessoa_fisica)
, prescr_procedimento a
LEFT OUTER JOIN agenda_paciente h ON (a.nr_seq_agenda = h.nr_sequencia)
WHERE a.cd_procedimento		= p.cd_procedimento and a.ie_origem_proced		= p.ie_origem_proced and a.nr_prescricao 		= b.nr_prescricao and b.cd_pessoa_fisica 		= c.cd_pessoa_fisica and g.cd_setor_atendimento	= s.cd_setor_atendimento and t.cd_procedencia		= n.cd_procedencia and f.nr_atendimento  		= b.nr_atendimento and t.nr_atendimento  		= b.nr_atendimento  and a.dt_integracao is null and a.nr_seq_exame is null and p.cd_tipo_procedimento in(select x.cd_tipo_procedimento
				 from	 mmed_tipo_procedimento x
				 where	 x.nr_seq_parametro_mmed = (select max(y.nr_sequencia) 
								    from mmed_parametro_integracao y)) and a.cd_motivo_baixa in (0, 1) and coalesce(dt_liberacao_medico, dt_liberacao) is not null   and b.cd_medico 		= d.cd_pessoa_fisica  and g.nr_seq_interno		= obter_atepacu_paciente(b.nr_atendimento,'A') and a.cd_setor_atendimento in (select s.cd_setor_atendimento
			from setor_atendimento s
			where ((upper(s.nm_usuario_banco) = (select max(x.nm_usuario_banco)
							     from mmed_parametro_integracao x)) or (upper(s.nm_usuario_banco) = (select user )))) and (f.nr_seq_interno 	= (select max(y.nr_seq_interno)
			from atend_categoria_convenio y
			where y.nr_atendimento = b.nr_atendimento
			and y.dt_inicio_vigencia = (select max(w.dt_inicio_vigencia)
					from atend_categoria_convenio w
					where w.nr_atendimento = b.nr_atendimento))) and f.cd_convenio           = v.cd_convenio;

