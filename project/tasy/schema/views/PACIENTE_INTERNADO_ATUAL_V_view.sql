-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW paciente_internado_atual_v (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, cd_motivo_alta, ie_permite_visita, ie_permite_visita_rel, ie_clinica, ie_clinica_ant, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, dt_saida_interno, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_unidade, cd_tipo_acomod_unid, cd_tipo_acomod_conv, ds_setor_atendimento, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, cd_convenio, cd_categoria, cd_usuario_convenio, nr_doc_convenio, cd_plano_convenio, ds_convenio, ds_categoria, cd_classif_setor, qt_dia_longa_perm, dt_previsto_alta, qt_dia_internacao, dt_alta_convenio, nr_anos, nr_ramal, ie_sexo, ie_paciente_isolado, ie_status_unidade, ie_carater_inter_sus, ie_probabilidade_alta, nr_seq_indicacao, cd_estabelecimento, ie_temporario, ds_probabilidade, cd_empresa, nr_seq_tipo_acidente, dt_entrada_internacao, ds_observacao, cd_setor_atual, dt_alta_medico, nr_doc_conv_principal, dt_ver_prev_alta, dt_saida_real, nm_usuario_saida, dt_cancelamento, ds_nivel_urgencia, nr_seq_agrupamento, nr_seq_triagem_prioridade, ie_boletim_inform, ie_leito_adapt, ie_leito_adaptado, dt_saida_temporaria, dt_retorno_saida_temporaria, nr_episodio) AS select
	a.nr_atendimento,
	a.nr_atend_original,
	a.dt_entrada,
	a.cd_pessoa_fisica,
	a.cd_procedencia,
	a.ie_tipo_atendimento,
	a.cd_medico_resp,
	a.dt_alta,
	a.cd_motivo_alta,
	a.ie_permite_visita,
	a.ie_permite_visita_rel,
	a.ie_clinica,
	a.ie_clinica_ant,
	a.nr_seq_classificacao,
	b.dt_entrada_unidade,
	b.dt_saida_unidade,
	b.dt_saida_interno,
	u.cd_setor_atendimento,
	u.cd_unidade_basica,
	u.cd_unidade_compl,
	(u.cd_unidade_basica ||' '||u.cd_unidade_compl) cd_unidade,
	b.cd_tipo_acomodacao cd_tipo_acomod_unid,
	c.cd_tipo_acomodacao cd_tipo_acomod_conv,
	s.ds_setor_atendimento,
	m.nm_pessoa_fisica nm_medico,
	p.nm_pessoa_fisica nm_paciente,
	substr(obter_prontuario_pf(a.cd_estabelecimento,a.cd_pessoa_fisica),1,255) nr_prontuario,
	p.dt_nascimento,
	p.cd_religiao,
	c.cd_convenio,
	c.cd_categoria,
	c.cd_usuario_convenio,
	c.nr_doc_convenio,
	c.cd_plano_convenio,
	v.ds_convenio,
	t.ds_categoria,
	s.cd_classif_setor,
	a.qt_dia_longa_perm,
	a.dt_previsto_alta,
	c.qt_dia_internacao,
	(a.dt_entrada + c.qt_dia_internacao) dt_alta_convenio,
	somente_numero(SUBSTR(TRUNC(pkg_date_utils.get_DiffDate(p.dt_nascimento, LOCALTIMESTAMP, 'YEAR')),1,40)) nr_anos,
	u.nr_ramal,
	p.ie_sexo,
	a.ie_paciente_isolado,
	u.ie_status_unidade,
	a.ie_carater_inter_sus,
	a.ie_probabilidade_alta,
	a.nr_seq_indicacao,
	a.cd_estabelecimento,
	u.ie_temporario,
	substr(obter_valor_dominio(1267,a.ie_probabilidade_alta),1,40) ds_probabilidade,
	c.cd_empresa,
	a.nr_seq_tipo_acidente,
	to_date(obter_unidade_atendimento(a.nr_atendimento,'PI','DT'),'dd/mm/yyyy hh24:mi:ss') dt_entrada_internacao,
	a.ds_observacao,
	b.cd_setor_atendimento cd_setor_atual,
	a.dt_alta_medico,
	c.nr_doc_conv_principal,
	a.dt_ver_prev_alta,
	a.dt_saida_real,
	a.nm_usuario_saida,
	a.dt_cancelamento,
	substr(coalesce(obter_desc_triagem(a.nr_seq_triagem),obter_desc_expressao(309956)),1,100) ds_nivel_urgencia,
	s.nr_seq_agrupamento,
	a.nr_seq_triagem_prioridade,
	coalesce(a.ie_boletim_inform,'S') ie_boletim_inform,
	coalesce(u.ie_leito_adaptado, 'N') ie_leito_adapt,
	coalesce(u.ie_leito_adaptado, 'N') ie_leito_adaptado,
	b.dt_saida_temporaria,
	b.dt_retorno_saida_temporaria,
	substr(OBTER_EPISODIO_ATEND_TELA(a.nr_atendimento),1,80) nr_episodio
FROM	pessoa_fisica m,
	pessoa_fisica p,
	atend_categoria_convenio c,
	categoria_convenio t,
	convenio v,
	atendimento_paciente a,
	atend_paciente_unidade b,
	unidade_atendimento u,
	setor_atendimento s
where	u.dt_entrada_unidade	= b.dt_entrada_unidade
and	u.cd_setor_atendimento  = s.cd_setor_atendimento
and	a.cd_medico_resp	= m.cd_pessoa_fisica
and	a.cd_pessoa_fisica	= p.cd_pessoa_fisica
and	c.cd_convenio		= v.cd_convenio
and	c.cd_convenio		= t.cd_convenio
and	c.cd_categoria		= t.cd_categoria
and	c.nr_seq_interno	= 	(	SELECT	MAX(nr_seq_interno)
						FROM 	atend_categoria_convenio z
						WHERE	z.nr_atendimento 		= a.nr_atendimento
						AND 	z.dt_inicio_vigencia	=	(	SELECT 	MAX(x.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio x
												WHERE 	x.nr_atendimento = a.nr_atendimento
											)
					)
and	s.cd_classif_setor in ('3','4','11','12')
and	a.nr_atendimento	= c.nr_atendimento
and	a.nr_atendimento	= b.nr_atendimento
and	u.nr_atendimento	= a.nr_atendimento
and	u.nr_atendimento	= b.nr_atendimento;

