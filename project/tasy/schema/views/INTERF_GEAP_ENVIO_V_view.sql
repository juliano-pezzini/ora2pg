-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_geap_envio_v (tp_reg, tp_registro, nm_arquivo, ds_versao, nr_interno_conta, nr_seq_protocolo, ds_espaco, cd_contratado, nm_contratado, dt_referencia, nr_remessa, ds_observacao, nr_sequencia, nr_guia, tp_guia, nr_carteira_cliente, nm_cliente, ie_carater_atend, cd_motivo_cobranca, dt_atendimento, dt_inicio_cirurgia, dt_alta, nr_autorizacao, tp_internacao, cd_especialidade, cd_cid, nr_controle, cd_cpf_medico, ds_sigla_crm, nr_crm_medico, uf_crm_medico, ds_servico, nr_seq_folha, nr_seq_item, cd_servico, cd_local_atend, cd_tabela_aux, tx_adicional_hor, qt_servico, vl_servico, qt_total_itens, qt_total_servico, vl_total_servico, cd_material, cd_unidade_medida, cd_unidade_apres, qt_unidade_apres, cd_simpro, dt_execucao, ie_matmed, cd_unidade_cobr, qt_material, vl_material, ds_material, dt_geracao, ds_email, ds_telefone, qt_total_guia, vl_total_guia, ds_responsavel, cd_med_bras) AS select
	1 					tp_reg, 
	0 					tp_registro, 
	'GEAPFAT'				nm_arquivo, 
	'3.00'				ds_versao, 
	0					nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	substr(a.nm_hospital,1,30)	nm_contratado, 
	b.dt_mesano_referencia		dt_referencia, 
	1					nr_remessa, 
	' '					ds_observacao, 
	0					nr_sequencia, 
	0					nr_guia, 
	0					tp_guia, 
	0					nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	''					ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	0					cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM	protocolo_convenio b, 
	w_interf_conta_header a 
where	a.nr_seq_protocolo = b.nr_seq_protocolo 

union all
 
select 
	2 					tp_reg, 
	1 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa, 
	''					ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio) nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	substr(a.nm_paciente,1,30)	nm_cliente, 
	CASE WHEN a.ie_carater_inter='E' THEN 1  ELSE 2 END  
						ie_carater_atend, 
	a.cd_motivo_alta			cd_motivo_cobranca, 
	a.dt_entrada			dt_atendimento, 
	coalesce(to_char(c.dt_inicio_real,'yyyymmdd'), '00000000')			dt_inicio_cirurgia, 
	a.dt_alta				dt_alta, 
	somente_numero(coalesce(b.cd_senha,'0')) 
						nr_autorizacao, 
	a.ie_tipo_atendimento			tp_internacao, 
	somente_numero(obter_especialidade_medico(a.cd_medico_resp, 'C')) cd_especialidade, 
	substr(a.cd_cid_principal,1,4) 
						cd_cid, 
	a.nr_interno_conta		nr_controle, 
	somente_numero(coalesce(a.nr_cpf_medico_resp,'0')) 
						cd_cpf_medico, 
	'CRM '				ds_sigla_crm, 
	somente_numero(coalesce(substr(a.nr_crm_medico_resp,1,6),'0')) 
						nr_crm_medico, 
	a.uf_crm_medico_resp		uf_crm_medico, 
	''					ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	0					cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
LEFT OUTER JOIN cirurgia c ON (a.nr_cirurgia = c.nr_cirurgia)
WHERE b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  
union all
 
select 
	3 					tp_reg, 
	2 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa,''	ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)	nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	substr(c.ds_item,1,30)		ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)) 
						cd_servico, 
	CASE WHEN d.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE d.cd_tipo_acomodacao END  cd_local_atend, 
	c.cd_funcao_executor		cd_tabela_aux, 
	c.pr_hora_extra			tx_adicional_hor, 
	campo_numerico(campo_mascara(sum(c.qt_item),2))		qt_servico, 
--	c.vl_total_item			vl_servico, 
	0			vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade d, w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 1 and c.nr_atendimento	= d.nr_atendimento and c.cd_setor_atendimento	= d.cd_setor_atendimento and c.dt_entrada_unidade	= d.dt_entrada_unidade and c.vl_total_item		<> 0 and c.qt_item		<> 0 and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')), 
	substr(c.ds_item,1,30), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	CASE WHEN d.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE d.cd_tipo_acomodacao END , 
	c.cd_funcao_executor, 
	c.pr_hora_extra 

union all
 
select 
	3 					tp_reg, 
	2 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa,''	ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)			nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	'Medicamentos'			ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030256				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	in (2,3) group by 
	a.nr_interno_conta, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 

union all
 
select 
	3 					tp_reg, 
	2 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa,''	ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio) nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	'Materiais'				ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030264				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and not c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	a.nr_seq_protocolo 

union all
 
select 
	3 					tp_reg, 
	2 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa,''	ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)	nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	c.ds_item			ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8))	cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	c.ds_item, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	a.nr_seq_protocolo 

union all
 
select 
	4 					tp_reg, 
	3 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	nr_interno_conta		nr_interno_conta, 
	nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa, 
	''					ds_observacao, 
	0					nr_sequencia, 
	nr_guia, 
	tp_guia, 
	nr_carteira_cliente, 
	nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	'' ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	0					cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	count(*)			qt_total_itens, 
	campo_numerico(campo_mascara(sum(qt_servico),2))			qt_total_servico, 
	sum(vl_servico)		vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
from 
(select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	substr(c.ds_item,1,30)		ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)) 
						cd_servico, 
	0 cd_local_atend, 
	c.cd_funcao_executor		cd_tabela_aux, 
	c.pr_hora_extra			tx_adicional_hor, 
	campo_numerico(campo_mascara(sum(c.qt_item),2))		qt_servico, 
	0			vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade d, w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 1 and c.nr_atendimento	= d.nr_atendimento and c.cd_setor_atendimento	= d.cd_setor_atendimento and c.dt_entrada_unidade	= d.dt_entrada_unidade and c.vl_total_item		<> 0 and c.qt_item		<> 0 and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')), 
	substr(c.ds_item,1,30), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	CASE WHEN d.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE d.cd_tipo_acomodacao END , 
	c.cd_funcao_executor, 
	c.pr_hora_extra 

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Medicamentos'			ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030256				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  		cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	in (2,3) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)	nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Materiais'				ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030264				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and not c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)	nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Materiais'				ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030264				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	c.cd_item, 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END ) alias171 
group by nr_interno_conta, 
	nr_seq_protocolo, 
	nr_carteira_cliente, 
	nr_guia, 
	tp_guia, 
	nm_cliente 

union all
 
select 
	5 					tp_reg, 
	4 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa, 
	''					ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)			nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	''					ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	c.cd_setor_atendimento		cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)) 
						cd_material, 
	substr(c.cd_unidade_medida,1,4) 
						cd_unidade_medida, 
	' '					cd_unidade_apres, 
	coalesce(max(d.qt_conversao_mg),1)			qt_unidade_apres, 
	max(c.cd_simpro)				cd_simpro, 
	max(c.dt_item)				dt_execucao, 
	CASE WHEN d.ie_tipo_material='2' THEN 1 WHEN d.ie_tipo_material='3' THEN 1  ELSE 2 END  
						ie_matmed, 
	substr(c.cd_unidade_medida,1,4) 
						cd_unidade_cobr, 
	campo_numerico(CASE WHEN length(to_char(round(sum(c.qt_item))))=3 THEN  campo_mascara(round(sum(c.qt_item)),1)  ELSE campo_mascara(sum(c.qt_item),1) END )			qt_material, 
	sum(c.vl_total_item)		vl_material, 
	substr(c.ds_item,1,60)		ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	max((select max(x.cd_medicamento) FROM d
LEFT OUTER JOIN material_brasindice x ON (d.cd_material = x.cd_material) )) cd_med_bras 
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.vl_total_item		<> 0 and c.qt_item		<> 0 and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	in (2,3) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	c.cd_setor_atendimento, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	substr(c.cd_unidade_medida,1,4), 
	CASE WHEN d.ie_tipo_material='2' THEN 1 WHEN d.ie_tipo_material='3' THEN 1  ELSE 2 END , 
	substr(c.cd_unidade_medida,1,4), 
	substr(c.ds_item,1,60) 
having 	sum(c.vl_total_item) > 0 

union all
 
select 
	5 					tp_reg, 
	4 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa, 
	''					ds_observacao, 
	0					nr_sequencia, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)			nr_guia, 
	max(CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END )	tp_guia, 
	max(somente_numero(coalesce(a.cd_usuario_convenio,'0'))) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	''					ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	c.cd_setor_atendimento		cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)) 
						cd_material, 
	substr(c.cd_unidade_medida,1,4) 
						cd_unidade_medida, 
	' '					cd_unidade_apres, 
	coalesce(max(d.qt_conversao_mg),1)		qt_unidade_apres, 
	max(c.cd_simpro)				cd_simpro, 
	max(c.dt_item)				dt_execucao, 
	CASE WHEN d.ie_tipo_material='2' THEN 1 WHEN d.ie_tipo_material='3' THEN 1  ELSE 2 END  
						ie_matmed, 
	substr(c.cd_unidade_medida,1,4) 
						cd_unidade_cobr, 
	campo_numerico(CASE WHEN length(to_char(round(sum(c.qt_item))))=3 THEN  campo_mascara(round(sum(c.qt_item)),1)  ELSE campo_mascara(sum(c.qt_item),1) END )			qt_material, 
	sum(c.vl_total_item)			vl_material, 
	substr(c.ds_item,1,60)		ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	e.cd_medicamento			cd_med_bras 
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
LEFT OUTER JOIN material_brasindice e ON (d.cd_material = e.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.vl_total_item		<> 0 and c.qt_item		<> 0 and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3)  group by a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	c.cd_setor_atendimento, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	substr(c.cd_unidade_medida,1,4), 
	coalesce(d.qt_conversao_mg,1), 
	substr(c.ds_item,1,60), 
	CASE WHEN d.ie_tipo_material='2' THEN 1 WHEN d.ie_tipo_material='3' THEN 1  ELSE 2 END , 
	substr(c.cd_unidade_medida,1,4), 
	e.cd_medicamento 
having 	sum(c.vl_total_item) > 0 

union all
 
select 
	9 					tp_reg, 
	9 					tp_registro, 
	''					nm_arquivo, 
	''					ds_versao, 
	9999999999				nr_interno_conta, 
	nr_seq_protocolo, 
	' '					ds_espaco, 
	'11010673'				cd_contratado, 
	''					nm_contratado, 
	LOCALTIMESTAMP				dt_referencia, 
	0					nr_remessa, 
	''					ds_observacao, 
	0					nr_sequencia, 
	0 nr_guia, 
	0					tp_guia, 
	0					nr_carteira_cliente, 
	''					nm_cliente, 
	0					ie_carater_atend, 
	0					cd_motivo_cobranca, 
	LOCALTIMESTAMP				dt_atendimento, 
	''				dt_inicio_cirurgia, 
	LOCALTIMESTAMP				dt_alta, 
	0					nr_autorizacao, 
	0					tp_internacao, 
	0					cd_especialidade, 
	''					cd_cid, 
	0					nr_controle, 
	0					cd_cpf_medico, 
	''					ds_sigla_crm, 
	0					nr_crm_medico, 
	''					uf_crm_medico, 
	''					ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	0					cd_servico, 
	0					cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	0					qt_servico, 
	0					vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	trunc(LOCALTIMESTAMP)			dt_geracao, 
	'faturamento@hvc.com.br'		ds_email, 
	'3290-1095'			ds_telefone, 
	0					qt_total_guia, 
	sum(vl_servico)			vl_total_guia, 
	'Selma'				ds_responsavel, 
	''					cd_med_bras 
from 
(select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	substr(c.ds_item,1,30)		ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)) 
						cd_servico, 
	0 cd_local_atend, 
	c.cd_funcao_executor		cd_tabela_aux, 
	c.pr_hora_extra			tx_adicional_hor, 
	campo_numerico(campo_mascara(sum(c.qt_item),2))		qt_servico, 
	0			vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade d, w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 1 and c.nr_atendimento	= d.nr_atendimento and c.cd_setor_atendimento	= d.cd_setor_atendimento and c.dt_entrada_unidade	= d.dt_entrada_unidade and c.vl_total_item		<> 0 and c.qt_item		<> 0 and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')), 
	substr(c.ds_item,1,30), 
	somente_numero(substr(coalesce(c.cd_item_convenio,'0'),1,8)), 
	CASE WHEN d.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE d.cd_tipo_acomodacao END , 
	c.cd_funcao_executor, 
	c.pr_hora_extra 

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Medicamentos'			ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030256				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  		cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	in (2,3) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Materiais'				ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030264				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and not c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	a.nr_seq_protocolo, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 

union all
 
select 
	a.nr_interno_conta		nr_interno_conta, 
	a.nr_seq_protocolo		nr_seq_protocolo, 
	Obter_Guia_Geap(a.nr_seq_conta_convenio)		nr_guia, 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END  
						tp_guia, 
	somente_numero(coalesce(a.cd_usuario_convenio,'0')) 
						nr_carteira_cliente, 
	''					nm_cliente, 
	'Materiais'				ds_servico, 
	0					nr_seq_folha, 
	0					nr_seq_item, 
	98030264				cd_servico, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END  cd_local_atend, 
	0					cd_tabela_aux, 
	0					tx_adicional_hor, 
	1					qt_servico, 
	sum(c.vl_total_item)		vl_servico, 
	0					qt_total_itens, 
	0					qt_total_servico, 
	0					vl_total_servico, 
	0					cd_material, 
	''					cd_unidade_medida, 
	' '					cd_unidade_apres, 
	0					qt_unidade_apres, 
	0					cd_simpro, 
	LOCALTIMESTAMP				dt_execucao, 
	0					ie_matmed, 
	''					cd_unidade_cobr, 
	0					qt_material, 
	0					vl_material, 
	''					ds_material, 
	LOCALTIMESTAMP				dt_geracao, 
	''					ds_email, 
	''					ds_telefone, 
	0					qt_total_guia, 
	0					vl_total_guia, 
	''					ds_responsavel, 
	''					cd_med_bras 
FROM atend_paciente_unidade e, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
, w_interf_conta_item c
LEFT OUTER JOIN material d ON (c.cd_item = d.cd_material)
WHERE c.nr_interno_conta	= a.nr_interno_conta and c.ie_tipo_item		= 2 and c.nr_atendimento	= e.nr_atendimento and c.cd_setor_atendimento	= e.cd_setor_atendimento and c.dt_entrada_unidade	= e.dt_entrada_unidade and c.cd_subgrupo_mat in (68,101,93) and b.nr_sequencia		= 
	(select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
		from w_interf_conta_autor x 
		where a.nr_interno_conta = x.nr_interno_conta)  and d.ie_tipo_material	not in (2,3) group by 
	a.nr_interno_conta, 
	c.cd_item, 
	a.nr_seq_protocolo, 
	CASE WHEN e.cd_tipo_acomodacao=0 THEN  		somente_numero(obter_unidade_atendimento(a.nr_atendimento, 'IA', 'CTA'))  ELSE e.cd_tipo_acomodacao END , 
	Obter_Guia_Geap(a.nr_seq_conta_convenio), 
	CASE WHEN b.ie_tipo_guia='I' THEN 1  ELSE 2 END , 
	somente_numero(coalesce(a.cd_usuario_convenio,'0'))) alias323 
group by nr_seq_protocolo;

