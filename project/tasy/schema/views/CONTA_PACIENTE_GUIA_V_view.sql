-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_guia_v (nr_atendimento, nr_interno_conta, dt_acerto_conta, nr_doc_convenio, ie_tipo_guia, vl_item, vl_participante) AS select 	x.nr_atendimento,
		a.nr_interno_conta, 
		min(coalesce(coalesce(a.dt_acerto_conta,a.dt_conta),x.dt_acerto_conta)) dt_acerto_conta, 
		coalesce(a.nr_doc_convenio,coalesce(to_char(x.nr_conta_convenio),'Não Informada')) nr_doc_convenio, 
		max(a.ie_tipo_guia) ie_tipo_guia, 
		sum(a.vl_item) vl_item, 
		0 vl_participante 
	FROM	convenio c, 
		conta_paciente_v a, 
		conta_paciente x 
	where	a.nr_interno_conta 	= x.nr_interno_conta 
	and	a.cd_motivo_exc_conta 	is null 
	and	coalesce(a.nr_seq_proc_pacote,a.nr_sequencia) = a.nr_sequencia 
	and	x.cd_convenio_parametro	= c.cd_convenio 
	and	((c.ie_tipo_convenio <> 3) or (a.ie_proc_mat = 1)) 
	group 	by x.nr_atendimento, 		a.nr_interno_conta, 
		coalesce(a.nr_doc_convenio,coalesce(to_char(x.nr_conta_convenio),'Não Informada')) 
	
union
 
	select	a.nr_atendimento,				 
		a.nr_interno_conta, 
		coalesce(coalesce(b.dt_acerto_conta, b.dt_conta),a.dt_acerto_conta), 
		c.NR_DOC_HONOR_CONV, 
		b.ie_tipo_guia, 
		0 vl_item, 
		sum(c.vl_participante) 
	from	procedimento_participante c, 
		procedimento_paciente b, 
		conta_paciente a 
	where	a.nr_interno_conta	= b.nr_interno_conta 
	and	b.nr_sequencia		= c.nr_sequencia 
	and	b.cd_motivo_exc_conta	is null 
	and	c.NR_DOC_HONOR_CONV	is not null 
	group by a.nr_atendimento,				 
		 a.nr_interno_conta, 
		 coalesce(coalesce(b.dt_acerto_conta, b.dt_conta),a.dt_acerto_conta), 
		 c.NR_DOC_HONOR_CONV, 
		 b.ie_tipo_guia;

