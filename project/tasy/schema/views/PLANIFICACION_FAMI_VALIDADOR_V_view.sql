-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW planificacion_fami_validador_v (ie_tipo_registro, cabecario, clues, curpprestador, nombreprestador, primerapellidoprestador, segundoapellidoprestador, tipopersonal, especificatipopersonal, cedulaprofesional, servicioatencion, especificarservicio, curppaciente, nombre, primerapellido, segundoapellido, fechanacimiento, entidadenacimiento, edad, claveedad, sexo, seconsideraindigena, spss, numeroafiliacionspss, prospera, folioprospera, imss, numeroafiliacionimss, issste, numeroafiliacionissste, otraafiliacion, numerootraafiliacion, peso, talla, tipodificultad, gradodificultad, origendificultad, migrante, fechaconsulta, relaciontemporal, descripciondiagnostico1, primeravezdiagnostico1, suivecausesdiagnostico1, codigociediagnostico1, descripciondiagnostico2, primeravezdiagnostico2, suivecausesdiagnostico2, codigociediagnostico2, programa, primeravezanio, oral, inyectablemensal, inyectablebimestral, implantesubdermico, parchedermico, diu, diumedicado, quirurgico, preservativo, preservativofemenino, otrometodo, orientacionpf, anticoncepcionemergencia, vasectomiasinbisturi, altaconazoospermia, lineavida, cartillavacunacion, referido, contrarreferido, telemedicina, dt_entrada, cd_pessoa_fisica, nr_atendimento, cd_cgc, ds_convenio, cd_medico) AS select
	2 ie_tipo_registro,
	'' cabecario,
	pj.cd_internacional clues,
	coalesce(substr(upper(pj.cd_curp),1,18), 'XXXX999999XXXXXX99') curpprestador,
	pj.ds_razao_social nombreprestador,
	pj.nm_fantasia primerapellidoprestador,
	pj.ds_nome_abrev segundoapellidoprestador,
	profissional.ie_profissional tipopersonal,
	CASE WHEN profissional.ie_profissional='12' THEN obter_desc_expressao(308221) END  especificatipopersonal,
	case
		when profissional.ie_profissional in ('2','3','4','6','8')
		then lpad(coalesce(pf_m.ds_codigo_prof, m.nr_crm),8,0)
	end as cedulaprofesional,
	CASE WHEN b.ie_clinica=2 THEN 3 WHEN b.ie_clinica=1 THEN 4 WHEN b.ie_clinica=3 THEN 5 WHEN b.ie_clinica=1000 THEN 6 WHEN b.ie_clinica=1001 THEN 7 WHEN b.ie_clinica=1002 THEN 8 WHEN b.ie_clinica=1004 THEN 9 WHEN b.ie_clinica=1005 THEN 13 WHEN b.ie_clinica=1006 THEN 14 WHEN b.ie_clinica=4 THEN 16 WHEN b.ie_clinica=1007 THEN 17 WHEN b.ie_clinica=1008 THEN 22 WHEN b.ie_clinica=1009 THEN 23 END  servicioatencion,
	'' especificarservicio,
	pf_p.cd_curp curppaciente,
	y.ds_given_name nombre,
	y.ds_family_name primerapellido,
	y.ds_component_name_1 segundoapellido,
	LOCALTIMESTAMP fechanacimiento,
	ce.cd_entidade entidadenacimiento,
        case
		when obter_idade(pf_p.dt_nascimento, b.dt_entrada, 'A') is not null
		then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_entrada,'IDADE')
	end as edad,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_entrada, 'A') is not null
		then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_entrada,'CLAVEEDAD')
	end as claveedad,
	pf_p.ie_sexo sexo,
	pf_p.nr_seq_cor_pele seconsideraindigena,
	pf_p.nr_spss spss,
	pf_p.nr_spss numeroafiliacionspss,
	n.cd_tipo_convenio_mx prospera,
	p.nr_doc_convenio folioprospera,
	n.cd_tipo_convenio_mx imss,
	p.nr_doc_convenio numeroafiliacionimss,
	n.cd_tipo_convenio_mx issste,
	p.nr_doc_convenio numeroafiliacionissste,
	n.cd_tipo_convenio_mx otraafiliacion,
	p.nr_doc_convenio numerootraafiliacion,
	coalesce(coalesce((select	max(qt_peso)
		FROM	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
		from	atendimento_sinal_vital
		where	qt_peso is not null
		and	nr_atendimento	= b.nr_atendimento
		and	coalesce(ie_situacao,'A') = 'A'
		and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_peso), '999') peso,
	coalesce(coalesce((select	max(qt_altura_cm)
		from	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
		from	atendimento_sinal_vital
		where	qt_altura_cm is not null
		and	nr_atendimento	= b.nr_atendimento
		and	coalesce(ie_situacao,'A') = 'A'
		and	coalesce(ie_rn,'A')	= 'A')), pf_p.qt_altura_cm), '999') talla,
	(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) tipodificultad,
	case
		when(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) = 56
		then 9
		else CASE WHEN(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica)=56 THEN 9  ELSE (select max(ptd.ie_grau_deficiencia) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) END
	end as gradodificultad,
	case
		when(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) = 56
		then 9
		else (select max(ptd.nr_seq_causa_lesao) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica)
	end as origendificultad,
	null migrante,
	LOCALTIMESTAMP fechaconsulta,
	CASE WHEN(select count(*) from atendimento_paciente ap where (to_char(ap.dt_entrada, 'yyyy') = extract(year from b.dt_entrada)) and b.nr_atendimento = ap.nr_atendimento) IS NULL THEN 0  ELSE 1 END  relaciontemporal,
	elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
						from diagnostico_doenca dd, cid_doenca cd
						where dd.nr_atendimento = b.nr_atendimento
						and dd.cd_doenca = cd.cd_doenca_cid
						and dd.ie_classificacao_doenca = 'P')),1, 255)) descripciondiagnostico1,
	case
		when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(year from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'P') > 1)
		then 0
		else 1
	end as primeravezdiagnostico1,
	case
		when(select max(cd.ds_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'P') is not null
		then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  0  ELSE 1 END  from cid_doenca a2
					where a2.cd_doenca_cid = (select max(cd_doenca)
								from diagnostico_doenca
								where nr_atendimento = b.nr_atendimento
								and ie_classificacao_doenca = 'P')), 'N')
	end as suivecausesdiagnostico1,
	(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'P') codigociediagnostico1,
	elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
						from diagnostico_doenca dd, cid_doenca cd
						where dd.nr_atendimento = b.nr_atendimento
						and dd.cd_doenca = cd.cd_doenca_cid
						and dd.ie_classificacao_doenca = 's')),1, 255)) descripciondiagnostico2,
	case
		when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(year from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'S') > 1)
		then 0
		else 1
	end as primeravezdiagnostico2,
	case
		when(select max(ds_diagnostico) from diagnostico_doenca where nr_atendimento = b.nr_atendimento and ie_classificacao_doenca = 'S') is not null
		then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  0  ELSE 1 END  from cid_doenca a2
			where a2.cd_doenca_cid = (select max(cd_doenca)
			from diagnostico_doenca
			where nr_atendimento = b.nr_atendimento
			and ie_classificacao_doenca = 'S')), 'N')
	end as suivecausesdiagnostico2,
	(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'S') codigociediagnostico2,
	'' programa,
	null primeravezanio,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 1 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as oral,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 2 and pf_p.ie_sexo = 'S'
		then '1'
		else 'XX'
	end as inyectablemensal,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 3 and pf_p.ie_sexo = 'F'
		then '1'
		else 'XX'
	end as inyectablebimestral,
	case
		when hsm.ds_metodos_contrac = 6 and pf_p.ie_sexo = 'F'
		then hsm.ds_compl_contrac
		else 'XX'
	end as implantesubdermico,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 4 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as parchedermico,
	case
		when hsm.ds_metodos_contrac = 1 and hsm.ds_compl_contrac = 1 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as diu,
	case
		when hsm.ds_metodos_contrac = 1 and hsm.ds_compl_contrac = 2 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as diumedicado,
	null quirurgico,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 1 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as preservativo,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 2 and pf_p.ie_sexo = 'F'
		then hsm.nr_contrac_realizado
		else 666
	end as preservativofemenino,
	null otrometodo,
	CASE WHEN pf_p.ie_sexo='M' THEN  phs.ie_orient_met_contrac  ELSE 'XX' END  orientacionpf,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 3 and pf_p.ie_sexo = 'F'
		then 1
		else 666
	end as anticoncepcionemergencia,
	case
		 when pf_p.ie_sexo = 'M' and (select b.ds_tipo_vasectomia
		   	 	 	 from historico_saude_cirurgia a, procedimento b
					 where a.cd_pessoa_fisica = b.cd_pessoa_fisica
					 and a.cd_procedimento = b.cd_procedimento
					 and b.cd_tipo_procedimento = 66) = 'S'
		 then 1
		 else 0
	end as vasectomiasinbisturi,
	case
		when pf_p.ie_sexo = 'M' and (select b.ds_tipo_vasectomia
					 from historico_saude_cirurgia a, procedimento b
					 where a.cd_pessoa_fisica = b.cd_pessoa_fisica
					 and a.cd_procedimento = b.cd_procedimento
					 and b.cd_tipo_procedimento = 66) = 'N'
		then 1
		else 0
	end as altaconazoospermia,
	null lineavida,
	null cartillavacunacion,
	null referido,
        null contrarreferido,
	null telemedicina,
	b.dt_entrada dt_entrada,
	pf_p.cd_pessoa_fisica cd_pessoa_fisica,
	b.nr_atendimento nr_atendimento,
	pj.cd_cgc cd_cgc,
	obter_desc_convenio(n.cd_convenio) ds_convenio,
	pf_m.cd_pessoa_fisica cd_medico
FROM pessoa_juridica pj, pessoa_fisica pf_m, atend_categoria_convenio p, medico m, estabelecimento e, categoria_convenio cc, atendimento_paciente b
LEFT OUTER JOIN historico_saude_mulher hsm ON (b.cd_pessoa_fisica = hsm.cd_pessoa_fisica)
LEFT OUTER JOIN paciente_hist_social phs ON (b.cd_pessoa_fisica = phs.cd_pessoa_fisica)
LEFT OUTER JOIN atend_profissional profissional ON (b.nr_atendimento = profissional.nr_atendimento)
, pessoa_fisica pf_p
LEFT OUTER JOIN sus_municipio sm ON (pf_p.cd_municipio_ibge = sm.cd_municipio_ibge)
LEFT OUTER JOIN person_name y ON (pf_p.nr_seq_person_name = y.nr_sequencia AND 'main' = y.ds_type)
LEFT OUTER JOIN cat_entidade ce ON (sm.nr_seq_entidade_mx = ce.nr_sequencia)
, convenio n
LEFT OUTER JOIN cat_derechohabiencia k ON (n.cd_tipo_convenio_mx = k.nr_sequencia)
WHERE b.nr_atendimento  		= p.nr_atendimento and pj.cd_cgc 			= e.cd_cgc and b.cd_estabelecimento 		= e.cd_estabelecimento and b.cd_pessoa_fisica		= pf_p.cd_pessoa_fisica and b.cd_medico_resp 		= m.cd_pessoa_fisica and pf_m.cd_pessoa_fisica 		= m.cd_pessoa_fisica   and p.cd_convenio 			= cc.cd_convenio and p.cd_categoria 			= cc.cd_categoria and n.cd_convenio 			= cc.cd_convenio;

