-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_solic_situacao_prot_v (ds_tipo_logradouro, ds_versao, ds_endereco, nr_endereco, ds_complemento, ds_municipio, sg_estado, cd_municipio_ibge, cd_cep, cd_cgc, ds_razao_social, cd_cnes, cd_interno, cd_ans, dt_solicitacao, nr_seq_prot_situacao, cd_cgc_prestador, nr_protocolo_receb, nr_seq_protocolo, nr_prot_retorno) AS select	lpad(coalesce(f.CD_TIPO_LOGRADOURO, '081'),3,'0') ds_tipo_logradouro,
	'2.01.01' ds_versao, 
	c.ds_endereco, 
	c.nr_endereco, 
	c.ds_complemento, 
	c.ds_municipio, 
	c.sg_estado, 
	substr(lpad(coalesce(c.cd_municipio_ibge, OBTER_MUNICIPIO_IBGE(somente_numero(c.cd_cep))),7,'0'),1,25) cd_municipio_ibge, 
	lpad(to_char(somente_numero(c.cd_cep)),8,'0') cd_cep, 
	c.cd_cgc, 
	c.ds_razao_social, 
	coalesce(b.cd_cns, c.cd_cnes) cd_cnes, 
	coalesce(cd_prestador_convenio, substr(coalesce(TISS_OBTER_PREST_PROTOCOLO(a.cd_estabelecimento, a.cd_setor_atendimento, a.ie_tipo_protocolo, a.cd_convenio), Obter_Valor_Conv_Estab(e.cd_convenio, b.cd_estabelecimento, 'CD_INTERNO')),1,15)) cd_interno, 
	c.cd_ans, 
	LOCALTIMESTAMP dt_solicitacao, 
	(null)::numeric  nr_seq_prot_situacao, 
	c.cd_cgc cd_cgc_prestador, 
	null nr_protocolo_receb, 
	a.nr_seq_protocolo, 
	to_char(a.nr_seq_protocolo) NR_PROT_RETORNO 
FROM convenio e, estabelecimento b, protocolo_convenio a, pessoa_juridica c
LEFT OUTER JOIN cns_tipo_logradouro f ON (c.nr_seq_tipo_logradouro = f.nr_sequencia)
WHERE a.cd_estabelecimento		= b.cd_estabelecimento and a.cd_convenio			= e.cd_convenio and b.cd_cgc			= c.cd_cgc  
union
 
select	lpad(coalesce(f.CD_TIPO_LOGRADOURO, '081'),3,'0') ds_tipo_logradouro, 
	'2.01.01' ds_versao, 
	c.ds_endereco, 
	c.nr_endereco, 
	c.ds_complemento, 
	c.ds_municipio, 
	c.sg_estado, 
	substr(lpad(coalesce(c.cd_municipio_ibge, OBTER_MUNICIPIO_IBGE(somente_numero(c.cd_cep))),7,'0'),1,25) cd_municipio_ibge, 
	lpad(to_char(somente_numero(c.cd_cep)),8,'0') cd_cep, 
	c.cd_cgc, 
	c.ds_razao_social, 
	coalesce(b.cd_cns, c.cd_cnes) cd_cnes, 
	coalesce(cd_prestador_convenio, substr(coalesce(TISS_OBTER_PREST_PROTOCOLO(a.cd_estabelecimento, a.cd_setor_atendimento, a.ie_tipo_protocolo, a.cd_convenio), Obter_Valor_Conv_Estab(e.cd_convenio, b.cd_estabelecimento, 'CD_INTERNO')),1,15)) cd_interno, 
	c.cd_ans, 
	LOCALTIMESTAMP dt_solicitacao, 
	a.nr_seq_protocolo nr_seq_prot_situacao, 
	c.cd_cgc cd_cgc_prestador, 
	g.nr_sequencia nr_protocolo_receb, 
	a.nr_seq_protocolo, 
	g.nr_protocolo_receb NR_PROT_RETORNO 
FROM tiss_protocolo_envio_ret g, convenio e, estabelecimento b, protocolo_convenio a, pessoa_juridica c
LEFT OUTER JOIN cns_tipo_logradouro f ON (c.nr_seq_tipo_logradouro = f.nr_sequencia)
WHERE a.cd_estabelecimento		= b.cd_estabelecimento and a.cd_convenio			= e.cd_convenio and b.cd_cgc			= c.cd_cgc and g.nr_seq_protocolo		= a.nr_seq_protocolo  and g.nr_sequencia	= (	select	max(x.nr_sequencia) 
				from	tiss_protocolo_envio_ret x 
				where	x.nr_seq_protocolo = g.nr_seq_protocolo);

