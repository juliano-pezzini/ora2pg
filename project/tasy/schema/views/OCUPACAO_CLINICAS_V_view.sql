-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ocupacao_clinicas_v (nm_clinica, cd_estabelecimento_base, nr_unidades_setor, nr_unidades_temporarias, nr_unidades_ocupadas, qt_unidade_acomp, nr_unidades_interditadas, nr_unidades_livres, nr_unidades_higienizacao, nr_unidades_reservadas, qt_unidades_isolamento, qt_unidades_alta, nr_unid_temp_ocup) AS SELECT substr(obter_valor_dominio(17,a.ie_clinica),1,60) nm_clinica,
	C.cd_estabelecimento_base, 
	COUNT(*) NR_UNIDADES_SETOR, 
   	sum(CASE WHEN B.IE_TEMPORARIO='S' THEN  1  ELSE 0 END ) NR_UNIDADES_TEMPORARIAS,   
	sum(CASE WHEN B.IE_STATUS_UNIDADE='P' THEN  1  ELSE 0 END ) NR_UNIDADES_OCUPADAS,  
	sum(CASE WHEN B.IE_STATUS_UNIDADE='M' THEN  1  ELSE 0 END ) qt_UNIDADE_ACOMP,   
	sum(CASE WHEN B.IE_STATUS_UNIDADE='I' THEN  1  ELSE 0 END ) NR_UNIDADES_INTERDITADAS,   
	sum(CASE WHEN B.IE_STATUS_UNIDADE='L' THEN  1  ELSE 0 END ) NR_UNIDADES_LIVRES,   
	sum(CASE WHEN B.IE_STATUS_UNIDADE='H' THEN  1  ELSE 0 END ) NR_UNIDADES_HIGIENIZACAO, 
	sum(CASE WHEN B.IE_STATUS_UNIDADE='R' THEN  1  ELSE 0 END ) NR_UNIDADES_RESERVADAS, 
	sum(CASE WHEN B.IE_STATUS_UNIDADE='O' THEN  1  ELSE 0 END ) QT_UNIDADES_ISOLAMENTO, 
	sum(CASE WHEN B.IE_STATUS_UNIDADE='A' THEN  1  ELSE 0 END ) QT_UNIDADES_ALTA, 
	sum(CASE WHEN B.IE_TEMPORARIO='S' THEN  CASE WHEN B.IE_STATUS_UNIDADE='P' THEN  1  ELSE 0 END   ELSE 0 END ) NR_UNID_TEMP_OCUP 
FROM	SETOR_ATENDIMENTO C,	 
	UNIDADE_ATENDIMENTO B, 
	atendimento_paciente a 
WHERE	B.CD_SETOR_ATENDIMENTO   = C.CD_SETOR_ATENDIMENTO 
AND	B.IE_SITUACAO       = 'A' 
and	C.CD_CLASSIF_SETOR IN (3,4) 
and	B.nr_atendimento = a.nr_atendimento 
and	ie_ocup_hospitalar = 'S' 
group by substr(obter_valor_dominio(17,a.ie_clinica),1,60), 
	C.cd_estabelecimento_base;

