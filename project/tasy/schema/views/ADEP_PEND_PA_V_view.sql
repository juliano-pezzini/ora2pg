-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW adep_pend_pa_v (nr_seq_apresent, ie_tipo_item, ds_tipo_item, ds_tipo_item_plural, ie_laboratorio, cd_estabelecimento, nr_atendimento, nr_prescricao, cd_prescritor, dt_prescricao, dt_inicio_prescr, dt_validade_prescr, dt_liberacao, dt_lib_horario, cd_setor_prescr) AS select	3 nr_seq_apresent,
	'M' ie_tipo_item,
	'Medicamento' ds_tipo_item,
	'Medicamentos' ds_tipo_item_plural,
	'N' ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	coalesce(a.dt_liberacao,b.dt_lib_material) dt_liberacao,
	c.dt_lib_horario,
	a.cd_setor_atendimento cd_setor_prescr
FROM
	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador =1
--and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union all

select	3 nr_seq_apresent,
	'S' ie_tipo_item,
	'Soluções' ds_tipo_item,
	'Soluções' ds_tipo_item_plural,
	'N' ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	coalesce(a.dt_liberacao,b.dt_lib_material),
	c.dt_lib_horario,
	a.cd_setor_atendimento cd_setor_prescr
from
	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 4
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and	substr(obter_status_solucao_prescr(1, b.nr_prescricao, b.nr_sequencia_solucao),1,3) = 'N'

union all

select	CASE WHEN b.nr_seq_exame IS NULL THEN  5  ELSE 8 END  nr_seq_apresent,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'P'  ELSE 'L' END  ie_tipo_item,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'Procedimento'  ELSE 'Coleta' END  ds_tipo_item,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'Procedimentos'  ELSE 'Coletas' END  ds_tipo_item_plural,
	CASE WHEN b.nr_seq_exame IS NULL THEN  'N'  ELSE 'S' END  ie_laboratorio,
	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_prescricao,
	a.cd_prescritor,
	a.dt_prescricao,
	a.dt_inicio_prescr,
	a.dt_validade_prescr,
	a.dt_liberacao,
	c.dt_lib_horario,
	a.cd_setor_atendimento cd_setor_prescr
from
	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_seq_procedimento = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.nr_seq_solic_sangue is null
and	b.nr_seq_derivado is null
and	b.nr_seq_prot_glic is null
and	((b.nr_seq_proc_interno is null) or (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'NC'))
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and	substr(obter_se_proc_enfermagem_pa(b.cd_procedimento,b.ie_origem_proced),1,1) = 'S'
and	adep_obter_se_apres_hor_proc('PROC', wheb_usuario_pck.get_cd_estabelecimento, a.cd_setor_atendimento, obter_perfil_ativo, b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno) = 'S'
and	adep_obter_regra_inclusao(	'PROC',
								wheb_usuario_pck.get_cd_estabelecimento,
								wheb_usuario_pck.get_cd_setor_atendimento,
								obter_perfil_ativo,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_Atendimento,
								b.cd_setor_atendimento,
								a.nr_prescricao, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S';

