-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ocupacao_hospitalar_p312_v (dt_referencia, cd_estabelecimento, ds_estabelecimento, cd_empresa, cd_setor_atendimento, ds_setor_atendimento, cd_convenio, ds_convenio, cd_unidade_basica, cd_unidade_compl, qt_leito_planejado, qt_leito_instalado, qt_leito_extra, qt_leito_vago, qt_leito_ocupado, qt_leito_bloqueado, qt_leito_desativado, qt_internacao, qt_alta, qt_evasao, qt_desistencia, qt_obito_hospitalar, qt_obito_institucional, qt_trans_interna, qt_trans_externa, qt_leito_dia, qt_ocupado, qt_paciente_dia, qt_obs_hospitalar, qt_trans_int_entrada, qt_trans_int_saida, qt_trans_ext_entrada, qt_trans_ext_saida, qt_saidas, qt_bloq, qt_ex_ocup, qt_desativado, ie_clinica, ds_clinica, cd_agrupamento, ds_agrupamento, cd_tipo_acomodacao, ds_acomodacao, qt_indicegiro, tx_ocup_oper, tx_ocup_oper_312, media_permanen, qt_ocup_planej, qt_mort_hosp_312, qt_mort_inst_312) AS select	a.dt_referencia,
	a.cd_estabelecimento,
	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_estabelecimento,
	obter_empresa_estab(a.cd_estabelecimento) cd_empresa,
	a.cd_setor_atendimento,
	substr(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor_atendimento,
	coalesce(a.cd_convenio, 0) cd_convenio,
	substr(coalesce(obter_nome_convenio(a.cd_convenio), wheb_mensagem_pck.get_texto(689295)),1,100) ds_convenio,
	a.cd_unidade_basica,
	a.cd_unidade_compl,
	a.qt_leito_planejado,
	a.qt_leito_instalado,
	a.qt_leito_extra,
	a.qt_leito_vago,
	a.qt_leito_ocupado,
	a.qt_leito_bloqueado,
	a.qt_leito_desativado,
	a.qt_internacao,
	a.qt_alta,
	a.qt_evasao,
	a.qt_desistencia,
	a.qt_obito_hospitalar,
	a.qt_obito_institucional,
	a.qt_trans_interna,
	a.qt_trans_externa,
	a.qt_leito_dia,
	a.qt_ocupado,
	a.qt_paciente_dia,
	a.qt_obs_hospitalar,
	a.qt_trans_int_entrada,
	a.qt_trans_int_saida,
	a.qt_trans_ext_entrada,
	a.qt_trans_ext_saida,
	(qt_alta + qt_obito_hospitalar +
			CASE WHEN substr(obter_dados_param_atend(a.cd_estabelecimento, 'OH'), 1, 1)='N' THEN  qt_obito_institucional  ELSE 0 END  +
			qt_trans_externa + qt_desistencia + qt_evasao) qt_saidas,
	CASE WHEN a.qt_leito_extra=1 THEN  0  ELSE a.qt_leito_bloqueado END  qt_bloq,
	CASE WHEN a.qt_leito_ocupado=1 THEN  CASE WHEN a.qt_leito_extra=1 THEN  a.qt_leito_extra  ELSE 0 END   ELSE 0 END  qt_ex_ocup,
	CASE WHEN a.qt_leito_extra=1 THEN  0  ELSE a.qt_leito_desativado END  qt_desativado,
	a.ie_clinica,
	substr(obter_valor_dominio(17,a.ie_clinica),1,100) ds_clinica,
	coalesce(substr(obter_dados_setor(cd_setor_atendimento,'AC'),1,255),0) cd_agrupamento,
	CASE WHEN substr(obter_dados_setor(cd_setor_atendimento,'AC'),1,255)='' THEN 'Sem agrupamento'  ELSE SUBSTR(Obter_desc_agrup_setor(substr(obter_dados_setor(cd_setor_atendimento,'AC'),1,255)),1,50) END  ds_agrupamento,
	a.cd_tipo_acomodacao,
	CASE WHEN substr(obter_desc_tipo_acomodacao(a.cd_tipo_acomodacao),1,255)='' THEN 'Sem acomodação'  ELSE SUBSTR(obter_desc_tipo_acomodacao(a.cd_tipo_acomodacao),1,255) END  ds_acomodacao,
	ROUND((qt_alta + qt_obito_hospitalar + CASE WHEN SUBSTR(obter_dados_param_atend(a.cd_estabelecimento, 'OH'), 1, 1)='N' THEN  qt_obito_institucional  ELSE 0 END  + qt_trans_externa + qt_desistencia + qt_evasao) / (CASE WHEN coalesce(a.qt_leito_vago + a.qt_leito_ocupado,0)=0 THEN  1  ELSE coalesce(a.qt_leito_vago + a.qt_leito_ocupado,0) END )) qt_indiceGiro,
	(DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA))) * 100 tx_ocup_oper,
	CASE WHEN DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA))=0 THEN 1  ELSE DIVIDIR((QT_PACIENTE_DIA), (QT_LEITO_DIA)) END  * 100 tx_ocup_oper_312,
	DIVIDIR((QT_PACIENTE_DIA),(qt_alta + qt_obito_hospitalar + CASE WHEN substr(obter_dados_param_atend(a.cd_estabelecimento, 'OH'), 1, 1)='N' THEN  qt_obito_institucional  ELSE 0 END  + qt_trans_externa + qt_desistencia + qt_evasao)) media_permanen,
	(QT_LEITO_DIA + CASE WHEN a.qt_leito_extra=1 THEN  0  ELSE a.qt_leito_desativado END  + a.QT_LEITO_BLOQUEADO) qt_ocup_planej,
	CASE WHEN obter_classif_setor(cd_setor_atendimento)=4 THEN qt_trans_interna  ELSE 0 END  - QT_OBITO_INSTITUCIONAL qt_mort_hosp_312,
	CASE WHEN obter_classif_setor(cd_setor_atendimento)=4 THEN qt_trans_interna  ELSE 0 END  - QT_OBITO_HOSPITALAR qt_mort_inst_312
FROM	eis_ocupacao_hospitalar_p312 a;

