-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW resultado_hospital_mx_v (serie, factura, situacao, cliente, paciente, convenio_cuenta, ds_uuid, dt_referencia, fh_emision_fe, fh_cancelacion, fh_cancelacion_fe, fh_contabilizacion, importe_0, importe_16, iva, total, nr_sequencia, nr_protocolo) AS select a.cd_serie_nf serie,
	coalesce(a.nr_nota_fiscal, 'NO TIENE') factura, 
	upper(substr(obter_valor_dominio(1056,a.ie_situacao),1,20)) situacao, 
	obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc) cliente, 
	obter_paciente_conta(a.nr_interno_conta,'D') paciente, 
	upper(obter_convenio_conta(a.nr_interno_conta)) 
	|| ' - ' 
	|| obter_plano_atendimento(obter_atendimento_conta(a.nr_interno_conta),'D') convenio_cuenta, 
	a.nr_nfe_imp ds_uuid, 
	a.dt_emissao dt_referencia, 
	a.dt_emissao_nfe fh_emision_fe, 
	a.dt_cancelamento fh_cancelacion, 
	a.dt_cancelamento_nfe fh_cancelacion_fe, 
  CASE WHEN a.ie_acao_nf=1 THEN  CASE WHEN b.ie_data_contab_nf='ES' THEN  a.dt_entrada_saida WHEN b.ie_data_contab_nf='ATU' THEN  a.dt_atualizacao WHEN b.ie_data_contab_nf='EST' THEN  a.dt_atualizacao_estoque WHEN b.ie_data_contab_nf='OPE' THEN  CASE WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='ES' THEN  	a.dt_entrada_saida WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='ATU' THEN  a.dt_atualizacao WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='EST' THEN  a.dt_atualizacao_estoque  ELSE a.dt_emissao END   ELSE a.dt_emissao END   ELSE CASE WHEN b.ie_data_contab_est_nf='ES' THEN  a.dt_entrada_saida WHEN b.ie_data_contab_est_nf='ATU' THEN  a.dt_atualizacao WHEN b.ie_data_contab_est_nf='EST' THEN  	a.dt_atualizacao_estoque WHEN b.ie_data_contab_est_nf='OPE' THEN  CASE WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='ES' THEN  a.dt_entrada_saida WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='ATU' THEN  a.dt_atualizacao WHEN obter_regra_contab_nf_operacao(a.nr_sequencia)='EST' THEN  a.dt_atualizacao_estoque  ELSE a.dt_emissao END   ELSE a.dt_emissao END  END  fh_contabilizacion, 
	coalesce(CASE WHEN a.ie_situacao=1 THEN  CASE WHEN a.nr_nfe_imp IS NULL THEN  0  ELSE 1 END   ELSE 1 END  * obter_dados_iva(a.nr_sequencia,0) * CASE WHEN a.ie_acao_nf=1 THEN 1  ELSE -1 END  * CASE WHEN a.cd_serie_nf='BBT' THEN -1  ELSE 1 END , 0) importe_0, 
	coalesce(CASE WHEN a.ie_situacao=1 THEN  CASE WHEN a.nr_nfe_imp IS NULL THEN  0  ELSE 1 END   ELSE 1 END  * obter_dados_iva(a.nr_sequencia,16) * CASE WHEN a.ie_acao_nf=1 THEN 1  ELSE -1 END  * CASE WHEN a.cd_serie_nf='BBT' THEN -1  ELSE 1 END , 0) importe_16, 
	coalesce(CASE WHEN a.ie_situacao=1 THEN  CASE WHEN a.nr_nfe_imp IS NULL THEN  0  ELSE 1 END   ELSE 1 END  * obter_vl_total_trib_nota(a.nr_sequencia,'IVA') * CASE WHEN a.ie_acao_nf=1 THEN 1  ELSE -1 END  * CASE WHEN a.cd_serie_nf='BBT' THEN -1  ELSE 1 END , 0) iva, 
	coalesce(CASE WHEN a.ie_situacao=1 THEN  CASE WHEN a.nr_nfe_imp IS NULL THEN  0  ELSE 1 END   ELSE 1 END  * a.vl_total_nota * CASE WHEN a.ie_acao_nf=1 THEN 1  ELSE -1 END  * CASE WHEN a.cd_serie_nf='BBT' THEN -1  ELSE 1 END , 0) total, 
	a.nr_sequencia, 
	coalesce(CASE WHEN a.ie_situacao=2 THEN (select obter_protocolo_conpaci(max(nr_interno_conta)) 	FROM conta_paciente 	where nr_seq_conta_origem = a.nr_interno_conta 	and ie_cancelamento    = 'E' 	)  ELSE obter_protocolo_conpaci(a.nr_interno_conta) END , 0) 
	|| ',' nr_protocolo 
from 	nota_fiscal a, 
	parametro_estoque b 
where 	a.ie_tipo_nota in ('SF','SE','SD') 
and 	a.cd_estabelecimento = b.cd_estabelecimento 
order by 1,2;

