-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_controle_cart_emissao_v (nr_sequencia, nm_pessoa_fisica, cd_usuario_plano, nr_seq_seg_carteira, ds_status_carteira, nm_estipulante, nm_subestipulante, dt_solicitacao, dt_inicio_vigencia, dt_validade_carteira, nm_usuario_solicitante, ds_observacao, ds_titularidade, ds_trilha1, ds_trilha2, ds_trilha3, dt_recebimento, dt_entrega_beneficiario, nm_usuario_entrega, ie_situacao, nr_via_emissao, ie_status_emissao, nr_seq_segurado, ds_motivo_via_adic, ds_interface, nm_titular, ds_cpt, ds_endereco, ds_municipio, sg_estado, cd_cep, cd_pessoa_fisica, cd_cgc, nr_seq_subestip, nr_seq_lote, nm_pessoa_entrega, cd_matricula_est, nr_seq_localizacao_benef) AS select	d.nr_sequencia nr_sequencia,
	SUBSTR(obter_nome_pf(e.cd_pessoa_fisica),1,100) nm_pessoa_fisica, 
	c.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provisório' END  ds_status_carteira, 
	(	select	SUBSTR(obter_nome_pf(k.cd_pessoa_fisica),1,100) nm_pessoa_fisica 
		FROM	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pf_estipulante 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc_estipulante) nm_estipulante, 
	(	select	SUBSTR(obter_nome_pf(m.cd_pessoa_fisica),1,100) 
		from	pessoa_fisica m, 
			pls_sub_estipulante pm 
		where	m.cd_pessoa_fisica = pm.cd_pessoa_fisica 
		and	pm.nr_sequencia = b.nr_seq_subestipulante 
		
union
 
		select	n.ds_razao_social 
		from	pessoa_juridica n, 
			pls_sub_estipulante pn 
		where	n.cd_cgc = pn.cd_cgc 
		and	pn.nr_sequencia = b.nr_seq_subestipulante) nm_subestipulante, 
	coalesce(d.dt_solicitacao, c.dt_solicitacao) dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(coalesce(d.dt_validade_carteira, c.dt_validade_carteira),'dd') dt_validade_carteira, 
	coalesce(d.nm_usuario_solic, c.nm_usuario_solicitante) nm_usuario_solicitante, 
	coalesce(d.ds_observacao, c.ds_observacao) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	coalesce(d.ds_trilha_1, c.ds_trilha1) ds_trilha1, 
	coalesce(d.ds_trilha_2, c.ds_trilha2) ds_trilha2, 
	coalesce(d.ds_trilha_3, c.ds_trilha3) ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	(	select	substr(x.ds_motivo,1,255) 
		from	pls_motivo_via_adicional x 
		where	x.nr_sequencia = c.nr_seq_motivo_via) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	(	select	SUBSTR(obter_nome_pf(z.cd_pessoa_fisica),1,255) nm_pessoa_fisica 
		from	pls_segurado	x,
			pls_segurado	y,
			pessoa_fisica	z
		where	x.nr_seq_titular	= y.nr_sequencia 
		and	y.cd_pessoa_fisica	= z.cd_pessoa_fisica 
		and	x.nr_sequencia		= b.nr_sequencia) nm_titular, 
	substr(pls_obter_benef_cpt(b.nr_sequencia),1,10) ds_cpt, 
	(	select	substr(x.ds_endereco,1,255) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) ds_endereco, 
	(	select	substr(x.ds_municipio,1,200) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) ds_municipio, 
	(	select	substr(x.sg_estado,1,3) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) sg_estado, 
	(	select	substr(x.cd_cep,1,16) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) cd_cep, 
	a.cd_pf_estipulante cd_pessoa_fisica, 
	a.cd_cgc_estipulante cd_cgc, 
	b.nr_seq_subestipulante nr_seq_subestip, 
	d.nr_seq_lote , 
	d.nm_pessoa_entrega nm_pessoa_entrega, 
	coalesce(d.cd_matricula_est, b.cd_matricula_estipulante) cd_matricula_est, 
	b.nr_seq_localizacao_benef 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_carteira	c, 
	pls_segurado		b, 
	pls_contrato		a 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica 
and	d.nr_seq_seg_carteira	= c.nr_sequencia 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_contrato	= a.nr_sequencia 

union
 
select	d.nr_sequencia nr_sequencia, 
	SUBSTR(obter_nome_pf(e.cd_pessoa_fisica),1,100) nm_pessoa_fisica, 
	c.cd_usuario_plano, 
	d.nr_seq_seg_carteira, 
	CASE WHEN d.ie_situacao='D' THEN 'Definitivo'  ELSE 'Provisório' END  ds_status_carteira, 
	(	select	SUBSTR(obter_nome_pf(k.cd_pessoa_fisica),1,100) nm_pessoa_fisica 
		from	pessoa_fisica k 
		where	k.cd_pessoa_fisica = a.cd_pessoa_fisica 
		and	a.cd_cgc is null 
		
union
 
		select	l.ds_razao_social 
		from	pessoa_juridica l 
		where	l.cd_cgc = a.cd_cgc 
		and	a.cd_pessoa_fisica is null) nm_estipulante, 
	'' nm_subestipulante, 
	coalesce(d.dt_solicitacao, c.dt_solicitacao) dt_solicitacao, 
	c.dt_inicio_vigencia, 
	trunc(coalesce(d.dt_validade_carteira, c.dt_validade_carteira),'dd') dt_validade_carteira, 
	coalesce(d.nm_usuario_solic, c.nm_usuario_solicitante) nm_usuario_solicitante, 
	coalesce(d.ds_observacao, c.ds_observacao) ds_observacao, 
	CASE WHEN b.nr_seq_titular IS NULL THEN 'Titular'  ELSE 'Dependente' END  ds_titularidade, 
	coalesce(d.ds_trilha_1, c.ds_trilha1) ds_trilha1, 
	coalesce(d.ds_trilha_2, c.ds_trilha2) ds_trilha2, 
	coalesce(d.ds_trilha_3, c.ds_trilha3) ds_trilha3, 
	d.dt_recebimento, 
	d.dt_entrega_beneficiario, 
	d.nm_usuario_entrega, 
	d.ie_situacao, 
	d.nr_via_emissao, 
	substr(pls_status_solic_carteira(nr_seq_seg_carteira),1,100) ie_status_emissao, 
	b.nr_sequencia nr_seq_segurado, 
	(	select	substr(x.ds_motivo,1,255) 
		from	pls_motivo_via_adicional x 
		where	x.nr_sequencia = c.nr_seq_motivo_via ) ds_motivo_via_adic, 
	substr(pls_obter_interface_cartao(b.ie_tipo_segurado,'D',a.cd_estabelecimento),1,255) ds_interface, 
	(	select	SUBSTR(obter_nome_pf(z.cd_pessoa_fisica),1,255) nm_pessoa_fisica 
		from	pls_segurado	x,
			pls_segurado	y,
			pessoa_fisica	z
		where	x.nr_seq_titular	= y.nr_sequencia 
		and	y.cd_pessoa_fisica	= z.cd_pessoa_fisica 
		and	x.nr_sequencia		= b.nr_sequencia) nm_titular, 
	substr(pls_obter_benef_cpt(b.nr_sequencia),1,10) ds_cpt, 
	(	select 	substr(x.ds_endereco,1,255) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) ds_endereco, 
	(	select 	substr(x.ds_municipio,1,200) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) ds_municipio, 
	(	select 	substr(x.sg_estado,1,3) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) sg_estado, 
	(	select 	substr(x.cd_cep,1,16) 
		from	compl_pessoa_fisica x 
		where	x.cd_pessoa_fisica = e.cd_pessoa_fisica 
		and	x.ie_tipo_complemento = 1 ) cd_cep, 
	a.cd_pessoa_fisica cd_pessoa_fisica, 
	a.cd_cgc cd_cgc, 
	null nr_seq_subestip, 
	d.nr_seq_lote , 
	d.nm_pessoa_entrega nm_pessoa_entrega, 
	coalesce(d.cd_matricula_est, b.cd_matricula_estipulante) cd_matricula_est, 
	b.nr_seq_localizacao_benef 
from	pessoa_fisica		e, 
	pls_carteira_emissao	d, 
	pls_segurado_carteira	c, 
	pls_segurado		b, 
	pls_intercambio		a 
where	b.cd_pessoa_fisica	= e.cd_pessoa_fisica 
and	d.nr_seq_seg_carteira	= c.nr_sequencia 
and	c.nr_seq_segurado	= b.nr_sequencia 
and	b.nr_seq_intercambio	= a.nr_sequencia 
order by	1;

