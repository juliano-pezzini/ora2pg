-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hnsc_autor_convenio_assim_v (nr_atendimento, nr_seq_autorizacao, cd_funcao_assim, cd_hospital, ds_senha, cd_prestador_exec, cd_prestador_solic, cd_especialidade, cd_tipo_operacao, cd_tipo_servico, ds_associado, cd_amb_1, cd_amb_2, cd_amb_3, cd_amb_4, cd_amb_5, cd_processo, cd_guia, nr_sequencia, nr_crm_prest_solic, nm_prest_solic, ds_senha_amb_1, ds_senha_amb_2, ds_senha_amb_3, ds_senha_amb_4, ds_senha_amb_5, cd_natureza_servico, cd_estabelecimento) AS select	b.nr_atendimento,
	b.nr_seq_autorizacao, 
	1						cd_funcao_assim, 
	substr(Obter_Valor_Conv_Estab(c.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),1,4) cd_hospital, 
	substr(c.ds_senha,1,6)				ds_senha, 
	substr(obter_medico_convenio(f.cd_estabelecimento,b.cd_medico_solicitante,b.cd_convenio, null, null, null, null,null, f.ie_tipo_atendimento, null, null),1,4) cd_prestador_exec, 
	substr(obter_medico_convenio(f.cd_estabelecimento,b.cd_medico_solicitante,b.cd_convenio, null, null, null, null,null, f.ie_tipo_atendimento, null, null),1,4) cd_prestador_solic, 
	(substr(obter_conversao_externa(c.cd_cgc, 
						'ESPECIALIDADE_MEDICA', 
						'CD_ESPECIALIDADE', 
						obter_especialidade_medico(d.cd_pessoa_fisica,'C')),1,3))::numeric  cd_especialidade, 
	1						cd_tipo_operacao, 
	CASE WHEN b.ie_tipo_autorizacao='6' THEN 1  ELSE 3 END 		cd_tipo_servico, 
	substr(g.cd_usuario_convenio,1,15)		ds_associado, 
	substr(coalesce(obter_proced_autor(b.nr_atendimento,b.nr_seq_autorizacao,1),' '),1,8) 	cd_amb_1, 
	substr(coalesce(obter_proced_autor(b.nr_atendimento,b.nr_seq_autorizacao,2),' '),1,8) 	cd_amb_2, 
	substr(coalesce(obter_proced_autor(b.nr_atendimento,b.nr_seq_autorizacao,3),' '),1,8) 	cd_amb_3, 
	substr(coalesce(obter_proced_autor(b.nr_atendimento,b.nr_seq_autorizacao,4),' '),1,8) 	cd_amb_4, 
	substr(coalesce(obter_proced_autor(b.nr_atendimento,b.nr_seq_autorizacao,5),' '),1,8) 	cd_amb_5, 
	' '						cd_processo, 	--Somente para estorno e reimpressão 
	' '						cd_guia, 	--Somente para estorno e reimpressão 
	b.nr_seq_autorizacao				nr_sequencia, 
	somente_numero(d.nr_crm)			nr_crm_prest_solic, 
	substr(obter_nome_pf(d.cd_pessoa_fisica),1,30)	nm_prest_solic, 
	' '	ds_senha_amb_1, 
	' '	ds_senha_amb_2, 
	' '	ds_senha_amb_3, 
	' '	ds_senha_amb_4, 
	' '	ds_senha_amb_5, 
	CASE WHEN f.ie_carater_inter_sus='1' THEN 1 WHEN f.ie_carater_inter_sus='20' THEN 2 END 	cd_natureza_servico, 
	f.cd_estabelecimento 
FROM atend_categoria_convenio g, atendimento_paciente f, convenio c, autorizacao_convenio b
LEFT OUTER JOIN medico d ON (b.cd_medico_solicitante = d.cd_pessoa_fisica)
WHERE b.cd_convenio		= c.cd_convenio  and b.nr_atendimento	= f.nr_atendimento and g.nr_atendimento	= f.nr_atendimento and g.cd_convenio		= c.cd_convenio and g.dt_inicio_vigencia	= (select	max(dt_inicio_vigencia) 
				  from		atend_categoria_convenio x 
				  where	x.nr_atendimento = g.nr_atendimento 
				  and		x.cd_convenio	 = g.cd_convenio 
				  and		x.cd_categoria	 = g.cd_categoria);

