-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ctb_reg_aux_valores_agrup_v (ds_valor, cd_conta_contabil, dt_referencia, nr_seq_reg_auxiliar, vl_movimento) AS select	'1' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_parcela) vl_movimento
FROM    w_ctb_aux_contra_emit a
where	ie_tipo_livro  not in (1,7)
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'1' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_apropriado) vl_movimento
from    w_ctb_aux_contra_emit a
where	ie_tipo_livro = 1
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'2' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_pagar) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	in (1,6)
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'3' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(coalesce(a.vl_glosa,0) + coalesce(a.vl_taxa_pgto,0)) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	= 4
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'4' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_coparticipacao) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	= 5
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'5' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_evento + coalesce(a.vl_ajuste,0)) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	in (7,8)
and 	(	select  max(a.ie_lote_ajuste_prod)
		from   pls_parametro_contabil a
		where  a.cd_estabelecimento = (  select coalesce(b.cd_estab_exclusivo, a.cd_estabelecimento)
						from ctb_livro_auxiliar b
						where  nr_sequencia = a.nr_seq_reg_auxiliar)) = 'P'
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'6' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_evento) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	in (7,8)
and 	coalesce((	select  max(a.ie_lote_ajuste_prod)
		from   pls_parametro_contabil a
		where  a.cd_estabelecimento = (  select coalesce(b.cd_estab_exclusivo, a.cd_estabelecimento)
						from ctb_livro_auxiliar b
						where  nr_sequencia = a.nr_seq_reg_auxiliar)), 'X') <> 'P'
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'7' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_evento) vl_movimento
from	w_ctb_livro_aux_event_liq a
where	a.ie_tipo_livro	in (9)
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar

union all

select	'1' ds_valor,
	coalesce(a.cd_conta_contabil,'0') cd_conta_contabil,
	trunc(a.dt_referencia,'month') dt_referencia,
	a.nr_seq_reg_auxiliar,
	sum(a.vl_antecipado) vl_movimento
from    w_ctb_aux_contra_emit a
where	ie_tipo_livro = 7
group by coalesce(a.cd_conta_contabil,'0'),
	trunc(a.dt_referencia,'month'),
	a.nr_seq_reg_auxiliar;

