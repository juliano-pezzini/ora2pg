-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hpms_pls_segurado_web (nr_seq_segurado, dt_atualizacao, ds_senha, ds_tec, ie_situacao, cd_estabelecimento, cd_pessoa_fisica, nm_pessoa_fisica, cd_carteira_atual, cd_carteira_anterior) AS SELECT
        psw.nr_seq_segurado nr_seq_segurado,
        psw.dt_atualizacao dt_atualizacao,
        coalesce(psw.ds_senha,'*') ds_senha,
        psw.ds_tec ds_tec,
        psw.ie_situacao ie_situacao,
        psw.cd_estabelecimento cd_estabelecimento,
        pf.cd_pessoa_fisica cd_pessoa_fisica,
        pf.nm_pessoa_fisica nm_pessoa_fisica,
        (
            SELECT
                psc.cd_usuario_plano
            FROM
                pls_segurado_carteira psc
            WHERE
                psc.nr_seq_segurado = psw.nr_seq_segurado
         LIMIT 1) cd_carteira_atual,
        (
            SELECT
                cd_usuario_ant
            FROM (
                    SELECT
                        psca.nr_seq_segurado,
                        psca.cd_usuario_ant
                    FROM
                        pls_segurado_cart_ant psca
                    WHERE
                        psca.dt_validade IS NOT NULL
                        AND psca.dt_validade >= LOCALTIMESTAMP
                    ORDER BY
                        psca.nr_sequencia DESC
                ) psa_anterior
            WHERE
                psa_anterior.nr_seq_segurado = psw.nr_seq_segurado 
         LIMIT 1) cd_carteira_anterior
    FROM
        pls_segurado_web psw,
        pls_segurado ps,
        pessoa_fisica pf,
        (
            SELECT
                nr_seq_segurado,
                MAX(nr_sequencia) nr_sequencia
            FROM
                pls_segurado_web psw
            GROUP BY
                nr_seq_segurado
        ) psw_ultimo
    WHERE
        ps.nr_seq_motivo_cancelamento IS NULL
        AND psw.nr_seq_segurado = ps.nr_sequencia
        AND ps.cd_pessoa_fisica = pf.cd_pessoa_fisica
        AND psw_ultimo.nr_seq_segurado = psw.nr_seq_segurado
        AND psw_ultimo.nr_sequencia = psw.nr_sequencia;

