-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pagto_escritural_unibanco_v (tp_registro, cd_agencia, nr_conta, nm_cliente, dt_gravacao, nr_seq_envio, nr_compl_cep_fav, nr_banco_favorecido, cd_agencia_fav, nr_conta_fav, ie_emissao_aviso, ie_tipo_operacao, ie_tipo_servico, vl_favorecido, nr_favorecido_empresa, dt_credito, nm_favorecido, ds_endereco, ds_cidade, ie_uf, cd_cep, cd_ocorrencia, vl_liquido, cd_favorecido, nr_bloqueto, dt_vencimento, nr_check_horiz, nr_nosso_numero, ds_campo_livre) AS select	0 tp_registro,
	b.cd_agencia_bancaria cd_agencia, 
	b.cd_conta nr_conta, 
	p.ds_razao_social nm_cliente, 
	e.dt_remessa_retorno dt_gravacao, 
	e.nr_sequencia nr_seq_envio, 
	'' nr_compl_cep_fav, 
	'' nr_banco_favorecido, 
	'' cd_agencia_fav, 
	'' nr_conta_fav, 
	0 ie_emissao_aviso, 
	0 ie_tipo_operacao, 
	0 ie_tipo_servico, 
	0 vl_favorecido, 
	0 nr_favorecido_empresa, 
	LOCALTIMESTAMP dt_credito, 
	'' nm_favorecido, 
	'' ds_endereco, 
	'' ds_cidade, 
	'' ie_uf, 
	'' cd_cep, 
	'00' cd_ocorrencia, 
	0 vl_liquido, 
	'' cd_favorecido, 
	'' nr_bloqueto, 
	LOCALTIMESTAMP dt_vencimento, 
	'' nr_check_horiz, 
	'0' nr_nosso_numero, 
	'0' ds_campo_livre 
FROM	banco_estabelecimento b, 
	estabelecimento a, 
	pessoa_juridica p, 
	banco c, 
	banco_escritural e 
where	e.cd_estabelecimento 	= a.cd_estabelecimento 
 and	e.cd_estabelecimento 	= b.cd_estabelecimento 
 and	a.cd_cgc 		= p.cd_cgc 
 and	e.cd_banco 		= b.cd_banco 
 and	e.cd_banco 		= c.cd_banco 
 and	b.ie_tipo_relacao	= 'EP' 

union all
 
select	1 tp_registro, 
	b.cd_agencia_bancaria cd_agencia, 
	b.cd_conta nr_conta, 
	'' nm_cliente, 
	a.dt_remessa_retorno dt_gravacao, 
	a.nr_sequencia nr_seq_envio, 
	substr(d.cd_cep,5,3) nr_compl_cep_fav, 
	d.cd_banco_favorecido nr_banco_favorecido, 
	substr(d.cd_agencia_favorecido,1,4) cd_agencia_fav, 
	substr(d.nr_conta_favorecido,1,4) nr_conta_fav, 
	0 ie_emissao_aviso, 
	5 ie_tipo_operacao, 
	4 ie_tipo_servico, 
	d.vl_titulo vl_favorecido, 
	d.nr_titulo nr_favorecido_empresa, 
	d.dt_vencimento_atual dt_credito, 
	d.nm_favorecido, 
	d.ds_endereco, 
	d.ds_cidade, 
	d.ds_estado ie_uf, 
	substr(d.cd_cep,1,5) cd_cep, 
	c.cd_ocorrencia, 
	0 vl_liquido, 
	d.cd_favorecido, 
	'' nr_bloqueto, 
	LOCALTIMESTAMP dt_vencimento, 
	'' nr_check_horiz, 
	d.nr_nosso_numero nr_nosso_numero, 
	substr(d.nr_bloqueto,20,25) ds_campo_livre 
from	titulo_pagar_escrit c, 
	titulo_pagar_v2 d, 
   	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a 
where	c.nr_titulo     	= d.nr_titulo 
 and	a.nr_sequencia    	= c.nr_seq_escrit 
 and	a.cd_banco     	= b.cd_banco 
 and	a.cd_estabelecimento 	= b.cd_estabelecimento 
 and	a.cd_estabelecimento 	= e.cd_estabelecimento 
 and	b.ie_tipo_relacao	= 'EP' 
 and	c.ie_tipo_pagamento	<> 'BLQ' 

union all
 
select	2 tp_registro, 
	b.cd_agencia_bancaria cd_agencia, 
	b.cd_conta nr_conta, 
  p.ds_razao_social nm_cliente, 
--	'' nm_cliente, 
	a.dt_remessa_retorno dt_gravacao, 
	a.nr_sequencia nr_seq_envio, 
	substr(d.cd_cep,5,3) nr_compl_cep_fav, 
  substr(to_char(c.cd_banco),1,5) nr_banco_favorecido, 
	c.cd_agencia_bancaria cd_agencia_fav, 
	c.nr_conta nr_conta_fav, 
--	d.cd_banco_favorecido nr_banco_favorecido, 
--	substr(d.cd_agencia_favorecido,1,4) cd_agencia_fav, 
--  substr(d.nr_conta_favorecido,1,4) nr_conta_fav, 
	0 ie_emissao_aviso, 
	5 ie_tipo_operacao, 
	4 ie_tipo_servico, 
	d.vl_titulo vl_favorecido, 
	d.nr_titulo nr_favorecido_empresa, 
	d.dt_vencimento_atual dt_credito, 
	d.nm_favorecido, 
	d.ds_endereco, 
	d.ds_cidade, 
	d.ds_estado ie_uf, 
	substr(d.cd_cep,1,5) cd_cep, 
	c.cd_ocorrencia, 
	0 vl_liquido, 
	d.cd_favorecido, 
	'CDB' || d.nr_bloqueto nr_bloqueto, 
	d.dt_vencimento_atual dt_vencimento, 
	to_char(((to_char(c.cd_banco,'FM0000') || '00000000000000')::numeric  + (d.vl_titulo * 100)) * 5) nr_check_horiz, 
	d.nr_nosso_numero nr_nosso_numero, 
	substr(d.nr_bloqueto,20,25) ds_campo_livre 
from	titulo_pagar_escrit c, 
   	titulo_pagar_v2 d, 
   	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a, 
		banco f, 
		pessoa_juridica p 
where	c.nr_titulo     	= d.nr_titulo 
 and	a.nr_sequencia    	= c.nr_seq_escrit 
 and	a.cd_banco     	= b.cd_banco 
 and	a.cd_estabelecimento 	= b.cd_estabelecimento 
 and	a.cd_estabelecimento 	= e.cd_estabelecimento 
 and	b.ie_tipo_relacao	= 'EP' 
 and	c.ie_tipo_pagamento	= 'BLQ' 
 and  a.cd_banco = f.cd_banco 
 and  e.cd_cgc 			= p.cd_cgc 

union all
 
select	9 tp_registro, 
	'' cd_agencia, 
	'' nr_conta, 
	'' nm_cliente, 
	LOCALTIMESTAMP dt_gravacao, 
	a.nr_sequencia nr_seq_envio, 
	'' nr_compl_cep_fav, 
	'' nr_banco_favorecido, 
	'' cd_agencia_fav, 
	'' nr_conta_fav, 
	0 ie_emissao_aviso, 
	0 ie_tipo_operacao, 
	0 ie_tipo_servico, 
	0 vl_favorecido, 
	0 nr_favorecido_empresa, 
	LOCALTIMESTAMP dt_credito, 
	'' nm_favorecido, 
	'' ds_endereco, 
	'' ds_cidade, 
	'' ie_uf, 
	'' cd_cep, 
	'00' cd_ocorrencia, 
	sum(d.vl_titulo) vl_liquido, 
	'' cd_favorecido, 
	'' nr_bloqueto, 
	LOCALTIMESTAMP dt_vencimento, 
	'' nr_check_horiz , 
	'0' nr_nosso_numero, 
	'0' ds_campo_livre 
from	titulo_pagar_escrit c, 
	titulo_pagar_v2 d, 
   	Estabelecimento e, 
   	banco_estabelecimento b, 
   	banco_escritural a 
where	c.nr_titulo     	= d.nr_titulo 
 and	a.nr_sequencia    	= c.nr_seq_escrit 
 and	a.cd_banco     	= b.cd_banco 
 and	a.cd_estabelecimento 	= b.cd_estabelecimento 
 and	a.cd_estabelecimento 	= e.cd_estabelecimento 
 and	b.ie_tipo_relacao	= 'EP' 
group by a.nr_sequencia;

