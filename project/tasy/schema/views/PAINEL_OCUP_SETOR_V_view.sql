-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW painel_ocup_setor_v (ds_setor_unidade, cd_estabelecimento, qt_media_perm, qt_giro, qt_ocupacao, qt_media_obito) AS select	ds_setor_atendimento ds_setor_unidade,
	cd_estabelecimento,
	CASE WHEN SUM(nr_altas+nr_transf_saida+nr_obitos)=0 THEN 0  ELSE SUM(nr_leitos_ocupados)/SUM(nr_altas+nr_transf_saida+nr_obitos) END qt_media_perm,
	CASE WHEN SUM(nr_leitos_ocupados+nr_leitos_livres)=0 THEN 0  ELSE SUM(nr_altas+nr_transf_saida+nr_obitos)/(SUM(nr_leitos_ocupados+nr_leitos_livres)/AVG(TRUNC(LOCALTIMESTAMP,'dd') -		TRUNC(LOCALTIMESTAMP,'month'))) END qt_giro,
	--SUM(nr_leitos_ocupados)*100/SUM(DECODE(ie_temp,'S',nr_leitos_ocupados,nr_unidades_setor))qt_ocupacao,
	--Comentei a linha acima pois, conforme os outros subindicadores o cálculo da % ocup é igual abaixo:
	sum(nr_leitos_ocupados)*100/sum(nr_leitos_ocupados + nr_leitos_livres)qt_ocupacao,
	CASE WHEN SUM(nr_altas+nr_transf_saida+nr_obitos)=0 THEN 0  ELSE SUM(nr_obitos* 100)/SUM(nr_altas+nr_transf_saida+nr_obitos) END qt_media_obito
FROM	eis_ocupacao_setor_v a
where 	dt_referencia between TRUNC(LOCALTIMESTAMP,'month') and TRUNC(LOCALTIMESTAMP,'dd')
and	ie_periodo = 'D'
and	a.ie_ocup_hospitalar = 'S'
group by ds_setor_atendimento,
	cd_estabelecimento
having(AVG(TRUNC(LOCALTIMESTAMP,'dd') - TRUNC(LOCALTIMESTAMP,'month')) > 0) and (SUM(nr_leitos_ocupados + nr_leitos_livres) > 0);

