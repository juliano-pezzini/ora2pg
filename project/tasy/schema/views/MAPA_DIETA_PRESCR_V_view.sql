-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mapa_dieta_prescr_v (cd_pessoa_fisica, dt_dieta, cd_refeicao, ie_destino_dieta, nm_usuario, ds_observacao, cd_dieta, cd_unidade_basica, cd_unidade_compl, cd_setor_atendimento, nr_sequencia, nr_atendimento, ie_status, dt_atualizacao, ds_observacao_tec, qt_parametro, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_superior, dt_liberacao, nm_usuario_lib, ie_forma_geracao, nr_seq_tipo_jejum, dt_inicio_jejum, dt_fim_jejum, nr_prescricao, nr_seq_local_ref, dt_inicio_prescr, dt_validade_prescr, nm_dieta, ie_tipo_dieta, ds_obs_suplem_oral, ds_obs_sup_nut, nr_prescricao_medica, dt_prescricao, cd_material, ds_material, ie_via_aplicacao, cd_unidade_medida, qt_dose, ds_horarios, hr_prim_horario, ie_acm, ie_se_necessario, nr_dia_util, ie_urgencia, qt_dose_especial, hr_dose_especial, ie_suspenso, ds_justificativa, ds_observacao_nut, cd_intervalo, qt_vel_infusao, dt_horario, dt_entrada, ds_refeicao, ds_classe_acomodacao, ds_destino, ds_acomodacao_etiq, ds_idade, ds_idade_anos, ds_idade_abrev, nm_pessoa_fisica, cd_unidade, hr_atualizacao, qt_paciente, qt_acompanhante, ds_tipo_acomodacao, ds_dados_convenio, ds_obs_tec, ds_setor_atendimento) AS SELECT	a.CD_PESSOA_FISICA,a.DT_DIETA,a.CD_REFEICAO,a.IE_DESTINO_DIETA,a.NM_USUARIO,a.DS_OBSERVACAO,a.CD_DIETA,a.CD_UNIDADE_BASICA,a.CD_UNIDADE_COMPL,a.CD_SETOR_ATENDIMENTO,a.NR_SEQUENCIA,a.NR_ATENDIMENTO,a.IE_STATUS,a.DT_ATUALIZACAO,a.DS_OBSERVACAO_TEC,a.QT_PARAMETRO,a.DT_ATUALIZACAO_NREC,a.NM_USUARIO_NREC,a.NR_SEQ_SUPERIOR,a.DT_LIBERACAO,a.NM_USUARIO_LIB,a.IE_FORMA_GERACAO,a.NR_SEQ_TIPO_JEJUM,a.DT_INICIO_JEJUM,a.DT_FIM_JEJUM,a.NR_PRESCRICAO,a.NR_SEQ_LOCAL_REF,a.DT_INICIO_PRESCR,a.DT_VALIDADE_PRESCR,a.NM_DIETA,a.IE_TIPO_DIETA,a.DS_OBS_SUPLEM_ORAL,a.DS_OBS_SUP_NUT,a.NR_PRESCRICAO_MEDICA,a.DT_PRESCRICAO,a.CD_MATERIAL,a.DS_MATERIAL,a.IE_VIA_APLICACAO,a.CD_UNIDADE_MEDIDA,a.QT_DOSE,a.DS_HORARIOS,a.HR_PRIM_HORARIO,a.IE_ACM,a.IE_SE_NECESSARIO,a.NR_DIA_UTIL,a.IE_URGENCIA,a.QT_DOSE_ESPECIAL,a.HR_DOSE_ESPECIAL,a.IE_SUSPENSO,a.DS_JUSTIFICATIVA,a.DS_OBSERVACAO_NUT,a.CD_INTERVALO,a.QT_VEL_INFUSAO,a.DT_HORARIO,
	obter_data_entrada(a.nr_atendimento) dt_entrada, 
	OBTER_VALOR_DOMINIO(99, a.CD_REFEICAO) DS_REFEICAO, 
	CASE WHEN c.IE_CLASSE_ACOMODACAO='I' THEN 'Individual' WHEN c.IE_CLASSE_ACOMODACAO='C' THEN 'Coletivo' END  ds_classe_acomodacao, 
	CASE WHEN a.IE_DESTINO_DIETA='P' THEN 'Paciente' WHEN a.IE_DESTINO_DIETA='A' THEN 'Acompanhante' END  DS_DESTINO, 
	CASE WHEN s.cd_classif_setor=3 THEN (a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL) WHEN s.cd_classif_setor=4 THEN (a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL)  ELSE s.ds_setor_atendimento END  ds_acomodacao_etiq, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'C'),1,20) ds_idade, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'A'),1,20) || ' a' ds_idade_anos, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'S'),1,20) ds_idade_abrev, 
	p.NM_PESSOA_FISICA, 
	(a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL) CD_UNIDADE, 
	(TO_CHAR(a.DT_ATUALIZACAO,'dd/mm hh24:mi')) HR_ATUALIZACAO, 
	CASE WHEN a.IE_DESTINO_DIETA='P' THEN 1  ELSE 0 END  QT_PACIENTE, 
	CASE WHEN a.IE_DESTINO_DIETA='A' THEN 1  ELSE 0 END  QT_ACOMPANHANTE, 
	substr(obter_desc_tipo_acomod(c.cd_tipo_acomodacao),1,100) ds_tipo_acomodacao, 
	substr(obter_dados_conv_mapa_dieta(a.nr_sequencia),1,240) ds_dados_convenio, 
	substr(a.ds_observacao_tec,1,2000) ds_obs_tec, 
	substr(s.ds_setor_atendimento,1,100) ds_setor_atendimento 
FROM 	setor_atendimento s, 
	pessoa_fisica p, 
	unidade_atendimento c, 
	(SELECT	a.cd_pessoa_fisica, 
		a.dt_dieta, 
		a.cd_refeicao, 
		a.ie_destino_dieta, 
		a.nm_usuario, 
		a.ds_observacao, 
		a.cd_dieta, 
		a.cd_unidade_basica, 
		a.cd_unidade_compl, 
		a.cd_setor_atendimento, 
		a.nr_sequencia, 
		a.nr_atendimento, 
		a.ie_status, 
		a.dt_atualizacao, 
		a.ds_observacao_tec, 
		a.qt_parametro, 
		a.dt_atualizacao_nrec, 
		a.nm_usuario_nrec, 
		a.nr_seq_superior, 
		a.dt_liberacao, 
		a.nm_usuario_lib, 
		a.ie_forma_geracao, 
		a.nr_seq_tipo_jejum, 
		a.dt_inicio_jejum, 
		a.dt_fim_jejum, 
		a.nr_prescricao, 
		a.nr_seq_local_ref, 
		b.dt_inicio_prescr, 
		b.dt_validade_prescr, 
		d.NM_DIETA, 
		d.ie_tipo_dieta, 
		b.ds_observacao ds_obs_suplem_oral, 
		null ds_obs_sup_nut, 
		b.nr_prescricao nr_prescricao_medica, 
		b.dt_prescricao, 
		c.cd_material, 
		substr(OBTER_DESC_MATERIAL(c.cd_material),1,180) ds_material, 
		c.ie_via_aplicacao, 
		c.CD_UNIDADE_MEDIDA, 
		c.QT_DOSE, 
		c.DS_HORARIOS, 
		c.HR_PRIM_HORARIO, 
		c.IE_ACM, 
		c.IE_SE_NECESSARIO, 
		c.NR_DIA_UTIL, 
		c.IE_URGENCIA, 
		c.QT_DOSE_ESPECIAL, 
		c.HR_DOSE_ESPECIAL, 
		c.IE_SUSPENSO, 
		c.DS_JUSTIFICATIVA, 
		c.ds_observacao_nut, 
		c.CD_INTERVALO, 
		c.QT_VEL_INFUSAO, 
		x.dt_horario 
	FROM prescr_medica b, prescr_material c
LEFT OUTER JOIN prescr_mat_hor x ON (c.nr_prescricao = x.nr_prescricao AND c.nr_sequencia = x.nr_seq_material)
, mapa_dieta a
LEFT OUTER JOIN dieta d ON (a.cd_dieta = d.cd_dieta)
WHERE a.cd_pessoa_fisica	= b.cd_pessoa_fisica and b.nr_prescricao		= c.nr_prescricao    and b.dt_prescricao between a.dt_dieta - 10 and a.dt_dieta + 2 and c.ie_agrupador		= 12 and coalesce(c.ie_suspenso,'N')	= 'N' and b.dt_liberacao is not null ) a 
where 	a.cd_pessoa_fisica    = p.cd_pessoa_fisica 
and	a.cd_unidade_basica   = c.cd_unidade_basica 
and	a.cd_unidade_compl    = c.cd_unidade_compl 
and	a.cd_setor_atendimento	 = c.cd_setor_atendimento 
and	Obter_data_dieta_mapa(a.dt_dieta,a.cd_dieta,a.cd_refeicao) between a.dt_inicio_prescr and a.dt_validade_prescr 
and	a.cd_setor_atendimento  = s.cd_setor_atendimento 

union all
 
SELECT	a.CD_PESSOA_FISICA,a.DT_DIETA,a.CD_REFEICAO,a.IE_DESTINO_DIETA,a.NM_USUARIO,a.DS_OBSERVACAO,a.CD_DIETA,a.CD_UNIDADE_BASICA,a.CD_UNIDADE_COMPL,a.CD_SETOR_ATENDIMENTO,a.NR_SEQUENCIA,a.NR_ATENDIMENTO,a.IE_STATUS,a.DT_ATUALIZACAO,a.DS_OBSERVACAO_TEC,a.QT_PARAMETRO,a.DT_ATUALIZACAO_NREC,a.NM_USUARIO_NREC,a.NR_SEQ_SUPERIOR,a.DT_LIBERACAO,a.NM_USUARIO_LIB,a.IE_FORMA_GERACAO,a.NR_SEQ_TIPO_JEJUM,a.DT_INICIO_JEJUM,a.DT_FIM_JEJUM,a.NR_PRESCRICAO,a.NR_SEQ_LOCAL_REF,a.DT_INICIO_PRESCR,a.DT_VALIDADE_PRESCR,a.NM_DIETA,a.IE_TIPO_DIETA,a.DS_OBS_SUPLEM_ORAL,a.DS_OBS_SUP_NUT,a.NR_PRESCRICAO_MEDICA,a.DT_PRESCRICAO,a.CD_MATERIAL,a.DS_MATERIAL,a.IE_VIA_APLICACAO,a.CD_UNIDADE_MEDIDA,a.QT_DOSE,a.DS_HORARIOS,a.HR_PRIM_HORARIO,a.IE_ACM,a.IE_SE_NECESSARIO,a.NR_DIA_UTIL,a.IE_URGENCIA,a.QT_DOSE_ESPECIAL,a.HR_DOSE_ESPECIAL,a.IE_SUSPENSO,a.DS_JUSTIFICATIVA,a.DS_OBSERVACAO_NUT,a.CD_INTERVALO,a.QT_VEL_INFUSAO,a.DT_HORARIO, 
	obter_data_entrada(a.nr_atendimento) dt_entrada, 
	OBTER_VALOR_DOMINIO(99, a.CD_REFEICAO) DS_REFEICAO, 
	CASE WHEN c.IE_CLASSE_ACOMODACAO='I' THEN 'Individual' WHEN c.IE_CLASSE_ACOMODACAO='C' THEN 'Coletivo' END  ds_classe_acomodacao, 
	CASE WHEN a.IE_DESTINO_DIETA='P' THEN 'Paciente' WHEN a.IE_DESTINO_DIETA='A' THEN 'Acompanhante' END  DS_DESTINO, 
	CASE WHEN s.cd_classif_setor=3 THEN (a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL) WHEN s.cd_classif_setor=4 THEN (a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL)  ELSE s.ds_setor_atendimento END  ds_acomodacao_etiq, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'C'),1,20) ds_idade, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'A'),1,20) || ' a' ds_idade_anos, 
	substr(OBTER_IDADE(p.DT_NASCIMENTO, LOCALTIMESTAMP, 'S'),1,20) ds_idade_abrev, 
	p.NM_PESSOA_FISICA, 
	(a.CD_UNIDADE_BASICA || ' ' ||a.CD_UNIDADE_COMPL) CD_UNIDADE, 
	(TO_CHAR(a.DT_ATUALIZACAO,'dd/mm hh24:mi')) HR_ATUALIZACAO, 
	CASE WHEN a.IE_DESTINO_DIETA='P' THEN 1  ELSE 0 END  QT_PACIENTE, 
	CASE WHEN a.IE_DESTINO_DIETA='A' THEN 1  ELSE 0 END  QT_ACOMPANHANTE, 
	substr(obter_desc_tipo_acomod(c.cd_tipo_acomodacao),1,100) ds_tipo_acomodacao, 
	substr(obter_dados_conv_mapa_dieta(a.nr_sequencia),1,240) ds_dados_convenio, 
	substr(a.ds_observacao_tec,1,2000) ds_obs_tec, 
	substr(s.ds_setor_atendimento,1,100) ds_setor_atendimento 
from 	setor_atendimento s, 
	pessoa_fisica p, 
	unidade_atendimento c, 
	(SELECT	a.cd_pessoa_fisica, 
		a.dt_dieta, 
		a.cd_refeicao, 
		a.ie_destino_dieta, 
		a.nm_usuario, 
		a.ds_observacao, 
		a.cd_dieta, 
		a.cd_unidade_basica, 
		a.cd_unidade_compl, 
		a.cd_setor_atendimento, 
		a.nr_sequencia, 
		a.nr_atendimento, 
		a.ie_status, 
		a.dt_atualizacao, 
		a.ds_observacao_tec, 
		a.qt_parametro, 
		a.dt_atualizacao_nrec, 
		a.nm_usuario_nrec, 
		a.nr_seq_superior, 
		a.dt_liberacao, 
		a.nm_usuario_lib, 
		a.ie_forma_geracao, 
		a.nr_seq_tipo_jejum, 
		a.dt_inicio_jejum, 
		a.dt_fim_jejum, 
		a.nr_prescricao, 
		a.nr_seq_local_ref, 
		b.dt_inicio_prescr, 
		b.dt_validade_prescr, 
		d.NM_DIETA, 
		d.ie_tipo_dieta, 
		null ds_obs_suplem_oral, 
		c.ds_observacao ds_obs_sup_nut, 
		b.nr_prescricao nr_prescricao_medica, 
		b.dt_prescricao, 
		c.cd_material, 
		substr(OBTER_DESC_MATERIAL(c.cd_material),1,180) ds_material, 
		c.ie_via_aplicacao, 
		c.CD_UNIDADE_MEDIDA, 
		c.QT_DOSE, 
		c.DS_HORARIOS, 
		c.HR_PRIM_HORARIO, 
		c.IE_ACM, 
		c.IE_SE_NECESSARIO, 
		c.NR_DIA_UTIL, 
		c.IE_URGENCIA, 
		c.QT_DOSE_ESPECIAL, 
		c.HR_DOSE_ESPECIAL, 
		c.IE_SUSPENSO, 
		c.DS_JUSTIFICATIVA, 
		c.ds_observacao_nut, 
		c.CD_INTERVALO, 
		c.QT_VEL_INFUSAO, 
		x.dt_horario 
	FROM prescr_medica b, prescr_material c
LEFT OUTER JOIN prescr_mat_hor x ON (c.nr_prescricao = x.nr_prescricao AND c.nr_sequencia = x.nr_seq_material)
, mapa_dieta a
LEFT OUTER JOIN dieta d ON (a.cd_dieta = d.cd_dieta)
WHERE a.cd_pessoa_fisica	= b.cd_pessoa_fisica   and b.nr_prescricao		= c.nr_prescricao  and b.dt_prescricao between a.dt_dieta - 10 and a.dt_dieta + 2 and c.ie_agrupador		= 8 and coalesce(c.ie_suspenso,'N')	= 'N' and b.dt_liberacao is not null ) a 
where 	a.cd_pessoa_fisica    = p.cd_pessoa_fisica 
and	a.cd_unidade_basica   = c.cd_unidade_basica 
and	a.cd_unidade_compl    = c.cd_unidade_compl 
and	a.cd_setor_atendimento	 = c.cd_setor_atendimento 
and	Obter_data_dieta_mapa(a.dt_dieta,a.cd_dieta,a.cd_refeicao) between a.dt_inicio_prescr and a.dt_validade_prescr 
and	a.cd_setor_atendimento  = s.cd_setor_atendimento;

