-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_demonstrativo_pagamento_v (nr_documento, dt_emissao, nm_beneficiario, cd_usuario_plano, nr_quantidade, cd_procedimento, ds_descricao, ds_atividade, vl_honorario, vl_custo_operacional, vl_filme, nr_opm, vl_glosa, nr_seq_evento, nr_seq_protocolo, nr_seq_prestador_pgto, cd_pessoa_fisica, ie_tipo_item, nr_seq_prestador_exec, nr_seq_lote_pgto, nr_seq_pag_item, vl_taxas, vl_apresentado, nr_seq_resumo, nr_seq_conta, vl_liberado, ie_participante) AS select	nr_documento,
	dt_emissao, 
	nm_beneficiario, 
	cd_usuario_plano, 
	nr_quantidade, 
	cd_procedimento, 
	ds_descricao, 
	ds_atividade, 
	CASE WHEN ie_tipo_item='P' THEN  CASE WHEN vl_custo_operacional=0 THEN  CASE WHEN vl_liberado=vl_custo_operacional THEN  0  ELSE vl_honorario END   ELSE CASE WHEN vl_liberado=vl_honorario THEN  0  ELSE vl_custo_operacional END  END   ELSE CASE WHEN vl_liberado=vl_custo_operacional THEN  0  ELSE vl_honorario END  END  vl_honorario,				 
	CASE WHEN ie_tipo_item='P' THEN  CASE WHEN vl_custo_operacional=0 THEN  CASE WHEN vl_liberado=vl_honorario THEN  0  ELSE vl_custo_operacional END   ELSE vl_custo_operacional END   ELSE CASE WHEN vl_liberado=vl_honorario THEN  0  ELSE vl_custo_operacional END  END  vl_custo_operacional, 
	vl_filme, 
	nr_opm, 
	vl_glosa, 
	nr_seq_evento, 
	nr_seq_protocolo, 
	nr_seq_prestador_pgto, 
	cd_pessoa_fisica, 
	ie_tipo_item, 
	nr_seq_prestador_exec, 
	nr_seq_lote_pgto, 
	nr_seq_pag_item, 
	vl_taxas, 
	vl_apresentado, 
	nr_seq_resumo, 
	nr_seq_conta, 
	vl_liberado, 
	ie_participante 
FROM	(select	nr_documento, 
		dt_emissao, 
		nm_beneficiario, 
		cd_usuario_plano, 
		nr_quantidade, 
		cd_procedimento, 
		ds_descricao, 
		ds_atividade, 
		case	when(vl_honorario > 0) and (vl_filme > 0) and (vl_custo_operacional > 0) and (vl_honorario + vl_filme + vl_custo_operacional = vl_liberado) then 
			CASE WHEN ie_participante='N' THEN  0  ELSE vl_custo_operacional END  
		else	 
			CASE WHEN ie_tipo_item='C' THEN  vl_liberado WHEN ie_tipo_item='R' THEN  vl_liberado WHEN ie_tipo_item='P' THEN  CASE WHEN vl_liberado=vl_custo_operacional THEN  0  ELSE CASE WHEN ie_tipo_despesa='4' THEN  0 WHEN ie_tipo_despesa='2' THEN  0   ELSE CASE WHEN vl_liberado=vl_honorario + vl_anestesista + vl_auxiliares THEN  vl_honorario  ELSE vl_liberado END  END  END  WHEN ie_tipo_item='M' THEN  0  ELSE vl_honorario END  
		end	vl_honorario,	 
		case	when(vl_honorario > 0) and (vl_filme > 0) and (vl_custo_operacional > 0) and (vl_honorario + vl_filme + vl_custo_operacional = vl_liberado) then	 
			CASE WHEN ie_participante='S' THEN  0  ELSE vl_honorario END  
		else 
			CASE WHEN ie_tipo_item='M' THEN  vl_liberado WHEN ie_tipo_item='C' THEN  0 WHEN ie_tipo_item='P' THEN  CASE WHEN ie_tipo_despesa='4' THEN  vl_liberado WHEN ie_tipo_despesa='2' THEN  vl_liberado  ELSE CASE WHEN vl_liberado - vl_taxas=vl_custo_operacional + vl_filme THEN  vl_custo_operacional  ELSE CASE WHEN vl_liberado=vl_custo_operacional THEN  CASE WHEN vl_filme=0 THEN  vl_custo_operacional  ELSE 0 END   ELSE vl_custo_operacional END  END  END   ELSE vl_custo_operacional END  
		end	vl_custo_operacional, 
		case	when(vl_honorario > 0) and (vl_filme > 0) and (vl_custo_operacional > 0) and (vl_honorario + vl_filme + vl_custo_operacional = vl_liberado) then	 
			CASE WHEN ie_participante='S' THEN  0  ELSE vl_filme END  
		else 
			CASE WHEN ie_tipo_item='M' THEN  vl_filme WHEN ie_tipo_item='C' THEN  0 WHEN ie_tipo_item='P' THEN  CASE WHEN vl_liberado - vl_taxas=vl_custo_operacional + vl_filme THEN  vl_filme  ELSE CASE WHEN vl_filme=vl_liberado THEN  CASE WHEN coalesce(vl_custo_operacional,0)=0 THEN  vl_liberado  ELSE vl_filme END   ELSE vl_filme END  END   ELSE vl_filme END  
		end	vl_filme, 
		nr_opm, 
		vl_glosa, 
		nr_seq_evento, 
		nr_seq_protocolo, 
		nr_seq_prestador_pgto, 
		CASE WHEN ie_tipo_item='P' THEN  CASE WHEN vl_custo_operacional=0 THEN  cd_pessoa_fisica  ELSE null END   ELSE cd_pessoa_fisica END  cd_pessoa_fisica, 
		ie_tipo_item, 
		case	when(vl_honorario > 0) and (vl_filme > 0) and (vl_custo_operacional > 0) and (vl_honorario + vl_filme + vl_custo_operacional = vl_liberado) then 
			CASE WHEN ie_participante='S' THEN  0  ELSE nr_seq_prestador_exec END  
		else 
			nr_seq_prestador_exec 
		end nr_seq_prestador_exec, 
		nr_seq_lote_pgto, 
		nr_seq_pag_item, 
		vl_taxas, 
		vl_apresentado, 
		nr_sequencia nr_seq_resumo, 
		nr_seq_conta, 
		vl_liberado, 
		ie_participante 
	from	(select	a.cd_guia nr_documento, 
			to_char(a.dt_emissao, 'dd/mm/yyyy') dt_emissao, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,50) nm_beneficiario, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_usuario_plano, 
			coalesce(c.qt_item,0) nr_quantidade, 
			to_char(b.cd_procedimento) cd_procedimento, 
			substr(obter_descricao_procedimento(b.cd_procedimento,b.ie_origem_proced),1,45) ds_descricao, 
			'' ds_atividade, 
			coalesce(c.vl_medico,0) vl_honorario, 
			abs(CASE WHEN c.nr_seq_exame_coleta IS NULL THEN  CASE WHEN coalesce(b.vl_exame_coleta,0)=0 THEN  coalesce(c.vl_custo_operacional,0)  ELSE coalesce(c.vl_custo_operacional,0) - 				(select	coalesce(sum(x.vl_liberado),0) 				from	pls_conta_proc		y, 					pls_conta_medica_resumo x 				where	y.nr_sequencia = x.nr_seq_item 				and	x.nr_seq_evento 	= c.nr_seq_evento 				and	x.nr_seq_protocolo 	= c.nr_seq_protocolo 				and	x.nr_seq_prestador_pgto <> c.nr_seq_prestador_pgto 				and	x.nr_seq_exame_coleta is not null 				and	((coalesce(x.cd_pessoa_fisica,'0') = coalesce(c.cd_pessoa_fisica,'0') and x.ie_tipo_item not in ('P', 'M')) or (c.cd_pessoa_fisica is null and CASE WHEN x.ie_tipo_item='P' THEN  x.nr_seq_prestador_exec WHEN x.ie_tipo_item='M' THEN  x.nr_seq_prestador_exec  ELSE '0' END  = c.nr_seq_prestador_exec)) 				and	x.nr_seq_conta		= a.nr_sequencia 				and	x.ie_tipo_item		= c.ie_tipo_item 				and	x.ie_tipo_item		= 'P') END   ELSE coalesce(c.vl_liberado,0) END ) vl_custo_operacional, 
			coalesce(c.vl_materiais,0) vl_filme, 
			null nr_opm, 
			coalesce(c.vl_glosa,0) vl_glosa, 
			coalesce(c.vl_liberado,0) vl_liberado, 
			c.nr_seq_evento, 
			c.nr_seq_protocolo, 
			c.nr_seq_prestador_pgto, 
			c.cd_pessoa_fisica, 
			c.ie_tipo_item, 
			c.nr_seq_prestador_exec, 
			c.nr_seq_lote_pgto, 
			c.nr_seq_pag_item, 
			coalesce(c.vl_taxa_adm,0) + coalesce(c.vl_taxa_adm_co,0) + coalesce(c.vl_taxa_adm_mat,0) vl_taxas, 
			b.ie_tipo_despesa, 
			c.vl_apresentado, 
			c.nr_sequencia, 
			a.nr_sequencia nr_seq_conta, 
			c.vl_anestesista, 
			c.vl_auxiliares, 
			'N' ie_participante 
		from	pls_conta 		a, 
			pls_conta_proc 		b, 
			pls_conta_medica_resumo c 
		where	a.nr_sequencia		= b.nr_seq_conta 
		and	c.nr_seq_conta  	= a.nr_sequencia 
		and	c.nr_seq_conta_proc	= b.nr_sequencia 
		and	c.ie_tipo_item <> 'I' 
		and	coalesce(c.qt_item, 0) > 0 
		
union
 
		select	a.cd_guia nr_documento, 
			to_char(a.dt_emissao, 'dd/mm/yyyy') dt_emissao, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,50) nm_beneficiario, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_usuario_plano, 
			coalesce(c.qt_item,0) nr_quantidade, 
			substr(pls_obter_dados_material(b.nr_seq_material, 'CO'),1,40) cd_procedimento, 
			substr(pls_obter_dados_material(b.nr_seq_material,'DS'),1,45) ds_descricao, 
			'' ds_atividade, 
			coalesce(c.vl_liberado,0) vl_honorario, 
			0 vl_custo_operacional, 
			0 vl_filme, 
			b.nr_nota_fiscal nr_opm, 
			coalesce(c.vl_glosa,0) vl_glosa, 
			coalesce(c.vl_liberado, 0) vl_liberado, 
			c.nr_seq_evento, 
			c.nr_seq_protocolo, 
			c.nr_seq_prestador_pgto, 
			c.cd_pessoa_fisica, 
			c.ie_tipo_item, 
			c.nr_seq_prestador_exec, 
			c.nr_seq_lote_pgto, 
			c.nr_seq_pag_item, 
			coalesce(c.vl_taxa_adm,0) + coalesce(c.vl_taxa_adm_co,0) + coalesce(c.vl_taxa_adm_mat,0) vl_taxas, 
			b.ie_tipo_despesa, 
			c.vl_apresentado, 
			c.nr_sequencia, 
			a.nr_sequencia nr_seq_conta, 
			c.vl_anestesista, 
			c.vl_auxiliares, 
			'N' ie_participante 
		from	pls_conta	a, 
			pls_conta_mat	b, 
			pls_conta_medica_resumo c 
		where	a.nr_sequencia = b.nr_seq_conta 
		and	c.nr_seq_conta = a.nr_sequencia 
		and	c.nr_seq_conta_mat 	= b.nr_sequencia 
		and	c.ie_tipo_item <> 'I' 
		and	coalesce(c.qt_item, 0) > 0 
		
union all
 
		select	a.cd_guia nr_documento, 
			to_char(a.dt_emissao, 'dd/mm/yyyy') dt_emissao, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,50) nm_beneficiario, 
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_usuario_plano, 
			coalesce(c.qt_item,0) nr_quantidade, 
			to_char(b.cd_procedimento) cd_procedimento, 
			substr(obter_descricao_procedimento(b.cd_procedimento,b.ie_origem_proced),1,45) ds_descricao, 
			'' ds_atividade, 
			coalesce(c.vl_medico,0) vl_honorario, 
			abs(CASE WHEN c.nr_seq_exame_coleta IS NULL THEN  CASE WHEN coalesce(b.vl_exame_coleta,0)=0 THEN  coalesce(c.vl_custo_operacional,0)  ELSE coalesce(c.vl_custo_operacional,0) - 				(select	coalesce(sum(x.vl_liberado),0) 				from	pls_conta_proc		y, 					pls_conta_medica_resumo x 				where	y.nr_sequencia = x.nr_seq_item 				and	x.nr_seq_evento 	= c.nr_seq_evento 				and	x.nr_seq_protocolo 	= c.nr_seq_protocolo 				and	x.nr_seq_prestador_pgto <> c.nr_seq_prestador_pgto 				and	x.nr_seq_exame_coleta is not null 				and	((coalesce(x.cd_pessoa_fisica,'0') = coalesce(c.cd_pessoa_fisica,'0') and x.ie_tipo_item not in ('P', 'M')) or (c.cd_pessoa_fisica is null and CASE WHEN x.ie_tipo_item='P' THEN  x.nr_seq_prestador_exec WHEN x.ie_tipo_item='M' THEN  x.nr_seq_prestador_exec  ELSE '0' END  = c.nr_seq_prestador_exec)) 				and	x.nr_seq_conta		= a.nr_sequencia 				and	x.ie_tipo_item		= c.ie_tipo_item 				and	x.ie_tipo_item		= 'P') END   ELSE coalesce(c.vl_liberado,0) END ) vl_custo_operacional, 
			coalesce(c.vl_materiais,0) vl_filme, 
			null nr_opm, 
			coalesce(c.vl_glosa,0) vl_glosa, 
			coalesce(c.vl_liberado,0) vl_liberado, 
			c.nr_seq_evento, 
			c.nr_seq_protocolo, 
			c.nr_seq_prestador_pgto, 
			c.cd_pessoa_fisica, 
			c.ie_tipo_item, 
			c.nr_seq_prestador_exec, 
			c.nr_seq_lote_pgto, 
			c.nr_seq_pag_item, 
			coalesce(c.vl_taxa_adm,0) + coalesce(c.vl_taxa_adm_co,0) + coalesce(c.vl_taxa_adm_mat,0) vl_taxas, 
			b.ie_tipo_despesa, 
			c.vl_apresentado, 
			c.nr_sequencia, 
			a.nr_sequencia nr_seq_conta, 
			c.vl_anestesista, 
			c.vl_auxiliares, 
			'S' ie_tipo_participante 
		from	pls_conta 		a, 
			pls_conta_proc 		b, 
			pls_conta_medica_resumo c 
		where	a.nr_sequencia		= b.nr_seq_conta 
		and	c.nr_seq_conta  	= a.nr_sequencia 
		and	c.nr_seq_conta_proc	= b.nr_sequencia 
		and	c.ie_tipo_item <> 'I' 
		and	coalesce(c.vl_medico,0) + coalesce(c.vl_custo_operacional,0) + coalesce(c.vl_materiais,0) = c.vl_liberado 
		and	coalesce(c.vl_medico,0) > 0 
		and	coalesce(c.vl_materiais, 0) > 0 
		and	coalesce(c.qt_item, 0) > 0) alias101) alias102;

