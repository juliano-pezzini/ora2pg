-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nota_fiscal_centro_custo_v (cd_local_estoque, cd_centro_custo, ds_centro_custo, cd_conta_contabil, ds_conta_contabil, cd_grupo_material, ds_grupo_material, cd_subgrupo_material, ds_subgrupo_material, cd_classe_material, ds_classe_material, cd_material, ds_material, ie_consignado, nr_nota_fiscal, dt_atualizacao_estoque, dt_mesano_estoque, dt_entrada_saida, dt_atualizacao, dt_emissao, dt_contabil, cd_estabelecimento, vl_movimento, qt_movimento, cd_operacao_estoque, ds_operacao, cd_cgc_emitente) AS select	/*+ index (a notfiit_notfisc_fk_i) */	a.cd_local_estoque,
	r.cd_centro_custo,
	b.ds_centro_custo,
	coalesce(r.cd_conta_contabil, a.cd_conta_contabil) cd_conta_contabil,
	substr(obter_desc_conta_contabil(coalesce(r.cd_conta_contabil, a.cd_conta_contabil)),1,255) ds_conta_contabil,
	c.cd_grupo_material,
	c.ds_grupo_material,
	d.cd_subgrupo_material,
	d.ds_subgrupo_material,
	e.cd_classe_material,
	e.ds_classe_material,
	f.cd_material,
	f.ds_material,
	CASE WHEN coalesce(h.ie_consignado,'0')='0' THEN 'N'  ELSE 'S' END  ie_consignado,
	g.nr_nota_fiscal,
	g.dt_atualizacao_estoque,
	trunc(g.dt_atualizacao_estoque,'Month') dt_mesano_estoque,
	g.dt_entrada_saida,
	g.dt_atualizacao,
	g.dt_emissao,
	g.dt_contabil,
	g.cd_estabelecimento,
	sum(coalesce(r.vl_rateio, CASE WHEN g.ie_acao_nf=1 THEN a.vl_liquido  ELSE a.vl_liquido * - 1 END )) vl_movimento,
	round((sum(dividir(a.qt_item_nf * coalesce(r.vl_rateio, CASE WHEN g.ie_acao_nf=1 THEN a.vl_liquido  ELSE a.vl_liquido * - 1 END ),a.vl_total_item_nf)))::numeric,2) qt_movimento,
	h.cd_operacao_estoque,
	h.ds_operacao,
	g.cd_cgc_emitente
FROM nota_fiscal_item_rateio r, nota_fiscal g, material f, classe_material e, subgrupo_material d, grupo_material c, centro_custo b, nota_fiscal_item a, operacao_nota i
LEFT OUTER JOIN operacao_estoque h ON (i.cd_operacao_estoque = h.cd_operacao_estoque)
WHERE a.nr_sequencia		= g.nr_sequencia and r.cd_centro_custo		= b.cd_centro_custo and a.cd_material		= f.cd_material and f.cd_classe_material	= e.cd_classe_material and e.cd_subgrupo_material	= d.cd_subgrupo_material and d.cd_grupo_material	= c.cd_grupo_material and g.cd_operacao_nf		= i.cd_operacao_nf  and a.nr_sequencia		= r.nr_seq_nota and a.nr_item_nf		= r.nr_item_nf and g.ie_situacao		= '1' and r.cd_centro_custo is not null group by
	a.cd_local_estoque,
	r.cd_centro_custo,
	b.ds_centro_custo,
	coalesce(r.cd_conta_contabil, a.cd_conta_contabil),
	c.cd_grupo_material,
	c.ds_grupo_material,
	d.cd_subgrupo_material,
	d.ds_subgrupo_material,
	e.cd_classe_material,
	e.ds_classe_material,
	f.cd_material,
	f.ds_material,
	CASE WHEN coalesce(h.ie_consignado,'0')='0' THEN 'N'  ELSE 'S' END ,
	g.nr_nota_fiscal,
	g.dt_atualizacao_estoque,
	g.dt_entrada_saida,
	g.dt_atualizacao,
	g.dt_emissao,
	g.dt_contabil,
	g.cd_estabelecimento,
	a.qt_item_nf,
	h.cd_operacao_estoque,
	h.ds_operacao,
	g.cd_cgc_emitente

union

select	/*+ index (a notfiit_notfisc_fk_i) */	a.cd_local_estoque,
	a.cd_centro_custo,
	b.ds_centro_custo,
	a.cd_conta_contabil,
	substr(obter_desc_conta_contabil(a.cd_conta_contabil),1,255) ds_conta_contabil,
	c.cd_grupo_material,
	c.ds_grupo_material,
	d.cd_subgrupo_material,
	d.ds_subgrupo_material,
	e.cd_classe_material,
	e.ds_classe_material,
	f.cd_material,
	f.ds_material,
	CASE WHEN coalesce(h.ie_consignado,'0')='0' THEN 'N'  ELSE 'S' END  ie_consignado,
	g.nr_nota_fiscal,
	g.dt_atualizacao_estoque,
	trunc(g.dt_atualizacao_estoque,'Month') dt_mesano_estoque,
	g.dt_entrada_saida,
	g.dt_atualizacao,
	g.dt_emissao,
	g.dt_contabil,
	g.cd_estabelecimento,
	sum(CASE WHEN i.ie_operacao_fiscal='E' THEN (CASE WHEN g.ie_acao_nf=1 THEN a.vl_liquido  ELSE a.vl_liquido * - 1 END )  ELSE a.vl_liquido * -1 END ) vl_movimento,
	sum(CASE WHEN i.ie_operacao_fiscal='E' THEN (CASE WHEN g.ie_acao_nf=1 THEN a.qt_item_nf  ELSE a.qt_item_nf * - 1 END )  ELSE a.qt_item_nf * -1 END ) qt_movimento,
/*	sum(a.qt_item_nf) qt_movimento	Maicon 14/04/2008 - Substitui essa linha pelo decode acima para ficar igual ao vl_movimento*/

	h.cd_operacao_estoque,
	h.ds_operacao,
	g.cd_cgc_emitente
FROM nota_fiscal g, material f, classe_material e, subgrupo_material d, grupo_material c, centro_custo b, nota_fiscal_item a, operacao_nota i
LEFT OUTER JOIN operacao_estoque h ON (i.cd_operacao_estoque = h.cd_operacao_estoque)
WHERE a.nr_sequencia 		= g.nr_sequencia and a.cd_centro_custo 		= b.cd_centro_custo and a.cd_material 		= f.cd_material and f.cd_classe_material 	= e.cd_classe_material and e.cd_subgrupo_material 	= d.cd_subgrupo_material and d.cd_grupo_material 	= c.cd_grupo_material and g.cd_operacao_nf 		= i.cd_operacao_nf  and g.ie_situacao			= '1' and a.cd_centro_custo is not null and not exists (
	select	1
	from	nota_fiscal_item_rateio r
	where	r.nr_seq_nota = g.nr_sequencia
	and	r.nr_item_nf    = a.nr_item_nf) group by
	a.cd_local_estoque,
	a.cd_centro_custo,
	b.ds_centro_custo,
	a.cd_conta_contabil,
	c.cd_grupo_material,
	c.ds_grupo_material,
	d.cd_subgrupo_material,
	d.ds_subgrupo_material,
	e.cd_classe_material,
	e.ds_classe_material,
	f.cd_material,
	f.ds_material,
	CASE WHEN coalesce(h.ie_consignado,'0')='0' THEN 'N'  ELSE 'S' END ,
	g.nr_nota_fiscal,
	g.dt_atualizacao_estoque,
	g.dt_entrada_saida,
	g.dt_atualizacao,
	g.dt_emissao,
	g.dt_contabil,
	g.cd_estabelecimento,
	h.cd_operacao_estoque,
	h.ds_operacao,
	g.cd_cgc_emitente;

