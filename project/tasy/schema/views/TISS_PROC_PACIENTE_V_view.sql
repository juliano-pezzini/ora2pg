-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_proc_paciente_v (ds_versao, dt_procedimento, ds_procedimento, cd_edicao_amb, cd_procedimento, qt_procedimento, vl_reducao_acrescimo, vl_procedimento, nr_interno_conta, cd_autorizacao, dt_entrada, dt_alta, ie_via_acesso, vl_unitario, ie_honorario, nr_seq_procedimento, cd_medico_executor, cd_procedimento_convenio, cd_edicao_relat, ie_tiss_tipo_guia, ds_proc_tasy, dt_inicio_cirurgia, dt_fim_cirurgia, ie_tiss_tipo_guia_honor, vl_medico, vl_unitario_medico, cd_cgc_prestador, cd_cgc_honorario, ie_tecnica_utilizada) AS select	DS_VERSAO,
	DT_PROCEDIMENTO,
	DS_PROCEDIMENTO,
	CD_EDICAO_AMB,
	CD_PROCEDIMENTO,
	QT_PROCEDIMENTO,
	VL_REDUCAO_ACRESCIMO,
	CASE WHEN ie_tiss_tipo_guia='6' THEN  vl_medico  ELSE vl_procedimento END  vl_procedimento,
	NR_INTERNO_CONTA,
	CD_AUTORIZACAO,
	DT_ENTRADA,
	DT_ALTA,
	IE_VIA_ACESSO,
	dividir_sem_round(CASE WHEN ie_tiss_tipo_guia='6' THEN  vl_medico  ELSE vl_procedimento END , qt_procedimento) VL_UNITARIO,
	CASE WHEN ie_tiss_tipo_guia='6' THEN 'S'  ELSE 'N' END  ie_honorario,
	NR_SEQ_PROCEDIMENTO,
	CD_MEDICO_EXECUTOR,
	replace(replace(CD_PROCEDIMENTO_CONVENIO, '.',''),'-','') CD_PROCEDIMENTO_CONVENIO,
	CD_EDICAO_RELAT,
	IE_TISS_TIPO_GUIA,
	DS_PROC_TASY,
	dt_inicio_cirurgia,
	dt_fim_cirurgia,
	ie_tiss_tipo_guia_honor,
	vl_medico,
	dividir_sem_round(vl_medico, qt_procedimento) VL_UNITARIO_MEDICO,
	coalesce(cd_cgc_prestador_tiss, CASE WHEN ie_tiss_tipo_guia='5' THEN  cd_cgc_estab  ELSE coalesce(cd_cgc_prestador, cd_cgc_estab) END ) cd_cgc_prestador, -- Edgar 13-06-07, OS59019, Lab para SADT
	coalesce(cd_cgc_honorario_tiss, cd_cgc_prestador) cd_cgc_honorario,
	ie_tecnica_utilizada
FROM
(	select	'2.01.01' ds_versao,
		a.dt_procedimento,
		substr(TISS_ELIMINAR_CARACTERE(obter_desc_proc_convenio(a.nr_sequencia, null)), 1, 60) ds_procedimento,
		substr(coalesce(tiss_obter_tabela(a.cd_edicao_amb, p.cd_estabelecimento,  e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta, 'X', c.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null,p.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),'00'), 1, 20) cd_edicao_amb,
		lpad(a.cd_procedimento, 10, '0') cd_procedimento,
		a.qt_procedimento,
		0 vl_reducao_acrescimo,
		a.vl_medico,
		a.vl_procedimento,
		a.nr_interno_conta,
		coalesce(a.nr_doc_convenio, obter_desc_expressao(778770)) cd_autorizacao,
		p.dt_entrada,
		p.dt_alta,
		CASE WHEN a.ie_via_acesso='B' THEN 'U'  ELSE a.ie_via_acesso END  ie_via_acesso,
		a.nr_sequencia nr_seq_procedimento,
		a.cd_medico_executor,
		lpad(coalesce(a.CD_PROCEDIMENTO_CONVENIO, a.CD_PROCEDIMENTO),10,'0') CD_PROCEDIMENTO_CONVENIO,
		coalesce(substr(tiss_obter_tabela(a.cd_edicao_amb, p.cd_estabelecimento, e.cd_convenio_parametro, e.cd_categoria_parametro, a.dt_conta, 'R', c.ie_classificacao,a.cd_procedimento,a.ie_origem_proced, null, null, p.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_procedimento_tuss),1,20),'00') CD_EDICAO_RELAT,
		substr(TISS_OBTER_GUIA_PROC(	p.ie_tipo_atendimento, 
						a.cd_procedimento, 
						a.ie_origem_proced,
						null,
						null,
						a.ie_tiss_tipo_guia),1,5) ie_tiss_tipo_guia,
		substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_proc_tasy,
		a.cd_cgc_prestador cd_cgc_prestador,
		coalesce(j.dt_inicio_real, a.dt_inicio_procedimento) dt_inicio_cirurgia,
		coalesce(j.dt_termino, a.dt_procedimento) dt_fim_cirurgia,
		a.ie_tiss_tipo_guia_honor ie_tiss_tipo_guia_honor,
		h.cd_cgc cd_cgc_estab,
		a.ie_tecnica_utilizada,
		a.cd_cgc_prestador_tiss,
		a.cd_cgc_honorario_tiss
	FROM atendimento_paciente p, estabelecimento h, conta_paciente e, procedimento c, convenio b, procedimento_paciente a
LEFT OUTER JOIN regra_honorario d ON (a.ie_responsavel_credito = d.cd_regra)
LEFT OUTER JOIN cirurgia j ON (a.nr_cirurgia = j.nr_cirurgia)
WHERE coalesce(a.nr_seq_proc_pacote, a.nr_sequencia)		= a.nr_sequencia and a.cd_convenio						= b.cd_convenio and p.nr_atendimento					= a.nr_atendimento and a.cd_procedimento					= c.cd_procedimento and a.ie_origem_proced					= c.ie_origem_proced   and a.cd_motivo_exc_conta				is null and e.cd_estabelecimento					= h.cd_estabelecimento and ((obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) not in (2, 3) and (a.ie_tiss_tipo_guia is null)) or (a.ie_tiss_tipo_guia in (4,5,6))) and a.nr_interno_conta		= e.nr_interno_conta ) alias35;

