-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW paciente_isolamento_v (nr_atendimento, cd_pessoa_fisica, nm_pessoa_fisica, cd_convenio, ds_convenio, cd_medico, nm_medico, cd_setor_atendimento, nm_setor_atendimento, ds_clinica, dt_inicio_isolamento, dt_fim_isolamento, qt_dias_isolamento, cd_precaucao, ds_precaucao, cd_motivo_precaucao, ds_motivo_precaucao, cd_tipo_isolamento, ds_tipo_isolamento, ie_paciente_isolado, nr) AS select	o.nr_atendimento,
	o.cd_pessoa_fisica, 
	substr(obter_nome_pf(o.cd_pessoa_fisica),1,60) nm_pessoa_fisica, 
	o.cd_convenio, 
	o.ds_convenio, 
	substr(obter_dados_atendimento(o.nr_atendimento,'MR'),1,10) cd_medico, 
	o.nm_guerra nm_medico, 
	o.cd_setor_atendimento, 
	substr(obter_nome_setor(o.cd_setor_atendimento),1,100) nm_setor_atendimento, 
	coalesce(o.ds_clinica,'NÃ£o informado') ds_clinica, 
	to_date(substr(CASE WHEN obter_valor_param_usuario(44,187,obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento)='S' THEN  obter_precaucao_isolamento(o.nr_atendimento,'DI')  ELSE obter_dados_isolamento(o.nr_atendimento,'I') END ,1,21),'dd/mm/yyyy hh24:mi:ss') dt_inicio_isolamento, 
	to_date(substr(CASE WHEN obter_valor_param_usuario(44,187,obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento)='S' THEN  obter_precaucao_isolamento(o.nr_atendimento,'DF')  ELSE obter_dados_isolamento(o.nr_atendimento,'F') END ,1,21),'dd/mm/yyyy hh24:mi:ss') dt_fim_isolamento, 
	substr(CASE WHEN obter_valor_param_usuario(44,187,obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento)='S' THEN  obter_precaucao_isolamento(o.nr_atendimento,'QD')  ELSE obter_dados_isolamento(o.nr_atendimento,'D') END ,1,21) qt_dias_isolamento, 
	substr(	(select	max(pc.nr_sequencia) 
		FROM	cih_precaucao pc, 
			atendimento_precaucao p 
		where	p.nr_seq_precaucao = pc.nr_sequencia 
		and	p.nr_atendimento = o.nr_atendimento 
		and	LOCALTIMESTAMP between coalesce(dt_inicio,LOCALTIMESTAMP - interval '1 days') and coalesce(dt_termino,LOCALTIMESTAMP + interval '1 days') 
		and	dt_final_precaucao is null)	 
	,1,10) cd_precaucao, 
	substr(obter_desc_precaucao(o.nr_atendimento),1,255) ds_precaucao, 
	substr(obter_precaucao_isolamento(o.nr_atendimento,'CM'),1,10) cd_motivo_precaucao, 
	substr(obter_precaucao_isolamento(o.nr_atendimento,'MO'),1,255) ds_motivo_precaucao, 
	substr(obter_tipo_isolamento(coalesce(to_char(a.nr_seq_cih_tipo_isolamento),a.ie_tipo_isolamento),'CD'),1,10) cd_tipo_isolamento, 
	substr(obter_tipo_isolamento(coalesce(to_char(a.nr_seq_cih_tipo_isolamento),a.ie_tipo_isolamento),'DS'),1,255) ds_tipo_isolamento, 
	--nvl(substr(obter_tipos_isolamentos_cih(o.nr_atendimento,null),1,150), substr(obter_dados_isolamento(o.nr_atendimento,'C'),1,150)) cd_tipo_isolamento, 
	--nvl(substr(obter_tipos_isolamentos_cih(o.nr_atendimento,'D'),1,150), substr(obter_dados_isolamento(o.nr_atendimento,'DS'),1,150)) ds_tipo_isolamento, 
	substr(obter_status_isolamento_ocup(o.cd_estabelecimento, o.nr_atendimento, o.ie_acompanhante, wheb_usuario_pck.get_nm_usuario),1,1) ie_paciente_isolado, 
	1 nr 
FROM ocupacao_unidade_v o
LEFT OUTER JOIN motivo_isolamento_atend a ON (o.nr_atendimento = a.nr_atendimento)
WHERE 1 = 1;

