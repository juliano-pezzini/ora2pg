-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_analise_conta_item_v (ie_glosa, ds_tipo, cd_codigo, ds_glosa_ocorrencia, ds_proc_mat, ds_situacao, ds_glosa_vinc, ie_fechar_conta, ds_obs_glosa, nr_sequencia, ie_situacao, ie_status, ie_substituido, ie_tipo, nr_seq_analise, nr_seq_conta, nr_seq_conta_mat, nr_seq_conta_proc, nr_seq_glosa, nr_seq_glosa_oc, nr_seq_glosa_ref, nr_seq_ocorrencia, ie_ordem, ds_ordem, qt_glosa, vl_glosa, nr_seq_proc_partic, ds_pagamento, ds_faturamento) AS select	'' ie_glosa,
	null ds_tipo,
	null cd_codigo,
	case 	when coalesce(nr_seq_proc_partic,0) > 0 then 'PARTICIPANTE'
		when coalesce(nr_seq_conta_proc,0) > 0 then 'PROCEDIMENTO'
		when coalesce(nr_seq_conta_mat,0) > 0 then 'MATERIAL'
		else 'CONTA'
	end ds_glosa_ocorrencia,
	null ds_proc_mat,
	null ds_situacao,
	null ds_glosa_vinc,
	null ie_fechar_conta,
	null ds_obs_glosa,
	null nr_sequencia,
	null ie_situacao,
	null ie_status,
	null ie_substituido,
	null ie_tipo,
	nr_seq_analise,
	null nr_seq_conta,
	nr_seq_conta_mat,
	nr_seq_conta_proc,
	null nr_seq_glosa,
	null nr_seq_glosa_oc,
	null nr_seq_glosa_ref,
	null nr_seq_ocorrencia,
	1 ie_ordem,
	CASE WHEN coalesce(a.nr_seq_conta_proc,coalesce(coalesce(a.nr_seq_proc_partic,a.nr_seq_conta_mat),0))=0 THEN CASE WHEN coalesce(pls_obter_se_conta_sem_itens(null,a.nr_Seq_conta),0)=0 THEN 'CONTA'  ELSE 'ATENDIMENTO' END   ELSE 'PROC/MAT/PARTIC' END  ds_ordem,
	null qt_glosa,
	null vl_glosa,
	nr_seq_proc_partic,
	null ds_pagamento,
	null ds_faturamento
FROM	pls_analise_conta_item a
group by a.nr_seq_proc_partic, a.nr_seq_conta_proc, a.nr_seq_conta_mat, a.nr_seq_analise, a.nr_seq_conta

union

select	'' ie_glosa,
	substr(CASE WHEN a.ie_tipo='G' THEN 'Glosa'  ELSE 'Ocorrência' END ,1,25) ds_tipo,
	a.cd_codigo,
	substr(pls_obter_desc_glosa_oc(a.cd_codigo, a.ie_tipo), 1, 255) ds_glosa_ocorrencia,
	case when coalesce(a.nr_seq_proc_partic,0) > 0 then 'Participante'
	 when coalesce(a.nr_seq_conta_proc,0) > 0 then 'Procedimento'
	 when coalesce(a.nr_seq_conta_mat,0) > 0 then 'Material'
	 else 'Conta'
	end ds_proc_mat,
	substr(obter_valor_dominio(3892, a.ie_status),1,255) ds_situacao,
	substr(pls_obter_desc_glosa(nr_seq_glosa_ref),1,255) ds_glosa_vinc, --Deve ser a function pls_obter_desc_glosa que trta pela seq da PLS_CONTA_GLOSA, e não a tiss_obter_motivo_glosa que tratya pela sequencia da TISS_MOTIVO_GLOSA
	a.ie_fechar_conta,
	Ltrim(substr(substr(a.ds_obs_glosa_oc,1,255)||'  '||chr(13)||chr(10)||substr(pls_obter_obs_glosa(a.nr_seq_glosa_ref),1,255),1,255)) ds_obs_glosa,
	a.nr_sequencia,
	a.ie_situacao,
	a.ie_status,
	a.ie_substituido,
	a.ie_tipo,
	a.nr_seq_analise,
	a.nr_seq_conta,
	a.nr_seq_conta_mat,
	a.nr_seq_conta_proc,
	a.nr_seq_glosa,
	a.nr_seq_glosa_oc,
	a.nr_seq_glosa_ref,
	a.nr_seq_ocorrencia,
	2 ie_ordem,
	CASE WHEN coalesce(a.nr_seq_conta_proc,coalesce(coalesce(a.nr_seq_proc_partic,a.nr_seq_conta_mat),0))=0 THEN  CASE WHEN coalesce(pls_obter_se_conta_sem_itens(null,a.nr_Seq_conta),0)=0 THEN 'CONTA'  ELSE 'ATENDIMENTO' END   ELSE 'PROC/MAT/PARTIC' END  ds_ordem,
	a.qt_glosa,
	a.vl_glosa,
	a.nr_seq_proc_partic,
	CASE WHEN a.ie_tipo='G' THEN  'Impede' WHEN a.ie_tipo='O' THEN  CASE WHEN a.ie_tipo_glosa='P' THEN  'Impede' WHEN a.ie_tipo_glosa='A' THEN  'Impede'  ELSE 'Não impede' END  END  ds_pagamento,
	CASE WHEN a.ie_tipo='G' THEN  'Não impede' WHEN a.ie_tipo='O' THEN  CASE WHEN a.ie_tipo_glosa='F' THEN  'Impede' WHEN a.ie_tipo_glosa='A' THEN  'Impede'  ELSE 'Não impede' END  END  ds_faturamento
from	pls_analise_conta_item a;

