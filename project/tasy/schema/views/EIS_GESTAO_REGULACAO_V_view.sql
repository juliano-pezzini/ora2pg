-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_gestao_regulacao_v (nr_sequencia, nm_segurado, nm_prestador, nm_prestador_exec, ie_tipo_referencia, ds_tipo_guia, ds_estagio, ds_estagio_regulacao, ie_estagio_regulacao, dt_requisicao, nr_seq_segurado, ie_estagio, nr_seq_prestador_exec, cd_guia_principal, nr_seq_guia_principal, cd_usuario_plano, nm_operadora, nr_crm, nr_seq_prestador, cd_prestador, ds_tipo_referencia, cd_prestador_exec, cd_guia_ref, nr_seq_guia_ref, nr_seq_regulacao, nr_seq_prioridade, ie_integracao, ds_prioridade_reg, ie_tipo, ds_servico, cd_estabelecimento, ds_prestador, ds_prestador_municipio, ds_prestador_estabelecimento, ds_medico_req_ed, ds_prestador_executor, ds_executor_municipio, ds_executor_estabelecimento, ds_nivel_atencao, ds_procedimento, cd_procedimento, cd_material, ds_material, vl_total_procedimento, vl_total_material, vl_total_solicitacoes, ie_status_an, ie_status_at, ie_status_ng, ie_status_le, ie_status_ag, ie_status_fa, ie_status_ae, ie_status_fi, ie_status_ps, ie_regulacao_en, ie_tipo_regulacao, ie_nivel_atencao_p, dt_tempo_espera, qt_lista_espera, qt_cotas) AS SELECT	a.nr_sequencia,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado ,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255) nm_prestador,
		substr(pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N'),1,255) nm_prestador_exec,
		substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4) ie_tipo_referencia,
		(select	substr(x.ds_valor_dominio,1,255)
		FROM	VALOR_DOMINIO_V	x
		where	x.cd_dominio	= 1746
		and	x.vl_dominio	= a.ie_tipo_guia) ds_tipo_guia,
		(select	substr(x.ds_valor_dominio,1,255)
		from	VALOR_DOMINIO_V	x
		where	x.cd_dominio	= 3431
		and	x.vl_dominio	= a.ie_estagio) ds_estagio,
		(select	substr(x.ds_valor_dominio,1,255)
		from	VALOR_DOMINIO_V	x
		where	x.cd_dominio	= 8890
		and	x.vl_dominio	= a.IE_ESTAGIO_REGULACAO) DS_ESTAGIO_REGULACAO,
		a.IE_ESTAGIO_REGULACAO,
		coalesce(a.dt_requisicao,z.dt_atualizacao_nrec) dt_requisicao,
		a.nr_seq_segurado,
		a.ie_estagio,
		a.nr_seq_prestador_exec,
		a.cd_guia_principal,
		a.nr_seq_guia_principal,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,255) cd_usuario_plano,
		(select	substr(y.ds_razao_social,1,255)
		from	pessoa_juridica	y,
			pls_congenere	x
		where	x.cd_cgc	= y.cd_cgc
		and	x.nr_sequencia	= a.nr_seq_uni_exec) nm_operadora,
		(select	substr(x.nr_crm,1,255)
		from	medico	x
		where	x.cd_pessoa_fisica	=  a.cd_medico_solicitante) nr_crm,
		a.nr_seq_prestador,
		substr(pls_obter_dados_prestador(a.nr_seq_prestador,'CD'),1,255) cd_prestador,
		CASE WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='P' THEN 'Principal' WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='F' THEN 'Filha' END  ds_tipo_referencia,
		substr(pls_obter_dados_prestador(a.nr_seq_prestador_exec,'CD'),1,255) cd_prestador_exec,
		CASE WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='F' THEN cd_guia_principal WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='P' THEN (	select	max(b.cd_guia)														from	pls_guia_plano b,															pls_execucao_requisicao c														where	b.nr_sequencia = c.nr_seq_guia 														and	c.nr_seq_requisicao = a.nr_sequencia) END  cd_guia_ref,
		CASE WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='F' THEN nr_seq_guia_principal WHEN substr(pls_obter_se_req_vinculadas(a.nr_sequencia),1,4)='P' THEN (	select 	max(b.nr_sequencia) 														from	pls_guia_plano b,															pls_execucao_requisicao c														where	b.nr_sequencia = c.nr_seq_guia														and c.nr_seq_requisicao = a.nr_sequencia) END  nr_seq_guia_ref,
		z.nr_sequencia nr_seq_regulacao, 
    z.NR_SEQ_PRIORIDADE, 
    a.IE_INTEGRACAO, 
    substr(obter_desc_estagio_regulacao(a.NR_SEQ_PRIORIDADE),1,255) DS_PRIORIDADE_REG,
    coalesce(a.ie_tipo, z.ie_tipo) ie_tipo,
    OBTER_VALOR_DOMINIO( 8800, z.ie_tipo) DS_SERVICO,
    coalesce(a.cd_estabelecimento,OBTER_ESTAB_ATENDIMENTO(z.nr_atendimento)) cd_estabelecimento,
    substr(pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255) ds_prestador,
    substr(pls_obter_dados_prestador(a.nr_seq_prestador,'MA'),1,255) DS_PRESTADOR_MUNICIPIO,
    coalesce(substr(OBTER_NOME_ESTABELECIMENTO(pls_obter_dados_prestador(a.NR_SEQ_PRESTADOR,'E')),1,255),OBTER_NOME_ESTABELECIMENTO(OBTER_ESTAB_ATENDIMENTO(z.nr_atendimento))) DS_PRESTADOR_ESTABELECIMENTO, 
    coalesce(substr(obter_nome_pf(a.cd_medico_solicitante),1,255),obter_nome_usuario(z.nm_usuario)) DS_MEDICO_REQ_ED,
    substr(pls_obter_dados_prestador(a.NR_SEQ_PRESTADOR_EXEC,'N'),1,255) DS_PRESTADOR_executor,
    substr(pls_obter_dados_prestador(a.NR_SEQ_PRESTADOR_EXEC,'MA'),1,255) DS_EXECUTOR_MUNICIPIO,
    substr(OBTER_NOME_ESTABELECIMENTO(pls_obter_dados_prestador(a.NR_SEQ_PRESTADOR_EXEC,'E')),1,255) DS_EXECUTOR_ESTABELECIMENTO,
    OBTER_VALOR_DOMINIO( 8267, a.IE_NIVEL_ATENCAO) DS_NIVEL_ATENCAO,
    coalesce(Obter_Desc_Procedimento(x.cd_procedimento, x.ie_origem_proced),CASE WHEN(somente_numero(z.cd_procedimento_envio))=0 THEN obter_desc_procedimento(z.cd_procedimento,z.ie_origem_proced)  ELSE coalesce(obter_desc_procedimento(z.cd_procedimento_envio,z.ie_origem_proced),z.cd_procedimento_envio) END ) DS_PROCEDIMENTO,
	x.cd_procedimento cd_procedimento, 
	y.cd_material cd_material,
    coalesce(obter_desc_proc_material( y.nr_seq_material, null, null ),CASE WHEN(somente_numero(z.cd_material_envio))=0 THEN  trim(both obter_medicamento_regulacao(z.cd_material))  ELSE z.cd_material_envio END ) DS_MATERIAL,
    (x.VL_PROCEDIMENTO * x.QT_PROCEDIMENTO) VL_TOTAL_PROCEDIMENTO, 
    (y.VL_MATERIAL * y.QT_MATERIAL) VL_TOTAL_MATERIAL,
    (coalesce((x.VL_PROCEDIMENTO * x.QT_PROCEDIMENTO),0) + coalesce((y.VL_MATERIAL * y.QT_MATERIAL),0)) VL_TOTAL_SOLICITACOES,
    (select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'AN') IE_STATUS_AN,
    (select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'AT') IE_STATUS_AT,
    (select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'NG') IE_STATUS_NG,
    (select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'LE') IE_STATUS_LE,
    (select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'AG') IE_STATUS_AG,
	(select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'FA') IE_STATUS_FA,
	(select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'AE') IE_STATUS_AE,
	(select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'FI') IE_STATUS_FI,
	(select coalesce(max(1),0)
      from REGULACAO_STATUS b
      where b.nr_seq_regulacao_atend = z.nr_sequencia
      and   ie_status = 'PS') IE_STATUS_PS,	  
    (select coalesce(max(1),0)
      from regulacao_Atend b
      where b.nr_sequencia = z.nr_sequencia
      and   ie_tipo = 'EN') IE_REGULACAO_EN,
    (select ie_tipo
      from regulacao_Atend b
      where b.nr_sequencia = z.nr_sequencia) IE_TIPO_REGULACAO,
    (select coalesce(max(1),0)
      from  pls_requisicao b
      where  b.nr_sequencia = a.nr_sequencia
      and   b.IE_NIVEL_ATENCAO = 'P' ) IE_NIVEL_ATENCAO_P, -- 1838382
    (select  coalesce(max(DT_PERIODO_FINAL), LOCALTIMESTAMP) - (coalesce(max(DT_PERIODO_INICIAL), LOCALTIMESTAMP)) DT_TEMPO_ESPERA
      from    agenda_lista_espera b
      where   b.nr_seq_regulacao = z.nr_sequencia ) DT_TEMPO_ESPERA,
    (select  count(*)
        from  AGENDA_LISTA_ESPERA b
        where   b.nr_seq_regulacao = z.nr_sequencia
        and     a.DT_REQUISICAO  between b.DT_PERIODO_INICIAL and b.DT_PERIODO_FINAL ) QT_LISTA_ESPERA,
    (SELECT sum(QT_COTA_ATUAL) - sum(QT_COTA_BLOQUEADA) qt_cotas
      FROM	AGENDA_INTEGRADA_CONTRATO b
      WHERE b.IE_TIPO = a.ie_tipo
        AND a.DT_REQUISICAO  between b.DT_PERIODO_INICIAL and b.DT_PERIODO_FINAL ) QT_COTAS
FROM pls_requisicao a
LEFT OUTER JOIN pls_requisicao_proc x ON (a.nr_sequencia = x.nr_seq_requisicao)
LEFT OUTER JOIN pls_requisicao_mat y ON (a.nr_sequencia = y.nr_seq_requisicao)
, regulacao_atend z
LEFT OUTER JOIN pls_requisicao a ON (z.nr_sequencia = a.nr_seq_regulacao)
WHERE (a.nr_seq_regulacao is not null or z.ie_status = 'AE');

