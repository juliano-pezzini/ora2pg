-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW admissao_hospitalar_ps_v (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, cd_motivo_alta, ie_permite_visita, ie_permite_visita_rel, ie_clinica, ie_clinica_ant, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_tipo_acomod_unid, cd_convenio, cd_categoria, cd_usuario_convenio, cd_empresa, cd_tipo_acomod_conv, nr_doc_convenio, ds_setor_atendimento, ds_convenio, ds_categoria, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, ie_carater_inter_sus, nr_seq_indicacao, nr_seq_interno, cd_estabelecimento, nr_seq_tipo_acidente, dt_atend_original, dt_cancelamento, dt_atend_medico, dt_saida_real, nm_usuario_saida, ds_nivel_urgencia, nr_seq_triagem_prioridade) AS SELECT A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
       A.DT_ENTRADA,
       A.CD_PESSOA_FISICA,
       A.CD_PROCEDENCIA,
       A.IE_TIPO_ATENDIMENTO,
       A.CD_MEDICO_RESP,
       A.DT_ALTA,
       A.CD_MOTIVO_ALTA,
	A.IE_PERMITE_VISITA,
	A.IE_PERMITE_VISITA_REL,
	A.IE_CLINICA,
	A.IE_CLINICA_ANT,
	A.NR_SEQ_CLASSIFICACAO,
       B.DT_ENTRADA_UNIDADE,
       B.DT_SAIDA_UNIDADE,
       B.CD_SETOR_ATENDIMENTO,
       B.CD_UNIDADE_BASICA,
       B.CD_UNIDADE_COMPL,
       B.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_UNID,
       C.CD_CONVENIO,
       C.CD_CATEGORIA,
       C.CD_USUARIO_CONVENIO,
       C.CD_EMPRESA,
       C.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_CONV,
       C.NR_DOC_CONVENIO,
       S.DS_SETOR_ATENDIMENTO,
       V.DS_CONVENIO,
       T.DS_CATEGORIA,
       M.NM_PESSOA_FISICA NM_MEDICO,
       P.NM_PESSOA_FISICA NM_PACIENTE,
       P.NR_PRONTUARIO,
       P.DT_NASCIMENTO,
       P.CD_RELIGIAO,
	A.IE_CARATER_INTER_SUS,
	A.nr_seq_indicacao,
	C.NR_SEQ_INTERNO,
	A.CD_ESTABELECIMENTO,
	A.NR_SEQ_TIPO_ACIDENTE,
	A.DT_ATEND_ORIGINAL,
	A.DT_CANCELAMENTO,
	A.DT_ATEND_MEDICO,
	A.DT_SAIDA_REAL,
	A.NM_USUARIO_SAIDA,
	substr(coalesce(obter_nivel_urgencia(A.nr_atendimento),obter_desc_expressao(309956)),1,100) ds_nivel_urgencia,
	A.nr_seq_triagem_prioridade
FROM   CONVENIO V,
       CATEGORIA_CONVENIO T,
       SETOR_ATENDIMENTO S,
       PESSOA_FISICA M,
       PESSOA_FISICA P,
       ATEND_PACIENTE_UNIDADE B,
       ATEND_CATEGORIA_CONVENIO C,
       ATENDIMENTO_PACIENTE A
WHERE (A.NR_ATENDIMENTO = B.NR_ATENDIMENTO)
  AND (A.NR_ATENDIMENTO = C.NR_ATENDIMENTO)
  AND (C.DT_INICIO_VIGENCIA =
      (SELECT MIN(W.DT_INICIO_VIGENCIA) DT_PRIMEIRA_VIGENCIA
       FROM   ATEND_CATEGORIA_CONVENIO W
       WHERE  W.NR_ATENDIMENTO = A.NR_ATENDIMENTO) )
  AND (B.DT_ENTRADA_UNIDADE =
      (SELECT MIN(W.DT_ENTRADA_UNIDADE)
       FROM   SETOR_ATENDIMENTO X,
		ATEND_PACIENTE_UNIDADE W
       WHERE W.NR_ATENDIMENTO = A.NR_ATENDIMENTO
	  AND W.CD_SETOR_ATENDIMENTO = X.CD_SETOR_ATENDIMENTO
	  AND X.CD_CLASSIF_SETOR = 1) )
  AND (S.CD_CLASSIF_SETOR      = 1)
  AND (B.CD_SETOR_ATENDIMENTO  = S.CD_SETOR_ATENDIMENTO)
  AND (C.CD_CONVENIO           = V.CD_CONVENIO)
  and (A.CD_MEDICO_RESP        = M.CD_PESSOA_FISICA)
  AND (A.CD_PESSOA_FISICA      = P.CD_PESSOA_FISICA)
  AND (C.CD_CONVENIO           = T.CD_CONVENIO)
  AND (C.CD_CATEGORIA          = T.CD_CATEGORIA);

