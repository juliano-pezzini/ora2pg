-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW queue_data_v (cd_estabelecimento, seq_fila, day, open_time, close_time, hour, emitted_tickets, weekday, is_open_now) AS SELECT	b.cd_estabelecimento,
	a.nr_seq_fila_espera_senha seq_fila,
	b.ie_dia_semana day,
	to_char(b.dt_horario_inicial, 'HH24MI') open_time,
	to_char(b.dt_horario_final, 'HH24MI') close_time,
	to_char(d.dt_geracao_senha, 'HH24') || ':00' hour,
	count(d.cd_senha_gerada) emitted_tickets,
	obter_descricao_dominio(3118, b.ie_dia_semana) || ': ' || to_char(b.dt_horario_inicial, 'HH24:MI') || '-' || to_char(b.dt_horario_final, 'HH24:MI') weekday,
	(CASE WHEN pkg_date_utils.get_weekday(LOCALTIMESTAMP) =  b.ie_dia_semana THEN (CASE WHEN b.dt_horario_inicial IS NOT NULL THEN (CASE WHEN b.dt_horario_final IS NOT NULL THEN (CASE WHEN(to_char(LOCALTIMESTAMP, 'HH24MI') between to_char(b.dt_horario_inicial, 'HH24MI')
			    AND to_char(b.dt_horario_final, 'HH24MI')) THEN 'true'
			ELSE 'false' END)
		     ELSE 'true' end)
		ELSE 'true' end)
	ELSE 'false' end)
	is_open_now
FROM	turno_senha_config a,
	turno_senha b,
	fila_espera_senha c,
	paciente_senha_fila d
WHERE 	a.nr_seq_turno_senha = b.nr_sequencia
AND	a.nr_seq_fila_espera_senha = c.nr_sequencia
AND	d.nr_seq_fila_senha = c.nr_sequencia
AND	pkg_date_utils.get_weekday(d.dt_geracao_senha) = b.ie_dia_semana
GROUP BY	a.nr_seq_fila_espera_senha , b.ie_dia_semana,  to_char(b.dt_horario_inicial, 'HH24MI'),
		to_char(b.dt_horario_final, 'HH24MI'),
		obter_descricao_dominio(3118, b.ie_dia_semana) || ': ' || to_char(b.dt_horario_inicial, 'HH24:MI') || '-' || to_char(b.dt_horario_final, 'HH24:MI'),
		pkg_date_utils.extract_field('HOUR', d.dt_geracao_senha), to_char(d.dt_geracao_senha, 'HH24'),
		b.cd_estabelecimento,
		b.dt_horario_inicial,
		b.dt_horario_final
ORDER BY	day, hour;

