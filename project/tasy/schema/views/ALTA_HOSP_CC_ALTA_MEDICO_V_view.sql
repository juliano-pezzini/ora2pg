-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW alta_hosp_cc_alta_medico_v (nr_atendimento, nr_atend_original, dt_alta, cd_motivo_alta, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_entrada, ie_permite_visita, ie_clinica, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_unidade, cd_tipo_acomod_unid, cd_convenio, cd_categoria, cd_usuario_convenio, cd_empresa, cd_tipo_acomod_conv, nr_doc_convenio, ds_setor_atendimento, ds_convenio, ds_categoria, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, dt_fim_conta, cd_estabelecimento, ds_motivo_alta, dt_alta_interno, nr_seq_interno, hr_alta, dt_saida_real, ie_carater_inter_sus, nr_seq_indicacao, ds_obs_alta, ie_paciente_isolado, nr_seq_tipo_acidente, dt_entrada_real, nm_usuario_saida, cd_classif_setor, dt_impressao_alta, nr_seq_agrupamento, nr_seq_classif_medico, dt_alta_medico, dt_alta_tesouraria, nr_seq_motivo_perm, nm_usuario_alta_medica, dt_alta_medico_setor, nr_episodio) AS SELECT  A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
	A.DT_ALTA,
	A.CD_MOTIVO_ALTA,
	A.CD_PESSOA_FISICA,
	A.CD_PROCEDENCIA,
	A.IE_TIPO_ATENDIMENTO,
	A.CD_MEDICO_RESP,
	A.DT_ENTRADA,
	A.IE_PERMITE_VISITA,
	A.IE_CLINICA,
	A.NR_SEQ_CLASSIFICACAO,
	B.DT_ENTRADA_UNIDADE,
	B.DT_SAIDA_UNIDADE,
	B.CD_SETOR_ATENDIMENTO,
	B.CD_UNIDADE_BASICA,
	B.CD_UNIDADE_COMPL,
	B.CD_UNIDADE_BASICA || ' ' ||B.CD_UNIDADE_COMPL  cd_unidade,
	B.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_UNID,
	C.CD_CONVENIO,
	C.CD_CATEGORIA,
	C.CD_USUARIO_CONVENIO,
	C.CD_EMPRESA,
	C.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_CONV,
	C.NR_DOC_CONVENIO,
	substr(obter_nome_setor(B.cd_setor_atendimento),1,100) DS_SETOR_ATENDIMENTO,
	substr(obter_nome_convenio(C.cd_convenio),1,60) DS_CONVENIO,
	T.DS_CATEGORIA,
	substr(obter_nome_pf(A.CD_MEDICO_RESP),1,100) NM_MEDICO,
	P.NM_PESSOA_FISICA NM_PACIENTE,
	P.NR_PRONTUARIO,
	P.DT_NASCIMENTO,
	P.CD_RELIGIAO,
	A.DT_FIM_CONTA,
	A.CD_ESTABELECIMENTO,
	substr(obter_desc_motivo_alta(A.CD_MOTIVO_ALTA),1,100) DS_MOTIVO_ALTA,
	A.DT_ALTA_INTERNO,
	B.NR_SEQ_INTERNO,
	To_Char(dt_alta,'hh24') hr_alta,
	dt_saida_real,
	A.IE_CARATER_INTER_SUS,
	A.nr_seq_indicacao,
	A.ds_obs_alta,
	A.ie_paciente_isolado,
	A.NR_SEQ_TIPO_ACIDENTE,
	B.dt_entrada_real,
	A.nm_usuario_saida,
	obter_classif_setor(B.cd_setor_Atendimento) cd_classif_setor,
	A.dt_impressao_alta,
	obter_agrupamento_setor(B.cd_setor_Atendimento) nr_seq_agrupamento,
	A.nr_seq_classif_medico,
	A.dt_alta_medico,
	A.dt_alta_tesouraria,
	B.nr_seq_motivo_perm,
	A.nm_usuario_alta_medica,
	B.dt_alta_medico_setor,
	substr(OBTER_EPISODIO_ATEND_TELA(A.nr_atendimento),1,80) nr_episodio
FROM	PESSOA_FISICA P,
	CATEGORIA_CONVENIO T,
	ATEND_PACIENTE_UNIDADE B,
	ATEND_CATEGORIA_CONVENIO C,
	ATENDIMENTO_PACIENTE A
WHERE (A.DT_ALTA IS NOT NULL or A.dt_alta_medico is not null or B.dt_alta_medico_setor is not null)
  AND (A.NR_ATENDIMENTO 	= B.NR_ATENDIMENTO)
  AND (A.NR_ATENDIMENTO 	= C.NR_ATENDIMENTO)
  and (B.nr_seq_interno		= obter_Atepacu_Paciente(A.nr_atendimento,'IAC'))
  AND (C.nr_seq_interno		= obter_atecaco_atendimento(A.nr_atendimento))
  AND (A.CD_PESSOA_FISICA      = P.CD_PESSOA_FISICA)
  AND (C.CD_CONVENIO           = T.CD_CONVENIO)
  AND (C.CD_CATEGORIA          = T.CD_CATEGORIA)

union all

SELECT  A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
	A.DT_ALTA,
	A.CD_MOTIVO_ALTA,
	A.CD_PESSOA_FISICA,
	A.CD_PROCEDENCIA,
	A.IE_TIPO_ATENDIMENTO,
	A.CD_MEDICO_RESP,
	A.DT_ENTRADA,
	A.IE_PERMITE_VISITA,
	A.IE_CLINICA,
	A.NR_SEQ_CLASSIFICACAO,
	B.DT_ENTRADA_UNIDADE,
	B.DT_SAIDA_UNIDADE,
	B.CD_SETOR_ATENDIMENTO,
	B.CD_UNIDADE_BASICA,
	B.CD_UNIDADE_COMPL,
	B.CD_UNIDADE_BASICA || ' ' ||B.CD_UNIDADE_COMPL  cd_unidade,
	B.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_UNID,
	0 CD_CONVENIO,
	'' CD_CATEGORIA,
	'' CD_USUARIO_CONVENIO,
	0 CD_EMPRESA,
	0 CD_TIPO_ACOMOD_CONV,
	'' NR_DOC_CONVENIO,
	substr(obter_nome_setor(B.cd_setor_atendimento),1,100) DS_SETOR_ATENDIMENTO,
	'' DS_CONVENIO,
	'' DS_CATEGORIA,
	substr(obter_nome_pf(A.CD_MEDICO_RESP),1,100) NM_MEDICO,
	P.NM_PESSOA_FISICA NM_PACIENTE,
	P.NR_PRONTUARIO,
	P.DT_NASCIMENTO,
	P.CD_RELIGIAO,
	A.DT_FIM_CONTA,
	A.CD_ESTABELECIMENTO,
	substr(obter_desc_motivo_alta(A.CD_MOTIVO_ALTA),1,100) DS_MOTIVO_ALTA,
	A.DT_ALTA_INTERNO,
	B.NR_SEQ_INTERNO,
	To_Char(dt_alta,'hh24') hr_alta,
	dt_saida_real,
	A.IE_CARATER_INTER_SUS,
	A.nr_seq_indicacao,
	A.ds_obs_alta,
	A.ie_paciente_isolado,
	A.NR_SEQ_TIPO_ACIDENTE,
	B.dt_entrada_real,
	A.nm_usuario_saida,
	obter_classif_setor(B.cd_setor_Atendimento) cd_classif_setor,
	A.dt_impressao_alta,
	obter_agrupamento_setor(B.cd_setor_Atendimento) nr_seq_agrupamento,
	A.nr_seq_classif_medico,
	A.dt_alta_medico,
	A.dt_alta_tesouraria,
	B.nr_seq_motivo_perm,
	A.nm_usuario_alta_medica,
	B.dt_alta_medico_setor,
	substr(OBTER_EPISODIO_ATEND_TELA(A.nr_atendimento),1,80) nr_episodio
FROM	PESSOA_FISICA P,
	ATEND_PACIENTE_UNIDADE B,
	ATENDIMENTO_PACIENTE A
WHERE (A.DT_ALTA IS NOT NULL or A.dt_alta_medico is not null or B.dt_alta_medico_setor is not null)
  AND (A.NR_ATENDIMENTO 	= B.NR_ATENDIMENTO)
  and (B.nr_seq_interno		= obter_Atepacu_Paciente(A.nr_atendimento,'IAC'))
  AND (A.CD_PESSOA_FISICA      = P.CD_PESSOA_FISICA)
  and not exists (select 1
		 from 	 atend_categoria_convenio x
		 where   x.nr_atendimento = A.nr_atendimento);

