-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_hbo_v (tp_registro, nr_seq_protocolo, cd_prestador, nr_seq_lote, nr_interno_conta, cd_serie_documento, dt_geracao, nr_documento, cd_unid_carteira, nr_carteira, dt_referencia, cd_motivo_alta, cd_cid, dt_entrada, dt_alta, dt_ano_guia, nr_guia, cd_classe_nota, cd_acomodacao, nm_beneficiario, ie_sexo, dt_nascimento, dt_validade_carteira, cd_setor_atendimento, cd_procedimento, qt_procedimento_autor, dt_procedimento, ie_urgencia, ie_adicional_urgencia, qt_procedimento, vl_procedimento, ie_tipo_nascimento, nr_seq_autorizacao, ie_tipo_percentual, ie_tipo_insumo, cd_insumo, qt_insumo, dt_insumo, qt_cobrada, vl_cobrado, cd_pacote, dt_emissao, qt_reg_nota, qt_reg_doc, qt_reg_proc, qt_reg_insumo, vl_total_lote, nr_seq_pacote) AS select	1 				tp_registro,
	c.nr_seq_protocolo, 
	00101146 			cd_prestador, 
	(c.nr_seq_doc_convenio)::numeric  nr_seq_lote, 
	0				nr_interno_conta, 
	0				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' '	 			ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0		 		ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0		 		qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
	0	 			qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
FROM	protocolo_convenio c 

union
 
select	2	 			tp_registro, 
	c.nr_seq_protocolo, 
	00101146		 	cd_prestador, 
	0 				nr_seq_lote, 
	0				nr_interno_conta, 
	0				cd_serie_documento, 
	LOCALTIMESTAMP	 		dt_geracao, 
	' ' 				nr_documento, 
	'0'	 			cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0	 			cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP	 		dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0		 		nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 
	' '	 			nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0	 			qt_procedimento, 
	0		 		vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0		 		ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0	 			qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0	 			qt_cobrada, 
	0		 		vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0		 		qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0	 			qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
from	protocolo_convenio c 

union
 
/*Dados conta sem pacote autorizacao_convenio*/
 
select	3	 			tp_registro, 
	c.nr_seq_protocolo, 
	somente_numero(coalesce(substr(obter_medico_convenio(c.cd_estabelecimento,a.cd_medico_resp,c.cd_convenio, null,null, null, null, null, a.ie_tipo_atendimento, null, null),1,15),'00050001'))	cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta, 
	1				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(somente_numero(t.cd_autorizacao)) nr_documento, 
	substr(n.cd_usuario_convenio,1,4) cd_unid_carteira, 
	substr(n.cd_usuario_convenio,5,14) nr_carteira, 
	b.dt_periodo_inicial 	dt_referencia, 
	a.cd_motivo_alta, 
	to_char(coalesce(substr(OBTER_CID_ATENDIMENTO(a.NR_ATENDIMENTO,'P'),1,10),'0000')) cd_cid, 
	a.dt_entrada			dt_entrada, 
	a.dt_alta			dt_alta, 
	CASE WHEN n.ie_tipo_guia='E' THEN null WHEN n.ie_tipo_guia='C' THEN null WHEN n.ie_tipo_guia='A' THEN  null  ELSE to_char(trunc(b.dt_periodo_inicial,'year'),'yyyy') END  dt_ano_guia, 
	CASE WHEN n.ie_tipo_guia='E' THEN 00000000 WHEN n.ie_tipo_guia='A' THEN 00000000  ELSE somente_numero(t.cd_autorizacao) END  nr_guia, 
	CASE WHEN substr(obter_se_conta_pacote(b.nr_interno_conta),1,1)='S' THEN CASE WHEN n.ie_tipo_guia='I' THEN '05'  ELSE '03' END   ELSE CASE WHEN n.ie_tipo_guia='E' THEN '02' WHEN n.ie_tipo_guia='IC' THEN '04' WHEN n.ie_tipo_guia='I' THEN '05' WHEN n.ie_tipo_guia='A' THEN '08' WHEN n.ie_tipo_guia='AI' THEN '03'  ELSE '08' END  END  cd_classe_nota, 
	n.cd_tipo_acomodacao		cd_acomodacao,	 
	p.nm_pessoa_fisica 		nm_beneficiario, 
	p.ie_sexo, 
	p.dt_nascimento, 
	n.dt_validade_carteira, 
	coalesce(obter_setor_atendimento(a.nr_atendimento),0) cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' '	 			ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_referencia, 
 	0 				qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
from	pessoa_fisica p, 
	atend_categoria_convenio n, 
	autorizacao_convenio t, 
	conta_paciente b, 
	atendimento_paciente a, 
	procedimento_paciente d, 
	procedimento_autorizado u, 
	protocolo_convenio c 
where	a.nr_atendimento	= b.nr_atendimento 
and	n.nr_atendimento	= b.nr_atendimento 
and	a.nr_atendimento	= t.nr_atendimento 
and	d.cd_motivo_exc_conta is null 
and	c.nr_seq_protocolo	= b.nr_seq_protocolo 
and	n.cd_convenio		= c.cd_convenio 
and	a.nr_atendimento	= u.nr_atendimento 
and	u.ie_origem_proced	= d.ie_origem_proced 
and	u.cd_procedimento	= d.cd_procedimento 
and	a.cd_pessoa_fisica	= p.cd_pessoa_fisica 
and	d.nr_interno_conta	= b.nr_interno_conta 
and	n.dt_inicio_vigencia	= (	select	max(x.dt_inicio_vigencia) 
					from	atend_categoria_convenio x 
					where	n.cd_convenio  = x.cd_convenio 
					and	n.nr_atendimento= x.nr_atendimento) 
and	t.cd_autorizacao is not null 
and	d.nr_seq_proc_pacote is null 

union
 
/*Dados conta sem pacote atend_categoria_convenio*/
 
select	3	 			tp_registro, 
	c.nr_seq_protocolo, 
	somente_numero(coalesce(substr(obter_medico_convenio(c.cd_estabelecimento,a.cd_medico_resp,c.cd_convenio, null,null, null, null, null, a.ie_tipo_atendimento, null, null),1,15),'00050001'))	cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta, 
	1				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(CASE WHEN coalesce(somente_numero(n.nr_doc_convenio),0)=0 THEN a.nr_atendimento  ELSE somente_numero(n.nr_doc_convenio) END ) nr_documento, 
	substr(n.cd_usuario_convenio,1,4) cd_unid_carteira, 
	substr(n.cd_usuario_convenio,5,14) nr_carteira, 
	b.dt_periodo_inicial 	dt_referencia, 
	a.cd_motivo_alta, 
	to_char(coalesce(substr(OBTER_CID_ATENDIMENTO(a.NR_ATENDIMENTO,'P'),1,10),'0000')) cd_cid, 
	a.dt_entrada			dt_entrada, 
	a.dt_alta			dt_alta, 
	CASE WHEN n.ie_tipo_guia='E' THEN null WHEN n.ie_tipo_guia='C' THEN null WHEN n.ie_tipo_guia='A' THEN  null  ELSE to_char(trunc(b.dt_periodo_inicial,'year'),'yyyy') END  dt_ano_guia, 
	CASE WHEN substr(obter_se_conta_pacote(b.nr_interno_conta),1,1)='S' THEN somente_numero(n.nr_doc_convenio)  ELSE to_char(CASE WHEN n.ie_tipo_guia='E' THEN 00000000 WHEN n.ie_tipo_guia='A' THEN 00000000  ELSE CASE WHEN coalesce(somente_numero(n.nr_doc_convenio),0)=0 THEN a.nr_atendimento  ELSE somente_numero(n.nr_doc_convenio) END  END ) END  nr_guia, 
	CASE WHEN substr(obter_se_conta_pacote(b.nr_interno_conta),1,1)='S' THEN CASE WHEN n.ie_tipo_guia='I' THEN '05'  ELSE '03' END   ELSE CASE WHEN n.ie_tipo_guia='E' THEN '02' WHEN n.ie_tipo_guia='IC' THEN '04' WHEN n.ie_tipo_guia='I' THEN '05' WHEN n.ie_tipo_guia='A' THEN '08' WHEN n.ie_tipo_guia='AI' THEN '03'  ELSE '08' END  END  cd_classe_nota, 
	n.cd_tipo_acomodacao		cd_acomodacao,	 
	p.nm_pessoa_fisica 		nm_beneficiario, 
	p.ie_sexo, 
	p.dt_nascimento, 
	n.dt_validade_carteira, 
	coalesce(obter_setor_atendimento(a.nr_atendimento),0) cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' '	 			ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_referencia, 
 	0 				qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
from	pessoa_fisica p, 
	atend_categoria_convenio n, 
	conta_paciente b, 
	atendimento_paciente a, 
	procedimento_paciente d, 
	protocolo_convenio c 
where	a.nr_atendimento	= b.nr_atendimento 
and	n.nr_atendimento	= b.nr_atendimento 
and	c.nr_seq_protocolo	= b.nr_seq_protocolo 
and	n.cd_convenio		= c.cd_convenio 
and	d.cd_motivo_exc_conta is null 
and	a.cd_pessoa_fisica	= p.cd_pessoa_fisica 
and	d.nr_interno_conta	= b.nr_interno_conta 
and	n.dt_inicio_vigencia	= (	select	max(x.dt_inicio_vigencia) 
					from	atend_categoria_convenio x 
					where	n.cd_convenio  = x.cd_convenio 
					and	n.nr_atendimento= x.nr_atendimento) 
and	d.nr_seq_proc_pacote is null 

union
 
/*Dados conta com pacote autorizacao_convenio*/
 
select	distinct 
	3	 			tp_registro, 
	c.nr_seq_protocolo, 
	somente_numero(coalesce(substr(obter_medico_convenio(c.cd_estabelecimento,a.cd_medico_resp,c.cd_convenio, null,null, null, null, null, a.ie_tipo_atendimento, null, null),1,15),'00050001')) cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta, 
	1				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20))=0 THEN  		somente_numero(d.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20)) END ) nr_documento, 
	substr(n.cd_usuario_convenio,1,4) cd_unid_carteira, 
	substr(n.cd_usuario_convenio,5,14) nr_carteira, 
	b.dt_periodo_inicial 	dt_referencia, 
	a.cd_motivo_alta, 
	to_char(coalesce(substr(OBTER_CID_ATENDIMENTO(a.NR_ATENDIMENTO,'P'),1,10),'0000')) cd_cid, 
	a.dt_entrada			dt_entrada, 
	a.dt_alta			dt_alta, 
	CASE WHEN n.ie_tipo_guia='E' THEN null WHEN n.ie_tipo_guia='C' THEN null WHEN n.ie_tipo_guia='A' THEN  null  ELSE to_char(trunc(b.dt_periodo_inicial,'year'),'yyyy') END  dt_ano_guia, 
	CASE WHEN n.ie_tipo_guia='E' THEN 00000000 WHEN n.ie_tipo_guia='A' THEN 00000000  ELSE CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20))=0 THEN somente_numero(d.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20)) END  END  nr_guia, 
	CASE WHEN substr(obter_se_conta_pacote(b.nr_interno_conta),1,1)='S' THEN CASE WHEN n.ie_tipo_guia='I' THEN '05'  ELSE '03' END   ELSE CASE WHEN n.ie_tipo_guia='E' THEN '02' WHEN n.ie_tipo_guia='IC' THEN '04' WHEN n.ie_tipo_guia='I' THEN '05' WHEN n.ie_tipo_guia='A' THEN '08' WHEN n.ie_tipo_guia='AI' THEN '03'  ELSE '08' END  END  cd_classe_nota, 
	n.cd_tipo_acomodacao		cd_acomodacao,	 
	p.nm_pessoa_fisica		nm_beneficiario, 
	p.ie_sexo, 
	p.dt_nascimento, 
	n.dt_validade_carteira, 
	coalesce(obter_setor_atendimento(a.nr_atendimento),0) cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' '	 			ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_referencia, 
 	0 				qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	d.nr_sequencia		nr_seq_pacote 
from	pessoa_fisica p, 
	conta_paciente b, 
	atend_categoria_convenio n, 
	atendimento_paciente a, 
	procedimento_paciente d, 
	protocolo_convenio c 
where	a.nr_atendimento	= b.nr_atendimento 
and	n.nr_atendimento	= b.nr_atendimento 
and	c.nr_seq_protocolo	= b.nr_seq_protocolo 
and	n.cd_convenio		= c.cd_convenio 
and	a.cd_pessoa_fisica	= p.cd_pessoa_fisica 
and (d.nr_seq_proc_pacote	= d.nr_sequencia) 
and	d.cd_motivo_exc_conta is null 
and	d.nr_interno_conta	= b.nr_interno_conta 
and	n.dt_inicio_vigencia	= (	select	max(x.dt_inicio_vigencia) 
					from	atend_categoria_convenio x 
					where	n.cd_convenio  = x.cd_convenio 
					and	n.nr_atendimento= x.nr_atendimento) 

union
 
/*Procedimentos*/
 
select	4	 			tp_registro, 
	c.nr_seq_protocolo, 
	00101146			cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta,	 
	0				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(CASE WHEN CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20))=0 THEN  		somente_numero(p.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20)) END =0 THEN a.nr_atendimento  ELSE CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20))=0 THEN  			somente_numero(p.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20)) END  END ) nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			Dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	coalesce(p.cd_procedimento_convenio,to_char(p.cd_procedimento)) cd_procedimento, 
	p.qt_procedimento 		qt_procedimento_autor, 
	p.dt_procedimento, 
	CASE WHEN a.ie_carater_inter_sus=20 THEN 'S' WHEN a.ie_carater_inter_sus=5 THEN 'S'  ELSE 'N' END 	ie_urgencia, 
	'N' 				ie_adicional_urgencia, 
	p.qt_procedimento, 
	p.vl_procedimento, 
	b.ie_tipo_nascimento, 
	p.nr_seq_autorizacao, 
	CASE WHEN p.tx_procedimento=50 THEN 1 WHEN p.tx_procedimento=20 THEN 2 WHEN p.tx_procedimento=40 THEN 4 WHEN p.tx_procedimento=100 THEN 05  ELSE 00 END  ie_tipo_percentual, 
	' ' 				ie_tipo_insumo, 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,			 
 	0 				qt_reg_doc, 
 	0	 			qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
FROM procedimento j, protocolo_convenio c, conta_paciente b, atendimento_paciente a, procedimento_paciente p
LEFT OUTER JOIN proc_paciente_convenio z ON (p.nr_sequencia = z.nr_seq_procedimento)
WHERE b.nr_atendimento	= p.nr_atendimento and c.nr_seq_protocolo	= b.nr_seq_protocolo and b.nr_interno_conta	= p.nr_interno_conta and a.nr_atendimento	= p.nr_atendimento  and a.nr_atendimento	= b.nr_atendimento and j.cd_procedimento	= p.cd_procedimento and p.cd_motivo_exc_conta is null and j.ie_origem_proced	= p.ie_origem_proced and p.NR_SEQ_PROC_PACOTE	is null and p.cd_procedimento not in (3) and coalesce(z.cd_grupo,0) not in (10,11,12,20) 
 
union
 
/*Taxas e diarias*/
 
select	5	 			tp_registro, 
	c.nr_seq_protocolo, 
	00101146			cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta,	 
	0				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(CASE WHEN CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20))=0 THEN  		somente_numero(p.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20)) END =0 THEN a.nr_atendimento  ELSE CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20))=0 THEN  			somente_numero(p.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,p.cd_procedimento,p.ie_origem_proced,null),1,20)) END  END ) nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			Dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0		 		qt_procedimento_autor, 
	LOCALTIMESTAMP			dt_procedimento, 
	' '				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0				qt_procedimento, 
	0 				vl_procedimento, 
	' '				ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0				ie_tipo_percentual, 
	CASE WHEN p.cd_procedimento='3' THEN '10'  ELSE z.cd_grupo END  ie_tipo_insumo, 
	p.cd_procedimento_convenio	cd_insumo, 
	p.qt_procedimento		qt_insumo, 
	p.dt_procedimento		dt_insumo, 
	p.qt_procedimento		qt_cobrada, 
	p.vl_procedimento		vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,			 
 	0 				qt_reg_doc, 
 	0	 			qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
FROM procedimento j, protocolo_convenio c, conta_paciente b, atendimento_paciente a, procedimento_paciente p
LEFT OUTER JOIN proc_paciente_convenio z ON (p.nr_sequencia = z.nr_seq_procedimento)
WHERE b.nr_atendimento	= p.nr_atendimento and c.nr_seq_protocolo	= b.nr_seq_protocolo and b.nr_interno_conta	= p.nr_interno_conta and a.nr_atendimento	= p.nr_atendimento  and a.nr_atendimento	= b.nr_atendimento and j.cd_procedimento	= p.cd_procedimento and p.cd_motivo_exc_conta is null and j.ie_origem_proced	= p.ie_origem_proced and (coalesce(z.cd_grupo,0) in (10,11,12,20) or (p.cd_procedimento in (3))) and p.NR_SEQ_PROC_PACOTE 	is null 
 
union
 
/*Insumos*/
 
select	5				tp_registro, 
	c.nr_seq_protocolo, 
	00101146			cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta, 
	0				cd_serie_documento, 
	LOCALTIMESTAMP	 		dt_geracao, 
	to_char(CASE WHEN CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(b.nr_atendimento,null,null,j.cd_material),1,20))=0 THEN  		somente_numero(j.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(b.nr_atendimento,null,null,j.cd_material),1,20)) END =0 THEN b.nr_atendimento  ELSE CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(b.nr_atendimento,null,null,j.cd_material),1,20))=0 THEN  			somente_numero(j.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(b.nr_atendimento,null,null,j.cd_material),1,20)) END  END ) nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP	 		dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 	 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	z.cd_grupo			ie_tipo_insumo,		 
	j.cd_material_convenio	cd_insumo, 
	j.qt_material 		qt_insumo, 
	j.dt_conta 			dt_insumo, 
	j.qt_material 		qt_cobrada, 
	j.vl_material 		vl_cobrado, 
	0	 			cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,	 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote 
FROM material m, protocolo_convenio c, conta_paciente b, atendimento_paciente a, material_atend_paciente j
LEFT OUTER JOIN mat_atend_pac_convenio z ON (j.nr_sequencia = z.nr_seq_material)
WHERE j.nr_atendimento	= b.nr_atendimento and c.nr_seq_protocolo	= b.nr_seq_protocolo and a.nr_atendimento	= b.nr_atendimento and j.cd_motivo_exc_conta is null and j.nr_interno_conta	= b.nr_interno_conta and j.cd_material		= m.cd_material  and j.nr_seq_proc_pacote	is null 
 
union
 
select	6 				tp_registro, 
	c.nr_seq_protocolo, 
	00101146			cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta, 
	0				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	to_char(CASE WHEN somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20))=0 THEN  		somente_numero(d.nr_doc_convenio)  ELSE somente_numero(substr(hbo_obter_guia_proc_mat(a.nr_atendimento,d.cd_procedimento,d.ie_origem_proced,null),1,20)) END ) nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 	 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual,	 
	' ' 				ie_tipo_insumo,	 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	d.cd_procedimento		cd_pacote, 
	d.dt_procedimento		dt_emissao, 
 	0 				qt_reg_nota,	 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	d.nr_sequencia		nr_seq_pacote 
from	conta_paciente b, 
	atendimento_paciente a, 
	procedimento_paciente d, 
	protocolo_convenio c 
where	d.nr_atendimento	= a.nr_atendimento 
and	c.nr_seq_protocolo	= b.nr_seq_protocolo 
and	a.nr_atendimento	= b.nr_atendimento 
and	d.cd_motivo_exc_conta is null 
and	d.nr_interno_conta	= b.nr_interno_conta 
and	d.nr_atendimento	= b.nr_atendimento 
and (d.nr_seq_proc_pacote= d.nr_sequencia) 

union
 
select	7 				tp_registro, 
	c.nr_seq_protocolo, 
	0	 			cd_prestador, 
	0 				nr_seq_lote, 
	999999				nr_interno_conta, 
	0				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	0 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	'0'				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	' ' 				ie_tipo_insumo,	 
	' ' 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	2 				qt_reg_nota, 
 	3 				qt_reg_doc, 
 	4 				qt_reg_proc, 
	5 				qt_reg_insumo, 
	sum(a.vl_total_lote)	vl_total_lote, 
	0				nr_seq_pacote 
from (		select	p.vl_procedimento	vl_total_lote, 
				c.nr_seq_protocolo 
			FROM procedimento j, protocolo_convenio c, conta_paciente b, atendimento_paciente a, procedimento_paciente p
LEFT OUTER JOIN proc_paciente_convenio z ON (p.nr_sequencia = z.nr_seq_procedimento)
WHERE b.nr_atendimento	= p.nr_atendimento and c.nr_seq_protocolo	= b.nr_seq_protocolo and b.nr_interno_conta	= p.nr_interno_conta and a.nr_atendimento	= p.nr_atendimento  and a.nr_atendimento	= b.nr_atendimento and j.cd_procedimento	= p.cd_procedimento and j.ie_origem_proced	= p.ie_origem_proced and p.NR_SEQ_PROC_PACOTE	is null 
			 
union all
 
			select	j.vl_material	vl_total_lote, 
				c.nr_seq_protocolo 
			FROM material m, protocolo_convenio c, conta_paciente b, material_atend_paciente j
LEFT OUTER JOIN mat_atend_pac_convenio z ON (j.nr_sequencia = z.nr_seq_material)
WHERE j.nr_atendimento	= b.nr_atendimento and c.nr_seq_protocolo	= b.nr_seq_protocolo and j.nr_interno_conta	= b.nr_interno_conta and j.cd_material		= m.cd_material  and j.nr_seq_proc_pacote	is null 
			 
union all
 
			select 0	vl_total_lote, 
				c.nr_seq_protocolo 
			from	conta_paciente b, 
				atendimento_paciente a, 
				procedimento_paciente d, 
				protocolo_convenio c 
			where	d.nr_atendimento	= a.nr_atendimento 
			and	c.nr_seq_protocolo	= b.nr_seq_protocolo 
			and	a.nr_atendimento	= b.nr_atendimento 
			and	d.nr_interno_conta	= b.nr_interno_conta 
			and	d.nr_atendimento	= b.nr_atendimento 
			and (d.nr_seq_proc_pacote= d.nr_sequencia)) a, 
	protocolo_convenio c 
where	c.nr_seq_protocolo = a.nr_seq_protocolo 
group by c.nr_seq_protocolo;

