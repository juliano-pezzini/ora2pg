-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_obitos_v (dt_obito, nr_atendimento, hr_obito, cd_setor_obito, cd_ultimo_setor, ds_setor_obito, ds_ultimo_setor, nm_paciente, ds_naturalidade, ie_sexo, ds_sexo, ie_faixa_etaria, ie_idade, ds_causa_morte, ds_faixa_etaria_ibge, cd_estabelecimento) AS SELECT	TRUNC(a.dt_alta) dt_obito,
	a.nr_atendimento, 
    TO_CHAR(a.dt_alta, 'hh24') hr_obito, 
	obter_setor_atendimento(a.nr_atendimento) cd_setor_obito, 
	obter_ultimo_setor_atendimento(a.nr_atendimento) cd_ultimo_setor, 
	SUBSTR(obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)),1,255) ds_setor_obito, 
	SUBSTR(obter_nome_setor(obter_ultimo_setor_atendimento(a.nr_atendimento)),1,255) ds_ultimo_setor, 
	b.nm_pessoa_fisica nm_paciente, 
	coalesce(SUBSTR(obter_naturalidade_pf(b.cd_pessoa_fisica,'A'),1,100),'Não informado') ds_naturalidade, 
	SUBSTR(obter_sexo_pf(b.cd_pessoa_fisica,'C'),1,30) ie_sexo, 
	SUBSTR(obter_sexo_pf(b.cd_pessoa_fisica,'D'),1,30) ds_sexo, 
	SUBSTR(obter_idade_pf(b.cd_pessoa_fisica,LOCALTIMESTAMP,'E'),1,30) ie_faixa_etaria, 
	SUBSTR(obter_idade_pf(b.cd_pessoa_fisica,LOCALTIMESTAMP,'A'),1,30) ie_idade, 
	SUBSTR(obter_desc_causa_morte(b.cd_pessoa_fisica),1,120) ds_causa_morte, 
	SUBSTR(obter_valor_dominio(4841,obter_idade_pf(b.cd_pessoa_fisica,LOCALTIMESTAMP,'EI')),1,30) ds_faixa_etaria_IBGE, 
	a.cd_estabelecimento 
FROM	atendimento_paciente a, 
	pessoa_fisica b, 
	motivo_alta d 
WHERE  a.cd_pessoa_fisica = b.cd_pessoa_fisica 
AND	a.cd_motivo_alta = d.cd_motivo_alta 
AND 	d.ie_obito	= 'S' 
AND	a.dt_alta IS NOT NULL 
GROUP BY b.cd_pessoa_fisica, 
	 b.nm_pessoa_fisica, 
	 a.cd_pessoa_fisica, 
	 a.dt_alta, 
	 coalesce(SUBSTR(obter_naturalidade_pf(b.cd_pessoa_fisica,'A'),1,100),'Não informado'), 
	SUBSTR(obter_sexo_pf(b.cd_pessoa_fisica,'D'),1,30), 
	SUBSTR(obter_idade_pf(b.cd_pessoa_fisica,LOCALTIMESTAMP,'E'),1,30), 
	SUBSTR(obter_idade_pf(b.cd_pessoa_fisica,LOCALTIMESTAMP,'A'),1,30), 
	TO_CHAR(a.dt_alta, 'hh24:mi:ss'), 
	obter_setor_atendimento(a.nr_atendimento), 
	obter_ultimo_setor_atendimento(a.nr_atendimento), 
	SUBSTR(obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)),1,255), 
	SUBSTR(obter_nome_setor(obter_ultimo_setor_atendimento(a.nr_atendimento)),1,255), 
	a.nr_atendimento, 
	a.cd_estabelecimento;

