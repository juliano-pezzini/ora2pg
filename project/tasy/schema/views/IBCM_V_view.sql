-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW ibcm_v (ds_registro, tp_registro, ie_apresentacao, nr_seq_protocolo, cd_convenio, dt_competencia, vl_total_fatura, dt_atendimento, nr_matricula_ibcm, nr_matricula_ipe, cd_categoria, tp_procedimento, cd_item, nm_paciente, vl_total_item, nr_cremers, nr_parcelas) AS SELECT	'CABEÃ‡ALHO' DS_REGISTRO,
	1 TP_REGISTRO, 
	0 IE_APRESENTACAO, 
	A.NR_SEQ_PROTOCOLO, 
	467 CD_CONVENIO, 
	TO_CHAR(LOCALTIMESTAMP,'yyyymm') DT_COMPETENCIA, 
	SUBSTR(REPLACE(SUM(B.VL_TOTAL_CONTA),',',''),1,20) VL_TOTAL_FATURA, 
	'' DT_ATENDIMENTO, 
	'' NR_MATRICULA_IBCM, 
	'' NR_MATRICULA_IPE, 
	'' CD_CATEGORIA, 
	'' TP_PROCEDIMENTO, 
	'' CD_ITEM, 
	'' NM_PACIENTE, 
	0 VL_TOTAL_ITEM, 
	'' NR_CREMERS, 
	'' NR_PARCELAS 
FROM	W_INTERF_CONTA_CAB A, 
	W_INTERF_CONTA_TOTAL B 
WHERE 	A.nr_seq_protocolo = B.nr_seq_protocolo 
GROUP BY A.CD_CONVENIO, 
	A.NR_SEQ_PROTOCOLO 

UNION ALL
 
SELECT	'DETALHE' DS_REGISTRO, 
	2 	 TP_REGISTRO, 
	1 	IE_APRESENTACAO, 
	A.NR_SEQ_PROTOCOLO, 
	0	 CD_CONVENIO, 
	''	 DT_COMPETENCIA, 
	''	 VL_TOTAL_FATURA, 
	TO_CHAR(A.DT_ENTRADA,'DDMMYYYY') DT_ATENDIMENTO, 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 1),1,20) NR_MATRICULA_IBCM, 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 2),1,20) NR_MATRICULA_IPE, 
	CASE WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='3' THEN '02' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='4' THEN '03' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='5' THEN '04' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='6' THEN '05'  ELSE '01' END  CD_CATEGORIA, 
	'06' 	TP_PROCEDIMENTO, 
	lpad(substr(IBCM_Obter_Codigo_Item(A.ie_tipo_atendimento, A.nr_interno_conta, B.cd_item, B.ie_origem_proced, B.ie_tipo_item),1,12),12,' ') cd_item, 
	A.NM_PACIENTE, 
	sum(B.VL_TOTAL_ITEM) * 100 VL_TOTAL_ITEM, 
	'    ' NR_CREMERS, 
	'   ' NR_PARCELAS 
FROM	W_INTERF_CONTA_ITEM B, 
	W_INTERF_CONTA_CAB	A 
WHERE 	A.NR_INTERNO_CONTA = B.NR_INTERNO_CONTA 
and	coalesce(A.NR_SEQ_PROTOCOLO,0) > 0 
and	B.ie_tipo_item = 2 
group by 
	A.NR_SEQ_PROTOCOLO, 
	TO_CHAR(A.DT_ENTRADA,'DDMMYYYY'), 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 1),1,20), 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 2),1,20), 
	CASE WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='3' THEN '02' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='4' THEN '03' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='5' THEN '04' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='6' THEN '05'  ELSE '01' END , 
	lpad(substr(IBCM_Obter_Codigo_Item(A.ie_tipo_atendimento, A.nr_interno_conta, B.cd_item, B.ie_origem_proced, B.ie_tipo_item),1,12),12,' '), 
	A.NM_PACIENTE, 
	A.NR_CRM_MEDICO_RESP 

UNION ALL
 
SELECT	'DETALHE' DS_REGISTRO, 
	2 	 TP_REGISTRO, 
	1 	IE_APRESENTACAO, 
	A.NR_SEQ_PROTOCOLO, 
	0	 CD_CONVENIO, 
	''	 DT_COMPETENCIA, 
	''	 VL_TOTAL_FATURA, 
	TO_CHAR(A.DT_ENTRADA,'DDMMYYYY') DT_ATENDIMENTO, 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 1),1,20) NR_MATRICULA_IBCM, 
	SUBSTR(OBTER_CD_USUARIO_CONV_GLOSA2(A.NR_ATENDIMENTO, 2),1,20) NR_MATRICULA_IPE, 
	CASE WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='3' THEN '02' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='4' THEN '03' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='5' THEN '04' WHEN Obter_Categoria_Atendimento(A.nr_atendimento)='6' THEN '05'  ELSE '01' END  CD_CATEGORIA, 
	CASE WHEN substr(Obter_Conversao_Externa(B.cd_cgc_convenio,'IBCM_V','TP_PROCEDIMENTO', 		SUBSTR(OBTER_TIPO_PROCEDIMENTO(B.CD_ITEM,B.IE_ORIGEM_PROCED,'C'),1,2)),1,2)='03' THEN  CASE WHEN Obter_Convenio_Atendimento(A.nr_atendimento)=2 THEN  '01'  ELSE '03' END  WHEN substr(Obter_Conversao_Externa(B.cd_cgc_convenio,'IBCM_V','TP_PROCEDIMENTO', 		SUBSTR(OBTER_TIPO_PROCEDIMENTO(B.CD_ITEM,B.IE_ORIGEM_PROCED,'C'),1,2)),1,2)='04' THEN  CASE WHEN Obter_Convenio_Atendimento(A.nr_atendimento)=2 THEN  '02'  ELSE '04' END  END  TP_PROCEDIMENTO, 
	lpad(substr(IBCM_Obter_Codigo_Item(A.ie_tipo_atendimento, A.nr_interno_conta, B.cd_item, B.ie_origem_proced, B.ie_tipo_item),1,12),12,' ') cd_item, 
	A.NM_PACIENTE, 
	CASE WHEN OBTER_DESC_TIPO_PROCEDIMENTO(B.CD_ITEM,B.IE_ORIGEM_PROCED)='85' THEN  B.VL_TOTAL_ITEM * 100  ELSE 0 END  VL_TOTAL_ITEM, 
	'    ' NR_CREMERS, 
	'   ' NR_PARCELAS 
FROM	W_INTERF_CONTA_ITEM B, 
	W_INTERF_CONTA_CAB	A 
WHERE 	A.NR_INTERNO_CONTA = B.NR_INTERNO_CONTA 
and	coalesce(A.NR_SEQ_PROTOCOLO,0) > 0 
and	B.ie_tipo_item = 1;

