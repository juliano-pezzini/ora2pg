-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_ics_envio_v (tp_registro, nr_seq_protocolo, nr_interno_conta, cd_contratado, ds_contratado, nr_seq_envio, nr_seq_reg, nr_senha, nr_carteira, tp_atendimento, ie_causa, ie_internado, ie_branco, nm_paciente, cd_servico, vl_servico, dt_servico, cd_dente, ie_faces_dente, qt_servico, hr_atendimento, cd_especialidade, cd_local_atend, cd_cid, ie_conselho, nr_conselho, ie_conselho_regional, nm_profissional, ie_profissional, cd_matmed, qt_matmed, cd_unidade_medida, ds_matmed, vl_matmed, ie_matmed) AS select
    1                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    0                    nr_interno_conta, 
    somente_numero(coalesce(a.cd_interno,'0')) 
                        cd_contratado, 
    substr(a.nm_hospital,1,40)    ds_contratado, 
    coalesce(a.nr_remessa,0)        nr_seq_envio, 
    0                    nr_seq_reg, 
    '0'                    nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    0                    cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    ' '                    cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
FROM    w_interf_conta_header a 

union all
 
select 
    2                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    a.nr_interno_conta        nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
    substr(coalesce(obter_doc_convenio_proc(a.nr_interno_conta), 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7) 
                        nr_senha, 
    somente_numero(coalesce(substr(a.cd_usuario_convenio,1,6),'000000')) 
                        nr_carteira, 
    CASE WHEN a.ie_carater_inter='E' THEN 1 WHEN a.ie_carater_inter='U' THEN 2  ELSE 1 END  
                        tp_atendimento, 
    CASE WHEN a.ie_carater_inter='E' THEN 2 WHEN a.ie_carater_inter='U' THEN 1  ELSE 0 END  
                        ie_causa, 
    CASE WHEN a.ie_tipo_atend_real=1 THEN 'S'  ELSE 'N' END  
                        ie_internado, 
    ' '                    ie_branco, 
    substr(a.nm_paciente,1,30)    nm_paciente, 
    0                    cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    ' '                    cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE b.nr_sequencia        = 
    (select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
        from w_interf_conta_autor x 
        where a.nr_interno_conta = x.nr_interno_conta) 
 
union all
 
select 
    3                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    a.nr_interno_conta        nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
    substr(coalesce(c.nr_doc_convenio, 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7) 
                        nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    somente_numero(substr(coalesce(c.cd_item_convenio,coalesce(c.cd_item,'0')),1,8)) 
                        cd_servico, 
    CASE WHEN C.CD_AREA_PROC=4 THEN SUM(C.VL_HONORARIO)  ELSE sum(c.vl_total_item) END    vl_servico, 
    c.dt_item                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    CASE WHEN c.cd_area_proc=4 THEN 1  ELSE sum(c.qt_item) END     qt_servico, 
    c.dt_item                hr_atendimento, 
    048                    cd_especialidade, 
    2                    cd_local_atend, 
    ' '                    cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
FROM w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE b.nr_sequencia        = 
    (select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
        from w_interf_conta_autor x 
        where a.nr_interno_conta = x.nr_interno_conta) and a.nr_interno_conta    = c.nr_interno_conta and c.cd_area_proc        in (1,2,3,4,9) group by 
    a.nr_seq_protocolo, 
    a.nr_interno_conta, 
    substr(coalesce(c.nr_doc_convenio, 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7), 
    somente_numero(substr(coalesce(c.cd_item_convenio,coalesce(c.cd_item,'0')),1,8)), 
    c.dt_item, 
    c.cd_area_proc 

union all
 
select 
    4                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    a.nr_interno_conta        nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
	substr(coalesce(a.cd_senha_guia,'0'),1,7)   nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    0                    cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    substr(a.cd_cid_principal,1,4) 
                        cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
FROM w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE b.nr_sequencia        = 
    (select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
        from w_interf_conta_autor x 
        where a.nr_interno_conta = x.nr_interno_conta) 
 
union all
 
select 
    5                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    a.nr_interno_conta        nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
    substr(coalesce(c.nr_doc_convenio, 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7) 
                        nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    somente_numero(substr(coalesce(c.cd_item_convenio,coalesce(c.cd_item,'0')),1,8)) 
                        cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    ' '                    cd_cid, 
    '1'                    ie_conselho, 
    somente_numero(substr(coalesce(c.nr_crm_executor,'0'),1,5)) 
                        nr_conselho, 
    substr(c.uf_crm_executor,1,5)    ie_conselho_regional, 
    substr(c.nm_medico_executor,1,27) 
                        nm_profissional, 
    CASE WHEN c.cd_funcao_executor=1 THEN 'S' WHEN c.cd_funcao_executor=3 THEN 'C' WHEN c.cd_funcao_executor=9 THEN '1' WHEN c.cd_funcao_executor=10 THEN '2'  ELSE '0' END  ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
FROM w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE b.nr_sequencia        = 
    (select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
        from w_interf_conta_autor x 
        where a.nr_interno_conta = x.nr_interno_conta) and a.nr_interno_conta    = c.nr_interno_conta and c.cd_area_proc        in (1,2,4) 
 
union all
 
select 
    6                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    a.nr_interno_conta        nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
    substr(coalesce(c.nr_doc_convenio, 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7) 
                        nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    0                    cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    ' '                    cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    somente_numero(substr(coalesce(c.cd_item_convenio,coalesce(c.cd_item,'0')),1,5)) 
                        cd_matmed, 
    sum(c.qt_item)            qt_matmed, 
    substr(c.cd_unidade_medida,1,2) 
                        cd_unidade_medida, 
    substr(c.ds_item,1,27)        ds_matmed, 
    sum(c.vl_total_item)        vl_matmed, 
    CASE WHEN c.cd_tipo_item_interf=4 THEN 'A'  ELSE 'E' END  
                        ie_matmed 
FROM w_interf_conta_item c, w_interf_conta_cab a
LEFT OUTER JOIN w_interf_conta_autor b ON (a.nr_interno_conta = b.nr_interno_conta)
WHERE b.nr_sequencia        = 
    (select coalesce(min(x.nr_sequencia),b.nr_sequencia) 
        from w_interf_conta_autor x 
        where a.nr_interno_conta = x.nr_interno_conta) and a.nr_interno_conta    = c.nr_interno_conta and c.cd_tipo_item_interf    in (4,5) group by 
    a.nr_seq_protocolo, 
    a.nr_interno_conta, 
    substr(coalesce(c.nr_doc_convenio, 
		coalesce(b.cd_senha,coalesce(a.nr_doc_convenio,'0'))),1,7), 
    somente_numero(substr(coalesce(c.cd_item_convenio,coalesce(c.cd_item,'0')),1,5)), 
    substr(c.cd_unidade_medida,1,2), 
    substr(c.ds_item,1,27), 
    CASE WHEN c.cd_tipo_item_interf=4 THEN 'A'  ELSE 'E' END  

union all
 
select 
    9                    tp_registro, 
    a.nr_seq_protocolo        nr_seq_protocolo, 
    9999999999                nr_interno_conta, 
    0                    cd_contratado, 
    ' '                    ds_contratado, 
    0                    nr_seq_envio, 
    0                    nr_seq_reg, 
    '0'                    nr_senha, 
    0                    nr_carteira, 
    0                    tp_atendimento, 
    0                    ie_causa, 
    ' '                    ie_internado, 
    ' '                    ie_branco, 
    ' '                    nm_paciente, 
    0                    cd_servico, 
    0                    vl_servico, 
    LOCALTIMESTAMP                dt_servico, 
    ' '                    cd_dente, 
    ' '                    ie_faces_dente, 
    0                    qt_servico, 
    LOCALTIMESTAMP                hr_atendimento, 
    0                    cd_especialidade, 
    0                    cd_local_atend, 
    ' '                    cd_cid, 
    ' '                    ie_conselho, 
    0                    nr_conselho, 
    ' '                    ie_conselho_regional, 
    ' '                    nm_profissional, 
    ' '                    ie_profissional, 
    0                    cd_matmed, 
    0                    qt_matmed, 
    ' '                    cd_unidade_medida, 
    ' '                    ds_matmed, 
    0                    vl_matmed, 
    ' '                    ie_matmed 
from    w_interf_conta_trailler a;

