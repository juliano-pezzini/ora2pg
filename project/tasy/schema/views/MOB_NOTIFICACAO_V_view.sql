-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW mob_notificacao_v (ie_tipo_not, cd_medico_resp, ds_macro) AS select	'P' ie_tipo_not,
			a.cd_medico_resp cd_medico_resp, 
			substr('#@NM_PACIENTE='||obter_nome_pf(a.cd_pessoa_fisica)||'; #@NR_ATENDIMENTO='||a.nr_atendimento||'; #@DS_SEXO=' 
				||obter_sexo_pf(cd_pessoa_fisica, '')||'; #@DS_IDADE='||Obter_Idade_PF(cd_pessoa_fisica, LOCALTIMESTAMP, 'S') 
				||'; #@CD_MEDICO='||cd_pessoa_fisica||'; #@DS_SETOR='||obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)) 
				||'; #@DS_UNIDADE='|| obter_ult_unidade_atend(a.nr_atendimento,'B') || ' - ' || obter_ult_unidade_atend(nr_atendimento, 'C') ||';',1,4000) ds_macro 
	FROM	atendimento_paciente a 
	where	a.dt_alta is null 
	and (exists (select 1 from unidade_atendimento x where x.nr_atendimento = a.nr_atendimento)) 
	and (not exists (	select  1 
							from   prescr_medica x 
							where  x.nr_atendimento = a.nr_atendimento 
							and   x.dt_validade_prescr > LOCALTIMESTAMP)) 
	and   ((exists (	select  1 
						from   prescr_medica x 
						where  x.nr_atendimento = a.nr_atendimento 
						and   x.dt_validade_prescr < LOCALTIMESTAMP - (24 /24)))) 
	and		(not exists (	select	1 
							from 	mob_notificacao_pend x 
							where	x.ie_tipo = 'P' 
							and		dt_atualizacao is not null 
							and		x.ds_macro not like '%NR_ATENDIMENTO='||a.nr_atendimento||'%' 
							and		LOCALTIMESTAMP > x.dt_atualizacao - (24 /24))) 
	
union
 
	select	'E' ie_tipo_not, 
			a.cd_medico_resp cd_medico_resp, 
			substr('#@NM_PACIENTE='||obter_nome_pf(a.cd_pessoa_fisica)||'; #@NR_ATENDIMENTO='||a.nr_atendimento||'; #@DS_SEXO=' 
				||obter_sexo_pf(cd_pessoa_fisica, '')||'; #@DS_IDADE='||Obter_Idade_PF(cd_pessoa_fisica, LOCALTIMESTAMP, 'S') 
				||'; #@CD_MEDICO='||cd_pessoa_fisica||'; #@DS_SETOR='||obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)) 
				||'; #@DS_UNIDADE='|| obter_ult_unidade_atend(a.nr_atendimento,'B') || ' - ' || obter_ult_unidade_atend(nr_atendimento, 'C') ||';',1,4000) ds_macro 
	from	atendimento_paciente a 
	where	a.dt_alta is null 
	and (exists (select 1 from unidade_atendimento x where x.nr_atendimento = a.nr_atendimento)) 
	and (not exists (select 1 
							from	evolucao_paciente x 
							where	x.nr_atendimento = a.nr_atendimento 
							and		x.dt_evolucao > LOCALTIMESTAMP - interval '24 days' /24)) 
	and		(not exists (	select	1 
							from 	mob_notificacao_pend x 
							where	x.ie_tipo = 'E' 
							and		dt_atualizacao is not null 
							and		x.ds_macro not like '%NR_ATENDIMENTO='||a.nr_atendimento||'%' 
							and		LOCALTIMESTAMP > x.dt_atualizacao - (24 /24))) 
	
union
 
	select	'A' ie_tipo_not, 
			a.cd_medico_resp cd_medico_resp, 
			substr('#@NM_PACIENTE='||obter_nome_pf(a.cd_pessoa_fisica)||'; #@NR_ATENDIMENTO='||a.nr_atendimento||'; #@DS_SEXO=' 
				||obter_sexo_pf(cd_pessoa_fisica, '')||'; #@DS_IDADE='||Obter_Idade_PF(cd_pessoa_fisica, LOCALTIMESTAMP, 'S') 
				||'; #@CD_MEDICO='||cd_pessoa_fisica||'; #@DS_SETOR='||obter_nome_setor(obter_setor_atendimento(a.nr_atendimento)) 
				||'; #@DS_UNIDADE='|| obter_ult_unidade_atend(a.nr_atendimento,'B') || ' - ' || obter_ult_unidade_atend(nr_atendimento, 'C') ||';',1,4000) ds_macro 
	from 	atendimento_paciente a 
	where	dt_alta is null 
	and 	dt_previsto_alta < LOCALTIMESTAMP 
	and		dt_previsto_alta is not null 
	and		ie_probabilidade_alta <> 'S';

