-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tjdft_v (tp_registro, cd_tipo_registro, cd_convenio, dt_mesano_referencia, nr_nota_nf, nr_interno_conta, cd_cgc_convenio, vl_protocolo, tx_administrativa, dt_emissao, dt_limite, nr_seq_protocolo, nr_guia, nr_matricula, ie_titular, nm_paciente, dt_entrada, ie_horario, vl_procedimento, vl_medicamento, vl_material, vl_total, cd_procedimento, cd_especialidade, qt_procedimento, vl_unitario, nr_indicacao, dt_arquivo, qt_registros) AS SELECT	0					tp_registro,
	0					cd_tipo_registro,
	a.cd_interno				cd_convenio,
	a.dt_remessa				dt_mesano_referencia,
	LPAD(obter_nf_protocolo(a.nr_seq_protocolo,'1'),12,0)					nr_nota_nf,
	0					nr_interno_conta,
	cd_cgc_hospital			 	cd_cgc_convenio,
	obter_total_protocolo(a.nr_Seq_protocolo) vl_protocolo,
	' '					tx_administrativa,
	obter_nf_protocolo(a.nr_seq_protocolo,'2')			dt_emissao,
	obter_nf_protocolo(a.nr_seq_protocolo,'3')			dt_limite,
	a.nr_seq_protocolo			nr_Seq_protocolo,
	null					nr_guia,
	null					nr_matricula,
	null					ie_titular,
	null					nm_paciente,
	LOCALTIMESTAMP					dt_entrada,
	0					ie_horario,
	0					vl_Procedimento,
	0					vl_medicamento,
	0					vl_material,
	0					vl_total,
	null					cd_procedimento,
	00					cd_especialidade,
	0					qt_procedimento,
	0					vl_unitario,
	'1'					nr_indicacao,
	LOCALTIMESTAMP					dt_arquivo,
	0					qt_registros
FROM	w_interf_conta_header 	a

UNION ALL

SELECT	1					tp_registro,
	1					cd_tipo_registro,
	null					cd_convenio,
	null					dt_mesano_referencia,
	' '					nr_nota_nf,
	a.nr_interno_conta			nr_interno_conta,
	null 					cd_cgc_convenio,
	0 					vl_protocolo,
	' '					tx_administrativa,
	' '					dt_emissao,
	' '					dt_limite,
	a.nr_seq_protocolo			nr_Seq_protocolo,
	Obter_Guia_Conta(a.nr_interno_conta)	nr_guia,
	a.cd_usuario_convenio			nr_matricula,
	CASE WHEN a.cd_dependente=1 THEN  'S'  ELSE 'N' END 	ie_titular,
	a.nm_paciente				nm_paciente,
	a.dt_entrada				dt_entrada,
	0					ie_horario,
	b.vl_taxas + b.vl_diarias + (	select	round((coalesce(sum(y.vl_participante),0))::numeric,4)
					from	conta_paciente_estrutura w,
						procedimento_participante y,
						procedimento_paciente z
					where	z.nr_interno_conta	= b.nr_interno_conta
					and	z.nr_sequencia		= y.nr_sequencia
					and	z.cd_motivo_exc_conta	is null
					and  	w.cd_estrutura  		= CASE WHEN upper(y.ie_emite_conta)='S' THEN 0 WHEN upper(y.ie_emite_conta)='N' THEN  0  ELSE y.ie_emite_conta END
					and	w.ie_total_interf	is not null
					and	exists (	select	1
							from	funcao_medico x
							where	x.cd_funcao = y.ie_funcao
							and	coalesce(x.ie_instrumentador,'N') = 'S'))	vl_Procedimento,
	b.vl_medicamentos			vl_medicamento,
	b.vl_materiais				vl_material,
	b.vl_total_conta			vl_total,
	null					cd_procedimento,
	00					cd_especialidade,
	0					qt_procedimento,
	0					vl_unitario,
	'1'					nr_indicacao,
	LOCALTIMESTAMP					dt_arquivo,
	0					qt_registros
FROM	w_interf_conta_cab 	a,
	w_interf_conta_total	b
WHERE	b.nr_interno_conta = a.nr_interno_conta

UNION ALL

SELECT	3					tp_registro,
	2					cd_tipo_registro,
	null					cd_convenio,
	null					dt_mesano_referencia,
	' '					nr_nota_nf,
	a.nr_interno_conta			nr_interno_conta,
	null 					cd_cgc_convenio,
	0 					vl_protocolo,
	' '					tx_administrativa,
	' '					dt_emissao,
	' '					dt_limite,
	a.nr_seq_protocolo			nr_Seq_protocolo,
	Obter_Guia_Conta(a.nr_interno_conta)	nr_guia,
	null					nr_matricula,
	null					ie_titular,
	null					nm_paciente,
	a.dt_entrada				dt_entrada,
	0					ie_horario,
	0					vl_Procedimento,
	0					vl_medicamento,
	0					vl_material,
	0					vl_total,
	(b.cd_item_convenio)::numeric 		cd_procedimento,
	somente_numero(obter_conversao_externa(a.cd_cgc_convenio, 'TJDFT_V', 'IE_CLINICA', a.ie_clinica))
						cd_especialidade,
	b.qt_item				qt_procedimento,
	CASE WHEN b.ie_emite_conta=91 THEN  b.vl_honorario  ELSE b.vl_unitario_item END 	vl_unitario,
	'1'					nr_indicacao,
	LOCALTIMESTAMP					dt_arquivo,
	0					qt_registros
FROM	w_interf_conta_cab 	a,
	w_interf_conta_item	b
WHERE	b.nr_interno_conta = a.nr_interno_conta
and	b.ie_tipo_item	= 1
and	obter_classif_material_proced(null, b.cd_item, b.ie_origem_proced) = '1'
and	coalesce(b.ie_responsavel_credito,'X') <> 'M'
and	not exists (	select	1
			from	funcao_medico x
			where	x.cd_funcao = b.cd_funcao_executor
			and	coalesce(x.ie_instrumentador,'N') = 'S')

UNION ALL

SELECT	4					tp_registro,
	9					cd_tipo_registro,
	null					cd_convenio,
	null					dt_mesano_referencia,
	' '					nr_nota_nf,
	9999999999				nr_interno_conta,
	null 					cd_cgc_convenio,
	0 					vl_protocolo,
	' '					tx_administrativa,
	' '					dt_emissao,
	' '					dt_limite,
	a.nr_seq_protocolo			nr_Seq_protocolo,
	null					nr_guia,
	null					nr_matricula,
	null					ie_titular,
	null					nm_paciente,
	LOCALTIMESTAMP					dt_entrada,
	0					ie_horario,
	0					vl_Procedimento,
	0					vl_medicamento,
	0					vl_material,
	0					vl_total,
	null					cd_procedimento,
	00					cd_especialidade,
	0					qt_procedimento,
	0					vl_unitario,
	'1'					nr_indicacao,
	LOCALTIMESTAMP					dt_arquivo,
	a.qt_item				qt_registros
from	w_interf_conta_trailler a;

