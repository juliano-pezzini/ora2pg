-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_ops_copart_custo_v (ds_tipo_regra, tx_regra_copart, dt_mes_competencia, cd_estabelecimento, vl_regra, vl_coparticipacao, vl_custo_item, vl_custo_total) AS select	ds_tipo_regra,
	tx_regra_copart,
	dt_mes_competencia,
	cd_estabelecimento,
	vl_regra,
	vl_coparticipacao,
	vl_custo_item,
	vl_custo_total
FROM	(
	select	substr(CASE WHEN z.ie_tipo_movto='1' THEN CASE WHEN coalesce(tx_regra_copart,0)=0 THEN obter_desc_expressao(301372)  ELSE obter_desc_expressao(299073) END   ELSE obter_desc_expressao(892520) END ,1,50) ds_tipo_regra,
		substr((z.tx_regra_copart || '%'),1,15) tx_regra_copart,
		z.dt_mes_competencia,
		z.cd_estabelecimento,
		z.vl_regra_fixo vl_regra,
		sum(z.vl_copart_item) vl_coparticipacao,
		sum(z.vl_custo) vl_custo_item,
		( select sum(vl_item)
		 from	 eis_ops_custo_v
		 where	 trunc(dt_mes_competencia_param) = z.dt_mes_competencia) vl_custo_total
	from (
		select	substr(obter_desc_expressao(296422),1,30) ds_tipo_item,
			1 ie_tipo_movto, -- Movtos com Coparticipação
			a.dt_mes_competencia_param dt_mes_competencia,
			a.cd_estabelecimento,
			a.nr_seq_conta,
			a.nr_seq_conta_proc,
			b.nr_seq_regra,
			c.tx_coparticipacao tx_regra_copart,
			c.vl_coparticipacao vl_regra_fixo,
			b.vl_coparticipacao vl_copart_item,
			a.vl_item vl_custo
		from	eis_ops_custo_v a,
			pls_conta_coparticipacao b,
			pls_regra_coparticipacao c
		where	a.nr_seq_conta = b.nr_seq_conta
		and	b.nr_seq_regra = c.nr_sequencia
		and	a.nr_seq_conta_proc = b.nr_seq_conta_proc
		
union all

		select	substr(obter_desc_expressao(292952),1,30) ds_tipo_item,
			1 ie_tipo_movto, -- Movtos com Coparticipação
			a.dt_mes_competencia_param dt_mes_competencia,
			a.cd_estabelecimento,
			a.nr_seq_conta,
			a.nr_seq_conta_mat,
			b.nr_seq_regra,
			c.tx_coparticipacao tx_regra_copart,
			c.vl_coparticipacao vl_regra_copart_fixo,
			b.vl_coparticipacao vl_copart_item,
			a.vl_item vl_custo
		from	eis_ops_custo_v a,
			pls_conta_coparticipacao b,
			pls_regra_coparticipacao c
		where	a.nr_seq_conta = b.nr_seq_conta
		and	b.nr_seq_regra = c.nr_sequencia
		and	a.nr_seq_conta_mat = b.nr_seq_conta_mat
		
union all

		select	substr(obter_desc_expressao(296422),1,30) ds_tipo_item,
			2 ie_tipo_movto, -- Movtos sem Coparticipação
			a.dt_mes_competencia_param dt_mes_competencia,
			a.cd_estabelecimento,
			a.nr_seq_conta,
			a.nr_seq_conta_proc,
			null nr_seq_regra,
			null  tx_regra_copart,
			null  vl_regra_fixo,
			0  vl_copart_item,
			a.vl_item vl_custo
		from	eis_ops_custo_v a
		where	not exists (	select	1
					from	pls_conta_coparticipacao b,
						pls_regra_coparticipacao c
					where	a.nr_seq_conta = b.nr_seq_conta
					and	b.nr_seq_regra = c.nr_sequencia
					and	a.nr_seq_conta_proc = b.nr_seq_conta_proc)
		and	coalesce(a.nr_seq_conta_proc,0) <> 0
		
union all

		select	substr(obter_desc_expressao(292952),1,30) ds_tipo_item,
			2 ie_tipo_movto, -- Movtos sem Coparticipação
			a.dt_mes_competencia_param dt_mes_competencia,
			a.cd_estabelecimento,
			a.nr_seq_conta,
			a.nr_seq_conta_mat,
			null nr_seq_regra,
			null tx_regra_copart,
			null vl_regra_copart_fixo,
			0 vl_copart_item,
			a.vl_item vl_custo
		from	eis_ops_custo_v a
		where	not exists (	select	1
					from	pls_conta_coparticipacao b,
						pls_regra_coparticipacao c
					where	a.nr_seq_conta = b.nr_seq_conta
					and	b.nr_seq_regra = c.nr_sequencia
					and	a.nr_seq_conta_mat = b.nr_seq_conta_mat)
		and	coalesce(a.nr_seq_conta_mat,0) <> 0
		) z
	group by ie_tipo_movto,
		tx_regra_copart,
		dt_mes_competencia,
		cd_estabelecimento,
		vl_regra_fixo
	) alias25
order by dt_mes_competencia asc;

