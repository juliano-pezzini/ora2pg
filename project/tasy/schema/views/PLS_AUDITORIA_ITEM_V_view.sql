-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_auditoria_item_v (ie_tipo_item, ds_tipo_item, cd_proc_mat, ds_proc_mat, ds_nome_comercial, cd_material, qt_original, qt_ajuste, ie_status, ie_status_solicitacao, ds_status_sol, ds_status, ds_acao, ds_despesa, nr_seq_origem, qt_tempo, ie_tipo_despesa, nr_sequencia, nr_seq_prest_fornec, ds_fornecedor, vl_item, ie_origem_proced, vl_conta, vl_total_intercambio, cd_servico_conversao, ds_opme, nr_seq_material_forn, nm_fornecedor_mat, nr_seq_material, nr_registro_anvisa, cd_ref_fabricante_imp, vl_total_pacote, ie_ocorr_liminar, ds_material_intercambio, ie_pacote_ptu, ds_pacote_ptu, ds_observacao, vl_original, cd_ref_mat_ops, nr_seq_auditoria, ds_prioridade, ds_solicitacoes_vinculadas) AS select	'P' ie_tipo_item,
	'Procedimento' ds_tipo_item,
	cd_procedimento cd_proc_mat,
	substr(Obter_Descricao_Procedimento(cd_procedimento,ie_origem_proced),1,255) ds_proc_mat,
	'' ds_nome_comercial,
	'' cd_material,
	qt_original,
	qt_ajuste,	
	ie_status,
	ie_status_solicitacao,
	substr(obter_valor_dominio(3544,ie_status_solicitacao),1,255) ds_status_sol,
	substr(obter_valor_dominio(3544,ie_status),1,255) ds_status,
	substr(obter_valor_dominio(3339,ie_acao_auditor),1,255) ds_acao,
	CASE WHEN ie_tipo_despesa=1 THEN 'Procedimentos' WHEN ie_tipo_despesa=2 THEN 'Taxas' WHEN ie_tipo_despesa=3 THEN 'Diárias' WHEN ie_tipo_despesa=4 THEN 'Pacote' END  ds_despesa,
	nr_seq_proc_origem nr_seq_origem,	
	CASE WHEN ie_status='S' THEN 0  ELSE round((CASE WHEN ie_status='P' THEN dt_atualizacao  ELSE CASE WHEN ie_Status='M' THEN dt_atualizacao  ELSE LOCALTIMESTAMP END  END  - dt_atualizacao_nrec) * 24,2) END  qt_tempo,
	ie_tipo_despesa,
	nr_sequencia,
	nr_seq_prest_fornec,
	'' ds_fornecedor,
	vl_item,
	ie_origem_proced ie_origem_proced,
	vl_procedimento_conta vl_conta,
	(qt_ajuste * vl_item) vl_total_intercambio,
	substr(pls_obter_item_desc_conv_scs(nr_sequencia,'P','C'),1,255)
	cd_servico_conversao,
	substr(pls_obter_item_desc_conv_scs(nr_sequencia,'P','D'),1,255) ds_opme,
	nr_seq_material_forn,
	substr(pls_obter_fornecedor_material(nr_seq_material_forn),1,255) nm_fornecedor_mat,
	0 nr_seq_material,
	nr_registro_anvisa,
	cd_ref_fabricante_imp,
	vl_total_pacote,
	substr(pls_obter_se_ocorr_liminar(nr_seq_auditoria, nr_sequencia),1,255) ie_ocorr_liminar,
	'' ds_material_intercambio,
	coalesce(ie_pacote_ptu,'N') ie_pacote_ptu,
	CASE WHEN ie_pacote_ptu='S' THEN 'Sim'  ELSE 'Não' END  ds_pacote_ptu,
	substr(pls_obter_observacao_item_req(nr_seq_proc_origem, null),1,255) ds_observacao,
	vl_original,
	null cd_ref_mat_ops,
	nr_seq_auditoria,
	obter_prioridade_reg_pls(NR_SEQ_AUDITORIA, cd_procedimento, 'A') ds_prioridade,
	regulacao_vinculadas_audit(NR_SEQ_AUDITORIA, cd_procedimento, 'P') ds_solicitacoes_vinculadas
FROM	pls_auditoria_item
where	cd_procedimento is not null

union

select	'M' ie_tipo_item,
	'Material' ds_tipo_item,
	(CASE WHEN pls_obter_dados_material(nr_seq_material,'CO')='' THEN nr_seq_material  ELSE pls_obter_dados_material(nr_seq_material,'CO') END )::numeric  cd_proc_mat,
	substr(pls_obter_desc_material(nr_seq_material),1,255) ds_proc_mat,
	substr(pls_obter_dados_material(nr_seq_material,'NC'),1,255)ds_nome_comercial,
	substr(pls_obter_seq_codigo_material(nr_seq_material,''),1,10) cd_material,
	qt_original,
	qt_ajuste,	
	ie_status,
	ie_status_solicitacao,
	substr(obter_valor_dominio(3544,ie_status_solicitacao),1,255) ds_status_sol,
	substr(obter_valor_dominio(3544,ie_status),1,255) ds_status,
	substr(obter_valor_dominio(3339,ie_acao_auditor),1,255) ds_acao,
	CASE WHEN ie_tipo_despesa=1 THEN 'Gases medicinais' WHEN ie_tipo_despesa=2 THEN 'Medicamentos' WHEN ie_tipo_despesa=3 THEN 'Materiais' WHEN ie_tipo_despesa=7 THEN 'OPM' END  ds_despesa,
	nr_seq_mat_origem nr_seq_origem,
	CASE WHEN ie_status='S' THEN 0  ELSE round((CASE WHEN ie_status='P' THEN dt_atualizacao  ELSE CASE WHEN ie_Status='M' THEN dt_atualizacao  ELSE LOCALTIMESTAMP END  END  - dt_atualizacao_nrec) * 24,2) END  qt_tempo,
	ie_tipo_despesa,
	nr_sequencia,
	nr_seq_prest_fornec,
	substr(pls_obter_dados_prestador(nr_seq_prest_fornec,'N'),1,255) ds_fornecedor,
	vl_item,
	0 ie_origem_proced,
	vl_material_conta vl_conta,
	(qt_ajuste * vl_item) vl_total_intercambio,
	substr(pls_obter_item_desc_conv_scs(nr_sequencia,'M','C'),1,255) cd_servico_conversao,
	substr(pls_obter_item_desc_conv_scs(nr_sequencia,'M','D'),1,255) ds_opme,
	nr_seq_material_forn,
	substr(pls_obter_fornecedor_material(nr_seq_material_forn),1,255) nm_fornecedor_mat,
	nr_seq_material,
	nr_registro_anvisa,
	cd_ref_fabricante_imp,
	vl_total_pacote,
	Substr(Pls_Obter_Se_Ocorr_Liminar(Nr_Seq_Auditoria, Nr_Sequencia),1,255) Ie_Ocorr_Liminar,
	substr(pls_obter_desc_mat_intercambio(nr_seq_auditoria, nr_seq_mat_origem),1,255) ds_material_intercambio,
	'N' ie_pacote_ptu,
	CASE WHEN ie_pacote_ptu='S' THEN 'Sim'  ELSE 'Não' END  ds_pacote_ptu,
	substr(pls_obter_observacao_item_req(null, nr_seq_mat_origem),1,255) ds_observacao,
	vl_original,
	to_char(CASE WHEN pls_obter_dados_material(nr_seq_material,'CO')='' THEN nr_seq_material  ELSE pls_obter_dados_material(nr_seq_material,'CO') END ) cd_ref_mat_ops,
	nr_seq_auditoria,
	'' ds_prioridade,
	regulacao_vinculadas_audit(NR_SEQ_AUDITORIA, cd_procedimento, 'M') ds_solicitacoes_vinculadas
from	pls_auditoria_item
where	nr_seq_material is not null
order by nr_sequencia;

