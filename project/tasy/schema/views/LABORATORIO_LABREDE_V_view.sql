-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW laboratorio_labrede_v (tp_registro, id_laboratorio, nr_prescricao, nr_prontuario, nr_seq_visita, nm_paciente, dt_nascimento, ie_sexo, qt_altura, qt_peso, ds_medicamento, ds_observacao, dt_ult_mes, cd_exame, cd_material, ds_complemento, nr_recipiente_origem, nr_recipiente_titan, ds_obs, ds_setor_atendimento, cd_material_int, ie_urgencia, nr_recipiente_terceiro, cd_setor_prescr, nr_seq_lote_externo) AS select	1					tp_registro,
	coalesce(Obter_Dados_Lote_Externo(a.nr_Seq_lote_externo,3),'093')					id_laboratorio, 
	a.nr_prescricao				nr_prescricao, 
	coalesce(b.cd_recem_nato, b.cd_pessoa_fisica) nr_prontuario, 
	001					nr_seq_visita, 
	upper(obter_nome_pessoa_fisica(coalesce(b.cd_recem_nato,b.cd_pessoa_fisica),null)) nm_paciente, 
	obter_nascimento_prescricao(b.nr_prescricao) dt_nascimento, 
	obter_sexo_prescricao(b.nr_prescricao)	ie_sexo, 
	b.qt_altura_cm				qt_altura, 
	b.qt_peso				qt_peso, 
	upper(b.ds_dado_clinico)		ds_medicamento, 
	upper(b.ds_observacao) || '|'		ds_observacao, 
	LOCALTIMESTAMP					dt_ult_mes, 
	''					cd_exame, 
	''					cd_material, 
	''					ds_complemento, 
	0					nr_recipiente_origem, 
	' '					nr_recipiente_titan, 
	''					ds_obs, 
	''					ds_setor_atendimento, 
	' '					cd_material_int, 
	0					ie_urgencia, 
	''					nr_recipiente_terceiro, 
	b.cd_setor_atendimento			cd_setor_prescr, 
	a.nr_seq_lote_externo 
FROM 	exame_laboratorio d, 
	prescr_medica b, 
	prescr_procedimento a 
where a.nr_prescricao = b.nr_prescricao 
 and a.nr_seq_exame = d.nr_seq_exame 
-- and a.dt_integracao is null 
union
 
select	2					tp_registro, 
	'0'					id_laboratorio, 
	a.nr_prescricao				nr_prescricao, 
	''					nr_prontuario, 
	001					nr_seq_visita, 
	''					nm_paciente, 
	LOCALTIMESTAMP					dt_nascimento, 
	' '					ie_sexo, 
	0					qt_altura, 
	0					qt_peso, 
	''					ds_medicamento, 
	''					ds_observacao, 
	LOCALTIMESTAMP					dt_ult_mes, 
	coalesce(c.cd_exame_integracao, cd_exame)	cd_exame, 
	coalesce(d.cd_material_integracao, d.cd_material_exame) cd_material, 
	upper(a.ds_dado_clinico)		ds_complemento, 
	e.nr_prescricao				nr_recipiente_origem, 
	coalesce(Obter_Dados_Lote_Externo(a.nr_Seq_lote_externo,3),'093') || to_char(LOCALTIMESTAMP,'yy') ||lpad(a.nr_seq_lab,7,'0')	nr_recipiente_titan, 
	upper(a.ds_observacao)			ds_obs, 
	upper(substr(obter_nome_setor(e.cd_setor_atendimento),1,200)) ds_setor_atendimento, 
	''					cd_material_int, 
	CASE WHEN a.ie_urgencia='N' THEN  0  ELSE 1 END 	ie_urgencia, 
	'' || '|'				nr_recipiente_terceiro, 
	e.cd_setor_atendimento			cd_setor_prescr, 
	a.nr_seq_lote_externo 
FROM prescr_medica e, material_exame_lab d, exame_laboratorio c, prescr_procedimento a
LEFT OUTER JOIN prescr_proc_etapa b ON (a.nr_prescricao = b.nr_prescricao AND a.nr_sequencia = b.nr_seq_prescricao)
WHERE a.nr_seq_exame = c.nr_seq_exame and a.cd_material_exame = d.cd_material_exame  and a.nr_prescricao = e.nr_prescricao;

