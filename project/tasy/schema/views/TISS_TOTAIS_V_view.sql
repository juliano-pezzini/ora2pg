-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW tiss_totais_v (ds_versao, vl_taxas, vl_diarias, vl_procedimentos, vl_medicamentos, vl_materiais, vl_total, ds_tipo_faturamento, vl_gases, nr_interno_conta, cd_autorizacao, nr_atendimento, dt_fim_conta, ie_honorario, ie_tiss_tipo_guia, cd_medico_atendimento, cd_cgc_prestador, ie_tiss_tipo_guia_desp) AS select	'2.01.01' ds_versao,
	sum(coalesce(x.vl_taxas, 0)) vl_taxas,
	sum(coalesce(x.vl_diarias, 0)) vl_diarias,
	sum(coalesce(x.vl_procedimentos, 0)) vl_procedimentos,
	sum(coalesce(x.vl_medicamentos, 0)) vl_medicamentos,
	sum(coalesce(x.vl_materiais, 0)) vl_materiais,
	sum(coalesce(x.vl_taxas, 0) + coalesce(x.vl_diarias, 0) + coalesce(x.vl_procedimentos, 0) + coalesce(x.vl_medicamentos, 0) + coalesce(x.vl_materiais, 0) + coalesce(x.vl_gases, 0)) vl_total,
	null ds_tipo_faturamento,
	sum(coalesce(x.vl_gases, 0)) vl_gases,
	x.nr_interno_conta,
	x.cd_autorizacao,
	x.nr_atendimento,
	x.dt_fim_conta,
	x.ie_honorario,
	x.ie_tiss_tipo_guia,
	x.cd_medico_atendimento,
	x.cd_cgc_prestador,
	x.ie_tiss_tipo_guia_desp
FROM (
	select	CASE WHEN a.ie_tiss_tipo_despesa='4' THEN  a.vl_procedimento  ELSE 0 END  vl_taxas,
		CASE WHEN a.ie_tiss_tipo_despesa='5' THEN  a.vl_procedimento  ELSE 0 END  vl_diarias,
		CASE WHEN coalesce(a.ie_tiss_tipo_despesa,'0')='0' THEN  a.vl_procedimento  ELSE 0 END  vl_procedimentos,
		0 vl_medicamentos,
		0 vl_materiais,
		CASE WHEN a.ie_tiss_tipo_despesa='1' THEN  a.vl_procedimento  ELSE 0 END  vl_gases,
		coalesce(a.nr_doc_convenio,'Não Informada') cd_autorizacao,
		a.nr_interno_conta,
		c.nr_atendimento,
		d.dt_fim_conta,
		CASE WHEN coalesce(a.ie_tiss_tipo_guia,'X')='X' THEN  CASE WHEN coalesce(e.ie_entra_conta || e.ie_repassa_medico, 'X')='NN' THEN  'S'  ELSE 'N' END   ELSE CASE WHEN a.ie_tiss_tipo_guia='6' THEN 'S'  ELSE 'N' END  END   ie_honorario,
		CASE WHEN coalesce(a.ie_tiss_tipo_guia,'X')='X' THEN 			CASE WHEN coalesce(e.ie_entra_conta || e.ie_repassa_medico, 'X')='NN' THEN  '6'  ELSE CASE WHEN d.ie_tipo_atendimento=1 THEN  '5'  ELSE '4' END  END   ELSE a.ie_tiss_tipo_guia END  ie_tiss_tipo_guia,
		d.cd_medico_atendimento,  -- Edgar, na guia de Resumo sempre o prestador deve ser o estabelecimento
		coalesce(a.cd_cgc_prestador_tiss, coalesce(CASE WHEN a.ie_tiss_tipo_guia='5' THEN  h.cd_cgc  ELSE a.cd_cgc_prestador END , h.cd_cgc)) cd_cgc_prestador,
		a.ie_tiss_tipo_guia_desp
	FROM procedimento p, estabelecimento h, atendimento_paciente d, conta_paciente c, procedimento_paciente a
LEFT OUTER JOIN regra_honorario e ON (a.ie_responsavel_credito = e.cd_regra)
WHERE a.cd_procedimento				= p.cd_procedimento and a.ie_origem_proced				= p.ie_origem_proced and c.nr_interno_conta				= a.nr_interno_conta and a.cd_motivo_exc_conta 				is null and c.ie_cancelamento				is null and coalesce(a.nr_seq_proc_pacote, a.nr_sequencia)	= a.nr_sequencia and a.nr_atendimento				= d.nr_atendimento  and c.cd_estabelecimento				= h.cd_estabelecimento
	
union all

	select	0 vl_taxas,
		0 vl_diarias,
		0 vl_procedimentos,
		CASE WHEN b.ie_tipo_material=1 THEN  0 WHEN b.ie_tipo_material=5 THEN  0 WHEN b.ie_tipo_material=4 THEN  0  ELSE a.vl_material END  vl_medicamentos,
		CASE WHEN m.ie_tipo_classe='G' THEN  0  ELSE CASE WHEN b.ie_tipo_material=1 THEN  a.vl_material WHEN b.ie_tipo_material=5 THEN  a.vl_material  ELSE 0 END  END  vl_materiais,
		CASE WHEN m.ie_tipo_classe='G' THEN  a.vl_material  ELSE 0 END  vl_gases,
		coalesce(a.nr_doc_convenio,'Não Informada') cd_autorizacao,
		a.nr_interno_conta,
		c.nr_atendimento,
		d.dt_fim_conta,
		'N' ie_honorario,
		'7' ie_tiss_tipo_guia,
		d.cd_medico_atendimento,
		h.cd_cgc,
		a.ie_tiss_tipo_guia_desp
	from	estabelecimento h,
		classe_material m,
		material b,
		material_atend_paciente a,
		conta_paciente c,
		atendimento_paciente d
	where	a.cd_material					= b.cd_material
	and	c.nr_interno_conta				= a.nr_interno_conta
	and	a.cd_motivo_exc_conta 				is null
	and	c.ie_cancelamento				is null
	and	a.nr_seq_proc_pacote 				is null
	and	a.nr_atendimento				= d.nr_atendimento
	and	c.cd_estabelecimento				= h.cd_estabelecimento
	and	b.cd_classe_material				= m.cd_classe_material
	and	coalesce(m.ie_tipo_classe, 'X')			not in ('O','P','M')
	) x
group by	x.nr_interno_conta,
		x.cd_autorizacao,
		x.nr_atendimento,
		x.dt_fim_conta,
		x.ie_honorario,
		x.ie_tiss_tipo_guia,
		x.cd_medico_atendimento,
		x.cd_cgc_prestador,
		x.ie_tiss_tipo_guia_desp;

