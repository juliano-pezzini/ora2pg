-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_invoice_billing_v (appointment_id, dc_doctor_id, business_location_id, rate_id, benefit_level_id, ds_user, invoice_type_id, ie_charge_gap, dt_operation_start, dt_operation_end, dt_operation_duration, ie_emergency_anaesthesia, asa_grading, ds_comments, nr_interno_conta, nr_patient_id, referrer_provider_id, referrer_first_name, refferer_last_name, establishment_id, internal_account_id, authorization_id) AS select	dc_obter_conversao_externa_int(null, 'AUTORIZACAO_CONVENIO','NR_SEQ_AGENDA', (select max(x.nr_sequencia) FROM autorizacao_convenio x where x.nr_atendimento = b.nr_atendimento), 'DC') appointment_id,
			obter_conversao_externa_int(null, 'MEDICO','CD_PESSOA_FISICA', get_professional_account(a.nr_interno_conta,b.cd_medico_resp), 'DC') dc_doctor_id,
			obter_conversao_externa_int(null, 'ESTABELECIMENTO','CD_ESTABELECIMENTO', a.cd_estabelecimento, 'DC') business_location_id,
			get_dc_rate_id(b.ie_tipo_convenio,b.ie_tipo_atendimento,a.ie_tipo_atend_conta,a.cd_convenio_parametro,a.nr_interno_conta) rate_id,
			CASE WHEN coalesce(b.ie_tipo_atendimento,a.ie_tipo_atend_conta)=1 THEN 2 WHEN coalesce(b.ie_tipo_atendimento,a.ie_tipo_atend_conta)=8 THEN 1  ELSE 1 END  benefit_level_id,
			'doctor' ds_user,
			2 invoice_type_id,
			'false' ie_charge_gap,
			null dt_operation_start,
			null dt_operation_end,
			null dt_operation_duration,
			'false' ie_emergency_anaesthesia,
			null asa_grading,
			null ds_comments,
			a.nr_interno_conta nr_interno_conta,
			obter_conversao_externa_int(null, 'PESSOA_FISICA','CD_PESSOA_FISICA', b.cd_pessoa_fisica, 'DC')  nr_patient_id,
			get_provider_details(b.cd_medico_referido, b.cd_estabelecimento, null) referrer_provider_id,
			obter_dados_pf(b.cd_medico_referido,'PNG') referrer_first_name,
			obter_dados_pf(b.cd_medico_referido,'PNL') refferer_last_name,
			a.cd_estabelecimento establishment_id,
			a.nr_interno_conta internal_account_id,
			(select max(x.nr_sequencia) from autorizacao_convenio x where x.nr_atendimento = b.nr_atendimento) authorization_id
from    conta_paciente a,
        atendimento_paciente b
where  a.nr_atendimento = b.nr_atendimento;

