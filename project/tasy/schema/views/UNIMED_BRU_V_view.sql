-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW unimed_bru_v (ie_tipo_registro, nr_seq_protocolo, nr_interno_conta, cd_interno, cd_regional, nr_crm_requisitante, nr_lote, cd_senha_guia, nr_doc_convenio, ie_tipo_documento, dt_emissao, dt_entrada, dt_alta, hr_entrada, hr_alta, cd_usuario_convenio, nm_usuario_convenio, uf_medico_solicitante, cd_medico_solicitante, cd_doenca_prov, cd_doenca_def, cd_motivo_alta, ie_carater_internacao, cd_procedimento_princ, cd_tipo_acomodacao, ie_clinica, cd_medico_executor, ie_funcao_executor, cd_item, ie_cirurgia_multipla, ie_tipo_nascimento, ie_sexo, dt_nascimento, dt_mesano_referencia, qt_item, vl_item, qt_filme, vl_filme, vl_custo_operacional, vl_medico, nr_controle_trailler) AS SELECT	1 IE_TIPO_REGISTRO,
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	a.cd_interno, 
 	c.cd_regional, 
	b.nr_crm_requisitante, 
 	coalesce(c.nr_remessa,0) nr_lote,             
 	b.cd_senha_guia, 
    b.nr_doc_convenio,         
 	ie_tipo_atendimento ie_tipo_documento, 
 	a.dt_entrada dt_emissao, 
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'ddmmyyyy')  ELSE '00000000' END  dt_entrada,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy')  ELSE '00000000' END  dt_alta,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'hh24mi')  ELSE '0000' END  hr_entrada,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi')  ELSE '0000' END  hr_alta,          
 	substr(a.cd_usuario_convenio,1,15) cd_usuario_convenio,       
 	substr(a.nm_paciente,1,25) nm_usuario_convenio,      
 	a.uf_crm_medico_resp uf_medico_solicitante,    
	a.cd_conv_medico_resp cd_medico_solicitante,   
 	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END  cd_doenca_prov, 
 	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END  cd_doenca_def, 
	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE null END  cd_motivo_alta, 
 	CASE WHEN ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END  ie_carater_internacao, 
 	a.cd_proc_principal cd_procedimento_princ, 
 	CASE WHEN ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END  cd_tipo_acomodacao, 
 	CASE WHEN ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,1)  ELSE null END  ie_clinica,           
 	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN  		b.cd_interno  ELSE b.cd_medico_exec_conv END  cd_medico_executor ,            
	CASE WHEN ie_tipo_atendimento=1 THEN 	coalesce(b.cd_funcao_executor,0)  ELSE 0 END  ie_funcao_executor,            
 	b.cd_item_convenio cd_item, 
	CASE WHEN ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END  ie_cirurgia_multipla,           
 	a.ie_tipo_nascimento, 
 	a.ie_sexo,                  
 	a.dt_nascimento,      
	d.dt_mesano_referencia,         
 	sum(qt_item) qt_item, 
 	sum(vl_total_item) vl_item,                
	sum(b.qt_filme) qt_filme,                 
 	sum(b.vl_filme) vl_filme,                 
 	sum(b.vl_custo_oper) vl_custo_operacional, 
 	sum(vl_honorario) vl_medico,                 
	'' nr_controle_trailler 
FROM	Protocolo_convenio d, 
	w_interf_conta_header c, 
	w_interf_conta_item b, 
	w_interf_conta_cab a 
where	a.nr_interno_conta	= b.nr_interno_conta 
 and	a.nr_seq_protocolo	= d.nr_seq_protocolo 
 and	a.nr_seq_protocolo	= c.nr_seq_protocolo 
group by 
	a.nr_seq_protocolo, 
	a.nr_interno_conta, 
	a.cd_interno,          
 	c.cd_regional, 
	b.nr_crm_requisitante,       
 	coalesce(c.nr_remessa,0),             
 	b.cd_senha_guia, 
    b.nr_doc_convenio,         
 	ie_tipo_atendimento, 
 	a.dt_entrada,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'ddmmyyyy')  ELSE '00000000' END ,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'ddmmyyyy')  ELSE '00000000' END ,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(a.dt_entrada,'hh24mi')  ELSE '0000' END ,           
	CASE WHEN ie_tipo_atendimento=1 THEN            	 	to_char(coalesce(a.dt_alta,a.dt_entrada),'hh24mi')  ELSE '0000' END ,          
 	a.cd_usuario_convenio,       
 	substr(a.nm_paciente,1,25),      
 	a.uf_crm_medico_resp,    
	a.cd_conv_medico_resp,   
	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END ,  
 	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_cid_principal  ELSE null END ,         
	CASE WHEN ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE null END ,          
 	CASE WHEN ie_tipo_atendimento=1 THEN  coalesce(a.ie_carater_sus,1)  ELSE ' ' END , 
 	a.cd_proc_principal, 
 	CASE WHEN ie_tipo_atendimento=1 THEN  a.cd_tipo_acomodacao  ELSE null END , 
 	CASE WHEN ie_tipo_atendimento=1 THEN  coalesce(a.ie_clinica,1)  ELSE null END ,           
 	CASE WHEN coalesce(b.cd_medico_exec_conv,'0')='0' THEN  b.cd_interno  ELSE b.cd_medico_exec_conv END ,            
 	CASE WHEN ie_tipo_atendimento=1 THEN 	coalesce(b.cd_funcao_executor,0)  ELSE 0 END , 
	b.cd_item_convenio, 
 	CASE WHEN ie_tipo_atendimento=1 THEN coalesce(b.ie_via_acesso,'N')  ELSE 'N' END , 
 	a.ie_tipo_nascimento, 
 	a.ie_sexo, 
	a.dt_nascimento, 
	d.dt_mesano_referencia 

union all
 
SELECT	9 IE_TIPO_REGISTRO, 
	nr_seq_protocolo,0, 
	 '', '', '', 0, '','', 0, 
 	LOCALTIMESTAMP, '', '', 
 	'', '', '',       
 	'', '', '', '','', 0, '', 
 	'', 0, 0, '', 0, '', '', '', 
 	'', LOCALTIMESTAMP, LOCALTIMESTAMP, 0, 
 	0, 0, 0, 0, 0, '999999' 
from	w_interf_conta_Trailler;

