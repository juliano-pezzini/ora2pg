-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW cns_envio_v (ds_registro, tp_registro, nr_seq_arquivo, cd_municipio_res, nm_municipio_res, nm_arquivo, nr_seq_domicilio, cd_domicilio, nr_ficha_domicilio, dt_preenchimento, dt_inclusao_domicilio, cd_segmento, cd_area, cd_micro_area, cd_familia, cd_tipo_logradouro, ds_tipo_logradouro, nr_logradouro, ds_complemento, ds_bairro, cd_cep, nr_ddd_telefone, nr_telefone, qt_morador, qt_comodo, ie_energia, ie_esgoto, ie_tipo_domicilio, ie_destino_lixo, ie_abastecimento, ie_tratamento, cd_programa_cobertura, cd_municipio_domicilio, ds_municipio_domicilio, cd_cadastrador, cd_domicilio_municipio, nr_seq_usuario, nr_ficha_usuario, nm_usuario, cd_raca_cor, cd_sit_conjugal, cd_escolaridade, dt_nascimento, ie_sexo, nm_pai, nm_mae, nr_cns, nr_pis_pasep, nr_cpf, cd_tipo_certidao, nm_cartorio_certidao, nr_livro_certidao, nr_folha_certidao, nr_termo_certidao, dt_emissao_certidao, ie_frequenta_escola, cd_orgao_emissor_ci, nr_identidade, ds_compl_ci, sg_emissora_ci, dt_emissao_ci, nr_ctps, nr_serie_ctps, uf_emissora_ctps, dt_emissao_ctps, nr_titulo_eleitor, nr_zona, nr_secao, cd_nacionalidade, dt_entrada_pais, nr_portaria_nat, dt_naturalizacao, dt_formulario, dt_inclusao, dt_alteracao, nr_lote_usuario, cd_municipio_resi, cd_domicilio_usuario, cd_municipio_nasc, ds_municipio_nasc, cd_cbo_sus, cd_cadastrador_usuario, cd_municipio_digitacao, ie_bolsa_alimentacao, ie_prodea, nr_seq_usuario_dom, ie_siab, nm_operador) AS select	'HEADER' ds_registro,
	0 tp_registro, 
	nr_sequencia nr_seq_arquivo, 
	cd_municipio_ibge cd_municipio_res, 
	substr(obter_desc_municipio_ibge(cd_municipio_ibge),1,40) nm_municipio_res, 
	cd_municipio_ibge||to_char(LOCALTIMESTAMP, 'yymmdd')||substr(nr_seq_envio,1,6) nm_arquivo, 
	0 nr_seq_domicilio, 
	'' cd_domicilio, 
	0 nr_ficha_domicilio, 
	null dt_preenchimento, 
	null dt_inclusao_domicilio, 
	'' cd_segmento, 
	'' cd_area, 
	'' cd_micro_area, 
	'' cd_familia, 
	'' cd_tipo_logradouro, 
	'' ds_tipo_logradouro, 
	'' nr_logradouro, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	0 nr_ddd_telefone, 
	0 nr_telefone, 
	0 qt_morador, 
	0 qt_comodo, 
	0 ie_energia, 
	'' ie_esgoto, 
	'' ie_tipo_domicilio, 
	'' ie_destino_lixo, 
	'' ie_abastecimento, 
	'' ie_tratamento, 
	'' cd_programa_cobertura, 
	'' cd_municipio_domicilio, 
	'' ds_municipio_domicilio, 
	'' cd_cadastrador, 
	'' cd_domicilio_municipio, 
	0 nr_seq_usuario, 
	0 nr_ficha_usuario, 
	'' nm_usuario, 
	'' cd_raca_cor, 
	'' cd_sit_conjugal, 
	0 cd_escolaridade, 
	null dt_nascimento, 
	'' ie_sexo, 
	'' nm_pai, 
	'' nm_mae, 
	'0' nr_cns, 
	'' nr_pis_pasep, 
	'' nr_cpf, 
	'' cd_tipo_certidao, 
	'' nm_cartorio_certidao, 
	'' nr_livro_certidao, 
	'' nr_folha_certidao, 
	'' nr_termo_certidao, 
	null dt_emissao_certidao, 
	'' ie_frequenta_escola, 
	'' cd_orgao_emissor_ci, 
	'' nr_identidade, 
	'' ds_compl_ci, 
	'' sg_emissora_ci, 
	null dt_emissao_ci, 
	0 nr_ctps, 
	'0' nr_serie_ctps, 
	'' uf_emissora_ctps, 
	null dt_emissao_ctps, 
	'' nr_titulo_eleitor, 
	'' nr_zona, 
	'' nr_secao, 
	'' cd_nacionalidade, 
	null dt_entrada_pais, 
	'' nr_portaria_nat, 
	null dt_naturalizacao, 
	null dt_formulario, 
	null dt_inclusao, 
	null dt_alteracao, 
	'' nr_lote_usuario, 
	'' cd_municipio_resi, 
	'' cd_domicilio_usuario, 
	'' cd_municipio_nasc, 
	'' ds_municipio_nasc, 
	0 cd_cbo_sus, 
	'' cd_cadastrador_usuario, 
	'' cd_municipio_digitacao, 
	null ie_bolsa_alimentacao, 
	null ie_prodea, 
	'' nr_seq_usuario_dom, 
	0 ie_siab, 
	'' nm_operador 
FROM	cns_controle_envio 

union
 
select	'DOMICLIO' ds_registro, 
	2 tp_registro, 
	a.nr_sequencia nr_seq_arquivo, 
	'' cd_municipio_res, 
	'' nm_municipio_res, 
	'' nm_arquivo, 
	c.nr_sequencia nr_seq_domicilio, 
	c.cd_domicilio cd_domicilio, 
	c.nr_ficha_cadastral nr_ficha_domicilio, 
	c.dt_atualizacao_nrec dt_preenchimento, 
	c.dt_inclusao dt_inclusao_domicilio, 
	coalesce(Cns_Obter_Domicilio_Estrut(c.nr_sequencia,'S'),0) cd_segmento, 
	substr(coalesce(Cns_Obter_Domicilio_Estrut(c.nr_sequencia,'A'),0),1,4) cd_area, 
	substr(coalesce(Cns_Obter_Domicilio_Estrut(c.nr_sequencia,'M'),0),1,2) cd_micro_area, 
	substr(coalesce(Cns_Obter_Domicilio_Estrut(c.nr_sequencia,'F'),0),1,3) cd_familia, 
	Cns_Obter_Dados_Domicilio(c.nr_sequencia, 'L','C') cd_tipo_logradouro, 
	Cns_Obter_Dados_Domicilio(c.nr_sequencia, 'L','D') ds_tipo_logradouro, 
	c.nr_endereco nr_logradouro, 
	c.ds_complemento ds_complemento, 
	c.ds_bairro ds_bairro, 
	c.cd_cep cd_cep, 
	coalesce(c.nr_ddd_telefone,0) nr_ddd_telefone, 
	coalesce(c.nr_telefone,0) nr_telefone, 
	c.qt_usuario qt_morador, 
	c.qt_comodo qt_comodo, 
	CASE WHEN c.ie_energia_eletrica='N' THEN 2  ELSE 1 END  ie_energia, 
	c.ie_esgoto_sanitario ie_esgoto, 
	coalesce(c.ie_tipo_domicilio,' ') ie_tipo_domicilio, 
	coalesce(c.ie_destino_lixo,' ') ie_destino_lixo, 
	coalesce(c.ie_tipo_agua,' ') ie_abastecimento, 
	coalesce(c.ie_tratamento_agua,' ') ie_tratamento, 
	Cns_Obter_Dados_Domicilio(c.nr_sequencia, 'P','C') cd_programa_cobertura, 
	c.cd_municipio_ibge cd_municipio_domicilio, 
	obter_desc_municipio_ibge(c.cd_municipio_ibge) ds_municipio_domicilio, 
	Cns_Obter_Dados_Domicilio(c.nr_sequencia, 'C','C') cd_cadastrador, 
	c.cd_domicilio cd_domicilio_municipio, 
	0 nr_seq_usuario, 
	0 nr_ficha_usuario, 
	'' nm_usuario, 
	'' cd_raca_cor, 
	'' cd_sit_conjugal, 
	0 cd_escolaridade, 
	null dt_nascimento, 
	'' ie_sexo, 
	'' nm_pai, 
	'' nm_mae, 
	'0' nr_cns, 
	'' nr_pis_pasep, 
	'' nr_cpf, 
	'' cd_tipo_certidao, 
	'' nm_cartorio_certidao, 
	'' nr_livro_certidao, 
	'' nr_folha_certidao, 
	'' nr_termo_certidao, 
	null dt_emissao_certidao, 
	'' ie_frequenta_escola, 
	'' cd_orgao_emissor_ci, 
	'' nr_identidade, 
	'' ds_compl_ci, 
	'' sg_emissora_ci, 
	null dt_emissao_ci, 
	0 nr_ctps, 
	'0' nr_serie_ctps, 
	'' uf_emissora_ctps, 
	null dt_emissao_ctps, 
	'' nr_titulo_eleitor, 
	'' nr_zona, 
	'' nr_secao, 
	'' cd_nacionalidade, 
	null dt_entrada_pais, 
	'' nr_portaria_nat, 
	null dt_naturalizacao, 
	null dt_formulario, 
	null dt_inclusao, 
	null dt_alteracao, 
	'' nr_lote_usuario, 
	'' cd_municipio_resi, 
	'' cd_domicilio_usuario, 
	'' cd_municipio_nasc, 
	'' ds_municipio_nasc, 
	0 cd_cbo_sus, 
	'' cd_cadastrador_usuario, 
	'' cd_municipio_digitacao, 
	null ie_bolsa_alimentacao, 
	null ie_prodea, 
	'' nr_seq_usuario_dom, 
	0 ie_siab, 
	'' nm_operador 
from	cns_domicilio		c, 
	cns_domicilio_usuario	b, 
	cns_controle_envio	a 
where	a.nr_sequencia		= b.nr_seq_controle_envio 
and	b.nr_seq_domicilio	= c.nr_sequencia 

union
 
select	'USUARIO' ds_registro, 
	3 tp_registro, 
	a.nr_sequencia nr_seq_arquivo, 
	'' cd_municipio_res, 
	'' nm_municipio_res, 
	'' nm_arquivo, 
	0 nr_seq_domicilio, 
	'' cd_domicilio, 
	0 nr_ficha_domicilio, 
	null dt_preenchimento, 
	null dt_inclusao_domicilio, 
	'' cd_segmento, 
	'' cd_area, 
	'' cd_micro_area, 
	'' cd_familia, 
	'' cd_tipo_logradouro, 
	'' ds_tipo_logradouro, 
	'' nr_logradouro, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	0 nr_ddd_telefone, 
	0 nr_telefone, 
	0 qt_morador, 
	0 qt_comodo, 
	0 ie_energia, 
	'' ie_esgoto, 
	'' ie_tipo_domicilio, 
	'' ie_destino_lixo, 
	'' ie_abastecimento, 
	'' ie_tratamento, 
	'' cd_programa_cobertura, 
	'' cd_municipio_domicilio, 
	'' ds_municipio_domicilio, 
	'' cd_cadastrador, 
	'' cd_domicilio_municipio, 
	c.nr_sequencia nr_seq_usuario, 
	c.nr_ficha_cadastral nr_ficha_usuario, 
	d.nm_pessoa_fisica nm_usuario, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'CP', 'C') cd_raca_cor, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'SC', 'C') cd_sit_conjugal, 
	coalesce(d.ie_grau_instrucao,99) cd_escolaridade, 
	d.dt_nascimento dt_nascimento, 
	d.ie_sexo ie_sexo, 
	obter_compl_pf(c.cd_pessoa_fisica, 4, 'N') nm_pai, 
	obter_compl_pf(c.cd_pessoa_fisica, 5, 'N') nm_mae, 
	coalesce(d.nr_cartao_nac_sus,'0') nr_cns, 
	d.nr_pis_pasep nr_pis_pasep, 
	d.nr_cpf nr_cpf, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'TC', 'C') cd_tipo_certidao, 
	c.nm_cartorio_certidao nm_cartorio_certidao, 
	c.nr_livro_certidao nr_livro_certidao, 
	c.nr_folha_certidao nr_folha_certidao, 
	c.nr_termo_certidao nr_termo_certidao, 
	c.dt_emissao_certidao dt_emissao_certidao, 
	c.ie_frequenta_escola ie_frequenta_escola, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'O', 'C') cd_orgao_emissor_ci, 
	d.nr_identidade nr_identidade, 
	c.ds_complemento_ci ds_compl_ci, 
	d.sg_emissora_ci sg_emissora_ci, 
	d.dt_emissao_ci dt_emissao_ci, 
	d.nr_ctps nr_ctps, 
	to_char(d.nr_serie_ctps) nr_serie_ctps, 
	d.uf_emissora_ctps uf_emissora_ctps, 
	d.dt_emissao_ctps dt_emissao_ctps, 
	d.nr_titulo_eleitor nr_titulo_eleitor, 
	d.nr_zona nr_zona, 
	d.nr_secao nr_secao, 
	d.cd_nacionalidade cd_nacionalidade, 
	d.dt_chegada_brasil dt_entrada_pais, 
	coalesce(d.nr_portaria_nat,0) nr_portaria_nat, 
	d.dt_naturalizacao_pf dt_naturalizacao, 
	c.dt_formulario dt_formulario, 
	c.dt_inclusao_usuario dt_inclusao, 
	c.dt_alteracao_usuario dt_alteracao, 
	c.nr_lote_usuario nr_lote_usuario, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'MR', 'C') cd_municipio_resi, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'C', 'C') cd_domicilio_usuario, 
	--obter_municipio_ibge(d.nr_cep_cidade_nasc) cd_municipio_nasc, 
	--obter_desc_municipio_ibge(obter_municipio_ibge(d.nr_cep_cidade_nasc)) ds_municipio_nasc, 
	coalesce(obter_municipio_ibge(d.nr_cep_cidade_nasc),d.cd_municipio_ibge) cd_municipio_nasc, 
	obter_desc_municipio_ibge(coalesce(obter_municipio_ibge(d.nr_cep_cidade_nasc),d.cd_municipio_ibge)) ds_municipio_nasc, 
	d.cd_cbo_sus cd_cbo_sus, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'CA', 'C') cd_cadastrador_usuario, 
	Cns_Obter_Municipio_Digitacao(a.cd_estabelecimento, 'C') cd_municipio_digitacao, 
	CASE WHEN c.ie_bolsa_alimentacao='S' THEN 1  ELSE 0 END  ie_bolsa_alimentacao, 
	CASE WHEN c.ie_prodea='S' THEN 1  ELSE 0 END  ie_prodea, 
	Cns_Obter_Dados_Usuario(c.nr_sequencia, 'S', 'C') nr_seq_usuario_dom, 
	CASE WHEN c.ie_siab='S' THEN 1  ELSE 0 END  ie_siab, 
	substr(c.nm_usuario_nrec,1,8) nm_operador 
from	pessoa_fisica		d, 
	cns_usuario		c, 
	cns_domicilio_usuario	b, 
	cns_controle_envio	a 
where	a.nr_Sequencia		= b.nr_seq_controle_envio 
and	b.nr_seq_usuario	= c.nr_sequencia 
and	c.cd_pessoa_fisica	= d.cd_pessoa_fisica 

union
 
select	'TRAILLER' ds_registro, 
	9 tp_registro, 
	a.nr_Sequencia nr_seq_arquivo, 
	cd_municipio_ibge cd_municipio_res, 
	substr(obter_desc_municipio_ibge(cd_municipio_ibge),1,40) nm_municipio_res, 
	'' nm_arquivo, 
	0 nr_seq_domicilio, 
	'' cd_domicilio, 
	0 nr_ficha_domicilio, 
	null dt_preenchimento, 
	null dt_inclusao_domicilio, 
	'' cd_segmento, 
	'' cd_area, 
	'' cd_micro_area, 
	'' cd_familia, 
	'' cd_tipo_logradouro, 
	'' ds_tipo_logradouro, 
	'' nr_logradouro, 
	'' ds_complemento, 
	'' ds_bairro, 
	'' cd_cep, 
	0 nr_ddd_telefone, 
	0 nr_telefone, 
	0 qt_morador, 
	0 qt_comodo, 
	0 ie_energia, 
	'' ie_esgoto, 
	'' ie_tipo_domicilio, 
	'' ie_destino_lixo, 
	'' ie_abastecimento, 
	'' ie_tratamento, 
	'' cd_programa_cobertura, 
	'' cd_municipio_domicilio, 
	'' ds_municipio_domicilio, 
	'' cd_cadastrador, 
	'' cd_domicilio_municipio, 
	0 nr_seq_usuario, 
	0 nr_ficha_usuario, 
	'' nm_usuario, 
	'' cd_raca_cor, 
	'' cd_sit_conjugal, 
	0 cd_escolaridade, 
	null dt_nascimento, 
	'' ie_sexo, 
	'' nm_pai, 
	'' nm_mae, 
	'0' nr_cns, 
	'' nr_pis_pasep, 
	'' nr_cpf, 
	'' cd_tipo_certidao, 
	'' nm_cartorio_certidao, 
	'' nr_livro_certidao, 
	'' nr_folha_certidao, 
	'' nr_termo_certidao, 
	null dt_emissao_certidao, 
	'' ie_frequenta_escola, 
	'' cd_orgao_emissor_ci, 
	'' nr_identidade, 
	'' ds_compl_ci, 
	'' sg_emissora_ci, 
	null dt_emissao_ci, 
	0 nr_ctps, 
	'0' nr_serie_ctps, 
	'' uf_emissora_ctps, 
	null dt_emissao_ctps, 
	'' nr_titulo_eleitor, 
	'' nr_zona, 
	'' nr_secao, 
	'' cd_nacionalidade, 
	null dt_entrada_pais, 
	'' nr_portaria_nat, 
	null dt_naturalizacao, 
	null dt_formulario, 
	null dt_inclusao, 
	null dt_alteracao, 
	'' nr_lote_usuario, 
	'' cd_municipio_resi, 
	'' cd_domicilio_usuario, 
	'' cd_municipio_nasc, 
	'' ds_municipio_nasc, 
	0 cd_cbo_sus, 
	'' cd_cadastrador_usuario, 
	'' cd_municipio_digitacao, 
	null ie_bolsa_alimentacao, 
	null ie_prodea, 
	'' nr_seq_usuario_dom, 
	0 ie_siab, 
	'' nm_operador 
from	cns_controle_envio	a 
order by tp_registro;

