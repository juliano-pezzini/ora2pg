-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW amico_v (tp_registro, nr_seq_protocolo, cd_interno, dt_referencia, nr_interno_conta, cd_usuario_convenio, nm_paciente, cd_empresa_paciente, dt_atendimento, dt_internacao, dt_alta, cd_motivo_alta, ie_sexo, qt_idade_paciente, cd_tipo_acomodacao, ie_clinica, vl_total_conta, cd_senha, cd_centro_custo, cd_medico_solicitante, nr_crm_solicitante, cd_especialidade_solic, cd_especialidade_real, ie_motivo_encaminhamento, cd_cid, ie_processamento, dt_processamento, cd_servico, dt_execucao, cd_setor_atendimento, ie_urgencia, qt_servico, vl_servico, dt_entrada) AS select	1 tp_registro,
	a.nr_seq_protocolo, 
 	a.cd_interno, 
	trunc(d.dt_mesano_referencia) dt_referencia, 
	a.nr_interno_conta, 
 	substr(a.cd_usuario_convenio,1,9) cd_usuario_convenio,       
	substr(a.nm_paciente,1,50) nm_paciente, 
	0 cd_empresa_paciente, 
	to_char(a.dt_entrada,'ddmmyyyyhh24mi') dt_atendimento, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN  	 	to_char(a.dt_entrada,'ddmmyyyy')  ELSE '00000000' END  dt_internacao, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN  	 	to_char(a.dt_alta,'ddmmyyyy')  ELSE '00000000' END  dt_alta, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_motivo_alta  ELSE 0 END  cd_motivo_alta, 
 	a.ie_sexo, 
	somente_numero(obter_idade(a.dt_nascimento,LOCALTIMESTAMP,'A')) qt_idade_paciente, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.cd_tipo_acomodacao  ELSE 0 END  cd_tipo_acomodacao, 
	CASE WHEN a.ie_tipo_atendimento=1 THEN a.ie_clinica  ELSE 0 END  ie_clinica, 
	x.vl_total_conta, 
	substr(a.nr_doc_convenio,1,8) cd_senha, 
	0 cd_centro_custo, 
	0 cd_medico_solicitante, 
	somente_numero(coalesce(a.nr_crm_medico_resp,0)) nr_crm_solicitante, 
	coalesce(somente_numero(obter_especialidade_medico(cd_medico_resp,'C')),0) cd_especialidade_solic, 
	coalesce(somente_numero(obter_especialidade_medico(cd_medico_resp,'C')),0) cd_especialidade_real, 
	a.ie_tipo_atendimento ie_motivo_encaminhamento, 
	substr(a.cd_cid_principal,1,4) cd_cid, 
	' ' ie_processamento, 
	0 dt_processamento, 
	0 cd_servico, 
	LOCALTIMESTAMP dt_execucao, 
	0 cd_setor_atendimento, 
	' ' ie_urgencia, 
	0 qt_servico, 
	0 vl_servico, 
	a.dt_entrada 
FROM	Protocolo_convenio d, 
	w_interf_conta_total x, 
	w_interf_conta_cab a 
where	a.nr_seq_protocolo	= d.nr_seq_protocolo 
 and	a.nr_interno_conta	= x.nr_interno_conta 

union all
 
select	2 tp_registro, 
	a.nr_seq_protocolo, 
 	a.cd_interno, 
	trunc(d.dt_mesano_referencia) dt_referencia, 
	a.nr_interno_conta, 
 	' ' cd_usuario_convenio,       
	substr(a.nm_paciente,1,50) nm_paciente, 
	0 cd_empresa_paciente, 
	' ' dt_atendimento, 
	' ' dt_internacao, 
	' ' dt_alta, 
	0 cd_motivo_alta, 
 	' ' ie_sexo, 
	0 qt_idade_paciente, 
	0 cd_tipo_acomodacao, 
	0 ie_clinica, 
	0 vl_total_conta, 
	' ' cd_senha, 
	0 cd_centro_custo, 
	0 cd_medico_solicitante, 
	0 nr_crm_solicitante, 
	0 cd_especialidade_solic, 
	0 cd_especialidade_real, 
	0 ie_motivo_encaminhamento, 
	' ' cd_cid, 
	' ' ie_processamento, 
	0 dt_processamento, 
	somente_numero(coalesce(b.cd_item_convenio,0)) cd_servico, 
	trunc(b.dt_item) dt_execucao, 
	0 cd_setor_atendimento, 
	CASE WHEN b.pr_hora_extra=0 THEN 'N' WHEN b.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END  ie_urgencia, 
	sum(b.qt_item) qt_servico, 
    --sum(decode(b.ie_responsavel_credito,'M',0,'RM',b.vl_honorario,b.vl_total_item)) vl_servico, 
	sum(b.vl_total_item) vl_servico, 
	a.dt_entrada 
from	Protocolo_convenio d, 
	w_interf_conta_total x, 
	w_interf_conta_item b, 
	w_interf_conta_cab a 
where	a.nr_seq_protocolo	= d.nr_seq_protocolo 
 and	a.nr_interno_conta	= x.nr_interno_conta 
 and	a.nr_interno_conta	= b.nr_interno_conta 
group by 
	a.dt_entrada, 
	a.nr_seq_protocolo, 
 	a.cd_interno, 
	trunc(d.dt_mesano_referencia), 
	a.nr_interno_conta, 
	substr(a.nm_paciente,1,50), 
 	somente_numero(coalesce(b.cd_item_convenio,0)), 
	trunc(b.dt_item), 
	CASE WHEN b.pr_hora_extra=0 THEN 'N' WHEN b.pr_hora_extra IS NULL THEN 'N'  ELSE 'S' END;

