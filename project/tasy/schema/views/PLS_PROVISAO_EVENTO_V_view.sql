-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_provisao_evento_v (nm_pessoa, cd_cgc_cpf, ds_tipo_prestador, nr_titulo, nr_lote_pagamento, dt_vencimento_atual, cd_conta_contabil, nr_seq_protocolo, dt_recebimento, cd_carteira, nm_segurado, vl_saldo_titulo, dt_movimento, ds_classificacao_pei, ds_classificacao_diops, dt_liquidacao, dt_emissao, nr_titulo_pagar, vl_saldo_tit) AS select 	nm_pessoa,
		cd_cgc_cpf, 
		ds_tipo_prestador, 
		(nr_titulo || CASE WHEN nr_bordero IS NULL THEN  null  ELSE '/' || nr_bordero END ) nr_titulo, 
		nr_lote_pagamento, 
		dt_vencimento_atual, 
		cd_conta_contabil, 
		nr_seq_protocolo, 
		dt_recebimento, 
		cd_carteira, 
		nm_segurado, 
		vl_saldo_titulo, 
		dt_movimento, 
		ds_classificacao_pei, 
		ds_classificacao_diops, 
		dt_liquidacao, 
		dt_emissao, 
		nr_titulo_pagar, 
		obter_saldo_titulo_pagar(nr_titulo_pagar, dt_emissao) vl_saldo_tit 
	FROM (	select 	substr(trim(both b.nm_pessoa_fisica), 1, 30) nm_pessoa, 
			CASE WHEN b.nr_cpf IS NULL THEN  ''  ELSE regexp_replace(lpad(b.nr_cpf, 11, '0'),'([0-9]{3})([0-9]{3})([0-9]{3})([0-9]{2})','\1.\2.\3-\4') END  cd_cgc_cpf, 
			substr(pls_obter_dados_prestador(d.nr_sequencia, 'TR'), 1, 20) ds_tipo_prestador, 
			a.nr_titulo, 
			coalesce(a.nr_bordero,(	select	max(x.nr_bordero) 
						from 	bordero_tit_pagar 	x 
						where 	x.nr_titulo		= a.nr_titulo)) nr_bordero, 
			e.nr_seq_lote nr_lote_pagamento, 
			a.dt_vencimento_atual, 
			c.cd_conta_contabil, 
			g.nr_sequencia nr_seq_protocolo, 
			g.dt_recebimento, 
			CASE WHEN pls_obter_carteira_segurado(h.nr_seq_segurado)='0' THEN  ''  ELSE regexp_replace(lpad(pls_obter_carteira_segurado(h.nr_seq_segurado), 15, '0'), '([0-9]{3})([0-9]{4})([0-9]{6})([0-9]{2})','\1.\2.\3-\4') END  cd_carteira, 
			substr(trim(both pls_obter_dados_segurado(h.nr_seq_segurado, 'N')), 1, 30) nm_segurado, 
			a.vl_saldo_titulo, 
			i.dt_movimento, 
			case when(g.dt_recebimento is not null) then 
				case when (g.dt_recebimento >= (LOCALTIMESTAMP - interval '30 days')) then 
					'Avisado nos últimos 30 dias' 
				else 
					'Avisado há mais de 30 dias' 
				end 
			end ds_classificacao_pei,				 
			case 	when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '120 days')) then 
					'Venc. a mais de 120 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '90 days')) then 
					'Venc. a mais de 90 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '60 days')) then 
					'Venc. a mais de 60 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '30 days')) then 
					'Venc. a mais de 30 dias' 
				when 	((a.dt_vencimento_atual is null) or (a.dt_vencimento_atual >= LOCALTIMESTAMP)) then 
					'A vencer' 
			end ds_classificacao_diops, 
			a.dt_liquidacao, 
			a.dt_emissao, 
			a.nr_titulo nr_titulo_pagar 
		from 	pls_conta_medica_resumo 		j, 
			movimento_contabil 			i, 
			pls_conta 				h, 
			pls_protocolo_conta 			g, 
			pls_pag_prest_vencimento 		f, 
			pls_pagamento_prestador 		e, 
			pls_prestador				d, 
			titulo_pagar_classif 			c, 
			pessoa_fisica 				b, 
			titulo_pagar 				a 
		where 	a.cd_pessoa_fisica			= b.cd_pessoa_fisica 
		and 	a.nr_titulo				= c.nr_titulo 
		and 	b.cd_pessoa_fisica			= d.cd_pessoa_fisica 
		and 	d.nr_sequencia				= e.nr_seq_prestador 
		and 	e.nr_sequencia				= f.nr_seq_pag_prestador 
		and 	d.nr_sequencia				= g.nr_seq_prestador 
		and 	g.nr_sequencia				= h.nr_seq_protocolo 
		and 	d.nr_sequencia				= h.nr_seq_prestador 
		and 	e.nr_seq_lote				= j.nr_seq_lote_pgto 
		and 	c.cd_conta_contabil			= i.cd_conta_contabil 
		and 	a.nr_titulo				= f.nr_titulo 
		
union all
 
		select 	substr(trim(both b.nm_fantasia),1,30)nm_pessoa, 
			CASE WHEN a.cd_cgc IS NULL THEN  ''  ELSE regexp_replace(lpad(a.cd_cgc, 15, '0'), '([0-9]{3})([0-9]{3})([0-9]{3})([0-9]{4})([0-9]{2})','\1.\2.\3/\4-\5') END  cd_cgc_cpf, 
			substr(pls_obter_dados_prestador(d.nr_sequencia, 'TR'), 1, 20) ds_tipo_prestador, 
			a.nr_titulo, 
			coalesce(a.nr_bordero,(	select	max(x.nr_bordero) 
						from	bordero_tit_pagar	x 
						where	x.nr_titulo		= a.nr_titulo)) nr_bordero, 
			e.nr_seq_lote nr_lote_pagamento, 
			a.dt_vencimento_atual, 
			c.cd_conta_contabil, 
			g.nr_sequencia nr_seq_protocolo, 
			g.dt_recebimento, 
			CASE WHEN pls_obter_carteira_segurado(h.nr_seq_segurado)='0' THEN  ''  ELSE regexp_replace(lpad(pls_obter_carteira_segurado(h.nr_seq_segurado), 15, '0'), '([0-9]{3})([0-9]{4})([0-9]{6})([0-9]{2})','\1.\2.\3-\4') END  cd_carteira, 
			substr(trim(both pls_obter_dados_segurado(h.nr_seq_segurado, 'N')), 1, 30) nm_segurado, 
			a.vl_saldo_titulo, 
			i.dt_movimento, 
			case when(g.dt_recebimento is not null) then 
				case when (g.dt_recebimento >= (LOCALTIMESTAMP - interval '30 days')) then 
					'Avisado nos últimos 30 dias.' 
				else 
					'Avisado há mais de 30 dias.' 
				end 
			end ds_classificacao_pei, 
			case 	when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '120 days')) then 
					'Venc. a mais de 120 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '90 days')) then 
					'Venc. a mais de 90 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '60 days')) then 
					'Venc. a mais de 60 dias' 
				when 	(a.dt_vencimento_atual < (LOCALTIMESTAMP - interval '30 days')) then 
					'Venc. a mais de 30 dias' 
				when 	((a.dt_vencimento_atual is null) or (a.dt_vencimento_atual >= LOCALTIMESTAMP)) then 
					'A vencer' 
			end ds_classificacao_diops, 
			a.dt_liquidacao, 
			a.dt_emissao, 
			a.nr_titulo nr_titulo_pagar 
		from 	pls_conta_medica_resumo 		j, 
			movimento_contabil 			i, 
			pls_conta 				h, 
			pls_protocolo_conta 			g, 
			pls_pag_prest_vencimento 		f, 
			pls_pagamento_prestador 		e, 
			pls_prestador 				d, 
			titulo_pagar_classif 			c, 
			pessoa_juridica 			b, 
			titulo_pagar 				a 
		where 	a.cd_cgc				= b.cd_cgc 
		and 	a.nr_titulo				= c.nr_titulo 
		and 	b.cd_cgc				= d.cd_cgc 
		and 	d.nr_sequencia				= e.nr_seq_prestador 
		and 	e.nr_sequencia				= f.nr_seq_pag_prestador 
		and 	d.nr_sequencia				= g.nr_seq_prestador 
		and 	g.nr_sequencia				= h.nr_seq_protocolo 
		and 	d.nr_sequencia				= h.nr_seq_prestador 
		and 	e.nr_seq_lote				= j.nr_seq_lote_pgto 
		and 	c.cd_conta_contabil			= i.cd_conta_contabil 
		and 	a.nr_titulo				= f.nr_titulo) alias62 
	group by nm_pessoa, 
		cd_cgc_cpf, 
		ds_tipo_prestador, 
		nr_bordero, 
		nr_titulo, 
		nr_lote_pagamento, 
		dt_vencimento_atual, 
		cd_conta_contabil, 
		nr_seq_protocolo, 
		dt_recebimento, 
		cd_carteira, 
		nm_segurado, 
		vl_saldo_titulo, 
		dt_movimento, 
		ds_classificacao_pei, 
		ds_classificacao_diops, 
		dt_liquidacao, 
		dt_emissao, 
		nr_titulo_pagar;

