-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW egresos_validador_v (nr_atendimento, cedocve, cjurcve, cmpocve, cloccve, ctuncve, clues, folio, egreso, ingre, dias_esta, tuhpsiq, servhc, servhp, tipserv, servicioingre, servicio02, servicio03, servicioegre, sa_labor, sa_expul, sa_recup, sa_inten, sa_interm, proced, cluesproced, cluesreferido, motegre, diag_ini, afecprin, vez, infec, traumat, lugar, cedularesp, nm_medico, derhab, paterno, materno, nombre, cveedad, edad, nacioen, sexo, peso, talla, spss, spss_dv, entidad, munic, loc, expediente, curp, indigena, habla_lengua, lengua_indigena, habla_esp, cd_doenca, promed, anest, quirof, qh, qm, cedulacirujano, mp, certif, causaia, cvetiemia, tiempoia, causaib, cvetiemib, tiempoib, causaic, cvetiemic, tiempoic, causaid, cvetiemid, tiempoid, causaiia, cvetiemiia, tiempoiia, causaiib, cvetiemiib, tiempoiib, gestas, partos, abortos, hayprod, tipaten, gestac, producto, ie_parto_normal, ie_parto_forceps, ie_parto_cesaria, planfam, numproducto, pesoprod, sexprod, condegre, certificado, nr_dfm, nr_dnv, naviapag, navirean, navicune, cd_procedencia, cd_medico_resp, cd_cgc_convenio, cd_pessoa_fisica, cd_medico_cirurgiao) AS SELECT a.nr_atendimento,
	coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_ESTADO'),2,'0'),'00') CEDOCVE,--887583
	coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_JURISDICAO'),2,'0'),'00') CJURCVE,
	coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_MUNICIPIO'),3,'0'),'00') CMPOCVE,
	coalesce(LPAD(obter_dados_cat_clues(c.cd_internacional,'CD_LOCALIDADE'),4,'0'),'00') CLOCCVE,
	obter_dados_cat_clues(c.cd_internacional,'IE_TIPO_UNIDADE') CTUNCVE,
	SUBSTR(coalesce(obter_dados_cat_clues(c.cd_internacional,'CD_CLUES'),c.cd_cgc),1,11) CLUES,
	a.nr_atendimento FOLIO,
	a.dt_alta EGRESO,
	a.dt_entrada INGRE,
	(TO_DATE(a.dt_alta, 'dd/mm/yyyy') - TO_DATE(a.dt_entrada, 'dd/mm/yyyy')) + 1 DIAS_ESTA,
	RPAD(coalesce(a.ie_clinica,'-1'),3,' ') TUHPSIQ,
	CASE WHEN coalesce(cm.ie_serv_psiq_cont,0)=0 THEN 0  ELSE cm.ie_serv_psiq_cont END  SERVHC,
	CASE WHEN coalesce(cm.ie_serv_psiq_par,0)=0 THEN 0  ELSE cm.ie_serv_psiq_par END  SERVHP,
	coalesce(a.ie_tipo_serv_mx,1) TIPSERV,
	RPAD(CASE WHEN coalesce(a.cd_serv_entrada_mx,0)=0 THEN '   '  ELSE a.cd_serv_entrada_mx END ,3) SERVICIOINGRE,
	RPAD(CASE WHEN coalesce(a.cd_serv_sec_mx,0)=0 THEN '   '  ELSE a.cd_serv_sec_mx END ,3) SERVICIO02,
	RPAD(CASE WHEN coalesce(a.cd_serv_ter_mx,0)=0 THEN '   '  ELSE a.cd_serv_ter_mx END ,3) SERVICIO03,
	RPAD(CASE WHEN coalesce(a.cd_serv_alta_mx,0)=0 THEN '113'  ELSE a.cd_serv_alta_mx END ,3) SERVICIOEGRE,
	LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,12),'   '),3,'0') SA_LABOR,
	LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,13),'   '),3,'0') SA_EXPUL,
	LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,14),'   '),3,'0') SA_RECUP,
	LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,15),'    '),4,'0') SA_INTEN,
	LPAD(coalesce(obter_horas_atend_unidade(a.nr_atendimento,16),'    '),4,'0') SA_INTERM,
	SUBSTR(CASE WHEN coalesce(a.cd_procedencia,'0')='0' THEN ' '  ELSE a.cd_procedencia END ,1,1) PROCED,
	coalesce(obter_dados_cat_clues(
				(SELECT x.cd_internacional
				FROM pessoa_juridica x
				WHERE x.cd_cgc = i.cd_cgc_procedencia),'CD_CLUES'),'           ') CLUESPROCED,
	coalesce(obter_dados_cat_clues(
				(SELECT x.cd_internacional
				FROM pessoa_juridica x
				WHERE x.cd_cgc = t.cd_cgc),'CD_CLUES'),'           ') CLUESREFERIDO,
	coalesce(
	(SELECT CD_EXTERNO
		FROM MOTIVO_ALTA X
		WHERE x.CD_MOTIVO_ALTA = A.CD_MOTIVO_ALTA),'9') MOTEGRE,
	RPAD(CASE WHEN coalesce(obter_cid_atendimento(a.nr_atendimento, 'S'),'X')='X' THEN '    '  ELSE obter_cid_atendimento(a.nr_atendimento, 'S') END ,4) DIAG_INI,
	RPAD(CASE WHEN coalesce(obter_cid_atendimento(a.nr_atendimento, 'P'),'X')='X' THEN '    '  ELSE obter_cid_atendimento(a.nr_atendimento, 'P') END ,4) AFECPRIN,
	CASE WHEN(SELECT COUNT(t.cd_doenca)		FROM diagnostico_doenca t, atendimento_paciente u		WHERE t.dt_diagnostico BETWEEN LOCALTIMESTAMP - interval '365 days' AND LOCALTIMESTAMP		AND t.nr_atendimento = u.nr_atendimento		AND u.nr_atendimento <> a.nr_atendimento		AND u.cd_pessoa_fisica = a.cd_pessoa_fisica		AND t.cd_doenca = obter_cid_atendimento(a.nr_atendimento, 'P'))='0' THEN '1'  ELSE '2' END  VEZ,
	CASE WHEN(SELECT COUNT(1)		FROM atendimento_precaucao x		WHERE x.nr_atendimento = a.nr_atendimento)='0' THEN '2'  ELSE '1' END  INFEC,
	coalesce(a.nr_seq_tipo_acidente,'9') TRAUMAT,
	coalesce(obter_dados_cat_lugar_acc(a.cd_lugar_acc,'CD_LUGAR_ACC'),'9') LUGAR,
	LPAD(coalesce(e.ds_codigo_prof,'0'),15,'0') CEDULARESP,
	RPAD(e.nm_pessoa_fisica,250) nm_medico,
	RPAD(CASE WHEN coalesce(g.cd_tipo_convenio_mx,9)=9 THEN '9'  ELSE g.cd_tipo_convenio_mx END ,2) DERHAB,--951133
	RPAD(CASE WHEN coalesce(xx.ds_family_name,'X')='X' THEN ' '  ELSE xx.ds_family_name END ,15) PATERNO,
	RPAD(CASE WHEN coalesce(xx.ds_component_name_1,'X')='X' THEN ' '  ELSE xx.ds_component_name_1 END ,15) MATERNO,
	RPAD(CASE WHEN coalesce(xx.ds_given_name,'X')='X' THEN ' '  ELSE xx.ds_given_name END ,25) NOMBRE,
	'3' CVEEDAD,
	TRUNC(pkg_date_utils.get_diffdate(d.dt_nascimento, LOCALTIMESTAMP, 'YEAR')) EDAD,
	CASE WHEN(SELECT coalesce(f.ie_local_nascimento,'99')		FROM parto f		WHERE f.nr_atendimento = a.nr_atendimento)='01' THEN '1' WHEN(SELECT coalesce(f.ie_local_nascimento,'99')		FROM parto f		WHERE f.nr_atendimento = a.nr_atendimento)='02' THEN '1' WHEN(SELECT coalesce(f.ie_local_nascimento,'99')		FROM parto f		WHERE f.nr_atendimento = a.nr_atendimento)='99' THEN '9'  ELSE '2' END  NACIOEN,
	CASE WHEN d.ie_sexo='M' THEN  1 WHEN d.ie_sexo='F' THEN  2  ELSE 9 END  SEXO,
	coalesce(
		(SELECT SUBSTR(ELIMINA_CARACTERE_ESPECIAL(d.qt_peso),1,3)
		FROM atendimento_sinal_vital
		WHERE nr_sequencia =
			(SELECT MAX(nr_sequencia)
			FROM atendimento_sinal_vital
			WHERE nr_atendimento = a.nr_atendimento)), SUBSTR(ELIMINA_CARACTERE_ESPECIAL(d.qt_peso),1,3)) PESO,
	d.qt_altura_cm TALLA,
	SUBSTR(RPAD(d.nr_spss,10,' '),1,10) SPSS,
	CASE WHEN g.cd_tipo_convenio_mx=11 THEN  d.nr_spss WHEN g.cd_tipo_convenio_mx=9 THEN  d.nr_spss  ELSE 'SEMVALOR' END   SPSS_DV,
	LPAD(obter_dados_cat_localidade(h.nr_seq_localizacao_mx,'CD_EFE'),2,'0') ENTIDAD,
	LPAD(obter_dados_cat_localidade(h.nr_seq_localizacao_mx,'CD_CAT_MUNICIPIO'),3,'0') MUNIC,
	LPAD(obter_dados_cat_localidade(h.nr_seq_localizacao_mx,'CD_CAT_LOCALIDADE'),4,'0') LOC,
	LPAD(d.nr_prontuario,13,'0') EXPEDIENTE,
	LPAD(CASE WHEN coalesce(d.cd_curp,'0')='0' THEN ' '  ELSE d.cd_curp END ,18,'0') CURP,
	CASE WHEN d.nr_seq_cor_pele IS NULL THEN  1  ELSE 2 END  INDIGENA,
	CASE WHEN coalesce(d.nr_seq_lingua_indigena,'2')='2' THEN '2'  ELSE '1' END  HABLA_LENGUA,
  substr((CASE WHEN coalesce(obter_dados_cat_lingua_indig(d.nr_seq_lingua_indigena,'CD_LINGUA_INDIGENA_MF'),'9999')='9999' THEN ' '  ELSE (obter_dados_cat_lingua_indig(d.nr_seq_lingua_indigena,'CD_LINGUA_INDIGENA_MF')) END ),1,4) LENGUA_INDIGENA,
	CASE WHEN d.ie_fluencia_portugues='F' THEN 1 WHEN d.ie_fluencia_portugues='R' THEN 1  ELSE 2 END  HABLA_ESP, --949006
	(SELECT MAX(x.cd_doenca)
	FROM diagnostico_doenca x
	WHERE x.nr_atendimento = a.nr_atendimento) CD_DOENCA, -- 949194
	RPAD(y.nr_seq_proc_interno,4) PROMED,
	CASE WHEN coalesce(y.cd_tipo_anestesia,'0')='0' THEN ' '  ELSE y.cd_tipo_anestesia END  ANEST,
	'1' quirof,
	LPAD(round((coalesce(nr_min_duracao_real,0)/60)::numeric,0),2,'0') QH,
	LPAD(MOD(coalesce(nr_min_duracao_real,0),60),2,'0') QM,
	LPAD(z.ds_codigo_prof,15,'0') CEDULACIRUJANO, --949639
	CASE WHEN(SELECT COUNT(1)		FROM declaracao_obito x		WHERE x.nr_atendimento = a.nr_atendimento)=0 THEN 2  ELSE 1 END  MP,
	dco.nr_declaracao CERTIF,
	dco.cd_cid_direta CAUSAIA,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_direta))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMIA,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_direta))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOIA,
	dco.cd_cid_adic_1 CAUSAIB,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END 
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_1))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMIB,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_1))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOIB,
	dco.cd_cid_adic_2 CAUSAIC,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END 
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_2))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMIC,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_2))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOIC,
	dco.cd_cid_adic_3 CAUSAID,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END 
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_3))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMID,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_3))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOID,
	dco.cd_cid_adic_4 CAUSAIIA,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END 
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_4))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMIIA,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_adic_4))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOIIA,
	dco.cd_cid_basica CAUSAIIB,
	(SELECT CASE WHEN f.ie_unidade_tempo='D' THEN 3 WHEN f.ie_unidade_tempo='M' THEN 5 WHEN f.ie_unidade_tempo='A' THEN '6'  ELSE '9' END 
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_basica))
	AND f.nr_atendimento = a.nr_atendimento) CVETIEMIIB,
	(SELECT f.qt_tempo
	FROM diagnostico_doenca f
	WHERE UPPER(trim(both f.cd_doenca)) = UPPER(trim(both dco.cd_cid_basica))
	AND f.nr_atendimento = a.nr_atendimento) TIEMPOIIB, --950349
	coalesce(ag.qt_gestacoes,'0') GESTAS,
	coalesce((ag.qt_parto_normal + ag.qt_parto_cesario),0) PARTOS,
	coalesce(ag.qt_abortos,0) ABORTOS,
	CASE WHEN(SELECT COUNT(1)		FROM parto p		WHERE p.nr_atendimento = a.nr_atendimento)=0 THEN 2  ELSE 1 END  HAYPROD,
	CASE WHEN(SELECT COUNT(1)		FROM nascimento n		WHERE n.nr_atendimento = a.nr_atendimento		AND n.nr_dfm IS NOT NULL)=0 THEN 2  ELSE 1 END  TIPATEN,
	LPAD(coalesce((CASE
		WHEN coalesce(pp.qt_ig_sem, pp.qt_ig_sem_us) < 21 THEN 22
		WHEN coalesce(pp.qt_ig_sem, pp.qt_ig_sem_us) > 45 THEN 44
		ELSE coalesce(pp.qt_ig_sem, pp.qt_ig_sem_us)
		END),'99'),2,'0') GESTAC,
	CASE WHEN pp.nr_feto=1 THEN 1  ELSE 2 END  PRODUCTO,
	pa.ie_parto_normal,
	pa.ie_parto_forceps,
	pa.ie_parto_cesaria,
	coalesce(
	(SELECT MAX(h.ds_metodos_contrac)
		FROM historico_saude_mulher h
		WHERE h.cd_pessoa_fisica = a.cd_pessoa_fisica),'4') PLANFAM,--954145
	ns.nr_sequencia NUMPRODUCTO,
	LPAD((CASE
		WHEN ns.qt_peso < 500 THEN 501
		WHEN ns.qt_peso > 6000 THEN 5999
		ELSE ns.qt_peso
	END),4,'0') PESOPROD,
	CASE WHEN coalesce(ns.ie_sexo,'X')='M' THEN '1' WHEN coalesce(ns.ie_sexo,'X')='F' THEN '2'  ELSE '9' END  SEXPROD,
	CASE WHEN coalesce((ns.ie_situacao_rn)::numeric ,'0')='0' THEN '9'  ELSE (ns.ie_situacao_rn)::numeric  END  CONDEGRE,
	LPAD(ns.nr_dnv,9,'0') CERTIFICADO,
	ns.nr_dfm,
	ns.nr_dnv,
	RPAD((coalesce(ns.qt_apgar_quinto_min,0))::numeric ,2) NAVIAPAG,
	CASE WHEN ns.ie_massag_cardiaca='S' THEN '1'  ELSE '2' END  NAVIREAN,
	RPAD(coalesce(Obter_Data_RN_Setor(a.nr_atendimento),'0'),3) NAVICUNE,
	a.cd_procedencia CD_PROCEDENCIA,
	a.cd_medico_resp CD_MEDICO_RESP,
	g.cd_convenio CD_CGC_CONVENIO,
	E.CD_PESSOA_FISICA CD_PESSOA_FISICA,
	y.CD_MEDICO_CIRURGIAO CD_MEDICO_CIRURGIAO
FROM pessoa_fisica e, pessoa_juridica c, estabelecimento b, atendimento_paciente a
LEFT OUTER JOIN atend_categoria_convenio f ON (a.nr_atendimento = f.nr_atendimento)
LEFT OUTER JOIN procedencia i ON (a.cd_procedencia = i.cd_procedencia)
LEFT OUTER JOIN atendimento_transf t ON (a.nr_atendimento = t.nr_atendimento)
LEFT OUTER JOIN cirurgia y ON (a.nr_atendimento = y.nr_atendimento)
LEFT OUTER JOIN declaracao_obito dco ON (a.nr_atendimento = dco.nr_atendimento)
LEFT OUTER JOIN atendimento_gravidez ag ON (a.nr_atendimento = ag.nr_atendimento)
LEFT OUTER JOIN parto pa ON (a.nr_atendimento = pa.nr_atendimento)
LEFT OUTER JOIN pre_parto pp ON (a.nr_atendimento = pp.nr_atendimento)
LEFT OUTER JOIN nascimento ns ON (a.nr_atendimento = ns.nr_atendimento)
LEFT OUTER JOIN complemento_mexico cm ON (a.nr_atendimento = cm.nr_atendimento)
LEFT OUTER JOIN convenio g ON (f.cd_convenio = g.cd_convenio)
LEFT OUTER JOIN pessoa_fisica z ON (y.cd_medico_cirurgiao = z.cd_pessoa_fisica)
, pessoa_fisica d
LEFT OUTER JOIN compl_pessoa_fisica h ON (d.cd_pessoa_fisica = h.cd_pessoa_fisica)
LEFT OUTER JOIN person_name xx ON (d.nr_seq_person_name = xx.nr_sequencia AND 'main' = xx.ds_type)
WHERE a.dt_alta IS NOT NULL AND a.cd_estabelecimento = b.cd_estabelecimento AND b.cd_cgc = c.cd_cgc    AND e.cd_pessoa_fisica = a.cd_medico_resp  AND a.cd_pessoa_fisica = d.cd_pessoa_fisica  AND h.ie_tipo_complemento = 1      AND dco.dt_inativacao is null AND dco.dt_liberacao is not null;

