-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_ocorrencias_guia_v (ie_tipo_ocorrencia, ds_pago, ie_pago, nr_seq_prestador_exec, ds_prestador, cd_guia, ds_tipo_guia, ie_tipo_guia, cd_prestador, ds_preco, ie_preco, cd_usuario_plano, cd_procedimento, ds_procedimento, qt_apresentada, qt_contestada, qt_procedimento, tx_item, cd_ocorrencia, dt_mes_competencia, nr_seq_ocorrencia, nr_seq_grupo_receita, nr_seq_estrutura, nr_seq_material) AS select	1 ie_tipo_ocorrencia,	/* View criada para rel. CUNI227, ao alterar testar o relatório */
	CASE WHEN a.ie_status='6' THEN 'Pago'  ELSE 'Não pago' END  ds_pago, /* seleciona as ocorrencias de contas, procedimentos e materiais */
 
	a.ie_status ie_pago, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,80) ds_prestador, 
	coalesce(b.cd_guia_referencia,b.cd_guia) cd_guia, 
	substr(obter_valor_dominio(1746,b.ie_tipo_guia),1,255) ds_tipo_guia, 
	a.ie_tipo_guia ie_tipo_guia, 
	c.cd_prestador cd_prestador, 
	substr(pls_obter_formacao_plano_seg(b.nr_seq_segurado),1,120) ds_preco, 
	i.ie_preco ie_preco, 
	d.cd_usuario_plano cd_usuario_plano, 
	null cd_procedimento, 
	'Ocorrência na guia' ds_procedimento, 
	null qt_apresentada, 
	null qt_contestada, 
	null qt_procedimento, 
	null tx_item, 	 
	g.cd_ocorrencia cd_ocorrencia, 
	trunc(a.dt_mes_competencia,'month') dt_mes_competencia, 
	g.nr_sequencia nr_seq_ocorrencia, 
	null nr_seq_grupo_receita, 
	null nr_seq_estrutura, 
	null nr_seq_material 
FROM	pls_protocolo_conta 	a, 
	pls_conta		b, 
	pls_prestador		c, 
	pls_segurado_carteira	d, 
	pls_ocorrencia_benef f, 
	pls_ocorrencia g, 
	pls_plano i 
where 	0=0 
and	b.nr_seq_protocolo	= a.nr_sequencia 
and	b.nr_seq_prestador_exec	= c.nr_sequencia 
and	b.nr_seq_segurado	= d.nr_seq_segurado 
and	f.nr_seq_conta		= b.nr_sequencia 
and	g.nr_sequencia		= f.nr_seq_ocorrencia 
and	i.nr_sequencia		= b.nr_seq_plano 
and	f.ie_situacao		= 'A' 
and	f.nr_seq_conta_proc	is null 
and	f.nr_seq_conta_mat	is null 
and	a.ie_status in (2,3,4,5,6) 

union all
 
select	2 ie_tipo_ocorrencia, 
	CASE WHEN a.ie_status='6' THEN 'Pago'  ELSE 'Não pago' END  ds_pago, 
	a.ie_status ie_pago, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,80) ds_prestador, 
	coalesce(b.cd_guia_referencia,b.cd_guia) cd_guia, 
	substr(obter_valor_dominio(1746,b.ie_tipo_guia),1,255) ds_tipo_guia, 
	a.ie_tipo_guia ie_tipo_guia, 
	c.cd_prestador cd_prestador, 
	substr(pls_obter_formacao_plano_seg(b.nr_seq_segurado),1,120) ds_preco, 
	i.ie_preco ie_preco, 
	d.cd_usuario_plano cd_usuario_plano, 
	to_char(e.cd_procedimento) cd_procedimento, 
	substr(obter_descricao_procedimento(e.cd_procedimento,e.ie_origem_proced),1,255) ds_procedimento, 
	e.qt_procedimento_imp qt_apresentada, 
	(e.qt_procedimento_imp - e.qt_procedimento) qt_contestada, 
	e.qt_procedimento qt_procedimento, 
	e.tx_item tx_item, 	 
	g.cd_ocorrencia cd_ocorrencia, 
	trunc(a.dt_mes_competencia,'month') dt_mes_competencia, 
	g.nr_sequencia nr_seq_ocorrencia, 
	h.nr_seq_grupo_rec nr_seq_grupo_receita, 
	null nr_seq_estrutura, 
	null nr_seq_material 
from	pls_protocolo_conta 	a, 
	pls_conta		b, 
	pls_prestador		c, 
	pls_segurado_carteira	d, 
	pls_conta_proc		e, 
	pls_ocorrencia_benef f, 
	pls_ocorrencia g, 
	procedimento h, 
	pls_plano i 
where 	0=0 
and	b.nr_seq_protocolo	= a.nr_sequencia 
and	b.nr_seq_prestador_exec	= c.nr_sequencia 
and	b.nr_seq_segurado	= d.nr_seq_segurado 
and	e.nr_seq_conta		= b.nr_sequencia 
and	f.nr_seq_conta_proc	= e.nr_sequencia 
and	g.nr_sequencia		= f.nr_seq_ocorrencia 
and	e.cd_procedimento 	= h.cd_procedimento 
and 	e.ie_origem_proced 	= h.ie_origem_proced 
and	i.nr_sequencia		= b.nr_seq_plano 
and	f.ie_situacao		= 'A' 
and	a.ie_status in (2,3,4,5,6) 

union all
 
select	3 ie_tipo_ocorrencia, 
	CASE WHEN a.ie_status='6' THEN 'Pago'  ELSE 'Não pago' END  ds_pago, 
	a.ie_status ie_pago, 
	b.nr_seq_prestador_exec nr_seq_prestador_exec, 
	substr(pls_obter_dados_prestador(b.nr_seq_prestador_exec,'N'),1,80) ds_prestador, 
	coalesce(b.cd_guia_referencia,b.cd_guia) cd_guia, 
	substr(obter_valor_dominio(1746,b.ie_tipo_guia),1,255) ds_tipo_guia, 
	a.ie_tipo_guia ie_tipo_guia, 
	c.cd_prestador cd_prestador, 
	substr(pls_obter_formacao_plano_seg(b.nr_seq_segurado),1,120) ds_preco, 
	i.ie_preco ie_preco, 
	d.cd_usuario_plano cd_usuario_plano, 
	substr(pls_obter_seq_codigo_material(e.nr_seq_material,''),1,255) cd_procedimento, 
	substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',e.nr_seq_material),1,255) ds_procedimento, 
	e.qt_material_imp qt_apresentada, 
	(e.qt_material_imp - e.qt_material) qt_contestada, 
	e.qt_material qt_procedimento, 
	null tx_item, 	 
	g.cd_ocorrencia cd_ocorrencia, 
	a.dt_mes_competencia dt_mes_competencia, 
	g.nr_sequencia nr_seq_ocorrencia, 
	null nr_seq_grupo_receita, 
 	(WITH RECURSIVE cte AS (
(select	y.nr_sequencia,1 as level 
	from	pls_estrutura_material y WHERE y.nr_sequencia = h.nr_seq_estrut_mat
  UNION ALL
(select	y.nr_sequencia,(c.level+1) 
	from	pls_estrutura_material y JOIN cte c ON (c.prior 	nr_seq_superior = y.nr_sequencia))

) SELECT * FROM cte WHERE level =	(WITH RECURSIVE cte AS (
select	max(1) 
			from	pls_estrutura_material z WHERE z.nr_sequencia = h.nr_seq_estrut_mat
  UNION ALL
select	max(c.level+1) 
			from	pls_estrutura_material z JOIN cte c ON (c.prior 	nr_seq_superior = z.z.nr_sequencia)

) SELECT * FROM cte;
);
) nr_seq_estrutura, 
	e.nr_seq_material nr_seq_material 
from	pls_protocolo_conta 	a, 
	pls_conta		b, 
	pls_prestador		c, 
	pls_segurado_carteira	d, 
	pls_conta_mat		e, 
	pls_ocorrencia_benef f, 
	pls_ocorrencia g, 
	pls_material h, 
	pls_plano i 
where 	0=0 
and	b.nr_seq_protocolo	= a.nr_sequencia 
and	b.nr_seq_prestador_exec	= c.nr_sequencia 
and	b.nr_seq_segurado	= d.nr_seq_segurado 
and	e.nr_seq_conta		= b.nr_sequencia 
and	f.nr_seq_conta_mat	= e.nr_sequencia 
and	g.nr_sequencia		= f.nr_seq_ocorrencia 
and	e.nr_seq_material 	= h.nr_sequencia 
and	i.nr_sequencia		= b.nr_seq_plano 
and	f.ie_situacao		= 'A' 
and	a.ie_status in (2,3,4,5,6);

