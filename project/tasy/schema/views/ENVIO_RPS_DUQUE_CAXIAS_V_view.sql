-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW envio_rps_duque_caxias_v (ie_tipo_registro, nr_versao, ie_tipo_contribuinte, cd_cgc_emitente, nr_inscricao_municipal, cd_estabelecimento, ie_tipo_rps, cd_serie_nf, nr_nota_fiscal, dt_emissao_pag, dt_emissao, dt_emissao_impresso, ie_situacao_nota, ie_tipo_tomador, cd_cpf_cnpj_tomador, ds_insc_munic_tomador, ds_insc_estad_tomador, ds_razao_social_tomador, ds_logradouro_tomador, ds_endereco_tomador, nr_endereco_tomador, ds_complemento_tomador, ds_bairro_tomador, ds_cidade_tomador, sg_uf_tomador, ds_cep_tomador, nr_fone_tomador, ds_email_tomador, cd_tributacao, ds_cidade_prestador, sg_uf_prestador, ds_regime_especial, ie_simples_nacional, ds_incentivador_cultural, cd_servico_fed, cd_servico_mun, pr_aliquota, vl_servicos, vl_deducao, vl_desconto_condicionado, vl_desconto_incondicionado, vl_cofins, vl_csll, vl_inss, vl_ir, vl_pis, vl_outras_retencoes, vl_iss, ie_retem_iss, cd_obra, ds_resp_tecnica, cd_serie_nf_st, nr_nota_fiscal_st, ds_reservado, ds_servicos, qt_linhas, vl_total_servicos, vl_total_deducoes, vl_total_desc_condicionado, vl_total_desc_incondicionado) AS select		10											ie_tipo_registro,
		lpad(003,3,0)										nr_versao, 
		2											ie_tipo_contribuinte, 
		lpad(cd_cgc,14,0)										cd_cgc_emitente, 
		lpad(cd_inscricao_municipal,15,0)								nr_inscricao_municipal, 
		cd_estabelecimento										cd_estabelecimento, 
		null											ie_tipo_rps, 
		''											cd_serie_nf, 
		''											nr_nota_fiscal, 
		NULL 											DT_EMISSAO_PAG, 
		null											dt_emissao, 
		null											dt_emissao_impresso, 
		null											ie_situacao_nota, 
		null											ie_tipo_tomador, 
		''											cd_cpf_cnpj_tomador, 
		''											ds_insc_munic_tomador, 
		''											ds_insc_estad_tomador, 
		''											ds_razao_social_tomador, 
		''											ds_logradouro_tomador, 
		''											ds_endereco_tomador, 
		''											nr_endereco_tomador, 
		''											ds_complemento_tomador, 
		''											ds_bairro_tomador, 
		''											ds_cidade_tomador, 
		''											sg_uf_tomador, 
		''											ds_cep_tomador, 
		''											nr_fone_tomador, 
		''											ds_email_tomador, 
		''											cd_tributacao, 
		''											ds_cidade_prestador, 
		''											sg_uf_prestador, 
		''											ds_regime_especial, 
		''											ie_simples_nacional, 
		''											ds_incentivador_cultural, 
		''											cd_servico_fed, 
		''											cd_servico_mun, 
		''											pr_aliquota, 
		null											vl_servicos, 
		null											vl_deducao, 
		null											vl_desconto_condicionado, 
		null											vl_desconto_incondicionado, 
		null											vl_cofins, 
		null											vl_csll, 
		null											vl_inss, 
		null											vl_ir, 
		null											vl_pis, 
		null											vl_outras_retencoes, 
		null											vl_iss, 
		null											ie_retem_iss, 
		null											cd_obra, 
		null											DS_RESP_TECNICA, 
		null											cd_serie_nf_st, 
		null											nr_nota_fiscal_st, 
		''											ds_reservado, 
		''											ds_servicos, 
		0											qt_linhas, 
		null											vl_total_servicos, 
		null											vl_total_deducoes, 
		null											vl_total_desc_condicionado, 
		null											vl_total_desc_incondicionado 
FROM		estabelecimento 

union all
 
select		20											ie_tipo_registro, 
		null											nr_versao, 
		null											ie_tipo_contribuinte, 
		''											cd_cgc_emitente, 
		''											nr_inscricao_municipal, 
		cd_estabelecimento										cd_estabelecimento, 
		0											ie_tipo_rps, 
		rpad(n.cd_serie_nf,5,' ')									cd_serie_nf_st, 
		lpad(n.nr_nota_fiscal,15,0)									nr_nota_fiscal, 
		n.dt_emissao 										DT_EMISSAO_PAG, 
		n.dt_emissao										dt_emissao, 
		n.dt_emissao										dt_emissao_impresso, 
		CASE WHEN n.ie_situacao=1 THEN 1  ELSE 2 END 									ie_situacao_nota, 
		CASE WHEN n.cd_cgc='' THEN 1  ELSE 2 END 									ie_tipo_tomador, 
		CASE WHEN n.cd_cgc='' THEN lpad(substr(obter_dados_pf(n.cd_pessoa_fisica,'CPF'),1,11),11,0)  ELSE lpad(substr(n.cd_cgc,1,14),14,0) END 								cd_cpf_cnpj_tomador, 
		lpad(CASE WHEN substr(upper(elimina_acentuacao(elimina_caracteres_especiais(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI')))),1,50)=substr(upper(elimina_acentuacao(elimina_caracteres_especiais(obter_dados_pf_pj(null, n.cd_cgc_emitente, 'CI')))),1,50) THEN  		obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'IM')  ELSE '' END ,15,0)					ds_insc_munic_tomador, 
		lpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'IE'),15,0)					ds_insc_estad_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'N'),115,' ')					ds_razao_social_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'LO'),3,' ')					ds_logradouro_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'R'),125,' ')					ds_endereco_tomador, 
		lpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'NR'),10,0)					nr_endereco_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CO'),60,' ')					ds_complemento_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'B'),72,' ')					ds_bairro_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CI'),50,' ')					ds_cidade_tomador, 
		substr(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'UF'),1,2)					sg_uf_tomador, 
		lpad(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'CEP'),8,' ')					ds_cep_tomador, 
		rpad(elimina_caracteres_especiais(obter_dados_pf_pj(n.cd_pessoa_fisica, n.cd_cgc, 'DDT')|| 
		obter_dados_pf_pj(n.cd_pessoa_fisica, cd_cgc, 'T')),11,' ')						nr_fone_tomador, 
		rpad(obter_dados_pf_pj(n.cd_pessoa_fisica, cd_cgc, 'M'),80,' ')					ds_email_tomador, 
		substr(nfse_obter_regra('TP',n.cd_estabelecimento),1,1)						cd_tributacao, 
		rpad(obter_dados_pf_pj(null,n.cd_cgc_emitente, 'CI'),50,' ')						ds_cidade_prestador, 
		substr(obter_dados_pf_pj(null,n.cd_cgc_emitente, 'UF'),1,2)						sg_uf_prestador, 
		lpad(nfse_obter_regra('RET',n.cd_estabelecimento),2,0)						ds_regime_especial, 
		substr(CASE WHEN nfse_obter_regra('OSN',n.cd_estabelecimento)='S' THEN 1 WHEN nfse_obter_regra('OSN',n.cd_estabelecimento)='N' THEN 0 END ,1,1)				ie_simples_nacional, 
		substr(CASE WHEN nfse_obter_regra('IC',n.cd_estabelecimento)='S' THEN 1 WHEN nfse_obter_regra('IC',n.cd_estabelecimento)='N' THEN 0 END ,1,1)				ds_incentivador_cultural, 
		lpad(elimina_caractere_especial(obter_dados_grupo_servico_item(obter_item_servico_proced((obter_procedimento_nfse(n.nr_sequencia,'P')),(obter_procedimento_nfse(nr_sequencia,'O'))),'CD')),4,0) cd_servico_fed, 
		lpad(elimina_caractere_especial(obter_dados_grupo_servico_item(obter_item_servico_proced((obter_procedimento_nfse(n.nr_sequencia,'P')),(obter_procedimento_nfse(nr_sequencia,'O'))),'CD')),4,0) cd_servico_mun, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia,'X','ISS')),5,0) 		pr_aliquota, 
		lpad(elimina_caracteres_especiais(CASE WHEN n.ie_situacao=1 THEN n.vl_mercadoria  ELSE 0 END ),15,0) 			vl_servicos, 
		lpad(elimina_caracteres_especiais(0),15,0) 							vl_deducao, 
		lpad(elimina_caracteres_especiais(0),15,0) 							vl_desconto_condicionado, 
		lpad(elimina_caracteres_especiais(n.vl_descontos),15,0) 						vl_desconto_incondicionado, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'COFINS')),15,0)		vl_cofins, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'CSLL')),15,0)		vl_csll, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS')),15,0) 		vl_inss, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR')),15,0) 		vl_ir, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'PIS')),15,0) 		vl_pis, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'O')),15,0)		vl_outras_retencoes, 
		lpad(elimina_caracteres_especiais(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'ISS')),15,0) 		vl_iss, 
		CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN  '1'  ELSE '0' END  						ie_retem_iss, 
		lpad(0,15,0)										cd_obra, 
		lpad(0,15,0)										DS_RESP_TECNICA, 
		rpad(n.cd_serie_nf,5,' ') 									cd_serie_nf, 
		lpad(n.nr_nota_fiscal,15,0) 									nr_nota_fiscal_st, 
		lpad(' ',15,' ')										ds_reservado, 
		substr(Obter_select_concatenado( 
		'select decode(a.cd_material, null, 
		substr(obter_descricao_procedimento(a.cd_procedimento, ie_origem_proced),1,240), 
		substr(obter_desc_material(a.cd_material),1,100)) 
		from nota_fiscal_item a, nota_fiscal b where a.nr_sequencia = b.nr_sequencia and a.nr_sequencia = ' || n.nr_sequencia,null,'|'),1,4000) ds_servicos, 
		0											qt_linhas, 
		null											vl_total_servicos, 
		null											vl_total_deducoes, 
		null											vl_total_desc_condicionado, 
		null											vl_total_desc_incondicionado 
from		nota_fiscal n 

union all
 
select		90											ie_tipo_registro, 
		null											nr_versao, 
		null											ie_tipo_contribuinte, 
		''											cd_cgc_emitente, 
		''											nr_inscricao_municipal, 
		cd_estabelecimento										cd_estabelecimento, 
		null											ie_tipo_rps, 
		''											cd_serie_nf, 
		''											nr_nota_fiscal, 
		NULL 											DT_EMISSAO_PAG, 
		null											dt_emissao, 
		null											dt_emissao_impresso, 
		null											ie_situacao_nota, 
		null											ie_tipo_tomador, 
		''											cd_cpf_cnpj_tomador, 
		''											ds_insc_munic_tomador, 
		''											ds_insc_estad_tomador, 
		''											ds_razao_social_tomador, 
		''											ds_logradouro_tomador, 
		''											ds_endereco_tomador, 
		''											nr_endereco_tomador, 
		''											ds_complemento_tomador, 
		''											ds_bairro_tomador, 
		''											ds_cidade_tomador, 
		''											sg_uf_tomador, 
		''											ds_cep_tomador, 
		''											nr_fone_tomador, 
		''											ds_email_tomador, 
		''											cd_tributacao, 
		''											ds_cidade_prestador, 
		''											sg_uf_prestador, 
		''											ds_regime_especial, 
		''											ie_simples_nacional, 
		''											ds_incentivador_cultural, 
		''											cd_servico_fed, 
		''											cd_servico_mun, 
		''											pr_aliquota, 
		null											vl_servicos, 
		null											vl_deducao, 
		null											vl_desconto_condicionado, 
		null											vl_desconto_incondicionado, 
		null											vl_cofins, 
		null											vl_csll, 
		null											vl_inss, 
		null											cd_obra, 
		null											DS_RESP_TECNICA, 
		null											vl_ir, 
		null											vl_pis, 
		null											vl_outras_retencoes, 
		null											vl_iss, 
		null											ie_retem_iss, 
		null											cd_serie_nf_st, 
		null											nr_nota_fiscal_st, 
		''											ds_reservado, 
		''											ds_servicos, 
		0											qt_linhas, 
		lpad(elimina_caracteres_especiais(sum(CASE WHEN n.ie_situacao=1 THEN n.vl_mercadoria  ELSE 0 END )),15,0)			vl_total_servicos, 
	 	lpad(0,15,0)								    		vl_total_deducoes, 
	 	lpad(0,15,0)								    		vl_total_desc_condicionado, 
	 	lpad(elimina_caracteres_especiais(sum(n.vl_descontos)),15,0)			    		vl_total_desc_incondicionado 
from	 	nota_fiscal n 
group by	cd_estabelecimento;

