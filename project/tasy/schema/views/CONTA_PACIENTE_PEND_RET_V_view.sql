-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW conta_paciente_pend_ret_v (cd_convenio, ds_convenio, nr_seq_protocolo, nr_protocolo, dt_envio, nr_atendimento, nr_interno_conta, vl_conta, cd_autorizacao, vl_guia, vl_recebido, vl_pendente, vl_glosa_ok, vl_glosa_pend, dt_vencimento, cd_estabelecimento, dt_venc_titulo, nr_seq_doc_convenio, cd_usuario_convenio, cd_pessoa_fisica, dt_periodo_inicial, dt_periodo_final) AS SELECT	a.cd_convenio,
	SUBSTR(obter_nome_convenio(a.cd_convenio),1,40) ds_convenio, 
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	a.dt_envio, 
	b.nr_atendimento, 
	b.nr_interno_conta, 
	b.vl_conta, 
	c.cd_autorizacao, 
	c.vl_guia, 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP) vl_recebido, 
	(c.vl_guia - (obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP)) - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP)) vl_pendente, 
--	(c.vl_guia - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', sysdate)) vl_pendente, 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP) vl_glosa_ok, 
	(c.vl_guia - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP)) - 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP) vl_glosa_pend, 
	a.dt_vencimento, 
	d.cd_estabelecimento, 
	d.dt_pagamento_previsto dt_venc_titulo, 
	a.nr_seq_doc_convenio, 
	SUBSTR(obter_codigo_usuario_conv(b.nr_atendimento),1,254) cd_usuario_convenio, 
	SUBSTR(obter_pessoa_atendimento(b.nr_atendimento,'C'),1,254) cd_pessoa_fisica, 
	b.dt_periodo_inicial, 
	b.dt_periodo_final 
FROM	conta_paciente_guia c, 
	conta_paciente b, 
	protocolo_convenio a, 
	titulo_receber d 
WHERE	a.nr_seq_protocolo = b.nr_seq_protocolo 
AND	b.nr_interno_conta = c.nr_interno_conta 
AND	a.nr_seq_protocolo = d.nr_seq_protocolo 
AND	d.nr_interno_conta IS NULL 
AND	b.dt_cancelamento IS NULL 
AND	a.ie_status_protocolo = 2 

UNION
 
SELECT	a.cd_convenio, 
	SUBSTR(obter_nome_convenio(a.cd_convenio),1,40) ds_convenio, 
	a.nr_seq_protocolo, 
	a.nr_protocolo, 
	a.dt_envio, 
	b.nr_atendimento, 
	b.nr_interno_conta, 
	b.vl_conta, 
	c.cd_autorizacao, 
	c.vl_guia, 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP) vl_recebido, 
	(c.vl_guia - (obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP)) - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP)) vl_pendente, 
--	(c.vl_guia - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', sysdate)) vl_pendente, 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP) vl_glosa_ok, 
	(c.vl_guia - obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'P', LOCALTIMESTAMP)) - 
	obter_valor_pago_conta(b.nr_interno_conta, c.cd_autorizacao, 'IG', LOCALTIMESTAMP) vl_glosa_pend, 
	a.dt_vencimento, 
	d.cd_estabelecimento, 
	d.dt_pagamento_previsto dt_venc_titulo, 
	a.nr_seq_doc_convenio, 
	SUBSTR(obter_codigo_usuario_conv(b.nr_atendimento),1,254) cd_usuario_convenio, 
	SUBSTR(obter_pessoa_atendimento(b.nr_atendimento,'C'),1,254) cd_pessoa_fisica, 
	b.dt_periodo_inicial, 
	b.dt_periodo_final 
FROM	conta_paciente_guia c, 
	conta_paciente b, 
	protocolo_convenio a, 
	titulo_receber d 
WHERE	a.nr_seq_protocolo = b.nr_seq_protocolo 
AND	b.nr_interno_conta = c.nr_interno_conta 
AND	d.nr_interno_conta = b.nr_interno_conta 
AND	b.dt_cancelamento IS NULL 
AND	a.ie_status_protocolo = 2;

