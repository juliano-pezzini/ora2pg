-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_controle_visita_setor_v (qt_ocorrencia, cd_pessoa_fisica, nr_atendimento, dt_entrada, ds_tipo_pessoa, nr_seq_tipo, ds_setor_atendimento, cd_setor_atendimento, ds_pernoite, ie_sexo_visitante, ds_faixa_etaria, cd_idade, ds_dia_semana, ds_hora, cd_hora, qt_minutos_visita, ds_acomp_autor, nm_pessoa_usuario, cd_estab_setor, cd_estabelecimento, cd_empresa) AS select	1 qt_ocorrencia,
	a.cd_pessoa_fisica,
	a.nr_atendimento,
	a.dt_entrada,
	substr(obter_descricao_padrao('VISITANTE','DS_VISITANTE',NR_SEQ_TIPO),1,60) ds_tipo_pessoa,
	nr_seq_tipo,
	substr(obter_nome_setor(a.cd_Setor_Atendimento),1,50) ds_setor_atendimento,
	a.cd_setor_atendimento,
	eis_obter_se_visita_pernoite(a.nr_sequencia) ds_pernoite,
	substr(OBTER_SEXO_PF(a.cd_pessoa_fisica,'D'),1,20) ie_sexo_visitante,
	eis_obter_faixa_etaria( campo_numerico( campo_numerico(obter_idade(trunc(p.dt_nascimento),coalesce(trunc(p.dt_obito),LOCALTIMESTAMP),'A')) )) ds_faixa_etaria,
	campo_numerico(obter_idade(trunc(p.dt_nascimento),coalesce(trunc(p.dt_obito),LOCALTIMESTAMP),'A')) cd_idade,
	obter_dia_semana(a.dt_entrada) ds_dia_semana,
	--ie_clinica,

	--obter_valor_dominio(17,ie_clinica) ds_clinica,

	lpad(to_char(a.dt_entrada,'hh24'),2,'0') || ':00' ds_hora,
	campo_numerico(to_char(a.dt_entrada,'hh24')) cd_hora,
	obter_minutos_espera(a.dt_entrada,coalesce(a.dt_saida,LOCALTIMESTAMP)) qt_minutos_visita,
	substr(eis_obter_pernoite_autoriz(a.nr_sequencia),1,50) ds_acomp_autor,
	substr(OBTER_NOME_USUARIO(coalesce(a.NM_USUARIO_NREC,a.NM_USUARIO)),1,255) nm_pessoa_usuario,
	s.cd_estabelecimento cd_estab_setor,
	s.cd_estabelecimento cd_estabelecimento,
	e.cd_empresa cd_empresa
FROM atendimento_visita a
LEFT OUTER JOIN setor_atendimento s ON (a.cd_setor_atendimento = s.cd_setor_atendimento)
LEFT OUTER JOIN pessoa_fisica p ON (a.cd_pessoa_Fisica = p.cd_pessoa_fisica)
LEFT OUTER JOIN estabelecimento e ON (s.cd_estabelecimento = e.cd_estabelecimento)
WHERE a.nr_atendimento	is null;

