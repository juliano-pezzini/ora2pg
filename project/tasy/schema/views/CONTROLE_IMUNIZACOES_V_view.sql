-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW controle_imunizacoes_v (qt_dose, nr_seq_vacina, ds_vacina, cd_material, ds_material, dt_vacina, dt_filtro, ie_cancelado, ds_faixa_etaria, cd_estabelecimento_vacina, ds_estabelecimento_vacina, cd_area_vacina, ds_area_vacina, cd_area_paciente, ds_area_paciente, ie_reside_local_vacina) AS SELECT 	X.QT_DOSE,
	x.nr_seq_vacina,	 
	UPPER(SUBSTR(OBTER_DESC_VACINA(X.NR_SEQ_VACINA),1,255)) DS_VACINA,	 
	D.CD_MATERIAL,	 
	UPPER(d.ds_material) ds_material,	 
	x.dt_vacina,	 
	X.DT_VACINA DT_FILTRO,	 
	CASE WHEN A.DT_CANCELAMENTO IS NULL THEN  'N'  ELSE 'S' END  IE_CANCELADO,	 
	SUBSTR(coalesce(OBTER_FAIXA_ETARIA_PF(X.CD_PESSOA_FISICA),OBTER_FAIXA_ETARIA_PF(OBTER_DADOS_ATENDIMENTO(X.NR_ATENDIMENTO,'CP'))),1,10) DS_FAIXA_ETARIA,	 
	C.CD_ESTABELECIMENTO CD_ESTABELECIMENTO_VACINA,	 
	UPPER(OBTER_NOME_ESTAB(C.CD_ESTABELECIMENTO)) DS_ESTABELECIMENTO_VACINA,	 
	E.CD_AREA CD_AREA_VACINA,	 
	UPPER(G.DS_AREA) DS_AREA_VACINA,	 
	F.NR_SEQ_AREA CD_AREA_PACIENTE,	 
	UPPER((SELECT MAX(DS_AREA) FROM PSF_AREA WHERE NR_SEQUENCIA = F.NR_SEQ_AREA)) DS_AREA_PACIENTE,	 
	CASE WHEN coalesce(E.CD_AREA,'0')=coalesce(F.NR_SEQ_AREA, '-1') THEN  'S'  ELSE 'N' END  IE_RESIDE_LOCAL_VACINA 
FROM 	PACIENTE_VACINA X 
	LEFT JOIN ATENDIMENTO_PACIENTE A 
	ON X.NR_ATENDIMENTO = A.NR_ATENDIMENTO 
	LEFT JOIN VACINA B 
	ON X.NR_SEQ_VACINA = B.NR_SEQUENCIA 
	LEFT JOIN VACINA_PACIENTE_MATERIAL C 
	ON X.NR_SEQUENCIA = C.NR_SEQ_VACINA 
	LEFT JOIN MATERIAL D 
	ON C.CD_MATERIAL = D.CD_MATERIAL 
	LEFT JOIN ESTRUTURA_ORGANIZACIONAL E 
	ON C.CD_ESTABELECIMENTO = E.CD_ESTABELECIMENTO 
	LEFT JOIN DOMICILIO_FAMILIA F 
	ON X.CD_PESSOA_FISICA = F.CD_PESSOA_FISICA  
	LEFT JOIN PSF_AREA G 
	ON E.CD_AREA = G.NR_SEQUENCIA 
	 
WHERE	X.DT_VACINA IS NOT NULL 
	AND F.IE_MUDOU_SE = 'N';

