-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW dados_tela_resumo_proj_v (nr_sequencia, nr_seq_rat, nr_seq_classif, ie_status, dt_fim_ativ, cd_executor, nm_consultor, nr_seq_proj, ds_titulo, nm_cliente, dt_aprovacao, dt_liberacao, dt_receb_rat, qt_horas, vl_custo_hora, vl_hora_rec, vl_receita_total, vl_custo_total, vl_fixo_rat, vl_adicional_clt, vl_margem_direta, vl_custo_inst, vl_margem_final, vl_viagem, vl_viagem_total, vl_viagem_cliente, vl_ebtida, vl_margem_ebtida, vl_imposto, vl_margem, pr_margem, vl_receita_liquida, vl_margem_1, vl_margem_2, vl_margem_prev, pr_margem_1, qt_hora_fat, qt_hora_nao_fat) AS select	a.nr_sequencia nr_sequencia,
	a.nr_sequencia nr_seq_rat,
	c.nr_seq_classif,
	c.ie_status,
	trunc(b.dt_inicio_ativ,'month') dt_fim_ativ,
	a.cd_executor,
	substr(obter_nome_pf(a.cd_executor),1,80) nm_consultor,
	a.nr_seq_proj nr_seq_proj,
	ds_titulo,
	SUBSTR(proj_obter_dados_projeto(a.nr_seq_proj,'C'),1,254) nm_cliente,
	a.dt_aprovacao,
	a.dt_liberacao,
	a.dt_receb_rat,
	SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) qt_horas,
	a.vl_hora_cobrar vl_custo_hora,
	0 vl_hora_rec,
	(sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* coalesce(a.vl_hora_cobrar,0)) vl_receita_total,
	SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0) vl_custo_total,
	Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)  vl_fixo_Rat,
	CASE WHEN a.ie_regime_contr='PJ' THEN 0  ELSE ((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0) + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais)) END   vl_adicional_clt,
	(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)-(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR)-(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2))-((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais))  vl_margem_direta,
	((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100) *proj_obter_perc_custo_inst(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais) vl_custo_inst,
	0 vl_margem_final,
	coalesce(obter_tot_despesa_viagem_con(a.nr_seq_proj,trunc(b.dt_inicio_ativ,'month')),0)  vl_viagem,
	coalesce(obter_tot_despesa_viagem_con(a.nr_seq_proj,trunc(b.dt_inicio_ativ,'month'), 'A'),0) vl_viagem_total,
	coalesce(obter_tot_despesa_viagem_con(a.nr_seq_proj,trunc(b.dt_inicio_ativ,'month'), 'T'),0) vl_viagem_cliente,
	(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)-(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR)-(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2))-((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais))- ((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100) *proj_obter_perc_custo_inst(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais) vl_ebtida,
	Round((dividir(((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)-(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR)-(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2))-((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais))- ((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100) *proj_obter_perc_custo_inst(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)),(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * CASE WHEN a.vl_hora_cobrar=0 THEN 0.1  ELSE a.vl_hora_cobrar END )))*100,2) vl_margem_ebtida,
	(sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )*a.vl_hora_cobrar/100) *proj_obter_perc_imposto_fat(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)  vl_imposto,
	(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)-(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR)-(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2))-((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais))- ((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100) *proj_obter_perc_custo_inst(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)-((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100)*proj_obter_perc_imposto_fat(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais) vl_margem,
	Round((dividir(((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)-(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR)-(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2))-((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais))- ((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100) *proj_obter_perc_custo_inst(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)-((SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * a.vl_hora_cobrar)/100)*proj_obter_perc_imposto_fat(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)),(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * CASE WHEN a.vl_hora_cobrar=0 THEN 0.1  ELSE a.vl_hora_cobrar END ))) *100,2) pr_margem,
	round((sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* a.vl_hora_cobrar) - (((((sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* a.vl_hora_cobrar)/100)*proj_obter_perc_imposto_fat(trunc(b.dt_inicio_ativ,'month'),e.nr_seq_pais)))), 2) vl_receita_liquida,
	round((sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* coalesce(a.vl_hora_cobrar,0)) - Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2) - (SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0)) - ((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0) + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais)), 2) vl_margem_1,
	round((sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* coalesce(a.vl_hora_cobrar,0)) - Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2) - (SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0)) - ((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR,0) + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais)) - (dividir(coalesce(obter_tot_despesa_viagem_con(a.nr_seq_proj, trunc(b.dt_inicio_ativ,'month')),0), (proj_obter_horas_cronograma(a.nr_seq_proj, 'F',trunc(b.dt_inicio_ativ,'month'))+ coalesce((proj_obter_horas_cronograma(a.nr_seq_proj, 'NF',trunc(b.dt_inicio_ativ,'month'))),0))) * SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60)), 2) vl_margem_2,
	round((proj_obter_horas_cronograma(a.nr_seq_proj, 'HC') * proj_obter_media_hora_cobrar(a.nr_seq_proj, proj_obter_inicio_prim_cron(a.nr_seq_proj))) - (proj_obter_horas_cronograma(a.nr_seq_proj, 'HC') * 9.55) - (proj_obter_horas_cronograma(a.nr_seq_proj, 'HC') * (proj_obter_media_valor_nivel / 180)), 2) vl_margem_prev,
	(dividir((round((sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* coalesce(a.vl_hora_cobrar,0)) - coalesce(Round((proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2), 0) - coalesce(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * VL_HORA_PAGAR,0) - coalesce(((Round(SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) * coalesce(VL_HORA_PAGAR, 0) + (proj_obter_valor_fixo(a.nr_sequencia)/180)*SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60),2)/100)*proj_obter_perc_clt(trunc(b.dt_inicio_ativ,'month'),1,e.nr_seq_pais)), 0) - dividir(coalesce(obter_tot_despesa_viagem_con(a.nr_seq_proj, trunc(b.dt_inicio_ativ,'month')),0), (proj_obter_horas_cronograma(a.nr_seq_proj, 'F',trunc(b.dt_inicio_ativ,'month'))+ coalesce((proj_obter_horas_cronograma(a.nr_seq_proj, 'NF',trunc(b.dt_inicio_ativ,'month'))),0)) * SUM(coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60)), 2)*100), (sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END )* coalesce(a.vl_hora_cobrar,0)))) pr_margem_1,
	sum(CASE WHEN f.ie_cobrado='S' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END ) qt_hora_fat,
	sum(CASE WHEN f.ie_cobrado='N' THEN (coalesce(coalesce(b.qt_min_ativ,0) - coalesce(b.qt_min_intervalo,0),0)/60) END ) qt_hora_nao_fat
FROM	proj_rat a,
	proj_rat_ativ b,
	proj_projeto c,
	com_cliente d,
	pessoa_juridica e,
	proj_cronograma f,
	proj_cron_etapa h
where	c.nr_seq_cliente = d.nr_sequencia
and	f.nr_seq_proj = c.nr_sequencia
and	b.nr_seq_etapa_cron = h.nr_sequencia
and	h.nr_seq_cronograma = f.nr_sequencia
and	e.cd_cgc = d.cd_cnpj
and	c.nr_sequencia = a.nr_seq_proj
and	a.nr_sequencia = b.nr_seq_rat
and 	a.dt_aprovacao is not null
group by a.nr_sequencia, c.nr_seq_classif, ie_status, a.cd_executor, a.vl_hora_cobrar, a.nr_seq_proj, VL_HORA_PAGAR, trunc(b.dt_inicio_ativ,'month'),ds_titulo,a.dt_aprovacao, a.dt_liberacao, a.dt_receb_rat, e.nr_seq_pais, a.ie_regime_contr;

