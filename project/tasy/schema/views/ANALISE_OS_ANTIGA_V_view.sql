-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW analise_os_antiga_v (ie_registro, nr_seq_gerencia, ds_gerencia, dt_posicao, qt_total_ordens, qt_ordens_antigas, pr_ordens_antigas) AS select	a.ie_registro,
	a.nr_seq_gerencia,
	a.ds_gerencia,
	a.dt_posicao,
	a.qt_total_ordens,
	a.qt_ordens_antigas,
	a.pr_ordens_antigas
FROM (
	select 	1 ie_registro,
		c.nr_sequencia nr_seq_gerencia,
		c.ds_gerencia_externo ds_gerencia,
		b.dt_posicao,
		sum(a.qt_total) qt_total_ordens,
		sum(a.qt_os_antiga) qt_ordens_antigas,
		round(dividir(sum(a.qt_os_antiga) * 100, sum(a.qt_total))) pr_ordens_antigas
	from 	gerencia_wheb c,
		man_posicao_diaria_resumo a,
		man_posicao_diaria b
	where 	c.nr_sequencia = a.nr_seq_gerencia
	and	a.nr_seq_posicao = b.nr_sequencia
	and	a.nr_seq_gerencia not in (1,5)
	and	b.ie_tipo_registro = 1
	and	coalesce(a.ie_tipo,'P') = 'P'
	and	coalesce(b.ie_tipo,'P') = 'P'
	group by
		1,
		c.nr_sequencia,
		c.ds_gerencia_externo,
		b.dt_posicao
	
union

	select 	2 ie_registro,
		0 nr_seq_gerencia,
		'' ds_gerencia,
		b.dt_posicao,
		sum(a.qt_total) qt_total_ordens,
		sum(a.qt_os_antiga) qt_ordens_antigas,
		round(dividir(sum(a.qt_os_antiga) * 100, sum(a.qt_total))) pr_ordens_antigas
	from 	gerencia_wheb c,
		man_posicao_diaria_resumo a,
		man_posicao_diaria b
	where 	c.nr_sequencia = a.nr_seq_gerencia
	and	a.nr_seq_posicao = b.nr_sequencia
	and	a.nr_seq_gerencia not in (1,5)
	and	b.ie_tipo_registro = 1
	and	coalesce(a.ie_tipo,'P') = 'P'
	and	coalesce(b.ie_tipo,'P') = 'P'
	group by
		2,
		0,
		'',
		b.dt_posicao
	) a
group by
	a.ie_registro,
	a.nr_seq_gerencia,
	a.ds_gerencia,
	a.dt_posicao,
	a.qt_total_ordens,
	a.qt_ordens_antigas,
	a.pr_ordens_antigas
order by
	a.ie_registro,
	a.ds_gerencia;

