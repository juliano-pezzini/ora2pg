-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_utilizacao_benef_v (vl_total, nr_sequencia, cd_tiss, ie_tipo_guia, ie_tipo_item, nr_seq_segurado, nr_seq_prestador, dt_atendimento_referencia, ie_tipo_conta, ie_tipo_benef, nr_seq_conta_princ, count_item) AS select	sum(t.vl_total) vl_total,
	t.nr_sequencia, 
	t.cd_tiss, 
	t.ie_tipo_guia, 
	t.ie_tipo_item, 
	t.nr_seq_segurado, 
	t.nr_seq_prestador, 
	t.dt_atendimento_referencia, 
	t.ie_tipo_conta, 
	t.ie_tipo_benef, 
	t.nr_seq_conta_princ, 
	count(t.nr_seq_item) count_item 
FROM (	select	CASE WHEN coalesce(b.ie_tipo_protocolo,'C')='R' THEN coalesce(d.vl_liquido,0)  ELSE coalesce(d.vl_lib_original,0) END  vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		a.ie_tipo_guia, 
		CASE WHEN d.ie_tipo_despesa='1' THEN  'P'  ELSE 'O' END  ie_tipo_item, 
		a.nr_seq_segurado, 
		a.nr_seq_prestador_exec nr_seq_prestador, 
		a.dt_atendimento_referencia, 
		'CM' ie_tipo_conta, 
		'T' ie_tipo_benef, 
		a.nr_seq_conta_princ nr_seq_conta_princ, 
		d.nr_sequencia nr_seq_item 
	FROM pls_segurado e, pls_conta_proc d, pls_conta a
LEFT OUTER JOIN pls_protocolo_conta b ON (a.nr_seq_protocolo = b.nr_sequencia)
LEFT OUTER JOIN pls_tipo_atendimento c ON (a.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE d.nr_seq_conta			= a.nr_sequencia and e.nr_sequencia			= a.nr_seq_segurado and a.ie_status			= 'F' and d.ie_status			<> 'D' 
	 
union all
 
	select	CASE WHEN coalesce(b.ie_tipo_protocolo,'C')='R' THEN coalesce(d.vl_liquido,0)  ELSE coalesce(d.vl_lib_original,0) END  vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		a.ie_tipo_guia, 
		CASE WHEN d.ie_tipo_despesa='1' THEN  'P'  ELSE 'O' END  ie_tipo_item, 
		e.nr_seq_titular nr_seq_segurado, 
		a.nr_seq_prestador_exec nr_seq_prestador, 
		a.dt_atendimento_referencia, 
		'CM' ie_tipo_conta, 
		'D' ie_tipo_benef, 
		a.nr_seq_conta_princ nr_seq_conta_princ, 
		d.nr_sequencia nr_seq_item 
	FROM pls_segurado e, pls_conta_proc d, pls_conta a
LEFT OUTER JOIN pls_protocolo_conta b ON (a.nr_seq_protocolo = b.nr_sequencia)
LEFT OUTER JOIN pls_tipo_atendimento c ON (a.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE d.nr_seq_conta			= a.nr_sequencia and e.nr_sequencia			= a.nr_seq_segurado and d.ie_status			<> 'D' and a.ie_status			= 'F' 
	 
union all
 
	select	CASE WHEN coalesce(b.ie_tipo_protocolo,'C')='R' THEN coalesce(d.vl_liberado,0)  ELSE coalesce(d.vl_lib_original,0) END  vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		a.ie_tipo_guia, 
		'O' ie_tipo_item, 
		a.nr_seq_segurado, 
		a.nr_seq_prestador_exec nr_seq_prestador, 
		a.dt_atendimento_referencia, 
		'CM' ie_tipo_conta, 
		'T' ie_tipo_benef, 
		a.nr_seq_conta_princ nr_seq_conta_princ, 
		d.nr_sequencia nr_seq_item 
	FROM pls_segurado e, pls_conta_mat d, pls_conta a
LEFT OUTER JOIN pls_protocolo_conta b ON (a.nr_seq_protocolo = b.nr_sequencia)
LEFT OUTER JOIN pls_tipo_atendimento c ON (a.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE d.nr_seq_conta			= a.nr_sequencia and e.nr_sequencia			= a.nr_seq_segurado and a.ie_status			= 'F' and d.ie_status			<> 'D' 
	 
union all
 
	select	CASE WHEN coalesce(b.ie_tipo_protocolo,'C')='R' THEN coalesce(d.vl_liberado,0)  ELSE coalesce(d.vl_lib_original,0) END  vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		a.ie_tipo_guia, 
		'O' ie_tipo_item, 
		e.nr_seq_titular nr_seq_segurado, 
		a.nr_seq_prestador_exec nr_seq_prestador, 
		a.dt_atendimento_referencia, 
		'CM' ie_tipo_conta, 
		'D' ie_tipo_benef, 
		a.nr_seq_conta_princ nr_seq_conta_princ, 
		d.nr_sequencia nr_seq_item 
	FROM pls_segurado e, pls_conta_mat d, pls_conta a
LEFT OUTER JOIN pls_protocolo_conta b ON (a.nr_seq_protocolo = b.nr_sequencia)
LEFT OUTER JOIN pls_tipo_atendimento c ON (a.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE d.nr_seq_conta			= a.nr_sequencia and e.nr_sequencia			= a.nr_seq_segurado and a.ie_status			= 'F' and d.ie_status			<> 'D' 
	 
union all
 
	select	coalesce(e.vl_liberado,0) vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		b.ie_tipo_guia, 
		CASE WHEN g.ie_tipo_despesa='1' THEN  'P'  ELSE 'O' END  ie_tipo_item, 
		b.nr_seq_segurado, 
		b.nr_seq_prestador_exec nr_seq_prestador, 
		b.dt_atendimento_referencia, 
		'RG' ie_tipo_conta, 
		'T' ie_tipo_benef, 
		b.nr_seq_conta_princ nr_seq_conta_princ, 
		g.nr_sequencia nr_seq_item 
	FROM pls_conta_proc g, pls_rec_glosa_proc f, pls_conta_rec_resumo_item e, pls_segurado d, pls_rec_glosa_conta a, pls_conta b
LEFT OUTER JOIN pls_tipo_atendimento c ON (b.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE b.nr_sequencia			= a.nr_seq_conta  and d.nr_sequencia			= b.nr_seq_segurado and e.nr_seq_conta_rec		= a.nr_sequencia and f.nr_seq_conta_rec		= e.nr_seq_conta_rec and f.nr_sequencia			= e.nr_seq_proc_rec and g.nr_sequencia			= f.nr_seq_conta_proc and b.ie_status			= 'F' and g.ie_status			<> 'D' and coalesce(e.vl_liberado,0)		> 0 and a.ie_status			!= '3' 
	 
union all
 
	select	coalesce(e.vl_liberado,0) vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		b.ie_tipo_guia, 
		CASE WHEN g.ie_tipo_despesa='1' THEN  'P'  ELSE 'O' END  ie_tipo_item, 
		d.nr_seq_titular nr_seq_segurado, 
		b.nr_seq_prestador_exec nr_seq_prestador, 
		b.dt_atendimento_referencia, 
		'RG' ie_tipo_conta, 
		'D' ie_tipo_benef, 
		b.nr_seq_conta_princ nr_seq_conta_princ, 
		g.nr_sequencia nr_seq_item 
	FROM pls_conta_proc g, pls_rec_glosa_proc f, pls_conta_rec_resumo_item e, pls_segurado d, pls_rec_glosa_conta a, pls_conta b
LEFT OUTER JOIN pls_tipo_atendimento c ON (b.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE b.nr_sequencia			= a.nr_seq_conta  and d.nr_sequencia			= b.nr_seq_segurado and e.nr_seq_conta_rec		= a.nr_sequencia and f.nr_seq_conta_rec		= e.nr_seq_conta_rec and f.nr_sequencia			= e.nr_seq_proc_rec and g.nr_sequencia			= f.nr_seq_conta_proc and b.ie_status			= 'F' and g.ie_status			<> 'D' and coalesce(e.vl_liberado,0)		> 0 and a.ie_status			!= '3' 
	 
union all
 
	select	coalesce(e.vl_liberado,0) vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		b.ie_tipo_guia, 
		'O' ie_tipo_item, 
		b.nr_seq_segurado, 
		b.nr_seq_prestador_exec nr_seq_prestador, 
		b.dt_atendimento_referencia, 
		'RG' ie_tipo_conta, 
		'T' ie_tipo_benef, 
		b.nr_seq_conta_princ nr_seq_conta_princ, 
		g.nr_sequencia nr_seq_item 
	FROM pls_conta_mat g, pls_rec_glosa_mat f, pls_conta_rec_resumo_item e, pls_segurado d, pls_rec_glosa_conta a, pls_conta b
LEFT OUTER JOIN pls_tipo_atendimento c ON (b.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE b.nr_sequencia			= a.nr_seq_conta  and d.nr_sequencia			= b.nr_seq_segurado and e.nr_seq_conta_rec		= a.nr_sequencia and f.nr_seq_conta_rec		= e.nr_seq_conta_rec and f.nr_sequencia			= e.nr_seq_mat_rec and g.nr_sequencia			= f.nr_seq_conta_mat and b.ie_status			= 'F' and g.ie_status			<> 'D' and coalesce(e.vl_liberado,0)		> 0 and a.ie_status			!= '3' 
	 
union all
 
	select	coalesce(e.vl_liberado,0) vl_total, 
		a.nr_sequencia, 
		c.cd_tiss, 
		b.ie_tipo_guia, 
		'O' ie_tipo_item, 
		d.nr_seq_titular nr_seq_segurado, 
		b.nr_seq_prestador_exec nr_seq_prestador, 
		b.dt_atendimento_referencia, 
		'RG' ie_tipo_conta, 
		'D' ie_tipo_benef, 
		b.nr_seq_conta_princ nr_seq_conta_princ, 
		g.nr_sequencia nr_seq_item 
	FROM pls_conta_mat g, pls_rec_glosa_mat f, pls_conta_rec_resumo_item e, pls_segurado d, pls_rec_glosa_conta a, pls_conta b
LEFT OUTER JOIN pls_tipo_atendimento c ON (b.nr_seq_tipo_atendimento = c.nr_sequencia)
WHERE b.nr_sequencia			= a.nr_seq_conta  and d.nr_sequencia			= b.nr_seq_segurado and e.nr_seq_conta_rec		= a.nr_sequencia and f.nr_seq_conta_rec		= e.nr_seq_conta_rec and f.nr_sequencia			= e.nr_seq_mat_rec and g.nr_sequencia			= f.nr_seq_conta_mat and b.ie_status			= 'F' and g.ie_status			<> 'D' and a.ie_status			!= '3' ) t 
group by	t.nr_sequencia, t.cd_tiss, t.ie_tipo_guia, t.ie_tipo_item, t.nr_seq_segurado, t.nr_seq_prestador, t.dt_atendimento_referencia, t.ie_tipo_conta, t.ie_tipo_benef, t.nr_seq_conta_princ 
order by to_date(t.dt_atendimento_referencia) asc;

