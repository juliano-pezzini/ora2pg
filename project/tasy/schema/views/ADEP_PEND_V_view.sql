-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW adep_pend_v (nr_seq_apresent, ie_tipo_item, ds_tipo_item, ds_tipo_item_plural, ie_laboratorio, cd_estabelecimento, nr_atendimento, nr_prescricao, cd_prescritor, nm_prescritor, dt_prescricao, dt_inicio_prescr, dt_validade_prescr, dt_liberacao, dt_lib_horario, cd_setor_prescr, ie_setor_processo_gedipa, nr_seq_item, ie_acm_sn, ie_di, cd_item, ie_origem_proced, nr_seq_proc_interno, ds_item, nr_agrupamento, cd_intervalo, ds_diluente, ds_topografia, ie_assoc_adep, nr_seq_area_prep, nr_seq_lote, nr_seq_processo, nr_seq_horario, dt_horario, qt_pend, cd_um, qt_dose, cd_unidade_medida_dose, ie_via, cd_pessoa_evento, nm_pessoa_evento, dt_liberacao_medico, ie_urgencia, cd_local_estoque, nr_seq_superior, ie_item_superior, ds_justificativa, nr_sequencia_proc, cd_local_estoque_mat, cd_local_estoque_aux, cd_setor_aux, ie_conferencia, ie_higienizacao, ie_preparo, ds_observacao, ie_medicacao_paciente, ie_dose_especial, nr_seq_cpoe) AS select	1 nr_seq_apresent,
		'D' ie_tipo_item,
		/*'Dieta oral' */
 obter_desc_expressao(287913) ds_tipo_item,
		/*'Dietas orais' */
 obter_desc_expressao(490024) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		-1 nr_seq_item,
		null ie_acm_sn,
		null ie_di,
		c.cd_refeicao cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,
		substr(obter_valor_dominio(99,c.cd_refeicao),1,240) ds_item,
		(null)::numeric  nr_agrupamento,
		'' cd_intervalo,
		null ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null ie_conferencia,
		null ie_higienizacao,
		null ie_preparo,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_dieta_cpoe nr_seq_cpoe
FROM	pessoa_fisica p,
		prescr_dieta_hor c,
		prescr_dieta b,
		prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_dieta = b.nr_sequencia
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	not exists ( select	1
			from	prescr_dieta x
			where	x.nr_prescricao = c.nr_prescricao
			and	x.nr_sequencia	= c.nr_seq_dieta
			and	x.dt_suspensao is not null)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	2 nr_seq_apresent,
		'S' ie_tipo_item,
		/*'Suplemento oral' */
 obter_desc_expressao(298960) ds_tipo_item,
		/*'Suplementos orais' */
 obter_desc_expressao(490025) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,	
		(null)::numeric  nr_seq_proc_interno,
		m.ds_material ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_dieta_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 12
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	3 nr_seq_apresent,
		'M' ie_tipo_item,
		/*'Medicamento'*/
 obter_desc_expressao(10652448) ds_tipo_item,
		/*'Medicamentos'*/
 obter_desc_expressao(293085) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		coalesce(a.dt_liberacao,b.dt_lib_material),
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,	
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		coalesce(a.dt_liberacao_medico,b.dt_lib_material),
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		b.ie_medicacao_paciente,
		coalesce(c.ie_dose_especial,'N') ie_dose_especial,
		b.nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	a.dt_suspensao is null
and	b.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	coalesce(b.ie_administrar,'S') <> 'N'
and	b.ie_agrupador = 1
and	c.dt_recusa is null
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	4 nr_seq_apresent,
		'MAT' ie_tipo_item,
		/*'Material' */
 obter_desc_expressao(292952) ds_tipo_item,
		/*'Materiais'*/
 obter_desc_expressao(292949) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(b.ie_administrar,'S') <> 'N'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 2
and	coalesce(a.ie_adep,'S') = 'S'
and	obter_se_material_adep(a.cd_estabelecimento,b.cd_material) = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	CASE WHEN b.nr_seq_exame IS NULL THEN  5  ELSE 8 END  nr_seq_apresent,
		CASE WHEN b.nr_seq_exame IS NULL THEN  'P'  ELSE 'L' END  ie_tipo_item,
		CASE WHEN b.nr_seq_exame IS NULL THEN  /*'Procedimento'*/
 obter_desc_expressao(296422)  ELSE /*'Coleta'*/ obter_desc_expressao(285474) END  ds_tipo_item,
		CASE WHEN b.nr_seq_exame IS NULL THEN  /*'Procedimentos'*/
 obter_desc_expressao(296465)  ELSE /*'Coletas'*/ obter_desc_expressao(314959) END  ds_tipo_item_plural,
		CASE WHEN b.nr_seq_exame IS NULL THEN  'N'  ELSE 'S' END  ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		'N' ie_di,
		to_char(b.cd_procedimento) cd_item,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		CASE WHEN b.nr_seq_exame IS NULL THEN  substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)  ELSE substr(obter_desc_exame(b.nr_seq_exame),1,240) END  ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		substr(obter_desc_topografia_dor(b.nr_seq_topografia),1,60) ds_topografia,
		substr(obter_se_assoc_proc_adep(b.cd_procedimento,b.ie_origem_proced),1,1) ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null,
		null,
		null,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_proc_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_seq_procedimento = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.nr_seq_solic_sangue is null
and	b.nr_seq_derivado is null
and	b.nr_seq_prot_glic is null
and	((b.nr_seq_proc_interno is null) or (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'NC'))
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	6 nr_seq_apresent,
		'R' ie_tipo_item,
		/*'Recomendacao'*/
 obter_desc_expressao(297341) ds_tipo_item,
		/*'Recomendacoes' */
 obter_desc_expressao(297348) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN padroniza_horario(b.ds_horarios)='' THEN  'S'  ELSE 'N' END  ie_acm_sn,
		'N' ie_di,
		coalesce(to_char(b.cd_recomendacao), b.ds_recomendacao) cd_item,
		(null)::numeric  ie_origem_proced,	
		(null)::numeric  nr_seq_proc_interno,	
		substr(obter_rec_prescricao(b.nr_sequencia, b.nr_prescricao),1,240) ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null,
		null,
		null,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_rec_cpoe nr_seq_cpoe
FROM pessoa_fisica p, prescr_rec_hor c, prescr_medica a, prescr_recomendacao b
LEFT OUTER JOIN tipo_recomendacao y ON (b.cd_recomendacao = y.cd_tipo_recomendacao)
WHERE c.nr_seq_recomendacao = b.nr_sequencia  and c.nr_prescricao = b.nr_prescricao and b.nr_prescricao = a.nr_prescricao and a.cd_prescritor	= p.cd_pessoa_fisica and c.dt_fim_horario is null and c.dt_suspensao is null and a.dt_suspensao is null and coalesce(c.ie_situacao,'A') = 'A' and coalesce(c.ie_horario_especial,'N') <> 'S' and coalesce(a.ie_adep,'S') = 'S' and coalesce(y.ie_adep,'S') = 'S' and Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	7 nr_seq_apresent,
		'E' ie_tipo_item,
		/*'SAE' */
 obter_desc_expressao(297968) ds_tipo_item,
		/*'SAE'*/
 obter_desc_expressao(297968) ds_tipo_item_plural,
		'N' ie_laboratorio,
		(null)::numeric  cd_estabelecimento,
		a.nr_atendimento,
		a.nr_sequencia,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		(null)::numeric  cd_setor_prescr,
		'N' ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE CASE WHEN padroniza_horario(b.ds_horarios)='' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		'N' ie_di,
		to_char(b.nr_seq_proc) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,		
		substr(obter_desc_intervencoes(b.nr_seq_proc),1,200)||CASE WHEN b.ie_lado IS NULL THEN ''  ELSE ' Lado: '||obter_valor_dominio(1372,b.ie_lado) END  ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		substr(obter_desc_topografia_dor(b.nr_seq_topografia),1,60) ds_topografia,
		'S' ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		to_date(null) dt_liberacao_medico,
		'' ie_urgencia,
		(null)::numeric  cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		(null)::numeric  cd_local_estoque_aux,
		(null)::numeric   cd_setor_aux,
		null,
		null,
		null,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		0 nr_seq_cpoe
from	pessoa_fisica p,
		pe_prescr_proc_hor c,
		pe_prescr_proc b,
		pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	c.nr_seq_pe_prescr = b.nr_seq_prescr
and	b.nr_seq_prescr = a.nr_sequencia
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	coalesce(b.ie_adep,'N') in ('S','M')
and	coalesce(a.ie_situacao, 'A') = 'A'
/*and	not exists (	select	1
			from	pe_prescr_proc_hor x
			where	x.dt_fim_horario is not null
			and	x.nr_sequencia		<> c.nr_sequencia
			and	x.nr_seq_pe_proc 	= b.nr_sequencia
			and	x.nr_seq_pe_prescr 	= b.nr_seq_prescr
			and	x.nr_seq_proc		= c.nr_seq_proc)*/


union

select	8 nr_seq_apresent,
		'ME' ie_tipo_item,
		/*'Medicamento'*/
 obter_desc_expressao(10652448) ds_tipo_item,
		/*'Medicamentos'*/
 obter_desc_expressao(293085) ds_tipo_item_plural,				
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,	
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		b.ie_medicacao_paciente,
		'N' ie_dose_especial,
		nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 14
and	c.dt_recusa is null
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	9 nr_seq_apresent,
		'MAP' ie_tipo_item,
		/*'Medicamento'*/
 obter_desc_expressao(10652448) ds_tipo_item,
		/*'Medicamentos'*/
 obter_desc_expressao(293085) ds_tipo_item_plural,	
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,	
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		b.nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		b.ie_medicacao_paciente,
		'N' ie_dose_especial,
		0 nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 5
and	c.dt_recusa is null
--and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento) = 'S'

and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	10 nr_seq_apresent,
		'NE' ie_tipo_item,
		/*'Suporte Nutricional Enteral'*/
 obter_desc_expressao(314222) ds_tipo_item,
		/*'Suporte Nutricional Enteral'*/
 obter_desc_expressao(314222) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,	
		(null)::numeric  nr_seq_proc_interno,
		m.ds_material ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		b.ie_medicacao_paciente,
		'N' ie_dose_especial,
		nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.ie_agrupador = 8
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(b.ie_status,'N') = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	11 nr_seq_apresent,
		'GIC' ie_tipo_item, 
		/*'Controle intensivo da glicemia' */
 obter_desc_expressao(489593) ds_tipo_item,
		/*'Controle intensivo da glicemia'*/
 obter_desc_expressao(489593) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		'N' ie_di,
		to_char(b.cd_procedimento) cd_item,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		CASE WHEN b.nr_seq_prot_glic IS NULL THEN  substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)  ELSE substr(obter_nome_prot_glic(b.nr_seq_prot_glic),1,200) END  ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		substr(obter_desc_topografia_dor(b.nr_seq_topografia),1,60) ds_topografia,
		substr(obter_se_assoc_proc_adep(b.cd_procedimento,b.ie_origem_proced),1,1) ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null,
		null,
		null,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		nr_seq_proc_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_seq_procedimento = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.nr_seq_solic_sangue is null
and	b.nr_seq_derivado is null
and	b.nr_seq_prot_glic is not null
and	((b.nr_seq_proc_interno is not null) and (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'CIG'))
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	12 nr_seq_apresent,
		'CCG' ie_tipo_item, 
		/*'Controle convencional da glicemia'*/
 obter_desc_expressao(308117) ds_tipo_item,
		/*'Controle convencional da glicemia'*/
 obter_desc_expressao(308117) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		'N' ie_di,
		to_char(b.cd_procedimento) cd_item,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		--decode(b.nr_seq_exame, null, substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240), substr(obter_desc_exame(b.nr_seq_exame),1,240)) ds_item,

		CASE WHEN nr_seq_prot_glic IS NULL THEN  substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)  ELSE substr(obter_nome_prot_glic(nr_seq_prot_glic),1,200) END  ds_item,
		(null)::numeric  nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		null ds_diluente,
		substr(obter_desc_topografia_dor(b.nr_seq_topografia),1,60) ds_topografia,
		substr(obter_se_assoc_proc_adep(b.cd_procedimento,b.ie_origem_proced),1,1) ie_assoc_adep,
		(null)::numeric  nr_seq_area_prep,
		(null)::numeric  nr_seq_lote,
		(null)::numeric  nr_seq_processo,	
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		1 qt_pend,
		'' cd_um,
		1 qt_dose,
		'' cd_unidade_medida_dose,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null,
		null,
		null,
		'' ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		nr_seq_proc_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_seq_procedimento = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	b.nr_seq_solic_sangue is null
and	b.nr_seq_derivado is null
and	b.nr_seq_prot_glic is not null
and	((b.nr_seq_proc_interno is not null) and (obter_ctrl_glic_proc(b.nr_seq_proc_interno) = 'CCG'))
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	13 nr_seq_apresent,
		'NAN' ie_tipo_item,
		/*'NPT Adulta'*/
 obter_desc_expressao(305331) ds_tipo_item,
		/*'NPT Adulta'*/
 obter_desc_expressao(305331) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		coalesce(a.dt_liberacao,b.dt_lib_material),
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,	
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		coalesce(a.dt_liberacao_medico,b.dt_lib_material),
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	substr(obter_status_solucao_prescr(6, b.nr_prescricao, b.nr_seq_nut_pac),1,3) not in ('T', 'S')
and	b.ie_agrupador = 11
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	14 nr_seq_apresent,
		'O' ie_tipo_item,
		/*'Gasoterapia'*/
 obter_desc_expressao(290567) ds_tipo_item,
		/*'Gasoterapias'*/
 obter_desc_expressao(330390) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		obter_nome_pf(a.cd_prescritor) nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.dt_liberacao,
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		null ie_acm_sn,
		null ie_di,
		to_char(b.nr_seq_gas) cd_item,
		null ie_origem_proced,
		null nr_seq_proc_interno,	
		obter_desc_gas(b.nr_seq_gas) ds_item,
		null nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		'' ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		null nr_seq_area_prep,	
		null nr_seq_lote,
		null nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		/*b.qt_gasoterapia*/
null qt_pend,
		b.cd_unidade_medida cd_um,
		b.qt_gasoterapia qt_dose,
		b.ie_unidade_medida,
		'' ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		a.dt_liberacao_medico,
		'' ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		(null)::numeric  nr_seq_superior,
		null ie_item_superior,
		null ds_justificativa,
		null nr_sequencia_proc,
		null cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		null ie_conferencia,
		null ie_higienizacao,
		null ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		'N' ie_medicacao_paciente,
		'N' ie_dose_especial,
		b.nr_seq_gas_cpoe nr_seq_cpoe
from	prescr_gasoterapia_hor c,
		prescr_gasoterapia b,
		prescr_medica a
where	c.nr_seq_gasoterapia = b.nr_sequencia
and		c.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = a.nr_prescricao
and		c.dt_fim_horario is null
and		c.dt_suspensao is null
and		coalesce(c.ie_horario_especial,'N') <> 'S'
and		coalesce(substr(Obter_Status_Gasoterapia(b.nr_sequencia, 'C'),1,80),'N') not in ('T', 'S')
and		coalesce(a.ie_adep,'S') = 'S'
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	15 nr_seq_apresent,
		'LD' ie_tipo_item,
		/*'Leite e derivados'*/
 obter_desc_expressao(304869) ds_tipo_item,
		/*'Leite e derivados'*/
 obter_desc_expressao(304869) ds_tipo_item_plural,
		'N' ie_laboratorio,
		a.cd_estabelecimento,
		a.nr_atendimento,
		a.nr_prescricao,
		a.cd_prescritor,
		p.nm_pessoa_fisica nm_prescritor,
		a.dt_prescricao,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		coalesce(a.dt_liberacao,b.dt_lib_material),
		c.dt_lib_horario,
		a.cd_setor_atendimento cd_setor_prescr,
		substr(obter_se_setor_processo_gedipa(a.cd_setor_atendimento),1,1) ie_setor_processo_gedipa,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		coalesce(b.ie_bomba_infusao,'N') ie_di,
		to_char(b.cd_material) cd_item,
		(null)::numeric  ie_origem_proced,
		(null)::numeric  nr_seq_proc_interno,	
		m.ds_material ds_item,
		b.nr_agrupamento nr_agrupamento,
		b.cd_intervalo cd_intervalo,
		substr(obter_diluicao_medic_adep(c.nr_sequencia),1,240) ds_diluente,
		null ds_topografia,
		'N' ie_assoc_adep,
		(c.nr_seq_area_prep)::numeric  nr_seq_area_prep,	
		c.nr_seq_lote nr_seq_lote,
		c.nr_seq_processo nr_seq_processo,
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		c.qt_dispensar_hor qt_pend,
		c.cd_unidade_medida cd_um,
		c.qt_dose,
		c.cd_unidade_medida_dose,
		b.ie_via_aplicacao ie_via,
		'' cd_pessoa_evento,
		'' nm_pessoa_evento,
		coalesce(a.dt_liberacao_medico,b.dt_lib_material),
		b.ie_urgencia,
		obter_local_estoque_setor(a.cd_setor_atendimento, a.cd_estabelecimento) cd_local_estoque,
		c.nr_seq_superior,
		b.ie_item_superior,
		b.ds_justificativa,
		null nr_sequencia_proc,
		b.cd_local_estoque cd_local_estoque_mat,
		obter_local_estoque_setor(Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS'), a.cd_estabelecimento) cd_local_estoque_aux,
		Obter_Unidade_Atendimento(a.nr_atendimento,'IAA','CS') cd_setor_aux,
		coalesce(b.ie_conferencia,'S') ie_conferencia,
		coalesce(b.ie_higienizacao,'S') ie_higienizacao,
		coalesce(b.ie_preparo,'S') ie_preparo,
		substr(b.ds_observacao,1,4000) ds_observacao,
		b.ie_medicacao_paciente,
		coalesce(c.ie_dose_especial,'N') ie_dose_especial,
		b.nr_seq_mat_cpoe nr_seq_cpoe
from	pessoa_fisica p,
		material m,
        prescr_leite_deriv e,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_seq_material = b.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.cd_material	= m.cd_material
and	a.cd_prescritor	= p.cd_pessoa_fisica
and	e.nr_prescricao	= b.nr_prescricao
and e.nr_sequencia	= b.nr_seq_leite_deriv
and	c.dt_fim_horario is null
and	c.dt_suspensao is null
and	a.dt_suspensao is null
and	b.dt_suspensao is null
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.ie_horario_especial,'N') <> 'S'
and	coalesce(b.ie_administrar,'S') <> 'N'
and	b.ie_agrupador = 16
and	c.dt_recusa is null
and	obter_se_gerar_item_adep('M',b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'N') = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S';

