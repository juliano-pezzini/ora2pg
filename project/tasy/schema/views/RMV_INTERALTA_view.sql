-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW rmv_interalta (coligada, prontuario, nomepaciente, datanascimento, dataadmissao, horaadmissao, sexo, peso, endereco, bairro, cidade, telefone, cep, codconvenio, codclinica, codespecialidade, dsespecialidade, email, dataalta, horaalta, tipoalta) AS select	distinct '1' coligada,
	substr(to_char(a.nr_prontuario),1,9) prontuario,
	substr(a.nm_pessoa_fisica,1,50) nomepaciente,
	trunc(a.dt_nascimento) datanascimento,
	trunc(b.dt_entrada) dataadmissao,
	to_char(b.dt_entrada,'hh24mi') horaadmissao,
	a.ie_sexo sexo,
	null peso,
	substr(c.ds_endereco ||', NÂº '||coalesce(nr_endereco, ds_compl_end) ||' '||ds_complemento,1,40) endereco,
	substr(c.ds_bairro,1,20) bairro,
	substr(c.ds_municipio,1,25) cidade,
	substr(c.nr_telefone,1,14) telefone,
	substr(c.cd_cep,1,10) cep,
	substr(d.cd_convenio,1,50) codconvenio,
	CASE WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20205 THEN '152' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20204 THEN '82' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20502 THEN '85' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20201 THEN '78' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20202 THEN '79' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=25 THEN null WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=24 THEN '88' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20503 THEN '84' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=20203 THEN '80' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=86 THEN '78' WHEN OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS')=83 THEN '80'  ELSE OBTER_UNIDADE_ATENDIMENTO(b.nr_atendimento,'PI','CS') END  codclinica,
	obter_especialidade_medico(b.cd_medico_resp,'C') codespecialidade,
	obter_especialidade_medico(b.cd_medico_resp,'D') dsespecialidade,
	substr(c.ds_email,1,40) email,
	trunc(b.dt_alta) dataalta,
	to_char(b.dt_alta,'hh24mi') horaalta,
	(select CASE WHEN ie_obito='S' THEN  'O' WHEN ie_obito='N' THEN (CASE WHEN ie_transferencia='S' THEN 'T'  ELSE 'A' END ) END
	FROM 	motivo_alta
	where 	cd_motivo_alta = b.cd_motivo_alta) tipoalta
FROM atend_categoria_convenio d, compl_pessoa_fisica c, pessoa_fisica a, atendimento_paciente b
LEFT OUTER JOIN motivo_alta e ON (b.cd_motivo_alta = e.cd_motivo_alta)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and a.cd_pessoa_fisica = c.cd_pessoa_fisica and b.nr_atendimento = d.nr_atendimento  and coalesce(IE_GERA_NOVO_ATEND,'N')  = 'N' and b.ie_tipo_atendimento = 1 and c.ie_tipo_complemento = 1;

