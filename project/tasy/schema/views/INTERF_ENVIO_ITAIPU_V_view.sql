-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW interf_envio_itaipu_v (tp_registro, cd_registro, dt_geracao, cd_matricula, nm_paciente, dt_atendimento, cd_convenio, cd_cpf_medico, nm_medico, nr_crm_medico, cd_procedimento, qt_procedimento, ds_espaco, vl_procedimento, nr_conta, cd_setor_atendimento, qt_lancamento, nr_seq_protocolo) AS select
	1						tp_registro, 
	1						cd_registro, 
	LOCALTIMESTAMP					dt_geracao, 
	0						cd_matricula, 
	' '						nm_paciente, 
	LOCALTIMESTAMP					dt_atendimento, 
	' '						cd_convenio, 
	' '						cd_cpf_medico, 
	' '						nm_medico, 
	' '						nr_crm_medico, 
	' '						cd_procedimento, 
	0						qt_procedimento, 
	' '						ds_espaco, 
	0						vl_procedimento, 
	0						nr_conta, 
	'0'						cd_setor_atendimento, 
	0						qt_lancamento, 
	a.nr_seq_protocolo				nr_seq_protocolo 
FROM	w_interf_conta_header a 

union all
 
 /* Movimento do Arquivo - Demais procedimentos */
 
select 
	2						tp_registro, 
	2						cd_registro, 
	LOCALTIMESTAMP					dt_geracao, 
	coalesce(somente_numero(a.cd_usuario_convenio),0) 
							cd_matricula, 
	substr(a.nm_paciente,1,30)		nm_paciente, 
	trunc(a.dt_entrada)			dt_atendimento, 
	'0536H'					cd_convenio, 
	coalesce(b.nr_cpf_executor,' ')		cd_cpf_medico, 
	coalesce(substr(b.nm_medico_executor,1,30),' ') 
							nm_medico, 
	coalesce(substr(b.nr_crm_executor,1,5),' ') 
							nr_crm_medico, 
	coalesce(substr(b.cd_item_convenio,1,8),' ') 
							cd_procedimento, 
	sum(b.qt_item)				qt_procedimento, 
	' '						ds_espaco, 
	sum(b.vl_total_item * 100)		vl_procedimento, 
	b.nr_interno_conta			nr_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10)	cd_setor_atendimento, 
	0						qt_lancamento, 
	a.nr_seq_protocolo				nr_seq_protocolo 
from	w_interf_conta_cab a, 
	w_interf_conta_item b 
where	b.nr_interno_conta	= a.nr_interno_conta 
and	b.cd_area_proc not in (4,13) 
and	b.ie_tipo_item	= 1 
group by 
	coalesce(somente_numero(a.cd_usuario_convenio),0), 
	substr(a.nm_paciente,1,30), 
	trunc(a.dt_entrada), 
	coalesce(b.nr_cpf_executor,' '), 
	coalesce(substr(b.nm_medico_executor,1,30),' '), 
	coalesce(substr(b.nr_crm_executor,1,5),' '), 
	coalesce(substr(b.cd_item_convenio,1,8),' '), 
	b.nr_interno_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10), 
	a.nr_seq_protocolo 

union all
 
 /* Movimento do Arquivo - Procedimentos cir√∫rgicos */
 
select 
	2						tp_registro, 
	2						cd_registro, 
	LOCALTIMESTAMP					dt_geracao, 
	coalesce(somente_numero(a.cd_usuario_convenio),0) 
							cd_matricula, 
	substr(a.nm_paciente,1,30)		nm_paciente, 
	trunc(a.dt_entrada)			dt_atendimento, 
	'0536H'					cd_convenio, 
	coalesce(b.nr_cpf_executor,' ')		cd_cpf_medico, 
	coalesce(substr(b.nm_medico_executor,1,30),' ') 
							nm_medico, 
	coalesce(substr(b.nr_crm_executor,1,5),' ') 
							nr_crm_medico, 
	coalesce(CASE WHEN b.cd_funcao_executor=2 THEN '77020014' WHEN b.cd_funcao_executor=3 THEN '77020022' WHEN b.cd_funcao_executor=4 THEN '77020030' WHEN b.cd_funcao_executor=6 THEN '77020049' WHEN b.cd_funcao_executor=8 THEN '77020049' WHEN b.cd_funcao_executor=5 THEN CASE WHEN b.nr_porte_anestesico=1 THEN '77010019' WHEN b.nr_porte_anestesico=2 THEN '77010027' WHEN b.nr_porte_anestesico=3 THEN '77010035' WHEN b.nr_porte_anestesico=4 THEN '77010043' WHEN b.nr_porte_anestesico=5 THEN '77010051' WHEN b.nr_porte_anestesico=6 THEN '77010060' WHEN b.nr_porte_anestesico=7 THEN '77010078'  ELSE substr(b.cd_item_convenio,1,8) END   ELSE substr(b.cd_item_convenio,1,8) END ,' ')	cd_procedimento, 
	sum(b.qt_item)			qt_procedimento, 
	' '						ds_espaco, 
	sum((b.vl_honorario + b.vl_custo_oper) * 100)		vl_procedimento, 
	b.nr_interno_conta			nr_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10)	cd_setor_atendimento, 
	0						qt_lancamento, 
	a.nr_seq_protocolo				nr_seq_protocolo 
from	w_interf_conta_cab a, 
	w_interf_conta_item b 
where	b.nr_interno_conta	= a.nr_interno_conta 
and	b.cd_area_proc in (4,13) 
and	b.ie_tipo_item	= 1 
group by 
	coalesce(somente_numero(a.cd_usuario_convenio),0), 
	substr(a.nm_paciente,1,30), 
	trunc(a.dt_entrada), 
	coalesce(b.nr_cpf_executor,' '), 
	coalesce(substr(b.nm_medico_executor,1,30),' '), 
	coalesce(substr(b.nr_crm_executor,1,5),' '), 
	coalesce(CASE WHEN b.cd_funcao_executor=2 THEN '77020014' WHEN b.cd_funcao_executor=3 THEN '77020022' WHEN b.cd_funcao_executor=4 THEN '77020030' WHEN b.cd_funcao_executor=6 THEN '77020049' WHEN b.cd_funcao_executor=8 THEN '77020049' WHEN b.cd_funcao_executor=5 THEN CASE WHEN b.nr_porte_anestesico=1 THEN '77010019' WHEN b.nr_porte_anestesico=2 THEN '77010027' WHEN b.nr_porte_anestesico=3 THEN '77010035' WHEN b.nr_porte_anestesico=4 THEN '77010043' WHEN b.nr_porte_anestesico=5 THEN '77010051' WHEN b.nr_porte_anestesico=6 THEN '77010060' WHEN b.nr_porte_anestesico=7 THEN '77010078'  ELSE substr(b.cd_item_convenio,1,8) END   ELSE substr(b.cd_item_convenio,1,8) END ,' '), 
	b.nr_interno_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10), 
	a.nr_seq_protocolo 

union all
 
 /* Movimento do Arquivo - matmed */
 
select 
	2						tp_registro, 
	2						cd_registro, 
	LOCALTIMESTAMP						dt_geracao, 
	coalesce(somente_numero(a.cd_usuario_convenio),0)		cd_matricula, 
	substr(a.nm_paciente,1,30)				nm_paciente, 
	trunc(a.dt_entrada)					dt_atendimento, 
	'0536H'						cd_convenio, 
	' '						cd_cpf_medico, 
	' '						nm_medico, 
	' '						nr_crm_medico, 
	'61090603'					cd_procedimento, 
	1						qt_procedimento, 
	' '						ds_espaco, 
	sum(b.vl_total_item * 100)				vl_procedimento, 
	b.nr_interno_conta					nr_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10)	cd_setor_atendimento, 
	0						qt_lancamento, 
	a.nr_seq_protocolo					nr_seq_protocolo 
from	w_interf_conta_cab a, 
	w_interf_conta_item b 
where	b.nr_interno_conta	= a.nr_interno_conta 
and	b.ie_tipo_item	= 2 
group by 
	coalesce(somente_numero(a.cd_usuario_convenio),0), 
	substr(a.nm_paciente,1,30), 
	trunc(a.dt_entrada), 
	b.nr_interno_conta, 
	substr(obter_unidade_atendimento(a.nr_atendimento, 'P', 'CS'),1,10), 
	a.nr_seq_protocolo 
 
union all
 
 /* Trailler do Arquivo */
 
select 
	9						tp_registro, 
	9						cd_registro, 
	LOCALTIMESTAMP					dt_geracao, 
	0						cd_matricula, 
	' '						nm_paciente, 
	LOCALTIMESTAMP					dt_atendimento, 
	' '						cd_convenio, 
	' '						cd_cpf_medico, 
	' '						nm_medico, 
	' '						nr_crm_medico, 
	' '						cd_procedimento, 
	0						qt_procedimento, 
	' '						ds_espaco, 
	0						vl_procedimento, 
	99999999999					nr_conta, 
	'0'						cd_setor_atendimento, 
	0						qt_lancamento, 
	a.nr_seq_protocolo				nr_seq_protocolo 
from	w_interf_conta_trailler a;

