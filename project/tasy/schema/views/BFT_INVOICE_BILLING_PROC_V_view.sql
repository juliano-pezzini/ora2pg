-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW bft_invoice_billing_proc_v (ie_order, procedure_code, catalog_origin_id, nr_account, encounter_id, type_of_catalogue, vl_procedure) AS select  x.ie_order,
        x.procedure_code,
        x.catalog_origin_id,
        x.nr_account,
        x.encounter_id,
        x.Type_of_catalogue,
        x.vl_procedure
FROM (
select  1 ie_order, -- DRG
        ltrim(b.cd_procedimento_loc,'0') procedure_code,
        b.ie_origem_proced catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        b.ie_origem_proced Type_of_catalogue,
        replace(a.vl_procedimento,',','.') vl_procedure
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento  = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 15
and     b.cd_procedimento_loc is not null
and     a.cd_motivo_exc_conta is null

union all

select  2 ie_order, -- Accommodation
        ltrim(b.cd_sistema_ant,'0') procedure_code,
        b.ie_origem_proced catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        b.ie_origem_proced Type_of_catalogue,
        replace(sum(a.vl_procedimento),',','.') vl_procedure
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento  = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 4
and     b.ie_classificacao = 3
and     b.cd_procedimento_loc is not null
and     a.cd_motivo_exc_conta is null
and     b.cd_sistema_ant is not null
group by b.cd_sistema_ant, b.ie_origem_proced, a.nr_interno_conta, a.nr_atendimento, b.ie_origem_proced

union all

select  3 ie_order, -- MBS
        ltrim(b.cd_procedimento_loc,'0') procedure_code,
        b.ie_origem_proced catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        b.ie_origem_proced Type_of_catalogue,
        replace(a.vl_procedimento,',','.') vl_procedure
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento  = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 20
and     b.cd_procedimento_loc is not null
and     a.cd_motivo_exc_conta is null

union all

select  4 ie_order, -- Protheses
        b.cd_sistema_ant procedure_code,
        null catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        null Type_of_catalogue,
        replace(sum(a.vl_material),',','.') vl_procedure
from    material_atend_paciente a,
        material b
where   Obter_estrutura_material(b.cd_material,'G') = 12
and     a.cd_material = b.cd_material
and     a.cd_motivo_exc_conta is null
group by b.cd_sistema_ant, a.nr_interno_conta, a.nr_atendimento

union all

select  5 ie_order, -- Nurse Practitioner
        ltrim(b.cd_procedimento_loc,'0') procedure_code,
        b.ie_origem_proced catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        b.ie_origem_proced Type_of_catalogue,
        replace(a.vl_procedimento,',','.') vl_procedure
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento  = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 4
and     OBTER_DADOS_ESTRUT_PROC(b.cd_procedimento,b.ie_origem_proced,'C','A') = 60
and     b.cd_procedimento_loc is not null
and     a.cd_motivo_exc_conta is null

union all

select  6 ie_order, -- Others Self
        ltrim(coalesce(a.cd_procedimento_convenio,b.cd_procedimento_loc),'0') procedure_code,
        b.ie_origem_proced catalog_origin_id,
        a.nr_interno_conta nr_account,
        a.nr_atendimento encounter_id,
        b.ie_origem_proced Type_of_catalogue,
        replace(a.vl_procedimento,',','.') vl_procedure
from    procedimento_paciente a,
        procedimento b
where   a.cd_procedimento  = b.cd_procedimento
and     a.ie_origem_proced = b.ie_origem_proced
and     a.ie_origem_proced = 4
and     OBTER_DADOS_ESTRUT_PROC(b.cd_procedimento,b.ie_origem_proced,'C','A') <> 60
and     b.ie_classificacao not in (3)
and     b.cd_procedimento_loc is not null
and     a.cd_motivo_exc_conta is null) x
where x.vl_procedure > 0
order by ie_order;

