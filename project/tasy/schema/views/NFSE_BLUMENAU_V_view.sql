-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nfse_blumenau_v (assinatura, nr_seq_nota, inscricaoprestador, serierps, numerorps, tiporps, dataemissao, statusrps, tributacaorps, valorservicos, valordeducoes, valorpis, valorcofins, valorinss, valorir, valorcsll, codigoservico, aliquotaservicos, issretido, inscricaomunicipaltomador, inscricaoestadualtomador, razaosocialtomador, tipologradouro, logradouro, numeroendereco, complementoendereco, bairro, cidade, uf, cep, emailtomador, discriminacao, nr_sequencia) AS select	cd_assinatura_rps Assinatura, 	
	a.nr_sequencia nr_seq_nota, 	
	coalesce(substr(lpad(obter_dados_pf_pj('', a.cd_cgc_emitente, 'IM'), 8, '0'), 1, 30), '00000000') InscricaoPrestador, 	
	a.cd_serie_nf SerieRPS, 	
	a.nr_nota_fiscal NumeroRPS, 	
	'RPS' TipoRPS, 	
	to_char(a.dt_emissao, 'yyyy-mm-dd') DataEmissao, 	
	CASE WHEN a.ie_situacao=1 THEN  'N' WHEN a.ie_situacao=2 THEN  'C' WHEN a.ie_situacao=3 THEN  'C'  ELSE 'N' END  StatusRPS, 	
	CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='1' THEN  'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='2' THEN  'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='3' THEN  'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento, 14)='5' THEN  'J'  ELSE 'I' END  TributacaoRPS, 	
	campo_mascara(a.vl_total_nota, 2) ValorServicos, 	
	campo_mascara(a.vl_descontos, 2) ValorDeducoes, 	
	campo_mascara(CASE WHEN cd_cgc='' THEN  0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'PIS') END , 2) ValorPIS, 	
	campo_mascara(CASE WHEN cd_cgc='' THEN  0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'COFINS') END , 2) ValorCOFINS, 	
	campo_mascara(CASE WHEN cd_cgc='' THEN  0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'INSS') END , 2) ValorINSS, 	
	campo_mascara(CASE WHEN cd_cgc='' THEN  0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'IR') END , 2) ValorIR, 	
	campo_mascara(CASE WHEN cd_cgc='' THEN  0  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'V', 'CSLL') END , 2) ValorCSLL, 	
	coalesce(obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'P'),
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O')), 'CD'))CodigoServico,	 	
	'0.02' AliquotaServicos, 	
	CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='S' THEN 'true'  ELSE 'false' END  ISSRetido, 	
	CASE WHEN a.cd_cgc='' THEN null  ELSE CASE WHEN obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc,'CDM')='420240' THEN obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc,'IM')  ELSE null END  END  InscricaoMunicipalTomador, 	
	substr(obter_dados_pf_pj( null, cd_cgc, 'IE'), 1, 19) InscricaoEstadualTomador,	 	
	substr(tiss_eliminar_caractere(elimina_acentuacao(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc))), 1, 255) RazaoSocialTomador, 	
	'Rua' TipoLogradouro, 	
	substr(tiss_eliminar_caractere(elimina_acentuacao(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica,cd_cgc)='N' THEN ''  ELSE coalesce(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'EN'),'Endereco') END )),1,50) Logradouro, 	
	substr(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica,cd_cgc)='N' THEN ''  ELSE coalesce(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'NR'),'00') END ,1,25) NumeroEndereco, 	
	substr(tiss_eliminar_caractere(elimina_acentuacao(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica,cd_cgc)='N' THEN ''  ELSE coalesce(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CO'),'Complemento') END )),1,30) ComplementoEndereco, 	
	tiss_eliminar_caractere(elimina_acentuacao(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN substr(somente_nao_numero(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CI')) || ' - ' || obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'PAIS'),1,30)  ELSE coalesce(substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc,'B'),1,30),'Bairro') END )) Bairro, 	
	CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN ''  ELSE lpad(elimina_acentuacao(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CDMDV')),7,'0') END  Cidade, 	substr(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica,cd_cgc)='N' THEN ''  ELSE obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'UF') END ,1,2) UF, 	
	lpad(somente_numero(substr(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica,cd_cgc)='N' THEN ''  ELSE obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'CEP') END ,1,15)),8,'0') CEP, 	
	substr(tiss_eliminar_caractere(elimina_acentuacao(obter_dados_pf_pj_estab(a.cd_estabelecimento,cd_pessoa_fisica, cd_cgc, 'M'))), 1, 80) EmailTomador, 	
	coalesce(substr(obter_descricao_rps(a.cd_estabelecimento, a.nr_sequencia, 'DS_SERVICOS'), 1, 1000), 'Servicos') Discriminacao ,
	t.nr_sequencia
FROM 	nota_fiscal_lote_nfe l, 	
	nfe_transmissao_nf n, 	
	nfe_transmissao t, 	
	nota_fiscal a
where	l.nr_seq_transmissao = t.nr_sequencia 
and	t.nr_sequencia	= n.nr_seq_transmissao 
and	a.nr_sequencia = n.nr_seq_nota_fiscal 
and	l.nr_sequencia = (select max(nr_sequencia) from nota_fiscal_lote_nfe f where f.nr_seq_transmissao = t.nr_sequencia) order by a.nr_nota_fiscal;

