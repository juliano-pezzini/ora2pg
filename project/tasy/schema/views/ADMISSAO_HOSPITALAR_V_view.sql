-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW admissao_hospitalar_v (nr_atendimento, nr_atend_original, dt_entrada, cd_pessoa_fisica, cd_procedencia, ie_tipo_atendimento, cd_medico_resp, dt_alta, cd_motivo_alta, ie_permite_visita, ie_permite_visita_rel, ie_clinica, ie_clinica_ant, nr_seq_classificacao, dt_entrada_unidade, dt_saida_unidade, cd_setor_atendimento, cd_unidade_basica, cd_unidade_compl, cd_tipo_acomod_unid, cd_convenio, cd_categoria, cd_usuario_convenio, cd_empresa, cd_tipo_acomod_conv, nr_doc_convenio, ds_setor_atendimento, ds_convenio, ds_categoria, nm_medico, nm_paciente, nr_prontuario, dt_nascimento, cd_religiao, ie_carater_inter_sus, nr_seq_indicacao, cd_estabelecimento, nr_seq_tipo_acidente, dt_cancelamento, dt_saida_real, nm_usuario_saida, nr_seq_agrupamento, nr_seq_triagem_prioridade, nm_usuario_intern, ie_paciente_isolado) AS SELECT 	A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
        A.DT_ENTRADA,
        A.CD_PESSOA_FISICA,
        A.CD_PROCEDENCIA,
        A.IE_TIPO_ATENDIMENTO,
        A.CD_MEDICO_RESP,
        A.DT_ALTA,
        A.CD_MOTIVO_ALTA,
	A.IE_PERMITE_VISITA,
	A.IE_PERMITE_VISITA_REL,
	A.IE_CLINICA,
	A.IE_CLINICA_ANT,
	A.NR_SEQ_CLASSIFICACAO,
        B.DT_ENTRADA_UNIDADE,
        B.DT_SAIDA_UNIDADE,
        B.CD_SETOR_ATENDIMENTO,
        B.CD_UNIDADE_BASICA,
        B.CD_UNIDADE_COMPL,
        B.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_UNID,
        C.CD_CONVENIO,
        C.CD_CATEGORIA,
        C.CD_USUARIO_CONVENIO,
        C.CD_EMPRESA,
        C.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_CONV,
        C.NR_DOC_CONVENIO,
        S.DS_SETOR_ATENDIMENTO,
        (select substr(obter_nome_convenio(C.cd_convenio),1,200) ) DS_CONVENIO,
        (select substr(OBTER_CATEGORIA_CONVENIO(C.cd_convenio, C.cd_categoria),1,200) ) DS_CATEGORIA,
        M.NM_PESSOA_FISICA NM_MEDICO,
        P.NM_PESSOA_FISICA NM_PACIENTE,
        P.NR_PRONTUARIO,
        P.DT_NASCIMENTO,
        P.CD_RELIGIAO,
	A.IE_CARATER_INTER_SUS,
	A.nr_seq_indicacao,
	A.CD_ESTABELECIMENTO,
	A.NR_SEQ_TIPO_ACIDENTE,
	A.dt_cancelamento,
	A.DT_SAIDA_REAL,
	A.NM_USUARIO_SAIDA,
	S.NR_SEQ_AGRUPAMENTO,
	A.nr_seq_triagem_prioridade,
	A.nm_usuario_intern,
        A.ie_paciente_isolado
FROM    ATENDIMENTO_PACIENTE A,
        PESSOA_FISICA M,
        PESSOA_FISICA P,
        ATEND_PACIENTE_UNIDADE B,
        SETOR_ATENDIMENTO S,
        ATEND_CATEGORIA_CONVENIO C
WHERE 	A.CD_MEDICO_RESP  	= M.CD_PESSOA_FISICA
AND 	A.CD_PESSOA_FISICA   = P.CD_PESSOA_FISICA
and	A.NR_ATENDIMENTO 	= B.NR_ATENDIMENTO
and	B.nr_seq_interno	= (	select	coalesce(min(x.nr_seq_interno),0)	
					from 	atend_paciente_unidade x
					where	A.nr_atendimento = x.nr_atendimento
	  				and 	x.dt_entrada_unidade	=
						(select min(z.dt_entrada_unidade)
						from 	Setor_Atendimento y,
							atend_paciente_unidade z
						where 	A.nr_atendimento = z.nr_atendimento
		  				and 	z.cd_setor_atendimento	= y.cd_setor_atendimento
		  				and 	y.cd_classif_setor in (3,4,8,12)))
AND 	C.NR_ATENDIMENTO 	= A.NR_ATENDIMENTO
and 	C.nr_seq_interno	= (	select	coalesce(max(P.nr_seq_interno),0)
					from 	atend_categoria_convenio p
					where	P.nr_atendimento = A.nr_atendimento
					and 	P.dt_inicio_vigencia = 
						(	select max(q.dt_inicio_vigencia)
							from atend_categoria_convenio q
							where q.nr_atendimento = A.nr_atendimento))
AND 	B.CD_SETOR_ATENDIMENTO = S.CD_SETOR_ATENDIMENTO

union all

SELECT  A.NR_ATENDIMENTO,
	A.NR_ATEND_ORIGINAL,
        A.DT_ENTRADA,
        A.CD_PESSOA_FISICA,
        A.CD_PROCEDENCIA,
        A.IE_TIPO_ATENDIMENTO,
        A.CD_MEDICO_RESP,
        A.DT_ALTA,
        A.CD_MOTIVO_ALTA,
	A.IE_PERMITE_VISITA,
	A.IE_PERMITE_VISITA_REL,
	A.IE_CLINICA,
	A.IE_CLINICA_ANT, 
	A.NR_SEQ_CLASSIFICACAO,
        B.DT_ENTRADA_UNIDADE,
        B.DT_SAIDA_UNIDADE,
        B.CD_SETOR_ATENDIMENTO,
        B.CD_UNIDADE_BASICA,
        B.CD_UNIDADE_COMPL,
        B.CD_TIPO_ACOMODACAO CD_TIPO_ACOMOD_UNID,
        0 CD_CONVENIO,
        null CD_CATEGORIA,
        null CD_USUARIO_CONVENIO,
        0 CD_EMPRESA,
        0 CD_TIPO_ACOMOD_CONV,
        null NR_DOC_CONVENIO,
        S.DS_SETOR_ATENDIMENTO,
        null DS_CONVENIO,
        null DS_CATEGORIA,
        M.NM_PESSOA_FISICA NM_MEDICO,
        P.NM_PESSOA_FISICA NM_PACIENTE,
        P.NR_PRONTUARIO,
        P.DT_NASCIMENTO,
        P.CD_RELIGIAO,
	A.IE_CARATER_INTER_SUS,
	A.nr_seq_indicacao,
	A.CD_ESTABELECIMENTO,
	A.NR_SEQ_TIPO_ACIDENTE,
	A.dt_cancelamento,
	A.DT_SAIDA_REAL,
	A.NM_USUARIO_SAIDA,
	S.NR_SEQ_AGRUPAMENTO,
	A.nr_seq_triagem_prioridade,
	A.nm_usuario_intern,
        A.ie_paciente_isolado
FROM    ATENDIMENTO_PACIENTE A,
        PESSOA_FISICA M,
        PESSOA_FISICA P,
        ATEND_PACIENTE_UNIDADE B,
        SETOR_ATENDIMENTO S
WHERE 	A.CD_MEDICO_RESP  	= M.CD_PESSOA_FISICA
AND 	A.CD_PESSOA_FISICA      = P.CD_PESSOA_FISICA
and	A.NR_ATENDIMENTO 	= B.NR_ATENDIMENTO
and	B.nr_seq_interno	= (	select	coalesce(min(x.nr_seq_interno),0)	
					from 	atend_paciente_unidade x
					where	A.nr_atendimento = x.nr_atendimento
	  				and 	x.dt_entrada_unidade	= 
						(select min(z.dt_entrada_unidade)
						from 	Setor_Atendimento y,
							atend_paciente_unidade z
						where 	A.nr_atendimento = z.nr_atendimento
		  				and 	z.cd_setor_atendimento	= y.cd_setor_atendimento
		  				and 	y.cd_classif_setor in (3,4,8,12)))
AND 	B.CD_SETOR_ATENDIMENTO = S.CD_SETOR_ATENDIMENTO
AND 	not exists (	select 1 
			from 	atend_categoria_convenio x
			where	x.nr_atendimento = A.nr_atendimento);

