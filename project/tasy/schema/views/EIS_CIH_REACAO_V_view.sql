-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW eis_cih_reacao_v (ie_origem_inf, dt_ficha, dt_alta, nr_seq_reacao, ds_reacao, qt_todos, qt_nao_infec, qt_infectados, cd_empresa) AS select	distinct
	1 ie_origem_inf, 
	a.dt_ficha, 
	null dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE a.dt_cancelamento is null group by a.dt_ficha, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE cd_topografia is null and a.dt_cancelamento is null group by a.dt_ficha, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	a.dt_ficha, 
	null dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	0, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE cd_topografia is not null and a.dt_cancelamento is null group by a.dt_ficha, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	distinct 
	1 ie_origem_inf, 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	count(distinct a.nr_ficha_ocorrencia) qt_todos, 
	0 qt_nao_infec, 
	0 qt_infectados, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento  and a.dt_cancelamento is null group by g.dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	2 ie_origem_inf, /* Não infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	0, 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento   and cd_topografia is null and a.dt_cancelamento is null group by g.dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) 

union
 
select	3 ie_origem_inf, /* Infectado */
 
	null dt_ficha, 
	g.dt_alta dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60) ds_reacao, 
	0, 
	0, 
	count(distinct a.nr_ficha_ocorrencia), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento)) cd_empresa 
FROM atendimento_paciente g, cih_ficha_ocorrencia a
LEFT OUTER JOIN cih_local_infeccao b ON (a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia)
LEFT OUTER JOIN cih_ficha_reacao f ON (a.nr_ficha_ocorrencia = f.nr_ficha_ocorrencia)
WHERE a.nr_atendimento    =  	g.nr_atendimento   and cd_topografia is not null and a.dt_cancelamento is null group by g.dt_alta, 
	f.nr_seq_reacao, 
	substr(obter_desc_reacao_cih(f.nr_seq_reacao),1,60), 
	obter_empresa_estab(obter_estab_atend(a.nr_atendimento));

