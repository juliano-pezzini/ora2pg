-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW san_matrix_exp_v (cd_tipo_registro, nr_seq_doacao, ds_amostra, ie_null, cd_pessoa_fisica, dt_coleta, ds_exames, nm_paciente, dt_idade, dt_nascimento, ie_sexo, ie_cor, ie_digito) AS select  10 cd_tipo_registro,
	a.nr_sequencia nr_seq_doacao,
	obter_isbt_doador(a.nr_sequencia, null, 'I') ds_amostra,
	' ' ie_null,
	a.cd_pessoa_fisica,
	a.dt_coleta,
	substr(obter_select_concatenado_bv('select rpad(cd_exame_integracao, 8, '' '') from san_exame_integracao where cd_tipo_integracao = :cd_tipo_integracao','cd_tipo_integracao=' || to_char(2) ,''), 1, 160) ds_exames,
	' ' nm_paciente,
	' ' dt_idade,
	null dt_nascimento,
	' ' ie_sexo,
	' ' ie_cor,
	'10' ie_digito
FROM 	san_doacao a

union

select	distinct
	11 cd_tipo_registro,
	a.nr_sequencia nr_seq_doacao,
	' ' ds_amostra,
	' ' ie_null,
	a.cd_pessoa_fisica,
	a.dt_coleta,
	' ' ds_exames,
	b.nm_pessoa_fisica nm_paciente,
	lpad(OBTER_IDADE(b.dt_nascimento, a.dt_doacao,'A'),3,0)||lpad(OBTER_IDADE(b.dt_nascimento, a.dt_doacao,'MM'),2,0)||lpad(OBTER_IDADE(b.dt_nascimento, a.dt_doacao,'DI'),2,0) dt_idade,
	b.dt_nascimento,
	b.ie_sexo,
	Matrix_Obter_Cor_Pele(b.nr_seq_cor_pele) ie_cor,
	'11' ie_digito
FROM san_doacao a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica);

