-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW planificacion_familiar_nom_v (ie_tipo_registro, cabecario, clues, curpprestador, nombreprestador, primerapellidoprestador, segundoapellidoprestador, tipopersonal, especificatipopersonal, cedulaprofesional, servicioatencion, especificarservicio, curppaciente, nombre, primerapellido, segundoapellido, fechanacimiento, entidadenacimiento, edad, claveedad, sexo, seconsideraindigena, spss, numeroafiliacionspss, prospera, folioprospera, imss, numeroafiliacionimss, issste, numeroafiliacionissste, otraafiliacion, numerootraafiliacion, peso, talla, tipodificultad, gradodificultad, origendificultad, migrante, fechaconsulta, relaciontemporal, descripciondiagnostico1, primeravezdiagnostico1, suivecausesdiagnostico1, codigociediagnostico1, descripciondiagnostico2, primeravezdiagnostico2, suivecausesdiagnostico2, codigociediagnostico2, primeravezanio, oral, inyectablemensal, inyectablebimestral, implantesubdermico, parchedermico, diu, diumedicado, quirurgico, preservativo, preservativofemenino, otrometodo, orientacionpf, anticoncepcionemergencia, vasectomiasinbisturi, altaconazoospermia, lineavida, cartillavacunacion, referido, contrarreferido, telemedicina, dt_entrada, nr_atendimento) AS select  0 ie_tipo_registro,
	'clues|curpPrestador|nombrePrestador|primerApellidoPrestador|segundoApellidoPrestador|tipoPersonal|especificaTipoPersonal|cedulaProfesional|servicioAtencion|especificarServicio|'||
	'curpPaciente|nombre|primerApellido|segundoApellido|fechaNacimiento|entidadNacimiento|edad|claveEdad|sexo|seConsideraIndigena|spss|numeroAfiliacionSpss|prospera|'||
	'folioProspera|imss|numeroAfiliacionImss|issste|numeroAfiliacionIssste|otraAfiliacion|numeroOtraAfiliacion|peso|talla|tipoDificultad|gradoDificultad|origenDificultad|migrante|'||
	'fechaConsulta |relacionTemporal|descripcionDiagnostico1|primeraVezDiagnostico1|suiveCausesDiagnostico1|codigoCIEDiagnostico1|descripcionDiagnostico2|primeraVezDiagnostico2|'||
	'suiveCausesDiagnostico2|codigoCIEDiagnostico2|descripcionDiagnostico3|primeraVezDiagnostico3|suiveCausesDiagnostico3|codigoCIEDiagnostico3|primeraVezAnio|oral|inyectableMensual|'||
	'inyectableBimestral|implanteSubdermico|parcheDermico|diu|diuMedicado|quirurgico|preservativo|preservativoFemenino|otroMetodo|orientacionPF|anticoncepcionEmergencia|vasectomiaSinBisturi|'||
	'altaConAzoospermia|lineaVida|cartillaVacunacion|referido|contrarreferido|telemedicina' CABECARIO,
	null clues,
	null curpprestador,
	null nombreprestador,
	null primerapellidoprestador,
	null segundoapellidoprestador,
	null tipopersonal,
	null especificatipopersonal,
	null cedulaprofesional,
	null servicioatencion,
	null especificarservicio,
	null curppaciente,
	null nombre,
	null primerapellido,
	null segundoapellido,
	null fechanacimiento,
	null entidadenacimiento,
	null edad,
	null claveedad,
	null sexo,
	null seconsideraindigena,
	null spss,
	null numeroafiliacionspss,
	null prospera,
	null folioprospera,
	null imss,
	null numeroafiliacionimss,
	null issste,
	null numeroafiliacionissste,
	null otraafiliacion,
	null numerootraafiliacion,
	null peso,
	null talla,
	null tipodificultad,
	null gradodificultad,
	null origendificultad,
	null migrante,
	null fechaconsulta,
	null relaciontemporal,
	null descripciondiagnostico1,
	null primeravezdiagnostico1,
	null suivecausesdiagnostico1,
	null codigociediagnostico1,
	null descripciondiagnostico2,
	null primeravezdiagnostico2,
	null suivecausesdiagnostico2,
	null codigociediagnostico2,
	null primeravezanio,
	null oral,
	null inyectablemensal,
	null inyectablebimestral,
	null implantesubdermico,
	null parchedermico,
	null diu,
	null diumedicado,
	null quirurgico,
	null preservativo,
	null preservativofemenino,
	null otrometodo,
	null orientacionpf,
	null anticoncepcionemergencia,
	null vasectomiasinbisturi,
	null altaconazoospermia,
	null lineavida,
	null cartillavacunacion,
	null referido,
	null contrarreferido,
	null telemedicina,
	null dt_entrada,
	null nr_atendimento


union all

select
	--prestador servico--
	2 ie_tipo_registro,
	'' cabecario,
	pj.cd_internacional clues,
	coalesce(substr(upper(pj.cd_curp),1,18), 'XXXX999999XXXXXX99') curpprestador,
	coalesce(substr(upper(pj.ds_razao_social),1,50), 'XX') nombreprestador,
	coalesce(substr(upper(pj.nm_fantasia),1,50), 'XX') primerapellidoprestador,
	coalesce(substr(upper(pj.ds_nome_abrev),1,50), 'XX') segundoapellidoprestador,
	profissional.ie_profissional  tipopersonal,
	CASE WHEN profissional.ie_profissional='12' THEN obter_desc_expressao(308221) END  especificatipopersonal,
	case
		when profissional.ie_profissional in ('2','3','4','6','8')
		then coalesce(lpad(coalesce(pf_m.ds_codigo_prof, m.nr_crm),8,0),0)
		else '0'
	end as cedulaprofesional,
	CASE WHEN b.ie_clinica=2 THEN 3 WHEN b.ie_clinica=1 THEN 4 WHEN b.ie_clinica=3 THEN 5 WHEN b.ie_clinica=1000 THEN 6 WHEN b.ie_clinica=1001 THEN 7 WHEN b.ie_clinica=1002 THEN 8 WHEN b.ie_clinica=1004 THEN 9 WHEN b.ie_clinica=1005 THEN 13 WHEN b.ie_clinica=1006 THEN 14 WHEN b.ie_clinica=4 THEN 16 WHEN b.ie_clinica=1007 THEN 17 WHEN b.ie_clinica=1008 THEN 22 WHEN b.ie_clinica=1009 THEN 23 END  servicioatencion,
	'' especificarservicio,
	--dados paciente--
	coalesce(substr(upper(pf_p.cd_curp),1,18), 'XXXX999999XXXXXX99') curppaciente,
	substr(upper(y.ds_given_name),1,50) nombre,
	coalesce(substr(upper(y.ds_family_name),1,50), 'XX') primerapellido,
	coalesce(substr(upper(y.ds_component_name_1),1,50), 'XX') segundoapellido,
	coalesce(to_char(pf_p.dt_nascimento, 'dd/mm/yyyy'), null) fechanacimiento,
	coalesce(ce.cd_entidade, '99') entidadenacimiento,
        case
		when obter_idade(pf_p.dt_nascimento, b.dt_entrada, 'a') is not null
		then coalesce(obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_entrada,'IDADE'),-1)
		else 999
	end as edad,
	case
		when obter_idade(pf_p.dt_nascimento, b.dt_entrada, 'a') is not null
		then obter_idade_imc_nom(b.nr_atendimento,pf_p.dt_nascimento,b.dt_entrada,'CLAVEEDAD')
		else 9
	end as claveedad,
	CASE WHEN pf_p.ie_sexo='M' THEN  1  WHEN pf_p.ie_sexo='F' THEN  2  ELSE 9 END  sexo,
	CASE WHEN pf_p.nr_seq_cor_pele=201 THEN  1  ELSE 0 END  seconsideraindigena,
	(CASE WHEN pf_p.nr_spss IS NOT NULL THEN 1 ELSE 0 END) spss,
	case
		when pf_p.nr_spss is not null
		then substr(pf_p.nr_spss,1,13)
	end as numeroafiliacionspss,
	CASE WHEN n.cd_tipo_convenio_mx=13 THEN  1  ELSE 0 END  prospera,
	CASE WHEN n.cd_tipo_convenio_mx=13 THEN  elimina_caractere_especial(substr(p.nr_doc_convenio,1,16)) END  folioprospera,
	CASE WHEN n.cd_tipo_convenio_mx=2 THEN  1  ELSE 0 END  imss,
	CASE WHEN n.cd_tipo_convenio_mx=2 THEN  substr(p.nr_doc_convenio,1,11) END  numeroafiliacionimss,
	CASE WHEN n.cd_tipo_convenio_mx=3 THEN  1  ELSE 0 END  issste,
	CASE WHEN n.cd_tipo_convenio_mx=3 THEN  substr(p.nr_doc_convenio,1,13) END  numeroafiliacionissste,
	CASE WHEN n.cd_tipo_convenio_mx=15 THEN  1  ELSE 0 END  otraafiliacion,
	CASE WHEN n.cd_tipo_convenio_mx=15 THEN  substr(p.nr_doc_convenio,1,15) END  numerootraafiliacion,
	coalesce(coalesce((select	max(qt_peso)
		from	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
		from	atendimento_sinal_vital
		where	qt_peso is not null
		and	nr_atendimento	= b.nr_atendimento
		and	coalesce(ie_situacao,'A') = 'A'
		and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_peso), '999') peso,
	coalesce(coalesce((select	max(qt_altura_cm)
		from	atendimento_sinal_vital
		where	nr_sequencia = (select	coalesce(max(nr_sequencia),-1)
		from	atendimento_sinal_vital
		where	qt_altura_cm is not null
		and	nr_atendimento	= b.nr_atendimento
		and	coalesce(ie_situacao,'A') = 'A'
		and	coalesce(ie_rn,'N')	= 'N')), pf_p.qt_altura_cm), '999') talla,
	(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = b.nr_atendimento) tipodificultad,
	case
		when(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) = 56
		then 9
		else CASE WHEN(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica)=56 THEN 9  ELSE (select max(ptd.ie_grau_deficiencia) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) END
	end as gradodificultad,
	case
		when(select max(ptd.nr_seq_tipo_def) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica) = 56
		then 9
		else (select max(ptd.nr_seq_causa_lesao) from pf_tipo_deficiencia ptd where ptd.cd_pessoa_fisica = pf_p.cd_pessoa_fisica)
	end as origendificultad,
	-1 migrante,
	coalesce(to_char(b.dt_entrada, 'dd/mm/yyyy'), null) fechaconsulta,
	CASE WHEN(select count(*) from atendimento_paciente ap where (to_char(ap.dt_inicio_atendimento, 'yyyy') = extract(year from b.dt_entrada)) and b.nr_atendimento = ap.nr_atendimento) IS NULL THEN 0  ELSE 1 END  relaciontemporal,
	elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
											from diagnostico_doenca dd, cid_doenca cd
											where dd.nr_atendimento = b.nr_atendimento
											and dd.cd_doenca = cd.cd_doenca_cid
											and dd.ie_classificacao_doenca = 'P')),1, 255)) descripciondiagnostico1,
	case
		when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(year from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'P') > 1)
		then 0
		else 1
	end as primeravezdiagnostico1,
	case
		when(select max(cd.ds_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'P') is not null
		then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  '0'  ELSE '1' END  from cid_doenca a2
					where a2.cd_doenca_cid = (select max(cd_doenca)
												from diagnostico_doenca
												where nr_atendimento = b.nr_atendimento
												and ie_classificacao_doenca = 'P')), 'N')
	end as suivecausesdiagnostico1,
	(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'P') codigociediagnostico1,
	elimina_caractere_especial(substr(upper((select max(cd.ds_doenca_cid)
											from diagnostico_doenca dd, cid_doenca cd
											where dd.nr_atendimento = b.nr_atendimento
											and dd.cd_doenca = cd.cd_doenca_cid
											and dd.ie_classificacao_doenca = 'S')),1, 255)) descripciondiagnostico2,
	case
		when ((select count(*) from diagnostico_doenca ddp where to_char(ddp.dt_diagnostico, 'yyyy') = extract(year from b.dt_entrada) and ddp.nr_atendimento = b.nr_atendimento and ddp.ie_classificacao_doenca = 'S') > 1)
		then 0
		else 1
	end as primeravezdiagnostico2,
	case
		when(select max(ds_diagnostico) from diagnostico_doenca where nr_atendimento = b.nr_atendimento and ie_classificacao_doenca = 'S') is not null
		then coalesce((select CASE WHEN coalesce(ie_suive_morb, ie_causa)='S' THEN  '0'  ELSE '1' END  from cid_doenca a2
					where a2.cd_doenca_cid = (select max(cd_doenca)
					from diagnostico_doenca
					where nr_atendimento = b.nr_atendimento
					and ie_classificacao_doenca = 'S')), 'N')
	end as suivecausesdiagnostico2,
	(select max(cd.cd_doenca_cid) from diagnostico_doenca dd, cid_doenca cd where dd.nr_atendimento = b.nr_atendimento and dd.cd_doenca = cd.cd_doenca_cid and dd.ie_classificacao_doenca = 'S') codigociediagnostico2,
	0 primeravezanio,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 1
		then hsm.nr_contrac_realizado
		else 0
	end as oral,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 2
		then '1'
		else '0'
	end as inyectablemensal,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 3
		then '1'
		else '0'
	end as inyectablebimestral,
	case
		when hsm.ds_metodos_contrac = 6
		then hsm.ds_compl_contrac
		else '-1'
	end as implantesubdermico,
	case
		when hsm.ds_metodos_contrac = 2 and hsm.ds_compl_contrac = 4
		then hsm.nr_contrac_realizado
		else -1
	end as parchedermico,
	case
		when hsm.ds_metodos_contrac = 1 and hsm.ds_compl_contrac = 1
		then coalesce(hsm.nr_contrac_realizado, -1)
		else -1
	end as diu,
	case
		when hsm.ds_metodos_contrac = 1 and hsm.ds_compl_contrac = 2
		then coalesce(hsm.nr_contrac_realizado, -1)
		else -1
	end as diumedicado,
	-1 quirurgico,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 1
		then hsm.nr_contrac_realizado
		else 0
	end as preservativo,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 2
		then hsm.nr_contrac_realizado
		else 0
	end as preservativofemenino,
	0 otrometodo,
	case
		when pf_p.ie_sexo = 'M'
		then CASE WHEN hsm.ie_orient_met_contrac='S' THEN '1'  ELSE '0' END 
		when pf_p.ie_sexo = 'M'
		then CASE WHEN phs.ie_orient_met_contrac='S' THEN '1'  ELSE '0' END 
		else '0'
	end as orientacionpf,
	case
		when hsm.ds_metodos_contrac = 5 and hsm.ds_compl_contrac = 3
		then 1
		else 0
	end as anticoncepcionemergencia,
	case
		 when pf_p.ie_sexo = 'M' and (select max(b.ds_tipo_vasectomia)
		 	  		from historico_saude_cirurgia a, procedimento b
					where a.cd_pessoa_fisica = b.cd_pessoa_fisica
					and a.cd_procedimento = b.cd_procedimento
					and b.cd_tipo_procedimento = 66) = 'S'
		 then 1
		 else 0
	end as vasectomiasinbisturi,
	case
		when pf_p.ie_sexo = 'M' and (select max(b.ds_tipo_vasectomia)
					from historico_saude_cirurgia a, procedimento b
					where a.cd_pessoa_fisica = b.cd_pessoa_fisica
					and a.cd_procedimento = b.cd_procedimento
					and b.cd_tipo_procedimento = 66) = 'N'
		then 1
		else 0
	end as altaconazoospermia,
	0 lineavida,
	0 cartillavacunacion,
	-1 referido,
	0 contrarreferido,
	0 telemedicina,
	b.dt_entrada dt_entrada,
	b.nr_atendimento nr_atendimento
FROM person_name y, atend_profissional profissional, pessoa_juridica pj, pessoa_fisica pf_m, atend_categoria_convenio p, medico m, estabelecimento e, categoria_convenio cc, atendimento_paciente b
LEFT OUTER JOIN historico_saude_mulher hsm ON (b.cd_pessoa_fisica = hsm.cd_pessoa_fisica)
LEFT OUTER JOIN paciente_hist_social phs ON (b.cd_pessoa_fisica = phs.cd_pessoa_fisica)
, pessoa_fisica pf_p
LEFT OUTER JOIN sus_municipio sm ON (pf_p.cd_municipio_ibge = sm.cd_municipio_ibge)
LEFT OUTER JOIN cat_entidade ce ON (sm.nr_seq_entidade_mx = ce.nr_sequencia)
, convenio n
LEFT OUTER JOIN cat_derechohabiencia k ON (n.cd_tipo_convenio_mx = k.nr_sequencia)
WHERE b.nr_atendimento  		= p.nr_atendimento and pj.cd_cgc 			= e.cd_cgc and b.cd_estabelecimento 		= e.cd_estabelecimento and b.cd_pessoa_fisica		= pf_p.cd_pessoa_fisica and b.cd_medico_resp 		= m.cd_pessoa_fisica and pf_m.cd_pessoa_fisica 		= m.cd_pessoa_fisica   and p.cd_convenio 			= cc.cd_convenio and p.cd_categoria 			= cc.cd_categoria and n.cd_convenio 			= cc.cd_convenio    and b.nr_atendimento 		= profissional.nr_atendimento and y.nr_sequencia 			= pf_p.nr_seq_person_name and y.ds_type 			= 'main';

