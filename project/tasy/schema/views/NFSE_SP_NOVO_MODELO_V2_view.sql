-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW nfse_sp_novo_modelo_v2 (assinatura, nr_seq_nota, inscricaoprestador, serierps, numerorps, tiporps, dataemissao, statusrps, tributacaorps, valorservicos, valordeducoes, valorpis, valorcofins, valorinss, valorir, valorcsll, codigoservico, aliquotaservicos, issretido, inscricaomunicipaltomador, inscricaoestadualtomador, razaosocialtomador, tipologradouro, logradouro, numeroendereco, complementoendereco, bairro, cidade, uf, cep, emailtomador, inscricaomunicipalintermed, issretidointermediario, emailintermediario, discriminacao, nr_seq_transmissao, nr_sequencia, ds_assinatura, cpf, cnpj, cpfcnpjintermediario, nr_interno_conta, nr_seq_protocolo) AS select	cd_assinatura_rps Assinatura, 	
		a.nr_sequencia nr_seq_nota,
		coalesce(substr(lpad(obter_dados_pf_pj('',a.cd_cgc_emitente,'IM'),8,'0'),1,30),'00000000') InscricaoPrestador,
		a.cd_serie_nf SerieRPS,
		a.nr_nota_fiscal NumeroRPS,
		'RPS' TipoRPS,
		to_char(a.dt_emissao,'yyyy-mm-dd') DataEmissao,
		CASE WHEN a.ie_situacao=1 THEN 'N' WHEN a.ie_situacao=2 THEN 'C' WHEN a.ie_situacao=3 THEN 'C'  ELSE 'N' END  StatusRPS,
			CASE WHEN obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') IS NULL THEN CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END   ELSE obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') END  TributacaoRPS,
		campo_mascara((a.vl_mercadoria - a.vl_descontos),2) ValorServicos,
		campo_mascara(0,2) ValorDeducoes,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','PIS'   ,'N')=0 THEN  Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','PIS'   ,'I')  ELSE Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','PIS'   ,'N') END  END ,2) ValorPIS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','COFINS','N')=0 THEN  Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','COFINS','I')  ELSE Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','COFINS','N') END  END ,2) ValorCOFINS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','INSS'  ,'N')=0 THEN  Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','INSS'  ,'I')  ELSE Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','INSS'  ,'N') END  END ,2) ValorINSS,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','IR'    ,'N')=0 THEN  Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','IR'    ,'I')  ELSE Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','IR'    ,'N') END  END ,2) ValorIR,
		campo_mascara(CASE WHEN cd_cgc='' THEN 0  ELSE CASE WHEN Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','CSLL'  ,'N')=0 THEN  Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','CSLL'  ,'I')  ELSE Obter_Valor_tipo_Tributo_Exp(a.nr_sequencia,'V','CSLL'  ,'N') END  END ,2) ValorCSLL,	
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),5,'0'),1,5) CodigoServico,	
		campo_mascara(CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISSST')=0 THEN  CASE WHEN obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISS')=0 THEN  2  ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISS') END   ELSE obter_valor_tipo_tributo_nota(a.nr_sequencia, 'X', 'ISSST') END /100, 2) AliquotaServicos,		
		--decode(fis_obter_se_intermediario(a.nr_sequencia),'S','false', decode(substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1),'N','true','false')) ISSRetido,

		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='N' THEN 'false'  ELSE 'true' END   ELSE 'false' END  ISSRetido,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(lpad(obter_dados_nfse_sp(cd_pessoa_fisica,cd_cgc,'IM'),8,'0'),1,30) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','IM')  ELSE null END  InscricaoMunicipalTomador,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica,cd_cgc,'IE'),1,19) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','IE')  ELSE null END  InscricaoEstadualTomador,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(nfe_elimina_caractere_especial(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc)),1,255) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','RS')  ELSE null END  RazaoSocialTomador,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN coalesce(obter_logr_abreviado_sp(obter_dados_pf_pj(cd_pessoa_fisica,cd_cgc,'LO')),'Rua') WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','TL')  ELSE null END  TipoLogradouro,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'LG') ,1,50) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','L')  ELSE null END  Logradouro,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'NR'),1,25) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','NE')  ELSE null END  NumeroEndereco,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'COM'),1,30) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','CE')  ELSE null END  ComplementoEndereco,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'BAI'),1,30) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','B')  ELSE null END  Bairro,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'CID'),1,7) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','C')  ELSE null END  Cidade,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'UF'),1,2) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','UF')  ELSE null END  UF,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN lpad(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'CEP'),8,'0') WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','CEP')  ELSE null END  CEP,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN substr(obter_dados_nfse_sp(cd_pessoa_fisica, cd_cgc, 'EML'),1,75) WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','ET')  ELSE null END  EmailTomador,				
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN substr(fis_obter_dados_intermediario(a.nr_sequencia,'S','II'),1,8)  ELSE null END  InscricaoMunicipalIntermed,
		--decode(decode(fis_obter_se_intermediario(a.nr_sequencia),'N',null,'S',substr(fis_obter_dados_intermediario(a.nr_sequencia,'S','RI'),1,8),null),'S','true','N','false',null) ISSRetidoIntermediario, 

		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null  ELSE coalesce(CASE WHEN fis_obter_dados_intermediario(a.nr_sequencia,'S','RI')='S' THEN 'true'  ELSE 'false' END ,'false') END  ISSRetidoIntermediario,
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN substr(fis_obter_dados_intermediario(a.nr_sequencia,'S','EI'),1,75)  ELSE null END  EmailIntermediario,				
		coalesce(substr(obter_descricao_rps(a.cd_estabelecimento,a.nr_sequencia,'DS_SERVICOS'),1,1000),'Servicos') Discriminacao,
		t.nr_sequencia nr_seq_transmissao,		
		a.nr_sequencia,		
		--INICIO ASSINATURA 	

		lpad(coalesce(substr(obter_dados_pf_pj('', a.cd_cgc_emitente,'IM'), 1, 30), '00000000'), 8, 0) ||                                                                                    	-- Inscricao Municipal do Prestador
		substr(rpad(a.cd_serie_nf, 5, ' '), 1, 5) ||                                                                                                                                      	--Serie do RPS
		lpad(a.nr_nota_fiscal, 12, 0) ||                                                                                                                                                  	--Numero do RPS
		to_char(a.dt_emissao, 'yyyymmdd') ||                                                                                                                                              	--Data de Emissao do RPS
		CASE WHEN obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') IS NULL THEN CASE WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='1' THEN 'T' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='2' THEN 'F' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='3' THEN 'I' WHEN obter_dados_parametro_compras(a.cd_estabelecimento,14)='5' THEN 'J'  ELSE 'I' END   ELSE obter_dados_natureza_operacao(a.cd_natureza_operacao,'ISS') END  ||                                                                                                                 --Tipo de Tributacao do RPS
		CASE WHEN a.ie_situacao=1 THEN  'N' WHEN a.ie_situacao=2 THEN  'C' WHEN a.ie_situacao=3 THEN  'C'  ELSE 'N' END  ||                                                                                                                             	--Status do RPS	
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN CASE WHEN substr(obter_se_nf_retem_iss(a.nr_sequencia),1,1)='N' THEN 'N'  ELSE 'S' END   ELSE coalesce(fis_obter_dados_intermediario(a.nr_sequencia,'S','RI'),'N') END  ||														--ISS Retido		
		lpad(elimina_caractere_especial(campo_mascara((a.vl_mercadoria - a.vl_descontos),2)), 15, '0') ||                                                                                 	--Valor dos Servicos
		lpad(elimina_caractere_especial(campo_mascara(0, 2)), 15, '0') ||                                                                                                                 	--Valor das Deducoes		
		substr(lpad(obter_cod_grupo_ativ(a.cd_estabelecimento,a.nr_sequencia,'C'),5,'0'),1,5) ||                                                                                          	--Codigo do Servico Prestado		
		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  3  ELSE CASE WHEN fis_obter_ambulatorio_conta(a.nr_seq_lote_prot, a.nr_interno_conta, a.nr_sequencia)='A' THEN  3  ELSE CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN  CASE WHEN obter_dados_tomador_conta(a.nr_sequencia,'C','CPF') IS NULL THEN  2  ELSE 1 END   ELSE CASE WHEN obter_dados_pf(cd_pessoa_fisica, 'CPF') IS NULL THEN  2   ELSE 1 END  END  END  END  ||	                                                                                                        --Indicador de CPF/CNPJ do Tomador		
    		lpad(CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  0  ELSE CASE WHEN fis_obter_ambulatorio_conta(a.nr_seq_lote_prot, a.nr_interno_conta, a.nr_sequencia)='A' THEN  0  ELSE CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN  CASE WHEN obter_dados_tomador_conta(a.nr_sequencia,'C','CPF') IS NULL THEN  cd_cgc  ELSE obter_dados_tomador_conta(a.nr_sequencia,'C','CPF') END   ELSE CASE WHEN cd_cgc='' THEN  coalesce(substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11), '0')  ELSE cd_cgc END  END  END  END ,14,0) || 	                                                                                                        --CPF/CNPJ do Tomador
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN ''   ELSE CASE WHEN greatest(length(fis_obter_dados_intermediario(a.nr_sequencia,'S','CI')),'13')=14 THEN  '2'  ELSE '1' END  END  ||                         --Indicador de CPF/CNPJ do Intermediario	
		CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN ''  ELSE lpad(fis_obter_dados_intermediario(a.nr_sequencia,'S','CI'),14,0) END  ||                                             		--CPF/CNPJ do Intermediario   				
		 CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN ''  ELSE coalesce(fis_obter_dados_intermediario(a.nr_sequencia,'S','RI'),'N') END  ds_assinatura ,			                      	--ISS Retido Intermediario 
		-- FIM ASSINATURA

		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  null  ELSE CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN obter_dados_tomador_conta(a.nr_sequencia,'C','CPF')  ELSE substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 11) END  END  CPF,
		CASE WHEN nfse_obter_se_brasileiro(cd_pessoa_fisica, cd_cgc)='N' THEN  null  ELSE CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN null  ELSE cd_cgc END  END  CNPJ,
		lpad(CASE WHEN fis_obter_se_intermediario(a.nr_sequencia)='N' THEN null WHEN fis_obter_se_intermediario(a.nr_sequencia)='S' THEN fis_obter_dados_intermediario(a.nr_sequencia,'S','CI')  ELSE null END ,14,0) CPFCNPJIntermediario,
		a.nr_interno_conta,
		a.nr_seq_lote_prot nr_seq_protocolo
	FROM	nota_fiscal_lote_nfe l,
		nfe_transmissao_nf n,
		nfe_transmissao t,
		nota_fiscal a
	where	l.nr_seq_transmissao = t.nr_sequencia
	and	t.nr_sequencia	= n.nr_seq_transmissao
	and	a.nr_sequencia = n.nr_seq_nota_fiscal
	and	l.nr_sequencia = (select max(nr_sequencia) from nota_fiscal_lote_nfe f where f.nr_seq_transmissao = t.nr_sequencia)
	order by a.nr_nota_fiscal;

