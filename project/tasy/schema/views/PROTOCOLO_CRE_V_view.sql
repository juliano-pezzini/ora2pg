-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW protocolo_cre_v (nr_seq_protocolo, nr_atendimento, nr_documento, vl_movimento, ie_fixo, ds_fixo, ie_tipo_registro, dt_vencimento, dt_emissao, cd_conta_contabil) AS select	a.nr_seq_protocolo,
	d.nr_atendimento, 
	CASE WHEN Obter_Valor_Conv_Estab(b.cd_convenio, d.cd_estabelecimento, 'IE_VALOR_CONTABIL')='G' THEN  e.cd_autorizacao  ELSE d.nr_atendimento END  nr_documento, 
   	sum(e.vl_guia) vl_movimento, 
   	999 ie_fixo, 
	'025' ds_fixo, 
   	1 ie_tipo_registro, 
	a.dt_vencimento, 
	coalesce(a.dt_entrega_convenio, a.dt_mesano_referencia) dt_emissao, 
	substr(obter_conta_convenio(d.cd_estabelecimento,a.cd_convenio,d.ie_tipo_atendimento,'T', 
							coalesce(a.dt_entrega_convenio,a.dt_mesano_referencia),null,null,null, null,null,null),1,20) cd_conta_contabil 
FROM 	Conta_Paciente_Guia	e, 
   	Atendimento_Paciente	d, 
	conta_paciente 	c, 
 	Convenio 		b, 
	protocolo_convenio 	a    
where 	a.cd_convenio			= b.cd_convenio 
and	a.nr_seq_protocolo     	= c.nr_seq_protocolo 
and	c.nr_interno_conta     	= e.nr_interno_conta 
and	c.nr_atendimento		= d.nr_atendimento 
group by 
	a.nr_seq_protocolo, 
	d.nr_atendimento, 
	CASE WHEN Obter_Valor_Conv_Estab(b.cd_convenio, d.cd_estabelecimento, 'IE_VALOR_CONTABIL')='G' THEN  e.cd_autorizacao  ELSE d.nr_atendimento END , 
	a.dt_vencimento, 
	coalesce(a.dt_entrega_convenio, a.dt_mesano_referencia), 
	obter_conta_convenio(d.cd_estabelecimento,a.cd_convenio,d.ie_tipo_atendimento,'T', 
	coalesce(a.dt_entrega_convenio,a.dt_mesano_referencia),null,null,null, null,null,null);

