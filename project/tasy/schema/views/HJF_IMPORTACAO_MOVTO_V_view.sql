-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW hjf_importacao_movto_v (tp_registro, nr_seq_protocolo, cd_prestador, nr_seq_lote, nr_interno_conta, cd_serie_documento, dt_geracao, nr_documento, cd_unid_carteira, nr_carteira, dt_referencia, cd_motivo_alta, cd_cid, dt_entrada, dt_alta, dt_ano_guia, nr_guia, cd_classe_nota, cd_acomodacao, nm_beneficiario, ie_sexo, dt_nascimento, dt_validade_carteira, cd_setor_atendimento, cd_procedimento, qt_procedimento_autor, dt_procedimento, ie_urgencia, ie_adicional_urgencia, qt_procedimento, vl_procedimento, ie_tipo_nascimento, nr_seq_autorizacao, ie_tipo_percentual, ie_tipo_insumo, cd_insumo, qt_insumo, dt_insumo, qt_cobrada, vl_cobrado, cd_pacote, dt_emissao, qt_reg_nota, qt_reg_doc, qt_reg_proc, qt_reg_insumo, vl_total_lote, nr_seq_pacote, nr_lote, qt_nasc_vivos_termo, qt_nasc_mortos, qt_nasc_vivos_premat, qt_obito_nasc_precoc, qt_obito_nasc_tardio, ie_tipo_saida, ie_tipo_doenca, qt_tempo_doenca, ie_tipo_tempo_doenca, ie_acidente, cd_cid1, cd_cid2, cd_cid3, nm_prof_solicitante, ie_tipo_atendimento, ie_tipo_consulta, ds_observacoes, ie_gestacao, ie_aborto, ie_trans_gravidez, ie_compl_puerperio, ie_sala_parto, ie_compl_neonat, ie_baixo_peso, ie_parto_cesareo, ie_parto_normal, ie_obito_mulher, ie_nasc_vivos, ie_cid_obito, nr_decl_obito, ie_tipo_faturamento, cd_cobertura, nm_prest_exec, cd_tab_medica, hr_final, nm_prof_exec, ie_tec_utilizada, ie_tipo_perc, qt_pacote, nr_linha_ptu, ie_grau_partic, nr_dec_nasc_vivo2, nr_dec_nasc_vivo3, nr_dec_nasc_vivo4, nr_dec_nasc_vivo5, ie_regime_inter, ds_indicacao_clinica, cd_tipo_acomod_tiss, cons_prof_solic, nr_cons_prof_solic, uf_cons_prof_solic, cd_cbo_proc_solic, nr_guia_principal, nr_seq_digitacao, nr_seq_digitacao2, ie_divide_honorario, cd_tipo_vinculo_divisao, cd_divisao_honorario, cd_prestador_divisao, cd_ato_medico_divisao, ie_anestesia, qt_porte_anestesico, cd_nivel_prestador, ie_via_acesso, cd_ato_medico) AS select	/* Header */
	1 				tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	substr(cd_interno,1,8)		cd_prestador, 
	c.nr_seq_protocolo 		nr_seq_lote, 
	0				nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	 
					dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' '	 			ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0		 		ie_tipo_percentual, 
	0 				ie_tipo_insumo, 
	0 				cd_insumo, 
	0		 		qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
	0	 			qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
FROM	w_interf_conta_header c 

union
 
select	/* Nota */
 
	2	 			tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	substr(c.cd_interno,1,8) 	cd_prestador, 
	0 				nr_seq_lote, 
	0				nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP	 			dt_geracao, 
	' ' 				nr_documento, 
	'0'	 			cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0	 			cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP	 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0		 		nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 
	' '	 			nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP				dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0	 			qt_procedimento, 
	0		 		vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0		 		ie_tipo_percentual, 
	0 				ie_tipo_insumo, 
	0 				cd_insumo, 
	0	 			qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0	 			qt_cobrada, 
	0		 		vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0		 		qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0	 			qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
from	w_interf_conta_header c 

union
 
select	/* Documento */
 
	3	 			tp_registro, 
	b.nr_seq_protocolo		nr_seq_protocolo, 
	lpad(substr(CASE WHEN HDJF_Obter_Se_Medico_Conven(obter_estab_atend(b.nr_atendimento),b.cd_medico_resp,b.cd_convenio, 	null, null,null,null)='S' THEN b.NR_CRM_MEDICO_RESP  ELSE '00000003' END ,1,8),8,'0') 
					cd_prestador, 
	0 				nr_seq_lote, 
	b.nr_interno_conta		nr_interno_conta, 
	substr(hjf_obter_serie_documento(b.nr_seq_protocolo,b.nr_atendimento),1,4) cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	substr(obter_dados_categ_conv(b.nr_atendimento,'G'),5,8)	nr_documento, 
	substr(b.cd_usuario_convenio,1,4) cd_unid_carteira, 
	substr(b.cd_usuario_convenio,5,13) nr_carteira, 
	LOCALTIMESTAMP				dt_referencia, 
	b.cd_motivo_alta		cd_motivo_alta, 
	substr(b.cd_cid_principal,1,4)	cd_cid, 
	b.dt_entrada			dt_entrada, 
	b.dt_alta			dt_alta, 
	substr(obter_dados_categ_conv(b.nr_atendimento,'G'),1,4) 	dt_ano_guia, 
	CASE WHEN substr(obter_dados_categ_conv(b.nr_atendimento,'G'),1,4)='0000' THEN 0  ELSE somente_numero(substr(obter_dados_categ_conv(b.nr_atendimento,'G'),5,8)) END  nr_guia, 
	/*decode(b.ie_tipo_atendimento,7,'02', 
		decode(d.ie_tipo_guia,'IC','04','I','05','IO','06','AI','03','IP','11','08')) cd_classe_nota,*/
 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  CASE WHEN somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,10))=1 THEN '04' WHEN somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,10))=2 THEN '05' WHEN somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,10))=3 THEN '06' WHEN somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,10))=4 THEN '11' WHEN somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,10))=5 THEN '12'  ELSE '00' END   ELSE CASE WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=2 THEN '01' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=3 THEN '02' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=5 THEN '02' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=10 THEN '02' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=8 THEN '03' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=9 THEN '03' WHEN somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2))=4 THEN '08'  ELSE '00' END  END  
					cd_classe_nota, 
	CASE WHEN b.ie_tipo_atendimento=8 THEN  ' ' WHEN b.ie_tipo_atendimento=7 THEN  ' '  ELSE CASE WHEN b.cd_tipo_acomodacao=0 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=6 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=5 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=4 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=3 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=2 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END  WHEN b.cd_tipo_acomodacao=1 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  'A '  ELSE 'B ' END   ELSE substr(b.cd_tipo_acomodacao,1,4) END  END  cd_acomodacao, 
	substr(b.nm_paciente,1,40)	nm_beneficiario, 
	b.ie_sexo			ie_sexo, 
	b.dt_nascimento			dt_nascimento, 
	b.dt_validade_carteira		dt_validade_carteira, 
	CASE WHEN coalesce(b.cd_setor_atendimento,0)=13 THEN CASE WHEN b.ie_tipo_atendimento=8 THEN 91 WHEN b.ie_tipo_atendimento=7 THEN 92  ELSE 90 END   ELSE coalesce(b.cd_setor_atendimento,0) END  cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' '	 			ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' '	 			ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	0 				ie_tipo_insumo, 
	0 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0	 			vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_referencia, 
 	0 				qt_reg_nota, 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote,	 
	b.nr_seq_protocolo		nr_lote, 
	(SELECT sum(qt_nasc_vivos) FROM parto WHERE NR_ATENDIMENTO = b.NR_ATENDIMENTO) qt_nasc_vivos_termo, 
	(SELECT sum(qt_nasc_mortos) FROM parto WHERE NR_ATENDIMENTO = b.NR_ATENDIMENTO) qt_nasc_mortos, 
	CASE WHEN b.ie_tipo_nascimento=3 THEN 1  ELSE 0 END  qt_nasc_vivos_premat, 
	CASE WHEN b.ie_tipo_nascimento=8 THEN 1  ELSE 0 END  qt_obito_nasc_precoc, 
	CASE WHEN b.ie_tipo_nascimento=7 THEN 1  ELSE 0 END  qt_obito_nasc_tardio, 
	to_char(b.cd_motivo_alta)	ie_tipo_saida, 
	substr(hdjb_obter_dados_tiss_diag(b.nr_atendimento, '1'),1,1) 
					ie_tipo_doenca, 
	somente_numero(substr(hdjb_obter_dados_tiss_diag(b.nr_atendimento, '3'),1,2)) 
					qt_tempo_doenca, 
	substr(hdjb_obter_dados_tiss_diag(b.nr_atendimento,'2'),1,1) 
					ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	substr(b.cd_cid_principal,1,4)	cd_cid1, 
	substr(b.cd_cid_secundario,1,4)	cd_cid2, 
	' ' 				cd_cid3, 
	substr(d.nm_medico_solicitante,1,70) 
					nm_prof_solicitante, 
	CASE WHEN b.ie_tipo_atendimento=1 THEN  somente_numero(substr(TISS_OBTER_CLINICA(b.ie_clinica, null),1,2))  ELSE somente_numero(substr(obter_tipo_atend_tiss(b.nr_atendimento, b.nr_interno_conta),1,2)) END  ie_tipo_atendimento, 
	1				ie_tipo_consulta, 
	' '				ds_observacoes, 
	CASE WHEN b.ie_tipo_nascimento=1 THEN 'S'  ELSE 'N' END  ie_gestacao, 
	CASE WHEN b.ie_tipo_nascimento=2 THEN 'S'  ELSE 'N' END  ie_aborto, 
	CASE WHEN b.ie_tipo_nascimento=6 THEN 'S'  ELSE 'N' END  ie_trans_gravidez, 
	'N'				ie_compl_puerperio, 	 
	'N'				ie_sala_parto, 
	'N'				ie_compl_neonat, 
	(SELECT max('S') FROM nascimento WHERE NR_ATENDIMENTO = b.NR_ATENDIMENTO and qt_peso < 2.5) 
					ie_baixo_peso, 
	(SELECT CASE WHEN ie_parto_cesaria IS NULL THEN 'N'  ELSE ie_parto_cesaria END  FROM parto WHERE NR_ATENDIMENTO = b.NR_ATENDIMENTO)	 
					ie_parto_cesareo, 
	(SELECT CASE WHEN ie_parto_normal IS NULL THEN 'N'  ELSE ie_parto_normal END  FROM parto WHERE NR_ATENDIMENTO = b.NR_ATENDIMENTO) 
					ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	CASE WHEN b.cd_motivo_alta=16 THEN 'P'  ELSE 'T' END  ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	1				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	CASE WHEN b.ie_tipo_atendimento=8 THEN  0  WHEN b.ie_tipo_atendimento=7 THEN  0   ELSE CASE WHEN b.cd_tipo_acomodacao=0 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  7   ELSE 1 END  WHEN b.cd_tipo_acomodacao=5 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  7  ELSE 1 END  WHEN b.cd_tipo_acomodacao=4 THEN  CASE WHEN obter_dados_categ_conv(b.nr_atendimento,'CA')='1' THEN  7  ELSE 1 END  WHEN b.cd_tipo_acomodacao=1 THEN 7 WHEN b.cd_tipo_acomodacao=2 THEN 7 WHEN b.cd_tipo_acomodacao=3 THEN 1 WHEN b.cd_tipo_acomodacao=6 THEN 1  ELSE 0 END  END  
					CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
FROM w_interf_conta_header a, w_interf_conta_cab b
LEFT OUTER JOIN w_interf_conta_autor d ON (b.nr_interno_conta = d.nr_interno_conta)
WHERE b.nr_seq_protocolo	= a.nr_seq_protocolo  and coalesce(d.nr_sequencia,0) = 
	(select coalesce(min(y.nr_sequencia),0) 
		from w_interf_conta_autor y 
		where b.nr_interno_conta = y.nr_interno_conta) 
 
union
 
select	/*Procedimentos*/
 
	4	 			tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	CASE WHEN d.IE_TOTAL_INTERF=8 THEN  '00010030'  ELSE lpad(substr(CASE WHEN d.ie_responsavel_credito='M' THEN  			CASE WHEN HDJF_Obter_Se_Medico_Conven(obter_estab_atend(c.nr_atendimento),d.cd_medico_executor, 			c.cd_convenio,null, null,null,null)='S' THEN  d.nr_crm_executor  ELSE '00100301' END  WHEN d.ie_responsavel_credito='RM' THEN  			CASE WHEN HDJF_Obter_Se_Medico_Conven(obter_estab_atend(c.nr_atendimento),d.cd_medico_executor, 			c.cd_convenio,null, null,null,null)='S' THEN  d.nr_crm_executor  ELSE '00100301' END  WHEN d.ie_responsavel_credito='H' THEN '00010030'  ELSE '00100301' END ,1,8),8,'0') END  
					cd_prestador, 
	0 				nr_seq_lote, 
	d.nr_interno_conta		nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	 
					dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			Dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	--somente_numero(nvl(d.cd_item_convenio, d.cd_item))   Almir em OS119302 - alterei pela linha de baixo 
	somente_numero(coalesce(obter_proc_origem_pacote(d.nr_seq_proc_pacote), coalesce(d.cd_item_convenio, d.cd_item))) 
					cd_procedimento, 
	d.qt_item 			qt_procedimento_autor, 
	d.dt_item			dt_procedimento, 
	substr(hjf_obter_dados_cirurgia(d.nr_seq_item,'2'),1,1)	ie_urgencia, 
	substr(hjf_obter_dados_cirurgia(d.nr_seq_item,'3'),1,1) ie_adicional_urgencia, 
	d.qt_item			qt_procedimento, 
	d.vl_total_item			vl_procedimento, 
	c.ie_tipo_nascimento		ie_tipo_nascimento, 
	somente_numero(substr(d.cd_senha_guia,1,8))	 
					nr_seq_autorizacao, 
	--decode(substr(hjf_obter_se_divide_honorario(d.cd_item),1,1),'S',somente_numero(d.cd_grupo_gasto),0) ie_tipo_percentual, 
	CASE WHEN hjf_obter_se_tipo_percentual(obter_estab_atend(c.nr_atendimento), c.cd_convenio, 					c.cd_categoria_convenio, d.dt_item, d.cd_item, d.ie_origem_proced, d.qt_item)='S' THEN  somente_numero(d.cd_grupo_gasto)  ELSE 0 END  
					ie_tipo_percentual, 
	0 				ie_tipo_insumo, 
	0 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,			 
 	0 				qt_reg_doc, 
 	0	 			qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	substr(obter_dados_pf_pj(Null, CD_CGC_PRESTADOR, 'N'),1,30) 
					nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	substr(d.nm_medico_executor,1,70) nm_prof_exec, 
	substr(CASE WHEN substr(hjf_obter_dados_cirurgia(d.nr_seq_item,'1'),1,1)='S' THEN OBTER_TECNICA_UTILIZADA_TISS(d.nr_seq_item)  ELSE ' ' END ,1,1) ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	CASE WHEN d.IE_TOTAL_INTERF=8 THEN  11  ELSE CASE WHEN substr(d.cd_item_convenio,1,2)='28,' THEN 11 WHEN substr(d.cd_item_convenio,1,2)='33' THEN 11  ELSE CASE WHEN d.cd_funcao_executor=2 THEN 0 WHEN d.cd_funcao_executor=5 THEN 6 WHEN d.cd_funcao_executor=3 THEN 1 WHEN d.cd_funcao_executor=6 THEN 3 WHEN d.cd_funcao_executor=7 THEN 4 WHEN d.cd_funcao_executor=4 THEN 2 WHEN d.cd_funcao_executor=8 THEN 9 WHEN d.cd_funcao_executor=9 THEN 5 WHEN d.cd_funcao_executor=10 THEN 12  ELSE 7 END  END  END  IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	substr(hjf_obter_se_divide_honorario(d.cd_item),1,1) ie_divide_honorario, 
	CASE WHEN substr(hjf_obter_se_divide_honorario(d.cd_item),1,1)='S' THEN 22  ELSE 0 END 	cd_tipo_vinculo_divisao, 
	CASE WHEN substr(hjf_obter_se_divide_honorario(d.cd_item),1,1)='S' THEN 49  ELSE 0 END 	CD_DIVISAO_HONORARIO, 
	CASE WHEN substr(hjf_obter_se_divide_honorario(d.cd_item),1,1)='S' THEN 10030  ELSE 0 END  CD_PRESTADOR_DIVISAO, 
	CASE WHEN substr(hjf_obter_se_divide_honorario(d.cd_item),1,1)='S' THEN 2  ELSE 1 END  CD_ATO_MEDICO_DIVISAO, 
	CASE WHEN substr(d.cd_item,1,2)='16' THEN 'N'  ELSE CASE WHEN d.cd_funcao_executor=5 THEN 'S'  ELSE 'N' END  END ie_anestesia, 
	d.nr_porte_anestesico		QT_PORTE_ANESTESICO, 
	CASE WHEN d.IE_TOTAL_INTERF=8 THEN  1  ELSE /* Exames SADT */
 		CASE WHEN d.cd_grupo_proc=20001 THEN 1  ELSE CASE WHEN d.cd_item=14010011 THEN  1 WHEN d.cd_item=80091118 THEN  1 WHEN d.cd_item=40010 THEN  1 WHEN d.cd_item=40029 THEN  1 WHEN d.cd_item=14010020 THEN  1  ELSE /* Visitas e Plantões */
 			CASE WHEN OBTER_TIPO_GUIA_CONVENIO(c.nr_atendimento)='C' THEN 1  WHEN OBTER_TIPO_GUIA_CONVENIO(c.nr_atendimento)='A' THEN  1  ELSE CASE WHEN d.cd_funcao_executor=2 THEN 1 WHEN d.cd_funcao_executor=5 THEN 1 WHEN d.cd_funcao_executor=3 THEN 2  ELSE 3 END  END  END  END  END  CD_NIVEL_PRESTADOR,  
	CASE WHEN d.IE_TOTAL_INTERF=8 THEN  1   ELSE CASE WHEN d.ie_via_acesso_inf='U' THEN 1 WHEN d.ie_via_acesso_inf='M' THEN 3 WHEN d.ie_via_acesso_inf='D' THEN 4  ELSE 2 END  END  IE_VIA_ACESSO, 
	CASE WHEN CASE WHEN OBTER_TIPO_GUIA_CONVENIO(c.nr_atendimento)='C' THEN 1  WHEN OBTER_TIPO_GUIA_CONVENIO(c.nr_atendimento)='A' THEN  1  ELSE CASE WHEN d.cd_funcao_executor=2 THEN 1 WHEN d.cd_funcao_executor=5 THEN 1 WHEN d.cd_funcao_executor=3 THEN 2  ELSE 3 END  END =1 THEN 1  ELSE 2 END  CD_ATO_MEDICO 
from	w_interf_conta_item d, 
	w_interf_conta_cab c, 
	w_interf_conta_header f	 
where  c.nr_interno_conta = d.nr_interno_conta 
and	c.nr_seq_protocolo = f.nr_seq_protocolo 
--and	d.nr_seq_proc_pacote is null 
--and	d.nr_seq_item <> nvl(d.nr_seq_proc_pacote, 0) 
and	coalesce(obter_classif_material_proced(null, d.cd_item, d.ie_origem_proced),0) <> 2 
and 	coalesce(IE_TOTAL_INTERF,0) not in (5,6,7) 
and 	d.ie_tipo_item = 1 

union
 
select	/* Insumos (Taxas e diarias) */
 
	5	 			tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	--substr(f.cd_interno,1,8)	cd_prestador, 
	substr(coalesce(Obter_Prestador_Convenio(d.cd_cgc_prestador, c.cd_convenio,null),f.cd_interno),1,8) cd_prestador, 
	0 				nr_seq_lote, 
	d.nr_interno_conta		nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' '	 			ie_sexo, 
	LOCALTIMESTAMP 			Dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0		 		qt_procedimento_autor, 
	LOCALTIMESTAMP				dt_procedimento, 
	' '				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0				qt_procedimento, 
	0 				vl_procedimento, 
	' '				ie_tipo_nascimento, 
	0				nr_seq_autorizacao, 
	0				ie_tipo_percentual, 
	CASE WHEN hjf_obter_se_proc_pacote(d.nr_atendimento, d.nr_seq_item, d.nr_seq_proc_pacote)='S' THEN 06  ELSE CASE WHEN coalesce(IE_TOTAL_INTERF,0)=7 THEN 2 WHEN coalesce(IE_TOTAL_INTERF,0)=6 THEN 3 WHEN coalesce(IE_TOTAL_INTERF,0)=5 THEN 4  ELSE 0 END  END  
					ie_tipo_insumo, 
	somente_numero(coalesce(d.cd_item_convenio,d.cd_item))	 
					cd_insumo, 
	sum(d.qt_item)			qt_insumo, 
	trunc(d.dt_item)		dt_insumo, 
	sum(d.qt_item)			qt_cobrada, 
	sum(d.vl_total_item)		vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,			 
 	0 				qt_reg_doc, 
 	0	 			qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
from	w_interf_conta_item 	d, 
	w_interf_conta_cab 	c, 
	w_interf_conta_header	f	 
where  c.nr_interno_conta = d.nr_interno_conta 
and	c.nr_seq_protocolo = f.nr_seq_protocolo 
and 	((coalesce(IE_TOTAL_INTERF,0) in (5,6,7)) or (d.nr_seq_item = coalesce(d.nr_seq_proc_pacote,0))) 
and 	d.ie_tipo_item = 1 
group by	 
	c.nr_seq_protocolo, 
	--substr(f.cd_interno,1,8), 
	substr(coalesce(Obter_Prestador_Convenio(d.cd_cgc_prestador, c.cd_convenio,null),f.cd_interno),1,8), 
	d.nr_interno_conta, 
	CASE WHEN hjf_obter_se_proc_pacote(d.nr_atendimento, d.nr_seq_item, d.nr_seq_proc_pacote)='S' THEN 06  ELSE CASE WHEN coalesce(IE_TOTAL_INTERF,0)=7 THEN 2 WHEN coalesce(IE_TOTAL_INTERF,0)=6 THEN 3 WHEN coalesce(IE_TOTAL_INTERF,0)=5 THEN 4  ELSE 0 END  END , 
	somente_numero(coalesce(d.cd_item_convenio,d.cd_item)), 
	trunc(d.dt_item) 
having sum(d.qt_item) > 0 

union
 
select	/* Insumos (Materiais e Medicamentos) */
 
	5				tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	substr(f.cd_interno,1,8)	cd_prestador, 
	0 				nr_seq_lote, 
	d.nr_interno_conta		nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP	 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP	 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 	 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	CASE WHEN hjf_obter_se_proc_pacote(d.nr_atendimento, d.nr_seq_item, d.nr_seq_proc_pacote)='S' THEN 06  ELSE (d.cd_grupo_gasto)::numeric  END  
					ie_tipo_insumo, 
	somente_numero(coalesce(d.cd_item_convenio,d.cd_item)) 
					cd_insumo, 
	sum(d.qt_item) 			qt_insumo, 
	trunc(d.dt_item) 		dt_insumo, 
	sum(d.qt_item) 			qt_cobrada, 
	sum(d.vl_total_item) 		vl_cobrado, 
	0	 			cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	0 				qt_reg_nota,	 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
from	w_interf_conta_item 	d, 
	w_interf_conta_cab 	c, 
	w_interf_conta_header	f 
where  c.nr_interno_conta = d.nr_interno_conta 
and 	c.nr_seq_protocolo = f.nr_seq_protocolo 
--and	d.nr_seq_proc_pacote is null   	Almir em OS119302 
and 	d.ie_tipo_item = 2 
group by 
	c.nr_seq_protocolo, 
	substr(f.cd_interno,1,8), 
	d.nr_interno_conta, 
	CASE WHEN hjf_obter_se_proc_pacote(d.nr_atendimento, d.nr_seq_item, d.nr_seq_proc_pacote)='S' THEN 06  ELSE (d.cd_grupo_gasto)::numeric  END , 
	somente_numero(coalesce(d.cd_item_convenio,d.cd_item)), 
	trunc(d.dt_item) 		 
having sum(d.qt_item) > 0 

union
 
select	/* Pacote */
 
	6 				tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	substr(f.cd_interno,1,8)	cd_prestador, 
	0 				nr_seq_lote, 
	d.nr_interno_conta		nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	 
					dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 	 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual,	 
	0 				ie_tipo_insumo,	 
	0 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	somente_numero(coalesce(d.cd_item_convenio,d.cd_item)) 
					cd_pacote, 
	d.dt_item			dt_emissao, 
 	0 				qt_reg_nota,	 
 	0 				qt_reg_doc, 
 	0 				qt_reg_proc, 
	0 				qt_reg_insumo, 
	0 				vl_total_lote, 
	d.nr_seq_proc_pacote		nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	d.qt_item			qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
from	w_interf_conta_item 	d, 
	w_interf_conta_cab 	c, 
	w_interf_conta_header	f	 
where  c.nr_interno_conta = d.nr_interno_conta 
and	c.nr_seq_protocolo = f.nr_seq_protocolo 
and	d.nr_seq_proc_pacote is not null 
and 	1 = 2 /* OS 99474, de acordo com o Layout esse registro 6 não é utilizado pelo convênio e não deve ser enviado */
 

union
 
select	/* Trailler */
 
	7 				tp_registro, 
	c.nr_seq_protocolo		nr_seq_protocolo, 
	'0'	 			cd_prestador, 
	0 				nr_seq_lote, 
	999999				nr_interno_conta, 
	' '				cd_serie_documento, 
	LOCALTIMESTAMP 			dt_geracao, 
	' ' 				nr_documento, 
	'0' 				cd_unid_carteira, 
	' ' 				nr_carteira, 
	LOCALTIMESTAMP 			dt_referencia, 
	0 				cd_motivo_alta, 
	' ' 				cd_cid, 
	LOCALTIMESTAMP 			dt_entrada, 
	LOCALTIMESTAMP 			dt_alta, 
	to_char(trunc(LOCALTIMESTAMP,'year'),'yyyy')	 
					dt_ano_guia, 
	0 				nr_guia, 
	'0' 				cd_classe_nota, 
	'0' 				cd_acomodacao, 
	' ' 				nm_beneficiario, 
	' ' 				ie_sexo, 
	LOCALTIMESTAMP 			dt_nascimento, 
	LOCALTIMESTAMP 			dt_validade_carteira, 
	0 				cd_setor_atendimento, 
	0				cd_procedimento, 
	0 				qt_procedimento_autor, 
	LOCALTIMESTAMP 			dt_procedimento, 
	' ' 				ie_urgencia, 
	' ' 				ie_adicional_urgencia, 
	0 				qt_procedimento, 
	0 				vl_procedimento, 
	' ' 				ie_tipo_nascimento, 
	0 				nr_seq_autorizacao, 
	0 				ie_tipo_percentual, 
	0 				ie_tipo_insumo,	 
	0 				cd_insumo, 
	0 				qt_insumo, 
	LOCALTIMESTAMP 			dt_insumo, 
	0 				qt_cobrada, 
	0 				vl_cobrado, 
	0 				cd_pacote, 
	LOCALTIMESTAMP 			dt_emissao, 
 	2 				qt_reg_nota, 
 	3 				qt_reg_doc, 
 	4 				qt_reg_proc, 
	5 				qt_reg_insumo, 
	sum(c.vl_total_conta)		vl_total_lote, 
	0				nr_seq_pacote, 
	0				nr_lote, 
	0 				qt_nasc_vivos_termo, 
	0				 qt_nasc_mortos, 
	0 				qt_nasc_vivos_premat, 
	0 				qt_obito_nasc_precoc, 
	0 				qt_obito_nasc_tardio, 
	'0'		 		ie_tipo_saida, 
	' '				ie_tipo_doenca, 
	0				qt_tempo_doenca, 
	' '				ie_tipo_tempo_doenca, 
	0 				ie_acidente, 
	' ' 				cd_cid1, 
	' ' 				cd_cid2, 
	' ' 				cd_cid3, 
	' '				nm_prof_solicitante, 
	0				ie_tipo_atendimento, 
	0				ie_tipo_consulta, 
	' '				ds_observacoes, 
	' '				ie_gestacao, 
	' ' 				ie_aborto, 
	' '				ie_trans_gravidez, 
	' '				ie_compl_puerperio, 	 
	' '				ie_sala_parto, 
	' '				ie_compl_neonat, 
	' '				ie_baixo_peso, 
	' '				ie_parto_cesareo, 
	' ' 				ie_parto_normal, 
	' ' 				ie_obito_mulher, 
	' '				ie_nasc_vivos, 
	' '				ie_cid_obito, 
	0				nr_decl_obito, 
	' '				ie_tipo_faturamento, 
	'000'				cd_cobertura, 
	' '				nm_prest_exec, 
	'00'				cd_tab_medica, 
	LOCALTIMESTAMP				hr_final, 
	' ' 				nm_prof_exec, 
	' '				ie_tec_utilizada, 
	' ' 				ie_tipo_perc, 
	0				qt_pacote, 
	0				nr_linha_ptu, 
	0				IE_GRAU_PARTIC, 
	' '				NR_DEC_NASC_VIVO2, 
	' '				NR_DEC_NASC_VIVO3, 
	' '				NR_DEC_NASC_VIVO4, 
	' '				NR_DEC_NASC_VIVO5, 
	0				IE_REGIME_INTER, 
	' '				DS_INDICACAO_CLINICA, 
	0				CD_TIPO_ACOMOD_TISS, 
	' '				CONS_PROF_SOLIC, 
	' '				NR_CONS_PROF_SOLIC, 
	' '				UF_CONS_PROF_SOLIC, 
	' '				CD_CBO_PROC_SOLIC, 
	' '				NR_GUIA_PRINCIPAL, 
	0				nr_seq_digitacao, 
	0				nr_seq_digitacao2, 
	' '				ie_divide_honorario, 
	0				cd_tipo_vinculo_divisao, 
	0				CD_DIVISAO_HONORARIO, 
	0				CD_PRESTADOR_DIVISAO, 
	0				CD_ATO_MEDICO_DIVISAO, 
	' '				ie_anestesia, 
	0				QT_PORTE_ANESTESICO, 
	0				CD_NIVEL_PRESTADOR, 
	0				IE_VIA_ACESSO, 
	0				CD_ATO_MEDICO 
from	w_interf_conta_trailler c 
group by c.nr_seq_protocolo;

