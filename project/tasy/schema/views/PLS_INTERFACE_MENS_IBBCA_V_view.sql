-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';

CREATE OR REPLACE VIEW pls_interface_mens_ibbca_v (ie_tipo_reg, nm_titular, nm_pessoa_fisica, cd_procedimento, ds_procedimento, qt_liberada_copartic, vl_coparticipacao, nm_prestador, ds_unimed, ds_branco, nr_cpf, cd_usuario_plano_1, cd_usuario_plano_2, dt_emissao, cd_especialidade, nm_usuario) AS select	1 ie_tipo_reg,
	' ' nm_titular, 
	' ' nm_pessoa_fisica, 
	' ' cd_procedimento, 
	' ' ds_procedimento, 
	null QT_LIBERADA_COPARTIC, 
	null VL_COPARTICIPACAO, 
	' ' nm_prestador, 
	' ' ds_unimed, 
	' ' ds_branco, 
	' ' nr_cpf, 
	' ' cd_usuario_plano_1, 
	' ' cd_usuario_plano_2, 
	null DT_EMISSAO, 
	' ' cd_especialidade, 
	nm_usuario 
FROM	W_PLS_INTERFACE_MENS 
group by nm_usuario 

union all
	 
select	2 ie_tipo_reg, 
	CASE WHEN g.nr_seq_titular IS NULL THEN h.nm_pessoa_fisica  ELSE substr(pls_obter_dados_segurado(g.nr_sequencia,'NT'),1,255) END  nm_titular, 
	h.nm_pessoa_fisica, 
	coalesce(substr(pls_obter_dados_conta_proc(i.nr_seq_conta_proc,'C'),1,255),substr(pls_obter_dados_conta_mat(i.nr_seq_conta_mat,'C'),1,255)) cd_procedimento, 
	coalesce(substr(pls_obter_dados_conta_proc(i.nr_seq_conta_proc,'D'),1,255),substr(pls_obter_dados_conta_mat(i.nr_seq_conta_mat,'D'),1,255)) ds_procedimento, 
	i.QT_LIBERADA_COPARTIC, 
	replace(campo_mascara(i.VL_COPARTICIPACAO,2),'.',',') VL_COPARTICIPACAO, 
	substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'N'),1,255) nm_prestador, 
	'UNIMED SÃO JOSÉ DO RIO PRETO' ds_unimed, 
	' ' ds_branco, 
	CASE WHEN g.nr_seq_titular IS NULL THEN h.nr_cpf  ELSE substr(pls_obter_dados_segurado(g.nr_seq_titular,'CPF'),1,255) END  nr_cpf, 
	substr(f.cd_usuario_plano,5,10) cd_usuario_plano_1, 
	f.cd_usuario_plano cd_usuario_plano_2, 
	c.DT_EMISSAO, 
	' ' cd_especialidade, 
	d.nm_usuario 
from	PLS_CONTA_COPARTICIPACAO	i, 
	pessoa_fisica			h, 
	pls_segurado			g, 
	pls_segurado_carteira		f, 
	pls_mensalidade_segurado	e, 
	W_PLS_INTERFACE_MENS		d, 
	pls_conta			c, 
	pls_mensalidade_seg_item	b, 
	pls_contrato			a 
where	g.cd_pessoa_fisica		= h.cd_pessoa_fisica 
and	f.nr_seq_segurado		= g.nr_sequencia 
and	e.nr_seq_segurado		= g.nr_sequencia 
and	d.NR_SEQ_MENSALIDADE_SEG	= e.nr_sequencia 
and	b.NR_SEQ_MENSALIDADE_SEG	= e.nr_sequencia 
and	i.NR_SEQ_MENSALIDADE_SEG	= e.nr_sequencia 
and	b.nr_seq_conta			= c.nr_sequencia 
and	g.nr_seq_contrato		= a.nr_sequencia;

