-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE exclui_amostra_rack (nr_seq_armazem_rack_p bigint, nr_seq_lab_am_rack_p bigint, amostra_excluida_p INOUT text) AS $body$
DECLARE


gravado_w           varchar(1);
nr_sequencia_info_w bigint;
nr_total_info_w bigint;

BEGIN
  gravado_w := 'N';
  begin
    update lab_soro_amostra_rack set ds_amostra = ' ', ie_status = 'L'
     where nr_sequencia = nr_seq_lab_am_rack_p;

    select count(nr_sequencia)
      into STRICT nr_total_info_w
      from lab_soro_processo_info
     where IE_ACAO = 'AR' and
           nr_seq_armazena_rack = nr_seq_armazem_rack_p and
           (nr_seq_amostra_rack IS NOT NULL AND nr_seq_amostra_rack::text <> '');

    if (nr_total_info_w > 1) then
      delete from lab_soro_processo_info
       where nr_seq_amostra_rack = nr_seq_lab_am_rack_p and
             nr_seq_armazena_rack = nr_seq_armazem_rack_p;
    else
      select max(nr_sequencia)
        into STRICT nr_sequencia_info_w
        from lab_soro_processo_info
       where IE_ACAO = 'AR' and
             nr_seq_armazena_rack = nr_seq_armazem_rack_p and
             nr_seq_amostra_rack = nr_seq_lab_am_rack_p;

      update lab_soro_processo_info set nr_seq_amostra_rack  = NULL
       where nr_sequencia = nr_sequencia_info_w;
    end if;

    delete from lab_soro_exame_amostra
     where nr_seq_amostra_rack = nr_seq_lab_am_rack_p;

    gravado_w := 'S';
    commit;
	exception
  when others then
    gravado_w := 'N';
  end;

  amostra_excluida_p := gravado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exclui_amostra_rack (nr_seq_armazem_rack_p bigint, nr_seq_lab_am_rack_p bigint, amostra_excluida_p INOUT text) FROM PUBLIC;

