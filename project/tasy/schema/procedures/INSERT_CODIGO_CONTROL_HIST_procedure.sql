-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_codigo_control_hist ( nm_usuario_p text, nr_autorizacao_p bigint, nr_factura_p bigint, dt_emision_p timestamp, nr_nit_p bigint default 0, nr_monto_p bigint DEFAULT NULL, cd_llave_p text DEFAULT NULL, cd_codigo_control_p text DEFAULT NULL, nr_item_p bigint default null, cd_medico_p text default null) AS $body$
DECLARE


dt_sysdate_s    timestamp := clock_timestamp();


BEGIN
    if ((nr_autorizacao_p IS NOT NULL AND nr_autorizacao_p::text <> '') and (nr_factura_p IS NOT NULL AND nr_factura_p::text <> '') and (dt_emision_p IS NOT NULL AND dt_emision_p::text <> '')
        and (nr_monto_p IS NOT NULL AND nr_monto_p::text <> '') and (cd_llave_p IS NOT NULL AND cd_llave_p::text <> '') and (cd_codigo_control_p IS NOT NULL AND cd_codigo_control_p::text <> '')) then

        insert into GERAR_CODIGO_CONTROL_HIST(
            nr_sequencia,
            dt_atualizacao,
            dt_atualizacao_nrec,
            nm_usuario,
            nm_usuario_nrec,
            nr_autorizacao,
            nr_factura,
            dt_emision,
            nr_nit,
            nr_monto,
            cd_llave,
            cd_codigo_control,
            cd_medico
        ) values (
            nextval('gerar_codigo_control_hist_seq'),
            dt_sysdate_s,
            dt_sysdate_s,
            coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
            coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
            nr_autorizacao_p,
            nr_factura_p,
            dt_emision_p,
            coalesce(nr_nit_p, 0),
            nr_monto_p,
            cd_llave_p,
            cd_codigo_control_p,
            cd_medico_p
        );

        if (nr_item_p IS NOT NULL AND nr_item_p::text <> '') then
            update  nota_fiscal
            set     cd_control_code = cd_codigo_control_p,
                    nr_autorizacao = (
                        SELECT  max(nr_autorizacao)
                        from    autorizacao_numero_hist 
                        where   ie_situacao = 'A' 
                        and     dt_sysdate_s between dt_inicial and dt_fim)
            where   nr_sequencia = nr_item_p;
        end if;

        if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') then
            update  third_party_invoice
            set     cd_control_code = cd_codigo_control_p,
                    dt_emissao  = dt_emision_p
            where   nr_fatura   = nr_factura_p;
        end if;

        commit;
    end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_codigo_control_hist ( nm_usuario_p text, nr_autorizacao_p bigint, nr_factura_p bigint, dt_emision_p timestamp, nr_nit_p bigint default 0, nr_monto_p bigint DEFAULT NULL, cd_llave_p text DEFAULT NULL, cd_codigo_control_p text DEFAULT NULL, nr_item_p bigint default null, cd_medico_p text default null) FROM PUBLIC;

