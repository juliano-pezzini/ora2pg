-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_regra_encaixe_agenda (cd_tipo_agenda_p bigint, dt_encaixe_p timestamp, hr_encaixe_p timestamp, dt_hr_encaixe_p timestamp, cd_agenda_p bigint, cd_convenio_p bigint, ie_permite_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


                                
nr_seq_regra_encaixe_w agenda_regra_encaixe.nr_sequencia%type;
qt_permitida_regra_w agenda_regra_encaixe.qt_permitida%type;
hr_inicial_regra_w agenda_regra_encaixe.hr_inicial%type;
hr_final_regra_w agenda_regra_encaixe.hr_final%type;
cd_convenio_regra_w agenda_regra_encaixe.cd_convenio%type;
cd_perfil_regra_w agenda_regra_encaixe.cd_perfil%type;
ie_regra_encaixe_w agenda.ie_regra_encaixe%type;

qt_encaixe_existe_w integer;
ie_permite_w varchar(1) := 'S';
dt_hora_encaixe_w timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia,
        coalesce(hr_inicial, to_date('30/12/1899 00:00:01', 'dd/mm/yyyy hh24:mi:ss')) hr_inicial,
        coalesce(hr_final, to_date('30/12/1899 23:59:59', 'dd/mm/yyyy hh24:mi:ss')) hr_final
	from	agenda_regra_encaixe
	where	cd_agenda = cd_agenda_p	
	and		obter_cod_dia_semana(dt_hora_encaixe_w) = ie_dia_semana		
	and		dt_hora_encaixe_w
			between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	and		((cd_convenio 	= cd_convenio_p) or (coalesce(cd_convenio_p::text, '') = ''))
	order by 	coalesce(cd_convenio,0),
				hr_inicial,
				hr_final;
				
C02 CURSOR FOR
	SELECT	nr_sequencia,
          coalesce(hr_inicial, to_date('30/12/1899 00:00:01', 'dd/mm/yyyy hh24:mi:ss')) hr_inicial,
          coalesce(hr_final, to_date('30/12/1899 23:59:59', 'dd/mm/yyyy hh24:mi:ss')) hr_final
	from	agenda_regra_encaixe
	where	cd_agenda = cd_agenda_p
	and		(coalesce(ie_dia_semana::text, '') = '' or (ie_dia_semana = obter_cod_dia_semana(dt_hora_encaixe_w)) or ((ie_dia_semana = 9) and (obter_cod_dia_semana(dt_hora_encaixe_w) not in (7,1))))
	and		dt_hora_encaixe_w
			between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	and		((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
	order by 	coalesce(cd_convenio,0),
				hr_inicial,
				hr_final;

C03 CURSOR FOR 
  SELECT	nr_sequencia
	from	agenda_regra_encaixe
	where	cd_agenda = cd_agenda_p
	and		(coalesce(ie_dia_semana::text, '') = '' or (ie_dia_semana = obter_cod_dia_semana(dt_hora_encaixe_w)) or ((ie_dia_semana = 9) and (obter_cod_dia_semana(dt_hora_encaixe_w) not in (7,1))))
	and		((cd_perfil = obter_perfil_ativo) or (coalesce(cd_perfil::text, '') = ''))
	and		((coalesce(cd_convenio,0) = cd_convenio_p) or (coalesce(cd_convenio,0) = 0))
	and		dt_hora_encaixe_w	
	between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	order by coalesce(cd_perfil,0);
BEGIN

  if cd_tipo_agenda_p = 2 then

    if (dt_hr_encaixe_p IS NOT NULL AND dt_hr_encaixe_p::text <> '') then
      dt_hora_encaixe_w := dt_hr_encaixe_p;
    else
      dt_hora_encaixe_w := to_date(to_char(dt_encaixe_p, 'dd/mm/yyyy') || ' ' || to_char(hr_encaixe_p,'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss');
    end if;

    select coalesce(max(ie_regra_encaixe),'N')
    into STRICT	ie_regra_encaixe_w
    from	agenda
    where	cd_agenda = cd_agenda_p;

    for c_03 in C03 loop
      nr_seq_regra_encaixe_w := c_03.nr_sequencia;
    end loop;
	
    select	coalesce(max(qt_permitida),0),
        max(hr_inicial),
        max(hr_final),
        max(cd_perfil),
        max(coalesce(cd_convenio,0))
    into STRICT	qt_permitida_regra_w,
        hr_inicial_regra_w,
        hr_final_regra_w,
        cd_perfil_regra_w,
        cd_convenio_regra_w
    from	agenda_regra_encaixe
    where	nr_sequencia = nr_seq_regra_encaixe_w;

    if (ie_regra_encaixe_w <> 'N') and (qt_permitida_regra_w = 0) then

      select count(1)
      into STRICT	qt_encaixe_existe_w
      from	agenda_regra_encaixe
      where	cd_agenda	= cd_agenda_p  LIMIT 1;

      if (qt_encaixe_existe_w > 0) then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(251260);
      end if;		

    end if;

    if (qt_permitida_regra_w > 0 ) then
      select	count(1)
      into STRICT	qt_encaixe_existe_w
      from	agenda_paciente
      where	ie_encaixe = 'S'
      and		cd_agenda = cd_agenda_p
      and		to_date(to_char(hr_inicio,'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
      between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial_regra_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
          to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final_regra_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss') 	
      and		((cd_perfil_ger_encaixe = cd_perfil_regra_w) or (coalesce(cd_perfil_regra_w::text, '') = ''))
      and		((coalesce(cd_convenio,0) = cd_convenio_regra_w) or (cd_convenio_regra_w = 0))
      and		ie_status_agenda <> 'C';

      if (qt_encaixe_existe_w >= qt_permitida_regra_w) then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(251261);
      end if;

    elsif qt_permitida_regra_w = 0 and (nr_seq_regra_encaixe_w IS NOT NULL AND nr_seq_regra_encaixe_w::text <> '') then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(251261);
    end if;

  elsif cd_tipo_agenda_p in (3,4) then

    select	max(qt_permitida),
      max(hr_inicial),
      max(hr_final),
      max(cd_convenio)
    into STRICT	qt_permitida_regra_w,
      hr_inicial_regra_w,
      hr_final_regra_w,
      cd_convenio_regra_w
    from	agenda_regra_encaixe
    where	cd_agenda = cd_agenda_p
    and		((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
    and	obter_cod_dia_semana(dt_encaixe_p) = ie_dia_semana
    and	dt_hr_encaixe_p
    between CASE WHEN coalesce(hr_inicial::text, '') = '' THEN  PKG_DATE_UTILS.start_of(dt_encaixe_p, 'dd')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_inicial) END  
    and CASE WHEN coalesce(hr_final::text, '') = '' THEN  PKG_DATE_UTILS.end_of(dt_encaixe_p, 'DAY')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_final) END  
    and	dt_hr_encaixe_p between coalesce(dt_inicial_vigencia, dt_hr_encaixe_p) and coalesce(dt_final_vigencia + 86399/86400, dt_hr_encaixe_p + 86399/86400);				

    if (coalesce(hr_inicial_regra_w::text, '') = '') then
      
      select	max(qt_permitida),
        max(hr_inicial),
        max(hr_final),
        max(cd_convenio)
      into STRICT	qt_permitida_regra_w,
        hr_inicial_regra_w,
        hr_final_regra_w,
        cd_convenio_regra_w
      from	agenda_regra_encaixe
      where	cd_agenda = cd_agenda_p
      and		((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
      and	((ie_dia_semana = obter_cod_dia_semana(dt_encaixe_p)) or ((ie_dia_semana = 9) and (obter_cod_dia_semana(dt_encaixe_p) not in (7,1))) or (coalesce(ie_dia_semana::text, '') = ''))
      and	dt_hr_encaixe_p
      between CASE WHEN coalesce(hr_inicial::text, '') = '' THEN  PKG_DATE_UTILS.start_of(dt_encaixe_p, 'dd')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_inicial) END  
      and CASE WHEN coalesce(hr_final::text, '') = '' THEN  PKG_DATE_UTILS.end_of(dt_encaixe_p, 'DAY')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_final) END  
      and	dt_hr_encaixe_p between coalesce(dt_inicial_vigencia, dt_hr_encaixe_p) and coalesce(dt_final_vigencia + 86399/86400, dt_hr_encaixe_p + 86399/86400);
    end if;		

    if (qt_permitida_regra_w IS NOT NULL AND qt_permitida_regra_w::text <> '') then
      if (coalesce(cd_convenio_regra_w::text, '') = '')then
        select	count(1)
        into STRICT	qt_encaixe_existe_w
        from	agenda_consulta
        where	ie_encaixe = 'S'
        and	cd_agenda = cd_agenda_p
        and	dt_agenda 	between CASE WHEN coalesce(hr_inicial_regra_w::text, '') = '' THEN  PKG_DATE_UTILS.start_of(dt_encaixe_p, 'dd')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_inicial_regra_w) END  
        and CASE WHEN coalesce(hr_final_regra_w::text, '') = '' THEN  PKG_DATE_UTILS.end_of(dt_encaixe_p, 'DAY')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_final_regra_w) END  
        and	ie_status_agenda <> 'C';
      else
        select	count(1)
        into STRICT	qt_encaixe_existe_w
        from	agenda_consulta
        where	ie_encaixe = 'S'
        and	cd_agenda = cd_agenda_p
        and	cd_agenda = cd_agenda_p
        and	dt_agenda 	between CASE WHEN coalesce(hr_inicial_regra_w::text, '') = '' THEN  PKG_DATE_UTILS.start_of(dt_encaixe_p, 'dd')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_inicial_regra_w) END
        and CASE WHEN coalesce(hr_final_regra_w::text, '') = '' THEN  PKG_DATE_UTILS.end_of(dt_encaixe_p, 'DAY')  ELSE pkg_date_utils.get_DateTime(dt_encaixe_p, hr_final_regra_w) END  
        and	ie_status_agenda <> 'C'
        and	cd_convenio = cd_convenio_p;
      end if;

      if (qt_encaixe_existe_w >= qt_permitida_regra_w)then
        ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279677,null);
        ie_permite_w := 'N';
      end if;
    end if;

    ie_permite_p := ie_permite_w;

  elsif cd_tipo_agenda_p = 5 then
  
    if (dt_hr_encaixe_p IS NOT NULL AND dt_hr_encaixe_p::text <> '') then
      dt_hora_encaixe_w := dt_hr_encaixe_p;
    end if;

    for c_01 in C01 loop

      nr_seq_regra_encaixe_w := c_01.nr_sequencia;

    end loop;

    select	coalesce(max(qt_permitida),0),
        max(hr_inicial),
        max(hr_final),
        max(cd_convenio)
    into STRICT	qt_permitida_regra_w,
        hr_inicial_regra_w,
        hr_final_regra_w,
        cd_convenio_regra_w
    from	agenda_regra_encaixe
    where	nr_sequencia = nr_seq_regra_encaixe_w;				

    if (coalesce(hr_inicial_regra_w::text, '') = '') then
    
      for c_02 in C02 loop
      
        nr_seq_regra_encaixe_w	:= c_02.nr_sequencia;

      end loop;	

      select	coalesce(max(qt_permitida),0),
          max(hr_inicial),
          max(hr_final),
          max(cd_convenio)
      into STRICT	qt_permitida_regra_w,
          hr_inicial_regra_w,
          hr_final_regra_w,
          cd_convenio_regra_w
      from	agenda_regra_encaixe
      where	nr_sequencia = nr_seq_regra_encaixe_w;

    end if;

    if (qt_permitida_regra_w > 0 ) then

      if (coalesce(cd_convenio_regra_w::text, '') = '') then					
        
        select	count(1)
        into STRICT	qt_encaixe_existe_w
        from	agenda_consulta
        where	ie_encaixe = 'S'
        and		cd_agenda = cd_agenda_p
        and		to_date(to_char(dt_agenda,'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
            between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial_regra_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
            to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final_regra_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss') 	
        and		ie_status_agenda <> 'C';

      else
        
        select	count(1)
        into STRICT	qt_encaixe_existe_w
        from	agenda_consulta
        where	ie_encaixe = 'S'
        and		cd_agenda = cd_agenda_p
        and		to_date(to_char(dt_agenda,'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
            between to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial_regra_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
            to_date(to_char(dt_hora_encaixe_w,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final_regra_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss') 	
        and		ie_status_agenda <> 'C'
        and		cd_convenio		= cd_convenio_regra_w;


      end if;

      if (qt_encaixe_existe_w >= qt_permitida_regra_w) then
        ie_permite_w	:= 'N';
        ds_erro_p := wheb_mensagem_pck.get_texto(280194,'DS_ERRO_W2='|| to_char(dt_hora_encaixe_w,'dd/mm hh24:mi'));
      end if;
    elsif (qt_permitida_regra_w = 0) and (nr_seq_regra_encaixe_w IS NOT NULL AND nr_seq_regra_encaixe_w::text <> '') then					
      ie_permite_w	:= 'N';
      ds_erro_p := wheb_mensagem_pck.get_texto(280194,'DS_ERRO_W2='|| to_char(dt_hora_encaixe_w,'dd/mm hh24:mi'));
    end if;

    ie_permite_p := ie_permite_w;
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_regra_encaixe_agenda (cd_tipo_agenda_p bigint, dt_encaixe_p timestamp, hr_encaixe_p timestamp, dt_hr_encaixe_p timestamp, cd_agenda_p bigint, cd_convenio_p bigint, ie_permite_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

