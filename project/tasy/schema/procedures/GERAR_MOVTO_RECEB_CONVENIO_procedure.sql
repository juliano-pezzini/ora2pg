-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_receb_convenio ( cd_estabelecimento_p bigint, nr_seq_receb_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


DT_RECEBIMENTO_w		timestamp;
dt_liberacao_w			timestamp;
ds_observacao_w			varchar(255);
VL_RECEBIMENTO_w		double precision;
VL_DESPESA_BANCARIA_w		double precision;
VL_DEPOSITO_w			double precision;
NR_SEQ_CONTA_BANCO_w	bigint;
NR_SEQ_TRANS_FIN_w		bigint;
cd_convenio_w			integer;
cd_cgc_convenio_w		varchar(14);
qt_movto_w			integer;
NR_SEQ_MOVTO_W		bigint;
ie_movto_conv_receb_w		varchar(100);
ie_integrar_cb_fluxo_w		varchar(100);
nr_seq_cobranca_w		bigint;
ie_entra_banco_w			varchar(255);
ie_banco_w			varchar(255);


BEGIN

select	coalesce(NR_SEQ_CONTA_BANCO,0),
	coalesce(NR_SEQ_TRANS_FIN,0),
	cd_convenio,
	coalesce(VL_RECEBIMENTO,0),
	coalesce(VL_DESPESA_BANCARIA,0),
	coalesce(VL_DEPOSITO,0),
	DT_RECEBIMENTO,
	dt_liberacao,
	DS_OBSERVACAO,
	coalesce(ie_integrar_cb_fluxo,'S'),
	nr_seq_cobranca
into STRICT	NR_SEQ_CONTA_BANCO_w,
	NR_SEQ_TRANS_FIN_w,
	cd_convenio_w,
	VL_RECEBIMENTO_w,
	VL_DESPESA_BANCARIA_w,
	VL_DEPOSITO_w,
	DT_RECEBIMENTO_w,
	dt_liberacao_w,
	ds_observacao_w,
	ie_integrar_cb_fluxo_w,
	nr_seq_cobranca_w
from 	convenio_receb
where 	nr_sequencia = nr_seq_receb_p;

ie_entra_banco_w := obter_param_usuario(27, 158, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_entra_banco_w);

select	max(ie_banco)
into STRICT	ie_banco_w
from	transacao_financeira
where	nr_Sequencia = NR_SEQ_TRANS_FIN_w;

select	cd_cgc
into STRICT	cd_cgc_convenio_w
from	convenio
where	cd_convenio	= cd_convenio_w;

select	coalesce(max(ie_movto_conv_receb),'N')
into STRICT	ie_movto_conv_receb_w
from 	parametro_contas_receber
where 	cd_estabelecimento = cd_estabelecimento_p;


select	count(*)
into STRICT	qt_movto_w
from	MOVTO_TRANS_FINANC
where	nr_seq_conv_receb = nr_seq_receb_p;

/*
insert into log_xxtasy	(
			dt_atualizacao,
			nm_usuario,
			cd_log,
			ds_log
			)
values			(
			sysdate,
			nm_usuario_p,
			7412,
			'Seq= ' || nr_seq_receb_p || 'Conta Banco: ' || nvl(NR_SEQ_CONTA_BANCO_w,0) || chr(13) ||
			' Transação: ' || NR_SEQ_TRANS_FIN_w  || ' Movimento: ' || qt_movto_w || chr(13) ||
			' Par. Contas receber: ' || ie_movto_conv_receb_w || chr(13) ||
			' Dt liberacao: ' || dt_liberacao_w || chr(13) ||
			' Integrar CB fluxo: ' || ie_integrar_cb_fluxo_w || chr(13) ||
			' Nr_seq_trans_fin= ' || nr_seq_trans_fin_w);

			*/
if (ie_integrar_cb_fluxo_w = 'S') and
   ((NR_SEQ_CONTA_BANCO_w > 0) and (NR_SEQ_TRANS_FIN_w > 0) and (qt_movto_w = 0) and
   ((ie_movto_conv_receb_w = 'I') or (ie_movto_conv_receb_w = 'L' AND dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> ''))) and
   ((coalesce(ie_entra_banco_w,'S') = 'S') or (coalesce(ie_banco_w,'S') <> 'N')) then

	SELECT	nextval('movto_trans_financ_seq')
	INTO STRICT	NR_SEQ_MOVTO_W
	;

	INSERT	INTO MOVTO_TRANS_FINANC(NR_SEQUENCIA,
		DT_TRANSACAO,
		NR_SEQ_TRANS_FINANC,
		VL_TRANSACAO,
		NR_SEQ_BANCO,
		NR_SEQ_CONV_RECEB,
		DT_REFERENCIA_SALDO,
		DT_ATUALIZACAO,
		NM_USUARIO,
		nr_lote_contabil,
		ie_conciliacao,
		ds_historico,
		cd_cgc,
		nr_seq_cobr_escrit)
	VALUES (NR_SEQ_MOVTO_W,
		DT_RECEBIMENTO_W,
		NR_SEQ_TRANS_FIN_W,
		CASE WHEN coalesce(VL_DEPOSITO_W,0)=0 THEN  VL_RECEBIMENTO_W - coalesce(VL_DESPESA_BANCARIA_W,0)  ELSE VL_DEPOSITO_W END ,
		NR_SEQ_CONTA_BANCO_W,
		NR_SEQ_receb_p,
		TRUNC(DT_RECEBIMENTO_W,'MM'),
		clock_timestamp(),
		NM_USUARIO_p,
		0,
		'N',
		DS_OBSERVACAO_W,
		cd_cgc_convenio_w,
		nr_seq_cobranca_w);
end if;

if (coalesce(ie_commit_p,'N')	= 'S') then

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_receb_convenio ( cd_estabelecimento_p bigint, nr_seq_receb_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

