-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conta_repasse ( nr_repasse_terceiro_p bigint, ie_tipo_convenio_p bigint, nm_usuario_p text, ie_gerar_estornados_p text, ie_gerar_rep_perc_saldo_p text, ie_valor_lib_zerado_p text, nr_seq_protocolo_p bigint, ie_tipo_atendimento_p bigint, ds_filtro_convenios_p text, ds_filtro_procedimentos_p text, cd_area_proc_p bigint, cd_espec_proc_p bigint, cd_grupo_proc_p bigint, ds_filtro_medicos_p text, ds_filtro_proc_p text, ds_observacao_p text default null) AS $body$
DECLARE


/* Toda vez que alterar esta PROCEDURE verifica se a GERAR_CONTA_REPASSE_MEDICO deve ser alterada tambem*/

nr_seq_terceiro_w		bigint;
cd_convenio_w			integer;
ie_tipo_data_w			smallint;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_mesano_referencia_w		timestamp;
nr_sequencia_w			bigint;
qt_reg_proc_w			bigint;
qt_reg_mat_w			bigint;
qt_reg_item_w			bigint;
nr_seq_repasse_item_w		bigint;
cont_w				bigint;
ie_tipo_convenio_regra_w	bigint;
ie_excluir_rep_zerado_w		varchar(255);
ie_saldo_w			varchar(255);
ie_valor_w			varchar(255);
cd_estabelecimento_w		smallint;
nr_seq_terc_rep_w		bigint;
tx_repasse_w			double precision;
nr_seq_terc_destino_w		bigint;
nr_seq_trans_financ_w		bigint;
nr_repasse_terceiro_dest_w	bigint;
nr_sequencia_item_w		bigint;
vl_item_w			double precision;
vl_repassar_w			double precision;
vl_repasse_ie_valor_w		double precision;
vl_repasse_w			double precision;
vl_saldo_repasse_w		double precision;
vl_repasse_proc_w		double precision;
vl_repasse_mat_w		double precision;
vl_repasse_regra_w		double precision;
ie_calcular_item_w		varchar(1);
ie_desconsiderar_glosados_w	varchar(255); -- afstringari 193824 31/03/2010
ie_estorno_w			varchar(100);
ds_convenios_w			varchar(255);
ds_convenios_not_w		varchar(1);
ds_procedimentos_w		varchar(255);
ds_procedimentos_not_w		varchar(1);
nr_seq_tipo_w			bigint;
ie_procedimento_w		varchar(1);
ie_material_w			varchar(1);
ie_item_repasse_w		varchar(1);
ds_tipo_repasse_w		varchar(255);
dt_inicial_repasse_w		timestamp;
dt_final_repasse_w		timestamp;
ie_tipo_convenio_w		integer;
ds_medicos_w			varchar(2000);
ds_medicos_not_w		varchar(1);
ds_proc_w			varchar(255);
ds_proc_not_w			varchar(1);
ie_vinc_rep_estorno_w		varchar(1);
cd_medico_terc_w		varchar(10);
ie_repasse_medico_w		varchar(1);
qt_w				double precision	:= 0;

ds_sql_w			varchar(4000)	:= '';
ds_from_w			varchar(4000)	:= '';
ds_sql_restricao_w		varchar(4000)	:= '';
ds_sql_filtro_w			varchar(4000)	:= '';

var_cur_w			integer;
var_exec_w			integer;
var_retorno_w			integer;

var_cur_dois_w			integer;
var_exec_dois_w			integer;
var_retorno_dois_w		integer;

c03 CURSOR FOR
SELECT	a.nr_sequencia
from 	repasse_terceiro_item a
where	a.dt_liberacao 		between dt_inicial_w and dt_final_w
and	a.nr_seq_terceiro		= nr_seq_terceiro_w
and	coalesce(a.nr_repasse_terceiro::text, '') = '';

c04 CURSOR FOR
SELECT	nr_sequencia,
	tx_repasse,
	nr_seq_terc_destino,
	nr_seq_trans_financ,
	coalesce(vl_repasse, 0),
	coalesce(ie_saldo, 'N'),
	coalesce(ie_valor, 'T')
from	terceiro_repasse
where	nr_seq_terceiro					= nr_seq_terceiro_w
and	ie_situacao					= 'A'
and	coalesce(ie_tipo_convenio, ie_tipo_convenio_regra_w)	= ie_tipo_convenio_regra_w
order 	by coalesce(ie_prioridade, 0);	


BEGIN

/* Francisco - OS 174252 - 28/10/2009 */

CALL liberar_repasse_regra(nr_repasse_terceiro_p,nm_usuario_p);

select	nr_seq_terceiro,
	cd_convenio,
	dt_periodo_inicial,
	dt_periodo_final,
	ie_tipo_data,
	cd_estabelecimento,
	dt_mesano_referencia,
	nr_seq_tipo,
	ie_tipo_convenio
into STRICT	nr_seq_terceiro_w,
	cd_convenio_w,
	dt_inicial_w,
	dt_final_w,
	ie_tipo_data_w,
	cd_estabelecimento_w,
	dt_mesano_referencia_w,
	nr_seq_tipo_w,
	ie_tipo_convenio_w
from	repasse_terceiro
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

select	max(coalesce(a.IE_GERAR_CONTA_REP_PF,'N'))
into STRICT	ie_repasse_medico_w
from	terceiro a
where	a.nr_sequencia	= nr_seq_terceiro_w;

select	coalesce(max(a.ie_procedimento),'S'),
	coalesce(max(a.ie_material),'S'),
	coalesce(max(a.ie_item_repasse),'S'),
	max(a.ds_tipo_repasse)
into STRICT	ie_procedimento_w,
	ie_material_w,
	ie_item_repasse_w,
	ds_tipo_repasse_w
from	tipo_repasse a
where	a.nr_sequencia	= nr_seq_tipo_w;

if (coalesce(ie_procedimento_w,'S') = 'N') and (coalesce(ie_material_w,'S') = 'N') and (coalesce(ie_item_repasse_w,'S') = 'N') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(205485, 'DS_TIPO_REPASSE_W='||ds_tipo_repasse_w);
end if;

ie_desconsiderar_glosados_w := obter_param_usuario(89, 67, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_desconsiderar_glosados_w);
ie_estorno_w := obter_param_usuario(89, 76, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_estorno_w);
ie_vinc_rep_estorno_w := obter_param_usuario(89, 137, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_vinc_rep_estorno_w);

/* Francisco - OS 71440 - 19/10/2007 */

select	coalesce(max(ie_excluir_rep_zerado),'N')
into STRICT	ie_excluir_rep_zerado_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ds_filtro_convenios_p IS NOT NULL AND ds_filtro_convenios_p::text <> '') then
	if (position('not' in ds_filtro_convenios_p) = 1) then
		ds_convenios_w := substr(ds_filtro_convenios_p, 4);
		ds_convenios_not_w := 'S';
	else
		ds_convenios_w := ds_filtro_convenios_p;
		ds_convenios_not_w := 'N';
	end if;
else
	ds_convenios_w := null;
	ds_convenios_not_w := null;	
end if;

if (ds_filtro_procedimentos_p IS NOT NULL AND ds_filtro_procedimentos_p::text <> '') then
	if (position('not' in ds_filtro_procedimentos_p) = 1) then
		ds_procedimentos_w := substr(ds_filtro_procedimentos_p, 4);
		ds_procedimentos_not_w := 'S';
	else
		ds_procedimentos_w := ds_filtro_procedimentos_p;
		ds_procedimentos_not_w := 'N';
	end if;
else
	ds_procedimentos_w := null;
	ds_procedimentos_not_w := null;
end if;

if (ds_filtro_medicos_p IS NOT NULL AND ds_filtro_medicos_p::text <> '') then
	if (position('not' in ds_filtro_medicos_p) = 1) then
		ds_medicos_w	:= substr(ds_filtro_medicos_p,4);
		ds_medicos_not_w	:= 'S';
	else
		ds_medicos_w	:= ds_filtro_medicos_p;
		ds_medicos_not_w	:= 'N';
	end if;
else
	ds_medicos_w		:= null;
	ds_medicos_not_w	:= null;
end if;

ds_medicos_w	:= trim(both replace(ds_medicos_w,chr(39),''));

if (ds_filtro_proc_p IS NOT NULL AND ds_filtro_proc_p::text <> '') then
	if (position('not' in ds_filtro_proc_p) = 1) then
		ds_proc_w	:= substr(ds_filtro_proc_p,4);
		ds_proc_not_w	:= 'S';
	else
		ds_proc_w	:= ds_filtro_proc_p;
		ds_proc_not_w	:= 'N';
	end if;
else
	ds_proc_w	:= null;
	ds_proc_not_w	:= null;
end if;

/* Cursor Dinamico C01 OS Performace - jjweege OS 710839 -- 19/03/2014
O cursor original da procedure foi substituido por um tratamento dinamico para melhoria da performance */
if (coalesce(ie_repasse_medico_w,'N') = 'N') then

	if (coalesce(ie_procedimento_w,'S')	= 'S') then
	
		ds_sql_w		:= 	'select	a.nr_sequencia ';
		ds_from_w		:= 	'from	convenio_retorno i, ' 		||
						'	convenio_retorno_item h, '	||
						'	estrutura_procedimento_v g, ' 	||
						'	procedimento f, ' 		||
						'	atendimento_paciente e, ' 	||
						'	convenio d, ' 			||
						'	Conta_paciente c, ' 		||
						'	procedimento_paciente b, ' 	||
						'	procedimento_repasse a ';
								
		ds_sql_restricao_w	:= 	'where	1 = 1 ' ||
						'and	h.nr_seq_retorno				= i.nr_sequencia(+) ' ||
						'and	a.nr_seq_item_retorno				= h.nr_sequencia(+) ' ||
						'and	nvl(c.nr_seq_protocolo,0)			= nvl(:nr_seq_protocolo,nvl(c.nr_seq_protocolo,0)) ' ||
						'and	a.nr_seq_procedimento   			= b.nr_sequencia ' ||
						'and 	b.nr_interno_conta      			= c.nr_interno_conta ' ||
						'and	d.cd_convenio					= c.cd_convenio_parametro ' ||
						'and	nvl(:ie_tipo_convenio, d.ie_tipo_convenio)	= d.ie_tipo_convenio ' ||
						'and	nvl(:cd_convenio, c.cd_convenio_parametro)	= c.cd_convenio_parametro ' ||
						'and	f.cd_procedimento				= g.cd_procedimento ' ||
						'and	f.ie_origem_proced				= g.ie_origem_proced ' ||
						'and	a.ie_status					in (decode(nvl(:ie_desconsiderar_glosados, ' 	|| chr(39) || 'S' || chr(39)  || '),'  || chr(39) || 'S' || chr(39) || ','
																			|| chr(39) || 'G' || chr(39) || ',' || chr(39) || 'X' || chr(39) || '),' 
																			|| chr(39) || 'L' || chr(39) || ',' || chr(39) || 'S' || chr(39) || ',' 
																			|| chr(39) || 'R' || chr(39) || ',decode(:ie_gerar_estornados, ' 
																			|| chr(39) || 'S' || chr(39) || ','|| chr(39) || 'E' || chr(39) || ', null)) ' ||
						'and	substr(obter_se_gerar_repasse(:nr_repasse_terceiro,a.nr_sequencia,null),1,1)	= ' || chr(39) || 'S'  || chr(39) ||
						'and	a.nr_seq_terceiro				= :nr_seq_terceiro '||
						'and	a.nr_repasse_terceiro				is null ' ||
						'and	(:ie_estorno = ' || chr(39) || 'S' || chr(39) || ' or nvl(a.ie_estorno,' || chr(39) || 'N' || chr(39) || ') = ' || chr(39) || 'N' || chr(39) ||  ') ' || 
						'and	c.nr_atendimento				= e.nr_atendimento ' ||
						'and	e.ie_tipo_atendimento				= nvl(:ie_tipo_atendimento,e.ie_tipo_atendimento) ' ||
						'and	f.cd_procedimento 				= b.cd_procedimento ' ||
						'and	f.ie_origem_proced 				= b.ie_origem_proced ';
						
		ds_sql_filtro_w		:= 	'';

		if (ie_tipo_data_w = 0) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(a.dt_liberacao,a.dt_atualizacao) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 1) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and c.dt_mesano_referencia between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 2) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and b.dt_procedimento between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 3) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(i.dt_fechamento,to_date(' || chr(39) || '01/01/2099' || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w	= 4) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(obter_dt_emissao_nf(b.nr_interno_conta),to_date(nvl(obter_dados_nota_fiscal(obter_nf_conta_geral(b.nr_interno_conta),9),'|| chr(39) || '01/01/2099' || chr(39) || '))) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 5) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and to_date(nvl(obter_dados_laudo_procedimento(b.nr_sequencia,' || chr(39) || 'DL' || chr(39) || '),' || chr(39) || '01/01/2099 00:00:00' || chr(39) || '),' || chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ') between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 6) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(a.dt_entrega_convenio, obter_dados_protocolo_dt(c.nr_seq_protocolo,' || chr(39) ||  'DEN' || chr(39) || ')) between :dt_inicial and :dt_final ';
		end if;

		if ((ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') and ds_convenios_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and ('|| chr(39) || ',' || chr(39) ||  '|| :ds_convenios ||' || chr(39) || ',' ||  chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(c.cd_convenio_parametro)||' || chr(39) || ',%' ||chr(39) || ') ';
		elsif ((ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') and ds_convenios_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '|| :ds_convenios ||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(c.cd_convenio_parametro)||' || chr(39) || ',%' ||chr(39) || ') ';
		end if;

		if ((ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') and ds_procedimentos_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (' || chr(39) || ',' || chr(39) || '|| :ds_procedimentos ||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(f.cd_tipo_procedimento)||' || chr(39) || ',%' ||chr(39) || ') ';
		elsif ((ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') and ds_procedimentos_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '|| :ds_procedimentos ||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(f.cd_tipo_procedimento)||' || chr(39) || ',%' || chr(39) || ') ';
		end if;

		if ((ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') and ds_medicos_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (' || chr(39) || ',' || chr(39) || '|| :ds_medicos ||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(a.cd_medico)||' || chr(39) || ',%' || chr(39) || ') ';
		elsif ((ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') and ds_medicos_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '|| :ds_medicos ||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(a.cd_medico)||' || chr(39) || ',%' || chr(39) || ') ';
		end if;
		
		if ((ds_proc_w IS NOT NULL AND ds_proc_w::text <> '') and ds_proc_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (' || chr(39) || ',' || chr(39) || '||:ds_proc||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(b.cd_procedimento)||' || chr(39) || ',%' || chr(39) || ') ';
		elsif ((ds_proc_w IS NOT NULL AND ds_proc_w::text <> '') and ds_proc_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '||:ds_proc||' || chr(39) || ',' || chr(39) || 'like' || chr(39) || '%,' || chr(39) || '||to_char(b.cd_procedimento)||' || chr(39) || ',%' || chr(39) || ') ';
		end if;

		if (cd_area_proc_p IS NOT NULL AND cd_area_proc_p::text <> '') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and g.cd_area_procedimento = :cd_area_proc ';
		end if;
			
		if (cd_espec_proc_p IS NOT NULL AND cd_espec_proc_p::text <> '') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and g.cd_especialidade = :cd_espec_proc ';
		end if;
			
		if (cd_grupo_proc_p IS NOT NULL AND cd_grupo_proc_p::text <> '') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and g.cd_grupo_proc = :cd_grupo_proc ';
		end if;

		if (coalesce(ie_gerar_rep_perc_saldo_p, 'S') = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and substr(OBTER_DADOS_FORMA_REPASSE(a.cd_regra, a.nr_seq_regra_item, ' || chr(39) || 'S' || chr(39) || '),1,255) <> ' || chr(39) || 'S ' || chr(39);
		end if;

		if (coalesce(ie_valor_lib_zerado_p,'S') = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and a.vl_liberado <> 0 ';
		end if;
			
		if (coalesce(ie_vinc_rep_estorno_w,'S')	= 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (((a.ie_status <> ' || chr(39) || 'E' || chr(39) || ' and c.ie_status_acerto = 2) or c.ie_status_acerto = 2) and ' ||
																	'not exists ' ||
																	'(select	1 ' ||
																	'from	procedimento_repasse x ' ||
																	'where	x.nr_seq_origem = b.nr_sequencia ' ||
																	'and	x.ie_status	= ' || chr(39) || 'A' || chr(39) || ')) ';
		end if;
			
		ds_sql_w	:=	ds_sql_w ||
					ds_from_w ||
					ds_sql_restricao_w ||
					ds_sql_filtro_w;

		--Abrir o cursor Dinamico  C01-- OS Performace - jjweege OS 710839 -- 19/03/2014			
		var_cur_w	:=	dbms_sql.open_cursor;
		dbms_sql.parse(var_cur_w,  ds_sql_w, 1);
		
		dbms_sql.bind_variable(var_cur_w, ':nr_seq_protocolo', nr_seq_protocolo_p);
		dbms_sql.bind_variable(var_cur_w, ':ie_tipo_convenio', ie_tipo_convenio_p);
		dbms_sql.bind_variable(var_cur_w, ':cd_convenio' ,cd_convenio_w);
		dbms_sql.bind_variable(var_cur_w, ':ie_desconsiderar_glosados' , ie_desconsiderar_glosados_w);
		dbms_sql.bind_variable(var_cur_w, ':ie_gerar_estornados', ie_gerar_estornados_p);
		dbms_sql.bind_variable(var_cur_w, ':nr_repasse_terceiro', nr_repasse_terceiro_p);
		dbms_sql.bind_variable(var_cur_w, ':nr_seq_terceiro', nr_seq_terceiro_w);
		dbms_sql.bind_variable(var_cur_w, ':ie_estorno', ie_estorno_w);
		dbms_sql.bind_variable(var_cur_w, ':ie_tipo_atendimento', ie_tipo_atendimento_p);
		
		if (ie_tipo_data_w <> 7) then
			dbms_sql.bind_variable(var_cur_w, ':dt_inicial', dt_inicial_w);
			dbms_sql.bind_variable(var_cur_w, ':dt_final', dt_final_w);
		end if;
		
		if (ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':ds_convenios', ds_convenios_w);
		end if;
		
		if (ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':ds_procedimentos', ds_procedimentos_w);
		end if;
		
		if (ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':ds_medicos', ds_medicos_w);
		end if;
		
		if (ds_proc_w IS NOT NULL AND ds_proc_w::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':ds_proc', ds_proc_w);
		end if;
		
		if (cd_area_proc_p IS NOT NULL AND cd_area_proc_p::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':cd_area_proc', cd_area_proc_p);
		end if;
		
		if (cd_espec_proc_p IS NOT NULL AND cd_espec_proc_p::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':cd_espec_proc', cd_espec_proc_p);
		end if;
		
		if (cd_grupo_proc_p IS NOT NULL AND cd_grupo_proc_p::text <> '') then
			dbms_sql.bind_variable(var_cur_w, ':cd_grupo_proc', cd_grupo_proc_p);
		end if;
		
		dbms_sql.define_column(var_cur_w, 1, nr_sequencia_w);
		var_exec_w := dbms_sql.execute(var_cur_w);
		
		loop
		var_retorno_w := dbms_sql.fetch_rows(var_cur_w);
		exit when var_retorno_w = 0;
		
			dbms_sql.column_value(var_cur_w, 1, nr_sequencia_w);
			
			update	procedimento_repasse
			set	nr_repasse_terceiro	= nr_repasse_terceiro_p
			where	nr_sequencia		= nr_sequencia_w;
			
		end loop;
		dbms_sql.close_cursor(var_cur_w);--Fechar o cursor Dinamico  C01 OS Performace - jjweege OS 710839 -- 19/03/2014
	end if;	

	--Cursor Dinamico C02
	if (coalesce(ie_material_w,'S')	 = 'S') then
	
		ds_sql_w		:=	'select	a.nr_sequencia ';

		ds_from_w		:=	'from   atendimento_paciente e, ' ||
						'	convenio d, '||
						'	Conta_paciente c, ' ||
						'	Material_atend_paciente b, '||
						'	material_repasse a ';

		ds_sql_restricao_w	:= 	'where	1 = 1 ' ||
						'and	nvl(c.nr_seq_protocolo,0)	= nvl(:nr_seq_protocolo,nvl(c.nr_seq_protocolo,0)) ' ||
						'and	a.nr_seq_material		= b.nr_sequencia '||
						'and	b.nr_interno_conta		= c.nr_interno_conta '||
						'and	c.cd_convenio_parametro		= nvl(:cd_convenio, c.cd_convenio_parametro) '||
						'and	d.cd_convenio			= c.cd_convenio_parametro '||
						'and	d.ie_tipo_convenio		= nvl(:ie_tipo_convenio, d.ie_tipo_convenio) ' ||	
						'and	a.ie_status			in (decode(nvl(:ie_desconsiderar_glosados,' || chr(39) || 'S' || chr(39) || '),' || chr(39) || 'S' || chr(39) ||
											',' || chr(39) || 'G' || chr(39) || ',' || chr(39) || 'X' || chr(39) || '),' || chr(39) || 'L'  || chr(39) ||
											',' || chr(39) || 'S' || chr(39) || ',' || chr(39) || 'R' || chr(39) || ', decode(:ie_gerar_estornados, ' || chr(39) || 'S' || chr(39) ||
											', ' || chr(39) || 'E' || chr(39) || ', null)) ' ||
						'and	substr(obter_se_gerar_repasse(:nr_repasse_terceiro, null, a.nr_sequencia),1,255)	= ' || chr(39) || 'S' || chr(39) ||
						'and	a.nr_seq_terceiro		= :nr_seq_terceiro ' ||
						'and	a.nr_repasse_terceiro   	is null ' ||
						'and	c.nr_atendimento		= e.nr_atendimento ' ||
						'and	e.ie_tipo_atendimento		= nvl(:ie_tipo_atendimento,e.ie_tipo_atendimento) ' ||
						'and	((nvl(a.ie_estorno,' || chr(39) || 'N' || chr(39) || ') = ' || chr(39) || 'N' || chr(39) || ') or (:ie_estorno = ' || chr(39) || 'S' || chr(39) || ')) ';
						
		ds_sql_filtro_w		:= 	'';
		
		if (ie_tipo_data_w = 0) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(a.dt_liberacao, a.dt_atualizacao) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 1) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and c.dt_mesano_referencia between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 2) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and b.dt_atendimento	between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 3) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and to_date(nvl(obter_dados_ret_convenio(a.nr_seq_item_retorno, 2),' || chr(39) || '01/01/2099' || chr(39) || ')) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w	= 4) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(obter_dt_emissao_nf(b.nr_interno_conta),to_date(nvl(obter_dados_nota_fiscal(nvl(obter_nf_conta(b.nr_interno_conta,8), nvl(obter_nf_conta(b.nr_interno_conta,1), obter_nf_conta(b.nr_interno_conta,4))),9),' || chr(39) || '01/01/2099' || chr(39) || '))) between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 5) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and to_date(nvl(obter_dados_laudo_procedimento(b.nr_sequencia,' || chr(39) || 'DL' || chr(39) || '),' || chr(39) || '01/01/2099 00:00:00' || chr(39) || '),' || chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ') between :dt_inicial and :dt_final ';
		elsif (ie_tipo_data_w = 6) then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and nvl(a.dt_entrega_convenio, obter_dados_protocolo_dt(c.nr_seq_protocolo,' || chr(39) ||  'DEN' || chr(39) || ')) between :dt_inicial and :dt_final ';
		end if;
		
			
		if (coalesce(ie_gerar_rep_perc_saldo_p, 'S') = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (substr(OBTER_DADOS_FORMA_REPASSE(a.cd_regra, a.nr_seq_regra_item, ' || chr(39) || 'S' || chr(39) || '),1,255) <> ' || chr(39) || 'S' || chr(39) || ') ';
		end if;
			
		if (coalesce(ie_valor_lib_zerado_p,'S') = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and a.vl_liberado <> 0 ';
		end if;
			
		if (coalesce(ie_vinc_rep_estorno_w,'S') = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (((a.ie_status <> ' || chr(39) || 'E' || chr(39) || ' and c.ie_status_acerto = 2) or c.ie_status_acerto = 2) and ' ||
																			'not exists ' ||
																			'(select	1 ' ||
																			'from	material_repasse x ' ||
																			'where	x.nr_seq_origem = b.nr_sequencia ' ||
																			'and	x.ie_status	= ' || chr(39) || 'A' || chr(39) || ')) ';
		end if;
																			
		
		if ((ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') and ds_convenios_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (' || chr(39) || ',' || chr(39) || '|| :ds_convenios ||' || chr(39) || ',' || chr(39) || ' like ' || chr(39) || '%,' || chr(39) || '||to_char(c.cd_convenio_parametro)||' || chr(39) || ',%' || chr(39) || ') ';
		elsif ((ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') and ds_convenios_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '|| :ds_convenios ||' || chr(39) || ',' || chr(39) || ' like ' || chr(39) || ' ' || chr(39) ||  '||' || chr(39) ||  '%,' || chr(39) || '||to_char(c.cd_convenio_parametro)||' || chr(39) || ',%'  || chr(39) || '||' || chr(39) || ' ' || chr(39) || ') ';
		end if;
			
		if ((ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') and ds_medicos_not_w = 'N') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and (' || chr(39) || ',' || chr(39) || '|| :ds_medicos ||' || chr(39) || ',' || chr(39) || ' like ' || chr(39) || '%,' || chr(39) || '||to_char(a.cd_medico)||' || chr(39) || ',%' || chr(39) || ') ';
		elsif ((ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') and ds_medicos_not_w = 'S') then
			ds_sql_filtro_w := ds_sql_filtro_w || 'and not (' || chr(39) || ',' || chr(39) || '|| :ds_medicos ||' || chr(39) || ',' || chr(39) || ' like ' || chr(39) || '%,' || chr(39) || '||to_char(a.cd_medico)||' || chr(39) || ',%' || chr(39) || ') ';
		end if;
		
		
		ds_sql_w	:=	ds_sql_w ||
					ds_from_w ||
					ds_sql_restricao_w ||
					ds_sql_filtro_w;
		
		--Abrir o cursor Dinamico  C02-- OS Performace - jjweege OS 710839 -- 19/03/2014	
		var_cur_dois_w	:=	dbms_sql.open_cursor;
		dbms_sql.parse(var_cur_dois_w,  ds_sql_w, 1);
		
		dbms_sql.bind_variable(var_cur_dois_w, ':nr_seq_protocolo', nr_seq_protocolo_p);
		dbms_sql.bind_variable(var_cur_dois_w, ':cd_convenio' ,cd_convenio_w);
		dbms_sql.bind_variable(var_cur_dois_w, ':ie_tipo_convenio', ie_tipo_convenio_p);
		dbms_sql.bind_variable(var_cur_dois_w, ':ie_desconsiderar_glosados' , ie_desconsiderar_glosados_w);
		dbms_sql.bind_variable(var_cur_dois_w, ':ie_gerar_estornados', ie_gerar_estornados_p);
		dbms_sql.bind_variable(var_cur_dois_w, ':nr_repasse_terceiro', nr_repasse_terceiro_p);
		dbms_sql.bind_variable(var_cur_dois_w, ':nr_seq_terceiro', nr_seq_terceiro_w);
		dbms_sql.bind_variable(var_cur_dois_w, ':ie_tipo_atendimento', ie_tipo_atendimento_p);
		dbms_sql.bind_variable(var_cur_dois_w, ':ie_estorno', ie_estorno_w);
		
		if (ie_tipo_data_w <> 7) then
			dbms_sql.bind_variable(var_cur_dois_w, ':dt_inicial', dt_inicial_w);
			dbms_sql.bind_variable(var_cur_dois_w, ':dt_final', dt_final_w);
		end if;
		
		if (ds_convenios_w IS NOT NULL AND ds_convenios_w::text <> '') then
			dbms_sql.bind_variable(var_cur_dois_w, ':ds_convenios', ds_convenios_w);
		end if;
		
		if (ds_medicos_w IS NOT NULL AND ds_medicos_w::text <> '') then
			dbms_sql.bind_variable(var_cur_dois_w, ':ds_medicos', ds_medicos_w);
		end if;
		
		dbms_sql.define_column(var_cur_dois_w, 1, nr_sequencia_w);
		var_exec_dois_w := dbms_sql.execute(var_cur_dois_w);
		
		loop
		var_retorno_dois_w := dbms_sql.fetch_rows(var_cur_dois_w);
		exit when var_retorno_dois_w = 0;
		
			dbms_sql.column_value(var_cur_dois_w, 1, nr_sequencia_w);
			
			update	material_repasse
			set	nr_repasse_terceiro	= nr_repasse_terceiro_p
			where	nr_sequencia 		= nr_sequencia_w;
			
		end loop;
		dbms_sql.close_cursor(var_cur_dois_w);--Fechar o cursor Dinamico  C02 OS Performace - jjweege OS 710839 -- 19/03/2014	
	end if;	

	if (coalesce(ie_item_repasse_w,'S')	= 'S') then
		
		open c03;
		loop
		fetch c03 into
			nr_seq_repasse_item_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */

			begin
			select 	coalesce(max(nr_sequencia_item), 0) +1
			into STRICT	nr_sequencia_item_w
			from 	repasse_terceiro_item
			where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

			update	repasse_terceiro_item
			set	nr_repasse_terceiro	= nr_repasse_terceiro_p,
				nr_sequencia_item	= nr_sequencia_item_w
			where	nr_sequencia 		= nr_seq_repasse_item_w;
			exception
			when unique_violation then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191472, 'NR_REPASSE_TERCEIRO_P = ' || nr_repasse_terceiro_p ||
										';NR_SEQUENCIA_ITEM_W = ' || nr_sequencia_item_w ||
										';NR_SEQ_REPASSE_ITEM_W = ' ||  nr_seq_repasse_item_w ||
										';SQLERRM = ' || sqlerrm);
			end;

		end loop;
		close c03;
	end if;	

	vl_repasse_w		:= coalesce(obter_valor_repasse(nr_repasse_terceiro_p, 'R'),0);
	vl_saldo_repasse_w	:= coalesce(obter_valor_repasse(nr_repasse_terceiro_p, 'R'),0);



	select	coalesce(sum(a.vl_repasse),0)
	into STRICT	vl_repasse_proc_w
	from	convenio d,
		conta_paciente c,
		procedimento_paciente b,
		procedimento_repasse a
	where	a.nr_repasse_terceiro	= nr_repasse_terceiro_p
	and	a.nr_seq_procedimento	= b.nr_sequencia
	and	b.nr_interno_conta	= c.nr_interno_conta
	and	c.cd_convenio_parametro	= d.cd_convenio
	and	d.ie_tipo_convenio	= 2;

	select	coalesce(sum(a.vl_repasse),0)
	into STRICT	vl_repasse_mat_w
	from	convenio d,
		conta_paciente c,
		material_atend_paciente b,
		material_repasse a
	where	a.nr_repasse_terceiro	= nr_repasse_terceiro_p
	and	a.nr_seq_material	= b.nr_sequencia
	and	b.nr_interno_conta	= c.nr_interno_conta
	and	c.cd_convenio_parametro	= d.cd_convenio
	and	d.ie_tipo_convenio	= 2;

	select	coalesce(sum(vl_repasse),0)
	into STRICT	vl_repasse_regra_w
	from	repasse_terceiro_item a
	where	nr_repasse_terceiro     = nr_repasse_terceiro_p
	and	(nr_seq_regra_esp IS NOT NULL AND nr_seq_regra_esp::text <> '');

	select	coalesce(max(ie_tipo_convenio),0)
	into STRICT	ie_tipo_convenio_regra_w
	from	REPASSE_TERCEIRO_REGRA
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

	if (coalesce(ie_item_repasse_w,'S') = 'S') then

		dt_inicial_repasse_w	:= trunc(dt_mesano_referencia_w,'month');
		dt_final_repasse_w	:= fim_dia(fim_mes(dt_mesano_referencia_w));
		
		open c04;
		loop
		fetch c04 into
			nr_seq_terc_rep_w,
			tx_repasse_w,
			nr_seq_terc_destino_w,
			nr_seq_trans_financ_w,
			vl_repassar_w,
			ie_saldo_w,
			ie_valor_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */

			if (ie_valor_w = 'PMC') then
				--vl_repassar_w	:= vl_repasse_mat_w + vl_repasse_proc_w;
				if (vl_repassar_w = 0) then
					vl_repasse_ie_valor_w	:= coalesce(obter_valor_repasse(nr_repasse_terceiro_p, 'RPM'),0);--vl_repasse_mat_w + vl_repasse_proc_w;
				end if;		
			elsif (ie_valor_w = 'R') then
				--vl_repassar_w	:= vl_repasse_regra_w;
				if (vl_repassar_w = 0) then
					vl_repasse_ie_valor_w	:= coalesce(obter_valor_repasse(nr_repasse_terceiro_p, 'RI'),0);--vl_repasse_regra_w;
				end if;
			end if;

			select	count(*)
			into STRICT	cont_w
			from	repasse_terceiro_item b,
				repasse_terceiro a
			where	a.nr_repasse_terceiro			= b.nr_repasse_terceiro
			and	a.dt_mesano_referencia			between dt_inicial_repasse_w and dt_final_repasse_w
			and	a.nr_seq_terceiro			= nr_seq_terc_destino_w
			and	b.nr_seq_terc_rep			= nr_seq_terc_rep_w;

			if (cont_w = 0) then

				nr_repasse_terceiro_dest_w := OBTER_REPASSE_TERCEIRO(dt_mesano_referencia_w, nr_seq_terc_destino_w, nm_usuario_p, null, 'I', nr_repasse_terceiro_dest_w, cd_estabelecimento_w, ie_tipo_convenio_w);

				if (coalesce(nr_repasse_terceiro_dest_w,0) > 0) then


					if (ie_saldo_w = 'N') then
						if (vl_repassar_w <> 0) then
							vl_item_w	:= vl_repassar_w;
						else
							vl_item_w	:= (dividir_sem_round((tx_repasse_w)::numeric, 100) * vl_repasse_ie_valor_w); -- vl_repasse_w
						end if;
					elsif (ie_saldo_w = 'S') then
						vl_item_w	:= (dividir_sem_round((tx_repasse_w)::numeric, 100) * vl_saldo_repasse_w);
					end if;

					vl_saldo_repasse_w	:= vl_saldo_repasse_w - vl_item_w;

					/* Gerar valor negativo do repasse origem */

					select	coalesce(max(nr_sequencia_item),0) + 1
					into STRICT	nr_sequencia_item_w
					from	repasse_terceiro_item
					where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

					insert	into repasse_terceiro_item(nr_repasse_terceiro,
						nr_sequencia_item,
						vl_repasse,
						dt_atualizacao,
						nm_usuario,
						nr_lote_contabil,
						ds_observacao,
						nr_seq_trans_fin,
						dt_lancamento,
						nr_seq_terceiro,
						nr_sequencia,
						nr_seq_terc_rep,
						ie_partic_tributo)
					SELECT	nr_repasse_terceiro_p,
						nr_sequencia_item_w,
						coalesce(vl_item_w,0) * -1,
						clock_timestamp(),
						nm_usuario_p,
						0,
						wheb_mensagem_pck.get_texto(802697,'NM_TERCEIRO=' || obter_nome_terceiro(nr_seq_terceiro_w)),
						nr_seq_trans_financ_w,
						clock_timestamp(),
						nr_seq_terceiro_w,
						nextval('repasse_terceiro_item_seq'),
						nr_seq_terc_rep_w,
						'S'
					;

					/* Gerar valor do repasse destino */

					select	coalesce(max(nr_sequencia_item),0) + 1
					into STRICT	nr_sequencia_item_w
					from	repasse_terceiro_item
					where	nr_repasse_terceiro	= nr_repasse_terceiro_dest_w;

					insert	into repasse_terceiro_item(nr_repasse_terceiro,
						nr_sequencia_item,
						vl_repasse,
						dt_atualizacao,
						nm_usuario,
						nr_lote_contabil,
						ds_observacao,
						nr_seq_trans_fin,
						dt_lancamento,
						nr_seq_terceiro,
						nr_sequencia,
						nr_seq_terc_rep,
						ie_partic_tributo)
					SELECT	nr_repasse_terceiro_dest_w,
						nr_sequencia_item_w,
						coalesce(vl_item_w,0),
						clock_timestamp(),
						nm_usuario_p,
						0,
						wheb_mensagem_pck.get_texto(802697,'NM_TERCEIRO=' || obter_nome_terceiro(nr_seq_terceiro_w)),
						nr_seq_trans_financ_w,
						clock_timestamp(),
						nr_seq_terc_destino_w,
						nextval('repasse_terceiro_item_seq'),
						nr_seq_terc_rep_w,
						'S'
					;
				end if;
			end if;

		end loop;
		close c04;
	end if;	

	ie_calcular_item_w := obter_param_usuario(89, 57, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_calcular_item_w);

	if (ie_calcular_item_w = 'G') and (coalesce(ie_item_repasse_w,'S') = 'S') then
		CALL calcular_item_repasse(nr_repasse_terceiro_p,nm_usuario_p);
	end if;

	select	count(*)
	into STRICT	qt_reg_proc_w
	from	procedimento_repasse
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

	select	count(*)
	into STRICT	qt_reg_mat_w
	from	material_repasse
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

	select	count(*)
	into STRICT	qt_reg_item_w
	from	repasse_terceiro_item
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

	if (qt_reg_proc_w = 0) and (qt_reg_mat_w = 0) and (qt_reg_item_w = 0) and (ie_excluir_rep_zerado_w = 'S') then
		delete	from repasse_terceiro
		where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
	end if;
else
	CALL gerar_conta_repasse_medico(nr_repasse_terceiro_p,ie_tipo_convenio_p,nm_usuario_p,ie_gerar_estornados_p,ie_gerar_rep_perc_saldo_p,ie_valor_lib_zerado_p,nr_seq_protocolo_p,ie_tipo_atendimento_p,ds_filtro_convenios_p,ds_filtro_procedimentos_p,cd_grupo_proc_p,cd_espec_proc_p,cd_grupo_proc_p,ds_filtro_medicos_p,ds_filtro_proc_p,ds_observacao_p);
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conta_repasse ( nr_repasse_terceiro_p bigint, ie_tipo_convenio_p bigint, nm_usuario_p text, ie_gerar_estornados_p text, ie_gerar_rep_perc_saldo_p text, ie_valor_lib_zerado_p text, nr_seq_protocolo_p bigint, ie_tipo_atendimento_p bigint, ds_filtro_convenios_p text, ds_filtro_procedimentos_p text, cd_area_proc_p bigint, cd_espec_proc_p bigint, cd_grupo_proc_p bigint, ds_filtro_medicos_p text, ds_filtro_proc_p text, ds_observacao_p text default null) FROM PUBLIC;

