-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_colombia_bisa ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* VERSION 001 DE NOV-2020 */

ie_situacao_w 		varchar(1)	:= 'A';
ie_separator_w		varchar(1)	:= '#';
ds_invalids_w		varchar(9)	:= '()=!/:,-.';
nr_seq_apres_w		bigint	:= 1;
ds_conteudo_w		varchar(306);

/* FILE DETAILS */

cd_estabelecimento_w	varchar(4);
importe_w   		varchar(17);
tipo_pago_w     	varchar(1);
nota_w          	varchar(40);
correo_electronico_w	varchar(40);
codigo_w        	varchar(20);
cuenta_w 		varchar(20);
nombre_completo_w      	varchar(60);
suc_destino_w 		varchar(3);
banco_destino_w 	varchar(4);
tipo_cuenta_w 		varchar(1);
tipo_persona_w 		varchar(1);
tipo_doc_w 		varchar(3);
nro_doc_w 		varchar(20);
forma_entrega_w 	varchar(40);
telefono_w 		varchar(20);
flag_empleado_w		varchar(1);

c01 CURSOR FOR
SELECT
    substr(to_char(coalesce(b.CD_ESTABELECIMENTO,0)),1,4) ESTABELECIMENTO,
	substr(to_char(coalesce(c.vl_escritural,0)),1,17) IMPORTE,
	substr(coalesce(c.IE_TIPO_SERVICO,0),1,1) TIPO_PAGO,
	substr(d.DS_OBSERVACAO_TITULO,1,40) NOTA,
	NULL CORREO_ELECTRONICO,
	substr(coalesce(a.CD_CONTA,'0'),1,20) CODIGO,
	substr(coalesce(a.CD_CONTA,'0'),1,20) CUENTA,
	substr(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.DS_RAZAO_SOCIAL  ELSE g.NM_PESSOA_FISICA END ,1,60) NOMBRE_COMPLETO,
	substr(e.CD_AGENCIA_BANCARIA,1,3) SUC_DESTINO,
	substr(to_char(e.CD_BANCO),1,4)  BANCO_DESTINO,
	substr((CASE
           WHEN c.IE_TIPO_SERVICO = '00004'
           THEN e.CD_CODIGO_IDENTIFICACAO 
           ELSE NULL
        END),1,1) TIPO_CUENTA,
        CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  'J'  ELSE 'N' END  TIPO_PESSOA,
	CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  'NIT'  ELSE 'RUI' END  TIPO_DOC,
	substr(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.CD_CGC  ELSE g.NR_CPF END ,1,20) NRO_DOC,
        substr((CASE
           WHEN c.IE_TIPO_SERVICO = '00002'
           THEN CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.DS_RAZAO_SOCIAL  ELSE g.NM_PESSOA_FISICA END  
           ELSE NULL
        END),1,40) FORMA_ENTREGA,
	substr(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.NR_TELEFONE  ELSE g.NR_TELEFONE_CELULAR END ,1,20) TELEFONO,
	NULL FLAG_EMPLEADO
FROM titulo_pagar_escrit c, banco_escritural b, banco_estabelecimento a, titulo_pagar d
LEFT OUTER JOIN titulo_pagar_favorecido e ON (d.nr_titulo = e.nr_titulo)
LEFT OUTER JOIN pessoa_juridica i ON (d.cd_cgc = i.cd_cgc)
LEFT OUTER JOIN pessoa_fisica g ON (e.cd_pessoa_fisica = g.cd_pessoa_fisica)
LEFT OUTER JOIN compl_pessoa_fisica h ON (g.cd_pessoa_fisica = h.cd_pessoa_fisica)
WHERE a.nr_sequencia = b.nr_seq_conta_banco and (b.cd_estabelecimento = a.cd_estabelecimento or obter_estab_financeiro(b.cd_estabelecimento) = a.cd_estabelecimento) and b.nr_sequencia = c.nr_seq_escrit and c.nr_titulo = d.nr_titulo     and d.ie_situacao = ie_situacao_w and b.nr_sequencia = nr_seq_envio_p;


BEGIN
/*  DELETE EXISTING RECORDS */

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;
/* MOUNT FILE DETAILS */

OPEN c01;
LOOP
FETCH c01 INTO
	cd_estabelecimento_w,
	importe_w,
	tipo_pago_w,
	nota_w,
	correo_electronico_w,
	codigo_w,
	cuenta_w,
	nombre_completo_w,
	suc_destino_w,
	banco_destino_w,
	tipo_cuenta_w,
	tipo_persona_w,
	tipo_doc_w,
	nro_doc_w,
	forma_entrega_w,
	telefono_w,
	flag_empleado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	nr_seq_apres_w := 	coalesce(nr_seq_apres_w, 0) + 1;

	ds_conteudo_w	:=	lpad(somente_numero(importe_w),17,' ')	 			||
				ie_separator_w							||
				lpad(tipo_pago_w,1,' ') 					||
				ie_separator_w							||
				lpad(elimina_caracteres_especiais_d(elimina_acentuacao(coalesce(nota_w,' ')), ds_invalids_w),40,' ') 		||
				ie_separator_w							||
				lpad(coalesce(correo_electronico_w,' '),40,' ')			||
				ie_separator_w							||
				lpad(codigo_w,20,' ')						||
				ie_separator_w							||
				lpad(cuenta_w,20,' ')						||
				ie_separator_w							||
				lpad(elimina_caracteres_especiais_d(elimina_acentuacao(coalesce(nombre_completo_w,' ')), ds_invalids_w),60,' ')	||
				ie_separator_w							||
				lpad(coalesce(suc_destino_w,' '),3,' ')				||
				ie_separator_w							||
				lpad(coalesce(banco_destino_w,' '),4,' ')				||
				ie_separator_w							||
				lpad(coalesce(tipo_cuenta_w,' '),1,' ')				||
				ie_separator_w							||
				lpad(tipo_persona_w,1,' ')					||
				ie_separator_w							||
				lpad(tipo_doc_w,3,' ')						||
				ie_separator_w							||
				lpad(nro_doc_w,20,' ') 						||
				ie_separator_w							||
				lpad(elimina_caracteres_especiais_d(elimina_acentuacao(coalesce(forma_entrega_w,' ')), ds_invalids_w),40,' ')	||
				ie_separator_w							||
				lpad(telefono_w,20,' ') 					||
				ie_separator_w							||
				lpad(coalesce(flag_empleado_w,' '),1,' ');

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

END LOOP;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_colombia_bisa ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

