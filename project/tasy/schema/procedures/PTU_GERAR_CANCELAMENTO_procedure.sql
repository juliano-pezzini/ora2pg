-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_cancelamento ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_complemento_p bigint, nr_seq_execucao_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


cd_unimed_executora_w		smallint;
cd_unimed_beneficiario_w	smallint;
nr_seq_origem_w			bigint;
ie_tipo_cliente_w		varchar(2);
qt_registros_w			smallint;
nr_seq_resposta_w		bigint;
nr_seq_complemento_w		bigint;
nr_seq_cancelamento_w		bigint;
ie_existe_trans_w		varchar(2) := 'N';


BEGIN

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	begin
	select	a.nr_sequencia
	into STRICT	nr_seq_execucao_p
	from	ptu_pedido_autorizacao		b,
		ptu_controle_execucao		a
	where	a.nr_seq_pedido_aut		= b.nr_sequencia
	and	b.nr_seq_guia			= nr_seq_guia_p;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(179724);
	end;

	begin
	select	nr_sequencia
	into STRICT	nr_seq_cancelamento_w
	from	ptu_cancelamento
	where	nr_seq_execucao	= nr_seq_execucao_p;
	exception
	when others then
		nr_seq_cancelamento_w	:= 0;
	end;

	if (nr_seq_cancelamento_w	<> 0) then
		goto final;
	end if;

	begin
	select	cd_unimed_executora,
		cd_unimed_beneficiario,
		nr_seq_origem,
		ie_tipo_cliente
	into STRICT	cd_unimed_executora_w,
		cd_unimed_beneficiario_w,
		nr_seq_origem_w,
		ie_tipo_cliente_w
	from	ptu_resposta_autorizacao
	where	nr_seq_execucao	= nr_seq_execucao_p;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(179727);
	end;

	CALL pls_guia_gravar_historico(nr_seq_guia_p,2,'Enviado o cancelamento para a Unimed '||cd_unimed_beneficiario_w,'',nm_usuario_p);
elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	begin
		select	a.nr_sequencia
		into STRICT	nr_seq_execucao_p
		from	ptu_pedido_autorizacao		b,
			ptu_controle_execucao		a
		where	a.nr_seq_pedido_aut		= b.nr_sequencia
		and	b.nr_seq_requisicao		= nr_seq_requisicao_p;
	exception
	when others then
		begin
			select	a.nr_sequencia
			into STRICT	nr_seq_execucao_p
			from	ptu_pedido_compl_aut		b,
				ptu_controle_execucao		a
			where	a.nr_seq_pedido_compl		= b.nr_sequencia
			and	b.nr_seq_requisicao		= nr_seq_requisicao_p;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(179724);
		end;
	end;

	begin
	select	nr_sequencia
	into STRICT	nr_seq_cancelamento_w
	from	ptu_cancelamento
	where	nr_seq_execucao	= nr_seq_execucao_p;
	exception
	when others then
		nr_seq_cancelamento_w	:= 0;
	end;

	if (nr_seq_cancelamento_w	<> 0) then
		goto final;
	end if;

	begin
	select	cd_unimed_executora,
		cd_unimed_beneficiario,
		nr_seq_origem,
		ie_tipo_cliente
	into STRICT	cd_unimed_executora_w,
		cd_unimed_beneficiario_w,
		nr_seq_origem_w,
		ie_tipo_cliente_w
	from	ptu_resposta_autorizacao
	where	nr_seq_execucao	= nr_seq_execucao_p;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(179729);
	end;

	CALL pls_requisicao_gravar_hist(nr_seq_requisicao_p,'L','Enviado o cancelamento para a Unimed '||cd_unimed_beneficiario_w,null,nm_usuario_p);
end if;

insert	into ptu_cancelamento(nr_sequencia, cd_transacao, ie_tipo_cliente,
	 cd_unimed_executora, cd_unimed_beneficiario, nr_seq_execucao,
	 dt_atualizacao, nm_usuario, nr_seq_origem,
	 nr_seq_requisicao, nr_seq_guia)
values (nextval('ptu_cancelamento_seq'), '00211', ie_tipo_cliente_w,
	 cd_unimed_executora_w, cd_unimed_beneficiario_w, nr_seq_execucao_p,
	 clock_timestamp(), nm_usuario_p, nr_seq_origem_w,
	 nr_seq_requisicao_p, nr_seq_guia_p);

<<final>>
ie_existe_trans_w	:= 'S';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_cancelamento ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_complemento_p bigint, nr_seq_execucao_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

