-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_kit_proced_manual ( cd_cpoe_procedimento_p cpoe_procedimento.nr_sequencia%type, cd_kit_material_p cpoe_procedimento.cd_kit_material1%type, cd_estabelecimento_p componente_kit.cd_estab_regra%type, cd_perfil_p perfil.cd_perfil%type, cd_convenio_p componente_kit.cd_convenio%type default 0) AS $body$
DECLARE

    nr_max_kit_w              integer := 7;
    index_cpoe_procedimento_w smallint;
    index_kit_material_w      smallint;
    qt_idade_ano_w	          integer;
    qt_idade_mes_w	          bigint;
    qt_idade_dia_w	          bigint;
    ds_horarios_aux_w	      varchar(2000);
    nr_ocorrencia_w           smallint;
    nm_usuario_w              cpoe_material.nm_usuario%type;
    ie_urgencia_w             cpoe_procedimento.ie_urgencia%type;
    qt_procedimento_w         cpoe_procedimento.qt_procedimento%type;
    ie_tipo_convenio_w        convenio.ie_tipo_convenio%type;
    cd_medico_w               cpoe_procedimento.cd_medico%type;
    ie_recem_nato_w           varchar(1);
    cd_kit_material_w         cpoe_procedimento.cd_kit_material1%type;
    cd_pessoa_fisica_w        cpoe_procedimento.cd_pessoa_fisica%type;
    nr_atendimento_w          cpoe_procedimento.nr_atendimento%type;
    cd_interv_proc_w          cpoe_procedimento.cd_intervalo%type;
    dt_prev_execucao_w        cpoe_procedimento.dt_prev_execucao%type;
    ds_horarios_w             cpoe_procedimento.ds_hor_proc1%type;
    hr_prim_hor_proc_w	      cpoe_procedimento.hr_prim_hor_proc1%type;
    dt_fim_w                  cpoe_material.dt_fim%type;
    nr_ocorrencia_cpoe_w      cpoe_material.nr_ocorrencia%type;
    nr_seq_cpoe_material_w    cpoe_material.nr_sequencia%type;

c_kit CURSOR FOR
    SELECT  distinct c.cd_material cd_material,
            CASE WHEN coalesce(c.ie_multiplica_dose,'N')='S' THEN c.qt_material * qt_procedimento_w  ELSE c.qt_material END  qt_material_kit,
            coalesce(c.ie_via_aplicacao, m.ie_via_aplicacao) ie_via_aplicacao,
            obter_tipo_material(c.cd_material, 'C') ie_tipo_material,
            m.cd_unidade_medida_consumo cd_unid_medida_dose_mat
    from    componente_kit c,
            kit_material x,
            material m
    where   coalesce(c.cd_convenio,0) = (
                    SELECT    coalesce(max(y.cd_convenio), 0)
                    from    componente_kit y
                    where    y.cd_kit_material = c.cd_kit_material
                    and        y.cd_material      = c.cd_material
                    and        y.cd_convenio     = cd_convenio_p
                    and        ((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_p))
    )
    and    coalesce(c.ie_tipo_convenio,0) = (    
                    select    coalesce(max(y.ie_tipo_convenio), 0)
                    from    componente_kit y
                    where    y.cd_kit_material = c.cd_kit_material
                    and        y.cd_material      = c.cd_material
                    and        y.ie_tipo_convenio     = ie_tipo_convenio_w
                    and        ((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_p))
    )
    and (obter_se_comp_kit_rep(c.cd_kit_material,c.nr_sequencia,cd_medico_w) = 'S')
    and    ((c.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A'))
    and    ((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p))
	and (qt_idade_ano_w between coalesce(c.qt_idade_minima,-1) and coalesce(c.qt_idade_maxima,999))
    and    c.ie_situacao        = 'A'
    and    x.cd_kit_material    = c.cd_kit_material
    and    m.cd_material        = c.cd_material
    and    x.ie_situacao        = 'A'
    and    x.cd_kit_material    = cd_kit_material_w;
BEGIN
    nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

    FOR idx IN 1..nr_max_kit_w LOOP
        if (coalesce(index_kit_material_w::text, '') = '') then
            EXECUTE 'select cd_kit_material'||idx||' from cpoe_procedimento where nr_sequencia = '||cd_cpoe_procedimento_p into STRICT cd_kit_material_w;
            if (coalesce(cd_kit_material_w::text, '') = '') then
                index_kit_material_w := idx;
            end if;
        end if;
    END LOOP;

    cd_kit_material_w := cd_kit_material_p;

    if (index_kit_material_w IS NOT NULL AND index_kit_material_w::text <> '')then
        EXECUTE 'update cpoe_procedimento set cd_kit_material'||index_kit_material_w||' = '||cd_kit_material_w||' where nr_sequencia = '||cd_cpoe_procedimento_p;
    end if;

    if (cd_convenio_p > 0 ) then
        select  max(ie_tipo_convenio)
        into STRICT    ie_tipo_convenio_w
        from    convenio
        where    cd_convenio = cd_convenio_p;
    end if;

    select qt_procedimento, cd_medico, cd_pessoa_fisica, ie_urgencia, nr_atendimento, dt_prev_execucao
    into STRICT qt_procedimento_w, cd_medico_w, cd_pessoa_fisica_w, ie_urgencia_w, nr_atendimento_w, dt_prev_execucao_w
    from cpoe_procedimento
    where nr_sequencia = cd_cpoe_procedimento_p;

    select coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric ,0),
           coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'M'))::numeric ,0),
           coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'DIA'))::numeric ,0)
    into STRICT   qt_idade_ano_w, qt_idade_mes_w, qt_idade_dia_w
    from   pessoa_fisica
    where  cd_pessoa_fisica = cd_pessoa_fisica_w;

    index_cpoe_procedimento_w := 1;
    ie_recem_nato_w := Obter_se_recem_nasc(nr_atendimento_w);

    for c_kit_w in c_kit loop
    begin
        nr_ocorrencia_w	:= 0;
        hr_prim_hor_proc_w	:= to_char(dt_prev_execucao_w,'hh24:mi');

        if (coalesce(ds_horarios_w::text, '') = '') then					
            SELECT * FROM cpoe_calcular_horario_prescr(	
                NR_ATENDIMENTO_P => nr_atendimento_w, CD_INTERVALO_P => cd_interv_proc_w, CD_MATERIAL_P => c_kit_w.cd_material, DT_HORA_INICIO_P => dt_prev_execucao_w, QT_HORA_INTERVALO_P => null, QT_MIN_INTERVALO_P => null, NR_INTERVALO_P => nr_ocorrencia_w, DS_HORARIOS_P => ds_horarios_w, DS_HORARIOS2_P => ds_horarios_aux_w, NM_USUARIO_P => nm_usuario_w, CD_ESTABELECIMENTO_P => cd_estabelecimento_p, CD_PERFIL_P => cd_perfil_p, DS_DOSE_DIFERENCIADA_P => null) INTO STRICT NR_INTERVALO_P => nr_ocorrencia_w, DS_HORARIOS_P => ds_horarios_w, DS_HORARIOS2_P => ds_horarios_aux_w;
            ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
        end if;

        if (c_kit_w.ie_tipo_material = '1' or index_cpoe_procedimento_w > 7) then
            dt_fim_w := trunc(dt_prev_execucao_w + 1/24,'hh24') - 1/1440;
            nr_ocorrencia_cpoe_w := obter_ocorrencias_horarios_rep(ds_horarios_w);

            select  nextval('cpoe_material_seq')
            into STRICT  nr_seq_cpoe_material_w
;

            insert into cpoe_material(nr_sequencia,nr_atendimento,cd_material,qt_dose,cd_unidade_medida,ie_via_aplicacao,cd_intervalo,
                        hr_prim_horario,ds_horarios,dt_inicio,ie_urgencia,ie_duracao,ie_administracao,dt_fim,ie_material,nm_usuario,
                        nm_usuario_nrec,dt_atualizacao,dt_atualizacao_nrec,cd_perfil_ativo,cd_pessoa_fisica,nr_seq_procedimento,
                        nr_seq_proc_edit,cd_funcao_origem,qt_unitaria,nr_ocorrencia,ie_tipo_assoc, cd_kit_material
            ) values (
                nr_seq_cpoe_material_w, -- nr_sequencia
                nr_atendimento_w, -- nr_atendimento
                c_kit_w.cd_material, -- cd_material
                c_kit_w.qt_material_kit, -- qt_dose
                c_kit_w.cd_unid_medida_dose_mat, -- cd_unidade_medida
                c_kit_w.ie_via_aplicacao, -- ie_via_aplicacao
                cd_interv_proc_w, -- cd_intervalo
                hr_prim_hor_proc_w, -- hr_prim_horario
                ds_horarios_w, -- ds_horarios
                dt_prev_execucao_w, -- dt_inicio
                ie_urgencia_w, -- ie_urgencia
                'P', -- ie_duracao
                'P', -- ie_administracao
                dt_fim_w, -- dt_fim
                'S', -- ie_material
                nm_usuario_w, -- nm_usuario
                nm_usuario_w, -- nm_usuario_nrec
                clock_timestamp(), -- dt_atualizacao
                clock_timestamp(), -- dt_atualizacao_nrec
                cd_perfil_p, -- cd_perfil_ativo
                cd_pessoa_fisica_w, -- cd_pessoa_fisica
                cd_cpoe_procedimento_p, -- nr_seq_procedimento
                cd_cpoe_procedimento_p, -- nr_seq_proc_edit
                2314, -- cd_funcao_origem
                obter_conversao_unid_med_cons(c_kit_w.cd_material, c_kit_w.cd_unid_medida_dose_mat, c_kit_w.qt_material_kit), -- qt_unitaria
                nr_ocorrencia_cpoe_w, -- nr_ocorrencia
                'P', -- ie_tipo_assoc
                cd_kit_material_w -- cd_kit_material
            );
        else
            CALL exec_sql_dinamico_bv(
                DS_IDENTIFICACAO_P => 'CPOE',
                DS_COMANDO_P => 
					' update	cpoe_procedimento ' ||
					' set		cd_mat_proc'||index_cpoe_procedimento_w||' = :cd_material_w, ' ||
					' 			ie_via_mat_proc'||index_cpoe_procedimento_w||' = :ie_via_mat_proc_w, ' ||
					' 			qt_dose_mat'||index_cpoe_procedimento_w||' = :qt_dose_mat_w, ' ||
					' 			cd_unid_medida_dose_mat'||index_cpoe_procedimento_w||' = :cd_unid_medida_dose_mat_w, ' ||
					' 			cd_interv_proc'||index_cpoe_procedimento_w||' = :cd_interv_proc_w, ' ||
					' 			ds_hor_proc'||index_cpoe_procedimento_w||' = :ds_hor_proc_w, ' ||
					' 			dt_inicio_proc'||index_cpoe_procedimento_w||' = :dt_inicio_proc_w, ' ||
					' 			hr_prim_hor_proc'||index_cpoe_procedimento_w||' = :hr_prim_hor_proc_w, ' ||
					' 			ds_obser_proc'||index_cpoe_procedimento_w||' = :ds_obser_proc_w, ' ||
					' 			ie_urgencia_mat'||index_cpoe_procedimento_w||' = :ie_urgencia_mat_w, ' ||
					' 			ie_adm_mat'||index_cpoe_procedimento_w||' = :ie_adm_mat_w, ' ||
					' 			ie_assoc_adep'||index_cpoe_procedimento_w||' = :ie_assoc_adep_w ' ||
					' where		nr_sequencia = :cd_cpoe_procedimento_p',
                DS_PARAMETROS_P =>
                    'cd_material_w='||c_kit_w.cd_material||
                    '#@#@cd_interv_proc_w='||cd_interv_proc_w||
                    '#@#@ie_via_mat_proc_w='||c_kit_w.ie_via_aplicacao||
                    '#@#@ds_hor_proc_w='||ds_horarios_w||
                    '#@#@cd_unid_medida_dose_mat_w='||c_kit_w.cd_unid_medida_dose_mat||
                    '#@#@qt_dose_mat_w='||c_kit_w.qt_material_kit||
                    '#@#@dt_inicio_proc_w='||to_char(dt_prev_execucao_w,pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_w)))||
                    '#@#@hr_prim_hor_proc_w='||hr_prim_hor_proc_w||
                    '#@#@ds_obser_proc_w='||
                    '#@#@ie_urgencia_mat_w='||ie_urgencia_w||
                    '#@#@ie_adm_mat_w=P'||
                    '#@#@ie_assoc_adep_w=N' ||
                    '#@#@cd_cpoe_procedimento_p='||cd_cpoe_procedimento_p||
                    '#@#@'
            );
            index_cpoe_procedimento_w := index_cpoe_procedimento_w+1;
        end if;

    end;
    end loop;

    update cpoe_procedimento
    set ie_kit_gerado = 'S' 
    where nr_sequencia = cd_cpoe_procedimento_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_kit_proced_manual ( cd_cpoe_procedimento_p cpoe_procedimento.nr_sequencia%type, cd_kit_material_p cpoe_procedimento.cd_kit_material1%type, cd_estabelecimento_p componente_kit.cd_estab_regra%type, cd_perfil_p perfil.cd_perfil%type, cd_convenio_p componente_kit.cd_convenio%type default 0) FROM PUBLIC;

