-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_gerar_regra_valor_gv ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
vl_total_w		double precision;
nr_titulo_w		bigint;
nr_seq_cliente_w		bigint;
nr_sequencia_w		bigint;
ie_origem_proced_w	bigint;
nr_seq_gv_vinc_w		bigint;
cd_uf_w			varchar(2);
ds_compl_nf_w		varchar(250) := '';
dt_referencia_w		timestamp;

c01 CURSOR FOR 
SELECT	a.nr_seq_viagem 
from	fin_faturamento_gv_vinc a 
where	a.nr_seq_fat_gv = nr_sequencia_p;


BEGIN 
select	max(a.vl_total), 
	max(a.nr_titulo), 
	max(a.dt_referencia), 
	max(a.nr_seq_cliente) 
into STRICT	vl_total_w, 
	nr_titulo_w, 
	dt_referencia_w, 
	nr_seq_cliente_w 
from	fin_faturamento_gv a 
where	a.nr_sequencia = nr_sequencia_p;
 
select	substr(obter_dados_pf_pj(null,a.cd_cnpj,'UF'),1,2) 
into STRICT	cd_uf_w 
from	com_cliente a 
where	a.nr_sequencia = nr_seq_cliente_w;
 
select	nextval('com_cliente_regra_valor_seq') 
into STRICT	nr_sequencia_w
;
 
insert	into	com_cliente_regra_valor(nr_sequencia, 
				dt_inicio_vigencia, 
				dt_fim_vigencia, 
				cd_operacao_nf, 
				cd_condicao_pagamento, 
				cd_natureza_operacao, 
				ie_regra_gv, 
				cd_estabelecimento, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				ie_atualizar, 
				ie_situacao, 
				nm_usuario, 
				nm_usuario_nrec, 
				nr_seq_cliente) 
			values (	nr_sequencia_w, 
				trunc(dt_referencia_w,'month'), 
				fim_mes(dt_referencia_w), 
				24, 
				375, 
				CASE WHEN cd_uf_w='SC' THEN 5949  ELSE 6949 END , 
				'S', 
				cd_estabelecimento_p, 
				clock_timestamp(), 
				clock_timestamp(), 
				'N', 
				'A', 
				nm_usuario_p, 
				nm_usuario_p, 
				nr_seq_cliente_w);
 
update	fin_faturamento_gv 
set	nr_seq_regra = nr_sequencia_w 
where	nr_sequencia = nr_sequencia_p;
 
select	max(a.ie_origem_proced) 
into STRICT	ie_origem_proced_w 
from	procedimento a 
where	a.cd_procedimento = 69000300;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_gv_vinc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_compl_nf_w := ds_compl_nf_w || 'GV' || nr_seq_gv_vinc_w || ', ';
	end;
end loop;
close C01;
				 
insert into com_cli_regra_valor_item(nr_sequencia, 
				ds_titulo, 
				cd_procedimento, 
				vl_cobrar, 
				ie_rat, 
				cd_conta_contabil, 
				cd_centro_custo, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				ie_origem_proced, 
				ie_situacao, 
				nm_usuario, 
				nm_usuario_nrec, 
				nr_seq_regra, 
				ds_compl_nf) 
			values (	nextval('com_cli_regra_valor_item_seq'), 
				Wheb_mensagem_pck.get_texto(798784), 
				69000300, 
				vl_total_w, 
				'N', 
				3131, 
				75, 
				clock_timestamp(), 
				clock_timestamp(), 
				ie_origem_proced_w, 
				'A', 
				nm_usuario_p, 
				nm_usuario_p, 
				nr_sequencia_w, 
				ds_compl_nf_w);
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_gerar_regra_valor_gv ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

