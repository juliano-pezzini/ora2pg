-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_log_acesso_pep_item ( nr_seq_acesso_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_funcao_origem_p text, ds_justificativa_p text, nr_seq_justificativa_p bigint, nr_seq_item_oft_p bigint, nr_seq_item_pepo_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_existe_w		bigint := 0;
cd_perfil_ativo_w		bigint;
cont_w			bigint;
cd_setor_ativo_w		integer;
ie_existe_pepo_w		varchar(1) := 'N';
qt_existe_oft_w		bigint := 0;
nr_seq_item_pepo_w   	bigint := null;
nr_seq_item_w		bigint := null;


BEGIN
if (nr_seq_item_p > 0) then
	nr_seq_item_w := nr_seq_item_p;

	select	count(*)
	into STRICT	qt_existe_w
	from	prontuario_item
	where	nr_sequencia	= nr_seq_item_p;
end if;

if (nr_seq_item_oft_p > 0) then

	select	count(*)
	into STRICT	qt_existe_oft_w
	from	oftalmologia_item
	where	nr_sequencia	= nr_seq_item_oft_p;
end if;


if (qt_existe_w = 0) and (coalesce(nr_seq_item_pepo_p,0) > 0) then
	select 	coalesce(max('S'),'N')
	into STRICT	ie_existe_pepo_w
	from 	pepo_item
	where	coalesce(nr_seq_item_pep::text, '') = ''
	and 	nr_sequencia = nr_seq_item_pepo_p;

	if (ie_existe_pepo_w = 'S') then
		nr_seq_item_pepo_w 	:= nr_seq_item_pepo_p;
		nr_seq_item_w 			:= null;
	end if;
end if;

if (coalesce(obter_perfil_ativo,0)	> 0) then
	cd_perfil_ativo_w	:=obter_perfil_ativo;
end if;


select 	wheb_usuario_pck.get_cd_setor_atendimento
into STRICT	cd_setor_ativo_w
;

if cd_setor_ativo_w = 0 then
	cd_setor_ativo_w := null;
end if;


select	count(*)
into STRICT	cont_w
from	pep_acesso
where	nr_sequencia	= nr_seq_acesso_p;

if	((qt_existe_w > 0) or (ie_existe_pepo_w = 'S') or (qt_existe_oft_w > 0)) and (cont_w > 0) then

	select	nextval('pep_acesso_item_seq')
	into STRICT	nr_sequencia_w
	;

	insert into pep_acesso_item(
		nr_sequencia,
		nr_seq_acesso,
		dt_atualizacao,
		nm_usuario,
		nr_seq_item,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_funcao_origem,
		cd_perfil_ativo,
		ds_justificativa,
		nr_seq_justificativa,
		cd_setor_atendimento,
		nr_seq_item_pepo,
		nr_seq_item_oft)
	values (	nr_sequencia_w,
		nr_seq_acesso_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_funcao_origem_p,
		cd_perfil_ativo_w,
		ds_justificativa_p,
		nr_seq_justificativa_p,
		cd_setor_ativo_w,
		nr_seq_item_pepo_w,
		nr_seq_item_oft_p);

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_log_acesso_pep_item ( nr_seq_acesso_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_funcao_origem_p text, ds_justificativa_p text, nr_seq_justificativa_p bigint, nr_seq_item_oft_p bigint, nr_seq_item_pepo_p bigint) FROM PUBLIC;

