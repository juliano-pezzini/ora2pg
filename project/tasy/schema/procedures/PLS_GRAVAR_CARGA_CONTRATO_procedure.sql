-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_carga_contrato ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_contrato_w			timestamp;
cd_cod_anterior_w		varchar(20);
cd_cgc_estipulante_w		varchar(14);
cd_pf_estipulante_w		varchar(10);
ie_reajuste_w			varchar(1);
ie_geracao_valores_w		varchar(1);
nr_seq_congenere_w		bigint;
nr_seq_emissor_w		bigint;
ie_tipo_operacao_w		varchar(3);
qt_dias_valid_cart_w		integer;
dt_rescisao_contrato_w		timestamp;
dt_cancelamento_w		timestamp;
qt_anos_limite_reaj_w		smallint;
qt_idade_limite_reaj_w		smallint;
qt_intervalo_w			bigint;
nr_contrato_principal_w		bigint;
ie_renovacao_automatica_w	varchar(1);
ie_permite_prod_dif_w		varchar(1);
ie_itens_nao_cobertos_w		varchar(1);
ie_preco_co_operadora_w		varchar(1);
ie_situacao_w			varchar(1);
qt_registros_w			bigint;
nr_seq_contrato_w		bigint;

C01 CURSOR FOR
	SELECT	dt_contrato,
		cd_cod_anterior,
		cd_cgc_estipulante,
		cd_pf_estipulante,
		coalesce(ie_reajuste,'C'),
		coalesce(ie_geracao_valores,'B'),
		nr_seq_congenere,
		nr_seq_emissor,
		coalesce(ie_tipo_operacao,'B'),
		qt_dias_valid_cart,
		dt_rescisao_contrato,
		dt_cancelamento,
		qt_anos_limite_reaj,
		qt_idade_limite_reaj,
		qt_intervalo,
		nr_contrato_principal,
		coalesce(ie_renovacao_automatica,'N'),
		coalesce(ie_permite_prod_dif,'N'),
		ie_itens_nao_cobertos,
		ie_preco_co_operadora,
		coalesce(ie_situacao,'1')
	from	w_pls_carga_contrato
	where	(dt_contrato IS NOT NULL AND dt_contrato::text <> '');


BEGIN

open C01;
loop
fetch C01 into
	dt_contrato_w,
	cd_cod_anterior_w,
	cd_cgc_estipulante_w,
	cd_pf_estipulante_w,
	ie_reajuste_w,
	ie_geracao_valores_w,
	nr_seq_congenere_w,
	nr_seq_emissor_w,
	ie_tipo_operacao_w,
	qt_dias_valid_cart_w,
	dt_rescisao_contrato_w,
	dt_cancelamento_w,
	qt_anos_limite_reaj_w,
	qt_idade_limite_reaj_w,
	qt_intervalo_w,
	nr_contrato_principal_w,
	ie_renovacao_automatica_w,
	ie_permite_prod_dif_w,
	ie_itens_nao_cobertos_w,
	ie_preco_co_operadora_w,
	ie_situacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	--aaschlote 12/04/2011 OS - 305559
	select	count(*)
	into STRICT	qt_registros_w
	from	pls_contrato
	where	cd_cod_anterior		= cd_cod_anterior_w
	and	cd_estabelecimento	= cd_estabelecimento_p;

	if (qt_registros_w	= 0) then
		select	nextval('pls_contrato_seq')
		into STRICT	nr_seq_contrato_w
		;

		insert into pls_contrato(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, cd_cgc_estipulante,
			cd_pf_estipulante, dt_aprovacao, cd_cod_anterior,
			qt_intervalo, ie_renovacao_automatica, ie_permite_prod_dif,
			ie_situacao, dt_rescisao_contrato, dt_contrato,
			dt_reativacao, cd_contrato, ie_reajuste,
			cd_estabelecimento, ie_geracao_valores, nr_seq_emissor,
			ie_tipo_beneficiario, nr_seq_congenere, qt_dias_valid_cart,
			qt_idade_limite_reaj, qt_anos_limite_reaj, dt_cancelamento,
			nr_seq_motivo_rescisao, nr_seq_proposta, nr_contrato_principal,
			ie_preco_co_operadora, ie_itens_nao_cobertos, ie_tipo_operacao,
			nr_contrato, ie_controle_carteira)
		values (	nr_seq_contrato_w, clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, cd_cgc_estipulante_w,
			cd_pf_estipulante_w, null, cd_cod_anterior_w,
			qt_intervalo_w, ie_renovacao_automatica_w, ie_permite_prod_dif_w,
			ie_situacao_w, dt_rescisao_contrato_w, dt_contrato_w,
			null, null, ie_reajuste_w,
			cd_estabelecimento_p, ie_geracao_valores_w, nr_seq_emissor_w,
			'BE', nr_seq_congenere_w, qt_dias_valid_cart_w,
			qt_idade_limite_reaj_w, qt_anos_limite_reaj_w, dt_cancelamento_w,
			null, null, nr_contrato_principal_w,
			ie_preco_co_operadora_w, ie_itens_nao_cobertos_w, ie_tipo_operacao_w,
			nextval('nr_contrato_seq'), 'A');

	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_carga_contrato ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

