-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atual_dt_integ_mult_equip ( nr_prescricao_p text, ie_status_envio_p text, ie_status_pos_envio_p text, ds_sigla_p text, nm_usuario_p text) AS $body$
DECLARE

 
										 
nr_prescricao_w			prescr_procedimento.nr_prescricao%type;
nr_seq_prescr_w			prescr_procedimento.nr_sequencia%type;
ie_equip_pend_w			prescr_proc_equip_lab.ds_sigla_interf%type;
ie_exame_amostra_w		lab_parametro.ie_exame_amostra%type;
nr_seq_proc_mat_item_w	bigint;
ie_tipo_atendimento_w	bigint;
cd_estabelecimento_w	bigint;

										 
C01 CURSOR FOR 
	SELECT	distinct 
			a.nr_prescricao, 
			a.nr_sequencia 
	from	prescr_procedimento a, 
			prescr_proc_equip_lab b 
	where 	a.nr_prescricao = b.nr_prescricao 
	and		a.nr_sequencia	= b.nr_seq_prescr 
	and 	(obter_Equipamento_Exame(a.nr_seq_exame,null,ds_sigla_p) IS NOT NULL AND (obter_Equipamento_Exame(a.nr_seq_exame,null,ds_sigla_p))::text <> '')  
	and 	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')  
	and 	a.ie_status_atend = ie_status_envio_p  
	and		a.nr_prescricao = nr_prescricao_p 	 
	and		b.ds_sigla_interf = ds_sigla_p 
	and		a.cd_motivo_baixa = 0 
	and		a.ie_suspenso <> 'S' 
	and 	coalesce(a.dt_integracao::text, '') = '';
	
c02 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	prescr_proc_mat_item a, 
			prescr_procedimento b 
	where	a.nr_seq_prescr = b.nr_sequencia 
	and		a.nr_prescricao = b.nr_prescricao 
	and 	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') 
	and		coalesce(a.dt_integracao::text, '') = '' 
	and		a.ie_status = ie_status_envio_p 
	and		(Obter_Equip_Exame_online(b.nr_seq_exame,null,ds_sigla_p,ie_tipo_atendimento_w, cd_estabelecimento_w) IS NOT NULL AND (Obter_Equip_Exame_online(b.nr_seq_exame,null,ds_sigla_p,ie_tipo_atendimento_w, cd_estabelecimento_w))::text <> '')  
	and		a.nr_prescricao = nr_prescricao_p;
	
	 

BEGIN 
 
select	b.ie_tipo_atendimento, 
		a.cd_estabelecimento, 
		coalesce(c.ie_exame_amostra,'N') 
into STRICT	ie_tipo_atendimento_w, 
		cd_estabelecimento_w, 
		ie_exame_amostra_w 
from	prescr_medica a, 
		atendimento_paciente b, 
		lab_parametro c 
where	a.nr_atendimento = b.nr_atendimento 
and		a.cd_estabelecimento = c.cd_estabelecimento 
and		a.nr_prescricao = nr_prescricao_p;
 
open C01;
loop 
fetch C01 into	 
	nr_prescricao_w, 
	nr_seq_prescr_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	update 	prescr_proc_equip_lab 
	set	 	dt_integracao = clock_timestamp(), 
			nm_usuario = nm_usuario_p, 
			dt_atualizacao = clock_timestamp()			 
	where 	nr_prescricao = nr_prescricao_w 
	and		nr_seq_prescr = nr_seq_prescr_w 
	and		ds_sigla_interf = ds_sigla_p;
	commit;
	 
	select 	MAX(ds_sigla_interf) 
	into STRICT	ie_equip_pend_w 
	from 	prescr_proc_equip_lab 
	where 	nr_prescricao = nr_prescricao_w 
	and		nr_seq_prescr = nr_seq_prescr_w 
	and		coalesce(dt_integracao::text, '') = '' 
	and		ds_sigla_interf <> ds_sigla_p;
	 
	if (coalesce(ie_equip_pend_w::text, '') = '') then 
		update	prescr_procedimento 
		set		dt_atualizacao = clock_timestamp(), 
				dt_integracao = clock_timestamp(), 
				ie_status_atend = ie_status_pos_envio_p, 
				nm_usuario	= nm_usuario_p 
		where	nr_prescricao = nr_prescricao_w 
		and		nr_sequencia = nr_seq_prescr_w;
		 
		if (ie_exame_amostra_w = 'S') then 
			open c02;
			loop 
			fetch c02 into	 
				nr_seq_proc_mat_item_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin 
				update 	prescr_proc_mat_item 
				set 	ie_status = ie_status_pos_envio_p, 
						dt_integracao = clock_timestamp(), 
						dt_atualizacao = clock_timestamp(), 
						nm_usuario = nm_usuario_p 
				where 	nr_sequencia = nr_seq_proc_mat_item_w;
				end;
			end loop;
			close c02;
		end if;
	end if;
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atual_dt_integ_mult_equip ( nr_prescricao_p text, ie_status_envio_p text, ie_status_pos_envio_p text, ds_sigla_p text, nm_usuario_p text) FROM PUBLIC;

