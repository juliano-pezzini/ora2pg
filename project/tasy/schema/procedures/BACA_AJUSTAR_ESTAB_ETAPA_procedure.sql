-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_estab_etapa () AS $body$
DECLARE


cd_estabelecimento_w	bigint;
nr_sequencia_w		bigint;
nr_seq_etapa_w		bigint;
ds_etapa_w		varchar(255);
nr_seq_etapa_nova_w	bigint;

c01 CURSOR FOR
SELECT  c.cd_estabelecimento,
	a.nr_sequencia,
	a.nr_seq_etapa,
	b.ds_etapa
FROM       fatur_etapa             b,
   conta_paciente_etapa    a,
   conta_paciente          c
WHERE      a.nr_seq_etapa          = b.nr_sequencia
and        c.nr_interno_conta      = a.nr_interno_conta
and        c.cd_estabelecimento    <> b.cd_estabelecimento
and	   coalesce(b.ie_situacao,'A') = 'A'
and exists (select 1 from
fatur_etapa x
where x.cd_estabelecimento = c.cd_estabelecimento
and x.ds_etapa = b.ds_etapa
and coalesce(x.ie_situacao,'A') = 'A');


BEGIN

open	c01;
loop
fetch	c01 into
	cd_estabelecimento_w,
	nr_sequencia_w,
	nr_seq_etapa_w,
	ds_etapa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_etapa_nova_w
	from	fatur_etapa
	where	ds_etapa		= ds_etapa_w
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(ie_situacao,'A')	= 'A';

	if (nr_seq_etapa_nova_w <> 0) then

		/*insert	 into logxxxx_tasy values
			(sysdate, 'TASY', 7453,
			nr_sequencia_w || ' ' || nr_seq_etapa_w || ' ' || nr_seq_etapa_nova_w);*/
		update conta_paciente_etapa
		set 	nr_seq_etapa	= nr_seq_etapa_nova_w
		where	nr_sequencia	= nr_sequencia_w;
	end if;

	end;
end loop;
close c01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_estab_etapa () FROM PUBLIC;

