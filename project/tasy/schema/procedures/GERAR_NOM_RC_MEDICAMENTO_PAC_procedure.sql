-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_medicamento_pac (nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE



/* Medicamentos previos y actuales del paciente */

nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_html_w					varchar(32000);
qt_registro_w				bigint	:= 0;

c_medic_pac CURSOR FOR
SELECT  X.CD_MATERIAL cd_material,
		x.cd_sistema_ant, /*291*/
		substr(x.ds_material,1,240) ds_material, /*292*/
		b.ie_via_aplicacao ie_via_aplicacao,    /*293*/
		obter_desc_via(b.ie_via_aplicacao) ie_desc_via_aplicacao,   /*294*/
		b.cd_unidade_medida ds_dose,  /*295*/
		min(c.dt_horario) dt_inicio,    /*296*/
		max(c.dt_fim_horario) dt_fim,   /*297*/
		b.ds_observacao ds_observacao,  /*298*/
		sum(d.qt_dose_adm) qt_dose,
		obter_desc_unid_med(b.cd_unidade_medida) || '. Intervalo: ' || obter_desc_intervalo(b.cd_intervalo) ds_dose_desc
FROM    material x,
        prescr_mat_alteracao d,
        prescr_mat_hor c,
        prescr_material b,
        prescr_medica a,
        prescr_item_sintoma s,
        lista_problema_pac l,
        cpoe_material cp
WHERE	d.nr_seq_horario    	= c.nr_sequencia
AND		c.nr_seq_material   	= b.nr_sequencia
AND		c.nr_prescricao     	= b.nr_prescricao
AND		b.nr_prescricao     	= a.nr_prescricao
AND		cp.cd_material      	= x.cd_material
AND     s.nr_prescricao     	= b.nr_prescricao
AND     s.nr_seq_problema   	= l.nr_sequencia
AND     a.nr_atendimento    	= l.nr_atendimento
AND     cp.nr_atendimento   	= l.nr_atendimento 
AND     coalesce(c.ie_situacao,'A') 	= 'A'
AND     coalesce(c.ie_adep,'S') 		= 'S'
AND     b.ie_agrupador 			= 1
AND     coalesce(a.ie_adep,'S') 		= 'S'   
AND     Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
AND     (cp.nr_seq_receita_amb IS NOT NULL AND cp.nr_seq_receita_amb::text <> '')
AND 	coalesce(c.dt_suspensao::text, '') = ''
AND     (d.cd_um_dose_adm IS NOT NULL AND d.cd_um_dose_adm::text <> '')
AND     (coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
AND     (x.cd_sistema_ant IS NOT NULL AND x.cd_sistema_ant::text <> '')
AND		EXISTS (SELECT 1 FROM prescr_item_sintoma XX WHERE XX.NR_PRESCRICAO = B.NR_PRESCRICAO)
AND 	l.nr_atendimento    in (select	x.nr_atendimento
								from	nom_rc_cabecalho x
								where	x.nr_sequencia = nr_seq_cabecalho_p
								and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
								
union

								select	y.nr_atendimento
								from	atendimento_paciente y,
										nom_rc_cabecalho x
								where	x.nr_seq_episodio = y.nr_seq_episodio
								and		x.nr_sequencia = nr_seq_cabecalho_p)
GROUP BY
        a.nr_atendimento, 
        a.nr_prescricao,
        x.ds_material,
        d.cd_um_dose_adm,
        b.IE_VIA_APLICACAO,
        b.ds_observacao,
        x.cd_sistema_ant,
        obter_desc_material(b.cd_material),
        b.cd_unidade_medida,
		x.cd_material,
		b.cd_intervalo

union all

SELECT  m.cd_material,
		m.cd_sistema_ant, /*291*/
        substr(m.ds_material,1,240) ds_material, /*292*/
        p.ie_via_aplicacao ie_via_aplicacao, /*293*/
        obter_desc_via(p.ie_via_aplicacao) desc_via_aplicacao, /*294*/
        p.cd_unid_med ds_dose, /*295*/
        p.dt_inicio dt_inicio, /*296*/
        p.dt_fim dt_fim, /*297*/
        p.ds_observacao ds_observacao, /*298*/
        p.qt_dose qt_dose,
		obter_desc_unid_med(p.cd_unid_med) || '. Intervalo: ' || obter_desc_intervalo(p.cd_intervalo) ds_dose_desc
FROM    paciente_medic_uso p,
        material m,
        soap_item_sintoma s,
        lista_problema_pac l
WHERE   p.cd_material 		= m.cd_material
AND     p.nr_sequencia 		= s.nr_seq_pac_medic_uso
AND     s.nr_seq_problema 	= l.nr_sequencia
AND     (m.cd_sistema_ant IS NOT NULL AND m.cd_sistema_ant::text <> '')
AND     (p.dt_liberacao IS NOT NULL AND p.dt_liberacao::text <> '')
AND     coalesce(p.dt_inativacao::text, '') = ''
AND     l.nr_atendimento in (select	x.nr_atendimento
								from	nom_rc_cabecalho x
								where	x.nr_sequencia = nr_seq_cabecalho_p
								and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
								
union

								select	y.nr_atendimento
								from	atendimento_paciente y,
										nom_rc_cabecalho x
								where	x.nr_seq_episodio = y.nr_seq_episodio
								and		x.nr_sequencia = nr_seq_cabecalho_p)
GROUP BY 
        m.cd_sistema_ant,
        m.ds_material,
        p.ie_via_aplicacao,
        p.qt_dose,
        p.cd_unid_med,
        p.dt_inicio,
        p.dt_fim,
        p.ds_observacao,
		m.cd_material,
		p.cd_intervalo;


BEGIN
delete from nom_rc_medicamento_pac
where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	null;
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	min(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Nombre del medicamento</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Vía de administración</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Dosis</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fecha de inicio</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fecha de fin</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Obs. prescripción</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';

	for	r_c_medic_pac in c_medic_pac loop
		qt_registro_w	:= qt_registro_w + 1;

		insert into nom_rc_medicamento_pac(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			cd_sistema_ant,
			ds_material,
			ie_via_aplicacao,
			ie_desc_via_aplicacao,
			qt_dose,
			dt_inicio,
			dt_final,
			ds_observacao,
			ds_dose,
			nr_seq_cabecalho)
		values (nextval('nom_rc_medicamento_pac_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			r_c_medic_pac.cd_material,
			r_c_medic_pac.cd_sistema_ant,
			r_c_medic_pac.ds_material,
			r_c_medic_pac.ie_via_aplicacao,
			r_c_medic_pac.ie_desc_via_aplicacao,
			r_c_medic_pac.qt_dose,
			r_c_medic_pac.dt_inicio,
			r_c_medic_pac.dt_fim,
			r_c_medic_pac.ds_observacao,
			r_c_medic_pac.ds_dose,
			nr_seq_cabecalho_p);

			if (length(ds_html_w) < 31000) then
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_medic_pac.ds_material ||'</td>';
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_medic_pac.ie_via_aplicacao || ' - ' || r_c_medic_pac.ie_desc_via_aplicacao || '</td>';
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_medic_pac.qt_dose || ' ' || r_c_medic_pac.ds_dose_desc ||  '</td>';
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_data_utc(r_c_medic_pac.dt_inicio, 'NOM_TABLE') || '</td>';
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_data_utc(r_c_medic_pac.dt_fim, 'NOM_TABLE')  || '</td>';
				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_medic_pac.ds_observacao || '</td>';

				ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
			end if;
	end loop;

	if (qt_registro_w = 0) then
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td></td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td></td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td></td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td></td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td></td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_desc_expressao(932883) || '</td>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	end if;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>';

	insert into nom_rc_medicamento_pac(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_cabecalho,
		ds_html)
	values (nextval('nom_rc_medicamento_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_cabecalho_p,
		ds_html_w);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_medicamento_pac (nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

