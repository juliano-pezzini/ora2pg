-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_consiste_liberacao_enf (( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, ds_mensagem_1_p out text, ds_mensagem_2_p out text, ds_mensagem_3_p out text) is nr_atendimento_w prescr_medica.nr_atendimento%type) AS $body$
BEGIN
		if (ds_macro_p IS NOT NULL AND ds_macro_p::text <> '') then 
			return;
		else 
			return;
		end if;
	end;
						 
begin 
/* Gestão dos Planos Terapêuticos - Conversão dos códigos de parâmetros */
 
if (obter_funcao_ativa = 252) then 
	ie_parametro_3_w := obter_param_usuario(252, 33, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_3_w);
	ie_parametro_26_w := obter_param_usuario(252, 24, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_26_w);
	ie_parametro_33_w := obter_param_usuario(252, 25, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_33_w);
	ie_parametro_64_w := obter_param_usuario(252, 28, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_64_w);
	ie_parametro_75_w := obter_param_usuario(252, 32, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_75_w);
	ie_parametro_84_w := obter_param_usuario(252, 36, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_84_w);
else 
	ie_parametro_3_w := obter_param_usuario(7015, 3, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_3_w);
	ie_parametro_26_w := obter_param_usuario(7015, 26, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_26_w);
	ie_parametro_33_w := obter_param_usuario(7015, 33, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_33_w);
	ie_parametro_64_w := obter_param_usuario(7015, 64, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_64_w);
	ie_parametro_75_w := obter_param_usuario(7015, 75, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_75_w);
	ie_parametro_84_w := obter_param_usuario(7015, 84, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_parametro_84_w);
end if;
 
select	max(nr_atendimento), 
		max(cd_setor_atendimento) 
into STRICT	nr_atendimento_w, 
		cd_setor_atendimento_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
if (ie_parametro_84_w IS NOT NULL AND ie_parametro_84_w::text <> '') and (obter_se_contido(cd_setor_atendimento_w,ie_parametro_84_w) = 'S') then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(420272);
end if;
	 
if ((ie_parametro_64_w = 'S') or (ie_parametro_64_w = 'Q')) and (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then 
	 
	if (ie_parametro_75_w IS NOT NULL AND ie_parametro_75_w::text <> '') and (ie_parametro_75_w <> '') then 
		select	coalesce(count(*),0) 
		into STRICT	qt_setor_w 
		from	setor_atendimento a, 
				atend_paciente_unidade b 
		where	a.cd_setor_atendimento = b.cd_setor_atendimento 
		and		obter_se_contido_char(a.cd_setor_atendimento, ie_parametro_75_w) = 'S' 
		and		b.nr_atendimento = nr_atendimento_w;
	else 
		select	coalesce(count(*),0) 
		into STRICT	qt_setor_w 
		from  setor_atendimento a, 
				atend_paciente_unidade b 
		where  a.cd_setor_atendimento = b.cd_setor_atendimento 
		and   a.cd_classif_setor in (3,4,8) 
		and   b.nr_atendimento = nr_atendimento_w;		
	end if;
	 
	if (qt_setor_w = 0) then 
		if (ie_parametro_64_w = 'S') then 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(113699);
		else 
			if (ie_parametro_75_w IS NOT NULL AND ie_parametro_75_w::text <> '') and (ie_parametro_75_w <> '') then 
				ds_mensagem_1_w := obter_texto(113714);
			else 
				ds_mensagem_1_w := obter_texto(110911);
			end if;
		end if;
	end if;
 
end if;
 
if (ie_parametro_33_w <> 'S') then 
	ds_retorno_proc_w := consistir_liberacao_enfermagem(nr_prescricao_p, ds_retorno_proc_w);
	if (ds_retorno_proc_w IS NOT NULL AND ds_retorno_proc_w::text <> '') and (ie_parametro_33_w = 'N') then 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(ds_retorno_proc_w);
	elsif (ds_retorno_proc_w IS NOT NULL AND ds_retorno_proc_w::text <> '') then 
		ds_mensagem_2_w := obter_texto(28972,'MENSAGEM='||ds_retorno_proc_w);
	end if;
end if;
 
if (ie_parametro_3_w <> 'S') then 
	CALL consistir_dispensacao_farmacia(nr_prescricao_p);
end if;
 
if (ie_parametro_26_w = 'S') and (obter_unidade_atendimento(nr_atendimento_w,'A','CS') = cd_setor_atendimento_W) then 
	ds_mensagem_3_w := obter_texto(29153);
end if;
 
ds_mensagem_1_p	:= ds_mensagem_1_w;
ds_mensagem_2_p := ds_mensagem_2_w;
ds_mensagem_3_p := ds_mensagem_3_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_consiste_liberacao_enf (( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, ds_mensagem_1_p out text, ds_mensagem_2_p out text, ds_mensagem_3_p out text) is nr_atendimento_w prescr_medica.nr_atendimento%type) FROM PUBLIC;

