-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_insere_proc_padrao ( nr_atendimento_p bigint, cd_procedimento_p bigint, nr_seq_laudo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

			
cd_procedimento_w	sus_proced_padrao_ama.cd_procedimento%type;
nr_seq_laudo_w		atend_medico_ambulatorial.nr_sequencia%type;
qt_procedimento_w		sus_proced_padrao_ama.qt_procedimento%type;
ie_origem_proced_w	sus_proced_padrao_ama.ie_origem_proced%type;
cd_atividade_prof_bpa_w	sus_proced_padrao_ama.cd_atividade_prof_bpa%type;
cd_convenio_w		atend_categoria_convenio.cd_convenio%type;
cd_categoria_w		atend_categoria_convenio.cd_categoria%type;
cd_plano_convenio_w	atend_categoria_convenio.cd_plano_convenio%type;
cd_tipo_acomodacao_w	atend_categoria_convenio.cd_tipo_acomodacao%type;
nr_seq_proc_interno_w	sus_proced_padrao_ama.nr_seq_proc_interno%type;
ie_tipo_atendimento_w   atendimento_paciente.ie_tipo_atendimento%type;


BEGIN

nr_seq_laudo_w := nr_seq_laudo_p;
ie_tipo_atendimento_w := obter_tipo_atendimento(nr_atendimento_p);

begin
select	cd_procedimento,
	ie_origem_proced,
	qt_procedimento,
	cd_atividade_prof_bpa
into STRICT	cd_procedimento_w,
	ie_origem_proced_w,
	qt_procedimento_w,
	cd_atividade_prof_bpa_w
from	sus_proced_padrao_ama
where	ie_situacao = 'A'
and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
and	cd_estabelecimento = cd_estabelecimento_p
and	cd_procedimento = cd_procedimento_p;
exception
when others then
	cd_procedimento_w	:= 0;	
	ie_origem_proced_w	:= 0;
end;

if (cd_procedimento_w = 0) then
	begin
	
	begin
	select	nr_seq_proc_interno,
		qt_procedimento,
		cd_atividade_prof_bpa
	into STRICT	nr_seq_proc_interno_w,
		qt_procedimento_w,
		cd_atividade_prof_bpa_w
	from	sus_proced_padrao_ama
	where	ie_situacao = 'A'
	and	coalesce(cd_procedimento::text, '') = ''
	and	(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '')
	and	cd_estabelecimento = cd_estabelecimento_p
	and	nr_seq_proc_interno = cd_procedimento_p;	
	exception
	when others then
		nr_seq_proc_interno_w 	:= 0;
		cd_procedimento_w	:= 0;	
		ie_origem_proced_w	:= 0;
	end;
	
	select	max(cd_convenio),
		max(cd_categoria),
		max(cd_plano_convenio),
		max(cd_tipo_acomodacao)
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_plano_convenio_w,
		cd_tipo_acomodacao_w
	from	atend_categoria_convenio
	where	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_p);
	
	if (coalesce(nr_seq_proc_interno_w,0) <> 0) then
		begin
		SELECT * FROM Obter_Proc_Tab_Interno_Conv2(	nr_seq_proc_interno_w, cd_estabelecimento_P, cd_convenio_w, cd_categoria_w, cd_plano_convenio_w, clock_timestamp(), cd_tipo_acomodacao_w, cd_procedimento_w, ie_origem_proced_w, ie_tipo_atendimento_w) INTO STRICT cd_procedimento_w, ie_origem_proced_w;		
		end;
	end if;
	
	end;
end if;

if (nr_seq_laudo_w = 0) then
	begin
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_laudo_w
	from	atend_medico_ambulatorial
	where	nr_atendimento = nr_atendimento_p;
	if (nr_seq_laudo_w = 0) then
		begin
		select	nextval('atend_medico_ambulatorial_seq')
		into STRICT	nr_seq_laudo_w
		;
		insert into atend_medico_ambulatorial(	nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_atendimento,
							cd_medico_resp,
							ie_medic_prescrito,
							ie_medic_aplicada,
							dt_ama)
						values (	nr_seq_laudo_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_atendimento_p,
							substr(obter_pf_usuario(nm_usuario_p,'C'),1,10),
							'N',
							'N',
							clock_timestamp());		
		end;
	end if;
	end;
end if;

if (coalesce(cd_procedimento_w,0) <> 0) and (nr_seq_laudo_w <> 0) then
	begin
	insert into proced_medico_ambulatorial(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_procedimento,
						qt_procedimento,
						nr_seq_ama,-- (sequencia do laudo)
						ie_origem_proced,
						cd_atividade_prof_bpa)
					values ( nextval('proced_medico_ambulatorial_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_procedimento_w,
						qt_procedimento_w,
						nr_seq_laudo_w,
						ie_origem_proced_w,
						cd_atividade_prof_bpa_w);	
	end;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_insere_proc_padrao ( nr_atendimento_p bigint, cd_procedimento_p bigint, nr_seq_laudo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

