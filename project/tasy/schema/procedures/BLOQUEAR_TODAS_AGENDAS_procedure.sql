-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bloquear_todas_agendas ( nr_seq_bloqueio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_agenda_w		bigint;
ie_setor_exclusivo_w	varchar(1);

c01 CURSOR FOR 
SELECT	a.cd_agenda 
from	agenda a 
where	a.ie_situacao 		= 'A' 
and   a.cd_tipo_agenda 	= 1 
and   (((a.cd_setor_exclusivo IS NOT NULL AND a.cd_setor_exclusivo::text <> '') and ie_setor_exclusivo_w = 'S') 
	or (coalesce(a.cd_setor_exclusivo::text, '') = '' and ie_setor_exclusivo_w = 'N')) 
and   a.cd_estabelecimento 	= cd_estabelecimento_p 
and	not exists (	SELECT	1 
			from	agenda_bloqueio b 
			where	b.nr_sequencia 	= nr_seq_bloqueio_p 
			and	b.cd_agenda	= a.cd_agenda);


BEGIN 
 
select	max(obter_valor_param_usuario(871, 28, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)) 
into STRICT	ie_setor_exclusivo_w
;
 
 
OPEN C01;
LOOP 
FETCH C01 into 
	cd_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	insert into agenda_bloqueio( 
		cd_agenda, 
		dt_inicial, 
		dt_final, 
		ie_motivo_bloqueio, 
		dt_atualizacao, 
		nm_usuario, 
		ds_observacao, 
		ie_dia_semana, 
		hr_inicio_bloqueio, 
		hr_final_bloqueio, 
		nr_sequencia, 
		ie_classif_bloqueio) 
	SELECT	cd_agenda_w, 
		dt_inicial, 
		dt_final, 
		ie_motivo_bloqueio, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_observacao, 
		ie_dia_semana, 
		hr_inicio_bloqueio, 
		hr_final_bloqueio, 
		nextval('agenda_bloqueio_seq'), 
		ie_classif_bloqueio 
	from	agenda_bloqueio 
	where	nr_sequencia = nr_seq_bloqueio_p;
 
	end;
END LOOP;
CLOSE C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bloquear_todas_agendas ( nr_seq_bloqueio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

