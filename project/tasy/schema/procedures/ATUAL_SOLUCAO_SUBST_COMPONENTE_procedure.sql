-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_solucao_subst_componente ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_sequencia_solucao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) is ie_calc_aut_w varchar(1) RETURNS bigint AS $body$
DECLARE

	
	qt_fator_calculo_w		bigint;
	qt_tempo_w				bigint;
	
BEGIN	
	if (ie_tipo_dosagem_w = 'gtm') then
		qt_fator_calculo_w	:= 20;
		qt_tempo_w			:= 60;
	elsif (ie_tipo_dosagem_w = 'mlh') then
		qt_fator_calculo_w	:= 1;
		qt_tempo_w			:= 1;
	else
		qt_fator_calculo_w	:= 60;
		qt_tempo_w			:= 60;
	end if;
	
	return dividir(dividir((round(qt_solucao_total_p) * qt_fator_calculo_w), qt_tempo_aplicacao_w) , qt_tempo_w);
	
	end;
					
begin

select	max(cd_funcao_origem)
into STRICT	cd_funcao_origem_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_calc_aut),'N'),
		coalesce(max(ie_esquema_Alternado),'N'),
		max(ie_tipo_dosagem),
		coalesce(max(qt_tempo_aplicacao),0),
		coalesce(max(nr_etapas),0)
into STRICT	ie_calc_aut_w,
		ie_esquema_alternado_w,
		ie_tipo_dosagem_w,
		qt_tempo_aplicacao_w,
		nr_etapas_w
from	prescr_solucao
where	nr_prescricao 	= nr_prescricao_p
and 	nr_seq_solucao 	= nr_seq_solucao_p;

select	coalesce(sum(qt_solucao),0)
into STRICT	qt_volume_adep_w
from 	prescr_material a
where 	a.nr_prescricao = nr_prescricao_p
and 	a.nr_sequencia_solucao = nr_seq_solucao_p
and		coalesce(a.nr_seq_substituto::text, '') = '';

if (ie_tipo_dosagem_w <> 'ACM') or (ie_esquema_alternado_w = 'S') then
	select	coalesce(sum(qt_solucao),0)
	into STRICT	qt_volume_w
	from 	prescr_material a
	where 	a.nr_prescricao 	= nr_prescricao_p
	and 	a.nr_sequencia_solucao 	= nr_seq_solucao_p
	and		coalesce(a.nr_seq_substituto::text, '') = '';

end if;	


if (ie_calc_aut_w = 'S') or (cd_funcao_origem_w = 2314) then

	if (ie_esquema_alternado_w <> 'S') then		
		qt_solucao_total_w	:= (qt_volume_w * nr_etapas_w);
		qt_dosagem_w		:= obter_vel_infusao(qt_solucao_total_w);		
		update	prescr_solucao
		set		qt_volume 	 		= qt_volume_w,
				qt_solucao_total 	= qt_solucao_total_w,
				qt_dosagem	 		= qt_dosagem_w,
				qt_volume_adep		= qt_volume_adep_w	
		where	nr_prescricao 		= nr_prescricao_p
		and		nr_seq_solucao 	 	= nr_seq_solucao_p;
	else
		qt_dosagem_w		:= obter_vel_infusao(qt_volume_w);
		update	prescr_solucao
		set		qt_solucao_total	= qt_volume_w,
				qt_dosagem	 		= qt_dosagem_w,
				qt_volume_adep	 	= qt_volume_adep_w
		where	nr_prescricao 	 	= nr_prescricao_p
		and		nr_seq_solucao 	 	= nr_seq_solucao_p;
	end if;	
else
	update	prescr_solucao
	set		qt_volume 	= qt_volume_w,
			qt_volume_adep	= qt_volume_adep_w
	where	nr_prescricao 	= nr_prescricao_p
	and		nr_seq_solucao 	= nr_seq_solucao_p;
end if;	


if (ie_esquema_alternado_w = 'S') then
	CALL Calcular_Etapas_Esquema(nr_prescricao_p,nr_seq_solucao_p);
end if;

select cd_material
into STRICT cd_material_w
from prescr_material
where nr_sequencia = nr_sequencia_solucao_p
and nr_prescricao = nr_prescricao_p;

CALL cpoe_substituir_componente_sol( nr_prescricao_p, nr_seq_solucao_p, cd_material_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_solucao_subst_componente ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_sequencia_solucao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) is ie_calc_aut_w varchar(1) FROM PUBLIC;

