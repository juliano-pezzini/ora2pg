-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ins_man_custom_branch (NR_SEQ_SO_ORIGIN_P man_custom_branch.nr_seq_service_ordem_orig%type, nm_usuario_p man_custom_branch.nm_usuario%type) AS $body$
DECLARE


cd_version_w man_custom_branch.cd_version%type;
cd_build_w man_custom_branch.cd_build_tag%type;
cd_cnpj_w man_custom_branch.cd_cnpj%type;
branch_name_w man_custom_branch.branch_name%type;
part_branch_name_w varchar(20) := null;


BEGIN

    if (not coalesce(nr_seq_so_origin_p::text, '') = '') then
        branch_name_w := customer_branch_exists(nr_seq_so_origin_p);

        if (coalesce(branch_name_w::text, '') = '' or length(branch_name_w) > 0) then

            select trim(both substr(mos.nr_versao_cliente_abertura,0,9)), mos.nr_versao_cliente_abertura
                 , REGEXP_REPLACE(ml.cd_cnpj, '\.|/|-', '')
                 , trim(both lpad(REGEXP_REPLACE(REGEXP_SUBSTR(ml.ds_localizacao, '(\S*)(\s)', 1)||REGEXP_SUBSTR(ml.ds_localizacao, '(\S*)(\s)', 1, 2), '\s|''|\\|\.', ''),20))
              into STRICT cd_version_w, cd_build_w, cd_cnpj_w, part_branch_name_w
              from man_ordem_servico mos
             inner join man_localizacao ml ON (mos.nr_seq_localizacao = ml.nr_sequencia)
             where mos.nr_sequencia = NR_SEQ_SO_ORIGIN_P;

            branch_name_w := cd_version_w||'-'||part_branch_name_w;

            insert into MAN_CUSTOM_BRANCH(
            DT_ATUALIZACAO_NREC
            ,NR_SEQ_SERVICE_ORDEM_ORIG
            ,CD_CNPJ
            ,NR_SEQUENCIA
            ,NM_USUARIO
            ,NM_USUARIO_NREC
            ,CD_VERSION
            ,CD_BUILD_TAG
            ,BRANCH_NAME
            ,IE_CREATED_BRANCH
            ,DT_ATUALIZACAO
            ) values (
            clock_timestamp()
            ,NR_SEQ_SO_ORIGIN_P
            ,cd_cnpj_w
            ,nextval('man_custom_branch_seq')
            ,nm_usuario_p
            ,nm_usuario_p
            ,cd_version_w
            ,cd_build_w
            ,branch_name_w
            ,'N'
            ,clock_timestamp());

            CALL INS_HIST_REQ_CUSTOM_BRANCH_OS(NR_SEQ_SO_ORIGIN_P, branch_name_w);

            commit;
        end if;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ins_man_custom_branch (NR_SEQ_SO_ORIGIN_P man_custom_branch.nr_seq_service_ordem_orig%type, nm_usuario_p man_custom_branch.nm_usuario%type) FROM PUBLIC;

