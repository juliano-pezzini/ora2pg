-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nova_prescricao_sol ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_orig_p bigint, nr_seq_solucao_p bigint, ie_tipo_item_p INOUT text, nr_prescricoes_p text, cd_perfil_p bigint, nm_usuario_p text, ie_interv_farm_p text, ie_susp_sol_orig_p text default 'S', nr_nova_prescricao_p INOUT bigint DEFAULT NULL, nr_nova_sequencia_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

 
ie_calcula_validade_w		varchar(5);
ie_estender_prescricao_w	varchar(5);
ie_verificar_prescr_w		varchar(1);
ie_prescr_mat_sem_lib_w		varchar(30);
ie_motivo_prescr_w			varchar(5);
nr_prescricao_w				bigint;
nr_prescricao_ww			bigint;
ie_nova_prescricao_w		varchar(1) := 'S';
nr_seq_dialise_w			bigint;
nr_seq_dialise_ww			bigint;
nr_agrup_acum_w				bigint;
ie_medico_w					varchar(5);
cd_prescritor_w				varchar(10);
nr_horas_validade_w			integer;
nr_atendimento_w			bigint;
nr_seq_solucao_w			bigint;
nr_seq_material_w			bigint;
dt_primeiro_horario_w		timestamp;
ie_tipo_dialise_w			varchar(1);
cd_setor_atendimento_w		integer;
nr_etapa_atual_w			bigint;
nr_etapas_w					bigint;
nr_etapas_suspender_w		varchar(4000);
nr_etapas_erro_w			varchar(4000);
nr_etapa_w					bigint;

C01 CURSOR FOR 
	SELECT	nr_etapa_sol 
	from	prescr_mat_hor 
	where	coalesce(ie_horario_especial,'N') = 'N' 
	and		coalesce(dt_inicio_horario::text, '') = '' 
	and		coalesce(dt_suspensao::text, '') = '' 
	and		(nr_etapa_sol IS NOT NULL AND nr_etapa_sol::text <> '') 
	and		nr_seq_solucao = nr_seq_solucao_p 
	and		nr_prescricao = nr_prescricao_orig_p 
	order by 1;


BEGIN 
 
if ((coalesce(nr_prescricao_orig_p,nr_prescricoes_p) IS NOT NULL AND (coalesce(nr_prescricao_orig_p,nr_prescricoes_p))::text <> '')) and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then 
 
	ie_calcula_validade_w := Obter_Param_Usuario(924, 98, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_calcula_validade_w);
	ie_estender_prescricao_w := Obter_Param_Usuario(924, 249, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_estender_prescricao_w);
	ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_mat_sem_lib_w);
	ie_verificar_prescr_w := Obter_Param_Usuario(8030, 47, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_verificar_prescr_w);
	ie_motivo_prescr_w := Obter_Param_Usuario(8030, 65, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_motivo_prescr_w);
 
	if (coalesce(nr_prescricao_orig_p::text, '') = '') then 
		select 	Obter_Max_NrPrescricao(nr_prescricoes_p) 
		into STRICT	nr_prescricao_w 
		;
	else	 
		nr_prescricao_w := nr_prescricao_orig_p;
	end if;
 
	if (nr_prescricao_w > 0) then	 
		 
		if (ie_calcula_validade_w	= 'R') then 
			 
			select	max(cd_setor_atendimento) 
			into STRICT	cd_setor_atendimento_w 
			from	prescr_medica 
			where	nr_prescricao	= nr_prescricao_w;
			 
			ie_calcula_validade_w	:= obter_se_calcula_validade(cd_setor_atendimento_w);
			 
		end if;
		 
		select	max(cd_pessoa_fisica) 
		into STRICT	cd_prescritor_w 
		from	usuario 
		where	nm_usuario	= nm_usuario_p;
 
		if (coalesce(ie_interv_farm_p,'N') = 'N') then 
		 
			if (ie_verificar_prescr_w = 'S') then 
				select	max(nr_prescricao) 
				into STRICT 	nr_prescricao_ww 
				from	Prescr_medica 
				where	nr_atendimento 		= nr_atendimento_p 
				and	coalesce(dt_liberacao::text, '') = '' 
				and	coalesce(dt_liberacao_medico::text, '') = '' 
				and	cd_prescritor		= cd_prescritor_w 
				and	trunc(dt_prescricao,'dd') = trunc(clock_timestamp(),'dd');
				 
				if (coalesce(nr_prescricao_ww::text, '') = '') then 
					select 	nextval('prescr_medica_seq') 
					into STRICT  	nr_prescricao_ww 
					;
				else 
					ie_nova_prescricao_w := 'N';
				end if;
			else 
				select 	nextval('prescr_medica_seq') 
				into STRICT  	nr_prescricao_ww 
				;
			end if;
		else 
			select	max(nr_prescricao) 
			into STRICT 	nr_prescricao_ww 
			from	Prescr_medica 
			where	nr_prescricao_anterior = nr_prescricao_w;
			 
			if (coalesce(nr_prescricao_ww::text, '') = '') then 
				select 	nextval('prescr_medica_seq') 
				into STRICT  	nr_prescricao_ww 
				;
			else 
				ie_nova_prescricao_w := 'N';
			end if;
		end if;
		 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_w;
		 
		dt_primeiro_horario_w := to_date('30/12/1899 ' || to_char(clock_timestamp(),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		 
		if (ie_calcula_validade_w <> 'N') then 
			select	max(obter_horas_validade_prescr(dt_primeiro_horario_w,nr_atendimento_w,ie_estender_prescricao_w,'A',clock_timestamp(),nr_prescricao_w)) 
			into STRICT	nr_horas_validade_w 
			;
		end if;
 
		if (ie_nova_prescricao_w = 'S') then	 
			insert into prescr_medica( 
				nr_prescricao, 
				cd_pessoa_fisica, 
				nr_atendimento, 
				cd_medico, 
				dt_prescricao, 
				dt_atualizacao, 
				nm_usuario, 
				nm_usuario_original, 
				ds_observacao, 
				nr_horas_validade, 
				cd_motivo_baixa, 
				dt_baixa, 
				dt_primeiro_horario, 
				dt_liberacao, 
				dt_emissao_setor, 
				dt_emissao_farmacia, 
				cd_setor_atendimento, 
				dt_entrada_unidade, 
				ie_recem_nato, 
				ie_origem_inf, 
				nr_prescricao_anterior, 
				nr_prescricao_mae, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_cirurgia, 
				nr_seq_agenda, 
				cd_estabelecimento, 
				ds_medicacao_uso, 
				cd_prescritor, 
				qt_altura_cm, 
				qt_peso, 
				ie_adep, 
				ie_prescr_emergencia, 
				ie_prescricao_alta, 
				ie_hemodialise, 
				ie_motivo_prescricao, 
				nr_prescricoes, 
				nr_seq_transcricao, 
				ie_prescr_farm) 
			SELECT	nr_prescricao_ww, 
				cd_pessoa_fisica, 
				CASE WHEN nr_atendimento_p=0 THEN  null  ELSE nr_atendimento_p END , 
				CASE WHEN Obter_se_medico(cd_prescritor_w,'M')='S' THEN  cd_prescritor_w  ELSE cd_medico END , 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				ds_observacao, 
				coalesce(nr_horas_validade_w, nr_horas_validade), 
				null, 
				null, 
				dt_primeiro_horario_w, 
				null, 
				null, 
				null, 
				cd_setor_atendimento, 
				null, 
				'N', 
				ie_origem_inf, 
				nr_prescricao_w, 
				nr_prescricao_mae, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_cirurgia, 
				null, 
				cd_estabelecimento, 
				ds_medicacao_uso, 
				coalesce(cd_prescritor_w, cd_prescritor), 
				qt_altura_cm, 
				qt_peso, 
				ie_adep, 
				'N', 
				'N', 
				ie_hemodialise, 
				coalesce(ie_motivo_prescr_w, ie_motivo_prescricao), 
				nr_prescricoes_p, 
				nr_seq_transcricao, 
				CASE WHEN coalesce(ie_interv_farm_p,'N')='N' THEN  ie_prescr_farm  ELSE 'S' END  
			from	prescr_medica 
			where	nr_prescricao = nr_prescricao_w;
			commit;
		end if;
		 
		-- Hemodiálise 
		if (ie_tipo_item_p = 'MD') then 
		 
			select	max(nr_seq_dialise) 
			into STRICT	nr_seq_dialise_w 
			from	prescr_solucao 
			where	nr_prescricao	= nr_prescricao_w 
			and	nr_seq_solucao	= nr_seq_solucao_p 
			and	coalesce(ie_hemodialise,'N') <> 'N';
			 
			select	coalesce(max(ie_tipo_dialise),'N') 
			into STRICT	ie_tipo_dialise_w 
			from	hd_prescricao 
			where	nr_prescricao	= nr_prescricao_w 
			and	nr_sequencia	= nr_seq_dialise_w;
			 
			if (ie_tipo_dialise_w <> 'N') and (nr_seq_dialise_w IS NOT NULL AND nr_seq_dialise_w::text <> '') then 
 
				select	max(nr_sequencia) 
				into STRICT	nr_seq_dialise_ww 
				from	hd_prescricao 
				where	nr_prescricao	= nr_prescricao_ww 
				and	ie_tipo_dialise = ie_tipo_dialise_w;
				 
				if (coalesce(nr_seq_dialise_ww::text, '') = '') then 
					select	nextval('hd_prescricao_seq') 
					into STRICT	nr_seq_dialise_ww 
					;
					 
					insert into hd_prescricao( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_prescricao, 
						qt_fluxo_sangue, 
						qt_sessao_sem, 
						qt_min_sessao, 
						nr_seq_mod_dialisador, 
						ie_ultrafiltracao, 
						qt_ultrafiltracao, 
						ie_tipo_hemodialise, 
						qt_peso_ideal, 
						nr_seq_diametro_agulha, 
						nr_seq_tipo_agulha_art, 
						nr_seq_perfil_sodio, 
						qt_zero_um, 
						qt_um_dois, 
						qt_dois_tres, 
						qt_tres_quatro, 
						ie_ligar_prime, 
						qt_peso_seco, 
						ds_observacao, 
						nr_prescricao_original, 
						ie_tipo_dialise, 
						ie_tipo_peritoneal, 
						nr_ciclos, 
						qt_volume_ciclo, 
						qt_hora_duracao, 
						qt_min_duracao, 
						qt_volume_total, 
						qt_hora_sessao, 
						dt_inicio_dialise, 
						dt_fim_dialise, 
						nr_seq_maq_cicladora, 
						nr_serie, 
						qt_minimo_volume, 
						ie_perm_inteligente, 
						ie_apagar_visor, 
						ie_volume_alarme, 
						ie_modo_dialise, 
						ie_continuo, 
						ie_cateter, 
						nr_seq_tipo_agulha, 
						qt_seto_oito, 
						qt_cinco_seis, 
						ie_categoria) 
					SELECT	nr_seq_dialise_ww, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_prescricao_ww, 
						qt_fluxo_sangue, 
						qt_sessao_sem, 
						qt_min_sessao, 
						nr_seq_mod_dialisador, 
						ie_ultrafiltracao, 
						qt_ultrafiltracao, 
						ie_tipo_hemodialise, 
						qt_peso_ideal, 
						nr_seq_diametro_agulha, 
						nr_seq_tipo_agulha_art, 
						nr_seq_perfil_sodio, 
						qt_zero_um, 
						qt_um_dois, 
						qt_dois_tres, 
						qt_tres_quatro, 
						ie_ligar_prime, 
						qt_peso_seco, 
						ds_observacao, 
						nr_prescricao_orig_p, 
						ie_tipo_dialise, 
						ie_tipo_peritoneal, 
						nr_ciclos, 
						qt_volume_ciclo, 
						qt_hora_duracao, 
						qt_min_duracao, 
						qt_volume_total, 
						qt_hora_sessao, 
						dt_inicio_dialise, 
						dt_fim_dialise, 
						nr_seq_maq_cicladora, 
						nr_serie, 
						qt_minimo_volume, 
						ie_perm_inteligente, 
						ie_apagar_visor, 
						ie_volume_alarme, 
						ie_modo_dialise, 
						ie_continuo, 
						ie_cateter, 
						nr_seq_tipo_agulha, 
						qt_seto_oito, 
						qt_cinco_seis, 
						ie_categoria 
					from	hd_prescricao 
					where	nr_prescricao	= nr_prescricao_orig_p 
					and	nr_sequencia	= nr_seq_dialise_w;		
					commit;
				end if;
				 
				select	coalesce(max(nr_seq_solucao),0) + 1, 
					coalesce(max(nr_agrupamento),0) + 1 
				into STRICT	nr_seq_solucao_w, 
					nr_agrup_acum_w 
				from	prescr_solucao 
				where	nr_prescricao = nr_prescricao_ww;
 
				select	coalesce(max(nr_etapas_medico),coalesce(max(nr_etapas),0)), 
					coalesce(max(obter_etapa_atual_HM(nr_prescricao, nr_seq_solucao)),0) 
				into STRICT	nr_etapas_w, 
					nr_etapa_atual_w 
				from	prescr_solucao 
				where	nr_prescricao	= nr_prescricao_orig_p 
				and	nr_seq_solucao	= nr_seq_solucao_p;
				 
				nr_etapas_w	:= (nr_etapas_w	- nr_etapa_atual_w);
				 
				if (nr_etapas_w	< 0) then 
					nr_etapas_w	:= 0;
				end if;
 
				insert into prescr_solucao( 
					nr_prescricao, 
					nr_seq_solucao, 
					ie_via_aplicacao, 
					dt_atualizacao, 
					nm_usuario, 
					cd_unidade_medida, 
					ie_tipo_dosagem, 
					qt_dosagem, 
					qt_solucao_total, 
					qt_tempo_aplicacao, 
					ds_solucao, 
					qt_volume, 
					nr_etapas, 
					ds_horarios, 
					ie_bomba_infusao, 
					ie_suspenso, 
					nr_agrupamento, 
					ie_esquema_alternado, 
					ie_calc_aut, 
					ie_acm, 
					hr_prim_horario, 
					qt_hora_fase, 
					ie_urgencia, 
					ds_orientacao, 
					ie_hemodialise, 
					ie_tipo_solucao, 
					ie_pos_dialisador, 
					nr_seq_protocolo, 
					ie_unid_vel_inf, 
					qt_temp_solucao, 
					ie_apap, 
					qt_dose_ataque, 
					ie_se_necessario, 
					ie_solucao_pca, 
					ie_tipo_analgesia, 
					ie_pca_modo_prog, 
					qt_vol_infusao_pca, 
					qt_bolus_pca, 
					qt_intervalo_bloqueio, 
					qt_limite_quatro_hora, 
					qt_dose_inicial_pca, 
					ie_solucao_especial, 
					ie_etapa_especial, 
					nr_prescricao_original, 
					nr_seq_dialise, 
					ie_momento, 
					nr_seq_fabric, 
					hr_fim_capd, 
					hr_inicio_capd, 
					qt_tempo_drenagem, 
					qt_tempo_infusao, 
					qt_tempo_perm_hor, 
					nr_seq_anterior) -- Caso houver estensão da Diálise pela REP - PT, este campo deverá ser revisto 
				SELECT	nr_prescricao_ww, 
					nr_seq_solucao_w, 
					ie_via_aplicacao, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_unidade_medida, 
					ie_tipo_dosagem, 
					qt_dosagem, 
					qt_solucao_total, 
					qt_tempo_aplicacao, 
					ds_solucao, 
					qt_volume, 
					CASE WHEN coalesce(ie_acm,'N')='S' THEN  0  ELSE nr_etapas_w END , 
					ds_horarios, 
					ie_bomba_infusao, 
					ie_suspenso, 
					nr_agrup_acum_w, 
					ie_esquema_alternado, 
					ie_calc_aut, 
					ie_acm, 
					hr_prim_horario, 
					qt_hora_fase, 
					ie_urgencia, 
					ds_orientacao, 
					ie_hemodialise, 
					ie_tipo_solucao, 
					ie_pos_dialisador, 
					nr_seq_protocolo, 
					ie_unid_vel_inf, 
					qt_temp_solucao, 
					ie_apap, 
					qt_dose_ataque, 
					ie_se_necessario, 
					ie_solucao_pca, 
					ie_tipo_analgesia, 
					ie_pca_modo_prog, 
					qt_vol_infusao_pca, 
					qt_bolus_pca, 
					qt_intervalo_bloqueio, 
					qt_limite_quatro_hora, 
					qt_dose_inicial_pca, 
					ie_solucao_especial, 
					ie_etapa_especial, 
					nr_prescricao_orig_p, 
					nr_seq_dialise_ww, 
					ie_momento, 
					nr_seq_fabric, 
					hr_fim_capd, 
					hr_inicio_capd, 
					qt_tempo_drenagem, 
					qt_tempo_infusao, 
					qt_tempo_perm_hor, 
					nr_seq_solucao 
				from	prescr_solucao 
				where	nr_prescricao	= nr_prescricao_orig_p 
				and	nr_seq_dialise	= nr_seq_dialise_w 
				and	nr_seq_solucao	= nr_seq_solucao_p 
				and	coalesce(ie_suspenso,'N') <> 'S';
					 
				--Elementos da Solução de Hemodiálise 
				insert into hd_prescr_sol_elem( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_prescricao, 
					nr_seq_solucao, 
					nr_seq_elemento, 
					cd_unidade_medida, 
					qt_elemento, 
					nr_prescricao_original) 
				SELECT	nextval('hd_prescr_sol_elem_seq'), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_prescricao_ww, 
					nr_seq_solucao_w, 
					nr_seq_elemento, 
					cd_unidade_medida, 
					qt_elemento, 
					nr_prescricao_orig_p 
				from	hd_prescr_sol_elem 
				where	nr_prescricao	= nr_prescricao_orig_p 
				and	nr_seq_solucao	= nr_seq_solucao_p;
 
				select	coalesce(max(nr_agrupamento),0), 
					coalesce(max(nr_sequencia),0) 
				into STRICT	nr_agrup_acum_w, 
					nr_seq_material_w 
				from	prescr_material 
				where	nr_prescricao = nr_prescricao_ww;
 
				insert into prescr_material( 
					nr_prescricao, 
					nr_sequencia, 
					ie_origem_inf, 
					cd_material, 
					cd_unidade_medida, 
					qt_dose, 
					qt_unitaria, 
					qt_material, 
					dt_atualizacao, 
					nm_usuario, 
					cd_intervalo, 
					ds_horarios, 
					ds_observacao, 
					ds_observacao_enf, 
					ie_via_aplicacao, 
					nr_agrupamento, 
					ie_cobra_paciente, 
					cd_motivo_baixa, 
					dt_baixa, 
					ie_utiliza_kit, 
					cd_unidade_medida_dose, 
					qt_conversao_dose, 
					ie_urgencia, 
					nr_ocorrencia, 
					qt_total_dispensar, 
					cd_fornec_consignado, 
					nr_sequencia_solucao, 
					qt_solucao, 
					hr_dose_especial, 
					qt_dose_especial, 
					ds_dose_diferenciada, 
					ie_medicacao_paciente, 
					hr_prim_horario, 
					ie_agrupador, 
					nr_dia_util, 
					ie_suspenso, 
					ie_se_necessario, 
					qt_min_aplicacao, 
					ie_bomba_infusao, 
					ie_aplic_bolus, 
					ie_aplic_lenta, 
					ie_acm, 
					ie_objetivo, 
					cd_topografia_cih, 
					ie_origem_infeccao, 
					cd_amostra_cih, 
					cd_microorganismo_cih, 
					ie_uso_antimicrobiano, 
					cd_protocolo, 
					nr_seq_protocolo, 
					nr_seq_mat_protocolo, 
					qt_hora_aplicacao, 
					ie_recons_diluente_fixo, 
					qt_vel_infusao, 
					ds_justificativa, 
					ie_sem_aprazamento, 
					ie_indicacao, 
					dt_proxima_dose, 
					qt_total_dias_lib, 
					nr_seq_substituto, 
					ie_lado, 
					dt_inicio_medic, 
					qt_dia_prim_hor, 
					ie_regra_disp, 
					qt_vol_adic_reconst, 
					qt_hora_intervalo, 
					qt_min_intervalo, 
					nr_prescricao_original)		 
				SELECT nr_prescricao_ww, 
					a.nr_sequencia + nr_seq_material_w, 
					a.ie_origem_inf, 
					a.cd_material, 
					a.cd_unidade_medida, 
					a.qt_dose, 
					a.qt_unitaria, 
					a.qt_material, 
					clock_timestamp(), 
					nm_usuario_p, 
					a.cd_intervalo, 
					a.ds_horarios, 
					a.ds_observacao, 
					a.ds_observacao_enf, 
					a.ie_via_aplicacao, 
					nr_agrup_acum_w + row_number() OVER () AS rownum, 
					coalesce(a.ie_cobra_paciente,'S'), 
					CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END , 
					CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END , 
					a.ie_utiliza_kit, 
					a.cd_unidade_medida_dose, 
					a.qt_conversao_dose, 
					'N', 
					a.nr_ocorrencia, 
					a.qt_total_dispensar, 
					a.cd_fornec_consignado, 
					nr_seq_solucao_w, 
					a.qt_solucao, 
					null, 
					null, 
					a.ds_dose_diferenciada, 
					a.ie_medicacao_paciente, 
					CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE a.hr_prim_horario END , 
					a.ie_agrupador, 
					a.nr_dia_util, 
					CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END , 
					a.ie_se_necessario, 
					a.qt_min_aplicacao, 
					a.ie_bomba_infusao, 
					coalesce(a.ie_aplic_bolus,'N'), 
					coalesce(a.ie_aplic_lenta,'N'), 
					coalesce(a.ie_acm,'N'), 
					a.ie_objetivo, 
					a.cd_topografia_cih, 
					a.ie_origem_infeccao, 
					a.cd_amostra_cih, 
					a.cd_microorganismo_cih, 
					coalesce(a.ie_uso_antimicrobiano,'N'), 
					a.cd_protocolo, 
					a.nr_seq_protocolo, 
					a.nr_seq_mat_protocolo, 
					a.qt_hora_aplicacao, 
					'N', 
					a.qt_vel_infusao, 
					a.ds_justificativa, 
					a.ie_sem_aprazamento, 
					a.ie_indicacao, 
					a.dt_proxima_dose, 
					a.qt_total_dias_lib, 
					a.nr_seq_substituto, 
					a.ie_lado, 
					a.dt_inicio_medic, 
					a.qt_dia_prim_hor, 
					CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END , 
					a.qt_vol_adic_reconst, 
					a.qt_hora_intervalo, 
					a.qt_min_intervalo, 
					nr_prescricao_orig_p 
				From	Material b, 
					Prescr_Material a 
				where	a.nr_prescricao = nr_prescricao_orig_p 
				and	a.cd_material 	= b.cd_material 
				and	a.ie_suspenso 	<> 'S' 
				and	b.ie_situacao	= 'A' 
				and	a.ie_origem_inf	<> 'K' 
				and	a.ie_agrupador in (13,14) 
				and	coalesce(a.nr_sequencia_diluicao::text, '') = '' 
				and	a.nr_sequencia_solucao = nr_seq_solucao_p 
				and	coalesce(a.nr_sequencia_proc::text, '') = ''  
				and	coalesce(a.nr_sequencia_dieta::text, '') = '';
				 
				ie_tipo_item_p	:= 'HD' || ie_tipo_dialise_w;
			/*else 
				--'Esta solução não tem nenhuma diálise vinculada a ela. #@#@');*/ 
			end if;
		end if;
		 
		nr_nova_prescricao_p	:= nr_prescricao_ww;
		nr_nova_sequencia_p	:= nr_seq_solucao_w;
		 
		if (ie_susp_sol_orig_p = 'S') then 
		 
			update	prescr_solucao 
			set	ie_modificada = 'S', 
				ie_suspenso = 'S', 
				dt_suspensao_progr = clock_timestamp(), 
				dt_suspensao = clock_timestamp() 
			where	nr_prescricao = nr_prescricao_orig_p 
			and	nr_seq_solucao	= nr_seq_solucao_p;
			 
			insert into hd_prescricao_evento( 
						nr_sequencia, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						dt_atualizacao, 
						nm_usuario, 
						nr_prescricao, 
						nr_seq_solucao, 
						nr_etapa_evento, 
						ie_evento, 
						dt_evento, 
						cd_pessoa_evento, 
						dt_ciclo) 
					values ( 
						nextval('hd_prescricao_evento_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_prescricao_orig_p, 
						nr_seq_solucao_p, 
						null, 
						'SI', 
						clock_timestamp(), 
						substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10), 
						null);
		end if;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nova_prescricao_sol ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_orig_p bigint, nr_seq_solucao_p bigint, ie_tipo_item_p INOUT text, nr_prescricoes_p text, cd_perfil_p bigint, nm_usuario_p text, ie_interv_farm_p text, ie_susp_sol_orig_p text default 'S', nr_nova_prescricao_p INOUT bigint DEFAULT NULL, nr_nova_sequencia_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

