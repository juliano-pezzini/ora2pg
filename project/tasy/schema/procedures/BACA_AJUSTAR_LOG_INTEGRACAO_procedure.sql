-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_log_integracao () AS $body$
DECLARE


cd_sistema_origem_w 	varchar(20);
cd_sistema_destino_w 	varchar(20);
nr_sequencia_w		bigint;

qt_controle_w	bigint;

c010  			integer;
retorno_w		integer;
ds_comando_cursor_w	varchar(2000) := ''||
	' select	cd_sistema_origem,' ||
	'	cd_sistema_destino,'||
	'	nr_sequencia'||
	' from	log_integracao';

BEGIN

begin

	qt_controle_w := 0;

	C010 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C010, ds_comando_cursor_w, dbms_sql.Native);
	DBMS_SQL.DEFINE_COLUMN(C010, 1, cd_sistema_origem_w,20);
	DBMS_SQL.DEFINE_COLUMN(C010, 2, cd_sistema_destino_w,20);
	DBMS_SQL.DEFINE_COLUMN(C010, 3, nr_sequencia_w);
	retorno_w := DBMS_SQL.execute(c010);
	while( DBMS_SQL.FETCH_ROWS(C010) > 0 ) loop

		DBMS_SQL.COLUMN_VALUE(C010, 1, cd_sistema_origem_w);
		DBMS_SQL.COLUMN_VALUE(C010, 2, cd_sistema_destino_w);
		DBMS_SQL.COLUMN_VALUE(C010, 3, nr_sequencia_w);
		begin

		update 	log_integracao
		set	nr_seq_sistema_origem = CASE WHEN cd_sistema_origem_w='Tasy' THEN 7 WHEN cd_sistema_origem_w='Lab' THEN 9  ELSE cd_sistema_origem_w END ,
			nr_seq_sistema_destino = CASE WHEN cd_sistema_destino_w='Tasy' THEN 7 WHEN cd_sistema_destino_w='Lab' THEN 9  ELSE cd_sistema_destino_w END
		where	nr_sequencia = nr_sequencia_w;

		qt_controle_w := qt_controle_w + 1;

		if (qt_controle_w > 10000) then
			commit;
			qt_controle_w := 1;
		end if;

		end;
	END LOOP;

	DBMS_SQL.CLOSE_CURSOR(C010);

	CALL exec_sql_dinamico('Coelho','alter table log_integracao modify nr_seq_sistema_origem not null');
	CALL exec_sql_dinamico('Coelho','alter table log_integracao modify nr_seq_sistema_destino not null');

	CALL exec_sql_dinamico('Coelho','alter table log_integracao drop column cd_sistema_origem');
	CALL exec_sql_dinamico('Coelho','alter table log_integracao drop column cd_sistema_destino');

	commit;
exception
when others then
		cd_sistema_origem_w := null;
end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_log_integracao () FROM PUBLIC;

