-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_dispositivo ( nr_seq_disp_pac_p bigint, nr_seq_reversao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_ultima_acao_w	atend_pac_dispositivo.ie_acao%type;
dt_retirada_w	atend_pac_dispositivo.dt_retirada%type;
nr_seq_reversao_w	atend_pac_disp_proc.nr_seq_reversao%type;
nr_seq_disp_proc_w	atend_pac_dispositivo.nr_sequencia%type;
nr_seq_ultima_acao_w	atend_pac_disp_proc.nr_sequencia%type;


BEGIN

ie_ultima_acao_w	:= 'N';

if (nr_seq_disp_pac_p > 0) then
	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_ultima_acao_w
	from	atend_pac_disp_proc a
	where	a.nr_seq_disp_pac = nr_seq_disp_pac_p;

	if (nr_seq_ultima_acao_w > 0) then
		select  max(a.dt_retirada),
			max(b.nr_seq_reversao),
			max(b.nr_sequencia)
		into STRICT	dt_retirada_w,
			nr_seq_reversao_w,
			nr_seq_disp_proc_w
		from    atend_pac_dispositivo a,
			atend_pac_disp_proc b
		where   a.nr_sequencia = b.nr_seq_disp_pac
		and	a.nr_sequencia = nr_seq_disp_pac_p
		and	b.nr_sequencia = nr_seq_ultima_acao_w;
	end if;
end if;

if (coalesce(dt_retirada_w::text, '') = '' and coalesce(nr_seq_reversao_w::text, '') = '') then
	ie_ultima_acao_w	:= 'I';
elsif ((dt_retirada_w IS NOT NULL AND dt_retirada_w::text <> '') and coalesce(nr_seq_reversao_w::text, '') = '') then
	ie_ultima_acao_w	:= 'R';
end if;

if (ie_ultima_acao_w = 'I') then
	update	atend_pac_dispositivo
	set	dt_retirada			=	clock_timestamp(),
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario			=	nm_usuario_p
	where	nr_sequencia	=	nr_seq_disp_pac_p;

	update	atend_pac_disp_proc
	set	nr_seq_reversao		=	nr_seq_reversao_p,
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario			=	nm_usuario_p
	where	nr_sequencia		=	nr_seq_disp_proc_w;
elsif (ie_ultima_acao_w = 'R') then
	update	atend_pac_dispositivo
	set	dt_retirada			 = NULL,
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario			=	nm_usuario_p
	where	nr_sequencia	=	nr_seq_disp_pac_p;

	update	atend_pac_disp_proc
	set	nr_seq_reversao		=	nr_seq_reversao_p,
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario			=	nm_usuario_p
	where	nr_sequencia		=	nr_seq_disp_proc_w;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1211153);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_dispositivo ( nr_seq_disp_pac_p bigint, nr_seq_reversao_p bigint, nm_usuario_p text) FROM PUBLIC;

