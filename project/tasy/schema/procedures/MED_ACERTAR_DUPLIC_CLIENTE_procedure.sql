-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_acertar_duplic_cliente (cd_pessoa_origem_p text, cd_pessoa_destino_p text, nm_usuario_p text) AS $body$
DECLARE


cd_medico_w		varchar(10);
nr_seq_orig_w		bigint;
nr_seq_dest_w		bigint;
qt_diag_w		bigint;
qt_cons_w		bigint;
qt_ant_neo_w		bigint;

ds_encaminhamento_w	varchar(40);
nr_seq_classif_w	bigint;
cd_convenio_w		integer;
nr_seq_plano_w		bigint;
cd_usuario_convenio_w	varchar(30);
dt_validade_carteira_w	timestamp;
dt_primeira_consulta_w	timestamp;
dt_ultima_consulta_w	timestamp;
dt_ultima_atualiz_w	timestamp;
dt_ultima_visualiz_w	timestamp;
ie_ficha_papel_w	varchar(1);
ie_exame_consultorio_w	varchar(1);
ie_exame_virtual_w	varchar(1);
ie_gemelar_w		varchar(1);
ie_pais_separados_w	varchar(1);
ds_observacao_w		varchar(2000);

c01 CURSOR FOR
	SELECT	cd_medico
	FROM 	med_cliente
	WHERE 	cd_pessoa_fisica = cd_pessoa_origem_p
	GROUP BY cd_medico;

c02 CURSOR FOR
	SELECT	nr_sequencia
	FROM	med_cliente
	WHERE	cd_medico		= cd_medico_w
	AND	cd_pessoa_fisica	= cd_pessoa_origem_p;


BEGIN

OPEN	c01;
LOOP
FETCH	c01 INTO cd_medico_w;
	BEGIN
	EXIT WHEN NOT FOUND; /* apply on c01 */

	OPEN	c02;
	LOOP
	FETCH	c02 INTO nr_seq_orig_w;
		BEGIN
		EXIT WHEN NOT FOUND; /* apply on c02 */

		SELECT	coalesce(MAX(nr_sequencia),0)
		INTO STRICT	nr_seq_dest_w
		FROM	med_cliente
		WHERE	cd_pessoa_fisica	= cd_pessoa_destino_p
		AND	cd_medico		= cd_medico_w;


		IF (nr_seq_dest_w > 0) THEN
			BEGIN

			/* Atendimento */

			UPDATE	med_atendimento
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* CID */

			UPDATE	med_pac_cid
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Diagnostico */

			SELECT	COUNT(*)
			INTO STRICT	qt_diag_w
			FROM 	med_pac_diagnostico
			WHERE	nr_seq_cliente	= nr_seq_dest_w;

			IF (qt_diag_w = 0) THEN
				UPDATE	med_pac_diagnostico
				SET	nr_seq_cliente	= nr_seq_dest_w
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			ELSE
				DELETE	FROM med_pac_diagnostico
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			END IF;

			/* Antecedente Neonatal */

			SELECT	COUNT(*)
			INTO STRICT	qt_ant_neo_w
			FROM 	MED_ANTECEDENTE_NEONATAL
			WHERE	nr_seq_cliente	= nr_seq_dest_w;

			IF (qt_ant_neo_w = 0) THEN
				UPDATE	MED_ANTECEDENTE_NEONATAL
				SET	nr_seq_cliente	= nr_seq_dest_w
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			ELSE
				DELETE	FROM MED_ANTECEDENTE_NEONATAL
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			END IF;


			/* Pedido Exame */

			UPDATE	med_pedido_exame
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Evolucao */

			UPDATE	med_evolucao
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Receita */

			UPDATE	med_Receita
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Resultado de exames */

			UPDATE	med_result_exame
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Texto Adicional */

			UPDATE	med_texto_adicional
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Exame Avaliacao */

			UPDATE	med_exame_avaliacao
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Consulta */

			SELECT	COUNT(*)
			INTO STRICT	qt_cons_w
			FROM 	med_consulta
			WHERE	nr_seq_cliente	= nr_seq_dest_w;


			IF (qt_cons_w = 0) THEN
				UPDATE	med_consulta
				SET	nr_seq_cliente	= nr_seq_dest_w
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			ELSE
				DELETE FROM med_consulta
				WHERE	nr_seq_cliente	= nr_seq_orig_w;
			END IF;

			/* Atestado */

			UPDATE	med_atestado
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Alerta */

			UPDATE	med_alerta
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Parecer MÃ©dico */

			UPDATE	med_parecer_medico
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Seguranca */

			UPDATE	med_seguranca
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;

			/* Tratamento */

			UPDATE	med_tratamento
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;

			/* Pre Natal */

			UPDATE	med_pac_pre_natal
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;

			/* Ginecologia */

			UPDATE	med_pac_ginecologia
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;

			/* Avaliacao */

			UPDATE	med_aval_completa_pac
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Sinal Vital */

			UPDATE	med_pac_sinal_vital
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;


			/* Contato */

			UPDATE	med_pac_contato
			SET	nr_seq_cliente	= nr_seq_dest_w
			WHERE	nr_seq_cliente	= nr_seq_orig_w;

			/* Levar dados da ficha de origem para o destino */

			select	coalesce(b.ds_encaminhamento, a.ds_encaminhamento),
				coalesce(b.nr_seq_classif, a.nr_seq_classif),
				coalesce(b.cd_convenio, a.cd_convenio),
				coalesce(b.nr_seq_plano, a.nr_seq_plano),
				coalesce(b.cd_usuario_convenio, a.cd_usuario_convenio),
				coalesce(b.dt_validade_carteira, a.dt_validade_carteira),
				coalesce(b.dt_primeira_consulta, a.dt_primeira_consulta),
				coalesce(b.dt_ultima_consulta, a.dt_ultima_consulta),
				coalesce(b.dt_ultima_atualiz, a.dt_ultima_atualiz),
				coalesce(b.dt_ultima_visualiz, a.dt_ultima_visualiz),
				coalesce(b.ie_ficha_papel, a.ie_ficha_papel),
				coalesce(b.ie_exame_consultorio, a.ie_exame_consultorio),
				coalesce(b.ie_exame_virtual, a.ie_exame_virtual),
				coalesce(b.ie_gemelar, a.ie_gemelar),
				coalesce(b.ie_pais_separados, a.ie_pais_separados),
				coalesce(b.ds_observacao, a.ds_observacao)
			into STRICT	ds_encaminhamento_w,
				nr_seq_classif_w,
				cd_convenio_w,
				nr_seq_plano_w,
				cd_usuario_convenio_w,
				dt_validade_carteira_w,
				dt_primeira_consulta_w,
				dt_ultima_consulta_w,
				dt_ultima_atualiz_w,
				dt_ultima_visualiz_w,
				ie_ficha_papel_w,
				ie_exame_consultorio_w,
				ie_exame_virtual_w,
				ie_gemelar_w,
				ie_pais_separados_w,
				ds_observacao_w
			from	med_cliente a,
				med_cliente b
			where	a.nr_sequencia = nr_seq_orig_w
			and	b.nr_sequencia = nr_seq_dest_w;

			update	med_cliente
			set	ds_encaminhamento	= ds_encaminhamento_w,
				nr_seq_classif		= nr_seq_classif_w,
				cd_convenio		= cd_convenio_w,
				nr_seq_plano		= nr_seq_plano_w,
				cd_usuario_convenio	= cd_usuario_convenio_w,
				dt_validade_carteira	= dt_validade_carteira_w,
				dt_primeira_consulta	= dt_primeira_consulta_w,
				dt_ultima_consulta	= dt_ultima_consulta_w,
				dt_ultima_atualiz	= dt_ultima_atualiz_w,
				dt_ultima_visualiz	= dt_ultima_visualiz_w,
				ie_ficha_papel		= ie_ficha_papel_w,
				ie_exame_consultorio	= ie_exame_consultorio_w,
				ie_exame_virtual	= ie_exame_virtual_w,
				ie_gemelar		= ie_gemelar_w,
				ie_pais_separados	= ie_pais_separados_w,
				ds_observacao		= ds_observacao_w
			where	nr_sequencia		= nr_seq_dest_w;

			END;

			/* Deletar o origem */

			DELETE FROM med_cliente
			WHERE	nr_sequencia	= nr_seq_orig_w;

		ELSE
			BEGIN

			UPDATE	med_cliente
			SET	cd_pessoa_fisica	= cd_pessoa_destino_p
			WHERE	nr_sequencia		= nr_seq_orig_w
			AND	cd_medico		= cd_medico_w;

			END;
		END IF;
		END;
	END LOOP;
	CLOSE c02;

	END;
END LOOP;
CLOSE c01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_acertar_duplic_cliente (cd_pessoa_origem_p text, cd_pessoa_destino_p text, nm_usuario_p text) FROM PUBLIC;

