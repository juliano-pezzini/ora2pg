-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixa_titulo_retorno_convenio ( nr_conv_ret_sequencia_p bigint, vl_recebido_p bigint, vl_descontos_p bigint, vl_juros_p bigint, vl_multa_p bigint, vl_rec_maior_p bigint, vl_glosa_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


nr_seq_tit_rec_liq_w    titulo_receber_liq.nr_sequencia%type;
cd_estabelecimento_w    estabelecimento.cd_estabelecimento%type;
cd_moeda_w		integer;
dt_referencia_w		timestamp;
cd_tipo_receb_perda_w	parametro_contas_receber.cd_tipo_receb_perda%type;

c_itens CURSOR FOR
	SELECT	d.nr_titulo,
		d.vl_titulo,
		d.nr_seq_protocolo,
		d.nr_seq_nf_saida,
		d.nr_nota_fiscal
	from 	convenio_retorno a,
		protocolo_convenio b,
		nota_fiscal c,
		titulo_receber d
	where	a.nr_seq_protocolo = b.nr_seq_protocolo
	and	b.nr_seq_protocolo = c.nr_seq_protocolo
	and	c.nr_seq_protocolo = d.nr_seq_protocolo
	and	c.nr_sequencia = d.nr_seq_nf_saida
	and	c.nr_nota_fiscal = d.nr_nota_fiscal
	and	a.nr_sequencia = nr_conv_ret_sequencia_p;
	
BEGIN


dt_referencia_w			:= clock_timestamp();
cd_estabelecimento_w    := coalesce(cd_estabelecimento_p , wheb_usuario_pck.get_cd_estabelecimento);


begin
select	cd_moeda_padrao,
	cd_tipo_receb_perda
into STRICT	cd_moeda_w,
	cd_tipo_receb_perda_w
from	parametro_contas_receber
where	cd_estabelecimento = cd_estabelecimento_w  LIMIT 1;
exception
when others then
    cd_moeda_w        		:= null;
    cd_tipo_receb_perda_w   := null;
end;



if (coalesce(cd_tipo_receb_perda_w::text, '') = '' ) then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1133027);
else

	for c_itens_w in c_itens loop
	
		select	max(t.nr_sequencia) + 1 
		into STRICT	nr_seq_tit_rec_liq_w  
		from	titulo_receber_liq t
		where	t.NR_TITULO = c_itens_w.NR_TITULO;

		insert into titulo_receber_liq(
					nr_sequencia,
					nr_titulo,
					dt_recebimento,
					dt_atualizacao,
					vl_recebido,
					vl_descontos,
					vl_juros,
					vl_multa,
					cd_moeda,
					cd_tipo_recebimento,
					vl_rec_maior,
					vl_glosa,
					nm_usuario,
					ie_acao,
					ie_lib_caixa
		)
		values (
					nr_seq_tit_rec_liq_w,
					c_itens_w.nr_titulo,
					dt_referencia_w,
					dt_referencia_w,
					vl_recebido_p,			
					vl_descontos_p,
					vl_juros_p,
					vl_multa_p,
					cd_moeda_w,
					cd_tipo_receb_perda_w,
					vl_rec_maior_p,
					vl_glosa_p,
					nm_usuario_p,
					'I',
					'S'
		);


		CALL atualizar_saldo_tit_rec(c_itens_w.nr_titulo, nm_usuario_p);


	end	loop;
end	if;
	
commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixa_titulo_retorno_convenio ( nr_conv_ret_sequencia_p bigint, vl_recebido_p bigint, vl_descontos_p bigint, vl_juros_p bigint, vl_multa_p bigint, vl_rec_maior_p bigint, vl_glosa_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

