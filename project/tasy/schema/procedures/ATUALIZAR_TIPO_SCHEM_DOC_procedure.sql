-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_tipo_schem_doc (nr_sequencia_p bigint, nm_usuario_p text, ds_documentacao_p text) AS $body$
DECLARE


ds_doc_w		text := '';
ds_doc_fim_w		text := EMPTY_CLOB;
ds_documentacao_w	text := EMPTY_CLOB;
ds_doc_ant_w		text := EMPTY_CLOB;

nm_pessoa_fisica_w	varchar(255);
ds_sql_w		varchar(2000);
c001			integer;
retorno_w		integer;

ds_conteudo_1_w		varchar(32764);
ds_conteudo_2_w		varchar(32764);

C02 CURSOR(nr_seq	tipo_schem_doc.nr_sequencia%type) FOR
	SELECT	ds_documentacao
	from	tipo_schem_doc
	where	nr_sequencia = nr_seq;

BEGIN

select	obter_nome_usuario(nm_usuario_p)
into STRICT	nm_pessoa_fisica_w
;

select	(
	'<pre>__________________________________________________________</pre>'||
	'<p><strong>Added by: '||nm_pessoa_fisica_w||' - '||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')||'</strong></p>'||
	'<p>'||chr(38)||'nbsp;</p>')
into STRICT	ds_doc_w
;

select	('<p>'||chr(38)||'nbsp;</p><p>__________________________________________________________</p>')
into STRICT	ds_doc_fim_w
;


dbms_lob.createtemporary(ds_documentacao_w, true, dbms_lob.session);
dbms_lob.open(ds_documentacao_w, dbms_lob.lob_readwrite);
--Abre o cursor e armazena o conte√∫do no CLOB
for r_c02_w in C02(nr_sequencia_p) loop
	begin

	ds_doc_ant_w := r_c02_w.ds_documentacao;

	dbms_lob.append(ds_documentacao_w, ds_doc_ant_w);
	dbms_lob.append(ds_documentacao_w, ds_doc_w);
	dbms_lob.append(ds_documentacao_w, ds_documentacao_p);
	dbms_lob.append(ds_documentacao_w, ds_doc_fim_w);

	end;
end loop;

/*INICIO - QUEBRA O VALOR DO CONTEUDO CLOB EM VARIOS VARCHAR PARA PODER INSERIR NA TABELA DE ORIGEM*/

ds_conteudo_1_w := substr(ds_documentacao_w,32764,1);
ds_conteudo_2_w := substr(ds_documentacao_w,32764,32765);
/*FIM QUEBRA O VALOR DO CONTEUDO CLOB EM VARIOS VARCHAR PARA PODER INSERIR NA TABELA DE ORIGEM*/

ds_sql_w	:= ' update tipo_schem_doc set ds_documentacao = :ds_texto where nr_sequencia ='||nr_sequencia_p;
c001 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(c001, ds_sql_w, dbms_sql.Native);
DBMS_SQL.BIND_VARIABLE(c001, 'DS_TEXTO', ds_conteudo_1_w || ds_conteudo_2_w );

retorno_w := DBMS_SQL.EXECUTE(c001);
DBMS_SQL.CLOSE_CURSOR(c001);

dbms_lob.freetemporary(ds_documentacao_w);

CALL GRAVAR_TIPO_SCHEM_DOC_REACAO(nm_usuario_p,nr_sequencia_p,3,null);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_tipo_schem_doc (nr_sequencia_p bigint, nm_usuario_p text, ds_documentacao_p text) FROM PUBLIC;

