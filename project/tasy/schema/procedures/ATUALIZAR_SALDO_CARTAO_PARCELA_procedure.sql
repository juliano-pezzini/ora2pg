-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_cartao_parcela (nr_seq_parcela_p bigint, nm_usuario_p text) AS $body$
DECLARE

vl_baixa_w		double precision;
vl_saldo_liquido_w	double precision;
vl_liquido_w		double precision;
vl_desp_equip_w		double precision;
nr_seq_movto_w		bigint;
nr_autorizacao_w	varchar(40);
dt_parcela_w		timestamp;
vl_antecip_w  		double precision;


BEGIN

if (nr_seq_parcela_p IS NOT NULL AND nr_seq_parcela_p::text <> '') then
	select	coalesce(sum(vl_baixa),0),
		coalesce(sum(vl_desp_equip),0)
	into STRICT	vl_baixa_w,
		vl_desp_equip_w
	from	movto_cartao_cr_baixa
	where	nr_seq_parcela	= nr_seq_parcela_p;

	select	coalesce(max(vl_liquido),0),
		max(dt_parcela),
		max(nr_seq_movto),
		coalesce(max(vl_antecip),0)
	into STRICT	vl_liquido_w,
		dt_parcela_w,
		nr_seq_movto_w,
		vl_antecip_w
	from	movto_cartao_cr_parcela
	where	nr_sequencia	= nr_seq_parcela_p;

	select	max(nr_autorizacao)
	into STRICT	nr_autorizacao_w
	from	movto_cartao_cr
	where	nr_sequencia	= nr_seq_movto_w;

	vl_saldo_liquido_w	:= coalesce(vl_liquido_w,0) - (coalesce(vl_baixa_w,0) + coalesce(vl_desp_equip_w,0)) - coalesce(vl_antecip_w,0);

	if (vl_saldo_liquido_w >= 0) then
		update	movto_cartao_cr_parcela
		set	vl_saldo_liquido	= vl_saldo_liquido_w,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_parcela_p;
	else
		/*O valor das baixas supera o saldo da parcela !
		Aut: nr_autorizacao_w. Dt parcela: dt_parcela_w
		Vl parcela: vl_liquido_w. Vl baixa: (nvl(vl_baixa_w,0) + nvl(vl_desp_equip_w,0)) */
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262161,	'NR_AUTORIZACAO_W=' || nr_autorizacao_w ||
								';DT_PARCELA_W=' || dt_parcela_w ||
								';VL_LIQUIDO_W=' || vl_liquido_w ||
								';VL_BAIXA_W=' || (coalesce(vl_baixa_w,0) + coalesce(vl_desp_equip_w,0)));


	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_cartao_parcela (nr_seq_parcela_p bigint, nm_usuario_p text) FROM PUBLIC;

