-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_aprovar_resultado_bco ( ds_sigla_padrao_p text, nr_prescricao_p bigint, nr_seq_amostra_p bigint, cd_exame_p text, nm_usuario_aprov_p text, dt_aprovacao_p timestamp, ds_erro_p INOUT text) AS $body$
DECLARE



nr_seq_prescr_w			bigint;
nr_seq_result_w			bigint;
ie_status_receb_w		smallint;
ie_aprovar_todos_interf_w	varchar(1);
ds_consistencia_w		varchar(4000);
qt_exames_consist_w		integer;


BEGIN

begin

select 	max(p.nr_sequencia)
into STRICT	nr_seq_prescr_w
from	prescr_procedimento p,
	exame_laboratorio e
where	p.nr_prescricao = nr_prescricao_p
and	p.nr_seq_exame 	= e.nr_seq_exame
and	coalesce(e.cd_exame_integracao, e.cd_exame) = cd_exame_p;

if (coalesce(nr_seq_prescr_w::text, '') = '') then

	select 	max(p.nr_sequencia)
	into STRICT	nr_seq_prescr_w
	from	prescr_procedimento p
	where	p.nr_prescricao	= nr_prescricao_p
	and	p.nr_seq_exame	= obter_equip_exame_integracao(cd_exame_p,ds_sigla_padrao_p,1);

end if;

select	max(nr_seq_resultado)
into STRICT	nr_seq_result_w
from	exame_lab_resultado
where	nr_prescricao = nr_prescricao_p;


select	coalesce(max(b.ie_status_receb),35),
	coalesce(max(b.ie_aprovar_todos_interf),'S')
into STRICT	ie_status_receb_w,
	ie_aprovar_todos_interf_w
from	lab_parametro b,
	prescr_medica a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_prescricao		= nr_prescricao_p;


ds_consistencia_w := '';
if (ie_aprovar_todos_interf_w = 'N') then

	ds_consistencia_w := Consistir_Aprovacao_Exame(nr_prescricao_p, nr_seq_prescr_w, ds_consistencia_w);

	if (ds_consistencia_w <> '' AND ie_status_receb_w = 35) then
		ie_status_receb_w := 30;
	end if;

end if;


if (ie_status_receb_w = 35) then

	qt_exames_consist_w := consitir_valores_interf_aprov(nr_seq_result_w, nr_seq_prescr_w, qt_exames_consist_w);

	if (qt_exames_consist_w > 0) then
		ie_status_receb_w := 30;
	end if;

end if;

update 	prescr_procedimento
set 	ie_status_atend = ie_status_receb_w,
	dt_atualizacao 	= clock_timestamp(),
	nm_usuario 	= nm_usuario_aprov_p
where nr_prescricao 	= nr_prescricao_p
  and nr_sequencia 	= nr_seq_prescr_w
  and ie_status_atend 	= 30;


if (ie_status_receb_w >= 35) then

	update 	exame_lab_result_item
	set	dt_aprovacao		= dt_aprovacao_p,
		nm_usuario_aprovacao	= nm_usuario_aprov_p,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_aprov_p
	where	nr_seq_resultado	= nr_seq_result_w
	  and	nr_seq_prescr		= nr_seq_prescr_w
	  and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

end if;


exception
when others then
	ds_erro_p := substr(sqlerrm,1,2000);
end;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_aprovar_resultado_bco ( ds_sigla_padrao_p text, nr_prescricao_p bigint, nr_seq_amostra_p bigint, cd_exame_p text, nm_usuario_aprov_p text, dt_aprovacao_p timestamp, ds_erro_p INOUT text) FROM PUBLIC;

