-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE trocar_composicao_padrao ( nr_sequencia_p bigint, nr_seq_dieta_p bigint, ds_ret_mensagem INOUT text) AS $body$
DECLARE


dieta_comp_serv_cur CURSOR(nr_sequencia_p bigint, nr_seq_dieta_p bigint) FOR
    SELECT DISTINCT dc.*
    FROM nut_composicao n_new, dieta_comp_servico dc_new, dieta_comp_servico dc, nut_composicao nc
    WHERE   dc_new.nr_sequencia = nr_sequencia_p
        AND dc_new.nr_seq_dieta = nr_seq_dieta_p
        AND n_new.nr_sequencia = dc_new.nr_seq_composicao_serv
        AND dc_new.nr_seq_composicao_serv = n_new.nr_sequencia
        AND dc.nr_seq_dieta = dc_new.nr_seq_dieta
        AND dc.nr_sequencia <> dc_new.nr_sequencia
        AND dc.nr_seq_composicao_serv = nc.nr_sequencia
        AND dc.ie_comp_padrao = 'S'
        AND (coalesce(nc.ie_beverage,'N') = n_new.ie_beverage OR coalesce(nc.ie_beverage,'N') = 'N')
        AND (coalesce(nc.ie_staple_food,'N') = n_new.ie_staple_food OR coalesce(nc.ie_staple_food,'N') = 'N');
BEGIN
    ds_ret_mensagem := 'N';
    FOR dieta_comp_serv_ele_w IN dieta_comp_serv_cur(nr_sequencia_p,nr_seq_dieta_p)
    LOOP

        UPDATE dieta_comp_servico
        SET ie_comp_padrao = 'N'
        WHERE nr_sequencia = dieta_comp_serv_ele_w.nr_sequencia;
        ds_ret_mensagem := 'S';
    END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE trocar_composicao_padrao ( nr_sequencia_p bigint, nr_seq_dieta_p bigint, ds_ret_mensagem INOUT text) FROM PUBLIC;

