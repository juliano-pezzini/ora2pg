-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_reg_0035_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_scp_p bigint, ds_separador_p text, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nome_scp_w			pessoa_juridica.ds_razao_social%type;
cod_scp_w			estabelecimento.cd_cgc%type;
tp_registro_w			varchar(4);
inf_complementar_w		varchar(100);
nr_linha_w			bigint := qt_linha_p;
nr_seq_registro_w		bigint := nr_sequencia_p;
ds_arquivo_w			varchar(4000);
ds_arquivo_compl_w		varchar(4000);
ds_linha_w			varchar(8000);
sep_w				varchar(1) := ds_separador_p;
ie_scp_w			fis_efd_controle.ie_scp%type;
	
c01 CURSOR FOR
	SELECT	'0035' tp_registro,
		a.cd_cgc cod_scp,
		d.ds_razao_social nome_scp,
		''
	from	estabelecimento a,
		pessoa_juridica	d
	where	a.cd_cgc	= d.cd_cgc
	and	a.cd_empresa = cd_empresa_p
	and	d.ie_situacao	= 'A'
	and	a.ie_situacao	= 'A'
	and	coalesce(a.ie_gerar_sped,'S') = 'S'
	and	((ie_scp_w = 'N' AND a.ie_scp = 'S') or
		(ie_scp_w = 'S' AND a.cd_estabelecimento = cd_estabelecimento_scp_p));
		

BEGIN

	if coalesce(cd_estabelecimento_scp_p::text, '') = '' then
		ie_scp_w := 'N';
	else
		ie_scp_w := 'S';
	end if;

	open C01;
	loop
	fetch C01 into	
		tp_registro_w,
		cod_scp_w,
		nome_scp_w,
		inf_complementar_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	
		ds_linha_w	:= substr(	sep_w || tp_registro_w 		||
					sep_w || cod_scp_w		||
					sep_w || nome_scp_w		||
					sep_w || inf_complementar_w	|| sep_w, 1, 8000);
		
		ds_arquivo_w		:= substr(ds_linha_w, 1, 4000);
		ds_arquivo_compl_w	:= substr(ds_linha_w, 4001, 4000);
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		nr_linha_w		:= nr_linha_w + 1;

		insert into fis_efd_arquivo(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_controle_efd,
			nr_linha,
			cd_registro,
			ds_arquivo,
			ds_arquivo_compl)
		values (	nr_seq_registro_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_controle_p,
			nr_linha_w,
			'0035',
			ds_arquivo_w,
			ds_arquivo_compl_w);
		end;
	end loop;
	close C01;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_reg_0035_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_scp_p bigint, ds_separador_p text, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

