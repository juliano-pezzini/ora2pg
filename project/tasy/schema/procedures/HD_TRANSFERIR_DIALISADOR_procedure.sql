-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_transferir_dialisador ( ie_tipo_p text, nr_seq_unid_origem_p bigint, nr_seq_unid_destino_p bigint, nr_seq_dialisador_p bigint, nr_seq_motivo_transf_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w			smallint;
cd_estabelecimento_destino_w 	smallint;


BEGIN 
if (ie_tipo_p = 'I') then 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	hd_unidade_dialise 
	where	nr_sequencia		= nr_seq_unid_destino_p;
elsif (ie_tipo_p = 'E') then 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	hd_unidade_dialise 
	where	nr_sequencia		= nr_seq_unid_origem_p;
end if;
 
select	max(cd_estabelecimento) 
into STRICT	cd_estabelecimento_destino_w 
from 	hd_unidade_dialise 
where 	nr_sequencia = nr_seq_unid_destino_p;
 
if (nr_seq_unid_origem_p = nr_seq_unid_destino_p) then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(278354,null);
elsif (coalesce(cd_estabelecimento_w::text, '') = '') then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(278356,null);
elsif (nr_seq_unid_destino_p = 0) then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(278357,null);
elsif (nr_seq_dialisador_p = 0) then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279947,null);
elsif (nr_seq_motivo_transf_p = 0) then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279948,null);
elsif (coalesce(cd_estabelecimento_destino_w::text, '') = '') then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(278356,null);
else 
	update	hd_dializador 
	set	ie_status		 	= 'T', 
		nr_seq_motivo_transf	 	= nr_seq_motivo_transf_p, 
		nr_seq_unid_dialise_atual	= nr_seq_unid_destino_p 
	where	nr_sequencia		 	= nr_seq_dialisador_p;
		 
	insert into hd_dialisador_transf( 
		nr_sequencia, 
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_dialisador, 
		nr_seq_unid_origem, 
		nr_seq_unid_destino, 
		dt_transferencia, 
		cd_pf_transf, 
		ie_tipo, 
		nr_seq_motivo_transf 
	) values ( 
		nextval('hd_dialisador_transf_seq'), 
		cd_estabelecimento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_dialisador_p, 
		nr_seq_unid_origem_p, 
		nr_seq_unid_destino_p, 
		clock_timestamp(), 
		substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10), 
		ie_tipo_p, 
		nr_seq_motivo_transf_p 
	);
end if;
				 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_transferir_dialisador ( ie_tipo_p text, nr_seq_unid_origem_p bigint, nr_seq_unid_destino_p bigint, nr_seq_dialisador_p bigint, nr_seq_motivo_transf_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

