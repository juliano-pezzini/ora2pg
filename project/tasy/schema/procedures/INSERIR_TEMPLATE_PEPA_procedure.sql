-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_template_pepa ( nr_seq_tipo_cons_pepa_p atend_consulta_pepa.nr_sequencia%type, nr_seq_tipo_temp_p ehr_tipo_reg_item.nr_seq_template%type, nm_usuario_p usuario.nm_usuario%type, ie_acao_p text default 'V', nr_sequencia_ehr_p INOUT ehr_registro.nr_sequencia%type DEFAULT NULL, nr_seq_reg_template_p INOUT ehr_reg_template.nr_seq_template%type  DEFAULT NULL) AS $body$
DECLARE

	
	nr_sequencia_ehr_w	ehr_registro.nr_sequencia%type;
	nr_seq_reg_template_w	ehr_reg_template.nr_sequencia%type;
	cd_paciente_w		pessoa_fisica.cd_pessoa_fisica%type;
	nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
	cd_profissional_w	pessoa_fisica.cd_pessoa_fisica%type;
	ie_nivel_atencao_w  atend_consulta_pepa.ie_nivel_atencao%type;


BEGIN
	
	if (nr_seq_tipo_cons_pepa_p IS NOT NULL AND nr_seq_tipo_cons_pepa_p::text <> '') and (nr_seq_tipo_temp_p IS NOT NULL AND nr_seq_tipo_temp_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
		select coalesce(max(nr_sequencia),0) nr_sequencia
		into STRICT nr_sequencia_ehr_w	
		from ehr_registro
		where nr_seq_atend_cons_pepa = nr_seq_tipo_cons_pepa_p
		and nr_seq_templ = nr_seq_tipo_temp_p
		and ((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or nm_usuario = nm_usuario_p)
		and coalesce(dt_inativacao::text, '') = ''
		and ie_acao_p = 'V';
		
		if (nr_sequencia_ehr_w = 0 and ie_acao_p <> 'SV')	then
		
			select cd_pessoa_fisica, nr_atendimento, cd_medico , ie_nivel_atencao
			into STRICT cd_paciente_w, nr_atendimento_w, cd_profissional_w, ie_nivel_atencao_w
			from atend_consulta_pepa
			where nr_sequencia = nr_seq_tipo_cons_pepa_p;

			if (cd_paciente_w IS NOT NULL AND cd_paciente_w::text <> '') and (cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') then
			
				select	nextval('ehr_registro_seq')
				into STRICT	nr_sequencia_ehr_w
				;
				
				insert into ehr_registro(
					nr_sequencia,
					cd_paciente,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_atend_cons_pepa,
					dt_registro,
					cd_profissional,
					nr_atendimento,
                    ie_nivel_atencao,
					dt_liberacao)
				values (
					nr_sequencia_ehr_w,
					cd_paciente_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_tipo_cons_pepa_p,
					clock_timestamp(),
					cd_profissional_w,
					nr_atendimento_w,
					ie_nivel_atencao_w,
					null);
				---------------------------------------------------------
				
				select	nextval('ehr_reg_template_seq')
				into STRICT	nr_seq_reg_template_w
				;

				insert into ehr_reg_template(
					nr_sequencia,
					nr_seq_reg,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_registro,
					nr_seq_template,
					dt_liberacao)
				values (
					nr_seq_reg_template_w,
					nr_sequencia_ehr_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_seq_tipo_temp_p,
					null);
				commit;
			end if;
		end if;
		nr_sequencia_ehr_p := ehr_obter_reg_template(nr_sequencia_ehr_w, 'R');
		nr_seq_reg_template_p := ehr_obter_reg_template(nr_sequencia_ehr_w, 'T');
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_template_pepa ( nr_seq_tipo_cons_pepa_p atend_consulta_pepa.nr_sequencia%type, nr_seq_tipo_temp_p ehr_tipo_reg_item.nr_seq_template%type, nm_usuario_p usuario.nm_usuario%type, ie_acao_p text default 'V', nr_sequencia_ehr_p INOUT ehr_registro.nr_sequencia%type DEFAULT NULL, nr_seq_reg_template_p INOUT ehr_reg_template.nr_seq_template%type  DEFAULT NULL) FROM PUBLIC;

