-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_classif_tit_imposto (nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_titulo_w		bigint;
nr_sequencia_w		integer;
cd_conta_contabil_w	varchar(20);
cd_centro_custo_w	integer;
cd_conta_financ_w	bigint;
vl_classif_w		double precision;
vl_diferenca_w		double precision;
vl_saldo_titulo_w	double precision;
vl_tributo_w		double precision;
nr_seq_conta_financ_w	bigint;
ds_erro_w		varchar(4000);

c01 CURSOR FOR 
SELECT	b.nr_titulo, 
	a.vl_imposto, 
	a.cd_conta_financ 
from	titulo_pagar b, 
	titulo_pagar_imposto a 
where	b.nr_seq_tributo	= a.nr_sequencia	 
and	a.nr_titulo		= nr_titulo_p;

c02 CURSOR FOR 
SELECT	cd_conta_contabil, 
	cd_centro_custo, 
	coalesce(cd_conta_financ_w, nr_seq_conta_financ), 
	vl_titulo 
from	titulo_pagar_classif 
where	nr_titulo	= nr_titulo_p;


BEGIN 
 
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then 
	begin 
 
	vl_saldo_titulo_w	:= (obter_dados_tit_pagar(nr_titulo_p, 'VT'))::numeric;
 
	open c01;
	loop 
	fetch c01 into 
		nr_titulo_w, 
		vl_tributo_w, 
		cd_conta_financ_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
		delete	from	titulo_pagar_classif 
		where	nr_titulo	= nr_titulo_w;
 
		open c02;
		loop 
		fetch c02 into 
			cd_conta_contabil_w, 
			cd_centro_custo_w, 
			nr_seq_conta_financ_w, 
			vl_classif_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
	 
			vl_classif_w	:= (vl_tributo_w * dividir_sem_round(vl_classif_w, vl_saldo_titulo_w));
 
			select	coalesce(max(nr_sequencia), 0) + 1 
			into STRICT	nr_sequencia_w 
			from	titulo_pagar_classif 
			where	nr_titulo		= nr_titulo_w;
 
			insert into titulo_pagar_classif( 
				nr_titulo, nr_sequencia, vl_titulo, 
				dt_atualizacao, nm_usuario, 
				cd_conta_contabil, cd_centro_custo, 
				nr_seq_conta_financ) 
			values ( 
				nr_titulo_w, nr_sequencia_w, vl_classif_w, 
				clock_timestamp(), nm_usuario_p, 
				cd_conta_contabil_w, cd_centro_custo_w, 
				nr_seq_conta_financ_w);
 
		end loop;
		close c02;
 
		select	coalesce(sum(vl_titulo),0) 
		into STRICT	vl_classif_w 
		from	titulo_pagar_classif 
		where	nr_titulo	= nr_titulo_w;
 
		vl_diferenca_w	:= vl_tributo_w - vl_classif_w;
	 
		update	titulo_pagar_classif 
		set	vl_titulo	= vl_titulo + vl_diferenca_w 
		where	nr_titulo	= nr_titulo_w 
		and	nr_sequencia	= nr_sequencia_w;
 
	end loop;
	close c01;
 
	exception 
	when others then 
		ds_erro_w	:= sqlerrm(SQLSTATE);
		-- Erro ao inserir classificação do título de imposto. #@DS_ERRO#@ 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266951, 'DS_ERRO=' || ds_erro_w);
	end;
 
commit;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_classif_tit_imposto (nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

