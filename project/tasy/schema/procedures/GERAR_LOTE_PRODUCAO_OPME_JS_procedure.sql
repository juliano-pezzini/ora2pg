-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_producao_opme_js ( cd_setor_atendimento_p bigint, nr_ficha_tecnica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_lote_producao_p INOUT bigint, nr_prescricao_p bigint) AS $body$
DECLARE

 
cd_material_w			integer;
cd_unidade_medida_consumo_w	varchar(30);
cd_setor_atendimento_w		integer;
cd_local_estoque_w		smallint;
nr_lote_producao_w		bigint;
ie_lancar_conta_w		varchar(1);

cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_atendimento_w		bigint;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w		timestamp;
cd_setor_atend_prescr_w		bigint;
dt_prescricao_w			timestamp;
nr_interno_conta_w		bigint;

C01 CURSOR FOR 
	SELECT a.cd_procedimento, 
	    a.ie_origem_proced, 
	    b.nr_atendimento, 
	    b.dt_inicio_prescr, 
	    b.dt_validade_prescr, 
	    b.cd_setor_atendimento, 
	    dt_prescricao 
	from  prescr_opm a, 
	    prescr_medica b 
	where a.nr_prescricao		= b.nr_prescricao 
	and  b.nr_prescricao 		= nr_prescricao_p	 
	order by 1;


BEGIN 
 
ie_lancar_conta_w := obter_param_usuario(10025, 15, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_p, ie_lancar_conta_w);
 
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
 
	select	cd_local_estoque 
	into STRICT	cd_local_estoque_w 
	from	setor_atendimento 
	where	cd_setor_atendimento = cd_setor_atendimento_p;
 
	select	max(cd_material) 
	into STRICT	cd_material_w 
	from	ficha_tecnica 
	where	nr_ficha_tecnica = nr_ficha_tecnica_p;
 
	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then 
		begin 
		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo 
		into STRICT	cd_unidade_medida_consumo_w 
		from	material 
		where	cd_material = cd_material_w;
 
		select	nextval('lote_producao_seq') 
		into STRICT	nr_lote_producao_w 
		;
		 
		insert into lote_producao( 
			nr_lote_producao, 
			cd_material, 
			ie_status_lote, 
			cd_unidade_medida, 
			qt_prevista, 
			cd_estabelecimento, 
			cd_local_estoque, 
			dt_atualizacao, 
			nm_usuario, 
			ie_etapa, 
			cd_farmaceutico, 
			ie_tipo_lote, 
			dt_inicio, 
			dt_geracao, 
			nm_usuario_geracao, 
			cd_responsavel, 
			nr_prescricao) 
		values ( 
			nr_lote_producao_w, 
			cd_material_w, 
			'P', 
			cd_unidade_medida_consumo_w, 
			1, 
			cd_estabelecimento_p, 
			cd_local_estoque_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			'G', 
			null, 
			'A', 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			obter_dados_usuario_opcao(nm_usuario_p,'C'), 
			nr_prescricao_p);
			 
		CALL gerar_lote_producao_comp_opme(nr_lote_producao_w, nm_usuario_p);
		 
		 
		begin 
		CALL gerar_status_prescr_opm('G',nr_prescricao_p,'',cd_estabelecimento_p,nm_usuario_p);
		exception 
		when others then 
			null;
		end;
		end;
		 
		if (ie_lancar_conta_w = 'S') then 
		open C01;
		loop 
		fetch C01 into	 
			cd_procedimento_w, 
			ie_origem_proced_w, 
			nr_atendimento_w, 
			dt_inicio_prescr_w, 
			dt_validade_prescr_w, 
			cd_setor_atend_prescr_w, 
			dt_prescricao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			/*select	max(nr_interno_conta) 
			into	nr_interno_conta_w 
			from	conta_paciente 
			where	nr_atendimento		= nr_atendimento_w 
			and	ie_status_acerto 	= 1 
			and	Obter_Tipo_Convenio(cd_convenio_parametro) <> 1 
			and	dt_inicio_prescr_w	>= dt_periodo_inicial 
			and	dt_validade_prescr_w	<= dt_periodo_final;*/
 
			 
			 
			CALL Gerar_Proc_Pac_Item_Prescr(nr_prescricao_p, null, nr_atendimento_w,null, null, cd_procedimento_w, ie_origem_proced_w, 1, cd_setor_atend_prescr_w, 1, 
						  dt_prescricao_w, nm_usuario_p, null, null, null, null,null);
			end;
		end loop;
		close C01;
	end if;		
	end if;
	 
	end;
end if;
commit;
nr_lote_producao_p	:= nr_lote_producao_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_producao_opme_js ( cd_setor_atendimento_p bigint, nr_ficha_tecnica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_lote_producao_p INOUT bigint, nr_prescricao_p bigint) FROM PUBLIC;

