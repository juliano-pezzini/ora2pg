-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_crit_liberacao_analise ( dados_regra_lib_analise_p pls_cta_valorizacao_pck.dados_regra_lib_analise, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_analise_p bigint, nm_usuario_p text, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE


ie_estrut_mat_w			varchar(1);
ie_grupo_operadora_w		varchar(1);
ie_grupo_material_w		varchar(1);
nr_seq_regra_ww			bigint	:= 0;
nr_seq_regra_w			bigint	:= 0;
nr_seq_ocorrencia_w		bigint;
qt_glosa_w			bigint;
qt_ocorrencia_benef_w		bigint;
qt_ocorrencia_fora_regra_w	bigint;
nr_seq_mat_w			bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_estrut_regra_w		bigint;
qt_ocorrencia_w			bigint;
nr_seq_grupo_servico_w		bigint;		
nr_seq_grupo_contrato_w		bigint;
nr_seq_grupo_prestador_w	bigint;
ie_grupo_servico_w		varchar(1);
ie_grupo_contrato_w		varchar(1);
ie_grupo_prestador_w		varchar(1);
ie_tipo_prestador_grupo_w	pls_criterio_lib_analise.ie_tipo_prestador_grupo%type;
nr_seq_prestador_w		integer;
vl_minimo_w			double precision;
vl_maximo_w			double precision;
ie_tipo_valor_w			varchar(1);
ie_valor_valido_w		varchar(1);
qt_proc_grupo_analise_w		bigint;
qt_procedimento_w		bigint;
nr_seq_grupo_proc_qtde_w	bigint;
ie_qt_proc_analise_w		varchar(1);
ie_valida_guia_w		varchar(1);
nr_idade_inicial_w		pls_criterio_lib_analise.nr_idade_inicial%type;
nr_idade_final_w		pls_criterio_lib_analise.nr_idade_final%type;
ie_idade_valida_w			varchar(1);
nr_seq_grupo_operadora_w	pls_criterio_lib_analise.nr_seq_grupo_operadora%type;
nr_seq_grupo_material_w		pls_criterio_lib_analise.nr_seq_grupo_material%type;

C02 CURSOR FOR
	SELECT	a.nr_seq_regra,
		a.nr_seq_ocorrencia,
		a.nr_seq_estrutura_mat,
		a.nr_seq_grupo_servico,
		a.nr_seq_grupo_contrato,
		a.nr_seq_grupo_prestador,
		a.ie_tipo_prestador_grupo,
		a.vl_minimo,
		a.vl_maximo,
		coalesce(a.ie_tipo_valor,'C'),
		a.qt_procedimento,
		a.nr_seq_grupo_proc_qtde,
		a.nr_idade_inicial,
		a.nr_idade_final,
		a.nr_seq_grupo_operadora,
		a.nr_seq_grupo_material
	from	pls_criterio_lib_analise a
	where	a.nr_seq_regra = dados_regra_lib_analise_p.nr_seq_regra
	and	a.ie_situacao  = 'A'
	and	((coalesce(a.nr_seq_grupo_rec::text, '') = '') or ((nr_seq_grupo_rec		= dados_regra_lib_analise_p.nr_seq_grupo_rec)and (coalesce(dados_regra_lib_analise_p.nr_seq_material::text, '') = '') and (coalesce(dados_regra_lib_analise_p.nr_seq_estrutura_mat::text, '') = '')))
	and	((coalesce(a.ie_tipo_guia::text, '') = '') or (a.ie_tipo_guia 		= dados_regra_lib_analise_p.ie_tipo_guia))
	and	((coalesce(a.ie_tipo_segurado::text, '') = '') or (a.ie_tipo_segurado		= dados_regra_lib_analise_p.ie_tipo_segurado))
	and	((coalesce(a.ie_preco::text, '') = '') or (a.ie_preco 		= dados_regra_lib_analise_p.ie_preco))	
	and	((coalesce(a.cd_area_procedimento::text, '') = '') or ((a.cd_area_procedimento	= dados_regra_lib_analise_p.cd_area_procedimento)	and (coalesce(dados_regra_lib_analise_p.nr_seq_material::text, '') = '') and (coalesce(dados_regra_lib_analise_p.nr_seq_estrutura_mat::text, '') = '')))
	and	((coalesce(a.cd_especialidade::text, '') = '') or ((a.cd_especialidade	= dados_regra_lib_analise_p.cd_especialidade)		and (coalesce(dados_regra_lib_analise_p.nr_seq_material::text, '') = '') and (coalesce(dados_regra_lib_analise_p.nr_seq_estrutura_mat::text, '') = '')))
	and	((coalesce(a.cd_grupo_proc::text, '') = '') or ((a.cd_grupo_proc		= dados_regra_lib_analise_p.cd_grupo_proc)		and (coalesce(dados_regra_lib_analise_p.nr_seq_material::text, '') = '') and (coalesce(dados_regra_lib_analise_p.nr_seq_estrutura_mat::text, '') = '')))
	and	((coalesce(a.cd_procedimento::text, '') = '') or ((a.cd_procedimento 	= dados_regra_lib_analise_p.cd_procedimento AND a.ie_origem_proced = dados_regra_lib_analise_p.ie_origem_proced)and (coalesce(dados_regra_lib_analise_p.nr_seq_material::text, '') = '') and (coalesce(dados_regra_lib_analise_p.nr_seq_estrutura_mat::text, '') = '')))
	and	((coalesce(a.nr_seq_contrato::text, '') = '') or (a.nr_seq_contrato		= dados_regra_lib_analise_p.nr_seq_contrato))
	and	((coalesce(a.ie_internado::text, '') = '') or (a.ie_internado = 'N')	or (a.ie_internado	= dados_regra_lib_analise_p.ie_internado))
	and	((coalesce(a.cd_prestador_exec::text, '') = '') or (a.cd_prestador_exec	= dados_regra_lib_analise_p.cd_prestador_exec))
	and	((coalesce(a.cd_prestador_prot::text, '') = '') or (a.cd_prestador_prot	= dados_regra_lib_analise_p.cd_prestador_prot))
	and	((coalesce(a.nr_seq_intercambio::text, '') = '') or (a.nr_seq_intercambio	= dados_regra_lib_analise_p.nr_seq_intercambio))
	and	((coalesce(a.nr_seq_congenere::text, '') = '') or (a.nr_seq_congenere		= dados_regra_lib_analise_p.nr_seq_congenere))
	and	((coalesce(a.nr_seq_material::text, '') = '') or ((a.nr_seq_material		= dados_regra_lib_analise_p.nr_seq_material) and (coalesce(dados_regra_lib_analise_p.cd_procedimento::text, '') = '')))
	and	((coalesce(a.ie_tipo_gat::text, '') = '') or (a.ie_tipo_gat = 'N')	or (a.ie_tipo_gat	= dados_regra_lib_analise_p.ie_tipo_gat))
	and	((coalesce(a.ie_origem_conta::text, '') = '') or (ie_origem_conta		= dados_regra_lib_analise_p.ie_origem_conta))
	and	((coalesce(a.nr_seq_tipo_atendimento::text, '') = '') or (a.nr_seq_tipo_atendimento	= dados_regra_lib_analise_p.nr_seq_tipo_atendimento))
	and	((coalesce(a.ie_regime_atendimento::text, '') = '') or (a.ie_regime_atendimento	= dados_regra_lib_analise_p.ie_regime_atendimento))
	and	((coalesce(a.ie_saude_ocupacional::text, '') = '') or (a.ie_saude_ocupacional	= dados_regra_lib_analise_p.ie_saude_ocupacional))
	and	((coalesce(a.nr_seq_tipo_prestador::text, '') = '') or (a.nr_seq_tipo_prestador	= dados_regra_lib_analise_p.nr_seq_tipo_prestador))
	and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '') or (a.nr_seq_tipo_acomodacao	= dados_regra_lib_analise_p.nr_seq_tipo_prestador))
	and	((coalesce(a.nr_seq_tipo_prestador_prot::text, '') = '') or (a.nr_seq_tipo_prestador_prot = dados_regra_lib_analise_p.nr_seq_tipo_prestador_prot))
	and	((coalesce(a.ie_tipo_despesa_mat::text, '') = '') or (a.ie_tipo_despesa_mat	= dados_regra_lib_analise_p.ie_tipo_despesa_mat))
	and	((coalesce(a.ie_tipo_intercambio::text, '') = '') or (a.ie_tipo_intercambio 	= 'A') or (a.ie_tipo_intercambio = dados_regra_lib_analise_p.ie_tipo_intercambio))
	and	((coalesce(a.nr_seq_prest_req::text, '') = '') or (a.nr_seq_prest_req		= dados_regra_lib_analise_p.nr_seq_prestador_solic))
	order by
		1;


BEGIN
open C02;
loop
fetch C02 into	
	nr_seq_regra_ww,
	nr_seq_ocorrencia_w,
	nr_seq_estrut_regra_w,
	nr_seq_grupo_servico_w,
	nr_seq_grupo_contrato_w,
	nr_seq_grupo_prestador_w,
	ie_tipo_prestador_grupo_w,
	vl_minimo_w,
	vl_maximo_w,
	ie_tipo_valor_w,
	qt_procedimento_w,
	nr_seq_grupo_proc_qtde_w,
	nr_idade_inicial_w,
	nr_idade_final_w,
	nr_seq_grupo_operadora_w,
	nr_seq_grupo_material_w;
EXIT WHEN NOT FOUND; /* apply on C02 */	
	begin
		
	ie_estrut_mat_w		:= 'S';
	ie_grupo_operadora_w	:= 'S';
	ie_grupo_material_w		:= 'S';
	ie_grupo_servico_w	:= 'S';
	ie_grupo_contrato_w	:= 'S';
	ie_grupo_prestador_w	:= 'S';
	ie_valor_valido_w	:= 'S';
	ie_qt_proc_analise_w	:= 'S';
	ie_idade_valida_w	:= 'N';
	if (nr_seq_grupo_servico_w IS NOT NULL AND nr_seq_grupo_servico_w::text <> '') then
		ie_grupo_servico_w := pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, dados_regra_lib_analise_p.cd_procedimento, dados_regra_lib_analise_p.ie_origem_proced);
	end if;
	
	if (nr_seq_grupo_contrato_w IS NOT NULL AND nr_seq_grupo_contrato_w::text <> '') and (ie_grupo_servico_w = 'S') then
		ie_grupo_contrato_w := pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, dados_regra_lib_analise_p.nr_seq_contrato, null);
	end if;
	
	if (nr_seq_grupo_prestador_w IS NOT NULL AND nr_seq_grupo_prestador_w::text <> '') and (ie_grupo_servico_w = 'S') and (ie_grupo_contrato_w = 'S') then
		if (coalesce(ie_tipo_prestador_grupo_w,'C') = 'C') then
			nr_seq_prestador_w := dados_regra_lib_analise_p.nr_seq_prestador_exec;
		elsif (coalesce(ie_tipo_prestador_grupo_w,'C') = 'CR') then
			nr_seq_prestador_w := dados_regra_lib_analise_p.nr_seq_prestador_solic;
		else
			nr_seq_prestador_w := dados_regra_lib_analise_p.nr_seq_prestador_prot;
		end if;
		ie_grupo_prestador_w := pls_obter_se_grupo_prestador(nr_seq_prestador_w, nr_seq_grupo_prestador_w);
	end if;
	
	if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') then
		if (pls_obter_se_mat_estrutura(dados_regra_lib_analise_p.nr_seq_material, nr_seq_estrut_regra_w) = 'N') then
			ie_estrut_mat_w	:= 'N';
		end if;
	end if;
	
	if (nr_seq_grupo_operadora_w IS NOT NULL AND nr_seq_grupo_operadora_w::text <> '') then
		ie_grupo_operadora_w	:= pls_se_grupo_preco_operadora(nr_seq_grupo_operadora_w,dados_regra_lib_analise_p.nr_seq_congenere);
	end if;
	
	if (nr_seq_grupo_material_w IS NOT NULL AND nr_seq_grupo_material_w::text <> '') then
		ie_grupo_material_w := pls_se_grupo_preco_material(nr_seq_grupo_material_w, dados_regra_lib_analise_p.nr_seq_material);
	end if;

	if (coalesce(vl_minimo_w,0) > 0) or (coalesce(vl_maximo_w,0) > 0) then
		if (ie_tipo_valor_w = 'C') and /* Valor calculado */
			((dados_regra_lib_analise_p.vl_apresentado < coalesce(vl_minimo_w,0)) or (dados_regra_lib_analise_p.vl_apresentado > coalesce(vl_maximo_w,9999999999999))) then
			ie_valor_valido_w	:= 'N';
		elsif (ie_tipo_valor_w = 'L') and
			((dados_regra_lib_analise_p.vl_liberado < coalesce(vl_minimo_w,0)) or (dados_regra_lib_analise_p.vl_liberado > coalesce(vl_maximo_w,9999999999999))) then /* Valor liberado */
			ie_valor_valido_w	:= 'N';
		end if;
	end if;

	if (coalesce(qt_procedimento_w,0) > 0) then
		qt_proc_grupo_analise_w	:= pls_obter_qt_proc_analise(nr_seq_analise_p,nr_seq_grupo_proc_qtde_w);
		
		if (qt_proc_grupo_analise_w > qt_procedimento_w) or (qt_proc_grupo_analise_w = 0) then
			ie_qt_proc_analise_w	:= 'N';
		end if;
	end if;
	
	if (coalesce(nr_idade_inicial_w::text, '') = '') then
		nr_idade_inicial_w := 0;	
	end if;
	
	if (coalesce(nr_idade_final_w::text, '') = '') then
		nr_idade_final_w := 200;
	end if;
	
	if (dados_regra_lib_analise_p.nr_idade_benef between nr_idade_inicial_w and nr_idade_final_w) then
		ie_idade_valida_w := 'S';
	end if;
	
	if (ie_estrut_mat_w = 'S') and (ie_grupo_servico_w = 'S') and (ie_grupo_contrato_w = 'S') and (ie_grupo_operadora_w = 'S') and (ie_grupo_prestador_w = 'S') and (ie_valor_valido_w = 'S') and (ie_qt_proc_analise_w = 'S') and (ie_idade_valida_w = 'S')  and (ie_grupo_material_w = 'S' )then
		
		if (pls_obter_excecao_lib_analise(	nr_seq_conta_p, nr_seq_conta_proc_p, nr_seq_regra_ww,
							dados_regra_lib_analise_p, nr_seq_analise_p) = 0) then
			
			select	count(1)
			into STRICT	qt_ocorrencia_w
			from	pls_conta		a,
				pls_ocorrencia_benef	c
			where	a.nr_sequencia		= c.nr_seq_conta
			and	a.nr_seq_analise	= nr_seq_analise_p
			and	c.nr_seq_ocorrencia	= nr_seq_ocorrencia_w;

			if (coalesce(nr_seq_ocorrencia_w,0) > 0) and (dados_regra_lib_analise_p.ie_somente_ocorrencia = 'S') then	

				/* William - OS 397802 - Performance, retirado OR, e buscando a glosa primeiro da PLS_CONTA, visto com Robson */

				select	count(1)
				into STRICT	qt_glosa_w
				from	pls_conta		a,
					pls_ocorrencia_benef	c
				where	a.nr_sequencia		= c.nr_seq_conta
				and	a.nr_seq_analise	= nr_seq_analise_p
				and	c.nr_seq_ocorrencia not in (SELECT	x.nr_seq_ocorrencia
									from	pls_criterio_lib_analise	x
									where	x.ie_situacao	= 'A'
									and	x.nr_seq_regra	= nr_seq_regra_ww)  LIMIT 1;
				
				if (qt_glosa_w = 0) then
					select	count(1)
					into STRICT	qt_glosa_w
					from	pls_conta 	a,
						pls_conta_glosa	b
					where	a.nr_sequencia = b.nr_seq_conta
					and	a.nr_seq_analise = nr_seq_analise_p
					and	not exists (SELECT	1
								from 	pls_ocorrencia_benef d
								where	d.nr_sequencia = b.nr_seq_ocorrencia_benef)
					and	not exists (select	1
								from 	pls_ocorrencia_benef d
								where	d.nr_seq_glosa = b.nr_sequencia)  LIMIT 1;
				end if;
				
				if (qt_glosa_w = 0) then
					select	count(1)
					into STRICT	qt_glosa_w
					from	pls_conta_mat	b,
						pls_conta	a,
						pls_ocorrencia_benef	c
					where	a.nr_sequencia		= b.nr_seq_conta
					and	a.nr_seq_analise	= nr_seq_analise_p
					and	b.nr_sequencia		= c.nr_seq_conta_mat
					and	c.nr_seq_ocorrencia not in (SELECT	x.nr_seq_ocorrencia
										from	pls_criterio_lib_analise	x
										where	x.ie_situacao	= 'A'
										and	x.nr_seq_regra	= nr_seq_regra_ww)  LIMIT 1;
				end if;
				
				if (qt_glosa_w = 0) then
					select	count(1)
					into STRICT	qt_glosa_w
					from	pls_conta 	a,
						pls_conta_glosa	b,
						pls_conta_mat	c
					where	a.nr_sequencia 	= c.nr_seq_conta
					and	c.nr_sequencia	= b.nr_seq_conta_mat
					and	a.nr_seq_analise = nr_seq_analise_p
					and	not exists (SELECT	1
								from 	pls_ocorrencia_benef d
								where	d.nr_sequencia = b.nr_seq_ocorrencia_benef)
					and	not exists (select	1
								from 	pls_ocorrencia_benef d
								where	d.nr_seq_glosa = b.nr_sequencia)  LIMIT 1;
				end if;
				
				if (qt_glosa_w = 0) then
					select	count(1)
					into STRICT	qt_glosa_w
					from	pls_conta_proc		b,
						pls_conta		a,
						pls_ocorrencia_benef	c
					where	a.nr_sequencia		= b.nr_seq_conta
					and	a.nr_seq_analise	= nr_seq_analise_p
					and	b.nr_sequencia		= c.nr_seq_conta_proc
					and	c.nr_seq_ocorrencia not in (SELECT	x.nr_seq_ocorrencia
										from	pls_criterio_lib_analise	x
										where	x.ie_situacao	= 'A'
										and	x.nr_seq_regra	= nr_seq_regra_ww)  LIMIT 1;
				end if;
				
				if (qt_glosa_w = 0) then
					select	count(1)
					into STRICT	qt_glosa_w
					from	pls_conta 	a,
						pls_conta_glosa	b,
						pls_conta_proc	c
					where	a.nr_sequencia 	= c.nr_seq_conta
					and	c.nr_sequencia	= b.nr_seq_conta_proc
					and	a.nr_seq_analise = nr_seq_analise_p
					and	not exists (SELECT	1
								from 	pls_ocorrencia_benef d
								where	d.nr_sequencia = b.nr_seq_ocorrencia_benef)
					and	not exists (select	1
								from 	pls_ocorrencia_benef d
								where	d.nr_seq_glosa = b.nr_sequencia)  LIMIT 1;
				end if;
			
				
				if (qt_glosa_w = 0) and (qt_ocorrencia_w > 0) then
					nr_seq_regra_w := nr_seq_regra_ww;
					exit;
				end if;

			elsif (coalesce(nr_seq_ocorrencia_w, 0) > 0) and (dados_regra_lib_analise_p.ie_somente_ocorrencia = 'N') then
				select	sum(CASE WHEN nr_seq_ocorrencia=nr_seq_ocorrencia_w THEN 1  ELSE 0 END ),
					sum(CASE WHEN nr_seq_ocorrencia=nr_seq_ocorrencia_w THEN 0  ELSE 1 END )
				into STRICT	qt_ocorrencia_benef_w,
					qt_ocorrencia_fora_regra_w
				from	pls_ocorrencia_benef
				where	((nr_seq_conta	= nr_seq_conta_p) or (nr_seq_proc	= nr_seq_conta_proc_w) or (nr_seq_mat	= nr_seq_mat_w));
				
				if (coalesce(qt_ocorrencia_benef_w,0) > 0) and
					((dados_regra_lib_analise_p.ie_somente_ocorrencia = 'N') or (qt_ocorrencia_fora_regra_w = 0)) then
					nr_seq_regra_w	:= nr_seq_regra_ww;
					exit;
				end if;
			else
				nr_seq_regra_w	:= nr_seq_regra_ww;
				exit;
			end if;
		end if;
	end if;
	end;
end loop;
close C02;

nr_seq_regra_p	:= nr_seq_regra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_crit_liberacao_analise ( dados_regra_lib_analise_p pls_cta_valorizacao_pck.dados_regra_lib_analise, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_analise_p bigint, nm_usuario_p text, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

