-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_benef_internado ( nr_seq_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_benef_internado_w		varchar(1)	:= 'S';
nr_seq_segurado_w		bigint;
cd_estabelecimento_w		smallint;
nr_seq_internacao_w		bigint;
nr_seq_contrato_w		bigint;
cd_guia_w			varchar(20);
ie_tipo_plano_w			varchar(3);
ie_tipo_beneficiario_w		varchar(3);
qt_diarias_w			bigint	:= 0;
nr_seq_protocolo_w		bigint;
dt_mesref_protocolo_w		timestamp;
ie_tipo_guia_w			varchar(2);
nr_seq_clinica_w		bigint;
ie_tipo_segurado_w		varchar(3);


BEGIN

ie_benef_internado_w	:= pls_obter_se_internado(nr_seq_conta_p, 'C');

/* Obter dados da conta */

begin
select	nr_seq_segurado,
	cd_estabelecimento,
	coalesce(cd_guia_referencia, cd_guia),
	ie_tipo_plano,
	ie_tipo_beneficiario,
	nr_seq_protocolo,
	ie_tipo_guia,
	nr_seq_clinica
into STRICT	nr_seq_segurado_w,
	cd_estabelecimento_w,
	cd_guia_w,
	ie_tipo_plano_w,
	ie_tipo_beneficiario_w,
	nr_seq_protocolo_w,
	ie_tipo_guia_w,
	nr_seq_clinica_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;
exception
	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267424,
						'NR_SEQ_CONTA_P=' || nr_seq_conta_p);
end;

if (nr_seq_segurado_w	> 0) then
	/* Obter dados do segurado */

	begin
	select	nr_seq_contrato,
		ie_tipo_segurado
	into STRICT	nr_seq_contrato_w,
		ie_tipo_segurado_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_w;
	exception
		when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(267425,
							'NR_SEQ_CONTA_P=' || nr_seq_conta_p||';'||
							'NR_SEQ_SEGURADO_W=' || nr_seq_segurado_w);
	end;

	if (ie_tipo_segurado_w in ('B','A')) then
		/* Obter dados do protocolo */

		select	dt_mes_competencia
		into STRICT	dt_mesref_protocolo_w
		from	pls_protocolo_conta
		where	nr_sequencia	= nr_seq_protocolo_w;

		/* Obter a quantidade de di√°rias da conta */

		select	coalesce(sum(qt_procedimento),0)
		into STRICT	qt_diarias_w
		from	pls_conta_proc
		where	nr_seq_conta	= nr_seq_conta_p
		and	ie_tipo_despesa	= 3;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_internacao_w
		from	pls_beneficiario_internado
		where	nr_seq_segurado	= nr_seq_segurado_w
		and	cd_guia		= cd_guia_w;

		if (nr_seq_internacao_w	= 0) then
			insert into pls_beneficiario_internado(nr_sequencia,
				cd_estabelecimento,
				nr_seq_segurado,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_contrato,
				cd_guia,
				ie_tipo_plano,
				ie_tipo_beneficiario,
				qt_diarias,
				nr_seq_conta,
				dt_mesref_protocolo,
				ie_tipo_guia,
				nr_seq_clinica)
			values (	nextval('pls_beneficiario_internado_seq'),
				cd_estabelecimento_w,
				nr_seq_segurado_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_contrato_w,
				cd_guia_w,
				ie_tipo_plano_w,
				ie_tipo_beneficiario_w,
				qt_diarias_w,
				nr_seq_conta_p,
				dt_mesref_protocolo_w,
				ie_tipo_guia_w,
				nr_seq_clinica_w);
		else
			update	pls_beneficiario_internado
			set	nr_seq_contrato		= nr_seq_contrato_w,
				cd_guia			= cd_guia_w,
				ie_tipo_plano		= ie_tipo_plano_w,
				ie_tipo_beneficiario	= ie_tipo_beneficiario_w,
				qt_diarias		= qt_diarias + qt_diarias_w,
				nr_seq_conta		= nr_seq_conta_p,
				dt_mesref_protocolo	= dt_mesref_protocolo_w,
				ie_tipo_guia		= ie_tipo_guia_w,
				nr_seq_clinica		= nr_seq_clinica_w
			where	nr_sequencia	= nr_seq_internacao_w;
		end if;

		--commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_benef_internado ( nr_seq_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

