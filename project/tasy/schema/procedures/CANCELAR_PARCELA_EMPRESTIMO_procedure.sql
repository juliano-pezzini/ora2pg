-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_parcela_emprestimo (nr_seq_parcela_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w		emprest_financ_parc.nr_titulo%type;
ie_situacao_w		titulo_pagar.ie_situacao%type;


BEGIN
select	max(nr_titulo)
into STRICT	nr_titulo_w
from	emprest_financ_parc
where	nr_sequencia = nr_seq_parcela_p;

if (coalesce(nr_titulo_w::text, '') = '') then
	-- Parcela não possui título e não pode ser cancelada.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(369557);
else
	select	max(ie_situacao)
	into STRICT	ie_situacao_w
	from	titulo_pagar
	where	nr_titulo = nr_titulo_w;

	if (coalesce(ie_situacao_w,'A') <> 'C') then
		-- Título deve estar cancelado para cancelar a parcela.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(369558);
	else
		/* Cancela a parcela atual e gera nova parcela com os mesmos dados da parcela cancelada */

		update	emprest_financ_parc
		set	dt_cancelamento = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia = nr_seq_parcela_p;

		insert into emprest_financ_parc(nr_sequencia,
			nr_parcela,
			nr_seq_contrato,
			cd_estabelecimento,
			nm_usuario,
			dt_atualizacao,
			nr_titulo,
			dt_vencimento,
			vl_parcela,
			vl_juros,
			vl_amortizacao,
			vl_saldo_dev,
			vl_saldo_corrigido)
		SELECT	nextval('emprest_financ_parc_seq'),
			nr_parcela,
			nr_seq_contrato,
			cd_estabelecimento,
			nm_usuario_p,
			clock_timestamp(),
			null,
			dt_vencimento,
			vl_parcela,
			vl_juros,
			vl_amortizacao,
			vl_saldo_dev,
			vl_saldo_corrigido
		from	emprest_financ_parc
		where	nr_sequencia = nr_seq_parcela_p;

		commit;
	end if;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_parcela_emprestimo (nr_seq_parcela_p bigint, nm_usuario_p text) FROM PUBLIC;

