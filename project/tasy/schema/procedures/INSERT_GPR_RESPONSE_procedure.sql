-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_gpr_response ( ie_participant_type_p text, cd_participant_p text, nm_participant_p text, nr_par_num_p text, dt_update_p timestamp, cd_capability_p text, nm_capability_p text, cd_sec_capability_p text, cd_capability_ver_p text, cd_capability_role_p text, ds_notes_p text) AS $body$
DECLARE


  nr_seq_gpr_response_w 		gpr_response.nr_sequencia%type        		:= -1;
  ie_participant_type_w 		gpr_response.ie_participant_type%type 		:= ie_participant_type_p;
  cd_participant_w 			gpr_response.cd_participant%type           	:= cd_participant_p;
  nm_participant_w 			gpr_response.nm_participant%type           	:= nm_participant_p;
  nr_par_num_w 			gpr_response.nr_par_num%type                   	:= nr_par_num_p;
  dt_update_w 			gpr_response.dt_update%type                     	:= dt_update_p;
  cd_capability_w 			gpr_response.cd_capability%type             	:= cd_capability_p;
  nm_capability_w 			gpr_response.nm_capability%type             	:= nm_capability_p;
  cd_seq_capability_w 		gpr_response.cd_sec_capability%type     	:= cd_sec_capability_p;
  cd_capability_ver_w 		gpr_response.cd_capability_ver%type     	:= cd_capability_ver_p;
  cd_capability_role_w 		gpr_response.cd_capability_role%type   		:= cd_capability_role_p;


BEGIN
  UPDATE gpr_response
  SET ie_situation          = 'N'
  WHERE dt_atualizacao_nrec < clock_timestamp()
  AND cd_participant = cd_participant_p;
  
  SELECT coalesce(MAX(nr_sequencia), -1)
  INTO STRICT nr_seq_gpr_response_w
  FROM gpr_response
  WHERE cd_participant     = cd_participant_p
  AND cd_capability        = cd_capability_p;

  IF nr_seq_gpr_response_w > 0 THEN
  
    UPDATE gpr_response
    SET dt_atualizacao_nrec = clock_timestamp(),
      nm_usuario_nrec       = coalesce(obter_usuario_ativo(), 'TASY_BIFROST'),
      ie_situation          = 'S',
	  ds_notes				= ds_notes_p
    WHERE nr_sequencia      = nr_seq_gpr_response_w;

    COMMIT;

  ELSE
  
    SELECT nextval('gpr_response_seq') INTO STRICT nr_seq_gpr_response_w;

    INSERT
    INTO gpr_response(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        ie_participant_type,
        cd_participant,
        nm_participant,
        nr_par_num,
        dt_update,
        cd_capability,
        nm_capability,
        cd_sec_capability,
        cd_capability_ver,
        cd_capability_role,
        ie_situation,
		ds_notes
      )
      VALUES (
        nr_seq_gpr_response_w,
        clock_timestamp(),
        'TASY_BIFROST',
        clock_timestamp(),
        'TASY_BIFROST',
        ie_participant_type_w,
        cd_participant_w,
        nm_participant_w,
        nr_par_num_w,
        dt_update_w,
        cd_capability_w,
        nm_capability_w,
        cd_seq_capability_w,
        cd_capability_ver_w,
        cd_capability_role_w,
        'S',
		ds_notes_p
      );

    COMMIT;
    
  END IF;

  CALL update_eclipse_documentation(cd_participant_w);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_gpr_response ( ie_participant_type_p text, cd_participant_p text, nm_participant_p text, nr_par_num_p text, dt_update_p timestamp, cd_capability_p text, nm_capability_p text, cd_sec_capability_p text, cd_capability_ver_p text, cd_capability_role_p text, ds_notes_p text) FROM PUBLIC;

