-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_obter_acessos_funcao ( nr_sequencia_p bigint) AS $body$
DECLARE


vl_inf_w		varchar(100);
id_inf_w		varchar(100);
cd_cnpj_w		varchar(14);

C01 CURSOR FOR
	SELECT	count(*) VL_INF,
			'COM_FUNC_USO:' || cd_funcao ID_INF,
			obter_cgc_estabelecimento(obter_estabelecimento_ativo) CD_CNPJ
	from	log_acesso_funcao l
	where	cd_funcao in (	SELECT	cd_funcao
							from	funcao f,
									modulo_implantacao m
							where	m.nr_sequencia = nr_seq_mod_impl
							and		UPPER(coalesce(f.ie_situacao, 'I')) = 'A'
							and		m.IE_COMERCIAL = 'S')
	and		l.dt_acesso > clock_timestamp() - interval '60 days'
	group by cd_funcao;


BEGIN

open C01;
loop
fetch C01 into
	vl_inf_w,
	id_inf_w,
	cd_cnpj_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		CALL insert_inf_base_cliente(
				nr_sequencia_p,
				vl_inf_w,
				id_inf_w,
				cd_cnpj_w,
				null,
				'Tasy');
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_obter_acessos_funcao ( nr_sequencia_p bigint) FROM PUBLIC;

