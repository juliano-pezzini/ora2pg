-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_regra_mat_cotacao (cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_cgc_fornecedor_w			varchar(14);
cd_material_w				integer;
vl_preco_w				double precision;
qt_existe_w				bigint;

c01 CURSOR FOR
SELECT	cd_cgc_fornecedor,
	cd_material,
	vl_preco
from	regra_cotacao_mat_fornec
where	(cd_material IS NOT NULL AND cd_material::text <> '')
order by cd_cgc_fornecedor,
	cd_material;


BEGIN
open C01;
loop
fetch C01 into
	cd_cgc_fornecedor_w,
	cd_material_w,
	vl_preco_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	count(*)
	into STRICT	qt_existe_w
	from	preco_pj
	where	cd_estabelecimento	 = cd_estabelecimento_p
	and	cd_cgc = cd_cgc_fornecedor_w
	and	cd_material = cd_material_w;

	if (qt_existe_w = 0) then
		insert into preco_pj(
			nr_sequencia,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			cd_cgc,
			cd_material,
			vl_item)
		values (nextval('preco_pj_seq'),
			cd_estabelecimento_p,
			clock_timestamp(),
			'TasyRegraPreco',
			cd_cgc_fornecedor_w,
			cd_material_w,
			vl_preco_w);
	else
		update	preco_pj
		set	vl_item = vl_preco_w
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_cgc = cd_cgc_fornecedor_w
		and	cd_material = cd_material_w;
	end if;
	end;
end loop;
close C01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_regra_mat_cotacao (cd_estabelecimento_p bigint) FROM PUBLIC;

