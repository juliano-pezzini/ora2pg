-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE via_alterar_aprovador ( nr_seq_viagem_p bigint, ie_tipo_troca_p text, cd_pessoa_fisica_new_p text, ds_justificativa_p text, nm_usuario_p text ) AS $body$
DECLARE

	
	cd_pessoa_fisica_old_w 		pessoa_fisica.cd_pessoa_fisica%type;


BEGIN

	SELECT 	CASE ie_tipo_troca_p
			WHEN 'APV' THEN MAX(cd_pessoa_aprov)
			WHEN 'ASV' THEN MAX(cd_aprov_sub)
			WHEN 'APR' THEN MAX(cd_pessoa_aprov_rel_desp)
			WHEN 'ASR' THEN MAX(cd_pessoa_aprov_rel_desp_sub)
		END cd_pessoa_fisica_old
	INTO STRICT 	cd_pessoa_fisica_old_w
	FROM 	fin_gv_pend_aprov
	WHERE 	nr_seq_viagem = nr_seq_viagem_p;
	
	INSERT INTO VIA_VIAGEM_LOG_APROV(
		NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		DS_JUSTIFICATIVA,
		CD_PESSOA_FISICA_OLD,
		IE_TIPO_TROCA,
		NR_SEQ_VIAGEM
	) VALUES (
		nextval('via_viagem_log_aprov_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_justificativa_p,
		cd_pessoa_fisica_old_w,
		ie_tipo_troca_p,
		nr_seq_viagem_p
	);
	
	CASE ie_tipo_troca_p
		WHEN 'APV' THEN
			UPDATE	fin_gv_pend_aprov
			SET	cd_pessoa_aprov 			= cd_pessoa_fisica_new_p,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 			= clock_timestamp()
			WHERE	nr_seq_viagem = nr_seq_viagem_p;
		WHEN 'ASV' THEN
			UPDATE	fin_gv_pend_aprov
			SET	cd_aprov_sub 			= cd_pessoa_fisica_new_p,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 			= clock_timestamp()
			WHERE	nr_seq_viagem = nr_seq_viagem_p;
		WHEN 'APR' THEN
			UPDATE	fin_gv_pend_aprov
			SET	cd_pessoa_aprov_rel_desp 		= cd_pessoa_fisica_new_p,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 			= clock_timestamp()
			WHERE	nr_seq_viagem = nr_seq_viagem_p;
		WHEN 'ASR' THEN
			UPDATE	fin_gv_pend_aprov
			SET 	cd_pessoa_aprov_rel_desp_sub 	= cd_pessoa_fisica_new_p,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 			= clock_timestamp()
			WHERE 	nr_seq_viagem = nr_seq_viagem_p;
	END CASE;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE via_alterar_aprovador ( nr_seq_viagem_p bigint, ie_tipo_troca_p text, cd_pessoa_fisica_new_p text, ds_justificativa_p text, nm_usuario_p text ) FROM PUBLIC;

