-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_calculate_patient_on_tele ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


	    nr_seq_operational_level_w  	bigint := 0;
	    nr_seq_panel_w					pfcs_panel_detail.nr_seq_panel%type;
    	ds_active_status_w				varchar(15) := 'ACTIVE';
        ds_dev_inactive_status_w		varchar(15) := 'INACTIVE';
        ds_dev_unknown_status_w		    varchar(15) := 'UNKNOWN';
    	ds_monitor_dev_type_w 			varchar(10) := 'Monitor';

/* in use = Patients on Tele / Total  Devices */

c01_device_from_pfcs CURSOR FOR
   SELECT	sum(total_device_in_use) total_device_in_use,
			sum(total_devices) total_devices,
			ds_department
	from (	SELECT	count(1) total_device_in_use,
					0 total_devices,
					loc.ds_department ds_department
			from	pfcs_device dev,
					pfcs_location loc,
					pfcs_organization org
			where	dev.si_status = ds_active_status_w
			and		dev.ds_device_type = ds_monitor_dev_type_w
			and		loc.nr_sequencia = dev.nr_seq_location
			and		dev.nr_seq_organization = org.nr_sequencia
			and		org.cd_estabelecimento = (cd_estabelecimento_p)::numeric
			group by loc.ds_department
			
union

			select	0 total_device_in_use,
					count(1) total_devices,
					loc.ds_department ds_department
			from	pfcs_device dev,
					pfcs_location loc,
					pfcs_organization org
			where	dev.ds_device_type = ds_monitor_dev_type_w
			and		dev.nr_seq_organization = org.nr_sequencia
			and (dev.si_status not in ds_dev_unknown_status_w or coalesce(dev.si_status::text, '') = '')
			and		loc.nr_sequencia = dev.nr_seq_location
			and		dev.nr_seq_organization = org.nr_sequencia
			and		loc.si_status = ds_active_status_w
			and     pfcs_get_bed_status(loc.cd_operational_status, 'C', cd_estabelecimento_p, 'Y') = 'A'
			and		org.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
			group by loc.ds_department
			) alias9
	group by ds_department
	
union all

	select	0 total_device_in_use,
			count(1) total_devices,
			Obter_desc_expressao(344145) ds_department
	from	pfcs_device dev,
			pfcs_organization org
	where (dev.si_status in (ds_dev_inactive_status_w) or coalesce(dev.si_status::text, '') = '')
	and		dev.ds_device_type = ds_monitor_dev_type_w
	and		dev.nr_seq_organization = org.nr_sequencia
	and		coalesce(dev.nr_seq_location::text, '') = ''
	and		org.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
        having count(1) > 0;

BEGIN
	for r_c02 in c01_device_from_pfcs loop
		 := pfcs_pck_v2.pfcs_generate_results(
					vl_indicator_p => r_c02.total_device_in_use, vl_indicator_aux_p => r_c02.total_devices, ds_reference_value_p => r_c02.ds_department, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => (cd_estabelecimento_p)::numeric , nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

		CALL pfcs_pck_v2.pfcs_update_detail(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_panel_p => nr_seq_panel_w,
			nr_seq_operational_level_p => (cd_estabelecimento_p)::numeric ,
			nm_usuario_p => nm_usuario_p);
	end loop;

	commit;

	CALL pfcs_pck_v2.pfcs_activate_records(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_operational_level_p => (cd_estabelecimento_p)::numeric ,
			nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_calculate_patient_on_tele ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

