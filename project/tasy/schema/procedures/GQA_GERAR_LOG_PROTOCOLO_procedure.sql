-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_gerar_log_protocolo (nr_sequencia_p bigint ,opcao_p text) AS $body$
DECLARE


  c_prot_etapa CURSOR FOR
    SELECT e.qt_resultado
          ,e.dt_inicio
          ,e.nm_usuario_executor
          ,e.nr_seq_etapa_sup
          ,e.dt_fim
          ,e.nr_sequencia
          ,e.qt_tempo_execucao
          ,p.nr_seq_protocolo
      FROM gqa_protocolo_pac       p
          ,gqa_protocolo_etapa_pac e
     WHERE p.nr_sequencia = e.nr_seq_prot_pac
       AND e.nr_sequencia = nr_sequencia_p;
  r_prot_etapa c_prot_etapa%ROWTYPE;

  seq_nextval_w bigint;


BEGIN
  FOR r_prot_etapa IN c_prot_etapa LOOP
    SELECT nextval('gqa_protocolo_mov_pac_seq')
      INTO STRICT seq_nextval_w
;

    INSERT INTO gqa_protocolo_mov_pac(nr_sequencia
      ,dt_atualizacao
      ,nm_usuario
      ,dt_atualizacao_nrec
      ,nm_usuario_nrec
      ,ie_situacao
      ,qt_pontos
      ,dt_inicio
      ,nm_usuario_executor
      ,ds_movimento
      ,nr_seq_etapa_sup
      ,dt_fim
      ,nr_seq_etapac_pac
      ,qt_tempo_execucao
      ,cd_prot_mov
      ,ie_acao)
    VALUES (seq_nextval_w
      ,clock_timestamp()
      ,wheb_usuario_pck.get_nm_usuario
      ,clock_timestamp()
      ,wheb_usuario_pck.get_nm_usuario
      ,'A'
      ,r_prot_etapa.qt_resultado
      ,r_prot_etapa.dt_inicio
      ,r_prot_etapa.nm_usuario_executor
      ,' '
      ,coalesce(r_prot_etapa.nr_seq_etapa_sup,0)
      ,r_prot_etapa.dt_fim
      ,r_prot_etapa.nr_sequencia
      ,r_prot_etapa.qt_tempo_execucao
      ,r_prot_etapa.nr_seq_protocolo
      ,opcao_p);
  END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_gerar_log_protocolo (nr_sequencia_p bigint ,opcao_p text) FROM PUBLIC;

