-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_auditoria (nr_seq_auditoria_p bigint, nr_interno_conta_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, ie_tipo_data_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p text, ie_nao_auditados_p text, ie_proc_mat_p text, cd_area_proc_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_grupo_mat_p bigint, cd_subgrupo_p bigint, cd_classe_p bigint, nm_usuario_p text, nr_seq_regra_audit_p bigint, vl_min_audit_p bigint, vl_max_audit_p bigint, nr_doc_interno_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_item_w		double precision;
nr_seq_item_w		bigint;
tx_procedimento_w		double precision;
ie_status_acerto_w		varchar(01);
ds_filtros_auditoria_w	varchar(2000);
vl_item_w			double precision;
ie_pacote_w		varchar(1);

cd_setor_atendimento_w	integer;
cd_area_procedimento_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
ie_tipo_item_w		varchar(1);
ie_tipo_data_w		varchar(1);
cd_material_w		integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ie_classificacao_w	varchar(1);
qt_regra_w		bigint;
dt_entrada_unidade_w	timestamp;
nr_seq_atepacu_w	bigint;

ie_regra_w		varchar(1):= null;
ie_exige_auditoria_w	varchar(1) := 'N';
cd_unidade_basica_w	varchar(10);
cd_unidade_compl_w	varchar(10);
nr_atendimento_w	bigint;
nr_seq_kit_est_w	bigint;
ds_mat_kit_est_w	varchar(150);
nr_seq_lote_w		bigint;
cd_medico_autenticacao_w	varchar(10);
cd_setor_original_w	setor_atendimento.cd_setor_atendimento%type;
ie_resumo_auditoria_w	varchar(1);

c01 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.nr_sequencia,
		a.qt_material,
		a.vl_material,
		coalesce(a.nr_seq_kit_estoque,0),
		coalesce(a.nr_seq_lote_ap,0),
		cd_medico_autenticacao,
		a.cd_setor_atendimento
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		(a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1) or
		((Obter_se_item_valido_prescr(a.nr_atendimento, a.nr_prescricao,dt_periodo_inicial_p, dt_periodo_final_p) = 'S') and (ie_tipo_data_p = 2)))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and	((coalesce(vl_min_audit_p::text, '') = '') or (vl_min_audit_p <= a.vl_material))
	and	((coalesce(vl_max_audit_p::text, '') = '') or (vl_max_audit_p >= a.vl_material))
	and	((coalesce(nr_doc_interno_p::text, '') = '') or (obter_se_contido(a.nr_doc_interno, '(' || nr_doc_interno_p || ')') = 'S'));

c02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.qt_procedimento,
		a.tx_procedimento,
		a.vl_procedimento,
		a.cd_setor_atendimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0)	= 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0)	= 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		(a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1) or
		((Obter_se_item_valido_prescr(a.nr_atendimento, a.nr_prescricao,dt_periodo_inicial_p, dt_periodo_final_p) = 'S') and (ie_tipo_data_p = 2)))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and	((coalesce(vl_min_audit_p::text, '') = '') or (vl_min_audit_p <= a.vl_procedimento))
	and	((coalesce(vl_max_audit_p::text, '') = '') or (vl_max_audit_p >= a.vl_procedimento))
	and	((coalesce(nr_doc_interno_p::text, '') = '') or (obter_se_contido(a.nr_doc_interno, '(' || nr_doc_interno_p || ')') = 'S'));

c03 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.nr_sequencia,
		a.qt_material,
		a.vl_material,
		coalesce(b.cd_grupo_material,0),
		coalesce(b.cd_subgrupo_material,0),
		coalesce(b.cd_classe_material,0),
		b.cd_material,
		a.cd_setor_atendimento,
		a.dt_entrada_unidade,
		a.nr_seq_atepacu,
		a.nr_atendimento,
		coalesce(a.nr_seq_kit_estoque,0),
		coalesce(a.nr_seq_lote_ap,0),
		cd_medico_autenticacao
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		(a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1) or
		((Obter_se_item_valido_prescr(a.nr_atendimento, a.nr_prescricao,dt_periodo_inicial_p, dt_periodo_final_p) = 'S') and (ie_tipo_data_p = 2)))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and	((coalesce(vl_min_audit_p::text, '') = '') or (vl_min_audit_p <= a.vl_material))
	and	((coalesce(vl_max_audit_p::text, '') = '') or (vl_max_audit_p >= a.vl_material))
	and	((coalesce(nr_doc_interno_p::text, '') = '') or (obter_se_contido(a.nr_doc_interno, '(' || nr_doc_interno_p || ')') = 'S'));

c04 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.qt_procedimento,
		a.tx_procedimento,
		a.vl_procedimento,
		coalesce(b.cd_area_procedimento,0),
		coalesce(b.cd_especialidade,0),
		coalesce(b.cd_grupo_proc,0),
		b.cd_procedimento,
		b.ie_origem_proced,
		a.cd_setor_atendimento,
		a.dt_entrada_unidade,
		a.nr_seq_atepacu,
		a.nr_atendimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		(a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1) or
		((Obter_se_item_valido_prescr(a.nr_atendimento, a.nr_prescricao,dt_periodo_inicial_p, dt_periodo_final_p) = 'S') and (ie_tipo_data_p = 2)))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and	((coalesce(vl_min_audit_p::text, '') = '') or (vl_min_audit_p <= a.vl_procedimento))
	and	((coalesce(vl_max_audit_p::text, '') = '') or (vl_max_audit_p >= a.vl_procedimento))
	and	((coalesce(nr_doc_interno_p::text, '') = '') or (obter_se_contido(a.nr_doc_interno, '(' || nr_doc_interno_p || ')') = 'S'));

C05 CURSOR FOR
	SELECT 	'S'
	from  	regra_auditoria_mat
	where 	nr_seq_regra_auditoria	= nr_seq_regra_audit_p
	and	ie_situacao = 'A'
	and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
	and 	coalesce(cd_material, coalesce(cd_material_w,0))			= coalesce(cd_material_w,0)
	and 	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and 	coalesce(cd_unidade_basica, coalesce(cd_unidade_basica_w,'0'))	= coalesce(cd_unidade_basica_w,'0')
	and 	coalesce(cd_unidade_compl, coalesce(cd_unidade_compl_w,'0'))	= coalesce(cd_unidade_compl_w,'0')
	order by  coalesce(cd_material,0),
		  coalesce(cd_classe_material,0),
		  coalesce(cd_subgrupo_material,0),
		  coalesce(cd_grupo_material,0),
		  coalesce(cd_setor_atendimento,0),
		  coalesce(cd_unidade_basica, '0'),
		  coalesce(cd_unidade_compl, '0');

C06 CURSOR FOR
	SELECT 	'S'
	from  	regra_auditoria_proc
	where 	nr_seq_regra_auditoria =  nr_seq_regra_audit_p
	and	ie_situacao = 'A'
	and	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
	and	coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
	and	coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
	and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))		= coalesce(cd_procedimento_w,0)
	and	((coalesce(cd_procedimento::text, '') = '') or (((cd_procedimento IS NOT NULL AND cd_procedimento::text <> '') and (coalesce(ie_origem_proced, ie_origem_proced_w) = ie_origem_proced_w ))))
	and 	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and 	coalesce(ie_classificacao, ie_classificacao_w)		= ie_classificacao_w
	and 	coalesce(cd_unidade_basica, coalesce(cd_unidade_basica_w,'0'))	= coalesce(cd_unidade_basica_w,'0')
	and 	coalesce(cd_unidade_compl, coalesce(cd_unidade_compl_w,'0'))	= coalesce(cd_unidade_compl_w,'0')
	order by  coalesce(cd_procedimento,0),
		  coalesce(cd_grupo_proc,0),
		  coalesce(cd_especialidade,0),
		  coalesce(cd_area_procedimento,0),
		  coalesce(cd_setor_atendimento,0),
		  coalesce(ie_classificacao,'0'),
		  coalesce(cd_unidade_basica, '0'),
		  coalesce(cd_unidade_compl, '0');





BEGIN

select	ie_status_acerto
into STRICT	ie_status_acerto_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p;

if (ie_status_acerto_w = 2) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(192255);
end if;

ie_pacote_w:= obter_valor_param_usuario(1116, 22, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

open	c01;
loop
fetch	c01 into
	nr_sequencia_w,
	qt_item_w,
	vl_item_w,
	nr_seq_kit_est_w,
	nr_seq_lote_w,
	cd_medico_autenticacao_w,
	cd_setor_original_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(obter_se_exige_auditoria(nr_sequencia_w,1))
	into STRICT	ie_exige_auditoria_w
	;

	select	nextval('auditoria_matpaci_seq')
	into STRICT	nr_seq_item_w
	;

	ds_mat_kit_est_w:= ' ';
	begin
	select 	substr(obter_desc_kit_estoque(nr_seq_kit_est_w),1,150)
	into STRICT	ds_mat_kit_est_w
	
	where 	nr_seq_kit_est_w <> 0;
	exception
	when others then
		ds_mat_kit_est_w:= ' ';
	end;

	insert	into auditoria_matpaci(nr_sequencia,
		nr_seq_auditoria,
		nr_seq_matpaci,
		dt_atualizacao,
		nm_usuario,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		NR_SEQ_MOTIVO,
		QT_ORIGINAL,
		QT_AJUSTE,
		DS_JUSTIFICATIVA,
		ie_tipo_auditoria,
		ie_perda,
		vl_material,
		ie_exige_auditoria,
		nr_seq_kit_est,
		ds_mat_kit_est,
		nr_seq_lote,
		cd_medico_autenticacao,
		cd_setor_original,
		ie_original)
	values (nr_seq_item_w,
		nr_seq_auditoria_p,
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		qt_item_w,
		null,
		null, 'A', 'N',
		vl_item_w,
		ie_exige_auditoria_w,
		nr_seq_kit_est_w,
		ds_mat_kit_est_w,
		nr_seq_lote_w,
		cd_medico_autenticacao_w,
		cd_setor_original_w,
		'S');

	update	material_atend_paciente
	set	ie_auditoria	= 'A'
	where	nr_sequencia	= nr_sequencia_w;

	end;
end loop;
close c01;


open	c02;
loop
fetch	c02 into
	nr_sequencia_w,
	qt_item_w,
	tx_procedimento_w,
	vl_item_w,
	cd_setor_original_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	select	max(obter_se_exige_auditoria(nr_sequencia_w,2))
	into STRICT	ie_exige_auditoria_w
	;

	select	nextval('auditoria_propaci_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_propaci(nr_sequencia,
		nr_seq_auditoria,
		nr_seq_propaci,
		dt_atualizacao,
		nm_usuario,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		NR_SEQ_MOTIVO,
		QT_ORIGINAL,
		QT_AJUSTE,
		DS_JUSTIFICATIVA,
		TX_PROC_ORIGINAL,
		ie_tipo_auditoria,
		ie_perda,
		vl_procedimento,
		ie_exige_auditoria,
		cd_setor_original,
		ie_original)
	values (nr_seq_item_w,
		nr_seq_auditoria_p,
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		qt_item_w,
		null,
		null,
		coalesce(tx_procedimento_w,0), 'A', 'N',
		vl_item_w,
		ie_exige_auditoria_w,
		cd_setor_original_w,
		'S');

	update	procedimento_paciente
	set	ie_auditoria	= 'A'
	where	nr_sequencia	= nr_sequencia_w;

	end;
end loop;
close c02;


open	c03;
loop
fetch	c03 into
	nr_sequencia_w,
	qt_item_w,
	vl_item_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_w,
	cd_setor_atendimento_w,
	dt_entrada_unidade_w,
	nr_seq_atepacu_w,
	nr_atendimento_w,
	nr_seq_kit_est_w,
	nr_seq_lote_w,
	cd_medico_autenticacao_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin

	select	max(cd_unidade_basica),
		max(cd_unidade_compl)
	into STRICT	cd_unidade_basica_w,
		cd_unidade_compl_w
	from	atend_paciente_unidade
	where	nr_atendimento = nr_atendimento_w
	and	dt_entrada_unidade = dt_entrada_unidade_w
	and	nr_seq_interno = nr_seq_atepacu_w
	and	cd_setor_atendimento = cd_setor_atendimento_w;

	ie_regra_w := 'S';

	ds_mat_kit_est_w:= ' ';
	begin
	select 	substr(obter_desc_kit_estoque(nr_seq_kit_est_w),1,150)
	into STRICT	ds_mat_kit_est_w
	
	where 	nr_seq_kit_est_w <> 0;
	exception
	when others then
		ds_mat_kit_est_w:= ' ';
	end;

	select 	count(*)
	into STRICT	qt_regra_w
	from  	regra_auditoria_mat
	where 	nr_seq_regra_auditoria =  nr_seq_regra_audit_p;

	if (qt_regra_w > 0) then

		ie_regra_w:= 'N';
		--Abrir o cursor da regra e verificar se tem regra ou não.
		open C05;
		loop
		fetch C05 into
			ie_regra_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin

			ie_regra_w:= 'S';

			end;
		end loop;
		close C05;

	end if;

	if (ie_regra_w = 'S') then

		select	max(obter_se_exige_auditoria(nr_sequencia_w,1))
		into STRICT	ie_exige_auditoria_w
		;

		select	nextval('auditoria_matpaci_seq')
		into STRICT	nr_seq_item_w
		;

		insert	into auditoria_matpaci(nr_sequencia,
			nr_seq_auditoria,
			nr_seq_matpaci,
			dt_atualizacao,
			nm_usuario,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			NR_SEQ_MOTIVO,
			QT_ORIGINAL,
			QT_AJUSTE,
			DS_JUSTIFICATIVA,
			ie_tipo_auditoria,
			ie_perda,
			vl_material,
			ie_exige_auditoria,
			nr_seq_kit_est,
			ds_mat_kit_est,
			nr_seq_lote,
			cd_medico_autenticacao,
			cd_setor_original,
			ie_original)
		values (nr_seq_item_w,
			nr_seq_auditoria_p,
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			qt_item_w,
			null,
			null, 'A', 'N',
			vl_item_w,
			ie_exige_auditoria_w,
			nr_seq_kit_est_w,
			ds_mat_kit_est_w,
			nr_seq_lote_w,
			cd_medico_autenticacao_w,
			cd_setor_atendimento_w,
			'S');

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

	end if;

	end;
end loop;
close c03;


open	c04;
loop
fetch	c04 into
	nr_sequencia_w,
	qt_item_w,
	tx_procedimento_w,
	vl_item_w,
	cd_area_procedimento_w,
	cd_especialidade_w,
	cd_grupo_proc_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_setor_atendimento_w,
	dt_entrada_unidade_w,
	nr_seq_atepacu_w,
	nr_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin

	select	max(cd_unidade_basica),
		max(cd_unidade_compl)
	into STRICT	cd_unidade_basica_w,
		cd_unidade_compl_w
	from	atend_paciente_unidade
	where	nr_atendimento = nr_atendimento_w
	and	dt_entrada_unidade = dt_entrada_unidade_w
	and	nr_seq_interno = nr_seq_atepacu_w
	and	cd_setor_atendimento = cd_setor_atendimento_w;

	select 	max(ie_classificacao)
	into STRICT	ie_classificacao_w
	from 	procedimento
	where 	cd_procedimento = cd_procedimento_w
	and 	ie_origem_proced = ie_origem_proced_w;

	ie_regra_w:= 'S';

	select 	count(*)
	into STRICT	qt_regra_w
	from  	regra_auditoria_proc
	where 	nr_seq_regra_auditoria =  nr_seq_regra_audit_p;

	if (qt_regra_w > 0) then

		ie_regra_w:= 'N';
		--Abrir o cursor da regra e verificar se tem regra ou não.
		open C06;
		loop
		fetch C06 into
			ie_regra_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin

			ie_regra_w:= 'S';

			end;
		end loop;
		close C06;

	end if;

	if (ie_regra_w = 'S') then

		select	max(obter_se_exige_auditoria(nr_sequencia_w,2))
		into STRICT	ie_exige_auditoria_w
		;

		select	nextval('auditoria_propaci_seq')
		into STRICT	nr_seq_item_w
		;

		insert	into auditoria_propaci(nr_sequencia,
			nr_seq_auditoria,
			nr_seq_propaci,
			dt_atualizacao,
			nm_usuario,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			NR_SEQ_MOTIVO,
			QT_ORIGINAL,
			QT_AJUSTE,
			DS_JUSTIFICATIVA,
			TX_PROC_ORIGINAL,
			ie_tipo_auditoria,
			ie_perda,
			vl_procedimento,
			ie_exige_auditoria,
			cd_setor_original,
			ie_original)
		values (nr_seq_item_w,
			nr_seq_auditoria_p,
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			qt_item_w,
			null,
			null,
			coalesce(tx_procedimento_w,0), 'A', 'N',
			vl_item_w,
			ie_exige_auditoria_w,
			cd_setor_atendimento_w,
			'S');

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

	end if;

	end;
end loop;
close c04;


if (coalesce(nr_seq_regra_audit_p,0) = 0) then

	ds_filtros_auditoria_w	:='dt_periodo_inicial='||to_Char(dt_periodo_inicial_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'dt_periodo_final='||to_char(dt_periodo_final_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'ie_tipo_data='||ie_tipo_data_p||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_p||';'||
			'nr_prescricao='||nr_prescricao_p||';'||
			'ie_nao_auditados='||ie_nao_auditados_p||';'||
			'ie_proc_mat='||ie_proc_mat_p||';'||
			'cd_area_proc='||cd_area_proc_p||';'||
			'cd_especialidade='||cd_especialidade_p||';'||
			'cd_grupo_proc='||cd_grupo_proc_p||';'||
			'cd_grupo_mat='||cd_grupo_mat_p||';'||
			'cd_subgrupo='||cd_subgrupo_p||';'||
			'cd_classe='||cd_classe_p ||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_p||';'||
			'vl_min_audit='||vl_min_audit_p||';'||
			'vl_max_audit='||vl_max_audit_p||';'||
			'nr_doc_interno='||nr_doc_interno_p;

	update	auditoria_conta_paciente
	set	dt_periodo_inicial = dt_periodo_inicial_p,
		dt_periodo_final = dt_periodo_final_p,
		ds_filtros = ds_filtros_auditoria_w,
		vl_auditoria_orig = obter_valor_auditoria(nr_seq_auditoria_p, nr_interno_conta_p),
		cd_setor_atendimento = cd_setor_atendimento_p,
		nr_seq_regra_audit = nr_seq_regra_audit_p
	where	nr_sequencia = nr_seq_auditoria_p;

else

	ds_filtros_auditoria_w	:='dt_periodo_inicial='||to_Char(dt_periodo_inicial_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'dt_periodo_final='||to_char(dt_periodo_final_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'ie_tipo_data='||ie_tipo_data_p||';'||
		--	'cd_setor_atendimento='||cd_setor_atendimento_w||';'||
			'nr_prescricao='||nr_prescricao_p||';'||
			'ie_nao_auditados='||ie_nao_auditados_p||';'||
			'ie_proc_mat='||ie_proc_mat_p||';';
		--	'cd_area_proc='||cd_area_procedimento_w||';'||
		--	'cd_especialidade='||cd_especialidade_w||';'||
		--	'cd_grupo_proc='||cd_grupo_proc_w||';'||
		--	'cd_grupo_mat='||cd_grupo_material_w||';'||
		--	'cd_subgrupo='||cd_subgrupo_material_w||';'||
		--	'cd_classe='||cd_classe_material_w ||';'||
		--	'cd_setor_atendimento='||cd_setor_atendimento_w;
	update	auditoria_conta_paciente
	set	dt_periodo_inicial = dt_periodo_inicial_p,
		dt_periodo_final = dt_periodo_final_p,
		ds_filtros = ds_filtros_auditoria_w,
		vl_auditoria_orig = obter_valor_auditoria(nr_seq_auditoria_p, nr_interno_conta_p),
		cd_setor_atendimento = cd_setor_atendimento_w,
		nr_seq_regra_audit = nr_seq_regra_audit_p
	where	nr_sequencia = nr_seq_auditoria_p;

end if;

ie_resumo_auditoria_w := coalesce(obter_valor_param_usuario(1116, 193, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'S');

if (ie_resumo_auditoria_w = 'S') then
	CALL Atualizar_Resumo_Auditoria(nr_seq_auditoria_p,'I',nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_auditoria (nr_seq_auditoria_p bigint, nr_interno_conta_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, ie_tipo_data_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p text, ie_nao_auditados_p text, ie_proc_mat_p text, cd_area_proc_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_grupo_mat_p bigint, cd_subgrupo_p bigint, cd_classe_p bigint, nm_usuario_p text, nr_seq_regra_audit_p bigint, vl_min_audit_p bigint, vl_max_audit_p bigint, nr_doc_interno_p text) FROM PUBLIC;

