-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_ci_email_baixa_req ( nr_requisicao_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_motivo_baixa_w		varchar(255);
nm_usuario_destino_w	varchar(15);
ds_titulo_w		varchar(80);
ds_comunicacao_w		varchar(2000);
ds_lista_material_w		varchar(2000);
nr_seq_classif_w		bigint;
cd_material_w		integer;
ds_material_w		varchar(255);
qt_mat_baixa_w		bigint;
ds_email_destino_w		varchar(255);
dt_atendimento_w		timestamp;
nm_pessoa_atend_w	varchar(255);

c01 CURSOR FOR 
SELECT	cd_material, 
	substr(obter_desc_material(cd_material),1,255), 
	substr(obter_nome_pessoa_fisica(cd_pessoa_atende,null),1,255), 
	dt_atendimento 
from	item_requisicao_material 
where	nr_requisicao = nr_requisicao_p 
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) <> 1 
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) <> 0 
order by	dt_atendimento desc;

c02 CURSOR FOR 
SELECT	cd_material, 
	substr(obter_desc_material(cd_material),1,255), 
	substr(obter_nome_pessoa_fisica(cd_pessoa_atende,null),1,255), 
	dt_atendimento 
from	item_requisicao_material 
where	nr_requisicao = nr_requisicao_p 
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 1 
order by	dt_atendimento desc;


BEGIN 
 
ds_titulo_w := Wheb_mensagem_pck.get_Texto(299738, 'NR_REQUISICAO_P='||NR_REQUISICAO_P);
		/*Atendimento da requisição número #@NR_REQUISICAO_P#@.*/
 
 
 
select	count(*) 
into STRICT	qt_mat_baixa_w 
from	item_requisicao_material 
where	nr_requisicao = nr_requisicao_p 
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) <> 0;
 
if (qt_mat_baixa_w > 0) then 
	begin 
 
	if (obter_tipo_motivo_baixa_req(cd_motivo_baixa_p) <> 1) then 
		begin 
 
		select	substr(obter_desc_motivo_baixa_req(cd_motivo_baixa_p),1,80) 
		into STRICT	ds_motivo_baixa_w 
		;
 
		open C01;
		loop 
		fetch C01 into	 
			cd_material_w, 
			ds_material_w, 
			nm_pessoa_atend_w, 
			dt_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin		 
			ds_lista_material_w := 	WHEB_MENSAGEM_PCK.get_texto(299741, 
							'DS_LISTA_MATERIAL_W='|| DS_LISTA_MATERIAL_W || 
							';CD_MATERIAL_W='|| CD_MATERIAL_W || 
							';DS_MATERIAL_W='|| DS_MATERIAL_W || 
							';DT_ATENDIMENTO_W='|| to_char(dt_atendimento_w,'dd/mm/yyyy hh24:mm:ss') || 
							';NM_PESSOA_ATEND_W='|| NM_PESSOA_ATEND_W);
						/*#@DS_LISTA_MATERIAL_W#@ #@CD_MATERIAL_W#@ - #@DS_MATERIAL_W#@ 
						Dt. Atendimento: #@DT_ATENDIMENTO_W#@ Pessoa Atendimento: #@NM_PESSOA_ATEND_W#@*/
 
			end;
		end loop;
		close C01;
 
		ds_comunicacao_w := 	substr(WHEB_MENSAGEM_PCK.get_texto(299747, 
						'NR_REQUISICAO_P='|| NR_REQUISICAO_P || 
						';DS_MOTIVO_BAIXA_W='|| DS_MOTIVO_BAIXA_W || 
						';DS_LISTA_MATERIAL_W='|| DS_LISTA_MATERIAL_W),1,2000);	
						/*Os materais abaixo relacionados não foram atendidos na requisição número #@NR_REQUISICAO_P#@. 
						Motivo de baixa: #@DS_MOTIVO_BAIXA_W#@. 
 
						#@DS_LISTA_MATERIAL_W#@*/
 
		end;
	end if;
 
	if (obter_tipo_motivo_baixa_req(cd_motivo_baixa_p) = 1) then 
		begin 
 
		open C02;
		loop 
		fetch C02 into	 
			cd_material_w, 
			ds_material_w, 
			nm_pessoa_atend_w, 
			dt_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin		 
			ds_lista_material_w := 	WHEB_MENSAGEM_PCK.get_texto(299741, 
							'DS_LISTA_MATERIAL_W='|| DS_LISTA_MATERIAL_W || 
							';CD_MATERIAL_W='|| CD_MATERIAL_W || 
							';DS_MATERIAL_W='|| DS_MATERIAL_W || 
							';DT_ATENDIMENTO_W='|| to_char(dt_atendimento_w,'dd/mm/yyyy hh24:mm:ss') || 
							';NM_PESSOA_ATEND_W='|| NM_PESSOA_ATEND_W);
						/*#@DS_LISTA_MATERIAL_W#@ #@CD_MATERIAL_W#@ - #@DS_MATERIAL_W#@ 
						Dt. Atendimento: #@DT_ATENDIMENTO_W#@ Pessoa Atendimento: #@NM_PESSOA_ATEND_W#@*/
			 
			end;
		end loop;
		close C02;
		 
		ds_comunicacao_w := 	substr(WHEB_MENSAGEM_PCK.get_texto(299749, 
						'NR_REQUISICAO_P='|| NR_REQUISICAO_P ||						 
						';DS_LISTA_MATERIAL_W='|| DS_LISTA_MATERIAL_W),1,2000);	
						/*Os materais abaixo relacionados foram atendidos na requisição número #@NR_REQUISICAO_P#@. 
						Motivo de baixa: Baixa normal. 
 
						#@DS_LISTA_MATERIAL_W#@*/
 
		end;
	end if;
 
	select	obter_usuario_pessoa(cd_pessoa_requisitante) 
	into STRICT	nm_usuario_destino_w 
	from	requisicao_material 
	where	nr_requisicao = nr_requisicao_p;
 
	if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') then 
		begin 
	 
		select	max(obter_classif_comunic('F')) 
		into STRICT	nr_seq_classif_w 
		;
 
		CALL Gerar_Comunic_Padrao( 
			clock_timestamp(), 
			ds_titulo_w, 
			ds_comunicacao_w, 
			nm_usuario_p, 
			'N', 
			nm_usuario_destino_w, 
			'N', 
			nr_seq_classif_w, 
			'','','',clock_timestamp(),'','');
		 
		commit;
 
		select	ds_email 
		into STRICT	ds_email_destino_w 
		from	usuario 
		where	nm_usuario = nm_usuario_destino_w;
		 
		if (coalesce(ds_email_destino_w::text, '') = '') then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265978);
			--'Não encontrado o e-mail do requisitante!' 
		end if;
			 
		CALL Enviar_Email(ds_titulo_w,ds_comunicacao_w, null, ds_email_destino_w, nm_usuario_p,'M');
 
		end;
	end if;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_ci_email_baixa_req ( nr_requisicao_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text) FROM PUBLIC;

