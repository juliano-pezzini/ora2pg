-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_lote_prescr_pendente ( dt_parametro_p timestamp) AS $body$
DECLARE


qt_dias_baixa_ap_lote_w		bigint := 15;
nr_sequencia_w				ap_lote.nr_sequencia%type;
nr_prescricao_w				prescr_medica.nr_prescricao%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_lote_agrupamento_w		ap_lote.nr_lote_agrupamento%type;
qt_lote_pendente_w			integer;
nr_lote_pendente_w			ap_lote.nr_sequencia%type;
ie_status_lote_w			ap_lote.ie_status_lote%type;		
dt_atend_farmacia_w			ap_lote.dt_atend_farmacia%type;
dt_entrega_setor_w			ap_lote.dt_entrega_setor%type;
dt_inicio_dispensacao_w		ap_lote.dt_inicio_dispensacao%type;
dt_recebimento_setor_w		ap_lote.dt_recebimento_setor%type;
nm_usuario_atend_w			ap_lote.nm_usuario_atend%type;
nm_usuario_disp_w			ap_lote.nm_usuario_disp%type;
nm_usuario_entrega_w		ap_lote.nm_usuario_entrega%type;
nm_usuario_receb_w			ap_lote.nm_usuario_receb%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
			nr_prescricao
	from	ap_lote
	where	ie_status_lote	= 'G'
	and 	coalesce(ie_agrupamento,'N') = 'N'
	and		dt_geracao_lote between(dt_parametro_p - 90) and dt_parametro_p;


BEGIN

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	coalesce(max(cd_estabelecimento),1)
	into STRICT	cd_estabelecimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;
	
	select	coalesce(max(qt_dias_baixa_ap_lote),0)
	into STRICT	qt_dias_baixa_ap_lote_w
	from	parametros_farmacia
	where	coalesce(qt_dias_baixa_ap_lote,0) > 0
	and		cd_estabelecimento = cd_estabelecimento_w;

	if (qt_dias_baixa_ap_lote_w > 0) then
		begin

		update	ap_lote
		set		ie_status_lote	= 'C',
				dt_cancelamento	= clock_timestamp(),
				nm_usuario_cancelamento = 'JOB BLPP_J'
		where	nr_sequencia = nr_sequencia_w
		and (dt_geracao_lote + qt_dias_baixa_ap_lote_w) < dt_parametro_p;
		
		select	coalesce(max(nr_lote_agrupamento),0)
		into STRICT	nr_lote_agrupamento_w
		from 	ap_lote
		where 	nr_sequencia = nr_sequencia_w;
		
		if (nr_lote_agrupamento_w > 0) then
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_lote_pendente_w
			from	ap_lote
			where 	nr_lote_agrupamento = nr_lote_agrupamento_w
			and 	ie_status_lote not in ('C','S','CA');
			
			if (nr_lote_pendente_w = 0) then
				update	ap_lote
				set		ie_status_lote	= 'C',
						dt_cancelamento	= clock_timestamp(),
						nm_usuario_cancelamento = 'JOB BLPP_J'
				where	nr_sequencia = nr_lote_agrupamento_w;
			else
				
				select 	max(ie_status_lote),
						max(dt_atend_farmacia),
						max(dt_entrega_setor),
						max(dt_inicio_dispensacao),
						max(dt_recebimento_setor),
						max(nm_usuario_atend),
						max(nm_usuario_disp),
						max(nm_usuario_entrega),
						max(nm_usuario_receb)
				into STRICT	ie_status_lote_w,
						dt_atend_farmacia_w,
						dt_entrega_setor_w,
						dt_inicio_dispensacao_w,
						dt_recebimento_setor_w,
						nm_usuario_atend_w,
						nm_usuario_disp_w,
						nm_usuario_entrega_w,
						nm_usuario_receb_w
				from	ap_lote
				where 	nr_sequencia = nr_lote_pendente_w;

				select	count(*)
				into STRICT	qt_lote_pendente_w
				from	ap_lote
				where 	nr_lote_agrupamento = nr_lote_agrupamento_w
				and 	ie_status_lote = 'G';

				if (qt_lote_pendente_w = 0) then
					update	ap_lote
					set		ie_status_lote			= ie_status_lote_w,
							dt_atend_farmacia		= dt_atend_farmacia_w,
							dt_entrega_setor		= dt_entrega_setor_w,
							dt_inicio_dispensacao	= dt_inicio_dispensacao_w,
							dt_recebimento_setor	= dt_recebimento_setor_w,
							nm_usuario_atend		= nm_usuario_atend_w,
							nm_usuario_disp			= nm_usuario_disp_w,
							nm_usuario_entrega		= nm_usuario_entrega_w,
							nm_usuario_receb		= nm_usuario_receb_w						
					where	nr_sequencia 			= nr_lote_agrupamento_w;
				end if;
			end if;		
		end if;
		end;
	end if;	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_lote_prescr_pendente ( dt_parametro_p timestamp) FROM PUBLIC;

