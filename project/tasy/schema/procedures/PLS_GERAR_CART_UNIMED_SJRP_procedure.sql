-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cart_unimed_sjrp ( nr_seq_lote_p bigint, cd_interface_p bigint, nr_seq_usuario_ops_p_p bigint, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
ds_header_w			varchar(4000);
ds_sub_header_w			varchar(4000);
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(250);
tp_contratacao_w		varchar(30);
dt_nascimento_w			varchar(20);
dt_validade_carteira_w		varchar(20);
cd_local_cobranca_w		varchar(20);
ds_produto_w			varchar(50);
cd_abrangencia_w		varchar(50);
ds_abrangencia_w		varchar(50);
ds_registro_ans_w		varchar(50);
ds_acomodacao_w			varchar(50);
cod_empresa_w			bigint;
ds_mensagem_cpt_w		varchar(15);
nm_empresa_w			varchar(50);
ds_rede_atendimento_w		varchar(50);
ds_carencia_ww			varchar(4000);
ds_carencia_w			varchar(4000);
ds_observacao_1_w		varchar(255);
ds_observacao_2_w		varchar(255);
tp_contrato_w			varchar(10);
nr_via_solicitacao_w		bigint;
ds_regiao_w			varchar(4000);
ds_trilha_2_w			pls_segurado_carteira.ds_trilha2%type;
nr_protocolo_ans_w		varchar(100);
dt_contratacao_w		timestamp;
ds_mensagem_w			varchar(100);
dt_inclusao_operadora_w		timestamp;
qt_carencias_w			bigint;
nm_abreviado_w			varchar(255);
nr_seq_contrato_w		bigint;
ds_mensagem_cart_w		varchar(255);
dt_geracao_w			varchar(10);
dt_contrato_w			varchar(10);
IE_NOVA_REGULAMENTACAO_w	varchar(10);
cd_plano_w			varchar(255);
nr_seq_intercambio_w		bigint;
cd_matricula_estipulante_w	varchar(30);
ds_mens_carencia_w		varchar(255);
qt_lida_mensagens_w		bigint;
ds_abrangencia_aux_w		varchar(255);
ds_segmentacao_w		varchar(255);
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
ie_regulamentacao_w		pls_plano.ie_regulamentacao%type;
nm_administradora_w		w_pls_interface_carteira.nm_administradora%type;	
ds_estipulante_w		varchar(255);	
nr_seq_intercambio_benef_w	pls_segurado.nr_seq_intercambio_benef%type;
cd_interface_w			bigint;
qt_carteira_contrato_w		bigint;
----------------------------------------------------------------------
cd_cgc_estipulante_w		varchar(20);
cd_pf_estipulante_w		varchar(20);
i				bigint;
qt_registros_w			bigint;
nr_seq_plano_w			bigint;
nr_seq_regiao_w			bigint;
ds_municipio_w			varchar(255);
ie_tipo_contrato_w		varchar(10);
ie_tipo_segurado_w		varchar(10);
ds_congenere_w			varchar(255);
ds_regiao_1_w			varchar(100);
ds_regiao_2_w			varchar(100);
ds_regiao_3_w			varchar(100);
ds_regiao_4_w			varchar(100);
ds_regiao_5_w			varchar(100);
ie_cpt_1044_w			varchar(1);
ds_mensagemAbran_w    		varchar(255);
ie_tipo_contrato_benef_w	varchar(1);
cd_rede_refer_ptu_w		pls_plano.cd_rede_refer_ptu%type;
qt_mensagem_cart_w		integer := 0;
nr_cartao_nac_sus_w		pessoa_fisica.nr_cartao_nac_sus%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_segurado,
		'C'
	from	pls_segurado_carteira	a,
		pls_segurado		b,
		pls_carteira_emissao	c,
		pls_lote_carteira	d,
		pls_contrato		e
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	c.nr_seq_seg_carteira	= a.nr_sequencia
	and	c.nr_seq_lote		= d.nr_sequencia
	and	b.nr_seq_contrato	= e.nr_sequencia
	and	d.nr_sequencia		= nr_seq_lote_p
	
union all

	SELECT	b.nr_sequencia nr_seq_segurado,
		'I'
	from	pls_segurado_carteira	a,
		pls_segurado		b,
		pls_carteira_emissao	c,
		pls_lote_carteira	d,
		pls_intercambio		e
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	c.nr_seq_seg_carteira	= a.nr_sequencia
	and	c.nr_seq_lote		= d.nr_sequencia
	and	b.nr_seq_intercambio	= e.nr_sequencia
	and	d.nr_sequencia		= nr_seq_lote_p
	
union all

	select	nr_seq_segurado,
		coalesce(ie_tipo_contrato_benef_w, 'C')
	from	pls_segurado_carteira
	where	cd_usuario_plano = cd_usuario_plano_p;
	

c02 CURSOR FOR
	SELECT	upper(coalesce(b.DS_ABREVIACAO,b.ds_municipio))
	from	pls_regiao_local	a,
		sus_municipio		b
	where	a.cd_municipio_ibge	= b.cd_municipio_ibge
	and	a.nr_seq_regiao		= nr_seq_regiao_w
	order by b.ds_municipio;
	
C03 CURSOR FOR	
	SELECT	ds_mensagem
	from	pls_contrato_mensagem_cart
	where	nr_seq_contrato	= nr_seq_contrato_w
	and	clock_timestamp()	between dt_inicio_vigencia and fim_dia(dt_fim_vigencia)
	and	ie_situacao	= 'A'
	and	ie_mensagem_carencia = 'S'
	and	ie_tipo_contrato_w = 'C'
	
union all

	SELECT	ds_mensagem
	from	pls_contrato_mensagem_cart
	where	nr_seq_intercambio	= nr_seq_intercambio_w
	and	clock_timestamp()	between dt_inicio_vigencia and fim_dia(dt_fim_vigencia)
	and	ie_situacao	= 'A'
	and	ie_mensagem_carencia = 'S'
	and	ie_tipo_contrato_w = 'I';

C04 CURSOR FOR
	SELECT	a.Carencia
	from	(SELECT	a.*,
			min(prioridade ) over () min_prioridade
		from	(select	substr(CASE WHEN Ie_Padrao_Carteira='N' THEN  ds_carencia  ELSE ds_carencia_carteira END ,1,21) ||';'||
				CASE WHEN 	ie_isenta_carencia='N' THEN 					(CASE					when 	((coalesce(dt_fim_vigencia,dt_validade) >= clock_timestamp()) and (qt_dias > 0)) then						to_char(coalesce(dt_fim_vigencia, dt_validade), 'dd/MM/yyyy')					when(coalesce(dt_fim_vigencia, dt_validade) < clock_timestamp()) THEN						'CUMPRIDA'					when 	qt_dias = 0 THEN						'ISENTA'					end)  ELSE 'ISENTA' END  carencia, 
				1 prioridade
			from  	pls_carencia_beneficiario_v
			where 	nr_seq_segurado =  nr_seq_segurado_w /*1673048*/
			and 	ie_padrao_carteira = 'S' 
			
union all

			select 	substr(CASE WHEN Ie_Padrao_Carteira='N' THEN  ds_carencia  ELSE ds_carencia_carteira END ,1,21) ||';'||
				CASE WHEN 	ie_isenta_carencia='N' THEN 					(CASE					when 	((coalesce(dt_fim_vigencia, dt_validade) >= clock_timestamp()) and (qt_dias > 0)) then						to_char(coalesce(dt_fim_vigencia, dt_validade), 'dd/MM/yyyy')					when(coalesce(dt_fim_vigencia, dt_validade) < clock_timestamp()) THEN						'CUMPRIDA'					when 	qt_dias = 0 THEN						'ISENTA'					end)  ELSE 'ISENTA' END  carencia, 
				2 prioridade
			from  	pls_carencia_beneficiario_v
			where 	nr_seq_segurado_p = nr_seq_segurado_w /*1673048*/
			and 	ie_padrao_carteira = 'S'  LIMIT 10) a
		) a
	
	where (a.prioridade = a.min_prioridade);
	

BEGIN

if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	cd_interface_w	:= cd_interface_p;
	
	ds_header_w := 	'"Codigo_Usuario";"Nome_Usuario";"Data_Nascimento";"Data_Vencimento";"Codigo_Plano";"Descricao_Plano";"Acomodacao";"Tarja_Magnetica";"Data_Geracao";"Via_Cartao";"Nova_Legislacao";'||
			'"Inicio_Contrato";"Tipo_Contrato";"Codigo_ANS";"Mensagem_Cadastro";"Mensagem_Area";"DOENCA_PRE";"TXDESCRICAO";"CAR1";"DT_CAR1";"CAR2";"DT_CAR2";"CAR3";'||
			'"DT_CAR3";"CAR4";"DT_CAR4";"CAR5";"DT_CAR5";"CAR6";"DT_CAR6";"CAR7";"DT_CAR7";"CAR8";"DT_CAR8";"CAR9";"DT_CAR9";"CAR10";"DT_CAR10";"AONOVA_LEGISLACAO";"CDCONTRATO";"CDAREAACAO_COBRANCA";"CDNATUREZA";"CDUSUARIO_EMPRESA";"COD_REDE";"Abr";'||
			'"abrangencia1";"abrangencia2";"abrangencia3";"abrangencia4";"abrangencia5";"REDE_ATEND";'||
			'"'||wheb_mensagem_pck.get_texto(1191064)||'";"segmentacao";"administradora";"contratante";"badgetype"';
			
	delete	FROM w_pls_interface_carteira
	where	nr_seq_lote	= nr_seq_lote_p;

	insert into w_pls_interface_carteira(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_lote,ds_header,ie_tipo_reg)
	values (	nextval('w_pls_interface_carteira_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_lote_p,ds_header_w,1);
else
	select	CASE WHEN coalesce(a.nr_seq_contrato::text, '') = '' THEN  CASE WHEN coalesce(a.nr_seq_intercambio::text, '') = '' THEN  'E'  ELSE 'I' END   ELSE 'C' END
	into STRICT	ie_tipo_contrato_benef_w
	from	pls_segurado a,
		pls_segurado_carteira b
	where	a.nr_sequencia = b.nr_seq_segurado
	and	b.cd_usuario_plano = cd_usuario_plano_p;
	
	if (ie_tipo_contrato_benef_w = 'C') then
		select	count(1)
		into STRICT	qt_carteira_contrato_w
		from	pls_estipulante_web a,
			pls_contrato b,
			pls_segurado c,
			pls_segurado_carteira d
		where	b.nr_sequencia = a.nr_seq_contrato
		and	a.nr_sequencia = nr_seq_usuario_ops_p_p
		and	b.nr_sequencia = c.nr_seq_contrato
		and	c.nr_sequencia = d.nr_seq_segurado
		and	d.cd_usuario_plano = cd_usuario_plano_p;
		
		if (qt_carteira_contrato_w = 0) then
			select	count(1)
			into STRICT	qt_carteira_contrato_w
			from	pls_grupo_contrato_web a,
				pls_grupo_contrato b,
				pls_contrato c,
				pls_segurado d,
				pls_segurado_carteira e,
				pls_contrato_grupo f
			where	b.nr_sequencia = a.nr_seq_grupo_contrato
			and	b.nr_sequencia = f.nr_seq_grupo
			and	c.nr_sequencia = f.nr_seq_contrato
			and	c.nr_sequencia = d.nr_seq_contrato
			and	d.nr_sequencia = e.nr_seq_segurado
			and	a.nr_sequencia = nr_seq_usuario_ops_p_p
			and	e.cd_usuario_plano = cd_usuario_plano_p;
		end if;
	elsif (ie_tipo_contrato_benef_w = 'I') then
		select	count(1)
		into STRICT	qt_carteira_contrato_w
		from	pls_estipulante_web a,
			pls_intercambio b,
			pls_segurado c,
			pls_segurado_carteira d
		where	b.nr_sequencia = a.nr_seq_contrato_int
		and	a.nr_sequencia = nr_seq_usuario_ops_p_p
		and	b.nr_sequencia = c.nr_seq_intercambio
		and	c.nr_sequencia = d.nr_seq_segurado
		and	d.cd_usuario_plano = cd_usuario_plano_p;
		
		if (qt_carteira_contrato_w = 0) then
			select	count(1)
			into STRICT	qt_carteira_contrato_w
			from	pls_grupo_contrato_web a,
				pls_grupo_contrato b,
				pls_intercambio c,
				pls_segurado d,
				pls_segurado_carteira e,
				pls_contrato_grupo f
			where	b.nr_sequencia = a.nr_seq_grupo_contrato
			and	b.nr_sequencia = f.nr_seq_grupo
			and	c.nr_sequencia = f.nr_seq_intercambio
			and	c.nr_sequencia = d.nr_seq_intercambio
			and	d.nr_sequencia = e.nr_seq_segurado
			and	a.nr_sequencia = nr_seq_usuario_ops_p_p
			and	e.cd_usuario_plano = cd_usuario_plano_p;
		end if;
	else
		qt_carteira_contrato_w	:= 0;
	end if;
			
	if (qt_carteira_contrato_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1159914);
	end if;
	
	cd_interface_w	:= '2720';
	
	delete from w_pls_interface_carteira
	where	coalesce(nr_seq_lote::text, '') = ''
	and	cd_usuario_plano = cd_usuario_plano_p;
end if;

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	ie_tipo_contrato_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	nm_abreviado_w	:= '';

	if (ie_tipo_contrato_w = 'C') then
		select	c.cd_usuario_plano,
			substr(a.nm_pessoa_fisica,1,60),
			to_char(a.dt_nascimento,'dd/mm/yyyy'),
			substr(d.ds_plano,1,50) ds_produto,
			substr(coalesce(pls_obter_dados_cart_unimed(b.nr_sequencia,d.nr_sequencia,'DASJ',1),upper(wheb_mensagem_pck.get_texto(1191029))),1,50),
			to_char(c.dt_validade_carteira,'dd/mm/yyyy'),
			f.cd_cgc_estipulante,
			d.ie_tipo_contratacao,
			d.ie_regulamentacao,
			CASE WHEN D.ie_regulamentacao='R' THEN 'NAO'  ELSE 'SIM' END ,
			b.cd_operadora_empresa,
			CASE WHEN d.ie_abrangencia='GM' THEN 'Abrangencia'  ELSE '' END ,
			upper(Obter_Valor_Dominio(1667,d.ie_abrangencia)),
			c.nr_via_solicitacao,
			d.nr_sequencia,
			CASE WHEN d.ie_tipo_contratacao='I' THEN 'P'  ELSE 'E' END ,
			coalesce(d.nr_protocolo_ans,f.cd_scpa),
			replace(replace(ds_trilha2,';',''),'?',''),
			f.cd_pf_estipulante,
			b.dt_contratacao,
			b.dt_inclusao_operadora,
			b.ie_tipo_segurado,
			substr(a.nm_abreviado,1,25),
			f.nr_sequencia,
			to_char(c.dt_solicitacao,'dd/mm/yyyy'),
			to_char(f.dt_contrato,'dd/mm/yyyy'),
			d.cd_codigo_ant,
			b.cd_matricula_estipulante,
			a.nr_cartao_nac_sus,
			upper(obter_valor_dominio(1665,d.ie_segmentacao)) ds_segmentacao,
			substr(coalesce(pls_obter_dados_subestipulante(b.nr_seq_subestipulante,'N'),pls_obter_dados_contrato(f.nr_sequencia,'E')),1,255) ds_estipulante
		into STRICT	cd_usuario_plano_w,
			nm_beneficiario_w,
			dt_nascimento_w,
			ds_produto_w,
			ds_acomodacao_w,
			dt_validade_carteira_w,
			cd_cgc_estipulante_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w,
			ie_nova_regulamentacao_w,
			cod_empresa_w,
			cd_abrangencia_w,
			ds_abrangencia_w,
			nr_via_solicitacao_w,
			nr_seq_plano_w,
			tp_contrato_w,
			nr_protocolo_ans_w,
			ds_trilha_2_w,
			cd_pf_estipulante_w,
			dt_contratacao_w,
			dt_inclusao_operadora_w,
			ie_tipo_segurado_w,
			nm_abreviado_w,
			nr_seq_contrato_w,
			dt_geracao_w,
			dt_contrato_w,
			cd_plano_w,
			cd_matricula_estipulante_w,
			nr_cartao_nac_sus_w,
			ds_segmentacao_w,
			ds_estipulante_w
		from	pls_contrato		f,
			pls_plano		d,
			pls_segurado_carteira	c,
			pls_segurado		b,
			pessoa_fisica		a
		where	c.nr_seq_segurado	= b.nr_sequencia
		and	b.nr_seq_plano		= d.nr_sequencia
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.nr_seq_contrato	= f.nr_sequencia
		and	b.nr_sequencia		= nr_seq_segurado_w;
	elsif (ie_tipo_contrato_w = 'I') then
		select	c.cd_usuario_plano,
			substr(a.nm_pessoa_fisica,1,60),
			to_char(a.dt_nascimento,'dd/mm/yyyy'),
			substr(d.ds_plano,1,50) ds_produto,
			substr(coalesce(pls_obter_dados_cart_unimed(b.nr_sequencia,d.nr_sequencia,'DASJ',1),upper(wheb_mensagem_pck.get_texto(1191029))),1,50),
			to_char(c.dt_validade_carteira,'dd/mm/yyyy'),
			f.cd_cgc,
			d.ie_tipo_contratacao,
			d.ie_regulamentacao,
			CASE WHEN d.ie_regulamentacao='R' THEN 'NAO'  ELSE 'SIM' END ,
			b.cd_operadora_empresa,
			CASE WHEN d.ie_abrangencia='GM' THEN 'Abrangencia'  ELSE '' END ,
			upper(obter_valor_dominio(1667,d.ie_abrangencia)),
			c.nr_via_solicitacao,
			d.nr_sequencia,
			CASE WHEN d.ie_tipo_contratacao='I' THEN 'Particular'  ELSE 'Empresa' END ,
			d.nr_protocolo_ans,
			replace(replace(ds_trilha2,';',''),'?',''),
			f.cd_pessoa_fisica,
			b.dt_contratacao,
			b.dt_inclusao_operadora,
			to_char(c.dt_solicitacao,'dd/mm/yyyy'),
			to_char(f.dt_inclusao,'dd/mm/yyyy'),
			d.cd_codigo_ant,
			f.nr_sequencia,
			b.cd_matricula_estipulante,
			a.nr_cartao_nac_sus,
			upper(obter_valor_dominio(1665,d.ie_segmentacao)) ds_segmentacao,
			substr(pls_obter_dados_contrato_inter(f.nr_sequencia,null,'E'),1,255) ds_estipulante,
			nr_seq_intercambio_benef
		into STRICT	cd_usuario_plano_w,
			nm_beneficiario_w,
			dt_nascimento_w,
			ds_produto_w,
			ds_acomodacao_w,
			dt_validade_carteira_w,
			cd_cgc_estipulante_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w,
			ie_nova_regulamentacao_w,
			cod_empresa_w,
			cd_abrangencia_w,
			ds_abrangencia_w,
			nr_via_solicitacao_w,
			nr_seq_plano_w,
			tp_contrato_w,
			nr_protocolo_ans_w,
			ds_trilha_2_w,
			cd_pf_estipulante_w,
			dt_contratacao_w,
			dt_inclusao_operadora_w,
			dt_geracao_w,
			dt_contrato_w,
			cd_plano_w,
			nr_seq_intercambio_w,
			cd_matricula_estipulante_w,
			nr_cartao_nac_sus_w,
			ds_segmentacao_w,
			ds_estipulante_w,
			nr_seq_intercambio_benef_w
		from	pls_intercambio		f,
			pls_plano		d,
			pls_segurado_carteira	c,
			pls_segurado		b,
			pessoa_fisica		a
		where	c.nr_seq_segurado	= b.nr_sequencia
		and	b.nr_seq_plano		= d.nr_sequencia
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.nr_seq_intercambio	= f.nr_sequencia
		and	b.nr_sequencia		= nr_seq_segurado_w;
	end if;
	
	if (cd_interface_w = 2720) then		
		select  CASE WHEN ie_tipo_contratacao_w='I' THEN 'Individual ou Familiar' WHEN ie_tipo_contratacao_w='CA' THEN wheb_mensagem_pck.get_texto(1191030) WHEN ie_tipo_contratacao_w='CE' THEN 'Coletivo Empresarial' END ,
			CASE WHEN ie_regulamentacao_w='R' THEN wheb_mensagem_pck.get_texto(1191031) WHEN ie_regulamentacao_w='P' THEN 'Regulamentado' WHEN ie_regulamentacao_w='A' THEN 'Adaptado' END
		into STRICT	tp_contratacao_w,
			ds_registro_ans_w
		;
		
		if (nr_seq_intercambio_benef_w IS NOT NULL AND nr_seq_intercambio_benef_w::text <> '') then
			begin
			select	ds_plano_origem,
				CASE WHEN ie_natureza=2 THEN 'Familiar' WHEN ie_natureza=3 THEN 'Coletivo empresarial' WHEN ie_natureza=4 THEN wheb_mensagem_pck.get_texto(1191030) WHEN ie_natureza=5 THEN 'Beneficiente' END ,
				cd_prod_ans			
			into STRICT	ds_produto_w,
				tp_contratacao_w,
				nr_protocolo_ans_w
			from	ptu_intercambio_plano	b,
				ptu_intercambio_benef	a
			where	a.nr_seq_empresa = b.nr_seq_empresa
			and	a.nr_sequencia = nr_seq_intercambio_benef_w;
			exception
			when others then
				null;
			end;
		end if;
	
		ds_produto_w := substr(ds_produto_w,1,30);
		
		if (length(ds_estipulante_w) > 18) then
			select	pls_gerar_nome_abreviado(ds_estipulante_w)
			into STRICT	ds_estipulante_w
			;
			
			ds_estipulante_w := substr(ds_estipulante_w,1,18);
		end if;
	else
		ds_produto_w := substr(ds_produto_w,1,17);
		
		select	CASE WHEN ie_tipo_contratacao_w='I' THEN '2-'||upper(wheb_mensagem_pck.get_texto(1191062)) WHEN ie_tipo_contratacao_w='CA' THEN '4-'||upper(wheb_mensagem_pck.get_texto(1191032)) WHEN ie_tipo_contratacao_w='CE' THEN '3-EMPRESARIAL' END ,
			CASE WHEN ie_regulamentacao_w='R' THEN wheb_mensagem_pck.get_texto(1191031)  ELSE 'Produto Regulamentado' END
		into STRICT  	tp_contratacao_w,
			ds_registro_ans_w
		;		
	end if;

	CALL pls_atualizar_trilha_cartao(nr_seq_segurado_w, nm_usuario_p);
		
	if (cd_cgc_estipulante_w IS NOT NULL AND cd_cgc_estipulante_w::text <> '') then
		if (cd_interface_w < 2720) then
			ds_produto_w	:= substr(coalesce(obter_dados_pf_pj('',cd_cgc_estipulante_w,'ABV'),obter_dados_pf_pj('',cd_cgc_estipulante_w,'F')),1,18);
			ds_produto_w	:= upper(ds_produto_w);
		end if;
		
		if (cd_cgc_estipulante_w = '09298037000112') then		
			begin
			select	substr(ds_razao_social,1,255)
			into STRICT	nm_administradora_w
			from	pessoa_juridica
			where	cd_cgc = cd_cgc_estipulante_w;
			exception
			when others then
				nm_administradora_w := null;
			end;
		end if;
	end if;

	cd_usuario_plano_w	:= substr(cd_usuario_plano_w,1,1)||' '||substr(cd_usuario_plano_w,2,3)||' '||substr(cd_usuario_plano_w,5,12)||' '||substr(cd_usuario_plano_w,17,1);

	if (coalesce(trim(both nm_abreviado_w)::text, '') = '') then
		nm_beneficiario_w	:= upper(pls_gerar_nome_abreviado(nm_beneficiario_w));
	else
		nm_beneficiario_w	:= upper(nm_abreviado_w);
	end if;
		
	ds_acomodacao_w		:= upper(ds_acomodacao_w);

	ds_carencia_w	:= '';
	
	qt_lida_mensagens_w	:= 0;
	
	open C03;
	loop
	fetch C03 into	
		ds_mens_carencia_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		qt_lida_mensagens_w	:= qt_lida_mensagens_w + 1;
		
		ds_carencia_w	:= ds_carencia_w || ds_mens_carencia_w||';';
		
		end;
	end loop;
	close C03;

	/*Se houver mensagem na carteira, nao utiliza as carencias */

	if (coalesce(qt_lida_mensagens_w, 0) = 0) then
		open C04;
		loop
		fetch C04 into
			ds_mens_carencia_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			qt_lida_mensagens_w := qt_lida_mensagens_w + 1;
			if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
				ds_carencia_w := ds_carencia_w || ds_mens_carencia_w||';';
			else
				ds_carencia_ww := ds_mens_carencia_w || chr(13);
				ds_carencia_w := ds_carencia_w || ds_carencia_ww;
			end if;
		end loop;
		close C04;
	end if;

	if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
		for i in 1..10-qt_lida_mensagens_w loop
			begin

			ds_carencia_ww  := '                     ;          ;';

			if (i < 11) then
				ds_carencia_w := ds_carencia_w ||ds_carencia_ww;
			else
				ds_carencia_w := ds_carencia_w ||ds_carencia_ww;
			end if;
			end;
		end loop;
	end if;

	ds_carencia_w	:= substr(ds_carencia_w,1,length(ds_carencia_w)-1);
	
	ds_regiao_w := ' ';

	if (ie_tipo_segurado_w = 'R') then -- R = Repasse para outra operadora  (Resp. Transferida) - dominio 2406
		select	max(b.nm_fantasia)
		into STRICT	ds_congenere_w
		from	pls_segurado_repasse	c,
			pessoa_juridica		b,
			pls_congenere		a
		where	b.cd_cgc		= a.cd_cgc
		and	a.nr_sequencia		= c.nr_seq_congenere_atend
		and	c.nr_seq_segurado	= nr_seq_segurado_w
		and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and	coalesce(c.dt_fim_repasse::text, '') = '';

		if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
			ds_regiao_w := substr(ds_congenere_w,1,length(ds_congenere_w)-1) || ' ; ; ; ;';
		end if;
	else		
		if (cd_abrangencia_w IS NOT NULL AND cd_abrangencia_w::text <> '') then
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_regiao_w
			from	pls_plano_area	a,
				pls_regiao	b
			where	a.nr_seq_regiao		= b.nr_sequencia
			and	a.nr_seq_plano		= nr_seq_plano_w;
			
			if (nr_seq_regiao_w IS NOT NULL AND nr_seq_regiao_w::text <> '') then
				ds_regiao_1_w := null;
				ds_regiao_2_w := null;
				ds_regiao_3_w := null;
				ds_regiao_4_w := null;
				ds_regiao_5_w := null;
			
				open C02;
				loop
				fetch C02 into
					ds_municipio_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin					
					if (length(ds_regiao_w||ds_municipio_w||',') >= 100) then
						if (coalesce(ds_regiao_2_w::text, '') = '') then
							if (coalesce(ds_regiao_1_w::text, '') = '') then
								ds_regiao_1_w := ds_regiao_w;
							else
								ds_regiao_2_w := ds_regiao_w;
							end if;
							ds_regiao_w := '';							
						elsif (coalesce(ds_regiao_3_w::text, '') = '') then
							if (coalesce(ds_regiao_2_w::text, '') = '') then
								ds_regiao_2_w := ds_regiao_w;
							else
								ds_regiao_3_w := ds_regiao_w;
							end if;							
							ds_regiao_w := '';										
						elsif (coalesce(ds_regiao_4_w::text, '') = '') then
							if (coalesce(ds_regiao_3_w::text, '') = '') then
								ds_regiao_3_w := ds_regiao_w;
							else
								ds_regiao_4_w := ds_regiao_w;
							end if;							
							ds_regiao_w := '';	
						elsif (coalesce(ds_regiao_5_w::text, '') = '') then
							if (coalesce(ds_regiao_4_w::text, '') = '') then
								ds_regiao_4_w := ds_regiao_w;
							else
								ds_regiao_5_w := ds_regiao_w;
							end if;							
							ds_regiao_w := '';	
						end if;
					end if;
					
					ds_regiao_w := ds_regiao_w||ds_municipio_w||',';
					
					end;
				end loop;
				close C02;

				if (coalesce(ds_regiao_1_w::text, '') = '') then
					ds_regiao_1_w := ds_regiao_w;		
				elsif (coalesce(ds_regiao_2_w::text, '') = '') then
					ds_regiao_2_w := ds_regiao_w;	
				elsif (coalesce(ds_regiao_3_w::text, '') = '') then
					ds_regiao_3_w := ds_regiao_w;
				elsif (coalesce(ds_regiao_4_w::text, '') = '') then
					ds_regiao_4_w := ds_regiao_w;	
				elsif (coalesce(ds_regiao_5_w::text, '') = '') then
					ds_regiao_5_w := ds_regiao_w;	
				end if;	
				
				if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
					ds_regiao_1_w := substr(ds_regiao_1_w,1,length(ds_regiao_1_w)-1) || ';';
					ds_regiao_2_w := substr(ds_regiao_2_w,1,length(ds_regiao_2_w)-1) || ';';
					ds_regiao_3_w := substr(ds_regiao_3_w,1,length(ds_regiao_3_w)-1) || ';';
					ds_regiao_4_w := substr(ds_regiao_4_w,1,length(ds_regiao_4_w)-1) || ';';
					ds_regiao_5_w := substr(ds_regiao_5_w,1,length(ds_regiao_5_w)-1);
				else
					ds_regiao_1_w := substr(ds_regiao_1_w,1,length(ds_regiao_1_w)-1);
					ds_regiao_2_w := substr(ds_regiao_2_w,1,length(ds_regiao_2_w)-1);
					ds_regiao_3_w := substr(ds_regiao_3_w,1,length(ds_regiao_3_w)-1);
					ds_regiao_4_w := substr(ds_regiao_4_w,1,length(ds_regiao_4_w)-1);
					ds_regiao_5_w := substr(ds_regiao_5_w,1,length(ds_regiao_5_w)-1);
				end if;
				
				ds_regiao_w := ds_regiao_1_w || ds_regiao_2_w || ds_regiao_3_w || ds_regiao_4_w || ds_regiao_5_w;				
			end if;		
		end if;		
	end if;
	
	if (ds_regiao_w = ' ') then
		select  max(ds_mensagem)
		into STRICT  	ds_mensagemAbran_w
		from  	pls_contrato_mensagem_cart
		where 	nr_seq_contrato = nr_seq_contrato_w
		and 	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
		and 	coalesce(ie_mensagem_carencia,'N') = 'N'
		and 	coalesce(ie_mensagem_abrangencia,'N') = 'N'
		and 	ie_situacao = 'A';
	else
		ds_mensagemAbran_w	:= null;
	end if;

	if (not coalesce(trim(both ds_mensagemAbran_w)::text, '') = '') then
		if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
			ds_regiao_w := substr(ds_mensagemAbran_w,1,length(ds_mensagemAbran_w)) || ' ; ; ; ;';
		else
			ds_regiao_w := substr(ds_mensagemAbran_w,1,length(ds_mensagemAbran_w));
		end if;
	end if;
	
	if (ds_regiao_w = ' ') and (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
		ds_regiao_w := ' ; ; ; ;';
	end if;
	
	select	to_char(coalesce(max(a.dt_inicio_vigencia),max(c.dt_inclusao_operadora)) + max(a.qt_dias),'dd/mm/yyyy')
	into STRICT	ds_mensagem_cpt_w
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_w
	and	b.ie_cpt		= 'S';
	
	if (coalesce(ds_mensagem_cpt_w::text, '') = '') then
		ds_mensagem_cpt_w	:= 'NAO HA';
	end if;
	
	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_cpt_1044_w
	from	pls_carencia		a,
		pls_tipo_carencia	b,
		pls_segurado		c
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia
	and	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_segurado_w
	and	b.nr_sequencia 		= 1044
	and	b.ie_cpt 		= 'S'
	and	not exists (	SELECT	1
				from	pls_carencia		x,
					pls_tipo_carencia	y,
					pls_segurado		z
				where	x.nr_seq_tipo_carencia	= y.nr_sequencia
				and	x.nr_seq_segurado	= z.nr_sequencia
				and	z.nr_sequencia		= c.nr_sequencia
				and	y.ie_cpt		= 'S'
				and	y.nr_sequencia 		<> 1044);
	
	if (ie_cpt_1044_w = 'S') then
		ds_mensagem_cpt_w := 'NAO HA';
	end if;
	
	select	max(ds_mensagem)
	into STRICT	ds_observacao_1_w
	from	pls_plano_mensagem_cart
	where	nr_seq_plano	= nr_seq_plano_w
	and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
	and	ie_situacao	= 'A';

	if (ie_tipo_contrato_w = 'C') then
		select	max(ds_mensagem)
		into STRICT	ds_observacao_2_w
		from	pls_contrato_mensagem_cart
		where	nr_seq_contrato	= nr_seq_contrato_w
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
		and	coalesce(ie_mensagem_carencia,'N') = 'N'
		and	coalesce(ie_mensagem_abrangencia,'N') = 'N'
		and	ie_situacao	= 'A';
		
		select	count(1)
		into STRICT	qt_mensagem_cart_w
		
		where	exists (SELECT	1
				from	pls_contrato_mensagem_cart
				where	nr_seq_contrato	= nr_seq_contrato_w);
	elsif (ie_tipo_contrato_w = 'I') then
		select	max(ds_mensagem)
		into STRICT	ds_observacao_2_w
		from	pls_contrato_mensagem_cart
		where	nr_seq_intercambio	= nr_seq_intercambio_w
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
		and	coalesce(ie_mensagem_carencia,'N') = 'N'
		and	coalesce(ie_mensagem_abrangencia,'N') = 'N'
		and	ie_situacao	= 'A';
		
		select	count(1)
		into STRICT	qt_mensagem_cart_w
		
		where	exists (SELECT	1
				from	pls_contrato_mensagem_cart
				where	nr_seq_intercambio = nr_seq_intercambio_w);
	end if;
		
	if (coalesce(trim(both ds_observacao_2_w)::text, '') = '') and (qt_mensagem_cart_w > 0) then
		ds_observacao_2_w	:= 'Atendimento restrito a area de acao da Unimed Sao Jose do Rio Preto-SP. Outras localidades somente em caso de urgencia';
	end if;
	
	if (ie_tipo_contrato_w = 'C') then
		select	max(ds_mensagem)
		into STRICT	ds_abrangencia_aux_w
		from	pls_contrato_mensagem_cart
		where	nr_seq_contrato	= nr_seq_contrato_w
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
		and	coalesce(ie_mensagem_carencia,'N') = 'N'
		and	ie_mensagem_abrangencia = 'S'
		and	ie_situacao	= 'A';
	elsif (ie_tipo_contrato_w = 'I') then
		select	max(ds_mensagem)
		into STRICT	ds_abrangencia_aux_w
		from	pls_contrato_mensagem_cart
		where	nr_seq_intercambio	= nr_seq_intercambio_w
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
		and	coalesce(ie_mensagem_carencia,'N') = 'N'
		and	ie_mensagem_abrangencia = 'S'
		and	ie_situacao	= 'A';
	end if;
	
	if ((trim(both ds_abrangencia_aux_w) IS NOT NULL AND (trim(both ds_abrangencia_aux_w))::text <> '')) then
		ds_abrangencia_w	:= ds_abrangencia_aux_w;
		
		if (ds_abrangencia_aux_w = 'ESTADUAL') then
			if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
				ds_regiao_w   :=  substr(ds_observacao_2_w,1,length(ds_observacao_2_w)) || ' ; ; ; ;';
			else
				ds_regiao_w   :=  substr(ds_observacao_2_w,1,length(ds_observacao_2_w));
			end if;
		end if;
	end if;
	
	ds_abrangencia_w	:= replace(ds_abrangencia_w,chr(195),'I');
	ds_observacao_1_w	:= Elimina_Acentuacao(ds_observacao_1_w);
	ds_observacao_2_w	:= Elimina_Acentuacao(ds_observacao_2_w);
	nm_beneficiario_w	:= Elimina_Acentuacao(nm_beneficiario_w);
	ds_carencia_w		:= Elimina_Acentuacao(ds_carencia_w);
	ds_regiao_w		:= Elimina_Acentuacao(ds_regiao_w);
	ds_produto_w		:= Elimina_Acentuacao(ds_produto_w);
	
	cd_local_cobranca_w	:= pls_obter_area_cobranca(nr_seq_segurado_w,cd_estabelecimento_p);
	
	cd_local_cobranca_w	:= lpad(cd_local_cobranca_w,4,'0');
	
	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
		select	substr(cd_rede_refer_ptu,1,13)
		into STRICT	cd_rede_refer_ptu_w
		from	pls_plano
		where	nr_sequencia = nr_seq_plano_w;
		
		ds_rede_atendimento_w	:= cd_rede_refer_ptu_w || ' '|| substr(pls_obter_rede_ref_produto(nr_seq_plano_w,cd_estabelecimento_p,'DT'), 1, 30);
	end if;
	
	--ds_rede_atendimento_w	:= lpad(substr(pls_obter_rede_atendimento(nr_seq_segurado_w,nr_seq_plano_w),1,4),4,'0');
	insert into w_pls_interface_carteira(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_lote,ie_tipo_reg,cd_usuario_plano,dt_nascimento,ds_tipo_contratacao,
			dt_validade_carteira,nm_beneficiario,cd_local_cobranca,nm_plano,cd_abrangencia,
			ds_abrangencia,ds_registro_ans,ds_acomodacao,cd_operadora_empresa,dt_cpt,
			ds_rede_atendimento,ds_carencia,ds_observacao,ds_observacao_2,
			tp_contrato,nr_protocolo_ans,ds_trilha_2,nr_seq_segurado,
			nr_via_cartao,ds_regiao,ds_branco,dt_geracao,ds_segmentacao,nm_administradora,
			dt_contrato,ds_valor_padrao,ie_nova_regulamentacao,cd_plano,cd_matricula_familiar,ds_cns,
			ds_estipulante)
	values (	nextval('w_pls_interface_carteira_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_lote_p,2,coalesce(cd_usuario_plano_p, cd_usuario_plano_w),dt_nascimento_w,tp_contratacao_w,
			dt_validade_carteira_w,nm_beneficiario_w,cd_local_cobranca_w,ds_produto_w,cd_abrangencia_w,
			ds_abrangencia_w,ds_registro_ans_w,ds_acomodacao_w,lpad(coalesce(cod_empresa_w,'0'),4,'0'),ds_mensagem_cpt_w,
			ds_rede_atendimento_w,ds_carencia_w,ds_observacao_1_w,ds_observacao_2_w,
			tp_contrato_w,nr_protocolo_ans_w,ds_trilha_2_w,nr_seq_segurado_w,nr_via_solicitacao_w,
			ds_regiao_w,' ',dt_geracao_w,ds_segmentacao_w,nm_administradora_w,
			dt_contratacao_w,'Codigo da Rede',ie_nova_regulamentacao_w,cd_plano_w,cd_matricula_estipulante_w,nr_cartao_nac_sus_w,
			ds_estipulante_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cart_unimed_sjrp ( nr_seq_lote_p bigint, cd_interface_p bigint, nr_seq_usuario_ops_p_p bigint, cd_usuario_plano_p pls_segurado_carteira.cd_usuario_plano%type, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

