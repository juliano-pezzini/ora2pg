-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_gerar_lista_analise ( nr_ordem_servico_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_ordem_serv_w			bigint;
qt_politica_w				bigint;
qt_margem_dias_w			bigint;
nr_seq_tipo_lista_w			bigint;
nr_seq_grupamento_w			bigint;
ds_atributo_w				varchar(255);
ds_cadastro_W				varchar(255);
ds_coluna_w					varchar(255);
ds_valor_padrao_cad_w		varchar(255);
ds_valor_padrao_fixo_w		varchar(255);
nr_seq_formula_w			bigint;
nr_seq_lista_w				bigint;
ie_tipo_informacao_w		varchar(1);
nr_seq_reg_lista_w			bigint;
vl_resultado_formula_w		varchar(255);
vl_resultado_w				varchar(255);
ds_resultado_w				varchar(255);
nr_seq_reg_analise_item_w	bigint;
nm_informacao_w				varchar(255);

nr_seq_regional_w			bigint;
cd_empresa_w				bigint;
nr_seq_segmento_w			bigint;
cd_material_w				integer;
cd_local_estoque_w			smallint;
cd_estabelecimento_w		smallint;
nr_ordenacao_w				integer;
qt_existe_w					integer;
ds_composicao_w				varchar(4000);
ds_sql_w					varchar(4000);
ds_prova_real_w				varchar(4000);
ds_sql_prova_w					varchar(4000);
qt_existe_formula_w			integer;
qt_pos_ini_sql_w			integer;
qt_pos_fim_sql_w			integer;
ds_macro_atributo_w			varchar(80);
vl_resultado_atributo_w		varchar(255);
ds_resultado_atributo_w				varchar(255);
nr_seq_grup_regra_w			bigint;
cd_responsavel_w			varchar(10);
ie_origem_pcs_w				varchar(1);
nr_seq_relatorio_w			pcs_seg_compras_rel_item.nr_seq_relatorio%type;
qt_mensagem_w				integer;

C01 CURSOR FOR 
 
	SELECT	b.ds_atributo, 
			b.ds_cadastro, 
			b.ds_coluna, 
			b.ds_valor_padrao_cad, 
			b.ds_valor_padrao_fixo, 
			b.nr_seq_formula, 
			a.cd_empresa, 
			b.nr_seq_apres 
	from	pcs_listas a, 
			pcs_listas_colunas b 
	where	a.nr_sequencia = b.nr_seq_lista 
	and		a.nr_sequencia = nr_seq_lista_w 
	order by nr_seq_apres;
	
C02 CURSOR FOR 
	SELECT distinct cd_material, 
		cd_estabelecimento, 
		nr_seq_grupamento, 
		nr_seq_segmento 
	from	pcs_seg_compras_rel_item 
	where	nr_seq_relatorio = nr_seq_relatorio_w 
	and	nr_seq_grupamento = coalesce(nr_seq_grup_regra_w,0)	 
	and	coalesce(nr_seq_grup_regra_w,0) > 0 
	and	((pcs_obter_tipo_lista(nr_seq_tipo_lista_w) not in ('LC','MLC')) or (coalesce(pcs_obter_tipo_lista(nr_seq_tipo_lista_w)::text, '') = '')) 
	and	ie_origem_pcs_w = 'C' 
	
union all
 
	SELECT distinct cd_material, 
		cd_estabelecimento, 
		nr_seq_grupamento, 
		nr_seq_segmento 
	from	pcs_seg_compras_rel_item			 
	where	nr_seq_relatorio = nr_seq_relatorio_w 
	and	(nr_seq_tipo_lista_w IS NOT NULL AND nr_seq_tipo_lista_w::text <> '')				 
	and	cd_pessoa_resp_lc = cd_responsavel_w 
	and	(((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_mlc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'MLC')) 
	or	((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_lc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'LC'))) 
	and	ie_origem_pcs_w = 'C' 
	
union all
 
	select distinct b.cd_material, 
		b.cd_estabelecimento, 
		b.nr_seq_grupamento, 
		b.nr_seq_segmento 
	from	pcs_segmento_compras_rel a, 
		pcs_seg_compras_rel_item b			 
	where	a.nr_sequencia = b.nr_seq_relatorio 
	and	b.nr_seq_relatorio = nr_seq_relatorio_w 
	and	(nr_seq_tipo_lista_w IS NOT NULL AND nr_seq_tipo_lista_w::text <> '')				 
	and	b.cd_pessoa_resp_lc = cd_responsavel_w 
	and	(b.dt_entrega_prevista_oc IS NOT NULL AND b.dt_entrega_prevista_oc::text <> '')	 
	and	pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'PV' 
	and (to_date(to_char(coalesce(b.dt_entrega_prevista_oc,clock_timestamp()),'dd/mm/yyyy') || ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')	<= coalesce(dt_geracao,clock_timestamp())) 
	and	ie_origem_pcs_w = 'C'	 
	
union all
 
	select	distinct c.cd_material, 
		c.cd_estabelecimento, 
		nr_seq_grup_regra_w, 
		b.nr_sequencia 
	from	pcs_grupamentos a, 
		pcs_segmento b, 
		pcs_estrutura_segmento c 
	where	a.nr_sequencia = b.nr_seq_grupamento 
	and	a.nr_sequencia = c.nr_seq_grupamento 
	and	b.nr_sequencia = c.nr_seq_segmento 
	and	ie_origem_pcs_w = 'M' 
	and	exists (select	1 
			from	man_ordem_servico_mat x 
			where	x.nr_seq_ordem_serv = nr_ordem_servico_p 
			and	x.cd_material = c.cd_material);
	

BEGIN 
 
select	max(a.nr_sequencia) 
into STRICT	nr_seq_relatorio_w 
from	pcs_segmento_compras_rel a, 
	pcs_seg_compras_rel_item b 
where	a.nr_sequencia = b.nr_seq_relatorio 
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');
 
select count(*) 
into STRICT	qt_existe_w 
from	man_ordem_servico a, 
		pcs_regra_atividades b 
where	a.nr_seq_regra_ativ = b.nr_sequencia 
and		a.nr_sequencia = nr_ordem_servico_p 
and	pcs_obter_tipo_lista(b.nr_seq_tipo_lista) <> 'AD' -- Não será gerado lista para este tipo 
and	ie_origem_pcs = 'C';
 
if (coalesce(qt_existe_w,0) > 0) then 
 
	select	a.nr_sequencia, 
		a.nr_seq_grupamento, 
		a.nr_seq_regional, 
		a.nr_seq_lista, 
		cd_pessoa_solicitante, 
		ie_origem_pcs 
	into STRICT	nr_seq_ordem_serv_w, 
		nr_seq_grup_regra_w, 
		nr_seq_regional_w, 
		nr_seq_lista_w, 
		cd_responsavel_w, 
		ie_origem_pcs_w 
	from	man_ordem_servico a, 
		pcs_regra_atividades b 
	where	a.nr_seq_regra_ativ = b.nr_sequencia 
	and	a.nr_sequencia = nr_ordem_servico_p 
	and	ie_origem_pcs = 'C';
 
else 
	select count(*) 
	into STRICT	qt_existe_w 
	from	man_ordem_servico a 
	where	a.nr_sequencia = nr_ordem_servico_p 
	--and	pcs_obter_tipo_lista(nr_seq_tipo_lista_w) <> 'AD' -- Não será gerado lista para este tipo 
	and	ie_origem_pcs = 'M';
	 
	if (coalesce(qt_existe_w ,0) > 0) then 
 
		begin 
		select	nr_sequencia 
		into STRICT	nr_seq_tipo_lista_w 
		from	pcs_tipo_lista 
		where	ie_tipo = 'MN';
		 
		exception 
		when others then 
		nr_seq_tipo_lista_w := 0;
		end;	
	 
		if (coalesce(nr_seq_tipo_lista_w,0) = 0) then 
		  CALL wheb_mensagem_pck.exibir_mensagem_abort(338169); --É necessário cadastrar um tipo de lista do tipo manual, para este tipo de atividade! 
		end if;
	 
		select	a.nr_sequencia, 
			a.nr_seq_grupamento, 
			a.nr_seq_regional, 
			a.nr_seq_lista, 
			cd_pessoa_solicitante, 
			ie_origem_pcs 
		into STRICT	nr_seq_ordem_serv_w, 
			nr_seq_grup_regra_w, 
			nr_seq_regional_w, 
			nr_seq_lista_w, 
			cd_responsavel_w, 
			ie_origem_pcs_w 
		from	man_ordem_servico a 
		where	a.nr_sequencia = nr_ordem_servico_p 
		and	ie_origem_pcs = 'M';	
 
		if (coalesce(nr_seq_lista_w::text, '') = '') then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(332908);		
		end if;		
	end if;
end if;	
 
if (coalesce(nr_seq_tipo_lista_w,0) = 0) then 
	select	max(nr_seq_tipo_lista) 
	into STRICT	nr_seq_tipo_lista_w 
	from	man_ordem_servico a, 
		pcs_regra_atividades b 
	where	a.nr_seq_regra_ativ = b.nr_sequencia 
	and	a.nr_sequencia = nr_ordem_servico_p 
	and	ie_origem_pcs = 'C';
end if;
 
select 	sum(z.qt_mensagem) 
into STRICT	qt_mensagem_w 
from	(SELECT distinct count(*) qt_mensagem 
	from	pcs_seg_compras_rel_item 
	where	nr_seq_relatorio = nr_seq_relatorio_w 
	and	nr_seq_grupamento = coalesce(nr_seq_grup_regra_w,0)	 
	and	coalesce(nr_seq_grup_regra_w,0) > 0 
	and	((pcs_obter_tipo_lista(nr_seq_tipo_lista_w) not in ('LC','MLC')) or (coalesce(pcs_obter_tipo_lista(nr_seq_tipo_lista_w)::text, '') = '')) 
	and	ie_origem_pcs_w = 'C' 
	
union all
 
	SELECT distinct count(*) qt_mensagem 
	from	pcs_seg_compras_rel_item			 
	where	nr_seq_relatorio = nr_seq_relatorio_w 
	and	(nr_seq_tipo_lista_w IS NOT NULL AND nr_seq_tipo_lista_w::text <> '')				 
	and	cd_pessoa_resp_lc = cd_responsavel_w 
	and	(((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_mlc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'MLC')) 
	or	((obter_dias_estoque_material(cd_estabelecimento,cd_material,nm_usuario_p) <= coalesce(qt_dias_corte_lc,0)) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'LC'))) 
	and	ie_origem_pcs_w = 'C' 
	
union all
 
	select distinct count(*) qt_mensagem 
	from	pcs_segmento_compras_rel a, 
		pcs_seg_compras_rel_item b			 
	where	a.nr_sequencia = b.nr_seq_relatorio 
	and	b.nr_seq_relatorio = nr_seq_relatorio_w 
	and	(nr_seq_tipo_lista_w IS NOT NULL AND nr_seq_tipo_lista_w::text <> '')				 
	and	b.cd_pessoa_resp_lc = cd_responsavel_w 
	and	(b.dt_entrega_prevista_oc IS NOT NULL AND b.dt_entrega_prevista_oc::text <> '')	 
	and	pcs_obter_tipo_lista(nr_seq_tipo_lista_w) = 'PV' 
	and (to_date(to_char(coalesce(b.dt_entrega_prevista_oc,clock_timestamp()),'dd/mm/yyyy') || ' 00:00:00', 'dd/mm/yyyy hh24:mi:ss')	<= coalesce(dt_geracao,clock_timestamp())) 
	and	ie_origem_pcs_w = 'C'	 
	
union all
 
	select	distinct count(*) qt_mensagem 
	from	pcs_grupamentos a, 
		pcs_segmento b, 
		pcs_estrutura_segmento c 
	where	a.nr_sequencia = b.nr_seq_grupamento 
	and	a.nr_sequencia = c.nr_seq_grupamento 
	and	b.nr_sequencia = c.nr_seq_segmento 
	and	ie_origem_pcs_w = 'M' 
	and	exists (select	1 
			from	man_ordem_servico_mat x 
			where	x.nr_seq_ordem_serv = nr_ordem_servico_p 
			and	x.cd_material = c.cd_material)) z;
 
if (qt_mensagem_w = 0) and (pcs_obter_tipo_lista(nr_seq_tipo_lista_w) <> 'AD') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(357569); /*A lista de análise não foi gerada, porque não há itens que atendem aos critérios do tipo de lista.*/
end if;
 
 
if (coalesce(qt_existe_w,0) > 0) then 
	begin 
	CALL pcs_sup_gerar_planej_pck.pcs_executar_formula(null,nr_seq_grup_regra_w,nr_seq_tipo_lista_w,ie_origem_pcs_w,nr_seq_relatorio_w,cd_responsavel_w,nr_seq_ordem_serv_w,nm_usuario_p);	
	 
	select	nextval('pcs_reg_analise_seq') 
	into STRICT	nr_seq_reg_lista_w 
	;
	 
	 
	insert into pcs_reg_analise( 
			nr_sequencia, 
			nr_seq_lista, 
			qt_politica, 
			qt_margem_dias, 
			qt_dias_restantes, 
			nr_seq_tipo_lista, 
			nr_seq_grupamento, 
			nr_ordem_serv, 
			dt_atualizacao, 
			dt_atualizacao_nrec, 
			nm_usuario, 
			nm_usuario_nrec) 
	values (	nr_seq_reg_lista_w, 
			nr_seq_lista_w, 
			coalesce(qt_politica_w,0), 
			coalesce(qt_margem_dias_w,0), 
			0, 
			nr_seq_tipo_lista_w, 
			nr_seq_grup_regra_w, 
			nr_seq_ordem_serv_w, 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_p);
	 
		open C02;
		loop 
		fetch C02 into	 
			cd_material_w, 
			cd_estabelecimento_w, 
			nr_seq_grupamento_w, 
			nr_seq_segmento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin	 
			open C01;
			loop 
			fetch C01 into 
				ds_atributo_w, 
				ds_cadastro_w, 
				ds_coluna_w, 
				ds_valor_padrao_cad_w, 
				ds_valor_padrao_fixo_w, 
				nr_seq_formula_w, 
				cd_empresa_w, 
				nr_ordenacao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin 
		 
				nm_informacao_w := null;
				vl_resultado_w := null;
				ds_prova_real_w := null;
				vl_resultado_formula_w := null;
				 
				select	max(cd_local_estoque) 
				into STRICT	cd_local_estoque_w 
				from 	pcs_local_estoque_grup 
				where 	nr_seq_grupamento = nr_seq_grupamento_w 
				and		cd_estab_regra = cd_estabelecimento_w;
				 
				if (nr_seq_formula_w IS NOT NULL AND nr_seq_formula_w::text <> '') then 
					begin 
					nm_informacao_w :=	substr(obter_descricao_padrao('PCS_FORMULAS','DS_MACRO',nr_seq_formula_w),1,255);
					ie_tipo_informacao_w := 'F';
					 
					select	count(*) 
					into STRICT	qt_existe_formula_w 
					from	w_pcs_atributo_formula 
					where	nr_seq_formula = nr_seq_formula_w 
					and		cd_material = cd_material_w;
					 
					if (qt_existe_formula_w > 0) then 
						begin 
						 
						begin 
						select	coalesce(ds_resultado,0), 
								upper(ds_sql) 
						into STRICT	vl_resultado_formula_w, 
								ds_sql_w 
						from	w_pcs_atributo_formula 
						where	nr_seq_formula = nr_seq_formula_w 
						and		cd_material = cd_material_w;												
						exception 
						when others then 
							vl_resultado_w := null;
							ds_sql_w := null;
						end;
	 
						select	ds_composicao 
						into STRICT	ds_composicao_w 
						from	pcs_formulas 
						where	nr_sequencia = nr_seq_formula_w;					
	 
					qt_pos_ini_sql_w := position('SELECT' in ds_sql_w);
					qt_pos_fim_sql_w := position('FROM' in ds_sql_w);
					 
					ds_sql_w := substr(ds_sql_w,qt_pos_ini_sql_w + 6,qt_pos_fim_sql_w - 7);
						 
					ds_prova_real_w := substr(wheb_mensagem_pck.get_texto(305572) || ': ' || ds_composicao_w || chr(13) || chr(10) || 
											wheb_mensagem_pck.get_texto(305578) || ': ' || ds_sql_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(305574) || ': ' || vl_resultado_formula_w,1,3999);
	 
					vl_resultado_w	:= to_char(coalesce(vl_resultado_formula_w,0));					
					end;
					end if;						
					ds_composicao_w := null;						
					end;
				elsif (ds_atributo_w IS NOT NULL AND ds_atributo_w::text <> '') then 
					begin 
					ie_tipo_informacao_w := 'A';
					nm_informacao_w := ds_atributo_w;
	 
					/*if (nm_informacao_w = 'CD_ESTAB') then 
					nm_informacao_w := 'CD_ESTABELECIMENTO'; 
					elsif (nm_informacao_w = 'CD_LOCAL_EST') then 
					nm_informacao_w := 'CD_LOCAL_ESTOQUE'; 
					elsif (nm_informacao_w = 'QT_COMPRA') then 
					nm_informacao_w := 'QT_MATERIAL';					  
					elsif (nm_informacao_w = 'CD_FORNEC_TRANS') then 
					nm_informacao_w := 'CD_CGC_FORNECEDOR'; 
					 
					end if;*/
 
					 
					vl_resultado_w := substr(obter_dados_pcs(cd_empresa_w, nr_seq_regional_w, nr_seq_segmento_w, cd_material_w, cd_local_estoque_w, cd_estabelecimento_w,ds_atributo_w),1,255); --07/01/2015 
					
					if (coalesce(vl_resultado_w::text, '') = '') then 
						begin 
						 
						ds_macro_atributo_w := '#A_' || ds_atributo_w || '@';
						 
						select	max(coalesce(ds_resultado,'0')) 
						into STRICT	ds_resultado_atributo_w 
						from	w_pcs_atributo_formula 
						where	coalesce(nr_seq_formula::text, '') = '' 
						and		cd_material = cd_material_w 
						and		ds_macro = ds_macro_atributo_w;						
						exception 
						when others then 
						ds_resultado_atributo_w := null;						
						end;
					 
					vl_resultado_w := ds_resultado_atributo_w;
					end if;
					end;
				elsif (ds_cadastro_w IS NOT NULL AND ds_cadastro_w::text <> '') and (ds_valor_padrao_cad_w IS NOT NULL AND ds_valor_padrao_cad_w::text <> '') then 
					begin 
					ie_tipo_informacao_w := 'C';
					nm_informacao_w := ds_cadastro_w; 		
					vl_resultado_w	:= ds_valor_padrao_cad_w;
					end;
				end if;		
					 
				if (ds_valor_padrao_fixo_w IS NOT NULL AND ds_valor_padrao_fixo_w::text <> '') then 
					begin	 
					vl_resultado_w	:= ds_valor_padrao_fixo_w;
					nm_informacao_w	:= wheb_mensagem_pck.get_texto(297266,'NM_INFORMACAO_W='||nm_informacao_w);	
					end;
				end if;
				 
				select	nextval('pcs_reg_analise_itens_seq') 
				into STRICT	nr_seq_reg_analise_item_w 
				;
	 
					if (coalesce(vl_resultado_w::text, '') = '') then 
						vl_resultado_w := 'null';
					end if;
				 
					insert into pcs_reg_analise_itens( 
							ds_coluna, 
							dt_atualizacao, 
							dt_atualizacao_nrec, 
							ie_informacao, 
							nm_informacao, 
							nm_usuario, 
							nm_usuario_nrec, 
							nr_seq_registro, 
							nr_sequencia, 
							nr_seq_segmento, 
							vl_informacao, 
							cd_material, 
							nr_ordenacao, 
							ie_status_analise, 
							nr_seq_formula, 
							ds_prova_real, 
							cd_estabelecimento) 
					values (	ds_coluna_w, 
							clock_timestamp(), 
							clock_timestamp(), 
							ie_tipo_informacao_w, 
							nm_informacao_w, 
							nm_usuario_p, 
							nm_usuario_p, 
							nr_seq_reg_lista_w, 
							nr_seq_reg_analise_item_w,			 
							null, 
							vl_resultado_w, 
							cd_material_w, 
							nr_ordenacao_w, 
							'P', 
							nr_seq_formula_w, 
							ds_prova_real_w, 
							cd_estabelecimento_w);
			 
				end;
			end loop;
			close C01;
		 
			end;
		end loop;
		close C02;		
	 
	end;
	 
end if;		
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_gerar_lista_analise ( nr_ordem_servico_p bigint, nm_usuario_p text) FROM PUBLIC;

