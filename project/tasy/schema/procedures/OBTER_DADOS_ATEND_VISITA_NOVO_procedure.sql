-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_atend_visita_novo ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_atend_visita_lib_p INOUT text, ie_atend_visita_bloq_p INOUT text, ie_permite_visita_p INOUT text, cd_pessoa_fisica_p INOUT text) AS $body$
DECLARE

 
ie_consiste_eup_w		varchar(1);
ie_preencher_funcionario_w	varchar(1);
ie_vis_liberado_w		varchar(1);

BEGIN
 
if (coalesce(nr_atendimento_p,0) > 0) then 
	begin 
	ie_vis_liberado_w := obter_param_usuario(8014, 104, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vis_liberado_w);
	if (ie_vis_liberado_w = 'S') then 
		ie_atend_visita_lib_P := 'S';
	else 
		select	CASE WHEN count(*)=0 THEN  'S'  ELSE 'N' END  
		into STRICT	ie_atend_visita_lib_P 
		from	atendimento_visita_lib 
		where	nr_atendimento = nr_atendimento_p;
	end if;
	 
	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  
	into STRICT	ie_atend_visita_bloq_p 
	from	atendimento_visita_bloq 
	where	nr_atendimento = nr_atendimento_p;
 
	select	coalesce(ie_permite_visita, 'S') 
	into STRICT	ie_permite_visita_p 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	-- Controle de Visitas - Parametro [29] - Consistir se na entrada única o paciente está marcado para não receber visitas 
	ie_consiste_eup_w := obter_param_usuario(8014, 29, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_eup_w);
 
	-- Controle de Visitas - Parametro [48] - Preencher funcionário ao registrar uma nova visita 
	ie_preencher_funcionario_w := obter_param_usuario(8014, 48, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_preencher_funcionario_w);
 
	if (not(ie_permite_visita_p = 'N' and 
		ie_consiste_eup_w = 'S') and 
		ie_preencher_funcionario_w = 'S') then 
		select	cd_pessoa_fisica 
		into STRICT	cd_pessoa_fisica_p 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
	end if;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_atend_visita_novo ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_atend_visita_lib_p INOUT text, ie_atend_visita_bloq_p INOUT text, ie_permite_visita_p INOUT text, cd_pessoa_fisica_p INOUT text) FROM PUBLIC;

