-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_regra_ajuste_proc ( nr_sequencia_p bigint, cd_convenio_orig_p bigint, cd_convenio_dest_p text, ie_convenio_p text, ie_tabela_p text, ie_excluir_p text, ie_excluir_estrutura_p text, nm_usuario_p text) AS $body$
DECLARE


/*
ie_tabela_p
	P    - tabela REGRA_AJUSTE_PROC
*/
cd_convenio_dest_w		integer;
cd_classe_material_w           	integer;
cd_grupo_material_w            	smallint;
cd_material_w                  	integer;
cd_subgrupo_material_w         	smallint;
cd_area_procedimento_w          bigint;
cd_especialidade_w              bigint;
cd_grupo_proc_w                 bigint;
cd_procedimento_w               bigint;
ie_origem_proced_w		bigint;
	
c01 CURSOR FOR
	SELECT	coalesce(cd_convenio,0)
	from	convenio
	where	(((ie_convenio_p = '1') and (obter_se_contido(cd_convenio, substr(elimina_aspas(cd_convenio_dest_p),1,200)) = 'S')) or
		((ie_convenio_p = '2') and (not obter_se_contido(cd_convenio, substr(elimina_aspas(cd_convenio_dest_p),1,200)) = 'S')));		


BEGIN

open C01;
loop
fetch C01 into	
	cd_convenio_dest_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (cd_convenio_dest_w > 0) and
		((ie_convenio_p = '1') or (ie_convenio_p = '2' AND cd_convenio_dest_w <> cd_convenio_orig_p)) then
		
		if (ie_excluir_p = 'S') and (ie_tabela_p = 'P') then
			delete from regra_ajuste_proc
			where cd_convenio = cd_convenio_dest_w;
		end if;
		
		if (ie_excluir_estrutura_p = 'S') and (ie_tabela_p = 'P') then

			select	max(cd_area_procedimento),
				max(cd_especialidade),
				max(cd_grupo_proc),
				max(cd_procedimento),
				max(ie_origem_proced)
			into STRICT	cd_area_procedimento_w,
				cd_especialidade_w,
				cd_grupo_proc_w,
				cd_procedimento_w,
				ie_origem_proced_w
			from	regra_ajuste_proc
			where	nr_sequencia = nr_sequencia_p;
			
			delete 	from regra_ajuste_proc
			where 	cd_convenio = cd_convenio_dest_w
			and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0))		= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0))			= coalesce(cd_especialidade_w,0)
			and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0))			= coalesce(cd_procedimento_w,0)
			and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
			and	coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0))			= coalesce(ie_origem_proced_w,0);
		end if;
		
		if (ie_tabela_p = 'P') then
		
			insert into regra_ajuste_proc(
				cd_area_procedimento,
				cd_categoria,            
				cd_categoria_glosa,      
				cd_categoria_ref,        
				cd_cgc_prestador,        
				cd_cid,                  
				cd_convenio,             
				cd_convenio_glosa,       
				cd_convenio_ref,         
				cd_edicao_amb,           
				cd_edicao_filtro,        
				cd_empresa_ref,          
				cd_equipamento,          
				cd_especialidade,        
				cd_estabelecimento,      
				cd_grupo_proc,           
				cd_medico,               
				cd_motivo_exc_conta,     
				cd_municipio_ibge_pac,   
				cd_plano,                
				cd_procedencia,          
				cd_procedimento,         
				cd_procedimento_esp,     
				cd_procedimento_ref,     
				cd_proc_referencia,      
				cd_setor_atendimento,    
				cd_setor_atend_ref,      
				cd_tabela_servico,       
				cd_tipo_acomodacao,      
				ds_observacao,          
				dt_atualizacao,          
				dt_final_vigencia,       
				dt_inicio_vigencia,      
				ie_atend_retorno,        
				ie_autor_particular,     
				ie_beira_leito,          
				ie_carater_inter_sus,    
				ie_clinica,              
				ie_consiste_prescr,      
				ie_credenciado,          
				ie_edicao_convenio,      
				ie_entra_filme_neg,      
				ie_glosa,                
				ie_ignora_ch_edicao_amb, 
				ie_origem_proced,        
				ie_origem_proc_ref,      
				ie_origem_proc_refer,    
				ie_preco_informado,      
				ie_prior_edicao_ajuste, 
				ie_proc_qt_zero_sus, 
				ie_gerar_sem_proc_ref_sus,	
				ie_proc_unico_sus,       
				ie_sexo,                 
				ie_situacao,
				ie_spect,                
				ie_tipo_atend_bpa,       
				ie_tipo_atendimento,     
				ie_utiliza_video,        
				ie_vinculo_medico,       
				nm_usuario,              
				nr_auxiliares,           
				nr_seq_exame,            
				nr_seq_forma_org,        
				nr_seq_grupo,            
				nr_seq_proc_interno,     
				nr_seq_regra_preco,      
				nr_seq_subgrupo,         
				nr_seq_tipo_acidente,    
				nr_sequencia,            
				pr_glosa,                
				qt_dias_inter_final,     
				qt_dias_inter_inicio,    
				qt_filme,                
				qt_idade_max,            
				qt_idade_min,            
				qt_porte_anestesico,     
				tx_adm,                  
				tx_ajuste,               
				tx_ajuste_custo_oper,    
				tx_ajuste_filme,         
				tx_ajuste_matmed,        
				tx_ajuste_medico,        
				tx_ajuste_partic,        
				tx_desconto,             
				vl_anestesista,          
				vl_auxiliares,           
				vl_custo_operacional,    
				vl_glosa,                
				vl_maxproc_regra_sus,    
				vl_medico,               
				vl_proc_ajustado,
				cd_setor_atend_prescr,
				cd_usuario_convenio,
				qt_pos_inicial,
				qt_pos_final,
				NR_SEQ_AREA_INT,
				NR_SEQ_ESPEC_INT,
				NR_SEQ_GRUPO_INT,
				cd_dependente,
				nr_seq_origem,
				NR_SEQ_CLASSIFICACAO,
				cd_especialidade_medica,
				nr_seq_estrutura)
			SELECT	cd_area_procedimento,    
				cd_categoria,            
				cd_categoria_glosa,      
				cd_categoria_ref,        
				cd_cgc_prestador,        
				cd_cid,                  
				cd_convenio_dest_w,             
				cd_convenio_glosa,       
				cd_convenio_ref,         
				cd_edicao_amb,           
				cd_edicao_filtro,        
				cd_empresa_ref,          
				cd_equipamento,          
				cd_especialidade,        
				cd_estabelecimento,      
				cd_grupo_proc,           
				cd_medico,               
				cd_motivo_exc_conta,     
				cd_municipio_ibge_pac,   
				cd_plano,                
				cd_procedencia,          
				cd_procedimento,         
				cd_procedimento_esp,     
				cd_procedimento_ref,     
				cd_proc_referencia,      
				cd_setor_atendimento,    
				cd_setor_atend_ref,      
				cd_tabela_servico,       
				cd_tipo_acomodacao,      
				ds_observacao,          
				clock_timestamp(),          
				dt_final_vigencia,       
				dt_inicio_vigencia,      
				ie_atend_retorno,        
				ie_autor_particular,     
				ie_beira_leito,          
				ie_carater_inter_sus,    
				ie_clinica,              
				ie_consiste_prescr,      
				ie_credenciado,          
				ie_edicao_convenio,      
				ie_entra_filme_neg,      
				ie_glosa,                
				ie_ignora_ch_edicao_amb, 
				ie_origem_proced,        
				ie_origem_proc_ref,      
				ie_origem_proc_refer,    
				ie_preco_informado,      
				ie_prior_edicao_ajuste, 
				ie_proc_qt_zero_sus,  
				ie_gerar_sem_proc_ref_sus,	
				ie_proc_unico_sus,       
				ie_sexo,                 
				ie_situacao,
				ie_spect,                
				ie_tipo_atend_bpa,       
				ie_tipo_atendimento,     
				ie_utiliza_video,        
				ie_vinculo_medico,       
				nm_usuario_p,              
				nr_auxiliares,           
				nr_seq_exame,            
				nr_seq_forma_org,        
				nr_seq_grupo,            
				nr_seq_proc_interno,     
				nr_seq_regra_preco,      
				nr_seq_subgrupo,         
				nr_seq_tipo_acidente,    
				nextval('regra_ajuste_proc_seq'),            
				pr_glosa,                
				qt_dias_inter_final,     
				qt_dias_inter_inicio,    
				qt_filme,                
				qt_idade_max,            
				qt_idade_min,            
				qt_porte_anestesico,     
				tx_adm,                  
				tx_ajuste,               
				tx_ajuste_custo_oper,    
				tx_ajuste_filme,         
				tx_ajuste_matmed,        
				tx_ajuste_medico,        
				tx_ajuste_partic,        
				tx_desconto,             
				vl_anestesista,          
				vl_auxiliares,           
				vl_custo_operacional,    
				vl_glosa,                
				vl_maxproc_regra_sus,    
				vl_medico,               
				vl_proc_ajustado,
				cd_setor_atend_prescr,
				cd_usuario_convenio,
				qt_pos_inicial,
				qt_pos_final,
				NR_SEQ_AREA_INT,
				NR_SEQ_ESPEC_INT,
				NR_SEQ_GRUPO_INT,
				cd_dependente,
				nr_seq_origem,
				NR_SEQ_CLASSIFICACAO,
				cd_especialidade_medica,
				nr_seq_estrutura
		from	regra_ajuste_proc
		where	nr_sequencia	= nr_sequencia_p
		and	cd_convenio	= cd_convenio_orig_p;
		
		
		
		end if;
	end if;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_regra_ajuste_proc ( nr_sequencia_p bigint, cd_convenio_orig_p bigint, cd_convenio_dest_p text, ie_convenio_p text, ie_tabela_p text, ie_excluir_p text, ie_excluir_estrutura_p text, nm_usuario_p text) FROM PUBLIC;

