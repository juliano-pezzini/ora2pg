-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_undo_exam_appoint_link (nr_atendimento_p bigint, ie_button_p text ) AS $body$
DECLARE


    c01 CURSOR FOR
        SELECT	a.nr_sequencia
        from	cpoe_procedimento a
        where	a.ie_pre_cons_exam = 'S'
        and     coalesce(a.dt_liberacao::text, '') = ''
        and     a.nr_atendimento = nr_atendimento_p;

    c02 CURSOR FOR
        SELECT  a.nr_sequencia
        from    cpoe_procedimento a
        where   a.ie_pre_cons_exam = 'S'
        and     coalesce(a.dt_liberacao::text, '') = ''
        and     a.nr_atendimento = nr_atendimento_p
        and     not exists (SELECT 1 from cpoe_pre_cons_link b where b.nr_cpoe_pre_cons_exam = a.nr_sequencia);
BEGIN
    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
        if (ie_button_p = 'CANCEL') then
            for r_c01 in c01 loop
                EXIT WHEN NOT FOUND; /* apply on c01 */

                update  cpoe_procedimento
                set     dt_pre_cons_exam  = NULL
                where   nr_sequencia = r_c01.nr_sequencia;

                update  prescr_procedimento
                set     dt_prev_execucao  = NULL
                where   nr_seq_proc_cpoe = r_c01.nr_sequencia;

                delete
                from    cpoe_pre_cons_link
                where   nr_cpoe_pre_cons_exam = r_c01.nr_sequencia;

            end loop;

        else
             for r_c02 in c02 loop
                EXIT WHEN NOT FOUND; /* apply on c02 */

				CALL cpoe_remover_item('P', r_c02.nr_sequencia, obter_usuario_ativo);

            end loop;
        end if;
        commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_undo_exam_appoint_link (nr_atendimento_p bigint, ie_button_p text ) FROM PUBLIC;

