-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_excluir_favorito ( itens_liberar_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_reg_item_w	cpoe_fav_material.nr_sequencia%type;
ie_opcao_prescr_ww	varchar(4000);
ie_opcao_prescr_w	varchar(2);
item_w				varchar(255);
ds_item_w			varchar(255);
ie_tipo_dieta_w		cpoe_dieta.ie_tipo_dieta%type;
cd_dieta_w			cpoe_dieta.cd_dieta%type;
cd_material_w		cpoe_dieta.cd_material%type;
nr_seq_tipo_w		cpoe_dieta.nr_seq_tipo%type;

BEGIN

ie_opcao_prescr_ww := itens_liberar_p;

for i in 1..length(ie_opcao_prescr_ww) loop

	if (length(ie_opcao_prescr_ww) > 1) then
		-- R,12;M,12345;D,1233;M,2312;
		item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
		ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
		nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
		ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));

		if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') then
			if (ie_opcao_prescr_w = 'MA') then
				ie_opcao_prescr_w := 'M';
			end if;

			case ie_opcao_prescr_w
				when 'M' then --Material
					select	substr(obter_desc_material(cd_material),1,255)
					into STRICT	ds_item_w
					from	cpoe_fav_material
					where	nr_sequencia = nr_seq_reg_item_w;

					delete from cpoe_fav_material
					where nr_sequencia = nr_seq_reg_item_w;

					CALL gravar_log_tasy(10006, 'Material Exlcuído dos favoritos: ' || ds_item_w
									|| obter_desc_expressao(298311) || nr_seq_reg_item_w --sequencia
									|| obter_desc_expressao(298822) || dbms_utility.format_call_stack,
									nm_usuario_p);


				when 'N' then --Nutricao
					select	max(ie_tipo_dieta),
							max(cd_material),
							max(cd_dieta),
							max(nr_seq_tipo)
					into STRICT	ie_tipo_dieta_w,
							cd_material_w,
							cd_dieta_w,
							nr_seq_tipo_w
					from	cpoe_fav_dieta
					where	nr_sequencia = nr_seq_reg_item_w;

					if (ie_tipo_dieta_w = 'O') then

						select	substr(ds_dieta,1,255)
						into STRICT	ds_item_w
						from	dieta
						where	cd_dieta = cd_dieta_w;

					elsif (ie_tipo_dieta_w = 'J') then

						select	substr(ds_tipo,1,255)
						into STRICT	ds_item_w
						from	rep_tipo_jejum
						where	nr_sequencia = nr_seq_tipo_w;

					else
						--Enteral, Suplemento, Leite
						ds_item_w := substr(obter_desc_material(cd_material_w),1,255);
					end if;

					delete from cpoe_fav_dieta
					where nr_sequencia = nr_seq_reg_item_w;

					CALL gravar_log_tasy(10006, /*'Nutricao Exlcuída dos favoritos: '*/
 obter_desc_expressao(781578) || ds_item_w
									|| obter_desc_expressao(559991) || ie_tipo_dieta_w --tipo dieta
									||  obter_desc_expressao(298311)  || nr_seq_reg_item_w --sequencia
									|| obter_desc_expressao(298822) || dbms_utility.format_call_stack,
									nm_usuario_p);

				when 'P' then --Procedimentos
					select	substr(cpoe_obter_desc_proc_interno(nr_seq_proc_interno),1,255)
					into STRICT	ds_item_w
					from	cpoe_fav_procedimento
					where	nr_sequencia = nr_seq_reg_item_w;

					delete from cpoe_fav_procedimento
					where nr_sequencia = nr_seq_reg_item_w;

					CALL gravar_log_tasy(10006, 'Procedimento Exlcuído dos favoritos: ' || ds_item_w
									|| obter_desc_expressao(298311) || nr_seq_reg_item_w --sequencia
									|| obter_desc_expressao(298822) || dbms_utility.format_call_stack,
									nm_usuario_p);

				when 'G' then --Gasoterapia
					select	substr(obter_desc_gas(nr_seq_gas),1,255)
					into STRICT	ds_item_w
					from	cpoe_fav_gasoterapia
					where	nr_sequencia = nr_seq_reg_item_w;

					delete from cpoe_fav_gasoterapia
					where nr_sequencia = nr_seq_reg_item_w;

					CALL gravar_log_tasy(10006, 'Gasoterapia Exlcuída dos favoritos: ' || ds_item_w
									|| obter_desc_expressao(298311) || nr_seq_reg_item_w --sequencia
									|| obter_desc_expressao(298822) || dbms_utility.format_call_stack,
									nm_usuario_p);

				when 'R' then --Recomendação
					select	substr(obter_desc_recomendacao(cd_recomendacao),1,255)
					into STRICT	ds_item_w
					from	cpoe_fav_recomendacao
					where	nr_sequencia = nr_seq_reg_item_w;

					delete from cpoe_fav_recomendacao
					where nr_sequencia = nr_seq_reg_item_w;

					CALL gravar_log_tasy(10006, 'Recomendação Exlcuída dos favoritos: ' || ds_item_w
									|| obter_desc_expressao(298311) || nr_seq_reg_item_w --sequencia
									|| obter_desc_expressao(298822) || dbms_utility.format_call_stack,
									nm_usuario_p);
			end case;
		end if;
	end if;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_excluir_favorito ( itens_liberar_p text, nm_usuario_p text) FROM PUBLIC;

