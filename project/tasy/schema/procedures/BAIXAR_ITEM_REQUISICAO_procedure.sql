-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_item_requisicao ( nr_requisicao_p bigint, cd_material_p bigint, cd_material_lido_p bigint, qt_baixar_p bigint, nr_seq_lote_fornec_p bigint, cd_motivo_baixa_p bigint, cd_operacao_estoque_p bigint, ie_baixa_sem_saldo_p text, dt_atendimento_p timestamp, cd_barras_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
nr_seq_w				bigint;
nr_seq_ww			bigint;
qt_requisitada_w			double precision;
qt_requisitada_ww			double precision;
qt_baixa_total_w			double precision;
qt_baixar_w			double precision;
qt_baixar_ww			double precision;
qt_diferenca_w			double precision;
ds_erro_w			varchar(255);
cd_kit_material_w			integer;
cd_local_estoque_w		smallint;
cd_estabelecimento_w		smallint;
qt_liberada_w			bigint;
dt_atendimento_w			timestamp;
qt_obter_motivo_baixa_w		bigint;
dt_atendimento_item_w		timestamp;
ie_req_transferencia_mexico_w	varchar(1) := 'N';
nr_seq_lock_reg_w		item_requisicao_material.nr_sequencia%type;
cd_operacao_estoque_w	requisicao_material.cd_operacao_estoque%type;
ds_historico_w			requisicao_mat_historico.ds_historico%type;
ds_historico_final_w	requisicao_mat_historico.ds_historico%type;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		qt_material_requisitada,
		dt_atendimento
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p
	and	cd_material = cd_material_p
	and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 0
	and	coalesce(coalesce(nr_seq_lote_fornec, nr_seq_lote_fornec_p),0) = coalesce(nr_seq_lote_fornec_p,0)
	
union

	SELECT	nr_sequencia,
		qt_material_requisitada,
		dt_atendimento
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p
	and	cd_material = cd_material_p
	and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 0
	and	coalesce(nr_seq_lote_fornec,0) <> coalesce(nr_seq_lote_fornec_p,0)
	order by	2 desc;
	
c02 CURSOR FOR
  SELECT nr_sequencia
	  from item_requisicao_material
	 where nr_requisicao	= nr_requisicao_p
	 for update;


BEGIN

open c02;
loop
fetch c02 into
	nr_seq_lock_reg_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
end loop;
close c02;

select	count(*)
into STRICT	qt_liberada_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
if (qt_liberada_w = 0) then
	CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(185845,'NR_REQUISICAO='||nr_requisicao_p);
end if;

qt_baixa_total_w	:= 0;
qt_baixar_w		:= coalesce(qt_baixar_p,0);
dt_atendimento_w	:= coalesce(dt_atendimento_p,clock_timestamp());

select	sum(coalesce(qt_material_requisitada,0))
into STRICT	qt_baixar_ww
from	item_requisicao_material
where	nr_requisicao = nr_requisicao_p
and	cd_material = cd_material_p
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 0
and	coalesce(coalesce(nr_seq_lote_fornec, nr_seq_lote_fornec_p),0) = coalesce(nr_seq_lote_fornec_p,0);

qt_diferenca_w		:= qt_baixar_w - qt_baixar_ww;

if (qt_diferenca_w > 0) then

	select	max(nr_sequencia) + 1
	into STRICT	nr_seq_w
	from	item_requisicao_material
	where	nr_requisicao	= nr_requisicao_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_ww
	from	item_requisicao_material
	where	nr_requisicao	= nr_requisicao_p
	and	cd_material	= cd_material_p
	and	obter_tipo_motivo_baixa_req(cd_motivo_baixa)	= 0
	and	coalesce(coalesce(nr_seq_lote_fornec, nr_seq_lote_fornec_p),0) = coalesce(nr_seq_lote_fornec_p,0);

	insert into item_requisicao_material(
		nr_requisicao,
		nr_sequencia,
		cd_estabelecimento,
		cd_material,
		qt_material_requisitada,
		qt_material_atendida,
		vl_material,
		dt_atualizacao,
		nm_usuario,
		cd_unidade_medida,
		cd_pessoa_recebe,
		cd_pessoa_atende,
		cd_motivo_baixa,
		qt_estoque,
		cd_unidade_medida_estoque,
		cd_conta_contabil,
		cd_material_req,
		ie_geracao,
		cd_cgc_fornecedor,
		cd_barras,
		nr_seq_kit_estoque)
	SELECT	nr_requisicao,
		nr_seq_w,
		cd_estabelecimento,
		cd_material,
		qt_diferenca_w,
		qt_diferenca_w,
		vl_material,
		clock_timestamp(),
		nm_usuario_p,
		cd_unidade_medida,
		cd_pessoa_recebe,
		cd_pessoa_atende,
		0,
		qt_diferenca_w,
		cd_unidade_medida_estoque,
		cd_conta_contabil,
		cd_material_req,
		'S',
		cd_cgc_fornecedor,
		cd_barras_p,
		nr_seq_kit_estoque
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p
	and	nr_sequencia  = nr_seq_ww;
	
	/* 1213581 - Item desdobrado no atendimento da requisicao.
	155087 - Item #@NR_SEQUENCIA#@ [#@CD_MATERIAL#@] - #@DS_MATERIAL#@.
	Quantidade atendida: #@QT_MATERIAL_ATENDIDA#@
	1213571 - Lote: #@NRLOTE#@
	1213582 - Quantidade requisitada: #@QT_REQUISITADA#@
	1213583 - Codigo: #@CODIGO#@ */
	ds_historico_w := substr(WHEB_MENSAGEM_PCK.get_texto(1213581) || chr(10)||chr(13)
						|| WHEB_MENSAGEM_PCK.get_texto(155087,	'NR_SEQUENCIA=' || nr_seq_ww ||
																';CD_MATERIAL=' || cd_material_p ||
																';DS_MATERIAL=' || obter_desc_material(cd_material_p => cd_material_p) ||
																';QT_MATERIAL_ATENDIDA=' || qt_baixar_w) || chr(10)||chr(13)
						|| WHEB_MENSAGEM_PCK.get_texto(1213571,	'NRLOTE=' || nr_seq_lote_fornec_p) || chr(10)||chr(13)
						|| WHEB_MENSAGEM_PCK.get_texto(1213582,	'QT_REQUISITADA=' || qt_baixar_ww) || chr(10)||chr(13)
						|| chr(10)||chr(13)
						|| substr(dbms_utility.format_call_stack,1,3000) || chr(10)||chr(13)
						|| WHEB_MENSAGEM_PCK.get_texto(1213583,	'CODIGO=' || 'BIR001'),1,4000);
						
	insert into requisicao_mat_historico(
		nr_sequencia,
		nr_requisicao,
		dt_atualizacao,
		nm_usuario,
		dt_historico,
		ds_titulo,
		ds_historico,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo,
		cd_evento,
		dt_liberacao,
		nm_usuario_lib)
	values (nextval('requisicao_mat_historico_seq'),
		nr_requisicao_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		WHEB_MENSAGEM_PCK.get_texto(355122),
		ds_historico_w,
		clock_timestamp(),
		nm_usuario_p,
		'S',
		'AR',
		clock_timestamp(),
		nm_usuario_p);

	select	sum(coalesce(qt_material_requisitada,0))
	into STRICT	qt_baixar_ww
	from	item_requisicao_material
	where	nr_requisicao	= nr_requisicao_p
	and	cd_material	= cd_material_p
	and	obter_tipo_motivo_baixa_req(cd_motivo_baixa)	= 0
	and	coalesce(coalesce(nr_seq_lote_fornec, nr_seq_lote_fornec_p),0) = coalesce(nr_seq_lote_fornec_p,0);
end if;

begin
	select	cd_local_estoque,
			cd_operacao_estoque
	into STRICT	cd_local_estoque_w,
			cd_operacao_estoque_w
	from	requisicao_material
	where	nr_requisicao = nr_requisicao_p;
exception
	when no_data_found then
		cd_local_estoque_w := null;
		cd_operacao_estoque_w := null;
end;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	local_estoque
where	cd_local_estoque = cd_local_estoque_w;

select	coalesce(obter_mat_estabelecimento(cd_estabelecimento_w, 0, cd_material_lido_p, 'KT'),0)
into STRICT	cd_kit_material_w
;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	qt_requisitada_w,
	dt_atendimento_item_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	if (qt_baixa_total_w < qt_baixar_w) then
		begin

		if (qt_requisitada_w >= qt_baixar_w) then
			begin

			nr_sequencia_ww := Desdobrar_Item_Requisicao(nr_requisicao_p, nr_sequencia_w, qt_baixar_w, nr_seq_lote_fornec_p, nm_usuario_p, nr_sequencia_ww);

			update	item_requisicao_material
			set	nr_seq_cor_exec	= 103
			where	nr_requisicao	= nr_requisicao_p
			and	nr_sequencia	= nr_sequencia_ww
			and	coalesce(nr_seq_cor_exec::text, '') = '';

			if (cd_material_lido_p IS NOT NULL AND cd_material_lido_p::text <> '') and (coalesce(cd_kit_material_w,0) = 0) then
				begin
				update	item_requisicao_material
				set	cd_material_lido	= cd_material_lido_p
				where	nr_requisicao	= nr_requisicao_p
				and	nr_sequencia	= nr_sequencia_ww;
				exception
				when others then
					null;
				end;
			end if;

			qt_obter_motivo_baixa_w	:= obter_tipo_motivo_baixa_req(cd_motivo_baixa_p);
			
			if (nr_sequencia_w <> nr_sequencia_ww) then
				/* 1213581 - Item desdobrado no atendimento da requisicao.
				155087 - Item #@NR_SEQUENCIA#@ [#@CD_MATERIAL#@] - #@DS_MATERIAL#@.
				Quantidade atendida: #@QT_MATERIAL_ATENDIDA#@
				1213571 - Lote: #@NRLOTE#@
				1213582 - Quantidade requisitada: #@QT_REQUISITADA#@
				1213583 - Codigo: #@CODIGO#@ */
				ds_historico_w := substr(WHEB_MENSAGEM_PCK.get_texto(1213581) || chr(10)||chr(13)
									|| WHEB_MENSAGEM_PCK.get_texto(155087,	'NR_SEQUENCIA=' || nr_sequencia_w ||
																			';CD_MATERIAL=' || cd_material_p ||
																			';DS_MATERIAL=' || obter_desc_material(cd_material_p => cd_material_p) ||
																			';QT_MATERIAL_ATENDIDA=' || qt_baixar_w) || chr(10)||chr(13)
									|| WHEB_MENSAGEM_PCK.get_texto(1213571,	'NRLOTE=' || nr_seq_lote_fornec_p) || chr(10)||chr(13)
									|| WHEB_MENSAGEM_PCK.get_texto(1213582,	'QT_REQUISITADA=' || qt_requisitada_w) || chr(10)||chr(13)
									|| chr(10)||chr(13)
									|| substr(dbms_utility.format_call_stack,1,3000) || chr(10)||chr(13)
									|| WHEB_MENSAGEM_PCK.get_texto(1213583,	'CODIGO=' || 'BIR002'),1,4000);
									
				insert into requisicao_mat_historico(
					nr_sequencia,
					nr_requisicao,
					dt_atualizacao,
					nm_usuario,
					dt_historico,
					ds_titulo,
					ds_historico,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_tipo,
					cd_evento,
					dt_liberacao,
					nm_usuario_lib)
				values (nextval('requisicao_mat_historico_seq'),
					nr_requisicao_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					WHEB_MENSAGEM_PCK.get_texto(355122),
					ds_historico_w,
					clock_timestamp(),
					nm_usuario_p,
					'S',
					'AR',
					clock_timestamp(),
					nm_usuario_p);
			end if;

			/* Tratamento realizado para a OS 1433128 integracao HAOC Esteira*/

			 if (coalesce(dt_atendimento_item_w::text, '') = '') and (qt_obter_motivo_baixa_w not in (1,4)) then

				select CASE WHEN qt_obter_motivo_baixa_w=5 THEN qt_requisitada_w  ELSE 0 END
				into STRICT qt_obter_motivo_baixa_w
				;

				CALL set_cd_motivo_bai_item_req_mat(
						nr_sequencia_ww,
						nr_requisicao_p,
						cd_motivo_baixa_p,
						qt_obter_motivo_baixa_w,
						dt_atendimento_p,
						nm_usuario_p);

			else
				ie_req_transferencia_mexico_w := obter_se_transf_local_mexico(
										cd_estabelecimento_p	=> cd_estabelecimento_w,
										cd_operacao_estoque_p	=> cd_operacao_estoque_w);

				if (ie_req_transferencia_mexico_w = 'S') then
					CALL transf_local_est_consig_mexico(nr_requisicao_p	=> nr_requisicao_p,
								nr_sequencia_p		=> nr_sequencia_ww,
								qt_atendida_p		=> qt_baixar_w,
								cd_motivo_baixa_p	=> cd_motivo_baixa_p,
								cd_operacao_estoque_p	=> cd_operacao_estoque_w,
								dt_atendimento_p	=> dt_atendimento_w,
								cd_barras_p		=> cd_barras_p,
								ie_acao_p		=> '1',
								nm_usuario_p		=> nm_usuario_p);
				else
					ds_erro_w := gerar_movto_estoque_req(nr_requisicao_p, nr_sequencia_ww, cd_operacao_estoque_w, qt_baixar_w, dt_atendimento_w, cd_motivo_baixa_p, '1', ie_baixa_sem_saldo_p, nm_usuario_p, cd_barras_p, ds_erro_w);
				end if;

			end if;

			qt_baixa_total_w := qt_baixa_total_w + qt_baixar_w;
			end;

		else
			begin

			update item_requisicao_material
			set	nr_seq_cor_exec		= 103,
				cd_material_lido		= cd_material_lido_p,
				nr_seq_lote_fornec		= nr_seq_lote_fornec_p
			where	nr_requisicao		= nr_requisicao_p
			and	nr_sequencia		= nr_sequencia_w
			and	coalesce(nr_seq_cor_exec::text, '') = '';

			if (cd_material_lido_p IS NOT NULL AND cd_material_lido_p::text <> '') and (coalesce(cd_kit_material_w,0) = 0) then
				update item_requisicao_material
				set	cd_material_lido	= cd_material_lido_p,
					nr_seq_lote_fornec	= nr_seq_lote_fornec_p
				where	nr_requisicao	= nr_requisicao_p
				and	nr_sequencia	= nr_sequencia_w;
			end if;

			qt_baixa_total_w	:= qt_baixa_total_w + qt_requisitada_w;
			qt_requisitada_ww	:= qt_requisitada_w;
			
			/* 1213690 - Quantidade total: #@VL_QT_MATERIAL#@
			1213691 - Quantidade anterior: #@QT_ROUPA#@ */
			ds_historico_final_w := substr(	WHEB_MENSAGEM_PCK.get_texto(1213690, 'VL_QT_MATERIAL=' || qt_baixa_total_w) || chr(10)||chr(13)
										|| WHEB_MENSAGEM_PCK.get_texto(1213691, 'QT_ROUPA=' || qt_baixar_ww),1,4000);

			if (qt_baixa_total_w > qt_baixar_w) then
				qt_requisitada_ww	:= qt_baixa_total_w - qt_baixar_w;
				qt_baixa_total_w	:= qt_baixar_w;
				if	((qt_baixar_ww - qt_baixa_total_w) > 0) then
					nr_sequencia_ww := Desdobrar_Item_Requisicao(nr_requisicao_p, nr_sequencia_w, (qt_baixar_ww - qt_baixa_total_w), nr_seq_lote_fornec_p, nm_usuario_p, nr_sequencia_ww);
					qt_requisitada_ww	:= qt_requisitada_w - (qt_baixar_ww - qt_baixa_total_w);
					
					if (nr_sequencia_w <> nr_sequencia_ww) then
						/* 1213581 - Item desdobrado no atendimento da requisicao.
						155087 - Item #@NR_SEQUENCIA#@ [#@CD_MATERIAL#@] - #@DS_MATERIAL#@.
						Quantidade atendida: #@QT_MATERIAL_ATENDIDA#@
						1213571 - Lote: #@NRLOTE#@
						1213582 - Quantidade requisitada: #@QT_REQUISITADA#@
						1213583 - Codigo: #@CODIGO#@ */
						ds_historico_w := substr(WHEB_MENSAGEM_PCK.get_texto(1213581) || chr(10)||chr(13)
											|| WHEB_MENSAGEM_PCK.get_texto(155087,	'NR_SEQUENCIA=' || nr_sequencia_w ||
																					';CD_MATERIAL=' || cd_material_p ||
																					';DS_MATERIAL=' || obter_desc_material(cd_material_p => cd_material_p) ||
																					';QT_MATERIAL_ATENDIDA=' || qt_baixar_w) || chr(10)||chr(13)
											|| WHEB_MENSAGEM_PCK.get_texto(1213571,	'NRLOTE=' || nr_seq_lote_fornec_p) || chr(10)||chr(13)
											|| WHEB_MENSAGEM_PCK.get_texto(1213582,	'QT_REQUISITADA=' || qt_requisitada_w) || chr(10)||chr(13)
											|| chr(10)||chr(13)
											|| substr(dbms_utility.format_call_stack,1,3000) || chr(10)||chr(13)
											|| ds_historico_final_w || chr(10)||chr(13)
											|| WHEB_MENSAGEM_PCK.get_texto(1213583,	'CODIGO=' || 'BIR003'),1,4000);

						insert into requisicao_mat_historico(
							nr_sequencia,
							nr_requisicao,
							dt_atualizacao,
							nm_usuario,
							dt_historico,
							ds_titulo,
							ds_historico,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ie_tipo,
							cd_evento,
							dt_liberacao,
							nm_usuario_lib)
						values (nextval('requisicao_mat_historico_seq'),
							nr_requisicao_p,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							WHEB_MENSAGEM_PCK.get_texto(355122),
							ds_historico_w,
							clock_timestamp(),
							nm_usuario_p,
							'S',
							'AR',
							clock_timestamp(),
							nm_usuario_p);
					end if;
				end if;
			end if;

			ie_req_transferencia_mexico_w := obter_se_transf_local_mexico(
									cd_estabelecimento_p	=> cd_estabelecimento_w,
									cd_operacao_estoque_p	=> cd_operacao_estoque_w);

			if (ie_req_transferencia_mexico_w = 'S') then
				CALL transf_local_est_consig_mexico(nr_requisicao_p	=> nr_requisicao_p,
							nr_sequencia_p		=> nr_sequencia_w,
							qt_atendida_p		=> qt_requisitada_ww,
							cd_motivo_baixa_p	=> cd_motivo_baixa_p,
							cd_operacao_estoque_p	=> cd_operacao_estoque_w,
							dt_atendimento_p	=> dt_atendimento_w,
							cd_barras_p		=> cd_barras_p,
							ie_acao_p		=> '1',
							nm_usuario_p		=> nm_usuario_p);
			else
				ds_erro_w := gerar_movto_estoque_req(nr_requisicao_p, nr_sequencia_w, cd_operacao_estoque_w, qt_requisitada_ww, dt_atendimento_w, cd_motivo_baixa_p, '1', ie_baixa_sem_saldo_p, nm_usuario_p, cd_barras_p, ds_erro_w);
			end if;

			end;
		end if;
		end;
	end if;
	end;
end loop;
close c01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_item_requisicao ( nr_requisicao_p bigint, cd_material_p bigint, cd_material_lido_p bigint, qt_baixar_p bigint, nr_seq_lote_fornec_p bigint, cd_motivo_baixa_p bigint, cd_operacao_estoque_p bigint, ie_baixa_sem_saldo_p text, dt_atendimento_p timestamp, cd_barras_p text, nm_usuario_p text) FROM PUBLIC;

