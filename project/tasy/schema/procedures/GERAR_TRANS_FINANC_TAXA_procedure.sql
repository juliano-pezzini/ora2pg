-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_trans_financ_taxa (nr_seq_movto_trans_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_transacao_w			double precision;
dt_transacao_w			timestamp;
dt_referencia_saldo_w		timestamp;
nr_seq_banco_w			bigint;
nr_seq_trans_financ_w		bigint;
nr_seq_caixa_w			bigint;
nr_seq_lote_w			bigint;
nr_seq_saldo_banco_w		bigint;
nr_seq_trans_fin_taxa_w		bigint;
pr_taxa_w			double precision;
nr_seq_movto_trans_taxa_w	bigint;
nr_seq_saldo_caixa_w		bigint;
/* Projeto Multimoeda - Variáveis*/

vl_transacao_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;

c01 CURSOR FOR
SELECT	nr_seq_trans_fin_taxa,
	pr_taxa
from	trans_financ_taxa
where	nr_seq_trans_financ	= nr_seq_trans_financ_w;


BEGIN

begin
select	a.vl_transacao,
	a.dt_transacao,
	a.dt_referencia_saldo,
	a.nr_seq_banco,
	a.nr_seq_trans_financ,
	a.nr_seq_caixa,
	a.nr_seq_lote,
	a.nr_seq_saldo_banco,
	a.nr_seq_saldo_caixa,
	a.vl_transacao_estrang, -- Projeto Multimoeda - Busca valores em moeda estrangeira
	a.vl_cotacao,
	a.cd_moeda
into STRICT	vl_transacao_w,
	dt_transacao_w,
	dt_referencia_saldo_w,
	nr_seq_banco_w,
	nr_seq_trans_financ_w,
	nr_seq_caixa_w,
	nr_seq_lote_w,
	nr_seq_saldo_banco_w,
	nr_seq_saldo_caixa_w,
	vl_transacao_estrang_w,
	vl_cotacao_w,
	cd_moeda_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_movto_trans_p;
exception
	when no_data_found then
		nr_seq_trans_financ_w	:= 0;
end;

open c01;
loop
fetch c01 into
	nr_seq_trans_fin_taxa_w,
	pr_taxa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	nextval('movto_trans_financ_seq')
	into STRICT	nr_seq_movto_trans_taxa_w
	;

	/* Projeto Multimoeda - Verifica se a transação é em moeda estrangeira, caso positivo calcula o valor da taxa em moeda estrangeira de acordo com a cotação,
		caso negativo limpa as variáveis antes de inserir a transação. */
	if (coalesce(vl_cotacao_w,0) <> 0 and coalesce(vl_transacao_estrang_w,0) <> 0) then
		vl_transacao_estrang_w	:= (vl_transacao_w * (dividir_sem_round((pr_taxa_w)::numeric, 100))) / vl_cotacao_w;
		vl_complemento_w	:= (vl_transacao_w * (dividir_sem_round((pr_taxa_w)::numeric, 100))) - vl_transacao_estrang_w;
	else
		vl_transacao_estrang_w	:= null;
		vl_complemento_w	:= null;
		vl_cotacao_w		:= null;
		cd_moeda_w		:= null;
	end if;

	insert	into movto_trans_financ(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_trans_financ,
		vl_transacao,
		dt_transacao,
		dt_referencia_saldo,
		nr_seq_banco,
		nr_seq_caixa,
		nr_seq_lote,
		nr_seq_saldo_banco,
		nr_lote_contabil,
		ie_conciliacao,
		nr_seq_saldo_caixa,
		vl_transacao_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda)
	values
		(nr_seq_movto_trans_taxa_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_trans_fin_taxa_w,
		(vl_transacao_w * (dividir_sem_round((pr_taxa_w)::numeric, 100))),
		dt_transacao_w,
		dt_referencia_saldo_w,
		nr_seq_banco_w,
		nr_seq_caixa_w,
		nr_seq_lote_w,
		nr_seq_saldo_banco_w,
		0,
		'N',
		nr_seq_saldo_caixa_w,
		vl_transacao_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w);

end loop;
close c01;

-- NÃO DAR COMMIT
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_trans_financ_taxa (nr_seq_movto_trans_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

