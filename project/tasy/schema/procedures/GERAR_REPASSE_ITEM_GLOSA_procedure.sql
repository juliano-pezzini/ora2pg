-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_repasse_item_glosa ( nr_repasse_terceiro_p bigint, nr_seq_ret_glosa_p bigint, qt_perc_item_gerado_p bigint, nm_usuario_p text, nr_seq_terceiro_p bigint, ie_gerar_item_pendente_p text) AS $body$
DECLARE

 
nr_sequencia_item_w	bigint;
nr_sequencia_w		bigint;
nr_seq_terceiro_w		bigint;
cd_estabelecimento_w	bigint;
nr_seq_trans_fin_w		bigint;
nr_seq_trans_fin_adic_w	bigint;
cd_motivo_glosa_w		bigint;
vl_glosa_w		double precision;
vl_amaior_w		double precision;
vl_repasse_item_w		double precision;
ie_acao_glosa_w		varchar(10);
ds_proc_mat_w		varchar(255);
ds_observacao_w		varchar(4000);
nm_pessoa_fisica_w	varchar(255);
cd_autorizacao_w		varchar(255);
nr_titulo_w		varchar(255);
nr_atendimento_w		bigint;
nr_seq_retorno_w		bigint;
nr_seq_propaci_w		bigint;
nr_seq_matpaci_w		bigint;
cd_setor_atendimento_w	integer;
cd_centro_custo_w		integer;
cd_convenio_w		integer;
dt_baixa_w		timestamp;
cd_centro_custo_prov_w	integer;
nr_seq_trans_fin_prov_w	bigint;
cd_conta_contabil_w	varchar(20);
cd_conta_contabil_prov_w	varchar(20);
cd_medico_w		varchar(10);
cd_procedimento_w	bigint;
nr_seq_trans_item_rep_w	bigint;
dt_liberacao_w		timestamp;
cd_material_w		integer;
ie_origem_proced_w	bigint;
ie_trans_financ_terc_w	varchar(2);
ie_conta_contabil_terc_w varchar(1);
cd_conta_contabil_ter_w	 varchar(20);	
--Gerado a partir dos ítens glosados/Adicionais no retorno de convênio. 
ds_observacao_ww 	 varchar(4000) := wheb_mensagem_pck.get_texto(307561);
ds_texto_proc_mat_w	 varchar(100) := wheb_mensagem_pck.get_texto(307562);

BEGIN
 
select	max(nr_seq_propaci), 
	max(nr_seq_matpaci) 
into STRICT	nr_seq_propaci_w, 
	nr_seq_matpaci_w 
from	convenio_retorno_glosa 
where	nr_sequencia	= nr_seq_ret_glosa_p;
 
select	max(a.cd_medico_executor) 
into STRICT	cd_medico_w 
from	procedimento_paciente a 
where	a.nr_sequencia	= nr_seq_propaci_w;
 
if (coalesce(cd_medico_w::text, '') = '') then 
	select	max(a.cd_medico_prescritor) 
	into STRICT	cd_medico_w 
	from	material_atend_paciente a 
	where	a.nr_sequencia	= nr_seq_matpaci_w;
end if;
 
select	max(cd_setor_atendimento) 
into STRICT	cd_setor_atendimento_w 
from (SELECT	cd_setor_atendimento 
	from	procedimento_paciente 
	where	nr_sequencia	= nr_seq_propaci_w 
	
union
 
	SELECT	cd_setor_atendimento 
	from	material_atend_paciente 
	where	nr_sequencia	= nr_seq_matpaci_w) alias1;
 
select	max(cd_centro_custo) 
into STRICT	cd_centro_custo_w 
from	setor_atendimento 
where	cd_setor_atendimento	= cd_setor_atendimento_w;
 
select	((coalesce(a.vl_amaior, 0) * coalesce(qt_perc_item_gerado_p, 0)) / 100),	 
	((coalesce(a.vl_glosa, 0) * coalesce(qt_perc_item_gerado_p, 0)) / 100), 
	coalesce(a.cd_motivo_glosa,-1), 
	substr(CASE WHEN coalesce(a.cd_procedimento::text, '') = '' THEN obter_desc_material(a.cd_material)  ELSE obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced) END ,1,100), 
	((coalesce(a.vl_repasse_item, 0) * coalesce(qt_perc_item_gerado_p, 0)) / 100),	 
	c.cd_convenio, 
	c.dt_baixa_cr, 
	a.cd_procedimento, 
	a.ie_acao_glosa, 
	a.cd_material, 
	a.ie_origem_proced 
into STRICT	vl_amaior_w, 
	vl_glosa_w, 
	cd_motivo_glosa_w, 
	ds_proc_mat_w, 
	vl_repasse_item_w, 
	cd_convenio_w, 
	dt_baixa_w, 
	cd_procedimento_w, 
	ie_acao_glosa_w, 
	cd_material_w, 
	ie_origem_proced_w 
from	convenio_retorno c, 
	convenio_retorno_item b, 
	convenio_retorno_glosa a 
where	a.nr_sequencia	= nr_seq_ret_glosa_p 
and	a.nr_seq_ret_item	= b.nr_sequencia 
and	b.nr_seq_retorno	= c.nr_sequencia;
 
if (coalesce(ie_gerar_item_pendente_p,'N') = 'N') then 
 
	select	max(nr_seq_terceiro), 
		max(cd_estabelecimento) 
	into STRICT	nr_seq_terceiro_w, 
		cd_estabelecimento_w 
	from	repasse_terceiro 
	where	nr_repasse_terceiro = nr_repasse_terceiro_p;
	 
else 
 
	nr_seq_terceiro_w	:= nr_seq_terceiro_p;
	cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
 
end if;
 
ie_trans_financ_terc_w := obter_param_usuario(89, 154, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_trans_financ_terc_w);
ie_conta_contabil_terc_w := obter_param_usuario(89, 157, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_conta_contabil_terc_w);
 
select	max(nr_seq_trans_item_rep), 
	max(nr_seq_trans_rep_prov), 
	max(cd_conta_cont_rep), 
	max(cd_centro_custo_rep_prov), 
	max(cd_conta_cont_rep_prov) 
into STRICT	nr_seq_trans_fin_w, 
	nr_seq_trans_fin_prov_w, 
	cd_conta_contabil_w, 
	cd_centro_custo_prov_w, 
	cd_conta_contabil_prov_w 
from	parametro_faturamento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
select	CASE WHEN coalesce(ie_trans_financ_terc_w,'N')='S' THEN max(a.NR_SEQ_TRANS_FIN_TIT)  ELSE max(a.nr_seq_trans_item_rep) END  
into STRICT	nr_seq_trans_item_rep_w 
from	terceiro a 
where	a.nr_sequencia	= nr_seq_terceiro_w;
 
if (coalesce(ie_conta_contabil_terc_w,'N') = 'S') then 
	select	max(a.cd_conta_contabil) 
	into STRICT	cd_conta_contabil_ter_w 
	from	terceiro a 
	where	a.nr_sequencia	= nr_seq_terceiro_w;
end if;
 
if (coalesce(cd_centro_custo_prov_w::text, '') = '') then 
	select	max(cd_centro_custo) 
	into STRICT	cd_centro_custo_prov_w 
	from ( 
		SELECT	a.cd_centro_custo 
		from	setor_atendimento a, 
			procedimento_paciente b, 
			convenio_retorno_glosa c 
		where	c.nr_sequencia		= nr_seq_ret_glosa_p 
		and	c.nr_seq_propaci		= b.nr_sequencia 
		and	b.cd_setor_atendimento	= a.cd_setor_atendimento 
		
union
 
		SELECT	a.cd_centro_custo 
		from	setor_atendimento a, 
			procedimento_paciente b, 
			convenio_retorno_glosa c 
		where	c.nr_sequencia		= nr_seq_ret_glosa_p 
		and	c.nr_seq_propaci		= b.nr_sequencia 
		and	b.cd_setor_atendimento	= a.cd_setor_atendimento) alias3;
end if;
 
select	max(nr_seq_trans_item_rep_adic) 
into STRICT	nr_seq_trans_fin_adic_w 
from	parametro_faturamento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (coalesce(ie_acao_glosa_w::text, '') = '') then 
 
	select	max(ie_acao_glosa) 
	into STRICT	ie_acao_glosa_w 
	from	motivo_glosa 
	where	cd_motivo_glosa	= cd_motivo_glosa_w;
 
end if;
 
if (coalesce(ie_gerar_item_pendente_p,'N') = 'N') then 
 
	select	coalesce(max(nr_sequencia_item),0) + 1 
	into STRICT	nr_sequencia_item_w 
	from	repasse_terceiro_item 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
	 
	dt_liberacao_w		:= null;
	 
else 
	nr_sequencia_item_w 	:= null;
	dt_liberacao_w		:= clock_timestamp();
end if;	
	 
select	SUBSTR(OBTER_NOME_PF(e.CD_PESSOA_FISICA), 0, 255) nm_pessoa_fisica, 
	b.cd_autorizacao, 
	b.nr_titulo, 
	d.nr_atendimento, 
	b.nr_seq_retorno 
into STRICT	nm_pessoa_fisica_w, 
	cd_autorizacao_w, 
	nr_titulo_w, 
	nr_atendimento_w, 
	nr_seq_retorno_w 
from	pessoa_fisica e, 
	atendimento_paciente d, 
	conta_paciente c, 
	convenio_retorno_item b, 
	convenio_retorno_glosa a 
where	a.nr_sequencia		= nr_seq_ret_glosa_p 
and	a.nr_seq_ret_item	= b.nr_sequencia 
and	b.nr_interno_conta	= c.nr_interno_conta 
and	c.nr_atendimento	= d.nr_atendimento 
and	d.cd_pessoa_fisica	= e.cd_pessoa_fisica;
 
ds_observacao_w		:= 	wheb_mensagem_pck.get_texto(297369) ||' ' || nm_pessoa_fisica_w || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(307563) ||' ' || cd_autorizacao_w || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(216915) ||' ' || nr_titulo_w || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(326147) ||' '|| nr_atendimento_w || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(307565) ||' '||nr_seq_retorno_w;
 
if (coalesce(vl_repasse_item_w, 0) <> 0) then 
 
	select	nextval('repasse_terceiro_item_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into repasse_terceiro_item(nr_sequencia, 
		nr_seq_ret_glosa, 
		nr_repasse_terceiro, 
		dt_atualizacao, 
		nm_usuario, 
		nr_sequencia_item, 
		vl_repasse, 
		nr_seq_trans_fin, 
		nr_seq_terceiro, 
		dt_lancamento, 
		ds_observacao, 
		cd_centro_custo, 
		cd_centro_custo_prov, 
		nr_seq_trans_fin_prov, 
		cd_conta_contabil, 
		cd_conta_contabil_prov, 
		cd_convenio, 
		dt_contabil, 
		cd_medico, 
		cd_procedimento, 
		nr_atendimento, 
		dt_liberacao, 
		cd_material, 
		ie_origem_proced) 
	values (nr_sequencia_w, 
		nr_seq_ret_glosa_p, 
		nr_repasse_terceiro_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_sequencia_item_w, 
		vl_repasse_item_w, 
		CASE WHEN coalesce(ie_trans_financ_terc_w,'N')='S' THEN nr_seq_trans_item_rep_w  ELSE nr_seq_trans_fin_adic_w END , 
		nr_seq_terceiro_w, 
		clock_timestamp(), 
		substr(ds_observacao_ww || ' ' || chr(13) || 		 
			ds_texto_proc_mat_w || ' ' || ds_proc_mat_w || chr(13) || 
			ds_observacao_w,1,3980), 
		cd_centro_custo_w, 
		cd_centro_custo_prov_w, 
		nr_seq_trans_fin_prov_w, 
		CASE WHEN coalesce(ie_conta_contabil_terc_w,'N')='S' THEN cd_conta_contabil_ter_w  ELSE cd_conta_contabil_w END , 
		cd_conta_contabil_prov_w, 
		cd_convenio_w, 
		dt_baixa_w, 
		cd_medico_w, 
		cd_procedimento_w, 
		nr_atendimento_w, 
		dt_liberacao_w, 
		cd_material_w, 
		ie_origem_proced_w);
 
elsif (vl_amaior_w > 0) then 
 
	select	nextval('repasse_terceiro_item_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into repasse_terceiro_item(nr_sequencia, 
		nr_seq_ret_glosa, 
		nr_repasse_terceiro, 
		dt_atualizacao, 
		nm_usuario, 
		nr_sequencia_item, 
		vl_repasse, 
		nr_seq_trans_fin, 
		nr_seq_terceiro, 
		dt_lancamento, 
		ds_observacao, 
		cd_centro_custo, 
		cd_centro_custo_prov, 
		nr_seq_trans_fin_prov, 
		cd_conta_contabil, 
		cd_conta_contabil_prov, 
		cd_convenio, 
		dt_contabil, 
		cd_medico, 
		cd_procedimento, 
		nr_atendimento, 
		dt_liberacao, 
		cd_material, 
		ie_origem_proced) 
	values (nr_sequencia_w, 
		nr_seq_ret_glosa_p, 
		nr_repasse_terceiro_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_sequencia_item_w, 
		vl_amaior_w, 
		CASE WHEN coalesce(ie_trans_financ_terc_w,'N')='S' THEN nr_seq_trans_item_rep_w  ELSE nr_seq_trans_fin_adic_w END , 
		nr_seq_terceiro_w, 
		clock_timestamp(), 
		substr(ds_observacao_ww || ' ' || chr(13) || 		 
			ds_texto_proc_mat_w || ' ' || ds_proc_mat_w || chr(13) || 
			ds_observacao_w,1,3980), 
		cd_centro_custo_w, 
		cd_centro_custo_prov_w, 
		nr_seq_trans_fin_prov_w, 
		CASE WHEN coalesce(ie_conta_contabil_terc_w,'N')='S' THEN cd_conta_contabil_ter_w  ELSE cd_conta_contabil_w END , 
		cd_conta_contabil_prov_w, 
		cd_convenio_w, 
		dt_baixa_w, 
		cd_medico_w, 
		cd_procedimento_w, 
		nr_atendimento_w, 
		dt_liberacao_w, 
		cd_material_w, 
		ie_origem_proced_w);
 
elsif (vl_glosa_w > 0) then 
 
	if (ie_acao_glosa_w = 'R') then 
		select	nextval('repasse_terceiro_item_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert into repasse_terceiro_item(nr_sequencia, 
			nr_seq_ret_glosa, 
			nr_repasse_terceiro, 
			dt_atualizacao, 
			nm_usuario, 
			nr_sequencia_item, 
			vl_repasse, 
			nr_seq_trans_fin, 
			nr_seq_terceiro, 
			dt_lancamento, 
			ds_observacao, 
			cd_centro_custo, 
			cd_centro_custo_prov, 
			nr_seq_trans_fin_prov, 
			cd_conta_contabil, 
			cd_conta_contabil_prov, 
			cd_convenio, 
			dt_contabil, 
			cd_medico, 
			cd_procedimento, 
			nr_atendimento, 
			dt_liberacao, 
			cd_material, 
			ie_origem_proced) 
		values (nr_sequencia_w, 
			nr_seq_ret_glosa_p, 
			nr_repasse_terceiro_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_sequencia_item_w, 
			vl_glosa_w, 
			coalesce(nr_seq_trans_item_rep_w,nr_seq_trans_fin_w), 
			nr_seq_terceiro_w, 
			clock_timestamp(), 
			substr(ds_observacao_ww || ' ' || chr(13) || 		 
			ds_texto_proc_mat_w || ' ' || ds_proc_mat_w || chr(13) || 
			ds_observacao_w,1,3980), 
			cd_centro_custo_w, 
			cd_centro_custo_prov_w, 
			nr_seq_trans_fin_prov_w, 
			CASE WHEN coalesce(ie_conta_contabil_terc_w,'N')='S' THEN cd_conta_contabil_ter_w  ELSE cd_conta_contabil_w END , 
			cd_conta_contabil_prov_w, 
			cd_convenio_w, 
			dt_baixa_w, 
			cd_medico_w, 
			cd_procedimento_w, 
			nr_atendimento_w, 
			dt_liberacao_w, 
			cd_material_w, 
			ie_origem_proced_w);
	else 
		select	nextval('repasse_terceiro_item_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		vl_glosa_w	:= vl_glosa_w * -1;
 
		insert into repasse_terceiro_item(nr_sequencia, 
			nr_seq_ret_glosa, 
			nr_repasse_terceiro, 
			dt_atualizacao, 
			nm_usuario, 
			nr_sequencia_item, 
			vl_repasse, 
			nr_seq_trans_fin, 
			nr_seq_terceiro, 
			dt_lancamento, 
			ds_observacao, 
			cd_centro_custo, 
			cd_centro_custo_prov, 
			nr_seq_trans_fin_prov, 
			cd_conta_contabil, 
			cd_conta_contabil_prov, 
			cd_convenio, 
			dt_contabil, 
			cd_medico, 
			cd_procedimento, 
			nr_atendimento, 
			dt_liberacao, 
			cd_material, 
			ie_origem_proced) 
		values (nr_sequencia_w, 
			nr_seq_ret_glosa_p, 
			nr_repasse_terceiro_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_sequencia_item_w, 
			vl_glosa_w, 
			coalesce(nr_seq_trans_item_rep_w,nr_seq_trans_fin_w), 
			nr_seq_terceiro_w, 
			clock_timestamp(), 
			substr(ds_observacao_ww || ' ' || chr(13) || 		 
			ds_texto_proc_mat_w || ' ' || ds_proc_mat_w || chr(13) || 
			ds_observacao_w,1,3980), 
			cd_centro_custo_w, 
			cd_centro_custo_prov_w, 
			nr_seq_trans_fin_prov_w, 
			CASE WHEN coalesce(ie_conta_contabil_terc_w,'N')='S' THEN cd_conta_contabil_ter_w  ELSE cd_conta_contabil_w END , 
			cd_conta_contabil_prov_w, 
			cd_convenio_w, 
			dt_baixa_w, 
			cd_medico_w, 
			cd_procedimento_w, 
			nr_atendimento_w, 
			dt_liberacao_w, 
			cd_material_w, 
			ie_origem_proced_w);
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_repasse_item_glosa ( nr_repasse_terceiro_p bigint, nr_seq_ret_glosa_p bigint, qt_perc_item_gerado_p bigint, nm_usuario_p text, nr_seq_terceiro_p bigint, ie_gerar_item_pendente_p text) FROM PUBLIC;

