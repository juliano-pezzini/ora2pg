-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_inserir_card_setores ( cd_setor_atendimento_p bigint, nr_seq_servico_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

			 
 
nr_seq_opcao_rec_w		bigint;	
nr_seq_opcao_w			bigint;
nr_seq_comp_w			bigint;
nr_seq_receita_w		bigint;
nr_seq_servico_w		bigint;
nr_seq_servico_dia_w		bigint;
nr_seq_cardapio_w		bigint;	
nr_prescr_oral_w		bigint;
nr_atendimento_w		bigint;
cd_setor_atendimento_w		integer;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_receita_subst_w		nut_receita.nr_sequencia%type;
ir_receita_especial_w		varchar(1);

C01 CURSOR FOR 
	SELECT	c.nr_sequencia, 
		d.nr_atendimento, 
		c.nr_seq_servico 
	from	nut_atend_serv_dia c, 
		atendimento_paciente d 
	where	c.nr_seq_servico 	= coalesce( nr_seq_servico_p, c.nr_seq_servico) 
	and	c.cd_setor_atendimento 	= coalesce( cd_setor_atendimento_p, c.cd_setor_atendimento) 
	and	c.dt_servico between pkg_date_utils.start_of(dt_referencia_p, 'DD', 0) and pkg_date_utils.end_of(dt_referencia_p, 'DAY', 0) 
	and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '') 
	and	c.nr_atendimento = d.nr_atendimento 
	and	d.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
	and	not exists (	SELECT 1 
				from  nut_pac_opcao_rec x 
				where x.nr_seq_servico_dia = c.nr_sequencia);

C02 CURSOR FOR 
	SELECT	coalesce(a.nr_seq_opcao,b.nr_seq_opcao) nr_seq_opcao, 
		b.nr_seq_comp, 
		b.nr_seq_receita, 
		b.nr_sequencia 
	from	nut_cardapio_dia a, 
		nut_cardapio b 
	where	a.nr_sequencia 	= b.nr_seq_card_dia 
	and	a.nr_sequencia 	= nr_seq_cardapio_w;


BEGIN 
open C01;
loop 
fetch C01 into	 
	nr_seq_servico_dia_w, 
	nr_atendimento_w, 
	nr_seq_servico_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_cardapio_w	:= nut_obter_cardapio_padrao(nr_atendimento_w, nr_seq_servico_w, nr_seq_servico_dia_w, dt_referencia_p);
	 
	if (nr_seq_servico_dia_w IS NOT NULL AND nr_seq_servico_dia_w::text <> '') and (nr_seq_servico_w IS NOT NULL AND nr_seq_servico_w::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') and (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and (nr_seq_cardapio_w IS NOT NULL AND nr_seq_cardapio_w::text <> '') then 
		 
		open C02;
		loop 
		fetch C02 into			 
			nr_seq_opcao_w, 
			nr_seq_comp_w, 
			nr_seq_receita_w, 
			nr_seq_cardapio_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			ir_receita_especial_w := 'N';
		 
			select	max(a.cd_pessoa_fisica) 
			into STRICT	cd_pessoa_fisica_w 
			from	atendimento_paciente a, 
				nut_atend_serv_dia b 
			where	a.nr_atendimento = b.nr_atendimento 
			and	b.nr_sequencia = nr_seq_servico_dia_w;
			 
			nr_seq_receita_subst_w := nut_obter_receita_subst(cd_pessoa_fisica_w, nr_seq_servico_w, nr_seq_receita_w);
			 
			if (nr_seq_receita_subst_w IS NOT NULL AND nr_seq_receita_subst_w::text <> '') then 
			 
				select	max(nr_seq_composicao) 
				into STRICT	nr_seq_comp_w 
				from	nut_receita a 
				where	a.nr_sequencia = nr_seq_receita_subst_w;
				 
				CALL gravar_log_tasy(1194, 
						obter_texto_dic_objeto(732151, philips_param_pck.get_nr_seq_idioma, 'NR_ATENDIMENTO='||nr_atendimento_w|| 
						';NM_PESSOA_FISICA='||obter_nome_pf(cd_pessoa_fisica_w)||';NR_SEQ_RECEITA_OLD='||nr_seq_receita_w|| 
						';NR_SEQ_RECEITA_NEW='||nr_seq_receita_subst_w), 
						nm_usuario_p);
												 
				nr_seq_opcao_w := null;
				ir_receita_especial_w := 'S';
				nr_seq_receita_w := nr_seq_receita_subst_w;
				nr_seq_cardapio_w := null;
			 
			end if;
			 
			select	nextval('nut_pac_opcao_rec_seq') 
			into STRICT	nr_seq_opcao_rec_w 
			;
			 
			insert	into nut_pac_opcao_rec(nr_sequencia,      
				nr_seq_composicao,    
				nr_seq_receita, 
				nr_seq_opcao_sel, 
				nr_seq_servico_dia, 
				ie_receita_especial, 
				nr_seq_acompanhante, 
				cd_acompanhante, 
				nr_seq_cardapio_dia, 
				ie_tipo_cardapio, 
				dt_atualizacao,     
				nm_usuario,       
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_cardapio, 
				qt_refeicao) 
			values (nr_seq_opcao_rec_w, 
				nr_seq_comp_w, 
				nr_seq_receita_w, 
				nr_seq_opcao_w, 
				nr_seq_servico_dia_w, 
				'N', 
				null, 
				null, 
				null, 
				null, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_cardapio_w, 
				null);
			end;
		end loop;
		close C02;	
	end if;	
end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_inserir_card_setores ( cd_setor_atendimento_p bigint, nr_seq_servico_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

