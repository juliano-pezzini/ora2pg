-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_classif_agenda_serv (nr_seq_agenda_p bigint, cd_classificacao_p text, nm_usuario_p text, nr_seq_nova_agenda_p INOUT bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_agenda_w				agenda_consulta.nr_sequencia%type;
nr_seq_hora_w				bigint  := 0;
cd_agenda_w					bigint;
dt_agenda_w					timestamp;
qt_prescricao_w				integer;
ie_classif_agenda_origem_w	varchar(5);
ie_excluir_hor_ant_w		varchar(1);
cd_convenio_w				agenda_consulta.cd_convenio%type;
cd_categoria_w				agenda_consulta.cd_categoria%type;
cd_plano_w					agenda_consulta.cd_plano%type;
nm_tabela_w			integridade_referencial.nm_tabela%type;
nm_atributo_w			integridade_atributo.nm_atributo%type;
nr_seq_turno_w			agenda_consulta.nr_Seq_turno%type;

C01 CURSOR FOR
	SELECT b.nm_tabela, c.nm_atributo
	FROM tabela_sistema a,
		 integridade_referencial b,
		 INTEGRIDADE_ATRIBUTO C
	WHERE a.nm_tabela = b.nm_tabela_referencia
	AND a.nm_tabela = 'AGENDA_CONSULTA'
	AND b.ie_situacao = 'A'
	AND b.ie_regra_delecao = 'NO ACTION'
	AND b.nm_tabela = c.nm_tabela
	AND b.nm_integridade_referencial = c.nm_integridade_referencial;


BEGIN

ie_excluir_hor_ant_w := obter_param_usuario(866, 181, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_excluir_hor_ant_w);

select	cd_agenda,
		dt_agenda,
	nr_seq_turno
into STRICT	cd_agenda_w,
		dt_agenda_w,
	nr_seq_turno_w
from	agenda_consulta
where	nr_sequencia	= nr_seq_agenda_p;


select	coalesce(max(nr_seq_hora),0) + 1
into STRICT	nr_seq_hora_w
from	agenda_consulta
where	cd_agenda	= cd_agenda_w
and		dt_agenda	= dt_agenda_w;

select	nextval('agenda_consulta_seq')
into STRICT	nr_seq_agenda_w
;

select	max(cd_convenio),
		max(cd_categoria),
		max(cd_plano)
into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_plano_w
from	agenda_consulta
where	nr_sequencia = nr_seq_agenda_p;

insert 	into agenda_consulta(NR_SEQUENCIA			,
	CD_AGENDA				,
	DT_AGENDA				,
	NR_MINUTO_DURACAO		,
	IE_STATUS_AGENDA       	,
	IE_CLASSIF_AGENDA      	,
	DT_ATUALIZACAO         	,
	NM_USUARIO             	,
	CD_CONVENIO            	,
	CD_PLANO		,
	CD_PESSOA_FISICA       	,
	NM_PESSOA_CONTATO      	,
	DS_OBSERVACAO          	,
	IE_STATUS_PACIENTE     	,
	NR_SEQ_CONSULTA        	,
	NM_PACIENTE            	,
	NR_ATENDIMENTO         	,
	DT_CONFIRMACAO         	,
	DS_CONFIRMACAO         	,
	NR_TELEFONE            	,
	QT_IDADE_PAC           	,
	NR_SEQ_PLANO           	,
	NR_SEQ_CLASSIF_MED     	,
	NM_USUARIO_ORIGEM      	,
	IE_NECESSITA_CONTATO	,
	NR_SEQ_SALA          	,
	CD_CATEGORIA          	, 
	CD_TIPO_ACOMODACAO     	,
	CD_USUARIO_CONVENIO    	,
	CD_COMPLEMENTO         	,
	DT_VALIDADE_CARTEIRA	,
	NR_DOC_CONVENIO      	,  
	CD_SENHA              	, 
	NR_SEQ_AGEPACI         	,
	DS_SENHA               	,
	DT_NASCIMENTO_PAC      	,
	CD_TURNO               	,
	DT_AGENDAMENTO         	,
	CD_MEDICO              	,
	NR_SEQ_HORA            	,
	cd_medico_solic			,
	cd_procedimento			,
	ie_origem_proced		,
	nr_seq_proc_interno		,	
	CD_SETOR_ATENDIMENTO	,
	QT_TOTAL_SECAO			,
	NR_SECAO				,
	ie_classif_agenda_origem,
	ie_encaixe				,
	nr_seq_rp_item_ind		,
	nr_seq_rp_mod_item		,
	cd_cid					,
	nr_seq_lista_reab,
	nr_seq_turno)
(SELECT	nr_seq_agenda_w		,
	cd_agenda				,
	DT_AGENDA				,
	NR_MINUTO_DURACAO		,
	IE_STATUS_AGENDA       	,
	cd_classificacao_p     	,
	DT_ATUALIZACAO         	,
	NM_USUARIO             	,
	CD_CONVENIO            	,
	CD_PLANO		,
	CD_PESSOA_FISICA       	,
	NM_PESSOA_CONTATO      	,
	DS_OBSERVACAO          	,
	IE_STATUS_PACIENTE     	,
	NR_SEQ_CONSULTA        	,
	NM_PACIENTE            	,
	NR_ATENDIMENTO         	,
	DT_CONFIRMACAO         	,
	DS_CONFIRMACAO         	,
	NR_TELEFONE            	,
	QT_IDADE_PAC           	,
	NR_SEQ_PLANO           	,
	NR_SEQ_CLASSIF_MED     	,
	NM_USUARIO_ORIGEM      	,
	IE_NECESSITA_CONTATO	,
	NR_SEQ_SALA          	,  
	CD_CATEGORIA          	, 
	CD_TIPO_ACOMODACAO     	,
	CD_USUARIO_CONVENIO    	,
	CD_COMPLEMENTO         	,
	DT_VALIDADE_CARTEIRA	,
	NR_DOC_CONVENIO      	,  
	CD_SENHA              	, 
	NR_SEQ_AGEPACI         	,
	DS_SENHA               	,
	DT_NASCIMENTO_PAC      	,
	CD_TURNO               	,
	DT_AGENDAMENTO         	,
	CD_MEDICO              	,
	nr_seq_hora_w       	,
	cd_medico_solic			,
	cd_procedimento			,
	ie_origem_proced		,
	nr_seq_proc_interno		,
	CD_SETOR_ATENDIMENTO	,
	QT_TOTAL_SECAO			,
	NR_SECAO				,
	ie_classif_agenda_origem,
	ie_encaixe				,
	nr_seq_rp_item_ind		,
	nr_seq_rp_mod_item		,
	cd_cid					,
	nr_seq_lista_reab,
	nr_seq_turno_w
from	agenda_consulta
where	nr_sequencia		= nr_seq_agenda_p);
commit;

/*update	agenda_consulta
set		cd_convenio 	= cd_convenio_w,
		cd_categoria	= cd_categoria_w,
		cd_plano		= cd_plano_w
where	nr_sequencia = nr_seq_agenda_w;
commit;*/
insert into AGENDA_CONSULTA_PROF(nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_ordem,
				ie_tipo_profissional,
				cd_pessoa_fisica,
				hr_inicio,
				hr_fim,
				qt_dias_retorno,
				ie_solicita_retorno,
				dt_cancelamento,
				nr_seq_motivo_cancelamento)
	(SELECT			nextval('agenda_consulta_prof_seq'),
				nr_seq_agenda_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_ordem,
				ie_tipo_profissional,
				cd_pessoa_fisica,
				hr_inicio,
				hr_fim,
				qt_dias_retorno,
				ie_solicita_retorno,
				dt_cancelamento,
				nr_seq_motivo_cancelamento
	from			AGENDA_CONSULTA_PROF
	where	nr_seq_agenda	= nr_seq_agenda_p);


update	same_cpi_solic
set		nr_seq_agenda		= nr_seq_agenda_w
where	nr_seq_agenda		= nr_seq_agenda_p;

/*
update	agenda_consulta
set	ie_status_agenda	= 'C',
	CD_CONVENIO            	= null,
	CD_PESSOA_FISICA       	= null,
	NM_PACIENTE            	= null,
	NR_TELEFONE            	= null,
	ds_observacao	= 'Classificacao alterada - Tasy'
where	nr_sequencia	= nr_seq_agenda_p;
*/


/* Rafael em 07/08/06 Projeto HDH */

nr_seq_nova_agenda_p	:= nr_seq_agenda_w;

select	coalesce(count(*),0)
into STRICT	qt_prescricao_w
from	prescr_medica
where	nr_seq_agecons = nr_seq_agenda_p;

if (qt_prescricao_w > 0) then
	update	prescr_medica
	set		nr_seq_agecons	= nr_seq_agenda_w
	where	nr_seq_agecons	= nr_seq_agenda_p;

	commit;
end if;			
/* Fim Rafael em 07/08/06 Projeto HDH */

if (ie_excluir_hor_ant_w	= 'S') then

	update	med_avaliacao_paciente
	set	nr_seq_agenda_cons = nr_seq_agenda_w
	where	nr_seq_agenda_cons = nr_seq_agenda_p;
		
	update	agenda_consulta_proc
	set	nr_seq_agenda = nr_seq_agenda_w
	where	nr_seq_agenda = nr_seq_agenda_p
	and	not exists (SELECT 1 from agenda_consulta_proc x where x.nr_seq_proc_interno = nr_seq_proc_interno and x.nr_seq_agenda = nr_seq_agenda_w);	
	
	update	pep_pac_ci
	set	nr_seq_age_cons = nr_seq_agenda_w
	where	nr_seq_age_cons = nr_seq_agenda_p;

	open C01;
	loop
	fetch C01 into	
		nm_tabela_w,
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL exec_sql_dinamico('TASY', ' update ' || nm_tabela_w ||
			  ' set ' || nm_atributo_w || ' = ' || nr_seq_agenda_w ||
			  ' where ' || nm_atributo_w || ' = ' || nr_seq_agenda_p);
		end;
	end loop;
	close C01;
	
	commit;
	
	delete	FROM agenda_consulta
	where	nr_sequencia	= nr_seq_agenda_p;
else
	update	agenda_consulta
	set	ie_status_agenda		= 'C',
		dt_status				= clock_timestamp(),
		nm_usuario_status		= nm_usuario_p,
		CD_CONVENIO            	 = NULL,
		CD_PESSOA_FISICA       	 = NULL,
		NM_PACIENTE            	 = NULL,
		NR_TELEFONE            	 = NULL,
		ds_observacao			= wheb_mensagem_pck.get_texto(308263) -- Classificacao alterada - Tasy 
	where	nr_sequencia		= nr_seq_agenda_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_classif_agenda_serv (nr_seq_agenda_p bigint, cd_classificacao_p text, nm_usuario_p text, nr_seq_nova_agenda_p INOUT bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

