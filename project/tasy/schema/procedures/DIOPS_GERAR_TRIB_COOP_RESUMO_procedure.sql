-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_gerar_trib_coop_resumo ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
nr_sequencia_w			diops_fin_trib_coop_resumo.nr_sequencia%type;

c_conta CURSOR FOR 
	SELECT	r.nr_sequencia 
	from	diops_fin_trib_coop_resumo r, 
		diops_periodo p 
	where	p.nr_sequencia = r.nr_seq_periodo 
	and	p.nr_sequencia = nr_sequencia_p;

c_resumo CURSOR FOR 
	SELECT	sum(c.vl_pago_trimestre) vl_total_pago, 
		sum(c.vl_saldo_final) vl_saldo_final, 
		sum(c.vl_saldo_anterior) vl_saldo_anterior, 
		sum(c.vl_atual_monetaria) vl_atual_monetaria 
	from	diops_fin_trib_coop c 
	where	c.nr_seq_diops_coop_res = nr_sequencia_w;
	
vet_resumo 		c_resumo%rowtype;
			

BEGIN 
 
open c_conta;
loop 
fetch c_conta into	 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c_conta */
	begin 
	 
	open c_resumo;
	loop 
	fetch c_resumo into	 
		vet_resumo;
	EXIT WHEN NOT FOUND; /* apply on c_resumo */
		begin 
		 
		update 	diops_fin_trib_coop_resumo 
		set	vl_saldo_anterior	= vet_resumo.vl_saldo_anterior, 
			vl_total_pago		= vet_resumo.vl_total_pago, 
			vl_atual_monetaria	= vet_resumo.vl_atual_monetaria, 
			vl_saldo_final		= vet_resumo.vl_saldo_final 
		where	nr_sequencia = nr_sequencia_w;
		 
		commit;
		 
		end;
	end loop;
	close c_resumo;
	 
	end;
end loop;
close c_conta;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_gerar_trib_coop_resumo ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

