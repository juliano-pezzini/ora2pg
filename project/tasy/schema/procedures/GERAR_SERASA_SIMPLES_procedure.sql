-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_serasa_simples ( nm_usuario_p text, cd_estabelecimento_P bigint) AS $body$
DECLARE

 
ds_conteudo_w			varchar(4000);
nr_titulo_w			bigint;
ie_ordem_w			bigint;

/* Header */
 
cd_registro_w			varchar(1);
cd_cnpj_raiz_w			varchar(9);
dt_movimento_w			varchar(8);
nr_ddd_contato_w		varchar(4);
nr_ramal_contato_w		varchar(4);
nr_telefone_contato_w		varchar(8);
nm_contato_w			varchar(70);
nr_seq_envio_w			integer;

/* Registro tipo 1 */
 
cd_cnpj_contratante_w		varchar(6);
dt_ocorrencia_w			varchar(8);
dt_fim_contrato_w		varchar(8);
cd_natureza_operacao_w		varchar(3);
ie_pessoa_principal_w		varchar(1);
ie_tipo_doc_principal_w		varchar(1);
cd_primeito_doc_principal_w	varchar(15);
ie_segundo_doc_principal_w	varchar(1);
cd_segundo_doc_principal_w	varchar(15);
uf_rg_w				varchar(2);
ie_pessoa_coobrigado_w		varchar(1);
ie_primeiro_doc_coobrigado_w	varchar(1);
cd_doc_coobrigado_w		varchar(15);
ie_segundo_doc_coobrigado_w	varchar(1);
cd_segundo_doc_coobrigado_w	varchar(15);
uf_rg_coobrigado_w		varchar(2);
nm_devedor_w			varchar(70);
dt_nascimento_pf_w		varchar(8);
nm_pai_w			varchar(70);
nm_mae_w			varchar(70);
ds_endereco_w			varchar(45);
ds_bairro_w			varchar(20);
ds_municipio_w			varchar(25);
ds_uf_w				varchar(2);
ds_cep_w			varchar(8);
vl_titulo_w			varchar(15);
nr_titulo_reg_w			varchar(16);
nr_nosso_numero_w		varchar(9);
ds_complemento_w		varchar(25);
ds_ddt_devedor_w		varchar(4);
nr_telefone_devedor_w		varchar(9);
dt_compromisso_w		varchar(8);
vl_compromisso_w		varchar(15);
nr_seq_reg_w			integer;
ds_seq_reg_w			varchar(10);
ds_endereco_reg_w		varchar(45);
nr_bloqueto_w			varchar(50);
ie_bloqueto_w			varchar(1);

c01 CURSOR FOR 
SELECT	a.nr_titulo, 
	lpad(coalesce(substr(obter_cgc_estabelecimento(t.cd_estabelecimento),7,6),'0'),6,'0'), 
	lpad(coalesce(to_char(t.DT_VENCIMENTO,'yyyymmdd'),'0'),8,'0'), 
	lpad(coalesce(to_char(CASE WHEN coalesce(t.DT_PAGAMENTO_PREVISTO::text, '') = '' THEN t.DT_VENCIMENTO  ELSE t.DT_PAGAMENTO_PREVISTO END ,'yyyymmdd'),'0'),8,'0'), 
	lpad(coalesce(to_char(n.cd_natureza_operacao),' '),3,' '), 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN 'F'  ELSE 'J' END , 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN '2'  ELSE '1' END , 
	lpad(coalesce(coalesce(t.cd_cgc,obter_cpf_pessoa_fisica(t.cd_pessoa_fisica)),'0'),15,'0'), 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN '3'  ELSE ' ' END , 
	lpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_dados_pf(t.cd_pessoa_fisica,'RG')  ELSE ' ' END ,' '),15,' '), 
	lpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_dados_pf(t.cd_pessoa_fisica,'UFRG')  ELSE ' ' END ,' '),2,' '), 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN 'F'  ELSE 'J' END , 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN '2'  ELSE '1' END , 
	lpad(coalesce(t.cd_cgc,obter_cpf_pessoa_fisica(t.cd_pessoa_fisica)),15,'0'), 
	CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN '3'  ELSE ' ' END , 
	lpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_dados_pf(t.cd_pessoa_fisica,'RG')  ELSE ' ' END ,' '),15,' '), 
	lpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_dados_pf(t.cd_pessoa_fisica,'UFRG')  ELSE ' ' END ,' '),2,' '), 
	rpad(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_nome_pf(t.cd_pessoa_fisica)  ELSE obter_dados_pf_pj(null,t.cd_cgc,'N') END ,70,' '), 
	lpad(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN to_char(to_date(obter_dados_pf(t.cd_pessoa_fisica,'DN')),'yyyymmdd')  ELSE ' ' END ,8,' '), 
	rpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_compl_pf(t.cd_pessoa_fisica,4,'N')  ELSE ' ' END ,' '),70,' '), 
	rpad(coalesce(CASE WHEN coalesce(t.cd_cgc,'X')='X' THEN obter_compl_pf(t.cd_pessoa_fisica,5,'N')  ELSE ' ' END ,' '),70,' '), 
	rpad(coalesce(substr(CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'LO'),'X')='X' THEN ''  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'LO')||':' END || 
	CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'R'),'X')='X' THEN ''  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'R') END || 
	CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'NR'),'X')='X' THEN ''  ELSE ', '||obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'NR') END || 
	CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CO'),'X')='X' THEN ''  ELSE ', '||obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CO') END ,1,45),' '),45,' '), 
	rpad(CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'B'),'X')='X' THEN ' '  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'B') END ,20,' '), 
	rpad(CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CI'),'X')='X' THEN ' '  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CI') END ,25,' '), 
	rpad(CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'UF'),'X')='X' THEN ' '  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'UF') END ,2,' '), 
	rpad(CASE WHEN coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CEP'),'X')='X' THEN ' '  ELSE obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'CEP') END ,8,' '),	 
	lpad(somente_numero(to_char(coalesce(t.vl_titulo,0),'9999999999990.00')),15,'0'),		 
	lpad(coalesce(to_char(t.nr_titulo),' '),16,' '), 
	lpad(coalesce(substr(t.nr_nosso_numero,1,9),'0'),9,'0'), 
	lpad(substr(coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'DDT'),'0'),1,4),4,'0'), 
	lpad(coalesce(obter_dados_pf_pj(t.cd_pessoa_fisica,t.cd_cgc,'T'),'0'),9,'0'), 
	lpad(coalesce(to_char(t.dt_vencimento,'yyyymmdd'),'0'),8,'0'), 
	lpad(somente_numero(to_char(coalesce(t.vl_titulo,0),'9999999999990.00')),15,'0'), 
	t.nr_bloqueto 
FROM w_titulo_serasa a, titulo_receber t
LEFT OUTER JOIN nota_fiscal n ON (t.nr_seq_nf_saida = n.nr_sequencia)
WHERE a.nr_titulo		= t.nr_titulo and a.nm_usuario		= nm_usuario_p;


BEGIN 
 
select	nextval('w_titulo_serasa_envio_seq') 
into STRICT	nr_seq_envio_w
;
 
delete	from w_titulo_serasa 
where	coalesce(nr_titulo::text, '') = '' 
and	nm_usuario	= nm_usuario_p;
 
nr_seq_reg_w := 0;
/* Header */
 
select	'0',--OK 
	lpad(coalesce(p.cd_cnpj_raiz,'0'),9,'0'), 
	substr(to_char(clock_timestamp(),'yyyymmdd'),1,8), 
	lpad(coalesce(p.nr_ddd_telefone,'0'),4,'0'), 
	lpad(coalesce(p.nr_telefone,'0'),8,'0'), 
	lpad(coalesce(p.nr_ramal_contato,'0'),4,'0'), 
	rpad(coalesce(substr(p.nm_pessoa_contato,1,70),' '),70,' ') 
into STRICT	cd_registro_w, 
	cd_cnpj_raiz_w, 
	dt_movimento_w, 
	nr_ddd_contato_w, 
	nr_telefone_contato_w, 
	nr_ramal_contato_w, 
	nm_contato_w 
from	estabelecimento e, 
	pessoa_juridica p 
where	p.cd_cgc = e.cd_cgc 
and	e.cd_estabelecimento = cd_estabelecimento_P;
 
/* Header */
 
/*OS 792173 Incrementar no header tb.*/
 
nr_seq_reg_w := nr_seq_reg_w + 1;
ds_seq_reg_w := lpad(coalesce(nr_seq_reg_w,0),7,'0');
 
ds_conteudo_w	:=	cd_registro_w || 
			cd_cnpj_raiz_w || 
			dt_movimento_w || 
			nr_ddd_contato_w || 
			nr_telefone_contato_w || 
			nr_ramal_contato_w || 
			nm_contato_w || 
			rpad(substr('SERASA-CONVEM04',1,15),15,' ') || 
			lpad(nr_seq_envio_w,6,'0') || 
			'E' || 
			rpad(' ',4,' ') || 
			rpad(' ',3,' ') || 
			rpad(' ',8,' ') || 
			rpad(' ',392,' ') || 
			rpad(' ',60,' ') || 
			lpad(ds_seq_reg_w,7,'0');
 
ie_ordem_w	:= 1;
 
insert	into w_titulo_serasa(dt_atualizacao, 
	nm_usuario, 
	nr_sequencia, 
	ds_conteudo, 
	ie_ordem, 
	nr_seq_envio) 
values (clock_timestamp(), 
	nm_usuario_p, 
	nextval('w_titulo_serasa_seq'), 
	ds_conteudo_w, 
	ie_ordem_w, 
	nr_seq_envio_w);	
	 
open	c01;
loop 
fetch	c01 into 
	nr_titulo_w, 
	cd_cnpj_contratante_w, 
	dt_ocorrencia_w, 
	dt_fim_contrato_w, 
	cd_natureza_operacao_w, 
	ie_pessoa_principal_w, 
	ie_tipo_doc_principal_w, 
	cd_primeito_doc_principal_w, 
	ie_segundo_doc_principal_w, 
	cd_segundo_doc_principal_w, 
	uf_rg_w, 
	ie_pessoa_coobrigado_w, 
	ie_primeiro_doc_coobrigado_w, 
	cd_doc_coobrigado_w, 
	ie_segundo_doc_coobrigado_w, 
	cd_segundo_doc_coobrigado_w, 
	uf_rg_coobrigado_w, 
	nm_devedor_w, 
	dt_nascimento_pf_w, 
	nm_pai_w, 
	nm_mae_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	ds_municipio_w, 
	ds_uf_w, 
	ds_cep_w, 
	vl_titulo_w, 
	nr_titulo_reg_w, 
	nr_nosso_numero_w, 
	ds_ddt_devedor_w, 
	nr_telefone_devedor_w, 
	dt_compromisso_w, 
	vl_compromisso_w, 
	nr_bloqueto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	/* Registro tipo 1 */
 
	 
	if (coalesce(nr_bloqueto_w::text, '') = '') then 
		ie_bloqueto_w := ' ';
	else 
		ie_bloqueto_w := 'B';
	end if;
 
	nr_seq_reg_w := nr_seq_reg_w + 1;
	ds_seq_reg_w := lpad(coalesce(nr_seq_reg_w,0),7,'0');
	ds_endereco_reg_w := lpad(coalesce(substr(ds_endereco_w,1,45),' '),45,' ');
	ds_complemento_w := lpad(coalesce(substr(ds_endereco_w,46,25),' '),25,' ');
 
	/* Registro tipo 1 */
 
	ds_conteudo_w	:=	'1' || 
				'I' || 
				cd_cnpj_contratante_w || 
				dt_ocorrencia_w || 
				dt_fim_contrato_w || 
				cd_natureza_operacao_w || 
				rpad(' ',4,' ') || 
				ie_pessoa_principal_w || 
				ie_tipo_doc_principal_w || 
				cd_primeito_doc_principal_w || 
				rpad(' ',2,' ') || 
				ie_segundo_doc_principal_w || 
				cd_segundo_doc_principal_w || 
				uf_rg_w || 
				ie_pessoa_coobrigado_w || 
				ie_primeiro_doc_coobrigado_w || 
				cd_doc_coobrigado_w || 
				rpad(' ',2,' ') || 
				ie_segundo_doc_coobrigado_w || 
				cd_segundo_doc_coobrigado_w || 
				uf_rg_coobrigado_w || 
				nm_devedor_w || 
				dt_nascimento_pf_w || 
				nm_pai_w || 
				nm_mae_w || 
				ds_endereco_reg_w || 
				ds_bairro_w || 
				ds_municipio_w || 
				ds_uf_w || 
				ds_cep_w || 
				vl_titulo_w || 
				nr_titulo_reg_w || 
				nr_nosso_numero_w || 
				ds_complemento_w || 
				ds_ddt_devedor_w || 
				nr_telefone_devedor_w || 
				dt_compromisso_w || 
				vl_compromisso_w || 
				rpad(' ',6,' ') || 
				ie_bloqueto_w || 
				rpad(' ',2,' ') || 
				rpad(' ',60,' ') || 
				ds_seq_reg_w;
					 
	ie_ordem_w	:= coalesce(ie_ordem_w,0) + 1;
 
	insert	into w_titulo_serasa(dt_atualizacao, 
		nm_usuario, 
		nr_sequencia, 
		ds_conteudo, 
		ie_ordem, 
		nr_seq_envio) 
	values (clock_timestamp(), 
		nm_usuario_p, 
		nextval('w_titulo_serasa_seq'), 
		ds_conteudo_w, 
		ie_ordem_w, 
		nr_seq_envio_w);
 
	update	titulo_receber 
	set	dt_envio_serasa	= clock_timestamp() 
	where	nr_titulo	= nr_titulo_w;
 
	end;
end loop;
close C01;
 
/* Trailer */
 
/*OS 792173 Incrementar no trailler tb.*/
 
nr_seq_reg_w := nr_seq_reg_w + 1;
ds_seq_reg_w := lpad(coalesce(nr_seq_reg_w,0),7,'0');
 
ds_conteudo_w	:=	'9' || 
			rpad(' ',592,' ') || 
			lpad(ds_seq_reg_w,7,'0');
 
ie_ordem_w	:= coalesce(ie_ordem_w,0) + 1;
 
insert	into w_titulo_serasa(dt_atualizacao, 
	nm_usuario, 
	nr_sequencia, 
	ds_conteudo, 
	ie_ordem, 
	nr_seq_envio) 
values (clock_timestamp(), 
	nm_usuario_p, 
	nextval('w_titulo_serasa_seq'), 
	ds_conteudo_w, 
	ie_ordem_w, 
	nr_seq_envio_w);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_serasa_simples ( nm_usuario_p text, cd_estabelecimento_P bigint) FROM PUBLIC;

