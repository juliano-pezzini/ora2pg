-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_mensal_registro_bpjdec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text, nr_posicao_p INOUT bigint, cd_darf_p text ) AS $body$
DECLARE


cd_darf_w		varchar(10);
cd_cgc_w		varchar(14);
ds_arquivo_w		varchar(2000);
nm_pessoa_juridica_w	varchar(255);
nr_seq_apres_w		bigint;
vl_rendimento_jan_w	varchar(20);
vl_rendimento_fev_w	varchar(20);
vl_rendimento_mar_w	varchar(20);
vl_rendimento_abr_w	varchar(20);
vl_rendimento_mai_w	varchar(20);
vl_rendimento_jun_w	varchar(20);
vl_rendimento_jul_w	varchar(20);
vl_rendimento_ago_w	varchar(20);
vl_rendimento_set_w	varchar(20);
vl_rendimento_out_w	varchar(20);
vl_rendimento_nov_w	varchar(20);
vl_rendimento_dez_w	varchar(20);
vl_rendimento_13_w	varchar(20);
vl_imposto_jan_w		varchar(20);
vl_imposto_fev_w		varchar(20);
vl_imposto_mar_w		varchar(20);
vl_imposto_abr_w		varchar(20);
vl_imposto_mai_w		varchar(20);
vl_imposto_jun_w		varchar(20);
vl_imposto_jul_w		varchar(20);
vl_imposto_ago_w		varchar(20);
vl_imposto_set_w		varchar(20);
vl_imposto_out_w		varchar(20);
vl_imposto_nov_w		varchar(20);
vl_imposto_dez_w		varchar(20);
vl_imposto_13_w		varchar(20);
separador_w		varchar(1) := '|';
cd_estabelecimento_w 	smallint;


c01 CURSOR FOR
SELECT	substr(coalesce(t.cd_cgc, p.cd_cgc),1,14) cgc_cgc,
	substr(obter_nome_pf_pj(null, coalesce(t.cd_cgc, p.cd_cgc)),1,255) nm_pessoa_juridica,
	replace(substr(campo_mascara(0,2),1,20),'.','') vl_rendimento_13,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='01' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_jan,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='02' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_fev,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='03' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_mar,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='04' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_abr,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='05' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_mai,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='06' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_jun,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='07' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_jul,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='08' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_ago,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='09' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_set,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='10' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_out,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='11' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_nov,
	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(t.dt_base_titulo, d.dt_mes_referencia), 'mm'),'00')='12' THEN  t.vl_imposto  ELSE 0 END ),2),1,20),'.','') vl_imposto_dez,
	replace(substr(campo_mascara(0,2),1,20),'.','') vl_imposto_13
from	titulo_pagar p,
	dirf_titulo_pagar t,
	dirf_lote_mensal d,
	dirf_agrupar_lote a,
	dirf_lote l
where	t.nr_titulo = p.nr_titulo
and	t.nr_seq_lote_dirf = d.nr_sequencia
and	d.nr_sequencia = a.nr_seq_lote_mensal
and	l.nr_sequencia = a.nr_seq_lote_anual
and	(coalesce(t.cd_cgc, p.cd_cgc) IS NOT NULL AND (coalesce(t.cd_cgc, p.cd_cgc))::text <> '')
and	l.nr_sequencia = nr_seq_lote_dirf_p
and	t.cd_darf = cd_darf_p
group by substr(coalesce(t.cd_cgc, p.cd_cgc),1,14),
	substr(obter_nome_pf_pj(null, coalesce(t.cd_cgc, p.cd_cgc)),1,255)
order by substr(coalesce(t.cd_cgc, p.cd_cgc),1,14);


BEGIN

nr_seq_apres_w	:= nr_posicao_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	dirf_lote
where	nr_sequencia = nr_seq_lote_dirf_p;


open c01;
loop
fetch c01 into
	cd_cgc_w,
	nm_pessoa_juridica_w,
	vl_rendimento_13_w,
	vl_imposto_jan_w,
	vl_imposto_fev_w,
	vl_imposto_mar_w,
	vl_imposto_abr_w,
	vl_imposto_mai_w,
	vl_imposto_jun_w,
	vl_imposto_jul_w,
	vl_imposto_ago_w,
	vl_imposto_set_w,
	vl_imposto_out_w,
	vl_imposto_nov_w,
	vl_imposto_dez_w,
	vl_imposto_13_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='01' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_jan,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='02' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_fev,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='03' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_mar,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='04' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_abr,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='05' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_mai,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='06' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_jun,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='07' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_jul,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='08' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_ago,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='09' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_set,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='10' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_out,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='11' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_nov,
		replace(substr(campo_mascara(sum(CASE WHEN coalesce(to_char(coalesce(x.dt_base_titulo, x.dt_mes_referencia), 'mm'),'00')='12' THEN  x.vl_rendimento  ELSE 0 END ),2),1,20),'.','') vl_rendimento_dez
	into STRICT	vl_rendimento_jan_w,
		vl_rendimento_fev_w,
		vl_rendimento_mar_w,
		vl_rendimento_abr_w,
		vl_rendimento_mai_w,
		vl_rendimento_jun_w,
		vl_rendimento_jul_w,
		vl_rendimento_ago_w,
		vl_rendimento_set_w,
		vl_rendimento_out_w,
		vl_rendimento_nov_w,
		vl_rendimento_dez_w
	from(
		SELECT	p.nr_titulo,
			t.dt_base_titulo,
			d.dt_mes_referencia,
			t.vl_rendimento
		from	titulo_pagar p,
			dirf_titulo_pagar t,
			dirf_lote_mensal d,
			dirf_agrupar_lote a,
			dirf_lote l
		where	t.nr_titulo = p.nr_titulo
		and	t.nr_seq_lote_dirf = d.nr_sequencia
		and	d.nr_sequencia = a.nr_seq_lote_mensal
		and	l.nr_sequencia = a.nr_seq_lote_anual
		and	(coalesce(t.cd_cgc, p.cd_cgc) IS NOT NULL AND (coalesce(t.cd_cgc, p.cd_cgc))::text <> '')
		and	(((p.cd_cgc = cd_cgc_w) and (coalesce(t.cd_cgc::text, '') = '' and coalesce(t.cd_pessoa_fisica::text, '') = ''))
		or	 (t.cd_cgc = cd_cgc_w AND t.cd_cgc IS NOT NULL AND t.cd_cgc::text <> ''))
		and	l.nr_sequencia = nr_seq_lote_dirf_p
		and	t.cd_darf = cd_darf_p
		group by
			p.nr_titulo,
			t.dt_base_titulo,
			d.dt_mes_referencia,
			t.vl_rendimento
	) x;
	
	if	((abs(vl_rendimento_jan_w) +
		abs(vl_rendimento_fev_w) +
		abs(vl_rendimento_mar_w) +
		abs(vl_rendimento_abr_w) +
		abs(vl_rendimento_mai_w) +
		abs(vl_rendimento_jun_w) +
		abs(vl_rendimento_jul_w) +
		abs(vl_rendimento_ago_w) +
		abs(vl_rendimento_set_w) +
		abs(vl_rendimento_out_w) +
		abs(vl_rendimento_nov_w) +
		abs(vl_rendimento_dez_w) +
		abs(vl_rendimento_13_w)) <> 0) and
		((abs(vl_imposto_jan_w) +
		abs(vl_imposto_fev_w) +
		abs(vl_imposto_mar_w) +
		abs(vl_imposto_abr_w) +
		abs(vl_imposto_mai_w) +
		abs(vl_imposto_jun_w) +
		abs(vl_imposto_jul_w) +
		abs(vl_imposto_ago_w) +
		abs(vl_imposto_set_w) +
		abs(vl_imposto_out_w) +
		abs(vl_imposto_nov_w) +
		abs(vl_imposto_dez_w) +
		abs(vl_imposto_13_w)) <> 0) then
		begin
						
		if 	((cd_darf_p = '1708') or (cd_darf_p = '5952') or (cd_darf_p = '5960') or (cd_darf_p = '5979') or (cd_darf_p = '5987') or (cd_darf_p = '8045') or (cd_darf_p = '3280')) then
				vl_rendimento_13_w := '';
				vl_imposto_13_w := '';
		end if;

		-- inserir o CNPJ e o nome da pessoa jur?ca
		nm_pessoa_juridica_w := fis_remove_special_characters(nm_pessoa_juridica_w);
		ds_arquivo_w 	:= 'BPJDEC' || separador_w || lpad(cd_cgc_w,14,'0') || separador_w || nm_pessoa_juridica_w || separador_w;

		nr_seq_apres_w 	:= nr_seq_apres_w + 1;

		insert 	into w_dirf_arquivo(nr_sequencia,
					     nm_usuario,
					     nm_usuario_nrec,
					     dt_atualizacao,
					     dt_atualizacao_nrec,
					     ds_arquivo,
					     nr_seq_apresentacao,
					     nr_seq_registro,
					     cd_darf)
		values (nextval('w_dirf_arquivo_seq'),
					     nm_usuario_p,
					     nm_usuario_p,
					     clock_timestamp(),
					     clock_timestamp(),
					     ds_arquivo_w,
					     to_char(nr_seq_apres_w),
					     0,
					     cd_darf_w);
		commit;
		nr_seq_apres_w := nr_seq_apres_w + 1;

		-- inserir o valor de rendimento da pessoa jur?ca
		ds_arquivo_w := 'RTRT' 	|| separador_w || vl_rendimento_jan_w 	|| separador_w || vl_rendimento_fev_w || separador_w || vl_rendimento_mar_w
					|| separador_w || vl_rendimento_abr_w	|| separador_w || vl_rendimento_mai_w || separador_w || vl_rendimento_jun_w
					|| separador_w || vl_rendimento_jul_w 	|| separador_w || vl_rendimento_ago_w || separador_w || vl_rendimento_set_w
					|| separador_w || vl_rendimento_out_w 	|| separador_w || vl_rendimento_nov_w || separador_w || vl_rendimento_dez_w
					|| separador_w || vl_rendimento_13_w  	|| separador_w;

		nr_seq_apres_w := nr_seq_apres_w + 1;

		insert 	into w_dirf_arquivo(nr_sequencia,
						nm_usuario,
						nm_usuario_nrec,
						dt_atualizacao,
						dt_atualizacao_nrec,
						ds_arquivo,
						nr_seq_apresentacao,
						nr_seq_registro,
						cd_darf)
				values (nextval('w_dirf_arquivo_seq'),
						nm_usuario_p,
						nm_usuario_p,
						clock_timestamp(),
						clock_timestamp(),
						ds_arquivo_w,
						to_char(nr_seq_apres_w),
						0,
						cd_darf_w);
		commit;
		nr_seq_apres_w := nr_seq_apres_w + 1;

		-- inserir o valor de imposto da pessoa  jur?ca
		ds_arquivo_w := 'RTIRF' || separador_w || vl_imposto_jan_w || separador_w || vl_imposto_fev_w || separador_w || vl_imposto_mar_w
					|| separador_w || vl_imposto_abr_w || separador_w || vl_imposto_mai_w || separador_w || vl_imposto_jun_w
					|| separador_w || vl_imposto_jul_w   || separador_w || vl_imposto_ago_w || separador_w || vl_imposto_set_w
					|| separador_w || vl_imposto_out_w || separador_w || vl_imposto_nov_w || separador_w || vl_imposto_dez_w
					|| separador_w || vl_imposto_13_w  || separador_w;
		

			nr_seq_apres_w := nr_seq_apres_w + 1;

			insert 	into w_dirf_arquivo(nr_sequencia,
						     nm_usuario,
						     nm_usuario_nrec,
						     dt_atualizacao,
						     dt_atualizacao_nrec,
						     ds_arquivo,
						     nr_seq_apresentacao,
						     nr_seq_registro,
						     cd_darf)
					values (nextval('w_dirf_arquivo_seq'),
						     nm_usuario_p,
						     nm_usuario_p,
						     clock_timestamp(),
						     clock_timestamp(),
						     ds_arquivo_w,
						     to_char(nr_seq_apres_w),
						     0,
						     cd_darf_w);
			commit;

			nr_seq_apres_w := nr_seq_apres_w + 1;
			
		end; -- fim
	end if; -- fim
	
	end;
end loop;
close c01;

commit;

nr_posicao_p	:= nr_seq_apres_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_mensal_registro_bpjdec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text, nr_posicao_p INOUT bigint, cd_darf_p text ) FROM PUBLIC;

