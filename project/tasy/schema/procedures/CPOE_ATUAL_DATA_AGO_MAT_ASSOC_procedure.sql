-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atual_data_ago_mat_assoc ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_procedimento.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_mat_proc1_w				cpoe_procedimento.cd_mat_proc1%type;
cd_mat_proc2_w				cpoe_procedimento.cd_mat_proc2%type;
cd_mat_proc3_w				cpoe_procedimento.cd_mat_proc3%type;
cd_mat_proc4_w				cpoe_procedimento.cd_mat_proc4%type;
cd_mat_proc5_w				cpoe_procedimento.cd_mat_proc5%type;
cd_interv_proc1_w			cpoe_procedimento.cd_interv_proc1%type;
cd_interv_proc2_w			cpoe_procedimento.cd_interv_proc2%type;
cd_interv_proc3_w			cpoe_procedimento.cd_interv_proc3%type;
cd_interv_proc4_w			cpoe_procedimento.cd_interv_proc4%type;
cd_interv_proc5_w			cpoe_procedimento.cd_interv_proc5%type;
hr_prim_hor_proc1_w			cpoe_procedimento.hr_prim_hor_proc1%type;
hr_prim_hor_proc2_w			cpoe_procedimento.hr_prim_hor_proc2%type;
hr_prim_hor_proc3_w			cpoe_procedimento.hr_prim_hor_proc3%type;
hr_prim_hor_proc4_w			cpoe_procedimento.hr_prim_hor_proc4%type;
hr_prim_hor_proc5_w			cpoe_procedimento.hr_prim_hor_proc5%type;
dt_inicio_proc1_w			cpoe_procedimento.dt_inicio_proc1%type;
dt_inicio_proc2_w			cpoe_procedimento.dt_inicio_proc2%type;
dt_inicio_proc3_w			cpoe_procedimento.dt_inicio_proc3%type;
dt_inicio_proc4_w			cpoe_procedimento.dt_inicio_proc4%type;
dt_inicio_proc5_w			cpoe_procedimento.dt_inicio_proc5%type;
dt_fim_proc1_w				cpoe_procedimento.dt_fim_proc1%type;
dt_fim_proc2_w				cpoe_procedimento.dt_fim_proc2%type;
dt_fim_proc3_w				cpoe_procedimento.dt_fim_proc3%type;
dt_fim_proc4_w				cpoe_procedimento.dt_fim_proc4%type;
dt_fim_proc5_w				cpoe_procedimento.dt_fim_proc5%type;
ie_urgencia_mat1_w			cpoe_procedimento.ie_urgencia_mat1%type;
ie_urgencia_mat2_w			cpoe_procedimento.ie_urgencia_mat2%type;
ie_urgencia_mat3_w			cpoe_procedimento.ie_urgencia_mat3%type;
ie_urgencia_mat4_w			cpoe_procedimento.ie_urgencia_mat4%type;
ie_urgencia_mat5_w			cpoe_procedimento.ie_urgencia_mat5%type;
dt_prim_horario_w			cpoe_procedimento.dt_inicio%type;
ds_horarios_w				cpoe_procedimento.ds_horarios%type;
ds_horarios_ww				cpoe_procedimento.ds_horarios%type;
nr_ocorrencia_w				prescr_material.nr_ocorrencia%type;
qt_min_intervalo_w			intervalo_prescricao.qt_min_intervalo%type;
dt_referencia_w				timestamp;

	procedure preencher_ds_horarios(cd_interv_proc_p	cpoe_procedimento.cd_interv_proc1%type,
									cd_mat_proc_p		cpoe_procedimento.cd_mat_proc1%type,
									dt_fim_proc_p		cpoe_procedimento.dt_fim_proc1%type,
									ie_urgencia_mat_p	cpoe_procedimento.ie_urgencia_mat1%type) is
	;
BEGIN

		if (ie_urgencia_mat_p IS NOT NULL AND ie_urgencia_mat_p::text <> '') then
			dt_referencia_w := trunc(dt_referencia_p,'mi') + (ie_urgencia_mat_p)::numeric /1440;
		else
			dt_referencia_w :=  to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || to_char(to_date(Obter_prox_hora_cheia(dt_referencia_p),'hh24:mi:ss'),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		end if;

		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_interv_proc_p;

		cpoe_calcular_horario_prescr( nr_atendimento_p,cd_interv_proc_p,cd_mat_proc_p,dt_referencia_w,
						  0,qt_min_intervalo_w,nr_ocorrencia_w,ds_horarios_w,
						  ds_horarios_ww,nm_usuario_p,cd_estabelecimento_p,cd_perfil_p,
						  null,null, null, null,
						  null, ceil((coalesce(dt_fim_proc_p, dt_referencia_w + 1) - dt_referencia_w)*24) );

		ds_horarios_w := ds_horarios_w||ds_horarios_ww;

	end;

	function obter_se_pro_atrasado( dt_inicio_proc_p	cpoe_procedimento.dt_inicio_proc1%type,
									hr_prim_hor_proc_p	cpoe_procedimento.hr_prim_hor_proc1%type)
								return;

		if (dt_prim_horario_w < dt_referencia_p) then
			return;
		else
			return;
		end if;
	end;

begin
select	max(cd_mat_proc1),
		max(cd_mat_proc2),
		max(cd_mat_proc3),
		max(cd_mat_proc4),
		max(cd_mat_proc5),
		max(cd_interv_proc1),
		max(cd_interv_proc2),
		max(cd_interv_proc3),
		max(cd_interv_proc4),
		max(cd_interv_proc5),
		max(hr_prim_hor_proc1),
		max(hr_prim_hor_proc2),
		max(hr_prim_hor_proc3),
		max(hr_prim_hor_proc4),
		max(hr_prim_hor_proc5),
		max(dt_inicio_proc1),
		max(dt_inicio_proc2),
		max(dt_inicio_proc3),
		max(dt_inicio_proc4),
		max(dt_inicio_proc5),
		max(dt_fim_proc1),
		max(dt_fim_proc2),
		max(dt_fim_proc3),
		max(dt_fim_proc4),
		max(dt_fim_proc5),
		max(ie_urgencia_mat1),
		max(ie_urgencia_mat2),
		max(ie_urgencia_mat3),
		max(ie_urgencia_mat4),
		max(ie_urgencia_mat5)
into STRICT	cd_mat_proc1_w,
		cd_mat_proc2_w,
		cd_mat_proc3_w,
		cd_mat_proc4_w,
		cd_mat_proc5_w,
		cd_interv_proc1_w,
		cd_interv_proc2_w,
		cd_interv_proc3_w,
		cd_interv_proc4_w,
		cd_interv_proc5_w,
		hr_prim_hor_proc1_w,
		hr_prim_hor_proc2_w,
		hr_prim_hor_proc3_w,
		hr_prim_hor_proc4_w,
		hr_prim_hor_proc5_w,
		dt_inicio_proc1_w,
		dt_inicio_proc2_w,
		dt_inicio_proc3_w,
		dt_inicio_proc4_w,
		dt_inicio_proc5_w,
		dt_fim_proc1_w,
		dt_fim_proc2_w,
		dt_fim_proc3_w,
		dt_fim_proc4_w,
		dt_fim_proc5_w,
		ie_urgencia_mat1_w,
		ie_urgencia_mat2_w,
		ie_urgencia_mat3_w,
		ie_urgencia_mat4_w,
		ie_urgencia_mat5_w
from	cpoe_procedimento
where	nr_sequencia = nr_seq_cpoe_p;

ds_horarios_w := '';
ds_horarios_ww := '';
dt_referencia_w := '';

if (cd_mat_proc1_w IS NOT NULL AND cd_mat_proc1_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_proc1_w, hr_prim_hor_proc1_w) = 'S') then

		preencher_ds_horarios(cd_interv_proc1_w, cd_mat_proc1_w, dt_fim_proc1_w, ie_urgencia_mat1_w);

		update	cpoe_procedimento
		set		dt_inicio_proc1 = trunc(dt_referencia_w),
				hr_prim_hor_proc1 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_proc1 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

ds_horarios_w := '';
ds_horarios_ww := '';
dt_referencia_w := '';

if (cd_mat_proc2_w IS NOT NULL AND cd_mat_proc2_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_proc2_w, hr_prim_hor_proc2_w) = 'S') then

		preencher_ds_horarios(cd_interv_proc2_w, cd_mat_proc2_w, dt_fim_proc2_w, ie_urgencia_mat2_w);

		update	cpoe_procedimento
		set		dt_inicio_proc2 = trunc(dt_referencia_w),
				hr_prim_hor_proc2 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_proc2 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

ds_horarios_w := '';
ds_horarios_ww := '';
dt_referencia_w := '';

if (cd_mat_proc3_w IS NOT NULL AND cd_mat_proc3_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_proc3_w, hr_prim_hor_proc3_w) = 'S') then

		preencher_ds_horarios(cd_interv_proc3_w, cd_mat_proc3_w, dt_fim_proc3_w, ie_urgencia_mat3_w);

		update	cpoe_procedimento
		set		dt_inicio_proc3 = trunc(dt_referencia_w),
				hr_prim_hor_proc3 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_proc3 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

ds_horarios_w := '';
ds_horarios_ww := '';
dt_referencia_w := '';

if (cd_mat_proc4_w IS NOT NULL AND cd_mat_proc4_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_proc4_w, hr_prim_hor_proc4_w) = 'S') then

		preencher_ds_horarios(cd_interv_proc4_w, cd_mat_proc4_w, dt_fim_proc4_w, ie_urgencia_mat4_w);

		update	cpoe_procedimento
		set		dt_inicio_proc4 = trunc(dt_referencia_w),
				hr_prim_hor_proc4 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_proc4 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

ds_horarios_w := '';
ds_horarios_ww := '';
dt_referencia_w := '';

if (cd_mat_proc5_w IS NOT NULL AND cd_mat_proc5_w::text <> '') then

	if (obter_se_pro_atrasado(dt_inicio_proc5_w, hr_prim_hor_proc5_w) = 'S') then

		preencher_ds_horarios(cd_interv_proc5_w, cd_mat_proc5_w, dt_fim_proc5_w, ie_urgencia_mat5_w);

		update	cpoe_procedimento
		set		dt_inicio_proc5 = trunc(dt_referencia_w),
				hr_prim_hor_proc5 = to_char(dt_referencia_w,'hh24:mi'),
				ds_hor_proc5 = ds_horarios_w
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atual_data_ago_mat_assoc ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_procedimento.nr_sequencia%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

