-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_hor_visualizacao_salas ( qt_intervalo_p bigint, nm_usuario_p text) AS $body$
DECLARE


i				integer := 1;
dt_inicial_w	timestamp;
dt_final_w		timestamp;
dt_horario_w	timestamp;
dt_horario_ww	timestamp;
qt_intervalo_w	integer;
qt_hor_min_turno_w	bigint;
qt_hor_max_turno_w	bigint;


BEGIN

--Horário mínimo e máximo customizado, para visualização da ocupação dos horários
qt_hor_min_turno_w := Obter_Param_Usuario(99018, 4, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, qt_hor_min_turno_w);
qt_hor_max_turno_w := Obter_Param_Usuario(99018, 5, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, qt_hor_max_turno_w);

if (qt_hor_max_turno_w = 0) then
	qt_hor_max_turno_w	:= 23;
end if;

delete	FROM gest_cons_horarios
where	nm_usuario = nm_usuario_p;
commit;

select	to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || min(to_char(a.hr_inicial,'hh24:mi:ss')), 'dd/mm/yyyy hh24:mi:ss'),
		to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || max(to_char(a.hr_final,'hh24:mi:ss')), 'dd/mm/yyyy hh24:mi:ss')
into STRICT	dt_inicial_w,
		dt_final_w
from	agenda_turno a
where	(a.nr_seq_sala IS NOT NULL AND a.nr_seq_sala::text <> '');

dt_horario_w	:= dt_inicial_w;
dt_horario_ww	:= dt_inicial_w;
qt_intervalo_w	:= qt_intervalo_p;

if (qt_hor_min_turno_w IS NOT NULL AND qt_hor_min_turno_w::text <> '') and (qt_hor_max_turno_w IS NOT NULL AND qt_hor_max_turno_w::text <> '') then
	select	to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || qt_hor_min_turno_w||':00:00', 'dd/mm/yyyy hh24:mi:ss'),
			to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || qt_hor_max_turno_w||':00:00', 'dd/mm/yyyy hh24:mi:ss')
	into STRICT	dt_horario_w,
			dt_final_w
	;
	dt_horario_ww	:= dt_horario_w;
end if;

if (dt_inicial_w IS NOT NULL AND dt_inicial_w::text <> '') and (dt_final_w IS NOT NULL AND dt_final_w::text <> '')then
	begin
	while(dt_horario_w <= dt_final_w) loop
		begin
		if (i > 1) then
			select	dt_horario_ww + (qt_intervalo_w / 1440)
			into STRICT	dt_horario_ww
			;
		end if;

		insert into gest_cons_horarios(
								dt_horario,
								dt_atualizacao,
								nm_usuario)
		values (	dt_horario_ww,
								clock_timestamp(),
								nm_usuario_p);
		commit;
		end;
	i				:= i + 1;
	dt_horario_w	:= dt_horario_w + (qt_intervalo_w / 1440);
	end loop;

	if (qt_intervalo_w < 60)then
		--Gerar último registro com o horário final + duração do intervalo
		insert into gest_cons_horarios(
									dt_horario,
									dt_atualizacao,
									nm_usuario)
			values (	dt_horario_ww,
									clock_timestamp(),
									nm_usuario_p);
		commit;
	end if;

	end;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_hor_visualizacao_salas ( qt_intervalo_p bigint, nm_usuario_p text) FROM PUBLIC;

