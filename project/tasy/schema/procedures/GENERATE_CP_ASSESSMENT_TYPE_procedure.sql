-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_cp_assessment_type ( CD_PESSOA_FISICA_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, CD_MEDICO_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, NM_USUARIO_P MED_AVALIACAO_RESULT.NM_USUARIO%TYPE, NR_SEQ_ITEM_PRONT_P MED_AVALIACAO_PACIENTE.NR_SEQ_ITEM_PRONT%TYPE, NR_SEQ_TIPO_AVALIACAO_P MED_AVALIACAO_PACIENTE.NR_SEQ_TIPO_AVALIACAO%TYPE, NR_SEQ_PROT_INT_PAC_P FUNCAO_PARAM_ESTAB.VL_PARAMETRO%TYPE ) AS $body$
DECLARE


    NR_SEQ_PRONTUARIO_W CONSTANT MED_TIPO_AVALIACAO.NR_SEQ_PRONTUARIO%TYPE := 1558;
    IE_AVALIACAO_PARCIAL_W CONSTANT MED_AVALIACAO_PACIENTE.IE_AVALIACAO_PARCIAL%TYPE := 'N';
    DS_REGRA_LIKE_W CONSTANT MED_ITEM_AVALIAR.DS_REGRA%TYPE := '%PROTOCOLO_INT_PACIENTE%';

    ASSESSMENT_EXISTS_W MED_TIPO_AVALIACAO.NR_SEQUENCIA%TYPE;
    NR_SEQ_MED_AVAL_PAC_W MED_ITEM_AVALIAR.NR_SEQUENCIA%TYPE;
    NR_SEQ_CP_MED_AVAL_W MED_AVALIACAO_PACIENTE.NR_SEQUENCIA%TYPE;


BEGIN

    SELECT MAX(NR_SEQUENCIA)
      INTO STRICT ASSESSMENT_EXISTS_W
      FROM MED_TIPO_AVALIACAO
     WHERE NR_SEQUENCIA = NR_SEQ_TIPO_AVALIACAO_P
       AND NR_SEQ_PRONTUARIO = NR_SEQ_PRONTUARIO_W;

    IF (ASSESSMENT_EXISTS_W IS NOT NULL AND ASSESSMENT_EXISTS_W::text <> '') THEN

        NR_SEQ_MED_AVAL_PAC_W := OBTER_NEXTVAL_SEQUENCE('MED_AVALIACAO_PACIENTE');

        SELECT coalesce(MAX(A.NR_SEQUENCIA), 0)
          INTO STRICT NR_SEQ_CP_MED_AVAL_W
          FROM MED_ITEM_AVALIAR A
        INNER JOIN MED_TIPO_AVALIACAO B ON A.NR_SEQ_TIPO = B.NR_SEQUENCIA
         WHERE B.NR_SEQUENCIA = NR_SEQ_TIPO_AVALIACAO_P
           AND UPPER(A.DS_REGRA) LIKE DS_REGRA_LIKE_W;

        INSERT INTO MED_AVALIACAO_PACIENTE(
            NR_SEQUENCIA,
            CD_PESSOA_FISICA,
            CD_MEDICO,
            NM_USUARIO,
            DT_AVALIACAO,
            DT_ATUALIZACAO,
            NR_SEQ_TIPO_AVALIACAO,
            NR_SEQ_ITEM_PRONT,
            IE_AVALIACAO_PARCIAL
        )
        VALUES (
            NR_SEQ_MED_AVAL_PAC_W,
            CD_PESSOA_FISICA_P,
            CD_MEDICO_P,
            NM_USUARIO_P,
            clock_timestamp(),
            clock_timestamp(),
            NR_SEQ_TIPO_AVALIACAO_P,
            NR_SEQ_ITEM_PRONT_P,
            IE_AVALIACAO_PARCIAL_W
        );

        INSERT INTO MED_AVALIACAO_RESULT(
            NR_SEQ_AVALIACAO,
            NR_SEQ_ITEM,
            DT_ATUALIZACAO,
            NM_USUARIO,
            QT_RESULTADO
        )
            SELECT NR_SEQ_MED_AVAL_PAC_W,
                   NR_SEQUENCIA,
                   clock_timestamp(),
                   NM_USUARIO_P,
                   CASE
                    WHEN NR_SEQUENCIA = NR_SEQ_CP_MED_AVAL_W THEN TO_CHAR(NR_SEQ_PROT_INT_PAC_P)
                    ELSE VL_PADRAO END
              FROM MED_ITEM_AVALIAR
             WHERE NR_SEQ_TIPO = NR_SEQ_TIPO_AVALIACAO_P;

        COMMIT;

    END IF;

    EXCEPTION 
        WHEN no_data_found THEN
            ASSESSMENT_EXISTS_W := NULL;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_cp_assessment_type ( CD_PESSOA_FISICA_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, CD_MEDICO_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, NM_USUARIO_P MED_AVALIACAO_RESULT.NM_USUARIO%TYPE, NR_SEQ_ITEM_PRONT_P MED_AVALIACAO_PACIENTE.NR_SEQ_ITEM_PRONT%TYPE, NR_SEQ_TIPO_AVALIACAO_P MED_AVALIACAO_PACIENTE.NR_SEQ_TIPO_AVALIACAO%TYPE, NR_SEQ_PROT_INT_PAC_P FUNCAO_PARAM_ESTAB.VL_PARAMETRO%TYPE ) FROM PUBLIC;

