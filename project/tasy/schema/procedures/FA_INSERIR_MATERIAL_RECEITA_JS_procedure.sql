-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_inserir_material_receita_js ( nr_seq_entrega_p bigint, cd_setor_atendimento_p bigint, nr_seq_status_entrega_p bigint, nm_maquina_atual_p text, ds_status_mov_estq_p text, ds_status_p text, ie_validou_p INOUT text, nm_usuario_p text, ie_medic_conta_p INOUT text) AS $body$
DECLARE

		 
cd_local_estoque_w	bigint;
ie_validou_w		varchar(255);
ie_tipo_local_estoque_w	varchar(2);
ie_medic_conta_w	varchar(1);
nr_atendimento_w	bigint;


BEGIN 
ie_medic_conta_w := 'S';
ie_validou_w 	 := 'S';
ie_tipo_local_estoque_w	:= obter_valor_param_usuario(10015, 63, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
 
if (ds_status_mov_estq_p = 'CM') and (ds_status_p = 'CM') then 
	begin		 
	 
	select 	max(a.nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from  	fa_paciente_entrega a, 
		fa_entrega_medicacao b 
	where 	a.nr_sequencia = b.nr_seq_paciente_entrega 
	and  	b.nr_sequencia = nr_seq_entrega_p;
	 
	select fa_obter_local_estoque(nm_maquina_atual_p,nr_atendimento_w,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento) qt_local_estoque 
	into STRICT	cd_local_estoque_w 
	;
	 
		 
	if (cd_local_estoque_w <= 0) then 
		if (ie_tipo_local_estoque_w = 'C') then			 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(89036);
		elsif (ie_tipo_local_estoque_w = 'P') then			 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(89037);
		elsif (ie_tipo_local_estoque_w = 'U') then			 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(89038);
		end if;
	end if;
		 
	SELECT * FROM fa_inserir_material_receita(0, nr_seq_entrega_p, nm_usuario_p, cd_local_estoque_w, cd_setor_atendimento_p, '', ie_validou_w, ie_medic_conta_w) INTO STRICT ie_validou_w, ie_medic_conta_w;
	end;	
end if;
	 
CALL fa_alterar_status_entrega(nr_seq_status_entrega_p, 0, ds_status_p);
 
ie_medic_conta_p := ie_medic_conta_w;
ie_validou_p   := ie_validou_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_inserir_material_receita_js ( nr_seq_entrega_p bigint, cd_setor_atendimento_p bigint, nr_seq_status_entrega_p bigint, nm_maquina_atual_p text, ds_status_mov_estq_p text, ds_status_p text, ie_validou_p INOUT text, nm_usuario_p text, ie_medic_conta_p INOUT text) FROM PUBLIC;

