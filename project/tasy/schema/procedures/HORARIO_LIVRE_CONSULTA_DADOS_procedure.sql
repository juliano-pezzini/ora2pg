-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE horario_livre_consulta_dados ( cd_agenda_p bigint, VarAgendasUsuario_p text, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
cd_agenda_w			bigint;
ie_feriado_w			varchar(1);
ie_sobra_horario_w			varchar(1);
dt_agenda_w			timestamp;
cd_estabelecimento_w		smallint;
ds_retorno_w			varchar(255);
ie_resp_excl_hor_livres_w	varchar(1);
ie_consulta_w			varchar(1);

C01 CURSOR FOR 
SELECT 	a.cd_agenda, 
	a.ie_feriado, 
	a.ie_gerar_sobra_horario, 
	a.cd_estabelecimento 
from	agenda a 
where	obter_se_contido(a.cd_agenda,VarAgendasUsuario_p) = 'S' 
and	((a.cd_agenda = cd_agenda_p) or (cd_agenda_p = 0));


BEGIN 
 
select	coalesce(max(obter_valor_param_usuario(821, 365, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento)), 'N') 
into STRICT	ie_resp_excl_hor_livres_w
;
 
open c01;
	loop 
	fetch c01 into	cd_agenda_w, 
			ie_feriado_w, 
			ie_sobra_horario_w, 
			cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		dt_agenda_w := dt_inicio_p;
 
		while(dt_agenda_w <= dt_final_p) loop 
			begin 
			if (ie_resp_excl_hor_livres_w = 'S')then 
				ie_consulta_w	:= 'N';
			else 
				ie_consulta_w	:= 'S';			
			end if;			
			ds_retorno_w := horario_livre_consulta(cd_estabelecimento_w, cd_agenda_w, ie_feriado_w, dt_agenda_w, nm_usuario_p, 'S', ie_sobra_horario_w, ie_consulta_w, 0, ds_retorno_w);
			dt_agenda_w := dt_agenda_w + 1;
			end;
		end loop;
 
		end;
	end loop;
	close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE horario_livre_consulta_dados ( cd_agenda_p bigint, VarAgendasUsuario_p text, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

