-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_reversao_suspen ( ie_tipo_item_p text, nr_seq_horario_p bigint) AS $body$
DECLARE

	ie_ok_w	varchar(1)	:=	'S';

BEGIN
	if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '')	and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '')	then

		if (ie_tipo_item_p in ('M','MAT','SOL'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_mat_hor a,
					prescr_material b,
					cpoe_material c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		b.cd_material = a.cd_material
			and		c.nr_sequencia = b.nr_seq_mat_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('P'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_proc_hor a,
					prescr_procedimento b,
					cpoe_procedimento c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		b.cd_material_exame = a.cd_material_exame
			and		c.nr_sequencia = b.nr_seq_proc_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('AP'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_proc_hor a,
					prescr_procedimento b,
					cpoe_anatomia_patologica c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		c.nr_sequencia = b.nr_seq_proc_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('H','HM'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_proc_hor a,
					prescr_procedimento b,
					cpoe_hemoterapia c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		b.cd_material_exame = a.cd_material_exame
			and		c.nr_sequencia = b.nr_seq_proc_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('DI'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_mat_hor a,
					hd_prescricao b,
					cpoe_dialise c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		c.nr_sequencia = b.nr_seq_dialise_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('R'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_rec_hor a,
					prescr_recomendacao b,
					cpoe_recomendacao c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		c.nr_sequencia = b.nr_seq_rec_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('S','LD','SNE','D'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_dieta_hor a,
					prescr_dieta b,
					cpoe_dieta c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		c.nr_sequencia = b.nr_seq_dieta_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('NPTA','NPTI'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	nut_paciente_hor a,
					nut_pac b,
					cpoe_dieta c
			where   a.nr_sequencia = nr_seq_horario_p
			and     b.nr_sequencia = a.nr_seq_nut_protocolo
			and     c.nr_sequencia = b.nr_seq_npt_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;

		elsif (ie_tipo_item_p in ('O'))	then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_mat_hor a,
					prescr_gasoterapia b,
					cpoe_recomendacao c
			where	a.nr_sequencia = nr_seq_horario_p
			and		b.nr_prescricao = a.nr_prescricao
			and		c.nr_sequencia = b.nr_seq_gas_cpoe
			and		(c.dt_suspensao IS NOT NULL AND c.dt_suspensao::text <> '')
			and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
			and		a.dt_suspensao >= c.dt_suspensao;
		end if;

		if (ie_ok_w = 'N') then
			-- O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter a etapa/horario suspenso!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(196186);
		end if;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_reversao_suspen ( ie_tipo_item_p text, nr_seq_horario_p bigint) FROM PUBLIC;

