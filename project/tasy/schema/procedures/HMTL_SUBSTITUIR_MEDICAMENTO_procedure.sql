-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hmtl_substituir_medicamento ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, ds_campo_mat_alt_p text, cd_mat_antigo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

							 
cd_material_w			cpoe_material.cd_material%type;
qt_dose_w				cpoe_material.qt_dose%type;
cd_unidade_medida_w		cpoe_material.cd_unidade_medida%type;
							
nr_seq_material_w		prescr_material.nr_sequencia%type;
nr_seq_material_ww		prescr_material.nr_sequencia%type;
nr_seq_solucao_w		prescr_material.nr_sequencia_solucao%type;
ie_agrupador_w			prescr_material.ie_agrupador%type;

 

BEGIN 
 
select	max(nr_sequencia), 
		max(nr_sequencia_solucao), 
		max(ie_agrupador) 
into STRICT	nr_seq_material_w, 
		nr_seq_solucao_w, 
		ie_agrupador_w 
from	prescr_material 
where	cd_material = cd_mat_antigo_p 
and		nr_seq_mat_cpoe = nr_seq_cpoe_p 
and		nr_prescricao = nr_prescricao_p;
 
if (coalesce(nr_seq_material_w,0) > 0) then 
 
	if (ie_agrupador_w = 4) then 
		nr_seq_material_ww := substituir_componente_solucao(nr_prescricao_p, nr_seq_material_w, cd_estabelecimento_p, nm_usuario_p, nr_seq_material_ww);
	elsif (ie_agrupador_w = 1) then 
		nr_seq_material_ww := substituir_medicamento(nr_prescricao_p, nr_seq_material_w, cd_estabelecimento_p, nm_usuario_p, nr_seq_material_ww);
	end if;
	 
	if (nr_seq_material_ww IS NOT NULL AND nr_seq_material_ww::text <> '') then 
	 
		select	max(cd_material), 
				max(qt_dose), 
				max(cd_unidade_medida) 
		into STRICT	cd_material_w, 
				qt_dose_w, 
				cd_unidade_medida_w 
		from	cpoe_material_vig_v 
		where	nr_sequencia = nr_seq_cpoe_p 
		and		ie_tipo_item = html_obter_tipo_campo(ds_campo_mat_alt_p);
		 
		update	prescr_material 
		set		cd_material 			= cd_material_w, 
				qt_dose 				= qt_dose_w, 
				cd_unidade_medida_dose	= cd_unidade_medida_w, 
				nr_seq_mat_cpoe 		= nr_seq_cpoe_p 
		where	nr_sequencia 			= nr_seq_material_ww 
		and		nr_prescricao 			= nr_prescricao_p;
		 
		commit;	
		 
		if (ie_agrupador_w = 4) then 
			CALL atual_solucao_subst_componente(nr_prescricao_p, nr_seq_solucao_w, nr_seq_material_ww, cd_estabelecimento_p, nm_usuario_p);
		end if;
		 
	end if;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hmtl_substituir_medicamento ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, ds_campo_mat_alt_p text, cd_mat_antigo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

