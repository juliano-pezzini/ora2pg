-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_ds_hr_ini_prim_hr_md ( ds_prim_horario_p text, dt_prescricao_p timestamp, dt_primeiro_horario_p timestamp, hr_inicial_p INOUT text, hr_atual_p INOUT timestamp, ds_hora_inicio_p INOUT text, ds_horario_p INOUT text ) AS $body$
DECLARE

    ie_minutos_w  varchar(1);
    i             integer;

BEGIN
    FOR i IN 1..length(ds_prim_horario_p) LOOP
        BEGIN
            IF ( substr(ds_prim_horario_p, i, 1) = ' ' ) THEN
                BEGIN
                    IF ( coalesce(ds_hora_inicio_p::text, '') = '' ) THEN
                        ds_hora_inicio_p := ds_horario_p;
                    END IF;
                    IF ( substr(ds_horario_p, 1, 2) = '00' ) OR ( substr(ds_horario_p, 1, 2) = '24' ) THEN
                         hr_atual_p	:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_p) + 1;
                    ELSE
                        ie_minutos_w := 'N';
                        IF ( length(ds_horario_p) = 0 ) THEN
                            ds_horario_p := '00';
                        ELSIF (
                            ( length(ds_horario_p) > 2 )
                            AND ( length(ds_horario_p) <> 5 )
                        ) OR (
                            ( length(ds_horario_p) = 5 )
                            AND ( ( substr(ds_horario_p, 3, 1) <> ':' ) OR ( substr(ds_horario_p, 4, 1) > '5' ) )
                        ) THEN
                            ds_horario_p := substr(ds_horario_p, 1, 2);
                        END IF;

                        IF ( length(ds_horario_p) = 1 ) THEN
                            ds_horario_p := '0' || ds_horario_p;
                        ELSIF ( length(ds_horario_p) = 5 ) THEN
                            ie_minutos_w := 'S';
                        END IF;

                        IF ( ds_horario_p <> 'SN' )
                            AND ( ds_horario_p <> 'ACM' )
                            AND ( ds_horario_p <> '' )
                        THEN
                            IF ( ie_minutos_w = 'S' ) THEN
                                hr_atual_p := to_date(to_char(dt_prescricao_p, 'dd/mm/yyyy')
                                                      || ds_horario_p, 'dd/mm/yyyy hh24:mi');
                            ELSE
                                hr_atual_p := to_date(to_char(dt_prescricao_p, 'dd/mm/yyyy')
                                                      || ds_horario_p, 'dd/mm/yyyy hh24');
                            END IF;
                        END IF;

                    END IF;

                    IF ( hr_atual_p < dt_prescricao_p ) THEN
                        hr_atual_p := hr_atual_p + 1;
                    END IF;
                    IF ( ds_horario_p <> 'SN' ) THEN
                        IF ( length(ds_horario_p) = 2 ) THEN
                            ds_horario_p := ds_horario_p || ':00';
                        END IF;

                        IF ( ds_horario_p >= to_char(dt_primeiro_horario_p, 'hh24:mi') ) THEN
                            BEGIN
                                hr_inicial_p := ds_horario_p;
                                ds_hora_inicio_p := ds_horario_p;
                                EXIT;
                            END;
                        END IF;

                    END IF;

                    ds_horario_p := '';
                END;

            ELSE
                BEGIN
                    ds_horario_p := substr(ds_horario_p
                                           || substr(ds_prim_horario_p, i, 1), 1, 5);

                END;
            END IF;

        END;
    END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_ds_hr_ini_prim_hr_md ( ds_prim_horario_p text, dt_prescricao_p timestamp, dt_primeiro_horario_p timestamp, hr_inicial_p INOUT text, hr_atual_p INOUT timestamp, ds_hora_inicio_p INOUT text, ds_horario_p INOUT text ) FROM PUBLIC;

