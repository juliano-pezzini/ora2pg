-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE additional_proc_validation ( nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, cd_procedimento_new_p bigint, cd_procedimento_old_p bigint, ie_origem_proced_p bigint, cd_abort_p INOUT bigint, cd_questiona_autor_vinc_p INOUT bigint) AS $body$
DECLARE


ie_consiste_sexo_w	varchar(15);
ie_alterar_proced_w	varchar(15);
ie_permite_w			varchar(15);
ie_questiona_w			varchar(15);
cd_perfil_w				perfil.cd_perfil%type 	:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w			usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;


BEGIN

select	max(cd_pessoa_fisica)
into STRICT		cd_pessoa_fisica_w
from		agenda_paciente
where		nr_sequencia = nr_seq_agenda_p;

if (coalesce(nr_seq_proc_interno_p,0) > 0) then
	select	coalesce(max('S'), 'N')
	into STRICT		ie_permite_w
	from		proc_interno
	where		nr_sequencia = nr_seq_proc_interno_p
	and		coalesce(ie_situacao,'A') = 'A';
	if (ie_permite_w = 'N') then
		cd_abort_p := 290231;
	end if;
end if;

if (coalesce(cd_abort_p::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	ie_consiste_sexo_w := Obter_Param_Usuario(871, 94, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_consiste_sexo_w);
	if (ie_consiste_sexo_w = 'A') or (ie_consiste_sexo_w = 'SA') then
		select 	max(consistir_sexo_exclusivo_proc(cd_pessoa_fisica_w, nr_seq_proc_interno_p, cd_procedimento_new_p, ie_origem_proced_p))
		into STRICT		ie_permite_w
		;
		if (ie_permite_w = 'N') then
			cd_abort_p := 91173;
		end if;
	end if;
end if;

if (coalesce(cd_abort_p::text, '') = '') then
	if (coalesce(cd_procedimento_old_p,0) > 0) and (cd_procedimento_old_p <> cd_procedimento_new_p) then
		ie_alterar_proced_w := Obter_Param_Usuario(871, 793, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_alterar_proced_w);
		if (ie_alterar_proced_w <> 'N') then

			select 	coalesce(max('S'),'N')
			into STRICT		ie_questiona_w
			from		autorizacao_convenio b,
						procedimento_autorizado a
			where  	a.nr_sequencia_autor = b.nr_sequencia
			and    	b.nr_seq_agenda 		= nr_seq_agenda_p
			and    	a.cd_procedimento 	= cd_procedimento_old_p;

			if (ie_questiona_w = 'S') then
				if (ie_alterar_proced_w = 'S') then
					cd_abort_p := 279340;
				elsif (ie_alterar_proced_w = 'Q') then
					cd_questiona_autor_vinc_p := 72028;
				end if;
			end if;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE additional_proc_validation ( nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, cd_procedimento_new_p bigint, cd_procedimento_old_p bigint, ie_origem_proced_p bigint, cd_abort_p INOUT bigint, cd_questiona_autor_vinc_p INOUT bigint) FROM PUBLIC;

