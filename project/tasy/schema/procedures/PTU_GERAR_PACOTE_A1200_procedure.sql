-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_pacote_a1200 ( nr_seq_pacote_p text, nm_usuario_p text) AS $body$
DECLARE


ds_pacote_w			varchar(255);
nm_prestador_w			varchar(255);
cd_prestador_w			varchar(100);	
cd_prest_a400_w			varchar(15);		
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_unimed_origem_w		varchar(10);
cd_unimed_orig_prest_w		varchar(10);
vl_pacote_w			varchar(10);
cd_servico_w			varchar(10);
vl_servico_w			varchar(10);
ie_tipo_despesa_w		varchar(10);
nr_seq_prestador_w		bigint;
nr_seq_ptu_pacote_w		ptu_pacote.nr_sequencia%type;
nr_seq_pacote_reg_w		bigint;
qt_servico_w			pls_pacote_procedimento.qt_procedimento%type;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
nr_seq_pacote_w			bigint;
nr_versao_transacao_w		ptu_pacote.nr_versao_transacao%type;
dt_inicio_vigencia_w		pls_pacote_composicao.dt_inicio_vigencia%type;
dt_fim_vigencia_w		pls_pacote_composicao.dt_fim_vigencia%type;
ie_tipo_item_w			ptu_pacote_servico.ie_tipo_item%type;
qt_pac_servico_w		integer;
cd_pacote_w			integer;
nr_seq_composicao_w		pls_pacote_composicao.nr_sequencia%type;
nr_seq_prestador_serv_w		bigint;
ie_proc_mat_w			varchar(1);
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
cd_interface_w			interface.cd_interface%type;
cd_versao_w			varchar(10);
ds_servico_w			ptu_pacote_servico.ds_servico%type;
dt_atual_w			timestamp := trunc(clock_timestamp());
cd_espec_prest_w		pls_prestador_med_espec.cd_especialidade%type;
cd_espec_ptu_w			especialidade_medica.cd_ptu%type;
cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
cd_cgc_w			pls_prestador.cd_cgc%type;
ie_tipo_tabela_w		bigint;
cd_unimed_prest_w		varchar(10);
cd_prest_w			varchar(15);
nm_prest_w			varchar(255);
cd_cnes_prest_w			varchar(7);
ie_tipo_pacote_w		ptu_pacote_reg.ie_tipo_pacote%type;
cd_unimed_prestadora_w		pls_prestador.cd_unimed_prestadora%type;
ie_principal_w			ptu_pacote_servico.ie_principal%type;
ie_tipo_participacao_w		ptu_pacote_servico.ie_tipo_participacao%type;
qt_registro_w			integer := 0;
nr_seq_regra_conv_pac_w		pls_regra_conversao_pacote.nr_sequencia%type;
nr_seq_grupo_proc_w		pls_pacote_cad_grupo_proc.nr_sequencia%type;
cd_procedimento_w		procedimento.cd_procedimento%type;
ie_origem_proced_conv_w		procedimento.ie_origem_proced%type;
nr_seq_regra_conv_w		pls_conversao_proc.nr_sequencia%type;
ie_somente_codigo_w		pls_conversao_proc.ie_somente_codigo%type;
cd_servico_mat_w		varchar(50);
qt_regra_w			bigint := 0;
cd_mat_number_inter_w		numeric(30) := null;
ds_servico_orig_w		procedimento.ds_procedimento%type;
ie_param_12_w			funcao_parametro.vl_parametro_padrao%type := 'N';
ie_material_intercambio_w	pls_parametros.ie_material_intercambio%type;
cd_servico_a900_w		varchar(30);
nr_seq_material_temp_w		pls_material.nr_sequencia%type;
cd_servico_temp_w		bigint;	
qt_cad_mat_a900_w		integer := 0;
nr_seq_mat_unimed_w		pls_material_unimed.nr_sequencia%type;
ie_tp_acomodacao_ptu_w		pls_pacote_tipo_acomodacao.ie_tp_acomodacao_ptu%type;
ie_tp_internacao_ptu_w		pls_pacote_tipo_acomodacao.ie_tp_internacao_ptu%type;
ie_tp_pacote_ptu_w		pls_pacote_tipo_acomodacao.ie_tp_pacote_ptu%type;
ie_honorario_w			pls_pacote_procedimento.ie_contem_hm%type;
ie_honorario_pac_w		pls_pacote_procedimento.ie_contem_hm%type;
dt_inicio_vig_considerar_w	timestamp;
dt_fim_vig_considerar_w		timestamp;
nr_seq_grau_partic_w	pls_pacote_procedimento.nr_seq_grau_partic_ent%type;
ie_codificacao_w		pls_material_unimed.ie_codificacao%type;
dt_negociacao_w			pls_pacote_composicao.dt_negociacao%type;
cd_unidade_medida_w             pls_pacote_material.cd_unidade_medida%type;
qt_ie_principal_info_w		integer;
ie_procedimento_princ_w		pls_pacote_procedimento.ie_procedimento_princ%type;
ds_observacao_w			pls_pacote.ds_observacao%type;
nr_cpf_w			pessoa_fisica.nr_cpf%type;
ie_proc_alternativo_w		pls_pacote_procedimento.ie_proc_alternativo%type;
ie_reajuste_w                   ptu_pacote_prest.id_reajuste%type;
nr_seq_anexo_w			pls_pacote_comp_anexo.nr_sequencia%type;
ds_diretorio_arquivo_w		ptu_pacote_prest.ds_diretorio_arquivo%type;
ie_tipo_anexo_w			ptu_pacote_prest.ie_tipo_anexo%type;
ds_anexo_ptu_w			ptu_pacote_prest.ds_anexo_ptu%type;
dt_reajuste_w			pls_pacote_composicao.dt_reajuste%type;
ie_descartar_a1200_w		pls_pacote_tipo_acomodacao.ie_descartar_a1200%type;
ie_anestesista_w			ptu_pacote_reg.ie_anestesista%type;
ie_auxiliar_pac_w		ptu_pacote_reg.ie_auxiliar%type;
qt_prest_reg_w			integer;
nr_seq_regra_preco_w		pls_pacote_tipo_acomodacao.nr_sequencia%type;
nr_seq_regra_preco_ant_w	pls_pacote_tipo_acomodacao.nr_sequencia%type;
qt_composicao_w			numeric(20) := 0;
nr_seq_mesmo_dia_w 		varchar(2) := 0;



C00 CURSOR FOR
	SELECT	a.nr_sequencia,
		substr(ptu_somente_caracter_permitido(translate(a.ds_observacao, chr(10)||chr(11)||chr(13), ' '), 'ANS'), 1, 4000) ds_observacao
	from 	pls_pacote	a
	where 	' ' || nr_seq_pacote_p || ' ' like '% ' || a.nr_sequencia || ' %';

C01 CURSOR FOR
	SELECT 	coalesce(a.cd_procedimento,0) cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_procedimento,0) qt_servico,
		coalesce(a.ie_origem_proced,0) ie_origem_proced,
		null nr_seq_material,
		'P' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,80),'ANS') ds_servico,
		coalesce(a.ie_contem_hm,'N') ie_honorario,
		a.nr_seq_grau_partic_ent,
                null cd_unidade_medida,
		coalesce(a.ie_procedimento_princ, 'N') ie_procedimento_princ,
		coalesce(a.ie_proc_alternativo, 'N') ie_proc_alternativo
	from 	pls_pacote_procedimento		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w)
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia    = a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	d.cd_prestador 		= e.cd_prestador
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	
union

	SELECT 	a.cd_material cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_material,0) qt_servico,
		null ie_origem_proced,
		a.nr_seq_material nr_seq_material,
		'M' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(coalesce(pls_obter_desc_material(a.nr_seq_material),a.ds_material_proprio),1,80),'ANS') ds_servico,
		'N' ie_honorario,
		null nr_seq_grau_partic_ent,
                (select max(x.nr_unidade_ptu)  from unidade_medida x where x.cd_unidade_medida = a.cd_unidade_medida) cd_unidade_medida,
		null ie_procedimento_princ,
		null ie_proc_alternativo
	from	pls_pacote_material		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w)
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia      = a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	d.cd_prestador 		= e.cd_prestador
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	
union

	select 	coalesce(a.cd_procedimento,0) cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_procedimento,0) qt_servico,
		coalesce(a.ie_origem_proced,0) ie_origem_proced,
		null nr_seq_material,
		'P' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,80),'ANS') ds_servico,
		coalesce(a.ie_contem_hm,'N') ie_honorario,
		a.nr_seq_grau_partic_ent,
                null cd_unidade_medida,
		coalesce(a.ie_procedimento_princ, 'N') ie_procedimento_princ,
		coalesce(a.ie_proc_alternativo, 'N') ie_proc_alternativo
	from 	pls_pacote_procedimento		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w)
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia    	= a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	d.nr_seq_prestador	= e.nr_sequencia
	and	coalesce(d.cd_prestador::text, '') = ''
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	
union

	select 	a.cd_material cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_material,0) qt_servico,
		null ie_origem_proced,
		a.nr_seq_material nr_seq_material,
		'M' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(coalesce(pls_obter_desc_material(a.nr_seq_material),a.ds_material_proprio),1,80),'ANS') ds_servico,
		'N' ie_honorario,
		null nr_seq_grau_partic_ent,
                (select max(x.nr_unidade_ptu)  from unidade_medida x where x.cd_unidade_medida = a.cd_unidade_medida) cd_unidade_medida,
		null ie_procedimento_princ,
		null ie_proc_alternativo
	from	pls_pacote_material		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w) 
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia    	= a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	d.nr_seq_prestador	= e.nr_sequencia
	and	coalesce(d.cd_prestador::text, '') = ''
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	
union all

	select 	coalesce(a.cd_procedimento,0) cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_procedimento,0) qt_servico,
		coalesce(a.ie_origem_proced,0) ie_origem_proced,
		null nr_seq_material,
		'P' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,80),'ANS') ds_servico,
		coalesce(a.ie_contem_hm,'N') ie_honorario,
		a.nr_seq_grau_partic_ent,
                null cd_unidade_medida,
		coalesce(a.ie_procedimento_princ, 'N') ie_procedimento_princ,
		coalesce(a.ie_proc_alternativo, 'N') ie_proc_alternativo
	from 	pls_pacote_procedimento		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w)
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia    	= a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	coalesce(d.cd_prestador::text, '') = ''
	and	(d.nr_seq_grupo_prestador IS NOT NULL AND d.nr_seq_grupo_prestador::text <> '')
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	and 	ie_param_12_w		= 'S'
	and	e.nr_sequencia in (	select	x.nr_seq_prestador
					from	table(pls_grupos_pck.obter_prestadores_grupo(d.nr_seq_grupo_prestador))x)
	
union

	select 	a.cd_material cd_servico,
		coalesce(a.vl_negociado,0) vl_negociado,
		coalesce(a.qt_material,0) qt_servico,
		null ie_origem_proced,
		a.nr_seq_material nr_seq_material,
		'M' ie_proc_mat,
		ptu_somente_caracter_permitido(substr(coalesce(pls_obter_desc_material(a.nr_seq_material),a.ds_material_proprio),1,80),'ANS') ds_servico,
		'N' ie_honorario,
		null nr_seq_grau_partic_ent,
                (select max(x.nr_unidade_ptu)  from unidade_medida x where x.cd_unidade_medida = a.cd_unidade_medida) cd_unidade_medida,
		null ie_procedimento_princ,
		null ie_proc_alternativo
	from	pls_pacote_material		a,
		pls_pacote_composicao		b,
		pls_pacote			c,
		pls_pacote_tipo_acomodacao	d,
		pls_prestador			e
	where 	((a.nr_seq_pacote = nr_seq_pacote_w) 
		or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se no encotrar pelo pacote
	and	a.ie_gerar_a1200 	= 'S'
	and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
	and	e.nr_sequencia 		= nr_seq_prestador_serv_w
	and	b.nr_seq_pacote 	= c.nr_sequencia
	and	b.nr_sequencia 		= d.nr_seq_composicao
	and b.nr_sequencia      = a.nr_seq_composicao
	and	b.ie_situacao 		= 'A'
	and	coalesce(d.cd_prestador::text, '') = ''
	and	(d.nr_seq_grupo_prestador IS NOT NULL AND d.nr_seq_grupo_prestador::text <> '')
	and	c.nr_sequencia 		= nr_seq_pacote_w
	and	b.nr_sequencia		= nr_seq_composicao_w
	and 	ie_param_12_w		= 'S'
	and	e.nr_sequencia in (	select	x.nr_seq_prestador
					from	table(pls_grupos_pck.obter_prestadores_grupo(d.nr_seq_grupo_prestador))x);
	
C04 CURSOR FOR
	SELECT	distinct
		nr_seq_prestador,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		coalesce(dt_inicio_vigencia, dt_atual_w) dt_inicio_vig_considerar,
		coalesce(dt_fim_vigencia, dt_atual_w) dt_fim_vig_considerar,
		nr_seq_composicao,
		coalesce(ie_tp_acomodacao_ptu,'C'),
		ie_tp_internacao_ptu,
		ie_tp_pacote_ptu,
		dt_negociacao,
                ie_reajuste,
		nr_seq_anexo,
		dt_reajuste,
		ie_descartar_a1200,
		nr_seq_regra_preco
	from (SELECT	distinct 
			e.nr_sequencia nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_procedimento		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and     b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	d.nr_seq_prestador	= e.nr_sequencia
		and	coalesce(d.cd_prestador::text, '') = ''
		and 	coalesce(d.nr_seq_grupo_prestador::text, '') = ''
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.ie_ptu_a400		= 'S'		
		and	d.ie_situacao		= 'A'
		
union

		select	distinct 
			e.nr_sequencia nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_material		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and	b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	e.nr_sequencia		= d.nr_seq_prestador
		and	coalesce(d.cd_prestador::text, '') = ''
		and 	coalesce(d.nr_seq_grupo_prestador::text, '') = ''
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.ie_ptu_a400		= 'S'
		and	d.ie_situacao		= 'A'
		
union all

		select	distinct 
			e.nr_sequencia nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_procedimento		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and     b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	e.cd_prestador		= d.cd_prestador
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.ie_ptu_a400		= 'S'
		and	d.ie_situacao		= 'A'
		
union

		select	distinct 
			e.nr_sequencia nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_material		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and	b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	e.cd_prestador		= d.cd_prestador
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.ie_ptu_a400		= 'S'
		and	d.ie_situacao		= 'A'
		
union all

		select	distinct 
			e.nr_sequencia	nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_procedimento		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and     b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.nr_sequencia in (	select	x.nr_seq_prestador
						from	table(pls_grupos_pck.obter_prestadores_grupo(d.nr_seq_grupo_prestador))x)
		and 	ie_param_12_w		= 'S'
		and	e.ie_ptu_a400		= 'S'
		and	(d.nr_seq_grupo_prestador IS NOT NULL AND d.nr_seq_grupo_prestador::text <> '')
		and	d.ie_situacao		= 'A'
		
union all

		select	distinct 
			e.nr_sequencia	nr_seq_prestador,
			b.dt_inicio_vigencia,
			b.dt_fim_vigencia,
			d.nr_seq_composicao,
			d.ie_tp_acomodacao_ptu,
			d.ie_tp_internacao_ptu,
			d.ie_tp_pacote_ptu,
			b.dt_negociacao,
                        CASE WHEN trunc(b.dt_reajuste, 'MONTH')=trunc(clock_timestamp(), 'MONTH') THEN  'S'  ELSE 'N' END  ie_reajuste,
			pls_obter_seq_comp_anexo(b.nr_sequencia, d.nr_sequencia, e.nr_sequencia, b.dt_reajuste) nr_seq_anexo,
			b.dt_reajuste,
			coalesce(d.ie_descartar_a1200, 'N') ie_descartar_a1200,
			d.nr_sequencia nr_seq_regra_preco
		from	pls_pacote_material		a,
			pls_pacote_composicao		b,
			pls_pacote			c,
			pls_pacote_tipo_acomodacao	d,
			pls_prestador			e
		where	a.ie_gerar_a1200 	= 'S'
		and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
		and	a.nr_seq_composicao 	= b.nr_sequencia
		and	b.ie_situacao 		= 'A'
		and	b.nr_seq_pacote 	= c.nr_sequencia
		and	b.nr_sequencia 		= d.nr_seq_composicao
		and	c.nr_sequencia 		= nr_seq_pacote_w
		and	e.nr_sequencia in (	select	x.nr_seq_prestador 
						from	table(pls_grupos_pck.obter_prestadores_grupo(d.nr_seq_grupo_prestador))x)
		and 	ie_param_12_w		= 'S'
		and	e.ie_ptu_a400		= 'S'
		and	(d.nr_seq_grupo_prestador IS NOT NULL AND d.nr_seq_grupo_prestador::text <> '')
		and	d.ie_situacao		= 'A') alias51
	order by	nr_seq_regra_preco desc, -- imperativo este ser o primeiro campo do order by
			nr_seq_composicao asc;
					
C03 CURSOR(nr_seq_grupo_proc_pc	pls_pacote_cad_grupo_proc.nr_sequencia%type ) FOR
	SELECT	cd_procedimento cd_servico,
		ptu_somente_caracter_permitido(substr(obter_desc_procedimento(cd_procedimento,ie_origem_proced),1,80),'ANS') ds_servico
	from	pls_pacote_grupo_proc
	where	nr_seq_grupo	= nr_seq_grupo_proc_pc
	and	ie_situacao	= 'A'
	order by nr_sequencia;

BEGIN

ie_param_12_w := Obter_Param_Usuario(1321, 12, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_param_12_w);

select	coalesce(max(ie_material_intercambio), 'S')
into STRICT	ie_material_intercambio_w
from	pls_parametros
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select	count(1)
into STRICT	qt_cad_mat_a900_w
from	pls_material_a900 LIMIT 1;

open C00;
loop
fetch C00 into	
	nr_seq_pacote_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin
	begin
		select 	cd_estabelecimento,
			coalesce(nr_seq_prestador,0),
			coalesce(vl_pacote,0),
			coalesce(cd_procedimento,0),
			ptu_somente_caracter_permitido(substr(obter_descricao_procedimento(cd_procedimento,ie_origem_proced),1,60),'ANS')
		into STRICT	cd_estabelecimento_w,
			nr_seq_prestador_w,
			vl_pacote_w,
			cd_pacote_w,
			ds_pacote_w
		from 	pls_pacote
		where 	nr_sequencia	= nr_seq_pacote_w;
		
		select	pls_obter_unimed_estab(cd_estabelecimento_w)
		into STRICT	cd_unimed_origem_w
		;
		
		-- Gravar unimed origem prestador
		cd_unimed_orig_prest_w := cd_unimed_origem_w;
		
		select	pls_obter_cd_seq_congenere(lpad(cd_unimed_origem_w,4,'0'),'NR')
		into STRICT	nr_seq_congenere_w
		;

		if (coalesce(cd_unimed_origem_w,'-')= '-') then
			--'O sistema no encontrou cadastro da Unimed Origem. Por favor, verifique o cadastro na funo OPS - Cooperativas Mdicas.');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(185512);
		end if;
	exception
	when no_data_found then
		--Gerao de Pacote A1200 cancelada!
		--No foi possvel localizar o pacote a ser exportado.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221266,'NR_SEQ_PACOTE='||nr_seq_pacote_w);
	when others then
		--Um erro inesperado ocorreu na gerao do Pacote A1200. 
		--Veja os detalhes abaixo.
		--sqlcode||chr(13)||sqlerrm
		CALL wheb_mensagem_pck.exibir_mensagem_abort(221268,'sqlcode='||SQLSTATE||'sqlerrm='||sqlerrm);
	end;
	
	if (coalesce(trim(both cd_interface_w)::text, '') = '') then
		cd_interface_w := coalesce(pls_obter_interf_ptu( cd_estabelecimento_w, nr_seq_congenere_w, clock_timestamp(), 'A1200'), '2183');
	end if;
	
	select	ptu_obter_versao('A1200',cd_interface_w)
	into STRICT	cd_versao_w
	;

	nr_versao_transacao_w	:= somente_numero(ptu_obter_versao_transacao('A1200',cd_versao_w));
	
	/*VAI INSERIR REGISTRO PARA AS PASTAS  PACOTE A1200 E PACOTE\ ITENS */
 /*Grid Pacote A1200*/

	if (coalesce(nr_seq_ptu_pacote_w::text, '') = '') then
		insert into ptu_pacote(nr_sequencia,
			cd_unimed_origem,
			dt_atualizacao,
			dt_geracao,
			ie_tipo_carga,
			ie_tipo_informacao,
			cd_estabelecimento,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_versao_transacao)
		values (nextval('ptu_pacote_seq'),
			cd_unimed_origem_w,
			clock_timestamp(),               
			clock_timestamp(),
			1,
			1,        
			cd_estabelecimento_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			lpad(nr_versao_transacao_w,2,'0')) returning nr_sequencia into nr_seq_ptu_pacote_w;
	end if;

	nr_seq_regra_preco_ant_w	:= null;
	nr_seq_pacote_reg_w		:= null;
	

	open C04;
	loop
	fetch C04 into	
		nr_seq_prestador_serv_w,
		dt_inicio_vigencia_w,
		dt_fim_vigencia_w,
		dt_inicio_vig_considerar_w,
		dt_fim_vig_considerar_w,
		nr_seq_composicao_w,
		ie_tp_acomodacao_ptu_w,
		ie_tp_internacao_ptu_w,
		ie_tp_pacote_ptu_w,
		dt_negociacao_w,
                ie_reajuste_w,
		nr_seq_anexo_w,
		dt_reajuste_w,
		ie_descartar_a1200_w,
		nr_seq_regra_preco_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */

		
		if (dt_atual_w <= dt_fim_vig_considerar_w) and (ie_descartar_a1200_w = 'N') then

			select 	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_anestesista_w
			from	pls_Pacote_procedimento a,
					pls_grau_participacao b
			where 	a.nr_seq_composicao 	= nr_seq_composicao_w
			and 	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
			and 	a.ie_gerar_a1200 	= 'S'
			and 	a.nr_seq_grau_partic_ent = b.nr_sequencia
			and 	b.ie_anestesista  = 'S';

		--((dt_atual_w >= dt_inicio_vig_considerar_w) and (dt_atual_w <= dt_fim_vig_considerar_w) ) then
		--and	dt_atual_w between nvl(dt_inicio_vigencia, dt_atual_w) and fim_dia(nvl(dt_fim_vigencia, dt_atual_w));		
			nr_cpf_w := null;
			cd_espec_prest_w := null;
			
			select	substr(coalesce(cd_prest_a400,cd_prestador),1,8),
				ptu_somente_caracter_permitido(substr(coalesce(pls_obter_dados_prestador(nr_sequencia,'N'),'Nao Encontrado'),1,70),'ANS'),
				cd_pessoa_fisica,
				cd_cgc,
				coalesce(substr(pls_obter_cnes_prestador(nr_sequencia),1,7),'9999999'),
				cd_unimed_prestadora,
				pls_obter_dados_prestador(nr_seq_prestador_serv_w,'CPF')
			into STRICT	cd_prest_a400_w,
				nm_prestador_w,
				cd_pessoa_fisica_w,
				cd_cgc_w,
				cd_cnes_prest_w,
				cd_unimed_prestadora_w,
				nr_cpf_w
			from	pls_prestador
			where	nr_sequencia	= nr_seq_prestador_serv_w;
			
			-- Especialidade PRESTADOR
			if (nr_seq_prestador_serv_w IS NOT NULL AND nr_seq_prestador_serv_w::text <> '') then
				-- Prestador PF
				if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
					select	max(cd_especialidade)
					into STRICT	cd_espec_prest_w
					from	pls_prestador_med_espec
					where	nr_seq_prestador	= nr_seq_prestador_serv_w
					and	cd_pessoa_fisica	= cd_pessoa_fisica_w
					and	ie_especialidade_princ	= 'S'
					and	dt_atual_w between coalesce(dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(dt_fim_vigencia, dt_atual_w));
					
					if (coalesce(cd_espec_prest_w::text, '') = '') then
						select	max(cd_especialidade)
						into STRICT	cd_espec_prest_w
						from	pls_prestador_med_espec
						where	nr_seq_prestador	= nr_seq_prestador_serv_w
						and	cd_pessoa_fisica	= cd_pessoa_fisica_w
						and	dt_atual_w between coalesce(dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(dt_fim_vigencia, dt_atual_w));
					end if;
				-- Prestador PJ
				else
					select	max(cd_especialidade)
					into STRICT	cd_espec_prest_w
					from	pls_prestador_med_espec
					where	nr_seq_prestador	= nr_seq_prestador_serv_w
					and	coalesce(cd_pessoa_fisica::text, '') = ''
					and	ie_especialidade_princ	= 'S'
					and	dt_atual_w between coalesce(dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(dt_fim_vigencia, dt_atual_w));
					
					if (coalesce(cd_espec_prest_w::text, '') = '') then
						select	max(cd_especialidade)
						into STRICT	cd_espec_prest_w
						from	pls_prestador_med_espec
						where	nr_seq_prestador	= nr_seq_prestador_serv_w
						and	coalesce(cd_pessoa_fisica::text, '') = ''
						and	dt_atual_w between coalesce(dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(dt_fim_vigencia, dt_atual_w));
					end if;
				end if;
			end if;
			
			cd_espec_ptu_w := '99';
			-- Especialidade PTU
			if (cd_espec_prest_w IS NOT NULL AND cd_espec_prest_w::text <> '') then
				select	coalesce(max(cd_ptu),'99')
				into STRICT	cd_espec_ptu_w
				from	especialidade_medica
				where	cd_especialidade = cd_espec_prest_w;
			end if;
			
			-- Caso no tenha cdigo
			if (cd_pacote_w = 0) then
				cd_pacote_w := nr_seq_pacote_w;
			end if;
			
			
			nr_seq_pacote_reg_w	:= null;
			if (nr_versao_transacao_w >= 4) then -- Verso 9.0 (superior)
				select	max(nr_sequencia)
				into STRICT	nr_seq_pacote_reg_w
				from	ptu_pacote_reg
				where	cd_pacote	= cd_pacote_w
				and	nr_seq_pacote	= nr_seq_ptu_pacote_w;
				
				-- Versao superior a 9.0
				cd_unimed_prest_w	:= coalesce(cd_unimed_prestadora_w,cd_unimed_orig_prest_w);
				cd_prest_w		:= cd_prest_a400_w;
				nm_prest_w		:= nm_prestador_w;
				ie_tipo_pacote_w	:= 3;
				
				-- Versao abaixo da 9.0
				cd_unimed_origem_w	:= null;
				cd_prest_a400_w		:= null;
				nm_prestador_w		:= null;
			
			-- Versao 8.0 (inferior)
			else
				nm_prestador_w		:= substr(nm_prestador_w,1,40);
				ie_tipo_pacote_w	:= 1;
				cd_unimed_origem_w	:= coalesce(cd_unimed_prestadora_w,cd_unimed_origem_w);
			end if;
			
			ie_tp_pacote_ptu_w := coalesce(ie_tp_pacote_ptu_w, ie_tipo_pacote_w);
			
			select	coalesce(max(ie_contem_hm),'N')
			into STRICT	ie_honorario_pac_w
			from	pls_pacote_procedimento
			where	nr_seq_composicao = nr_seq_composicao_w;

			select	CASE WHEN t.contagem=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_auxiliar_pac_w
			from (	SELECT	count(1) contagem
				from	pls_pacote_procedimento	a,
					pls_grau_participacao	b
				where	b.nr_sequencia		= a.nr_seq_grau_partic_ent
				and	a.nr_seq_composicao	= nr_seq_composicao_w
				and	ie_honorario_pac_w	= 'S'
				and	b.ie_auxiliar		= 'S') t;
			
			if (coalesce(nr_seq_pacote_reg_w::text, '') = '') or
				((coalesce(nr_seq_regra_preco_ant_w::text, '') = '') or (nr_seq_regra_preco_w != nr_seq_regra_preco_ant_w))then
				-- Grid Regras A1200
				insert into ptu_pacote_reg(nr_sequencia,			nr_seq_pacote,							cd_pacote,
					nm_pacote,			cd_unimed_prestador,						cd_prestador,
					nm_prestador,			dt_negociacao,							ie_tipo_acomodacao,
					ie_tipo_pacote,			dt_atualizacao,							nm_usuario,
					dt_publicacao,			cd_especialidade,						ds_observacao,
					ie_tipo_informacao,		nm_usuario_nrec,						dt_atualizacao_nrec,
					dt_inicio_vigencia,		dt_fim_vigencia,						ie_tipo_internacao,
					vl_tot_taxas,			vl_tot_diarias,							vl_tot_gases,
					vl_tot_mat,			vl_tot_med,							vl_tot_proc,
					vl_tot_opme,			vl_tot_pacote,							ie_honorario,
					tipo_rede_min,			versao_pacote,                                                  ie_opme,
					ie_auxiliar,			dt_reajuste,							ie_anestesista,
					nr_seq_tipo_acomodacao)
				values (nextval('ptu_pacote_reg_seq'),	nr_seq_ptu_pacote_w,						cd_pacote_w,
					ds_pacote_w,			cd_unimed_origem_w,						cd_prest_a400_w,
					nm_prestador_w,			coalesce(dt_negociacao_w, coalesce(dt_inicio_vigencia_w, clock_timestamp())),	ie_tp_acomodacao_ptu_w,
					ie_tp_pacote_ptu_w,		clock_timestamp(),							nm_usuario_p,
					clock_timestamp(),			cd_espec_ptu_w,							ds_observacao_w,
					1,				nm_usuario_p,							clock_timestamp(),
					dt_inicio_vigencia_w,		dt_fim_vigencia_w,						ie_tp_internacao_ptu_w,
					0,				0,								0,
					0,				0,								0,
					0,				0,								ie_honorario_pac_w,
					null,				null,                                                           'N',
					ie_auxiliar_pac_w,		dt_reajuste_w,							ie_anestesista_w,
					nr_seq_regra_preco_w) returning nr_sequencia into nr_seq_pacote_reg_w;

				nr_seq_regra_preco_ant_w := nr_seq_regra_preco_w;
				
			end if;
			
			if (nr_versao_transacao_w >= 4) and (nr_seq_prestador_serv_w IS NOT NULL AND nr_seq_prestador_serv_w::text <> '') then

				-- verifica se tem anexo, e busca as inf dele
				if (nr_seq_anexo_w IS NOT NULL AND nr_seq_anexo_w::text <> '') then

					select	max(a.ds_diretorio_arquivo),
						max(a.ie_tipo_anexo)
					into STRICT	ds_diretorio_arquivo_w,
						ie_tipo_anexo_w
					from	pls_pacote_comp_anexo	a
					where	a.nr_sequencia		= nr_seq_anexo_w;

					nr_seq_mesmo_dia_w := lpad(nr_seq_mesmo_dia_w + 1, 2 , '0');
					
					if (ds_diretorio_arquivo_w IS NOT NULL AND ds_diretorio_arquivo_w::text <> '') and (ie_tipo_anexo_w IS NOT NULL AND ie_tipo_anexo_w::text <> '') then
						
						if (ie_tipo_anexo_w = 1) then
						
						ds_anexo_ptu_w := 'PC'||to_char(clock_timestamp(), 'YYMM')||ie_tipo_anexo_w||nr_seq_mesmo_dia_w||substr(ds_diretorio_arquivo_w, instr(ds_diretorio_arquivo_w, '.', -1), length(ds_diretorio_arquivo_w));
						
						elsif (ie_tipo_anexo_w = 2) then
						
						ds_anexo_ptu_w := 'PC'||to_char(clock_timestamp(), 'YYMM')||ie_tipo_anexo_w||lpad(cd_pacote_w,8,'_')||nr_seq_mesmo_dia_w||substr(ds_diretorio_arquivo_w, instr(ds_diretorio_arquivo_w, '.', -1), length(ds_diretorio_arquivo_w));
						
						elsif (ie_tipo_anexo_w = 3) then
						
						ds_anexo_ptu_w := 'PC'||to_char(clock_timestamp(), 'YYMM')||ie_tipo_anexo_w||lpad(coalesce(nr_cpf_w,cd_cgc_w),15,'_')||nr_seq_mesmo_dia_w||substr(ds_diretorio_arquivo_w, instr(ds_diretorio_arquivo_w, '.', -1), length(ds_diretorio_arquivo_w));
						
						elsif (ie_tipo_anexo_w = 4) then
						
						ds_anexo_ptu_w := 'PC'||lpad(case when ie_reajuste_w = 'S' then 'R' else '' end, 1, '_')||to_char(clock_timestamp(), 'YYMM')||ie_tipo_anexo_w||lpad(coalesce(nr_cpf_w,cd_cgc_w),15,'_')||nr_seq_mesmo_dia_w||substr(ds_diretorio_arquivo_w, instr(ds_diretorio_arquivo_w, '.', -1), length(ds_diretorio_arquivo_w));
						
						elsif (ie_tipo_anexo_w = 5) then
							
						ds_anexo_ptu_w := 'PC'||to_char(clock_timestamp(), 'YYMM')||ie_tipo_anexo_w||lpad(cd_pacote_w,8,'_')||lpad(coalesce(nr_cpf_w,cd_cgc_w),15,'_')||nr_seq_mesmo_dia_w||substr(ds_diretorio_arquivo_w, instr(ds_diretorio_arquivo_w, '.', -1), length(ds_diretorio_arquivo_w));							
						
						end if;
					else

						ds_anexo_ptu_w := null;
					end if;
				
				else
					
					ds_diretorio_arquivo_w := null;
					ie_tipo_anexo_w := null;
					ds_anexo_ptu_w := null;

				end if;

				-- apenas permite um prestador por pacote
				select	count(1)
				into STRICT	qt_prest_reg_w

				from	ptu_pacote_prest	a
				where	a.nr_seq_prestador	= nr_seq_prestador_serv_w
				and	a.nr_seq_pacote_reg	= nr_seq_pacote_reg_w;


				if (qt_prest_reg_w = 0) then
					
					insert into ptu_pacote_prest(nr_sequencia,				dt_atualizacao,			nm_usuario,
						dt_atualizacao_nrec,			nm_usuario_nrec,		nr_seq_pacote_reg,
						cd_unimed_prestador,			cd_prestador,			nm_prestador,
						cd_cgc_cpf,				nr_seq_prestador,		cd_cnes_prest,
						id_reajuste,				ds_diretorio_arquivo,		ie_tipo_anexo,
						ds_anexo_ptu)
					values (nextval('ptu_pacote_prest_seq'),		clock_timestamp(),			nm_usuario_p,
						clock_timestamp(),				nm_usuario_p,			nr_seq_pacote_reg_w,
						cd_unimed_prest_w,			cd_prest_w,			nm_prest_w,
						coalesce(nr_cpf_w,cd_cgc_w),                 nr_seq_prestador_serv_w,        cd_cnes_prest_w,
						ie_reajuste_w,				ds_diretorio_arquivo_w,		ie_tipo_anexo_w,
						ds_anexo_ptu_w);
				end if;
					
			end if;

			-- conta se existem procedimentos com o ie_principal informado.
			-- O sql e mais complexo, mas ele retrata justamente o c01, que contem os itens a serem enviados no A1200
			-- Isso e necessario para que a contagem tenha as mesmas restricoes do A1200
			with qt_inf as (	select	count(1) qt_informados
						from 	pls_pacote_procedimento		a,
							pls_pacote_composicao		b,
							pls_pacote			c,
							pls_pacote_tipo_acomodacao	d,
							pls_prestador			e
						where 	((a.nr_seq_pacote = nr_seq_pacote_w)
							or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se n?o encotrar pelo pacote
						and	a.ie_gerar_a1200 	= 'S'
						and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
						and	e.nr_sequencia 		= nr_seq_prestador_serv_w
						and	b.nr_seq_pacote 	= c.nr_sequencia
						and	b.nr_sequencia 		= d.nr_seq_composicao
						and	b.ie_situacao 		= 'A'
						and	d.cd_prestador 		= e.cd_prestador
						and	c.nr_sequencia 		= nr_seq_pacote_w
						and	b.nr_sequencia		= nr_seq_composicao_w
						and	(a.ie_procedimento_princ IS NOT NULL AND a.ie_procedimento_princ::text <> '')
						
union all

						select	count(1) qt_informados
						from 	pls_pacote_procedimento		a,
							pls_pacote_composicao		b,
							pls_pacote			c,
							pls_pacote_tipo_acomodacao	d,
							pls_prestador			e
						where 	((a.nr_seq_pacote = nr_seq_pacote_w)
							or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se n?o encotrar pelo pacote
						and	a.ie_gerar_a1200 	= 'S'
						and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
						and	e.nr_sequencia 		= nr_seq_prestador_serv_w
						and	b.nr_seq_pacote 	= c.nr_sequencia
						and	b.nr_sequencia 		= d.nr_seq_composicao
						and	b.ie_situacao 		= 'A'
						and	d.nr_seq_prestador	= e.nr_sequencia
						and	coalesce(d.cd_prestador::text, '') = ''
						and	c.nr_sequencia 		= nr_seq_pacote_w
						and	b.nr_sequencia		= nr_seq_composicao_w
						and	(a.ie_procedimento_princ IS NOT NULL AND a.ie_procedimento_princ::text <> '')
						
union all

						select 	count(1) qt_informados
						from 	pls_pacote_procedimento		a,
							pls_pacote_composicao		b,
							pls_pacote			c,
							pls_pacote_tipo_acomodacao	d,
							pls_prestador			e
						where 	((a.nr_seq_pacote = nr_seq_pacote_w)
							or(b.nr_seq_pacote = nr_seq_pacote_w AND a.nr_seq_composicao = b.nr_sequencia))-- jjung 21/12/2012 - Buscar pela composicao se n?o encotrar pelo pacote
						and	a.ie_gerar_a1200 	= 'S'
						and	(a.ie_gerar_a1200 IS NOT NULL AND a.ie_gerar_a1200::text <> '')
						and	e.nr_sequencia 		= nr_seq_prestador_serv_w
						and	b.nr_seq_pacote 	= c.nr_sequencia
						and	b.nr_sequencia 		= d.nr_seq_composicao
						and	b.ie_situacao 		= 'A'
						and	coalesce(d.cd_prestador::text, '') = ''
						and	(d.nr_seq_grupo_prestador IS NOT NULL AND d.nr_seq_grupo_prestador::text <> '')
						and	c.nr_sequencia 		= nr_seq_pacote_w
						and	b.nr_sequencia		= nr_seq_composicao_w
						and 	ie_param_12_w		= 'S'
						and	e.nr_sequencia in (	select	x.nr_seq_prestador
										from	table(pls_grupos_pck.obter_prestadores_grupo(d.nr_seq_grupo_prestador))x)
						and	(a.ie_procedimento_princ IS NOT NULL AND a.ie_procedimento_princ::text <> '')
			)
			select	sum(a.qt_informados)
			into STRICT	qt_ie_principal_info_w
			from	qt_inf	a;
			

			Begin
				select	count(1)
				into STRICT	qt_composicao_w
				from	ptu_pacote_servico	
				where	nr_seq_composicao	= nr_seq_composicao_w
				and	nr_seq_pacote_reg	= nr_seq_pacote_reg_w;
				Exception
					When Others Then
            --Se gerar algum erro por qualquer motivo, assume que nao a nenhuma composicao cadastrada e tenta incluir os itens para gerar no A1200
            --Melhor enviar um item repetido e somar um valor a mais do que nao enviar nada por erro/exception de sistema...
						qt_composicao_w := 0;
			End;
			
			if (qt_composicao_w = 0) then

		
				open C01;
				loop
				fetch C01 into	
					cd_servico_w,
					vl_servico_w,
					qt_servico_w,
					ie_origem_proced_w,
					nr_seq_material_w,
					ie_proc_mat_w,
					ds_servico_w,
					ie_honorario_w,
					nr_seq_grau_partic_w,
                                        cd_unidade_medida_w,
					ie_procedimento_princ_w,
					ie_proc_alternativo_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin

					ie_tipo_despesa_w := null;
					
					cd_procedimento_w	:= null;
					ie_origem_proced_conv_w	:= null;
					cd_servico_mat_w	:= null;
					cd_mat_number_inter_w	:= null;
					ds_servico_orig_w	:= null;
					
					if (ie_proc_mat_w = 'P') then
						select 	coalesce(max(ie_classificacao),0)
						into STRICT	ie_tipo_despesa_w
						from	procedimento
						where	cd_procedimento		= cd_servico_w
						and	ie_origem_proced	= ie_origem_proced_w;
						
						ie_tipo_item_w := 6;
						ie_tipo_participacao_w := '0';
						if (ie_tipo_despesa_w  = 1) then
							ie_tipo_tabela_w	:= 0;
							ie_tipo_participacao_w	:= '0';
							
						elsif (ie_tipo_despesa_w = 2) then
							ie_tipo_tabela_w	:= 1;
							ie_tipo_item_w		:= 1;
							ie_tipo_participacao_w	:= 'H';
							
						elsif (ie_tipo_despesa_w = 3) then
							ie_tipo_tabela_w	:= 1;
							ie_tipo_item_w		:= 2;
							ie_tipo_participacao_w	:= 'H';
							
						elsif (ie_tipo_despesa_w = 4) then -- pacote
							ie_tipo_tabela_w	:= 1;
						end if;
						
					elsif (ie_proc_mat_w = 'M') then					
						select 	coalesce(coalesce(substr(max(cd_material_ops),1,8), cd_servico_w),'0'),
							coalesce(max(ie_tipo_despesa),0)
						into STRICT	cd_servico_w,
							ie_tipo_despesa_w
						from	pls_material
						where	nr_sequencia	= nr_seq_material_w;
						
		
						select	coalesce(max(t.ie_codificacao), '1')
						into STRICT	ie_codificacao_w
						from (	SELECT	b.ie_codificacao,
								row_number() OVER () AS nr_linha
							from	pls_material_a900	a,
								pls_material_unimed	b
							where	b.nr_sequencia		= a.nr_seq_material_unimed
							and	a.nr_seq_material	= nr_seq_material_w
							and	a.dt_inicio_vigencia	<= fim_dia(clock_timestamp())
							and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (a.dt_fim_vigencia >= trunc(clock_timestamp(), 'dd')))
							order by a.dt_inicio_vigencia desc ) t
						where t.nr_linha = 1;
						
						
						ie_tipo_item_w		:= 4;
						ie_tipo_participacao_w	:= '0';
						if (ie_tipo_despesa_w = 1) then
						
							-- Trata conforme o tipo de codificacao no A900
							if (ie_codificacao_w = '1') then
							
								-- TNUMM Materiais
								ie_tipo_tabela_w	:= 2;
							else
								-- TUSS Materiais
								ie_tipo_tabela_w	:= 5;
							end if;
							
							ie_tipo_item_w		:= 3;
							
						elsif (ie_tipo_despesa_w = 2) then
						
							-- Trata conforme o tipo de codificacao no A900
							if (ie_codificacao_w = '1') then
							
								-- TNUMM Medicamentos
								ie_tipo_tabela_w	:= 3;
							else
								-- TUSS Medicamentos
								ie_tipo_tabela_w	:= 6;
							end if;
							
							ie_tipo_item_w		:= 5;
							
						elsif (ie_tipo_despesa_w = 3) then
						
							-- Trata conforme o tipo de codificacao no A900
							if (ie_codificacao_w = '1') then
							
								-- TNUMM Materiais
								ie_tipo_tabela_w	:= 2;
							else
								-- TUSS Materiais
								ie_tipo_tabela_w	:= 5;
							end if;
							
							ie_tipo_item_w		:= 4;
							
						elsif (ie_tipo_despesa_w = 7) then
						
							-- Trata conforme o tipo de codificacao no A900
							if (ie_codificacao_w = '1') then
							
								-- TNUMM Materiais
								ie_tipo_tabela_w	:= 2;
							else
								-- TUSS Materiais
								ie_tipo_tabela_w	:= 5;
							end if;
							
							ie_tipo_item_w		:= 7;					
						end if;
					end if;		

					-- por padrao, sera considerado 2 - composicao, e entao avaliado a classificacao definitiva
					ie_principal_w := 2;		
					
					if (ie_tipo_tabela_w = 1) then -- 1 = Servicos Hospitalares / Taxas / Complementos (Codigos da Tabela C ? Anexo 01)
						ie_principal_w := 2; -- 2 = Composicao
					
						-- se nao possuir algum item com o principal informado (qt_ie_principal_info_w), entao
						-- permanece o tratamento anterior -- 0 = Rol de Procedimentos Unimed
						-- ou se o item atual for S
						-- adicionado tratamento para proc alternativo, como pode ser do mesmo tipo de tabela do proc princ, tem que verificar se nao e alternativo antes de atribuir como principal
					elsif	(ie_tipo_tabela_w = 0 AND qt_ie_principal_info_w = 0) or
						(ie_procedimento_princ_w = 'S' AND ie_proc_alternativo_w = 'N') then 
						ie_principal_w := 1; -- 1 = Principal
						
					elsif (ie_proc_alternativo_w = 'S') then
						
						ie_principal_w := 3; -- 3 = Alternativo
						
					elsif (ie_tipo_tabela_w = 2) or -- 2 = Materiais (Codigos da Tabela E ? Anexo 01)
						(ie_tipo_tabela_w = 3) or -- 3 = Medicamentos (Codigos da Tabela D ? Anexo 01)
						(ie_tipo_tabela_w = 5) or -- TUSS Materiais
						(ie_tipo_tabela_w = 6) then -- TUSS Medicamentos
						
						ie_principal_w := 2; -- 2 = Composicao
					end if;
					
					if (ie_proc_mat_w = 'P') then
					
						if (cd_servico_w IS NOT NULL AND cd_servico_w::text <> '') then
							select	ds_procedimento
							into STRICT	ds_servico_orig_w
							from	procedimento
							where	cd_procedimento	= cd_servico_w
							and	ie_origem_proced = ie_origem_proced_w;
						end if;
					
						SELECT * FROM pls_obter_proced_conversao(	cd_servico_w, ie_origem_proced_w, null, cd_estabelecimento_w, 7, null, 3, 'E', null, null, null, null, null, cd_procedimento_w, ie_origem_proced_conv_w, nr_seq_regra_conv_w, ie_somente_codigo_w, clock_timestamp(), null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_conv_w, nr_seq_regra_conv_w, ie_somente_codigo_w;
					
						if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then
						
							cd_servico_w 	   := cd_procedimento_w;
							ie_origem_proced_w := ie_origem_proced_conv_w;	
						
						end if;
					
					else
						--utilizado mais adiante para verificar se tem conversao a900
						nr_seq_material_temp_w	:= nr_seq_material_w;
					
						select	count(1)
						into STRICT	qt_regra_w
						from	pls_conversao_proc
						where	(cd_material_imp IS NOT NULL AND cd_material_imp::text <> '')
						and	ie_situacao = 'A'
						and	ie_ptu = 'S';
						
						select	max(ds_material)
						into STRICT	ds_servico_orig_w
						from	pls_material
						where	nr_sequencia = nr_seq_material_w;
						
						if (qt_regra_w > 0) then
							cd_mat_number_inter_w := somente_numero(cd_servico_w);
						
							SELECT * FROM pls_obter_proced_conversao(	null, null, null, cd_estabelecimento_w, 7, null, 3, 'E', null, null, null, cd_mat_number_inter_w, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_regra_conv_w, ie_somente_codigo_w, clock_timestamp(), null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w, nr_seq_regra_conv_w, ie_somente_codigo_w;
											
							if (nr_seq_regra_conv_w IS NOT NULL AND nr_seq_regra_conv_w::text <> '') then
								cd_servico_w := substr(cd_procedimento_w, 1, 8);
								
								select	substr(ds_proc_envio, 1, 80)
								into STRICT	ds_servico_w
								from	pls_conversao_proc
								where	nr_sequencia = nr_seq_regra_conv_w;
							else

								ds_servico_w	:= substr(ds_servico_orig_w, 1, 80);
							end if;
							
							if (coalesce(ie_somente_codigo_w, 'N') = 'S') then
								ds_servico_w := substr(ds_servico_orig_w, 1, 80);
							end if;
						end if;
						
						if (coalesce(cd_procedimento_w::text, '') = '') then
					
							SELECT * FROM ptu_obter_material_conversao(	cd_servico_w, ie_tipo_tabela_w, clock_timestamp(), 'E', '8', ie_tipo_despesa_w, null, nr_seq_material_w, cd_servico_mat_w, ie_somente_codigo_w) INTO STRICT nr_seq_material_w, cd_servico_mat_w, ie_somente_codigo_w;
						else
						
							cd_servico_w 	   := cd_procedimento_w;
							ie_origem_proced_w := ie_origem_proced_conv_w;	
							
						end if;
										
						if (cd_servico_mat_w IS NOT NULL AND cd_servico_mat_w::text <> '') then
						
							cd_servico_w := cd_servico_mat_w;					
						end if;
						
						if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
							select	cd_material,
								substr(coalesce(ds_material, nm_material), 1, 80)
							into STRICT	cd_servico_w,
								ds_servico_w
							from	pls_material_unimed
							where	nr_sequencia = nr_seq_material_w;
												
						elsif (coalesce(nr_seq_material_w::text, '') = '') and (cd_servico_mat_w IS NOT NULL AND cd_servico_mat_w::text <> '') then
							
							select	max(substr(coalesce(ds_material, nm_material), 1, 80)),
								max(nr_sequencia)
							into STRICT	ds_servico_w,
								nr_seq_material_w
							from	pls_material_unimed
							where	cd_material = cd_servico_mat_w;
							
							if (coalesce(nr_seq_material_w::text, '') = '') then
								select	max(substr(coalesce(ds_material, nm_material), 1, 80)),
									max(nr_sequencia)
								into STRICT	ds_servico_w,
									nr_seq_material_w
								from	pls_material_unimed
								where	cd_anterior_material = cd_servico_mat_w;
								
								if (coalesce(nr_seq_material_w::text, '') = '') then
									select	max(substr(coalesce(ds_material, nm_material), 1, 80)),
										max(nr_sequencia)
									into STRICT	ds_servico_w,
										nr_seq_material_w
									from	pls_material_unimed
									where	cd_anterior_medicamento	= cd_servico_mat_w;
								end if;
							end if;
										
						end if;
						
						if (coalesce(ie_somente_codigo_w, 'N') = 'S') then
							ds_servico_w := substr(ds_servico_orig_w, 1, 80);
						end if;
						
						if (ie_material_intercambio_w = 'CI') then
							
							cd_servico_a900_w	:= null;
							cd_servico_temp_w	:= cd_servico_w;
							
							SELECT * FROM pls_obter_mat_a900_vigente(nr_seq_material_temp_w, clock_timestamp(), cd_servico_a900_w, null) INTO STRICT nr_seq_material_temp_w, cd_servico_a900_w;
							
							cd_servico_temp_w := somente_numero(cd_servico_a900_w);
							if (cd_servico_temp_w = 0) then
								cd_servico_temp_w := null;
							
							end if;
							
							if (coalesce(cd_servico_temp_w::text, '') = '') and (qt_cad_mat_a900_w = 0) then
								select	nr_seq_material_unimed
								into STRICT	nr_seq_mat_unimed_w
								from	pls_material
								where	nr_sequencia = nr_seq_material_w;
								
								if (nr_seq_mat_unimed_w IS NOT NULL AND nr_seq_mat_unimed_w::text <> '') then
									select	cd_material
									into STRICT	cd_servico_temp_w
									from	pls_material_unimed
									where	nr_sequencia = nr_seq_mat_unimed_w;
									
									
								end if;
							end if;
							
							-- Conversao pela gestao de materiais tem prioridade sobre a convesao cadastrada nas cooperativas medicas, caso encontrar uma conversao valida na gestao de materiais, cd_servico e nr_seq_material sera sobrescrito
							if (cd_servico_temp_w IS NOT NULL AND cd_servico_temp_w::text <> '') then
								cd_servico_w := cd_servico_temp_w;
							end if;
							
							if (nr_seq_material_temp_w IS NOT NULL AND nr_seq_material_temp_w::text <> '') and (cd_servico_temp_w IS NOT NULL AND cd_servico_temp_w::text <> '') then
								nr_seq_material_w	:= nr_seq_material_temp_w;
								ds_servico_w		:= substr(pls_obter_desc_material(nr_seq_material_w), 1, 80); --pode ter obtido outra sequencia de material
							end if;
						end if;
				
					end if;
					
					if (somente_numero(cd_servico_w) != 0) then
					
						-- Grid  Servicos A1200					
						insert into ptu_pacote_servico(nr_sequencia,			ie_tipo_tabela,		cd_servico,
							qt_servico,			ie_honorario,		ie_principal, 	
							ie_tipo_item,			dt_atualizacao,		nm_usuario,
							nr_seq_pacote_reg,		ie_tipo_participacao,	vl_servico,
							nm_usuario_nrec,		dt_atualizacao_nrec,	ds_servico,
                                                        cd_unidade_medida,		nr_seq_composicao)
						values (nextval('ptu_pacote_servico_seq'),ie_tipo_tabela_w,	cd_servico_w,
							qt_servico_w,			ie_honorario_w,		ie_principal_w,
							ie_tipo_item_w,			clock_timestamp(),		nm_usuario_p,
							nr_seq_pacote_reg_w,		ie_tipo_participacao_w,	vl_servico_w,
							nm_usuario_p,			clock_timestamp(),		ptu_somente_caracter_permitido(substr(ds_servico_w,1,80),'ANS'),
                                                        cd_unidade_medida_w,		nr_seq_composicao_w);

						
						
						update	ptu_pacote_reg
						set	vl_tot_taxas	= vl_tot_taxas		+ CASE WHEN ie_tipo_item_w=1 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_diarias	= vl_tot_diarias	+ CASE WHEN ie_tipo_item_w=2 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_gases	= vl_tot_gases		+ CASE WHEN ie_tipo_item_w=3 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_mat	= vl_tot_mat		+ CASE WHEN ie_tipo_item_w=4 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_med	= vl_tot_med		+ CASE WHEN ie_tipo_item_w=5 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_proc	= vl_tot_proc		+ CASE WHEN ie_tipo_item_w=6 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_opme	= vl_tot_opme		+ CASE WHEN ie_tipo_item_w=7 THEN vl_servico_w  ELSE 0 END ,
							vl_tot_pacote	= vl_tot_pacote		+ vl_servico_w,
							ie_opme		= CASE WHEN ie_tipo_item_w=7 THEN  'S'  ELSE ie_opme END
						where	nr_sequencia	= nr_seq_pacote_reg_w;
					end if;
					
					end;
				end loop;
				close C01;
			end if;	
			-- ################## Este trecho e para clientes que trabalham com procedimento fora do pacote, onde dependem de regra de conversao ##################
			select	count(1)
			into STRICT	qt_registro_w
			from	ptu_pacote_servico
			where	nr_seq_pacote_reg	= nr_seq_pacote_reg_w
			and	ie_tipo_tabela		= 0 -- Procedimento
			and	ie_principal		= 1;-- Principal
			
			-- Caso nao tenha procedimento principal
			if (qt_registro_w = 0) and (nr_seq_pacote_reg_w IS NOT NULL AND nr_seq_pacote_reg_w::text <> '')  then

				
				-- Verificar procedimento
				select	max(rc.nr_sequencia)
				into STRICT	nr_seq_regra_conv_pac_w
				from	pls_regra_conversao_pacote	rc,
					pls_conversao_pacote		c
				where	rc.nr_sequencia	= c.nr_seq_regra
				and	c.nr_seq_pacote = nr_seq_pacote_w
				and	rc.ie_situacao	= 'A'
				and	c.ie_situacao	= 'A'
				and	(rc.cd_procedimento IS NOT NULL AND rc.cd_procedimento::text <> '')
				and	dt_atual_w between coalesce(c.dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(c.dt_fim_vigencia, dt_atual_w));	
				
				-- Obter procedimento
				if (nr_seq_regra_conv_pac_w IS NOT NULL AND nr_seq_regra_conv_pac_w::text <> '') then
					select	cd_procedimento,
						ptu_somente_caracter_permitido(substr(obter_desc_procedimento(cd_procedimento,ie_origem_proced),1,80),'ANS') ds_servico
					into STRICT	cd_servico_w,
						ds_servico_w
					from	pls_regra_conversao_pacote
					where	nr_sequencia	= nr_seq_regra_conv_pac_w;
				
					-- Grid  Servicos A1200
					insert into ptu_pacote_servico(nr_sequencia,			ie_tipo_tabela,		cd_servico,
						qt_servico,			ie_honorario,		ie_principal, 	
						ie_tipo_item,			dt_atualizacao,		nm_usuario,
						nr_seq_pacote_reg,		ie_tipo_participacao,	vl_servico,
						nm_usuario_nrec,		dt_atualizacao_nrec,	ds_servico,
						nr_seq_composicao)
					values (nextval('ptu_pacote_servico_seq'),0,			cd_servico_w,
						1,				ie_honorario_w,		1,
						6,				clock_timestamp(),		nm_usuario_p,
						nr_seq_pacote_reg_w,		'0',			0,
						nm_usuario_p,			clock_timestamp(),		ds_servico_w,
						nr_seq_composicao_w);
				end if;
				
				if (coalesce(nr_seq_regra_conv_pac_w::text, '') = '') then
					-- Verificar se tem abertura de procedimento por grupo
					select	max(rc.nr_seq_grupo_proc)
					into STRICT	nr_seq_grupo_proc_w
					from	pls_regra_conversao_pacote	rc,
						pls_conversao_pacote		c
					where	rc.nr_sequencia	= c.nr_seq_regra
					and	c.nr_seq_pacote = nr_seq_pacote_w
					and	rc.ie_situacao	= 'A'
					and	c.ie_situacao	= 'A'
					and	(rc.nr_seq_grupo_proc IS NOT NULL AND rc.nr_seq_grupo_proc::text <> '')
					and	dt_atual_w between coalesce(c.dt_inicio_vigencia, dt_atual_w) and fim_dia(coalesce(c.dt_fim_vigencia, dt_atual_w));

					if (nr_seq_grupo_proc_w IS NOT NULL AND nr_seq_grupo_proc_w::text <> '') then
						qt_registro_w := 0;
						for r_c03_w in c03( nr_seq_grupo_proc_w ) loop
							insert into ptu_pacote_servico(nr_sequencia,			ie_tipo_tabela,		cd_servico,
								qt_servico,			ie_honorario,		ie_principal, 	
								ie_tipo_item,			dt_atualizacao,		nm_usuario,
								nr_seq_pacote_reg,		ie_tipo_participacao,	vl_servico,
								nm_usuario_nrec,		dt_atualizacao_nrec,	ds_servico)
							values (nextval('ptu_pacote_servico_seq'),0,			r_c03_w.cd_servico,
								1,				'N',			CASE WHEN qt_registro_w=0 THEN 1  ELSE 3 END ,
								6,				clock_timestamp(),		nm_usuario_p,
								nr_seq_pacote_reg_w,		'0',			0,
								nm_usuario_p,			clock_timestamp(),		r_c03_w.ds_servico);
							qt_registro_w := 1;
						end loop;
					end if;
				end if;
			end if;
			-- ################## Este trecho e para clientes que trabalham com procedimento fora do pacote, onde dependem de regra de conversao ##################
	
			end if;
		end loop;
		
	close C04;
		
	
	select	count(1)
	into STRICT	qt_pac_servico_w
	from	ptu_pacote_servico	a,
		ptu_pacote_reg		b
	where	b.nr_sequencia	= a.nr_seq_pacote_reg
	and	b.nr_seq_pacote	= nr_seq_ptu_pacote_w;
	

	delete	FROM ptu_pacote_reg x
	where	x.nr_seq_pacote	= nr_seq_ptu_pacote_w
	and	not exists (SELECT	1
				from	ptu_pacote_servico a
				where	x.nr_sequencia	= a.nr_seq_pacote_reg);
	
	if ( qt_pac_servico_w = 0) then
		delete	FROM ptu_pacote_reg
		where	nr_seq_pacote	= nr_seq_ptu_pacote_w;

	end if;
	
	end;
end loop;
close C00;

	if ( qt_pac_servico_w = 0) then
		
		delete	FROM ptu_pacote
		where	nr_sequencia	= nr_seq_ptu_pacote_w;
	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_pacote_a1200 ( nr_seq_pacote_p text, nm_usuario_p text) FROM PUBLIC;

