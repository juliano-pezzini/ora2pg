-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_prescr_mipres ( nr_prescricao_p PRESCR_MIPRES.NR_PRESCRICAO%TYPE, nr_atendimento_p PRESCR_MIPRES.nr_atendimento%TYPE, ie_forcar_geracao_p text default 'N') AS $body$
DECLARE


TYPE prescr_mipres_v_type IS TABLE OF CPOE_ITENS_MIPRES_V%rowtype INDEX BY integer;
TYPE prescr_mipres_type   IS TABLE OF PRESCR_MIPRES%rowtype INDEX BY integer;
prescr_mipres_v_row       prescr_mipres_v_type;
prescr_mipres_row         prescr_mipres_type;
dt_atual_s                CONSTANT PRESCR_MIPRES.DT_ATUALIZACAO%TYPE := clock_timestamp();
ie_eps_w                  CONVENIO_PLANO.IE_EPS%TYPE;
item_w  			prescr_mipres.nr_sequencia%type;
BEGIN

  SELECT coalesce(max(a.IE_EPS),'N')
  INTO STRICT   ie_eps_w
  FROM   CONVENIO_PLANO a
  WHERE  a.cd_plano = obter_plano_convenio_atend(nr_atendimento_p,'C')
  AND    a.cd_convenio = obter_convenio_atendimento(nr_atendimento_p);

  IF (ie_eps_w = 'S') THEN

    SELECT *
    BULK   COLLECT INTO STRICT prescr_mipres_v_row
    FROM   CPOE_ITENS_MIPRES_V a
    WHERE  ((nr_prescricao_p > 0 AND a.nr_prescricao = nr_prescricao_p AND coalesce(a.nr_seq_receita_amb::text, '') = '')
           OR (coalesce(a.nr_prescricao::text, '') = '' AND a.nr_atendimento = nr_atendimento_p AND (a.nr_seq_receita_amb IS NOT NULL AND a.nr_seq_receita_amb::text <> '')))
    AND NOT EXISTS (
           SELECT 1
           FROM   PRESCR_MIPRES b
           WHERE  b.nr_prescricao     = nr_prescricao_p
           AND    b.nr_atendimento    = nr_atendimento_p
           AND    b.nr_seq_item_cpoe  = a.nr_seq_item_cpoe
           AND    b.nr_seq_item_presc = a.nr_seq_item_presc
		   OR	  ie_forcar_geracao_p = 'S'
    )
    AND    a.ie_nopbs = 'S';

    IF (prescr_mipres_v_row.FIRST IS NOT NULL AND prescr_mipres_v_row.FIRST::text <> '') THEN
      FOR i IN prescr_mipres_v_row.FIRST..prescr_mipres_v_row.LAST LOOP
          prescr_mipres_row[i].nr_sequencia        := obter_nextval_sequence('PRESCR_MIPRES');
          prescr_mipres_row[i].dt_atualizacao      := dt_atual_s;
          prescr_mipres_row[i].dt_atualizacao_nrec := dt_atual_s;
          prescr_mipres_row[i].nm_usuario          := wheb_usuario_pck.get_nm_usuario;
          prescr_mipres_row[i].nm_usuario_nrec     := wheb_usuario_pck.get_nm_usuario;
          prescr_mipres_row[i].ie_status           := '1';
          prescr_mipres_row[i].nr_atendimento      := nr_atendimento_p;
          prescr_mipres_row[i].nr_prescricao       := prescr_mipres_v_row[i].nr_prescricao;
          prescr_mipres_row[i].nr_seq_item_presc   := prescr_mipres_v_row[i].nr_seq_item_presc;
          prescr_mipres_row[i].ie_tipo_item_presc  := prescr_mipres_v_row[i].ie_tipo_item_presc;
          prescr_mipres_row[i].nr_seq_item_cpoe    := prescr_mipres_v_row[i].nr_seq_item_cpoe;
          prescr_mipres_row[i].nr_seq_receita_amb  := prescr_mipres_v_row[i].nr_seq_receita_amb;
          prescr_mipres_row[i].nr_seq_item_receita_amb := prescr_mipres_v_row[i].nr_seq_item_receita_amb;
          prescr_mipres_row[i].ie_conselho_medico  := prescr_mipres_v_row[i].ie_conselho_medico;
          prescr_mipres_row[i].cd_pessoa_fisica := prescr_mipres_v_row[i].cd_pessoa_fisica;

          IF ((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') AND prescr_mipres_v_row[i]coalesce(.nr_seq_receita_amb::text, '') = '') THEN
            prescr_mipres_row[i].ie_pendency_origin  := 'PRESC';
          ELSIF (prescr_mipres_v_row[i](.nr_seq_receita_amb IS NOT NULL AND .nr_seq_receita_amb::text <> '')) THEN
            prescr_mipres_row[i].ie_pendency_origin  := 'REC';
          END IF;

          IF (coalesce(prescr_mipres_v_row[i].ie_conselho_medico, 'N') = 'S') THEN
            prescr_mipres_row[i].ie_aval_junta_prof  := 2;
          ELSE
            prescr_mipres_row[i].ie_aval_junta_prof  := 1;
          END IF;

		  if (ie_forcar_geracao_p = 'S') then
			  prescr_mipres_row[i].nr_seq_superior := null;
		  elsif (prescr_mipres_row[i](.nr_sequencia IS NOT NULL AND .nr_sequencia::text <> '') and prescr_mipres_row[i](.nr_seq_item_cpoe IS NOT NULL AND .nr_seq_item_cpoe::text <> '')) then
			  select    max(a.nr_sequencia)
			  into STRICT      item_w
			  from		prescr_mipres a
			  where		nr_seq_item_cpoe = prescr_mipres_row[i].nr_seq_item_cpoe
			  and		coalesce(nr_seq_superior::text, '') = ''
			  and		ie_tipo_item_presc = prescr_mipres_row[i].ie_tipo_item_presc;

              if (item_w IS NOT NULL AND item_w::text <> '') then
                  prescr_mipres_row[i].nr_seq_superior := item_w;
              end if;
          end if;

      END LOOP;
    END IF;

    IF (prescr_mipres_row.FIRST IS NOT NULL AND prescr_mipres_row.FIRST::text <> '') THEN

      FORALL i IN prescr_mipres_row.FIRST..prescr_mipres_row.LAST
        INSERT INTO PRESCR_MIPRES VALUES prescr_mipres_row(i);
      COMMIT;

      FOR i IN prescr_mipres_row.FIRST..prescr_mipres_row.LAST LOOP
		if (prescr_mipres_row[i]coalesce(.nr_seq_superior::text, '') = '') then
			CALL SET_TASK_LIST_MIPRES('I', nr_atendimento_p, prescr_mipres_row[i].nr_prescricao, prescr_mipres_row[i].nr_sequencia, wheb_usuario_pck.get_nm_usuario);
		end if;
      END LOOP;

    END IF;

  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_prescr_mipres ( nr_prescricao_p PRESCR_MIPRES.NR_PRESCRICAO%TYPE, nr_atendimento_p PRESCR_MIPRES.nr_atendimento%TYPE, ie_forcar_geracao_p text default 'N') FROM PUBLIC;

