-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alvaro_gravar_result_lab_rtf ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_resultado_p text, nr_sequencia_p INOUT bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, ie_final_p text default 'S', cd_exame_integracao_p text default null, ie_atualizar_rtf_p text default 'N') AS $body$
DECLARE


cd_procedimento_w	   bigint;
ie_origem_proced_w   bigint;
dt_coleta_w		       timestamp;
ie_formato_texto_w   smallint	:= 1;
nr_seq_exame_w		   bigint	:= null;
i					           integer;
ds_resultado_w		   varchar(32767);
ie_cobranca_w		     varchar(1) := 'N';
cd_estabelecimento_w smallint;
qt_proc_exec_w		   bigint;
ie_conta_res_w		   varchar(1);
nr_sequencia_w			 result_laboratorio.nr_sequencia%type;


BEGIN
  select cd_procedimento, ie_origem_proced
    into STRICT cd_procedimento_w, ie_origem_proced_w
    from prescr_procedimento
   where nr_prescricao = nr_prescricao_p
     and nr_sequencia  = nr_seq_prescr_p;

  begin
    select max(coalesce(to_date(lab_obter_data_recoleta(nr_prescricao_p,nr_seq_prescr_p,nm_usuario_p,0),'dd/mm/yyyy hh24:mi:ss') ,(b.dt_coleta)))
      into STRICT dt_coleta_w
      from exame_lab_result_item b, exame_lab_resultado a
     where a.nr_seq_resultado	= b.nr_seq_resultado
       and a.nr_prescricao		= nr_prescricao_p
       and b.nr_seq_prescr		= nr_seq_prescr_p
       and (b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');
  exception
	when others then
    dt_coleta_w	:= null;
  end;

  if (position('<HTML>' in upper(ds_resultado_p)) > 0) and (position('</HTML>' in upper(ds_resultado_p)) > 0) then
    ie_formato_texto_w	:= 2;
  end if;

  ds_resultado_w	:= ds_resultado_p;
  if (substr(ds_resultado_p,1,13) = 'NR_SEQ_EXAME=') then
    i := position(';' in ds_resultado_p);
    nr_seq_exame_w	:= (substr(ds_resultado_p,14,i-14))::numeric;
    ds_resultado_w	:= substr(ds_resultado_w, i + 1, length(ds_resultado_w));

    delete FROM result_laboratorio
     where nr_prescricao	= nr_prescricao_p
       and nr_seq_prescricao = nr_seq_prescr_p
       and nr_seq_exame	= nr_seq_exame_w;
  end if;

  select	max(coalesce(cd_estabelecimento,1))
  into STRICT	cd_estabelecimento_w
  from	prescr_medica
  where 	nr_prescricao = nr_prescricao_p;

  select	max(coalesce(ie_gerar_cobranca_result,'N'))
  into STRICT	ie_conta_res_w
  from	lab_parametro
  where	cd_estabelecimento = cd_estabelecimento_w;

  if (ie_conta_res_w = 'S') then
    select	count(*)
    into STRICT	qt_proc_exec_w
    from	procedimento_paciente
    where	nr_prescricao = nr_prescricao_p
    and		nr_sequencia_prescricao = nr_seq_prescr_p;

    if (qt_proc_exec_w = 0) then
      ie_cobranca_w := 'S';
    end if;
  end if;

  begin
    if (ie_atualizar_rtf_p = 'N') then
      insert into result_laboratorio(NR_PRESCRICAO, NR_SEQ_PRESCRICAO, NM_USUARIO, IE_COBRANCA, IE_ORIGEM_PROCED, CD_PROCEDIMENTO,DS_RESULTADO, DT_COLETA,
                                      IE_FORMATO_TEXTO, NR_SEQ_EXAME, IE_FINAL, CD_EXAME_INTEGRACAO)
                              values (nr_prescricao_p, nr_seq_prescr_p, nm_usuario_p, ie_cobranca_w, ie_origem_proced_w, cd_procedimento_w, ds_resultado_w, dt_coleta_w,
                                      ie_formato_texto_w, nr_seq_exame_w, ie_final_p, cd_exame_integracao_p);
    else
      update	result_laboratorio set
              ds_resultado = ds_resultado_w
      where	nr_prescricao = nr_prescricao_p
      and	nr_seq_prescricao = nr_seq_prescr_p;
    end if;

    commit;
  exception
	when others then
    cd_erro_p	:= 1;
		ds_erro_p	:= substr(OBTER_DESC_EXPRESSAO(777258)||' '||sqlerrm,1,2000);
  end;

	select max(a.nr_sequencia)
   into STRICT nr_sequencia_w
  from result_laboratorio a
  where a.nr_prescricao = nr_prescricao_p
   and a.nr_seq_prescricao = nr_seq_prescr_p;

  nr_sequencia_p	:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alvaro_gravar_result_lab_rtf ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_resultado_p text, nr_sequencia_p INOUT bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, ie_final_p text default 'S', cd_exame_integracao_p text default null, ie_atualizar_rtf_p text default 'N') FROM PUBLIC;

