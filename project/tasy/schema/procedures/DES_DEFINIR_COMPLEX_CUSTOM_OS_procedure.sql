-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_definir_complex_custom_os (nr_seq_complex_p bigint, nr_sequencia_p bigint, qt_hora_p bigint, nr_seq_integracao_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ie_tipo_customizacao_p text default 'C', ds_detalhamento_p text default null) AS $body$
DECLARE


vl_hora_w		des_regra_cobranca_rel_os.vl_hora%type;
qt_hora_w		des_complexidade_custom.qt_hora_padrao%type;
nm_pessoa_sol_w		pessoa_fisica.nm_pessoa_fisica%Type;
nr_seq_idioma_w		pessoa_juridica.nr_seq_idioma%type;
nr_seq_orc_w		man_ordem_servico_orc.nr_sequencia%type;
nr_seq_cliente_w	man_ordem_servico.nr_seq_cliente%type;
nr_seq_localizacao_w	man_ordem_servico.nr_seq_localizacao%type;
nr_seq_tipo_ordem_w	man_ordem_servico.nr_seq_tipo_ordem%type := 431;
ds_texto_padrao_w	man_ordem_serv_tecnico.ds_relat_tecnico%Type;
ie_tipo_orcamento_w	man_ordem_servico_orc.ie_tipo_orcamento%type := ie_tipo_customizacao_p;
ds_item_orc_w		man_ord_serv_orc_item.ds_item%type;
cd_unidade_medida_w	man_ord_serv_orc_item.cd_unidade_medida%type;
qt_existe_w		man_ordem_servico_exec.nr_sequencia%TYPE;
nr_seq_tipo_hist_w	man_tipo_hist.nr_sequencia%TYPE := 34;
nr_seq_estagio_w	man_estagio_processo.nr_sequencia%type := 2843;
nr_seq_integ_w		int_integracao.nr_sequencia%TYPE;
ie_implantacao_w	int_integracao.ie_implantacao%TYPE;
qt_horas_suporte_w	int_integracao.qt_horas_suporte%TYPE;
qt_horas_implantacao_w	int_integracao.qt_horas_implantacao%type;
qt_horas_desenv_imp_w	int_integracao.qt_horas_desenv_imp%TYPE;
qt_horas_tec_imp_w	int_integracao.qt_horas_tec_imp%TYPE;
ds_integracao_w		man_ordem_servico_orc.ds_observacao%TYPE;
ds_comunic_w		man_ordem_serv_envio.ds_observacao%TYPE;
ds_email_w		usuario.ds_email%TYPE;
nm_usuario_gestor_w	usuario.nm_usuario%TYPE;
ds_macro_w		man_ordem_servico_orc.ds_observacao%TYPE;
ds_historico_w		man_ordem_servico_orc.ds_observacao%TYPE;
qt_horas_adicionais_w	double precision;
ie_cliente_ok_w		varchar(1);
ds_titulo_w		varchar(255);


BEGIN

if (nr_sequencia_p > 0) then
	nr_seq_integ_w	:= coalesce(nr_seq_integracao_p,0);

	select	nr_seq_cliente,
		substr(obter_nome_pf(cd_pessoa_solicitante),1,60),
		nr_seq_localizacao
	into STRICT	nr_seq_cliente_w,
		nm_pessoa_sol_w,
		nr_seq_localizacao_w
	from	man_ordem_servico
	where	nr_sequencia	= nr_sequencia_p;

	select	coalesce(max(b.nr_seq_idioma),1)
	into STRICT	nr_seq_idioma_w
	from	man_localizacao a,
		pessoa_juridica b
	where	a.cd_cnpj = b.cd_cgc
	and	a.nr_sequencia = nr_seq_localizacao_w;

	if (nr_seq_integ_w > 0) then
		nr_seq_tipo_ordem_w := 433;
		ie_tipo_orcamento_w := 'I';

		select	substr(obter_desc_exp_idioma(963263,nr_seq_idioma_w, 'DS_TITULO=' || ds_titulo), 1, 4000),     /* Referente a integracao */
			coalesce(qt_horas_implantacao,0)
		into STRICT	ds_integracao_w,
			qt_horas_implantacao_w
		from	int_integracao
		where	nr_sequencia = nr_seq_integ_w;
	end if;

	if (des_obter_se_cliente_cobra_rel(nr_seq_cliente_w, 'C') = 'N') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(257739);
	end if;

	ie_cliente_ok_w := des_consiste_dados_adm_cliente(	nr_sequencia_p, nm_usuario_p, ie_cliente_ok_w);

	if (ie_cliente_ok_w = 'N') then
		nr_seq_estagio_w	:= 91;
		nr_seq_tipo_hist_w	:= 34;
		ds_mensagem_p		:= wheb_mensagem_pck.get_texto(354710);
	end if;

	if (nr_seq_complex_p = 4) then
		qt_hora_w	:= qt_hora_p;
	elsif (ie_tipo_orcamento_w = 'I') then
		qt_hora_w	:= qt_hora_p;
		qt_horas_adicionais_w := des_obter_acresc_horas_custom(nr_seq_complex_p,qt_hora_w,'A', ie_tipo_orcamento_w);

		if (nr_seq_integ_w <> 0) then
			begin
			select	coalesce(max(ie_implantacao),'X'),
					coalesce(max(qt_horas_suporte), 0),
					coalesce(max(qt_horas_implantacao), 0),
					coalesce(max(qt_horas_desenv_imp), 0),
					coalesce(max(qt_horas_tec_imp), 0)
			into STRICT	ie_implantacao_w,
					qt_horas_suporte_w,
					qt_horas_implantacao_w,
					qt_horas_desenv_imp_w,
					qt_horas_tec_imp_w
			from	int_integracao
			where	nr_sequencia	= nr_seq_integ_w;

			if (ie_implantacao_w = 'C') and (ie_cliente_ok_w = 'S') then
				nr_seq_estagio_w	:= 371;
				nr_seq_tipo_hist_w	:= 34;
			end if;
			end;

		qt_hora_w := qt_horas_suporte_w + qt_horas_tec_imp_w + qt_horas_desenv_imp_w + qt_horas_adicionais_w;

		else
        			qt_hora_w := qt_hora_w + qt_horas_adicionais_w;
		end if;
	else
		select	qt_hora_padrao
		into STRICT	qt_hora_w
		from	des_complexidade_custom
		where	nr_sequencia	= nr_seq_complex_p;
	end if;
	if (ie_tipo_orcamento_w = 'C') then

		qt_horas_adicionais_w := des_obter_acresc_horas_custom(nr_seq_complex_p,qt_hora_w,'A', ie_tipo_orcamento_w);

		if (qt_horas_adicionais_w > 0) then

			ds_macro_w :=	substr(	'QT_HORAS='	|| des_obter_acresc_horas_custom(nr_seq_complex_p,qt_hora_w,'T', ie_tipo_orcamento_w),
            						1, 4000);
			
			ds_historico_w :=	substr(obter_desc_exp_idioma(1071981, nr_seq_idioma_w, ds_macro_w), 1, 4000);

			CALL man_gravar_historico_ordem(	nr_sequencia_p,
							clock_timestamp(),
							ds_historico_w,
							'I',
							7,
							nm_usuario_p);
		end if;
		qt_hora_w := des_obter_acresc_horas_custom(nr_seq_complex_p,qt_hora_w, null, ie_tipo_orcamento_w);
    end if;

	update	man_ordem_servico
	set	nr_seq_complex_custom 	= CASE WHEN nr_seq_complex_p=0 THEN  null  ELSE nr_seq_complex_p END ,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		nr_seq_estagio		= nr_seq_estagio_w,
		ie_tipo_ordem 		= 23,
		nr_seq_tipo_ordem	= nr_seq_tipo_ordem_w,
		nr_seq_integracao	= CASE WHEN  nr_seq_integ_w=0 THEN  nr_seq_integracao  ELSE coalesce(nr_seq_integracao, nr_seq_integ_w) END
	where	nr_sequencia		= nr_sequencia_p;

	/*Foi removido o gestor pos venda como executor a pedido da OS - 933153*/

	update 	man_ordem_servico_exec
	set 	dt_fim_execucao	= clock_timestamp()
	where	nr_seq_ordem 	= nr_sequencia_p
	and	nm_usuario_exec 	<> nm_usuario_p
	and	coalesce(dt_fim_execucao::text, '') = '';

	/*verifica se o analista tem ativida*/
	
	select	count(1)
	into STRICT	qt_existe_w
	from 	man_ordem_servico_exec
	where	nr_seq_ordem 	= nr_sequencia_p
	and	nm_usuario_exec	= nm_usuario_p
	and	coalesce(dt_fim_execucao::text, '') = ''  LIMIT 1;

	if (qt_existe_w = 0) then
		insert into man_ordem_servico_exec(nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec,
			qt_min_prev,
			nr_seq_tipo_exec,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (nextval('man_ordem_servico_exec_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			45,
			'3',
			clock_timestamp(),
			nm_usuario_p);
	end if;

	vl_hora_w	:= des_obter_valor_hora_relat(nr_seq_cliente_w);

	ds_macro_w :=	substr('DS_SOLICITANTE=' || nm_pessoa_sol_w
		||	';DS_DETALHAMENTO=' || ds_detalhamento_p, 1, 4000);

	select	substr(obter_desc_exp_idioma(724634, nr_seq_idioma_w, ds_macro_w), 1, 4000)
	into STRICT	ds_texto_padrao_w
	;

	select	count(1)
	into STRICT	qt_existe_w
	from 	man_ordem_servico_orc
	where	coalesce(dt_aprovacao::text, '') = ''
	and	coalesce(dt_reprovacao::text, '') = ''
	and	nr_seq_ordem = nr_sequencia_p;

	if (qt_existe_w > 0) then
		update 	man_ordem_servico_orc
		set 	dt_reprovacao = clock_timestamp()
		where	coalesce(dt_aprovacao::text, '') = ''
		and	coalesce(dt_reprovacao::text, '') = ''
		and	nr_seq_ordem = nr_sequencia_p;
	end if;

	select	nextval('man_ordem_servico_orc_seq')
	into STRICT	nr_seq_orc_w
	;

	insert into man_ordem_servico_orc(nr_sequencia,
		nr_seq_ordem,
		dt_atualizacao,
		nm_usuario,
		dt_orcamento,
		nm_usuario_orc,
		cd_condicao_pagto,
		dt_validade,
		dt_aprovacao,
		nm_pessoa_aprovacao,
		nm_usuario_aprovacao,
		ds_conteudo_email_aprov,
		ds_observacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		qt_horas_prev_inicial,
		qt_horas_prev_interna,
		qt_horas_prev_revisao, 
		qt_horas_real,
		ie_tipo_orcamento)
	values (nr_seq_orc_w,
		nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'',
		clock_timestamp() + interval '30 days',
		null,
		'',
		'',
		'',
		substr(ds_integracao_w,1,4000),
		clock_timestamp(),
		nm_usuario_p,
		qt_hora_w,
		qt_hora_w, 
		'',
		qt_hora_w,
		ie_tipo_orcamento_w);

	ds_item_orc_w		:= obter_texto_tasy(354715, nr_seq_idioma_w);
	cd_unidade_medida_w	:= 'h';

	if (ie_tipo_customizacao_p = 'I') then	/*Se e de integracao, muda de customizacao para licenciamento*/
		ds_item_orc_w		:= obter_texto_tasy(475861, nr_seq_idioma_w);
		cd_unidade_medida_w	:= 'tx';
	end if;

	insert into man_ord_serv_orc_item(nr_sequencia,
		nr_seq_orc_ordem,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		ds_item,
		qt_item,
		cd_unidade_medida,
		vl_unitario,
		vl_item,
		ds_observacao,
		cd_material,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (nextval('man_ord_serv_orc_item_seq'),
		nr_seq_orc_w,
		clock_timestamp(),
		nm_usuario_p,
		1,
		ds_item_orc_w,
		qt_hora_w,
		cd_unidade_medida_w,
		vl_hora_w,
		(qt_hora_w * vl_hora_w),
		'',
		'',
		clock_timestamp(),
		nm_usuario_p);

	insert into man_ordem_serv_tecnico(nr_sequencia,
		nr_seq_ordem_serv,
		dt_atualizacao,
		nm_usuario,
		ds_relat_tecnico,
		cd_versao_tasy,
		dt_historico,
		ie_origem,
		nr_seq_tipo,
		dt_liberacao,
		nm_usuario_lib,
		ie_grau_satisfacao,
		dt_envio,
		ie_relevante_teste,
		nr_seq_motivo_desvio_prev)
	values (nextval('man_ordem_serv_tecnico_seq'),
		nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_texto_padrao_w,
		'',
		clock_timestamp(),
		'I',
		nr_seq_tipo_hist_w,
		clock_timestamp(),
		nm_usuario_p,
		'',
		'',
		'N',
		'');

	select	count(1)
	into STRICT	qt_existe_w
	from	man_ordem_serv_ativ
	where	trunc(dt_atividade)	= trunc(clock_timestamp())
	and	nr_seq_ordem_serv	= nr_sequencia_p
	and	nm_usuario_exec	    = nm_usuario_p
	and	coalesce(dt_fim_atividade::text, '') = ''  LIMIT 1;

	if (qt_existe_w = 0) then
		insert into man_ordem_serv_ativ(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			dt_atividade,
			nr_seq_funcao,
			qt_minuto,
			nm_usuario_exec,
			ds_observacao,
			dt_fim_atividade,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
            nr_seq_grupo_des)
		values (nextval('man_ordem_serv_ativ_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			31,
			5,
			nm_usuario_p,
			'',
			(clock_timestamp() + interval '5 days'/1440),
			clock_timestamp(),
			nm_usuario_p,
            obter_grupo_usuario(nm_usuario_p));
	end if;

	if (coalesce(nr_seq_integ_w,0) > 0) and (coalesce(qt_horas_implantacao_w,0) > 0) then /*Se existir necessidade de horas de implantacao/consultoria*/
		begin

		begin
		select	coalesce(substr(obter_usuario_pf(cd_pessoa_fisica),1,15),'Enedir')
		into STRICT	nm_usuario_gestor_w
		from	com_cliente_conta
		where	nr_seq_cliente = nr_seq_cliente_w
		and	clock_timestamp() between coalesce(dt_inicial,clock_timestamp()) and coalesce(dt_final,clock_timestamp())  LIMIT 1;
		exception
		when others then
			nm_usuario_gestor_w := 'Enedir';
		end;

		select	substr(obter_dados_usuario_opcao(nm_usuario_gestor_w,'E'),1,255)
		into STRICT	ds_email_w
		;

		ds_titulo_w	:= substr(obter_desc_exp_idioma(963265, nr_seq_idioma_w), 1, 255);

		ds_macro_w :=	substr('QT_HORAS_IMPLANTACAO='	|| qt_horas_implantacao_w
			||	';QT_HORAS_DESENVOLVIMENTO='	|| coalesce(qt_horas_desenv_imp_w, 0)
			||	';NR_SEQ_ORDEM='	|| nr_sequencia_p
			||	';DS_INTEGRACAO='	|| ds_integracao_w
			||	';DS_DETALHAMENTO='	|| ds_detalhamento_p, 1, 4000);

		ds_comunic_w :=	substr(obter_desc_exp_idioma(1039672, nr_seq_idioma_w, ds_macro_w), 1, 4000);

		if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
			CALL Enviar_Email(ds_titulo_w, ds_comunic_w, null, ds_email_w, nm_usuario_p, 'M');

			insert into man_ordem_serv_envio(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				dt_envio,
				ie_tipo_envio,
				ds_destino,
				ds_observacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (	nextval('man_ordem_serv_envio_seq'),
				nr_sequencia_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				'E',
				substr(ds_email_w,1,255),
				substr(ds_comunic_w,1,255),
				clock_timestamp(),
				nm_usuario_p);
		end if;

		insert into man_ordem_serv_tecnico(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			cd_versao_tasy,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			dt_liberacao,
			nm_usuario_lib,
			ie_grau_satisfacao,
			dt_envio,
			ie_relevante_teste,
			nr_seq_motivo_desvio_prev)
		values (nextval('man_ordem_serv_tecnico_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_comunic_w,
			'',
			clock_timestamp(),
			'I',
			7,
			clock_timestamp(),
			nm_usuario_p,
			'',
			'',
			'N',
			'');
		end;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_definir_complex_custom_os (nr_seq_complex_p bigint, nr_sequencia_p bigint, qt_hora_p bigint, nr_seq_integracao_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ie_tipo_customizacao_p text default 'C', ds_detalhamento_p text default null) FROM PUBLIC;

