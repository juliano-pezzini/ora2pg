-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_vinc_atend_futuros ( nr_atendimento_p bigint, ds_agecons_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_atend_fechado_p INOUT text, ds_perg_gerar_atend_p INOUT text, ds_msg_gerar_atend_p INOUT text, ds_erro_vincular_atend_p INOUT text, ds_perg_cd_diferentes_p INOUT text, ds_perg_atend_vinc_p INOUT text, nr_atendimento_lista_p INOUT text, cd_pessoa_fisica_lista_p INOUT text, cd_convenio_lista_p INOUT text, cd_plano_lista_p INOUT text, nr_seq_agenda_lista_p INOUT text) AS $body$
DECLARE


ie_consiste_vinc_atend_w	varchar(1);
ie_vincular_atend_fechado_w	varchar(1);
ie_ageserv_atend_fechado_w	varchar(1);
ds_agecons_lista_w		varchar(2000);
nr_seq_agecons_w		agenda_consulta.nr_sequencia%type;
qt_autorizada_w		bigint;
nr_secao_w		bigint;
cd_convenio_w		integer;
cd_usuario_convenio_w	varchar(30);
cd_usuario_conv_vinc_w	varchar(30);
cd_pessoa_fisica_w		varchar(10);
cd_plano_w		varchar(10);
ds_erro_w			varchar(255);
ie_atend_vinculado_w	varchar(1);
ie_vincula_atend_w		varchar(1);


BEGIN
/* Agenda de Servicos - Parametro [44] - Consistir a autorizacao da sessao ao vincular o atendimento */

ie_consiste_vinc_atend_w := obter_param_usuario(866, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_vinc_atend_w);
/* Agenda de Servicos - Parametro [173] - Permitir vincular atendimento com conta fechada */

ie_vincular_atend_fechado_w := obter_param_usuario(866, 173, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vincular_atend_fechado_w);

ds_perg_gerar_atend_p	:= '';
ds_msg_gerar_atend_p	:= '';
ds_erro_vincular_atend_p	:= '';
ds_perg_cd_diferentes_p	:= '';
ds_perg_atend_vinc_p	:= '';

nr_seq_agenda_lista_p	:= '';
nr_atendimento_lista_p	:= '';
cd_pessoa_fisica_lista_p	:= '';
cd_convenio_lista_p		:= '';
cd_plano_lista_p		:= '';

ds_agecons_lista_w	:= ds_agecons_lista_p;
while (ds_agecons_lista_w IS NOT NULL AND ds_agecons_lista_w::text <> '') loop
	begin
	nr_seq_agecons_w	:= (substr(ds_agecons_lista_w, 1, position(',' in ds_agecons_lista_w) - 1))::numeric;
	ds_agecons_lista_w	:= substr(ds_agecons_lista_w, position(',' in ds_agecons_lista_w) + 1, length(ds_agecons_lista_w));

	select	obter_qt_autconv_atend_agecons(nr_atendimento_p, nr_seq_agecons_w),
		obter_dados_agenda_servico(nr_seq_agecons_w, 'S')
	into STRICT	qt_autorizada_w,
		nr_secao_w
	;

	select	max(cd_convenio),
		max(cd_usuario_convenio)
	into STRICT	cd_convenio_w,
		cd_usuario_convenio_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agecons_w;

	ie_vincula_atend_w	:= 'S';
	if (ie_consiste_vinc_atend_w <> 'N') and (nr_secao_w > 1) and (nr_secao_w > qt_autorizada_w) then
		begin
		if (ie_consiste_vinc_atend_w = 'C') then
			ds_perg_gerar_atend_p	:= ds_perg_gerar_atend_p || ',' || nr_seq_agecons_w;
		elsif (ie_consiste_vinc_atend_w = 'I') then
			begin
			ds_msg_gerar_atend_p	:= ds_msg_gerar_atend_p || ',' || nr_seq_agecons_w;
			ie_vincula_atend_w		:= 'N';
			end;
		end if;
		end;
	end if;

	if (ie_vincula_atend_w = 'S') then
		begin
		SELECT * FROM vincular_atendimento_agenda(
			nr_atendimento_p, cd_convenio_w, cd_pessoa_fisica_w, cd_plano_w, cd_usuario_conv_vinc_w, ds_erro_w) INTO STRICT cd_convenio_w, cd_pessoa_fisica_w, cd_plano_w, cd_usuario_conv_vinc_w, ds_erro_w;

		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			begin
			if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
				ds_erro_vincular_atend_p	:= ds_erro_vincular_atend_p || nr_seq_agecons_w || ',' || ds_erro_w || ',';
			elsif (cd_usuario_convenio_w IS NOT NULL AND cd_usuario_convenio_w::text <> '') and (cd_usuario_conv_vinc_w IS NOT NULL AND cd_usuario_conv_vinc_w::text <> '') and (cd_usuario_convenio_w <> cd_usuario_conv_vinc_w) then
				ds_perg_cd_diferentes_p	:= ds_perg_cd_diferentes_p || ',' || nr_seq_agecons_w;
			end if;

			select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
			into STRICT	ie_atend_vinculado_w
			from	agenda_paciente
			where	cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	nr_atendimento	= nr_atendimento_p;

			if (ie_atend_vinculado_w = 'S') then
				ds_perg_atend_vinc_p	:= ds_perg_atend_vinc_p || ',' || nr_seq_agecons_w;
			end if;

			nr_atendimento_lista_p	:= nr_atendimento_lista_p || nr_atendimento_p || ',';
			cd_pessoa_fisica_lista_p	:= cd_pessoa_fisica_lista_p || cd_pessoa_fisica_w || ',';
			cd_convenio_lista_p		:= cd_convenio_lista_p || cd_convenio_w || ',';
			cd_plano_lista_p		:= cd_plano_lista_p || cd_plano_w || ',';
			nr_seq_agenda_lista_p	:= nr_seq_agenda_lista_p || nr_seq_agecons_w || ',';
			end;
		end if;
		end;
	end if;
	end;
end loop;

ie_ageserv_atend_fechado_w	:= ageserv_obter_se_atend_fechado(nr_atendimento_p);

if (ie_ageserv_atend_fechado_w = 'S') then
	begin
	if (ie_vincular_atend_fechado_w = 'Q') then
		ds_msg_atend_fechado_p	:= obter_texto_tasy(92488, wheb_usuario_pck.get_nr_seq_idioma);
	elsif (ie_vincular_atend_fechado_w = 'N') then
		ds_msg_atend_fechado_p	:= obter_texto_tasy(92491, wheb_usuario_pck.get_nr_seq_idioma);
	end if;
	end;	
end if;
	
if (length(ds_perg_gerar_atend_p) > 0) then
	ds_perg_gerar_atend_p	:= substr(obter_texto_tasy(50317, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_perg_gerar_atend_p;
end if;
if (length(ds_msg_gerar_atend_p) > 0) then
	ds_msg_gerar_atend_p	:= substr(obter_texto_tasy(50319, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_msg_gerar_atend_p;
end if;
if (length(ds_perg_cd_diferentes_p) > 0) then
	ds_perg_cd_diferentes_p	:= substr(obter_texto_tasy(51780, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_perg_cd_diferentes_p;
end if;
if (length(ds_perg_atend_vinc_p) > 0) then
	ds_perg_atend_vinc_p	:= substr(obter_texto_tasy(51782, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_perg_atend_vinc_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_vinc_atend_futuros ( nr_atendimento_p bigint, ds_agecons_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_atend_fechado_p INOUT text, ds_perg_gerar_atend_p INOUT text, ds_msg_gerar_atend_p INOUT text, ds_erro_vincular_atend_p INOUT text, ds_perg_cd_diferentes_p INOUT text, ds_perg_atend_vinc_p INOUT text, nr_atendimento_lista_p INOUT text, cd_pessoa_fisica_lista_p INOUT text, cd_convenio_lista_p INOUT text, cd_plano_lista_p INOUT text, nr_seq_agenda_lista_p INOUT text) FROM PUBLIC;

