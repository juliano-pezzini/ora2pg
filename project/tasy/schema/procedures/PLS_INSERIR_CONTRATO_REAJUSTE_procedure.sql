-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_contrato_reajuste ( nr_seq_reajuste_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_reajuste_w			timestamp;
tx_reajuste_w			double precision;
ie_indice_reajuste_w		varchar(1);
nr_seq_contrato_w		bigint;
nr_seq_contrato_ww		bigint;
ie_reajustar_inscricao_w	varchar(1);
ie_reajustar_vl_manutencao_w	varchar(1);
ie_tipo_reajuste_w		varchar(1);
dt_autorizacao_ans_w		timestamp;
ds_oficio_ans_w			varchar(255);
nr_protocolo_ans_w		varchar(60);
ie_reajuste_tabela_w		varchar(1);
nr_seq_reajuste_w		bigint;
ie_indice_reajuste_contrato_w	bigint;
ie_aplicacao_reajuste_w		varchar(2);
nr_seq_grupo_contrato_w		bigint;
ie_reajustar_copartic_w		varchar(1);
tx_reajuste_copartic_w		double precision;
tx_reajuste_copartic_max_w	double precision;
tx_reajuste_inscricao_w		double precision;
ie_reajustar_via_adic_w		varchar(1);
tx_via_adicional_w		double precision;
nr_seq_lote_reaj_copart_w	bigint;
qt_regra_copartic_w		bigint;
nr_seq_lote_reaj_inscricao_w	bigint;
qt_regra_inscricao_w		bigint;
qt_reaj_copartic_w		bigint;
qt_reaj_inscricao_w		bigint;
qt_tabelas_w			bigint;
nr_seq_intercambio_ww		bigint;
nr_seq_intercambio_w		bigint;
ie_tipo_contrato_w		varchar(2);
ie_tipo_contrato_ww		varchar(2);
nr_seq_plano_w			bigint;
ie_vinculo_coparticipacao_w	varchar(2);
dt_rescisao_w			timestamp;
ie_situacao_reaj_contrato_w	varchar(1);
ie_reajustar_benef_cancel_ww	varchar(1);
qt_mes_reaj_w			bigint;
qt_lote_reaj_copartic_w		bigint;
qt_lote_reaj_inscricao_w	bigint;
tx_deflator_w			double precision;
nr_seq_lote_reaj_colet_w	bigint;
nr_seq_grupo_intercambio_w	bigint;
nr_contrato_w			bigint;
ie_reajuste_w			varchar(1);
qt_registros_w			bigint;
ie_caracteristica_w		varchar(2);
ds_justificativa_w		varchar(255);
nr_seq_grupo_contr_w		varchar(255);
dt_contrato_w			pls_contrato.dt_contrato%type;
dt_aplicacao_reajuste_w		pls_reajuste.dt_aplicacao_reajuste%type;
nr_seq_grupo_produto_w		pls_reajuste.nr_seq_grupo_produto%type;
tx_reajuste_proposto_w		pls_reajuste.tx_reajuste_proposto%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio,
		'O' ie_tipo_contrato,
		coalesce(a.dt_rescisao_contrato,a.dt_cancelamento) dt_rescisao,
		a.nr_contrato nr_contrato
	FROM pls_contrato a
LEFT OUTER JOIN pls_contrato_grupo c ON (a.nr_sequencia = c.nr_seq_contrato)
LEFT OUTER JOIN pls_grupo_contrato b ON (c.nr_seq_grupo = b.nr_sequencia)
WHERE ((b.nr_sequencia = nr_seq_grupo_contrato_w) or (coalesce(nr_seq_grupo_contrato_w::text, '') = '')) and coalesce(a.cd_pf_estipulante::text, '') = '' and ((nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = '')) and a.cd_estabelecimento	= cd_estabelecimento_p and (((b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '') and c.ie_reajuste_grupo = 'S' and to_char(b.dt_reajuste,'mm') = to_char(dt_reajuste_w,'mm'))
		or	((coalesce(b.dt_reajuste::text, '') = '' or c.ie_reajuste_grupo = 'N') and
			(((a.dt_reajuste IS NOT NULL AND a.dt_reajuste::text <> '') and (to_char(a.dt_reajuste,'mm') = to_char(dt_reajuste_w,'mm')))
			or	((coalesce(a.dt_reajuste::text, '') = '') and (to_char(add_months(a.dt_contrato,coalesce(qt_intervalo,12)),'mm') = to_char(dt_reajuste_w,'mm')))))) and ((ie_tipo_contrato_w = 'O') or (coalesce(ie_tipo_contrato_w::text, '') = '')) and ((to_char(a.dt_contrato,'yyyy') <> to_char(dt_reajuste_w,'yyyy')) or (b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '')) and a.dt_contrato < dt_reajuste_w  -- Não pode incluir contratos com data superior a data do reajuste. Ex: Contrato de 2014 em reajuste de 2012
  and coalesce(a.ie_reajuste,'C') = 'C' and a.ie_situacao not in ('1','4')
	
union all

	SELECT	a.nr_sequencia nr_seq_contrato,
		null nr_seq_intercambio,
		'O' ie_tipo_contrato,
		coalesce(a.dt_rescisao_contrato,a.dt_cancelamento) dt_rescisao,
		a.nr_contrato nr_contrato
	FROM pls_segurado d, pls_contrato a
LEFT OUTER JOIN pls_contrato_grupo c ON (a.nr_sequencia = c.nr_seq_contrato)
LEFT OUTER JOIN pls_grupo_contrato b ON (c.nr_seq_grupo = b.nr_sequencia)
WHERE d.nr_seq_contrato	= a.nr_sequencia   and ((b.nr_sequencia = nr_seq_grupo_contrato_w) or (coalesce(nr_seq_grupo_contrato_w::text, '') = '')) and coalesce(a.cd_pf_estipulante::text, '') = '' and ((nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = '')) and a.cd_estabelecimento	= cd_estabelecimento_p and to_char(coalesce(d.dt_reajuste,d.dt_contratacao),'mm') = to_char(dt_reajuste_w,'mm') and ((ie_tipo_contrato_w = 'O') or (coalesce(ie_tipo_contrato_w::text, '') = '')) and ((to_char(a.dt_contrato,'yyyy') <> to_char(dt_reajuste_w,'yyyy')) or (b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '')) and a.dt_contrato < dt_reajuste_w and coalesce(a.ie_reajuste,'C') = 'A' and a.ie_situacao not in ('1','4')
	 
union all

	select	null,
		a.nr_sequencia,
		'I',
		a.dt_exclusao,
		null
	FROM pls_intercambio a
LEFT OUTER JOIN pls_regra_grupo_inter b ON (a.nr_seq_grupo_intercambio = b.nr_sequencia)
WHERE ((b.nr_sequencia = nr_seq_grupo_intercambio_w) or (coalesce(nr_seq_grupo_intercambio_w::text, '') = '')) and coalesce(cd_pessoa_fisica::text, '') = '' and (((b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '') /*Restrição do grupo de intercâmbio*/
			and	to_char(b.dt_reajuste,'mm') = to_char(dt_reajuste_w,'mm')) or (coalesce(b.dt_reajuste::text, '') = '' and /*Restrição dos contratos de intercâmbio*/
			to_char(a.dt_inclusao,'mm')	= to_char(dt_reajuste_w,'mm'))) and ((to_char(a.dt_inclusao,'yyyy')	<> to_char(dt_reajuste_w,'yyyy')) or (b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '')) and a.dt_inclusao < dt_reajuste_w and a.cd_estabelecimento	= cd_estabelecimento_p and ((ie_tipo_contrato_w = 'I') or (coalesce(ie_tipo_contrato_w::text, '') = ''));


BEGIN

select	max(ie_reajustar_benef_cancelado)
into STRICT	ie_reajustar_benef_cancel_ww
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

ie_reajustar_benef_cancel_ww	:= coalesce(ie_reajustar_benef_cancel_ww,'N');

select	dt_reajuste,
	coalesce(tx_reajuste,0),
	coalesce(tx_deflator,0),
	ie_indice_reajuste,
	nr_seq_contrato,
	ie_reajustar_inscricao,
	ie_reajustar_vl_manutencao,
	ie_tipo_reajuste,
	dt_autorizacao_ans,
	ds_oficio_ans,
	nr_protocolo_ans,
	ie_reajuste_tabela,
	ie_indice_reajuste_contrato,
	ie_aplicacao_reajuste,
	nr_seq_grupo_contrato,
	ie_reajustar_copartic,
	coalesce(tx_reajuste_copartic,tx_reajuste),
	coalesce(tx_reajuste_copartic_max,tx_reajuste),
	coalesce(tx_reajuste_inscricao,tx_reajuste),
	ie_reajustar_via_adic,
	tx_via_adicional,
	nr_seq_intercambio,
	ie_tipo_contrato,
	nr_seq_plano,
	ie_vinculo_coparticipacao,
	nr_seq_lote_reaj_colet,
	nr_seq_grupo_intercambio,
	coalesce(ie_reajustar_benef_cancelado,'T'),
	ie_caracteristica,
	ds_justificativa,
	dt_aplicacao_reajuste,
	nr_seq_grupo_produto,
	tx_reajuste_proposto
into STRICT	dt_reajuste_w,
	tx_reajuste_w,
	tx_deflator_w,
	ie_indice_reajuste_w,
	nr_seq_contrato_ww,
	ie_reajustar_inscricao_w,
	ie_reajustar_vl_manutencao_w,
	ie_tipo_reajuste_w,
	dt_autorizacao_ans_w,
	ds_oficio_ans_w,
	nr_protocolo_ans_w,
	ie_reajuste_tabela_w,
	ie_indice_reajuste_contrato_w,
	ie_aplicacao_reajuste_w,
	nr_seq_grupo_contrato_w,
	ie_reajustar_copartic_w,
	tx_reajuste_copartic_w,
	tx_reajuste_copartic_max_w,
	tx_reajuste_inscricao_w,
	ie_reajustar_via_adic_w,
	tx_via_adicional_w,
	nr_seq_intercambio_ww,
	ie_tipo_contrato_w,
	nr_seq_plano_w,
	ie_vinculo_coparticipacao_w,
	nr_seq_lote_reaj_colet_w,
	nr_seq_grupo_intercambio_w,
	ie_situacao_reaj_contrato_w,
	ie_caracteristica_w,
	ds_justificativa_w,
	dt_aplicacao_reajuste_w,
	nr_seq_grupo_produto_w,
	tx_reajuste_proposto_w
from	pls_reajuste
where	nr_sequencia	= nr_seq_reajuste_p;

if	((coalesce(nr_seq_contrato_ww,0) <> 0) or (coalesce(nr_seq_intercambio_ww,0) <> 0)) then

	if (coalesce(nr_seq_lote_reaj_colet_w,0) <> 0) then
		qt_mes_reaj_w	:= 1;
	elsif (nr_seq_contrato_ww IS NOT NULL AND nr_seq_contrato_ww::text <> '') then
		select	max(ie_reajuste),
			max(dt_contrato),
			pls_dados_grupo_relac_contr(max(nr_sequencia),'S')
		into STRICT	ie_reajuste_w,
			dt_contrato_w,
			nr_seq_grupo_contr_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_ww;

		ie_reajuste_w	:= coalesce(ie_reajuste_w,'C');

		if	((to_char(dt_contrato_w,'yyyy') = to_char(dt_reajuste_w,'yyyy')) and (coalesce(nr_seq_grupo_contr_w,'0') = '0')) then
			qt_mes_reaj_w	:= 0; -- Não pode reajustar o contrato no mesmo ano da contratação
		else
			if (ie_reajuste_w = 'A') then /* Reajuste do beneficiário */
				select	count(1)
				into STRICT	qt_mes_reaj_w
				FROM pls_segurado d, pls_contrato a
LEFT OUTER JOIN pls_contrato_grupo c ON (a.nr_sequencia = c.nr_seq_contrato)
LEFT OUTER JOIN pls_grupo_contrato b ON (c.nr_seq_grupo = b.nr_sequencia)
WHERE d.nr_seq_contrato	= a.nr_sequencia   and coalesce(a.cd_pf_estipulante::text, '') = '' and a.ie_situacao not in ('1','4') and ((to_char(coalesce(d.dt_reajuste,d.dt_contratacao),'mm') = to_char(dt_reajuste_w,'mm')) or (to_char(coalesce(a.dt_reajuste,a.dt_contrato),'mm') = to_char(dt_reajuste_w,'mm'))) and ((nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = '')) and a.cd_estabelecimento	= cd_estabelecimento_p and ((b.nr_sequencia = nr_seq_grupo_contrato_w) or (coalesce(nr_seq_grupo_contrato_w::text, '') = '')) and ((ie_tipo_contrato_w = 'O') or (coalesce(ie_tipo_contrato_w::text, '') = '')) and a.dt_contrato < dt_reajuste_w and a.nr_sequencia	= nr_seq_contrato_ww;
			else /* Reajuste do contrato */
				select	count(1)
				into STRICT	qt_mes_reaj_w
				FROM pls_contrato a
LEFT OUTER JOIN pls_contrato_grupo c ON (a.nr_sequencia = c.nr_seq_contrato)
LEFT OUTER JOIN pls_grupo_contrato b ON (c.nr_seq_grupo = b.nr_sequencia)
WHERE (((b.dt_reajuste IS NOT NULL AND b.dt_reajuste::text <> '') and c.ie_reajuste_grupo = 'S' and to_char(b.dt_reajuste,'mm') = to_char(dt_reajuste_w,'mm'))
					or	((coalesce(b.dt_reajuste::text, '') = '' or c.ie_reajuste_grupo = 'N') and
						(((a.dt_reajuste IS NOT NULL AND a.dt_reajuste::text <> '') and (to_char(a.dt_reajuste,'mm') = to_char(dt_reajuste_w,'mm')))
						or	((coalesce(a.dt_reajuste::text, '') = '') and (to_char(add_months(a.dt_contrato,coalesce(qt_intervalo,12)),'mm') = to_char(dt_reajuste_w,'mm')))))) and coalesce(a.cd_pf_estipulante::text, '') = '' and a.ie_situacao not in ('1','4') and ((nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = '')) and a.cd_estabelecimento	= cd_estabelecimento_p   and ((b.nr_sequencia = nr_seq_grupo_contrato_w) or (coalesce(nr_seq_grupo_contrato_w::text, '') = '')) and ((ie_tipo_contrato_w = 'O') or (coalesce(ie_tipo_contrato_w::text, '') = '')) and a.dt_contrato < dt_reajuste_w and a.nr_sequencia	= nr_seq_contrato_ww;
			end if;
		end if;
	elsif (nr_seq_intercambio_ww IS NOT NULL AND nr_seq_intercambio_ww::text <> '') then

		select	count(1)
		into STRICT	qt_mes_reaj_w
		from	pls_intercambio		a
		where	coalesce(cd_pessoa_fisica::text, '') = ''
		and	to_char(a.dt_inclusao,'mm')	= to_char(dt_reajuste_w,'mm')
		and	to_char(a.dt_inclusao,'yyyy')	<> to_char(dt_reajuste_w,'yyyy')
		and	a.dt_inclusao < dt_reajuste_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((ie_tipo_contrato_w = 'I') or (coalesce(ie_tipo_contrato_w::text, '') = ''))
		and	a.nr_sequencia		= nr_seq_intercambio_ww;
	end if;

	if (qt_mes_reaj_w > 0) then
		if (ie_reajustar_copartic_w = 'S') and (tx_reajuste_copartic_w <> 0) then

			select count(1)
			into STRICT	qt_lote_reaj_copartic_w
			from (      	SELECT 	a.nr_seq_reajuste
					from	pls_lote_reaj_copartic a,
						pls_reajuste b
					where	a.nr_seq_contrato 	= b.nr_seq_contrato
					and   	b.nr_sequencia 		= a.nr_seq_reajuste
					and   	a.nr_seq_contrato	= nr_seq_contrato_ww
					and	a.dt_referencia		= dt_reajuste_w
					and	a.ie_vinculo_coparticipacao = ie_vinculo_coparticipacao_w
					and 	coalesce(b.nr_seq_lote_deflator::text, '') = ''
					and     not exists (	SELECT	1
								from	pls_reajuste x
								where	x.nr_seq_lote_deflator = b.nr_sequencia)) alias6;

			if (qt_lote_reaj_copartic_w = 0) then
				select	nextval('pls_lote_reaj_copartic_seq')
				into STRICT	nr_seq_lote_reaj_copart_w
				;

				insert	into	pls_lote_reaj_copartic(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
						dt_referencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
						tx_reajuste_vl_maximo, nr_seq_reajuste, nr_seq_intercambio,
						ie_vinculo_coparticipacao)
					values (	nr_seq_lote_reaj_copart_w, nr_seq_contrato_ww, cd_estabelecimento_p,
						dt_reajuste_w, clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, tx_reajuste_copartic_w,
						tx_reajuste_copartic_max_w, nr_seq_reajuste_p, nr_seq_intercambio_ww,
						ie_vinculo_coparticipacao_w);

				CALL pls_incluir_copartic_lote_reaj(nr_seq_lote_reaj_copart_w, cd_estabelecimento_p, 'N', nm_usuario_p);

				select	count(1)
				into STRICT	qt_regra_copartic_w
				from	pls_reajuste_copartic
				where	nr_seq_lote	= nr_seq_lote_reaj_copart_w;

				if (qt_regra_copartic_w = 0) then
					delete	from	pls_lote_reaj_copartic
					where	nr_sequencia	= nr_seq_lote_reaj_copart_w;
				end if;
			end if;
		end if;

		if (ie_reajustar_inscricao_w = 'S') then
			qt_lote_reaj_inscricao_w	:= 0;
			if (coalesce(nr_seq_intercambio_ww,0) <> 0) then
				select	count(1)
				into STRICT	qt_lote_reaj_inscricao_w
				from	pls_lote_reaj_inscricao a,
					pls_reajuste b
				where	b.nr_sequencia		= a.nr_seq_reajuste
				and	a.nr_seq_intercambio	= nr_seq_intercambio_ww
				and	a.dt_referencia		= dt_reajuste_w
				and	coalesce(b.nr_seq_lote_deflator::text, '') = ''
				and	not exists (	SELECT	1
							from	pls_reajuste x
							where	x.nr_seq_lote_deflator = b.nr_sequencia);
			else
				select	count(1)
				into STRICT	qt_lote_reaj_inscricao_w
				from	pls_lote_reaj_inscricao a,
					pls_reajuste b
				where	b.nr_sequencia		= a.nr_seq_reajuste
				and	a.nr_seq_contrato	= nr_seq_contrato_ww
				and	a.dt_referencia		= dt_reajuste_w
				and	coalesce(b.nr_seq_lote_deflator::text, '') = ''
				and	not exists (	SELECT	1
							from	pls_reajuste x
							where	x.nr_seq_lote_deflator = b.nr_sequencia);
			end if;

			if (qt_lote_reaj_inscricao_w = 0) then
				select	nextval('pls_lote_reaj_inscricao_seq')
				into STRICT	nr_seq_lote_reaj_inscricao_w
				;

				insert	into	pls_lote_reaj_inscricao(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
						dt_referencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
						nr_seq_reajuste, nr_seq_intercambio)
					values (	nr_seq_lote_reaj_inscricao_w, nr_seq_contrato_ww, cd_estabelecimento_p,
						dt_reajuste_w, clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, tx_reajuste_inscricao_w,
						nr_seq_reajuste_p, nr_seq_intercambio_ww);

				CALL pls_incluir_inscricao_reaj(nr_seq_lote_reaj_inscricao_w, cd_estabelecimento_p, nm_usuario_p);

				select	count(1)
				into STRICT	qt_regra_inscricao_w
				from	pls_reajuste_inscricao
				where	nr_seq_lote	= nr_seq_lote_reaj_inscricao_w;

				if (qt_regra_inscricao_w = 0) then
					delete	from	pls_lote_reaj_inscricao
					where	nr_sequencia	= nr_seq_lote_reaj_inscricao_w;
				end if;
			end if;
		end if;

		if (tx_reajuste_w <> 0) or (tx_deflator_w <> 0) then
			CALL pls_inserir_tabela_reajuste(nr_seq_reajuste_p,null,nm_usuario_p);
		else
			select	count(1)
			into STRICT	qt_reaj_inscricao_w
			from	pls_lote_reaj_inscricao
			where	nr_seq_reajuste	= nr_seq_reajuste_p;

			select	count(1)
			into STRICT	qt_reaj_copartic_w
			from	pls_lote_reaj_copartic
			where	nr_seq_reajuste	= nr_seq_reajuste_p;

			if (qt_reaj_inscricao_w > 0) or (qt_reaj_copartic_w > 0) then
				update	pls_reajuste
				set	ie_status = '3'
				where	nr_sequencia = nr_seq_reajuste_p;
			end if;
		end if;
	end if;
elsif (coalesce(nr_seq_contrato_ww,0) = 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_contrato_w,
		nr_seq_intercambio_w,
		ie_tipo_contrato_ww,
		dt_rescisao_w,
		nr_contrato_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (coalesce(nr_seq_contrato_w,0) <> 0) then
			select	count(1)
			into STRICT	qt_registros_w
			from	pls_reajuste
			where	nr_seq_lote_referencia	= nr_seq_reajuste_p
			and	nr_seq_contrato		= nr_seq_contrato_w;
		else
			qt_registros_w	:= 0;
		end if;

		if (qt_registros_w = 0) and
			(((coalesce(dt_rescisao_w::text, '') = '') or (dt_rescisao_w > dt_reajuste_w)) or
			((dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') and (ie_reajustar_benef_cancel_ww in ('T','C')))) then


			/*Caso a situação para o reajuste do contrato for diferente de ambos verificar como está a situação do contrato*/

			if (ie_situacao_reaj_contrato_w <> 'T') then
				if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
					if (pls_obter_situac_contr_periodo(nr_seq_contrato_w,'C','M',dt_reajuste_w) <> ie_situacao_reaj_contrato_w) then
						goto finalCursor01;
					end if;
				elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
					if (pls_obter_situac_contr_periodo(nr_seq_intercambio_w,'I','M',dt_reajuste_w) <> ie_situacao_reaj_contrato_w) then
						goto finalCursor01;
					end if;
				end if;
			end if;

			select	nextval('pls_reajuste_seq')
			into STRICT	nr_seq_reajuste_w
			;

			insert	into	pls_reajuste(	nr_sequencia, nr_seq_lote_referencia, cd_estabelecimento,
					dt_reajuste, tx_reajuste, ie_indice_reajuste,
					ie_tipo_reajuste, ie_status, dt_atualizacao, nm_usuario,
					dt_atualizacao_nrec, nm_usuario_nrec, dt_autorizacao_ans,
					ds_oficio_ans, nr_protocolo_ans, nr_seq_contrato,
					ie_reajustar_inscricao, ie_reajustar_vl_manutencao, ie_reajuste_tabela,
					ie_aplicacao_reajuste, ie_reajustar_copartic, tx_reajuste_copartic,
					tx_reajuste_copartic_max, tx_reajuste_inscricao, ie_reajustar_via_adic,
					tx_via_adicional, nr_seq_intercambio, ie_tipo_contrato,
					nr_seq_plano,dt_reajuste_aux,ie_vinculo_coparticipacao, nr_contrato,
					ie_reajustar_benef_cancelado, ie_caracteristica, ds_justificativa,
					dt_aplicacao_reajuste, nr_seq_grupo_produto, tx_reajuste_proposto,
					ie_tipo_lote)
				values (	nr_seq_reajuste_w, nr_seq_reajuste_p, cd_estabelecimento_p,
					dt_reajuste_w, tx_reajuste_w, ie_indice_reajuste_w,
					ie_tipo_reajuste_w, 1, clock_timestamp(), nm_usuario_p,
					clock_timestamp(), nm_usuario_p, dt_autorizacao_ans_w,
					ds_oficio_ans_w, nr_protocolo_ans_w, nr_seq_contrato_w,
					ie_reajustar_inscricao_w, ie_reajustar_vl_manutencao_w, ie_reajuste_tabela_w,
					ie_aplicacao_reajuste_w, ie_reajustar_copartic_w, tx_reajuste_copartic_w,
					tx_reajuste_copartic_max_w, tx_reajuste_inscricao_w, CASE WHEN ie_tipo_contrato_ww='I' THEN 'N'  ELSE ie_reajustar_via_adic_w END ,
					tx_via_adicional_w, nr_seq_intercambio_w, ie_tipo_contrato_ww,
					nr_seq_plano_w,to_char(dt_reajuste_w,'mm/yyyy'),ie_vinculo_coparticipacao_w, nr_contrato_w,
					ie_situacao_reaj_contrato_w, ie_caracteristica_w, ds_justificativa_w,
					dt_aplicacao_reajuste_w, nr_seq_grupo_produto_w, tx_reajuste_proposto_w,
					'A');

			if (ie_reajustar_copartic_w = 'S') and (tx_reajuste_copartic_w <> 0) then
				select	count(1)
				into STRICT	qt_lote_reaj_copartic_w
				from	pls_lote_reaj_copartic
				where	nr_seq_contrato	= nr_seq_contrato_w
				and	dt_referencia	= dt_reajuste_w
				and	ie_vinculo_coparticipacao = ie_vinculo_coparticipacao_w;

				if (qt_lote_reaj_copartic_w = 0) then
					select	nextval('pls_lote_reaj_copartic_seq')
					into STRICT	nr_seq_lote_reaj_copart_w
					;

					insert	into	pls_lote_reaj_copartic(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
							dt_referencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
							tx_reajuste_vl_maximo, nr_seq_reajuste, ie_vinculo_coparticipacao,
							nr_seq_intercambio)
						values (	nr_seq_lote_reaj_copart_w, nr_seq_contrato_w, cd_estabelecimento_p,
							dt_reajuste_w, clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, tx_reajuste_copartic_w,
							tx_reajuste_copartic_max_w, nr_seq_reajuste_w, ie_vinculo_coparticipacao_w,
							nr_seq_intercambio_w);

					CALL pls_incluir_copartic_lote_reaj(nr_seq_lote_reaj_copart_w, cd_estabelecimento_p, 'N', nm_usuario_p);

					select	count(1)
					into STRICT	qt_regra_copartic_w
					from	pls_reajuste_copartic
					where	nr_seq_lote	= nr_seq_lote_reaj_copart_w;

					if (qt_regra_copartic_w = 0) then
						delete	from	pls_lote_reaj_copartic
						where	nr_sequencia	= nr_seq_lote_reaj_copart_w;
					end if;
				end if;
			end if;

			if (ie_reajustar_inscricao_w = 'S') then
				qt_lote_reaj_inscricao_w	:= 0;
				if (coalesce(nr_seq_intercambio_w,0) <> 0) then
					select	count(1)
					into STRICT	qt_lote_reaj_inscricao_w
					from	pls_lote_reaj_inscricao
					where	nr_seq_intercambio	= nr_seq_intercambio_w
					and	dt_referencia		= dt_reajuste_w;
				else
					select	count(1)
					into STRICT	qt_lote_reaj_inscricao_w
					from	pls_lote_reaj_inscricao
					where	nr_seq_contrato	= nr_seq_contrato_w
					and	dt_referencia	= dt_reajuste_w;
				end if;

				if (qt_lote_reaj_inscricao_w = 0) then
					select	nextval('pls_lote_reaj_inscricao_seq')
					into STRICT	nr_seq_lote_reaj_inscricao_w
					;

					insert	into	pls_lote_reaj_inscricao(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
							dt_referencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
							nr_seq_reajuste, nr_seq_intercambio)
						values (	nr_seq_lote_reaj_inscricao_w, nr_seq_contrato_w, cd_estabelecimento_p,
							dt_reajuste_w, clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, tx_reajuste_inscricao_w,
							nr_seq_reajuste_w, nr_seq_intercambio_w);

					CALL pls_incluir_inscricao_reaj(nr_seq_lote_reaj_inscricao_w, cd_estabelecimento_p, nm_usuario_p);

					select	count(1)
					into STRICT	qt_regra_inscricao_w
					from	pls_reajuste_inscricao
					where	nr_seq_lote	= nr_seq_lote_reaj_inscricao_w;

					if (qt_regra_inscricao_w = 0) then
						delete	from	pls_lote_reaj_inscricao
						where	nr_sequencia	= nr_seq_lote_reaj_inscricao_w;
					end if;
				end if;
			end if;

			if (tx_reajuste_w <> 0) then
				CALL pls_inserir_tabela_reajuste(nr_seq_reajuste_w,null,nm_usuario_p);
			end if;

			select	count(1)
			into STRICT	qt_reaj_inscricao_w
			from	pls_lote_reaj_inscricao
			where	nr_seq_reajuste	= nr_seq_reajuste_w;

			select	count(1)
			into STRICT	qt_reaj_copartic_w
			from	pls_lote_reaj_copartic
			where	nr_seq_reajuste	= nr_seq_reajuste_w;

			select	count(1)
			into STRICT	qt_tabelas_w
			from	pls_reajuste_tabela
			where	nr_seq_reajuste	= nr_seq_reajuste_w;

			if	((qt_reaj_inscricao_w > 0) or (qt_reaj_copartic_w > 0)) and (qt_tabelas_w = 0) then
				update	pls_reajuste
				set	ie_status = '3'
				where	nr_sequencia = nr_seq_reajuste_w;
			end if;

			if (qt_reaj_inscricao_w = 0) and (qt_reaj_copartic_w = 0) and (qt_tabelas_w = 0) then
				delete	from	pls_reajuste
				where	nr_sequencia	= nr_seq_reajuste_w;
			end if;
		end if;

		<<finalCursor01>>
		nr_contrato_w	:= nr_contrato_w;

		end;
	end loop;
	close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_contrato_reajuste ( nr_seq_reajuste_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

