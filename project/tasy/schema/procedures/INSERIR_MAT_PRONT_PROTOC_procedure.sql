-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_pront_protoc ( nr_seq_interno_p bigint, nr_seq_paciente_p bigint, qt_dose_p bigint, cd_intervalo_p text, cd_unidade_medida_p text, ds_dias_aplicacao_p text, ds_ciclos_aplicacao_p text, NM_USUARIO_P text, cd_via_administracao_p text default null, nr_agrupamento_p bigint default null, ie_se_necessario_p text default null, ie_acm_p text default null, ds_justificativa_p text default null) AS $body$
DECLARE

					 
					 
					 
nr_seq_material_w	bigint;
ie_gerar_ciclos_w	varchar(10);
nr_seq_interno_ww	bigint;
nr_agrupamento_w	integer;
cd_protocolo_w		bigint;
cd_pessoa_fisica_w	varchar(10);
nr_sequencia_w		bigint;
cd_convenio_w		bigint;
ie_gerar_pend_quimio_w		varchar(1);

C01 CURSOR FOR 
	SELECT	b.CD_MATERIAL cd_mat_dil, 
		a.CD_MATERIAL, 
		coalesce(b.QT_DOSE,0) qt_dose, 
		b.CD_UNIDADE_MEDIDA, 
		b.DS_DIAS_APLICACAO, 
		b.NR_AGRUPAMENTO,	 
		b.DS_RECOMENDACAO, 
		b.IE_VIA_APLICACAO, 
		b.nr_Seq_diluicao, 
		B.QT_MINUTO_APLICACAO, 
		b.IE_BOMBA_INFUSAO, 
		b.CD_INTERVALO, 
		b.QT_HORA_APLICACAO, 
		b.QT_DIAS_UTIL, 
		b.IE_SE_NECESSARIO, 
		b.IE_APLIC_LENTA,     
		b.IE_URGENCIA,       
		b.IE_APLIC_BOLUS, 
		b.ie_pre_medicacao, 
		b.ie_Agrupador, 
		b.IE_APLICA_REDUCAO, 
		b.IE_LOCAL_ADM, 
		b.nr_seq_interno, 
		b.ie_acm 
	FROM 	PROTOCOLO_MEDIC_MATERIAL B, 
		PROTOCOLO_MEDIC_MATERIAL A, 
		material c 
	WHERE 	a.nr_seq_interno = nr_seq_interno_p 
	 and	a.cd_Material = c.cd_material 
	 AND 	A.CD_PROTOCOLO = B.CD_PROTOCOLO 
	 AND 	A.NR_SEQUENCIA = B.NR_SEQUENCIA 
	 AND 	B.NR_SEQ_DILUICAO = A.NR_SEQ_MATERIAL 
	 AND	B.IE_AGRUPADOR IN (3) 
	 and	c.ie_situacao = 'A' 
	 AND	'S' = OBTER_PERMICAO_CONV_MEDIC(cd_convenio_w,b.nr_sequencia,b.cd_protocolo,b.nr_seq_material) 
	 and	exists (	SELECT	1 
			from	PACIENTE_PROTOCOLO_MEDIC x 
			where	x.nr_seq_paciente	= nr_seq_paciente_p 
			and	x.nr_seq_interno = nr_seq_interno_ww);

c01_w	c01%rowtype;

BEGIN
 
ie_gerar_ciclos_w := obter_param_usuario(6542, 3, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_ciclos_w);
ie_gerar_pend_quimio_w := obter_param_usuario(865, 255, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_pend_quimio_w);
 
select	coalesce(max(nr_seq_material),0) +1 
into STRICT	nr_seq_material_w 
from	paciente_protocolo_medic 
where	nr_seq_paciente	= nr_seq_paciente_p;
 
select nextval('paciente_protocolo_medic_seq') 
into STRICT 	nr_seq_interno_ww
;
 
if (coalesce(ie_gerar_ciclos_w,'N') = 'S') then 
 
	select coalesce(max(nr_agrupamento),0) +1 
	into STRICT	nr_agrupamento_w 
	from 	paciente_protocolo_medic 
	where	nr_seq_paciente	= nr_seq_paciente_p;
	 
end if;
 
insert into paciente_protocolo_medic( 
	nr_seq_paciente, 
	nr_seq_material, 
	cd_material, 
	qt_dose, 
	cd_unidade_medida, 
	ds_dias_aplicacao, 
	dt_atualizacao, 
	nm_usuario, 
	nr_agrupamento, 
	ds_recomendacao, 
	ie_via_aplicacao, 
	nr_seq_diluicao, 
	qt_min_aplicacao, 
	ie_bomba_infusao, 
	cd_intervalo, 
	qt_hora_aplicacao, 
	qt_dias_util, 
	nr_seq_interno, 
	ie_se_necessario, 
	ie_aplic_lenta,     
	ie_urgencia,       
	ie_aplic_bolus, 
	ie_pre_medicacao, 
	ie_alerta_via_adm, 
	ds_ciclos_aplicacao, 
	cd_protocolo, 
	nr_seq_medicacao, 
	ie_aplica_reducao, 
	ie_regra_diluicao_cad_mat, 
	ie_local_adm, 
	nr_seq_prot_med, 
	ds_observacao, 
	ie_acm) 
SELECT 	nr_seq_paciente_p, 
	nr_seq_material_w, 
	CD_MATERIAL, 
	coalesce(qt_dose_p,QT_DOSE), 
	coalesce(cd_unidade_medida_p,CD_UNIDADE_MEDIDA), 
	coalesce(ds_dias_aplicacao_p,DS_DIAS_APLICACAO), 
	clock_timestamp(), 
	NM_USUARIO_P, 
	coalesce(nr_agrupamento_p,coalesce(nr_agrupamento_w,NR_AGRUPAMENTO)), 
	DS_RECOMENDACAO, 
	coalesce(cd_via_administracao_p,IE_VIA_APLICACAO), 
	NR_SEQ_DILUICAO, 
	QT_MINUTO_APLICACAO, 
	IE_BOMBA_INFUSAO, 
	coalesce(cd_intervalo_p,cd_intervalo), 
	QT_HORA_APLICACAO, 
	QT_DIAS_UTIL, 
	nr_seq_interno_ww, 
	coalesce(ie_se_necessario_p,IE_SE_NECESSARIO), 
	IE_APLIC_LENTA,     
	IE_URGENCIA,       
	IE_APLIC_BOLUS, 
	ie_pre_medicacao, 
	IE_ALERTA_VIA_ADM, 
	coalesce(ds_ciclos_aplicacao_p,DS_CICLOS_APLICACAO), 
	CD_PROTOCOLO, 
	NR_SEQUENCIA, 
	coalesce(IE_APLICA_REDUCAO,'S'), 
	coalesce(IE_REGRA_DILUICAO_CAD_MAT,'N'), 
	CASE WHEN ie_gerar_pend_quimio_w='S' THEN  coalesce(IE_LOCAL_ADM,'H')  ELSE coalesce(IE_LOCAL_ADM,'') END , 
	NR_SEQ_interno, 
	substr(ds_justificativa_p,1,255), 
	ie_acm_p 
FROM 	PROTOCOLO_MEDIC_MATERIAL 
WHERE	nr_seq_interno = nr_seq_interno_p;
 
commit;
 
SELECT 	max(cd_protocolo), 
	max(cd_pessoa_fisica), 
	max(nr_seq_medicacao) 
into STRICT  cd_protocolo_w, 
    cd_pessoa_fisica_w, 
	 nr_sequencia_w 
FROM PACIENTE_SETOR 
WHERE NR_SEQ_PACIENTE = nr_seq_paciente_p;
 
select 	max(a.cd_convenio) 
into STRICT	cd_convenio_w 
from	paciente_setor_convenio a, 
	  paciente_setor b 
where 	b.cd_protocolo		= cd_protocolo_w 
and  	b.cd_pessoa_fisica   = cd_pessoa_fisica_w 
and  	a.nr_seq_paciente 	= b.nr_seq_paciente 
and		a.nr_seq_paciente	= nr_seq_paciente_p;
 
if (coalesce(cd_convenio_w::text, '') = '') then 
	select 	max(a.cd_convenio) 
	into STRICT	cd_convenio_w 
	from	paciente_setor_convenio a, 
			paciente_setor b 
	where 	b.cd_protocolo		= cd_protocolo_w 
	and  	b.cd_pessoa_fisica   = cd_pessoa_fisica_w 
	and  	a.nr_seq_paciente 	= b.nr_seq_paciente;
end if;
 
open C01;
loop 
fetch C01 into	 
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	INSERT INTO PACIENTE_PROTOCOLO_MEDIC( 
			NR_SEQ_PACIENTE, 
			NR_SEQ_MATERIAL, 
			CD_MATERIAL, 
			qt_dose, 
			CD_UNIDADE_MEDIDA, 
			DS_DIAS_APLICACAO, 
			DT_ATUALIZACAO, 
			NM_USUARIO, 
			NR_AGRUPAMENTO, 
			DS_RECOMENDACAO, 
			IE_VIA_APLICACAO, 
			NR_SEQ_DILUICAO, 
			QT_MIN_APLICACAO, 
			IE_BOMBA_INFUSAO, 
			CD_INTERVALO, 
			QT_HORA_APLICACAO, 
			QT_DIAS_UTIL, 
			NR_SEQ_INTERNO, 
			IE_SE_NECESSARIO, 
			IE_APLIC_LENTA,     
			IE_URGENCIA,       
			IE_APLIC_BOLUS, 
			ie_pre_medicacao, 
			CD_PROTOCOLO, 
			NR_SEQ_MEDICACAO, 
			ie_agrupador, 
			IE_APLICA_REDUCAO, 
			IE_LOCAL_ADM, 
			NR_SEQ_PROT_MED, 
			ie_acm) 
		values	(NR_SEQ_PACIENTE_P, 
			(SELECT	coalesce(max(x.nr_seq_material),0) +1 from paciente_protocolo_medic x where x.nr_seq_paciente = nr_seq_paciente_p),	 
			c01_w.CD_MAT_dil, 
			c01_w.QT_DOSE, 
			c01_w.CD_UNIDADE_MEDIDA, 
			coalesce(ds_dias_aplicacao_p,c01_w.DS_DIAS_APLICACAO), 
			clock_timestamp(), 
			NM_USUARIO_P, 
			c01_w.NR_AGRUPAMENTO,	 
			c01_w.DS_RECOMENDACAO, 
			c01_w.IE_VIA_APLICACAO, 
			nr_seq_material_w, 
			coalesce(obter_tempo_dil_mat(nr_seq_paciente_p, c01_w.cd_material, c01_w.cd_mat_dil),c01_w.QT_MINUTO_APLICACAO), 
			c01_w.IE_BOMBA_INFUSAO, 
			c01_w.CD_INTERVALO, 
			c01_w.QT_HORA_APLICACAO, 
			c01_w.QT_DIAS_UTIL, 
			nextval('paciente_protocolo_medic_seq'), 
			c01_w.IE_SE_NECESSARIO, 
			c01_w.IE_APLIC_LENTA,     
			c01_w.IE_URGENCIA,       
			c01_w.IE_APLIC_BOLUS, 
			c01_w.ie_pre_medicacao, 
			CD_PROTOCOLO_W, 
			NR_SEQUENCIA_W, 
			c01_w.ie_Agrupador, 
			c01_w.IE_APLICA_REDUCAO, 
			CASE WHEN ie_gerar_pend_quimio_w='S' THEN  coalesce(c01_w.IE_LOCAL_ADM,'H')  ELSE coalesce(c01_w.IE_LOCAL_ADM,'') END , 
			c01_w.nr_seq_interno, 
			c01_w.ie_acm);
			 
	commit;
	end;
end loop;
close C01;
 
if (coalesce(ie_gerar_ciclos_w,'N') = 'S') then 
 
		CALL atualizar_dose_onc_protocolo(nr_seq_paciente_p);
		CALL alterar_medic_trat_onc(nr_seq_paciente_p,nr_seq_interno_ww,1,nm_usuario_p);				
		 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_pront_protoc ( nr_seq_interno_p bigint, nr_seq_paciente_p bigint, qt_dose_p bigint, cd_intervalo_p text, cd_unidade_medida_p text, ds_dias_aplicacao_p text, ds_ciclos_aplicacao_p text, NM_USUARIO_P text, cd_via_administracao_p text default null, nr_agrupamento_p bigint default null, ie_se_necessario_p text default null, ie_acm_p text default null, ds_justificativa_p text default null) FROM PUBLIC;

