-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_senha_agenda ( nr_seq_senha_p text, cd_agenda_p text, nr_seq_agenda_p text) AS $body$
DECLARE

 
cd_tipo_agenda_w	bigint;
ie_consistir_age_w	varchar(10);
ie_vincular_w		varchar(1) := 'S';


BEGIN 
ie_consistir_age_w := obter_param_usuario(10021, 163, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_consistir_age_w);
 
if (ie_consistir_age_w = 'S') then 
	select 	CASE WHEN coalesce(ie_tipo, 'R')='A' THEN  'S'  ELSE 'N' END  
	into STRICT 	ie_vincular_w 
	from 	fila_espera_senha a, 
		paciente_senha_fila b 
	where 	b.nr_sequencia = nr_seq_senha_p 
	and	a.nr_sequencia = b.nr_seq_fila_senha;
end if;
 
if (ie_vincular_w = 'S') then 
	if (cd_agenda_p <> 0) then 
		select 	cd_tipo_agenda 
		into STRICT	cd_tipo_agenda_w 
		from 	agenda 
		where 	cd_agenda = cd_agenda_p;
		if (cd_tipo_agenda_w in (1,2)) then 
			update 	agenda_paciente 
			set 	nr_seq_pac_senha_fila = nr_seq_senha_p 
			where 	nr_sequencia = nr_seq_agenda_p;
		elsif (cd_tipo_agenda_w in (3,4,5)) then 
			update 	agenda_consulta 
			set 	nr_seq_pac_senha_fila = nr_seq_senha_p 
			where 	nr_sequencia = nr_seq_agenda_p;
		end if;
	 	CALL executar_evento_agenda_geral('AGS',null,nr_seq_agenda_p,cd_tipo_agenda_w,wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario);
	elsif (nr_seq_senha_p IS NOT NULL AND nr_seq_senha_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then 
		update	agenda_integrada 
		set	nr_seq_pac_senha_fila = nr_seq_senha_p 
		where	nr_sequencia = nr_seq_agenda_p;
	end if;
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_senha_agenda ( nr_seq_senha_p text, cd_agenda_p text, nr_seq_agenda_p text) FROM PUBLIC;

