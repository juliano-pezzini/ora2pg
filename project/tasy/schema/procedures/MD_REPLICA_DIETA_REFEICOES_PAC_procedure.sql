-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE md_replica_dieta_refeicoes_pac ( nr_sequencia_p bigint, nr_atendimento_p text, cd_setor_atendimento_p text, dt_dieta_p timestamp, cd_dieta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
ie_replicar_dieta_w		varchar(1);
nr_seq_superior_w		bigint;
cd_refeicao_w                   varchar(3);
ie_superior_w			varchar(1);
nr_seq_superior_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	mapa_dieta
	where	nr_atendimento = nr_atendimento_p
	and	cd_setor_atendimento = cd_setor_atendimento_p
	and	(dt_dieta between trunc(dt_dieta_p) and trunc(dt_dieta_p)+86399/86400
	or	((ie_replicar_dieta_w = 'T') and (trunc(dt_dieta) >= dt_dieta_p)))
	and	coalesce(dt_liberacao::text, '') = ''
	and 	((coalesce(nr_seq_superior::text, '') = '' and ie_superior_w = 'N') or (ie_superior_w = 'S'))
	and 	cd_refeicao <> cd_refeicao_w;



BEGIN

ie_replicar_dieta_w := Obter_Valor_Param_Usuario(1000, 87, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

select 	max(CASE WHEN coalesce(nr_seq_superior::text, '') = '' THEN 'N'  ELSE 'S' END ),
	max(cd_refeicao)
into STRICT 	ie_superior_w,
	cd_refeicao_w
from 	mapa_dieta
where 	nr_sequencia = nr_sequencia_p;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_dieta_p IS NOT NULL AND cd_dieta_p::text <> '') then

	open C01;
	loop
		fetch C01 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin



		if ( ie_superior_w = 'N') then

			update 	mapa_dieta
			set	cd_dieta 	= cd_dieta_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_w;

		else
			insert into mapa_dieta( nr_sequencia,
						ie_recem_nato,
						cd_dieta,
						cd_pessoa_fisica,
						dt_dieta,
						cd_refeicao,
						ie_destino_dieta,
						dt_atualizacao,
						nm_usuario,
						cd_setor_atendimento,
						cd_unidade_basica,
						cd_unidade_compl,
						nr_seq_superior)
				SELECT 		nextval('mapa_dieta_seq'),
						ie_recem_nato,
						cd_dieta_p,
						cd_pessoa_fisica,
						dt_dieta,
						cd_refeicao,
						ie_destino_dieta,
						clock_timestamp(),
						nm_usuario_p,
						cd_setor_atendimento,
						cd_unidade_basica,
						cd_unidade_compl,
						nr_sequencia_w
				from		mapa_dieta
				where		nr_sequencia  =  nr_sequencia_w;
		end if;
		end;
	end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE md_replica_dieta_refeicoes_pac ( nr_sequencia_p bigint, nr_atendimento_p text, cd_setor_atendimento_p text, dt_dieta_p timestamp, cd_dieta_p bigint, nm_usuario_p text) FROM PUBLIC;

