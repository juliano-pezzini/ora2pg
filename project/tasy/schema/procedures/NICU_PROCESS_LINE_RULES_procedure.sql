-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nicu_process_line_rules () AS $body$
DECLARE


exeption_w      	exception;
day_count_w			nicu_clinical_rule_color.nr_sequencia%type;
qt_yellow_low_w		nicu_clinical_rule_color.qt_yellow_low%type;
qt_red_low_w		nicu_clinical_rule_color.qt_red_low%type;
qt_yellow_high_w	nicu_clinical_rule_color.qt_yellow_high%type;
qt_red_high_w		nicu_clinical_rule_color.qt_red_high%type;
ie_color_w			nicu_observation.ie_color%type;		

C01 CURSOR FOR
	SELECT *
	from  nicu_observation a
	where id_rule in ('CVS_PIV',
					'CVS_UAC',
					'CVS_UVC',
					'CVS_Arterial_Line',
					'CVS_PICC',
					'CVS_NEO_PED_PICC',
					'CVS_PICC_Midline',
					'CVS_CLine',
					'CVS_Epidural',
					'CVS_RALine',
					'CVS_RVLine',
					'CVS_LALine',
					'CVS_PALine',
					'CVS_IO_Line',
					'CVS_NCED')
	and   cd_snomed_in = '702663001' 
	and   not exists (SELECT 1
					from    nicu_observation b
					where   a.nr_seq_patient = b.nr_seq_patient
					and     a.id_rule = b.id_rule
					and     b.cd_snomed_in = '175853000' 
					and     b.nr_sequencia > a.nr_sequencia)
	ORDER BY NR_SEQ_PATIENT;
  c01_w	c01%rowtype;

BEGIN
open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	select  max(trunc(clock_timestamp()) - trunc(to_date(value_result,'mm/dd/yyyy hh24:mi:ss'))) day_count
	INTO STRICT	day_count_w
	from    nicu_observation
	where   nr_seq_patient = c01_w.nr_seq_patient
	AND		dt_atualizacao_nrec = c01_w.dt_atualizacao_nrec
	AND		id_rule = c01_w.id_rule
	and     cd_snomed_in = '233527006';	
	
	SELECT	max(qt_yellow_low),
			max(qt_red_low),
			max(qt_yellow_high),
			max(qt_red_high)
	INTO STRICT	qt_yellow_low_w,
			qt_red_low_w,
			qt_yellow_high_w,
			qt_red_high_w
	FROM	nicu_clinical_rule_color
	WHERE	id_rule = c01_w.id_rule
	AND		cd_snomed_child = c01_w.cd_snomed_in
	AND		cd_snomed_source = c01_w.cd_snomed_in;
	
	IF (qt_red_low_w IS NOT NULL AND qt_red_low_w::text <> '') AND (DAY_COUNT_W	<= qt_red_low_w) THEN
		ie_color_w := 'R';
	ELSIF (qt_red_high_w IS NOT NULL AND qt_red_high_w::text <> '') and (day_count_w >= qt_red_high_w) THEN
		ie_color_w := 'R';
	ELSIF (qt_yellow_low_w IS NOT NULL AND qt_yellow_low_w::text <> '') AND (day_count_w	<= qt_yellow_low_w) THEN
		ie_color_w := 'Y';
	ELSIF (qt_yellow_high_w IS NOT NULL AND qt_yellow_high_w::text <> '') AND (day_count_w 	>= qt_yellow_high_w) THEN
		ie_color_w := 'Y';
	end if;
	
	
	UPDATE	nicu_observation
	SET		value_result = day_count_w,
			ie_color = ie_color_w
	WHERE	nr_sequencia = c01_w.nr_sequencia;
	
	end;
end loop;
close C01;

  commit;

exception
  when exeption_w then
   rollback;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nicu_process_line_rules () FROM PUBLIC;

