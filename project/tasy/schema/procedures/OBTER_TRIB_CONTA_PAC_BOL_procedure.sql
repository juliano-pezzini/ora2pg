-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_trib_conta_pac_bol ( cd_estabelecimento_p bigint, cd_convenio_p bigint, dt_referencia_p timestamp, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_tributo_in_p bigint, pr_aliquota_p INOUT bigint, nr_seq_regra_p INOUT bigint ) AS $body$
DECLARE

C01 CURSOR FOR
	SELECT	a.pr_imposto,
		a.nr_sequencia,
		b.cd_tributo
	from	regra_calculo_imposto a,
		tributo b,
        tributo_regra_deferido c
	where	b.cd_tributo = cd_tributo_in_p
    and a.cd_tributo = b.cd_tributo
    and a.cd_tributo = c.cd_tributo 
	and (coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p)
	and (coalesce(b.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p)
	and	coalesce(a.cd_convenio, coalesce(cd_convenio_p,0))= coalesce(cd_convenio_p,0)
	and ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_referencia_p) between a.dt_vigencia and coalesce(a.dt_fim_vigencia, dt_referencia_p)
	and	coalesce(a.cd_area_procedimento, cd_area_procedimento_p) = cd_area_procedimento_p
	and	coalesce(a.cd_especialidade, cd_especialidade_p) = cd_especialidade_p
	and	coalesce(a.cd_grupo_proc, cd_grupo_proc_p) = cd_grupo_proc_p
	and	coalesce(a.cd_procedimento, cd_procedimento_p) = cd_procedimento_p
	and	coalesce(a.ie_origem_proced, ie_origem_proced_p) = ie_origem_proced_p
	and	coalesce(a.cd_grupo_material, cd_grupo_material_p) = cd_grupo_material_p
	and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_p) = cd_subgrupo_material_p
	and	coalesce(a.cd_classe_material, cd_classe_material_p) = cd_classe_material_p
	and	coalesce(a.cd_material, cd_material_p) = cd_material_p
	and	b.ie_situacao = 'A'
	order by	coalesce(a.cd_procedimento, 0),
		coalesce(a.ie_origem_proced, 0),
		coalesce(a.cd_grupo_proc, 0),
		coalesce(a.cd_especialidade, 0),
		coalesce(a.cd_area_procedimento, 0),
		coalesce(a.cd_material, 0),
		coalesce(a.cd_classe_material, 0),
		coalesce(a.cd_subgrupo_material, 0),
		coalesce(a.cd_grupo_material, 0),
		coalesce(a.cd_convenio, 0);

BEGIN

    for dados_w in C01 loop
    
            pr_aliquota_p	:= dados_w.pr_imposto;
            nr_seq_regra_p	:= dados_w.nr_sequencia;
    end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_trib_conta_pac_bol ( cd_estabelecimento_p bigint, cd_convenio_p bigint, dt_referencia_p timestamp, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_tributo_in_p bigint, pr_aliquota_p INOUT bigint, nr_seq_regra_p INOUT bigint ) FROM PUBLIC;

