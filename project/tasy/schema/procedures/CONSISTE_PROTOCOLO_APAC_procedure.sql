-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_protocolo_apac ( nr_seq_protocolo_p bigint, nm_usuario_p text, ie_somente_consiste_p text) AS $body$
DECLARE

 
nr_interno_conta_w			bigint;
nr_atendimento_w			bigint;
nr_sequencia_apac_w		bigint;
qt_apac_com_erro_w		integer;
qt_outros_erro_w			integer;
ie_status_protocolo_w		smallint;
dt_intergracao_cr_w			timestamp;
qt_apac_11_w			integer;
qt_apac_13_w			integer;

 
C01 CURSOR FOR 
SELECT	b.nr_interno_conta, 
	b.nr_atendimento, 
	a.nr_sequencia 
from	sus_apac_movto a, 
	conta_paciente b 
where	b.nr_seq_protocolo	= nr_seq_protocolo_p 
and	b.nr_atendimento	= a.nr_atendimento;

 

BEGIN 
 
select	ie_status_protocolo, 
	dt_integracao_cr 
into STRICT	ie_status_protocolo_w, 
	dt_intergracao_cr_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
/* Passar o protocolo de 2-definitivo para 1-provisório */
 
if (ie_status_protocolo_w	= 2) and (ie_somente_consiste_p	= 'N') then 
	begin 
	if (dt_intergracao_cr_w IS NOT NULL AND dt_intergracao_cr_w::text <> '') then 
		--(-20011,'Não permite abrir protocolo integrado c/contas a receber'); 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(231619);
	end if;
 
	update	protocolo_convenio 
	set	ie_status_protocolo	= 1, 
		nm_usuario	= nm_usuario_p, 
		dt_atualizacao	= clock_timestamp() 
	where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
	CALL Desfazer_Protocolo_Repasse(nr_seq_protocolo_p, nm_usuario_p); /* Felipe OS 56784 - 10/05/2007 */
	end;
end if;
 
/* Passar o protocolo de 1-provisório para 2-definitivo */
 
if (ie_status_protocolo_w	= 1) then 
	BEGIN 
 
	select	count(*) 
	into STRICT	qt_apac_11_w 
	from	conta_paciente b, 
		sus_apac_movto a 
	where	a.nr_interno_conta	= b.nr_interno_conta 
	and	b.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	length(a.nr_apac)	< 13;
 
	select	count(*) 
	into STRICT	qt_apac_13_w 
	from	conta_paciente b, 
		sus_apac_movto a 
	where	a.nr_interno_conta	= b.nr_interno_conta 
	and	b.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	length(a.nr_apac)	= 13;
 
	if (qt_apac_11_w 	> 0) and (qt_apac_13_w 	> 0) then 
		--(-20011,'Existem APAC com 11 e 13 dígitos neste protocolo, deve separar as contas em protocolos diferentes.'); 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(231620);
	end if;
 
	qt_outros_erro_w		:= 0;
	qt_apac_com_erro_w	:= 0;
 
	/* Consistência das contas do protocolo */
 
	open C01;
	loop 
		fetch C01	into 
			nr_interno_conta_w, 
			nr_atendimento_w, 
			nr_sequencia_apac_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			CALL consiste_sus_apac(nr_sequencia_apac_w,nm_usuario_p);
			end;
	end loop;
	close C01;			
 
	/* Verificar se existem contas com erros */
 
	select	count(*) 
	into STRICT	qt_apac_com_erro_w 
	from	sus_apac_movto a, 
		conta_paciente b 
	where	b.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	b.nr_interno_conta	= a.nr_interno_conta 
	and	b.nr_atendimento	= a.nr_atendimento 
	and	(a.ds_inconsistencia IS NOT NULL AND a.ds_inconsistencia::text <> '');
 
	/* Somente passa protocolo para definitivo se não tiver erro em nenhuma conta */
 
	if (qt_apac_com_erro_w	= 0) and (qt_outros_erro_w	= 0) and (ie_somente_consiste_p	= 'N') then 
		begin 
		update 	protocolo_convenio 
		set	ie_status_protocolo	= 2, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao	= clock_timestamp(), 
			ds_inconsistencia	 = NULL 
		where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
		CALL gerar_protocolo_conv_repasse(nr_seq_protocolo_p, nm_usuario_p,null); /* Felipe OS 56784 - 10/05/2007 */
		end;
	end if;
	if (qt_apac_com_erro_w <> 0 ) or (qt_outros_erro_w  <> 0) then 
		--(-20011,'Existe APAC inconsistente vinculada a esse protocolo. Verifique na pasta Inconsistentes.'); 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(231621);
	end if;
	 
	END;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_protocolo_apac ( nr_seq_protocolo_p bigint, nm_usuario_p text, ie_somente_consiste_p text) FROM PUBLIC;

