-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_alt_venc_tit_rec_arq (nr_titulo_p bigint, dt_anterior_p timestamp, dt_vencimento_p timestamp, dt_alteracao_p timestamp, ds_observacao_p text, dt_atualizacao_p timestamp, nm_usuario_p text, nr_externo_p text) AS $body$
DECLARE



nr_sequencia_w		bigint;
qt_externo_w		bigint;


/*
Procedure utilizada para importação padrão WHEB das alterações de vencimento de títulos a receber
Usar interface 1622 - "Integração WHEB - Importar Alt. Vencto. Títulos a receber 1.0"
*/
BEGIN

IF (coalesce(nr_titulo_p::text, '') = '') THEN
	--R.AISE_APPLICATION_ERROR(-20011,'Título não encontrado');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267406);
ELSE
	SELECT 	coalesce(MAX(nr_sequencia),0) + 1
	INTO STRICT	nr_sequencia_w
	FROM	alteracao_vencimento
	WHERE	nr_titulo = nr_titulo_p;
END IF;

select	count(*)
into STRICT	qt_externo_w
from 	alteracao_vencimento
where	nr_titulo	= nr_titulo_p
and	nr_externo 	= nr_externo_p;

if (qt_externo_w = 0) then
	begin
	INSERT 	INTO 	alteracao_vencimento(nr_sequencia,
						ds_observacao,
						dt_alteracao,
						dt_anterior,
						dt_atualizacao,
						dt_vencimento,
						nm_usuario,
						nr_titulo,
						nr_externo)
				VALUES (nr_sequencia_w,
						ds_observacao_p,
						dt_alteracao_p,
						dt_anterior_p,
						dt_atualizacao_p,
						dt_vencimento_p,
						nm_usuario_p,
						nr_titulo_p,
						nr_externo_p);

	UPDATE	titulo_receber
	SET	dt_pagamento_previsto	= dt_vencimento_p
	WHERE	nr_titulo		= nr_titulo_p;

	COMMIT;
	end;

/*else

	insert into log_tasy
		(cd_log,
		nm_usuario,
		dt_atualizacao,
		ds_log)
	values	(55783,
		'IMP_WHEB',
		sysdate,
		'Erro ao inserir o título ' || nr_titulo_p || chr(13) || chr(10) ||
		'Erro: Esta alteração de vencimento já foi importada!');*/
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_alt_venc_tit_rec_arq (nr_titulo_p bigint, dt_anterior_p timestamp, dt_vencimento_p timestamp, dt_alteracao_p timestamp, ds_observacao_p text, dt_atualizacao_p timestamp, nm_usuario_p text, nr_externo_p text) FROM PUBLIC;

