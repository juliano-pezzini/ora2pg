-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lancto_automatico_lente ( nr_atendimento_p bigint, nr_seq_consulta_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	nr_sequencia
	from	oft_consulta_lente
	where	nr_seq_consulta	= nr_seq_consulta_p
	and	coalesce(dt_lancamento::text, '') = '';


nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;
cd_setor_usuario_w	integer;
dt_entrada_unidade_w	timestamp;
cd_unidade_medida_w	varchar(30);
nr_seq_atepacu_w	bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
nr_doc_convenio_w	varchar(20);
ie_tipo_guia_w		varchar(2);
cd_senha_w		varchar(20);
cd_estab_w		bigint;
dt_entrada_unidade_ww	timestamp;
cd_pessoa_fisica_w	varchar(10);
nr_seq_interno_w	bigint;
nr_seq_lente_w		bigint;
cd_material_w		integer;
nr_seq_lente_ww		bigint;
cd_local_estoque_w	smallint := null;
ie_local_estoque_w	varchar(15);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_perfil_w				perfil.cd_perfil%type;
nm_usuario_w			usuario.nm_usuario%type;





BEGIN
cd_estabelecimento_w		:= wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w					:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w				:= wheb_usuario_pck.get_nm_usuario;
cd_setor_usuario_w		:= wheb_usuario_pck.get_cd_setor_atendimento;

cd_local_estoque_w 		:= cd_local_estoque_p;
if (coalesce(cd_local_estoque_w,0) = 0) then
	ie_local_estoque_w := obter_param_usuario(3010, 2, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_local_estoque_w);
	if (ie_local_estoque_w = '1') then
		select 	max(cd_local_estoque)
		into STRICT		cd_local_estoque_w
		from 		setor_atendimento
		where  	cd_setor_atendimento = cd_setor_usuario_w;
	end if;

end if;

nr_seq_atepacu_w := obter_atepacu_paciente(nr_atendimento_p,'A');

SELECT * FROM obter_convenio_execucao(nr_atendimento_p, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;

select	cd_estabelecimento
into STRICT	cd_estab_w
from  	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

if 	(nr_seq_consulta_p > 0 AND nr_seq_atepacu_w > 0) then

	open C01;
	loop
	fetch C01 into
		nr_seq_lente_ww;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	coalesce(max(nr_seq_lente),0)
		into STRICT	nr_seq_lente_w
		from	oft_consulta_lente
		where	nr_sequencia	=	nr_seq_lente_ww;

		if (nr_seq_lente_w > 0) then
			select	coalesce(max(cd_material),0)
			into STRICT	cd_material_w
			from	oft_lente_contato
			where	nr_sequencia	=	nr_seq_lente_w;
		end if;

		if (cd_material_w > 0) then

			select	cd_setor_Atendimento,
				dt_entrada_unidade
			into STRICT	cd_setor_atendimento_w,
				dt_entrada_unidade_w
			from	atend_paciente_unidade
			where	nr_seq_interno = nr_seq_atepacu_w;

			select	nextval('material_atend_paciente_seq')
			into STRICT	nr_sequencia_w
			;

			select	substr(obter_dados_material_estab(cd_material,cd_estab_w,'UMS'),1,30) cd_unidade_medida_consumo
			into STRICT	cd_unidade_medida_w
			from	material
			where	cd_material = cd_material_w;


			insert into material_atend_paciente(
					nr_sequencia,
					cd_material,
					dt_atendimento,
					cd_senha,
					cd_convenio,
					nr_doc_convenio,
					ie_tipo_guia,
					cd_categoria,
					nr_seq_atepacu,
					cd_setor_atendimento,
					cd_material_exec,
					qt_executada,
					vl_unitario,
					qt_ajuste_conta,
					cd_situacao_glosa,
					ie_valor_informado,
					ie_guia_informada,
					ie_auditoria,
					dt_entrada_unidade,
					qt_material,
					cd_local_estoque,
					dt_Atualizacao,
					nm_usuario,
					nm_usuario_original,
					nr_atendimento,
					cd_unidade_medida,
					cd_acao)
			values (	nr_sequencia_w,
					cd_material_w,
					clock_timestamp(),
					cd_senha_w,
					cd_convenio_w,
					nr_doc_convenio_w,
					ie_tipo_guia_w,
					cd_categoria_w,
					nr_seq_atepacu_w,
					cd_setor_atendimento_w,
					cd_material_w,
					1,
					0,
					0,
					0,
					'N',
					'N',
					'N',
					dt_entrada_unidade_w,
					1,
					cd_local_estoque_w,
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					nr_atendimento_p,
					cd_unidade_medida_w,
					'1');

			CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);

			update	oft_consulta_lente
			set	dt_lancamento	=	clock_timestamp()
			where	nr_sequencia	=	nr_seq_lente_ww;
		end if;
		end;
	end loop;
	close C01;



commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lancto_automatico_lente ( nr_atendimento_p bigint, nr_seq_consulta_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

