-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE add_clinical_notes_ref_from ( nr_atendimento_p bigint, dt_reference_p timestamp, cd_referred_department_p bigint, cd_referred_doctor_p text, cd_medical_institution_p text, cd_medical_department_p bigint, cd_referring_doctor_p text, cd_postal_p text, ds_address_p text, nr_phone_p text, nr_seq_calculation_type_p bigint, dt_calculation_type_p timestamp, nm_usuario_p text, tab_selected_p bigint, nr_seq_rl_rp_p bigint) AS $body$
DECLARE



ds_evolucao_w  evolucao_paciente.ds_evolucao%TYPE;
expressao_titulo_w varchar(255);
expressao_dt_referencia_w varchar(255);
expressao_departament_w varchar(255);
desc_departament_w departamento_medico.ds_departamento%TYPE;
desc_ref_doctor_w medico.nm_guerra%TYPE;
expressao_ref_doctor_w varchar(255);
expressao_inst_medica varchar(255);
desc_inst_medica pessoa_juridica.nm_fantasia%TYPE;
expressao_dep_medic varchar(255);
desc_dep_medic departamento_medico.ds_departamento%TYPE;
expressao_ref_medic varchar(255);
desc_ref_medic  medico.nm_guerra%TYPE;
expressao_post_cod varchar(255);
expressao_address varchar(255);
expressao_phone varchar(255);
expressao_calc_type varchar(255);
expressao_dt_type varchar(255);
nr_sequencia_history_w bigint;


BEGIN

    IF (tab_selected_p = 1) THEN
        select obter_desc_expressao_idioma(968438, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_titulo_w
;

        select nr_sequencia
        into STRICT nr_sequencia_history_w
        from rl_history
        where NR_SEQ_RL_REF_FROM_HOSP = nr_seq_rl_rp_p;

        CALL update_status_rl_history(nr_sequencia_history_w, 2);
    END IF;

    IF (tab_selected_p = 2) THEN
        select obter_desc_expressao_idioma(1048593, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_titulo_w
;

        select nr_sequencia
        into STRICT nr_sequencia_history_w
        from rl_history
        where NR_SEQ_RL_REP_TO_HOSP = nr_seq_rl_rp_p;

        CALL update_status_rl_history(nr_sequencia_history_w, 3);
    END IF;

    IF (tab_selected_p = 3) THEN
        select obter_desc_expressao_idioma(1048591, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_titulo_w
;

        select nr_sequencia
        into STRICT nr_sequencia_history_w
        from rl_history
        where NR_SEQ_RL_REF_TO_HOSP = nr_seq_rl_rp_p;

        CALL update_status_rl_history(nr_sequencia_history_w, 3);
    END IF;

    IF (tab_selected_p = 4) THEN
        select obter_desc_expressao_idioma(1048577, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_titulo_w
;

        select nr_sequencia
        into STRICT nr_sequencia_history_w
        from rl_history
        where NR_SEQ_RL_REP_FROM_HOSP = nr_seq_rl_rp_p;

        CALL update_status_rl_history(nr_sequencia_history_w, 2);
    END IF;

     ds_evolucao_w := '<html tasy="html5"><body><p style="text-align:left;"><strong>' || expressao_titulo_w || '</strong>';

    IF (dt_reference_p IS NOT NULL AND dt_reference_p::text <> '') THEN
        select obter_desc_expressao_idioma(286752, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_dt_referencia_w
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_dt_referencia_w || '-' || trunc(dt_reference_p) || '</p>';
    END IF;

    IF (cd_referred_department_p IS NOT NULL AND cd_referred_department_p::text <> '') THEN
      BEGIN
    
        select obter_desc_expressao_idioma(1048508, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_departament_w
;

        select ds_departamento 
        into STRICT desc_departament_w
        from departamento_medico
        where cd_departamento = cd_referred_department_p
        AND  IE_SITUACAO = 'A';

        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_departament_w || '-' || desc_departament_w || '</p>';
     END;
    END IF;

     IF (cd_referred_doctor_p IS NOT NULL AND cd_referred_doctor_p::text <> '') THEN
      BEGIN
    
        select obter_desc_expressao_idioma(1048575, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_ref_doctor_w
;

        select  a.nm_guerra
        into STRICT    desc_ref_doctor_w
        from    medico a,
                departamento_setor b
        Where   a.cd_setor_atendimento = b.cd_setor_atendimento
        and     b.cd_departamento = cd_referred_department_p
        and     a.cd_pessoa_fisica = cd_referred_doctor_p
        and     a.ie_situacao = 'A';

        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_ref_doctor_w || '-' || desc_ref_doctor_w || '</p>';
     END;
    END IF;
    
    IF (cd_medical_institution_p IS NOT NULL AND cd_medical_institution_p::text <> '') THEN
         
        select nm_fantasia
        into STRICT desc_inst_medica
        from pessoa_juridica 
        where cd_cgc = cd_medical_institution_p;

        select obter_desc_expressao_idioma(1048496, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_inst_medica
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_inst_medica || '-' || desc_inst_medica || '</p>';

    END IF;

    IF (cd_medical_department_p IS NOT NULL AND cd_medical_department_p::text <> '') THEN
        select ds_departamento
        into STRICT desc_dep_medic
        from departamento_medico 
        where cd_departamento = cd_medical_department_p;

        select obter_desc_expressao_idioma(1048496, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_dep_medic
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_dep_medic || '-' || desc_dep_medic || '</p>';

    END IF;

    IF (cd_referring_doctor_p IS NOT NULL AND cd_referring_doctor_p::text <> '') THEN
    
        select nm_guerra ds
        into STRICT desc_ref_medic
        from medico
        where cd_pessoa_fisica = cd_referring_doctor_p;

        select obter_desc_expressao_idioma(701518, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_ref_medic
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_ref_medic || '-' || desc_inst_medica || '</p>';

    END IF;

    IF (cd_postal_p IS NOT NULL AND cd_postal_p::text <> '') THEN
      
        select obter_desc_expressao_idioma(284796, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_post_cod
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_post_cod || '-' || cd_postal_p || '</p>';

    END IF;

    IF (ds_address_p IS NOT NULL AND ds_address_p::text <> '') THEN
      
        select obter_desc_expressao_idioma(289232, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_address
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_address || '-' || ds_address_p || '</p>';

    END IF;

   IF (nr_phone_p IS NOT NULL AND nr_phone_p::text <> '') THEN
      
        select obter_desc_expressao_idioma(290210, null, wheb_usuario_pck.get_nr_seq_idioma)
        into STRICT expressao_phone
;
        
        ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_phone || '-' || nr_phone_p || '</p>';

   END IF;

   IF (nr_seq_calculation_type_p IS NOT NULL AND nr_seq_calculation_type_p::text <> '') THEN
   
       select obter_desc_expressao_idioma(1048528, null, wheb_usuario_pck.get_nr_seq_idioma)
       into STRICT expressao_calc_type
;

   END IF;
   
    IF (dt_calculation_type_p IS NOT NULL AND dt_calculation_type_p::text <> '') THEN
   
       select obter_desc_expressao_idioma(288398, null, wheb_usuario_pck.get_nr_seq_idioma)
       into STRICT expressao_dt_type
;
     
       ds_evolucao_w := ds_evolucao_w || '<p style="text-align:left;">' || expressao_dt_type || '-' || trunc(dt_calculation_type_p) || '</p>';

   END IF;


	CALL medical_guidance_order_epc(
		NR_ATENDIMENTO_P => nr_atendimento_p,
		NR_SEQ_EXTER_REFER_P => nr_seq_rl_rp_p,
		IE_ORI_EXTER_REFER_P => tab_selected_p,
		NM_USUARIO_P => nm_usuario_p
	);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE add_clinical_notes_ref_from ( nr_atendimento_p bigint, dt_reference_p timestamp, cd_referred_department_p bigint, cd_referred_doctor_p text, cd_medical_institution_p text, cd_medical_department_p bigint, cd_referring_doctor_p text, cd_postal_p text, ds_address_p text, nr_phone_p text, nr_seq_calculation_type_p bigint, dt_calculation_type_p timestamp, nm_usuario_p text, tab_selected_p bigint, nr_seq_rl_rp_p bigint) FROM PUBLIC;

