-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inst_epc_psm_data ( CD_PESSOA_FISICA_P EPC_PSM_DATA.CD_PESSOA_FISICA%TYPE, NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, NM_USUARIO_P EPC_PSM_DATA.NM_USUARIO%TYPE, NM_USUARIO_NREC_P EPC_PSM_DATA.NM_USUARIO_NREC%TYPE, CD_ESTABELECIMENTO_P ESTABELECIMENTO.CD_ESTABELECIMENTO%TYPE ) AS $body$
DECLARE

NM_CHILD_NAME	EPC_PSM_DATA.NM_CHILD_NAME%TYPE;
DT_CHILD_DOB  EPC_PSM_DATA.DT_CHILD_DOB%TYPE;
NM_CHILD_POB  EPC_PSM_DATA.NM_CHILD_POB%TYPE;
IE_CHILD_SEXO  EPC_PSM_DATA.IE_SEXO%TYPE;
NM_FATHER_NAME  EPC_PSM_DATA.NM_FATHER_NAME%TYPE;
NM_MOTHER_NAME  EPC_PSM_DATA.NM_MOTHER_NAME%TYPE;
NM_MOTHER_DEGREE  EPC_PSM_DATA.NM_MOTHER_DEGREE%TYPE;
DS_MOTHER_RELIGION  EPC_PSM_DATA.DS_MOTHER_RELIGION%TYPE;
DT_MOTHER_DOB   EPC_PSM_DATA.DT_MOTHER_DOB%TYPE;
NM_MOTHER_POB    EPC_PSM_DATA.NM_MOTHER_POB%TYPE;
DS_MOTHER_NATIONALITY  EPC_PSM_DATA.DS_MOTHER_NATIONALITY%TYPE;
IE_MOTHER_MARITAL_STATUS  EPC_PSM_DATA.IE_MOTHER_MARITAL_STATUS%TYPE;
NM_LIVE_BIRTH EPC_PSM_DATA.NM_LIVE_BIRTH%TYPE;
NM_STILL_BIRTH EPC_PSM_DATA.NM_STILL_BIRTH%TYPE;
DT_WEEKS EPC_PSM_DATA.DT_WEEKS%TYPE;
DT_DAYS EPC_PSM_DATA.DT_DAYS%TYPE;
QT_GRAM EPC_PSM_DATA.QT_GRAM%TYPE;
QT_BODY_LENGTH EPC_PSM_DATA.QT_BODY_LENGTH%TYPE;
QT_APGAR_ONE_MIN EPC_PSM_DATA.QT_APGAR_ONE_MIN%TYPE;
QT_APGAR_FIVE_MIN EPC_PSM_DATA.QT_APGAR_FIVE_MIN%TYPE;
QT_APGAR_TEN_MIN EPC_PSM_DATA.QT_APGAR_TEN_MIN%TYPE;
IE_SMOKING_YES EPC_PSM_DATA.IE_SMOKING_YES%TYPE;
IE_SMOKING_NO EPC_PSM_DATA.IE_SMOKING_NO%TYPE;
IE_SMOKING varchar(2);
NM_BODY_HEIGHT_MOTHER EPC_PSM_DATA.NM_BODY_HEIGHT_MOTHER%TYPE;
NM_BODY_WEIGHT_MOTHER EPC_PSM_DATA.NM_BODY_WEIGHT_MOTHER%TYPE;
NM_BODY_WEIGHT_BEFORE_BIRTH EPC_PSM_DATA.NM_BODY_WEIGHT_BEFORE_BIRTH%TYPE;
DT_ULT_PARTO EPC_PSM_DATA.DT_ULT_PARTO%TYPE;
NR_SEQ_POS_BIRTH NASCIMENTO.NR_SEQ_POS_BIRTH%TYPE;
NR_SEQ_TYP_DEL NASCIMENTO.NR_SEQ_TYP_DEL%TYPE;
IE_SKULL_POSITION EPC_PSM_DATA.IE_SKULL_POSITION%TYPE;
IE_IRREGULAR_SKULL_POSITION EPC_PSM_DATA.IE_IRREGULAR_SKULL_POSITION%TYPE;
IE_BREECH_POSITION EPC_PSM_DATA.IE_BREECH_POSITION%TYPE;
IE_BANK_POSITION EPC_PSM_DATA.IE_BANK_POSITION%TYPE;
IE_UNKNOWN EPC_PSM_DATA.IE_UNKNOWN%TYPE;
IE_SPONTANEOUS_BIRTH EPC_PSM_DATA.IE_SPONTANEOUS_BIRTH%TYPE;
IE_CAESAREAN_PRIMARY EPC_PSM_DATA.IE_CAESAREAN_PRIMARY%TYPE;
IE_CAESAREAN_SECONDARAY EPC_PSM_DATA.IE_CAESAREAN_SECONDARAY%TYPE;
IE_SUCTION_CUP EPC_PSM_DATA.IE_SUCTION_CUP%TYPE;
IE_FORCEPS_DELIVARY EPC_PSM_DATA.IE_FORCEPS_DELIVARY%TYPE;
IE_MANUAL_HELP EPC_PSM_DATA.IE_MANUAL_HELP%TYPE;
COUNTER bigint;
COUNTER1 bigint;
COUNTER2 bigint;
COUNTER3 bigint;
IE_SEXO_MOTHER PESSOA_FISICA.IE_SEXO%TYPE;
NM_FATHER_DEGREE EPC_PSM_DATA.NM_FATHER_DEGREE%TYPE;
IE_FATHER_SEXO EPC_PSM_DATA.IE_FATHER_SEXO%TYPE;
DS_FATHER_RELIGION EPC_PSM_DATA.DS_FATHER_RELIGION%TYPE;
DT_FATHER_DOB EPC_PSM_DATA.DT_FATHER_DOB%TYPE;
DS_FATHER_NATIONALITY EPC_PSM_DATA.DS_FATHER_NATIONALITY%TYPE;
NM_FATHER_POB EPC_PSM_DATA.NM_FATHER_POB%TYPE;
NR_CUSTOMER_NUMBER MASTER_DATA_BIRTH.NR_CUSTOMER_NUMBER%TYPE;
CD_MOTHER_REF EPC_PSM_DATA.CD_MOTHER_REF%TYPE;
CD_FATHER_REF EPC_PSM_DATA.CD_FATHER_REF%TYPE;
QT_PH_LEVEL EPC_PSM_DATA.QT_PH_LEVEL%TYPE;
IE_MOTHER_MARRIED  EPC_PSM_DATA.IE_MOTHER_MARRIED%TYPE;
IE_MOTHER_WIDOWED	EPC_PSM_DATA.IE_MOTHER_WIDOWED%TYPE;
IE_MOTHER_SINGLE 	EPC_PSM_DATA.IE_MOTHER_SINGLE%TYPE;
IE_DIVORCED_MOTHER	EPC_PSM_DATA.IE_DIVORCED_MOTHER%TYPE;
IE_MARRIAGE_ANNULLED_MOTHER	EPC_PSM_DATA.IE_MARRIAGE_ANNULLED_MOTHER%TYPE;
IE_MARRIAGE_REPEALED_MOTHER	EPC_PSM_DATA.IE_MARRIAGE_REPEALED_MOTHER%TYPE;
IE_DISBANDED_MOTHER	EPC_PSM_DATA.IE_DISBANDED_MOTHER%TYPE;
IE_MARRIAGE_ANNULLED_MOTHER_EP	EPC_PSM_DATA.IE_MARRIAGE_ANNULLED_MOTHER_EP%TYPE;
IE_SURVIVING_PARTNER_MOTHER	EPC_PSM_DATA.IE_SURVIVING_PARTNER_MOTHER%TYPE;
IE_INVALID_EP_MOTHER	EPC_PSM_DATA.IE_INVALID_EP_MOTHER%TYPE;


BEGIN
SELECT COUNT(*) INTO STRICT COUNTER FROM EPC_PSM_DATA WHERE CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
IF (COUNTER =0) THEN
SELECT A.NM_PESSOA_FISICA,  A.NR_CEP_CIDADE_NASC, A.IE_SEXO,
D.NM_PESSOA_FISICA , D.IE_GRAU_INSTRUCAO ,D.IE_SEXO, D.CD_RELIGIAO , D.DT_NASCIMENTO ,D.NR_CEP_CIDADE_NASC , F.DS_NACIONALIDADE, D.IE_ESTADO_CIVIL,D.CD_PESSOA_FISICA 
INTO STRICT 
NM_CHILD_NAME,NM_CHILD_POB,IE_CHILD_SEXO,NM_MOTHER_NAME,NM_MOTHER_DEGREE,IE_SEXO_MOTHER,DS_MOTHER_RELIGION,DT_MOTHER_DOB,NM_MOTHER_POB,DS_MOTHER_NATIONALITY,IE_MOTHER_MARITAL_STATUS,CD_MOTHER_REF
FROM PESSOA_FISICA A 
FULL OUTER JOIN PESSOA_FISICA D ON ( A.CD_PESSOA_MAE=D.CD_PESSOA_FISICA )
FULL OUTER JOIN NACIONALIDADE F ON (D.CD_NACIONALIDADE=F.CD_NACIONALIDADE) WHERE  
A.CD_PESSOA_FISICA =CD_PESSOA_FISICA_P;


SELECT  D.NM_PESSOA_FISICA , D.IE_GRAU_INSTRUCAO , D.IE_SEXO, D.CD_RELIGIAO , D.DT_NASCIMENTO , F.DS_NACIONALIDADE, D.NR_CEP_CIDADE_NASC,D.CD_PESSOA_FISICA
INTO STRICT NM_FATHER_NAME , NM_FATHER_DEGREE, IE_FATHER_SEXO ,DS_FATHER_RELIGION, DT_FATHER_DOB, DS_FATHER_NATIONALITY, NM_FATHER_POB,CD_FATHER_REF
FROM PESSOA_FISICA D FULL OUTER JOIN NACIONALIDADE F ON (D.CD_NACIONALIDADE=F.CD_NACIONALIDADE) WHERE CD_PESSOA_FISICA IN (SELECT CD_PESSOA_FISICA_REF FROM COMPL_PESSOA_FISICA
WHERE CD_PESSOA_FISICA=CD_PESSOA_FISICA_P AND IE_TIPO_COMPLEMENTO=4);

SELECT COUNT(*) INTO STRICT COUNTER3 FROM MASTER_DATA_BIRTH WHERE CD_ESTABELECIMENTO=CD_ESTABELECIMENTO_P;
IF (COUNTER3!=0)THEN
SELECT NR_CUSTOMER_NUMBER INTO STRICT NR_CUSTOMER_NUMBER FROM MASTER_DATA_BIRTH WHERE CD_ESTABELECIMENTO=CD_ESTABELECIMENTO_P;
END IF;
SELECT P.QT_NASC_VIVOS AS LIVEBIRTH, P.QT_NASC_MORTOS AS STILLBIRTH,P.IE_TABAGISMO, N.QT_SEM_IG_TOTAL AS PREGNANCYWEEKS , N.QT_DIA_IG_TOTAL AS PREGNANCYDAYS, N.QT_PESO AS CHILDWEIGHT , N.QT_ALTURA AS CHILDLENGTH,
N.QT_APGAR_PRIM_MIN, N.QT_APGAR_QUINTO_MIN,N.QT_APGAR_DECIMO_MIN , P.DT_ULT_PARTO, N.NR_SEQ_POS_BIRTH AS POSITIONOFBIRTH, N.NR_SEQ_TYP_DEL AS TYPEOFDELIVERY, N.CD_ARTERIAL_PH,N.DT_NASCIMENTO
INTO STRICT NM_LIVE_BIRTH, NM_STILL_BIRTH,IE_SMOKING, DT_WEEKS, DT_DAYS, QT_GRAM, QT_BODY_LENGTH,QT_APGAR_ONE_MIN,QT_APGAR_FIVE_MIN,QT_APGAR_TEN_MIN,DT_ULT_PARTO,NR_SEQ_POS_BIRTH,NR_SEQ_TYP_DEL,QT_PH_LEVEL,DT_CHILD_DOB
FROM PARTO P 
FULL OUTER JOIN ATENDIMENTO_PACIENTE B ON ( P.NR_ATENDIMENTO = B.NR_ATENDIMENTO_MAE)
FULL OUTER JOIN NASCIMENTO N ON (N.NR_ATEND_RN = B.NR_ATENDIMENTO)
WHERE B.NR_ATENDIMENTO=NR_ATENDIMENTO_P;	

SELECT COUNT(*) INTO STRICT COUNTER1 FROM MED_PAC_PRE_NATAL M , ATENDIMENTO_PACIENTE B WHERE M.NR_ATENDIMENTO= B.NR_ATENDIMENTO_MAE AND B.NR_ATENDIMENTO=NR_ATENDIMENTO_P;
IF (COUNTER1 != 0)THEN
SELECT QT_ALTURA_CM AS MOTHERHEIGHT INTO STRICT NM_BODY_HEIGHT_MOTHER FROM MED_PAC_PRE_NATAL  WHERE NR_SEQUENCIA =(SELECT MAX(NR_SEQUENCIA) FROM MED_PAC_PRE_NATAL M, ATENDIMENTO_PACIENTE B WHERE M.NR_ATENDIMENTO= B.NR_ATENDIMENTO_MAE AND B.NR_ATENDIMENTO=NR_ATENDIMENTO_P );	
ELSE
NM_BODY_HEIGHT_MOTHER:=NULL;
END IF;
SELECT COUNT(*) INTO STRICT COUNTER2 FROM PRE_PARTO A , ATENDIMENTO_PACIENTE B WHERE A.NR_ATENDIMENTO= B.NR_ATENDIMENTO_MAE AND B.NR_ATENDIMENTO=NR_ATENDIMENTO_P;
IF (COUNTER2 != 0)THEN
SELECT QT_WT_BEG_PREG_MOT AS PREGESTATIONWEIGHT , QT_PESO_MAE AS WTBEFOREBIRTH INTO STRICT NM_BODY_WEIGHT_MOTHER,NM_BODY_WEIGHT_BEFORE_BIRTH FROM PRE_PARTO WHERE NR_SEQUENCIA = (SELECT MAX(NR_SEQUENCIA) FROM PRE_PARTO A ,
ATENDIMENTO_PACIENTE B WHERE A.NR_ATENDIMENTO= B.NR_ATENDIMENTO_MAE AND  B.NR_ATENDIMENTO=NR_ATENDIMENTO_P);
ELSE
NM_BODY_WEIGHT_MOTHER := NULL;
NM_BODY_WEIGHT_BEFORE_BIRTH:=NULL;
END IF;

IF (IE_SMOKING = 'N')THEN
IE_SMOKING_NO := 'Y';
IE_SMOKING_YES := 'N';
ELSE
IE_SMOKING_NO := 'N';
IE_SMOKING_YES := 'Y';
END IF;
IF (NR_SEQ_POS_BIRTH IS NOT NULL AND NR_SEQ_POS_BIRTH::text <> '')THEN
CASE NR_SEQ_POS_BIRTH
	WHEN 1 THEN IE_SKULL_POSITION :='Y';
	WHEN 2 THEN IE_IRREGULAR_SKULL_POSITION :='Y';
	WHEN 3 THEN IE_BREECH_POSITION :='Y';
	WHEN 4 THEN IE_BANK_POSITION :='Y';
	WHEN 5 THEN IE_UNKNOWN :='Y';
END CASE;
END IF;
IF (NR_SEQ_TYP_DEL IS NOT NULL AND NR_SEQ_TYP_DEL::text <> '') THEN
CASE NR_SEQ_TYP_DEL
	WHEN 1 THEN IE_SPONTANEOUS_BIRTH :='Y';
	WHEN 2 THEN IE_SUCTION_CUP :='Y';
	WHEN 3 THEN IE_FORCEPS_DELIVARY :='Y';
	WHEN 5 THEN IE_MANUAL_HELP :='Y';
	WHEN 6 THEN IE_CAESAREAN_PRIMARY :='Y';
	WHEN 7 THEN IE_CAESAREAN_PRIMARY :='Y';
	WHEN 8 THEN IE_CAESAREAN_SECONDARAY :='Y';
	WHEN 9 THEN IE_CAESAREAN_SECONDARAY :='Y';
	WHEN 10 THEN IE_CAESAREAN_PRIMARY :='Y';
	WHEN 11 THEN IE_CAESAREAN_SECONDARAY :='Y';
END CASE;
END IF;
INSERT INTO EPC_PSM_DATA( NR_SEQUENCIA,
	DT_ATUALIZACAO ,
	NM_USUARIO,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC,
	CD_PESSOA_FISICA,
	IE_SEXO,NM_CHILD_NAME,DT_CHILD_DOB,NM_CHILD_POB,NM_FATHER_NAME,
	NM_MOTHER_NAME,NM_MOTHER_DEGREE,DS_MOTHER_RELIGION,DT_MOTHER_DOB,NM_MOTHER_POB,DS_MOTHER_NATIONALITY,IE_MOTHER_MARITAL_STATUS,NM_LIVE_BIRTH,NM_STILL_BIRTH,IE_FATHER_SEXO,IE_SEXO_MOTHER,DT_WEEKS,DT_DAYS,QT_GRAM,QT_BODY_LENGTH,QT_APGAR_ONE_MIN,QT_APGAR_FIVE_MIN,QT_APGAR_TEN_MIN,IE_SMOKING_YES,IE_SMOKING_NO,NM_BODY_HEIGHT_MOTHER,NM_BODY_WEIGHT_MOTHER,NM_BODY_WEIGHT_BEFORE_BIRTH,DT_ULT_PARTO,IE_SKULL_POSITION,IE_IRREGULAR_SKULL_POSITION,IE_BREECH_POSITION,IE_BANK_POSITION,IE_UNKNOWN,IE_SPONTANEOUS_BIRTH,IE_CAESAREAN_PRIMARY,IE_CAESAREAN_SECONDARAY,IE_SUCTION_CUP,IE_FORCEPS_DELIVARY,IE_MANUAL_HELP,NM_FATHER_DEGREE,DS_FATHER_RELIGION,DT_FATHER_DOB,DS_FATHER_NATIONALITY,NM_FATHER_POB,DS_AUTHORITY,CD_MOTHER_REF,CD_FATHER_REF,QT_PH_LEVEL,NR_ATENDIMENTO,IE_MOTHER_SINGLE,IE_MOTHER_MARRIED,IE_MOTHER_WIDOWED,IE_DIVORCED_MOTHER,IE_MARRIAGE_ANNULLED_MOTHER,IE_MARRIAGE_REPEALED_MOTHER,IE_DISBANDED_MOTHER,IE_MARRIAGE_ANNULLED_MOTHER_EP,IE_SURVIVING_PARTNER_MOTHER,IE_INVALID_EP_MOTHER,NR_SEQ_POS_BIRTH,NR_SEQ_TYP_DEL)
	VALUES (nextval('epc_psm_data_seq'),clock_timestamp(),NM_USUARIO_P,clock_timestamp(),NM_USUARIO_NREC_P,CD_PESSOA_FISICA_P,IE_CHILD_SEXO,
	NM_CHILD_NAME,DT_CHILD_DOB,NM_CHILD_POB,NM_FATHER_NAME,NM_MOTHER_NAME,NM_MOTHER_DEGREE,DS_MOTHER_RELIGION,DT_MOTHER_DOB,NM_MOTHER_POB,DS_MOTHER_NATIONALITY,IE_MOTHER_MARITAL_STATUS,NM_LIVE_BIRTH,NM_STILL_BIRTH,IE_FATHER_SEXO,IE_SEXO_MOTHER,DT_WEEKS,DT_DAYS,QT_GRAM,QT_BODY_LENGTH,QT_APGAR_ONE_MIN,QT_APGAR_FIVE_MIN,QT_APGAR_TEN_MIN,IE_SMOKING_YES,IE_SMOKING_NO,NM_BODY_HEIGHT_MOTHER,NM_BODY_WEIGHT_MOTHER,NM_BODY_WEIGHT_BEFORE_BIRTH,DT_ULT_PARTO,IE_SKULL_POSITION,IE_IRREGULAR_SKULL_POSITION,IE_BREECH_POSITION,IE_BANK_POSITION,IE_UNKNOWN,IE_SPONTANEOUS_BIRTH,IE_CAESAREAN_PRIMARY,IE_CAESAREAN_SECONDARAY,IE_SUCTION_CUP,IE_FORCEPS_DELIVARY,IE_MANUAL_HELP,NM_FATHER_DEGREE,DS_FATHER_RELIGION,DT_FATHER_DOB,DS_FATHER_NATIONALITY,NM_FATHER_POB,NR_CUSTOMER_NUMBER,CD_MOTHER_REF,CD_FATHER_REF,QT_PH_LEVEL,NR_ATENDIMENTO_P,IE_MOTHER_SINGLE,IE_MOTHER_MARRIED,IE_MOTHER_WIDOWED,IE_DIVORCED_MOTHER,IE_MARRIAGE_ANNULLED_MOTHER,IE_MARRIAGE_REPEALED_MOTHER,IE_DISBANDED_MOTHER,IE_MARRIAGE_ANNULLED_MOTHER_EP,IE_SURVIVING_PARTNER_MOTHER,IE_INVALID_EP_MOTHER,NR_SEQ_POS_BIRTH,NR_SEQ_TYP_DEL);
END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inst_epc_psm_data ( CD_PESSOA_FISICA_P EPC_PSM_DATA.CD_PESSOA_FISICA%TYPE, NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, NM_USUARIO_P EPC_PSM_DATA.NM_USUARIO%TYPE, NM_USUARIO_NREC_P EPC_PSM_DATA.NM_USUARIO_NREC%TYPE, CD_ESTABELECIMENTO_P ESTABELECIMENTO.CD_ESTABELECIMENTO%TYPE ) FROM PUBLIC;

