-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_stat_analise_pos (nr_seq_analise_pos_p bigint, cd_estabelecimento bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_partic_proc_w	bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
vl_liberado_w			double precision := 0;
vl_calculado_w			double precision := 0;
vl_total_liberado_w		double precision := 0;
vl_total_calculado_w	double precision := 0;
nr_seq_item_ref_w		bigint;
qt_registro_w			bigint := 0;


BEGIN
/* Quando alterado PARTICIPANTE */

select	max(nr_seq_partic_proc)
into STRICT	nr_seq_partic_proc_w
from	w_pls_resumo_conta
where	nr_sequencia = nr_seq_analise_pos_p;

if (nr_seq_partic_proc_w IS NOT NULL AND nr_seq_partic_proc_w::text <> '') then
	select	coalesce(max(vl_total),0),
			coalesce(max(vl_calculado),0)
	into STRICT	vl_liberado_w,
			vl_calculado_w
	from	w_pls_resumo_conta
	where	nr_sequencia = nr_seq_analise_pos_p;

	if (vl_liberado_w = vl_calculado_w) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'L',
			ie_status = 'L',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_calculado_w > vl_liberado_w) and (vl_liberado_w > 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'P',
			ie_status = 'P',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_liberado_w = 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'G',
			ie_status = 'D',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;
	end if;

	/* Atualizar o procedimento */

	select	max(nr_seq_item_ref)
	into STRICT	nr_seq_item_ref_w
	from	w_pls_resumo_conta
	where	nr_seq_partic_proc = nr_seq_partic_proc_w
	and	nr_sequencia = nr_seq_analise_pos_p;

	select	max(nr_seq_conta_proc)
	into STRICT	nr_seq_conta_proc_w
	from	w_pls_resumo_conta
	where	nr_seq_item_ref = nr_seq_item_ref_w;

	if (nr_seq_item_ref_w IS NOT NULL AND nr_seq_item_ref_w::text <> '') then
		select	coalesce(sum(vl_total),0)
		into STRICT	vl_total_liberado_w
		from	w_pls_resumo_conta
		where	nr_seq_item_ref = nr_seq_item_ref_w
		and	coalesce(nr_seq_conta_proc::text, '') = '';

		select	coalesce(max(vl_calculado),0)
		into STRICT	vl_total_calculado_w
		from	w_pls_resumo_conta
		where	nr_seq_conta_proc = nr_seq_conta_proc_w;

		update	w_pls_resumo_conta
		set	vl_total = vl_total_liberado_w
		where	nr_seq_conta_proc = nr_seq_conta_proc_w;

		if (vl_total_liberado_w = vl_total_calculado_w) then
			update	w_pls_resumo_conta
			set	ie_pagamento = 'L',
				ie_status = 'L',
				nm_usuario_liberacao 	= nm_usuario_p
			where	nr_seq_conta_proc = nr_seq_conta_proc_w;

		elsif (vl_total_calculado_w > vl_total_liberado_w) and (vl_total_liberado_w > 0) then
			update	w_pls_resumo_conta
			set	ie_pagamento = 'P',
				ie_status = 'D',
				nm_usuario_liberacao 	= nm_usuario_p
			where	nr_seq_conta_proc = nr_seq_conta_proc_w;

		elsif (vl_total_liberado_w = 0) then
			update	w_pls_resumo_conta
			set	ie_pagamento = 'G',
				ie_status = 'D',
				nm_usuario_liberacao 	= nm_usuario_p
			where	nr_seq_conta_proc = nr_seq_conta_proc_w;
		end if;
	end if;
end if;

/* Quando alterado PROCEDIMENTO */

select	max(nr_seq_conta_proc)
into STRICT	nr_seq_conta_proc_w
from	w_pls_resumo_conta
where	nr_sequencia = nr_seq_analise_pos_p;

if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
	select	coalesce(max(vl_total),0),
			coalesce(max(vl_calculado),0)
	into STRICT	vl_liberado_w,
			vl_calculado_w
	from	w_pls_resumo_conta
	where	nr_sequencia = nr_seq_analise_pos_p;

	select	count(1)
	into STRICT	qt_registro_w
	from	w_pls_resumo_conta
	where	nr_seq_item_ref = nr_seq_conta_proc_w
	and	coalesce(nr_seq_conta_proc::text, '') = '';

	if (vl_liberado_w = vl_calculado_w) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'L',
			ie_status = 'L',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_calculado_w > vl_liberado_w) and (vl_liberado_w > 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'P',
			ie_status = 'D',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_liberado_w = 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'G',
			ie_status = 'D',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;
	end if;
end if;

/* Quando alterado MATERIAL */

select	max(nr_seq_conta_mat)
into STRICT	nr_seq_conta_mat_w
from	w_pls_resumo_conta
where	nr_sequencia = nr_seq_analise_pos_p;

if (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
	select	coalesce(max(vl_total),0),
			coalesce(max(vl_calculado),0)
	into STRICT	vl_liberado_w,
			vl_calculado_w
	from	w_pls_resumo_conta
	where	nr_sequencia = nr_seq_analise_pos_p;

	if (vl_liberado_w = vl_calculado_w) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'L',
			ie_status = 'L',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_calculado_w > vl_liberado_w) and (vl_liberado_w > 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'P',
			ie_status = 'D',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;

	elsif (vl_liberado_w = 0) then
		update	w_pls_resumo_conta
		set	ie_pagamento = 'G',
			ie_status = 'D',
			nm_usuario_liberacao 	= nm_usuario_p
		where	nr_sequencia = nr_seq_analise_pos_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_stat_analise_pos (nr_seq_analise_pos_p bigint, cd_estabelecimento bigint, nm_usuario_p text ) FROM PUBLIC;

