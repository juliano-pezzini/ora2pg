-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE additional_proc_process ( nr_seq_agenda_p bigint, cd_procedimento_old_p bigint, ds_historico_p text, cd_motivo_alteracao_p bigint, ds_observacao_alteracao_p text, ie_cancelar_proc_autor_p text, ie_gerar_historico_p text) AS $body$
DECLARE


cd_agenda_w				agenda.cd_agenda%type;
ie_cancelar_proc_w	varchar(15);
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nm_paciente_w			agenda_paciente.nm_paciente%type;
cd_perfil_w				perfil.cd_perfil%type 	:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w			usuario.nm_usuario%type	:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;



BEGIN

if (ie_cancelar_proc_autor_p = 'S') then
	ie_cancelar_proc_w := Obter_Param_Usuario(871, 505, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_cancelar_proc_w);
	if (ie_cancelar_proc_w = 'S') then
		CALL cancelar_proc_autor_agenda(cd_estabelecimento_w,nm_usuario_w,nr_seq_agenda_p,cd_procedimento_old_p,'S');
	end if;
end if;

select	max(cd_agenda)
into STRICT		cd_agenda_w
from		agenda_paciente
where		nr_sequencia = nr_seq_agenda_p;

if (ie_gerar_historico_p = 'S') then
	CALL gerar_agenda_paciente_hist(cd_agenda_w,
										nr_seq_agenda_p,
										'E',
										nm_usuario_w,
										ds_historico_p,
										cd_pessoa_fisica_w,
										nm_paciente_w,
										clock_timestamp(),
										cd_perfil_w,
										cd_motivo_alteracao_p,
										ds_observacao_alteracao_p,
										null);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE additional_proc_process ( nr_seq_agenda_p bigint, cd_procedimento_old_p bigint, ds_historico_p text, cd_motivo_alteracao_p bigint, ds_observacao_alteracao_p text, ie_cancelar_proc_autor_p text, ie_gerar_historico_p text) FROM PUBLIC;

