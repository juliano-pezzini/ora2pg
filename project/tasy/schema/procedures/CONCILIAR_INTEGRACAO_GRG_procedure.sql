-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE conciliar_integracao_grg (nr_seq_item_p bigint, ie_opcao_p text) AS $body$
DECLARE


nr_seq_lote_w		imp_resp_recurso.nr_sequencia%type;
ie_status_w varchar(2) := 'P';


BEGIN

    if (ie_opcao_p = 'V') then  --Se clicado na opcao "Validar", ira buscar o item caso ele esteja com o status Pendente.
        ie_status_w := 'P';
    else if (ie_opcao_p = 'C') then --Se clicado na opcao "Conciliar", ira buscar o item caso ele esteja com o status Validado.
        ie_status_w := 'V';
        end if;
    end if;

	if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and (nr_seq_item_p > 0) then

		select	max(d.nr_sequencia)
		into STRICT	nr_seq_lote_w
		from	imp_resp_recurso_prot a,
			imp_resp_recurso_guia b,
			imp_resp_recurso_item c,
			imp_resp_recurso d
		where 	c.nr_sequencia 		= nr_seq_item_p
		and	b.nr_sequencia 		= c.nr_seq_res_rec_guia
		and	a.nr_sequencia 		= b.nr_seq_res_rec_prot
		and	a.nr_seq_resp_recurso	= d.nr_sequencia
		and	coalesce(a.ie_status, 'P')	= ie_status_w;

		if (coalesce(nr_seq_lote_w,0) > 0) then
			CALL conciliar_integr_resp_rec_pck.executar(nr_seq_lote_w, ie_opcao_p);
		end if;

	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_grg (nr_seq_item_p bigint, ie_opcao_p text) FROM PUBLIC;

