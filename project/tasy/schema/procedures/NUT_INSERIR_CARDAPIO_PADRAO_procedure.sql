-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_inserir_cardapio_padrao ( nr_seq_servico_p bigint, dt_referencia_p timestamp, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			

nr_seq_opcao_rec_w		bigint;	
cd_dieta_w			bigint;		
nr_seq_opcao_w			bigint;
nr_seq_comp_w			bigint;
nr_seq_receita_w			bigint;
nr_seq_servico_dia_w		bigint;
nr_seq_cardapio_w			bigint;	
nr_prescr_oral_w			bigint;
cd_dieta_paciente_w		bigint;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_receita_subst_w		nut_receita.nr_sequencia%type;
ir_receita_especial_w		varchar(1);
ds_parametro_120_w  		varchar(1);

C01 CURSOR FOR
	SELECT	a.cd_dieta,
		coalesce(a.nr_seq_opcao,b.nr_seq_opcao) nr_seq_opcao,
		b.nr_seq_comp,
		b.nr_seq_receita,
		b.nr_sequencia
	from	nut_cardapio_dia a,
		nut_cardapio b,
		nut_local_refeicao c
	where	a.nr_seq_local = c.nr_sequencia
	and	c.ie_local_paciente = 'S'
	and (c.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento or coalesce(c.cd_estabelecimento::text, '') = '')
	and	a.nr_sequencia 		= b.nr_seq_card_dia
	and	((a.cd_dieta 		= cd_dieta_paciente_w) or exists (SELECT	1
								from	nut_grupo_producao x,
									nut_grupo_producao_dieta k
								where	k.nr_seq_grupo_producao	= x.nr_sequencia
								and	x.nr_sequencia 		= a.nr_seq_grupo_producao
								and	k.cd_dieta = cd_dieta_paciente_w))
	and	a.nr_seq_servico 	= nr_seq_servico_p
	and	coalesce(a.ie_cardapio_padrao,'N') = 'S'
	and     ((ds_parametro_120_w = 'N' and  dt_referencia_p between a.dt_vigencia_inicial and a.dt_vigencia_final and  obter_se_cardapio_dia(dt_referencia_p, a.ie_semana, a.ie_dia_semana) = 'S')
	or (ds_parametro_120_w = 'S' and coalesce(a.nr_seq_cycle,0) > 0 and get_cycle_day(dt_referencia_p, a.nr_seq_cycle) = a.nr_seq_cycle_day));


BEGIN

nr_seq_servico_dia_w := obter_nut_atend_serv_dia(nr_atendimento_p,cd_setor_atendimento_p,dt_referencia_p,0,nr_seq_servico_p,0,null,null,0);
ds_parametro_120_w := obter_valor_param_usuario(1003,120,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
select	max(nr_prescr_oral)
into STRICT	nr_prescr_oral_w
from	nut_atend_serv_dia_rep b,
	nut_atend_serv_dia c
where	b.nr_seq_serv_dia   	= c.nr_sequencia	
and	c.nr_atendimento 	= nr_atendimento_p
and	c.nr_seq_servico 	= nr_seq_servico_p
and	c.cd_setor_atendimento 	= cd_setor_atendimento_p
and	c.dt_servico between inicio_dia(dt_referencia_p) and fim_dia(dt_referencia_p);

select	max(cd_dieta)
into STRICT	cd_dieta_paciente_w
from	prescr_dieta
where	nr_prescricao = nr_prescr_oral_w
and	(cd_dieta IS NOT NULL AND cd_dieta::text <> '');


if (nr_seq_servico_dia_w IS NOT NULL AND nr_seq_servico_dia_w::text <> '') and (nr_seq_servico_p IS NOT NULL AND nr_seq_servico_p::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	
	open C01;
	loop
	fetch C01 into			
		cd_dieta_w,	
		nr_seq_opcao_w,
		nr_seq_comp_w,
		nr_seq_receita_w,
		nr_seq_cardapio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		ir_receita_especial_w := 'N';
		
		select	max(a.cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	atendimento_paciente a,
			nut_atend_serv_dia b
		where	a.nr_atendimento = b.nr_atendimento
		and	b.nr_sequencia = nr_seq_servico_dia_w;
		
		nr_seq_receita_subst_w := nut_obter_receita_subst(cd_pessoa_fisica_w, nr_seq_servico_p, nr_seq_receita_w);
		
		if (nr_seq_receita_subst_w IS NOT NULL AND nr_seq_receita_subst_w::text <> '') then
		
			select	max(nr_seq_composicao)
			into STRICT	nr_seq_comp_w
			from	nut_receita a
			where	a.nr_sequencia = nr_seq_receita_subst_w;
			
			CALL gravar_log_tasy(1194,
					obter_texto_dic_objeto(732151, philips_param_pck.get_nr_seq_idioma, 'NR_ATENDIMENTO='||nr_atendimento_p||
					';NM_PESSOA_FISICA='||obter_nome_pf(cd_pessoa_fisica_w)||';NR_SEQ_RECEITA_OLD='||nr_seq_receita_w||
					';NR_SEQ_RECEITA_NEW='||nr_seq_receita_subst_w),
					nm_usuario_p);
			
			nr_seq_opcao_w := null;
			ir_receita_especial_w := 'S';
			nr_seq_receita_w := nr_seq_receita_subst_w;
			nr_seq_cardapio_w := null;
		
		end if;
		
		select	nextval('nut_pac_opcao_rec_seq')
		into STRICT	nr_seq_opcao_rec_w
		;
		
		insert	into nut_pac_opcao_rec(nr_sequencia,
			nr_seq_composicao,      
			nr_seq_receita, 
			nr_seq_opcao_sel,
			nr_seq_servico_dia,
			ie_receita_especial,
			nr_seq_acompanhante,
			cd_acompanhante,
			nr_seq_cardapio_dia,
			ie_tipo_cardapio,
			dt_atualizacao,         
			nm_usuario,             
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_cardapio,
			qt_refeicao)
		values (nr_seq_opcao_rec_w,
			nr_seq_comp_w,
			nr_seq_receita_w,
			nr_seq_opcao_w,
			nr_seq_servico_dia_w,
			ir_receita_especial_w,
			null,
			null,
			null,
			null,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_cardapio_w,
			null);
		end;
	end loop;
	close C01;	
end if;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_inserir_cardapio_padrao ( nr_seq_servico_p bigint, dt_referencia_p timestamp, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

