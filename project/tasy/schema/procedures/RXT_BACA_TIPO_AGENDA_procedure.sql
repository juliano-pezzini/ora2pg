-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_baca_tipo_agenda () AS $body$
DECLARE


nr_seq_equipamento_w	bigint;
hr_inicial_w		timestamp;
hr_final_w		timestamp;
dt_inicio_vigencia_w	timestamp;
dt_final_vigencia_w	timestamp;
ie_tipo_agenda_w	varchar(1);
nr_sequencia_w		bigint;


/*Obter todos os hor√°rios dos equipamentos*/

c01 CURSOR FOR
	SELECT		nr_seq_equipamento,
			hr_inicial,
			hr_final,
			dt_inicio_vigencia,
			dt_final_vigencia,
			ie_tipo_agenda
	from		rxt_equip_regra_agenda
	order by	nr_seq_equipamento;

c02 CURSOR FOR
	SELECT		nr_sequencia
	from		rxt_agenda
	where		nr_seq_equipamento = nr_seq_equipamento_w
	and		coalesce(ie_tipo_agenda::text, '') = ''
	and		((coalesce(dt_inicio_vigencia_w::text, '') = '') or (dt_inicio_vigencia_w <= dt_agenda))
	and		((coalesce(dt_final_vigencia_w::text, '') = '') or (dt_final_vigencia_w >= dt_agenda))
	and		to_date('30/12/1899 ' || to_char(dt_agenda,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') between hr_inicial_w and hr_final_w;



BEGIN

open c01;
loop
fetch c01 into	nr_seq_equipamento_w,
		hr_inicial_w,
		hr_final_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		ie_tipo_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	open c02;
	loop
	fetch c02 into	nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		/* Ajustar o tipo do agendamento */

		update	rxt_agenda
		set	ie_tipo_agenda	= ie_tipo_agenda_w,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= 'BacaTasy'
		where	nr_sequencia	= nr_sequencia_w;
		end;
	end loop;
	close c02;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_baca_tipo_agenda () FROM PUBLIC;

