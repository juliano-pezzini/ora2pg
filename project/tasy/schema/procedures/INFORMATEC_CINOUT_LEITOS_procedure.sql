-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE informatec_cinout_leitos ( ie_tipo_comando_p text, nr_atendimento_p bigint) AS $body$
DECLARE


arq_texto_w		utl_file.file_type;
nm_local_grav_w		varchar(60);		  --Caminho onde será salvo o arquivo   **** CAMINHO VÁLIDO, HABILITADO NO ORACLE ****
ds_espacamento_w	varchar(1) := ' ';
nm_arquivo_w		varchar(20);
cd_estabelecimento_w	integer;
ie_aberto_w		varchar(1);
ie_tipo_um_w		varchar(5);
ie_tipo_dois_w		varchar(5);
cd_setor_atendimento_w	bigint;
cd_unidade_basica_w	varchar(20);
cd_unidade_compl_w	varchar(20);
nr_ramal_w		numeric(20);

qt_tentativas_w		integer := 0;
nr_seq_interno_w		bigint;
/*
ie_tipo_comando_p =       CIN   ou   COUT
*/
BEGIN

if (nr_atendimento_p > 0) then

	nr_seq_interno_w	:=	obter_atepacu_paciente(nr_atendimento_p, 'A');

	if (nr_seq_interno_w > 0) then
		begin
		select 	max(a.cd_setor_atendimento),
			max(a.cd_unidade_basica),
			max(a.cd_unidade_compl)
		into STRICT	cd_setor_atendimento_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w
		from	atend_paciente_unidade a
		where	a.nr_seq_interno = nr_seq_interno_w;

		select 	max(nr_ramal)
		into STRICT	nr_ramal_w
		from	unidade_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w
		and	cd_unidade_basica = cd_unidade_basica_w
		and	cd_unidade_compl = cd_unidade_compl_w;

		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w;


		select	Obter_Valor_Param_Usuario(3111, 74, 0, 'TASY', cd_estabelecimento_w)
		into STRICT	nm_local_grav_w
		;


		if (ie_tipo_comando_p = 'CIN') then
			ds_espacamento_w	:= '0';
			nm_arquivo_w		:= 'CInCOut.txt';
			ie_tipo_um_w		:= '2';
			ie_tipo_dois_w		:= '4';
		elsif (ie_tipo_comando_p = 'COUT') then
			ds_espacamento_w	:= ' ';
			nm_arquivo_w		:= 'CInCOut.txt';
			ie_tipo_um_w		:= '4';
			ie_tipo_dois_w		:= '2';
		end if;

		ie_aberto_w := 'N';

		while(ie_aberto_w = 'N') and (qt_tentativas_w < 500) loop
			begin
			qt_tentativas_w := qt_tentativas_w + 1;

			--abre o arquivo
			arq_texto_w := utl_file.fopen(nm_local_grav_w,nm_arquivo_w , 'A');

			ie_aberto_w := 'S';
			exception
			when others then

			ie_aberto_w := 'N';
			end;

		end loop;


		if (qt_tentativas_w < 500) then

			--gera uma nova linha no arquivo
			utl_file.put_line(arq_texto_w, 	Completa_tam_campo(ie_tipo_comando_p,' ',4)||' '||		--Comando
							Completa_tam_campo_ant(to_char(coalesce(nr_ramal_w,0)),'0',5)||' '||	--Ramal do hóspede
							'0'||
							Completa_tam_campo_ant(' ',' ',108)||
							ie_tipo_um_w||'   '||
							ie_tipo_dois_w||
							chr(13));

			--fecha e libera o arquivo
			utl_file.fclose(arq_texto_w);

		end if;
		end;
	end if;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE informatec_cinout_leitos ( ie_tipo_comando_p text, nr_atendimento_p bigint) FROM PUBLIC;

