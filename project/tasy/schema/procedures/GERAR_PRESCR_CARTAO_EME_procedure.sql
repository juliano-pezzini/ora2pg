-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_cartao_eme (cd_medico_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_prescricao_p INOUT bigint, dt_inicio_prescricao_p timestamp default null) AS $body$
DECLARE


nr_prescricao_w		bigint;
cd_pessoa_fisica_w	varchar(10);
ie_tipo_pessoa_w	smallint;
cd_setor_atendimento_w	bigint;
ie_adep_w		varchar(10);
ie_forma_adep_w		varchar(10);
ie_motivo_prescricao_w	prescr_medica.ie_motivo_prescricao%type;
dt_inicio_prescricao_w	prescr_medica.dt_prescricao%type	:= clock_timestamp();


BEGIN

select	coalesce(max(b.ie_tipo_pessoa),'1')
into STRICT	ie_tipo_pessoa_w
from	pessoa_fisica b,
	usuario a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	a.nm_usuario		= nm_usuario_p;

select	max(cd_pessoa_fisica),
	max(Obter_Setor_Atendimento(nr_atendimento))
into STRICT	cd_pessoa_fisica_w,
	cd_setor_atendimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	nextval('prescr_medica_seq')
into STRICT	nr_prescricao_w
;


dt_inicio_prescricao_w	:= coalesce(dt_inicio_prescricao_p,clock_timestamp());


ie_forma_adep_w := Obter_Param_Usuario(924, 246, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_forma_adep_w);
ie_motivo_prescricao_w := Obter_Param_Usuario(440, 7, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_motivo_prescricao_w);
	
if (ie_forma_adep_w = 'DS') then
	select	coalesce(max(ie_adep),'N')
	into STRICT	ie_adep_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_w;
elsif (ie_forma_adep_w = 'NV') then
	ie_adep_w   := 'N';
elsif (ie_forma_adep_w = 'PV') then
	ie_adep_w := 'S';
elsif (ie_forma_adep_w = 'PNV') then
	ie_adep_w := 'N';
else	
	ie_adep_w := 'S';
end if;

insert	into prescr_medica(
	dt_prescricao,
	cd_medico,
	cd_pessoa_fisica,
	cd_estabelecimento,
	nm_usuario_original,
	nr_horas_validade,
	nr_prescricao,
	ie_recem_nato,
	ie_origem_inf,
	dt_primeiro_horario,
	nm_usuario,
	dt_atualizacao,
	cd_prescritor,
	ie_adep,
	ie_prescr_emergencia,
	nr_atendimento,
	ie_cartao_emergencia,
	ie_motivo_prescricao)
values (	dt_inicio_prescricao_w,
	cd_medico_p,
	cd_pessoa_fisica_w,
	cd_estabelecimento_p,
	nm_usuario_p,
	24,
	nr_prescricao_w,
	'N',
	ie_tipo_pessoa_w,
	dt_inicio_prescricao_w,
	nm_usuario_p,
	clock_timestamp(),
	obter_dados_usuario_opcao(nm_usuario_p, 'C'),
	ie_adep_w,
	'N',
	nr_atendimento_p,
	'S',
	ie_motivo_prescricao_w);

commit;

nr_prescricao_p	:= nr_prescricao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_cartao_eme (cd_medico_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_prescricao_p INOUT bigint, dt_inicio_prescricao_p timestamp default null) FROM PUBLIC;

