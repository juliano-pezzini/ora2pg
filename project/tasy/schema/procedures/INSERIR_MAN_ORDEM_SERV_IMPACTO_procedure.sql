-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_man_ordem_serv_impacto ( nr_seq_ordem_serv_p bigint, ds_titulo_p text, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_idioma_padrao_w 	CONSTANT idioma.nr_sequencia%type := 5; -- English
qt_reg_w				bigint;
nr_seq_impacto_w 		man_ordem_serv_impacto.nr_sequencia%type;
nr_seq_imp_pr_w 		man_ordem_serv_imp_pr.nr_sequencia%type;
ie_impacto_requisito_w 	man_ordem_serv_imp_pr.ie_impacto_requisito%type;
ds_new_title_w 			man_ordem_serv_imp_pr.ds_new_title%type;
is_add_answer_w			varchar(1);
	
c02 CURSOR FOR
	SELECT 	distinct nr_product_requirement
	from 	w_man_ordem_serv_imp_pr
	where 	nr_seq_ordem_serv = nr_seq_ordem_serv_p;
	
c03 CURSOR(nr_product_requirement_w bigint) FOR
	SELECT 	distinct cd_funcao
	from 	w_man_ordem_serv_imp_pr
	where 	nr_seq_ordem_serv = nr_seq_ordem_serv_p
	and 	nr_product_requirement = nr_product_requirement_w;


BEGIN

	if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then
	
		select 	nextval('man_ordem_serv_impacto_seq')
		into STRICT 	nr_seq_impacto_w
		;
		
		insert into man_ordem_serv_impacto(
			nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_liberacao,
			ds_titulo
		) values (
			nr_seq_impacto_w,
			nr_seq_ordem_serv_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			ds_titulo_p
		);
		
		for r_c02 in c02 loop begin
		
			select 	max(coalesce(
				(	select 	max(b.ie_impacto_requisito)
					from 	w_man_ordem_serv_imp_pr b
					where 	b.nr_seq_ordem_serv = a.nr_seq_ordem_serv
					and 	b.nr_product_requirement = a.nr_product_requirement
					and 	b.ie_impacto_requisito in ('A', 'I', 'E')
				),
				a.ie_impacto_requisito)),
				max(a.ds_new_title) ds_new_title
			into STRICT 	ie_impacto_requisito_w,
				ds_new_title_w
			from 	w_man_ordem_serv_imp_pr a
			where 	a.nr_seq_ordem_serv = nr_seq_ordem_serv_p
			and 	a.nr_product_requirement = r_c02.nr_product_requirement;
		
			select 	nextval('man_ordem_serv_imp_pr_seq')
			into STRICT 	nr_seq_imp_pr_w
			;
			
			insert into man_ordem_serv_imp_pr(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_impacto,
				nr_product_requirement,
				ie_impacto_requisito,
				ds_new_title
			) values (
				nr_seq_imp_pr_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_impacto_w,
				r_c02.nr_product_requirement,
				ie_impacto_requisito_w,
				ds_new_title_w
			);
			
			for r_c03 in c03(r_c02.nr_product_requirement) loop begin
				insert into man_ordem_serv_imp_pr_func(
					nr_sequencia,
					nr_seq_imp_pr,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					cd_funcao
				) values (
					nextval('man_ordem_serv_imp_pr_func_seq'),
					nr_seq_imp_pr_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					r_c03.cd_funcao
				);
			end; end loop;
			
		end; end loop;
		
		
		select 	coalesce(max('S'), 'N')
		into STRICT	is_add_answer_w
		from 	w_man_ordem_serv_imp_pr a
		where	a.nr_seq_ordem_serv	= nr_seq_ordem_serv_p
		and 	a.ie_impacto_requisito in ('A', 'I', 'E');
		
		if (is_add_answer_w = 'S') then
			CALL insert_man_ordem_serv_imp_resp(nr_seq_ordem_serv_p, nr_seq_impacto_w, nm_usuario_p);
		end if;
		
		delete from w_ordem_serv_imp_quest_res 	where nr_seq_ordem_serv = nr_seq_ordem_serv_p;
		delete from w_man_ordem_serv_imp_pr 		where nr_seq_ordem_serv = nr_seq_ordem_serv_p;
		
		commit;

		
		select	count(1)
		into STRICT	qt_reg_w
		from	man_ordem_serv_imp_resp
		where	nr_seq_impacto	= nr_seq_impacto_w
		and		coalesce(ie_resposta, 'N') = 'S'
		and		coalesce(dt_aprovacao::text, '') = '';
		
		if (qt_reg_w = 0) then
			CALL man_liberar_analise_impacto(nr_seq_ordem_serv_p, nr_seq_impacto_w, nm_usuario_p);
		else
			CALL avisar_aprovacao_pendente_sme(nr_seq_ordem_serv_p, nr_seq_impacto_w);
		end if;
		
	end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_man_ordem_serv_impacto ( nr_seq_ordem_serv_p bigint, ds_titulo_p text, nm_usuario_p text ) FROM PUBLIC;

