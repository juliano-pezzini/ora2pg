-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gc_baixar_prescr_mat_esp_js ( nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_prescricao_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_sucesso_p INOUT text, ie_html_p text default 'N') AS $body$
DECLARE


cd_local_estoque_w		bigint := 0;
cd_local_estoque_esp_w		bigint := 0;
nr_setor_cobra_mat_especiais_w	bigint := 0;
nr_seq_ate_pac_unid_w		bigint := 0;
ds_erro_w			varchar(255);

BEGIN

select	cd_local_estoque
into STRICT	cd_local_estoque_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_p;

cd_local_estoque_esp_w := obter_param_usuario(900, 128, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_local_estoque_esp_w);
nr_setor_cobra_mat_especiais_w := obter_param_usuario(900, 293, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, nr_setor_cobra_mat_especiais_w);

if (cd_local_estoque_esp_w > 0) then
	begin
	cd_local_estoque_w := cd_local_estoque_esp_w;
	end;
end if;

if (nr_setor_cobra_mat_especiais_w > 0) and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	begin
	CALL gerar_passagem_setor_atend(nr_atendimento_p,nr_setor_cobra_mat_especiais_w,clock_timestamp(),'N',nm_usuario_p);

	select	max(nr_seq_interno)
	into STRICT	nr_seq_ate_pac_unid_w
	from    atend_paciente_unidade
	where   nr_atendimento = nr_atendimento_p
	and     cd_setor_atendimento = nr_setor_cobra_mat_especiais_w;
	end;
end if;

if (nr_seq_ate_pac_unid_w = 0) then
	begin
	nr_seq_ate_pac_unid_w := obter_unid_setor_cirurgia(nr_cirurgia_p,'N');
	end;
end if;

ds_erro_w := baixa_prescr_mat_esp_cirurgia(nr_cirurgia_p, nr_prescricao_p, cd_local_estoque_w, nr_seq_ate_pac_unid_w, nm_usuario_p, obter_perfil_ativo, ds_erro_w);

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	if (ie_html_p	<> 'N')then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort( 262328 , 'DS_MENSAGEM='||ds_erro_w );
	else
		ds_msg_sucesso_p	:= ds_erro_w;
	end if;
else	
	ds_msg_sucesso_p := substr(obter_texto_tasy(1079495, wheb_usuario_pck.get_nr_seq_idioma),1,255);
end if;
commit;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gc_baixar_prescr_mat_esp_js ( nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_prescricao_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_sucesso_p INOUT text, ie_html_p text default 'N') FROM PUBLIC;

