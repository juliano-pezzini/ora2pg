-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_ata_gerar_os_pendencia ( cd_pessoa_solicitante_p text, nr_sequencia_p text, nm_usuario_exec_p text, nr_seq_equipamento_p text, nr_seq_localizacao_p text, nm_usuario_p text, nr_seq_estagio_p bigint, nr_seq_ordem_p INOUT bigint, ie_tipo_ordem_p INOUT text) AS $body$
DECLARE


ds_dano_w		varchar(4000);
ds_dano_breve_w		varchar(80);
nr_seq_ordem_w		bigint;
nr_sequencia_w		bigint;
nr_sequencia_pend_w	bigint;
ie_grupo_trabalho_w	bigint;
ie_grupo_planej_w		bigint;
nr_seq_estagio_w		bigint := null;
dt_prev_solucao_w		timestamp;
ie_param_tipo_ordem_w		varchar(1);
ie_tipo_ordem_w			varchar(2);


BEGIN

ie_grupo_trabalho_w := Obter_Param_Usuario(1351, 9, obter_perfil_ativo, nm_usuario_p, 0, ie_grupo_trabalho_w);
ie_grupo_planej_w := Obter_Param_Usuario(1351, 10, obter_perfil_ativo, nm_usuario_p, 0, ie_grupo_planej_w);
ie_param_tipo_ordem_w := Obter_Param_Usuario(1351, 25, obter_perfil_ativo, nm_usuario_p, 0, ie_param_tipo_ordem_w);

select	substr(c.ds_pendencia,1,80),
	c.dt_prev_solucao,
	substr(c.ds_pendencia ||': '|| c.ds_observacao,1,4000) ds_dano
into STRICT	ds_dano_breve_w,
	dt_prev_solucao_w,
	ds_dano_w
from	proj_ata_pendencia c,
	proj_ata b
where	c.nr_seq_ata		= b.nr_sequencia
and	c.nr_sequencia		= nr_sequencia_p;

select	nextval('man_ordem_servico_seq')
into STRICT	nr_seq_ordem_w
;

if (nr_seq_estagio_p <> 0) then
	nr_seq_estagio_w := nr_seq_estagio_p;
end if;

ie_tipo_ordem_w := '1';

if (ie_param_tipo_ordem_w = 'S') then
	ie_tipo_ordem_w := '14';
end if;

insert into man_ordem_servico(cd_pessoa_solicitante,
		ds_dano,
		ds_dano_breve,
		dt_atualizacao,
		dt_ordem_servico,
		ie_parado,
		ie_prioridade,
		ie_tipo_ordem,
		nm_usuario,
		nr_seq_equipamento,
		nr_seq_localizacao,
		nr_sequencia,
		nr_grupo_planej,
		nr_grupo_trabalho,
		ie_status_ordem,
		nr_seq_estagio,
		dt_conclusao_desejada,
		dt_fim_previsto,
		ie_origem_os)
	values (cd_pessoa_solicitante_p,
		ds_dano_w,
		ds_dano_breve_w,
		clock_timestamp(),
		clock_timestamp(),
		'N',
		'M',
		ie_tipo_ordem_w,
		nm_usuario_p,
		nr_seq_equipamento_p,
		nr_seq_localizacao_p,
		nr_seq_ordem_w,
		ie_grupo_planej_w,
		ie_grupo_trabalho_w,
		1,
		nr_seq_estagio_w,
		dt_prev_solucao_w,
		dt_prev_solucao_w,
		CASE WHEN ie_param_tipo_ordem_w='S' THEN 6  ELSE null END );

nr_seq_ordem_p := nr_seq_ordem_w;
ie_tipo_ordem_p := ie_tipo_ordem_w;

select	nextval('man_ordem_servico_exec_seq')
into STRICT	nr_sequencia_w
;

insert into man_ordem_servico_exec(dt_atualizacao,
		nm_usuario,
		nm_usuario_exec,
		nr_seq_ordem,
		nr_sequencia)
	values (clock_timestamp(),
		nm_usuario_p,
		nm_usuario_exec_p,
		nr_seq_ordem_w,
		nr_sequencia_w);

select	nextval('proj_ata_pendencia_os_seq')
into STRICT	nr_sequencia_pend_w
;

insert into proj_ata_pendencia_os(dt_atualizacao,
		nm_usuario,
		nr_seq_ordem,
		nr_seq_pendencia,
		nr_sequencia,
		ie_acordo)
	values (clock_timestamp(),
		nm_usuario_p,
		nr_seq_ordem_w,
		nr_sequencia_p,
		nr_sequencia_pend_w,
		'N');

update	proj_ata_pendencia
set	ie_status		= 'O',
	nm_usuario	= nm_usuario_p,
	dt_atualizacao   	= clock_timestamp()
where	nr_sequencia	= nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_ata_gerar_os_pendencia ( cd_pessoa_solicitante_p text, nr_sequencia_p text, nm_usuario_exec_p text, nr_seq_equipamento_p text, nr_seq_localizacao_p text, nm_usuario_p text, nr_seq_estagio_p bigint, nr_seq_ordem_p INOUT bigint, ie_tipo_ordem_p INOUT text) FROM PUBLIC;

