-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_qtd_conv_regra_cons ( nr_seq_agenda_p bigint, cd_convenio_p bigint, dt_agenda_p timestamp, cd_agenda_p bigint, cd_pessoa_fisica_p text, cd_categoria_p text, cd_plano_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p text, nr_seq_proc_interno_p bigint, ie_tipo_atendimento_p bigint, qt_agendamento_p INOUT bigint, qt_perm_regra_p INOUT bigint, ds_mensagem_p INOUT text) AS $body$
DECLARE


nr_seq_regra_w			bigint;
qt_regra_w			bigint	:= 0;
qt_agendamento_w		bigint	:= 0;
qt_agendamento_out_w		bigint 	:= 0;
cd_funcao_ativa_w		bigint;
cd_convenio_w			bigint;
cd_tipo_agenda_w		bigint;
ds_mensagem_customizada_w	varchar(255)	:= '';
dt_inicio_regra_w		timestamp;
dt_final_regra_w		timestamp;
nr_seq_proc_interno_w		bigint;
ie_tipo_regra_w			varchar(1);
ie_mesmo_pac_w			varchar(1);
cd_especialidade_w				agenda.cd_especialidade%type;
cd_agenda_w				agenda_regra_conv.cd_agenda%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
			cd_convenio,
			cd_agenda
	from	agenda_regra_conv
	where	cd_convenio 		= cd_convenio_p
	and	((cd_agenda 		= cd_agenda_p) 		or (coalesce(cd_agenda::text, '') = ''))
	and	((ie_tipo_atendimento 	= ie_tipo_atendimento_p) or (coalesce(ie_tipo_atendimento::text, '') = ''))
	and	((cd_medico		= cd_medico_p) 		or (coalesce(cd_medico::text, '') = ''))
	and	((cd_categoria		= cd_categoria_p) 	or (coalesce(cd_categoria::text, '') = ''))
	and	((cd_plano		= cd_plano_p) 		or (coalesce(cd_plano::text, '') = ''))
	and	((nr_seq_proc_interno 	= nr_seq_proc_interno_p) or (coalesce(nr_seq_proc_interno::text, '') = ''))
	and	((cd_tipo_agenda	= cd_tipo_agenda_w) 	or (coalesce(cd_tipo_agenda, 0) = 0))
	and	((cd_especialidade	= cd_especialidade_w) 	or (coalesce(cd_especialidade, 0) = 0))
	and	((obter_cod_dia_semana(dt_agenda_p)	= ie_dia_semana) or (ie_dia_semana = 9) or (coalesce(ie_dia_semana::text, '') = ''))
	and	dt_agenda_p	between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_inicial,'hh24:mi:ss'), '00:00:00'),'dd/mm/yyyy hh24:mi:ss')
	and	to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(hr_final,'hh24:mi:ss'), '23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	order by 	coalesce(nr_seq_proc_interno,0),
			coalesce(qt_regra, 0),
			coalesce(cd_especialidade, 0),
			coalesce(cd_agenda, 0),
			coalesce(cd_convenio, 0),
			coalesce(cd_categoria, 0),
			coalesce(cd_plano, 0),
			coalesce(ie_tipo_atendimento,0);


BEGIN
cd_funcao_ativa_w	:= Obter_Funcao_Ativa;

select	coalesce(max(cd_tipo_agenda), 0),
		coalesce(max(cd_especialidade), 0)
into STRICT	cd_tipo_agenda_w,
		cd_especialidade_w
from	agenda
where	cd_agenda	= cd_agenda_p;

if (cd_tipo_agenda_w = 0) then
	select	coalesce(max(cd_tipo_agenda), 0)
	into STRICT	cd_tipo_agenda_w
	from	agenda a,
			agenda_consulta b
	where	a.cd_agenda = b.cd_agenda
	and		b.nr_sequencia = nr_seq_agenda_p;
end if;

open C01;
loop
fetch C01 into
	nr_seq_regra_w,
	cd_convenio_w,
	cd_agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_seq_regra_w 		:= nr_seq_regra_w;

	select	coalesce(ds_mensagem,''),
		to_date(to_char(dt_agenda_p, 'dd/mm/yyyy')||' '||to_char(coalesce(hr_inicial, to_date('30/12/1899 00:00:01', 'dd/mm/yyyy hh24:mi:ss')), 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss'),
		to_date(to_char(dt_agenda_p, 'dd/mm/yyyy')||' '||to_char(coalesce(hr_final, to_date('30/12/1899 23:59:59', 'dd/mm/yyyy hh24:mi:ss')), 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss'),
		coalesce(ie_mesmo_pac,'N')
	into STRICT	ds_mensagem_customizada_w,
		dt_inicio_regra_w,
		dt_final_regra_w,
		ie_mesmo_pac_w
	from	agenda_regra_conv
	where	nr_sequencia	= nr_seq_regra_w;

	end;
end loop;
close C01;

if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
	select	max(qt_regra),
		max(nr_seq_proc_interno),
		coalesce(max(ie_tipo_regra),'D')
	into STRICT	qt_regra_w,
		nr_seq_proc_interno_w,
		ie_tipo_regra_w
	from	agenda_regra_conv
	where	nr_sequencia = nr_seq_regra_w;

	if (cd_tipo_agenda_w = 2)then

		select	count(*)
		into STRICT	qt_agendamento_w
		from	agenda_paciente
		where	ie_status_agenda not in ('F','I','C','L','B','R')
		and	cd_convenio 	= cd_convenio_p
		and	((ie_tipo_regra_w = 'D' AND hr_inicio between dt_inicio_regra_w and dt_final_regra_w) or
			((ie_tipo_regra_w = 'M')  and (trunc(hr_inicio,'month') = trunc(dt_agenda_p, 'month'))) or
			((ie_tipo_regra_w = 'S')  and (trunc(hr_inicio) between obter_inicio_fim_semana(dt_agenda_p,'I') and obter_inicio_fim_semana(dt_agenda_p,'F'))))
		and	cd_agenda 	= cd_agenda_p
		and	nr_sequencia 	<> nr_seq_agenda_p
		and	((cd_pessoa_fisica = cd_pessoa_fisica_p AND ie_mesmo_pac_w = 'S') or (ie_mesmo_pac_w = 'N'))
		and	((nr_seq_proc_interno = nr_seq_proc_interno_w) or (coalesce(nr_seq_proc_interno_w::text, '') = ''));

	elsif (cd_tipo_agenda_w in (3,5)) then

		select	count(*)
		into STRICT	qt_agendamento_w
		from	agenda_consulta
		where	ie_status_agenda not in ('F','I','C','L','B','R')
		and	cd_convenio 	= cd_convenio_p
		and	((ie_tipo_regra_w = 'D' AND dt_agenda between dt_inicio_regra_w and dt_final_regra_w) or
			((ie_tipo_regra_w = 'M')  and (trunc(dt_agenda,'month') = trunc(dt_agenda_p, 'month'))) or
			((ie_tipo_regra_w = 'S')  and (trunc(dt_agenda) between obter_inicio_fim_semana(dt_agenda_p,'I') and obter_inicio_fim_semana(dt_agenda_p,'F'))))
		and	((cd_agenda = cd_agenda_w) or (coalesce(cd_agenda_w::text, '') = ''))
		and	nr_sequencia 	<> nr_seq_agenda_p
		and	((cd_pessoa_fisica = cd_pessoa_fisica_p AND ie_mesmo_pac_w = 'S') or (ie_mesmo_pac_w = 'N'));

	end if;

	if (cd_convenio_w = cd_convenio_p)then
		qt_agendamento_w	:= qt_agendamento_w + 1;
	end if;

	if (qt_agendamento_w > qt_regra_w) and (cd_funcao_ativa_w <> 869) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(192298);
	end if;
end if;

qt_agendamento_out_w	:= 	qt_agendamento_w;
qt_agendamento_p	:= 	qt_agendamento_out_w;
qt_perm_regra_p		:=	qt_regra_w;
ds_mensagem_p		:=  ds_mensagem_customizada_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_qtd_conv_regra_cons ( nr_seq_agenda_p bigint, cd_convenio_p bigint, dt_agenda_p timestamp, cd_agenda_p bigint, cd_pessoa_fisica_p text, cd_categoria_p text, cd_plano_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p text, nr_seq_proc_interno_p bigint, ie_tipo_atendimento_p bigint, qt_agendamento_p INOUT bigint, qt_perm_regra_p INOUT bigint, ds_mensagem_p INOUT text) FROM PUBLIC;

