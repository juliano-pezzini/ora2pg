-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_atualizar_filtro_hemocomp ( nr_seq_producao_p san_producao.nr_sequencia%type, qt_peso_filtro_hemocomp_p san_producao.qt_peso_apos_filtragem%type, qt_volume_ant_p san_producao_log_alteracao.qt_volume_ant%type, qt_vol_filtro_hemocomp_p san_producao.qt_volume_apos_filtragem%type, dt_validade_filtro_hemocomp_p san_producao.dt_validade_apos_filtragem%type, nm_usuario_p san_producao.nm_usuario%type, cd_pf_filtro_p san_producao.cd_pf_filtro%type default null, nr_lote_filtro_p san_producao.nr_lote_filtro%type default null, ds_bolsa_transf_p san_producao.ds_bolsa_transf%type default null) AS $body$
BEGIN
if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') then
	update 	san_producao
	set	qt_peso_apos_filtragem          = qt_peso_filtro_hemocomp_p,
		qt_volume_apos_filtragem        = qt_vol_filtro_hemocomp_p,
		qt_volume                       = coalesce(qt_vol_filtro_hemocomp_p, qt_volume),
		dt_validade_apos_filtragem      = dt_validade_filtro_hemocomp_p,
		dt_atualizacao                  = clock_timestamp(),
		nm_usuario                      = nm_usuario_p,
		ie_filtrado                     = 'S',
		cd_pf_filtro                    = cd_pf_filtro_p,
		nr_lote_filtro                  = nr_lote_filtro_p,
		ds_bolsa_transf                 = ds_bolsa_transf_p
	where   nr_sequencia                = nr_seq_producao_p;

	CALL san_grava_log_producao_alterac(
		nr_seq_producao_p       => nr_seq_producao_p,
		qt_volume_anterior_p    => qt_volume_ant_p,
		qt_volume_atual_p       => qt_vol_filtro_hemocomp_p,
		ie_update_p             => 'N',
		nm_usuario_p            => nm_usuario_p
	);
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_atualizar_filtro_hemocomp ( nr_seq_producao_p san_producao.nr_sequencia%type, qt_peso_filtro_hemocomp_p san_producao.qt_peso_apos_filtragem%type, qt_volume_ant_p san_producao_log_alteracao.qt_volume_ant%type, qt_vol_filtro_hemocomp_p san_producao.qt_volume_apos_filtragem%type, dt_validade_filtro_hemocomp_p san_producao.dt_validade_apos_filtragem%type, nm_usuario_p san_producao.nm_usuario%type, cd_pf_filtro_p san_producao.cd_pf_filtro%type default null, nr_lote_filtro_p san_producao.nr_lote_filtro%type default null, ds_bolsa_transf_p san_producao.ds_bolsa_transf%type default null) FROM PUBLIC;

