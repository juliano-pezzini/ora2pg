-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nota_recusa ( nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_nf_recusa_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w		nota_fiscal.nr_sequencia%type;
cd_serie_nf_w		serie_nota_fiscal.cd_serie_nf%type;
cd_estabelecimento_w	nota_fiscal.cd_estabelecimento%type;
cd_cgc_emitente_w	pessoa_juridica.cd_cgc%type;
cd_operacao_nf_w		nota_fiscal.cd_operacao_nf%type;
cd_natureza_operacao_w	nota_fiscal.cd_natureza_operacao%type;
cd_oper_nf_corresp_w	nota_fiscal.cd_operacao_nf%type;
cd_cfop_inverso_w		natureza_operacao.cd_cfop_inverso%type;
cd_natureza_inversa_w	nota_fiscal.cd_natureza_operacao%type;
nr_nota_fiscal_w		nota_fiscal.nr_nota_fiscal%type;
nr_sequencia_nf_w		nota_fiscal.nr_sequencia_nf%type;
ie_grava_obs_lote_w	funcao_param_usuario.vl_parametro%type;
cd_perfil_ativo_w		perfil.cd_perfil%type;


BEGIN

cd_perfil_ativo_w := obter_perfil_ativo;

select	cd_serie_nf,
	cd_estabelecimento,
	cd_operacao_nf,
	cd_natureza_operacao
into STRICT	cd_serie_nf_w,
	cd_estabelecimento_w,
	cd_operacao_nf_w,
	cd_natureza_operacao_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

ie_grava_obs_lote_w := obter_param_usuario(40, 144, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_grava_obs_lote_w);

select	nextval('nota_fiscal_seq')
into STRICT	nr_sequencia_w
;

select	coalesce(max(somente_numero(nr_ultima_nf)), nr_sequencia_w) + 1
into STRICT	nr_nota_fiscal_w
from	serie_nota_fiscal
where	cd_serie_nf 		= cd_serie_nf_w
and	cd_estabelecimento 	= cd_estabelecimento_w;

select	cd_cgc
into STRICT	cd_cgc_emitente_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_w;

select	cd_oper_nf_corresp
into STRICT	cd_oper_nf_corresp_w
from	operacao_nota
where	cd_operacao_nf = cd_operacao_nf_w;

select	coalesce(max(cd_cfop_inverso),'0')
into STRICT	cd_cfop_inverso_w
from	natureza_operacao
where	cd_natureza_operacao = cd_natureza_operacao_w;

if (cd_cfop_inverso_w <> '0') then
	select	max(cd_natureza_operacao)
	into STRICT	cd_natureza_inversa_w
	from	natureza_operacao
	where	cd_cfop = cd_cfop_inverso_w
	and	ie_situacao = 'A';
end if;

select	coalesce(max(nr_sequencia_nf),0) + 1
into STRICT	nr_sequencia_nf_w
from	nota_fiscal
where	cd_estabelecimento = cd_estabelecimento_w
and	nr_nota_fiscal = nr_nota_fiscal_w
and	cd_serie_nf = cd_serie_nf_w
and	cd_cgc_emitente = cd_cgc_emitente_w;

insert into nota_fiscal(
	nr_sequencia,
	nr_nota_fiscal,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_sequencia_nf,
	cd_operacao_nf,
	dt_emissao,
	dt_entrada_saida,
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	vl_mercadoria,
	vl_total_nota,
	qt_peso_bruto,
	qt_peso_liquido,
	dt_atualizacao,
	nm_usuario,
	cd_condicao_pagamento,
	cd_cgc,
	cd_pessoa_fisica,
	vl_descontos,
	vl_frete,
	vl_seguro,
	vl_despesa_acessoria,
	ds_observacao,
	cd_natureza_operacao,
	vl_desconto_rateio,
	ie_situacao,
	nr_sequencia_ref,
	cd_moeda,
	vl_conv_moeda,
	ie_tipo_nota,
	cd_setor_digitacao,
	nr_danfe,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_tipo_servico,
	ie_nf_eletronica,
	ie_compl_tributo,
	ds_dados_adic_itens,
	vl_despesa_doc)
SELECT	nr_sequencia_w,
	nr_nota_fiscal_w,
	cd_estabelecimento_w,
	cd_cgc_emitente_w,
	cd_serie_nf_w,
	nr_sequencia_nf_w,
	cd_oper_nf_corresp_w,
	clock_timestamp(),
	clock_timestamp(),
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	0,
	0,
	qt_peso_bruto,
	qt_peso_liquido,
	clock_timestamp(),
	nm_usuario_p,
	cd_condicao_pagamento,
	cd_cgc,
	cd_pessoa_fisica,
	vl_descontos,
	vl_frete,
	vl_seguro,
	vl_despesa_acessoria,
	ds_observacao,
	cd_natureza_inversa_w,
	vl_desconto_rateio,
	'1',
	nr_sequencia_p,
	cd_moeda,
	vl_conv_moeda,
	'EP',
	cd_setor_digitacao,
	nr_danfe,
	clock_timestamp(),
	nm_usuario_p,
	cd_tipo_servico,
	ie_nf_eletronica,
	ie_compl_tributo,
	substr(ds_justificativa_p,1,255),
	vl_despesa_doc
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

insert into nota_fiscal_item(
	nr_sequencia,
	nr_nota_fiscal,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_sequencia_nf,
	nr_item_nf,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	dt_atualizacao,
	nm_usuario,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	vl_liquido,
	pr_desconto,
	nr_item_oci,
	dt_entrega_ordem,
	nr_seq_conta_financ,
	nr_contrato,
	ds_complemento,
	nr_seq_proj_rec,
	vl_projeto,
	nr_atendimento,
	pr_desc_financ,
	vl_desc_financ,
	nr_seq_ordem_serv,
	ds_justificativa,
	vl_liq_moeda_ref,
	nr_seq_unidade_adic,
	nr_seq_lote_fornec,
	ie_atualizar_barras,
	cd_barra_material,
	nr_sequencia_vinc_consig,
	nr_seq_inspecao,
	ds_barras,
	cd_imobilizado,
	cd_imob_serie,
	ie_indeterminado,
	nr_seq_classif_trib,
	nr_seq_marca,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_fabricacao,
	nr_seq_regra_contrato,
	nr_solic_compra,
	nr_item_solic_compra,
	nr_adicao,
	nr_seq_adicao,
	cd_fab_estrangeiro,
	vl_desc_adicao,
	ie_material_estoque,
	nr_seq_produto,
	nr_seq_nf_orig,
	nr_seq_item_nf_orig,
	ie_barras_lido,
	vl_liquido_cfop,
	nr_atend_lancamento,
	cd_historico,
	cd_fornecedor_consig,
	nr_serie_material,
	dt_atend_lancamento,
	cd_paciente,
	nr_seq_modelo,
	nr_prescricao)
SELECT	nr_sequencia_w,
	nr_nota_fiscal_w,
	cd_estabelecimento_w,
	cd_cgc_emitente_w,
	cd_serie_nf_w,
	nr_sequencia_nf_w,
	nr_item_nf,
	cd_natureza_inversa_w,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	clock_timestamp(),
	nm_usuario_p,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	vl_liquido,
	pr_desconto,
	nr_item_oci,
	dt_entrega_ordem,
	nr_seq_conta_financ,
	nr_contrato,
	ds_complemento,
	nr_seq_proj_rec,
	vl_projeto,
	nr_atendimento,
	pr_desc_financ,
	vl_desc_financ,
	nr_seq_ordem_serv,
	ds_justificativa,
	vl_liq_moeda_ref,
	nr_seq_unidade_adic,
	nr_seq_lote_fornec,
	ie_atualizar_barras,
	cd_barra_material,
	nr_sequencia_vinc_consig,
	nr_seq_inspecao,
	ds_barras,
	cd_imobilizado,
	cd_imob_serie,
	ie_indeterminado,
	nr_seq_classif_trib,
	nr_seq_marca,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_fabricacao,
	nr_seq_regra_contrato,
	nr_solic_compra,
	nr_item_solic_compra,
	nr_adicao,
	nr_seq_adicao,
	cd_fab_estrangeiro,
	vl_desc_adicao,
	ie_material_estoque,
	nr_seq_produto,
	nr_sequencia_p,
	nr_item_nf,
	ie_barras_lido,
	vl_liquido_cfop,
	nr_atend_lancamento,
	cd_historico,
	cd_fornecedor_consig,
	nr_serie_material,
	dt_atend_lancamento,
	cd_paciente,
	nr_seq_modelo,
	nr_prescricao
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

insert into nota_fiscal_item_lote(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	nr_seq_nota,
	nr_item_nf,
	dt_validade,
	qt_material,
	cd_lote_fabricacao,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_marca,
	nr_seq_lote_fornec,
	cd_barra_material,
	ds_barras,
	ie_indeterminado,
	qt_compra,
	dt_fabricacao,
	nr_seq_lote_fornec_orig,
	nr_serie_material)
SELECT	nextval('nota_fiscal_item_lote_seq'),
	clock_timestamp(),
	nm_usuario_p,
	nr_sequencia_w,
	nr_item_nf,
	dt_validade,
	qt_material,
	cd_lote_fabricacao,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_marca,
	nr_seq_lote_fornec,
	cd_barra_material,
	ds_barras,
	ie_indeterminado,
	qt_compra,
	dt_fabricacao,
	nr_seq_lote_fornec_orig,
	nr_serie_material
from	nota_fiscal_item_lote
where	nr_seq_nota = nr_sequencia_p;

insert into nota_fiscal_item_rateio(
	nr_sequencia,
	nr_seq_nota,
	nr_item_nf,
	dt_atualizacao,
	nm_usuario,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	ie_situacao,
	nr_seq_criterio,
	vl_tributo,
	nr_seq_orc_item_gpi,
	qt_rateio)
SELECT	nextval('nota_fiscal_item_rateio_seq'),
	nr_sequencia_w,
	nr_item_nf,
	clock_timestamp(),
	nm_usuario_p,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	ie_situacao,
	nr_seq_criterio,
	vl_tributo,
	nr_seq_orc_item_gpi,
	qt_rateio
from	nota_fiscal_item_rateio
where	nr_seq_nota = nr_sequencia_p;

CALL gerar_tributos_fornecedor_item(nr_sequencia_w, '0', '', 'N', clock_timestamp(), nm_usuario_p, 'N');
CALL gerar_tributos_fornecedor(nr_sequencia_w, '', nm_usuario_p, clock_timestamp(), 'N');
CALL atualiza_total_nota_fiscal(nr_sequencia_w, nm_usuario_p);
CALL gerar_vencimento_nota_fiscal(nr_sequencia_w, nm_usuario_p);
CALL gerar_trib_venc_nota(nr_sequencia_w, '', nm_usuario_p, clock_timestamp());

begin
CALL atualizar_nota_fiscal(nr_sequencia_w, 'I', nm_usuario_p, 5);
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(309466); /*A nota fiscal foi gerada, mas deu uma consistência ao calcular. Peço que abra a nota fiscal e tente calcular manualmente para verificar qual é a consistência.*/
end;

CALL gerar_lote_fornec_nf(nr_sequencia_w, ie_grava_obs_lote_w, nm_usuario_p,null);

nr_seq_nf_recusa_p	:= nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nota_recusa ( nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_nf_recusa_p INOUT bigint) FROM PUBLIC;

