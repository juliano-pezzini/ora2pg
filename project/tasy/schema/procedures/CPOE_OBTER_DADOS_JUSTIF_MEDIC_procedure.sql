-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_dados_justif_medic ( nr_atendimento_p bigint, cd_material_p material.cd_material%type, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_prescritor_p bigint, ie_via_aplicacao_p material_prescr.ie_via_aplicacao%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p text, ie_se_necessario_p text, ie_solucao_p text, ie_considerar_peso_p text, qt_dose material.qt_limite_pessoa%type, ie_bomba_infusao_p cpoe_material.ie_bomba_infusao%type, ie_exige_justificativa_p INOUT material_prescr.ie_exige_justificativa%type, ie_justificativa_padrao_p INOUT material_prescr.ie_justificativa_padrao%type, ds_justificativa_p INOUT text ) AS $body$
DECLARE


nr_seq_agrupamento_w		bigint;
qt_idade_w					bigint;
qt_idade_dia_w				double precision;
qt_idade_mes_w				double precision;
qt_peso_w					double precision;
qt_regra					bigint;
ie_exige_justificativa_w	material_prescr.ie_exige_justificativa%type;
ie_justificativa_padrao_w	material_prescr.ie_justificativa_padrao%type;


BEGIN

select	coalesce(max('S'),'N')
into STRICT	ie_exige_justificativa_p
from	regra_prescr_mat_justi
where	cd_material = cd_material_p
and 	coalesce(ie_bomba_infusao,coalesce(ie_bomba_infusao_p,'XPTO')) = coalesce(ie_bomba_infusao_p,'XPTO')
and	coalesce(cd_setor_atendimento, cd_setor_atendimento_p) = cd_setor_atendimento_p
and	((obter_sinal_vital(nr_atendimento_p, 'Peso') between coalesce(qt_peso_inicial,0) and coalesce(qt_peso_final,999)) or ((coalesce(qt_peso_inicial::text, '') = '') and (coalesce(qt_peso_final::text, '') = '')))
and	coalesce(cd_perfil, obter_perfil_ativo) = obter_perfil_ativo
and	coalesce(cd_convenio, obter_convenio_atendimento(nr_atendimento_p)) = obter_convenio_atendimento(nr_atendimento_p)
and	ie_situacao = 'A';

select	CASE WHEN ie_exige_justificativa_p='N' THEN  coalesce(max(ie_obriga_justificativa), 'N')  ELSE ie_exige_justificativa_p END ,
	coalesce(max(ie_justificativa_padrao), 'N')
into STRICT	ie_exige_justificativa_p,
	ie_justificativa_padrao_p
from	material
where 	cd_material = cd_material_p;

select
	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DI')),
	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'MM')),
	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'A'))
into STRICT
	qt_idade_dia_w,
	qt_idade_mes_w,
	qt_idade_w
from pessoa_fisica b
where b.cd_pessoa_fisica = cd_pessoa_fisica_p;

select	round((max(obter_sinal_vital(nr_atendimento_p,'Peso')))::numeric, 3)
into STRICT	qt_peso_w
;

if (ie_exige_justificativa_p = 'N' OR ie_justificativa_padrao_p = 'N') then
	begin

	select	count(*)
	into STRICT	qt_regra
	from	material_prescr
	where	cd_material	= cd_material_p;

	if (qt_regra > 0) then
		begin
		
		select	max(nr_seq_agrupamento)
		into STRICT	nr_seq_agrupamento_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_p;

		-- Obtendo o valor da regra
		select	coalesce(max(ie_exige_justificativa),'N'), coalesce(max(ie_justificativa_padrao), 'N')
		into STRICT	ie_exige_justificativa_w, ie_justificativa_padrao_w
		from	material_prescr
		where	coalesce(cd_setor_atendimento, coalesce( cd_setor_prescr_p,0))	= coalesce( cd_setor_prescr_p,0)
		and		cd_material		= cd_material_p
		and		coalesce(cd_estabelecimento, cd_estabelecimento_p ) = cd_estabelecimento_p
		and		coalesce(cd_setor_atendimento, coalesce( cd_setor_atendimento_p ,0)) = coalesce( cd_setor_atendimento_p,0)
		and		coalesce(ie_via_aplicacao, coalesce( ie_via_aplicacao_p,0)) = coalesce( ie_via_aplicacao_p,0)
		and		coalesce(cd_intervalo_filtro, coalesce(cd_intervalo_p,0)) = coalesce(cd_intervalo_p,0)
		and		coalesce(ie_somente_sn, coalesce(ie_se_necessario_p,'N')) = coalesce(ie_se_necessario_p,'N')
		and		qt_idade_dia_w between coalesce(qt_idade_min_dia,0) and coalesce(qt_idade_max_dia,55000)
		and		qt_idade_mes_w between coalesce(qt_idade_min_mes,0) and coalesce(qt_idade_max_mes,55000)
		and		((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w ))
		and		coalesce(qt_idade_w,0) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999)
		and (ie_considerar_peso_p = 'N'
					or (coalesce(qt_peso_w,0) between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999)))
		and		Obter_se_setor_regra_prescr( nr_sequencia, cd_setor_atendimento_p ) = 'S'
		and		((coalesce(cd_especialidade::text, '') = '') or (obter_se_especialidade_medico( cd_prescritor_p, cd_especialidade ) = 'S'));
		
		if (ie_exige_justificativa_p = 'N') then
			if (ie_exige_justificativa_w = 'N') then
				begin
				
				select coalesce(max(ie_obriga_just_dose), 'N')
				into STRICT ie_exige_justificativa_p
				from material_prescr
				where cd_material = cd_material_p
				and coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
				and ie_obriga_just_dose = 'S'
				and (qt_limite_pessoa IS NOT NULL AND qt_limite_pessoa::text <> '')
				and qt_limite_pessoa < qt_dose;
				
				end;
			else
				ie_exige_justificativa_p := ie_exige_justificativa_w;
			end if;
		end if;
		
		if (ie_justificativa_padrao_p = 'N') then
			ie_justificativa_padrao_p := ie_justificativa_padrao_w;
		end if;
		
		end;
	end if;
	
	end;
end if;

ds_justificativa_p := Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_p, ie_via_aplicacao_p, cd_setor_atendimento_p, cd_pessoa_fisica_p, qt_idade_w, qt_peso_w, ie_se_necessario_p, 'J', cd_intervalo_p, ie_solucao_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_dados_justif_medic ( nr_atendimento_p bigint, cd_material_p material.cd_material%type, cd_setor_prescr_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_prescritor_p bigint, ie_via_aplicacao_p material_prescr.ie_via_aplicacao%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p text, ie_se_necessario_p text, ie_solucao_p text, ie_considerar_peso_p text, qt_dose material.qt_limite_pessoa%type, ie_bomba_infusao_p cpoe_material.ie_bomba_infusao%type, ie_exige_justificativa_p INOUT material_prescr.ie_exige_justificativa%type, ie_justificativa_padrao_p INOUT material_prescr.ie_justificativa_padrao%type, ds_justificativa_p INOUT text ) FROM PUBLIC;

