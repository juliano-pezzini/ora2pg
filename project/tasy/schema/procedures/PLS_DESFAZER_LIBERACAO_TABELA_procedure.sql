-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_liberacao_tabela ( nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_tabela_segurado_w		bigint;
qt_tabela_origem_w		bigint;
qt_reajuste_tabela_w		bigint;
nr_seq_tabela_w			bigint;
ie_tabela_principal_w		varchar(2);

C01 CURSOR FOR
	SELECT 	nr_sequencia,
		CASE WHEN coalesce(nr_seq_principal::text, '') = '' THEN 'N'  ELSE 'S' END
	from 	pls_tabela_preco
	where 	nr_sequencia 		= nr_seq_tabela_p
	or 	nr_seq_principal	= nr_seq_tabela_p;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_tabela_w,
	ie_tabela_principal_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	count(*)
	into STRICT	qt_tabela_segurado_w
	from	pls_segurado
	where	nr_seq_tabela = nr_seq_tabela_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

	select	count(*)
	into STRICT	qt_tabela_origem_w
	from	pls_contrato_plano a,
		pls_contrato b
	where	a.nr_seq_contrato	= b.nr_sequencia
	and	a.nr_seq_tabela_origem	= nr_seq_tabela_w
	and	(b.dt_aprovacao IS NOT NULL AND b.dt_aprovacao::text <> '');

	if (qt_tabela_segurado_w > 0) or (qt_tabela_origem_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265796,'');
		--Mensagem: Esta tabela já foi comercializada. Não é possível alterar os dados da tabela.
	end if;

	select	count(*)
	into STRICT	qt_reajuste_tabela_w
	from	pls_reajuste_preco a,
		pls_plano_preco b,
		pls_tabela_preco c
	where	a.nr_seq_preco	= b.nr_sequencia
	and	b.nr_seq_tabela	= c.nr_sequencia
	and	c.nr_sequencia	= nr_seq_tabela_w;

	if (qt_reajuste_tabela_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265796,'');
		--Mensagem: Esta tabela já foi reajustada. Não é possível alterar os dados da tabela.
	end if;

	update	pls_tabela_preco
	set	dt_liberacao	 = NULL,
		dt_fim_vigencia	 = NULL,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_tabela_w;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_liberacao_tabela ( nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;

