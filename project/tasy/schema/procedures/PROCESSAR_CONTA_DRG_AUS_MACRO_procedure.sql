-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE processar_conta_drg_aus_macro ( ds_calculo_p text, ds_calculo_days_p text, ie_opcao_p text default 'P') AS $body$
DECLARE



 c001					integer;
 ds_calculo_w			varchar(4000);
 vl_resultado_w			double precision;
 retorno_w				integer;
 vl_retorno_w			double precision;

 ds_calculo_days_w		varchar(4000);
 vl_resultado_days_w	double precision;
 retorno_days_w			integer;
 vl_retorno_days_w		double precision;



BEGIN

/*	ie_opcao_p
	'T' - TESTE
	'P' - PROCESSAR_CONTA
*/
	if ('T' = ie_opcao_p) then
		CALL processar_conta_drg_aus_pck.set_vl_trnfr_dscnt(1);
		CALL processar_conta_drg_aus_pck.set_vl_sso_benefit(1);
		CALL processar_conta_drg_aus_pck.set_vl_short_diem_weight(1);
		CALL processar_conta_drg_aus_pck.set_vl_same_day_weight(1);
		CALL processar_conta_drg_aus_pck.set_vl_same_day_rate(1);
		CALL processar_conta_drg_aus_pck.set_vl_rate_lt_6_hrs(1);
		CALL processar_conta_drg_aus_pck.set_vl_rate_gt_6_hrs(1);
		CALL processar_conta_drg_aus_pck.set_vl_proc_only_fee(1);
		CALL processar_conta_drg_aus_pck.set_vl_overnight_flagfall_mv(1);
		CALL processar_conta_drg_aus_pck.set_vl_overnight_flagfall(1);
		CALL processar_conta_drg_aus_pck.set_vl_lso_benefit(1);
		CALL processar_conta_drg_aus_pck.set_vl_long_diem_weight(1);
		CALL processar_conta_drg_aus_pck.set_vl_inlier_weight(1);
		CALL processar_conta_drg_aus_pck.set_vl_inlier_rate_tier3(1);
		CALL processar_conta_drg_aus_pck.set_vl_inlier_rate_tier2(1);
		CALL processar_conta_drg_aus_pck.set_vl_inlier_rate(1);
		CALL processar_conta_drg_aus_pck.set_vl_icu_sso(1);
		CALL processar_conta_drg_aus_pck.set_qt_dias_icu_a(2);
		CALL processar_conta_drg_aus_pck.set_qt_dias_icu_b(1);
		CALL processar_conta_drg_aus_pck.set_qt_dias_icu_c(1);
		CALL processar_conta_drg_aus_pck.set_qt_dias_not_icu(4);
	end if;

	ds_calculo_w := upper(ds_calculo_p);

	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TRANSFER_DISCOUNT_VALUE', processar_conta_drg_aus_pck.get_vl_trnfr_dscnt),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SHORT_STAY_OUTLIER_BENEFIT', processar_conta_drg_aus_pck.get_vl_sso_benefit),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SHORT_DIEM_WEIGHT', processar_conta_drg_aus_pck.get_vl_short_diem_weight),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SAMEDAY_WEIGHT', processar_conta_drg_aus_pck.get_vl_same_day_weight),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SAMEDAY_RATE', processar_conta_drg_aus_pck.get_vl_same_day_rate),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SAMEDAY_CASE_LT', processar_conta_drg_aus_pck.get_vl_rate_lt_6_hrs),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@SAMEDAY_CASE_GT', processar_conta_drg_aus_pck.get_vl_rate_gt_6_hrs),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@PROCEDURE_ONLY_FEE_VALUE', processar_conta_drg_aus_pck.get_vl_proc_only_fee),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@OVERNIGHT_FLAGFALL_MV', processar_conta_drg_aus_pck.get_vl_overnight_flagfall_mv),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@OVERNIGHT_FLAGFALL', processar_conta_drg_aus_pck.get_vl_overnight_flagfall),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@LONG_STAY_OUTLIER_BENEFIT', processar_conta_drg_aus_pck.get_vl_lso_benefit),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@LONG_DIEM_WEIGHT', processar_conta_drg_aus_pck.get_vl_long_diem_weight),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@INLIER_EPISODIC_WEIGHT', processar_conta_drg_aus_pck.get_vl_inlier_weight),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TIER3_RANGE_INLIER_PRICE', processar_conta_drg_aus_pck.get_vl_inlier_rate_tier3),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TIER2_RANGE_INLIER_PRICE', processar_conta_drg_aus_pck.get_vl_inlier_rate_tier2),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TIER1_RANGE_INLIER_PRICE', processar_conta_drg_aus_pck.get_vl_inlier_rate),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@INLIER_RATE_EPISODIC', processar_conta_drg_aus_pck.get_vl_inlier_rate),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@ICU_SHORT_STAY_OUTLIER_BENEFIT', processar_conta_drg_aus_pck.get_vl_icu_sso),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_SPENT_IN_ICU_CATEGORY_A', processar_conta_drg_aus_pck.get_qt_dias_icu_a),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_SPENT_IN_ICU_CATEGORY_B', processar_conta_drg_aus_pck.get_qt_dias_icu_b),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_SPENT_IN_ICU_CATEGORY_C', processar_conta_drg_aus_pck.get_qt_dias_icu_c),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_IN_NON_ICU_DEPARTMENT', processar_conta_drg_aus_pck.get_qt_dias_not_icu),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@HOURS_SPENT_IN_HOSP', processar_conta_drg_aus_pck.get_qt_horas_int),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_SPENT_IN_HOSPITAL', processar_conta_drg_aus_pck.get_qt_total_days),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_SPENT_IN_ICU', processar_conta_drg_aus_pck.get_qt_days_in_icu),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_NOT_SPENT_IN_ICU_CAT_A', processar_conta_drg_aus_pck.get_qt_days_not_in_icu_cat_a),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_EXCEED_IN_TIER3', processar_conta_drg_aus_pck.get_qt_days_exceeds_tier3),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_EXCEED_IN_TIER2', processar_conta_drg_aus_pck.get_qt_days_exceeds_tier2),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_EXCEED_IN_TIER1', processar_conta_drg_aus_pck.get_qt_days_exceeds_tier1),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TOTAL_DAYS_IN_TIER1', processar_conta_drg_aus_pck.get_qt_days_in_tier1),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@TOTAL_DAYS_IN_TIER2', processar_conta_drg_aus_pck.get_qt_days_in_tier2),1,4000);
	ds_calculo_w := substr(replace_macro(ds_calculo_w, '@DAYS_OF_TRANSFER_DISCOUNT', processar_conta_drg_aus_pck.get_qt_days_for_tran_disc),1,4000);

	ds_calculo_w := 'select ' || ds_calculo_w || ' from dual';

	ds_calculo_w := replace(ds_calculo_w, ',', '.');

	begin
		c001 := dbms_sql.open_cursor;
		dbms_sql.parse(c001, ds_calculo_w, dbms_sql.native);
		if (upper(substr(ds_calculo_w,1,6)) = 'SELECT') then
			dbms_sql.define_column(c001, 1, vl_resultado_w);
		end if;

		retorno_w := dbms_sql.execute(c001);

		if (upper(substr(ds_calculo_w,1,6)) = 'SELECT') then
			
			begin
				retorno_w := dbms_sql.fetch_rows(c001);
				dbms_sql.column_value(c001, 1, vl_resultado_w);
			end;
			
		end if;
		dbms_sql.close_cursor(c001);
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(333613, 'ds_calculo_p=' || ds_calculo_p);
		dbms_sql.close_cursor(c001);
	end;

	if coalesce(vl_resultado_w::text, '') = '' then
		CALL processar_conta_drg_aus_pck.set_vl_procedimento(0);
	else
		CALL processar_conta_drg_aus_pck.set_vl_procedimento(vl_resultado_w);
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE processar_conta_drg_aus_macro ( ds_calculo_p text, ds_calculo_days_p text, ie_opcao_p text default 'P') FROM PUBLIC;

