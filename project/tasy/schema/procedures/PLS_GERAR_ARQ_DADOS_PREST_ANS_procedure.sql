-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arq_dados_prest_ans ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_tipo_prestador_p pls_prestador.nr_seq_tipo_prestador%type, ie_oficio_p text ) AS $body$
DECLARE

						
nm_arquivo_bas_w	varchar(255);
nm_arquivo_ser_w	varchar(255);
nm_arquivo_zip_w	varchar(255);
ds_pasta_w		varchar(255) := null;
ds_ans_w		varchar(6);
ds_conteudo_w		varchar(4000);
ds_erro_w		varchar(1000);
ie_csv_w		char(1) := ';';

-- Dados básicos

-- 1 Identificação do Contrato: Número para identificação do contrato entre a operadora e o prestador de serviço na ANS. Este número é a ligação entre os arquivos com as informações dos dados básicos do contrato e os demais arquivos enviados com as informações dos serviços contratados. Numérico 6 999999 Obrigatório

-- 2 Reg ANS Código de registro na ANS da operadora contratante String 6 Obrigatório

-- 3 CNPJ contratado Número de inscrição do prestador contratado no Cadastro Nacional de Pessoas Jurídicas String 14 Obrigatório

-- 4 CNES contratado Código do prestador contratado no Cadastro Nacional de Estabelecimentos de Saúde do Ministério da Saúde String 7 Obrigatório

-- 5 Data Asssinatura Contrato Data em que o contrato foi assinado pela operadora contratante e pelo prestador contratado String 10 dd/mm/aaaa Obrigatório 

-- 6 Data Início Vigência Data em que se iniciou a vigência do contrato String 10 dd/mm/aaaa Obrigatório

-- 7 Tipo Vigência Tipo de vigência do contrato, indicando se é por prazo determinado ou por prazo indeterminado String 1 Obrigatório. Ver tabela de vigência

-- 8 Data Fim Vigência Data em que se encerrará a vigência do contrato String 10 dd/mm/aaaa Condicionado. Deve ser informado caso o contrato seja por prazo determinado.

-- 9 Renovação automática Informar se o contrato prevê renovação automática. Informar "S" para sim ou "N" para não. String 1 Obrigatório

-- 10 Rescisão imotivada Informar se há previsão contratual com penalidade para rescisão imotivada. Informar "S" para sim ou "N" para não. String 1 Obrigatório

-- 11 Valor rescisão imotivada Informar valor em reais (R$) da penalidade por Numérico 6,2 999999,99 Condicionado. Só deve ser rescisão imotivada. informado caso haja penalidade para rescisão imotivada.

-- 12 Unidade prazo rescisão Informar a unidade contratualizada para antecedência mínima para notificação da rescisão contratual String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 13 Quantidade prazo rescisão Informar a quantidade de unidades contratualizada para antecedência mínima para notificação da rescisão contratual Numérico 3 999 Obrigatório.

-- 14 Unidade prazo não renovação Informar a unidade contratualizada para antecedência mínima, pela contratante e pelo contratado, para manifestar sua intenção de não renovar o contrato String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 15 Quantidade prazo não renovação Informar a quantidade contratualizada para antecedência mínima, pela contratante e pelo contratado, para manifestar sua intenção de não renovar o contrato Numérico 3 999 Obrigatório.

-- 16 Regime de atendimento Regime de atendimento dos serviços contratados String 1 Obrigatório. Ver tabela de regime de atendimento 

-- 17 Forma contratual de reajuste Forma como é determinado o percentual de reajuste dos valores dos serviços contratados String 1 Obrigatório. Ver tabela de forma contratual de reajuste

-- 18 Utilização de indicadores ou critérios de qualidade e desempenho na composição do reajuste Informar se o contrato utiliza indicadores ou critérios de qualidade e desempenho da assistência e serviços prestados, previamente discutidos e aceitos pelas partes, na composição do reajuste. String 1 Obrigatório. Informar "S" para sim ou "N" para não.

-- 19 Data último reajuste Data do último reajuste dos valores contratuais String 10 dd/mm/aaaa Condicionado. Informar caso já tenha havido reajuste dos valores contratados

-- 20 Índice último reajuste aplicado à diárias e taxas hospitalares Percentual aplicado à diárias e taxas hospitalares no último reajuste dos valores contratuais Numérico 3,2 999,99 Condicionado. Informar caso já tenha havido reajuste dos valores contratados

-- 21 Índice último reajuste aplicado à honorários Percentual aplicado à honorários no último reajuste dos valores contratuais Numérico 3,2 999,99 Condicionado. Informar caso já tenha havido reajuste dos valores contratados

-- 22 Índice último reajuste aplicado à medicamentos Percentual aplicado à medicamentos no último reajuste dos valores contratuais Numérico 3,2 999,99 Condicionado. Informar caso já tenha havido reajuste dos valores contratados

-- 23 Índice último reajuste aplicado à materiais Percentual aplicado à materiais no último reajuste dos valores contratuais Numérico 3,2 999,99 Condicionado. Informar caso já tenha havido reajuste dos valores contratados

-- 24 Utilização do fator de qualidade no último reajuste Informar se foi utilizado o fator de qualidade previsto na RN nº 364/2014, no último reajuste. Informar "S" para sim ou "N" para não. String 1 Obrigatório

-- 25 Unidade prazo máximo faturamento Informar a unidade de tempo contratualizada para o prestador apresentar a operadora a fatura do serviço prestado String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 26 Quantidade prazo máximo faturamento Informar a quantidade contratualizada para o prestador apresentar à operadora a fatura do serviço prestado Numérico 3 999 Obrigatório.

-- 27 Unidade prazo máximo pagamento Informar a unidade de tempo contratualizada para a operadora pagar ao prestador pelos serviços apresentados String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 28 Quantidade prazo máximo pagamento Informar a quantidade contratualizada para a operadora pagar ao prestador pelos serviços apresentados Numérico 3 999 Obrigatório. 

-- 29 Unidade prazo máximo glosa Informar a unidade de tempo contratualizada para a operadora informar ao prestador a glosa pelo serviço apresentado String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 30 Quantidade prazo máximo glosa Informar a quantidade contratualizada para a operadora informar ao prestador a glosa pelo serviço apresentado Numérico 3 999 Obrigatório.

-- 31 Unidade prazo máximo contestação glosa Informar a unidade de tempo contratualizada para o prestador contestar a glosa String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 32 Quantidade prazo máximo contestação glosa Informar a quantidade contratualizada para o prestador contestar a glosa Numérico 3 999 Obrigatório. 

-- 33 Unidade prazo máximo pagto revogação glosa Informar a unidade de tempo contratualizada para a operadora efetur o pagamento após a revogação da glosa String 1 Obrigatório. Ver tabela de unidade de tempo.

-- 34 Quantidade prazo máximo pagto revogação glosa Informar a quantidade contratualizada para a operadora efetur o pagamento após a revogação da glosa Numérico 3 999 Obrigatório. 

-- 35 Correção pagamento após prazo Informar a forma de correção de pagamentos realizados após o prazo máximo previstos no contrato String 1 Obrigatório. Ver a tabela de forma contratual de reajuste

-- 36 Penalidade inadimplemento Informar se há previsão contratual com penalidadepara inadimplemento da operadora. Informar "S" para sim ou "N" para não. String 1 Obrigatório.

-- 37 Valor penalidade inadimplemento Informar o valor da penalidade em reais (R$) para inadimplemento da operadora. Numérico 6,2 999999,99 Condicionado. Informar somente se há cláusula contratual de penalidade para inadimplemento da operadora. Mesmo que não haja valor a ser informado o campo sempre deverá ser delimitado por ponto e virgula.

-- 38 Tabela de Referência para material Informar o código da tabela utilizada como referência para contratação de material String 1 Condicionado. Informar caso a operadora tenha acordado com o prestador uma tabela do mercado como referência de preço de materiais utilizados no atendimento hospitalar Ver tabelas de referência. Mesmo que não haja valor a ser informado o campo sempre deverá ser delimitado por ponto e virgula.

-- 39 Tabela de referência para medicamento Informar o código da tabela utilizada como referência para contratação de medicamento String 1 Condicionado. Informar caso a operadora tenha acordado com o prestador uma tabela do mercado como referência de preço de medicamentos utilizados no atendimento hospitalar. Ver tabelas de referência. Mesmo que não haja valor a ser informado o campo sempre deverá ser delimitado por ponto e virgula.

-- 40 Tabela de referência para procedimentos Informar o código da tabela utilizada como referência para contratação de procedimentos médicos String 1 Condicionado. Informar caso a operadora tenha acordado com o prestador uma tabela do mercado como referência de preço de procedimentos médicos utilizados no atendimento hospitalar. Mesmo que não haja valor a ser informado o campo sempre deverá ser delimitado por ponto e vírgula. Ver tabelas de referência.

-- 41 Quantidade de aditivos ao contrato Quantidade de termos aditivos ao contrato Numérico 6 999999 Obrigatório. Informar zero caso não tenha havido nenhum aditivo ao contrato.

-- 42 Data de assinatura do último aditivo Data em que foi assinado o último termo aditivo ao contrato String 10 dd/mm/aaaa Condicionado. Deve ser informado se houver aditivo assinado. Mesmo que não haja valor a ser informado o campo sempre deverá ser delimitado por ponto e vírgula.
c01 CURSOR(	cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
		nr_seq_tipo_prestador_pc	pls_prestador.nr_seq_tipo_prestador%type,
		ds_ans_pc			text ) FOR
        SELECT	lpad(p.nr_sequencia,6,'0') nr_seq_prestador, --1
		ds_ans_pc ds_ans, -- 2
		rpad(p.cd_cgc,14,' ') cd_cgc, -- 3
		rpad(coalesce(substr(pls_obter_cnes_prestador(p.nr_sequencia),1,7),' '),7,' ') cd_cnes, -- 4
		coalesce(to_char(p.dt_inicio_contrato,'dd/mm/yyyy'),lpad(' ',10,' ')) dt_inicio_contrato, -- 5 
		coalesce(to_char(p.dt_inicio_servico,'dd/mm/yyyy'),lpad(' ',10,' ')) dt_inicio_servico, -- 6
		'2' ie_tipo_vigencia, -- 7
		coalesce(to_char(p.dt_exclusao,'dd/mm/yyyy'),lpad(' ',10,' ')) dt_exclusao, -- 8
		'S' ie_renovacao, -- 9
		'N' ie_rescisao, -- 10
		lpad(campo_mascara_virgula(0),9,'0') vl_rescisao, -- 11
		'4' ie_unidade_prazo_rescisao, -- 12
		lpad('0',3,'0') qt_prazo_rescisao, -- 13
		'4' ie_unidade_prazo_nao_renova, -- 14
		lpad('0',3,'0') qt_prazo_nao_renova, -- 15
		'2' ie_regime_atendimento, -- 16
		'4' ds_forma_reajuste, -- 17
		'N' ie_qualidade_reajuste, -- 18
		lpad(q.dt_ultimo_reajuste, 10, ' ') dt_ultimo_reajuste, -- 19
		lpad(q.pc_ult_reaj_diarias_taxa, 6, '0') cd_ultimo_reajuste_hosp, -- 20
		lpad(q.pc_ult_reaj_honorario, 6, '0') cd_ultimo_reajuste_honor, -- 21
		lpad(q.pc_ult_reaj_medicamentos, 6, '0') cd_ultimo_reajuste_med, -- 22
		lpad(q.pc_ult_reaj_materiais, 6, '0') cd_ultimo_reajuste_mat, -- 23
		'N' ie_ultimo_reajuste_fq, -- 24
		'4' ie_unidade_prazo_fat, -- 25
		lpad('0',3,'0') qt_prazo_fat, -- 26
		'4' ie_unidade_prazo_max_pag, -- 27
		lpad('0',3,'0') qt_prazo_max_pag, -- 28
		'4' ie_unidade_prazo_max_glosa, -- 29
		lpad('0',3,'0') qt_prazo_max_glosa, -- 30
		'4' ie_unidade_prazo_max_contest, -- 31
		lpad('0',3,'0') qt_prazo_max_contest, -- 32
		'4' ie_unidade_prazo_max_pag_rev, -- 33
		lpad('0',3,'0') qt_prazo_max_pag_rev, -- 34
		'4' ie_correcao_pag_apos_prazo, -- 35
		'N' ie_penalidade_inadimplemento, -- 36
		lpad(campo_mascara_virgula(0),9,'0') vl_penalidade_inadimplemento, -- 37
		' ' ie_tab_ref_mat, -- 38
		' ' ie_tab_ref_med, -- 39
		' ' ie_tab_ref_proc, -- 40
		lpad('0',6,'0') qt_aditivos, -- 41
		lpad(' ',10,' ') dt_assinatura_aditivo, -- 42
		-- Layout do Oficio-Circular nº: 6/2019/GASNT/DIRAD-DIDES/DIDES
		coalesce(q.cd_tipo_vigencia, '2') ie_tipo_vigencia_o6,							-- 7
		coalesce(q.ie_renovacao_automatica, 'S') ie_renovacao_o6,							-- 9
		coalesce(q.cd_rescisao_motivada, '4') cd_rescisao_motivada_o6,						-- 10
		coalesce(q.ie_qualif_composicao_reajuste, 'N') ie_qualidade_reajuste_o6,					-- 14
		lpad(to_date(q.dt_ultimo_reajuste, 'dd/mm/yyyy'), 10, ' ') dt_ultimo_reajuste_o6,			-- 15
		q.cd_reajuste_diarias_taxa cd_ultimo_reajuste_hosp_o6,							-- 16
		q.cd_reajuste_honorario cd_ultimo_reajuste_honor_o6,							-- 17
		q.cd_reajuste_medicamentos cd_ultimo_reajuste_med_o6,							-- 18
		q.cd_reajuste_materiais cd_ultimo_reajuste_mat_o6,							-- 19
		coalesce(q.cd_uni_med_prazo_fat, '4') ie_unidade_prazo_fat_o6,						-- 21
		lpad(qt_prazo_faturamento, 3, '0') qt_prazo_fat_o6,							-- 22
		coalesce(q.cd_uni_med_prazo_pagto, '4') ie_unidade_prazo_max_pag_o6,						-- 23
		lpad(q.qt_prazo_pagto, 3, '0') qt_prazo_max_pag_o6,							-- 24
		coalesce(q.cd_uni_med_prazo_glosa, '4') ie_unidade_prazo_max_glosa_o6,					-- 25
		lpad(q.qt_prazo_glosa, 3, '0') qt_prazo_max_glosa_o6,							-- 26
		coalesce(q.cd_uni_med_contest_glosa, '4') ie_unidade_prazo_max_conte_o6,					-- 27
		lpad(q.qt_contestacao_glosa, 3, '0') qt_prazo_max_contest_o6,						-- 28
		coalesce(q.cd_uni_med_prz_resp_glosa, '4') cd_uni_med_prz_resp_glosa_o6,					-- 29
		lpad(q.qt_prazo_resp_glosa, 3, '0') qt_prazo_resp_glosa_o6,						-- 30
		coalesce(q.cd_uni_med_revog_glosa, '4') ie_unid_prazo_max_pag_rev_o6,					-- 31
		lpad(q.qt_revogacao_glosa, 3, '0') qt_prazo_max_pag_rev_o6,						-- 32
		coalesce(q.ie_penalidade_inadimplento, 'N') ie_penalidade_inadimplem_o6					-- 34
	FROM pls_prestador p
LEFT OUTER JOIN pls_prestador_info_adic q ON (p.nr_sequencia = q.nr_seq_prestador)
WHERE p.cd_estabelecimento   		= cd_estabelecimento_pc and p.ie_situacao			= 'A' and (p.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '') and (p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '') order by nr_seq_prestador;
	
-- Serviços contratados

-- 1 Identificação do Contrato Número para identificação do contrato entre a operadora e o prestador de serviço na ANS. Este número é a ligação entre os arquivos com as informações dos dados básicos do contrato e o arquivo com as informações dos serviços contratados. Numérico 6 999999 Obrigatório

-- 2 Reg ANS Código de registro na ANS da operadora contratante String 6 Obrigatório

-- 3 CNPJ contratato Número de inscrição do prestador contratado no Cadastro Nacional de Pessoas Jurídicas String 14 Obrigatório

-- 4 CNES contratado Código do prestador contratado no Cadastro Nacional de Estabelecimentos de Saúde do Ministério da Saúde String 7 Obrigatório

-- 5 Código Serviço Código do serviço contratado na Tabela de Terminologia Unificada da Saúde Suplementar String 10 Obrigatório. Conforme as tabelas 18 e 22 da TUSS

-- 6 Autorização prévia Indicar se o serviço necessita de autorização prévia. String 1 Obrigatório. Ver tabela de autorização prévia.

-- 7 Código do pacote Informar o código do pacote a que o código do serviço está associado. String 10 Condicionado. Deve ser informado caso o código do serviço esteja dentro de um pacote contratado.
C02 CURSOR(	cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
		nr_seq_tipo_prestador_pc	pls_prestador.nr_seq_tipo_prestador%type,
		ds_ans_pc			text ) FOR
	-- 1 PROCEDIMENTO
        SELECT  s.nr_sequencia nr_seq_regra,
		lpad(p.nr_sequencia,6,'0') nr_seq_prestador, --1
		ds_ans_pc ds_ans, -- 2
		p.cd_cgc, -- 3
		rpad(coalesce(substr(pls_obter_cnes_prestador(p.nr_sequencia),1,7),' '),7,' ') cd_cnes, -- 4
		rpad(i.cd_procedimento,10,' ') cd_servico, -- 5
		CASE WHEN s.ie_liberar='S' THEN '2'  ELSE '1' END  ie_autorizacao_previa, -- 6
		lpad(' ',10,' ') cd_pacote  -- 7
        from    pls_prestador 			p,
		pls_prestador_proc		s,
		estrutura_procedimento_v	i
        where   p.nr_sequencia			= s.nr_seq_prestador
	and	s.cd_procedimento		= i.cd_procedimento
	and	s.ie_origem_proced		= i.ie_origem_proced
	and	p.cd_estabelecimento   		= cd_estabelecimento_pc
	and	p.ie_situacao			= 'A'
	and	i.ie_origem_proced		= '8' -- TUSS
	and (p.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '')
	and	(s.cd_procedimento IS NOT NULL AND s.cd_procedimento::text <> '')
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '')
	and	clock_timestamp() between trunc(coalesce(s.dt_inicio_vigencia,clock_timestamp())) and fim_dia(coalesce(s.dt_fim_vigencia,clock_timestamp()))
	
union all

	-- 2 GRUPO PROCEDIMENTO
        SELECT  s.nr_sequencia nr_seq_regra,
		lpad(p.nr_sequencia,6,'0') nr_seq_prestador, --1
		ds_ans_pc ds_ans, -- 2
		p.cd_cgc, -- 3
		rpad(coalesce(substr(pls_obter_cnes_prestador(p.nr_sequencia),1,7),' '),7,' ') cd_cnes, -- 4
		rpad(i.cd_procedimento,10,' ') cd_servico, -- 5
		CASE WHEN s.ie_liberar='S' THEN '2'  ELSE '1' END  ie_autorizacao_previa, -- 6
		lpad(' ',10,' ') cd_pacote  -- 7
        from    pls_prestador 			p,
		pls_prestador_proc		s,
		estrutura_procedimento_v	i
        where   p.nr_sequencia			= s.nr_seq_prestador
	and	s.cd_grupo_proc			= i.cd_grupo_proc
	and	p.cd_estabelecimento    	= cd_estabelecimento_pc
	and	p.ie_situacao			= 'A'
	and	i.ie_origem_proced		= '8' -- TUSS
	and (p.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '')
	and	coalesce(s.cd_procedimento::text, '') = ''
	and	(s.cd_grupo_proc IS NOT NULL AND s.cd_grupo_proc::text <> '')
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '')
	and	clock_timestamp() between trunc(coalesce(s.dt_inicio_vigencia,clock_timestamp())) and fim_dia(coalesce(s.dt_fim_vigencia,clock_timestamp()))
	
union all

	-- 3 ESPECIALIDADE PROCEDIMENTO
        select  s.nr_sequencia nr_seq_regra,
		lpad(p.nr_sequencia,6,'0') nr_seq_prestador, --1
		ds_ans_pc ds_ans, -- 2
		p.cd_cgc, -- 3
		rpad(coalesce(substr(pls_obter_cnes_prestador(p.nr_sequencia),1,7),' '),7,' ') cd_cnes, -- 4
		rpad(i.cd_procedimento,10,' ') cd_servico, -- 5
		CASE WHEN s.ie_liberar='S' THEN '2'  ELSE '1' END  ie_autorizacao_previa, -- 6
		lpad(' ',10,' ') cd_pacote  -- 7
        from    pls_prestador 			p,
		pls_prestador_proc		s,
		estrutura_procedimento_v	i
        where   p.nr_sequencia			= s.nr_seq_prestador
	and	s.cd_especialidade_proc		= i.cd_especialidade
	and	p.cd_estabelecimento    	= cd_estabelecimento_pc
	and	p.ie_situacao			= 'A'
	and	i.ie_origem_proced		= '8' -- TUSS
	and (p.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '')
	and	coalesce(s.cd_procedimento::text, '') = ''
	and	coalesce(s.cd_grupo_proc::text, '') = ''
	and	(s.cd_especialidade_proc IS NOT NULL AND s.cd_especialidade_proc::text <> '')
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '')
	and	clock_timestamp() between trunc(coalesce(s.dt_inicio_vigencia,clock_timestamp())) and fim_dia(coalesce(s.dt_fim_vigencia,clock_timestamp()))
	
union all

	-- 4 AREA PROCEDIMENTO
        select  s.nr_sequencia nr_seq_regra,
		lpad(p.nr_sequencia,6,'0') nr_seq_prestador, --1
		ds_ans_pc ds_ans, -- 2
		p.cd_cgc, -- 3
		rpad(coalesce(substr(pls_obter_cnes_prestador(p.nr_sequencia),1,7),' '),7,' ') cd_cnes, -- 4
		rpad(i.cd_procedimento,10,' ') cd_servico, -- 5
		CASE WHEN s.ie_liberar='S' THEN '2'  ELSE '1' END  ie_autorizacao_previa, -- 6
		lpad(' ',10,' ') cd_pacote  -- 7
        from    pls_prestador 			p,
		pls_prestador_proc		s,
		estrutura_procedimento_v	i
        where   p.nr_sequencia			= s.nr_seq_prestador
	and	s.cd_area_procedimento		= i.cd_area_procedimento
	and	p.cd_estabelecimento   		= cd_estabelecimento_pc
	and	p.ie_situacao			= 'A'
	and	i.ie_origem_proced		= '8' -- TUSS
	and (p.nr_seq_tipo_prestador	= nr_seq_tipo_prestador_pc or coalesce(nr_seq_tipo_prestador_pc::text, '') = '')
	and	coalesce(s.cd_procedimento::text, '') = ''
	and	coalesce(s.cd_grupo_proc::text, '') = ''
	and	coalesce(s.cd_especialidade_proc::text, '') = ''
	and	(s.cd_area_procedimento IS NOT NULL AND s.cd_area_procedimento::text <> '')
	and	(p.cd_cgc IS NOT NULL AND p.cd_cgc::text <> '')
	and	clock_timestamp() between trunc(coalesce(s.dt_inicio_vigencia,clock_timestamp())) and fim_dia(coalesce(s.dt_fim_vigencia,clock_timestamp()))
	order by nr_seq_prestador;

BEGIN

select  lpad(coalesce(cd_ans,'0'),6,'0') ds_regans
into STRICT	ds_ans_w
from    pls_outorgante
where   cd_estabelecimento = cd_estabelecimento_p;

-- NOMENCLATURA DOS ARQUIVOS

-- REGANS= número de registro da operadora na ANS com seis posições (informar zeros a esquerda quando for o caso);

-- Bloco 1: REGANSBASICOHOSP99.CSV

-- Bloco 2: REGANSSERVICOSHOSP99.CSV

-- 99 é a numeração sequencial do arquivo com duas posições

-- Deverá ser feita uma validação posterior para controlar os dados enviados e adicionar dados complementares gerados em novos arquivos
nm_arquivo_bas_w := ds_ans_w || 'BASICOHOSP01.CSV';
nm_arquivo_ser_w := ds_ans_w || 'SERVICOHOSP01.CSV';

-- Gerar arquivo UTL (Básico)
ds_pasta_w := pls_utl_file_pck.novo_arquivo( 14, nm_arquivo_bas_w, 'S', 4000, ds_pasta_w, 'U');

nm_arquivo_bas_w := ds_pasta_w || nm_arquivo_bas_w;

for r_C01_w in C01(cd_estabelecimento_p, nr_seq_tipo_prestador_p, ds_ans_w) loop

	-- Layout do "Oficio-Circular nº: 1/2019/GASNT/DIRAD-DIDES/DIDES"
	if (ie_oficio_p = '1') then
		ds_conteudo_w :=        r_C01_w.nr_seq_prestador			|| ie_csv_w ||	-- 1
					r_C01_w.ds_ans					|| ie_csv_w ||	-- 2
					r_C01_w.cd_cgc					|| ie_csv_w ||	-- 3
					r_C01_w.cd_cnes					|| ie_csv_w ||	-- 4
					r_C01_w.dt_inicio_contrato			|| ie_csv_w ||	-- 5
					r_C01_w.dt_inicio_servico			|| ie_csv_w ||	-- 6
					r_C01_w.ie_tipo_vigencia			|| ie_csv_w ||	-- 7
					r_C01_w.dt_exclusao				|| ie_csv_w ||	-- 8
					r_C01_w.ie_renovacao				|| ie_csv_w ||	-- 9
					r_C01_w.ie_rescisao				|| ie_csv_w ||	-- 10
					r_C01_w.vl_rescisao 				|| ie_csv_w ||	-- 11
					r_C01_w.ie_unidade_prazo_rescisao 		|| ie_csv_w ||	-- 12
					r_C01_w.qt_prazo_rescisao			|| ie_csv_w ||	-- 13
					r_C01_w.ie_unidade_prazo_nao_renova		|| ie_csv_w ||	-- 14
					r_C01_w.qt_prazo_nao_renova			|| ie_csv_w ||	-- 15
					r_C01_w.ie_regime_atendimento			|| ie_csv_w ||	-- 16
					r_C01_w.ds_forma_reajuste			|| ie_csv_w ||	-- 17
					r_C01_w.ie_qualidade_reajuste			|| ie_csv_w ||	-- 18
					r_C01_w.dt_ultimo_reajuste			|| ie_csv_w ||	-- 19
					r_C01_w.cd_ultimo_reajuste_hosp			|| ie_csv_w ||	-- 20
					r_C01_w.cd_ultimo_reajuste_honor		|| ie_csv_w ||	-- 21
					r_C01_w.cd_ultimo_reajuste_med			|| ie_csv_w ||	-- 22
					r_C01_w.cd_ultimo_reajuste_mat			|| ie_csv_w ||	-- 23
					r_C01_w.ie_ultimo_reajuste_fq			|| ie_csv_w ||	-- 24
					r_C01_w.ie_unidade_prazo_fat			|| ie_csv_w ||	-- 25
					r_C01_w.qt_prazo_fat				|| ie_csv_w ||	-- 26
					r_C01_w.ie_unidade_prazo_max_pag		|| ie_csv_w ||	-- 27
					r_C01_w.qt_prazo_max_pag			|| ie_csv_w ||	-- 28
					r_C01_w.ie_unidade_prazo_max_glosa		|| ie_csv_w ||	-- 29
					r_C01_w.qt_prazo_max_glosa			|| ie_csv_w ||	-- 30
					r_C01_w.ie_unidade_prazo_max_contest		|| ie_csv_w ||	-- 31
					r_C01_w.qt_prazo_max_contest			|| ie_csv_w ||	-- 32
					r_C01_w.ie_unidade_prazo_max_pag_rev		|| ie_csv_w ||	-- 33
					r_C01_w.qt_prazo_max_pag_rev			|| ie_csv_w ||	-- 34
					r_C01_w.ie_correcao_pag_apos_prazo		|| ie_csv_w ||	-- 35
					r_C01_w.ie_penalidade_inadimplemento		|| ie_csv_w ||	-- 36
					r_C01_w.vl_penalidade_inadimplemento		|| ie_csv_w ||	-- 37
					r_C01_w.ie_tab_ref_mat				|| ie_csv_w ||	-- 38
					r_C01_w.ie_tab_ref_med				|| ie_csv_w ||	-- 39
					r_C01_w.ie_tab_ref_proc				|| ie_csv_w ||	-- 40
					r_C01_w.qt_aditivos				|| ie_csv_w ||	-- 41
					r_C01_w.dt_assinatura_aditivo;					-- 42
					
	-- Layout do Oficio-Circular nº: 6/2019/GASNT/DIRAD-DIDES/DIDES
	elsif (ie_oficio_p = '6') then		
		ds_conteudo_w :=	r_C01_w.nr_seq_prestador			|| ie_csv_w ||	-- 1
					r_C01_w.ds_ans					|| ie_csv_w ||	-- 2
					r_C01_w.cd_cgc					|| ie_csv_w ||	-- 3
					r_C01_w.cd_cnes					|| ie_csv_w ||	-- 4
					r_C01_w.dt_inicio_contrato			|| ie_csv_w ||	-- 5
					r_C01_w.dt_inicio_servico			|| ie_csv_w ||	-- 6
					r_C01_w.ie_tipo_vigencia_o6			|| ie_csv_w ||	-- 7
					r_C01_w.dt_exclusao				|| ie_csv_w ||	-- 8
					r_C01_w.ie_renovacao_o6				|| ie_csv_w ||	-- 9
					r_C01_w.cd_rescisao_motivada_o6			|| ie_csv_w ||	-- 10
					r_C01_w.ie_unidade_prazo_rescisao 		|| ie_csv_w ||	-- 11
					r_C01_w.ie_unidade_prazo_nao_renova		|| ie_csv_w ||	-- 12
					r_C01_w.ie_regime_atendimento			|| ie_csv_w ||	-- 13
					r_C01_w.ie_qualidade_reajuste_o6		|| ie_csv_w ||	-- 14
					r_C01_w.dt_ultimo_reajuste_o6			|| ie_csv_w ||	-- 15
					r_C01_w.cd_ultimo_reajuste_hosp_o6		|| ie_csv_w ||	-- 16
					r_C01_w.cd_ultimo_reajuste_honor_o6		|| ie_csv_w ||	-- 17
					r_C01_w.cd_ultimo_reajuste_med_o6		|| ie_csv_w ||	-- 18
					r_C01_w.cd_ultimo_reajuste_mat_o6		|| ie_csv_w ||	-- 19
					r_C01_w.ie_ultimo_reajuste_fq			|| ie_csv_w ||	-- 20
					r_C01_w.ie_unidade_prazo_fat_o6			|| ie_csv_w ||	-- 21
					r_C01_w.qt_prazo_fat_o6				|| ie_csv_w ||	-- 22
					r_C01_w.ie_unidade_prazo_max_pag_o6		|| ie_csv_w ||	-- 23
					r_C01_w.qt_prazo_max_pag_o6			|| ie_csv_w ||	-- 24
					r_C01_w.ie_unidade_prazo_max_glosa_o6		|| ie_csv_w ||	-- 25
					r_C01_w.qt_prazo_max_glosa_o6			|| ie_csv_w ||	-- 26
					r_C01_w.ie_unidade_prazo_max_conte_o6		|| ie_csv_w ||	-- 27
					r_C01_w.qt_prazo_max_contest_o6			|| ie_csv_w ||	-- 28
					r_C01_w.cd_uni_med_prz_resp_glosa_o6		|| ie_csv_w ||	-- 29
					r_C01_w.qt_prazo_resp_glosa_o6			|| ie_csv_w ||	-- 30
					r_C01_w.ie_unid_prazo_max_pag_rev_o6		|| ie_csv_w ||	-- 31
					r_C01_w.qt_prazo_max_pag_rev_o6			|| ie_csv_w ||	-- 32
					r_C01_w.ie_correcao_pag_apos_prazo		|| ie_csv_w ||	-- 33
					r_C01_w.ie_penalidade_inadimplem_o6		|| ie_csv_w ||	-- 34
					r_C01_w.ie_tab_ref_mat				|| ie_csv_w ||	-- 35
					r_C01_w.ie_tab_ref_med				|| ie_csv_w ||	-- 36
					r_C01_w.ie_tab_ref_proc				|| ie_csv_w ||	-- 37
					r_C01_w.dt_assinatura_aditivo;					-- 38
	end if;
	
	CALL pls_utl_file_pck.escrever(ds_conteudo_w);
end loop;
CALL pls_utl_file_pck.fechar_arquivo();

-- Gerado somente para o "Oficio-Circular nº: 1/2019/GASNT/DIRAD-DIDES/DIDES"
if (ie_oficio_p = '1') then
	ds_pasta_w := pls_utl_file_pck.novo_arquivo( 14, nm_arquivo_ser_w, 'S', 4000, ds_pasta_w, 'U');
	
	nm_arquivo_ser_w := ds_pasta_w || nm_arquivo_ser_w;
	
	for r_C02_w in C02(cd_estabelecimento_p, nr_seq_tipo_prestador_p, ds_ans_w) loop
		ds_conteudo_w :=        r_C02_w.nr_seq_prestador	|| ie_csv_w ||
					r_C02_w.ds_ans			|| ie_csv_w ||
					r_C02_w.cd_cgc			|| ie_csv_w ||
					r_C02_w.cd_cnes			|| ie_csv_w ||
					r_C02_w.cd_servico		|| ie_csv_w ||
					r_C02_w.ie_autorizacao_previa	|| ie_csv_w ||
					r_C02_w.cd_pacote;
		CALL pls_utl_file_pck.escrever(ds_conteudo_w);
	end loop;
end if;

CALL pls_utl_file_pck.fechar_arquivo();

-- Gerar arquivo zipado

--Os arquivos deverão ser enviados utilizando o PTA (Programa Transmissor de Arquivos da ANS) de forma compactada, no padrão ZIP, contendo em um

--único arquivo compactado todos os arquivos gerados pela operadora. Este arquivo compactado terá a seguinte nomenclatura:

--REGANSCONTRATOSHOSP99.ZCP, onde:

--REGANS= número de registro da operadora na ANS com seis posições (informar zeros a esquerda quando for o caso);

--CONTRATOSHOSP= string fixa com a palavra CONTRATOSHOSP;

--99 = numeração sequencial do arquivo com duas posições. Caso a operadora tenha que complementar a informação em um novo arquivo. 


-- ESSA FORMA DE COMPACTAR O ARQUIVO SÓ FUNCIONA NO ORACLE 12G 

/*nm_arquivo_zip_w := ds_pasta_w || ds_ans_w || 'CONTRATOSHOSP01.ZCP';
ds_erro_w := pls_utl_zip_pck.compactar_arquivos(nm_arquivo_zip_w, nm_arquivo_bas_w||';'||nm_arquivo_ser_w, 'S');

if	(ds_erro_w is not null) then
	wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arq_dados_prest_ans ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_tipo_prestador_p pls_prestador.nr_seq_tipo_prestador%type, ie_oficio_p text ) FROM PUBLIC;

