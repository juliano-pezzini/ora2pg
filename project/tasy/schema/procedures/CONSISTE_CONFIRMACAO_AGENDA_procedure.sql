-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_confirmacao_agenda ( nr_seq_agenda_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w		varchar(255) := null;
dt_inicio_vigencia_w	varchar(30);
dt_fim_vigencia_w	varchar(30);
cd_perfil_w		integer;
nm_usuario_w		varchar(15);
cd_estabelecimento_w	integer;
ie_consiste_vig_w	varchar(1);
dt_agenda_w		timestamp;


BEGIN
cd_perfil_w		:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w		:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

select	max(hr_inicio)
into STRICT	dt_agenda_w
from	agenda_paciente
where 	nr_sequencia = nr_seq_agenda_p;

ie_consiste_vig_w := Obter_Param_Usuario(871, 802, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_consiste_vig_w);

if (ie_consiste_vig_w = 'S') and (coalesce(ds_erro_w::text, '') = '') then
	dt_inicio_vigencia_w	:=	obter_dados_autor_agenda(nr_seq_agenda_p,null,'IV');
	dt_fim_vigencia_w	:=	obter_dados_autor_agenda(nr_seq_agenda_p,null,'FV');
	if	((dt_inicio_vigencia_w IS NOT NULL AND dt_inicio_vigencia_w::text <> '') and (dt_agenda_w < to_date(dt_inicio_vigencia_w,'dd/mm/yyyy hh24:mi:ss'))) or
		((dt_fim_vigencia_w IS NOT NULL AND dt_fim_vigencia_w::text <> '') and (dt_agenda_w > to_date(dt_fim_vigencia_w,'dd/mm/yyyy hh24:mi:ss'))) then
		ds_erro_w := substr(obter_texto_dic_objeto(276066,wheb_usuario_pck.get_nr_seq_idioma,null),1,255);
	end if;
end if;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_confirmacao_agenda ( nr_seq_agenda_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

