-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_w_guia_solic_spsadt (ds_dir_padrao_p text, nr_atend_conta_tiss_p text, nm_usuario_p text, nr_atendimento_p text) AS $body$
DECLARE


cd_ans_w			varchar(255);
ie_urgencia_w			varchar(255);
ie_obs_urgente_w			varchar(100);
cd_cbos_w			varchar(100);
nr_atendimento_w		 	 bigint;
cd_autorizacao_w			varchar(100);
cd_autorizacao_ww			varchar(255);
ie_emitir_spsadt_zerado_w 		varchar(020);
ie_spsadt_zerado_w		varchar(020);
cd_procedimento_w		varchar(255);
cd_proc_solic_w			varchar(020);
ie_funcao_w			varchar(020);
qt_proc_guia_w			  smallint;
nr_atend_w			  bigint;
cd_senha_w			varchar(255);
dt_inicio_vigencia_w			timestamp;
dt_final_vigencia_w				timestamp;
dt_validade_senha_w			timestamp;
dt_emissao_guia_w				timestamp;
nr_seq_guia_w			 bigint;
nr_seq_agenda_w			 bigint;
nr_cpf_w				varchar(015);
ie_cid_exame_externo_w		varchar(015);
ds_cid_w				varchar(255);
cd_cgc_estab_w			varchar(255);
nm_medico_executor_w		varchar(255);
nm_medico_solic_w			varchar(255);
ds_obs_autor_w			varchar(4000);
sg_conselho_w			varchar(015);
nr_crm_w			varchar(020);
uf_crm_w			varchar(255);
cd_cbo_saude_w			varchar(020);
ie_tipo_atendimento_w		varchar(255);
ie_tipo_saida_w			varchar(020);
ds_inicacao_clinica_w		varchar(2000);
ds_justificativa_w			varchar(4000);
cd_edicao_amb_w			varchar(20);
IE_DESC_PROC_INTERNO_W	varchar(20);
cd_edicao_amb_solic_w		varchar(20);
cd_medico_executor_w		varchar(20);
ds_proced_convenio_w		varchar(255);
ie_tecnica_utilizada_w		varchar(20);
IE_EMITE_HONOR_SADT_PEP_w 	varchar(20);
ie_medico_rep_w			varchar(20);
ie_origem_proced_w		bigint;
qt_procedimento_w		double precision;
vl_reducao_acrescimo_w		double precision;
cd_categoria_conv_w		varchar(20);
vl_procedimento_w			double precision;
VL_TAXAS_w			double precision;
VL_DIARIAS_w			double precision;
VL_MEDICAMENTOS_w		double precision;
VL_MATERIAIS_w			double precision;
VL_GASES_w			double precision;
vl_proc_total_w			double precision;
nr_seq_procedimento_w		bigint;
dt_entrada_w			timestamp;
dt_alta_w		 		timestamp;
ie_via_acesso_w			varchar(20);
vl_unitario_w			double precision;
ds_procedimento_w		varchar(255);
ds_proc_tabela_interno_w		varchar(255);
ds_proc_exame_proc_w		varchar(255);
ds_proc_procedimento_w		varchar(255);
ds_proced_solic_w			varchar(255);
dt_procedimento_w		timestamp;
vl_total_w			double precision	:= 0;
cont_w				integer	:= 0;
ds_razao_social_w			varchar(255);
cd_cnes_w			varchar(255);
cd_cgc_w				varchar(255);
ie_trazer_executor_w		varchar(10);
qt_solicitada_w			double precision;
qt_autorizada_w			double precision;
dt_autorizacao_w			timestamp;
cd_doenca_cid_w			varchar(255);
cd_doenca_cid_autor_w		varchar(255);
cd_cid_externo_w			varchar(255);
ds_observacao_w			varchar(2000);
ds_observacao_autor_w		varchar(255);
ie_tipo_autorizacao_w		varchar(3);
nr_seq_guia_proc_w		bigint;
ds_arquivo_logo_w			varchar(140);
nr_seq_exame_w			bigint;
cd_medico_w			varchar(255);
dt_solicitacao_w			varchar(20);
cd_opm_w			varchar(20);
vl_opm_w			double precision;
vl_opms_w			double precision;
vl_total_opm_w			double precision;
cd_edicao_w			varchar(20);
ds_opm_w			varchar(255);
ds_fabricante_w			varchar(255);
ds_carater_internacao_w		varchar(1);
ie_proc_solic_spsadt_w		varchar(3);
ie_tiss_tipo_guia_w			varchar(50);
cd_setor_atendimento_w		integer;
ie_carater_inter_sus_w		varchar(2);
cd_convenio_w			integer;
cd_medico_convenio_w		varchar(20);
nr_seq_med_fatur_w		bigint;
nr_seq_autor_W			bigint;
nr_seq_apresent_W		bigint;
dt_inicio_cirurgia_w		timestamp;
dt_fim_cirurgia_w			timestamp;
cd_estabelecimento_w		smallint;
cd_interno_w			varchar(20);
nm_contratado_solic_w		varchar(255);
cd_interno_solic_w			varchar(255);
ie_medico_solic_atend_w		varchar(2);
nr_seq_apresentacao_w		bigint;
qt_opm_w			bigint;
nr_seq_apres_proc_w		bigint;
nr_seq_apresent_opm_w		bigint;
nr_seq_conta_guia_w		bigint;
dt_atendimento_w			timestamp;
cd_autorizacao_princ_exame_w	varchar(255);
cd_autorizacao_princ_w		varchar(255);
cd_cgc_prestador_w		varchar(255);
ie_agrupar_proc_w			varchar(40);
cd_prestador_convenio_w		varchar(255)	:= '';
dt_ult_atualizacao_w		timestamp;
dt_geracao_tiss_w			timestamp;
ie_status_acerto_w			integer;
ie_honorario_w			varchar(30)	:= '';
ds_assinatura_solic_w		varchar(255);
ds_assinatura_resp_w		varchar(255);
ds_assinatura_exec_w		varchar(255);
ie_assinatura_solic_w		varchar(2);
ie_ordenacao_spsadt_w		varchar(3);
nr_seq_proc_interno_w		bigint;
nr_seq_proc_prescr_w		bigint;
CD_AREA_PROCEDIMENTO_w	bigint;
CD_ESPECIALIDADE_w		bigint;
CD_GRUPO_PROC_w		bigint;
IE_REGRA_W			varchar(100);
ie_lado_w			varchar(255);
ie_lado_rep_w			varchar(5);
cd_tipo_Proc_w			smallint;
ie_quebra_proc_pep_w		varchar(1);
ie_prescr_unica_w			varchar(255);
ie_data_ass_prest_w		varchar(255);
dt_assin_prest_w			timestamp;
ie_solicitante_w			varchar(255);
ie_solicitante_ww			varchar(255);
ie_conveniado_w			varchar(255);
cd_medico_solic_w			varchar(255);
ie_clinica_w			varchar(255);		
cd_procedencia_w			varchar(255);
cd_cgc_prest_solic_regra_w		varchar(255);
cd_medico_atendimento_w		varchar(255);
cd_setor_entrada_w		bigint;
cd_cnes_solic_w			varchar(255);
cd_cgc_solic_w			varchar(255);
ds_arquivo_logo_comp_w		varchar(255);
nr_cpf_solic_w			varchar(255);
cd_cgc_solic_regra_w		varchar(20);
ie_gerar_tiss_w			varchar(10);
ie_tipo_atend_tiss_w		varchar(10);
ie_regra_guia_princ_w		varchar(255);
cd_autor_princ_w		varchar(255);
cd_autor_princ_prescr_w		varchar(255);
nr_seq_classif_atend_w		bigint;
cd_setor_prescr_w		integer;
cd_proc_conversao_exame_w	varchar(255);
ds_proc_conversao_exame_w	varchar(255);
ie_proc_tuss_w			varchar(255);
cd_proc_tuss_w			bigint;
ds_proc_tuss_w			varchar(255);
nr_seq_pedido_exame_prescr_w		bigint;
dt_validade_carteira_w		timestamp;
cd_pessoa_fisica_W		varchar(10);
nm_pessoa_fisica_W		varchar(255);
nr_cartao_nac_sus_W		varchar(20);
ds_plano_w			varchar(255);
cd_usuario_convenio_w		varchar(255);
qt_seq_exame_w			bigint;
qt_seq_pedido_exame_w		bigint;
nr_seq_exame_param_w		bigint;
nr_seq_pedido_exame_w		bigint;
nr_seq_tiss_tabela_w		bigint;
vl_item_w			double precision;	
vl_total_procedimentos_w	double precision;
vl_total_geral_w		double precision;
ie_desc_exame_ext_w		varchar(255);
ds_irrelevante_w		varchar(255);
ds_exame_w			varchar(255);
ie_prest_spsadt_tasymed_w	varchar(255);
ie_topo_rep_w			varchar(255);
ds_topogradia_w			varchar(255);
ie_dt_emissao_guia_w		varchar(255);
ie_spsadt_atend_retorno_w	varchar(10);
cd_medico_referido_w		varchar(255);
cd_proc_tabela_w		varchar(255);
cd_cid_proc_presc_w		varchar(255);
nr_sequencia_autor_w		bigint;
nr_prescricao_w			bigint;
ie_classif_proced_w		varchar(255);
ie_codigo_tuss_w		varchar(2);
ie_desc_tuss_w			varchar(2);
ie_sadt_autor_sem_proc_w	varchar(255);
ie_senha_guia_w			varchar(255);
cd_senha_proc_prescr_w		varchar(20);
nr_seq_exame_lab_w		bigint;
ie_dt_emiss_guia_regra_w	varchar(10);
ie_data_entrada_w		varchar(10);
dt_envio_autor_w		timestamp;
cd_profissional_w		varchar(10);
cd_cgc_exame_w			varchar(14);
ie_medico_solic_exame_w		varchar(255);
cd_medico_solic_tiss_w		varchar(10);
nm_medico_solicitante_w		varchar(255);
cd_medico_atend_w		varchar(10);
cd_medico_solic_autor_w		varchar(10);
ie_regra_med_solic_w		varchar(10);
cd_autor_princ_atend_w		varchar(255);
cd_tipo_acomodacao_w		bigint;
cd_plano_convenio_w		varchar(10);
nr_seq_classificacao_w		bigint;
cd_cgc_prestador_tiss_w		varchar(14);
cd_medico_exec_tiss_w		varchar(20);
cd_cgc_prestador_solic_w	varchar(14);
cd_prestador_solic_w		varchar(20);
ds_prestador_solic_w		varchar(255);
cd_interno_exec_w		varchar(20);
cd_cgc_exec_w			varchar(14);
nm_contratado_exec_w		varchar(255);
cd_cnes_exec_w			varchar(255);
ds_endereco_w			varchar(255);
ds_municipio_w			varchar(255);
cd_municipio_ibge_w		varchar(255);
cd_cep_w			varchar(255);
sg_estado_w			valor_dominio.vl_dominio%type;
ie_tipo_acomodacao_w		varchar(255);
nr_endereco_w			varchar(255);
nr_seq_regra_w			bigint;
nm_exec_compl_w			varchar(255);
nr_seq_conselho_w		varchar(255);
cd_cnes_compl_w			varchar(255);
nr_cpf_honor_w			varchar(255);
uf_conselho_compl_w		varchar(255);
nr_crm_compl_w			varchar(255);
nr_atend_conta_tiss_w		bigint;
ds_versao_w			varchar(20);
nr_seq_tipo_acidente_w		bigint;
ie_tipo_acidente_w		varchar(10);
nr_prontuario_w			bigint;
nr_guia_prestador_w		varchar(100);
ie_guia_prestador_w		varchar(3);
ie_regra_guia_prest_w		varchar(3);
nr_seq_regra_solic_w            bigint;
im_logo_convenio_w	tiss_logo_convenio.im_logo_convenio%type;

c16 CURSOR FOR
SELECT	ie_regra
from	tiss_regra_guia_princ
where	cd_estabelecimento					= cd_estabelecimento_w
and	cd_convenio						= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and (ie_tiss_tipo_guia					= '2')
order by coalesce(ie_tipo_atendimento, 0);

c01 CURSOR FOR
SELECT	ie_tipo_acidente
from	tiss_tipo_acidente
where	nr_seq_acidente			= nr_seq_tipo_acidente_w
and	coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy')) <= dt_entrada_w
order 	by coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy'));



BEGIN

delete	from w_tiss_guia
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_dados_atendimento
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_beneficiario
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_proc_paciente
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_contratado_exec
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_totais
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_proc_solic
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_solicitacao
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_contratado_solic
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_relatorio
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_opm
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_opm_exec
where	nm_usuario		= nm_usuario_p;

commit;

if (coalesce(nr_atend_conta_tiss_p,0) > 0) then
	nr_atend_conta_tiss_w	:= nr_atend_conta_tiss_p;
elsif (coalesce(nr_atendimento_p,0) > 0) then
	nr_atend_conta_tiss_w	:= nr_atendimento_p;
end if;
	
if (coalesce(nr_atend_conta_tiss_w,0) > 0) then

	select	max(a.cd_estabelecimento),
		max(b.cd_convenio),
		max(a.nr_seq_classificacao),
		max(obter_setor_atendimento(a.nr_atendimento)),
		max(a.dt_entrada)
	into STRICT	cd_estabelecimento_w,
		cd_convenio_w,
		nr_seq_classif_atend_w,
		cd_setor_entrada_w,
		dt_entrada_w
	from	atendimento_paciente a,
		atend_categoria_convenio b
	where	obter_atecaco_atendimento(a.nr_atendimento) 	= b.nr_seq_interno
	and	a.nr_atendimento				= b.nr_atendimento
	and	a.nr_atendimento				= nr_atend_conta_tiss_w;

	select	coalesce(max(ie_prescr_unica),'N'),
		coalesce(max(ie_quebra_proc_pep), 'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S'),
		coalesce(max(ie_data_ass_prest), 'S'),
		coalesce(max(ie_solicitante),'H'),
		max(ds_arquivo_logo_comp),
		max(ie_guia_prestador)
	into STRICT	ie_prescr_unica_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w,
		ie_data_ass_prest_w,
		ie_solicitante_w,
		ds_arquivo_logo_comp_w,
		ie_guia_prestador_w
	from	TISS_PARAMETROS_CONVENIO
	where	cd_estabelecimento			= cd_estabelecimento_w
	and	cd_convenio				= cd_convenio_w;
	
	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(t.nr_doc_convenio)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_autorizacao_w
	from	pessoa_juridica c,
		convenio b,
		atend_categoria_convenio t,
		atendimento_paciente a
	where	t.cd_convenio					= b.cd_convenio
	and	b.cd_cgc					= c.cd_cgc
	and	t.nr_atendimento				= a.nr_atendimento
	and	obter_atecaco_atendimento(t.nr_atendimento) 	= t.nr_seq_interno
	and	a.nr_atendimento				= nr_atend_conta_tiss_w;

	select	max(a.cd_senha),
		max(a.dt_inicio_vigencia),
		max(a.dt_final_vigencia),
		max(a.nr_atendimento),
		max(b.dt_entrada),
		max(b.ie_tipo_atendimento),
		max(a.cd_categoria),
		max(ie_clinica),
		max(coalesce(a.nr_doc_conv_principal,a.nr_doc_convenio)),
		max(b.ie_tipo_atend_tiss),
		max(coalesce(a.ds_observacao,b.ds_observacao)),
		max(a.cd_tipo_acomodacao),
		max(a.cd_plano_convenio),
		max(b.nr_seq_classificacao),
		max(b.nr_seq_tipo_acidente),
		max(obter_prontuario_pf(b.cd_estabelecimento,b.cd_pessoa_fisica))
	into STRICT	cd_senha_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		nr_atendimento_w,
		dt_atendimento_w,
		ie_tipo_atendimento_w,
		cd_categoria_conv_w,
		ie_clinica_w,
		cd_autor_princ_w,
		ie_tipo_atend_tiss_w,
		ds_observacao_w,
		cd_tipo_acomodacao_w,
		cd_plano_convenio_w,
		nr_seq_classificacao_w,
		nr_seq_tipo_acidente_w,
		nr_prontuario_w
	from	atend_categoria_convenio a,
		atendimento_paciente b
	where	a.nr_atendimento				= nr_atend_conta_tiss_w
	and	obter_atecaco_atendimento(b.nr_atendimento) 	= a.nr_seq_interno
	and	a.nr_atendimento				= b.nr_atendimento;
	
	
	begin
		select	im_logo_convenio
		into STRICT	im_logo_convenio_w
		from	tiss_logo_convenio
		where	cd_convenio	   = cd_convenio_w
		and 	coalesce(ie_situacao,'N') = 'A';
	exception
	when others then
		im_logo_convenio_w := null;
	end;
			
	if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
		ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
	end if;
	
	if (coalesce(ie_gerar_tiss_w,'S')= 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (obter_se_atend_retorno(nr_atendimento_w) = 'N'))then
	
		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;
		
		ie_tipo_acidente_w		:= '2';  -- outros
		open c01;
		loop
		fetch c01 into
			ie_tipo_acidente_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		
		select	nextval('w_tiss_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
			dt_assin_prest_w	:= dt_atendimento_w;
		else
			dt_assin_prest_w	:= clock_timestamp();
		end if;

		/*lhalves OS 226155 em 25/06/2010 - Considerar regra guia princ, ao emitir a guia pelo REP*/

		ie_regra_guia_princ_w	:= null;
		open c16;
		loop
		fetch c16 into
			ie_regra_guia_princ_w;	
		EXIT WHEN NOT FOUND; /* apply on c16 */
		end loop;
		close c16;

		if (ie_regra_guia_princ_w in ('AG','GP','A','G')) then
			cd_autor_princ_atend_w := cd_autor_princ_w;					
		elsif (ie_regra_guia_princ_w = 'S') then
			cd_autor_princ_atend_w	:= cd_senha_w;
		elsif (ie_regra_guia_princ_w = 'AS') then
			cd_autor_princ_atend_w := cd_autor_princ_w || cd_senha_w;		
		elsif (ie_regra_guia_princ_w = 'N') then
			cd_autor_princ_atend_w := null;
		end if;		
		
		if (ie_guia_prestador_w = 'G') then --Número da guia		
			nr_guia_prestador_w	:= cd_autor_princ_w;			
		elsif (ie_guia_prestador_w = 'GT') then --Número da guia + Tipo de guia
			nr_guia_prestador_w	:= cd_autor_princ_w||'2';			
		elsif (ie_guia_prestador_w = 'SG') then --Número de sequência da guia
			nr_guia_prestador_w 	:= nr_seq_guia_w;
		elsif (ie_guia_prestador_w = 'S') then --Senha do atendimento
			nr_guia_prestador_w 	:= cd_senha_w;
		elsif (ie_guia_prestador_w = 'PR') then --Prontuário do paciente								
			nr_guia_prestador_w	:= nr_prontuario_w;
		elsif (ie_guia_prestador_w = 'GE') then --Número da guia da EUP
			nr_guia_prestador_w	:= cd_autor_princ_w;
		elsif (ie_guia_prestador_w = 'A') then --Número do atendimento
			nr_guia_prestador_w	:= nr_atendimento_w;
		elsif (ie_guia_prestador_w = 'R') then
			SELECT * FROM TISS_OBTER_GUIA_PRESTADOR(cd_estabelecimento_w, cd_convenio_w, '2', nr_atendimento_w, null, cd_autor_princ_w, nr_seq_guia_w, nr_guia_prestador_w, ie_regra_guia_prest_w) INTO STRICT nr_guia_prestador_w, ie_regra_guia_prest_w;			
		end if;	

		insert	into w_tiss_guia(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			cd_ans,
			cd_autorizacao,
			cd_autorizacao_princ,
			dt_autorizacao,
			cd_senha,
			dt_validade_senha,
			dt_emissao_guia,
			nr_interno_conta,
			nr_seq_protocolo,
			nr_sequencia_autor,
			ds_observacao,
			ie_tiss_tipo_guia,
			dt_entrada,
			nr_atendimento,
			DT_ASSIN_PREST,
			dt_assin_solic,
			ds_versao,
			nr_guia_prestador)
		values (nr_seq_guia_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_ans_w,
			tiss_obter_regra_campo(2, 'CD_AUTORIZACAO', CD_CONVENIO_W, cd_autor_princ_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			cd_autor_princ_atend_w,
			tiss_obter_regra_campo(2, 'DT_AUTORIZACAO', CD_CONVENIO_W, dt_inicio_vigencia_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(2, 'CD_SENHA', CD_CONVENIO_W, cd_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			dt_final_vigencia_w,
			clock_timestamp(),
			null,
			null,
			null,
			substr(ds_observacao_w,1,3999),
			'2',
			tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP', CD_CONVENIO_W, dt_atendimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			nr_atendimento_w,
			tiss_obter_regra_campo(2, 'DS_ASSINATURA_EXEC', CD_CONVENIO_W, DT_ASSIN_PREST_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),								
			tiss_obter_regra_campo(2, 'DS_ASSINATURA_SOLIC', CD_CONVENIO_W, dt_atendimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			ds_versao_w,
			nr_guia_prestador_w);

		/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

		insert	into w_tiss_beneficiario(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_pessoa_fisica,
			nm_pessoa_fisica,
			nr_cartao_nac_sus,
			ds_plano,
			dt_validade_carteira,
			cd_usuario_convenio)
		SELECT	nextval('w_tiss_beneficiario_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			c.cd_pessoa_fisica,
			substr(coalesce(tiss_obter_nome_abreviado(b.cd_convenio, a.cd_estabelecimento, c.cd_pessoa_fisica), c.nm_pessoa_fisica),1,150),
			c.nr_cartao_nac_sus,
			substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
			b.dt_validade_carteira,
			b.cd_usuario_convenio
		from	pessoa_fisica c,
			atend_categoria_convenio b,
			atendimento_paciente a
		where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
		and	a.nr_atendimento	= b.nr_atendimento
		and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
		and	a.nr_atendimento	= nr_atend_conta_tiss_w;
		
		insert into w_tiss_dados_atendimento(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			ie_tipo_atendimento,
			ie_tipo_acidente)
		values (nextval('w_tiss_dados_atendimento_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			ie_tipo_atend_tiss_w,
			ie_tipo_acidente_w);
			
		select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, null, cd_setor_atendimento_w,null,null, null, null)), 'N')
		into STRICT	ie_conveniado_w
		;

		ie_solicitante_ww	:= null;		

		if (ie_solicitante_w	= 'R') then

			select	max(d.ie_tipo_atendimento),
				max(d.ie_clinica),	
				max(d.cd_procedencia),
				max(d.cd_medico_referido),
				max(cd_medico_resp)
			into STRICT	ie_tipo_atendimento_w,
				ie_clinica_w,
				cd_procedencia_w,
				cd_medico_referido_w,
				cd_medico_atendimento_w
			from	atendimento_paciente d
			where	nr_atendimento	= nr_atend_conta_tiss_w;		

			select	max(obter_setor_atendimento(nr_atend_conta_tiss_w))
			into STRICT	cd_setor_entrada_w
			;

			SELECT * FROM tiss_obter_regra_prest_solic(	cd_convenio_w, cd_estabelecimento_w, cd_setor_entrada_w, ie_clinica_w, cd_procedencia_w, ie_tipo_atendimento_w, 'N', ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_atendimento_w, cd_medico_solic_w, ds_irrelevante_w, ds_irrelevante_w, cd_medico_referido_w, cd_categoria_conv_w, clock_timestamp(), null, null, null, nr_seq_regra_solic_w) INTO STRICT ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_solic_w, ds_irrelevante_w, ds_irrelevante_w, nr_seq_regra_solic_w;				
		end if;

		if (ie_solicitante_w	= 'M') or (ie_solicitante_w	= 'MC' AND ie_conveniado_w	= 'S') then
			ie_solicitante_ww		:= ie_solicitante_w;
			nm_contratado_solic_w		:= nm_medico_solic_w;
			cd_interno_solic_w		:= tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_prescr_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w);							
		elsif (ie_solicitante_w	= 'I') then
			if (coalesce(cd_medico_solic_w::text, '') = '') then
				ie_solicitante_ww		:= ie_solicitante_w;
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					cd_cgc_solic_w
				;

				select	max(ds_razao_social),
					max(cd_cnes)
				into STRICT	nm_contratado_solic_w,
					cd_cnes_solic_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cgc_prest_solic_regra_w;
			else		
				
				ie_solicitante_ww		:= ie_solicitante_w;
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					nr_cpf_solic_w
				;

				select	max(nm_pessoa_fisica),
					max(cd_cnes)
				into STRICT	nm_contratado_solic_w,
					cd_cnes_solic_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_solic_w;
				
			end if;
		end if;
		
		select	coalesce(max(obter_nome_medico(a.cd_medico_resp, 'N')), nm_medico_solic_w),
			substr(coalesce(max(obter_dados_medico(a.cd_medico_resp, 'UFCRM')), uf_crm_w),1,2),
			coalesce(max(obter_dados_medico(a.cd_medico_resp, 'SGCRM')), sg_conselho_w),
			coalesce(max(obter_dados_medico(a.cd_medico_resp, 'CRM')), nr_crm_w),
			coalesce(max(obter_dados_pf(a.cd_medico_resp, 'CPF')), nr_cpf_w),
			max(tiss_obter_carater_intern(a.ie_carater_inter_sus))
		into STRICT	nm_medico_solic_w,
			uf_crm_w,
			sg_conselho_w,
			nr_crm_w,
			nr_cpf_w,
			ie_carater_inter_sus_w
		from	atendimento_paciente a
		where	a.nr_atendimento	= nr_atend_conta_tiss_w;
		
		if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
			select	CASE WHEN ie_carater_inter_sus_w='E' THEN '1' WHEN ie_carater_inter_sus_w='U' THEN '2' END
			into STRICT	ie_carater_inter_sus_w
			;
		end if;
		
		insert into w_tiss_contratado_solic(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_cgc,
			cd_interno,
			nr_cpf,
			nm_contratado,
			nm_solicitante,
			cd_cnes,
			sg_conselho,
			nr_crm,
			uf_crm,
			cd_cbo_saude)
		SELECT	nextval('w_tiss_contratado_solic_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  f.cd_cgc  ELSE cd_cgc_solic_w END ,
			CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO')  ELSE cd_interno_solic_w END ,
			coalesce(nr_cpf_solic_w, nr_cpf_w),
			coalesce(nm_contratado_solic_w, substr(tiss_eliminar_caractere(h.ds_razao_social),1,100)),
			tiss_obter_regra_campo(2, 'NM_SOLICITANTE', CD_CONVENIO_W, nm_medico_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),	
			coalesce(cd_cnes_solic_w, coalesce(f.cd_cns, h.cd_cnes)),	
			tiss_obter_regra_campo(2, 'SG_CONSELHO', CD_CONVENIO_W, sg_conselho_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(2, 'NR_CRM', CD_CONVENIO_W, nr_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(2, 'UF_CRM', CD_CONVENIO_W, uf_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(2, 'CD_CBO_SAUDE', cd_convenio_w, coalesce(tiss_obter_cbos_medico(i.cd_pessoa_fisica,obter_especialidade_medico(i.cd_pessoa_fisica,'c'),ds_versao_w,cd_convenio_w),k.cd_cbo), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')		
		FROM pessoa_juridica h, convenio g, estabelecimento f, atend_categoria_convenio c, pessoa_fisica i
LEFT OUTER JOIN cbo_saude k ON (i.nr_seq_cbo_saude = k.nr_sequencia)
, atendimento_paciente a
LEFT OUTER JOIN medico b ON (a.cd_medico_resp = b.cd_pessoa_fisica)
WHERE a.nr_atendimento			= c.nr_atendimento and obter_atecaco_atendimento(a.nr_atendimento) = c.nr_seq_interno  and a.cd_estabelecimento 			= f.cd_estabelecimento and c.cd_convenio				= g.cd_convenio and f.cd_cgc				= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica  and a.nr_atendimento			= nr_atend_conta_tiss_w;
		
		
		SELECT	max(a.cd_doenca) cd_doenca_cid,
			substr(max(a.ds_diagnostico),2,255)
			--max(decode(ie_carater_inter_sus, '1', 'E', 'U'))			
		into STRICT	cd_doenca_cid_w,
			ds_observacao_w
			--ie_carater_inter_sus_w
		FROM 	diagnostico_doenca a,
			diagnostico_medico c,
			atendimento_paciente e	
		WHERE	c.nr_atendimento		= a.nr_atendimento
		AND	c.dt_diagnostico		= a.dt_diagnostico
		and	c.nr_atendimento		= e.nr_atendimento
		and	a.nr_atendimento		= e.nr_atendimento
		AND	a.ie_classificacao_doenca	= 'P'
		and	e.nr_atendimento		= nr_atend_conta_tiss_w
		AND	c.dt_diagnostico		=
							(SELECT	MAX(x.dt_diagnostico)
							FROM	diagnostico_doenca y,
								diagnostico_medico x
							WHERE	x.nr_atendimento		= e.nr_atendimento
							AND	x.nr_atendimento		= y.nr_atendimento
							AND	x.dt_diagnostico		= y.dt_diagnostico
							AND	y.ie_classificacao_doenca	= 'P');									

		insert into w_tiss_solicitacao(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			dt_solicitacao,
			ie_carater_solic,
			cd_cid,
			ds_indicacao)
		values (nextval('w_tiss_solicitacao_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', CD_CONVENIO_W, to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
			ie_carater_inter_sus_w,
			coalesce(tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, cd_doenca_cid_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),cd_cid_proc_presc_w),
			coalesce(ds_inicacao_clinica_w, ds_observacao_w));

		select	cd_cgc
		into STRICT	cd_cgc_prestador_w
		from	estabelecimento
		where	cd_estabelecimento	= cd_estabelecimento_w;
			
		SELECT * FROM tiss_obter_regra_prestador(cd_convenio_w, cd_estabelecimento_w, ie_tipo_atendimento_w, null, ie_clinica_w, cd_cgc_prestador_w, cd_setor_entrada_w, null, cd_medico_atendimento_w, cd_categoria_conv_w, null, null, '4', 'N', cd_cgc_prestador_tiss_w, ds_irrelevante_w, ds_irrelevante_w, cd_medico_exec_tiss_w, cd_cgc_prestador_solic_w, nr_seq_regra_w, 'P', ds_irrelevante_w, null, ds_irrelevante_w, cd_prestador_solic_w, ds_prestador_solic_w, clock_timestamp(), 'N', cd_medico_referido_w, cd_tipo_acomodacao_w, cd_procedencia_w, cd_plano_convenio_w, nr_seq_classificacao_w, 'N', 'N', null, null) INTO STRICT cd_cgc_prestador_tiss_w, ds_irrelevante_w, ds_irrelevante_w, cd_medico_exec_tiss_w, cd_cgc_prestador_solic_w, nr_seq_regra_w, ds_irrelevante_w, ds_irrelevante_w, cd_prestador_solic_w, ds_prestador_solic_w;
				
		if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then	
			if	((cd_cgc_prestador_tiss_w IS NOT NULL AND cd_cgc_prestador_tiss_w::text <> '') or (cd_cgc_prestador_solic_w IS NOT NULL AND cd_cgc_prestador_solic_w::text <> ''))then
			
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, coalesce(cd_cgc_prestador_solic_w,cd_cgc_prestador_w), cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, coalesce(cd_cgc_prestador_solic_w,cd_cgc_prestador_w), cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_exec_w,
					cd_cgc_exec_w
				;
				
				select	substr(max(ds_razao_social),1,254),
					substr(max(cd_cnes),1,254),
					substr(max(ds_endereco), 1,254),
					substr(max(ds_municipio),1,254),
					substr(max(cd_municipio_ibge),1,254),
					substr(max(cd_cep),1,254),
					substr(max(sg_estado),1,254),
					substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
					substr(max(nr_endereco),1,254)
				into STRICT	nm_contratado_exec_w,
					cd_cnes_exec_w,
					ds_endereco_w,
					ds_municipio_w,
					cd_municipio_ibge_w,
					cd_cep_w,
					sg_estado_w,
					ie_tipo_acomodacao_w,
					nr_endereco_w
				FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= coalesce(cd_cgc_prestador_solic_w,cd_cgc_prestador_w);
				
				nm_contratado_exec_w	:= coalesce(ds_prestador_solic_w,nm_contratado_exec_w);
				cd_interno_exec_w	:= coalesce(cd_prestador_solic_w,cd_interno_exec_w);
				if (cd_interno_exec_w IS NOT NULL AND cd_interno_exec_w::text <> '') then
					cd_cgc_exec_w	:= null;
				end if;
			elsif (cd_medico_exec_tiss_w IS NOT NULL AND cd_medico_exec_tiss_w::text <> '') then
			
				select	max(nm_pessoa_fisica),
					max(nr_cpf)
				into STRICT	nm_contratado_exec_w,
					cd_interno_exec_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_exec_tiss_w;			
				
				nm_contratado_exec_w	:= coalesce(ds_prestador_solic_w,nm_contratado_exec_w);
				cd_interno_exec_w	:= coalesce(cd_prestador_solic_w,cd_interno_exec_w);
				if (cd_interno_exec_w IS NOT NULL AND cd_interno_exec_w::text <> '') then
					cd_cgc_exec_w	:= null;					
				end if;			
			
			end if;
		else
			select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
				max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
			into STRICT	cd_interno_exec_w,
				cd_cgc_exec_w
			;
			
			select	substr(max(ds_razao_social),1,254),
				substr(max(cd_cnes),1,254),
				substr(max(ds_endereco), 1,254),
				substr(max(ds_municipio),1,254),
				substr(max(cd_municipio_ibge),1,254),
				substr(max(cd_cep),1,254),
				substr(max(sg_estado),1,254),
				substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
				substr(max(nr_endereco),1,254)
			into STRICT	nm_contratado_exec_w,
				cd_cnes_exec_w,
				ds_endereco_w,
				ds_municipio_w,
				cd_municipio_ibge_w,
				cd_cep_w,
				sg_estado_w,
				ie_tipo_acomodacao_w,
				nr_endereco_w
			FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;
			
			nm_contratado_exec_w	:= coalesce(ds_prestador_solic_w,nm_contratado_exec_w);
			cd_interno_exec_w	:= coalesce(cd_prestador_solic_w,cd_interno_exec_w);
			if (cd_interno_exec_w IS NOT NULL AND cd_interno_exec_w::text <> '') then
				cd_cgc_exec_w	:= null;
			end if;
		end if;
		
		select	max(nm_pessoa_fisica),
			max(nr_seq_conselho),
			max(cd_cnes),			
			max(nr_cpf)
		into STRICT	nm_exec_compl_w,
			nr_seq_conselho_w,
			cd_cnes_compl_w,			
			nr_cpf_honor_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_medico_atendimento_w;
		
		select	substr(max(uf_crm),1,2),
			max(nr_crm)
		into STRICT	uf_conselho_compl_w,
			nr_crm_compl_w
		from	medico
		where	cd_pessoa_fisica	= cd_medico_atendimento_w;		

		insert	into w_tiss_contratado_exec(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_cgc,
			cd_interno,
			nr_cpf,
			nm_contratado,
			ds_tipo_logradouro,
			ds_logradouro,
			nm_municipio,
			sg_estado,
			cd_municipio_ibge,
			cd_cep,
			cd_cnes,
			nm_medico_executor,
			sg_conselho,
			nr_crm,
			uf_crm,
			cd_cbo_saude,
			ds_funcao_medico)
		values (nextval('w_tiss_contratado_exec_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_cgc_exec_w,
			cd_interno_exec_w,
			nr_cpf_honor_w,
			nm_contratado_exec_w,
			ie_tipo_acomodacao_w,
			(ds_endereco_w || ' ' || nr_endereco_w),
			ds_municipio_w,
			sg_estado_w,
			cd_municipio_ibge_w,
			cd_cep_w,
			cd_cnes_exec_w,
			nm_exec_compl_w,
			nr_seq_conselho_w,
			nr_crm_compl_w,
			uf_conselho_compl_w,
			null,
			null);

		CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w,nm_usuario_p);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_w_guia_solic_spsadt (ds_dir_padrao_p text, nr_atend_conta_tiss_p text, nm_usuario_p text, nr_atendimento_p text) FROM PUBLIC;

