-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_agenda_atividade_status ( cd_estab_p text, nr_seq_atividade_p text, nr_seq_regional_p text, nm_usuario_exec_p text, ie_status_agenda_p text, ie_tipo_consulta_p text, ie_situacao_p text, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_status_w			varchar(4000);
ie_status_dia_w			varchar(10);
qt_dias_mes_w			integer;
dt_mes_w			timestamp;
dt_inicio_w			timestamp;
qt_existe_w			integer;
nr_seq_atividade_w		varchar(255);
nr_seq_regional_w		varchar(255);
cd_estab_agenda_w		varchar(255);
nm_usuario_exec_w		varchar(255);
ie_status_agenda_w		varchar(255);
qt_dia_w			integer;
dt_mesano_referencia_w		timestamp;
ie_feriado_w			varchar(1);
dt_referencia_w			timestamp;
ie_existe_planej_w		varchar(1);
ie_dia_semana_w			varchar(1);
ds_cor_w			varchar(15);
cd_estabelecimento_w		smallint;
cd_estabelecimento_ww		smallint;
cd_estab_w			varchar(20);
qt_pintar_w			smallint;
qt_prioridade_w			integer;


C01 REFCURSOR;
BEGIN
-- Agenda_Dia_Status
--ATENÇÃO:  A tabela w_calend_planej_compras, é temporiaria para a  sessão, ou seja, não adianta fazr select no sql plus que não vai trazer nada. Tem que pegar e fazer um insert em outra tabela duplicada se quiser testar. mhbarth
delete from w_calend_planej_compras;
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

dt_mes_w		:= dt_inicial_p;
dt_inicio_w		:= pkg_date_utils.start_of(dt_inicial_p,'DD',0);
nr_seq_atividade_w	:= substr(replace(nr_seq_atividade_p,', ',','),1,255);
cd_estab_agenda_w	:= substr(replace(cd_estab_p,', ',','),1,255);
nr_seq_regional_w	:= substr(replace(nr_seq_regional_p,', ',','),1,255);
nm_usuario_exec_w	:= substr(replace(nm_usuario_exec_p,', ',','),1,255);
ie_status_agenda_w	:= substr(replace(ie_status_agenda_p,', ',','),1,255);

nm_usuario_exec_w	:= replace(nm_usuario_exec_w, '''',''); --remove as aspas simples
ie_status_agenda_w	:= replace(ie_status_agenda_w, '''',''); --remove as aspas simples
open C01 for EXECUTE ' select	cd_estabelecimento '||
	     ' from	estabelecimento '||
	     ' where	cd_estabelecimento in  ('|| coalesce(cd_estab_p,cd_estabelecimento_w) || ')'||
	     ' order by 1 ';
loop
fetch C01 into
	cd_estabelecimento_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	for i in 0..5 loop
		begin
		dt_mesano_referencia_w	:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(dt_inicio_w,i, 0), 'MONTH', 0);
		qt_dia_w			:= (PKG_DATE_UTILS.extract_field('DAY', PKG_DATE_UTILS.end_of(dt_mesano_referencia_w, 'MONTH', 0)))::numeric  - 1;

		for k in 0..qt_dia_w loop
			begin
			dt_referencia_w := dt_mesano_referencia_w + k;
			ie_dia_semana_w	:= pkg_date_utils.get_WeekDay(dt_referencia_w);

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_feriado_w
			from	feriado
			where 	cd_estabelecimento = cd_estabelecimento_ww
			and	dt_feriado = dt_referencia_w;
			--where	((cd_estab_p is null) or (obter_se_contido_char(cd_estabelecimento,cd_estab_p) = 'S'))
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_existe_planej_w
			from	pcs_agenda_atividades a
			where (pkg_date_utils.start_of(a.dt_inicio,'DD',0) = pkg_date_utils.start_of(dt_referencia_w,'DD',0))
			and	CASE WHEN ie_tipo_consulta_p='A' THEN a.dt_inicio WHEN ie_tipo_consulta_p='C' THEN a.dt_fim END  between dt_inicial_p and PKG_DATE_UTILS.start_of(dt_final_p,'dd', 0) + 86399/86400
			and	((coalesce(nr_seq_atividade_w::text, '') = '') or (obter_se_contido_char(a.nr_seq_atividade,upper(nr_seq_atividade_w)) = 'S'))
			and	a.cd_estabelecimento = cd_estabelecimento_ww
			and	((coalesce(nr_seq_regional_w::text, '') = '') or (obter_se_contido_char(a.nr_seq_regional,upper(nr_seq_regional_w)) = 'S'))
			and	((coalesce(ie_status_agenda_w::text, '') = '') or (obter_se_contido_char(a.ie_status,ie_status_agenda_w) = 'S'))
			and	((a.ie_situacao = ie_situacao_p) or (ie_situacao_p = 'T'));

			if (ie_existe_planej_w = 'S') then
				ds_cor_w		:= 'clGreen';
				qt_prioridade_w		:= 4;
			elsif (ie_feriado_w = 'S') then
				ds_cor_w		:= 'clRed';
				qt_prioridade_w		:= 3;
			elsif (pkg_date_utils.IS_BUSINESS_DAY(dt_referencia_w)  = 0) then		-- ie_dia_semana_w in (1,7)
				ds_cor_w		:= 'clYellow';
				qt_prioridade_w		:= 2;
			else
				ds_cor_w		:= 'clWhite';
				qt_prioridade_w		:= 1;
			end if;

			insert into w_calend_planej_compras(
				cd_estabelecimento,
				nr_seq_planej_compras,
				dt_mesano_referencia,
				dt_referencia,
				nm_usuario,
				ds_cor,
				qt_prioridade)
			values ( cd_estabelecimento_ww,
				1,
				dt_mesano_referencia_w,
				dt_referencia_w,
				nm_usuario_p,
				ds_cor_w,
				qt_prioridade_w);

			/*insert into mhbarth(
				cd_estabelecimento,
				nr_seq_planej_compras,
				dt_mesano_referencia,
				dt_referencia,
				nm_usuario,
				ds_cor,
				qt_prioridade)
			values ( cd_estabelecimento_ww,
				1,
				dt_mesano_referencia_w,
				dt_referencia_w,
				nm_usuario_p,
				ds_cor_w,
				qt_prioridade_w);*/
			end;
		end loop;

		end;
	end loop;



	end;
end loop;
close C01;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_agenda_atividade_status ( cd_estab_p text, nr_seq_atividade_p text, nr_seq_regional_p text, nm_usuario_exec_p text, ie_status_agenda_p text, ie_tipo_consulta_p text, ie_situacao_p text, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

