-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_prof_escala_per (dt_inicio_p timestamp, dt_final_p timestamp, ie_opcao_p bigint, lista_informacao_p text, nm_usuario_p text, ds_consistencia_p INOUT text) AS $body$
DECLARE



nr_seq_escala_w		bigint;
cd_pessoa_fisica_w	varchar(10);
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
cd_pessoa_origem_w	varchar(10);
ds_observacao_w		varchar(255);
ie_feriado_w		varchar(1);
qt_min_executado_w	bigint;
qt_escala_w		integer;
nr_seq_escala_diaria_w	bigint;
ds_dia_semana_w		varchar(3);
hr_inicio_w		varchar(7);
hr_fim_w		varchar(7);
ds_consistencia_w		varchar(255);
ds_consistencia_anestesita_w	varchar(255);
nr_seq_escala_dia_orig_w	bigint;

lista_informacao_w		varchar(4000);
ie_contador_w			bigint	:= 0;
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
nr_seq_ecala_dest_w		bigint;

/*
ie_opcao_p
1 - todos os dias com o mesmo horario
0 - somente o dia da semana com o mesmo horario
*/
c01 CURSOR FOR
SELECT 	nr_sequencia
from	escala_diaria
where	to_char(dt_fim,'hh24:mi')	= hr_fim_w
and	to_char(dt_inicio,'hh24:mi')	= hr_inicio_w
and	ie_feriado 			= ie_feriado_w
and	(((ie_opcao_p = 0) and (substr(obter_dia_semana(DT_INICIO),1,3) = ds_dia_semana_w)) or (ie_opcao_p = 1))
and	nr_sequencia	<> nr_seq_escala_dia_orig_w
and	nr_seq_escala	= nr_seq_escala_w
and	dt_inicio 	between pkg_date_utils.start_of(dt_inicio_p, 'DD', 0) and pkg_date_utils.end_of(dt_final_p, 'DAY', 0);

c02 CURSOR FOR
	SELECT	a.cd_pessoa_fisica
	from	escala_diaria_adic a,
		escala_diaria b
	where	b.nr_sequencia = a.nr_seq_escala_diaria
	and	nr_seq_escala_diaria	=	nr_seq_escala_dia_orig_w
	and	not exists (	SELECT	1
				from	escala_diaria_adic x
				where	x.nr_seq_escala_diaria = nr_seq_escala_diaria_w
				and	x.cd_pessoa_fisica = a.cd_pessoa_fisica);


BEGIN


lista_informacao_w	:= lista_informacao_p;

while	(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') or
	ie_contador_w > 200 loop
	begin
	tam_lista_w		:= length(lista_informacao_w);
	ie_pos_virgula_w	:= position(',' in lista_informacao_w);

	if (ie_pos_virgula_w <> 0) then
		nr_seq_escala_dia_orig_w	:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));
		lista_informacao_w		:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
	end if;

	select	max(nr_seq_escala),
		max(ie_feriado),
		max(substr(obter_dia_semana(DT_INICIO),1,3)),
		max(to_char(dt_inicio,'hh24:mi')),
		max(to_char(dt_fim,'hh24:mi'))
	into STRICT	nr_seq_escala_w,
		ie_feriado_w,
		ds_dia_semana_w,
		hr_inicio_w,
		hr_fim_w
	from	escala_diaria
	where   nr_sequencia = nr_seq_escala_dia_orig_w;

	open c01;
	loop
	fetch c01 into
		nr_seq_escala_diaria_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if	(nr_seq_escala_dia_orig_w > 0 AND nr_seq_escala_diaria_w > 0) then

			open c02;
			loop
				fetch c02 into	cd_pessoa_fisica_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */

				select	substr(obter_se_prof_liberado_escala(cd_pessoa_fisica_w,b.nr_seq_escala,b.dt_inicio),1,255)
				into STRICT	ds_consistencia_anestesita_w
				from	escala_diaria b
				where	b.nr_sequencia = 	nr_seq_escala_diaria_w;

				if (ds_consistencia_anestesita_w IS NOT NULL AND ds_consistencia_anestesita_w::text <> '') then
					ds_consistencia_w	:= substr(replace(ds_consistencia_w,ds_consistencia_anestesita_w || chr(10),''),1,255);

					if (length(ds_consistencia_w || ds_consistencia_anestesita_w || chr(10)) < 255) then
						ds_consistencia_w	:= ds_consistencia_w || ds_consistencia_anestesita_w || chr(10);

					end if;
				end if;
			end loop;
			close c02;

		end if;
	end loop;
	close c01;

	ie_contador_w	:= ie_contador_w + 1;
	end;
end loop;

if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') then
	ds_consistencia_p := Wheb_mensagem_pck.get_texto(306314, 'DS_CONSISTENCIA_W=' || ds_consistencia_w); -- ConsistÃªncias:  #@DS_CONSISTENCIA_W#@
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_prof_escala_per (dt_inicio_p timestamp, dt_final_p timestamp, ie_opcao_p bigint, lista_informacao_p text, nm_usuario_p text, ds_consistencia_p INOUT text) FROM PUBLIC;

