-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ins_hist_req_custom_branch_os (nr_sequence_so_p bigint, branch_name_p text) AS $body$
DECLARE


DS_TEXT varchar(1000);

cd_funcao_w funcao.cd_funcao%type;
nm_usuario_lider_w grupo_desenvolvimento.nm_usuario_lider%type;
ds_locale_user_w user_locale.ds_locale%type;
cd_exp_funcao_w funcao.cd_exp_funcao%type;
branch_name_w man_custom_branch.branch_name%type;
nr_seq_ordem_serv_w man_ordem_servico.nr_sequencia%type;


BEGIN
    branch_name_w := branch_name_p;
  select distinct coalesce(g.nm_usuario_lider,'jpweiss'), obtain_user_locale(coalesce(g.nm_usuario_lider,'jpweiss'))
    into STRICT nm_usuario_lider_w, ds_locale_user_w
    from  man_ordem_servico mos
    left join funcao f on (mos.cd_funcao = f.cd_funcao)
    left join funcao_grupo_des gf on (f.cd_funcao = gf.cd_funcao)
    left JOIN grupo_desenvolvimento g ON (gf.nr_seq_grupo = g.nr_sequencia)
    where mos.nr_sequencia = nr_sequence_so_p  LIMIT 1;

    DS_TEXT := trim(both expressao_pck.obter_dic_expressao_loc(967448,ds_locale_user_w));
    if (coalesce(DS_TEXT::text, '') = '' or length(DS_TEXT) <= 0) then
        DS_TEXT := 'A branch CUSTOM_BRANCH_NAME especifica foi solicitada com sucesso!'||chr(13)||chr(10)||
                   'aguarde a rotina criar a branch e comunicar via historico na OS.';
    end if;
    ds_text := replace(DS_TEXT, 'CUSTOM_BRANCH_NAME', branch_name_w);

  insert into MAN_ORDEM_SERV_TECNICO(NR_SEQUENCIA,
                      NR_SEQ_ORDEM_SERV,
                      DT_ATUALIZACAO,
                      NM_USUARIO,
                      DT_HISTORICO,
                      DT_LIBERACAO,
                      NR_SEQ_TIPO,
                      IE_ORIGEM,
                      DS_RELAT_TECNICO) 
                      values (nextval('man_ordem_serv_tecnico_seq'),
                      nr_sequence_so_p,
                      clock_timestamp(), 
                      'Tasy', 
                      clock_timestamp(),
                      clock_timestamp(),
                      7,
                      'I',
                      DS_TEXT);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ins_hist_req_custom_branch_os (nr_sequence_so_p bigint, branch_name_p text) FROM PUBLIC;

