-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_cancelamento_agenda (nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_agenda_w		bigint;
dt_agenda_w		timestamp;
hr_inicio_w		timestamp;
nr_seq_agenda_orig_w	agenda_paciente.nr_sequencia%type;


BEGIN

select	cd_agenda,
	dt_agenda,
	hr_inicio
into STRICT	cd_agenda_w,
	dt_agenda_w,
	hr_inicio_w
from	agenda_paciente
where	nr_sequencia	= nr_seq_agenda_p;


select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_agenda_orig_w
from	agenda_paciente
where	cd_agenda	= cd_agenda_w
and	dt_agenda	= dt_agenda_w
and	hr_inicio		= trunc(hr_inicio_w, 'mi')
and	ie_status_agenda	<> 'L'
and	nr_sequencia	<> nr_seq_agenda_p; /* Rafael em 12/02/2007 OS50494, inclui o teste referente a sequencia */
if (nr_seq_agenda_orig_w = 0) then
	begin

	delete	from agenda_paciente
	where	nr_sequencia	= nr_seq_agenda_orig_w;
		

	update	agenda_paciente
	set	hr_inicio			= trunc(hr_inicio_w, 'mi'),	
		ie_status_agenda		= 'N',
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		cd_motivo_cancelamento	 = NULL
	where	nr_sequencia		= nr_seq_agenda_p;


	end;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(282444);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_cancelamento_agenda (nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

