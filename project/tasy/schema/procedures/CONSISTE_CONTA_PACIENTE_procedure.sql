-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_conta_paciente ( nr_interno_conta_p bigint, nr_atendimento_p bigint, ie_fecha_atendimento_p INOUT text, ie_fecha_conta_p INOUT text, qt_processo_pendente_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE


dt_atualizacao_w	timestamp        		:= clock_timestamp();
nr_seq_proc_pacote_w	bigint	:= 0;
nr_atendimento_w	bigint   	:= 0;
nr_interno_conta_w	bigint   	:= 0;
ds_erro_laudo_w		varchar(2000) 	:= '';
ds_erro_atend_w		varchar(2000) 	:= '';
ds_erro_conta_w		varchar(2000) 	:= '';
ds_erro_bpa_w		varchar(2000) 	:= '';
ds_erro_valor_w		varchar(2000) 	:= '';
ds_erro_aih_w		varchar(2000) 	:= '';
ds_erro_guia_w		varchar(2000) 	:= '';
ds_erro_proc_w		varchar(2000) 	:= '';
ds_erro_partic_w	varchar(2000) 	:= '';
ds_erro_w			varchar(2000) 	:= '';
ds_erro_aux_w		varchar(2000) 	:= '';
cd_erro_w			varchar(120) 	:= '';
cd_erro_ler_w		varchar(255) 	:= '';
ds_erro_ler_w		varchar(2000) 	:= '';
ds_erro_cid_w		varchar(2000) 	:= '';
ds_erro_guia_dup_w	varchar(2000) 	:= '';
ds_erro_tipo_conv_w	varchar(2000) 	:= '';
ds_us_erro_w		varchar(2000)	:= '';
ds_rx_erro_w		varchar(2000)	:= '';
ds_erro_pacote_w	varchar(2000) 	:= '';
ds_proc_com_erro_w	varchar(2000)	:= '';
ds_proc_mat_erro_w	varchar(2000)	:= '';
ds_mat_com_erro_w	varchar(2000)	:= '';
qt_mat_comm_erro_w	bigint;
ds_erro_medico_exec_w	varchar(2000) 	:= '';
ds_erro_ctrm_w		varchar(2000) 	:= '';
ds_erro_uti_w		varchar(2000) 	:= '';
ds_erro_regra_atend_w	varchar(2000) 	:= '';
ds_erro_mat_w		varchar(2000) 	:= '';
ds_erro_procedimento_w	varchar(2000) 	:= '';
ds_erro_conta_audit_w	varchar(2000)	:= '';
sql_select		varchar(2000) 	:= '';
dt_alta_w		timestamp;
dt_entrada_w		timestamp;
ie_tipo_atendimento_w	smallint   	:= 0;
ie_tipo_convenio_w	smallint   	:= 0;
ie_tipo_convenio_ww	smallint;
ie_tipo_convenio_www	smallint;
qt_processo_pendente_w  bigint  	:= 0;
guampa			varchar(1)	:= chr(39);
ie_medico_conv_w	varchar(1) := 'S';
retorno_w		double precision;
qt_proc_sem_laudo_w	bigint;
qt_proc_laudo_nao_lib_w	bigint;
qt_proc_medico_residente_w	bigint;
qt_erro_w   		bigint  	:= 0;
qt_erro_ww   		bigint  	:= 0;
cd_convenio_w		integer;
ie_cih_w		smallint;
k			integer;
cd_motivo_alta_w	smallint := null;
cd_setor_atendimento_w	integer;
cd_classif_setor_w	varchar(10);
ie_obito_w		varchar(10);
cd_estabelecimento_w	bigint;
ie_tipo_conv_conta_w	bigint;
qt_reg_w		bigint;
vl_max_convenio_w	double precision;

cd_convenio_proc_w	integer;
cd_procedimento_w	bigint;
cd_proc_autor_w		bigint;
cd_proc_pacote_w	bigint;
ie_origem_proced_w	bigint;
dt_procedimento_w	timestamp;
qt_procedimento_w	double precision;
tx_procedimento_w	double precision;
cd_tipo_proced_w	smallint;
cd_plano_w		varchar(10);
ds_erro_autorizacao_w	varchar(2000) := '';
ds_erros_autor_w	varchar(2000) := '';
cd_setor_atend_proc_w	integer;
nr_seq_exame_w		bigint;
ie_regra_w		smallint;
ie_consiste_autor_w	varchar(1);
ds_erro_valor_zerado_w	varchar(2000) := '';
qt_proc_sus_unif_w	integer	:= 0;

qt_resp_credito_w	bigint;
qt_estrut_conta_w	bigint;
cd_autorizacao_w	varchar(20);
ie_guia_unica_conta_w	varchar(1):= 'N';
qt_guias_conta_w	integer:= 0;
nr_seq_regra_retorno_w	bigint;
qt_proc_pend_w		bigint;
qt_matmed_conversao_w	bigint := 0;
qt_med_conversao_w	bigint := 1;
qt_mat_conversao_ww	bigint := 1;
qt_mat_conversao_w	bigint := 0;
qt_mat_conversao_opme_w	bigint := 0;
qt_conversao_mat_w	bigint := 0;
qt_proc_conversao_w	bigint := 0;
qt_conversao_proc_w	bigint := 0;
qt_auditoria_w		bigint;
qt_auditoria_ww		bigint;
ie_tipo_guia_w		varchar(05);
ie_exige_tipo_guia_w	varchar(01);
qt_validade_vencida_w	bigint := 0;
dt_validade_carteira_w	timestamp;
qt_conta_aih_unif_w	smallint	:= 0;
nr_seq_proc_interno_w	bigint;
cd_material_opme_w	integer;
nr_sequencia_matopme_w	bigint;
ds_erro_opme_w		bigint;
qt_desconto_w		bigint;

cd_categoria_parametro_w	varchar(20);
cd_convenio_calculo_w	bigint;
cd_categoria_calculo_w	varchar(20);
qt_proc_parto_w		bigint;
qt_nascidos_w		bigint;
ie_clinica_w		integer;
qt_aten_sem_alta_w	bigint;
qt_aten_sem_alta_tiss_w	bigint;
nr_seq_saida_int_w	bigint;
ie_sem_cirurgia_w	varchar(10);
ie_sem_medico_conta_w	varchar(10);
cd_categoria_w		varchar(10);
ie_diaria_margem_pos_w	varchar(1);
qt_desconto_nao_gerado_w	bigint;
qt_proc_w		bigint;
qt_proc_tuss_w		bigint;
qt_proc_princ_w		bigint;
qt_proc_tuss_sem_pac_w	bigint;
ds_email_w		varchar(255);
cd_pessoa_fisica_w	varchar(10);
ie_exige_email_w		varchar(1);
ie_exige_tipo_faturamento_w	varchar(1);
ie_tipo_fatur_tiss_w		varchar(10);
ie_exige_cpf_paciente_w	varchar(1);
ie_exige_passaporte_paciente_w	varchar(1);
ie_consiste_cns_conta_w		varchar(1);
nr_cpf_w			varchar(11);
cd_pessoa_responsavel_w	varchar(10);
qt_itens_pend_devolucao_w	bigint;
qt_existe_w		bigint := 0;

nr_prescricao_w		bigint;
qt_registro_w 		bigint:= 0;
ds_prescricao_w		varchar(4000);
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;
ds_pacote_w		varchar(2000);
nr_identidade_w	varchar(30);
nr_passaporte_w	varchar(255);
cd_material_param_w	varchar(255);
ie_inconsistencia_w	varchar(1);
ie_valor_zerado_w	varchar(1);

qt_existe_ww		bigint := 0;
ie_brasileiro_w		varchar(1);
vl_desconto_w		bigint := 0;
vl_item_w		bigint := 0;
qt_proc_sem_diaria_w	bigint := 0;

dt_atendimento_w		timestamp;
cd_grupo_w			integer	:= 0;
cd_subgrupo_w			integer	:= 0;
cd_classe_w			integer	:= 0;
cd_material_w			integer;
cd_setor_atend_mat_w		integer;
cd_cgc_w			varchar(14);
ie_classificacao_w		varchar(05);
cd_categoria_ww			varchar(10);
cd_tipo_acomodacao_w		bigint;
nr_seq_atepacu_w		bigint;
cd_convenio_mat_w		integer;
qt_conversao_mat_conv_w		bigint;
ie_tipo_material_w		varchar(3);
ie_sexo_w			varchar(10);
qt_nr_dnv_w			bigint;
qt_itens_negociacao_w		bigint;
qt_diarias_w			bigint;
qt_dias_conta_w			bigint;
qt_pendencias_w			bigint;

cd_plano_atend_w		varchar(10);
cd_medico_exec_w		varchar(10);
ie_conversao_mat_w		varchar(1);
qt_cirurgia_bloq_fat_w		bigint;

ie_exige_cpf_doc_estr_w		varchar(1)	:= 'N';

dt_material_w		timestamp;
ds_erros_autor_mat_w	varchar(2000) := '';
ds_aviso_w		varchar(2000) := '';
ds_nao_informada_w	varchar(2000);
ie_regra_mat_w		integer;
qt_material_w		double precision;
ie_bloqueia_agenda_w	varchar(10);
qt_guia_duplic_w	bigint;
cd_autorizacao_ww	varchar(20);
ie_guia_duplic_w	varchar(1) := 'N';
ie_declaracao_obito_w	varchar(5);
qt_pagador_w		bigint;
qt_responsavel_w	bigint;
ie_consistencia_30_w    varchar(1)	:= 'N';
qt_cih_w                bigint;
dia_feriado_w		smallint	:= 0;
ie_feriado_w		varchar(1)	:= 'N';
qt_proc_sus_conta_conv_w	bigint;
ie_carater_inter_sus_w	varchar(2);
qt_mat_nao_simpro_w	bigint;
qt_med_nao_brasindice_w	bigint;
nr_cartao_nac_sus_w	varchar(20);
ie_cartao_correto_w	varchar(1);
qt_exa_depend_sem_aprov_w	bigint;
qt_medico_conv_w	bigint;
qt_existe_rec_w		bigint;
qt_proc_anat_patol_w	bigint;
nr_seq_c04_w		bigint;
ie_codigo_convenio_w	varchar(1);
ie_motivo_p312_w	varchar(15);
qt_mat_tuss_w		bigint;
qt_guia_conta_w		bigint;
qt_senha_guia_w		bigint;
ie_alterar_estagio_w	varchar(1);
qt_mat_tiss_tuss_conv_w	bigint;
nr_seq_estagio_conta_w	conta_paciente.nr_seq_estagio_conta%type;
nr_seq_classif_atend_w	atendimento_paciente.nr_seq_classificacao%type;
qt_proc_regra_sus_w	bigint;
qt_guia_dup_w		bigint;
ie_glosa_w		regra_ajuste_proc.ie_glosa%type;
nr_seq_regra_preco_w	regra_ajuste_proc.nr_sequencia%type;
cd_cnpj_w		convenio.cd_cgc%type;
ie_consiste_regra_ipasgo_w	convenio_estabelecimento.ie_consiste_regra_ipasgo%type;
ie_gerar_unid_compl_w	varchar(15) := 'N';
qt_reg_ipasgo_w		bigint := 0;
nr_seq_conselho_w	bigint := 0;
cd_tipo_tratamento_w	bigint := 0;
cd_tipo_fatura_w	bigint := 0;
nr_doc_convenio_proc_w	bigint := 0;
qt_reg_ipasgo_proc_w	bigint := 0;
qt_taxas_mat_proc_w	bigint := 0;
qt_proced_w		bigint := 0;
qt_diarias_uti_w	bigint := 0;
qt_plantao_uti_w	bigint := 0;
cd_autorizacao_ato_w	bigint := 0;
qt_verifica_proced_w	bigint := 0;
qt_dias_internacao_w	bigint := 0;
qt_proced_classif_diaria_w	bigint := 0;
nr_interno_conta_ww		conta_paciente.nr_interno_conta%type;
ie_tipo_mat_w			varchar(03);
ie_exige_declaracao_w	varchar(1);
ie_resp_brasileiro_w	varchar(1):='N';
ie_consiste_senha_w	varchar(1):='N';
cd_grupo_opme_w		varchar(255);
qt_mat_conversao_opme_manual_w	bigint := 0;
nr_seq_mat_simp_w	material_atend_paciente.nr_seq_mat_simp%type;
ie_valor_de_venda_maior_W	varchar(1) := 'N';
ie_exige_documento_w	funcao_param_usuario.vl_parametro%type;
ie_material_regulado_w	varchar(1);
nr_seq_tipo_doc_id_w	pessoa_fisica_aux.nr_seq_tipo_doc_identificacao%type;
cd_nacionalidade_w	pessoa_fisica.cd_nacionalidade%type;
cd_nationality_w	rule_regulated_price.cd_nationality%type;
vl_max_sale_w	rule_regulated_price.vl_max_sale%type;
vl_unitario_w	material_atend_paciente.vl_unitario%type;
nm_usuario_w  usuario.nm_usuario%type;
qt_prescr_mipres_w    bigint := 0;

c01 CURSOR FOR
SELECT	a.ie_tipo_convenio
from	convenio a
where	a.cd_convenio in (	select	distinct(b.cd_convenio)
			from	atend_categoria_convenio b
			where	b.nr_atendimento = nr_atendimento_p);

c02 CURSOR FOR
SELECT	a.cd_convenio,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.dt_procedimento,
	a.qt_procedimento,
	a.cd_setor_atendimento,
	a.nr_seq_exame,
	a.nr_seq_proc_interno,
	a.cd_medico_executor
from	procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	ie_consiste_autor_w	= 'S';

c03 CURSOR FOR
	SELECT	b.nr_prescricao
	from	prescr_procedimento b,
		prescr_medica	a
	where	a.nr_atendimento = nr_atendimento_p
	and	b.nr_prescricao = a.nr_prescricao
	and 	a.dt_prescricao between dt_periodo_inicial_w and dt_periodo_final_w
	and	b.cd_motivo_baixa = 0
	
union all

	SELECT	b.nr_prescricao
	from	prescr_material	b,
		prescr_medica	a
	where	a.nr_atendimento = nr_atendimento_p
	and	b.nr_prescricao = a.nr_prescricao
	and 	a.dt_prescricao between dt_periodo_inicial_w and dt_periodo_final_w
	and	b.cd_motivo_baixa = 0
	group by b.nr_prescricao;


c04 CURSOR FOR
	SELECT	a.cd_grupo_material,
		a.cd_subgrupo_material,
		a.cd_classe_material,
		a.cd_material,
		a.ie_tipo_material,
		b.dt_atendimento,
		b.cd_setor_atendimento,
		b.cd_convenio,
		coalesce(b.cd_cgc_fornecedor,'0') cd_cgc_fornecedor,
		b.cd_categoria,
		b.nr_seq_atepacu,
		b.nr_sequencia,
		b.vl_unitario
	from 	estrutura_material_v a,
		material_atend_paciente b
	where 	a.cd_material = b.cd_material
	and	b.nr_interno_conta = nr_interno_conta_p;

c05 CURSOR FOR
SELECT	a.cd_convenio,
	a.cd_material,
	a.dt_atendimento,
	a.qt_material,
	a.cd_setor_atendimento,
	a.nr_seq_mat_simp
from	material_atend_paciente a
where	a.nr_interno_conta		= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	ie_consiste_autor_w		= 'S';

c06 CURSOR FOR
	SELECT	count(*),
			cd_autorizacao
	from	tiss_conta_guia
	where	nr_interno_conta = nr_interno_conta_p
	and		(cd_autorizacao IS NOT NULL AND cd_autorizacao::text <> '')
	group	by cd_autorizacao;


BEGIN

nm_usuario_w := 'Tasy';

if (wheb_usuario_pck.get_nm_usuario IS NOT NULL AND wheb_usuario_pck.get_nm_usuario::text <> '') then
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
end if;

nr_atendimento_w	:= nr_atendimento_p;
nr_interno_conta_w	:= nr_interno_conta_w;

select 	ie_tipo_atendimento,
	coalesce(dt_alta,to_date('01/01/1900 00:00:00','dd/mm/yyyy hh24:mi:ss')),
	dt_entrada,
	ie_tipo_convenio,
	a.cd_convenio_parametro,
	b.cd_motivo_alta,
	coalesce(a.cd_estabelecimento, b.cd_estabelecimento),
	cd_autorizacao,
	a.ie_tipo_guia,
	a.cd_categoria_parametro,
	a.cd_convenio_calculo,
	a.cd_categoria_calculo,
	b.ie_clinica,
	a.ie_tipo_fatur_tiss,
	ie_carater_inter_sus,
	b.nr_seq_classificacao
into STRICT 	ie_tipo_atendimento_w,
	dt_alta_w,
	dt_entrada_w,
	ie_tipo_convenio_w,
	cd_convenio_w,
	cd_motivo_alta_w,
	cd_estabelecimento_w,
	cd_autorizacao_w,
	ie_tipo_guia_w,
	cd_categoria_parametro_w,
	cd_convenio_calculo_w,
	cd_categoria_calculo_w,
	ie_clinica_w,
	ie_tipo_fatur_tiss_w,
	ie_carater_inter_sus_w,
	nr_seq_classif_atend_w
from 	atendimento_paciente b,
	conta_paciente a
where 	a.nr_atendimento 	= b.nr_atendimento
and 	a.nr_interno_conta 	= nr_interno_conta_p;

select	ie_tipo_convenio,
	ie_consiste_autor,
	ie_exige_tipo_guia
into STRICT	ie_tipo_conv_conta_w,
	ie_consiste_autor_w,
	ie_exige_tipo_guia_w
from	convenio
where	cd_convenio	= cd_convenio_w;

select	coalesce(max(ie_exige_email),'N'),
	coalesce(max(ie_exige_tipo_faturamento),'N'),
	coalesce(max(ie_exige_cpf_paciente),'N'),
	coalesce(max(ie_exige_passaporte_paciente),'N'),
	coalesce(max(ie_consiste_cns_conta),'N'),
	coalesce(max(ie_consiste_regra_ipasgo),'N')
into STRICT	ie_exige_email_w,
	ie_exige_tipo_faturamento_w,
	ie_exige_cpf_paciente_w,
	ie_exige_passaporte_paciente_w,
	ie_consiste_cns_conta_w,
	ie_consiste_regra_ipasgo_w
from	convenio_estabelecimento
where	cd_convenio	= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(max(ie_obito),'N'),
		coalesce(max(ie_motivo_p312),'AL'),
		coalesce(max(ie_exige_declaracao),'N')
into STRICT	ie_obito_w,
		ie_motivo_p312_w,
		ie_exige_declaracao_w
from	motivo_alta
where	cd_motivo_alta	= cd_motivo_alta_w;

SELECT * FROM consiste_atendimento(nr_atendimento_w, qt_processo_pendente_w, ds_erro_atend_w) INTO STRICT qt_processo_pendente_w, ds_erro_atend_w;

/*
 Portaria n 312  de 02 de Maio de 2002.
2.1.10 - Transferencia externa
Mudanca de um paciente de um hospital para outro.
*/
if (cd_motivo_alta_w IS NOT NULL AND cd_motivo_alta_w::text <> '') and
	(ie_obito_w = 'N' AND ie_motivo_p312_w <> 'TE') then
	begin

	begin
	cd_setor_atendimento_w	:= obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS');
	exception
	when others then
		cd_setor_atendimento_w	:= null;
	end;

	select	cd_classif_setor
	into STRICT	cd_classif_setor_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;

	if (cd_classif_setor_w	= '4') then
		ds_erro_uti_w	:= '35 ';
	end if;

	exception
	when others then
		ds_erro_uti_w	:= '';
	end;
end if;

if (ie_tipo_convenio_w	= 3) and (ie_tipo_atendimento_w	<> 1) then
	select	count(1)
	into STRICT	qt_reg_w
	from	procedimento_paciente a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	sus_obter_tiporeg_proc(cd_procedimento, ie_origem_proced, 'C', 1) = 2
	and	not exists (	SELECT	1
					from	sus_bpa_unif	x
					where	x.nr_interno_conta	= a.nr_interno_conta)  LIMIT 1;


	if (qt_reg_w	> 0) then
		ds_erro_w	:= ds_erro_w	||'290 ';
	end if;
end if;

begin
ds_erro_guia_w	:= obter_pendencia_guia_atend(nr_atendimento_p);
exception
when others then
	ds_erro_guia_w	:= null;
end;

ds_erro_guia_w		:= replace(ds_erro_guia_w, '32 ', ''); /* edgar 03/09/2004, os 10914, segundo marcus nao e consitencia da conta */
ds_erro_guia_w		:= replace(ds_erro_guia_w, '302 ', ''); /* felipe 12/03/2007, os 52241 e 52319, estava filtrando por atendimento, mas deve ser por

conta */
begin
ie_consiste_senha_w :=consiste_exigencia_senha(nr_interno_conta_p);

if (ie_consiste_senha_w = 'S') then
	ds_erro_w := ds_erro_w|| '3074 ';
end if;
exception
when others then
	ie_consiste_senha_w:='N';
end;

cd_pessoa_fisica_w	:= obter_pessoa_atendimento(nr_atendimento_p,'C');
ds_email_w		:= coalesce(obter_compl_pf(cd_pessoa_fisica_w,1,'M'),obter_compl_pf(cd_pessoa_fisica_w,2,'M'));

if (ie_exige_email_w = 'S') and (coalesce(ds_email_w::text, '') = '') then
	ds_erro_w	:= ds_erro_w	||'48 ';
end if;

if (ie_exige_tipo_faturamento_w	= 'S') and (coalesce(ie_tipo_fatur_tiss_w::text, '') = '') then
	ds_erro_w	:= ds_erro_w	||'49 ';
end if;

select	max(ie_sexo),
	max(nr_cartao_nac_sus)
into STRICT	ie_sexo_w,
	nr_cartao_nac_sus_w
from 	pessoa_fisica
where 	cd_pessoa_fisica	= cd_pessoa_fisica_w;

if (ie_sexo_w	= 'I') then
	ds_erro_w	:= ds_erro_w	|| '2182 ';
end if;

if (ie_consiste_cns_conta_w = 'S') then
	begin


	if (coalesce(nr_cartao_nac_sus_w,'0') = '0') then
		ds_erro_w	:= ds_erro_w || '2126 ';
	end if;

	if (coalesce(nr_cartao_nac_sus_w,'0') <> '0') then
		begin
		ie_cartao_correto_w:= 'S';
		begin
		select   consistir_digito('CARTAOSUS', nr_cartao_nac_sus_w)
		into STRICT 	 ie_cartao_correto_w
		;
		exception
		when others then
			ie_cartao_correto_w := 'N';
		end;


		if (ie_cartao_correto_w = 'N') then
			ds_erro_w	:= ds_erro_w || '2126 ';
		end if;
		end;
	end if;


	end;
end if;

if (ie_exige_passaporte_paciente_w = 'R') then
	ie_exige_cpf_paciente_w	:= 'N';
end if;

-- Fabricio em 21/04/2009 OS 138407
if (ie_exige_cpf_paciente_w	= 'S') then

	select 	coalesce(max(cd_pessoa_responsavel),'0')
	into STRICT	cd_pessoa_responsavel_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_p;


	select	count(1)
	into STRICT	qt_existe_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	(nr_cpf IS NOT NULL AND nr_cpf::text <> '')
	and	((coalesce(cd_nacionalidade::text, '') = '') or (obter_se_brasileiro(cd_pessoa_fisica) = 'S'));

	select	count(1)
	into STRICT	qt_existe_ww
	from 	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_responsavel_w
	and	(nr_cpf IS NOT NULL AND nr_cpf::text <> '')
	and	((coalesce(cd_nacionalidade::text, '') = '') or (obter_se_brasileiro(cd_pessoa_fisica) = 'S'));

	begin
	ie_brasileiro_w	:= obter_se_brasileiro(cd_pessoa_fisica_w);
	exception
	when others then
		ie_brasileiro_w	:= 'N';
	end;


	if (ie_brasileiro_w = 'N') and (cd_pessoa_responsavel_w <> '0') then
		begin
		ie_brasileiro_w	:= obter_se_brasileiro(cd_pessoa_responsavel_w);
		exception
		when others then
			ie_brasileiro_w	:= 'N';
		end;
	end if;


	if (ie_brasileiro_w = 'S') and (qt_existe_w = 0) and (qt_existe_ww = 0) then
		ds_erro_w	:= ds_erro_w	|| '2041 ';
	end if;
/*	select 	max(nr_cpf)
	into	nr_cpf_w
	from 	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_fisica_w;
	--Se nao tem o CPF informado para o paciente, verifica-se o responsavel tem
	if	(nr_cpf_w is null) then
		select 	max(cd_pessoa_responsavel)
		into	cd_pessoa_responsavel_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_p;
		if	(cd_pessoa_responsavel_w is not null) then
			select 	max(nr_cpf)
			into	nr_cpf_w
			from 	pessoa_fisica
			where 	cd_pessoa_fisica = cd_pessoa_responsavel_w;
		end if;
	end if;
	if 	(nr_cpf_w is null) then
		ds_erro_w	:= ds_erro_w	|| '2041 ';
	end if;*/
end if;

if (ie_exige_passaporte_paciente_w	= 'S') then
	select 	coalesce(max(cd_pessoa_responsavel),'0')
	into STRICT	cd_pessoa_responsavel_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_p;


	select	count(1)
	into STRICT	qt_existe_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	coalesce(nr_cpf::text, '') = ''
	and	obter_se_brasileiro(cd_pessoa_fisica) <> 'S';

	select	count(1)
	into STRICT	qt_existe_ww
	from 	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_responsavel_w
	and	coalesce(nr_cpf::text, '') = ''
	and	obter_se_brasileiro(cd_pessoa_fisica) <> 'S';


	begin
	ie_brasileiro_w	:= obter_se_brasileiro(cd_pessoa_fisica_w);
	exception
	when others then
		ie_brasileiro_w	:= 'N';
	end;


	if (ie_brasileiro_w = 'S') and (cd_pessoa_responsavel_w <> '0') then
		begin
		ie_brasileiro_w	:= obter_se_brasileiro(cd_pessoa_responsavel_w);
		exception
		when others then
			ie_brasileiro_w	:= 'N';
		end;
	end if;

	if (ie_brasileiro_w = 'N') and ((qt_existe_w > 0) or (qt_existe_ww > 0)) then


		select 	coalesce(max(nr_reg_geral_estrang),'0'),
			coalesce(max(nr_passaporte),'0')
		into STRICT	nr_identidade_w,
			nr_passaporte_w
		from 	pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w
		and	coalesce(nr_cpf::text, '') = ''
		and	obter_se_brasileiro(cd_pessoa_fisica) <> 'S';


		--Se nao tem o passaporte/Rg informado para o paciente, verifica-se o responsavel tem
		if (nr_identidade_w = '0') and (nr_passaporte_w = '0') and (cd_pessoa_responsavel_w <> '0') then


			select 	coalesce(max(nr_reg_geral_estrang),'0'),
				coalesce(max(nr_passaporte),'0')
			into STRICT	nr_identidade_w,
				nr_passaporte_w
			from 	pessoa_fisica
			where 	cd_pessoa_fisica = cd_pessoa_responsavel_w
			and	coalesce(nr_cpf::text, '') = ''
			and	obter_se_brasileiro(cd_pessoa_fisica) <> 'S';


		end if;

		-- 751030
		-- se o paciente e estrangeiro e o responsavel brasileiro
		-- deve verificar se o responsavel tem CPF, pois o resp brasileiro nao vai ter RG Estrangeiro ou Passaporte
		-- a consistencia do CPF e feita pela 2041
		ie_resp_brasileiro_w:='N';
		if (obter_se_brasileiro(cd_pessoa_fisica_w) = 'N') and --Paceente estrangeiro
		    (obter_se_brasileiro(cd_pessoa_responsavel_w) = 'S') and  -- Responsavel brasileiro
		    (nr_identidade_w  = '0') and (nr_passaporte_w = '0') then -- Nenhum tem RG Estr/Passaporte
		    ie_resp_brasileiro_w:= 'S';
		end if;


		if (nr_identidade_w  = '0') and (nr_passaporte_w = '0') and (ie_resp_brasileiro_w = 'N') then
			ds_erro_w := ds_erro_w|| '3005 ';
		end if;
	end if;
end if;

if (ie_exige_passaporte_paciente_w	= 'R') then

	select	obter_se_exige_cpf_doc_estr(nr_atendimento_p)
	into STRICT	ie_exige_cpf_doc_estr_w
	;


	if (ie_exige_cpf_doc_estr_w = 'S') then
		ds_erro_w := ds_erro_w || '3010 ';
	end if;
end if;

if (obter_funcao_ativa = 99071) then
    cd_material_param_w := obter_valor_param_usuario(99071, 25, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento);
else
	cd_material_param_w := obter_valor_param_usuario(67, 394, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento);
end if;



if ((cd_material_param_w)::numeric  <> 0) then
	select	count(1)
	into STRICT	qt_existe_w
	from	material_atend_paciente
	where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;


	if (qt_existe_w > 0) then
		select	coalesce(max('N'),'S')
		into STRICT	ie_inconsistencia_w
		from	material_atend_paciente a
		where	a.nr_interno_conta = nr_interno_conta_p
		and	substr(obter_estrutura_material(a.cd_material, 'G'),1,10) = cd_material_param_w
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and 	coalesce(a.dt_acerto_convenio::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote::text, '') = ''

		and	not exists (
			SELECT	1
			from	mat_atend_paciente_opme x
			where	x.nr_seq_material = a.nr_sequencia);


		if (ie_inconsistencia_w = 'N') then
			ds_erro_w := ds_erro_w || '3006 ';
		end if;

	end if;

else
	select	count(1)
	into STRICT	qt_existe_w
	from	material_atend_paciente
	where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;


	if (qt_existe_w > 0) then
		select	coalesce(max('N'),'S')
		into STRICT	ie_inconsistencia_w
		from	material_atend_paciente a
		where	a.nr_interno_conta = nr_interno_conta_p
		and	ie_opme = 'S'
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and 	coalesce(a.dt_acerto_convenio::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote::text, '') = ''
		and	not exists (
				SELECT	1
				from	mat_atend_paciente_opme x
				where	x.nr_seq_material = a.nr_sequencia);


		if (ie_inconsistencia_w = 'N') then
			ds_erro_w := ds_erro_w || '3006 ';
		end if;



	end if;
end if;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	select	coalesce(max('S'),'N')
	into STRICT	ie_valor_zerado_w
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	vl_material = 0
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	obter_dados_material(cd_material, 'CON') = '1';


	if (ie_valor_zerado_w = 'S') then
		ds_erro_w := ds_erro_w || '3007 ';
	end if;
end if;

select	max(a.cd_procedimento)
into STRICT	cd_procedimento_w
from	procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	obter_classificacao_proced(cd_procedimento,ie_origem_proced,'C')	= '1'
and	coalesce(coalesce(a.cd_medico_executor,a.cd_pessoa_fisica)::text, '') = '';

if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then
	ds_erro_w := ds_erro_w	|| '29 ';
end if;

select	count(1)
into STRICT	qt_proc_pend_w
from	convenio c,
	procedimento_paciente b,
	conta_paciente a
where	a.nr_atendimento	= nr_atendimento_p
and	a.nr_interno_conta	= nr_interno_conta_p
and	a.nr_interno_conta	= b.nr_interno_conta
and	a.cd_convenio_parametro	= c.cd_convenio
and	c.ie_tipo_convenio	<> 1
and	b.cd_situacao_glosa	<> 0
and	a.ie_status_acerto	= 1
and	coalesce(b.nr_doc_convenio::text, '') = ''  LIMIT 1;

if (qt_proc_pend_w > 0) then
	ds_erro_w	:= ds_erro_w || '302 ';

else
	select	count(1)
	into STRICT	qt_proc_pend_w
	from	convenio c,
		material_atend_paciente b,
		conta_paciente a
	where	a.nr_atendimento	= nr_atendimento_p
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	a.cd_convenio_parametro	= c.cd_convenio
	and	c.ie_tipo_convenio	<> 1
	and	b.cd_situacao_glosa	<> 0
	and	a.ie_status_acerto	= 1
	and	coalesce(b.nr_doc_convenio::text, '') = ''  LIMIT 1;

	if (qt_proc_pend_w > 0) then
		ds_erro_w	:= ds_erro_w || '302 ';
	end if;
end if;

if (coalesce(cd_categoria_parametro_w::text, '') = '') then
	ds_erro_w	:= ds_erro_w || '603 ';
end if;

if (coalesce(cd_categoria_calculo_w::text, '') = '') or (coalesce(cd_convenio_calculo_w::text, '') = '') then
	ds_erro_w	:= ds_erro_w || '604 ';
end if;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	select	count(1)
	into STRICT	qt_itens_negociacao_w
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and 	substr(obter_se_negociado(nr_sequencia),1,1) = 'S'
	and	coalesce(nr_seq_proc_pacote::text, '') = ''  LIMIT 1;


	if (qt_itens_negociacao_w > 0) then
		ds_erro_w := ds_erro_w || '50 ';
	end if;
end if;


begin
select	count(1)
into STRICT	qt_auditoria_w
from	auditoria_conta_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(a.dt_liberacao::text, '') = ''  LIMIT 1;
exception
when others then
	qt_auditoria_w	:= 0;
end;

if (qt_auditoria_w > 0) then
	ds_erro_w	:= ds_erro_w || '917 ';
end if;


/* identificar as contas com data de proc/mat fora do periodo de atendimento */

ds_proc_com_erro_w	:= '';
select '('||to_char(max(b.cd_item))||') '
into STRICT	ds_proc_com_erro_w
from	atendimento_paciente a,
       	conta_paciente_consiste_v b
where	b.nr_atendimento = a.nr_atendimento
and	b.dt_conta not between a.dt_entrada and coalesce(a.dt_alta,clock_timestamp())
and	b.nr_atendimento =  nr_atendimento_p
and	b.nr_interno_conta = nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = '';
if (ds_proc_com_erro_w <> '() ') then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '20 ';
end if;


ds_proc_com_erro_w	:= '';
select '('||to_char(max(b.cd_item))||') '
into STRICT	ds_proc_com_erro_w
from	conta_paciente_consiste_v b,
	conta_paciente a
where	b.dt_conta not between a.dt_periodo_inicial and dt_periodo_final
and	b.nr_interno_conta = nr_interno_conta_p
and	a.nr_interno_conta = nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = '';
if (ds_proc_com_erro_w <> '() ') then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '21 ';
end if;

select	coalesce(count(1),0)
into STRICT	qt_erro_w
from	conta_paciente_consiste_v
where	nr_interno_conta 		= nr_interno_conta_p
and	coalesce(vl_item,0) 		= 0
and	coalesce(vl_medico,0)		= 0
and	coalesce(vl_custo_operacional,0)	= 0
and	coalesce(vl_anestesista,0)	= 0
and	coalesce(vl_auxiliares,0)		= 0  LIMIT 1;

if (qt_erro_w > 0) then
	ds_erro_proc_w := consiste_valor_conta(nr_interno_conta_p, ds_erro_proc_w, 'N');
end if;

select	coalesce(count(1),0)
into STRICT	qt_erro_w
from	conta_paciente_consiste_v
where	nr_interno_conta 	= nr_interno_conta_p
and	coalesce(vl_item,0) 	= 0
and	ie_proc_mat 	= 2  LIMIT 1;

if (qt_erro_w > 0) and (ie_tipo_convenio_w <> 3) then
	ds_erro_mat_w := consiste_valor_conta_mat(nr_interno_conta_p, ds_erro_mat_w);
end if;

select	coalesce(count(1),0)
into STRICT	qt_erro_w
from	conta_paciente_consiste_v
where	nr_interno_conta 	= nr_interno_conta_p
and	coalesce(vl_item,0) 	= 0
and	ie_proc_mat 	= 1  LIMIT 1;

if (qt_erro_w > 0) and (ie_tipo_convenio_w <> 3) then
	ds_erro_procedimento_w := consiste_valor_conta_proc(nr_interno_conta_p, ds_erro_procedimento_w);
end if;


ds_proc_com_erro_w	:= '';
select '('||max(cd_item) || ') '
into STRICT	ds_proc_com_erro_w
from	conta_paciente_consiste_v
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(nr_doc_convenio::text, '') = '';
if (ds_proc_com_erro_w <> '() ') then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '23 ';
end if;


/* identificar as procedimentos de medicos residentes */

ds_proc_com_erro_w	:= '';

select 	'('||to_char(max(a.cd_procedimento))||') '
into STRICT	ds_proc_com_erro_w
from 	medico b, procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	a.cd_medico_executor	= b.cd_pessoa_fisica
and 	b.ie_vinculo_medico	= 3;
if (ds_proc_com_erro_w <> '() ') then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '24'||ds_proc_com_erro_w;
end if;

select	count(1)
into STRICT	qt_reg_w
from	procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	coalesce(cd_motivo_exc_conta::text, '') = ''  LIMIT 1;

if (qt_reg_w = 0) then
	ds_erro_w := ds_erro_w || '918 ';
end if;


select 	count(1)
into STRICT	qt_reg_w
from 	declaracao_obito
where	nr_atendimento		= nr_atendimento_p  LIMIT 1;

select 	coalesce(max(ie_declaracao_obito),'XX')
into STRICT	ie_declaracao_obito_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

if (qt_reg_w = 0) and (cd_motivo_alta_w IS NOT NULL AND cd_motivo_alta_w::text <> '') and (ie_obito_w = 'S') and (ie_exige_declaracao_w = 'S') and
	((ie_declaracao_obito_w = 'XX') or (ie_declaracao_obito_w = 'M'))	then
	ds_erro_w := ds_erro_w || '2251 ';
end if;


/* identificar se o medico executor esta definido como prestador no cadastro de medicos */

qt_erro_ww	:= 0;

begin
select 	count(1)
into STRICT	qt_erro_ww
from 	procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	(a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '')
and	not exists ( 	SELECT 	1
			from 	medico b
			where	a.cd_medico_executor	= b.cd_pessoa_fisica
			and 	b.ie_vinculo_medico	= 5	)  LIMIT 1;
exception
when others then
	qt_erro_ww := 0;
end;

if (qt_erro_ww <> 0) then
	ds_erro_w := ds_erro_w || '38 ';
end if;

/* identificar itens que tenham o valor negativo */

/* ricardo 23/03/2004 - inclui a linha do teste do pacote no sql abaixo para mostrar a consistencia apenas dos que

nao sao pacotes*/
ds_proc_com_erro_w	:= '';

begin
select	count(*),
	'('||max(ie_proc_mat||cd_item)||') '
into STRICT	qt_erro_w,
	ds_proc_com_erro_w
from (	SELECT 	to_char(a.cd_item) cd_item,
		count(*),
		max(CASE WHEN a.ie_proc_mat=1 THEN 'P.'  ELSE 'M.' END ) ie_proc_mat
	from	conta_paciente_consiste_v  a,
		conta_paciente b
	where	a.nr_interno_conta 	= nr_interno_conta_p
	and 	a.nr_interno_conta = b.nr_interno_conta
	and	coalesce(a.nr_seq_proc_pacote,a.nr_sequencia) 	= a.nr_sequencia
	and 	coalesce(b.ie_cancelamento::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	group by a.cd_item
	having sum(coalesce(a.vl_unitario * a.qt_item,0)) < 0) alias10;
exception
	when others then
		qt_erro_w := 0;
end;


select	count(1)
into STRICT	qt_desconto_w
from	conta_paciente_desconto
where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

if (qt_desconto_w = 0) and (qt_erro_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '25'||ds_proc_com_erro_w;
end if;

/* identificar itens que tenham o valor negativo */

/* Heckmann 27/11/2009 - consistencia criada para verificacao se existe itens negativos na conta, apenas dos que nao sao pacotes*/

ds_proc_mat_erro_w	:= '';
begin
select	count(*),
	'('||max(ie_proc_mat||cd_item)||') '
into STRICT	qt_erro_w,
	ds_proc_mat_erro_w
from (	SELECT 	to_char(a.cd_item) cd_item,
		count(*),
		max(CASE WHEN a.ie_proc_mat=1 THEN 'P.'  ELSE 'M.' END ) ie_proc_mat
	from	conta_paciente_consiste_v a,
		conta_paciente b
	where	a.nr_interno_conta 			= nr_interno_conta_p
	and 	a.nr_interno_conta = b.nr_interno_conta
	and	coalesce(a.nr_seq_proc_pacote,a.nr_sequencia) 	= a.nr_sequencia
	and 	coalesce(b.ie_cancelamento::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.vl_item < 0
	group by a.cd_item) alias8;
exception
	when others then
		qt_erro_w := 0;
end;


select	count(1)
into STRICT	qt_desconto_w
from	conta_paciente_desconto
where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

if (qt_desconto_w = 0) and (qt_erro_w > 0) then
	ds_erro_w	:= ds_erro_w || '2254 ';
end if;

-- identificar se algum centro de custo esta com o valor negativo
-- dbolognini 30/03/2015 - OS 831633 - Inicio
-- tdpaula 27/11/2015 - OS 922510 ajuste para nao considerar os intes do pacote, esta mesma restricao ja existe na consistencia 25
begin
select	count(*)
into STRICT	qt_erro_w
from (	SELECT 	a.cd_setor_atendimento,
		a.cd_item,
		sum(a.vl_item)
	from	conta_paciente_consiste_v a,
		conta_paciente b
	where	a.nr_interno_conta = nr_interno_conta_p
	and 	a.nr_interno_conta = b.nr_interno_conta
	and 	coalesce(b.ie_cancelamento::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,a.nr_sequencia) 	= a.nr_sequencia
	group by a.cd_setor_atendimento,
		   a.cd_item
	having sum(a.vl_item) < 0) alias6;
exception
	when others then
		qt_erro_w := 0;
end;

select	count(1)
into STRICT	qt_desconto_w
from	conta_paciente_desconto
where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

if (qt_desconto_w = 0) and (qt_erro_w > 0) then
	ds_erro_w	:= ds_erro_w || '55 ';
end if;

-- dbolognini 30/03/2015 - OS 831633 - Fim
/* ricardo 17/11/2005 - incluida a consistencia abaixo para buscar os itens devolvidos com problema de arredondamento os25937 */

begin
select	count(*)
into STRICT	qt_erro_w
from (	SELECT cd_item, count(*)
	from	conta_paciente_consiste_v
	where	nr_interno_conta 			= nr_interno_conta_p
	and	coalesce(nr_seq_proc_pacote,nr_sequencia) 	= nr_sequencia
	and 	coalesce(cd_motivo_exc_conta::text, '') = ''
	group by cd_item
	having(sum(coalesce(vl_item,0)) > 0) and (sum(coalesce(qt_item,0)) = 0)) alias10;
exception
	when others then
		qt_erro_w := 0;
end;

if (qt_erro_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '28 ';
end if;

/* Fabricio 14/05/2013 - incluida a consistencia abaixo para buscar os itens devolvidos com problema de arredondamento*/

begin
select	count(*)
into STRICT	qt_erro_w
from (	SELECT cd_item, count(*)
	from	conta_paciente_consiste_v
	where	nr_interno_conta 			= nr_interno_conta_p
	and	coalesce(nr_seq_proc_pacote,nr_sequencia) 	= nr_sequencia
	and 	coalesce(cd_motivo_exc_conta::text, '') = ''
	group by cd_item
	having(sum(coalesce(vl_item,0)) < 0) and (sum(coalesce(qt_item,0)) = 0)) alias10;
exception
	when others then
		qt_erro_w := 0;
end;

if (qt_erro_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '52 ';
end if;

/* identificar itens que tenham o valor zerado ou nao tem na ultima tabela */

/* adelson 15/09/2004 - estes procedimentos nao sao emitidos no resumo do bpa */

ds_proc_com_erro_w	:= '';
select '('||to_char(max(b.cd_procedimento))||') '
into STRICT	ds_proc_com_erro_w
from   procedimento_paciente b
where  b.nr_interno_conta      = nr_interno_conta_p
and    b.ie_origem_proced      = 3
and    not exists
   (SELECT 1
   from    sus_preco_procbpa x
   where   x.cd_procedimento       = b.cd_procedimento
   and     x.ie_origem_proced      = b.ie_origem_proced
   and     x.dt_competencia =
           (select max(y.dt_competencia)
           from sus_preco_procbpa y)
   and (x.vl_honorario_medico + x.vl_matmed + x.vl_procedimento) > 0);
if (ds_proc_com_erro_w <> '() ') then
	ds_erro_w	:= ds_erro_w || '508'||ds_proc_com_erro_w;
end if;
qt_erro_w	:= 0;


/* identificar se todos os Procedimentos de Diagnostico na prescricao estao sem Laudo */

select     /*+ index(a propaci_compaci_i) */   coalesce(count(*),0)
into STRICT	qt_proc_sem_laudo_w
from  procedimento b,
   	procedimento_paciente a
where nr_interno_conta		= nr_interno_conta_p
  and a.cd_procedimento		= b.cd_procedimento
  and a.ie_origem_proced 	= b.ie_origem_proced
  and coalesce(ie_exige_laudo,'N') = 'S'
  and not exists (SELECT 1 from laudo_paciente x
                  where a.nr_sequencia = x.nr_seq_proc)
  and not exists (select 1 from laudo_paciente x
                  where a.nr_prescricao = x.nr_prescricao)
  and not exists (select 1 from laudo_paciente x
                  where a.nr_laudo = x.nr_sequencia)
 and  coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;
if (qt_proc_sem_laudo_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '6 ';
end if;
/* fim */

/* identificar se existe um ou mais procedimentos de diagnostico sem laudo */

/* Joao Vitor MR - OS 1457926 - 03/OUT/2017 */

select     /*+ index(a propaci_compaci_i) */ count(*)
into STRICT	qt_proc_sem_laudo_w
from  procedimento b,
   	procedimento_paciente a
where nr_interno_conta		= nr_interno_conta_p
  and a.cd_procedimento		= b.cd_procedimento
  and a.ie_origem_proced 	= b.ie_origem_proced
  and coalesce(ie_exige_laudo,'N') = 'S'
  and not exists (SELECT 1 from laudo_paciente x
                  where a.nr_sequencia = x.nr_seq_proc)
  and not exists (select 1 from laudo_paciente x
                  where a.nr_laudo = x.nr_sequencia)
 and  coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;
if (qt_proc_sem_laudo_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '3075 ';
end if;
/* fim */

select	coalesce(max(qt),0)
into STRICT	qt_proc_laudo_nao_lib_w
from (
	SELECT	1 qt
	from    procedimento_paciente a,
		laudo_paciente b
	where	a.nr_sequencia = b.nr_seq_proc
	and	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(b.dt_cancelamento::text, '') = ''
	and	coalesce(b.dt_liberacao::text, '') = ''
	
union all

	SELECT	1 qt
	from    procedimento_paciente a,
		laudo_paciente b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(b.dt_cancelamento::text, '') = ''
	and	coalesce(b.dt_liberacao::text, '') = '' 
	 LIMIT 1) alias6;
	
if (qt_proc_laudo_nao_lib_w > 0) then
	ds_erro_laudo_w	:= ds_erro_laudo_w || '2264 ';
end if;


/* validar se o pacote foi rateado */

begin
select	coalesce(max(nr_seq_proc_pacote),0)
into STRICT	nr_seq_proc_pacote_w
from	conta_paciente_v
where	nr_interno_conta = nr_interno_conta_p
and 	(nr_seq_proc_pacote IS NOT NULL AND nr_seq_proc_pacote::text <> '')
and	coalesce(cd_motivo_exc_conta::text, '') = ''
having	sum(CASE WHEN nr_seq_proc_pacote=nr_sequencia THEN vl_item  ELSE 0 END ) <>
sum(CASE WHEN nr_seq_proc_pacote=nr_sequencia THEN 0  ELSE vl_item END );
exception
	when no_data_found then
		nr_seq_proc_pacote_w := 0;
end;


select	count(1)
into STRICT	qt_desconto_w
from	conta_paciente_desconto
where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

if (nr_seq_proc_pacote_w <> 0) and (qt_desconto_w = 0) then
	--tdpaula 20/11/2009 - OS 179179
	select	coalesce(max(b.cd_procedimento),0)
	into STRICT	cd_proc_pacote_w
	from  	atendimento_pacote a,
		procedimento_paciente b
	where 	a.nr_seq_procedimento = b.nr_sequencia
	and   	b.nr_seq_proc_pacote = nr_seq_proc_pacote_w;


	ds_erro_conta_w	:= ds_erro_conta_w	||'7(Proc:'|| cd_proc_pacote_w ||') ';
	--ds_erro_conta_w	:= ds_erro_conta_w || '7 ';
end if;

if (ie_tipo_convenio_w = 3) and (ie_tipo_conv_conta_w = 3) and (cd_convenio_w = obter_dados_param_faturamento(cd_estabelecimento_w,'CSUS')) then
	CALL sus_consiste_conta(nr_interno_conta_p,nr_atendimento_p,nm_usuario_w);
end if;

if (ie_tipo_convenio_w in (1,2,5,6,7,8,9)) then
	ds_erro_cid_w := consiste_cid_atend_convenio(nr_atendimento_p, ds_erro_cid_w);
end if;

if (ie_tipo_convenio_w <> 3)	then
	ds_erro_valor_w := consiste_valor_informado(nr_interno_conta_p, ds_erro_valor_w);
	if (ie_tipo_atendimento_w = 1) then
		select count(*)
		into STRICT ie_cih_w
		from procedimento_paciente_cih
		where nr_atendimento = nr_atendimento_p;

		if (ie_cih_w = 0) then
			ie_consistencia_30_w := 'S';
			ds_erro_w := ds_erro_w || '30 ';
		end if;
	end if;
end if;

if (ie_consistencia_30_w = 'N') then

	select count(*)
	into STRICT qt_cih_w
	from procedimento_paciente_cih
	where nr_atendimento = nr_atendimento_p;

	if (qt_cih_w = 0) then
		ds_erro_w := ds_erro_w || '3015 ';
	end if;
end if;

/* elemar em 15/03/2004 */

if (ie_tipo_convenio_w = 4) then
	begin
	ds_proc_com_erro_w	:= '';
	select '('||to_char(max(a.cd_procedimento))||') '
	into STRICT	ds_proc_com_erro_w
	from	procedimento_paciente a
	where a.nr_interno_conta	= nr_interno_conta_p
	  and (a.vl_procedimento - a.vl_custo_operacional - a.vl_materiais) <>

obter_valor_medico_proc(a.nr_sequencia)
	  and obter_valor_medico_proc(a.nr_sequencia) <> 0;
	if (ds_proc_com_erro_w <> '() ') then
		ds_erro_w	:= ds_erro_w || '27'||ds_proc_com_erro_w;
	end if;
	end;
end if;


if (ie_exige_tipo_guia_w	= 'S') and (coalesce(ie_tipo_guia_w::text, '') = '') then
	ds_erro_w	:= ds_erro_w || '745 ';
end if;

select	count(1)
into STRICT	qt_nascidos_w
from	parto
where	nr_atendimento		= nr_atendimento_p
and	((qt_nasc_vivos	> 0)
or (qt_nasc_mortos	> 0))  LIMIT 1;

/*45080100, comentado pq no pro esse procedimento nao e de parto andre*/

select	count(1)
into STRICT	qt_proc_parto_w
from	procedimento_paciente
where	nr_interno_conta	= nr_interno_conta_p
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and	cd_procedimento in (	31309054,31309135,31309127,45080119,45080151,45080097,45080127,45080143,
				45080135,45080786,45080186,45080986,45080686,45080586,45080886,45080038,
				65420105,65421680,65310586,31309127,65420105,45080594,45080694,45080994,
				45080894,45080224,45080194,45080794,65000145,65000153)  LIMIT 1;

if (qt_proc_parto_w> 0) and (qt_nascidos_w	= 0) and (ie_tipo_convenio_w <> 3) then
	begin
	ds_erro_w := ds_erro_w || '714 ';
	end;
end if;



-- Falta N DNV para procedimentos de Parto
select 	count(1)
into STRICT	qt_nr_dnv_w
from 	nascimento
where 	nr_atendimento = nr_atendimento_p  LIMIT 1;

if (qt_proc_parto_w > 0) and (qt_nr_dnv_w	> 0) and (ie_tipo_convenio_w <> 3) then
	begin


	select 	count(1)
	into STRICT	qt_nr_dnv_w
	from 	nascimento
	where 	nr_atendimento = nr_atendimento_p
	and 	coalesce(nr_dnv::text, '') = ''
	and	coalesce(nr_dfm::text, '') = ''
	and 	(((coalesce(qt_peso_sala_parto::text, '') = '') or (coalesce(qt_peso_sala_parto,0) >= 500)) and
		 ((coalesce(qt_altura::text, '') = '') or (coalesce(qt_altura,0) >= 25)) and
		 ((coalesce(qt_sem_ig::text, '') = '') or (coalesce(qt_sem_ig,0) >= 20)))  LIMIT 1;


	--Em que situacoes nao emitir a DFM
	--1.  No obito fetal, com gestacao de menos de 20 semanas, ou feto com peso menor que 500 gramas, ou estatura menor que 25 centimetros.
	-- Nota: A legislacao atualmente existente permite que, na pratica, a emissao da DO seja facultativa para os casos em que a familia queira realizar o sepultamento do produto de concepcao.
	--http://portal.saude.gov.br/portal/arquivos/pdf/declaracao_de_obitooo.pdf
	if (qt_nr_dnv_w > 0) then
		ds_erro_w := ds_erro_w || '922 ';
	end if;


	end;
end if;


/*os49185 06/02/2007 fabricio - verifica se existe mais de uma guia (diferente) para a mesma conta. */

select 	coalesce(max(obter_valor_conv_estab(cd_convenio, cd_estabelecimento_w, 'IE_GUIA_UNICA_CONTA')),'N')
	ie_guia_unica_conta
into STRICT	ie_guia_unica_conta_w
from 	convenio
where 	cd_convenio = cd_convenio_w
and 	ie_situacao = 'A';

if (ie_guia_unica_conta_w = 'S') then
	select count(distinct coalesce(a.nr_doc_convenio,0))
	into STRICT	qt_guias_conta_w
	from 	valores_atend_paciente_v a,
	     	setor_atendimento b
	where 	a.cd_setor_atendimento = b.cd_setor_atendimento
	and 	a.nr_interno_conta = nr_interno_conta_p
	and 	coalesce(a.cd_motivo_exc_conta::text, '') = '';


	if (qt_guias_conta_w > 1) then
		ds_erro_w := ds_erro_w || '43 ';
	end if;
end if;

/*fabricio em 15/01/2009 os 124075*/

select 	count(*)
into STRICT	qt_desconto_nao_gerado_w
from 	conta_paciente_desconto
where	nr_interno_conta = nr_interno_conta_p
and 	coalesce(dt_calculo::text, '') = '';

if (qt_desconto_nao_gerado_w > 0) then
	ds_erro_w := ds_erro_w || '47 ';
end if;

/*Heckmann em 30/10/2009 OS 170489  */

select 	count(1)
into STRICT	qt_proc_w
from 	procedimento_paciente
where	nr_interno_conta = nr_interno_conta_p
and 	coalesce(cd_motivo_exc_conta::text, '') = ''
and	obter_classificacao_proced(cd_procedimento, ie_origem_proced,'C') = 1  LIMIT 1;

if (qt_proc_w = 0) then
	ds_erro_w := ds_erro_w || '2252 ';
end if;

/*Heckmann em 05/11/2009 OS 176507  */

select 	count(1)
into STRICT	qt_proc_tuss_w
from 	procedimento_paciente
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(cd_procedimento_tuss,0) = 0  -- cd_procedimento_tuss is null   Fabricio em  09/04/2010 OS 208239 */
and	coalesce(cd_motivo_exc_conta::text, '') = ''  LIMIT 1;
--and	obter_classificacao_proced(cd_procedimento, ie_origem_proced, 'C') = 1 /* Heckmann - alterado em 03/12/2009 OS182831 */
--Retirado a linha acima devido a OS 771182, pois o TUSS agora e realidade em Taxas e Diarias tambem.
if (qt_proc_tuss_w > 0) then
	ds_erro_w := ds_erro_w || '2253 ';
end if;

/*Fabricio em 23/09/2013 OS 648277  */

select 	count(1)
into STRICT	qt_mat_tuss_w
from 	material_atend_paciente
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(cd_material_tuss,0) = 0
and	coalesce(cd_motivo_exc_conta::text, '') = ''  LIMIT 1;

if (qt_mat_tuss_w > 0) then
	ds_erro_w := ds_erro_w || '2261 ';
end if;


/*Fabricio em 17/10/2014 OS 781811  */

select 	count(1)
into STRICT	qt_mat_tuss_w
from 	material_atend_paciente
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(cd_material_tuss,0) = 0
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and 	coalesce(nr_seq_proc_pacote::text, '') = ''  LIMIT 1;

if (qt_mat_tuss_w > 0) then
	ds_erro_w := ds_erro_w || '2265 ';
end if;


/*Fusinato em 29/03/2011 */

select	count(1)
into STRICT	qt_proc_princ_w
from	procedimento_paciente
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(ie_proc_princ_atend,'N') = 'S'  LIMIT 1;

if (qt_proc_princ_w = 0) then
	ds_erro_w := ds_erro_w || '413 ';
end if;


/*Heckmann em 10/06/2010 OS 221855  */

select 	count(1)
into STRICT	qt_proc_tuss_sem_pac_w
from 	procedimento_paciente
where	nr_interno_conta = nr_interno_conta_p
and	coalesce(cd_procedimento_tuss,0) = 0
and	coalesce(cd_motivo_exc_conta::text, '') = ''
--and	obter_classificacao_proced(cd_procedimento, ie_origem_proced, 'C') = 1		--Retirado a linha devido a OS 771182, pois o TUSS agora e realidade em Taxas e Diarias tambem.
and	coalesce(nr_seq_proc_pacote::text, '') = ''  LIMIT 1;

if (qt_proc_tuss_sem_pac_w > 0) then
	ds_erro_w := ds_erro_w || '2255 ';
end if;

/*Fabricio em 02/04/2012 OS 428793  */

select 	count(1)
into STRICT	qt_proc_sus_conta_conv_w
from 	procedimento_paciente 	a,
	conta_paciente 		b,
	convenio		c
where	a.nr_interno_conta = nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and 	a.nr_interno_conta = b.nr_interno_conta
and 	b.cd_convenio_parametro = c.cd_convenio
and 	c.ie_tipo_convenio = 2
and 	a.ie_origem_proced = 7  LIMIT 1;

if (qt_proc_sus_conta_conv_w > 0) then
	ds_erro_w := ds_erro_w || '2258 ';
end if;


/*Heckmann em 22/02/2011 OS 291627  */

if (ie_tipo_atendimento_w = 1) then
	select 	count(1)
	into STRICT	qt_proc_sem_diaria_w
	from 	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	obter_classificacao_proced(cd_procedimento, ie_origem_proced, 'C') = 3  LIMIT 1;


	if (qt_proc_sem_diaria_w = 0) then
		ds_erro_w := ds_erro_w || '2256 ';
	end if;
end if;

/*A. Silva  em 27/12/2011 OS 399010  */

select 	count(1)
into STRICT	qt_mat_comm_erro_w
from 	material_atend_paciente
where	nr_interno_conta = nr_interno_conta_p
and	vl_material = 0  LIMIT 1;

if (qt_mat_comm_erro_w > 0) then
	ds_erro_w := ds_erro_w || '3017 ';
end if;

/*tdpaula  em 15/03/2011 OS 300706  */

begin
select	sum(qt_cirurgia_bloq_fat)
into STRICT	qt_cirurgia_bloq_fat_w
from (SELECT count(*) qt_cirurgia_bloq_fat
	from	procedimento_paciente p,
		cirurgia c
	where	c.nr_cirurgia  = p.nr_cirurgia
	and	(c.dt_bloqueio_faturamento IS NOT NULL AND c.dt_bloqueio_faturamento::text <> '')
	and	p.nr_interno_conta = nr_interno_conta_p
	
union all

	SELECT 	count(*) qt_cirurgia_bloq_fat
	from	material_atend_paciente p,
		cirurgia c
	where	c.nr_cirurgia  = p.nr_cirurgia
	and	(c.dt_bloqueio_faturamento IS NOT NULL AND c.dt_bloqueio_faturamento::text <> '')
	and	p.nr_interno_conta = nr_interno_conta_p) alias5;
exception
	when others then
		qt_cirurgia_bloq_fat_w	:= 0;
end;

if (qt_cirurgia_bloq_fat_w > 0) then
	ds_erro_w := ds_erro_w || '2257 ';
end if;

/*Fabricio em 08/06/2009 OS146623*/

select 	count(1)
into STRICT	qt_itens_pend_devolucao_w
from 	devolucao_material_pac a
where 	coalesce(a.dt_baixa_total::text, '') = ''
and 	exists (SELECT 	1
		from 	item_devolucao_material_pac b
		where 	a.nr_devolucao = b.nr_devolucao)
and 	a.nr_atendimento = nr_atendimento_p  LIMIT 1;

if (qt_itens_pend_devolucao_w > 0) then
	ds_erro_w := ds_erro_w || '919 ';
end if;

/*Alexandre em  14/10/2010 OS 257116*/

qt_itens_pend_devolucao_w := 0;

select	count(1)
into STRICT	qt_itens_pend_devolucao_w
from	material_atend_paciente a
where	a.nr_interno_conta = nr_interno_conta_p
and	exists (SELECT 1
		from	devolucao_material_pac b,
			item_devolucao_material_pac c
		where	b.nr_devolucao = c.nr_devolucao
		and	a.nr_prescricao = c.nr_prescricao
		and	coalesce(b.dt_baixa_total::text, '') = '')  LIMIT 1;


if (qt_itens_pend_devolucao_w > 0) then
	ds_erro_w := ds_erro_w || '923 ';
end if;


open c06;
loop
fetch c06 into
	qt_guia_duplic_w,
	cd_autorizacao_ww;
EXIT WHEN NOT FOUND; /* apply on c06 */
	begin
	if (qt_guia_duplic_w > 1) then
		ie_guia_duplic_w := 'S';
	end if;
	end;
end loop;
close c06;

if (ie_guia_duplic_w = 'S') then
	ds_erro_w := ds_erro_w || '924 ';
end if;

qt_registro_w:= 0;
ds_prescricao_w:= '';

select 	coalesce(max(dt_periodo_inicial),clock_timestamp()),
	coalesce(max(dt_periodo_final),clock_timestamp())
into STRICT	dt_periodo_inicial_w,
	dt_periodo_final_w
from 	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

open c03;
loop
fetch c03 into
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin


	if (qt_registro_w	>= 4) then
		exit;
	end if;
	ds_prescricao_w := ds_prescricao_w||','||nr_prescricao_w;
	qt_registro_w	:= qt_registro_w + 1;


	end;
end loop;
close c03;


if (ds_prescricao_w IS NOT NULL AND ds_prescricao_w::text <> '') then
	ds_erro_w	:= ds_erro_w	||'2249 ';
end if;

ds_pacote_w:= '';
SELECT * FROM obter_atendimento_pacote(nr_atendimento_p, nr_interno_conta_p, 'S', ds_pacote_w, nr_interno_conta_ww, null, null) INTO STRICT ds_pacote_w, nr_interno_conta_ww;
if (ds_pacote_w IS NOT NULL AND ds_pacote_w::text <> '') then
	ds_erro_w := ds_erro_w || '2250 ';
end if;


/*Diego em 08/06/2009*/

/*SO-2220426*/

select	count(1)
into STRICT	qt_existe_w
from	atendimento_paciente
where	cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p, 'C')
and	nr_atendimento <> nr_atendimento_p
and	(((ie_tipo_atendimento = '3') and (obter_dados_atendimento(nr_atendimento_p, 'TA') = '1')) or
	((ie_tipo_atendimento = '1') and (obter_dados_atendimento(nr_atendimento_p, 'TA') = '3')))
and	pkg_date_utils.start_of(dt_alta, 'DD', 0) = pkg_date_utils.start_of(dt_entrada_w, 'DD', 0)  LIMIT 1;

/*SO-2220426*/

if (qt_existe_w = 0) then
	select	count(1)
	into STRICT	qt_existe_w
	from	atendimento_paciente
	where	cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p, 'C')
	and	nr_atendimento <> nr_atendimento_p
	and	(((ie_tipo_atendimento = '3') and (obter_dados_atendimento(nr_atendimento_p, 'TA') = '1')) or
		((ie_tipo_atendimento = '1') and (obter_dados_atendimento(nr_atendimento_p, 'TA') = '3')))
	and	pkg_date_utils.start_of(dt_alta_w, 'DD', 0) = pkg_date_utils.start_of(dt_entrada, 'DD', 0)  LIMIT 1;
end if;

if (qt_existe_w > 0) then
	ds_erro_w := ds_erro_w || '920 ';
end if;

/*Diego em 10/08/2009 OS158330*/

/*qt_existe_w := 0;
select	count(*)
into	qt_existe_w
from	medico_convenio
where	cd_convenio = cd_convenio_w;

if	(qt_existe_w > 0) then

	select	nvl(max('S'),'N')
	into	ie_medico_conv_w
	from	procedimento_paciente a,
		atendimento_paciente b
	where	a.nr_atendimento = b.nr_atendimento
	and	a.nr_interno_conta = nr_interno_conta_p
	and	b.cd_medico_resp in (
		select	x.cd_pessoa_fisica
		from	medico_convenio x
		where	x.cd_convenio = cd_convenio_w
		and	x.ie_conveniado = 'N');
end if;	*/
select	max(cd_plano_convenio)
into STRICT	cd_plano_atend_w
from	atend_categoria_convenio
where	nr_atendimento = nr_atendimento_p
and		cd_convenio = cd_convenio_w
and		cd_categoria = cd_categoria_w;


select	min(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor, cd_convenio_w,
	cd_cgc_prestador, cd_especialidade,	cd_categoria_parametro_w, cd_setor_atendimento, cd_plano_atend_w,
	dt_procedimento, ie_tipo_atendimento_w, ie_funcao_medico, ie_carater_inter_sus_w))
into STRICT	ie_medico_conv_w
from	procedimento_paciente
where	nr_interno_conta = nr_interno_conta_p;


if (ie_medico_conv_w = 'N') then
	ds_erro_w := ds_erro_w || '921 ';
end if;

/* os67259 29/08/2007 fabricio - verifica se ha lancamentos com data > que a data de validade da carteirinha do usuario */

begin
select  dt_validade_carteira
into STRICT	dt_validade_carteira_w
from 	atend_categoria_convenio
where 	nr_atendimento = nr_atendimento_p
and 	dt_inicio_vigencia = 	(SELECT max(dt_inicio_vigencia)
				 from 	atend_categoria_convenio b
			         where 	nr_atendimento = nr_atendimento_p);
exception
	when others then
		dt_validade_carteira_w:= null;
end;
/*SO-2220426*/

select	sum(qt_validade_vencida)
into STRICT	qt_validade_vencida_w
from (
	SELECT	count(*) qt_validade_vencida
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and 	pkg_date_utils.start_of(dt_procedimento, 'DD', 0) > pkg_date_utils.start_of(coalesce(dt_validade_carteira_w, dt_procedimento), 'DD', 0)
	
union all

	SELECT	count(*) qt_validade_vencida
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	pkg_date_utils.start_of(dt_atendimento, 'DD', 0) > pkg_date_utils.start_of(coalesce(dt_validade_carteira_w, dt_atendimento), 'DD', 0)) alias9;

if (qt_validade_vencida_w > 0) then
	ds_erro_w := ds_erro_w || '44 ';
end if;

/* os 116751 17/12/2008  fabricio - verifica se existe alguma diaria  lancada dentro do periodo de tolerancia (margem posterior) da diaria*/

select	coalesce(max(obter_se_diaria_margem_pos(nr_interno_conta_p)),'N')
into STRICT	ie_diaria_margem_pos_w
;

if (ie_diaria_margem_pos_w = 'S') then
	ds_erro_w:= 	ds_erro_w || '46 ';
end if;


-- Verificar a Regra Convenio Material
ie_conversao_mat_w	:= coalesce(obter_valor_conv_estab(cd_convenio_w, cd_estabelecimento_w, 'IE_CONVERSAO_MAT'),'R');

/*os55623 23/05/2007 andre verifica se matmed ou procedimento tem codigo de conversao */

select	count(1)
into STRICT	qt_conversao_mat_w
from	conversao_material_convenio
where	cd_convenio	= cd_convenio_w  LIMIT 1;

select	count(1)
into STRICT	qt_conversao_proc_w
from	conversao_proc_convenio
where	cd_convenio	= cd_convenio_w  LIMIT 1;

if	((qt_conversao_mat_w <> 0)	or (qt_conversao_proc_w <> 0))	or (ie_conversao_mat_w = 'O') then


	/* felipe martini os104828 em 15/08/2008
	select	count(*)
	into	qt_matmed_conversao_w
	from	material_atend_paciente a
	where	not exists (	select	1
				from	conversao_material_convenio b
				where	a.cd_material	= b.cd_material
				and	b.cd_convenio	= cd_convenio_w)
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_motivo_exc_conta is null;

	select	count(*)
	into	qt_proc_conversao_w
	from	procedimento_paciente a
	where	not exists (	select	1
				from	conversao_proc_convenio b
				where	a.cd_procedimento	= b.cd_procedimento
				and	b.cd_convenio		= cd_convenio_w)
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	a.cd_motivo_exc_conta is null;

	if	(qt_matmed_conversao_w <> 0)	or
		(qt_proc_conversao_w <> 0)	then
		ds_erro_w	:= ds_erro_w || '2241 ';
	end if;*/
	if (ie_conversao_mat_w = 'O') then
		select	count(1)
		into STRICT	qt_mat_conversao_w
		from	material_atend_paciente a,
			material c,
			estrutura_material_v b
		where	a.cd_material = c.cd_material
		and	a.cd_material = b.cd_material
		and	c.ie_tipo_material in (1,5)
		and	not exists (SELECT	1
					from	pls_material x
					where	x.cd_material	= a.cd_material
					and (coalesce(x.dt_exclusao::text, '') = '' or x.dt_exclusao > dt_atendimento_w)
					)
		and	a.nr_interno_conta = nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''  LIMIT 1;
	else
		begin

		select	count(1)
		into STRICT	qt_mat_conversao_w
		from	material_atend_paciente a,
			material c,
			estrutura_material_v b
		where	a.cd_material = c.cd_material
		and	a.cd_material = b.cd_material
		and	c.ie_tipo_material in (1,5)
		and	b.cd_grupo_material <> 15
		and	not exists (	SELECT	1
					from	conversao_material_convenio x
					where	a.cd_material = x.cd_material
					and	x.cd_convenio = cd_convenio_w
					and	a.dt_atendimento between coalesce(x.dt_inicio_vigencia, a.dt_atendimento) and
								coalesce(x.dt_final_vigencia, a.dt_atendimento)
					and	x.ie_situacao = 'A')
		and	a.nr_interno_conta = nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''  LIMIT 1;

		select	count(1)
		into STRICT	qt_mat_conversao_opme_w
		from	material_atend_paciente a,
			material c,
			estrutura_material_v b
		where	a.cd_material = c.cd_material
		and	a.cd_material = b.cd_material
		and	c.ie_tipo_material in (1,5)
		and	b.cd_grupo_material = 15
		and	not exists (	SELECT	1
					from	conversao_material_convenio x
					where	a.cd_material = x.cd_material
					and	x.cd_convenio = cd_convenio_w
					and	a.dt_atendimento between coalesce(x.dt_inicio_vigencia, a.dt_atendimento) and
								coalesce(x.dt_final_vigencia, a.dt_atendimento)
					and	x.ie_situacao = 'A')
		and	a.nr_interno_conta = nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''  LIMIT 1;
		
		--Codigo do grupo OPME da estrutura dos materiais para a visualizacao da pasta OPME
		if (obter_funcao_ativa = 99071) then
			cd_grupo_opme_w := somente_numero(obter_valor_param_usuario(99071, 26, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento));
		else
			cd_grupo_opme_w := somente_numero(obter_valor_param_usuario(67, 654, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento));
		end if;
		
		

		if (coalesce(cd_grupo_opme_w,0) > 0) then
		
			select	count(1)
			into STRICT	qt_mat_conversao_opme_manual_w
			from	material_atend_paciente a,
				material c,
				estrutura_material_v b
			where	a.cd_material = c.cd_material
			and	a.cd_material = b.cd_material
			and	c.ie_tipo_material in (1,5)
			and	b.cd_grupo_material = cd_grupo_opme_w
			and (not exists (	SELECT	1
						from	conversao_material_convenio x
						where	a.cd_material = x.cd_material
						and	x.cd_convenio = cd_convenio_w
						and	a.dt_atendimento between coalesce(x.dt_inicio_vigencia, a.dt_atendimento) and
									coalesce(x.dt_final_vigencia, a.dt_atendimento)
						and	x.ie_situacao = 'A') and coalesce(dt_conversao_manual::text, '') = '')
			and	a.nr_interno_conta = nr_interno_conta_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''  LIMIT 1;
		
		end if;
		
		end;
	end if;


	if (qt_mat_conversao_w > 0) then
		ds_erro_w := ds_erro_w || '2244 ';
	end if;

	if (qt_mat_conversao_opme_w > 0) then
		ds_erro_w := ds_erro_w || '2262 ';
	end if;
	
	if (qt_mat_conversao_opme_manual_w > 0) then
		ds_erro_w := ds_erro_w || '2266 ';
	end if;


	open c04;
	loop
	fetch c04 into
		cd_grupo_w,
		cd_subgrupo_w,
		cd_classe_w,
		cd_material_w,
		ie_tipo_mat_w,
		dt_atendimento_w,
		cd_setor_atend_mat_w,
		cd_convenio_mat_w,
		cd_cgc_w,

		cd_categoria_ww,
		nr_seq_atepacu_w,
		nr_seq_c04_w,
		vl_unitario_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin


		select 	max(ie_codigo_convenio)
		into STRICT	ie_codigo_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_mat_w;


		select	max(cd_tipo_acomodacao)
		into STRICT	cd_tipo_acomodacao_w
		from	atend_paciente_unidade
		where	nr_seq_interno	= nr_seq_atepacu_w;


		begin
		select	max(ie_classificacao)
		into STRICT	ie_classificacao_w
		from	tipo_acomodacao
		where	cd_tipo_acomodacao	= cd_tipo_acomodacao_w;
		exception
			when others then
				ie_classificacao_w	:= null;
		end;




		/* Christian Theilacker	- OS 282954 */

		if (ie_conversao_mat_w = 'O') then
			select	count(1)
			into STRICT	qt_conversao_mat_conv_w
			from	pls_material a
			where	a.cd_material	= cd_material_w
			and (coalesce(a.dt_exclusao::text, '') = '' or a.dt_exclusao > dt_atendimento_w)  LIMIT 1;
		else


			/* obter feriado */

			/*SO-2220426*/

			select 	count(*)
			into STRICT 	dia_feriado_w
			from 	feriado
			where 	cd_estabelecimento = coalesce(cd_estabelecimento_w, cd_estabelecimento)
			and	pkg_date_utils.start_of(dt_feriado, 'DD', 0)  = pkg_date_utils.start_of(dt_atendimento_w, 'DD', 0);

			if (dia_feriado_w > 0) then
				ie_feriado_w:= 'S';
			else
				ie_feriado_w:= 'N';
			end if;




			if (ie_codigo_convenio_w = 'I') then


				select 	count(1)
				into STRICT	qt_conversao_mat_conv_w
				from 	mat_atend_pac_convenio a,
					material_atend_paciente b
				where 	a.nr_seq_material = b.nr_sequencia
				and 	b.nr_interno_conta = nr_interno_conta_p
				and 	b.nr_sequencia = nr_seq_c04_w  LIMIT 1;


			else


				select	count(1)
				into STRICT	qt_conversao_mat_conv_w
				from	conversao_material_convenio
				where	coalesce(cd_material, cd_material_w) 			= cd_material_w
				and (coalesce(cd_categoria, cd_categoria_ww)			= cd_categoria_ww or cd_categoria_ww = '0')
				and	coalesce(cd_grupo_material, cd_grupo_w)			= cd_grupo_w
				and	coalesce(cd_subgrupo_material, cd_subgrupo_w)		= cd_subgrupo_w
				and	coalesce(cd_classe_material, cd_classe_w)			= cd_classe_w
				and	coalesce(ie_tipo_material, ie_tipo_mat_w)			= ie_tipo_mat_w
				and (coalesce(cd_setor_atendimento, cd_setor_atend_mat_w)	= cd_setor_atend_mat_w)
				and (coalesce(cd_cgc, cd_cgc_w)					= cd_cgc_w)
				and (coalesce(ie_classif_acomod, coalesce(ie_classificacao_w, 0))	= coalesce(ie_classificacao_w, 0))
				and (coalesce(cd_estabelecimento, cd_estabelecimento_w)		= cd_estabelecimento_w)
				and	((coalesce(dt_atendimento_w::text, '') = '') or (dt_atendimento_w between coalesce(dt_inicio_vigencia, dt_atendimento_w)
															and coalesce(dt_final_vigencia, dt_atendimento_w) + 86399/89400))
				and	cd_convenio = cd_convenio_mat_w
				and	ie_situacao = 'A'
				and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0)
				and	((coalesce(ie_feriado,'A') = ie_feriado_w ) or (coalesce(ie_feriado,'A')	='A'))
				order by
					coalesce(cd_material,0),
					coalesce(cd_classe_w,0),
					coalesce(cd_subgrupo_w,0),
					coalesce(cd_grupo_w,0),
					coalesce(ie_tipo_material,'0'),
					coalesce(cd_cgc, '0'),
					coalesce(cd_setor_atendimento,0),
					coalesce(cd_estabelecimento,0) LIMIT 1;
			end if;


		end if;


		select	ie_tipo_material
		into STRICT	ie_tipo_material_w
		from	material
		where	cd_material = cd_material_w;


		if (ie_tipo_material_w in (1,5)) then
			if (qt_conversao_mat_conv_w = 0) then
				qt_mat_conversao_ww 	:= 0;
			end if;
		end if;


		if (ie_tipo_material_w in (2,3,4)) then
			if (qt_conversao_mat_conv_w = 0) then
				qt_med_conversao_w 	:= 0;
			end if;
		end if;


		if (qt_mat_conversao_ww = 0) and (qt_med_conversao_w = 0) then
			exit;
		end if;


		end;
	end loop;
	close c04;


	if (qt_mat_conversao_ww = 0) then
		ds_erro_w := ds_erro_w || '2245 ';
	end if;


	if (qt_med_conversao_w = 0) then
		ds_erro_w := ds_erro_w || '2246 ';
	end if;


	select	count(1)
	into STRICT	qt_proc_conversao_w
	from	procedimento_paciente a,
		procedimento b
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	b.ie_classificacao	= 1
	and	not exists (	SELECT	1
				from	conversao_proc_convenio b
				where	a.cd_procedimento	= b.cd_procedimento
				and	b.cd_convenio		= cd_convenio_w
				and	b.ie_situacao		= 'A')  LIMIT 1;


	if (qt_proc_conversao_w	> 0) then
		ds_erro_w	:= ds_erro_w || '2247 ';
	end if;




	select	count(1)
	into STRICT	qt_proc_conversao_w
	from	procedimento_paciente a,
		procedimento b
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	b.ie_classificacao	<> 1
	and	not exists (	SELECT	1
				from	conversao_proc_convenio b
				where	a.cd_procedimento	= b.cd_procedimento
				and	b.cd_convenio		= cd_convenio_w)  LIMIT 1;


	if (qt_proc_conversao_w	> 0) then
		ds_erro_w	:= ds_erro_w || '2248 ';
	end if;


end if;

select	count(1)
into STRICT	qt_existe_w
from	conta_paciente_desconto
where	nr_interno_conta = nr_interno_conta_p  LIMIT 1;

if (qt_existe_w > 0) then


	select	sum(vl_desconto)
	into STRICT	vl_desconto_w
	from	conta_paciente_desconto
	where	nr_interno_conta = nr_interno_conta_p;


	select	coalesce(sum(vl_item),0)
	into STRICT	vl_item_w
	from (
		SELECT	sum(b.vl_procedimento) vl_item
		from	proc_paciente_valor b,
			procedimento_paciente a
		where	b.nr_seq_procedimento = a.nr_sequencia
		and	a.nr_interno_conta = nr_interno_conta_p
		and	b.ie_tipo_valor = 3
		
union all

		SELECT	sum(b.vl_material) vl_item
		from	mat_atend_paciente_valor b,
			material_atend_paciente a
		where	b.nr_seq_material = a.nr_sequencia
		and	a.nr_interno_conta = nr_interno_conta_p
		and	b.ie_tipo_valor = 3) alias4;


	if (vl_item_w <> vl_desconto_w) then
		ds_erro_w := ds_erro_w || '3008 ';
	end if;
end if;

if (qt_estrut_conta_w > 0) then
	ds_erro_w	:= ds_erro_w || '412 ';
end if;

/*os44375 23/11/2006 andre verifica se procedimento tem responsavel pelo credito*/

select	count(*)
into STRICT	qt_resp_credito_w
from	procedimento_paciente
where	coalesce(ie_responsavel_credito::text, '') = ''
and	nr_interno_conta	= nr_interno_conta_p
and	(cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '')
and 	coalesce(cd_motivo_exc_conta::text, '') = '';
if (qt_resp_credito_w > 0) then
	ds_erro_w	:= ds_erro_w || '411 ';
end if;

/*os386472 25/11/2011 Heckmann verifica se o participante tem responsavel pelo credito*/

select	count(*)
into STRICT	qt_resp_credito_w
from	procedimento_participante a,
	procedimento_paciente b
where	coalesce(a.ie_responsavel_credito::text, '') = ''
and	b.nr_interno_conta	= nr_interno_conta_p
and	b.nr_sequencia		= a.nr_sequencia
and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
and 	coalesce(b.cd_motivo_exc_conta::text, '') = '';
if (qt_resp_credito_w > 0) then
	ds_erro_w	:= ds_erro_w || '3016 ';
end if;

/*os44375 23/11/2006 andre verifica se tem estrutura da conta*/

select	count(1)
into STRICT	qt_estrut_conta_w
from	conta_paciente_v
where	nr_interno_conta	= nr_interno_conta_p
and	coalesce(ie_emite_conta::text, '') = ''  LIMIT 1;

if (qt_estrut_conta_w > 0) then
	ds_erro_w	:= ds_erro_w || '412 ';
end if;

--Materiais sem vinculo com simpro OS 479434
select  count(distinct a.cd_material)
into STRICT	qt_mat_nao_simpro_w
from    material_atend_paciente a,
        material c
where   a.cd_material = c.cd_material
and     c.ie_tipo_material in (1,5)
and     a.nr_interno_conta      = nr_interno_conta_p
and     not exists (	SELECT 	1
			from 	material_simpro b
			where 	b.cd_material = c.cd_material
			and     coalesce(b.ie_situacao,'A') = 'A');

if (qt_mat_nao_simpro_w > 0) then
	ds_erro_w	:= ds_erro_w || '926 ';
end if;


/*OS722272 10/04/2014 Fabricio */

select	count(*)
into STRICT	qt_mat_tiss_tuss_conv_w
from	material_atend_paciente
where	nr_interno_conta	= nr_interno_conta_p
and		somente_numero(cd_material_tiss) = cd_material
and 	coalesce(cd_material_tuss::text, '') = ''
and 	cd_material = coalesce(somente_numero(cd_material_convenio), cd_material)
and 	coalesce(cd_motivo_exc_conta::text, '') = '';

if (qt_mat_tiss_tuss_conv_w > 0) then
	ds_erro_w	:= ds_erro_w || '2263 ';
end if;

select 	count(1)
into STRICT	qt_exa_depend_sem_aprov_w
from 	procedimento_paciente 	a,
	prescr_procedimento 	b,
	exame_laboratorio 	c,
	exame_lab_dependente 	d
where 	a.nr_prescricao = b.nr_prescricao
and 	a.nr_sequencia_prescricao = b.nr_sequencia
and 	b.nr_seq_exame = c.nr_seq_exame
and 	c.nr_seq_exame = d.nr_seq_exame
and 	c.ie_formato_resultado in ('SM','S')
and 	d.ie_geracao in (1,5)
and 	b.ie_status_atend < 35
and 	b.ie_suspenso <> 'S'
and 	a.nr_interno_conta = nr_interno_conta_p
and 	not exists (SELECT 	1
		    from 	procedimento_paciente x
		    where 	x.nr_prescricao	= b.nr_prescricao
		    and 	x.nr_seq_exame	= d.nr_seq_exame_dep
		    and 	((coalesce(d.ie_agrupa_conta,'S') = 'S') or (x.nr_sequencia_prescricao = b.nr_sequencia)))  LIMIT 1;


if (qt_exa_depend_sem_aprov_w > 0) then
	ds_erro_w	:= ds_erro_w || '927 ';
end if;

--Medicamentos sem vinculo com brasindice  OS 479434
select  count(distinct a.cd_material)
into STRICT	qt_med_nao_brasindice_w
from    material_atend_paciente a,
        material c
where   a.cd_material = c.cd_material
and     c.ie_tipo_material in (2,3,4)
and     a.nr_interno_conta      = nr_interno_conta_p
and     not exists (	SELECT 	1
			from 	material_brasindice b
			where 	b.cd_material = c.cd_material
			and 	coalesce(b.ie_situacao,'A') = 'A');

if (qt_med_nao_brasindice_w > 0) then
	ds_erro_w	:= ds_erro_w || '925 ';
end if;


/* marcus em 16/07/2004 */

select	count(1)
into STRICT	qt_erro_w
from	setor_atendimento b,
	procedimento_paciente a
where	a.nr_interno_conta		= nr_interno_conta_p
and	a.cd_setor_atendimento	= b.cd_setor_atendimento
and	b.cd_estabelecimento		<> cd_estabelecimento_w  LIMIT 1;

if (qt_erro_w > 0) then
	ds_erro_w := ds_erro_w || '36 ';
end if;

select	count(1)
into STRICT	qt_erro_w
from	setor_atendimento b,
	material_atend_paciente a
where	a.nr_interno_conta		= nr_interno_conta_p
and	a.cd_setor_atendimento	= b.cd_setor_atendimento
and	b.cd_estabelecimento		<> cd_estabelecimento_w  LIMIT 1;

if (qt_erro_w > 0) then
	ds_erro_w := ds_erro_w || '36 ';
end if;
/* fim marcus em 16/07/2004 */

select	count(1)
into STRICT	qt_responsavel_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p
and	(cd_responsavel IS NOT NULL AND cd_responsavel::text <> '')  LIMIT 1;

if (qt_responsavel_w = 0) then
	ds_erro_w := ds_erro_w || '3014 ';
end if;

ds_erro_pacote_w := consistir_result_pacote_conta(nr_interno_conta_p, ds_erro_pacote_w);

ds_erro_ctrm_w := consiste_ct_rm_conta(nr_interno_conta_p, ds_erro_ctrm_w);
ds_us_erro_w := consiste_us_conta(nr_interno_conta_p, ds_us_erro_w);
ds_rx_erro_w := consiste_rx_conta(nr_interno_conta_p, ds_rx_erro_w);

/* edgar 28/01/2004, consistencia do convenio_regra_atend (numero de atendimentos por mes, disa entre

atendimentos)*/
select	obter_se_conv_regra_atend(nr_atendimento_p)
into STRICT	ds_erro_regra_atend_w
;

if (ds_erro_regra_atend_w = 'N') then
	ds_erro_regra_atend_w	:= '34 ';
else
	ds_erro_regra_atend_w	:= '';
end if;

/* ricardo 16/06/2008 - os 91845 */

select	obter_se_proc_regra_conta(nr_interno_conta_p, nr_atendimento_p)
into STRICT	ds_erro_regra_atend_w
;

if (ds_erro_regra_atend_w = 'N') then
	ds_erro_regra_atend_w	:= '45 ';
else
	ds_erro_regra_atend_w	:= '';
end if;

/* fim alteracao os 91845 */

/* felipe - os47328 inicio */

if (coalesce(cd_autorizacao_w::text, '') = '') or (cd_autorizacao_w = '') then
	ds_erro_w	:= ds_erro_w || '39 ';
end if;
/* felipe - 04/01/07 fim */

select	coalesce(max(vl_max_conta),0)
into STRICT	vl_max_convenio_w
from	conv_regra_valor_conta
where	cd_estabelecimento	= cd_estabelecimento_w
and	cd_convenio		= cd_convenio_w
and	ie_tipo_atendimento	= ie_tipo_atendimento_w;

if (vl_max_convenio_w	> 0) and (obter_valor_conta(nr_interno_conta_p,0) > vl_max_convenio_w) then
	ds_erro_w	:= ds_erro_w || '40 ';
else
	begin

	/* felipe - os42621 inicio */

	select	coalesce(max(vl_max_convenio),0)
	into STRICT	vl_max_convenio_w
	from	convenio
	where	cd_convenio	= cd_convenio_w;

	if (vl_max_convenio_w	> 0) and (obter_valor_conta(nr_interno_conta_p,0) > vl_max_convenio_w) then
		ds_erro_w	:= ds_erro_w || '40 ';
	end if;
	/* felipe - 10/01/07 fim */

	end;
end if;


/* felipe - os48963 inicio */

ds_mat_com_erro_w	:= '';
select	'('||to_char(max(b.cd_material)) || ') '
into STRICT	ds_mat_com_erro_w
from	material		b,
	material_atend_paciente	a
where	a.cd_material		= b.cd_material
and	a.nr_interno_conta	= nr_interno_conta_p
and	b.ie_situacao		= 'I';

if (ds_mat_com_erro_w <> '() ') then
	ds_erro_w	:= ds_erro_w || '41'||ds_mat_com_erro_w;
end if;
/* felipe - 29/01/07 fim */

/*felipe martini os110135*/

select	count(1)
into STRICT	qt_aten_sem_alta_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p
and	coalesce(dt_alta::text, '') = ''  LIMIT 1;

select	count(1)
into STRICT	qt_aten_sem_alta_tiss_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p
and	coalesce(dt_alta_tiss::text, '') = ''  LIMIT 1;

if (qt_aten_sem_alta_w > 0) and (qt_aten_sem_alta_tiss_w > 0) then
	ds_erro_w			:= ds_erro_w || '3003 ';
end if;

select 	count(1)
into STRICT	qt_proc_anat_patol_w
from 	cirurgia a
where 	coalesce(ie_anat_patol,'N') = 'S'
and 	a.nr_atendimento = nr_atendimento_p
and 	not exists (	SELECT 	1
			from 	procedimento_paciente b,
				procedimento c
			where 	b.nr_atendimento = nr_atendimento_p
			and 	c.cd_procedimento = b.cd_procedimento
			and	c.ie_origem_proced = b.ie_origem_proced
			and 	c.cd_tipo_procedimento = 74
			and 	b.nr_cirurgia = a.nr_cirurgia)  LIMIT 1;


if (qt_proc_anat_patol_w > 0) then
	ds_erro_tipo_conv_w	:= '2260 ';
end if;


/*edilson em 06/04/04 os 7599 inicio*/

select	max(ie_tipo_convenio) ie_tipo_convenio
into STRICT	ie_tipo_convenio_www
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

open c01;
loop
	fetch c01 into ie_tipo_convenio_ww;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_tipo_convenio_ww <> ie_tipo_convenio_www) then
			ds_erro_tipo_conv_w	:= '2117 ';
		end if;
		end;
end loop;

select	coalesce(max('S'),'N')
into STRICT	ie_sem_cirurgia_w

where	exists (	SELECT	1
			from 	procedimento_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	coalesce(nr_cirurgia::text, '') = ''
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	obter_se_proc_exige_cirurgia(	cd_estabelecimento_w,
								cd_convenio_w,
								cd_procedimento,
								ie_origem_proced)	= 'S');


if (ie_sem_cirurgia_w	= 'S') then
	ds_erro_w	:= ds_erro_w	|| '3004 ';
end if;

select	coalesce(max('S'),'N')
into STRICT	ie_sem_medico_conta_w

where	exists (	SELECT	1
			from 	procedimento_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	coalesce(cd_medico_exec_conta::text, '') = ''
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	obter_se_exige_medico_conta(	cd_estabelecimento_w,
								cd_convenio_w,
								cd_procedimento,
								ie_origem_proced)	= 'S');


if (ie_sem_medico_conta_w	= 'S') then
	ds_erro_w	:= ds_erro_w	|| '2259 ';
end if;

select	count(1)
into STRICT	qt_pendencias_w
from	cta_pendencia
where	nr_interno_conta	= nr_interno_conta_p
and	coalesce(dt_fechamento::text, '') = ''
and	obter_se_pend_fechar_conta(nr_seq_tipo) = 'N'  LIMIT 1;

if (qt_pendencias_w	> 0) then
	ds_erro_w	:= ds_erro_w	|| '3009 ';
end if;

select	count(1)
into STRICT	qt_medico_conv_w
from	procedimento_paciente a,
	procedimento b
where	a.nr_interno_conta = nr_interno_conta_p
and 	a.cd_procedimento = b.cd_procedimento
and 	a.ie_origem_proced = b.ie_origem_proced
and 	b.ie_classificacao = 1
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(a.cd_medico_convenio::text, '') = ''  LIMIT 1;

if (qt_medico_conv_w > 0) then
	ds_erro_w := ds_erro_w	|| '3020 ';
end if;

select	count(1)
into STRICT	qt_existe_rec_w
from	conta_paciente_recalculo
where	nr_interno_conta = nr_interno_conta_p  LIMIT 1;

if (qt_existe_rec_w = 0) then
	ds_erro_w	:= ds_erro_w	|| '3021 ';
end if;

select	count(1)
into STRICT	qt_pagador_w
from 	atendimento_pagador
where	nr_atendimento		= nr_atendimento_p  LIMIT 1;

if (qt_pagador_w	= 0) then
	ds_erro_w	:= ds_erro_w	|| '3012 ';
end if;

ds_erro_conta_audit_w := consiste_conta_sem_auditoria(nr_interno_conta_p, ds_erro_conta_audit_w);

if (ds_erro_conta_audit_w IS NOT NULL AND ds_erro_conta_audit_w::text <> '') then
	ds_erro_w	:= ds_erro_w || ds_erro_conta_audit_w;
end if;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
	select	count(*)
	into STRICT	qt_diarias_w
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and 	obter_classificacao_proced(cd_procedimento,ie_origem_proced,'C') = 3;


	qt_dias_conta_w:= obter_dias_entre_datas(dt_periodo_inicial_w,dt_periodo_final_w);


	if (qt_diarias_w > qt_dias_conta_w) then
		ds_erro_w := ds_erro_w || '51 ';
	end if;
end if;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then

	select	count(1)
	into STRICT	qt_guia_conta_w
	from	tiss_conta_guia
	where	nr_interno_conta	= nr_interno_conta_p  LIMIT 1;


	if (qt_guia_conta_w = 0) then
		ds_erro_w := ds_erro_w || '3022 ';
	end if;
end if;

/*
 Ronaldo 22/05 OS 444842
*/
begin
select	a.cd_procedimento
into STRICT	cd_proc_autor_w
from	procedimento_paciente a
where	a.nr_interno_conta = nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	exists (SELECT	1
		from	procedimento_autorizado x,
			autorizacao_convenio y,
			estagio_autorizacao z
		where	x.nr_sequencia_autor = y.nr_sequencia
		and	y.nr_seq_estagio = z.nr_sequencia
		and	z.ie_interno not in ('10','70','90')
		and	x.cd_procedimento = a.cd_procedimento
		and	x.ie_origem_proced = a.ie_origem_proced
		and	y.nr_atendimento = a.nr_atendimento  LIMIT 1)  LIMIT 1;
exception
when others then
	cd_proc_autor_w := null;
end;

if (cd_proc_autor_w IS NOT NULL AND cd_proc_autor_w::text <> '') then
	ds_erro_w	:= ds_erro_w	||'3018(Proc:'||cd_proc_autor_w||') ';
end if;

select	sum(qt_existe)
into STRICT	qt_existe_w
from (
	SELECT	count(*) qt_existe
	from	material_atend_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	coalesce(dt_conferencia::text, '') = ''
	
union all

	SELECT	count(*) qt_existe
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	coalesce(dt_conferencia::text, '') = '') alias7;

if (qt_existe_w > 0) then
	ds_erro_w := ds_erro_w || '3019 ';
end if;

/*lhalves OS 655023 em 18/10/2013*/

begin
select	1
into STRICT	qt_senha_guia_w
from	convenio b,
	atendimento_paciente c,
	atend_categoria_convenio a
where	a.cd_convenio	= b.cd_convenio
and	a.nr_atendimento	= c.nr_atendimento
and	a.nr_atendimento	= nr_atendimento_w
and	a.ie_tipo_guia		= ie_tipo_guia_w
and	b.ie_tipo_convenio	in (2,5,6,7,8,9)
and	obter_se_exige_guia_senha(a.cd_convenio, c.ie_tipo_atendimento, null, 'S',
				cd_estabelecimento_w, c.ie_carater_inter_sus, c.ie_clinica,
				null,null,null,null,a.cd_categoria, a.cd_plano_convenio, c.cd_procedencia) = 'S'
and	coalesce(a.cd_senha::text, '') = ''  LIMIT 1;
exception
when others then
	qt_senha_guia_w	:= 0;
end;

if (qt_senha_guia_w > 0) then
	ds_erro_w := ds_erro_w || '3023 ';
end if;

--Fabricio em 19/12/2013
if (obter_funcao_ativa = 99071) then
	ie_alterar_estagio_w:= obter_valor_param_usuario(99071, 24, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w);
else
	ie_alterar_estagio_w:= obter_valor_param_usuario(67, 377, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w);
end if;

if (ie_alterar_estagio_w = 'S') then


	select 	max(nr_seq_estagio_conta)
	into STRICT	nr_seq_estagio_conta_w
	from 	conta_paciente
	where 	nr_interno_conta = nr_interno_conta_p;


	if (coalesce(nr_seq_estagio_conta_w::text, '') = '') then
		ds_erro_w := ds_erro_w || '3024 ';
	end if;


end if;

ds_nao_informada_w	:= wheb_mensagem_pck.get_texto(1103974);

--lhalves OS 735006 em 29/07/2014
begin
select	count(1)
into STRICT	qt_guia_dup_w
from	conta_paciente_guia x
where	x.nr_interno_conta	= nr_interno_conta_p
and	coalesce(x.cd_autorizacao, ds_nao_informada_w) <> ds_nao_informada_w
and	exists (	SELECT	1
			from	conta_paciente a,
				conta_paciente_guia b,
				convenio c
			where	a.cd_convenio_parametro	= c.cd_convenio
			and	a.nr_interno_conta	= b.nr_interno_conta
			and	a.cd_convenio_parametro = cd_convenio_w
			and	a.cd_estabelecimento	= cd_estabelecimento_w
			and	a.nr_interno_conta	<> nr_interno_conta_p
			and	b.cd_autorizacao = x.cd_autorizacao
			and	c.ie_tipo_convenio	in (2,5,6,7,8,9)
			and	a.ie_status_acerto	= 2
			and	coalesce(b.cd_autorizacao, ds_nao_informada_w) <> ds_nao_informada_w);
exception
when others then
	qt_guia_dup_w	:= 0;
end;

if (qt_guia_dup_w > 0) then
	ds_erro_w := ds_erro_w || '3025 ';
end if;

if (coalesce(ie_consiste_regra_ipasgo_w, 'N') = 'S') then
	begin

	--mfcarneiro OS847254 17/02/2015
	select	count(1)
	into STRICT	nr_doc_convenio_proc_w
	from	procedimento_paciente a,
		prescr_procedimento b
	where	substr(somente_numero(coalesce(a.nr_doc_convenio,0)),1,10) <> 0
	and	a.nr_prescricao		= b.nr_prescricao
	and	a.nr_atendimento	= nr_atendimento_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	qt_reg_ipasgo_w := 0;
	if (nr_doc_convenio_proc_w = 0) then
		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	atendimento_paciente a,
			conta_paciente b
		where	coalesce(substr(somente_numero(obter_guia_atend(b.nr_atendimento, b.cd_convenio_parametro, b.cd_categoria_parametro)),1,11), 0) <> 0
		and	a.nr_atendimento	= b.nr_atendimento
		and	a.nr_atendimento	= nr_atendimento_p
		and	b.nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

		if (qt_reg_ipasgo_w = 0) and (nr_doc_convenio_proc_w = 0) then
			ds_erro_w := ds_erro_w || '3026 ';
		end if;
	end if;
	--mfcarneiro OS847254 17/02/2015 fim
	--mfcarneiro OS847261 em 19/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	material_atend_paciente a,
		convenio_prestador b
	where	a.cd_cgc_prestador	= b.cd_cgc
	and	coalesce(b.cd_prestador_convenio::text, '') = ''
	and	a.cd_convenio		= cd_convenio_w
	and	a.cd_convenio		= b.cd_convenio
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3029 ';
	end if;
	--mfcarneiro OS847261 em 19/02/2015 fim
	--mfcarneiro OS847262 em 22/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	material_atend_paciente a,
		conta_paciente b
	where	a.dt_atendimento < dt_periodo_inicial_w
	and 	a.nr_atendimento 	= b.nr_atendimento
	and	b.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3030 ';
	end if;
	--mfcarneiro OS847262 em 23/02/2015 fim
	--mfcarneiro OS843155 em 06/02/2015
	select	cd_cgc
	into STRICT	cd_cnpj_w
	from	convenio
	where	cd_convenio = cd_convenio_w;

	if (ie_tipo_atendimento_w in (3,8)) then
		begin

		qt_reg_ipasgo_w := 0;

		ie_gerar_unid_compl_w := obter_param_usuario(999, 39, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_unid_compl_w);

		if (coalesce(ie_gerar_unid_compl_w, 'N') = 'N') then

			select	count(1)
			into STRICT	qt_reg_ipasgo_w
			from	material_atend_paciente a
			where	a.nr_interno_conta = nr_interno_conta_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_MATMED_TRAT','CD_LOCAL_UTIL_MATMED',a.cd_setor_atendimento),a.cd_setor_atendimento) <> '3'  LIMIT 1;

		else

			select	count(1)
			into STRICT	qt_reg_ipasgo_w
			from	material_atend_paciente a,
				atend_paciente_unidade b
			where	a.nr_interno_conta 	= nr_interno_conta_p
			and	a.nr_seq_atepacu 	= b.nr_seq_interno
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_MATMED_TRAT','CD_LOCAL_UTIL_MATMED',a.cd_setor_atendimento),coalesce(b.cd_unidade_compl,a.cd_setor_atendimento)) <> '3'  LIMIT 1;

		end if;
		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3031 ';
		end if;
		end;
	end if;

	--mfcarneiro OS843157 em 10/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from 	procedimento_paciente a,
		procedimento b
	where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO', a.ie_funcao_medico), a.ie_funcao_medico) <> 2
	and	b.cd_tipo_procedimento = 95
	and	a.cd_procedimento = b.cd_procedimento
	and	a.ie_origem_proced = b.ie_origem_proced
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and (coalesce(coalesce(a.cd_pessoa_fisica,a.cd_medico_executor),'X') <> 'X')  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3033 ';
	end if;
	--mfcarneiro OS843157 em 10/02/2015 fim
	--mfcarneiro OS843435 em 09/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from 	procedimento_paciente a,
		pessoa_fisica b
	where 	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO',b.nr_seq_conselho), b.nr_seq_conselho) not in (1,2,3,4,5,6)
	and 	a.nr_interno_conta	= nr_interno_conta_p
	and	b.cd_pessoa_fisica	= coalesce(a.cd_medico_executor,a.cd_pessoa_fisica)
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w = 0) then

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	procedimento_paciente a,
			procedimento_participante b,
			pessoa_fisica c
		where 	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO',c.nr_seq_conselho),c.nr_seq_conselho) not in (1,2,3,4,5,6)
		and 	b.nr_sequencia 		= a.nr_sequencia
		and 	a.nr_interno_conta	= nr_interno_conta_p
		and	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	end if;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3034 ';
	end if;
	--mfcarneiro OS 843435 em 09/02/2015 fim
	--mfcarneiro  OS843436 em 09/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT 	qt_reg_ipasgo_w
	from 	material_atend_paciente a,
		conta_paciente c,
		atendimento_paciente b
	where	a.dt_atendimento > 	coalesce(b.dt_alta, c.dt_periodo_final)
	and	b.nr_atendimento	= c.nr_atendimento
	and	a.nr_interno_conta	= c.nr_interno_conta
	and	a.nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3035 ';
	end if;
	--mfcarneiro  OS843436 em 09/02/2015 fim
	--mfcarneiro OS843947 em 10/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT 	qt_reg_ipasgo_w
	from	atendimento_paciente
	where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_TRAT','CD_MOTIVO_ALTA',coalesce(obter_alta_tiss_conta(nr_interno_conta_p,'I'),cd_motivo_alta)), coalesce(obter_alta_tiss_conta(nr_interno_conta_p,'I'),cd_motivo_alta)) not in (1,2,3,4,5,6,7)
	and	nr_atendimento		= nr_atendimento_p  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3036 ';
	end if;
	--mfcarneiro  OS843947 em 10/02/2015 fim
	--mfcarneiro OS843948 em 13/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	exists (SELECT	1
			from	procedimento_paciente b
			where	b.nr_interno_conta 	= nr_interno_conta_p
			and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(b.nr_seq_proc_pacote,0) 	<> b.nr_sequencia
			and	b.nr_sequencia <> a.nr_sequencia
			and	coalesce(b.cd_pessoa_fisica,a.cd_medico_executor) = coalesce(a.cd_pessoa_fisica,a.cd_medico_executor)
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',b.ie_funcao_medico),b.ie_funcao_medico) <> coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao_medico),a.ie_funcao_medico))  LIMIT 1;

	if (qt_reg_ipasgo_w = 0) then
		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	procedimento_paciente a
		where	a.nr_interno_conta 	= nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
		and	exists (SELECT	1
				from	procedimento_paciente b
				where	b.nr_interno_conta = nr_interno_conta_p
				and	b.nr_sequencia <> a.nr_sequencia
				and	coalesce(b.cd_pessoa_fisica,b.cd_medico_executor) = coalesce(a.cd_pessoa_fisica,a.cd_medico_executor)
				and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',b.ie_funcao_medico),b.ie_funcao_medico) = coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao_medico),a.ie_funcao_medico))  LIMIT 1;
	end if;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3037 ';
	end if;
	--mfcarneiro OS843948 em 13/02/2015 fim
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from 	procedimento_paciente a
	where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO', a.ie_funcao_medico), a.ie_funcao_medico) not between 1 and 15
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and (coalesce(coalesce(a.cd_pessoa_fisica,a.cd_medico_executor),'X') <> 'X')  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3038 ';
	end if;

	--mfcarneiro OS844587 em 10/02/2015
	if (coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_TRAT', 'CD_TIPO_TRATAMENTO', cd_tipo_tratamento_w), cd_tipo_tratamento_w) in (1,4)) then
		begin
		qt_reg_ipasgo_w := 0;

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from 	procedimento_paciente a
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO', a.ie_funcao_medico), a.ie_funcao_medico) = 2
		and	a.nr_interno_conta 	= nr_interno_conta_p  LIMIT 1;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3039 ';
		end if;
		end;
	end if;

	--mfcarneiro OS844587 em 10/02/2015 fim
	--mfcarneiro OS844588 em 10/02/2015
	if (coalesce(ipasgo_verifica_proced_conv(nr_interno_conta_p, nm_usuario_w, cd_estabelecimento_w), 'N') = 'N') then
		ds_erro_w := ds_erro_w || '3040 ';
	end if;
	--mfcarneiro OS844588 em 10/02/2015 fim
	--mfcarneiro OS845211 em 11/02/2015
	qt_reg_ipasgo_w := 0;

	select	coalesce(max(a.cd_tipo_fatura), 0)
	into STRICT	cd_tipo_fatura_w
	from	fatur_tipo_fatura a,
		conta_paciente b
	where	a.nr_sequencia = b.nr_seq_tipo_fatura
	and 	b.nr_interno_conta	= nr_interno_conta_p;

	if (cd_tipo_fatura_w > 0) then

		select	max(qt_tipo_atend)
		into STRICT	qt_reg_ipasgo_w
		from (
			SELECT	count(1) qt_tipo_atend
			from	atendimento_paciente a
			where	a.ie_tipo_atendimento 	<> 1
			and	cd_tipo_fatura_w	 in (4,5,6)
			and	a.nr_atendimento 	= nr_atendimento_p
			
union all

			SELECT	count(1) qt_tipo_atend
			from	atendimento_paciente a
			where	a.ie_tipo_atendimento	= 1
			and	cd_tipo_fatura_w  	not in (4,5,6)
			and	a.nr_atendimento 	= nr_atendimento_p) alias6;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3041 ';
		end if;

	end if;
	--mfcarneiro OS845211 em 11/02/2015 fim
	--mfcarneiro OS845212 16/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	conta_paciente b
	where	b.nr_interno_conta 	= nr_interno_conta_p
	and	not exists (	SELECT	1
				from	cid_doenca a
				where	a.cd_doenca_cid = coalesce(substr(elimina_caracteres_especiais(obter_cid_princ_atend_ipasgo(b.cd_estabelecimento,b.nr_atendimento)),1,4),'X'))  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3042 ';
	end if;
	--mfcarneiro OS845212 16/02/2015 fim
	--mfcarneiro OS845213 em 11/02/2015
	qt_reg_ipasgo_w := 0;

	select	coalesce(max(a.cd_tipo_tratamento),0)
	into STRICT	cd_tipo_tratamento_w
	from	fatur_tipo_fatura a,
		conta_paciente b
	where	a.nr_sequencia = b.nr_seq_tipo_fatura
	and	b.nr_interno_conta	= nr_interno_conta_p;

	if (cd_tipo_tratamento_w > 0) then

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from 	conta_paciente a
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_TRAT', 'CD_TIPO_TRATAMENTO', cd_tipo_tratamento_w), cd_tipo_tratamento_w) not in (1,2,3,4)
		and	a.nr_interno_conta 	= nr_interno_conta_p  LIMIT 1;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3043 ';
		end if;

	end if;
	--mfcarneiro OS845213 em 11/02/2015 fim
	--mfcarneiro OS845793 em 16/02/2015
	select	count(1)
	into STRICT	qt_reg_ipasgo_proc_w
	from	procedimento_paciente a,
		conversao_proc_convenio b
	where	b.nr_seq_proc_interno	= a.nr_seq_proc_interno
	and	b.cd_convenio		= a.cd_convenio
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and	length(b.cd_proc_convenio) > 6
	and	(a.nr_seq_proc_interno IS NOT NULL AND a.nr_seq_proc_interno::text <> '')  LIMIT 1;

	if (qt_reg_ipasgo_proc_w = 0) then

		select	count(1)
		into STRICT	qt_reg_ipasgo_proc_w
		from	procedimento_paciente a,
			conversao_proc_convenio b
		where	b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.cd_convenio		= cd_convenio_w
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and	length(b.cd_proc_convenio) > 6  LIMIT 1;

	end if;

	if (qt_reg_ipasgo_proc_w > 0) then
		ds_erro_w := ds_erro_w || '3044 ';
	end if;
	--mfcarneiro OS845793 em 16/02/2015 fim
	--mfcarneiro OS845794 em 12/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a,
		conta_paciente b
	where	a.dt_procedimento > b.dt_periodo_final
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	b.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3045 ';
	end if;
	--mfcarneiro OS845794 em 12/02/2015 fim
	--mfcarneiro OS em 12/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	((coalesce(a.nr_ato_ipasgo,0) > 1) or (obter_se_gera_ato_ipasgo(a.cd_procedimento,a.ie_origem_proced,cd_estabelecimento_w,cd_tipo_fatura_w,ie_tipo_atendimento_w,a.cd_setor_atendimento) = 'S'))
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and	coalesce(a.ie_via_acesso,'X') = 'X'  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3046 ';
	end if;
	--mfcarneiro OS em 12/02/2015 fim
	--mfcarneiro OS846388 em 12/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a,
		conta_paciente b,
		estabelecimento c,
		convenio_prestador d
	where	a.cd_cgc_prestador 	<> c.cd_cgc
	and	b.cd_estabelecimento 	= c.cd_estabelecimento
	and	b.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_interno_conta	= b.nr_interno_conta
	and	a.cd_convenio	 	= d.cd_convenio
	and	a.cd_cgc_prestador	= d.cd_cgc
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and	coalesce(d.cd_prestador_convenio::text, '') = ''  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3047 ';
	end if;
	--mfcarneiro OS846388 em 12/02/2015 fim
	--mfcarneiro OS846389 em 25/02/2015
	cd_tipo_tratamento_w := 0;

	select	coalesce(max(a.cd_tipo_tratamento), 0)
	into STRICT	cd_tipo_tratamento_w
	from	fatur_tipo_fatura a,
		conta_paciente b
	where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w, 'W_IPASGO_DADOS_TRAT', 'CD_TIPO_TRATAMENTO', a.cd_tipo_tratamento), a.cd_tipo_tratamento) in (1,3)
	and	a.nr_sequencia		= b.nr_seq_tipo_fatura
	and	b.nr_interno_conta	= nr_interno_conta_p;

	if (cd_tipo_tratamento_w > 0) then
		qt_reg_ipasgo_w := 0;

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	procedimento_paciente a,
			procedimento b
		where	a.nr_interno_conta = nr_interno_conta_p
		and	a.cd_procedimento = b.cd_procedimento
		and	a.ie_origem_proced = b.ie_origem_proced
		and	b.cd_tipo_procedimento  = 99
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3048 ';
		end if;
	end if;
	--mfcarneiro OS846389 em 25/02/2015 fim
	--mfcarneiro OS846972 em 18/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and	coalesce(coalesce(a.cd_pessoa_fisica,a.cd_medico_executor),'X') <> 'X'
	and	coalesce(a.ie_funcao_medico,'X') <> 'X'
	and	exists (SELECT	1
			from	procedimento_paciente b
			where	b.nr_interno_conta 	= nr_interno_conta_p
			and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(b.nr_seq_proc_pacote,0) 	<> b.nr_sequencia
			and	b.nr_sequencia <> a.nr_sequencia
			and	coalesce(b.ie_funcao_medico,'X') <> 'X'
			and	coalesce(coalesce(b.cd_pessoa_fisica,b.cd_medico_executor),'X') <> 'X'
			and	coalesce(b.cd_pessoa_fisica,b.cd_medico_executor) = coalesce(a.cd_pessoa_fisica,a.cd_medico_executor)
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',b.ie_funcao_medico),b.ie_funcao_medico) = coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao_medico),a.ie_funcao_medico))  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3049 ';
	end if;
	--mfcarneiro OS846972 em 18/02/2015 fim
	--mfcarneiro OS846973 em 26/02/2015
	if (ie_tipo_atendimento_w = 1) then

		qt_dias_internacao_w := coalesce(obter_dias_entre_datas_hora(dt_entrada_w, coalesce(dt_alta_w, dt_periodo_final_w)),0);

		if (qt_dias_internacao_w > 0) then

			select	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_proced_classif_diaria_w
			from	procedimento_paciente a,
				procedimento b,
				conversao_proc_convenio c
			where	b.ie_classificacao in (1,2,3)
			and	c.cd_proc_convenio	in ('101001','101003','10200','102003','102004','102005','103001','103003','103004','103005','103006','104001','105001','106001','106002','106003','109001')
			and	a.cd_procedimento	= b.cd_procedimento
			and	a.ie_origem_proced	= b.ie_origem_proced
			and	c.cd_estabelecimento	= cd_estabelecimento_w
			and	a.nr_seq_proc_interno	= c.nr_seq_proc_interno
			and 	a.cd_convenio		= c.cd_convenio
			and	a.nr_interno_conta 	= nr_interno_conta_p;

			if (qt_proced_classif_diaria_w = 0) then
				begin

				select	sum(a.qt_procedimento)
				into STRICT	qt_proced_classif_diaria_w
				from	procedimento_paciente a,
					procedimento b,
					conversao_proc_convenio c
				where	b.ie_classificacao in (1,2,3)
				and	c.cd_proc_convenio	in ('101001','101003','10200','102003','102004','102005','103001','103003','103004','103005','103006','104001','105001','106001','106002','106003','109001')
				and	a.cd_procedimento	= b.cd_procedimento
				and	a.ie_origem_proced	= b.ie_origem_proced
				and	c.cd_estabelecimento	= cd_estabelecimento_w
				and	a.cd_procedimento	= c.cd_procedimento
				and	a.ie_origem_proced	= c.ie_origem_proced
				and 	a.cd_convenio		= c.cd_convenio
				and	a.nr_interno_conta 	= nr_interno_conta_p;

				end;
			end if;

			if (qt_proced_classif_diaria_w > qt_dias_internacao_w) then
				ds_erro_w := ds_erro_w || '3050 ';
			end if;

		end if;

	end if;
	--mfcarneiro OS846973 em 26/02/2015 fim
	--mfcarneiro OS847341 em 18/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a
	where	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and	(a.nr_seq_proc_interno IS NOT NULL AND a.nr_seq_proc_interno::text <> '')
	and	not exists (SELECT 1
			from	conversao_proc_convenio b
			where	b.nr_seq_proc_interno 	= a.nr_seq_proc_interno
			and	b.cd_convenio 		= a.cd_convenio
			and	b.cd_estabelecimento	= cd_estabelecimento_w)  LIMIT 1;

	if (qt_reg_ipasgo_w = 0) then
		begin

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	procedimento_paciente a
		where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and	not exists ( SELECT	1
				from	conversao_proc_convenio b
				where	b.cd_procedimento	= a.cd_procedimento
				and	b.ie_origem_proced 	= a.ie_origem_proced
				and	b.cd_convenio 		= a.cd_convenio
				and	b.cd_estabelecimento	= cd_estabelecimento_w)  LIMIT 1;

		end;
	end if;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3051 ';
	end if;
	--mfcarneiro OS847341 em 18/02/2015 fim
	--mfcarneiro OS847342 em 18/02/2015
	if (qt_reg_ipasgo_proc_w > 0) then
		qt_reg_ipasgo_w := 0;

		select	count(1)
		into STRICT	qt_reg_ipasgo_w
		from	procedimento_paciente a,
			conversao_proc_convenio b
		where	b.nr_seq_proc_interno 	= a.nr_seq_proc_interno
		and	b.cd_procedimento	= a.cd_procedimento
		and	b.ie_origem_proced	= a.ie_origem_proced
		and	b.cd_estabelecimento	= cd_estabelecimento_w
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3052 ';
		end if;
	end if;
	--mfcarneiro OS847342 em 18/02/2015 fim
	--mfcarneiro OS847670 em 23/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	atendimento_paciente a,
		conta_paciente b
	where	coalesce(substr(elimina_caracteres_especiais(obter_cid_princ_atend_ipasgo(cd_estabelecimento_w,a.nr_atendimento)),1,5), 'X') = 'X'
	and	a.nr_atendimento 	= b.nr_atendimento
	and	a.nr_atendimento	= nr_atendimento_p
	and	a.ie_tipo_atendimento	= 1
	and	b.nr_interno_conta	= nr_interno_conta_p  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3053 ';
	end if;
	--mfcarneiro OS847670 em 23/02/2015 fim
	--mfcarneiro OS847671 em 24/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	atendimento_paciente a,
		conta_paciente b
	where	a.dt_inicio_atendimento between b.dt_periodo_inicial and b.dt_periodo_final
	and	a.nr_atendimento 	= b.nr_atendimento
	and	b.nr_interno_conta 	= nr_interno_conta_p  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3054 ';
	end if;
	--mfcarneiro OS847671 em 24/02/2015 fim
	--mfcarneiro OS847672 em 19/02/2015
	qt_reg_ipasgo_w := 0;

	select	max(qt_tamanho_max)
	into STRICT	qt_reg_ipasgo_w
	from (
		SELECT	count(1) qt_tamanho_max
		from	procedimento_paciente a,
			pessoa_fisica b
		where 	a.nr_interno_conta 	= nr_interno_conta_p
		and	length(coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO',b.nr_seq_conselho), b.nr_seq_conselho)) > 6
		and	coalesce(a.cd_medico_executor,a.cd_pessoa_fisica) = b.cd_pessoa_fisica
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
		
union

		SELECT	count(1) qt_tamanho_max
		from	procedimento_paciente a,
			procedimento_participante b,
			pessoa_fisica c
		where	a.nr_interno_conta = nr_interno_conta_p
		and	length(coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO',c.nr_seq_conselho), c.nr_seq_conselho)) > 6
		and 	b.nr_sequencia		= a.nr_sequencia
		and	b.cd_pessoa_fisica 	= c.cd_pessoa_fisica
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1) alias14;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3055 ';
	end if;
	--mfcarneiro OS847672 em 19/02/2015 fim
	--mfcarneiro OS848141 em 19/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a,
		conta_paciente b,
		atendimento_paciente c
	where	a.dt_procedimento > coalesce(c.dt_alta,b.dt_periodo_final)
	and	a.nr_interno_conta 	= b.nr_interno_conta
	and	b.nr_atendimento 	= c.nr_atendimento
	and	b.nr_atendimento 	= nr_atendimento_p
	and	b.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3056 ';
	end if;
	--mfcarneiro OS848141 em 19/02/2015 fim
	--mfcarneiro OS848142 em 19/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a,
		conta_paciente b
	where	a.dt_procedimento < b.dt_periodo_inicial
	and	b.nr_atendimento	= a.nr_atendimento
	and	b.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3057 ';
	end if;
	--mfcarneiro OS848142 em 19/02/2015 fim
	--mfcarneiro OS848144 em 19/02/2015
	qt_reg_ipasgo_w := 0;

	select	sum(nr_seq_conselho)
	into STRICT	qt_reg_ipasgo_w
	from (
		SELECT	count(1) nr_seq_conselho
		from	procedimento_paciente a,
			pessoa_fisica b
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO',b.nr_seq_conselho), b.nr_seq_conselho) is null
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and	b.cd_pessoa_fisica	= a.cd_medico_executor
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
		
union

		SELECT	count(1) nr_seq_conselho
		from	procedimento_paciente a,
			procedimento_participante b,
			pessoa_fisica c
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_CONSELHO', c.nr_seq_conselho), c.nr_seq_conselho) is null
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and 	b.nr_sequencia		= a.nr_sequencia
		and	c.cd_pessoa_fisica	= a.cd_medico_executor
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1) alias11;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3059 ';
	end if;
	--mfcarneiro OS848144 em 19/02/2015 fim
	--mfcarneiro OS848616 em 20/02/2015
	select	count(1)
	into STRICT	qt_taxas_mat_proc_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) = '2'
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;

	select	count(1)
	into STRICT	qt_proced_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced) = '1'
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;

	if (qt_taxas_mat_proc_w > qt_proced_w) then
		ds_erro_w := ds_erro_w || '3060 ';
	end if;
	--mfcarneiro OS848616 em 20/02/2015 fim
	--mfcarneiro OS848617 em 20/02/2015
	qt_reg_ipasgo_w := 1;

	select	count(1) qt_funcao_medico
	into STRICT	qt_reg_ipasgo_w
	from (
		SELECT	count(1) qt_funcao_medico
		from	procedimento_paciente a
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao_medico),a.ie_funcao_medico) between 1 and 15
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
		
union

		SELECT	count(1) qt_funcao_medico
		from	procedimento_paciente a,
			procedimento_participante b
		where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w, 'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO', b.ie_funcao), b.ie_funcao) between 1 and 15
		and	b.nr_sequencia 		= a.nr_sequencia
		and	a.nr_interno_conta 	= nr_interno_conta_p
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1) alias11;

	if (qt_reg_ipasgo_w = 0) then
		ds_erro_w := ds_erro_w || '3061 ';
	end if;
	--mfcarneiro OS848617 em 20/02/2015 fim
	--mfcarneiro OS848618 em 20/02/2015
	qt_reg_ipasgo_w := 0;

	select 	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a,
		conta_paciente b
	where	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w, 'W_IPASGO_DADOS_TRAT', 'CD_TIPO_ACOMODACAO', substr(obter_tipo_acomod_atend(b.nr_atendimento, 'C'), 1,1)), substr(obter_tipo_acomod_atend(b.nr_atendimento, 'C'), 1,1)) not in (1,2,3,4,5)
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
	and	b.nr_interno_conta 	= a.nr_interno_conta  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3062 ';
	end if;
	--mfcarneiro OS848618 em 20/02/2015 fim
	--mfcarneiro OS849132 em 23/02/2015
	select	sum(qt_procedimento)
	into STRICT	qt_diarias_uti_w
	from	procedimento_paciente a
	where	a.cd_procedimento_convenio in (103001,103004,103005)
	and	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;

	select	sum(qt_procedimento)
	into STRICT	qt_plantao_uti_w
	from	procedimento_paciente a
	where	a.cd_procedimento_convenio in (40010,40029)
	and	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia;

	if	(qt_plantao_uti_w > (qt_diarias_uti_w * 2)) then
		ds_erro_w := ds_erro_w || '3064 ';
	end if;
	--mfcarneiro OS849132 em 23/02/2015 fim
	--mfcarneiro OS849891 em 25/02/2015
	select 	count(1)
	into STRICT	qt_verifica_proced_w
	from	procedimento_paciente a
	where	a.nr_interno_conta = nr_interno_conta_p
	and	coalesce(a.cd_senha::text, '') = ''
	and	coalesce(a.nr_doc_convenio::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_verifica_proced_w > 0) then

		select	count(1) cd_autorizacao_ato
		into STRICT	cd_autorizacao_ato_w
		from (
			SELECT	count(1) cd_autorizacao_ato
			from	procedimento_paciente a
			where	coalesce(nr_ato_ipasgo, 0) = 0
			and	coalesce(a.ie_proc_princ_atend, 'N') = 'S'
			and	coalesce(a.cd_senha::text, '') = ''
			and	coalesce(a.nr_doc_convenio::text, '') = ''
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	a.nr_interno_conta 	= nr_interno_conta_p
			
union

			SELECT	count(1) cd_autorizacao_ato
			from	procedimento_paciente a
			where	coalesce(nr_ato_ipasgo, 0) = 0
			and	obter_se_gera_ato_ipasgo(a.cd_procedimento, a.ie_origem_proced, cd_estabelecimento_w, cd_tipo_fatura_w, ie_tipo_atendimento_w, a.cd_setor_atendimento) = 'S'
			and	coalesce(a.ie_proc_princ_atend, 'N') = 'S'
			and	coalesce(a.cd_senha::text, '') = ''
			and	coalesce(a.nr_doc_convenio::text, '') = ''
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	a.nr_interno_conta 	= nr_interno_conta_p 
			
union

			select	count(1) cd_autorizacao_ato
			from	procedimento_paciente a
			where	coalesce(nr_ato_ipasgo, 0) > 0
			and	obter_se_gera_ato_ipasgo(a.cd_procedimento, a.ie_origem_proced, cd_estabelecimento_w, cd_tipo_fatura_w, ie_tipo_atendimento_w, a.cd_setor_atendimento) = 'S'
			and	coalesce(a.ie_proc_princ_atend, 'N') = 'S'
			and	coalesce(a.cd_senha::text, '') = ''
			and	coalesce(a.nr_doc_convenio::text, '') = ''
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	a.nr_interno_conta 	= nr_interno_conta_p  LIMIT 1) alias25;

		if (cd_autorizacao_ato_w > 0) then
			ds_erro_w := ds_erro_w || '3065 ';
		end if;

	end if;
	--mfcarneiro OS849891 em 25/02/2015 fim
	--mfcarneiro OS849892 em 23/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	procedimento_paciente a
	where	coalesce(a.ie_responsavel_credito, 'X') = 'X'
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3066 ';
	end if;
	--mfcarneiro OS849892 em 23/02/2015 fim
	--mfcarneiro OS850557 em 25/02/2015
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	atendimento_paciente a,
		atend_categoria_convenio b
	where	(b.cd_senha IS NOT NULL AND b.cd_senha::text <> '')
	and	b.nr_seq_interno 	= obter_atecaco_atendimento(a.nr_atendimento)
	and	a.nr_atendimento	= nr_atendimento_p  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3068 ';
	end if;
	--mfcarneiro OS850557 em 25/02/2015 fim
	--mfcarneiro OS851175 em 26/02/2015
	if (cd_tipo_fatura_w in (3, 8, 12, 13, 14)) then

		qt_reg_ipasgo_w := 0;

		ie_gerar_unid_compl_w := obter_param_usuario(999, 39, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_unid_compl_w);

		select	sum(qt_setor_atendimento)
		into STRICT	qt_reg_ipasgo_w
		from (
			SELECT	count(1) qt_setor_atendimento
			from 	material_atend_paciente a,
				atendimento_paciente b,
				atend_paciente_unidade c
			where	ie_gerar_unid_compl_w = 'S'
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_MATMED_TRAT','CD_LOCAL_UTIL_MATMED', a.cd_setor_atendimento), a.cd_setor_atendimento) <> 3
			and	c.nr_seq_interno	= a.nr_seq_atepacu
			and	b.nr_atendimento 	= c.nr_atendimento
			and	a.nr_interno_conta 	= nr_interno_conta_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			
union

			SELECT	count(1) qt_setor_atendimento
			from	material_atend_paciente a
			where	ie_gerar_unid_compl_w = 'N'
			and	coalesce(obter_conversao_meio_ext_ipe(cd_cnpj_w,'W_IPASGO_DADOS_MATMED_TRAT','CD_LOCAL_UTIL_MATMED', a.cd_setor_atendimento), a.cd_setor_atendimento) <> 3
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia
			and	a.nr_interno_conta 	= nr_interno_conta_p  LIMIT 1) alias11;

		if (qt_reg_ipasgo_w > 0) then
			ds_erro_w := ds_erro_w || '3069 ';
		end if;

	end if;
	--mfcarneiro OS851175 em 26/02/2015 fim
	--mfcarneiro OS851898 em 27/02/2015 3071
	qt_reg_ipasgo_w := 0;

	select	count(1)
	into STRICT	qt_reg_ipasgo_w
	from	material_atend_paciente a
	where	coalesce(a.ie_responsavel_credito, 'X') = 'X'
	and	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	coalesce(a.nr_seq_proc_pacote,0) 	<> a.nr_sequencia  LIMIT 1;

	if (qt_reg_ipasgo_w > 0) then
		ds_erro_w := ds_erro_w || '3071 ';
	end if;
	--mfcarneiro OS851898 em 27/02/2015 fim
	end;
end if;
--mfcarneiro OS 843155 em 06/02/2015 fim
select	max(a.cd_procedimento)
into STRICT	cd_proc_autor_w
from	procedimento_paciente a
where	a.nr_interno_conta = nr_interno_conta_p
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	exists (SELECT	1
		from	procedimento_autorizado x,
			autorizacao_convenio y,
			estagio_autorizacao z
		where	x.nr_sequencia_autor = y.nr_sequencia
		and	y.nr_seq_estagio = z.nr_sequencia
		and	z.ie_interno not in ('10','70','90')
		and	x.cd_procedimento = a.cd_procedimento
		and	x.ie_origem_proced = a.ie_origem_proced
		and	x.nr_sequencia	   = a.nr_seq_proc_autor
		and	y.nr_atendimento = a.nr_atendimento);

if (coalesce(cd_proc_autor_w,0) > 0) then
	ds_erro_w	:= ds_erro_w	||'3073(Proc:'||cd_proc_autor_w||') ';
end if;

select	count(1)
into STRICT	qt_proc_regra_sus_w
from	conta_paciente	a,
	procedimento_paciente b
where	a.nr_interno_conta = b.nr_interno_conta
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	a.cd_convenio_parametro <> 3
and	not exists (SELECT 1
		from	procedimento_conv_sus x
		where	b.cd_procedimento = x.cd_procedimento
		and	b.ie_origem_proced = x.ie_origem_proced)
and	a.nr_interno_conta = nr_interno_conta_p;

if (qt_proc_regra_sus_w > 0) then
	ds_erro_w := ds_erro_w || '53 ';
end if;

/*edilson em 06/04/04 os 7599 fim*/

ds_erro_medico_exec_w := consistir_medico_executor(nr_interno_conta_p, ds_erro_medico_exec_w); /* edgar 15/02/2005, os 15020, inclui a conisitencia */
/* adelson 26/12/2005 os 27646 */

if (ie_tipo_convenio_w <> 3)	then
	ds_erro_partic_w := consiste_participante(nr_interno_conta_p, ds_erro_partic_w);
end if;

ds_erros_autor_w			:= ''; /*francisco os 30405 - 13/10/06 - loop abaixo - consistir proced. autorizados */
open c02;
loop
fetch c02 into
	cd_convenio_proc_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_procedimento_w,
	qt_procedimento_w,
	cd_setor_atend_proc_w,
	nr_seq_exame_w,
	nr_seq_proc_interno_w,
	cd_medico_exec_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	SELECT * FROM consiste_plano_convenio(nr_atendimento_w, cd_convenio_proc_w, cd_procedimento_w, ie_origem_proced_w, dt_procedimento_w, 0, /*qt_procedimento_w,  -- francisco - 30/09/08 troquei por 0 por causa da consiste_autorizacao_proc */
				ie_tipo_atendimento_w, cd_plano_atend_w, null, ds_erro_autorizacao_w, cd_setor_atend_proc_w, nr_seq_exame_w, ie_regra_w, null, nr_seq_regra_retorno_w, nr_seq_proc_interno_w, cd_categoria_parametro_w, cd_estabelecimento_w, null, cd_medico_exec_w, cd_pessoa_fisica_w, ie_glosa_w, nr_seq_regra_preco_w) INTO STRICT ds_erro_autorizacao_w, ie_regra_w, nr_seq_regra_retorno_w, ie_glosa_w, nr_seq_regra_preco_w;

	if (coalesce(ie_regra_w,-1) = 6) and 			/* se a regra e para consistir na conta paciente */
		(ds_erro_autorizacao_w IS NOT NULL AND ds_erro_autorizacao_w::text <> '') then
		ds_erros_autor_w	:= substr(ds_erros_autor_w || ds_erro_autorizacao_w,1,2000);
	end if;

end loop;
close c02;

ds_erros_autor_mat_w	:= null;
open c05;
loop
fetch c05 into
	cd_convenio_mat_w,
	cd_material_w,
	dt_material_w,
	qt_material_w,
	cd_setor_atend_mat_w,
	nr_seq_mat_simp_w;
EXIT WHEN NOT FOUND; /* apply on c05 */

	SELECT * FROM consiste_mat_plano_convenio(cd_convenio_mat_w, cd_plano_atend_w, cd_material_w, nr_atendimento_w, cd_setor_atend_mat_w, ds_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_mat_w, nr_seq_regra_retorno_w, 0, dt_material_w, null, cd_estabelecimento_w, cd_categoria_parametro_w, ie_tipo_atendimento_w, null, null, null, null, nr_seq_mat_simp_w) INTO STRICT ds_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_mat_w, nr_seq_regra_retorno_w;

	if (coalesce(ie_regra_mat_w,-1) = 3) then

		ds_erro_autorizacao_w	:= null;

		SELECT * FROM consiste_autorizacao_mat(nr_atendimento_w, cd_convenio_mat_w, dt_material_w, cd_material_w, 0, null, ds_aviso_w, ds_erro_autorizacao_w) INTO STRICT ds_aviso_w, ds_erro_autorizacao_w;


		if (ds_erro_autorizacao_w IS NOT NULL AND ds_erro_autorizacao_w::text <> '') then
			ds_erros_autor_mat_w	:= substr(ds_erros_autor_mat_w ||'3011('||to_char(cd_material_w)||') ',1,2000);
		end if;
	end if;

end loop;
close c05;

if ((Obter_Nr_Seq_Locale(nm_usuario_w) = 7) and consiste_tipo_cobranca(nr_interno_conta_p)) then --Somente para Alemanha
  ds_erro_w := ds_erro_w || '3076 ';
end if;

ie_exige_documento_w := Obter_Valor_Param_Usuario(67, 748, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento);

if (coalesce(ie_exige_documento_w,'N') = 'S') then
	select	max(nr_seq_tipo_doc_identificacao),
			obter_nacionalidade_pf(cd_pessoa_fisica_w)
	into STRICT	nr_seq_tipo_doc_id_w,
			cd_nacionalidade_w
	from	pessoa_fisica_aux
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	for material_conta_w in c04 loop
		select  obter_regulated_price('MRV', material_conta_w.cd_material),
				obter_regulated_price('NAT', material_conta_w.cd_material),
				(obter_regulated_price('VMV', material_conta_w.cd_material))::numeric
		into STRICT    ie_material_regulado_w,
				cd_nationality_w,
				vl_max_sale_w
		;
		
		if (material_conta_w.vl_unitario > vl_max_sale_w and cd_nacionalidade_w = cd_nationality_w and nr_seq_tipo_doc_id_w in ('CC','TI','RC','CN','AS','MS')) then
			ie_valor_de_venda_maior_W := 'S';
		end if;
	end loop;
	
	if (ie_valor_de_venda_maior_W = 'S') then
		ds_erro_w := ds_erro_w || '3077 ';
	end if;
	
else
	for material_conta_w in c04 loop
		select  obter_regulated_price('MRV', material_conta_w.cd_material),
				(obter_regulated_price('VMV', material_conta_w.cd_material))::numeric
		into STRICT    ie_material_regulado_w,
				vl_max_sale_w
		;
		
		if (material_conta_w.vl_unitario > vl_max_sale_w) then
			ie_valor_de_venda_maior_W := 'S';
		end if;
	end loop;
	
	if (ie_valor_de_venda_maior_W = 'S') then
		ds_erro_w := ds_erro_w || '3077 ';
	end if;
	
end if;

ds_erro_w	:= substr(ds_erro_ctrm_w || ds_us_erro_w || ds_rx_erro_w ||ds_erro_w || (ds_erro_atend_w || ds_erro_guia_w ||
		ds_erro_conta_w || ds_erro_bpa_w || ds_erro_proc_w || ds_erro_cid_w ||
		ds_erro_laudo_w  || ds_erro_aih_w   || ds_erro_valor_w ||
		ds_erro_pacote_w || ds_erro_regra_atend_w || ds_erro_tipo_conv_w || ds_erro_uti_w ||
		ds_erro_medico_exec_w || ds_erro_partic_w || ds_erros_autor_w || ds_erro_mat_w ||
		ds_erro_procedimento_w || ds_erros_autor_mat_w),1,255); /*

03/08/2007 - os64138 - luiz f.m. - alterei o tamanho do substr de 100
para 255 */
ds_erro_w := restringir_inconsistencia(cd_estabelecimento_w, cd_convenio_w, cd_categoria_parametro_w, ie_tipo_atendimento_w, ie_clinica_w, nr_seq_classif_atend_w, ds_erro_w);

/*21/APR/2022 - OS 2892175 - Apenas para a Colombia*/

SELECT coalesce(MAX(count(b.nr_prescricao)), 0) qt_prescr_mipres
  INTO STRICT qt_prescr_mipres_w
  FROM conta_paciente a,
       prescr_mipres b
 WHERE a.nr_atendimento = b.nr_atendimento
   AND ( EXISTS ( SELECT 1
                 FROM procedimento_paciente c
                WHERE a.nr_interno_conta = c.nr_interno_conta
                  AND a.nr_atendimento = c.nr_atendimento
                  AND b.nr_prescricao = c.nr_prescricao
                  AND coalesce(b.nr_presc_mipres::text, '') = ''
                )
    OR EXISTS ( SELECT 1
              FROM material_atend_paciente d
             WHERE a.nr_interno_conta = d.nr_interno_conta
               AND a.nr_atendimento = d.nr_atendimento
               AND b.nr_prescricao = d.nr_prescricao
               AND coalesce(b.nr_presc_mipres::text, '') = ''
              ) )
   AND a.nr_interno_conta = nr_interno_conta_p
   group by a.nr_atendimento, a.nr_interno_conta;

if (qt_prescr_mipres_w > 0) and (Obter_Nr_Seq_Locale(wheb_usuario_pck.get_nm_usuario) = 3) then
	ds_erro_w := ds_erro_w || '12500 ';
end if;
/* FIM OS 2892175 */

--ds_erro_aux_w	:= substr(replace(ds_erro_w,' ',','),0,length(ds_erro_w)-1);
ds_erro_aux_w := ds_erro_w;
ds_erro_p	:= substr(ds_erro_w,1,255);
ds_erro_ler_w	:= '';

/* felipe - 24/11/2007 - feito o teste abaixo para nao aparecer as inconsistencias da conta para o sus unificado */

select	count(*)
into STRICT	qt_proc_sus_unif_w
from	procedimento_paciente
where	nr_interno_conta	= nr_interno_conta_p
and	ie_origem_proced	= 7;
if (qt_proc_sus_unif_w	> 0) and (ie_tipo_convenio_w = 3) then
	ds_erro_aux_w	:= '';
	ds_erro_p	:= '';
	ds_erro_ler_w	:= '';
end if;
/* fim alteracao */

/*Foi trocada a rotina abaixo para realizar o mesmo processo realizado na procedure 'RESTRINGIR_INCONSISTENCIA'
pois ocorreria problema caso um codigo com descricao entre parenteses fosse cortado por conta da restricao 
de 255 caracteres realizada por conta da plataforma DELPHI*/
if (length(ds_erro_aux_w) > 0) then
	while (ds_erro_aux_w IS NOT NULL AND ds_erro_aux_w::text <> '') LOOP
		begin
		
		k := position(' ' in ds_erro_aux_w);
		if (k > 1) then
			cd_erro_w		:= substr(ds_erro_aux_w, 1, k-1);
			ds_erro_aux_w	:= substr(ds_erro_aux_w, k + 1, 255);
		elsif (ds_erro_aux_w IS NOT NULL AND ds_erro_aux_w::text <> '') then
			cd_erro_w 	:= replace(ds_erro_aux_w, ' ','');
			ds_erro_aux_w	:= '';
		end if;
		if (cd_erro_w IS NOT NULL AND cd_erro_w::text <> '') then
			k := position('(' in cd_erro_w);
			if (k > 1) then
				cd_erro_ler_w := substr(cd_erro_w, 1, k-1);
			else
				cd_erro_ler_w := substr(cd_erro_w,1,5);
			end if;
			
			if (ds_erro_ler_w IS NOT NULL AND ds_erro_ler_w::text <> '') then
				ds_erro_ler_w := ds_erro_ler_w || ',' || cd_erro_ler_w;
			else
				ds_erro_ler_w := cd_erro_ler_w;
			end if;
		end if;
		
		end;
	end LOOP;
end if;

if (ds_erro_ler_w IS NOT NULL AND ds_erro_ler_w::text <> '') then
	/* incluido a function obter_dados_inconsistencia  pois nao considerava as regras por perfil / estabelecimento  os 113853  fabricio e martini  em 21/10/2008 */

	sql_select := 	'select count(*) ' ||
			' from inconsistencia ' ||
			' where ie_tipo_inconsistencia = 1 ' ||
			'   and Obter_Dados_Inconsistencia(nr_sequencia, :CD_ESTABELECIMENTO_P, obter_perfil_ativo,ie_fecha_conta,'||guampa||'IE_FECHA_CONTA'||guampa||') = '|| guampa || 'N' || guampa ||
			'   and cd_inconsistencia in :CD_INCONSISTENCIA_P';

	retorno_w := obter_valor_dinamico_in_bv(sql_select, ':CD_ESTABELECIMENTO_P=' || cd_estabelecimento_w, ':CD_INCONSISTENCIA_P', ds_erro_ler_w, ',', retorno_w);

	select	CASE WHEN retorno_w=0 THEN  'S'  ELSE 'N' END
	into STRICT	ie_fecha_conta_p
	;

	/* ignorar fecha conta de inconsistencias do susaih definidas como nao permite alterar */

	if (ie_tipo_atendimento_w 	= 1)	and (ie_tipo_conv_conta_w 	= 3)	and (ie_fecha_conta_p	= 'S')	then
		begin
		sql_select := 	'select count(*) ' ||
				' from inconsistencia ' ||
				' where ie_tipo_inconsistencia = 1 ' ||
				' and ie_permite_alterar = ' || guampa || 'N' || guampa ||
				' and cd_inconsistencia in :CD_INCONSISTENCIA_P';
					
		retorno_w := obter_valor_dinamico_in_bv(sql_select, '', ':CD_INCONSISTENCIA_P', ds_erro_ler_w, ',', retorno_w);
		
		select	CASE WHEN retorno_w=0 THEN 'S'  ELSE 'N' END
		into STRICT	ie_fecha_conta_p
		;
		end;
	end if;

	/* incluido a function obter_dados_inconsistencia  pois nao considerava as regras por perfil / estabelecimento  os 125816  fabricio em 28/01/2009 */

	sql_select := 	'select count(*) ' ||
			'from inconsistencia ' ||
			'where ie_tipo_inconsistencia = 1 ' ||
			'and Obter_Dados_Inconsistencia(nr_sequencia, :CD_ESTABELECIMENTO_P, obter_perfil_ativo,ie_fecha_atendimento,'||guampa||'IE_FECHA_ATENDIMENTO'||guampa||') = '|| guampa || 'N' || guampa ||
			'and cd_inconsistencia in :CD_INCONSISTENCIA_P';

	retorno_w := obter_valor_dinamico_in_bv(sql_select, ':CD_ESTABELECIMENTO_P=' || cd_estabelecimento_w, ':CD_INCONSISTENCIA_P', ds_erro_ler_w, ',', retorno_w);

	select	CASE WHEN retorno_w=0 THEN  'S'  ELSE 'N' END
	into STRICT 	ie_fecha_atendimento_p
	;	
else	
	ie_fecha_conta_p := 'S';
	ie_fecha_atendimento_p := 'S';
end if;
	
if (ie_tipo_convenio_w = 3) and (ie_tipo_conv_conta_w = 3) then
	begin
	retorno_w := coalesce(obter_se_inconsistente(2,nr_interno_conta_p),0);
	if (retorno_w > 0) then
		ie_fecha_conta_p 	:= 'N';
		ie_fecha_atendimento_p	:= 'N';
	end if;
	end;
end if;

qt_processo_pendente_p		:= qt_processo_pendente_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_conta_paciente ( nr_interno_conta_p bigint, nr_atendimento_p bigint, ie_fecha_atendimento_p INOUT text, ie_fecha_conta_p INOUT text, qt_processo_pendente_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

