-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_requisito (nr_sequencia_p text, ie_liberar_desenv_p text ) AS $body$
DECLARE

    ie_liberar_desenv_old_w LATAM_REQUISITO.IE_LIBERAR_DESENV%type;
	dt_cancelado_w			LATAM_REQUISITO.DT_INATIVACAO%type;
    ds_cmd_update_w         varchar(4000);
    ds_sep_bv_w             varchar(50);
  i RECORD;

BEGIN
	IF ie_liberar_desenv_p = 'C' THEN
		dt_cancelado_w := clock_timestamp();
	ELSE
		dt_cancelado_w := null;
	END IF;
	
    ds_sep_bv_w := obter_separador_bv;
    ds_cmd_update_w := ' update latam_requisito '
                    || ' set    ie_liberar_desenv = :1 '
					|| ' , dt_inativacao = :2 '
                    || ' where  nr_sequencia = :3';

    FOR i IN (WITH RECURSIVE cte AS (
SELECT regexp_substr(nr_sequencia_p, '[^,]+', 1, level) AS nr_sequencia

             (regexp_substr(nr_sequencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_p, '[^,]+', 1, level))::text <> '')  UNION ALL
SELECT regexp_substr(nr_sequencia_p, '[^,]+', 1, level) AS nr_sequencia
                
             (regexp_substr(nr_sequencia_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_p, '[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
)
    LOOP
        SELECT  a.IE_LIBERAR_DESENV
        INTO STRICT    ie_liberar_desenv_old_w
        FROM    LATAM_REQUISITO a
        WHERE   a.NR_SEQUENCIA = i.nr_sequencia;

        EXECUTE ds_cmd_update_w USING ie_liberar_desenv_p, dt_cancelado_w, i.nr_sequencia;

        CALL generate_latam_log(i.nr_sequencia, ie_liberar_desenv_old_w, 939550);

    END LOOP;

    COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_requisito (nr_sequencia_p text, ie_liberar_desenv_p text ) FROM PUBLIC;

