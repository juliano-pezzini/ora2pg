-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proccess_address_austria (nr_catalogo_p bigint, nm_usuario_p text default 'TASYLOAD') AS $body$
DECLARE


    -- COUNTRY NAME
    nm_pais_w                pais.nm_pais%type;
    plz_w                    adresse.plz%type;
    gkz_w                    adresse.gkz%type;
    gemeindename_w           gemeinde.gemeindename%type;
    okz_w                    adresse.okz%type;
    ortsname_w               ortschaft.ortsname%type;
    skz_w                    adresse.skz%type;
    strassenname_w           strasse.strassenname%type;
    hausnrzahl1_w            adresse.hausnrzahl1%type;
    hausnrbuchstabe1_w       adresse.hausnrbuchstabe1%type;
    adrcd_w                  adresse.adrcd%type;

    plz_last_w               adresse.plz%type;
    gkz_last_w               adresse.gkz%type;
    okz_last_w               adresse.okz%type;
    skz_last_w               adresse.skz%type;
    adrcd_last_w             adresse.adrcd%type;

    hausnrzahl1_varchar_w            end_endereco.ds_endereco%type;
    hausnrbuchstabe1_varchar_w       end_endereco.ds_endereco%type;

    nr_contador_w   adresse.adrcd%type;
    nr_registro_w   adresse.adrcd%type;

    codigo_postal       constant varchar(13) := 'CODIGO_POSTAL';
    localidade_area     constant varchar(15) := 'LOCALIDADE_AREA';
    municipio           constant varchar(9)  := 'MUNICIPIO';
    rua_vialidade       constant varchar(13) := 'RUA_VIALIDADE';
    numero              constant varchar(6)  := 'NUMERO';
    situacao            constant varchar(1)  := 'A';
    espaco              constant varchar(1)  := ' ';
    virgula_espaco      constant varchar(2)  := ', ';

c01 CURSOR FOR
    SELECT 
        adr.plz,
        adr.gkz,
        dem.gemeindename,
        adr.okz,
        ort.ortsname,
        adr.skz,
        str.strassenname,
        adr.adrcd,
        adr.hausnrzahl1,
        adr.hausnrbuchstabe1
    from adresse adr
        INNER JOIN gemeinde dem ON dem.gkz = adr.gkz
        INNER JOIN ortschaft ort ON ort.okz = adr.okz 
        INNER JOIN strasse str ON str.skz = adr.skz
    ORDER BY
        adr.plz,
        adr.gkz,
        adr.okz,
        adr.skz,
        adr.adrcd;



BEGIN
    SELECT nm_pais
    INTO STRICT NM_PAIS_W
    FROM end_catalogo cat, pais pais
    WHERE pais.nr_sequencia = cat.nr_seq_pais AND cat.nr_sequencia = NR_CATALOGO_P;

    plz_last_w                 := 0;
    gkz_last_w                 := 0;
    okz_last_w                 := 0;
    skz_last_w                 := 0;
    adrcd_last_w               := 0;
    hausnrzahl1_varchar_w      := espaco;
    hausnrbuchstabe1_varchar_w := espaco;
    nr_contador_w              := 0;

    open c01;
    loop
    fetch	c01 into
        plz_w,
        gkz_w,
        gemeindename_w,
        okz_w,
        ortsname_w,
        skz_w,
        strassenname_w,
        adrcd_w,
        hausnrzahl1_w,
        hausnrbuchstabe1_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
        begin
            --INSERT INTO LOG (DS_LOG) VALUES ('Ciclo cursor: ' || adrcd_w);
            if (plz_last_w != plz_w) then

                INSERT 
                    INTO end_endereco(
                    nr_sequencia, 
                    dt_atualizacao, 
                    nm_usuario, 
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    nr_seq_catalogo,
                    ie_informacao, 
                    ds_endereco, 
                    cd_sistema_anterior,
                    ds_endereco_completo, 
                    ie_situacao
                )
                SELECT 
                    nextval('end_endereco_seq')                    as nr_sequencia,
                    zip.dt_atualizacao                          as dt_atualizacao,
                    zip.nm_usuario                              as nm_usuario,
                    zip.dt_atualizacao                          as dt_atualizacao_nrec,
                    zip.nm_usuario                              as nm_usuario_nrec,
                    zip.nr_seq_catalogo                         as nr_seq_catalogo,
                    zip.ie_informacao                           as ie_informacao,
                    zip.plz                                     as ds_endereco,
                    zip.plz                                     as cd_sistema_anterior,
                    (zip.plz || virgula_espaco ||  NM_PAIS_W)   as ds_endereco_completo,
                    zip.ie_situacao                             as ie_situacao
                FROM (
                        SELECT plz_w        as plz
                            ,clock_timestamp()        as dt_atualizacao
                            ,NM_USUARIO_P   as nm_usuario
                            ,NR_CATALOGO_P  as nr_seq_catalogo
                            ,codigo_postal  as ie_informacao
                            ,situacao       as ie_situacao
                        
                     ) zip
                    LEFT JOIN end_endereco edr ON zip.plz = edr.cd_sistema_anterior
                        AND edr.nr_seq_catalogo = NR_CATALOGO_P
                WHERE coalesce(edr.nr_sequencia::text, '') = ''; -- Only new Zip Codes
                plz_last_w := plz_w;
            end if;

            if (gkz_last_w != gkz_w) then
                SELECT COUNT(*) 
                INTO STRICT nr_registro_w
                FROM end_endereco edr 
                WHERE edr.cd_sistema_anterior = TO_CHAR(gkz_w) 
                    AND edr.nr_seq_catalogo = NR_CATALOGO_P;

                if (nr_registro_w = 0) then
                    --INSERT INTO LOG (DS_LOG) VALUES ('gkz_w nao existe: ' || gkz_w);
                    INSERT INTO end_endereco(
                        nr_sequencia,
                        dt_atualizacao, 
                        nm_usuario, 
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_catalogo,
                        ie_informacao, 
                        nr_seq_superior,
                        ds_endereco, 
                        cd_postal,
                        cd_sistema_anterior,
                        ds_endereco_completo, 
                        ie_situacao
                    ) 
                    SELECT 
                        nextval('end_endereco_seq'),           -- nr_sequencia
                        clock_timestamp(),                            -- dt_atualizacao
                        NM_USUARIO_P,                       -- nm_usuario
                        clock_timestamp(),                            -- dt_atualizacao_nrec
                        NM_USUARIO_P,                       -- nm_usuario_nrec
                        NR_CATALOGO_P,                      -- nr_seq_catalogo
                        localidade_area,                    -- ie_informacao         
                        dist.nr_sequencia,                  -- nr_seq_superior
                        dist.gemeindename,                  -- ds_endereco
                        dist.plz,                           -- cd_postal
                        dist.gkz,                           -- cd_sistema_anterior
                        (dist.gemeindename || virgula_espaco ||  
                                dist.ds_endereco_completo), -- ds_endereco_completo  
                        situacao                       -- ie_situacao
                    FROM (
                            SELECT      
                                    plz_w as plz,                   -- Code of Zip Code
                                    endr.nr_sequencia,              -- Code of Zip Code recode on end_endereco
                                    endr.ds_endereco_completo,      -- Full address description of the Zip Code
                                    gkz_w as gkz,                   -- Distric Code
                                    gemeindename_w as gemeindename  -- District Name
                            FROM end_endereco endr 
                            WHERE endr.cd_sistema_anterior = plz_w
                                AND endr.nr_seq_catalogo = NR_CATALOGO_P  -- Find records with same ZIP Code  
                         ) dist LIMIT 1;
                else
                    --INSERT INTO LOG (DS_LOG) VALUES ('gkz_w existe: ' || gkz_w);
                    UPDATE end_endereco
                    SET(dt_atualizacao, 
                         nm_usuario,  
                         ds_endereco, 
                         nr_seq_superior,
                         ds_endereco_completo, 
                         ie_situacao) =
                                        (
                                         SELECT 
                                                clock_timestamp(),                            -- dt_atualizacao
                                                NM_USUARIO_P,                       -- nm_usuario    
                                                dist.gemeindename,                  -- ds_endereco 
                                                dist.nr_sequencia,                  -- nr_seq_superior
                                                (dist.gemeindename || virgula_espaco  ||  
                                                        dist.ds_endereco_completo), -- ds_endereco_completo  
                                                situacao
                                         FROM (
                                                 SELECT 
                                                        plz_w as plz,                          -- Code of Zip Code
                                                        endr.nr_sequencia,                -- Code of Zip Code recode on end_endereco
                                                        endr.ds_endereco_completo,        -- Full address description of the Zip Code
                                                        gkz_w as gkz,                          -- Distric Code
                                                        gemeindename_w as gemeindename                  -- District Name
                                                FROM end_endereco endr 
                                                WHERE endr.cd_sistema_anterior = plz_w 
                                                    AND endr.nr_seq_catalogo = NR_CATALOGO_P  -- Find records with same ZIP Code  
                                            ) dist LIMIT 1)
                    WHERE cd_sistema_anterior = gkz_w AND nr_seq_catalogo = NR_CATALOGO_P;
                end if;
                gkz_last_w := gkz_w;
            end if;

            if (okz_last_w != okz_w) then
                
                SELECT COUNT(*) 
                INTO STRICT nr_registro_w
                FROM end_endereco edr 
                WHERE edr.cd_sistema_anterior = TO_CHAR(okz_w) AND edr.nr_seq_catalogo = NR_CATALOGO_P;

                if (nr_registro_w = 0) then
                    --INSERT INTO LOG (DS_LOG) VALUES ('okz_w nao existe: ' || okz_w);
                    INSERT INTO end_endereco(
                        nr_sequencia, 
                        dt_atualizacao, 
                        nm_usuario, 
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_catalogo,
                        ie_informacao, 
                        nr_seq_superior,
                        ds_endereco, 
                        cd_postal,
                        cd_sistema_anterior,
                        ds_endereco_completo, 
                        ie_situacao
                    ) 
                    SELECT 
                        nextval('end_endereco_seq'),           -- nr_sequencia
                        clock_timestamp(),                            -- dt_atualizacao
                        NM_USUARIO_P,                       -- nm_usuario
                        clock_timestamp(),                            -- dt_atualizacao_nrec
                        NM_USUARIO_P,                       -- nm_usuario_nrec
                        NR_CATALOGO_P,                      -- nr_seq_catalogo
                        municipio,                          -- ie_informacao        
                        city.nr_sequencia,                  -- nr_seq_superior
                        city.ortsname,                      -- ds_endereco
                        city.plz,                           -- cd_postal
                        city.okz,                           -- cd_sistema_anterior
                        (city.ortsname || virgula_espaco  ||  
                                city.ds_endereco_completo), -- ds_endereco_completo  
                        situacao                       -- ie_situacao
                    FROM (
                            SELECT 
                                    plz_w as plz,                          -- Code of Zip Code
                                    endr.nr_sequencia,                -- Code of District recod on end_endereco
                                    endr.ds_endereco_completo,        -- Full address description of the District
                                    okz_w as okz ,                         -- City Code
                                    ortsname_w as ortsname                      -- City Name
                            FROM end_endereco endr 
                            WHERE endr.cd_sistema_anterior = gkz_w
                                AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same District
                         ) city LIMIT 1; -- Only new Cities
                else
                    --INSERT INTO LOG (DS_LOG) VALUES ('okz_w existe: ' || okz_w);
                    UPDATE end_endereco 
                    SET(dt_atualizacao, 
                         nm_usuario,  
                         ds_endereco, 
                         nr_seq_superior,
                         ds_endereco_completo, 
                         ie_situacao) =
                                        (
                                        SELECT 
                                            clock_timestamp(),                            -- dt_atualizacao
                                            NM_USUARIO_P,                       -- nm_usuario    
                                            city.ortsname,                      -- ds_endereco
                                            city.nr_sequencia,                  -- nr_seq_superior
                                            (city.ortsname || virgula_espaco ||  
                                                    city.ds_endereco_completo), -- ds_endereco_completo  
                                            situacao                       -- ie_situacao
                                        FROM (
                                                SELECT 
                                                        plz_w as plz,                     -- Code of Zip Code
                                                        endr.nr_sequencia,                -- Code of District recod on end_endereco
                                                        endr.ds_endereco_completo,        -- Full address description of the District
                                                        okz_w as okz ,                    -- City Code
                                                        ortsname_w as ortsname            -- City Name
                                                FROM end_endereco endr 
                                                WHERE endr.cd_sistema_anterior = gkz_w 
                                                    AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same District
                                             ) city LIMIT 1)
                     WHERE cd_sistema_anterior = okz_w AND nr_seq_catalogo = NR_CATALOGO_P;
                end if;

                okz_last_w := okz_w;
            end if;

            if (skz_last_w != skz_w) then
                SELECT COUNT(*) 
                INTO STRICT nr_registro_w
                FROM end_endereco edr 
                WHERE edr.cd_sistema_anterior = TO_CHAR(skz_w) AND edr.nr_seq_catalogo = NR_CATALOGO_P;

                if (nr_registro_w = 0) then
                    --INSERT INTO LOG (DS_LOG) VALUES ('skz_w nao existe: ' || skz_w);
                    INSERT INTO end_endereco(
                        nr_sequencia,
                        dt_atualizacao, 
                        nm_usuario, 
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_catalogo,
                        ie_informacao, 
                        nr_seq_superior,
                        ds_endereco, 
                        cd_postal,
                        cd_sistema_anterior,
                        ds_endereco_completo, 
                        ie_situacao
                    ) 
                    SELECT 
                        nextval('end_endereco_seq'),           -- nr_sequencia
                        clock_timestamp(),                            -- dt_atualizacao
                        NM_USUARIO_P,                       -- nm_usuario
                        clock_timestamp(),                            -- dt_atualizacao_nrec
                        NM_USUARIO_P,                       -- nm_usuario_nrec
                        NR_CATALOGO_P,                      -- nr_seq_catalogo
                        rua_vialidade,                    -- ie_informacao          
                        strt.nr_sequencia,                  -- nr_seq_superior
                        strt.strassenname,                  -- ds_endereco
                        strt.plz,                           -- cd_postal
                        strt.skz,                           -- cd_sistema_anterior
                        (strt.strassenname || virgula_espaco  ||  
                                strt.ds_endereco_completo), -- ds_endereco_completo  
                        situacao                       -- ie_situacao
                    FROM (
                            SELECT DISTINCT     
                                    plz_w as plz,                          -- Code of Zip Code
                                    endr.nr_sequencia,                -- Code of District recod on end_endereco
                                    endr.ds_endereco_completo,        -- Full address description of the District
                                    skz_w as skz ,                         -- Street Code
                                    strassenname_w as strassenname                  -- Street Name
                            FROM end_endereco endr WHERE endr.cd_sistema_anterior = okz_w 
                                    AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same City
                         ) strt LIMIT 1; -- Only new Streets    
                else
                    --INSERT INTO LOG (DS_LOG) VALUES ('skz_w existe: ' || skz_w);
                    UPDATE end_endereco
                    SET(dt_atualizacao,
                         nm_usuario,  
                         ds_endereco, 
                         nr_seq_superior,
                         ds_endereco_completo, 
                         ie_situacao) =
                                        (
                                        SELECT --DISTINCT
                                            clock_timestamp(),                            -- dt_atualizacao
                                            NM_USUARIO_P,                       -- nm_usuario
                                            strt.strassenname,                  -- ds_endereco
                                            strt.nr_sequencia,                  -- nr_seq_superior
                                            (strt.strassenname || virgula_espaco ||  
                                                    strt.ds_endereco_completo), -- ds_endereco_completo  
                                            situacao                       -- ie_situacao
                                        FROM (
                                                SELECT 
                                                        plz_w as plz,                     -- Code of Zip Code
                                                        endr.nr_sequencia,                -- Code of District recod on end_endereco
                                                        endr.ds_endereco_completo,        -- Full address description of the District
                                                        skz_w as skz ,                    -- Street Code
                                                        strassenname_w as strassenname    -- Street Name
                                                FROM end_endereco endr 
                                                WHERE endr.cd_sistema_anterior = okz_w
                                                        AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same City
                                             ) strt LIMIT 1)
                    WHERE cd_sistema_anterior = skz_w AND nr_seq_catalogo = NR_CATALOGO_P;
                end if;
                skz_last_w := skz_w;
            end if;

            if (adrcd_last_w != adrcd_w) then
                hausnrzahl1_varchar_w       := COALESCE(TO_CHAR(hausnrzahl1_w), espaco);
                hausnrbuchstabe1_varchar_w  := COALESCE(TO_CHAR(hausnrbuchstabe1_w), espaco);

                SELECT COUNT(*) 
                INTO STRICT nr_registro_w
                FROM end_endereco edr 
                WHERE edr.cd_sistema_anterior = TO_CHAR(adrcd_w) AND edr.nr_seq_catalogo = NR_CATALOGO_P;

                if (nr_registro_w = 0) then

                    INSERT INTO end_endereco(
                        nr_sequencia,
                        dt_atualizacao, 
                        nm_usuario, 
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_seq_catalogo,
                        ie_informacao, 
                        nr_seq_superior,
                        ds_endereco, 
                        cd_postal,
                        cd_sistema_anterior,
                        ds_endereco_completo, 
                        ie_situacao
                    ) 
                    SELECT 
                        nextval('end_endereco_seq'),           -- nr_sequencia
                        clock_timestamp(),                            -- dt_atualizacao
                        NM_USUARIO_P,                       -- nm_usuario
                        clock_timestamp(),                            -- dt_atualizacao_nrec
                        NM_USUARIO_P,                       -- nm_usuario_nrec
                        NR_CATALOGO_P,                      -- nr_seq_catalogo
                        numero,                           -- ie_informacao          
                        hsnm.nr_sequencia,                  -- nr_seq_superior
                        hsnm.hausnrzahl1,                   -- ds_endereco
                        hsnm.plz,                           -- cd_postal
                        hsnm.adrcd,                         -- cd_sistema_anterior
                        (hsnm.hausnrzahl1 || hsnm.hausnrbuchstabe1 || virgula_espaco ||  
                                hsnm.ds_endereco_completo), -- ds_endereco_completo  
                        situacao                       -- ie_situacao
                    FROM (
                            SELECT 
                                    plz_w as plz,                                       -- Code of Zip Code
                                    adrcd_w as adrcd,							        -- codigo id
                                    okz_w as okz,                                       -- City Code
                                    endr.nr_sequencia,                                  -- Code of Street record on end_endereco
                                    endr.ds_endereco_completo,                          -- Full address description of the Street
                                    ortsname_w as ortsname,                             -- City Name
                                    hausnrzahl1_varchar_w as hausnrzahl1,                       -- House Number
                                    hausnrbuchstabe1_varchar_w hausnrbuchstabe1   -- House Letter
                            FROM end_endereco endr 
                            WHERE endr.cd_sistema_anterior = skz_w AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same Street
                         ) hsnm LIMIT 1;

                else
                    --INSERT INTO LOG (DS_LOG) VALUES ('adrcd_w existe: ' || adrcd_w);
                    UPDATE end_endereco
                    SET(dt_atualizacao,
                         nm_usuario,  
                         ds_endereco, 
                         nr_seq_superior,
                         ds_endereco_completo, 
                         ie_situacao) =
                                        (
                                        SELECT 
                                            clock_timestamp(),                            -- dt_atualizacao
                                            NM_USUARIO_P,                       -- nm_usuario
                                            hsnm.hausnrzahl1,                   -- ds_endereco
                                            hsnm.nr_sequencia,                  -- nr_seq_superior
                                            (hsnm.hausnrzahl1 || hsnm.hausnrbuchstabe1 || virgula_espaco ||  
                                                    hsnm.ds_endereco_completo), -- ds_endereco_completo  
                                            situacao                       -- ie_situacao
                                        FROM (
                                                SELECT 
                                                    plz_w as plz,                                            -- Code of Zip Code
                                                    endr.nr_sequencia,                                  -- Code of Street recod on end_endereco
                                                    endr.ds_endereco_completo,                          -- Full address description of the Street
                                                    hausnrzahl1_varchar_w as hausnrzahl1,                                    -- House Number
                                                    hausnrbuchstabe1_varchar_w hausnrbuchstabe1 -- House Letter
                                                FROM end_endereco endr 
                                                WHERE endr.cd_sistema_anterior = skz_w 
                                                        AND endr.nr_seq_catalogo = NR_CATALOGO_P                     -- Find records with same Street
                                             ) hsnm LIMIT 1)
                    WHERE cd_sistema_anterior = adrcd_w AND nr_seq_catalogo = NR_CATALOGO_P;
                end if;
                adrcd_last_w := adrcd_w;
            end if;

            nr_contador_w := nr_contador_w + 1;
            if (nr_contador_w = 500) then
                commit;
                nr_contador_w := 0;
            end if;
        end;
    end loop;
    close c01;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proccess_address_austria (nr_catalogo_p bigint, nm_usuario_p text default 'TASYLOAD') FROM PUBLIC;

