-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE jpn_insert_dummy_proced_data (nr_atendimento_p bigint, cd_medico_p text, dt_referencia_p timestamp, cd_exame_p text, qt_procedimento_p bigint, nr_seq_empresa_p bigint, nr_prescricao_ext_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_seq_prescr_p INOUT bigint, cd_order_control_p text default null, ds_horarios_p text DEFAULT NULL, ds_inf_adicional_p text default null, nr_controle_lab_p text default null) AS $body$
DECLARE


nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_prescricao_ext_w		prescr_medica.nr_prescricao%type;
nr_sequencia_w			prescr_procedimento.nr_Sequencia%type;
nr_compl_seq_w          prescr_procedimento_compl.nr_sequencia%type;
nr_interno_seq_w        prescr_procedimento.nr_seq_interno%type;
dt_prescricao_w			timestamp;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w		prescr_procedimento.ie_origem_proced%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;
ie_tipo_evol_w			usuario.ie_tipo_evolucao%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_medico_prescri_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_pf_usuario_w			pessoa_fisica.cd_pessoa_fisica%type;
qt_altura_cm_w			prescr_medica.qt_altura_cm%type;
qt_peso_w				prescr_medica.qt_peso%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_seq_proc_interno%type;
cd_material_exame_w		prescr_procedimento.cd_material_exame%type;
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;
cd_perfil_w			    perfil.cd_perfil%type;
dt_referencia_w			timestamp;
ds_erro_w				varchar(4000);
qt_procedimento_w 		prescr_procedimento.qt_procedimento%type;
cd_intervalo_w 			prescr_procedimento.cd_intervalo%type;
ds_horarios_w 			prescr_procedimento.ds_horarios%type;
is_medica_w             varchar(1);
nr_seq_proc_cpoe_w      prescr_procedimento.nr_seq_proc_cpoe%type;
cd_perfil_ativo_w		cpoe_procedimento.cd_perfil_ativo%type;


BEGIN

dt_referencia_w		:= dt_referencia_p;
qt_procedimento_w 	:= qt_procedimento_p;

select nextval('cpoe_procedimento_seq')
into STRICT   nr_seq_proc_cpoe_w
;

if (coalesce(qt_procedimento_w::text, '') = '' or qt_procedimento_w = '') then
  qt_procedimento_w := 1;
end if;

select 	max(a.cd_pessoa_fisica),
		max(a.ie_tipo_evolucao)
into STRICT	cd_pf_usuario_w,
		ie_tipo_evol_w
from	usuario a
where	a.nm_usuario = nm_usuario_p;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	select	max(cd_pessoa_fisica),
			max(cd_medico_resp),
			max(cd_estabelecimento)
	into STRICT	cd_pessoa_fisica_w,
			cd_medico_prescri_w,
			cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

end if;

qt_altura_cm_w	:= obter_sinal_vital(nr_atendimento_p, obter_desc_expressao(283402));
qt_peso_w		:= obter_sinal_vital(nr_atendimento_p, obter_desc_expressao(295698));

select max(cd_perfil_padrao)
into STRICT   cd_perfil_w
from   empresa_integr_dados
where  nr_seq_empresa_integr = nr_seq_empresa_p;

nr_prescricao_w := nr_prescricao_p;

select CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
into STRICT   is_medica_w
from   prescr_medica
where  nr_prescricao = nr_prescricao_w;

if is_medica_w = 'N' then
insert into	prescr_medica( nr_prescricao,
				nr_atendimento,
				cd_pessoa_fisica,
				cd_medico,
				cd_prescritor,
				dt_prescricao,
				dt_atualizacao,
                dt_liberacao,
				nm_usuario,
				nm_usuario_original,
				ie_adep,
				ie_emergencia,
				ie_recem_nato,
				ie_ajusta_validade_atend,
				ie_prescritor_aux,
				ie_paciente_dialise,
				ie_funcao_prescritor,
				ie_origem_inf,
				qt_altura_cm,
				qt_peso,
				dt_inicio_prescr,
				dt_primeiro_horario,
				nr_horas_validade,
				cd_funcao_origem,
				cd_perfil_ativo,
				nr_controle_int_lab,
				cd_estabelecimento,
                nr_controle_lab)
		values (
				nr_prescricao_w,
				nr_atendimento_p,
				cd_pessoa_fisica_w,
				coalesce(cd_medico_p, cd_medico_prescri_w),
				cd_pf_usuario_w,
				dt_referencia_w,
				clock_timestamp(),
                clock_timestamp(),
				'ITECH',
				'ITECH',
				'S',
				'N',
				'N',
				'N',
				'N',
				'N',
				ie_tipo_evol_w,
				1,
				qt_altura_cm_w,
				qt_peso_w,
				dt_referencia_w,
				dt_referencia_w,
				24,
				2314,
				cd_perfil_w,
				(nr_prescricao_ext_p)::numeric ,
				cd_estabelecimento_w,
                nr_controle_lab_p);

insert into prescr_proced_inf_adic(nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                dt_registro,
                nr_prescricao,
                ds_informacao,
                cd_pessoa_fisica,
                ie_situacao,
                dt_liberacao,
                nr_seq_laudo,
                ie_achado_critico)
        values ( nextval('prescr_proced_inf_adic_seq'),
                clock_timestamp(),
                'ITECH',
                clock_timestamp(),
                'ITECH',
                clock_timestamp(),
                nr_prescricao_w,
                ds_inf_adicional_p,
                cd_pessoa_fisica_w,
                'A',
                clock_timestamp(),
                null,
                null
             );

	commit;

end if;

select	max(dt_prescricao),
		max(cd_estabelecimento),
		max(nr_atendimento)
into STRICT 	dt_prescricao_w,
		cd_estabelecimento_w,
		nr_atendimento_w
from 	prescr_medica
where 	nr_prescricao = nr_prescricao_w;


select max(cd_perfil)
into STRICT   cd_perfil_ativo_w
from   perfil
where  ie_situacao = 'A';


select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_sequencia_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_w;

begin
select  max(nr_seq_exame),
        max(cd_procedimento),
        max(ie_origem_proced),
        max(nr_seq_proc_interno)
into STRICT    nr_seq_exame_w,
        cd_procedimento_w,
        ie_origem_proced_w,
        nr_seq_proc_interno_w
from	exame_laboratorio
where   coalesce(cd_exame_integracao, cd_exame) = cd_exame_p;
exception when no_data_found then
    select  max(nr_seq_exame)
    into STRICT    nr_seq_exame_w
    from	exame_laboratorio
    where   (cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
    and     (ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '')
    and     (nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '');

    select	max(cd_procedimento),
            max(ie_origem_proced),
            max(nr_seq_proc_interno)
    into STRICT    cd_procedimento_w,
            ie_origem_proced_w,
            nr_seq_proc_interno_w
    from	exame_laboratorio
    where	nr_seq_exame = nr_seq_exame_w;
end;

if coalesce(nr_seq_proc_interno_w::text, '') = '' then

    select max(nr_sequencia)
    into STRICT   nr_seq_proc_interno_w
    from   proc_interno
    where  (cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
    and    (ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '');

end if;


if (coalesce(cd_procedimento_w::text, '') = '' or coalesce(ie_origem_proced_w::text, '') = '')then

    select max(cd_procedimento), 
		   max(ie_origem_proced) 
	into STRICT   cd_procedimento_w,
		   ie_origem_proced_w
	from   proc_interno 
	where  nr_sequencia = nr_seq_proc_interno_w;

end if;



cd_intervalo_w := Obter_Param_Prescr_Proc_Int(nr_seq_proc_interno_w, null, 'I', null);
ds_horarios_w  := ds_horarios_p;


select  nextval('prescr_procedimento_seq')
into STRICT    nr_interno_seq_w
;


select nextval('prescr_procedimento_compl_seq')
into STRICT   nr_compl_seq_w
;

select max(cd_material_exame)
into STRICT   cd_material_exame_w
from   material_exame_lab;

insert into prescr_procedimento_compl( nr_sequencia,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec,
										ie_status_report)
                            values ( nr_compl_seq_w,
                                        clock_timestamp(),
                                        'ITECH',
                                        clock_timestamp(),
                                        'ITECH',
										'1');

insert	into cpoe_procedimento(
					nr_sequencia,
					qt_procedimento,
					ds_horarios,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_atendimento,
					dt_liberacao,
					cd_pessoa_fisica,
                    cd_perfil_ativo)
          values (
					nr_seq_proc_cpoe_w,
					1,
					ds_horarios_w,
					clock_timestamp(),
					'ITECH',
					clock_timestamp(),
					'ITECH',
					nr_atendimento_p,
					clock_timestamp(),
					cd_pessoa_fisica_w,
                    cd_perfil_ativo_w);
insert into prescr_procedimento( nr_prescricao,
				nr_sequencia,
				cd_procedimento,
				ie_origem_proced,
				qt_procedimento,
				ie_urgencia,
				ie_suspenso,
				dt_prev_execucao,
				ie_status_atend,
				dt_atualizacao,
				nm_usuario,
				ie_origem_inf,
				nr_seq_interno,
				ie_avisar_result,
				cd_motivo_baixa,
				nr_seq_proc_interno,
				cd_perfil_ativo,
				nr_seq_exame,
				cd_material_exame,
				cd_intervalo,
				ds_horarios,
                nr_seq_proc_compl,
                nr_seq_proc_cpoe)
		values (nr_prescricao_w,
				nr_sequencia_w,
				cd_procedimento_w,
				ie_origem_proced_w,
				qt_procedimento_w,
				'N', 
				'N',
				dt_prescricao_w,
				15, 
				clock_timestamp(), 
				'ITECH',
				'1', 
				nr_interno_seq_w,
			    'N',
				1,
				nr_seq_proc_interno_w,
				cd_perfil_w,
				nr_seq_exame_w,
				cd_material_exame_w,
				cd_intervalo_w,
				ds_horarios_w,
                nr_compl_seq_w,
                nr_seq_proc_cpoe_w);
commit;

nr_seq_prescr_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE jpn_insert_dummy_proced_data (nr_atendimento_p bigint, cd_medico_p text, dt_referencia_p timestamp, cd_exame_p text, qt_procedimento_p bigint, nr_seq_empresa_p bigint, nr_prescricao_ext_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_seq_prescr_p INOUT bigint, cd_order_control_p text default null, ds_horarios_p text DEFAULT NULL, ds_inf_adicional_p text default null, nr_controle_lab_p text default null) FROM PUBLIC;

