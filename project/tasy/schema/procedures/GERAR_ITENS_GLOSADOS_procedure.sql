-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_glosados ( nr_interno_conta_p bigint, ie_emite_conta_p bigint, cd_autorizacao_p text, nr_seq_ret_item_p bigint, vl_glosado_p bigint, nm_usuario_p text, cd_procedimento_p text, cd_material_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_motivo_glosa_p text, ds_observacao_p text, cd_area_proc_p text, cd_espec_proc_p text, cd_grupo_proc_p text, cd_grupo_mat_p text, cd_subgrupo_mat_p text, cd_classe_mat_p text, ie_glosar_itens_conta_p text default 'N') AS $body$
DECLARE


cd_procedimento_w 		bigint;
cd_material_w 			bigint;
ie_origem_proced_w		bigint;
cd_procedimento_convenio_w	procedimento_paciente.cd_procedimento_convenio%type;
cd_material_convenio_w		material_atend_paciente.cd_material_convenio%type;
cd_setor_atendimento_w		integer;
nr_seq_material_w		bigint;
nr_seq_procedimento_w		bigint;
nr_seq_ret_item_w		bigint;
ie_emite_conta_w 		bigint;
vl_procedimento_w		double precision;
vl_material_w			double precision;
qt_procedimento_w		double precision;
qt_material_w			double precision;
vl_glosa_w			double precision;
vl_total_materiais_w		double precision;
vl_total_procedimentos_w	double precision;
vl_total_w			double precision;
ds_observacao_w			varchar(4000) := null;
vl_total_glosa_w		double precision;
nr_seq_item_w			bigint;
vl_glosado_w			convenio_retorno_item.vl_amenor%type;
ds_texto_pck_w			varchar(2000);

c01 CURSOR FOR
SELECT	a.cd_procedimento,
	a.ie_origem_proced,
	a.cd_procedimento_convenio,
	a.cd_setor_atendimento,
	a.nr_sequencia,
	a.ie_emite_conta,
	a.vl_procedimento,
	a.qt_procedimento
from	procedimento_paciente a,
	estrutura_procedimento_v b
where	a.cd_procedimento = b.cd_procedimento
and	a.ie_origem_proced = b.ie_origem_proced
and	coalesce(a.ie_emite_conta, '-1')			= COALESCE(to_char(ie_emite_conta_p), coalesce(a.ie_emite_conta, '-1'))
and	a.nr_interno_conta				= nr_interno_conta_p
and	coalesce(a.nr_doc_convenio,ds_texto_pck_w) 		= coalesce(cd_autorizacao_p,ds_texto_pck_w)
and	a.cd_procedimento					= coalesce(cd_procedimento_p, a.cd_procedimento)
and	a.dt_procedimento	 between trunc(coalesce(dt_inicial_p, a.dt_procedimento - 1), 'dd') and trunc(coalesce(dt_final_p, a.dt_procedimento + 1), 'dd')
and	coalesce(cd_area_proc_p,b.cd_area_procedimento) 	= b.cd_area_procedimento
and	coalesce(cd_espec_proc_p,b.cd_especialidade) 	= b.cd_especialidade
and	coalesce(cd_grupo_proc_p,b.cd_grupo_proc)		= b.cd_grupo_proc
and	coalesce(cd_material_p,'X') = 'X'
and	coalesce(cd_grupo_mat_p,'X') = 'X'
and	coalesce(cd_classe_mat_p,'X') = 'X';
/*and	((nvl(cd_area_proc_p,'X') = 'X') or
	 to_char(obter_area_procedimento(a.cd_procedimento,a.ie_origem_proced))		= cd_area_proc_p)
and	((nvl(cd_espec_proc_p,'X') = 'X') or
	 to_char(obter_especialidade_proced(a.cd_procedimento,a.ie_origem_proced))	= cd_espec_proc_p)
and	((nvl(cd_grupo_proc_p,'X') = 'X') or
	 obter_grupo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C')		= cd_grupo_proc_p);*/
C02 CURSOR FOR
SELECT	b.cd_material,
	b.cd_material_convenio,
	b.cd_setor_atendimento,
	b.nr_sequencia,
	b.ie_emite_conta,
	b.vl_material,
	b.qt_material
from	estrutura_material_v a,
	material_atend_paciente b
where	coalesce(b.ie_emite_conta, '-1')			= COALESCE(to_char(ie_emite_conta_p), coalesce(b.ie_emite_conta, '-1'))
and	b.cd_material					= a.cd_material
and    	b.nr_interno_conta 				= nr_interno_conta_p
and	coalesce(b.nr_doc_convenio,ds_texto_pck_w) 		= coalesce(cd_autorizacao_p, ds_texto_pck_w)
and	b.cd_material					= coalesce(cd_material_p, b.cd_material)
and	b.dt_atendimento				between trunc(coalesce(dt_inicial_p, dt_atendimento - 1), 'dd') and trunc(coalesce(dt_final_p, dt_atendimento + 1), 'dd')
and	coalesce(cd_grupo_mat_p,a.cd_grupo_material) 	= a.cd_grupo_material
and	coalesce(cd_subgrupo_mat_p,a.cd_subgrupo_material) 	= a.cd_subgrupo_material
and	coalesce(cd_classe_mat_p,a.cd_classe_material) 	= a.cd_classe_material
and	coalesce(cd_area_proc_p,'X') = 'X'
and	coalesce(cd_espec_proc_p,'X') = 'X'
and	coalesce(cd_grupo_proc_p,'X') = 'X';


/*and	((nvl(cd_grupo_mat_p,'X') = 'X') or
	 to_char(a.cd_grupo_material)	= cd_grupo_mat_p)
and	((nvl(cd_subgrupo_mat_p,'X') = 'X') or
	 to_char(a.cd_subgrupo_material)	= cd_subgrupo_mat_p)
and	((nvl(cd_classe_mat_p,'X') = 'X') or
	 to_char(a.cd_classe_material)	= cd_classe_mat_p);	*/
BEGIN

vl_total_materiais_w		:= 0;
vl_total_procedimentos_w	:= 0;
vl_total_w		:= 0;
vl_glosa_w		:= 0;
nr_seq_ret_item_w		:= nr_seq_ret_item_p;
ds_observacao_w		:= substr(ds_observacao_p,1,3999);
vl_total_glosa_w	:= 0;
vl_glosado_w		:= vl_glosado_p;
ds_texto_pck_w		:= substr(Wheb_mensagem_pck.get_Texto(306761),1,2000);--Nao Informada
select	sum(vl_material)
into STRICT	vl_total_materiais_w
from	material_atend_paciente b,
	estrutura_material_v a
where	coalesce(to_char(ie_emite_conta_p),b.ie_emite_conta)			= b.ie_emite_conta
and	b.nr_interno_conta 			= nr_interno_conta_p
and	coalesce(b.nr_doc_convenio,ds_texto_pck_w) = coalesce(cd_autorizacao_p, ds_texto_pck_w)
and	b.dt_atendimento				between trunc(coalesce(dt_inicial_p, dt_atendimento - 1), 'dd') and trunc(coalesce(dt_final_p, dt_atendimento + 1), 'dd')
and	b.cd_material					= a.cd_material
and	coalesce(cd_material_p,b.cd_material)		= b.cd_material
and	coalesce(cd_grupo_mat_p,a.cd_grupo_material) 	= a.cd_grupo_material
and	coalesce(cd_subgrupo_mat_p,a.cd_subgrupo_material) 	= a.cd_subgrupo_material
and	coalesce(cd_classe_mat_p,a.cd_classe_material) 	= a.cd_classe_material
and	coalesce(cd_area_proc_p,'X') = 'X'
and	coalesce(cd_espec_proc_p,'X') = 'X'
and	coalesce(cd_grupo_proc_p,'X') = 'X';

select	sum(vl_procedimento)
into STRICT	vl_total_procedimentos_w
from	procedimento_paciente b,
	estrutura_procedimento_v a
where	coalesce(to_char(ie_emite_conta_p),b.ie_emite_conta)			= b.ie_emite_conta
and	b.nr_interno_conta 			= nr_interno_conta_p
and	a.cd_procedimento	= b.cd_procedimento
and	b.ie_origem_proced	= a.ie_origem_proced
and	coalesce(b.nr_doc_convenio,ds_texto_pck_w) = coalesce(cd_autorizacao_p, ds_texto_pck_w)
and	b.cd_procedimento					= coalesce(cd_procedimento_p, b.cd_procedimento)
and	b.dt_procedimento	 between trunc(coalesce(dt_inicial_p, b.dt_procedimento - 1), 'dd') and trunc(coalesce(dt_final_p, b.dt_procedimento + 1), 'dd')
and	coalesce(cd_area_proc_p,a.cd_area_procedimento) 	= a.cd_area_procedimento
and	coalesce(cd_espec_proc_p,a.cd_especialidade) 	= a.cd_especialidade
and	coalesce(cd_grupo_proc_p,a.cd_grupo_proc)		= a.cd_grupo_proc
and	coalesce(cd_material_p,'X') = 'X'
and	coalesce(cd_grupo_mat_p,'X') = 'X'
and	coalesce(cd_classe_mat_p,'X') = 'X';

if (ie_glosar_itens_conta_p = 'S') and (coalesce(vl_glosado_w,0) = 0) then
	select	coalesce(sum(a.vl_amenor + a.vl_glosado),0)
	into STRICT	vl_glosado_w
	from	convenio_retorno_item a
	where	nr_interno_conta = nr_interno_conta_p
	and	a.nr_sequencia = nr_seq_ret_item_p;
end if;

vl_total_w := 	coalesce(vl_total_materiais_w,0) + coalesce(vl_total_procedimentos_w,0);

open C01;
loop
fetch C01 into
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_procedimento_convenio_w,
	cd_setor_atendimento_w,
	nr_seq_procedimento_w,
	ie_emite_conta_w,
	vl_procedimento_w,
	qt_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	vl_glosa_w	:= coalesce(dividir_sem_round((vl_glosado_w * vl_procedimento_w), vl_total_w),0);
	vl_total_glosa_w	:= coalesce(vl_total_glosa_w,0) + coalesce(vl_glosa_w,0);

	/* ahoffelder - OS 330401 - 22/06/2011 - e necessario porque necessita-se saber qual foi ultimo item gerado para colocar a sobra do valor.
	Nao fazer select max() foram dos cursores, porque pode pegar um item que nao foi gerado por esta procedure. */
	select	nextval('convenio_retorno_glosa_seq')
	into STRICT	nr_seq_item_w
	;

	insert into convenio_retorno_glosa(
		nr_sequencia,
		nr_seq_ret_item,
		vl_glosa,
		dt_atualizacao,
		nm_usuario,
		cd_procedimento, 
		ie_origem_proced, 
		ie_atualizacao,
		cd_item_convenio, 
		qt_glosa, 
		cd_setor_atendimento, 
		nr_seq_propaci, 
		ie_emite_conta, 
		vl_cobrado,
		qt_cobrada,
		cd_motivo_glosa,
		ds_observacao) 
	values (	nr_seq_item_w,
		nr_seq_ret_item_w,
		vl_glosa_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_procedimento_w, 
		ie_origem_proced_w, 
		'N',
		cd_procedimento_convenio_w, 
		qt_procedimento_w,
		cd_setor_atendimento_w, 
		nr_seq_procedimento_w, 
		ie_emite_conta_w, 
		vl_procedimento_w,
		qt_procedimento_w,
		CASE WHEN cd_motivo_glosa_p=0 THEN  null  ELSE cd_motivo_glosa_p END ,
		ds_observacao_w);
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into	
	cd_material_w,
	cd_material_convenio_w,
	cd_setor_atendimento_w,
	nr_seq_material_w,
	ie_emite_conta_w,
	vl_material_w,
	qt_material_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	vl_glosa_w	:= coalesce(dividir_sem_round((vl_glosado_w * vl_material_w), vl_total_w),0);
	vl_total_glosa_w	:= coalesce(vl_total_glosa_w,0) + coalesce(vl_glosa_w,0);

	select	nextval('convenio_retorno_glosa_seq')
	into STRICT	nr_seq_item_w
	;

	insert into convenio_retorno_glosa(
		nr_sequencia,
		nr_seq_ret_item,
		vl_glosa,
		dt_atualizacao,
		nm_usuario,
		cd_material, 
		ie_atualizacao,
		cd_item_convenio, 
		qt_glosa, 
		cd_setor_atendimento, 
		nr_seq_matpaci, 
		ie_emite_conta, 
		vl_cobrado,
		qt_cobrada,
		cd_motivo_glosa,
		ds_observacao) 
	values (	nr_seq_item_w,
		nr_seq_ret_item_w,
		vl_glosa_w, 
		clock_timestamp(),
		nm_usuario_p,
		cd_material_w,
		'N',
		cd_material_convenio_w, 
		qt_material_w,
		cd_setor_atendimento_w, 
		nr_seq_material_w, 
		ie_emite_conta_w, 
		vl_material_w,
		qt_material_w,
		CASE WHEN cd_motivo_glosa_p=0 THEN  null  ELSE cd_motivo_glosa_p END ,
		ds_observacao_w);
	end;
end loop;
close C02;

/* ahoffelder - OS 330401 - 22/06/2011 - colocar a sobra no ultimo item */

update	convenio_retorno_glosa
--set	vl_glosa	= nvl(vl_glosa,0) + (nvl(vl_glosado_p,0) - nvl(vl_total_glosa_w,0))
set	vl_glosa	= coalesce(vl_glosa,0) + (coalesce(vl_glosado_w,0) - coalesce(vl_total_glosa_w,0))
where	nr_seq_ret_item	= nr_seq_ret_item_w
and	nr_sequencia	= nr_seq_item_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_glosados ( nr_interno_conta_p bigint, ie_emite_conta_p bigint, cd_autorizacao_p text, nr_seq_ret_item_p bigint, vl_glosado_p bigint, nm_usuario_p text, cd_procedimento_p text, cd_material_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_motivo_glosa_p text, ds_observacao_p text, cd_area_proc_p text, cd_espec_proc_p text, cd_grupo_proc_p text, cd_grupo_mat_p text, cd_subgrupo_mat_p text, cd_classe_mat_p text, ie_glosar_itens_conta_p text default 'N') FROM PUBLIC;

