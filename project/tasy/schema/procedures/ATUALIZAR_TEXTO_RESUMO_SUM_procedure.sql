-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_texto_resumo_sum ( nr_seq_atend_sumario_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_html_p text default null) AS $body$
DECLARE


nr_ordem_w			integer;
nm_exame_w			varchar(500);
nr_exame_w			varchar(20);
ds_auxiliar_w		varchar(10000);
qt_tabela_w			smallint;
ds_titulo_w			varchar(255);
qt_reg_w			bigint;
ds_texto_w			varchar(32000);
ds_conteudo_1_w		varchar(32764);
ds_conteudo_2_w		varchar(32764);
ds_conteudo_3_w		text;
ds_evolucao_w		varchar(10000);
ds_cirurgia_w		varchar(2000);
nr_seq_conversao_w	bigint;
ds_tipo_descricao_w		varchar(60);
ds_resumo_cirurgia_w	varchar(2000);
ds_diagnostico_w		varchar(2000);
ds_diagnostico_pos_w	varchar(2000);
ds_exame_rad_w			varchar(2000);
ds_exame_anatomo_w		varchar(2000);
ds_intercorrencia_w		varchar(2000);
ds_achados_operatorios_w	varchar(2000);
ds_po_imediato_w		varchar(2000);
nr_seq_cirurgia_w		bigint;
ds_doenca_cid_w			varchar(255);
qt_resultado_w			double precision;
ds_resultado_w			varchar(255);
ds_result_format_w		varchar(300);
dt_evolucao_w			timestamp;
nm_usuario_evol_w		varchar(200);
ds_dados_evol_w			varchar(300);
cd_medico_cirurgiao_w	varchar(10);
dt_inicio_real_w		timestamp;
nm_medico_w				varchar(150);
dt_cid_diag_w			timestamp;
ds_campo_clob_w			text;
ds_resumo_long_w		text;
nr_seq_precaucao_w		bigint;
ds_observacao_w			varchar(2000);
ds_motivo_isolamento_w	varchar(255);
ds_classificacao_doenca_w	DIC_EXPRESSAO.DS_EXPRESSAO_BR%type;
ds_estado_resolucao_w   	DIC_EXPRESSAO.DS_EXPRESSAO_BR%type;
cd_versao_w              	DIC_EXPRESSAO.DS_EXPRESSAO_BR%type;
ie_origem_proced_w        PROCEDIMENTO.IE_ORIGEM_PROCED%type;
cd_procedimento_w         PROCEDIMENTO.CD_PROCEDIMENTO%type;
dt_versao_w   	          PROCEDIMENTO_VERSAO.DT_VERSAO%type;
dt_entrada_w			timestamp;
dt_termino_w			timestamp;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
qt_registros_w			bigint;
ds_quebra_w			varchar(20)	:= chr(10);
ie_sbis_w			varchar(1);

C01 CURSOR FOR
	SELECT	1 nr_ordem,
			substr(Obter_desc_tipo_evolucao(ie_evolucao_clinica),1,200) nm_exame,
			to_char(b.cd_evolucao) nr_exame
	from	atend_sumario_alta_item a,
			evolucao_paciente b
	where	a.cd_evolucao = b.cd_evolucao
	and		nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		a.ie_tipo_item = 'V'
	order by a.nr_sequencia desc;

C02 CURSOR FOR
	SELECT 	2 nr_ordem,
			substr(b.ds_doenca_cid || CASE WHEN coalesce(obter_tipo_diag_classif(c.ie_tipo_diag_classif)::text, '') = '' THEN null  ELSE ' - ' || obter_tipo_diag_classif(c.ie_tipo_diag_classif) END  ||
			CASE WHEN coalesce(get_diagnosis_status(c.cd_doenca,c.nr_atendimento)::text, '') = '' THEN null  ELSE ' - ' || SUBSTR(OBTER_VALOR_DOMINIO(8221,(get_diagnosis_status(A.CD_DOENCA,C.NR_ATENDIMENTO))),1,255) END ,1,500) nm_exame,
			a.cd_doenca nr_exame,
      case
        when (DT_FIM IS NOT NULL AND DT_FIM::text <> '') then obter_desc_expressao(948418)--Resolvido
        when (DT_INICIO IS NOT NULL AND DT_INICIO::text <> '') then obter_desc_expressao(1074595)--Resolvendo
        else obter_desc_expressao(291833)--Indeterminado
      end ds_estado_resolucao,
      obter_valor_dominio(58, c.IE_CLASSIFICACAO_DOENCA) DS_CLASSIFICACAO_DOENCA,
      obter_valor_dominio(3224, b.cd_versao) cd_versao
	from 	atend_sumario_alta_item a,
			cid_doenca b,
			diagnostico_doenca c
	where	a.cd_doenca = b.cd_doenca_cid
	and		c.cd_doenca = a.cd_doenca
	and		a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		c.nr_atendimento = nr_atendimento_p
	and		a.ie_tipo_item = 'D'
	order by	a.nr_sequencia desc;

C03 CURSOR FOR
	SELECT 	5 nr_ordem,
			substr(obter_desc_recomendacao(cd_recomendacao),1,255) nm_exame,
			'' nr_exame,
			substr(ds_auxiliar,1,255) ds_auxiliar
	from 	atend_sumario_alta_item a
	where	nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		ie_tipo_item = 'C'
	order by a.nr_sequencia desc;


C04 CURSOR FOR
	SELECT 	4 nr_ordem,
			b.nm_exame nm_exame,
			to_char(a.nr_seq_exame) nr_exame,
			a.nr_sequencia
	from 	atend_sumario_alta_item a,
			exame_laboratorio b
	where	a.nr_seq_exame =  b.nr_seq_exame
	and		a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		a.ie_tipo_item = 'E'
	
union

	SELECT 	5 nr_ordem,
			substr(obter_desc_procedimento(cd_procedimento, ie_origem_proced),1,255) nm_exame,
			'' nr_exame,
			a.nr_sequencia
	from 	 atend_sumario_alta_item a
	where	a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		coalesce(a.nr_seq_exame::text, '') = ''
	and		a.ie_tipo_item = 'E'
	
union

	select 	6 nr_ordem,
			substr(obter_desc_prescr_proc(b.cd_procedimento,b.ie_origem_proced,b.nr_proc_interno),1,255) nm_exame,
			to_char(b.cd_procedimento) nr_exame,
			a.nr_sequencia
	from 	atend_sumario_alta_item a,
			procedimento b
	where	a.cd_procedimento =  b.cd_procedimento
	and 	a.ie_origem_proced =  b.ie_origem_proced
	and		a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		a.ie_tipo_item = 'P'
	
union

	select	7 nr_ordem,
			substr(obter_exame_agenda(b.cd_procedimento_princ, b.ie_origem_proced, b.nr_seq_proc_interno),1,255) || ' - ' || coalesce(dt_inicio_real,dt_inicio_prevista) || ' - ' || substr(obter_nome_medico(cd_medico_cirurgiao,'N'),1,200) nm_exame,
			to_char(a.nr_cirurgia) nr_exame,
			a.nr_sequencia
	from	atend_sumario_alta_item a,
			cirurgia b
	where	a.nr_cirurgia = b.nr_cirurgia
	and		a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
	and		a.ie_tipo_item = 'I'
	order by 1;

C06 CURSOR FOR
	SELECT	substr(obter_valor_dominio(1424,ie_tipo_descricao),1,60),
			ds_resumo_cirurgia,
			ds_diagnostico,
			ds_diagnostico_pos,
			ds_exame_rad,
			ds_exame_anatomo,
			ds_intercorrencia,
			ds_achados_operatorios,
			ds_po_imediato,
			substr(Obter_Desc_CID_Doenca(cd_doenca_cid),1,255),
			nr_sequencia,
			b.cd_medico_cirurgiao,
			b.dt_inicio_real
	from	cirurgia_descricao a,
			cirurgia b
	where	a.nr_cirurgia = b.nr_cirurgia
	and		b.nr_cirurgia = nr_exame_w;

C07 CURSOR FOR
	SELECT	distinct substr(obter_desc_exame_lab(e.nr_seq_exame,null,null,null),1,255),
			e.qt_resultado
	from	prescr_medica a,
			prescr_procedimento b,
			exame_laboratorio c,
			exame_lab_resultado d,
			exame_lab_result_item e
	where	a.nr_prescricao 	= b.nr_prescricao
	and		c.nr_seq_exame 		= b.nr_seq_exame
	and		d.nr_prescricao 	= a.nr_prescricao
	and		e.nr_seq_resultado 	= d.nr_seq_resultado
	and		e.nr_seq_exame		= c.nr_seq_exame
	and		coalesce(ie_grid_pep,'N') 	= 'S'
	and		coalesce(b.ie_suspenso,'N')	= 'N'
	and		coalesce(c.ie_sumario_alta,'N') = 'S'
	and		a.nr_atendimento 	= nr_atendimento_p
	and		c.nr_seq_exame		= nr_exame_w
	and		a.nr_prescricao		= nr_prescricao_w;

C10 CURSOR FOR
	SELECT	nr_ordem,
			ds_texto
	from	w_sumario_texto_resumo
	where	nm_usuario = nm_usuario_p
	and		nr_atendimento = nr_atendimento_p
	order by nr_sequencia;


C11 CURSOR FOR
	SELECT
		nr_seq_precaucao,
		dt_inicio,
		dt_termino,
		ds_observacao,
		substr(obter_desc_motivo_isolamento(nr_seq_motivo_isol),1,255) ds_motivo_isolamento
	from atendimento_precaucao
	where nr_atendimento = nr_atendimento_p
	order by dt_inicio desc;


	procedure Monta_Texto_resumo(ds_texto_p text, ie_titulo_p text, nr_ordem_p bigint) is
		ds_titulo_w		varchar(100);
		
BEGIN
		if (trim(both ie_titulo_p) = 'S') then
			if (nr_ordem_p = 1) then
				ds_titulo_w := '		* ' || wheb_mensagem_pck.get_texto(307016, null) || ' '; -- Evolucoes
			elsif (nr_ordem_p = 2) then
				ds_titulo_w := '		* ' || wheb_mensagem_pck.get_texto(307017, null) || ' '; -- Diagnosticos
			elsif (nr_ordem_p = 3) then
				ds_titulo_w := '		* ' || wheb_mensagem_pck.get_texto(306711, 'DS_LISTA_PRESCRICAO_W=') || ' '; -- Prescricoes
			elsif (nr_ordem_p = 4) then
				ds_titulo_w := '		* ' || wheb_mensagem_pck.get_texto(307211, null) || ' '; -- Exames/Procedimentos/Cirurgias
			elsif (nr_ordem_p = 5) then
				ds_titulo_w	:= '		* ' || wheb_mensagem_pck.get_texto(307212, null) || ' '; -- Laudo Paciente
			elsif (nr_ordem_p = 8) then
			    ds_titulo_w	:= '		* ' || wheb_mensagem_pck.get_texto(331546, null) || ' '; -- Precaucao / Isolamento
			end if;

      if (ie_html_p = 'S') then
        ds_titulo_w:= '<b>'||ds_titulo_w||'</b>';
      end if;
			insert into w_sumario_texto_resumo(
										nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_atendimento,
										nr_ordem,
										ds_texto,
										dt_registro)
							values ( 	nextval('w_sumario_texto_resumo_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_atendimento_p,
										nr_ordem_p,
										ds_titulo_w,
										clock_timestamp());
		else
			insert into w_sumario_texto_resumo(
										nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_atendimento,
										nr_ordem,
										ds_texto,
										dt_registro)
							values ( 	nextval('w_sumario_texto_resumo_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_atendimento_p,
										nr_ordem_p,
										ds_texto_p,
										clock_timestamp());
		end if;
		commit;
		end;

begin
ds_texto_w := '{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 Courier New;}{\f1\fnil'||
		 'Courier New;}}{\colortbl ;\red0\green0\blue0;}\viewkind4\uc1\pard\cf1\lang1046\f0\fs20 ';--||ds_texto_w  ||'\f1\par }';
delete from w_sumario_texto_resumo
where	nm_usuario = nm_usuario_p
and		nr_atendimento = nr_atendimento_p;

if (ie_html_p	= 'S') then
	ds_quebra_w	:= '<br>';
end if;


commit;

ie_sbis_w := Obter_Valor_Param_Usuario(0, 215, Obter_perfil_Ativo, nm_usuario_p, OBTER_ESTABELECIMENTO_ATIVO);

select	count(*)
into STRICT	qt_reg_w
from	atend_sumario_alta_resumo
where	nr_seq_atend_sumario = nr_seq_atend_sumario_p;
if (qt_reg_w = 0) then
	insert into atend_sumario_alta_resumo(	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											nr_seq_atend_sumario)
								values (		nextval('atend_sumario_alta_resumo_seq'),
											clock_timestamp(),
											nm_usuario_p,
											nr_seq_atend_sumario_p);
end if;

select	count(*)
into STRICT	qt_reg_w
from	atend_sumario_alta_item a,
		evolucao_paciente b
where	a.cd_evolucao = b.cd_evolucao
and		nr_seq_atend_sumario = nr_seq_atend_sumario_p
and		a.ie_tipo_item = 'V';

select 	count(*)
into STRICT	qt_reg_w
from 	atend_sumario_alta_item a,
		cid_doenca b
where	a.cd_doenca = b.cd_doenca_cid
and		a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
and		a.ie_tipo_item = 'D';

if (qt_reg_w > 0) then			/*DIAGNOSTICOS */
	Monta_Texto_resumo('', 'S', 2);

	open C02;
	loop
	fetch C02 into
			nr_ordem_w,
			nm_exame_w,
			nr_exame_w,
      ds_estado_resolucao_w,
      ds_classificacao_doenca_w,
      cd_versao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			select	max(substr(obter_medico_diagnostico(b.nr_atendimento,b.dt_diagnostico,'N'),1,150)),
					max(coalesce(dt_cid,dt_diagnostico))
			into STRICT	nm_medico_w,
					dt_cid_diag_w
			from	diagnostico_doenca b
			where	b.cd_doenca = nr_exame_w
			and	b.nr_atendimento = nr_atendimento_p;

			Monta_Texto_resumo(wheb_mensagem_pck.get_texto(306727, 'DS_DATA=' || dt_cid_diag_w) ||' - '||nm_medico_w,'',nr_ordem_w);
			if (ie_sbis_w <> 1) then
			  Monta_Texto_resumo(nm_exame_w,'',nr_ordem_w);
      else
        Monta_Texto_resumo(obter_desc_expressao(1074824) || ': ' || obter_desc_expressao(284902), null, nr_ordem_w);
        Monta_Texto_resumo(nr_exame_w || ' ' || nm_exame_w, null, nr_ordem_w);
        Monta_Texto_resumo(obter_desc_expressao(285080) || ': ' || coalesce(ds_classificacao_doenca_w, '---'), null, nr_ordem_w);
        Monta_Texto_resumo(obter_desc_expressao(1074597) || ': ' || obter_desc_expressao(284052), null, nr_ordem_w);
        Monta_Texto_resumo(obter_desc_expressao(1074593) || ': ' || coalesce(ds_estado_resolucao_w, '---'), null, nr_ordem_w);
        Monta_Texto_resumo(obter_desc_expressao(301639) || ': ' || coalesce(cd_versao_w, '---'), null, nr_ordem_w);
	      Monta_Texto_resumo(null, 'N', nr_ordem_w);
      end if;

			end;
	end loop;
	close C02;
end if;


select 	count(*)
into STRICT	qt_reg_w
from 	atend_sumario_alta_item a
where	nr_seq_atend_sumario = nr_seq_atend_sumario_p
and		ie_tipo_item = 'C';

if (qt_reg_w > 0) then			/*CONDUTAS(RECOMENDACOES) */
	Monta_Texto_resumo('', 'N', 3); -- Espaco antes do titulo
	Monta_Texto_resumo('', 'S', 3);

	open C03;
	loop
	fetch C03 into
			nr_ordem_w,
			nm_exame_w,
			nr_exame_w,
			ds_auxiliar_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			--Monta_Texto_resumo(nm_exame_w,'',nr_ordem_w);
			Monta_Texto_resumo(ds_auxiliar_w,'',nr_ordem_w);
			end;
	end loop;
	close C03;
end if;


select 	count(*)
into STRICT	qt_reg_w
from 	atend_sumario_alta_item a
where	a.nr_seq_atend_sumario = nr_seq_atend_sumario_p
and		a.ie_tipo_item in ('E','P','I');

if (qt_reg_w > 0) then			/*EXAMES/PROCEDIMENTOS/CIRURGIAS */
	Monta_Texto_resumo('', 'N', 3); -- Espaco antes do titulo
	Monta_Texto_resumo('', 'S', 4);

	open C04;
	loop
	fetch C04 into
			nr_ordem_w,
			nm_exame_w,
			nr_exame_w,
			nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			if (nr_ordem_w <> 4) then
				Monta_Texto_resumo(nm_exame_w,'',nr_ordem_w);

        if ((nm_exame_w IS NOT NULL AND nm_exame_w::text <> '') and nr_ordem_W = 6 and ie_sbis_w = 1) then
          select
            dt_entrada
          into STRICT
            dt_entrada_w
          from
           atendimento_paciente
          where
           nr_atendimento = nr_atendimento_p;

         select max(c.ie_origem_proced)
         into STRICT ie_origem_proced_w
         from atend_sumario_alta_item c
         where c.nr_sequencia = nr_sequencia_w;

          select
            max(b.DT_VERSAO)
          into STRICT
            dt_versao_w
          from
            PROCEDIMENTO_VERSAO b,
            atend_sumario_alta_item c
            where c.nr_sequencia = nr_sequencia_w
            and c.cd_procedimento =  b.cd_procedimento
            and c.IE_ORIGEM_PROCED = b.ie_origem_proced
            and obter_se_versao_vigente(b.cd_procedimento, b.IE_ORIGEM_PROCED, dt_entrada_w) = 'S';

          if (ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') then
            Monta_Texto_resumo(obter_desc_expressao(294966) || ': ' || obter_valor_dominio(30, ie_origem_proced_w), null, nr_ordem_w);
          end if;

          if (dt_versao_w IS NOT NULL AND dt_versao_w::text <> '') then
            Monta_Texto_resumo(obter_desc_expressao(301639) || ': ' || to_char(dt_versao_w, 'yyyy'), null, nr_ordem_w);
          end if;

          Monta_Texto_resumo(obter_desc_expressao(726929) || ': ' || obter_desc_expressao(10652291), null, nr_ordem_w);
        end if;
			end if;

			select	max(DS_AUXILIAR)
			into STRICT	nr_prescricao_w
			from	atend_sumario_alta_item
			where	nr_sequencia = nr_sequencia_w;

			if (nr_ordem_w = 4) and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
				begin
				select	count(*)
				into STRICT	qt_registros_w
				from	prescr_medica a,
						prescr_procedimento b,
						exame_laboratorio c,
						exame_lab_resultado d,
						exame_lab_result_item e
				where	a.nr_prescricao 	= b.nr_prescricao
				and		c.nr_seq_exame 		= b.nr_seq_exame
				and		d.nr_prescricao 	= a.nr_prescricao
				and		e.nr_seq_resultado 	= d.nr_seq_resultado
				and		e.nr_seq_exame		= c.nr_seq_exame
				and		coalesce(ie_grid_pep,'N') 	= 'S'
				and		coalesce(b.ie_suspenso,'N')	= 'N'
				and		coalesce(c.ie_sumario_alta,'N') = 'S'
				and		a.nr_atendimento 	= nr_atendimento_p
				and		c.nr_seq_exame		= nr_exame_w
				and		a.nr_prescricao		= nr_prescricao_w;

				if (qt_registros_w > 0) then
					begin
					open C07;
					loop
					fetch C07 into
						ds_resultado_w,
						qt_resultado_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin
						ds_result_format_w := ds_resultado_w || ': ' || replace(rtrim(to_char(qt_resultado_w, 'FM9999990.99'), '.'), '.', ',');
						Monta_Texto_resumo(ds_result_format_w, 'N', 4);
						end;
					end loop;
					close C07;
					Monta_Texto_resumo('', 'N', 4);
					end;
				else
					begin
					Monta_Texto_resumo(nm_exame_w,'',nr_ordem_w);
					Monta_Texto_resumo('', 'N', 4);
					end;
				end if;
				end;
			elsif (nr_ordem_w = 4) then
				begin
				Monta_Texto_resumo(nm_exame_w,'',nr_ordem_w);
				Monta_Texto_resumo('', 'N', 4);
				end;
			end if;

			if (nr_ordem_w = 7) then
					open C06;
					loop
					fetch C06 into
						ds_tipo_descricao_w,
						ds_resumo_cirurgia_w,
						ds_diagnostico_w,
						ds_diagnostico_pos_w,
						ds_exame_rad_w,
						ds_exame_anatomo_w,
						ds_intercorrencia_w,
						ds_achados_operatorios_w,
						ds_po_imediato_w,
						ds_doenca_cid_w,
						nr_seq_cirurgia_w,
						cd_medico_cirurgiao_w,
						dt_inicio_real_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						begin
						Monta_Texto_resumo('', 'N', 7);
						Monta_Texto_resumo('', 'N', 7);
						Monta_Texto_resumo(wheb_mensagem_pck.get_texto(306731, 'NM_MEDICO_W=' || obter_nome_pf(cd_medico_cirurgiao_w)),'N',7); -- Medico cirurgiao: #@NM_MEDICO_W#@
						Monta_Texto_resumo(wheb_mensagem_pck.get_texto(306727, 'DS_DATA=' || dt_inicio_real_w),'N',7); -- Data: #@DS_DATA#@
						Monta_Texto_resumo(wheb_mensagem_pck.get_texto(307013, null) || ': ' || ds_tipo_descricao_w, 'N', 7); -- Tipo descricao
						if (trim(both ds_resumo_cirurgia_w) <> '') then
							Monta_Texto_resumo(ds_resumo_cirurgia_w,'N',7);
						end if;
						if (trim(both ds_diagnostico_w) <> '') then
							Monta_Texto_resumo(ds_diagnostico_w,'N',7);
						end if;
						if (trim(both ds_diagnostico_pos_w) <> '') then
							Monta_Texto_resumo(ds_diagnostico_pos_w,'N',7);
						end if;
						if (trim(both ds_exame_rad_w) <> '') then
							Monta_Texto_resumo(ds_exame_rad_w,'N',7);
						end if;
						if (trim(both ds_exame_anatomo_w) <> '') then
							Monta_Texto_resumo(ds_exame_anatomo_w,'N',7);
						end if;
						if (trim(both ds_intercorrencia_w) <> '') then
							Monta_Texto_resumo(ds_intercorrencia_w,'N',7);
						end if;
						if (trim(both ds_achados_operatorios_w) <> '') then
							Monta_Texto_resumo(ds_achados_operatorios_w,'N',7);
						end if;
						if (trim(both ds_po_imediato_w) <> '') then
							Monta_Texto_resumo(ds_po_imediato_w,'N',7);
						end if;
						if (trim(both ds_doenca_cid_w) <> '') then
							Monta_Texto_resumo(ds_doenca_cid_w,'N',7);
						end if;

						nr_seq_conversao_w := converte_rtf_string( 'select ds_cirurgia
												from cirurgia_descricao
												where nr_sequencia = :nr_sequencia_p', nr_seq_cirurgia_w, 'Tasy', nr_seq_conversao_w);
						begin
							select	ds_texto
							into STRICT	ds_cirurgia_w
							from	tasy_conversao_rtf
							where	nr_sequencia = nr_seq_conversao_w;
						exception
						when others then
							null;
						end;

						end;
					end loop;
					close C06;
			end if;
			end;

				Monta_Texto_resumo(null, 'N', nr_ordem_w);
	end loop;
	close C04;
end if;


select 	count(*)
into STRICT	qt_reg_w
from 	atendimento_precaucao
where 	nr_atendimento = nr_atendimento_p;

if (qt_reg_w > 0) then			/*  Precaucao / Isolamento */
	Monta_Texto_resumo('', 'N', 8); -- Espaco antes do titulo
	Monta_Texto_resumo('', 'S', 8);


	open C11;
	loop
	fetch C11 into
		nr_seq_precaucao_w,
		dt_inicio_real_w,
		dt_termino_w,
		ds_observacao_w,
		ds_motivo_isolamento_w;
	EXIT WHEN NOT FOUND; /* apply on C11 */
				begin

				Monta_Texto_resumo(wheb_mensagem_pck.get_texto(307027) ||': '|| substr(obter_descricao_padrao('CIH_PRECAUCAO','DS_PRECAUCAO',nr_seq_precaucao_w),1,255) ,'N',8);  --Precaucao
				Monta_Texto_resumo(wheb_mensagem_pck.get_texto(307029) ||': '|| ds_motivo_isolamento_w,'N',8); -- Motivo
				ds_texto_w :=  wheb_mensagem_pck.get_texto(331605) ||': '|| to_char(dt_inicio_real_w,'DD/MM/YYYY HH24:MI:SS'); --Inicio
				if (dt_termino_w IS NOT NULL AND dt_termino_w::text <> '') then
					ds_texto_w := ds_texto_w ||' - '||wheb_mensagem_pck.get_texto(331648)||': '|| to_char(dt_termino_w,'DD/MM/YYYY HH24:MI:SS'); --Fim
				end if;
				Monta_Texto_resumo(ds_texto_w,'N',8);
				Monta_Texto_resumo(wheb_mensagem_pck.get_texto(280550) ||': '|| ds_observacao_w,'N',8); -- Observacao
				Monta_Texto_resumo('', 'N', 8);


			end;
	end loop;
	close C11;


end if;


nr_ordem_w		:= null;
ds_auxiliar_w	:= '';
ds_texto_w		:= '';



open C10;
loop
fetch C10 into
	nr_ordem_w,
	ds_auxiliar_w;
EXIT WHEN NOT FOUND; /* apply on C10 */
	begin
	ds_campo_clob_w := ds_campo_clob_w || ds_auxiliar_w;
	ds_campo_clob_w := ds_campo_clob_w || ds_quebra_w;
	end;
end loop;
close C10;

ds_conteudo_1_w := substr(ds_campo_clob_w,32764,1);
ds_conteudo_2_w := substr(ds_campo_clob_w,32764,32765);

ds_resumo_long_w := ds_conteudo_1_w||ds_conteudo_2_w;

SELECT GET_RESUME_SCORE_EPICRISIS(nr_atendimento_p) INTO STRICT ds_conteudo_3_w;


ds_resumo_long_w := ds_resumo_long_w || '<BR>';
ds_resumo_long_w := ds_resumo_long_w || ds_conteudo_3_w;

update	atend_sumario_alta_resumo
set		ds_resumo = ds_resumo_long_w
where	nr_seq_atend_sumario = nr_seq_atend_sumario_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_texto_resumo_sum ( nr_seq_atend_sumario_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_html_p text default null) FROM PUBLIC;

