-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_w_fluxo_drilldown ( nr_seq_fluxo_caixa_p bigint, nr_ordem_compra_p bigint, nr_titulo_p bigint, vl_fluxo_p bigint, nr_autorizacao_p text, nr_cheque_p text, ds_pessoa_p text, ie_integracao_p text, ie_gerar_classif_p text, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w	bigint;
ds_centro_custo_w	varchar(255);
vl_classificacao_w	double precision;


/* Classificação títulos */

c03 CURSOR FOR
SELECT	a.cd_centro_custo,
	obter_desc_centro_custo(a.cd_centro_custo),
	sum(a.vl_classificacao)
from	titulo_receber_classif a
where	a.nr_titulo	= nr_titulo_p
and	ie_integracao_p	= 'CR'
group by
	a.cd_centro_custo

union all

select	a.cd_centro_custo,
	obter_desc_centro_custo(a.cd_centro_custo),
	sum(a.vl_titulo)
from	titulo_pagar_classif a
where	a.nr_titulo	= nr_titulo_p
and	ie_integracao_p	= 'CP'
group by
	a.cd_centro_custo;


BEGIN

if (ie_gerar_classif_p = 'S') then
	open c03;
	loop
	fetch c03 into
		cd_centro_custo_w,
		ds_centro_custo_w,
		vl_classificacao_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		insert	into	w_fluxo_drilldown(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_fluxo,
			nr_titulo,
			nr_ordem_compra,
			nr_autorizacao,
			nr_cheque,
			vl_fluxo,
			ds_item,
			ie_integracao,
			cd_centro_custo,
			ds_centro_custo,
			vl_classificacao)
		values (nextval('w_fluxo_drilldown_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_fluxo_caixa_p,
			CASE WHEN nr_titulo_p=0 THEN null  ELSE nr_titulo_p END ,
			CASE WHEN nr_ordem_compra_p=0 THEN null  ELSE nr_ordem_compra_p END ,
			nr_autorizacao_p,
			nr_cheque_p,
			vl_fluxo_p,
			ds_pessoa_p,
			ie_integracao_p,
			cd_centro_custo_w,
			ds_centro_custo_w,
			vl_classificacao_w);
	end loop;
	close c03;
else

	insert	into	w_fluxo_drilldown(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_fluxo,
		nr_titulo,
		nr_ordem_compra,
		nr_autorizacao,
		nr_cheque,
		vl_fluxo,
		ds_item,
		ie_integracao)
	values (nextval('w_fluxo_drilldown_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_fluxo_caixa_p,
		CASE WHEN nr_titulo_p=0 THEN null  ELSE nr_titulo_p END ,
		CASE WHEN nr_ordem_compra_p=0 THEN null  ELSE nr_ordem_compra_p END ,
		nr_autorizacao_p,
		nr_cheque_p,
		vl_fluxo_p,
		ds_pessoa_p,
		ie_integracao_p);
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_w_fluxo_drilldown ( nr_seq_fluxo_caixa_p bigint, nr_ordem_compra_p bigint, nr_titulo_p bigint, vl_fluxo_p bigint, nr_autorizacao_p text, nr_cheque_p text, ds_pessoa_p text, ie_integracao_p text, ie_gerar_classif_p text, nm_usuario_p text) FROM PUBLIC;

