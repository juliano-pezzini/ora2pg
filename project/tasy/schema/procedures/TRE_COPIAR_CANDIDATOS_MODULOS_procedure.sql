-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tre_copiar_candidatos_modulos (nr_seq_agenda_p bigint, nr_modulo_p bigint, nr_seq_modulo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_setor_usuario_w	integer;
cd_cargo_w		bigint;
cd_cgc_w		varchar(14);
ie_funcionario_w	varchar(1);
ie_cancelamento_w	varchar(1);
ds_observacao_w		varchar(255);
ie_inserir_w		bigint;

c01 CURSOR FOR 	--Buscar todos os candidatos do módulo selecionado.
	SELECT	a.cd_pessoa_fisica,	--Candidato
		a.cd_setor_usuario,	--Setor
		a.cd_cargo,		--Cargo
		a.cd_cgc,		--Empresa
		a.ie_funcionario,	--Funcionário
		a.ie_cancelamento,	--Cancelado
		a.ds_observacao 		--Observação
	from	tre_candidato a,
		tre_agenda_modulo b,
		tre_agenda c
	where	b.nr_sequencia  = a.nr_seq_modulo
	and	c.nr_sequencia  = a.nr_seq_agenda
	and	a.nr_seq_modulo = nr_seq_modulo_p
	and	a.nr_seq_agenda = nr_seq_agenda_p;


BEGIN
open c01;
loop
fetch c01 into	--Localizar candidatos
	cd_pessoa_fisica_w,
	cd_setor_usuario_w,
	cd_cargo_w,
	cd_cgc_w,
	ie_funcionario_w,
	ie_cancelamento_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	count(*)
	into STRICT	ie_inserir_w
	from	tre_candidato a,
		tre_agenda_modulo b
	where	b.nr_sequencia  = a.nr_seq_modulo
	and	a.nr_seq_modulo = nr_modulo_p
	and	a.nr_seq_agenda = nr_seq_agenda_p
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

	if (ie_inserir_w = 0) then
		begin
		insert	into tre_candidato(
			nr_sequencia,
			cd_pessoa_fisica,
			nr_seq_agenda,
			nr_seq_modulo,
			cd_setor_usuario,
			cd_cargo,
			cd_cgc,
			ie_funcionario,
			ie_cancelamento,
			ds_observacao,
			nm_usuario_nrec,
			nm_usuario,
			dt_atualizacao_nrec,
			dt_atualizacao)
		values (nextval('tre_candidato_seq'),
			cd_pessoa_fisica_w,
			nr_seq_agenda_p,
			nr_modulo_p,
			cd_setor_usuario_w,
			cd_cargo_w,
			cd_cgc_w,
			ie_funcionario_w,
			ie_cancelamento_w,
			ds_observacao_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp());
		commit;
		end;
	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tre_copiar_candidatos_modulos (nr_seq_agenda_p bigint, nr_modulo_p bigint, nr_seq_modulo_p bigint, nm_usuario_p text) FROM PUBLIC;

