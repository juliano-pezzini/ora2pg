-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_inserir_regra_ticket ( nr_seq_ticket_medio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_cenario_p bigint) AS $body$
DECLARE





C01 CURSOR FOR  -- Buscar dados da métrica selecionada
	SELECT	cd_centro_custo,
			cd_conta_contabil,
			dt_mes_fim,
			dt_mes_inic,
			ie_padrao_ajuste,
			ie_regra,
			ie_sobrepor,
			nr_seq_cenario,
			nr_seq_grupo_centro,
			nr_seq_grupo_conta,
			nr_seq_mes_ref,
			nr_seq_metrica,
			nr_seq_regra,
			pr_aplicar,
			vl_fixo
	from	ctb_regra_ticket_medio
	where	nr_sequencia 	= nr_seq_ticket_medio_p
	and		nr_seq_cenario	= nr_seq_cenario_p
	and		cd_estabelecimento = cd_estabelecimento_p;

vet01	c01%rowtype;

C02 CURSOR FOR  --Busca os dados do shift f11 (Métricas do orçamento)
	SELECT	a.cd_centro_custo
	from	ctb_orc_metrica a
	where	a.nr_seq_metrica = vet01.nr_seq_metrica
	and		exists (SELECT	1
					from	centro_custo x
					where	a.cd_centro_custo = x.cd_centro_custo
					and		x.ie_situacao = 'A'
					and		x.cd_estabelecimento = cd_estabelecimento_p)
	and		a.cd_centro_custo <> vet01.cd_centro_custo;

vet02	c02%rowtype;


BEGIN

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(vet01.nr_seq_metrica,0) = 0)then
		-- Favor selecionar uma métrica!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(310797);
	end if;

	open C02;
	loop
	fetch C02 into
		vet02;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		insert into ctb_regra_ticket_medio( nr_sequencia,
										cd_centro_custo,
										dt_mes_fim,
										dt_mes_inic,
										ie_padrao_ajuste,
										ie_regra,
										ie_sobrepor,
										nr_seq_cenario,
										nr_seq_grupo_centro,
										nr_seq_grupo_conta,
										nr_seq_mes_ref,
										nr_seq_metrica,
										nr_seq_regra,
										pr_aplicar,
										vl_fixo,
										cd_estabelecimento,
										nm_usuario,
										dt_atualizacao,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										cd_conta_contabil)
								values (nextval('ctb_regra_ticket_medio_seq'),
										vet02.cd_centro_custo,
										vet01.dt_mes_fim,
										vet01.dt_mes_inic,
										vet01.ie_padrao_ajuste,
										vet01.ie_regra,
										vet01.ie_sobrepor,
										vet01.nr_seq_cenario,
										vet01.nr_seq_grupo_centro,
										vet01.nr_seq_grupo_conta,
										vet01.nr_seq_mes_ref,
										vet01.nr_seq_metrica,
										vet01.nr_seq_regra,
										vet01.pr_aplicar,
										vet01.vl_fixo,
										cd_estabelecimento_p,
										nm_usuario_p,
										clock_timestamp(),
										clock_timestamp(),
										nm_usuario_p,
										vet01.cd_conta_contabil);


		end;
	end loop;
	close C02;




	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_inserir_regra_ticket ( nr_seq_ticket_medio_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_cenario_p bigint) FROM PUBLIC;

