-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_fim_consulta_oft ( nr_seq_consulta_p bigint, nr_seq_status_atual_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

					

dt_alteracao_w		timestamp;
nr_seq_status_novo_w	bigint;
nr_seq_agenda_w	        agenda_paciente.nr_sequencia%type;
ie_agenda_w		varchar(2) := 'CI';
nr_atendimento_w  atendimento_paciente.nr_atendimento%type;
					

BEGIN

	
if (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '') then

	select	coalesce(max(nr_atendimento),0)
	into STRICT	nr_atendimento_w
	from	oft_consulta
	where	nr_sequencia = nr_seq_consulta_p;


	select 	 max(a.dt_atualizacao),
		 max(a.nr_seq_status)
	into STRICT	 dt_alteracao_w,
		 nr_seq_status_novo_w
	from     oft_log_status_consulta a
	where    a.nr_sequencia = (SELECT max(b.nr_sequencia)
          		 	   from	  oft_log_status_consulta b    
			 	   where  b.nr_seq_consulta = nr_seq_consulta_p
				   and    b.nr_seq_status   <> nr_seq_status_atual_p);
	
	update	oft_consulta
	set	dt_fim_consulta		 = NULL,
		nr_seq_status		=	nr_seq_status_novo_w
	where	nr_sequencia		=	nr_seq_consulta_p;
	
	if (nr_atendimento_w > 0) then
		update	atendimento_paciente
		set	dt_fim_consulta		 = NULL
		where	nr_atendimento		= nr_atendimento_w
		and	ie_tipo_atendimento	= 3;
	end if;	
	
	commit;
	
	select 	max(nr_sequencia)
	into STRICT	nr_seq_agenda_w
	from   	agenda_paciente
	where  	ie_status_agenda not in ('L','C','E')
	and	nr_atendimento = (	SELECT	max(nr_atendimento)
					from	oft_consulta
					where	nr_sequencia = nr_seq_consulta_p);
					
	if (coalesce(nr_seq_agenda_w::text, '') = '') then
		select 	max(nr_sequencia)
		into STRICT	nr_seq_agenda_w
		from   	agenda_consulta
		where  	ie_status_agenda not in ('L','C','E')
		and	nr_atendimento = (	SELECT	max(nr_atendimento)
						from	oft_consulta
						where	nr_sequencia = nr_seq_consulta_p);
						
		ie_agenda_w := 'C';
	end if;

	if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		CALL executar_evento_agenda('DFCO', ie_agenda_w, nr_seq_agenda_w, cd_estabelecimento_p, nm_usuario_p);
	end if;
	
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_fim_consulta_oft ( nr_seq_consulta_p bigint, nr_seq_status_atual_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

