-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_movto_banco_pend_js ( nr_titulo_p bigint, --parâmetros pra exec de procedures 
 ie_exec_estorna_tit_p text, ie_exec_gerar_adiant_movto_p text, ie_exec_cheque_p text, --parâmetros para ie_exec_estorna_tit_p 
 nr_seq_baixa_p bigint, ie_commit_p text, ie_gerar_movto_p text, --parâmetros para ie_exec_baixar_movto_p 
 nr_seq_movto_pend_p bigint, vl_baixa_p bigint, ie_commita_p text, nr_bordero_rec_p bigint, nr_seq_conv_receb_p bigint, nr_adiantamento_p bigint, nr_sequencia_baixa_p bigint, --ie_exec_gerar_adiant_movto_p 
 nr_seq_movto_baixa_p bigint, cd_estabelecimento_p bigint, ie_acao_p text, -- 
 nr_seq_cheque_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
nr_adiantamento_w	bigint;

BEGIN
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
	 
	if (ie_exec_estorna_tit_p IS NOT NULL AND ie_exec_estorna_tit_p::text <> '') then 
		begin 
		CALL estornar_tit_receber_liq(nr_titulo_p, nr_seq_baixa_p, clock_timestamp(), nm_usuario_p, 'S','', ie_gerar_movto_p);
		end;
	else 
		begin 
		CALL baixar_movto_banco_pend(nr_seq_movto_pend_p, 
				clock_timestamp(), 
				vl_baixa_p, 
				nr_titulo_p, 
				null, 
				nm_usuario_p, 
				ie_commita_p, 
				nr_bordero_rec_p, 
				nr_seq_conv_receb_p, 
				nr_adiantamento_p, 
				nr_seq_cheque_p, 
				null, 
				null, 
				null, 
				null, 
				nr_sequencia_baixa_p);
		end;
	end if;
 
	if (ie_exec_gerar_adiant_movto_p IS NOT NULL AND ie_exec_gerar_adiant_movto_p::text <> '') then 
		begin 
		nr_adiantamento_w := gerar_adiant_movto_bco_pend(nr_seq_movto_baixa_p, cd_estabelecimento_p, nm_usuario_p, ie_acao_p, nr_adiantamento_w);
		end;
	end if;
 
	if (nr_adiantamento_w IS NOT NULL AND nr_adiantamento_w::text <> '') then 
		begin 
		/*R.aise_application_error(-20011, 
			obter_texto_dic_objeto(105563, wheb_usuario_pck.get_nr_seq_idioma, nr_adiantamento_w || '#@#@'));*/
 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(105563,'DS_DEVOLUCAO_W='||NR_ADIANTAMENTO_W);
		end;
	end if;
 
	if (ie_exec_cheque_p IS NOT NULL AND ie_exec_cheque_p::text <> '') then 
		begin 
		update	cheque_cr 
		set	dt_devolucao = clock_timestamp(), 
			nm_usuario = nm_usuario_p 
		where	nr_seq_cheque = nr_seq_cheque_p;
 
		CALL atualizar_desbloqueio_cheque(nr_seq_cheque_p, nm_usuario_p);
		CALL atualizar_saldo_neg_cheque_cr(nr_seq_cheque_p, nm_usuario_p);
		CALL atualizar_cobranca_cheque(nr_seq_cheque_p, nm_usuario_p);
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_movto_banco_pend_js ( nr_titulo_p bigint,  ie_exec_estorna_tit_p text, ie_exec_gerar_adiant_movto_p text, ie_exec_cheque_p text,  nr_seq_baixa_p bigint, ie_commit_p text, ie_gerar_movto_p text,  nr_seq_movto_pend_p bigint, vl_baixa_p bigint, ie_commita_p text, nr_bordero_rec_p bigint, nr_seq_conv_receb_p bigint, nr_adiantamento_p bigint, nr_sequencia_baixa_p bigint,  nr_seq_movto_baixa_p bigint, cd_estabelecimento_p bigint, ie_acao_p text,  nr_seq_cheque_p bigint, nm_usuario_p text) FROM PUBLIC;

