-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_a560_40 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w		varchar(4000);
cd_unimed_origem_w	varchar(4);
cd_unimed_destino_w	varchar(4);
nr_fatura_w		varchar(11);
vl_total_fatura_w	varchar(14) := null;
nr_nota_debito_w	varchar(11);
dt_ven_nota_w		varchar(8);
nr_seq_ptu_fatura_w	bigint;


BEGIN
if (nr_seq_nota_deb_p IS NOT NULL AND nr_seq_nota_deb_p::text <> '') then
	delete from w_ptu_envio_arq
	where  nm_usuario = nm_usuario_p;

	begin
	select	nr_seq_ptu_fatura
	into STRICT	nr_seq_ptu_fatura_w
	from	pls_lote_contestacao	c,
		ptu_camara_contestacao	b,
		ptu_nota_debito	a
	where	b.nr_sequencia	= a.nr_seq_camara_contest
	and	c.nr_sequencia	= b.nr_seq_lote_contest
	and	a.nr_sequencia	= nr_seq_nota_deb_p;
	exception
	when others then
		nr_seq_ptu_fatura_w := null;
	end;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	lpad(replace(replace(campo_mascara(pls_obter_dados_ptu_fatura(nr_seq_ptu_fatura_w,'VT'),2),',',''),'.',''),14,'0')
		into STRICT	vl_total_fatura_w
		;
	end if;

	select	lpad(a.cd_unimed_origem,4,'0'),
		lpad(a.cd_unimed_destino,4,'0'),
		lpad(a.nr_fatura,11,'0'),
		CASE WHEN coalesce(vl_total_fatura_w::text, '') = '' THEN lpad(replace(replace(campo_mascara(vl_total_fatura,2),',',''),'.',''),14,'0')  ELSE vl_total_fatura_w END ,
		lpad(coalesce(a.nr_nota_debito,'0'),11,'0'),
		lpad(coalesce(to_char(a.dt_ven_nota,'YYYYMMDD'),' '),8,' ')
	into STRICT	cd_unimed_origem_w,
		cd_unimed_destino_w,
		nr_fatura_w,
		vl_total_fatura_w,
		nr_nota_debito_w,
		dt_ven_nota_w
	from	ptu_nota_debito a
	where	a.nr_sequencia = nr_seq_nota_deb_p;

	ds_conteudo_w := '00000001' || '561' || cd_unimed_destino_w || cd_unimed_origem_w || nr_fatura_w || vl_total_fatura_w || '01';

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);

	ds_conteudo_w := '00000002' || '562' || nr_nota_debito_w || dt_ven_nota_w;

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_a560_40 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) FROM PUBLIC;

