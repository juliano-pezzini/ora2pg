-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_repasse_simulacao (nr_seq_prod_plantao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_medico_w			varchar(10);
nr_seq_terceiro_w	bigint;
vl_repasse_w		double precision;
vl_producao_w		double precision;
vl_plantao_w		double precision;
nr_sequencia_w		bigint;

/* Ocorrências */

qt_item_w			bigint;
vl_total_repasse_w	double precision;
vl_total_estorno_w	double precision;
ds_ocorrencia_w		varchar(4000);

c01 CURSOR FOR
SELECT	a.cd_medico,
	a.nr_seq_terceiro,
	a.vl_repasse,
	a.vl_producao,
	a.vl_plantao,
	a.nr_sequencia
from	repasse_producao_plantao a
where	a.nr_seq_prod_plantao	= nr_seq_prod_plantao_p;


BEGIN

open	c01;
loop
fetch	c01 into
	cd_medico_w,
	nr_seq_terceiro_w,
	vl_repasse_w,
	vl_producao_w,
	vl_plantao_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* Lançar estorno */

	insert	into repasse_terceiro_item(cd_medico,
		ds_observacao,
		dt_atualizacao,
		dt_lancamento,
		nm_usuario,
		nr_seq_repasse_prod,
		nr_seq_terceiro,
		nr_sequencia,
		vl_repasse)
	values	(cd_medico_w,
		wheb_mensagem_pck.get_texto(304919)|| nr_seq_prod_plantao_p,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_w,
		nr_seq_terceiro_w,
		nextval('repasse_terceiro_item_seq'),
		(coalesce(vl_producao_w,0) + coalesce(vl_plantao_w,0)) * -1);

	/* Lançar repasse calculado */

	insert	into repasse_terceiro_item(cd_medico,
		ds_observacao,
		dt_atualizacao,
		dt_lancamento,
		nm_usuario,
		nr_seq_repasse_prod,
		nr_seq_terceiro,
		nr_sequencia,
		vl_repasse)
	values (cd_medico_w,
		wheb_mensagem_pck.get_texto(304922) || nr_seq_prod_plantao_p,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_w,
		nr_seq_terceiro_w,
		nextval('repasse_terceiro_item_seq'),
		coalesce(vl_repasse_w,0));

	qt_item_w		:= coalesce(qt_item_w,0) + 1;
	vl_total_repasse_w	:= coalesce(vl_total_repasse_w,0) + coalesce(vl_repasse_w,0);
	vl_total_estorno_w	:= coalesce(vl_total_estorno_w,0) + ((coalesce(vl_producao_w,0) + coalesce(vl_plantao_w,0)) * -1);

end	loop;
close	c01;

update	producao_medica_plantao
set	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	dt_geracao_repasse	= clock_timestamp()
where	nr_sequencia		= nr_seq_prod_plantao_p;

ds_ocorrencia_w	:=	substr(wheb_mensagem_pck.get_texto(304928,'qt_item_w=' || qt_item_w || ';vl_total_estorno_w=' || to_char(vl_total_estorno_w,'999999990.00') || ';qt_item_w=' || qt_item_w || ';vl_total_repasse_w=' || to_char(vl_total_repasse_w,'999999990.00')),1,4000);

CALL gerar_repasse_prod_plantao_log(	nr_seq_prod_plantao_p,
				'F',
				'R',
				ds_ocorrencia_w,
				nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_repasse_simulacao (nr_seq_prod_plantao_p bigint, nm_usuario_p text) FROM PUBLIC;

