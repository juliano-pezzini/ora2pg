-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_situacao_leito_agrup (cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_agrupamento_w		integer;
cd_tipo_acomodacao_w		smallint;
ie_status_unidade_w		varchar(3);
qt_unidade_ocupado_w		integer;
ie_nova_situacao_w		varchar(1);
ie_situacao_w			varchar(1);
ie_status_aguard_higie_w	varchar(1);
ie_status_agrup_w		varchar(3);
nr_seq_interno_w		bigint;
nr_seq_interno_uni_w      bigint;
ie_evento_w			varchar(10);

C01 CURSOR FOR 
	SELECT	a.nr_seq_interno 
	from	unidade_atendimento a 
	where	a.cd_setor_atendimento	= cd_setor_atendimento_p 
	and	a.cd_tipo_acomodacao  <> cd_tipo_acomodacao_w 
	and	a.nr_agrupamento    = nr_agrupamento_w;


BEGIN 
 
if (ie_tipo_p = 'T') then 
	ie_status_aguard_higie_w := obter_param_usuario(3111, 137, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_status_aguard_higie_w);
	ie_evento_w := 'TL';
elsif (ie_tipo_p = 'S') then 
	ie_status_aguard_higie_w := obter_param_usuario(3111, 130, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_status_aguard_higie_w);
	ie_evento_w := 'AR';
end if;
 
select	coalesce(max(nr_agrupamento),0), 
	max(cd_tipo_acomodacao), 
	max(ie_status_unidade), 
	max(ie_situacao) 
into STRICT	nr_agrupamento_w, 
	cd_tipo_acomodacao_w, 
	ie_status_unidade_w, 
	ie_situacao_w 
from	unidade_atendimento 
where	cd_setor_atendimento 	= cd_setor_atendimento_p 
and	cd_unidade_basica	= cd_unidade_basica_p 
and	cd_unidade_compl	= cd_unidade_compl_p 
and	coalesce(ie_inativa_setor_auto,'N') = 'S';
 
if (nr_agrupamento_w > 0) then 
 
	if (ie_situacao_w = 'A') then 
		ie_nova_situacao_w	:= 'I';
	else 
		ie_nova_situacao_w	:= 'A';
	end if;
 
	if (ie_status_unidade_w = 'A') or (ie_status_unidade_w = 'P') then 
	 
		ds_erro_p	:= wheb_mensagem_pck.get_texto(281776,null);
	else 
		select 	count(*) 
		into STRICT	qt_unidade_ocupado_w 
		from	unidade_atendimento 
		where	nr_agrupamento 		= nr_agrupamento_w 
		and	cd_setor_atendimento 	= cd_setor_atendimento_p 
		and (cd_unidade_basica <> cd_unidade_basica_p or cd_unidade_compl <> cd_unidade_compl_p) 
		and	ie_status_unidade in ('A','P');
 
		if (qt_unidade_ocupado_w = 0) then 
		 
			if	((coalesce(ie_status_aguard_higie_w,'N')) = 'S') then 
				ie_status_agrup_w := 'G';
			else 
				ie_status_agrup_w := 'L';
			end if;
		 
 
			update 	unidade_atendimento 
			set	ie_situacao 		= ie_nova_situacao_w, 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp(), 
				ie_status_unidade    = 'L' 
			where	cd_setor_atendimento 	= cd_setor_atendimento_p 
			and	cd_tipo_acomodacao 	= cd_tipo_acomodacao_w 
			and	nr_agrupamento 		= nr_agrupamento_w;
 
			update 	unidade_atendimento 
			set	ie_situacao 		= ie_situacao_w, 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp(), 
				ie_status_unidade	= ie_status_agrup_w 
			where	cd_setor_atendimento 	= cd_setor_atendimento_p 
			and	cd_tipo_acomodacao 	<> cd_tipo_acomodacao_w 
			and	nr_agrupamento 		= nr_agrupamento_w;
			 
			open C01;
			loop 
			fetch C01 into	 
				nr_seq_interno_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin 
				CALL gerar_higienizacao_leito_unid(clock_timestamp(), nm_usuario_p, cd_estabelecimento_p, ie_evento_w, nr_seq_interno_w, null);
				end;
			end loop;
			close C01;
			 
			select max(nr_seq_interno) 
			into STRICT	nr_seq_interno_uni_w 
			from  unidade_atendimento 
			where	cd_setor_atendimento 	= cd_setor_atendimento_p 
			and	cd_tipo_acomodacao 	= cd_tipo_acomodacao_w 
			and	nr_agrupamento 		= nr_agrupamento_w;
			 
			update	sl_unid_atend 
			set 	ie_status_serv = 'C' 
			where	nr_seq_unidade	= nr_seq_interno_uni_w 
			and	coalesce(dt_inicio::text, '') = '';
			 
		else 
			ds_erro_p	:= wheb_mensagem_pck.get_texto(281777,null) || nr_agrupamento_w;
 
		end if;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_situacao_leito_agrup (cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_p text, ds_erro_p INOUT text) FROM PUBLIC;

