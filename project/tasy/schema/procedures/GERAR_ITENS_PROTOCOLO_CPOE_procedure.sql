-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_protocolo_cpoe ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_seq_pend_pac_acao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_transcricao_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_gerar_setor_pa_p text default 'N') AS $body$
DECLARE



qt_casas_w					rep_regra_arredond_dose.qt_casas%type;
qt_peso_w					pessoa_fisica.qt_peso%type;
cd_categoria_convenio_w		atend_categoria_convenio.cd_categoria%type;
cd_plano_convenio_w			atend_categoria_convenio.cd_plano_convenio%type;
cd_convenio_w				convenio.cd_convenio%type;
ie_tipo_convenio_w			convenio.ie_tipo_convenio%type;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
cd_medico_atend_w			atendimento_paciente.cd_medico_resp%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;
nr_seq_item_gerado_w		bigint;
qt_idade_dia_w				bigint;
qt_idade_mes_w				bigint;
qt_idade_ano_w				bigint;
ie_origem_inf_w				varchar(50);
list_itens_w                varchar(4000);


	procedure carregar_dados_paciente is  ---Load the information of patient admission
	
BEGIN
	qt_idade_ano_w				:= (Obter_Idade_PF( cd_paciente_p, clock_timestamp(), 'A'))::numeric;
	qt_idade_mes_w				:= (Obter_Idade_PF( cd_paciente_p, clock_timestamp(), 'MM'))::numeric;
	qt_idade_dia_w				:= (Obter_Idade_PF( cd_paciente_p, clock_timestamp(), 'DI'))::numeric;
	ie_tipo_atendimento_w 		:= obter_tipo_atendimento(nr_atendimento_p);
	cd_setor_atendimento_w		:= obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS');
	nr_seq_agrupamento_w		:= obter_agrupamento_setor(cd_setor_atendimento_w);
	qt_peso_w					:= obter_sinal_vital(nr_atendimento_p, 'Peso');
	cd_convenio_w				:= obter_convenio_atendimento(nr_atendimento_p);
	ie_tipo_convenio_w			:= obter_tipo_convenio(cd_convenio_w);
	cd_categoria_convenio_w		:= obter_cat_conv_atend(nr_atendimento_p, cd_convenio_w);
	cd_plano_convenio_w 		:= obter_plano_atendimento(nr_atendimento_p,'C');
	cd_medico_atend_w			:= obter_medico_resp_atend(nr_atendimento_p,'C');
	
	end;
	
	procedure obter_quantidade_casas_dec is ---Get the decimal number of decimal point
	begin
		select	coalesce(max(qt_casas),0)
		into STRICT	qt_casas_w
		from	rep_regra_arredond_dose
		where	qt_peso_w between qt_peso_inicial and qt_peso_final;
	end;
	
	function obter_origem_inf return;
	end if;
	
	return;
	end;										

begin

if (coalesce(nr_seq_protocolo_p,0) > 0) then
	
	ie_origem_inf_w := obter_origem_inf;	
	carregar_dados_paciente;	
	obter_quantidade_casas_dec;
	list_itens_w := null;
	
	---To generate the medicines of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_medicamento(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_paciente_p, cd_prescritor_p, cd_setor_atendimento_w, nr_seq_agrupamento_w, qt_idade_dia_w, qt_idade_mes_w, qt_idade_ano_w, qt_peso_w, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_oncologia_p, nr_seq_conclusao_apae_p);
	
	---To generate the solutions of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_solucao(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, ie_tipo_atendimento_w, cd_prescritor_p, cd_paciente_p, cd_medico_atend_w, cd_setor_atendimento_w, nr_seq_agrupamento_w, cd_convenio_w, ie_tipo_convenio_w, cd_categoria_convenio_w, cd_plano_convenio_w, qt_idade_dia_w, qt_idade_mes_w, qt_idade_ano_w, qt_peso_w, qt_casas_w, ie_origem_inf_w, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_oncologia_p, nr_seq_conclusao_apae_p);
								
	---To generate the material of protocol on CPOE
	nr_seq_item_gerado_w := cpoe_gerar_prot_material(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_paciente_p, cd_prescritor_p, cd_setor_atendimento_w, nr_seq_agrupamento_w, qt_idade_dia_w, qt_idade_mes_w, qt_idade_ano_w, qt_peso_w, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_oncologia_p, nr_seq_conclusao_apae_p);
					
	---To generate the procedures of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_proc_exame(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, ie_tipo_atendimento_w, cd_prescritor_p, cd_paciente_p, qt_idade_dia_w, qt_idade_mes_w, qt_idade_ano_w, qt_peso_w, cd_medico_atend_w, cd_setor_atendimento_w, nr_seq_agrupamento_w, cd_convenio_w, ie_tipo_convenio_w, cd_categoria_convenio_w, cd_plano_convenio_w, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_oncologia_p, nr_seq_conclusao_apae_p, null, null, 'N', null, ie_gerar_setor_pa_p);
					
	---To generate the recomendations of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_recomendacao(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_paciente_p, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_oncologia_p, nr_seq_conclusao_apae_p);
								
	---To generate the fast diet of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_dieta_jejum(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, nr_seq_item_gerado_w, cd_paciente_p, nr_seq_pend_pac_acao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_transcricao_p, nr_seq_conclusao_apae_p);

	---To generate the enteral nutition of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_dieta_enteral(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, nr_seq_item_gerado_w, cd_paciente_p, nr_seq_pend_pac_acao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_transcricao_p, nr_seq_conclusao_apae_p);

	---To generate the supplementary nutrition of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_suplementar(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, nr_seq_item_gerado_w, cd_paciente_p, nr_seq_pend_pac_acao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_transcricao_p, nr_seq_conclusao_apae_p);
									
	---To generate the oral nutrition of protocol on CPOE
	nr_seq_item_gerado_w := CPOE_Gerar_prot_dieta_oral(		cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, nr_seq_item_gerado_w, cd_paciente_p, nr_seq_pend_pac_acao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_transcricao_p, nr_seq_conclusao_apae_p);		
	
	---To generate the dialysis of protocol on CPOE
	nr_seq_item_gerado_w := cpoe_gerar_prot_dialise(	cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p, qt_peso_w, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_conclusao_apae_p);
								
	---To generate the gasotherapu of protocol on CPOE
	nr_seq_item_gerado_w := cpoe_gerar_prot_gasoterapia(	cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_paciente_p, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_conclusao_apae_p);

	---to generate the hemotherapy of protocol on CPOE
	nr_seq_item_gerado_w := cpoe_gerar_prot_hemoterapia(	cd_protocolo_p, nr_seq_protocolo_p, null, nr_atendimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p, nr_seq_item_gerado_w, nr_seq_pend_pac_acao_p, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, cd_medico_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, nr_seq_conclusao_apae_p);
									
	list_itens_w := cpoe_utils_pck.get_list_itens;
    CALL cpoe_utils_pck.update_status_cpoe_item(list_itens_w);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_protocolo_cpoe ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_seq_pend_pac_acao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_transcricao_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_gerar_setor_pa_p text default 'N') FROM PUBLIC;

