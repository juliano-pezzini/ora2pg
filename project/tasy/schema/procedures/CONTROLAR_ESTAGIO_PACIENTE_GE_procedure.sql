-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE controlar_estagio_paciente_ge ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tipo_acao text) AS $body$
DECLARE


nr_seq_recuperacao_w bigint;

/* 
SIGLAS:
  IN = Iniciar Recuperação
  DI = Desfazer início
  FR = Finalizar Recuperação
  DF = Desfazer fim
*/
BEGIN


if (ie_tipo_acao = 'IN') then

        SELECT	nextval('recuperacao_paciente_seq')
        INTO STRICT	nr_seq_recuperacao_w
;

        INSERT INTO recuperacao_paciente(
          nr_sequencia,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          cd_pessoa_fisica,
          nr_atendimento,
          dt_inicio_recuperacao,
          dt_fim_recuperacao)
        VALUES (
          nr_seq_recuperacao_w,
          clock_timestamp(),
          Obter_Usuario_Ativo(),
          clock_timestamp(),
          Obter_Usuario_Ativo(),
          cd_pessoa_fisica_p,
          nr_atendimento_p,
          clock_timestamp(),
          null
        );
end if;

if (ie_tipo_acao = 'DI') then
          DELETE FROM recuperacao_paciente
          WHERE nr_atendimento = nr_atendimento_p
                and cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;

if (ie_tipo_acao = 'FR') then
          UPDATE recuperacao_paciente
          SET dt_fim_recuperacao = clock_timestamp()
          WHERE nr_atendimento = nr_atendimento_p
                and cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;

if (ie_tipo_acao = 'DF') then
          UPDATE recuperacao_paciente
          SET dt_fim_recuperacao = ''
          WHERE nr_atendimento = nr_atendimento_p
                and cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE controlar_estagio_paciente_ge ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, ie_tipo_acao text) FROM PUBLIC;

