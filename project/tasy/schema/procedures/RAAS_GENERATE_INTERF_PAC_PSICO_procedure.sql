-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE raas_generate_interf_pac_psico ( nr_seq_lote_atend_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_uf_w					w_raas_interf_pac_psico.cd_uf%type;
dt_mesano_referencia_w	w_raas_interf_pac_psico.dt_producao%type;
cd_cnes_usf_w			w_raas_interf_pac_psico.cd_unidade_prestadora%type;
nr_cartao_nac_sus_w		w_raas_interf_pac_psico.cd_cartao_saude_paciente%type;
dt_admissao_w			w_raas_interf_pac_psico.dt_inicial_validade%type;
dt_conclusao_w			w_raas_interf_pac_psico.dt_final_validade%type;
nm_paciente_w			w_raas_interf_pac_psico.nm_paciente%type;
nr_prontuario_w			w_raas_interf_pac_psico.nr_prontuario%type;
nm_mae_paciente_w		w_raas_interf_pac_psico.nm_mae_paciente%type;
ds_logradouro_w			w_raas_interf_pac_psico.ds_logradouro%type;
nr_residencia_w			w_raas_interf_pac_psico.nr_residencia%type;
ds_complemento_w		w_raas_interf_pac_psico.ds_complemento%type;
cd_cep_w				w_raas_interf_pac_psico.cd_cep%type;
cd_municipio_ibge_w		w_raas_interf_pac_psico.cd_municipio_ibge%type;
dt_nascimento_w			w_raas_interf_pac_psico.dt_nascimento%type;
ie_sexo_w				w_raas_interf_pac_psico.ie_sexo%type;
ds_raca_w				w_raas_interf_pac_psico.ds_raca%type;
ds_nome_responsavel_w	w_raas_interf_pac_psico.ds_nome_responsavel%type;
cd_nacionalidade_w		w_raas_interf_pac_psico.cd_nacionalidade%type;
cd_etnia_w				w_raas_interf_pac_psico.cd_etnia%type;
nr_telefone_w			w_raas_interf_pac_psico.nr_telefone%type;
nr_celular_w			w_raas_interf_pac_psico.nr_celular%type;
cd_motivo_saida_w		w_raas_interf_pac_psico.cd_motivo_saida%type;
dt_ocorrencia_w			w_raas_interf_pac_psico.dt_ocorrencia%type;
cd_cid_principal_w		w_raas_interf_pac_psico.cd_cid_principal%type;
cd_cid_causas_assoc_w	w_raas_interf_pac_psico.cd_cid_causas_assoc%type;
cd_carater_atend_w		w_raas_interf_pac_psico.cd_carater_atend%type;
cd_origem_paciente_w	w_raas_interf_pac_psico.cd_origem_paciente%type;
ie_cobertura_estrat_w	w_raas_interf_pac_psico.ie_cobertura_familiar%type;
cd_estab_esf_w			w_raas_interf_pac_psico.cd_estab_esf%type;
qt_total_acoes_w		w_raas_interf_pac_psico.qt_total_acoes%type;
ie_emcaminhamento_w		w_raas_interf_pac_psico.cd_destino_paciente%type;
ie_situacao_rua_w		w_raas_interf_pac_psico.ie_situacao_rua%type;
ie_usu_alcool_droga_w	w_raas_interf_pac_psico.ie_usuario_drogas%type;
ie_crack_w				w_raas_interf_pac_psico.ie_usuario_crack%type;
ie_alcool_w				w_raas_interf_pac_psico.ie_usuario_alcool%type;
ie_outras_drogas_w		w_raas_interf_pac_psico.ie_usuario_outros%type;
nr_autorizacao_w		w_raas_interf_pac_psico.nr_autorizacao%type;

c01 CURSOR FOR
SELECT	esus_obter_codigo_uf(obter_compl_pf(a.cd_pessoa_fisica,1,'UF')) cd_uf,
		a.dt_mesano_referencia,
		a.cd_cnes_usf,
		substr(b.nr_cartao_nac_sus,1,15) nr_cartao_nac_sus,
		a.dt_admissao,
		a.dt_conclusao,
		substr(obter_nome_pf(a.cd_pessoa_fisica),1,30) nm_paciente,
		b.nr_prontuario,
		substr(obter_nome_mae(a.cd_pessoa_fisica),1,30) nm_mae_paciente,
		substr(obter_compl_pf(a.cd_pessoa_fisica,1,'EN'),1,30) ds_logradouro,
		obter_compl_pf(a.cd_pessoa_fisica,1,'NR') nr_residencia,
		substr(obter_compl_pf(a.cd_pessoa_fisica,1,'CO'),1,10) ds_complemento,
		obter_compl_pf(a.cd_pessoa_fisica,1,'CEP') cd_cep,
		obter_compl_pf(a.cd_pessoa_fisica,1,'CDMDV') cd_municipio_ibge,
		b.dt_nascimento,
		b.ie_sexo,
		lpad(sus_obter_cor_pele(a.cd_pessoa_fisica,'C'),2,0) ds_raca,
		substr(coalesce(obter_nome_responsavel(a.nr_atendimento),CASE WHEN obter_se_pf_menor_idade(a.cd_pessoa_fisica,clock_timestamp())='N' THEN obter_nome_pf(a.cd_pessoa_fisica)  ELSE obter_nome_mae(a.cd_pessoa_fisica) END ),1,30) ds_nome_responsavel,
		b.cd_nacionalidade,
		sus_obter_etnia(a.cd_pessoa_fisica,'C') cd_etnia,
		somente_numero_char(obter_compl_pf(a.cd_pessoa_fisica,1,'T')) nr_telefone,
		somente_numero_char(b.nr_telefone_celular) nr_celular,
		obter_motivo_alta_sus(a.nr_atendimento) cd_motivo_saida,
		case	when obter_motivo_alta_sus(a.nr_atendimento) in (41,42,43) then b.dt_obito
				when obter_motivo_alta_sus(a.nr_atendimento) in (11,12,13,14,15,16,17,18,19) then obter_dt_alta_medica(a.nr_atendimento) end dt_ocorrencia,
		a.cd_cid_principal,
		a.cd_cid_causas_assoc,
		lpad(obter_carater_atend(a.nr_atendimento),2,0) cd_carater_atend,
		a.cd_origem_paciente,
		a.ie_cobertura_estrat,
		CASE WHEN a.ie_cobertura_estrat='S' THEN a.cd_estabelecimento END  cd_estab_esf,
		(select count(*) from raas_acoes_atencao_psico where nr_seq_atend_atenc_psi = a.nr_sequencia) qt_total_acoes,
		a.ie_emcaminhamento,
		a.ie_situacao_rua,
		a.ie_usu_alcool_droga,
		a.ie_crack,
		a.ie_alcool,
		a.ie_outras_drogas,
		a.nr_autorizacao
from	raas_atend_atencao_psico a,
		pessoa_fisica b
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
and		a.nr_seq_lote_atend = nr_seq_lote_atend_p;


BEGIN

open c01;
loop
fetch c01 into
	cd_uf_w,
	dt_mesano_referencia_w,
	cd_cnes_usf_w,
	nr_cartao_nac_sus_w,
	dt_admissao_w,
	dt_conclusao_w,
	nm_paciente_w,
	nr_prontuario_w,
	nm_mae_paciente_w,
	ds_logradouro_w,
	nr_residencia_w,
	ds_complemento_w,
	cd_cep_w,
	cd_municipio_ibge_w,
	dt_nascimento_w,
	ie_sexo_w,
	ds_raca_w,
	ds_nome_responsavel_w,
	cd_nacionalidade_w,
	cd_etnia_w,
	nr_telefone_w,
	nr_celular_w,
	cd_motivo_saida_w,
	dt_ocorrencia_w,
	cd_cid_principal_w,
	cd_cid_causas_assoc_w,
	cd_carater_atend_w,
	cd_origem_paciente_w,
	ie_cobertura_estrat_w,
	cd_estab_esf_w,
	qt_total_acoes_w,
	ie_emcaminhamento_w,
	ie_situacao_rua_w,
	ie_usu_alcool_droga_w,
	ie_crack_w,
	ie_alcool_w,
	ie_outras_drogas_w,
	nr_autorizacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	insert into w_raas_interf_pac_psico(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_linha,
		cd_uf,
		dt_producao,
		cd_unidade_prestadora,
		cd_cartao_saude_paciente,
		dt_inicial_validade,
		dt_final_validade,
		nm_paciente,
		nr_prontuario,
		nm_mae_paciente,
		ds_logradouro,
		nr_residencia,
		ds_complemento,
		cd_cep,
		cd_municipio_ibge,
		dt_nascimento,
		ie_sexo,
		ds_raca,
		ds_nome_responsavel,
		cd_nacionalidade,
		cd_etnia,
		nr_telefone,
		nr_celular,
		cd_motivo_saida,
		dt_ocorrencia,
		cd_cid_principal,
		cd_cid_causas_assoc,
		cd_carater_atend,
		cd_origem_paciente,
		ie_cobertura_familiar,
		cd_estab_esf,
		qt_total_acoes,
		cd_destino_paciente,
		ie_origem,
		ie_situacao_rua,
		ie_usuario_drogas,
		ie_usuario_crack,
		ie_usuario_alcool,
		ie_usuario_outros,
		nr_autorizacao)
	values (
		nextval('w_raas_interf_pac_psico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'15',
		cd_uf_w,
		dt_mesano_referencia_w,
		cd_cnes_usf_w,
		nr_cartao_nac_sus_w,
		dt_admissao_w,
		dt_conclusao_w,
		nm_paciente_w,
		nr_prontuario_w,
		nm_mae_paciente_w,
		ds_logradouro_w,
		nr_residencia_w,
		ds_complemento_w,
		cd_cep_w,
		cd_municipio_ibge_w,
		dt_nascimento_w,
		ie_sexo_w,
		ds_raca_w,
		ds_nome_responsavel_w,
		cd_nacionalidade_w,
		cd_etnia_w,
		nr_telefone_w,
		nr_celular_w,
		cd_motivo_saida_w,
		dt_ocorrencia_w,
		cd_cid_principal_w,
		cd_cid_causas_assoc_w,
		cd_carater_atend_w,
		cd_origem_paciente_w,
		ie_cobertura_estrat_w,
		cd_estab_esf_w,
		qt_total_acoes_w,
		ie_emcaminhamento_w,
		'EXT',
		ie_situacao_rua_w,
		ie_usu_alcool_droga_w,
		ie_crack_w,
		ie_alcool_w,
		ie_outras_drogas_w,
		nr_autorizacao_w);
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE raas_generate_interf_pac_psico ( nr_seq_lote_atend_p bigint, nm_usuario_p text) FROM PUBLIC;

