-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lesao_hem_angioplastia (nr_seq_proc_p bigint, nr_seq_vaso_p bigint, nr_seq_lesao_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*váriaveis relacionadas ao vaso*/

nr_sequencia_v_w			bigint; -- sequência do registro que será inserido na tabela;
nr_seq_vaso_w				bigint;
nr_seq_enxerto_w			bigint;
nr_seq_calibre_w			bigint;
nr_seq_leito_w			bigint;
ie_ponte_miocardica_w		varchar(1);
ie_grau_colateral_w			smallint;
qt_timi_inic_w			smallint;
nr_seq_vaso_circ_colat_w		bigint;
ie_tortuosidade_w			varchar(1);
ie_origem_anomala_w			varchar(1);
nr_seq_vaso_origem_anomala_w	bigint;

/*váriaveis relacionadas ao segmento do vaso*/

nr_sequencia_l_w			bigint; -- sequência do registro que será inserido na tabela;
nr_seq_segmento_w			bigint;
ie_extensao_w				varchar(15);
ie_tipo_w				varchar(15);
pr_obstrucao_w			bigint;
nr_seq_reestenose_w			bigint;
ie_bifurcacao_w			varchar(1);
ie_stent_w				varchar(1);
ie_trombo_w				varchar(1);
ie_placa_excentrica_w		varchar(1);
ie_placa_ulcerada_w			varchar(1);
ie_oclusao_cronica_w			varchar(1);
ie_ramo_2mm_w				varchar(1);
ie_calcificacao_w			varchar(1);
cd_tipo_bifurcacao_w			smallint;

/*váriaveis complementares*/

qt_vaso_w				smallint	:= 0;




BEGIN
/*obter dados do vaso*/

select	v.nr_seq_vaso,
	v.nr_seq_enxerto,
	v.nr_seq_calibre,
	v.nr_seq_leito,
	v.ie_ponte_miocardica,
	v.ie_grau_colateral,
	v.qt_timi_inic,
	v.nr_seq_vaso_circ_colat,
	v.ie_tortuosidade,
	v.ie_origem_anomala,
	v.nr_seq_vaso_origem_anomala
into STRICT	nr_seq_vaso_w,
	nr_seq_enxerto_w,
	nr_seq_calibre_w,
	nr_seq_leito_w,
	ie_ponte_miocardica_w,
	ie_grau_colateral_w,
	qt_timi_inic_w,
	nr_seq_vaso_circ_colat_w,
	ie_tortuosidade_w,
	ie_origem_anomala_w,
	nr_seq_vaso_origem_anomala_w
from	hem_cat_vaso v
where	v.nr_sequencia = nr_seq_vaso_p;

/*obter dados do segmento*/

select	l.nr_seq_segmento,
	l.ie_extensao,
	l.ie_tipo,
	l.pr_obstrucao,
	l.nr_seq_reestenose,
	l.ie_bifurcacao,
	l.ie_stent,
	l.ie_trombo,
	l.ie_placa_excentrica,
	l.ie_placa_ulcerada,
	l.ie_oclusao_cronica,
	l.ie_ramo_2mm,
	l.ie_calcificacao,
	l.cd_tipo_bifurcacao
into STRICT	nr_seq_segmento_w,
	ie_extensao_w,
	ie_tipo_w,
	pr_obstrucao_w,
	nr_seq_reestenose_w,
	ie_bifurcacao_w,
	ie_stent_w,
	ie_trombo_w,
	ie_placa_excentrica_w,
	ie_placa_ulcerada_w,
	ie_oclusao_cronica_w,
	ie_ramo_2mm_w,
	ie_calcificacao_w,
	cd_tipo_bifurcacao_w
from	hem_cat_lesao l
where	l.nr_seq_vaso_cat	= nr_seq_vaso_p
and	l.nr_sequencia	= nr_seq_lesao_p;

/*verificar se este vaso já foi selecionado anteriormente para tratamento*/

select	count(*)
into STRICT	qt_vaso_w
from	hem_cat_vaso
where	nr_seq_origem_vaso	= nr_seq_vaso_p
and	ie_vaso_atc		= 'S';

if (coalesce(qt_vaso_w,0) = 0) then

	/*obter nova sequência dos registros nas tabelas*/

	select	nextval('hem_cat_vaso_seq')
	into STRICT	nr_sequencia_v_w
	;

	select	nextval('hem_cat_lesao_seq')
	into STRICT	nr_sequencia_l_w
	;

	/*inserir dados do vaso*/

	insert	into	hem_cat_vaso(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_vaso,
					nr_seq_enxerto,
					nr_seq_calibre,
					nr_seq_leito,
					ie_ponte_miocardica,
					ie_grau_colateral,
					qt_timi_inic,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_vaso_circ_colat,
					ie_tortuosidade,
					ie_origem_anomala,
					nr_seq_vaso_origem_anomala,
					ie_vaso_atc,
					nr_seq_proc,
					nr_seq_origem_vaso)
			values (
					nr_sequencia_v_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_vaso_w,
					nr_seq_enxerto_w,
					nr_seq_calibre_w,
					nr_seq_leito_w,
					ie_ponte_miocardica_w,
					ie_grau_colateral_w,
					qt_timi_inic_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_vaso_circ_colat_w,
					ie_tortuosidade_w,
					ie_origem_anomala_w,
					nr_seq_vaso_origem_anomala_w,
					'S',
					nr_seq_proc_p,
					nr_seq_vaso_p);

	/*inserir dados do segmento*/

	insert	into	hem_cat_lesao(
					nr_sequencia,
					nr_seq_vaso_cat,
					dt_atualizacao,
					nm_usuario,
					nr_seq_segmento,
					ie_extensao,
					ie_tipo,
					pr_obstrucao,
					nr_seq_reestenose,
					ie_bifurcacao,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_stent,
					ie_trombo,
					ie_placa_excentrica,
					ie_placa_ulcerada,
					ie_oclusao_cronica,
					ie_ramo_2mm,
					ie_calcificacao,
					cd_tipo_bifurcacao,
					ie_lesao_atc)
			values (
					nr_sequencia_l_w,
					nr_sequencia_v_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_segmento_w,
					ie_extensao_w,
					ie_tipo_w,
					pr_obstrucao_w,
					nr_seq_reestenose_w,
					ie_bifurcacao_w,
					clock_timestamp(),
					nm_usuario_p,
					ie_stent_w,
					ie_trombo_w,
					ie_placa_excentrica_w,
					ie_placa_ulcerada_w,
					ie_oclusao_cronica_w,
					ie_ramo_2mm_w,
					ie_calcificacao_w,
					cd_tipo_bifurcacao_w,
					'S');
else
	/*obter sequência atual do registro na tabela vaso*/

	select	nr_sequencia
	into STRICT	nr_sequencia_v_w
	from	hem_cat_vaso
	where	nr_seq_origem_vaso	= nr_seq_vaso_p
	and	ie_vaso_atc		= 'S';

	/*obter nova sequência do registro na tabela lesão*/

	select	nextval('hem_cat_lesao_seq')
	into STRICT	nr_sequencia_l_w
	;

	/*inserir dados do segmento*/

	insert	into	hem_cat_lesao(
					nr_sequencia,
					nr_seq_vaso_cat,
					dt_atualizacao,
					nm_usuario,
					nr_seq_segmento,
					ie_extensao,
					ie_tipo,
					pr_obstrucao,
					nr_seq_reestenose,
					ie_bifurcacao,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_stent,
					ie_trombo,
					ie_placa_excentrica,
					ie_placa_ulcerada,
					ie_oclusao_cronica,
					ie_ramo_2mm,
					ie_calcificacao,
					cd_tipo_bifurcacao,
					ie_lesao_atc)
			values (
					nr_sequencia_l_w,
					nr_sequencia_v_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_segmento_w,
					ie_extensao_w,
					ie_tipo_w,
					pr_obstrucao_w,
					nr_seq_reestenose_w,
					ie_bifurcacao_w,
					clock_timestamp(),
					nm_usuario_p,
					ie_stent_w,
					ie_trombo_w,
					ie_placa_excentrica_w,
					ie_placa_ulcerada_w,
					ie_oclusao_cronica_w,
					ie_ramo_2mm_w,
					ie_calcificacao_w,
					cd_tipo_bifurcacao_w,
					'S');
end if;
commit;
END	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lesao_hem_angioplastia (nr_seq_proc_p bigint, nr_seq_vaso_p bigint, nr_seq_lesao_p bigint, nm_usuario_p text) FROM PUBLIC;

