-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_remover_token_acesso ( cd_token_p text, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p INOUT text, nm_usuario_p INOUT text) AS $body$
DECLARE

qt_reg_w	bigint;
ds_comando_w	varchar(2000);
ds_parametro_w	varchar(2000);
ds_sep_bv_w	varchar(10);
C04				integer;
ds_comando_delete_w	varchar(2000);
retorno_w			integer;


BEGIN

select	count(*)
into STRICT	qt_reg_w
from	user_tables
where	table_name = 'CUS_SIH_TOKENS';

if (qt_reg_w	> 0) then
	ds_sep_bv_w	:= obter_separador_bv;
	ds_comando_w	:= 	'	select	atendimento, cd_pessoa_fisica,	'||
				'		login		'||
				'	from	CUS_SIH_TOKENS	'||
				'	where	token = :CD_TOKEN	';
	C04 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C04, ds_comando_w, dbms_sql.Native);

	DBMS_SQL.DEFINE_COLUMN(C04,1,nr_atendimento_p);
	DBMS_SQL.DEFINE_COLUMN(C04,2,cd_pessoa_fisica_p, 30);
	DBMS_SQL.DEFINE_COLUMN(C04,3,nm_usuario_p,255);

	DBMS_SQL.BIND_VARIABLE(C04,'CD_TOKEN', cd_token_p);
	retorno_w := DBMS_SQL.execute(C04);

	while( DBMS_SQL.FETCH_ROWS(C04) > 0 ) loop
		begin
		DBMS_SQL.COLUMN_VALUE(C04,1,nr_atendimento_p);
		DBMS_SQL.COLUMN_VALUE(C04,2,cd_pessoa_fisica_p);
		DBMS_SQL.COLUMN_VALUE(C04,3,nm_usuario_p);

		ds_comando_delete_w	:= '	delete from CUS_SIH_TOKENS where token = :CD_TOKEN';
		CALL Exec_sql_Dinamico_bv('VICE',ds_comando_delete_w,'CD_TOKEN='||cd_token_p||ds_sep_bv_w);



		end;
	end loop;
	DBMS_SQL.CLOSE_CURSOR(C04);
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_remover_token_acesso ( cd_token_p text, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p INOUT text, nm_usuario_p INOUT text) FROM PUBLIC;

