-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_deficiencia_pac (nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_html_deficiencia_w		varchar(32000);
ds_oid_w					varchar(255);
qtd_registros_w				smallint;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
							
c01 CURSOR FOR
SELECT 	c.ds_deficiencia ds_deficiencia,  /*id_286*/
		b.cd_cif cd_cif,					 /*id_288*/
		cc.ds_cif ds_cif, /*id_289*/
		b.nr_sequencia nr_sequencia /*id_287*/
FROM tipo_deficiencia c, pf_tipo_deficiencia b
LEFT OUTER JOIN classificacao_cif cc ON (b.cd_cif = cc.cd_cif)
WHERE b.nr_seq_tipo_def = c.nr_sequencia  and b.ie_nega_deficiencia = 'N' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') and coalesce(b.dt_inativacao::text, '') = '' and b.cd_pessoa_fisica	= cd_pessoa_fisica_w group by
 	c.ds_deficiencia,
	b.cd_cif,
	cc.ds_cif,
	b.nr_sequencia;

BEGIN

																		

delete FROM nom_rc_deficiencia_pac where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio,
		a.cd_estabelecimento
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w,
		cd_estabelecimento_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;

ds_oid_w	:= get_oid_details(7,'OID_NUMBER', 'NOM', cd_estabelecimento_w);

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	a.cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente a
	where	a.nr_atendimento = nr_atendimento_w;
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	a.cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	episodio_paciente a
	where	a.nr_sequencia = nr_seq_episodio_w;
end if;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	qtd_registros_w := 0;
	
	ds_html_deficiencia_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>CÃ³digo CIF</th>';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Discapacidad</th>';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) ||  '</thead>';
	
	ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || '<tbody>';
	
	for r_deficiencia in c01 loop
		
		insert into nom_rc_deficiencia_pac(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_cabecalho,
			nr_seq_deficiencia,
			cd_cif,
			ds_deficiencia,
			DS_OID_DEFICIENCIA
		) values (
			nextval('nom_rc_deficiencia_pac_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_cabecalho_p,
			r_deficiencia.nr_sequencia,
			r_deficiencia.cd_cif,
			r_deficiencia.ds_cif,
			ds_oid_w
		);
		
		qtd_registros_w := qtd_registros_w + 1;
		
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_deficiencia.cd_cif || '</td>';
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_deficiencia.ds_cif || '</td>';
		
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
		
	end loop;
	
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || chr(9) || '</tbody>';
	
		ds_html_deficiencia_w	:= ds_html_deficiencia_w || chr(13) || chr(10) || '</table>';
	
	if (qtd_registros_w = 0) then
		ds_html_deficiencia_w	:= 'Sin registros';
	end if;
	
	if (qtd_registros_w > 0) then
		insert into nom_rc_deficiencia_pac(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_cabecalho,
			ds_html_deficiencia
		
		) values (
			nextval('nom_rc_deficiencia_pac_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_cabecalho_p,
			ds_html_deficiencia_w
		);
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_deficiencia_pac (nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

