-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_caixa_saldo_diario (nr_sequencia_p bigint, ie_posteriores_p text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_seq_caixa_w			bigint;
dt_saldo_ref_w			timestamp;
dt_saldo_w			timestamp;
dt_saldo_anterior_w		timestamp;
vl_saldo_anterior_w		double precision;
nr_sequencia_w			bigint;
vl_transacoes_w			double precision 	:= 0;
vl_cheque_pre_w			double precision	:= 0;
vl_cartao_cr_w			double precision	:= 0;
vl_cheque_vista_w		double precision	:= 0;
vl_especie_w			double precision	:= 0;
vl_transf_saida_cheque_pre_w	double precision	:= 0;
vl_transf_saida_cartao_cr_w	double precision	:= 0;
vl_transf_saida_cheque_vista_w	double precision	:= 0;
vl_transf_saida_especie_w	double precision	:= 0;
vl_transf_entr_cheque_pre_w	double precision	:= 0;
vl_transf_entr_cartao_cr_w	double precision	:= 0;
vl_transf_entr_cheque_vista_w	double precision	:= 0;
vl_transf_entr_especie_w	double precision	:= 0;
vl_total_cheque_pre_w		double precision	:= 0;
vl_total_cartao_cr_w		double precision	:= 0;
vl_total_cheque_vista_w		double precision	:= 0;
vl_total_especie_w		double precision	:= 0;
vl_especie_anterior_w		double precision	:= 0;
vl_atualizado_w			double precision	:= 0;
vl_despesa_w			double precision	:= 0;
vl_total_desp_w			double precision	:= 0;
vl_especie_dep_w		double precision	:= 0;
vl_cheque_pre_dep_w		double precision	:= 0;
vl_cheque_vista_dep_w		double precision	:= 0;
vl_transacao_w			double precision	:= 0;
vl_cheque_vista_anterior_w	double precision	:= 0;
vl_cheque_pre_anterior_w	double precision	:= 0;
vl_cheque_vista_transf_w	double precision	:= 0;
vl_especie_transf_w		double precision	:= 0;
vl_cheque_pre_transf_w		double precision	:= 0;
vl_cartao_cr_anterior_w		double precision	:= 0;
cd_estabelecimento_w		bigint;
ie_saldo_caixa_w		varchar(255);
ie_saldo_dep_cheque_w		varchar(255);
nr_seq_deposito_w		bigint;
nr_seq_movto_cartao_cr_w	bigint;
nr_seq_movto_transf_w		bigint;
ie_caixa_w			varchar(01)	:= null;
/* Projeto Multimoeda - Variaveis */

cd_moeda_empresa_w		integer;
ie_caixa_estrang_w		varchar(1)	:= 'N';
nr_seq_lote_cartao_w	movto_trans_financ.nr_seq_lote_cartao%type;

nr_seq_movto_trans_fin_w		movto_trans_financ.nr_sequencia%type;
nr_seq_movto_orig_transf_w		movto_trans_financ.nr_sequencia%type;
nr_seq_movto_cartao_transf_w	movto_trans_financ.nr_seq_movto_cartao%type;
ds_lista_movto_cartao_w			varchar(1000);
vl_deposito_direto_w			movto_trans_financ.vl_transacao%type;
vl_total_deposito_direto_w		movto_trans_financ.vl_transacao%type;
vl_transf_saida_deposito_di_w		movto_trans_financ.vl_transacao%type;
vl_transf_entr_deposito_di_w		movto_trans_financ.vl_transacao%type;
vl_deposito_direto_atual_w		caixa_saldo_diario.vl_deposito_direto_atual%type;

C01 CURSOR FOR
SELECT	dt_saldo,
	nr_sequencia
from	caixa_saldo_diario
where	nr_seq_caixa	= nr_seq_caixa_w
and	dt_saldo 	> dt_saldo_ref_w
order 	by dt_saldo;

c02 CURSOR FOR
SELECT	a.vl_transacao,
	coalesce(b.ie_saldo_caixa,'N'),
	a.nr_seq_deposito,
	coalesce(b.ie_caixa,'N'),
	a.nr_seq_movto_cartao,
	a.nr_seq_lote_cartao,
	a.nr_seq_movto_transf,
	a.nr_sequencia
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	a.nr_seq_saldo_caixa	= nr_sequencia_p
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w; -- Projeto Multimoeda - Busca apenas o que e moeda nacional
C03 CURSOR FOR
	SELECT  a.nr_seq_movto_cartao
	from	movto_trans_financ a
	where	a.nr_seq_movto_transf = nr_seq_movto_orig_transf_w;	


BEGIN

select	nr_seq_caixa
into STRICT	nr_seq_caixa_w
from	caixa_saldo_diario
where	nr_sequencia = nr_sequencia_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	caixa
where	nr_sequencia	= nr_seq_caixa_w;

/* Projeto Multimoeda - Busca a moeda padrao da empresa */

select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E')
into STRICT	cd_moeda_empresa_w
;

/* Projeto Multimoeda - Verifica se o caixa permite saldo em moeda estrangeira */

select	substr(obter_se_caixa_estrang(nr_seq_caixa_w),0,1)
into STRICT	ie_caixa_estrang_w
;

select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='S' THEN  a.vl_transacao * -1  ELSE a.vl_transacao END ),0)
into STRICT	vl_transacoes_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_saldo_caixa	= nr_sequencia_p
and	a.nr_seq_trans_financ	= b.nr_sequencia
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
and	b.ie_saldo_caixa	in ('S', 'E')
and	b.ie_caixa		in ('D', 'T', 'A');

update	caixa_saldo_diario
set	vl_saldo	= coalesce(vl_saldo_inicial,0) + vl_transacoes_w
where	nr_sequencia	= nr_sequencia_p;
--and	dt_fechamento	is null;
begin
select	coalesce(ie_saldo_dep_cheque,'N')
into STRICT	ie_saldo_dep_cheque_w
from	parametro_tesouraria
where	cd_estabelecimento	= cd_estabelecimento_w;
exception
when no_data_found then
	--r.aise_application_error(-20011, 'Parametros da tesouraria nao cadastrado para o estabelecimento ' || cd_estabelecimento_w || '.');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(264858,'CD_ESTABELECIMENTO_W='||cd_estabelecimento_w);
end;

/* Francisco - 09/06/07 - Saldos de cheque pre e cartao */

select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cartao_cr='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END  WHEN b.ie_cartao_cr='N' THEN CASE WHEN ie_cartao_debito='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END   ELSE 0 END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_deposito_direto='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0)
into STRICT	vl_cheque_pre_w,
	vl_cartao_cr_w,
	vl_cheque_vista_w,
	vl_especie_w,
	vl_deposito_direto_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_saldo_caixa	= nr_sequencia_p
and	a.nr_seq_trans_financ	= b.nr_sequencia
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
and	((ie_saldo_dep_cheque_w	= 'N')
	 or (coalesce(a.nr_seq_deposito::text, '') = ''))  -- OS 232580 em 14/07/2010. dsantos - edgar.
and	b.ie_caixa		in ('M','A','T');

/* Tratar as transferencias originadas de monetarias e que nao tem os campos definidos,
ex: "Transferencia especie saida" mas sem o campo IE_ESPECIE_MARCADO */
select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cartao_cr='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END  WHEN b.ie_cartao_cr='N' THEN CASE WHEN ie_cartao_debito='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END   ELSE 0 END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_deposito_direto='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0)
into STRICT	vl_transf_saida_cheque_pre_w,
	vl_transf_saida_cartao_cr_w,
	vl_transf_saida_cheque_vista_w,
	vl_transf_saida_especie_w,
	vl_transf_saida_deposito_di_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
and	b.ie_caixa		in ('M','A')
and	exists (SELECT	1
		from	transacao_financeira y,
			movto_trans_financ x
		where	x.nr_seq_trans_financ	= y.nr_sequencia
		and	x.nr_seq_saldo_caixa	= nr_sequencia_p
		and	y.ie_caixa		= 'T'
		and	y.ie_saldo_caixa	= 'S'
		and	coalesce(x.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
		and	x.nr_sequencia		= a.nr_seq_movto_transf
		and	y.ie_cheque_cr		not in ('P','V')
		and	y.ie_cartao_cr		<> 'S'
		and	y.ie_cartao_debito	<> 'S'
		and	y.ie_especie		<> 'S');

/* Tratar as transferencias originadas de monetarias e que nao tem os campos definidos,
ex: "Transferencia especie entrada" mas sem o campo IE_ESPECIE_MARCADO */
select	coalesce(sum(CASE WHEN b.ie_cheque_cr='P' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cartao_cr='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END  WHEN b.ie_cartao_cr='N' THEN CASE WHEN ie_cartao_debito='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao *-1  ELSE a.vl_transacao END   ELSE 0 END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_cheque_cr='V' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_especie='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0),
	coalesce(sum(CASE WHEN b.ie_deposito_direto='S' THEN CASE WHEN b.ie_saldo_caixa='S' THEN a.vl_transacao * -1  ELSE a.vl_transacao END   ELSE 0 END ),0)
into STRICT	vl_transf_entr_cheque_pre_w,
	vl_transf_entr_cartao_cr_w,
	vl_transf_entr_cheque_vista_w,
	vl_transf_entr_especie_w,
	vl_transf_entr_deposito_di_w
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
and	b.ie_caixa		in ('M','A')
and	exists (SELECT	1
		from	transacao_financeira y,
			movto_trans_financ x
		where	x.nr_seq_trans_financ	= y.nr_sequencia
		and	y.ie_caixa		= 'T'
		and	y.ie_saldo_caixa	= 'S'
		and	x.nr_sequencia		= a.nr_seq_movto_transf
		and	coalesce(x.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
		and	exists (select	1
				from	transacao_financeira z,
					movto_trans_financ w
				where	w.nr_seq_trans_financ	= z.nr_sequencia
				and	w.nr_seq_saldo_caixa	= nr_sequencia_p
				and	z.ie_caixa		= 'T'
				and	z.ie_saldo_caixa	= 'E'
				and	w.nr_sequencia		= x.nr_seq_movto_transf
				and	coalesce(w.cd_moeda,cd_moeda_empresa_w) = cd_moeda_empresa_w -- Projeto Multimoeda - Busca apenas o que e moeda nacional
				and	z.ie_cheque_cr		not in ('P','V')
				and	z.ie_cartao_cr		<> 'S'
				and	z.ie_cartao_debito	<> 'S'
				and	z.ie_especie		<> 'S'));

vl_total_cheque_pre_w	:= vl_cheque_pre_w - vl_transf_saida_cheque_pre_w + vl_transf_entr_cheque_pre_w;
vl_total_cartao_cr_w	:= vl_cartao_cr_w - vl_transf_saida_cartao_cr_w + vl_transf_entr_cartao_cr_w;
vl_total_cheque_vista_w	:= vl_cheque_vista_w - vl_transf_saida_cheque_vista_w + vl_transf_entr_cheque_vista_w;
vl_total_especie_w		:= vl_especie_w - vl_transf_saida_especie_w + vl_transf_entr_especie_w;
vl_total_deposito_direto_w	:= vl_deposito_direto_w - vl_transf_saida_deposito_di_w + vl_transf_entr_deposito_di_w;

if (ie_saldo_dep_cheque_w = 'S') then

	open c02;
	loop
	fetch c02 into
		vl_transacao_w,
		ie_saldo_caixa_w,
		nr_seq_deposito_w,
		ie_caixa_w,
		nr_seq_movto_cartao_cr_w,
		nr_seq_lote_cartao_w,
		nr_seq_movto_transf_w,
		nr_seq_movto_trans_fin_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	
		if (ie_caixa_w	= 'D') or (ie_caixa_w	= 'T') or (ie_caixa_w	= 'A') then
			if (ie_saldo_caixa_w	= 'S') then
				vl_atualizado_w		:= vl_atualizado_w + vl_transacao_w;
			elsif (ie_saldo_caixa_w	= 'E') then
				vl_atualizado_w		:= vl_atualizado_w + (vl_transacao_w * -1);
			end if;
		end if;

		if (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then
	
			select	coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='S' THEN a.vl_cheque  ELSE 0 END ),0),
				coalesce(sum(CASE WHEN obter_se_cheque_cr_avista(a.nr_seq_cheque)='N' THEN a.vl_cheque  ELSE 0 END ),0)
			into STRICT	vl_cheque_vista_dep_w,
				vl_cheque_pre_dep_w
			from	deposito_cheque b,
				cheque_cr a
			where	a.nr_seq_cheque		= b.nr_seq_cheque
			and	b.nr_seq_deposito	= nr_seq_deposito_w;
	
			if (sign(vl_transacao_w) < 0) then
				vl_cheque_pre_dep_w	:= vl_cheque_pre_dep_w * -1;
				vl_cheque_vista_dep_w	:= vl_cheque_vista_dep_w * -1;
			end if;

			if (ie_saldo_caixa_w = 'S') then
				vl_cheque_pre_transf_w	:= vl_cheque_pre_transf_w + vl_cheque_pre_dep_w * -1;
				vl_cheque_vista_transf_w	:= vl_cheque_vista_transf_w + vl_cheque_vista_dep_w * -1;
			elsif (ie_saldo_caixa_w = 'E') then
				vl_cheque_pre_transf_w	:= vl_cheque_pre_transf_w + vl_cheque_pre_dep_w;
				vl_cheque_vista_transf_w	:= vl_cheque_vista_transf_w + vl_cheque_vista_dep_w;
			end if;
	
			select	coalesce(max(vl_especie),0)
			into STRICT	vl_especie_dep_w
			from	deposito
			where	nr_sequencia		= nr_seq_deposito_w;
	
			if (sign(vl_transacao_w) < 0) then
				vl_especie_dep_w		:= vl_especie_dep_w * -1;
			end if;

			if (ie_saldo_caixa_w = 'S') then
				vl_especie_transf_w		:= vl_especie_transf_w + vl_especie_dep_w * -1;
			elsif (ie_saldo_caixa_w = 'E') then
				vl_especie_transf_w		:= vl_especie_transf_w + vl_especie_dep_w;
			end if;
		end if;
	
		if (nr_seq_movto_cartao_cr_w IS NOT NULL AND nr_seq_movto_cartao_cr_w::text <> '') and (coalesce(nr_seq_movto_transf_w::text, '') = '') then
			select	coalesce(sum(a.vl_despesa),0)
			into STRICT	vl_despesa_w
			from	movto_cartao_cr_parcela a,
				movto_cartao_cr b
			where	b.nr_sequencia	= nr_seq_movto_cartao_cr_w
			and	b.nr_sequencia	= a.nr_seq_movto;

      if (vl_transacao_w >= 0) then
        if (ie_saldo_caixa_w = 'S') then
          vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w * -1;
        elsif (ie_saldo_caixa_w = 'E') then
          vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w;
        end if;
      else
        if (ie_saldo_caixa_w = 'S') then
          vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w * -1;
        elsif (ie_saldo_caixa_w = 'E') then
          vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w;
        end if;
      end if;
		end if;
		
		if (nr_seq_lote_cartao_w IS NOT NULL AND nr_seq_lote_cartao_w::text <> '') and (coalesce(nr_seq_movto_transf_w::text, '') = '') then
			select	coalesce(sum(a.vl_despesa),0)
			into STRICT	vl_despesa_w
			from	movto_cartao_cr_parcela a
			where	a.nr_seq_lote	= nr_seq_lote_cartao_w;

      if (vl_transacao_w >= 0) then
        if (ie_saldo_caixa_w = 'S') then
          vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w * -1;
        elsif (ie_saldo_caixa_w = 'E') then
          vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w;
        end if;
      else
        if (ie_saldo_caixa_w = 'S') then
          vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w * -1;
        elsif (ie_saldo_caixa_w = 'E') then
          vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w;
        end if;
      end if;
		end if;
		
		/*OS 1908016 - Casos de transferencia de cartao, onde no caixa destino da transferencia, o valor da coluna saldo real nao deduz a despesa do cartao.
		Buscamos a transacao de saida do caixa origem que esta vinculada a transacao de entrada no caixa destino e depois buscamos o movimento de cartao da transacao de recebimento vinculado a essa transacao de saida do caixa origem*/
		if (vl_transacao_w < 0) then
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_movto_orig_transf_w
			from 	movto_trans_financ a
			where 	a.nr_seq_movto_transf = (SELECT max(nr_seq_movto_orig) from movto_trans_financ where nr_sequencia  = nr_seq_movto_trans_fin_w and (nr_seq_movto_orig IS NOT NULL AND nr_seq_movto_orig::text <> '') and ie_estorno = 'E'); --Caso for um estorno de uma transf de entrada
		else	
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_movto_orig_transf_w
			from 	movto_trans_financ a
			where 	a.nr_seq_movto_transf = nr_seq_movto_trans_fin_w;
		end if;
		
		if (nr_seq_movto_orig_transf_w IS NOT NULL AND nr_seq_movto_orig_transf_w::text <> '') then
			
			/*select  max(a.nr_seq_movto_cartao) 
			into	nr_seq_movto_cartao_transf_w
		 	from	movto_trans_financ a
			where	a.nr_seq_movto_transf = nr_seq_movto_orig_transf_w;*/
			ds_lista_movto_cartao_w := null;
			open C03;
			loop
			fetch C03 into	
				nr_seq_movto_cartao_transf_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				if (coalesce(ds_lista_movto_cartao_w::text, '') = '') then
					ds_lista_movto_cartao_w := nr_seq_movto_cartao_transf_w;
				else
					ds_lista_movto_cartao_w := substr(ds_lista_movto_cartao_w || ' ' || nr_seq_movto_cartao_transf_w,1,1000);
				end if;
				end;
			end loop;
			close C03;	

			if (ds_lista_movto_cartao_w IS NOT NULL AND ds_lista_movto_cartao_w::text <> '') then
			
				select	coalesce(sum(a.vl_despesa),0)
				into STRICT	vl_despesa_w
				from	movto_cartao_cr_parcela a,
						movto_cartao_cr b
				
				where	' ' || ds_lista_movto_cartao_w || ' ' like '% ' || b.nr_sequencia || ' %'
				and		b.nr_sequencia		= a.nr_seq_movto;
				
        if (vl_transacao_w >= 0) then
          if (ie_saldo_caixa_w = 'S') then
            vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w * -1;
          elsif (ie_saldo_caixa_w = 'E') then
            vl_total_desp_w	:= vl_total_desp_w + vl_despesa_w;
          end if;
        else
          if (ie_saldo_caixa_w = 'S') then
            vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w * -1;
          elsif (ie_saldo_caixa_w = 'E') then
            vl_total_desp_w	:= vl_total_desp_w - vl_despesa_w;
          end if;
        end if;
			end if;
		
		end if;
		/*OS 1908016 Fim*/

	end loop;
	close c02;
end if;

update	caixa_saldo_diario
set	vl_cheque_pre_atual	= coalesce(vl_cheque_pre_inicial,0) + coalesce(vl_total_cheque_pre_w,0) + coalesce(vl_cheque_pre_transf_w,0),
	vl_cartao_cr_atual		= coalesce(vl_cartao_cr_inicial,0) + coalesce(vl_total_cartao_cr_w,0),
	vl_cheque_vista_atual	= coalesce(vl_cheque_vista_inicial,0) + coalesce(vl_total_cheque_vista_w,0) + coalesce(vl_cheque_vista_transf_w,0),
	vl_especie_atual		= coalesce(vl_especie_inicial,0) + coalesce(vl_total_especie_w,0)+ coalesce(vl_especie_transf_w,0),
	vl_saldo_sem_desp_cartao	= vl_saldo_inicial - vl_atualizado_w - vl_total_desp_w,
	vl_deposito_direto_atual	= coalesce(vl_deposito_direto_inicial,0) + coalesce(vl_total_deposito_direto_w,0)
where	nr_sequencia		= nr_sequencia_p;

update	caixa_saldo_diario
set	vl_saldo_avista		= coalesce(vl_saldo,0) - coalesce(vl_cheque_pre_atual,0) - coalesce(vl_cartao_cr_atual,0)
where	nr_sequencia		= nr_sequencia_p;

/* Projeto Multimoeda - Caso o caixa permita moeda estrangeira, chama a procedure para recalcular o saldo em moeda estrangeira.
	Este processo foi saperado para nao gerar impacto no desempenho da rotina atual, nao realizando consultas sem necessidade
	quando o caixa nao possuir saldo em moeda estrangeira. */
if (coalesce(ie_caixa_estrang_w,'N') = 'S') then
	CALL recalcular_caixa_saldo_estrang(nr_sequencia_p);
end if;


if (ie_posteriores_p = 'S') then
	select	dt_saldo,
		nr_seq_caixa
	into STRICT	dt_saldo_ref_w,
		nr_seq_caixa_w
	from	caixa_saldo_diario
	where	nr_sequencia = nr_sequencia_p;

	open c01;
	loop
	fetch c01 into
		dt_saldo_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		select	max(dt_saldo)
		into STRICT	dt_saldo_anterior_w
		from	caixa_saldo_diario
		where	nr_seq_caixa	= nr_seq_caixa_w
		and	dt_saldo	< dt_saldo_w;

		select	vl_saldo,
			vl_especie_atual,
			vl_cheque_vista_atual,
			vl_cheque_pre_atual,
			vl_cartao_cr_atual,
			coalesce(vl_deposito_direto_atual,0)
		into STRICT	vl_saldo_anterior_w,
			vl_especie_anterior_w,
			vl_cheque_vista_anterior_w,
			vl_cheque_pre_anterior_w,
			vl_cartao_cr_anterior_w,
			vl_deposito_direto_atual_w
		from	caixa_saldo_diario
		where	nr_seq_caixa	= nr_seq_caixa_w
		and	dt_saldo		= dt_saldo_anterior_w;

		update	caixa_saldo_diario
		set	vl_saldo_inicial		= vl_saldo_anterior_w,
			vl_especie_inicial		= vl_especie_anterior_w,
			vl_cheque_vista_inicial	= vl_cheque_vista_anterior_w,
			vl_cheque_pre_inicial	= vl_cheque_pre_anterior_w,
			vl_cartao_cr_inicial		= vl_cartao_cr_anterior_w,
			vl_deposito_direto_inicial	= vl_deposito_direto_atual_w
		where	nr_seq_caixa		= nr_seq_caixa_w
		and	dt_saldo			= dt_saldo_w
		and	nr_sequencia		= nr_sequencia_w;
		
		/* Projeto Multimoeda - Caso o caixa permita moeda estrangeira, chama a procedure para atualizar o saldo inicial do 
			caixa em moeda estrangeira. Este processo foi saperado para nao gerar impacto no desempenho da rotina atual, 
			nao realizando consultas sem necessidade quando o caixa nao possuir saldo em moeda estrangeira. */
		if (coalesce(ie_caixa_estrang_w,'N') = 'S') then
			CALL atualiza_cx_saldo_ini_estrang(nr_sequencia_w,dt_saldo_w,nr_seq_caixa_w);
		end if;

		CALL Recalcular_Caixa_Saldo_Diario(nr_sequencia_w,'N');
	end loop;
	close c01;
end if;


if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_caixa_saldo_diario (nr_sequencia_p bigint, ie_posteriores_p text, ie_commit_p text default 'S') FROM PUBLIC;

