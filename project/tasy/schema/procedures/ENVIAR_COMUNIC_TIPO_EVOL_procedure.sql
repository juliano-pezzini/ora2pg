-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_tipo_evol ( cd_evolucao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_evolucao_w 			varchar(32000) := '';
ds_evolucao_ww			varchar(32000) := '';
ds_pos_inicio_rtf_w		bigint;
nm_usuario_w			varchar(15);
nm_destino_w			varchar(4000) := '';
nm_usuario_cad_w		varchar(15) := '';
nr_sequencia_w			bigint;
nr_atendimento_w		bigint;
nm_paciente_w			varchar(300);
nm_medico_w			varchar(100) := 0;
cd_pessoa_fisica_w		varchar(10);
nr_seq_equipe_w			bigint;
ds_seq_equipe_w			varchar(255);
ds_leito_w			varchar(255);
ds_setor_w			varchar(255);
ie_equipe_w			varchar(10);
cd_setor_w			bigint;
cd_setor_destino_w		varchar(4000);
cd_perfil_w			bigint;
cd_perfil_destino_w		varchar(4000);
nm_usuario_comunic_w		varchar(15);
nm_usuario_destino_w		varchar(4000);
nr_seq_grupo_w			bigint;
nr_seq_grupo_dest_w		varchar(4000);
cd_tipo_evolucao_w		varchar(3);
qt_reg_w			bigint;	
ds_tipo_evolucao_w	varchar(255);
nr_seq_classif_w	bigint;
visualiza_desc_evol_w		char(1);	
nr_prontuario_w			bigint;
estabelecimento_w		smallint;
estabelecimento_dest_w		smallint;
	
C01 CURSOR FOR
	SELECT	cd_setor_atendimento,
		cd_perfil,
		nm_usuario_comunic,
		nr_seq_grupo,
		cd_estabelecimento
	from	tipo_evolucao_comunic
	where	cd_tipo_evolucao = cd_tipo_evolucao_w
	and	coalesce(cd_estabelecimento,obter_estabelecimento_ativo) = obter_estabelecimento_ativo;
	

BEGIN

select	nr_atendimento,
	obter_nome_pf(a.cd_pessoa_fisica),
	a.cd_pessoa_fisica,
	SUBSTR(Obter_Unidade_Atendimento(nr_atendimento,'A','S'),1,120),
	substr(Obter_Unidade_Atendimento(nr_atendimento,'A','UB')||Obter_Unidade_Atendimento(nr_atendimento,'A','UC'),1,80),
	ie_evolucao_clinica,
	obter_prontuario_pf(obter_estabelecimento_ativo,b.cd_pessoa_fisica)
into STRICT	nr_atendimento_w,
	nm_paciente_w,
	cd_pessoa_fisica_w,
	ds_setor_w,
	ds_leito_w,
	cd_tipo_evolucao_w,
	nr_prontuario_w
from    evolucao_paciente a,
        pessoa_fisica b
where   cd_evolucao = cd_evolucao_p
and   	a.cd_pessoa_fisica = b.cd_pessoa_fisica;

select	count(*)
into STRICT	qt_reg_w
from	tipo_evolucao_comunic
where	cd_tipo_evolucao = cd_tipo_evolucao_w
and		coalesce(cd_estabelecimento,obter_estabelecimento_ativo) = obter_estabelecimento_ativo;



if (cd_evolucao_p IS NOT NULL AND cd_evolucao_p::text <> '') and (qt_reg_w	> 0)then

	select	nextval('comunic_interna_seq')
	into STRICT	nr_sequencia_w
	;
	
	select	obter_nome_medico(cd_medico,'N'),
		ds_evolucao,
		substr(obter_usuario_pf(cd_medico),1,100)
	into STRICT	nm_medico_w,
		ds_evolucao_w,
		nm_usuario_cad_w
	from	evolucao_paciente
	where	cd_evolucao = cd_evolucao_p;	
	
	select	max(ds_tipo_evolucao),
		max(NR_SEQ_CLASSIF),
		coalesce(max(IE_TEXTO_COMUNIC),'S')
	into STRICT	ds_tipo_evolucao_w,
		nr_seq_classif_w,
		visualiza_desc_evol_w
	from	tipo_evolucao
	where	cd_tipo_evolucao = cd_tipo_evolucao_w;
	
	
	if (ds_evolucao_w IS NOT NULL AND ds_evolucao_w::text <> '') then
			/*Pega o cabecalho do RTF*/

			ds_pos_inicio_rtf_w := position('\lang' in ds_evolucao_w)+9;
			ds_evolucao_ww 	:= substr(ds_evolucao_w,1,ds_pos_inicio_rtf_w) || 'fs20 ';
			
			
			if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
				ds_evolucao_ww := ds_evolucao_ww ||
				WHEB_MENSAGEM_PCK.get_texto(457601,
				'nr_atendimento_w=' || nr_atendimento_w || ' \par ' ||
				';nr_prontuario_w=' || nr_prontuario_w || ' \par ' ||
				';nm_paciente_w=' || nm_paciente_w || ' \par ');
				/*'Evolucao liberada para o atendimento: ' || nr_atendimento_w || ' \par ' ||
				'Prontuario: '||nr_prontuario_w||' \par ' ||
				'Paciente: ' || nm_paciente_w || ' \par ';*/
			else
				ds_evolucao_ww := ds_evolucao_ww ||
				OBTER_DESC_EXPRESSAO(728912) ||nm_paciente_w|| ' \par '; 			-- 728912: 'Evolucao liberada para o paciente: '
			end if;
			
			ds_evolucao_ww	:= ds_evolucao_ww ||OBTER_DESC_EXPRESSAO(329821) || ' ' ||ds_setor_w || ' \par ';															-- 329821: 'Setor:'
			ds_evolucao_ww	:= ds_evolucao_ww ||OBTER_DESC_EXPRESSAO(728916) || ' ' ||ds_leito_w || ' \par ';															-- 728916: 'Leito\Compl:'
			
			ds_evolucao_ww	:= ds_evolucao_ww ||OBTER_DESC_EXPRESSAO(728918) || ' ' || nm_medico_w || ' \par ';															-- 728918: 'Profissional:'
			ds_evolucao_ww	:= ds_evolucao_ww ||OBTER_DESC_EXPRESSAO(728932) || ' ' || ds_tipo_evolucao_w || ' \par ';													-- 728932: 'Tipo evolucao:'
	
			if (visualiza_desc_evol_w = 'S') then
			ds_evolucao_ww := ds_evolucao_ww || OBTER_DESC_EXPRESSAO(728940) || ' \par \par '|| substr(ds_evolucao_w,ds_pos_inicio_rtf_w,length(ds_evolucao_w));		-- 728940: 'Evolucao:'
			else
			ds_evolucao_ww := ds_evolucao_ww || ' \par \par '|| wheb_rtf_pck.GET_RODAPE;
			end if;
	end if;
	
	if (nm_usuario_cad_w IS NOT NULL AND nm_usuario_cad_w::text <> '') then
		nm_destino_w := nm_usuario_cad_w || ',';
	end if;
		
	/*obter_param_usuario(281,733,obter_perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento,ie_equipe_w);*/

	open C01;
	loop
	fetch C01 into
		cd_setor_w,
		cd_perfil_w,
		nm_usuario_comunic_w,
		nr_seq_grupo_w,
		estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			if (cd_setor_w IS NOT NULL AND cd_setor_w::text <> '') then
				cd_setor_destino_w 	:= cd_setor_w||','||cd_setor_destino_w;
			end if;
			if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
				cd_perfil_destino_w 	:= cd_perfil_w||','||cd_perfil_destino_w;						
			end if;
			if (nm_usuario_comunic_w IS NOT NULL AND nm_usuario_comunic_w::text <> '') then
				nm_usuario_destino_w 	:= nm_usuario_comunic_w|| ',' || nm_usuario_destino_w;						
			end if;
			if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
				nr_seq_grupo_dest_w 	:= nr_seq_grupo_w|| ','||nr_seq_grupo_dest_w;
			end if;
			if (estabelecimento_w IS NOT NULL AND estabelecimento_w::text <> '') then
				estabelecimento_dest_w 	:= estabelecimento_w;
			end if;
			
			
		end;
	end loop;
	close C01;
	

	insert	into comunic_interna(cd_estab_destino,
			nr_sequencia,
			ds_titulo,
			dt_comunicado,
			ds_comunicado,
			nm_usuario,
			nm_usuario_destino,
			dt_atualizacao,
			ie_geral,
			ie_gerencial,
			ds_perfil_adicional,
			dt_liberacao,
			ds_setor_adicional,
			ds_grupo,
			nr_seq_classif)
	values (
			coalesce(estabelecimento_dest_w,wheb_usuario_pck.get_cd_estabelecimento),
			nr_sequencia_w,
			OBTER_DESC_EXPRESSAO(728946) || ' ' ||nm_paciente_w,												-- 728946: 'Evolucao do paciente:
			sysdate,
			ds_evolucao_ww,
			nm_usuario_p,
			nm_usuario_destino_w,
			sysdate,
			'N',
			'N',
			cd_perfil_destino_w,
			sysdate,
			cd_setor_destino_w,
			nr_seq_grupo_dest_w,
			nr_seq_classif_w);


end if;	

if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_tipo_evol ( cd_evolucao_p bigint, nm_usuario_p text) FROM PUBLIC;

