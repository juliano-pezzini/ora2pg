-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_vincular_loinc_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, nm_usuario_p text, cd_material_exame_p text) AS $body$
DECLARE


nr_seq_loinc_w         bigint;
nr_seq_material_w      bigint;
nr_seq_metodo_w        bigint;
nr_seq_loinc_sistema_w bigint;
nr_seq_loinc_metodo_w  bigint;
nr_seq_loinc_escala_w  bigint;
nr_seq_loinc_prop_w    bigint;
nr_seq_loinc_tempo_w   bigint;
nr_seq_gravado_w       bigint;

C01 CURSOR FOR
  SELECT distinct lld.nr_sequencia
    from lab_loinc_dados lld
   inner join LAB_LOINC_DADOS_REG lldr on lldr.nr_seq_loinc_dados = lld.nr_sequencia
   where coalesce(lldr.nr_seq_sistema, coalesce(nr_seq_loinc_sistema_w, 0)) = coalesce(nr_seq_loinc_sistema_w, 0) and
         coalesce(lldr.nr_seq_metodo, coalesce(nr_seq_loinc_metodo_w, 0)) = coalesce(nr_seq_loinc_metodo_w, 0) and
         coalesce(lldr.nr_seq_escala, coalesce(nr_seq_loinc_escala_w, 0)) = coalesce(nr_seq_loinc_escala_w, 0) and
         coalesce(lldr.nr_seq_propriedade, coalesce(nr_seq_loinc_prop_w, 0)) = coalesce(nr_seq_loinc_prop_w, 0) and
         coalesce(lldr.nr_seq_tempo, coalesce(nr_seq_loinc_tempo_w, 0)) = coalesce(nr_seq_loinc_tempo_w, 0);

BEGIN
  select nr_seq_loinc
    into STRICT nr_seq_loinc_w
    from EXAME_LABORATORIO
   where NR_SEQ_EXAME = nr_seq_exame_p;

  if (nr_seq_loinc_w IS NOT NULL AND nr_seq_loinc_w::text <> '') then
    insert into prescr_procedimento_loinc(nr_sequencia,
                                           nr_prescricao,
                                           nr_seq_prescr,
                                           nr_seq_loinc_dados,
                                           dt_atualizacao,
                                           dt_atualizacao_nrec,
                                           dt_vinculo,
                                           nm_usuario,
                                           nm_usuario_nrec,
                                           nm_usuario_vinc)
                                   values (nextval('prescr_procedimento_loinc_seq'),
                                           nr_prescricao_p,
                                           nr_seq_prescr_p,
                                           nr_seq_loinc_w,
                                           clock_timestamp(),
                                           clock_timestamp(),
                                           clock_timestamp(),
                                           nm_usuario_p,
                                           nm_usuario_p,
                                           nm_usuario_p);
  else
    begin
		nr_seq_loinc_escala_w :=obter_escala_exame(nr_seq_exame_p);
		nr_seq_loinc_prop_w   :=obter_prop_exame(nr_seq_exame_p);
		nr_seq_loinc_tempo_w  :=obter_tempo_exame(nr_seq_exame_p);
    exception
		when no_data_found then
			nr_seq_loinc_escala_w :=null;
			nr_seq_loinc_prop_w   :=null;
			nr_seq_loinc_tempo_w  :=null;
	end;

    select nr_sequencia
      into STRICT nr_seq_material_w
      from material_exame_lab
     where cd_material_exame = cd_material_exame_p;

    select nr_seq_sistema_loinc
      into STRICT nr_seq_loinc_sistema_w
      from exame_lab_material
     where nr_seq_exame = nr_seq_exame_p and
           nr_seq_material = nr_seq_material_w;

    if (coalesce(nr_seq_loinc_sistema_w::text, '') = '') then
      select nr_seq_sistema_loinc
        into STRICT nr_seq_loinc_sistema_w
        from material_exame_lab
      where nr_sequencia = nr_seq_material_w;
    end if;

    nr_seq_metodo_w :=OBTER_METODO_REGRA(nr_prescricao_p, nr_seq_exame_p);

    select nr_seq_metodo_loinc
      into STRICT nr_seq_loinc_metodo_w
      from EXAME_LAB_METODO
     where nr_seq_exame = nr_seq_exame_p and
           nr_seq_metodo = nr_seq_metodo_w;

    if (coalesce(nr_seq_loinc_metodo_w::text, '') = '') then
      select nr_seq_metodo_loinc
        into STRICT nr_seq_loinc_metodo_w
        from METODO_EXAME_LAB
       where nr_sequencia = nr_seq_metodo_w;
    end if;

    OPEN C01;
      LOOP
        FETCH C01 INTO
          nr_seq_loinc_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
          BEGIN
            insert into prescr_procedimento_loinc(nr_sequencia,
                                                   nr_prescricao,
                                                   nr_seq_prescr,
                                                   nr_seq_loinc_dados,
                                                   dt_atualizacao,
                                                   dt_atualizacao_nrec,
                                                   nm_usuario,
                                                   nm_usuario_nrec)
                                           values (nextval('prescr_procedimento_loinc_seq'),
                                                   nr_prescricao_p,
                                                   nr_seq_prescr_p,
                                                   nr_seq_loinc_w,
                                                   clock_timestamp(),
                                                   clock_timestamp(),
                                                   nm_usuario_p,
                                                   nm_usuario_p);
          END;
      END LOOP;
    CLOSE C01;

    commit;
  end if;

  select count(1)
    into STRICT nr_seq_gravado_w
    from prescr_procedimento_loinc
   where nr_prescricao = nr_prescricao_p and
         nr_seq_prescr = nr_seq_prescr_p;

  if (nr_seq_gravado_w = 1) then
    update prescr_procedimento_loinc set dt_vinculo = clock_timestamp(),
                                         nm_usuario_vinc = nm_usuario_p
     where nr_prescricao = nr_prescricao_p and
           nr_seq_prescr = nr_seq_prescr_p;

  end if;

  commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_vincular_loinc_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, nm_usuario_p text, cd_material_exame_p text) FROM PUBLIC;

