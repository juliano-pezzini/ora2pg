-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_pagar_classif_rateio (nr_titulo_p bigint, nr_seq_criterio_p bigint, nm_usuario_p text, vl_titulo_p bigint) AS $body$
DECLARE

 
 
vl_classif_w		double precision;
vl_titulo_w		double precision;
cd_centro_custo_w	bigint;
cd_conta_contabil_w	varchar(100);
cd_conta_financ_w	bigint;
nr_sequencia_w		bigint;
pr_rateio_w		double precision;

c01 CURSOR FOR 
SELECT	cd_centro_custo, 
	cd_conta_contabil, 
	cd_conta_financ, 
	pr_rateio 
from	ctb_criterio_rateio_item 
where	nr_seq_criterio		= nr_seq_criterio_p 
and	clock_timestamp()			between coalesce(dt_inicio_vigencia, clock_timestamp() - interval '1 days') and coalesce(dt_fim_vigencia, clock_timestamp() + interval '1 days');


BEGIN 
 
vl_titulo_w	:= obter_dados_tit_pagar(nr_titulo_p, 'VT');
 
 
open c01;
loop 
fetch c01 into 
	cd_centro_custo_w, 
	cd_conta_contabil_w, 
	cd_conta_financ_w, 
	pr_rateio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from	titulo_pagar_classif 
	where	nr_titulo	= nr_titulo_p;
 
	insert	into titulo_pagar_classif(NR_TITULO, 
		NR_SEQUENCIA, 
		VL_TITULO, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		CD_CONTA_CONTABIL, 
		CD_CENTRO_CUSTO, 
		NR_SEQ_CONTA_FINANC, 
		NR_SEQ_TRANS_FIN, 
		NR_CONTRATO, 
		VL_DESCONTO, 
		VL_ORIGINAL, 
		VL_ACRESCIMO) 
	values	(nr_titulo_p, 
		nr_sequencia_w, 
		vl_titulo_p * (pr_rateio_w / 100), 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_conta_contabil_w, 
		cd_centro_custo_w, 
		cd_conta_financ_w, 
		null, 
		null, 
		null, 
		null, 
		null);
 
end loop;
close c01;
 
select	coalesce(sum(vl_titulo), 0) 
into STRICT	vl_classif_w 
from	titulo_pagar_classif 
where	nr_titulo	= nr_titulo_p;
 
if (vl_classif_w <> vl_titulo_p) and (vl_titulo_p = vl_titulo_w) then 
	 
	update	titulo_pagar_classif 
	set	vl_titulo	= vl_titulo + (vl_titulo_p - vl_classif_w) 
	where	nr_titulo	= nr_titulo_p 
	and	nr_sequencia	= nr_sequencia_w;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_pagar_classif_rateio (nr_titulo_p bigint, nr_seq_criterio_p bigint, nm_usuario_p text, vl_titulo_p bigint) FROM PUBLIC;

