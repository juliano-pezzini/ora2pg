-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_gerar_informacao_req ( nr_atendimento_p bigint, nm_usuario_p text, ie_regra_alerta_p text, nr_cirurgia_p bigint default null, nr_seq_evento_p bigint default null, ie_escala_p bigint default null, nr_seq_atend_cons_pepa_p bigint default null, nr_seq_registro_p bigint default null, nr_seq_proc_interno_p cpoe_procedimento.nr_seq_proc_interno%type default null) AS $body$
DECLARE
 						
						
cd_setor_atendimento_w		bigint;						
ie_tipo_atendimento_w		bigint;
ds_mensagem_w			varchar(255);
nm_tabela_w			varchar(50);
nm_atributo_w			varchar(50);
ds_comando_w			varchar(32000);
qt_retorno_w			bigint;
qt_reg_w			bigint;
cd_perfil_w			bigint;
dt_entrada_unidade_w		timestamp;
dt_saida_unidade_w		timestamp;
qt_horas_setor_w		bigint;
nr_seq_item_pront_w		bigint;
nr_seq_item_pepo_w		bigint;
cd_estabelecimento_w		bigint;
qt_idade_alerta_w		bigint;
cd_pessoa_fisica_w		varchar(10);	
ds_sql_where_w			varchar(4000);
ie_regra_w			smallint;
ie_atributo_w			varchar(5);
ie_forma_apresent_w		varchar(10);
ie_regra_alerta_w		varchar(15);
ie_tipo_evolucao_w		varchar(3);
ie_consiste_liberacao_w		varchar(3);
ds_cor_w			varchar(15);
ds_cor_fonte_w			varchar(15);
qt_horas_atend_w		bigint;
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
cd_especialidade_w		varchar(255);
cd_medico_resp_w		varchar(10);
ie_apresenta_requisicao_w	varchar(1);
cd_usuario_w			varchar(100);
ie_carater_inter_sus_w		varchar(2);
cd_convenio_w			integer;
ie_ritual_w			varchar(1);
ie_acao_w			varchar(1);
dt_atual_w			timestamp;
ie_sexo_w			varchar(1);
nr_seq_tipo_cons_pepa_w		ATEND_CONSULTA_PEPA.NR_SEQ_TIPO_CONSULTA%TYPE;
nr_seq_ritual_w				PEP_REGRA_INFORMACAO.NR_SEQ_RITUAL%TYPE;
ds_titulo_w					PEP_REGRA_INFORMACAO.DS_TITULO%TYPE;
nr_seq_classif_w			proc_interno.nr_seq_classif%type;
nr_seq_template_w			pep_regra_informacao.nr_seq_template%TYPE;
qt_cons_pepa_w			bigint;

C01 CURSOR FOR
	SELECT	nm_tabela,
		nm_atributo,
		ds_mensagem,
		NR_SEQ_ITEM_PRONT,
		ds_sql_where,
		coalesce(ie_regra,0),
		coalesce(ie_atributo,'A'),
		ie_regra_apresent,
		coalesce(ie_consiste_liberacao,'S'),
		ds_cor,
		ds_cor_fonte,
		nr_seq_item_pepo,
		coalesce(ie_ritual,'N'),
		coalesce(ie_acao,'A'),
		nr_seq_ritual,
		ds_titulo,
		nr_seq_template
	from	pep_regra_informacao
	where	coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w)		= ie_tipo_atendimento_w
	and	coalesce(cd_perfil,cd_perfil_w)				= cd_perfil_w
	and	coalesce(cd_estabelecimento,cd_estabelecimento_w)		= cd_estabelecimento_w
	and	coalesce(ie_carater_inter_sus,ie_carater_inter_sus_w)	= ie_carater_inter_sus_w
	and	coalesce(cd_convenio,cd_convenio_w)				= cd_convenio_w
	and	coalesce(ie_regra_alerta,ie_regra_alerta_w)				= ie_regra_alerta_w
	and coalesce(ie_escala,0) = coalesce(ie_escala_p,0)
	and	qt_horas_setor_w	between coalesce(qt_horas_min_setor,0)	and	coalesce(qt_horas_max_setor,999999999999)
	and	qt_idade_alerta_w	between coalesce(Obter_idade_req_inf(nr_sequencia,'MIN'),0) 	and	coalesce(Obter_idade_req_inf(nr_sequencia,'MAX'),9999999)
	and	coalesce(ie_sexo,ie_sexo_w) = ie_sexo_w
	and	 dt_atual_w between coalesce(dt_inicio,dt_atual_w - 1) and coalesce(dt_fim,dt_atual_w + 1)
	and	coalesce(ie_situacao,'A')	= 'A'
	and	coalesce(ie_tipo_evolucao,ie_tipo_evolucao_w)	= ie_tipo_evolucao_w
	and	Obter_se_Regra_Inf_Pep(nr_sequencia)	= 'S'
	and 	Obter_se_Regra_evento_Pepo(nr_sequencia,nr_cirurgia_p,nr_seq_evento_p) = 'S'
	and 	coalesce(NR_SEQ_TIPO_CONSULTA, coalesce(nr_seq_tipo_cons_pepa_w, 0)) = coalesce(nr_seq_tipo_cons_pepa_w, 0)
	and	qt_horas_atend_w between coalesce(qt_horas_min_atend,0)	and	coalesce(qt_horas_max_atend,999999999999)
	and (coalesce(nr_seq_proc_interno_p::text, '') = '' or coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p, 0)) = coalesce(nr_seq_proc_interno_p, 0))
	and (coalesce(nr_seq_classif_w::text, '') = '' or  coalesce(nr_seq_classif, coalesce(nr_seq_proc_interno_p, 0)) = coalesce(nr_seq_classif_w, 0));




BEGIN
delete	from w_pep_regra_informacao
where	dt_atualizacao < clock_timestamp() - interval '12 days'/24;

delete	from w_pep_regra_informacao
where	nr_atendimento	= nr_atendimento_p
and	nm_usuario	= nm_usuario_p;

ie_regra_alerta_w	:= coalesce(ie_regra_alerta_p,'A');

if (nr_atendimento_p	> 0) then

	select  coalesce(max(ie_tipo_evolucao),'X')
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	cd_perfil_w	:= obter_perfil_ativo;
	
	select	max(nr_seq_classif)
	into STRICT	nr_seq_classif_w
	from	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;

	select	max(cd_setor_atendimento),
		max(ie_tipo_atendimento),
		max(dt_entrada_unidade),
		coalesce(MAX(coalesce(dt_saida_unidade,dt_alta)),clock_timestamp()),
		max(cd_estabelecimento),
		max(cd_pessoa_fisica),
		max(dt_entrada),
		coalesce(max(dt_alta),clock_timestamp()),
		coalesce(max(ie_carater_inter_sus),0),
		coalesce(max(cd_convenio),0)
	into STRICT	cd_setor_atendimento_w,
		ie_tipo_atendimento_w,
		dt_entrada_unidade_w,
		dt_saida_unidade_w,
		cd_estabelecimento_w,
		cd_pessoa_fisica_w,
		dt_entrada_w,
		dt_alta_w,
		ie_carater_inter_sus_w,
		cd_convenio_w
	from	resumo_atendimento_paciente_v
	where	nr_atendimento	= nr_atendimento_p;
	
	qt_horas_setor_w	:= coalesce(trunc((dt_saida_unidade_w - dt_entrada_unidade_w) *24),0);
	qt_horas_atend_w	:= coalesce(trunc((dt_alta_w - dt_entrada_w) *24),0);
	qt_idade_alerta_w	:= coalesce(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'DIA'),0);
	
	ie_sexo_w			:= coalesce(obter_dados_pf_sbis(nr_atendimento_p,'SEXO'),OBTER_SEXO_PF(cd_pessoa_fisica_w,'C'));
	dt_atual_w			:= clock_timestamp();
	
	select coalesce(max(NR_SEQ_TIPO_CONSULTA),0)
	into STRICT nr_seq_tipo_cons_pepa_w
	from ATEND_CONSULTA_PEPA
	where NR_SEQUENCIA = coalesce(nr_seq_atend_cons_pepa_p,0);
	
	open C01;
	loop
	fetch C01 into	
		nm_tabela_w,
		nm_atributo_w,
		ds_mensagem_w,
		NR_SEQ_ITEM_PRONT_w,
		ds_sql_where_w,
		ie_regra_w,
		ie_atributo_w,
		ie_forma_apresent_w,
		ie_consiste_liberacao_w,
		ds_cor_w,
		ds_cor_fonte_w,
		NR_SEQ_ITEM_PEPO_w,
		ie_ritual_w,
		ie_acao_w,
		nr_seq_ritual_w,
		ds_titulo_w,
		nr_seq_template_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_apresenta_requisicao_w	:= 'S';
		if (ie_atributo_w = 'A') then
			ds_comando_w	:= 	'select	count(*)	'||
						'	from	'||nm_tabela_w|| ' a '||
						'	where	nr_atendimento	= :nr_atendimento	 and		rownum = 1 ';
		elsif (ie_atributo_w = 'P') then
			if (upper(nm_tabela_w) = 'ATENDIMENTO_SINAL_VITAL' ) then
				ds_comando_w	:= 	'select	count(*)	'||
							'	from	'||nm_tabela_w|| ' a '||
							'	where	cd_paciente	= :cd_pessoa_fisica	 and		rownum = 1 ';
			else
				ds_comando_w	:= 	'select	count(*)	'||
							'	from	'||nm_tabela_w|| ' a '||
							'	where	cd_pessoa_fisica	= :cd_pessoa_fisica	 and		rownum = 1 ';
			end if;
		elsif (ie_atributo_w = 'C') then
			ds_comando_w	:= 	'select	count(*)	'||
						'	from	'||nm_tabela_w|| ' a '||
						'	where	nr_cirurgia	= :nr_cirurgia	 and		rownum = 1 ';
		elsif (ie_atributo_w = 'U') then
			ds_comando_w	:= 	'select	count(*)	'||
						'	from	'||nm_tabela_w|| ' a '||
						'	where	nm_usuario	= :nm_usuario	 and		rownum = 1 ';
		end if;
					
		if (nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') then		
			if (nm_atributo_w = 'NR_SEQUENCIA' and (nr_seq_registro_p IS NOT NULL AND nr_seq_registro_p::text <> '')) then
				ds_comando_w	:= ds_comando_w||'	and	'||nm_atributo_w||'	= ' || nr_seq_registro_p;
			else
				ds_comando_w	:= ds_comando_w||'	and	'||nm_atributo_w||'	is not null ';
			end if;
		end if;
		
		select	count(*)
		into STRICT	qt_reg_w
		from	tabela_atributo
		where	nm_tabela	= nm_tabela_w
		and		nm_atributo	= 'DT_INATIVACAO';		
		
		if (qt_reg_w > 0) then
			ds_comando_w	:= ds_comando_w||'  and dt_inativacao is null	';
		end if;
		
		select	count(*)
		into STRICT	qt_reg_w
		from	tabela_atributo
		where	nm_tabela	= nm_tabela_w
		and		nm_atributo	= 'DT_LIBERACAO';
		
		if (qt_reg_w	>0) and (ie_consiste_liberacao_w	= 'S')then
			ds_comando_w	:= ds_comando_w||'  and DT_LIBERACAO is not null	';
		end if;		
		
		select	count(*)
		into STRICT	qt_reg_w
		from	tabela_atributo
		where	nm_tabela	= nm_tabela_w
		and		nm_atributo	= 'NR_SEQ_ATEND_CONS_PEPA';
		
		ds_sql_where_w := replace(upper(ds_sql_where_w), ':NR_SEQ_ATEND_CONS_PEPA', nr_seq_atend_cons_pepa_p);
		
		if (nr_seq_atend_cons_pepa_p IS NOT NULL AND nr_seq_atend_cons_pepa_p::text <> '') and (ie_regra_alerta_w = 'Z') and (qt_reg_w > 0) and (nm_atributo_w	= 'NR_SEQ_ATEND_CONS_PEPA') then
			ds_comando_w := ds_comando_w || ' and NR_SEQ_ATEND_CONS_PEPA = ' || nr_seq_atend_cons_pepa_p || ' ';
		end if;
		
		if (ds_sql_where_w IS NOT NULL AND ds_sql_where_w::text <> '') then
			ds_comando_w	:= ds_comando_w ||ds_sql_where_w;
		end if;

		if (ie_atributo_w = 'A') then
			qt_retorno_w := Obter_valor_Dinamico_bv(ds_comando_w, 'NR_ATENDIMENTO='||nr_atendimento_p||';', qt_retorno_w);
		elsif (ie_atributo_w = 'P') then
			qt_retorno_w := Obter_valor_Dinamico_bv(ds_comando_w, 'CD_PESSOA_FISICA='||cd_pessoa_fisica_w||';', qt_retorno_w);
		elsif (ie_atributo_w = 'C') then
			qt_retorno_w := Obter_valor_Dinamico_bv(ds_comando_w, 'NR_CIRURGIA='||nr_cirurgia_p||';', qt_retorno_w);
		elsif (ie_atributo_w = 'U') then
			qt_retorno_w := Obter_valor_Dinamico_bv(ds_comando_w, 'NM_USUARIO='||nm_usuario_p||';', qt_retorno_w);
		end if;
		
		if (coalesce(ie_forma_apresent_w::text, '') = '') then
			ie_apresenta_requisicao_w := 'S';
		elsif (trim(both ie_forma_apresent_w) = 'ME') then
			begin
			cd_usuario_w := Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C');
			
			select	max(cd_medico_resp)
			into STRICT	cd_medico_resp_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_p;
			
			cd_especialidade_w	:= coalesce(substr(obter_especialidade_medico(cd_medico_resp_w,''),1,255),0);
			
			if (trim(both cd_especialidade_w) <> 0) and (trim(both coalesce(obter_especialidade_medico(cd_usuario_w,''),0)) <> 0) then
				begin
				if (coalesce(obter_especialidade_medico(cd_usuario_w,''),0) = cd_especialidade_w) then
					ie_apresenta_requisicao_w	:= 'S';
				else
					ie_apresenta_requisicao_w	:= 'N';
				end if;
				end;
			else
				ie_apresenta_requisicao_w := 'N';
			end if;
			end;
		elsif (trim(both ie_forma_apresent_w) = 'MR') then
			begin
			cd_usuario_w := Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C');
			
			select	max(cd_medico_resp)
			into STRICT	cd_medico_resp_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_p;
			
			if (cd_usuario_w <> cd_medico_resp_w) then
				ie_apresenta_requisicao_w := 'N';
			end if;
			end;
		end if;

		if (ie_apresenta_requisicao_w = 'S') and
			((qt_retorno_w	= 0 and ie_regra_w = 0) or (qt_retorno_w <> 0 and ie_regra_w = 1)) then
			insert	into w_pep_regra_informacao(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_atendimento,
								ds_mensagem,
								NR_SEQ_ITEM_PRONT,
								nm_tabela,
								ie_regra_apresent,
								ds_cor,
								ds_cor_fonte,
								nr_seq_item_pepo,
								ie_ritual,
								ie_acao,
								nr_seq_ritual,
								ds_titulo,
								nr_seq_template)
						values (	nextval('w_pep_regra_informacao_seq'),
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_atendimento_p,
								ds_mensagem_w,
								NR_SEQ_ITEM_PRONT_w,
								nm_tabela_w,
								ie_forma_apresent_w,
								ds_cor_w,
								ds_cor_fonte_w,
								nr_seq_item_pepo_w,
								ie_ritual_w,
								ie_acao_w,
								nr_seq_ritual_w,
								ds_titulo_w,
								nr_seq_template_w);
		end if;		
		
		end;
	end loop;
	close C01;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_gerar_informacao_req ( nr_atendimento_p bigint, nm_usuario_p text, ie_regra_alerta_p text, nr_cirurgia_p bigint default null, nr_seq_evento_p bigint default null, ie_escala_p bigint default null, nr_seq_atend_cons_pepa_p bigint default null, nr_seq_registro_p bigint default null, nr_seq_proc_interno_p cpoe_procedimento.nr_seq_proc_interno%type default null) FROM PUBLIC;

