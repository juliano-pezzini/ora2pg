-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_mensal (cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_mes_ref_p timestamp, dt_atual_p timestamp, nm_usuario_p text, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_data_atual_p text, ie_todas_contas_p text) AS $body$
DECLARE


dt_atual_w		timestamp;
ie_classificaco_w	varchar(5)	:= '';

-- 'RM' = Relatório Mensal
BEGIN

dt_atual_w		:= null;

/* Francisco - 10/11/2007 - OS 72999 - Não pode gerar a procedure do fluxo por causa do fechamento,
so a view, por isso comentei as chamadas das procedures abaixo*/
if (ie_classificacao_p in ('P', 'PG')) then		-- passado
	/*gerar_fluxo_caixa_passado(	cd_estabelecimento_p,
					trunc(dt_mes_ref_p,'month'),
					fim_mes(dt_mes_ref_p),
					nm_usuario_p,
					cd_empresa_p,
					ie_restringe_estab_p,
					nvl(vl_saldo_anterior_p,0),
					'D',
					'S',
					ie_todas_contas_p);*/
	ie_classificaco_w		:= ie_classificacao_p;

elsif (ie_classificacao_p in ('R','RG')) then		-- a realizar
	/*gerar_fluxo_caixa_real(	cd_estabelecimento_p,
				nvl(vl_saldo_anterior_p,0),
				trunc(dt_mes_ref_p,'month'),
				fim_mes(dt_mes_ref_p),
				nm_usuario_p,
				cd_empresa_p,
				ie_restringe_estab_p,
				'D',
				ie_todas_contas_p);*/
	ie_classificaco_w		:= ie_classificacao_p;

elsif (ie_classificacao_p in ('PR','PRG')) then	-- passado/realizar
	if (ie_data_atual_p = 'R') then
		dt_atual_w	:= coalesce(dt_atual_p, clock_timestamp());
	else
		dt_atual_w	:= coalesce(dt_atual_p, clock_timestamp()) + 1;
	end if;

	/*gerar_fluxo_caixa_passado(	cd_estabelecimento_p,
					trunc(dt_mes_ref_p,'month'),
					dt_atual_w - 1,
					nm_usuario_p,
					cd_empresa_p,
					ie_restringe_estab_p,
					nvl(vl_saldo_anterior_p,0),
					'D',
					'S',
					ie_todas_contas_p);

	gerar_fluxo_caixa_real(		cd_estabelecimento_p,
					nvl(vl_saldo_anterior_p,0),
					nvl(dt_atual_w, sysdate),
					fim_mes(dt_mes_ref_p),
					nm_usuario_p,
					cd_empresa_p,
					ie_restringe_estab_p,
					'D',
					ie_todas_contas_p);*/
	if (ie_classificacao_p = 'PR') then
		ie_classificaco_w		:= '';
	else
		ie_classificaco_w		:= 'PRGM';
	end if;

end if;

CALL gerar_view_fluxo_caixa(	cd_estabelecimento_p,
			trunc(dt_mes_ref_p,'month'),
			fim_mes(dt_mes_ref_p),
			dt_atual_w,
			'D',
			ie_classificaco_w || 'RM',
			qt_nivel_p,
			cd_empresa_p,
			ie_restringe_estab_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_mensal (cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_mes_ref_p timestamp, dt_atual_p timestamp, nm_usuario_p text, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_data_atual_p text, ie_todas_contas_p text) FROM PUBLIC;

