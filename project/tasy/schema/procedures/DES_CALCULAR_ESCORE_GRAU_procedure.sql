-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_calcular_escore_grau (dt_referencia_p timestamp, nm_usuario_p text, qt_pontos_p INOUT bigint, ds_historico_p INOUT text) AS $body$
DECLARE


qt_pontos_grau_w					double precision;
qt_erros_w							double precision;
qt_total_os_w						double precision;
qt_excelente_os_w					double precision;
qt_otimo_w							double precision;
qt_bom_w							double precision;
qt_regular_w						double precision;
qt_ruim_w							double precision;
qt_os_grau_escore_w					double precision;
pr_os_grau_w						double precision;
dt_mes_inicial_w                	timestamp;
dt_mes_final_w                  	timestamp;
qt_erro_esperado_w					varchar(30) := ' <= 3%';


BEGIN

dt_mes_inicial_w                := trunc(dt_referencia_p, 'month');
dt_mes_final_w                  := Fim_Mes(trunc(dt_referencia_p, 'month'));
qt_pontos_grau_w				:= 0;

select	count(*) qt_total_os,
		sum(CASE WHEN a.IE_GRAU_SATISFACAO='O' THEN  1  ELSE 0 END ) qt_otimo,
		sum(CASE WHEN a.IE_GRAU_SATISFACAO='E' THEN  1  ELSE 0 END ) qt_excelente,
		sum(CASE WHEN a.IE_GRAU_SATISFACAO='B' THEN  1  ELSE 0 END ) qt_bom,
		sum(CASE WHEN a.IE_GRAU_SATISFACAO='R' THEN  1  ELSE 0 END ) qt_regular,
		sum(CASE WHEN a.IE_GRAU_SATISFACAO='P' THEN  1  ELSE 0 END ) qt_ruim
into STRICT	qt_total_os_w,
		qt_otimo_w,
		qt_excelente_os_w,
		qt_bom_w,
		qt_regular_w,
		qt_ruim_w
from 	man_ordem_servico a
where 	coalesce(a.IE_GRAU_SATISFACAO, 'N') <> 'N'
and exists
		(SELECT	1
		from 	MAN_ORDEM_SERV_ESTAGIO b,
				man_estagio_processo c
		where 	b.NR_SEQ_ESTAGIO		= c.nr_sequencia
		and 	((c.ie_desenv 			= 'S') or (c.ie_tecnologia = 'S'))
		and 	b.nm_usuario 			= nm_usuario_p
		and 	b.dt_atualizacao between dt_mes_inicial_w and dt_mes_final_w
		and 	b.nr_seq_ordem 			= a.nr_sequencia);

qt_os_grau_escore_w		:= qt_excelente_os_w + qt_bom_w + qt_otimo_w;
pr_os_grau_w			:= dividir((qt_os_grau_escore_w * 100), qt_total_os_w);

if (pr_os_grau_w >= 90) then
		qt_pontos_grau_w	:= 0;
elsif (pr_os_grau_w >= 80) then
		qt_pontos_grau_w	:= 5;
elsif (pr_os_grau_w >= 70) then
		qt_pontos_grau_w	:= 10;
else
		qt_pontos_grau_w	:= 10;
end if;

if (qt_total_os_w = 0) then
	qt_pontos_grau_w		:= 0;
end if;

qt_pontos_p	:= qt_pontos_grau_w;

ds_historico_p	:= 	'Escore de grau de satisfação ' || chr(13) || chr(10) ||
					'		Ordens de grau (excelente, ótimo e bom) no mês: ' || coalesce(qt_os_grau_escore_w,0) || chr(13) || chr(10) ||
					'		Total de ordens: ' || coalesce(qt_total_os_w,0) || chr(13) || chr(10) ||
					'		Perde: ' || qt_pontos_grau_w || ' pontos' || chr(13) || chr(13);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_calcular_escore_grau (dt_referencia_p timestamp, nm_usuario_p text, qt_pontos_p INOUT bigint, ds_historico_p INOUT text) FROM PUBLIC;

