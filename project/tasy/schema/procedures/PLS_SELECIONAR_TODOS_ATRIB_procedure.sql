-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_selecionar_todos_atrib ( ie_tipo_tabela_p text, ie_tipo_preco_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_regra_p text default 0, ie_adic_remov_p bigint default 0) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_apresentacao_w	pls_regra_preco_ordem.nr_seq_apresentacao%type;
nm_atributo_w		tabela_atributo.nm_atributo%type;
ds_sql_w 		varchar(4000);
nm_tabela_w		tabela_atributo.nm_tabela%type;
ie_tipo_preco_w		pls_regra_preco_ordem.ie_tipo_preco%type;
ds_entao_w		tabela_atributo.nm_atributo%type;
ds_from_w		varchar(150);
ds_from_where_w		varchar(500);
cursor_w		pls_util_pck.t_cursor;
ds_sql_nr_seq_apres_w	varchar(4000);

ds_sql_delete		varchar(4000);


BEGIN

if ( ie_tipo_regra_p = 0) then
	nm_tabela_w := 'PLS_REGRA_PRECO_PROC';
	ds_from_w := ' 		from	pls_regra_preco_ordem	x ';
	ie_tipo_preco_w := 'P';
	ds_entao_w := 'NR_SEQ_CBHPM_EDICAO';
	if ( ie_tipo_tabela_p in ('I','IP','IC') ) then
		ds_from_where_w := 	' from	tabela_visao_atributo a, '||
					' tabela_visao b ' ||
					' Where	a.nr_Sequencia = b.nr_Sequencia '||
					' and	upper(b.nm_tabela) = :nm_tabela '||
					' and	a.nr_sequencia = 11449 ' ||
					' and	UPPER(Substr(Obter_Tipo_Atributo(A.Nr_Sequencia,A.Nm_Atributo),1,15)) Not In (''FUNCTION'', ''VISUAL'') ';
	elsif ( ie_tipo_tabela_p not in ('I','IP','IC') ) then
		ds_from_where_w :=	' FROM tabela_atributo a ' ||
					' WHERE upper(a.nm_tabela) = :nm_tabela '||
					' and	a.ie_tipo_atributo not in (''FUNCTION'', ''VISUAL'') ';
	end if;

elsif ( ie_tipo_regra_p = 1) then
	nm_tabela_w := 'PLS_REGRA_PRECO_MAT';
	ds_from_w :=	'	from  pls_regra_preco_ordem_mat x ';
	ie_tipo_preco_w := 'M';
	ds_entao_w := 'DS_SE_ENTAO';
	if ( ie_tipo_tabela_p in ('I','IP','IC') ) then
		ds_from_where_w := 	' from	tabela_visao_atributo a, '||
					' tabela_visao b ' ||
					' Where	a.nr_Sequencia = b.nr_Sequencia '||
					' and	upper(b.nm_tabela) = :nm_tabela '||
					' and	a.nr_sequencia = 11452 ' ||
					' and	UPPER(Substr(Obter_Tipo_Atributo(A.Nr_Sequencia,A.Nm_Atributo),1,15)) Not In (''FUNCTION'', ''VISUAL'') ';
	elsif ( ie_tipo_tabela_p not in ('I','IP','IC') ) then
		ds_from_where_w :=	' FROM tabela_atributo a ' ||
					' WHERE upper(a.nm_tabela) = :nm_tabela '||
					' and	a.ie_tipo_atributo not in (''FUNCTION'', ''VISUAL'') ';
	end if;

elsif (ie_tipo_regra_p = 2) then
	nm_tabela_w := 'PLS_REGRA_PRECO_SERVICO';
	ds_from_w :=	'	from	pls_regra_preco_ordem_serv x ';
	ie_tipo_preco_w := 'S';
	ds_entao_w := 'DS_ENTAO';
	ds_from_where_w :=	' FROM tabela_atributo a ' ||
				' WHERE upper(a.nm_tabela) = :nm_tabela '||
				' and	a.ie_tipo_atributo not in (''FUNCTION'', ''VISUAL'') ';

end if;

if (ie_adic_remov_p = 0) then
ds_sql_w := 	' select	 a.nm_atributo '||
		ds_from_where_w||
		' and	a.NR_SEQ_APRESENT is not null '||
		' and	not exists	(	select	1 '||
		ds_from_w ||
		'				where	upper(x.nm_atributo) 	= upper(a.nm_atributo) '||
		'				and	x.ie_tipo_preco = :ie_tipo_preco_p '||
		'				and	x.ie_tipo_tabela = :ie_tipo_tabela_p ) ' 	||
		' and	a.nr_seq_apresent < (	select 	max(y.nr_seq_apresent) ' ||
		'				from	tabela_atributo y '||
		'				where	upper(y.nm_tabela) = :nm_tabela '||
		'				and	upper(y.nm_atributo) = :ds_entao ) '||
		' and	a.nm_atributo <> (''NR_SEQUENCIA'') ' ||
		' order by a.NR_SEQ_APRESENT desc';

ds_sql_nr_seq_apres_w :=' select	max(nr_seq_apresentacao) + 1 '||
			ds_from_w||
			' where	x.ie_tipo_tabela 	= :ie_tipo_tabela_p '||
			' and	x.ie_tipo_preco 	= :ie_tipo_preco_p ';

open cursor_w 	for EXECUTE 	ds_sql_w
		using 	nm_tabela_w ,
			ie_tipo_preco_w ,
			ie_tipo_tabela_p,
			nm_tabela_w,
			ds_entao_w;
loop
fetch cursor_w into
	nm_atributo_w;
EXIT WHEN NOT FOUND; /* apply on cursor_w */
	begin
	begin
		EXECUTE ds_sql_nr_seq_apres_w
		into STRICT 	nr_seq_apresentacao_w
		using 	ie_tipo_tabela_p, ie_tipo_preco_w;
	exception
	when others then
		nr_seq_apresentacao_w := 1;
	end;

	if (coalesce(nr_seq_apresentacao_w::text, '') = '') then
		nr_seq_apresentacao_w := 1;
	end if;
	if (ie_tipo_regra_p = 0) then
		insert into	pls_regra_preco_ordem( 	cd_estabelecimento, dt_atualizacao, dt_atualizacao_nrec,
								ie_tipo_preco, ie_tipo_tabela, nm_atributo,
								nm_usuario, nm_usuario_nrec, nr_seq_apresentacao ,
								nr_sequencia)
					values (	cd_estabelecimento_p, clock_timestamp(), clock_timestamp(),
								ie_tipo_preco_w, ie_tipo_tabela_p, upper(nm_atributo_w),
								nm_usuario_p, nm_usuario_p, nr_seq_apresentacao_w ,
								nextval('pls_regra_preco_ordem_seq'));
	elsif (ie_tipo_regra_p = 1) then
		insert into	pls_regra_preco_ordem_mat( 	cd_estabelecimento, dt_atualizacao, dt_atualizacao_nrec,
								ie_tipo_preco, ie_tipo_tabela, nm_atributo,
								nm_usuario, nm_usuario_nrec, nr_seq_apresentacao ,
								nr_sequencia)
					values (	cd_estabelecimento_p, clock_timestamp(), clock_timestamp(),
								ie_tipo_preco_w, ie_tipo_tabela_p, upper(nm_atributo_w),
								nm_usuario_p, nm_usuario_p, nr_seq_apresentacao_w ,
								nextval('pls_regra_preco_ordem_seq'));
	elsif (ie_tipo_regra_p = 2) then
		insert into	pls_regra_preco_ordem_serv( 	cd_estabelecimento, dt_atualizacao, dt_atualizacao_nrec,
								ie_tipo_preco, ie_tipo_tabela, nm_atributo,
								nm_usuario, nm_usuario_nrec, nr_seq_apresentacao ,
								nr_sequencia)
					values (	cd_estabelecimento_p, clock_timestamp(), clock_timestamp(),
								ie_tipo_preco_w, ie_tipo_tabela_p, upper(nm_atributo_w),
								nm_usuario_p, nm_usuario_p, nr_seq_apresentacao_w ,
								nextval('pls_regra_preco_ordem_seq'));
	end if;
	end;
end loop;
close cursor_w;

else
ds_sql_delete :=' delete ' || ds_from_w ||
		' where	x.ie_tipo_preco 	= :ie_tipo_preco_p '||
		' and	x.ie_tipo_tabela	= :ie_tipo_tabela_p';

EXECUTE ds_sql_delete
using 	ie_tipo_preco_w, ie_tipo_tabela_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_selecionar_todos_atrib ( ie_tipo_tabela_p text, ie_tipo_preco_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_regra_p text default 0, ie_adic_remov_p bigint default 0) FROM PUBLIC;

