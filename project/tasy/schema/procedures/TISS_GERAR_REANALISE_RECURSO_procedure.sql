-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_reanalise_recurso (nr_seq_rec_glosa_imp_p bigint, nr_seq_lote_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_analise_w			bigint;
nr_seq_lote_audit_w		bigint;
ds_retorno_w			varchar(4000);
nr_seq_lote_hist_guia_w		bigint;
nr_seq_lote_w			bigint;
cd_autorizacao_w			varchar(20);
cd_senha_w			varchar(20);
nr_seq_guia_w			bigint;
vl_saldo_guia_w			double precision;
nr_seq_guia_envio_w		bigint;
cd_procedimento_w			varchar(10);
vl_recursado_w			double precision;
vl_acatado_w			double precision;
nr_seq_lote_hist_item_w		bigint;
vl_amenor_w			double precision;
nr_seq_retorno_w			bigint;
ie_agrup_resposta_rec_glosa_w	varchar(1);
nr_seq_prot_imp_w			bigint;
ds_justificativa_oper_w		varchar(4000);
nr_seq_guia_antiga_w		bigint;
ds_justificativa_prest_w		tiss_rec_glosa_guia_imp.ds_justificativa_prest%type;
dt_realizacao_w			tiss_recurso_glosa_item.dt_procedimento%type;


c01 CURSOR FOR
SELECT	a.nr_seq_lote_hist_guia,
	c.nr_guia_prestador,
        coalesce(c.cd_senha,'XXX'),
	a.nr_sequencia,
	c.nr_seq_prot_imp
from	tiss_recurso_glosa_guia a,
	tiss_recurso_glosa_prot b,
	tiss_rec_glosa_guia_imp c,
	tiss_rec_glosa_prot_imp d
where	a.nr_seq_rec_prot	= b.nr_sequencia
and	d.nr_sequencia		= c.nr_seq_prot_imp
and	d.nr_seq_lote_hist	= b.nr_seq_lote_hist
and	c.nr_guia_prestador	= coalesce(a.nr_guia_origem, c.nr_guia_prestador)
and	c.nr_guia_operadora 	= a.cd_autorizacao
and	coalesce(c.cd_senha,'XXX')	= coalesce(coalesce(a.cd_senha,c.cd_senha),'XXX')
and	b.nr_seq_lote_hist	= nr_seq_lote_audit_p
and	((ie_agrup_resposta_rec_glosa_w = 'N' and c.nr_seq_prot_imp = nr_seq_rec_glosa_imp_p)
or (ie_agrup_resposta_rec_glosa_w = 'S')) 
group by 	a.nr_seq_lote_hist_guia,
		c.nr_guia_prestador,
        	c.cd_senha,
		a.nr_sequencia,
		c.nr_seq_prot_imp;
	
c02 CURSOR FOR
SELECT	cd_procedimento,
	vl_recursado,
	vl_acatado,
	coalesce(ds_just_ops_nao_acato_guia,ds_justificativa_oper),
	ds_justificativa_prest,
	dt_realizacao
from	tiss_rec_glosa_guia_imp
where	nr_seq_prot_imp		= nr_seq_prot_imp_w
and	nr_guia_prestador		= cd_autorizacao_w
and	coalesce(cd_senha,'XXX')	= cd_senha_w;


c03 CURSOR FOR
SELECT l.nr_sequencia,
	coalesce((obter_saldo_conpaci(l.nr_interno_conta,l.cd_autorizacao))::numeric ,0),
	l.nr_seq_retorno
from lote_audit_hist_guia l
where 1 = 1
and l.nr_seq_lote_hist = nr_seq_lote_audit_p
and (obter_saldo_conpaci(l.nr_interno_conta,l.cd_autorizacao))::numeric  > 0
and not exists (SELECT 1 from lote_audit_hist_guia la
                where la.nr_seq_lote_hist = nr_seq_lote_audit_w
                and la.nr_interno_conta = l.nr_interno_conta
                and la.cd_autorizacao = l.cd_autorizacao
              );


BEGIN

select	coalesce(tpc.ie_agrup_resposta_rec_glosa,'N')
into STRICT	ie_agrup_resposta_rec_glosa_w
from	tiss_parametros_convenio tpc,
	lote_audit_hist a,
	lote_auditoria l
where	l.nr_sequencia = a.nr_seq_lote_audit
and	tpc.cd_convenio = l.cd_convenio
and 	tpc.cd_estabelecimento = l.cd_estabelecimento
and	a.nr_sequencia = nr_seq_lote_audit_p;

select	coalesce(max(a.nr_analise),0) + 1 nr_analise
into STRICT	nr_analise_w
from	lote_audit_hist a
where	a.nr_seq_lote_audit  = nr_seq_lote_p;

select	nextval('lote_audit_hist_seq')
into STRICT	nr_seq_lote_audit_w
;

insert into lote_audit_hist(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	ie_status,
	nr_seq_lote_audit,
	nr_analise,
	vl_glosa,
	vl_recurso,
	vl_pago,
	nm_usuario_resp,
	dt_atualizacao_nrec,
	nm_usuario_nrec)
values (nr_seq_lote_audit_w,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	nr_seq_lote_p,
	nr_analise_w,
	0,
	0,
	0,
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p);
	
/*Busca as guias importadas na resposta do recurso que foram enviadas
Faz com base no numero da guia prestador e senha, pois e o unico identificador que temos*/
	
open C01;
loop
fetch C01 into	
	nr_seq_lote_hist_guia_w,
	cd_autorizacao_w,
	cd_senha_w,
	nr_seq_guia_envio_w,
	nr_seq_prot_imp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('lote_audit_hist_guia_seq')
	into STRICT	nr_seq_guia_w
	;
	
	select	coalesce((obter_saldo_conpaci(a.nr_interno_conta,a.cd_autorizacao))::numeric ,0),
		nr_seq_retorno
	into STRICT	vl_saldo_guia_w,
		nr_seq_retorno_w
	from	lote_audit_hist_guia a
	where	nr_sequencia	= nr_seq_lote_hist_guia_w;
	
	insert	into lote_audit_hist_guia(cd_autorizacao,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_interno_conta,
		nr_seq_lote_hist,
		nr_sequencia,
		nr_seq_retorno,
		ie_guia_sem_saldo,
		vl_saldo_guia,
		ie_guia_sem_resposta)
	SELECT	a.cd_autorizacao,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		a.nr_interno_conta,
		nr_seq_lote_audit_w,
		nr_seq_guia_w,
		nr_seq_retorno_w,
		a.ie_guia_sem_saldo,
		vl_saldo_guia_w,
		'N'
	from	lote_audit_hist_guia a
	where	nr_sequencia	= nr_seq_lote_hist_guia_w;
	
	/*Buscar os itens da resposta da guia que foram enviados*/

	open C02;
	loop
	fetch C02 into	
		cd_procedimento_w,
		vl_recursado_w,
		vl_acatado_w,
		ds_justificativa_oper_w,
		ds_justificativa_prest_w,
		dt_realizacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			
		/*Busca o item da guia que foi enviado com mesmo codigo e valor recursado*/

		select	max(a.nr_seq_lote_hist_item)
		into STRICT	nr_seq_lote_hist_item_w
		from	tiss_recurso_glosa_item a,
			lote_audit_hist_item b
		where	a.nr_seq_lote_hist_item		= b.nr_sequencia
		and	a.nr_seq_rec_guia			= nr_seq_guia_envio_w
		and	a.cd_procedimento_convenio		= cd_procedimento_w
		and	a.vl_recursado			= vl_recursado_w
		and	trunc(a.dt_procedimento)		= trunc(dt_realizacao_w);

		vl_amenor_w	:= vl_recursado_w - vl_acatado_w;
		if (vl_amenor_w < 0) then
			vl_amenor_w := 0;
		end if;

		insert	into lote_audit_hist_item(ds_observacao,
			dt_atualizacao,
			dt_historico,
			ie_status,
			nm_usuario,
			nr_seq_guia,
			nr_seq_matpaci,
			nr_seq_propaci,
			nr_seq_ret_glosa,
			nr_seq_ret_item,
			nr_sequencia,
			vl_glosa,
			vl_amenor,
			vl_acatado,
			qt_item,
			vl_saldo_amenor,
			vl_saldo,
			vl_glosa_informada,
			cd_setor_responsavel,
			cd_motivo_glosa,
			cd_resposta,
			nr_seq_lote,
			nr_seq_partic,
			ie_acao_glosa,
			ds_justificativa_oper)
		SELECT	coalesce(a.ds_observacao,ds_justificativa_prest_w),
			clock_timestamp(),
			clock_timestamp(),
			'A',
			nm_usuario_p,
			nr_seq_guia_w,
			a.nr_seq_matpaci,
			a.nr_seq_propaci,
			a.nr_seq_ret_glosa,
			a.nr_seq_ret_item,
			nextval('lote_audit_hist_item_seq'),
			0,
			vl_amenor_w,
			vl_acatado_w,
			a.qt_item,
			vl_amenor_w,
			vl_amenor_w,
			vl_recursado_w,
			a.cd_setor_responsavel,
			a.cd_motivo_glosa,
			null,
			nr_seq_lote_audit_w,
			a.nr_seq_partic,
			a.ie_acao_glosa,
			ds_justificativa_oper_w
		from	lote_audit_hist_item a
		where	a.nr_sequencia	= nr_seq_lote_hist_item_w; 		
		
		end;
	end loop;
	close C02;	
	
	end;
end loop;
close C01;

open C03;
loop
fetch C03 into	
	nr_seq_guia_antiga_w,
	vl_saldo_guia_w,
	nr_seq_retorno_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	
	select	nextval('lote_audit_hist_guia_seq')
	into STRICT	nr_seq_guia_w
	;
	

	insert	into lote_audit_hist_guia(cd_autorizacao,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_interno_conta,
		nr_seq_lote_hist,
		nr_sequencia,
		nr_seq_retorno,
		ie_guia_sem_saldo,
		vl_saldo_guia,
		ie_guia_sem_resposta)
	SELECT	a.cd_autorizacao,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		a.nr_interno_conta,
		nr_seq_lote_audit_w,
		nr_seq_guia_w,
		nr_seq_retorno_w,
		a.ie_guia_sem_saldo,
		vl_saldo_guia_w,
		'S'
	from	lote_audit_hist_guia a
	where	nr_sequencia	= nr_seq_guia_antiga_w;

  	--insert into - values ('c003 - inseriu nr_seq_guia_antiga_w:'|| nr_seq_guia_antiga_w || ' nr_seq_lote_audit_w:'|| nr_seq_lote_audit_w);
	insert	into lote_audit_hist_item(nr_sequencia,
		 dt_atualizacao,
		 nm_usuario,
		 dt_atualizacao_nrec,
		 nm_usuario_nrec,
		 nr_seq_lote,
		 nr_seq_conpaci_ret,
		 dt_historico,
		 vl_historico,
		 nr_seq_hist_audit,
		 nr_seq_ret_item,
		 ds_observacao,
		 dt_reapresentacao,
		 dt_receb_prev,
		 cd_motivo_glosa,
		 cd_processo_receb,
		 cd_resposta,
		 nr_seq_ret_glosa,
		 ie_status,
		 vl_pago,
		 vl_saldo,
		 nr_seq_guia,
		 nr_seq_propaci,
		 nr_seq_matpaci,
		 vl_glosa,
		 vl_amenor,
		 qt_item,
		 nr_seq_matpaci_partic,
		 cd_setor_responsavel,
		 ie_acao_glosa,
		 vl_saldo_amenor,
		 vl_glosa_informada,
		 ds_complemento,
		 vl_adicional,
		 nr_seq_partic,
		 ie_ajustado,
		 ie_tipo_glosa,
		 ie_pago_convenio,
		 cd_motivo_glosa_tiss,
		 cd_material_atend_paciente,
		 cd_material_atend_tiss,
		 cd_item_conversao,
		 cd_procedimento_pac,
		 ie_origem_proced_pac,
		 dt_item,
		 dt_conta_item,
		 cd_setor_atendimento,
		 cd_autorizacao,
		 nr_interno_conta,
		 cd_item_tuss,
		 ie_forma_agrupamento,
		 vl_acatado,
		 ds_justificativa_oper,
		 ie_item_sem_resposta,
		 nr_doc_conv_item_conta,
		 nr_atendimento_item,
		 cd_pessoa_fisica_item,
		 nm_pessoa_fisica_item,
		 ds_item_convenio,
		 ds_item_tiss,
		 ds_item_tuss)
	SELECT	nextval('lote_audit_hist_item_seq') seq,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_lote_audit_w,
		l.nr_seq_conpaci_ret,
		l.dt_historico,
		l.vl_historico,
		l.nr_seq_hist_audit,
		l.nr_seq_ret_item,
		l.ds_observacao,
		l.dt_reapresentacao,
		l.dt_receb_prev,
		l.cd_motivo_glosa,
		l.cd_processo_receb,
		l.cd_resposta,
		l.nr_seq_ret_glosa,
		l.ie_status,
		l.vl_pago,
		l.vl_saldo,
		nr_seq_guia_w,
		l.nr_seq_propaci,
		l.nr_seq_matpaci,
		l.vl_glosa,
		l.vl_amenor,
		l.qt_item,
		l.nr_seq_matpaci_partic,
		l.cd_setor_responsavel,
		l.ie_acao_glosa,
		l.vl_saldo_amenor,
		l.vl_glosa_informada,
		l.ds_complemento,
		l.vl_adicional,
		l.nr_seq_partic,
		l.ie_ajustado,
		l.ie_tipo_glosa,
		l.ie_pago_convenio,
		l.cd_motivo_glosa_tiss,
		l.cd_material_atend_paciente,
		l.cd_material_atend_tiss,
		l.cd_item_conversao,
		l.cd_procedimento_pac,
		l.ie_origem_proced_pac,
		l.dt_item,
		l.dt_conta_item,
		l.cd_setor_atendimento,
		l.cd_autorizacao,
		l.nr_interno_conta,
		l.cd_item_tuss,
		l.ie_forma_agrupamento,
		l.vl_acatado,
		l.ds_justificativa_oper,
		'S',
		l.nr_doc_conv_item_conta,
		l.nr_atendimento_item,
		l.cd_pessoa_fisica_item,
		l.nm_pessoa_fisica_item,
		l.ds_item_convenio,
		l.ds_item_tiss,
		l.ds_item_tuss
	from	lote_audit_hist_item l      
	where 	l.nr_seq_guia = nr_seq_guia_antiga_w
  and     l.ie_acao_glosa in ('R','P');
	
	end;
end loop;
close C03;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_reanalise_recurso (nr_seq_rec_glosa_imp_p bigint, nr_seq_lote_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) FROM PUBLIC;

