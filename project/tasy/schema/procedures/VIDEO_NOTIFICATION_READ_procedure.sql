-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE video_notification_read ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


dt_read_w timestamp;
dt_video_assessment_w timestamp;
qt_notification_w bigint;

/* ie_opcao_p
MR = mark as read
VA = video assessment */
BEGIN

select count(*)
into STRICT qt_notification_w
from video_notification_user
where 1 = 1
and nr_seq_video_server_not =  nr_sequencia_p
and nm_usuario = nm_usuario_p;

dt_read_w := null;
dt_video_assessment_w := null;

if (ie_opcao_p = 'VA') then
	dt_video_assessment_w := clock_timestamp();
	
	update video_server_notification
	set dt_video_assessment = clock_timestamp()
	where nr_sequencia = nr_sequencia_p
	and coalesce(dt_video_assessment::text, '') = '';
		
elsif (ie_opcao_p = 'MR') then
	dt_read_w := clock_timestamp();
	
	update video_server_notification
	set dt_read = clock_timestamp()
	where nr_sequencia = nr_sequencia_p
	and coalesce(dt_read::text, '') = '';
end if;


if (qt_notification_w = 0)then
	insert into VIDEO_NOTIFICATION_USER(
			 nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 nr_seq_video_server_not,
			 dt_read,
			 dt_video_assessment)
		   values (
			 nextval('video_server_notification_seq'),
			 clock_timestamp(),
			 nm_usuario_p,
			 nr_sequencia_p,
			 dt_read_w,
			 dt_video_assessment_w);

elsif (qt_notification_w > 0) then

	if (ie_opcao_p = 'VA') then
		update VIDEO_NOTIFICATION_USER
		set dt_video_assessment = dt_video_assessment_w
		where nr_seq_video_server_not =  nr_sequencia_p
		and nm_usuario = nm_usuario_p
		and coalesce(dt_video_assessment::text, '') = '';
		
	elsif (ie_opcao_p = 'MR') then
		update VIDEO_NOTIFICATION_USER
		set dt_read =  dt_read_w
		where nr_seq_video_server_not =  nr_sequencia_p
		and nm_usuario = nm_usuario_p
		and coalesce(dt_read::text, '') = '';

	end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE video_notification_read ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

