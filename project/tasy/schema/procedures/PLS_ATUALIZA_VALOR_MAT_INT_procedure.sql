-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_valor_mat_int ( nr_sequencia_p bigint, ie_gravar_log_p text, nm_usuario_p text, tx_intercambio_p bigint, ie_pos_estab_faturamento_p pls_parametros.ie_pos_estab_faturamento%type, ie_geracao_pos_estabelecido_p pls_parametros.ie_geracao_pos_estabelecido%type, ie_preco_interc_congenere_p pls_parametros.ie_preco_interc_congenere%type, nr_seq_regra_p INOUT bigint, vl_beneficiario_p INOUT bigint, tx_inter_out_p INOUT pls_conta_mat.tx_intercambio%type, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material) AS $body$
DECLARE


_ora2pg_r RECORD;
/*

	AS ALTERACOES REALIZADAS NESSA ROTINA DEVEM SER REFLETIDAS NA ROTINA PLS_POS_ESTABELECIDO_PCK.PLS_ATUALIZA_VALOR_MAT_POS

*/
					
					
nr_seq_conta_w			bigint;
cd_estabelecimento_w		integer;
dt_preco_w			timestamp;
qt_material_w			double precision;
nr_seq_cod_material_w		bigint;
ie_tipo_despesa_w			varchar(10);
ie_origem_preco_w			smallint;
nr_seq_outorgante_w		bigint;
nr_seq_segurado_w		bigint;
vl_beneficiario_w			double precision	:= 0;
ds_retorno_w			varchar(100);
nr_seq_regra_pos_estab_w		bigint;
nr_seq_plano_w			bigint;
tx_ajuste_benef_lib_w		double precision;
nr_seq_categoria_w		bigint;
nr_seq_tipo_atendimento_w	bigint;
nr_seq_clinica_w		bigint;
ie_tipo_guia_w			varchar(2);
nr_seq_tipo_acomodacao_w	bigint;
cd_guia_referencia_w		varchar(20);
qt_autorizacao_espec_w		bigint;
ie_autorizacao_espec_w		varchar(10)	:= 'N';
nr_seq_plano_espec_w		bigint;
nr_seq_prestador_exec_w		bigint;
ie_tipo_segurado_w		varchar(10);
nr_seq_intercambio_w		bigint;
vl_material_ptu_w		double precision;
nr_seq_regra_int_w		bigint;
ie_tipo_protocolo_w		varchar(2);
ie_tipo_tabela_int_w		varchar(2);
ie_tipo_conta_w			varchar(1);
nr_seq_fatura_w			bigint;
nr_seq_congenere_w		bigint;
ie_pagamento_cobranca_w		varchar(1);
dt_material_w			timestamp;
tx_intercambio_w		double precision;
ie_taxa_w			varchar(2);
qt_dia_proced_receb_w		bigint;
dt_alta_w			timestamp;
dt_conta_w			timestamp;
ie_preco_interc_congenere_w	pls_parametros.ie_preco_interc_congenere%type;
nr_seq_congenere_conta_w	pls_conta.nr_seq_congenere%type;
ie_origem_conta_w		pls_conta_v.ie_origem_conta%type;
ie_tipo_intercambio_w		pls_conta_v.ie_tipo_intercambio%type;
dt_recebimento_fatura_w		ptu_fatura.dt_recebimento_fatura%type;
dt_postagem_fatura_w		ptu_fatura.dt_postagem%type;
nr_seq_grupo_coop_seg_w		pls_segurado.nr_seq_grupo_coop%type;
ie_seguro_obito_w		pls_plano.ie_seguro_obito%type;
ie_pcmso_w			pls_segurado.ie_pcmso%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
dt_atendimento_conta_w		pls_conta.dt_atendimento%type;

dados_conta_valor_w		pls_cta_valorizacao_pck.dados_conta;
dados_conta_mat_valor_w		pls_cta_valorizacao_pck.dados_conta_mat;
dados_beneficiario_valor_w	pls_cta_valorizacao_pck.dados_beneficiario;
dados_fatura_valor_w		pls_cta_valorizacao_pck.dados_fatura;
dados_tx_interc_valor_w		pls_cta_valorizacao_pck.dados_taxa_intercambio;
ie_tipo_congenere_w		pls_congenere.ie_tipo_congenere%type;
ie_internado_w			varchar(2);
ie_nao_gera_tx_inter_w		pls_regra_preco_mat.ie_nao_gera_tx_inter%type;
nr_seq_cabecalho_w		pls_conta_pos_cabecalho.nr_sequencia%type;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;
vl_calc_orig_w			pls_conta_mat.vl_material_imp%type;
ie_tipo_log_w			pls_log_calculo_proc.ie_tipo_log%type := 'C';
ie_regime_atendimento_w	pls_regra_preco_mat.ie_regime_atendimento%type;
ie_saude_ocupacional_w	pls_regra_preco_mat.ie_saude_ocupacional%type;


BEGIN


tx_intercambio_w	:= coalesce(tx_intercambio_p,0);
if (ie_pos_estab_faturamento_p = 'N') or (ie_geracao_pos_estabelecido_p != 'F') then
	/* Obter dados do material */

	select	nr_seq_conta,
		nr_seq_material,
		ie_tipo_despesa,
		ie_origem_preco,
		coalesce(qt_material_imp,0),
		dt_atendimento,
		nr_sequencia
	into STRICT	nr_seq_conta_w,
		nr_seq_cod_material_w,
		ie_tipo_despesa_w,
		ie_origem_preco_w,
		qt_material_w,
		dt_material_w,
		nr_seq_conta_mat_w
	from	pls_conta_mat_v
	where	nr_sequencia	= nr_sequencia_p;

	/* Obter dados da conta */

	select	coalesce(nr_seq_segurado_prot, nr_seq_segurado) nr_seq_segurado,
		cd_estabelecimento,
		coalesce(nr_seq_tipo_acomodacao,0),
		coalesce(nr_seq_tipo_atendimento,0),
		nr_seq_clinica,
		ie_tipo_guia,
		cd_guia_referencia,
		nr_seq_prestador_exec,
		ie_tipo_conta,
		nr_seq_fatura,
		dt_alta,
		nr_seq_congenere,
		ie_origem_conta,
		ie_tipo_intercambio,
		dt_recebimento_fatura,
		dt_postagem_fatura,
		coalesce(dt_atendimento,dt_material_w),
		nr_seq_guia,
		dt_atendimento,
		ie_tipo_segurado,
		ie_regime_atendimento,
		ie_saude_ocupacional
	into STRICT	nr_seq_segurado_w,
		cd_estabelecimento_w,
		nr_seq_tipo_acomodacao_w,
		nr_seq_tipo_atendimento_w,
		nr_seq_clinica_w,
		ie_tipo_guia_w,
		cd_guia_referencia_w,
		nr_seq_prestador_exec_w,
		ie_tipo_conta_w,
		nr_seq_fatura_w,
		dt_alta_w,
		nr_seq_congenere_conta_w,
		ie_origem_conta_w,
		ie_tipo_intercambio_w,
		dt_recebimento_fatura_w,
		dt_postagem_fatura_w,
		dt_atendimento_conta_w,
		nr_seq_plano_espec_w,
		dt_conta_w,
		ie_tipo_segurado_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w
	from	pls_conta_v
	where	nr_sequencia	= nr_seq_conta_w;
else
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_cabecalho_w
	from	pls_conta_pos_cabecalho	b,
		pls_conta_mat		a
	where	b.nr_seq_conta	= a.nr_seq_conta
	and	a.nr_sequencia	= nr_sequencia_p;
	/* Obter dados do material */

	select	max(b.nr_seq_conta),
		max(coalesce(a.nr_seq_material,b.nr_seq_material)),
		max(b.ie_tipo_despesa),
		max(b.ie_origem_preco),
		max(coalesce(b.qt_material_imp,0)),
		max(coalesce(a.dt_item, b.dt_atendimento)),
		max(b.nr_sequencia)
	into STRICT	nr_seq_conta_w,
		nr_seq_cod_material_w,
		ie_tipo_despesa_w,
		ie_origem_preco_w,
		qt_material_w,
		dt_material_w,
		nr_seq_conta_mat_w
	FROM pls_conta_mat b
LEFT OUTER JOIN pls_conta_pos_estabelecido a ON (b.nr_sequencia = a.nr_seq_conta_mat)
WHERE b.nr_sequencia		= nr_sequencia_p  and ( );
	
	/* Obter dados da conta */

	select	coalesce(b.nr_seq_segurado_prot, b.nr_seq_segurado) nr_seq_segurado,
		a.cd_estabelecimento,
		coalesce(a.nr_seq_tipo_acomodacao,0),
		coalesce(a.nr_seq_tipo_atendimento,0),
		a.nr_seq_clinica,
		a.ie_tipo_guia,
		a.cd_guia_referencia,
		a.nr_seq_prestador_exec,
		b.ie_tipo_conta,
		a.nr_seq_fatura,
		a.dt_alta,
		a.ie_tipo_protocolo,
		b.ie_origem_conta,
		b.nr_seq_congenere,
		b.ie_tipo_intercambio,
		b.dt_recebimento_fatura,
		b.dt_postagem_fatura,
		coalesce(b.dt_atendimento,dt_material_w),
		b.nr_seq_guia,
		b.ie_tipo_segurado,
		b.ie_regime_atendimento,
		b.ie_saude_ocupacional
	into STRICT	nr_seq_segurado_w,
		cd_estabelecimento_w,
		nr_seq_tipo_acomodacao_w,
		nr_seq_tipo_atendimento_w,
		nr_seq_clinica_w,
		ie_tipo_guia_w,
		cd_guia_referencia_w,
		nr_seq_prestador_exec_w,
		ie_tipo_conta_w,
		nr_seq_fatura_w,
		dt_alta_w,
		ie_tipo_protocolo_w,
		ie_origem_conta_w,
		nr_seq_congenere_conta_w,
		ie_tipo_intercambio_w,
		dt_recebimento_fatura_w,
		dt_postagem_fatura_w,
		dt_atendimento_conta_w,
		nr_seq_plano_espec_w,
		ie_tipo_segurado_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w
	from	pls_conta_pos_cabecalho	a,
		pls_conta_v		b
	where	nr_seq_conta	= nr_seq_conta_w
	and	a.nr_sequencia	= nr_seq_cabecalho_w
	and	b.nr_sequencia	= nr_seq_conta;
end if;

dados_conta_valor_w.nr_sequencia 		:= nr_seq_conta_w;
dados_conta_valor_w.nr_seq_congenere		:= nr_seq_congenere_conta_w;
dados_conta_valor_w.ie_origem_conta		:= ie_origem_conta_w;
dados_conta_valor_w.ie_tipo_conta		:= 'C';
dados_conta_valor_w.nr_seq_segurado		:= nr_seq_segurado_w;
dados_conta_valor_w.ie_tipo_intercambio		:= ie_tipo_intercambio_w;
dados_conta_valor_w.ie_tipo_guia		:= ie_tipo_guia_w;
dados_conta_valor_w.dt_alta			:= dt_alta_w;
dados_conta_valor_w.dt_atendimento		:= dt_atendimento_conta_w;

dados_fatura_valor_w.nr_sequencia		:= nr_seq_fatura_w;
dados_fatura_valor_w.dt_recebimento		:= dt_recebimento_fatura_w;
dados_fatura_valor_w.dt_postagem		:= dt_postagem_fatura_w;

dados_conta_mat_valor_w.nr_sequencia		:= nr_seq_conta_mat_w;
dados_conta_mat_valor_w.nr_seq_conta		:= nr_seq_conta_w;
dados_conta_mat_valor_w.nr_seq_material		:= nr_seq_cod_material_w;
dados_conta_mat_valor_w.dt_atendimento		:= dt_material_w;

ie_preco_interc_congenere_w	:= coalesce(ie_preco_interc_congenere_p,'I');

/*Obter se existe material especial*/

select	count(1)
into STRICT	qt_autorizacao_espec_w
from	pls_solic_lib_mat_med	a,
	pls_guia_plano		b
where	a.nr_seq_guia		= b.nr_sequencia
and	b.nr_sequencia		= nr_seq_plano_espec_w;

if (qt_autorizacao_espec_w	> 0) then
	ie_autorizacao_espec_w	:= 'S';
end if;

/* Obter a categoria do tipo de acomodacao */

if (nr_seq_tipo_acomodacao_w IS NOT NULL AND nr_seq_tipo_acomodacao_w::text <> '') then
	select	max(nr_seq_categoria)
	into STRICT	nr_seq_categoria_w
	from	pls_regra_categoria
	where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomodacao_w;
end if;

/* Obter dados do segurado */

begin
select	pls_obter_produto_benef(nr_sequencia,dt_conta_w),
	nr_seq_intercambio,
	coalesce(nr_seq_ops_congenere,nr_seq_congenere),
	nr_seq_grupo_coop,
	ie_pcmso
into STRICT	nr_seq_plano_w,
	nr_seq_intercambio_w,
	nr_seq_congenere_w,
	nr_seq_grupo_coop_seg_w,
	ie_pcmso_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_w;
exception
	when others then
	nr_seq_plano_w	:= null;
end;

select	max(ie_tipo_congenere)
into STRICT	ie_tipo_congenere_w
from	pls_congenere
where	nr_sequencia = nr_seq_congenere_w;

if (ie_tipo_congenere_w = 'OP') and (ie_tipo_segurado_w = 'T') and (dados_conta_valor_w.nr_seq_congenere IS NOT NULL AND dados_conta_valor_w.nr_seq_congenere::text <> '') and (ie_preco_interc_congenere_w != 'F')then
	nr_seq_congenere_w := coalesce(dados_conta_valor_w.nr_seq_congenere,nr_seq_congenere_w);
end if;	
	
/* Obter dados do plano */

begin
	select	nr_seq_outorgante,
		ie_seguro_obito
	into STRICT	nr_seq_outorgante_w,
		ie_seguro_obito_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_w;
exception
	when others then
	nr_seq_outorgante_w	:= null;
end;

if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
	dados_conta_valor_w.nr_seq_congenere		:= nr_seq_congenere_w;
end if;
dados_beneficiario_valor_w.nr_sequencia		:= nr_seq_segurado_w;
dados_beneficiario_valor_w.nr_seq_intercambio	:= nr_seq_intercambio_w;
dados_beneficiario_valor_w.nr_seq_plano		:= nr_seq_plano_w;
dados_beneficiario_valor_w.nr_seq_grupo_coop	:= nr_seq_grupo_coop_seg_w;
dados_beneficiario_valor_w.ie_tipo_beneficiario	:= ie_tipo_segurado_w;
dados_beneficiario_valor_w.ie_beneficio_obito	:= ie_seguro_obito_w;
dados_beneficiario_valor_w.ie_pcmso		:= ie_pcmso_w;

if (ie_tipo_conta_w in ('I','C')) then
	
	dados_tx_interc_valor_w	:= pls_cta_valorizacao_pck.obter_taxa_intercambio(
							dados_conta_valor_w, null, dados_conta_mat_valor_w,
							dados_fatura_valor_w, dados_beneficiario_valor_w, null, cd_estabelecimento_w);
										
	tx_intercambio_w := dados_tx_interc_valor_w.pr_taxa;

end if;

ie_tipo_tabela_int_w	:= 'IC';

/* Francisco - 29/08/2013 - OS 637684
Quando o beneficiario for de operadora congenere, buscar da regra de pos ao inves de intercambio */
if	(ie_preco_interc_congenere_w = 'F' AND ie_tipo_congenere_w = 'OP') or (ie_tipo_segurado_w = 'B') then
	ie_tipo_tabela_int_w	:= 'O';
end if;

ie_internado_w	:= pls_obter_se_internado(nr_seq_conta_w,'C');

dt_preco_w	:= pls_obter_data_preco_item(nr_sequencia_p, 'M');

SELECT * FROM pls_define_preco_material(	cd_estabelecimento_w, nr_seq_prestador_exec_w, dt_preco_w, nr_seq_cod_material_w, 4, ie_tipo_despesa_w, ie_origem_preco_w, ie_tipo_tabela_int_w, nr_seq_outorgante_w, nr_seq_segurado_w, nr_seq_intercambio_w, '', nr_seq_categoria_w, nr_seq_tipo_acomodacao_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_tipo_guia_w, ie_autorizacao_espec_w, nr_seq_plano_espec_w, ie_gravar_log_p, nm_usuario_p, nr_sequencia_p, '', null, null, null, null, null, null, null, null, null, null, ie_internado_w, null, null, null, null, vl_material_ptu_w, ds_retorno_w, ds_retorno_w, ds_retorno_w, ds_retorno_w, ds_retorno_w, dados_regra_preco_material_w, null, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT _ora2pg_r;
 vl_material_ptu_w := _ora2pg_r.vl_material_p; ds_retorno_w := _ora2pg_r.dt_ult_vigencia_p; ds_retorno_w := _ora2pg_r.nr_seq_material_preco_p; ds_retorno_w := _ora2pg_r.vl_material_simpro_p; ds_retorno_w := _ora2pg_r.vl_material_brasindice_p; ds_retorno_w := _ora2pg_r.vl_material_tabela_p; dados_regra_preco_material_w := _ora2pg_r.dados_regra_preco_material_p;

nr_seq_regra_int_w	:= dados_regra_preco_material_w.nr_sequencia;
vl_calc_orig_w		:= coalesce(vl_material_ptu_w,0);

-- necessario fazer o round diretamente no vl_material_ptu_w, pois em alguns casos ele poderia causar uma diferenca entre o valor total e unitario quando gerado xml
vl_material_ptu_w	:= round((coalesce(round((vl_material_ptu_w)::numeric,2),0) *qt_material_w),2);

if (vl_material_ptu_w	= 0)  and (vl_calc_orig_w	       != 0)  and (qt_material_w		> 0)  then
	vl_material_ptu_w	:= vl_calc_orig_w;
end if;

select	max(ie_nao_gera_tx_inter)
into STRICT	ie_nao_gera_tx_inter_w
from	pls_regra_preco_mat
where	nr_sequencia	= nr_seq_regra_int_w;

if (coalesce(ie_nao_gera_tx_inter_w,'N') = 'S') then
	tx_intercambio_w	:= 0;
end if;

vl_beneficiario_w	:= vl_material_ptu_w + coalesce(dividir((vl_material_ptu_w*tx_intercambio_w),100),0);

update	pls_conta_mat
set	vl_beneficiario			= vl_beneficiario_w,
	vl_material_ptu			= vl_material_ptu_w,
	nr_seq_regra_int		= nr_seq_regra_int_w,
	tx_intercambio			= tx_intercambio_w
where	nr_sequencia			= nr_sequencia_p;

vl_beneficiario_p	:= vl_beneficiario_w;
nr_seq_regra_p		:= nr_seq_regra_int_w;
tx_inter_out_p		:= tx_intercambio_w;
dados_regra_preco_material_p := dados_regra_preco_material_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_valor_mat_int ( nr_sequencia_p bigint, ie_gravar_log_p text, nm_usuario_p text, tx_intercambio_p bigint, ie_pos_estab_faturamento_p pls_parametros.ie_pos_estab_faturamento%type, ie_geracao_pos_estabelecido_p pls_parametros.ie_geracao_pos_estabelecido%type, ie_preco_interc_congenere_p pls_parametros.ie_preco_interc_congenere%type, nr_seq_regra_p INOUT bigint, vl_beneficiario_p INOUT bigint, tx_inter_out_p INOUT pls_conta_mat.tx_intercambio%type, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material) FROM PUBLIC;

