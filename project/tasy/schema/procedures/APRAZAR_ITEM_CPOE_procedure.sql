-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprazar_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, ie_aprazar_interv_p text, dt_aprazar_p timestamp, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_atendimento_w		bigint;
nr_seq_proc_interno_w		bigint;
cd_item_w			bigint;
cd_intervalo_w			varchar(7);
qt_item_w			double precision;
nr_prescricao_w			bigint;
nr_seq_item_w			integer;
ie_inconsistencia_w		varchar(1);
ds_inconsistentes_w		varchar(255);
nr_agrupamento_w		integer;
ie_acm_sn_w			varchar(3);


BEGIN

nr_prescricao_w	:= obter_prescr_item_cpoe(nr_sequencia_p,ie_tipo_item_p);

if (ie_tipo_item_p	= 'P') then
	select	max(nr_atendimento),
		max(nr_seq_proc_interno),
		max(qt_procedimento),
		CASE WHEN max(ie_administracao)='P' THEN 'N'  ELSE 'S' END ,
		max(cd_intervalo)
	into STRICT	nr_atendimento_w,
		nr_seq_proc_interno_w,
		qt_item_w,
		ie_acm_sn_w,
		cd_intervalo_w
	from	cpoe_procedimento
	where	nr_sequencia	= nr_sequencia_p;

	select	max(cd_procedimento)
	into STRICT	cd_item_w
	from	proc_interno
	where	nr_sequencia	= nr_seq_proc_interno_w;

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w
	and	nr_seq_proc_interno	= nr_seq_proc_interno_w
	and	nr_seq_proc_cpoe = nr_sequencia_p;

	select	max(nr_agrupamento)
	into STRICT	nr_agrupamento_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w
	and	nr_sequencia	= nr_seq_item_w;

elsif (ie_tipo_item_p	= 'M') then

	select	max(nr_atendimento),
		max(cd_material),
		max(cd_intervalo),
		max(qt_Dose),
		CASE WHEN max(ie_administracao)='P' THEN 'N'  ELSE 'S' END
	into STRICT	nr_atendimento_w,
		cd_item_w,
		cd_intervalo_w,
		qt_item_w,
		ie_acm_sn_w
	from	cpoe_material
	where	nr_Sequencia	= nr_sequencia_p;

	select	max(nr_Sequencia)
	into STRICT	nr_Seq_item_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_w
	and	nr_Seq_mat_cpoe = nr_sequencia_p
	and	cd_material	= cd_item_w;

end if;

if (coalesce(nr_atendimento_w::text, '') = '') then
	nr_atendimento_w := 0;
end if;

SELECT * FROM aprazar_item_prescr( ie_aprazar_interv_p, cd_estabelecimento_p, nr_atendimento_w, ie_tipo_item_p, 0, cd_item_w, cd_intervalo_w, qt_item_w, dt_aprazar_p, null, nr_prescricao_w, nr_seq_item_w, 'N', nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, ie_inconsistencia_w, ds_inconsistentes_w, nr_seq_proc_interno_w, nr_agrupamento_w, ie_acm_sn_w, null, null, null, null, null, null, null, null, null, null) INTO STRICT ie_inconsistencia_w, ds_inconsistentes_w;

if (ie_inconsistencia_w	= 'P') then
	/*Não existem prescrições vigentes no momento onde o horário informado possa ser incluído.
	Provavelmente, o mesmo é anterior ao início destas prescrições ou superior a validade das mesmas!*/
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(29743);
elsif (ie_inconsistencia_w	= 'H') then
	/*Não foi possível gerar o horário informado nas seguintes prescrições: #@MENSAGEM#@
	Provavelmente, este item já possuía este horário nestas prescrições!*/
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(29745,'MENSAGEM='||ds_inconsistentes_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprazar_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, ie_aprazar_interv_p text, dt_aprazar_p timestamp, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

