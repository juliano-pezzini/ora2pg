-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_categ_befpost_eup_js ( var_ds_email_p text, var_ie_enviar_email_p text, var_cd_usuario_conv_p bigint, qt_dia_internacao_p bigint, dt_inicio_vigencia_p timestamp, ie_carater_inter_sus_p text, nr_seq_regra_acomp_p bigint, ie_lib_dieta_p text, qt_dieta_acomp_p bigint, nr_acompanhante_p bigint, ie_alterou_plano_p text, ie_alterou_categoria_p text, ie_alterou_convenio_p text, ie_tipo_convenio_p bigint, ie_completo_p text, cd_convenio_old_p bigint, cd_medico_resp_p text, nr_seq_cobertura_p bigint, nr_seq_queixa_p bigint, nr_seq_tipo_acidente_p bigint, cd_procedencia_p bigint, nr_seq_classificacao_p bigint, cd_setor_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, dt_validade_cart_glosa_p timestamp, nr_seq_origem_p bigint, dt_validade_carteira_p timestamp, dt_final_vigencia_p timestamp, cd_complemento_glosa_p text, cd_usuario_conv_glosa_p text, cd_categoria_glosa_p text, cd_convenio_glosa_p bigint, cd_compl_usuario_p text, nr_doc_conv_principal_p text, cd_empresa_p bigint, cd_categoria_p text, ie_tipo_guia_p text, cd_senha_p text, ie_alterou_guia_p text, ie_edicao_registro_p text, ie_tipo_atendimento_p bigint, nr_doc_convenio_old_p text, nr_doc_convenio_p text, ie_novo_registro_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_usuario_convenio_p text, cd_convenio_p bigint, cd_tipo_acomodacao_p bigint, cd_plano_convenio_p text, nr_seq_visao_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_alerta_cart_p INOUT text, ds_msg_abort_cons_cart_p INOUT text, ds_msg_alerta_cartao_sus_p INOUT text, nr_doc_conv_retorno_p INOUT text, ds_msg_consist_categ_conv_p INOUT text, ds_msg_incons_conta_p INOUT text, ie_aborta_acao_p INOUT text, ds_msg_regra_atend_p INOUT text, ds_msg_cons_cart_categ_p INOUT text, ds_msg_cons_cart_plano_p INOUT text, ds_msg_bloq_excl_atend_p INOUT text, ds_msg_bloquei_atend_p INOUT text, ie_focar_no_convenio_p INOUT text, ds_msg_medico_cred_p INOUT text, ds_msg_empresa_ref_p INOUT text, ds_msg_cart_fidel_venc_p INOUT text, ds_msg_consist_reinter_p INOUT text, ds_msg_conv_alerta_p INOUT text, ie_apresenta_consist_prescr_p INOUT text, ds_msg_alerta_cpf_p INOUT text, ds_proc_regra_val_usuario_p INOUT text, nr_acompanhante_ret_p INOUT bigint, qt_dieta_acomp_ret_p INOUT bigint, ie_lib_dieta_ret_p INOUT text, nr_seq_regra_acomp_ret_p INOUT bigint, ds_msg_dieta_p INOUT text, ds_msg_alerta_tit_venc_p INOUT text, dt_final_vigencia_ret_p INOUT timestamp, ds_msg_enviar_email_p INOUT text, nr_doc_convenio_ret_p INOUT text, nr_doc_convenio_princ_ret_p INOUT text, ie_chama_auto_convenio_p INOUT text, ie_chama_auto_convenio_grid_p INOUT text, ie_abortar_p INOUT text, nr_seq_regra_p INOUT bigint, ie_usuario_categoria_out_w INOUT text) AS $body$
DECLARE



cd_estabelecimento_w 		smallint;
ie_consistir_dupli_cart_w	varchar(3);	
ie_exige_conv_estab_w		varchar(1);
ie_consiste_cartao_sus_w	varchar(1);	
qt_convenio_atend_w		bigint;	
ie_atualiza_guia_tipo_guia_w	varchar(1);
ie_consiste_guia_senha_w	varchar(3);	
ie_exibir_consist_conta_pac_w	varchar(1);
ie_regra_w			smallint := 0;	
nr_seq_regra_w			bigint;
ie_aborta_acao_w		varchar(1);
ie_consiste_cart_convenio_w	varchar(1);
ie_consiste_cod_usu_categ_w	varchar(3);
ie_inclui_obs_conv_w		varchar(1);
ie_consiste_cod_usu_plano_w	varchar(3);
ie_regra_lib_atend_w		varchar(1);
ie_remover_nao_numeros_w	varchar(1);
cd_usuario_conv_w		varchar(30);
ie_convenios_liberados_w	varchar(255);
ie_convenios_nao_liberados_w	varchar(255);
ie_consiste_medico_credenc_w	varchar(1);
ie_convenio_cons_cart_fidel_w	varchar(255);
ie_visao_cobertura_w		varchar(1);
qt_dias_reinterncao_w		bigint;
ie_alerta_convenio_w		varchar(1);
ie_cons_permi_regra_atend_w	varchar(1);
ie_exige_guia_tipo_convenio_w	varchar(1);
ie_atualiza_proced_alt_conv_w	varchar(1);
ie_cons_prescr_alt_convenio_w	varchar(1);
ie_perm_cart_venc_w		varchar(1);
ie_consiste_cpf_conv_w		varchar(1);
ie_bloqueia_estrang_w		varchar(1);
ie_envia_integracao_w		varchar(1);
nr_seq_agenda_w			agenda_paciente.nr_sequencia%type;
ie_regra_valida_cod_usu_w	varchar(1);
ie_resp_nao_medico_w		varchar(1);
ie_atualiza_dieta_w		varchar(1);
ie_gera_qt_acomp_w		varchar(1);
ie_atualiza_dieta_nenhuma_w	varchar(1);	
ie_exibe_dieta_categ_conv_w	varchar(1);
ie_consist_tit_aberto_w		varchar(4);
ie_carat_perm_atend_tit_venc_w	varchar(60);
ie_valor_pend_estab_w		varchar(1);
ie_calcula_final_vigen_w	varchar(1);
hr_virada_diaria_w		varchar(40);
dt_parametro_w			varchar(40);
qt_dias_autor_w			bigint;
ie_copia_senha_guia_w		varchar(1);
ie_copia_senha_guia_princ_w	varchar(1);
ie_abre_auto_conveio_w		varchar(1);
ie_tipo_conv_auto_convenio_w	varchar(255);
ie_glosa_w			regra_ajuste_proc.ie_glosa%type;
nr_seq_regra_preco_w		regra_ajuste_proc.nr_sequencia%type;
					

BEGIN

if (coalesce(cd_convenio_p,0) = 0) then
	goto final;
end if;

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_perm_cart_venc_w := Obter_param_Usuario(916, 40, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_perm_cart_venc_w);
ie_consiste_cart_convenio_w := Obter_param_Usuario(916, 93, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_cart_convenio_w);
qt_dias_reinterncao_w := Obter_param_Usuario(916, 99, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, qt_dias_reinterncao_w);
ie_aborta_acao_w := Obter_param_Usuario(916, 124, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_aborta_acao_w);
ie_consiste_guia_senha_w := Obter_param_Usuario(916, 126, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_guia_senha_w);
qt_convenio_atend_w := Obter_param_Usuario(916, 134, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, qt_convenio_atend_w);
ie_exige_conv_estab_w := Obter_param_Usuario(916, 139, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exige_conv_estab_w);
ie_regra_lib_atend_w := Obter_param_Usuario(916, 287, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_regra_lib_atend_w);
ie_consistir_dupli_cart_w := Obter_param_Usuario(916, 294, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consistir_dupli_cart_w);
ie_atualiza_guia_tipo_guia_w := Obter_param_Usuario(916, 300, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_guia_tipo_guia_w);
ie_remover_nao_numeros_w := Obter_param_Usuario(916, 314, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_remover_nao_numeros_w);
ie_convenios_liberados_w := Obter_param_Usuario(916, 339, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_convenios_liberados_w);
ie_inclui_obs_conv_w := Obter_param_Usuario(916, 402, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_inclui_obs_conv_w);
ie_convenios_nao_liberados_w := Obter_param_Usuario(916, 432, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_convenios_nao_liberados_w);
ie_consiste_medico_credenc_w := Obter_param_Usuario(916, 449, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_medico_credenc_w);
ie_abre_auto_conveio_w := Obter_param_Usuario(916, 460, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_abre_auto_conveio_w);
ie_atualiza_dieta_nenhuma_w := Obter_param_Usuario(916, 466, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_dieta_nenhuma_w);
ie_consiste_cpf_conv_w := Obter_param_Usuario(916, 501, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_cpf_conv_w);
ie_exibe_dieta_categ_conv_w := Obter_param_Usuario(916, 520, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exibe_dieta_categ_conv_w);
ie_convenio_cons_cart_fidel_w := Obter_param_Usuario(916, 534, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_convenio_cons_cart_fidel_w);
ie_visao_cobertura_w := Obter_param_Usuario(916, 554, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_visao_cobertura_w);
ie_alerta_convenio_w := Obter_param_Usuario(916, 585, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_alerta_convenio_w);
ie_consiste_cartao_sus_w := Obter_param_Usuario(916, 622, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_cartao_sus_w);
ie_calcula_final_vigen_w := Obter_param_Usuario(916, 635, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_calcula_final_vigen_w);
ie_cons_permi_regra_atend_w := Obter_param_Usuario(916, 652, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_cons_permi_regra_atend_w);
ie_bloqueia_estrang_w := Obter_param_Usuario(916, 665, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_bloqueia_estrang_w);
ie_exige_guia_tipo_convenio_w := Obter_param_Usuario(916, 675, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exige_guia_tipo_convenio_w);
ie_cons_prescr_alt_convenio_w := Obter_param_Usuario(916, 700, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_cons_prescr_alt_convenio_w);
ie_gera_qt_acomp_w := Obter_param_Usuario(916, 706, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gera_qt_acomp_w);
ie_tipo_conv_auto_convenio_w := Obter_param_Usuario(916, 708, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_tipo_conv_auto_convenio_w);
ie_envia_integracao_w := Obter_param_Usuario(916, 721, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_envia_integracao_w);
ie_atualiza_proced_alt_conv_w := Obter_param_Usuario(916, 732, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_proced_alt_conv_w);
ie_consiste_cod_usu_categ_w := Obter_param_Usuario(916, 753, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_cod_usu_categ_w);
ie_resp_nao_medico_w := Obter_param_Usuario(916, 789, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_resp_nao_medico_w);
ie_regra_valida_cod_usu_w := Obter_param_Usuario(916, 849, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_regra_valida_cod_usu_w);
ie_exibir_consist_conta_pac_w := Obter_param_Usuario(916, 884, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exibir_consist_conta_pac_w);
ie_consiste_cod_usu_plano_w := Obter_param_Usuario(916, 888, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_cod_usu_plano_w);
ie_consist_tit_aberto_w := Obter_param_Usuario(916, 1026, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consist_tit_aberto_w);
ie_carat_perm_atend_tit_venc_w := Obter_param_Usuario(916, 1060, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_carat_perm_atend_tit_venc_w);
ie_atualiza_dieta_w := Obter_param_Usuario(916, 1115, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_dieta_w);

ie_valor_pend_estab_w := Obter_param_Usuario(-815, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_valor_pend_estab_w);

SELECT * FROM atend_categ_befpost_abort_eup(ie_resp_nao_medico_w, dt_validade_carteira_p, ie_perm_cart_venc_w, ie_tipo_convenio_p, ie_exige_guia_tipo_convenio_w, cd_medico_resp_p, ie_cons_permi_regra_atend_w, nr_seq_cobertura_p, ie_visao_cobertura_w, ie_convenios_nao_liberados_w, ie_convenios_liberados_w, ie_clinica_p, cd_pessoa_fisica_p, ie_consiste_cart_convenio_w, dt_entrada_p, cd_empresa_p, cd_categoria_p, ie_tipo_guia_p, cd_senha_p, ie_consiste_guia_senha_w, ie_atualiza_guia_tipo_guia_w, ie_alterou_guia_p, ie_edicao_registro_p, ie_tipo_atendimento_p, nr_doc_convenio_old_p, nr_doc_convenio_p, nr_atendimento_p, qt_convenio_atend_w, ie_novo_registro_p, cd_usuario_convenio_p, cd_estabelecimento_w, ie_exige_conv_estab_w, cd_convenio_p, cd_tipo_acomodacao_p, cd_plano_convenio_p, nr_seq_visao_p, nm_usuario_p, ds_msg_abort_p, ds_msg_abort_cons_cart_p, nr_doc_conv_retorno_p, ie_focar_no_convenio_p) INTO STRICT ds_msg_abort_p, ds_msg_abort_cons_cart_p, nr_doc_conv_retorno_p, ie_focar_no_convenio_p;

if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') or (ds_msg_abort_cons_cart_p IS NOT NULL AND ds_msg_abort_cons_cart_p::text <> '') then
	goto final;
end if;				
	
SELECT * FROM atend_categ_befpost_inf_eup_js(ie_regra_valida_cod_usu_w, ie_bloqueia_estrang_w, ie_consiste_cpf_conv_w, ie_alterou_convenio_p, ie_alerta_convenio_w, ie_completo_p, qt_dias_reinterncao_w, ie_convenio_cons_cart_fidel_w, ie_consiste_medico_credenc_w, cd_medico_resp_p, nr_seq_cobertura_p, nr_seq_queixa_p, nr_seq_tipo_acidente_p, cd_procedencia_p, nr_seq_classificacao_p, dt_entrada_p, cd_tipo_acomodacao_p, ie_edicao_registro_p, ie_regra_lib_atend_w, cd_setor_atendimento_p, ie_consiste_cod_usu_plano_w, ie_inclui_obs_conv_w, ie_clinica_p, ie_consiste_cod_usu_categ_w, ie_tipo_atendimento_p, dt_validade_cart_glosa_p, nr_seq_origem_p, dt_validade_carteira_p, dt_final_vigencia_p, cd_empresa_p, cd_complemento_glosa_p, cd_usuario_conv_glosa_p, cd_categoria_glosa_p, cd_convenio_glosa_p, cd_categoria_p, cd_compl_usuario_p, nr_doc_conv_principal_p, nr_doc_convenio_p, cd_senha_p, cd_plano_convenio_p, ie_consiste_cartao_sus_w, cd_pessoa_fisica_p, nr_atendimento_p, cd_usuario_convenio_p, cd_convenio_p, ie_consistir_dupli_cart_w, cd_estabelecimento_w, nm_usuario_p, ie_novo_registro_p, ds_msg_abort_p, ds_msg_alerta_cart_p, ds_msg_alerta_cartao_sus_p, ds_msg_consist_categ_conv_p, ds_msg_regra_atend_p, ds_msg_cons_cart_categ_p, ds_msg_cons_cart_plano_p, ds_msg_bloq_excl_atend_p, ds_msg_bloquei_atend_p, ds_msg_medico_cred_p, ds_msg_empresa_ref_p, ds_msg_cart_fidel_venc_p, ds_msg_consist_reinter_p, ds_msg_conv_alerta_p, ds_msg_alerta_cpf_p, ds_proc_regra_val_usuario_p, nr_seq_regra_p, ie_usuario_categoria_out_w) INTO STRICT ds_msg_abort_p, ds_msg_alerta_cart_p, ds_msg_alerta_cartao_sus_p, ds_msg_consist_categ_conv_p, ds_msg_regra_atend_p, ds_msg_cons_cart_categ_p, ds_msg_cons_cart_plano_p, ds_msg_bloq_excl_atend_p, ds_msg_bloquei_atend_p, ds_msg_medico_cred_p, ds_msg_empresa_ref_p, ds_msg_cart_fidel_venc_p, ds_msg_consist_reinter_p, ds_msg_conv_alerta_p, ds_msg_alerta_cpf_p, ds_proc_regra_val_usuario_p, nr_seq_regra_p, ie_usuario_categoria_out_w;
				
if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
	goto final;
end if;	

if (ie_exibir_consist_conta_pac_w = 'S') then
	SELECT * FROM consiste_plano_convenio(nr_atendimento_p, cd_convenio_p, null, null, null, null, ie_tipo_atendimento_p, cd_plano_convenio_p, null, ds_msg_incons_conta_p, null, null, ie_regra_w, null, nr_seq_regra_w, null, cd_categoria_p, cd_estabelecimento_w, null, null, cd_pessoa_fisica_p, ie_glosa_w, nr_seq_regra_preco_w) INTO STRICT ds_msg_incons_conta_p, ie_regra_w, nr_seq_regra_w, ie_glosa_w, nr_seq_regra_preco_w;
	if (ie_aborta_acao_w = 'S') then
		ie_aborta_acao_p := ie_aborta_acao_w;
		if (ds_msg_incons_conta_p IS NOT NULL AND ds_msg_incons_conta_p::text <> '') then
			goto final;
		end if;	
	end if;
end if;

if (ie_consist_tit_aberto_w = 'E') or (ie_consist_tit_aberto_w = 'PE') then
	SELECT * FROM consiste_tit_aberto_eup_js(ie_carater_inter_sus_p, ie_carat_perm_atend_tit_venc_w, 'E', cd_pessoa_fisica_p, null, cd_empresa_p, cd_estabelecimento_w, ie_valor_pend_estab_w, nm_usuario_p, ds_msg_abort_p, ds_msg_alerta_tit_venc_p) INTO STRICT ds_msg_abort_p, ds_msg_alerta_tit_venc_p;
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;	
end if;	


if (ie_edicao_registro_p = 'S') and (coalesce(cd_convenio_p,0) <> coalesce(cd_convenio_old_p,0)) then
	CALL Enviar_comunic_conv(nr_atendimento_p, cd_pessoa_fisica_p, cd_convenio_p, cd_estabelecimento_w, nm_usuario_p);
end if;

if (ie_atualiza_proced_alt_conv_w = 'S') and
	((ie_alterou_categoria_p = 'S') or (ie_alterou_convenio_p = 'S')) then
	CALL atualiza_proc_atend_conv(nr_atendimento_p, cd_convenio_p, cd_categoria_p);
end if;

if	((ie_alterou_plano_p = 'S') or (ie_alterou_categoria_p = 'S') or (ie_alterou_convenio_p = 'S')) then
	if (ie_cons_prescr_alt_convenio_w = 'S') then
		ie_apresenta_consist_prescr_p := 'S';
	end if;
end if;
if (ie_envia_integracao_w = 'S') and (ie_alterou_convenio_p = 'S') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_agenda_w
	from	agenda_paciente 
	where	nr_atendimento = nr_atendimento_p 
	and	ie_opme_integracao = 'S';
	
	if (coalesce(nr_seq_agenda_w,0) > 0) then
		CALL ajusta_status_agenda_int_opme(nr_seq_agenda_w, '8', '',	nm_usuario_p, null);
	end if;
end if;

SELECT * FROM obter_dados_dieta_eup_js(ie_exibe_dieta_categ_conv_w, nr_seq_regra_acomp_p, ie_lib_dieta_p, qt_dieta_acomp_p, nr_acompanhante_p, ie_atualiza_dieta_nenhuma_w, ie_gera_qt_acomp_w, ie_atualiza_dieta_w, nr_atendimento_p, cd_pessoa_fisica_p, cd_plano_convenio_p, cd_categoria_p, cd_convenio_p, nm_usuario_p, nr_acompanhante_ret_p, qt_dieta_acomp_ret_p, ie_lib_dieta_ret_p, nr_seq_regra_acomp_ret_p, ds_msg_dieta_p) INTO STRICT nr_acompanhante_ret_p, qt_dieta_acomp_ret_p, ie_lib_dieta_ret_p, nr_seq_regra_acomp_ret_p, ds_msg_dieta_p;

if	((ie_calcula_final_vigen_w = 'S') or (ie_calcula_final_vigen_w = 'A')) and (coalesce(cd_tipo_acomodacao_p,0) > 0) then
	
	select	to_char(max(hr_virada_diaria),'hh24:mi:ss')
	into STRICT	hr_virada_diaria_w
	from	tipo_acomodacao
	where	cd_tipo_acomodacao = cd_tipo_acomodacao_p;
	
	dt_parametro_w := to_char(dt_inicio_vigencia_p, 'dd/mm/yyyy') || ' ' || hr_virada_diaria_w;
	qt_dias_autor_w	:= obter_qt_autor_conv(nr_atendimento_p);
	
	if (ie_calcula_final_vigen_w = 'S') then
		if (coalesce(qt_dias_autor_w,0) = 0) then
			qt_dias_autor_w	:= qt_dia_internacao_p;
		end if;
		dt_final_vigencia_ret_p := to_date(dt_parametro_w,'dd/mm/yyyy hh24:mi:ss') + qt_dias_autor_w;
		if (dt_final_vigencia_ret_p < dt_inicio_vigencia_p) then
			dt_final_vigencia_ret_p := dt_final_vigencia_ret_p + 1;
		end if;
	elsif (ie_calcula_final_vigen_w = 'A') and (coalesce(qt_dias_autor_w,0) > 0) then
		dt_final_vigencia_ret_p := to_date(dt_parametro_w,'dd/mm/yyyy hh24:mi:ss') + qt_dias_autor_w;
	end if;
end if;	

begin
	select	coalesce(ie_copia_senha_guia,'N'),
		coalesce(ie_copia_senha_guia_princ,'N')
	into STRICT	ie_copia_senha_guia_w,
		ie_copia_senha_guia_princ_w
	from  	convenio_estabelecimento
	where 	cd_convenio = cd_convenio_p                            
	and   	cd_estabelecimento = cd_estabelecimento_w;
exception
when others then
	ie_copia_senha_guia_w		:= 'N';
	ie_copia_senha_guia_princ_w	:= 'N';
end;

if (cd_senha_p IS NOT NULL AND cd_senha_p::text <> '') and
	((nr_doc_convenio_p <> cd_senha_p) or (coalesce(nr_doc_convenio_p::text, '') = '')) and (ie_copia_senha_guia_w = 'S') then
	
	nr_doc_convenio_ret_p := cd_senha_p;
end if;

if (cd_senha_p IS NOT NULL AND cd_senha_p::text <> '') and
	((nr_doc_conv_principal_p <> cd_senha_p) or (coalesce(nr_doc_conv_principal_p::text, '') = '')) and (ie_copia_senha_guia_princ_w = 'S') then
	
	nr_doc_convenio_princ_ret_p := cd_senha_p;
end if;

if (coalesce(var_cd_usuario_conv_p,0) > 0) and (var_ie_enviar_email_p = 'S') then
	ds_msg_enviar_email_p := substr(obter_texto_dic_objeto(90573, wheb_usuario_pck.get_nr_seq_idioma, 'ITEM='||var_ds_email_p),1,255);
end if;

if	((ie_abre_auto_conveio_w = 'S') and (coalesce(nr_doc_convenio_p::text, '') = '') and (coalesce(NR_DOC_CONV_RETORNO_P::text, '') = '')) or
	(((ie_tipo_conv_auto_convenio_w = 'S') or (Obter_Se_Contido_char(ie_tipo_convenio_p, ie_tipo_conv_auto_convenio_w) = 'S')) and (coalesce(cd_senha_p::text, '') = '')) then
	ie_chama_auto_convenio_p := 'S';
	if	((ie_tipo_conv_auto_convenio_w = 'S') or (Obter_Se_Contido_char(ie_tipo_convenio_p, ie_tipo_conv_auto_convenio_w) = 'S')) then
		ie_chama_auto_convenio_grid_p := 'S';
	end if;
end if;

<<final>>
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_categ_befpost_eup_js ( var_ds_email_p text, var_ie_enviar_email_p text, var_cd_usuario_conv_p bigint, qt_dia_internacao_p bigint, dt_inicio_vigencia_p timestamp, ie_carater_inter_sus_p text, nr_seq_regra_acomp_p bigint, ie_lib_dieta_p text, qt_dieta_acomp_p bigint, nr_acompanhante_p bigint, ie_alterou_plano_p text, ie_alterou_categoria_p text, ie_alterou_convenio_p text, ie_tipo_convenio_p bigint, ie_completo_p text, cd_convenio_old_p bigint, cd_medico_resp_p text, nr_seq_cobertura_p bigint, nr_seq_queixa_p bigint, nr_seq_tipo_acidente_p bigint, cd_procedencia_p bigint, nr_seq_classificacao_p bigint, cd_setor_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, dt_validade_cart_glosa_p timestamp, nr_seq_origem_p bigint, dt_validade_carteira_p timestamp, dt_final_vigencia_p timestamp, cd_complemento_glosa_p text, cd_usuario_conv_glosa_p text, cd_categoria_glosa_p text, cd_convenio_glosa_p bigint, cd_compl_usuario_p text, nr_doc_conv_principal_p text, cd_empresa_p bigint, cd_categoria_p text, ie_tipo_guia_p text, cd_senha_p text, ie_alterou_guia_p text, ie_edicao_registro_p text, ie_tipo_atendimento_p bigint, nr_doc_convenio_old_p text, nr_doc_convenio_p text, ie_novo_registro_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_usuario_convenio_p text, cd_convenio_p bigint, cd_tipo_acomodacao_p bigint, cd_plano_convenio_p text, nr_seq_visao_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_alerta_cart_p INOUT text, ds_msg_abort_cons_cart_p INOUT text, ds_msg_alerta_cartao_sus_p INOUT text, nr_doc_conv_retorno_p INOUT text, ds_msg_consist_categ_conv_p INOUT text, ds_msg_incons_conta_p INOUT text, ie_aborta_acao_p INOUT text, ds_msg_regra_atend_p INOUT text, ds_msg_cons_cart_categ_p INOUT text, ds_msg_cons_cart_plano_p INOUT text, ds_msg_bloq_excl_atend_p INOUT text, ds_msg_bloquei_atend_p INOUT text, ie_focar_no_convenio_p INOUT text, ds_msg_medico_cred_p INOUT text, ds_msg_empresa_ref_p INOUT text, ds_msg_cart_fidel_venc_p INOUT text, ds_msg_consist_reinter_p INOUT text, ds_msg_conv_alerta_p INOUT text, ie_apresenta_consist_prescr_p INOUT text, ds_msg_alerta_cpf_p INOUT text, ds_proc_regra_val_usuario_p INOUT text, nr_acompanhante_ret_p INOUT bigint, qt_dieta_acomp_ret_p INOUT bigint, ie_lib_dieta_ret_p INOUT text, nr_seq_regra_acomp_ret_p INOUT bigint, ds_msg_dieta_p INOUT text, ds_msg_alerta_tit_venc_p INOUT text, dt_final_vigencia_ret_p INOUT timestamp, ds_msg_enviar_email_p INOUT text, nr_doc_convenio_ret_p INOUT text, nr_doc_convenio_princ_ret_p INOUT text, ie_chama_auto_convenio_p INOUT text, ie_chama_auto_convenio_grid_p INOUT text, ie_abortar_p INOUT text, nr_seq_regra_p INOUT bigint, ie_usuario_categoria_out_w INOUT text) FROM PUBLIC;

