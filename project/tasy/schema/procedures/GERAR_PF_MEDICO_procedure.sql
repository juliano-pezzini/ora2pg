-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pf_medico ( nr_crm_p text, uf_crm_p text, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_pessoa_fisica_ww	varchar(10);
ds_erro_w		varchar(2000);

nr_crm_w		varchar(20);
uf_crm_w		medico.uf_crm%type;
nm_medico_w		varchar(60);


BEGIN

CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');

begin

	if (nr_crm_p > '0') and (nr_crm_p IS NOT NULL AND nr_crm_p::text <> '') then

		select	nr_crm,
			uf_crm,
			nm_medico
		into STRICT	nr_crm_w,
			uf_crm_w,
			nm_medico_w
		from 	cadastro_medico
		where	nr_crm	= nr_crm_p
		and	uf_crm 	= uf_crm_p;

		begin
		select	coalesce(max(a.cd_pessoa_fisica),'0')
		into STRICT	cd_pessoa_fisica_ww
		from	pessoa_fisica a,
			medico b
		where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
		and	somente_numero(b.nr_crm)	= nr_crm_w
		and	b.uf_crm			= uf_crm_w;
		exception
			when others then
			cd_pessoa_fisica_ww	:= '0';
		end;

		if (cd_pessoa_fisica_ww = '0') then

			select	nextval('pessoa_fisica_seq')
			into STRICT	cd_pessoa_fisica_w
			;

			begin
			insert 	into	pessoa_fisica(
				cd_pessoa_fisica,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				ie_tipo_pessoa,
				nm_pessoa_fisica,
				nm_pessoa_fisica_sem_acento,
				nm_pessoa_pesquisa)
			values (cd_pessoa_fisica_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				1,
				nm_medico_w,
				elimina_acentuacao(nm_medico_w),
				padronizar_nome(nm_medico_w));
			exception
				when others then
				ds_erro_w	:= sqlerrm;
			end;


			begin
			insert into medico(
				cd_pessoa_fisica,
				nr_crm,
				nm_guerra,
				ie_vinculo_medico,
				ie_corpo_assist,
				ie_corpo_clinico,
				dt_atualizacao,
				nm_usuario,
				uf_crm,
				ie_situacao)
			values (cd_pessoa_fisica_w,
				nr_crm_w,
				nm_medico_w,
				14,
				'N',
				'N',
				clock_timestamp(),
				nm_usuario_p,
				uf_crm_w,
				'A');
			exception
				when others then
				ds_erro_w	:= sqlerrm;
			end;

		end if;

	end if;
exception
	when others then
	CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');
end;

commit;

CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pf_medico ( nr_crm_p text, uf_crm_p text, nm_usuario_p text) FROM PUBLIC;

