-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_copiar_equipamento ( nr_seq_equipamento_p bigint, nr_seq_localizacao_p bigint, ie_assistencia_p text, ie_contrato_p text, ie_anexo_p text, nm_usuario_p text, nr_seq_tipo_equipamento_p bigint, ie_local_adic_p text, ie_dano_padrao_p text, ie_gravar_estab_p text, qt_copias_p bigint default 1) AS $body$
DECLARE


nr_sequencia_w			bigint;
ie_incluir_copia_nome_w		varchar(01);
cd_centro_custo_w			integer;
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
cd_estab_contabil_w		smallint;
qt_copias_aux_w			bigint := 0;


BEGIN

if (coalesce(qt_copias_p,0) > 0) then
	begin
	ie_incluir_copia_nome_w := obter_param_usuario(298, 27, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_incluir_copia_nome_w);

	if (coalesce(ie_gravar_estab_p,'0') = '1') then
		begin
		select	max(cd_estabelecimento)
		into STRICT	cd_estab_contabil_w
		from	man_localizacao
		where	nr_sequencia = nr_seq_localizacao_p;
		exception
		when others then
			cd_estab_contabil_w := null;
		end;
	end if;

	select	max(b.cd_centro_custo)
	into STRICT	cd_centro_custo_w
	from	centro_custo b,
		setor_atendimento a,
		man_localizacao c
	where	a.cd_centro_custo	= b.cd_centro_custo
	and	c.cd_setor		= a.cd_setor_atendimento
	and	c.nr_sequencia		= nr_seq_localizacao_p;

	while(qt_copias_aux_w < qt_copias_p) loop
		begin
		select	nextval('man_equipamento_seq')
		into STRICT	nr_sequencia_w
		;

		insert into man_equipamento(
			nr_sequencia,
			ds_equipamento,
			nr_seq_local,
			nr_seq_tipo_equip,
			dt_atualizacao,
			nm_usuario,
			nr_seq_planej,
			nr_seq_trab,
			ie_situacao,
			cd_imobilizado,
			cd_impacto,
			cd_estab_contabil,
			cd_centro_custo,
			ie_voltagem,
			dt_ano_fabricacao,
			ds_marca,
			ds_modelo,
			qt_peso,
			nr_seq_fabricante,
			cd_nacionalidade,
			cd_fornecedor,
			dt_aquisicao,
			vl_aquisicao,
			cd_moeda,
			dt_inicio_garantia,
			dt_fim_garantia,
			nr_doc_garantia,
			ds_observacao,
			nr_serie,
			ie_disponibilidade,
			nr_seq_contador,
			ie_rotina_seguranca,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_propriedade,
			cd_cgc_terc,
			vl_custo_sem_utilizacao,
			ie_parado,
			nr_seq_superior,
			ie_controle_setor,
			nr_seq_categoria,
			nr_seq_status,
			cd_pessoa_terceiro,
			ie_tensao_ac,
			qt_corrente_ac,
			qt_potencia_ac,
			ie_tensao_dc,
			qt_corrente_dc,
			qt_potencia_dc,
			nr_seq_marca,
			nr_seq_modelo,
			ds_padrao_os,
			qt_largura,
			qt_comprimento,
			qt_altura,
			ie_tensao_dc_saida,
			ie_tensao_ac_saida,
			qt_corrente_ac_saida,
			qt_corrente_dc_saida,
			qt_potencia_ac_saida,
			qt_potencia_dc_saida,
			ds_observacao_tensao,
			ie_consiste_os_duplic,
			nr_registro_anvisa,
			ie_tipo_ordem,
			nr_seq_tipo_ordem,
			ie_classificacao_os)
		SELECT	nr_sequencia_w,
			substr(CASE WHEN coalesce(ie_incluir_copia_nome_w,'S')='S' THEN  'CÃ³pia '  ELSE '' END  || ds_equipamento,1,80),
			nr_seq_localizacao_p,
			coalesce(nr_seq_tipo_equipamento_p,nr_seq_tipo_equip),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_planej,
			nr_seq_trab,
			ie_situacao,
			'',
			cd_impacto,
			CASE WHEN ie_gravar_estab_p='0' THEN cd_estab_contabil WHEN ie_gravar_estab_p='1' THEN cd_estab_contabil_w WHEN ie_gravar_estab_p='2' THEN null END ,
			coalesce(cd_centro_custo_w,cd_centro_custo),
			ie_voltagem,
			dt_ano_fabricacao,
			ds_marca,
			ds_modelo,
			qt_peso,
			nr_seq_fabricante,
			cd_nacionalidade,
			cd_fornecedor,
			dt_aquisicao,
			vl_aquisicao,
			cd_moeda,
			dt_inicio_garantia,
			dt_fim_garantia,
			nr_doc_garantia,
			ds_observacao,
			nr_serie,
			ie_disponibilidade,
			nr_seq_contador,
			ie_rotina_seguranca,
			clock_timestamp(),
			nm_usuario_p,
			ie_propriedade,
			cd_cgc_terc,
			vl_custo_sem_utilizacao,
			ie_parado,
			nr_seq_superior,
			ie_controle_setor,
			nr_seq_categoria,
			nr_seq_status,
			cd_pessoa_terceiro,
			ie_tensao_ac,
			qt_corrente_ac,
			qt_potencia_ac,
			ie_tensao_dc,
			qt_corrente_dc,
			qt_potencia_dc,
			nr_seq_marca,
			nr_seq_modelo,
			ds_padrao_os,
			qt_largura,
			qt_comprimento,
			qt_altura,
			ie_tensao_dc_saida,
			ie_tensao_ac_saida,
			qt_corrente_ac_saida,
			qt_corrente_dc_saida,
			qt_potencia_ac_saida,
			qt_potencia_dc_saida,
			ds_observacao_tensao,
			coalesce(ie_consiste_os_duplic,'N'),
			nr_registro_anvisa,
			ie_tipo_ordem,
			nr_seq_tipo_ordem,
			ie_classificacao_os
		from	man_equipamento
		where	nr_sequencia = nr_seq_equipamento_p;

		if (ie_assistencia_p = 'S') then
			insert into man_equip_assistencia(
				nr_sequencia,
				nr_seq_equipamento,
				nr_seq_tipo,
				dt_atualizacao,
				nm_usuario,
				cd_pessoa_fisica,
				cd_cgc,
				nm_contato,
				ds_telefone,
				ds_horario,
				ds_observacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			SELECT	nextval('man_equip_assistencia_seq'),
				nr_sequencia_w,
				nr_seq_tipo,
				clock_timestamp(),
				nm_usuario_p,
				cd_pessoa_fisica,
				cd_cgc,
				nm_contato,
				ds_telefone,
				ds_horario,
				ds_observacao,
				clock_timestamp(),
				nm_usuario_p
			from	man_equip_assistencia
			where	nr_seq_equipamento = nr_seq_equipamento_p;
		end if;

		if (ie_contrato_p = 'S') then
			insert into man_contrato_manut(
				nr_sequencia,
				nr_seq_equipamento,
				dt_atualizacao,
				nm_usuario,
				dt_inicio_contrato,
				dt_fim_contrato,
				nr_documento,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_cnpj,
				nr_seq_tipo_contrato,
				vl_contrato)
			SELECT	nextval('man_contrato_manut_seq'),
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				dt_inicio_contrato,
				dt_fim_contrato,
				nr_documento,
				clock_timestamp(),
				nm_usuario_p,
				cd_cnpj,
				nr_seq_tipo_contrato,
				vl_contrato
			from	man_contrato_manut
			where	nr_seq_equipamento = nr_seq_equipamento_p;
		end if;

		if (ie_anexo_p = 'S') then
			insert into man_equip_arq(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo,
				nr_seq_equipamento,
				dt_arquivo)
			SELECT	nextval('man_equip_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo,
				nr_sequencia_w,
				dt_arquivo
			from	man_equip_arq
			where	nr_seq_equipamento = nr_seq_equipamento_p;
		end if;

		if (ie_local_adic_p = 'S') then
			insert into man_equip_local_adic(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_equipamento,
				nr_seq_local)
			SELECT	nextval('man_equip_local_adic_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				nr_seq_local
			from	man_equip_local_adic
			where	nr_seq_equipamento = nr_seq_equipamento_p;
		end if;

		if (ie_dano_padrao_p = 'S') then
			insert into man_equipamento_dano(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_equipamento,
				ds_dano,
				nr_seq_apresentacao)
			SELECT  nextval('man_equipamento_dano_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				ds_dano,
				nr_seq_apresentacao
			from	man_equipamento_dano
			where	nr_seq_equipamento = nr_seq_equipamento_p;
		end if;

		qt_copias_aux_w := qt_copias_aux_w + 1;
		end;
	end loop;
	end;
end if;

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_copiar_equipamento ( nr_seq_equipamento_p bigint, nr_seq_localizacao_p bigint, ie_assistencia_p text, ie_contrato_p text, ie_anexo_p text, nm_usuario_p text, nr_seq_tipo_equipamento_p bigint, ie_local_adic_p text, ie_dano_padrao_p text, ie_gravar_estab_p text, qt_copias_p bigint default 1) FROM PUBLIC;

