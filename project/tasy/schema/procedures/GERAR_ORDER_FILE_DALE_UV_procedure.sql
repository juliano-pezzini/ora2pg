-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_order_file_dale_uv ( nr_seq_mensagem_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			duv_arquivo_auf.nr_sequencia%type;
duv_arquivo_auf_w		duv_arquivo_auf%rowtype;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_cgc_comunic_w		pessoa_juridica.cd_cgc%type;
nm_arquivo_w			duv_arquivo_auf.NM_ARQUIVO%type;
nr_ik_hospital_w		varchar(9) := '0';
nr_ik_comunic_w			varchar(9) := '0';
nr_ik_convenio_w		varchar(9) := '0';
dt_inicio_ref_w			timestamp;
ds_conteudo_w			varchar(4000);
ds_conteudo_aux_w		varchar(4000);
ds_complemento_w		varchar(4000);
qt_tamanho_w			varchar(12) := '0';
cd_mensagem_w			DUV_TIPO_MENSAGEM.cd_mensagem%type;
nr_seq_mensagem_w		duv_arquivo_auf.NR_SEQ_MENSAGEM%type;

	procedure concatena_valor(ds_valor_p	in text,
				ds_valor_out_p	out text) is
	;
BEGIN
	ds_conteudo_w 	:= ds_conteudo_w || ds_valor_p;
	ds_valor_out_p	:= ds_valor_p;
	end;

begin

delete	FROM duv_arquivo_auf
where	nr_seq_mensagem = nr_seq_mensagem_p;
commit;


select	max(nr_seq_tipo_mensagem)
into STRICT	nr_seq_mensagem_w
from 	duv_mensagem
where 	nr_sequencia = nr_seq_mensagem_p;


select	coalesce(upper(cd_mensagem),'0')
into STRICT	cd_mensagem_w
from	DUV_TIPO_MENSAGEM
where	nr_sequencia = nr_seq_mensagem_w;


select	wheb_usuario_pck.get_cd_estabelecimento
into STRICT	cd_estabelecimento_w
;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	select	coalesce(a.cd_cnes,'0')
	into STRICT	nr_ik_hospital_w
	from	pessoa_juridica a,
			estabelecimento b
	where	a.cd_cgc				= b.cd_cgc
	and		b.cd_estabelecimento	= cd_estabelecimento_w;
end if;

select	max(a.CD_ORIGEM)
into STRICT	cd_cgc_comunic_w
from	DUV_UNB a,
		DUV_MENSAGEM b
where	a.nr_seq_mensagem = b.nr_sequencia
and		b.nr_sequencia = nr_seq_mensagem_p;

if (cd_cgc_comunic_w IS NOT NULL AND cd_cgc_comunic_w::text <> '') then
		select	max(coalesce(a.cd_cnes,'0'))
		into STRICT	nr_ik_comunic_w
		from	pessoa_juridica a
		where	a.cd_cgc			= cd_cgc_comunic_w;
end if;

select	max(coalesce(a.CD_CONVENIO_EXT,'0'))
into STRICT	nr_ik_convenio_w
from	DUV_UVT a,
		DUV_MENSAGEM b
where	a.nr_seq_mensagem = b.nr_sequencia
and		b.nr_sequencia = nr_seq_mensagem_p;


--Dateinamen  / File Name
/*
select 	to_char(nr_ik_comunic_w)||'_'||to_char(sysdate, 'YY')||'_'||to_char(lpad(nr_sequencia,6,'0'))
into	nm_arquivo_w
from	dual;
*/
ds_conteudo_w	:= '';

select	nextval('duv_arquivo_auf_seq')
into STRICT	nr_sequencia_w
;

duv_arquivo_auf_w.nr_sequencia			:= nr_sequencia_w;
duv_arquivo_auf_w.dt_atualizacao		:= clock_timestamp();
duv_arquivo_auf_w.nm_usuario			:= nm_usuario_p;
duv_arquivo_auf_w.dt_atualizacao_nrec	:= clock_timestamp();
duv_arquivo_auf_w.nm_usuario_nrec		:= nm_usuario_p;
duv_arquivo_auf_w.nr_seq_mensagem		:= nr_seq_mensagem_p;


concatena_valor('500000',	duv_arquivo_auf_w.ds_identificador);
concatena_valor('01', 		duv_arquivo_auf_w.ds_versao);
concatena_valor('00000348', duv_arquivo_auf_w.qt_tam_arq_auf);
concatena_valor('000', 		duv_arquivo_auf_w.nr_serial_number);

concatena_valor('00000', 	duv_arquivo_auf_w.ds_tipo_dado);

concatena_valor('001',		duv_arquivo_auf_w.nr_transacao);
concatena_valor(lpad(cd_mensagem_w,5,' '),	duv_arquivo_auf_w.ds_ident_proc);
concatena_valor(rpad(coalesce(coalesce(nr_ik_comunic_w,nr_ik_hospital_w),' '),15,' '),	duv_arquivo_auf_w.nr_ik_remetente_comunic);
concatena_valor(rpad(coalesce(nr_ik_hospital_w,' '),15,' '),	duv_arquivo_auf_w.nr_ik_remetente_hosp);
concatena_valor(rpad(coalesce(nr_ik_convenio_w,' '),15,' '),	duv_arquivo_auf_w.nr_ik_destinatario_comunic);
concatena_valor(rpad(coalesce(nr_ik_convenio_w,' '),15,' '),	duv_arquivo_auf_w.nr_ik_destinatario_conv);
concatena_valor('000000',duv_arquivo_auf_w.cd_erro); --Inhalt: „00000,“
concatena_valor('000000',duv_arquivo_auf_w.cd_acao_erro); --Inhalt: „00000,“
concatena_valor(rpad(coalesce(nm_arquivo_w,' '),11,' '),duv_arquivo_auf_w.nm_arquivo);
concatena_valor(to_char(clock_timestamp(),'YYYYMMDDHH24MISS'),duv_arquivo_auf_w.ds_dt_criacao);
concatena_valor('00000000000000',duv_arquivo_auf_w.ds_dt_inicio_trans);
concatena_valor('00000000000000',duv_arquivo_auf_w.ds_dt_inicio_receb);
concatena_valor('00000000000000',duv_arquivo_auf_w.ds_dt_fim_receb);
concatena_valor('000010',duv_arquivo_auf_w.ds_versao_arq);
concatena_valor('0',duv_arquivo_auf_w.ie_arquivo_reenvio);
concatena_valor(lpad(qt_tamanho_w,12,'0'),duv_arquivo_auf_w.qt_tamanho_arq);
concatena_valor(lpad(qt_tamanho_w,12,'0'),duv_arquivo_auf_w.qt_tamanho_arq_cripto);
concatena_valor('I8',duv_arquivo_auf_w.ie_charset);
concatena_valor('00',duv_arquivo_auf_w.ie_compactacao);
concatena_valor('00',duv_arquivo_auf_w.ie_criptografia);
concatena_valor('00',duv_arquivo_auf_w.ie_assinatura);
concatena_valor('U  ',duv_arquivo_auf_w.ie_formato);
concatena_valor('00000',duv_arquivo_auf_w.qt_tamanho_format);
concatena_valor('00000000',duv_arquivo_auf_w.qt_tamanho_block);

--Complementovo padrão no fim do arquivo
ds_complemento_w	:= '00000000000000000000                                                                                                      '; -----------################
concatena_valor(ds_complemento_w,ds_conteudo_aux_w);


duv_arquivo_auf_w.ds_conteudo_auf	:= ds_conteudo_w;

insert into duv_arquivo_auf values (duv_arquivo_auf_w.*);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_order_file_dale_uv ( nr_seq_mensagem_p bigint, nm_usuario_p text) FROM PUBLIC;

