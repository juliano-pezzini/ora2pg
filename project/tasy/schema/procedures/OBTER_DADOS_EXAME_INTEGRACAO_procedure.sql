-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_exame_integracao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_resultado_p bigint, nr_seq_material_p bigint, ds_sigla_equip_p text, cd_parametro_p text, nm_usuario_p text, nr_seq_item_p INOUT bigint, ie_formato_resultado_p INOUT text, ie_campo_calculo_p INOUT text) AS $body$
DECLARE

nr_seq_item_w		bigint;
ie_formato_resultado_w	varchar(3);
ie_campo_calculo_w	varchar(1);


BEGIN

select  coalesce(max(a.nr_seq_exame),0)
into STRICT	nr_seq_item_w
from 	exame_laboratorio b,
	exame_lab_result_item a
where   b.nr_seq_exame = a.nr_seq_exame
and 	Obter_Equip_Exame_integracao(cd_parametro_p, ds_sigla_equip_p, 1) = b.nr_seq_exame
and 	a.nr_seq_resultado = nr_seq_resultado_p
and 	a.nr_seq_prescr    = nr_seq_prescr_p;

select	coalesce(max(obter_formato_result_exame(a.nr_seq_exame, nr_seq_material_p )),'') ie_formato_resultado
into STRICT	ie_formato_resultado_w
from 	exame_laboratorio b,
	exame_lab_result_item a
where 	b.nr_seq_exame = a.nr_seq_exame
and 	Obter_Equip_Exame_integracao(cd_parametro_p, ds_sigla_equip_p, 1) = b.nr_seq_exame
and 	a.nr_seq_resultado = nr_seq_resultado_p
and 	a.nr_seq_prescr    = nr_seq_prescr_p;



CALL gerar_lab_log_interf_imp( nr_prescricao_p,
			  nr_seq_prescr_p,
			  null,
			  null,
			  null,
			  '1.01 log:  sigla_equip: ' || ds_sigla_equip_p ||
			  ' Material do TasyLAB: ' || nr_seq_material_p ||
			  ' cd_parametro: ' || cd_parametro_p ||
			  ' length(cd_parametro): ' || length(cd_parametro_p) ||
			  ' nr_Seq_resultado: ' || nr_seq_resultado_p ||
			  ' nr_seq_prescr: ' || nr_seq_prescr_p ||
			  ' ie_formato_result: ' ||ie_formato_resultado_w ||
			  ' nr_seq_item: ' || nr_seq_item_w,
			  null,
			  nm_usuario_p,
			  'N');


if ( coalesce(ie_formato_resultado_w,'0') = '0') then

	select	coalesce(max(substr(obter_formato_result_exame(Obter_Equip_Exame_integracao(cd_parametro_p, ds_sigla_equip_p, 1), nr_seq_material_p),1,3)),'') ie_formato_resultado
	into STRICT	ie_formato_resultado_w
	;

	CALL gerar_lab_log_interf_imp( nr_prescricao_p,
				  nr_seq_prescr_p,
				  null,
				  null,
				  null,
				  '1.11 log::  sigla_equip: ' || ds_sigla_equip_p ||
				  ' Material do TasyLAB: ' || nr_seq_material_p ||
				  ' cd_parametro: ' || cd_parametro_p ||
				  ' length(cd_parametro): ' || length(cd_parametro_p) ||
				  ' nr_Seq_resultado: ' || nr_seq_resultado_p ||
				  ' nr_seq_prescr: ' || nr_seq_prescr_p ||
				  ' ie_formato_result: ' ||ie_formato_resultado_w ||
				  ' nr_seq_item: ' || nr_seq_item_w,
				  null,
				  nm_usuario_p,
				  'N');


end if;

select  coalesce(max(b.ie_campo_calculo),'')
into STRICT	ie_campo_calculo_w
from 	exame_laboratorio b,
 	exame_lab_result_item a
where 	b.nr_seq_exame = a.nr_seq_exame
and 	Obter_Equip_Exame_integracao(cd_parametro_p, ds_sigla_equip_p, 1) = b.nr_seq_exame
and 	a.nr_seq_resultado = nr_seq_resultado_p
and 	a.nr_seq_prescr    = nr_seq_prescr_p;

if ( coalesce(nr_seq_item_w,0) = 0) then

	select  coalesce(max(a.nr_seq_exame),0)
	into STRICT	nr_seq_item_w
	from 	exame_laboratorio b,
		exame_lab_result_item a
	where 	b.nr_seq_exame = a.nr_seq_exame
	and 	coalesce(b.cd_exame_integracao, b.cd_exame) = cd_parametro_p
	and 	a.nr_seq_resultado = nr_seq_resultado_p
	and 	a.nr_seq_prescr    = nr_seq_prescr_p;

	select  coalesce(max(obter_formato_result_exame(a.nr_seq_exame, nr_seq_material_p)),'') ie_formato_resultado
	into STRICT	ie_formato_resultado_w
	from 	exame_laboratorio b,
		exame_lab_result_item a
	where 	b.nr_seq_exame = a.nr_seq_exame
	and 	coalesce(b.cd_exame_integracao, b.cd_exame) = cd_parametro_p
	and 	a.nr_seq_resultado = nr_seq_resultado_p
	and 	a.nr_seq_prescr    = nr_seq_prescr_p;

	CALL gerar_lab_log_interf_imp( nr_prescricao_p,
				  nr_seq_prescr_p,
				  null,
				  null,
				  null,
				  '2 log: Material do TasyLAB: ' || nr_seq_material_P ||
				  ' cd_parametro: ' || cd_parametro_p ||
				  ' nr_Seq_resultado: ' || nr_seq_resultado_p ||
				  ' nr_seq_prescr: ' || nr_seq_prescr_p ||
				  ' ie_formato_result: ' || ie_formato_resultado_w,
				  null,
				  nm_usuario_p,
				  'N');



	select 	coalesce(max(b.ie_campo_calculo),'')
	into STRICT	ie_campo_calculo_w
	from 	exame_laboratorio b,
		exame_lab_result_item a
	where 	b.nr_seq_exame = a.nr_seq_exame
	and 	coalesce(b.cd_exame_integracao, b.cd_exame) = cd_parametro_p
	and 	a.nr_seq_resultado = nr_seq_resultado_p
	and 	a.nr_seq_prescr    = nr_seq_prescr_p;

end if;

nr_seq_item_p 	        := nr_seq_item_w;
ie_formato_resultado_P  := ie_formato_resultado_w;
ie_campo_calculo_p  	:= ie_campo_calculo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_exame_integracao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_resultado_p bigint, nr_seq_material_p bigint, ds_sigla_equip_p text, cd_parametro_p text, nm_usuario_p text, nr_seq_item_p INOUT bigint, ie_formato_resultado_p INOUT text, ie_campo_calculo_p INOUT text) FROM PUBLIC;

