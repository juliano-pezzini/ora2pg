-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_ato_desp_aviso ( dt_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_competencia_p bigint, ie_opcao_p text) AS $body$
DECLARE


cd_mat_envio_w			ptu_aviso_material.cd_mat_envio%type;
cd_proc_envio_w			ptu_aviso_procedimento.cd_proc_envio%type;
nr_seq_ptu_aviso_conta_w		ptu_aviso_conta.nr_sequencia%type;
cd_tabela_w			ptu_aviso_procedimento.cd_tabela%type;
nr_seq_grupo_ans_proc_w		bigint := null;
ie_ato_cooperado_proc_w		bigint;
nr_seq_grupo_ans_mat_w		bigint := null;
ie_ato_cooperado_mat_w		bigint;
nr_contador_w			bigint := 0;
nr_seq_regra_w			varchar(255);
nr_seq_ptu_aviso_proc_w		bigint;
nr_seq_ptu_aviso_mat_w		bigint;
dt_referencia_month_w		timestamp;
dt_ref_inicial_w		timestamp;
dt_ref_final_w			timestamp;

/* ie_opcao_p: 'A'-> ATO_COOPERADO  |	'G'-> GRUPO_ANS*/

	
c_aviso_cobr CURSOR FOR	
	SELECT	p.nr_sequencia nr_seq_ptu_aviso_proc,
		null nr_seq_ptu_aviso_mat,
		p.cd_proc_envio	cd_ptu_aviso_proc,
		null cd_ptu_mat,
		ac.nr_sequencia	nr_seq_ptu_aviso_conta,
		p.cd_tabela cd_tabela
	from	ptu_lote_aviso		l,
		ptu_aviso_arquivo	a,
		ptu_aviso_procedimento 	p,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac
	where	coalesce(l.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
	and     l.nr_sequencia		= a.nr_seq_lote
	and	a.nr_sequencia		= ap.nr_seq_arquivo
	and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
	and	ac.nr_sequencia		= p.nr_seq_aviso_conta
	and	l.ie_tipo_lote		= 'R'
	and	a.dt_transacao between dt_ref_inicial_w and dt_ref_final_w
	
union all

	SELECT	null nr_seq_ptu_aviso_proc,
		m.nr_sequencia nr_seq_ptu_aviso_mat,
		null cd_ptu_aviso_proc,
		m.cd_mat_envio cd_ptu_mat,
		ac.nr_sequencia nr_seq_ptu_aviso_conta,
		m.cd_tabela cd_tabela
	from	ptu_lote_aviso		l,
		ptu_aviso_arquivo	a,
		ptu_aviso_material	m,
		ptu_aviso_protocolo	ap,
		ptu_aviso_conta		ac
	where	coalesce(l.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
	and     l.nr_sequencia		= a.nr_seq_lote
	and	a.nr_sequencia		= ap.nr_seq_arquivo
	and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
	and	ac.nr_sequencia		= m.nr_seq_aviso_conta
	and	l.ie_tipo_lote		= 'R'
	and	a.dt_transacao between dt_ref_inicial_w and dt_ref_final_w;

c_aviso_w 	c_aviso_cobr%rowtype;


BEGIN

dt_referencia_month_w	:= trunc(dt_referencia_p,'month');
dt_ref_inicial_w	:= dt_referencia_month_w;
dt_ref_final_w		:= fim_dia(fim_mes(dt_referencia_month_w));

open c_aviso_cobr;
	loop
	fetch c_aviso_cobr into
		c_aviso_w;
	EXIT WHEN NOT FOUND; /* apply on c_aviso_cobr */
		begin

		nr_seq_ptu_aviso_proc_w		:=	c_aviso_w.nr_seq_ptu_aviso_proc;
		nr_seq_ptu_aviso_mat_w		:=	c_aviso_w.nr_seq_ptu_aviso_mat;
		cd_proc_envio_w			:=	c_aviso_w.cd_ptu_aviso_proc;
		cd_mat_envio_w			:=	c_aviso_w.cd_ptu_mat;
		nr_seq_ptu_aviso_conta_w	:=	c_aviso_w.nr_seq_ptu_aviso_conta;
		cd_tabela_w			:= 	c_aviso_w.cd_tabela;
		
		nr_contador_w := nr_contador_w + 1;

		nr_seq_grupo_ans_proc_w := pls_obter_grupo_ans_a520(nr_seq_ptu_aviso_conta_w, 'P', cd_proc_envio_w, null, cd_tabela_w);
		SELECT * FROM pls_obter_tipo_ato_coop_a520(nr_seq_ptu_aviso_conta_w, 'P', cd_proc_envio_w, null, cd_tabela_w, nr_seq_regra_w, ie_ato_cooperado_proc_w) INTO STRICT nr_seq_regra_w, ie_ato_cooperado_proc_w;

		nr_seq_grupo_ans_mat_w := pls_obter_grupo_ans_a520(nr_seq_ptu_aviso_conta_w, 'M', null, cd_mat_envio_w, cd_tabela_w);
		SELECT * FROM pls_obter_tipo_ato_coop_a520(nr_seq_ptu_aviso_conta_w, 'M', null, cd_mat_envio_w, cd_tabela_w, nr_seq_regra_w, ie_ato_cooperado_mat_w) INTO STRICT nr_seq_regra_w, ie_ato_cooperado_mat_w;
		
		if (ie_opcao_p = 'A') then
			update ptu_aviso_procedimento
			set 	ie_ato_cooperado 	= ie_ato_cooperado_proc_w
			where	nr_sequencia		= nr_seq_ptu_aviso_proc_w;

			update ptu_aviso_material
			set 	ie_ato_cooperado 	= ie_ato_cooperado_mat_w
			where	nr_sequencia		= nr_seq_ptu_aviso_mat_w;

		end if;

		if (ie_opcao_p = 'G') then
			update ptu_aviso_procedimento
			set 	nr_seq_grupo_ans 	= nr_seq_grupo_ans_proc_w
			where	nr_sequencia		= nr_seq_ptu_aviso_proc_w;

			update ptu_aviso_material
			set 	nr_seq_grupo_ans 	= nr_seq_grupo_ans_mat_w
			where	nr_sequencia		= nr_seq_ptu_aviso_mat_w;

		end if;

		if (mod(nr_contador_w,1000) = 0) then
			commit;
		end if;
		
		end;

	end loop;
close c_aviso_cobr;

nr_contador_w := 0;

if (ie_opcao_p = 'A') then
	update 	pls_competencia
	set 	dt_atualizacao_ato 	= clock_timestamp()
	where 	nr_sequencia 		= nr_seq_competencia_p;
end if;
if (ie_opcao_p = 'G') then
	update 	pls_competencia
	set 	dt_atualizacao_grupo 	= clock_timestamp()
	where 	nr_sequencia 		= nr_seq_competencia_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_ato_desp_aviso ( dt_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_competencia_p bigint, ie_opcao_p text) FROM PUBLIC;

