-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_gerar_itens_solic ( nr_seq_licitacao_p bigint, nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_lic_item_w				integer;
nr_item_solic_compra_w			integer;
cd_material_w				integer;
qt_material_w				double precision;
qt_existe_w				bigint;
cd_unidade_medida_compra_w		varchar(30);
nr_seq_proj_rec_w			bigint;

c01 CURSOR FOR
SELECT	a.nr_item_solic_compra,
	a.cd_material,
	a.qt_material,
	a.cd_unidade_medida_compra,
	a.nr_seq_proj_rec
from	solic_compra_item a
where	a.nr_solic_compra = nr_solic_compra_p
and	((nr_item_solic_compra_p = 0) or
	(nr_item_solic_compra_p > 0 AND a.nr_item_solic_compra = nr_item_solic_compra_p))
and not exists (
	SELECT	1
	from	reg_lic_solic_item x
	where	x.nr_solic_compra		= a.nr_solic_compra
	and	x.nr_item_solic_compra	= a.nr_item_solic_compra);


BEGIN

if (coalesce(nr_solic_compra_p,0) > 0) then
	begin

	open C01;
	loop
	fetch C01 into
		nr_item_solic_compra_w,
		cd_material_w,
		qt_material_w,
		cd_unidade_medida_compra_w,
		nr_seq_proj_rec_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	coalesce(max(nr_seq_lic_item),0)
		into STRICT	nr_seq_lic_item_w
		from	reg_lic_item
		where	cd_material = cd_material_w
		and	nr_seq_licitacao = nr_seq_licitacao_p;

		if (nr_seq_lic_item_w = 0) then

			select (coalesce(max(nr_seq_lic_item),0) + 1)
			into STRICT	nr_seq_lic_item_w
			from	reg_lic_item
			where	nr_seq_licitacao = nr_seq_licitacao_p;

			insert into reg_lic_item(
				dt_atualizacao,
				nm_usuario,
				nr_seq_licitacao,
				nr_seq_lic_item,
				cd_material,
				cd_unid_medida,
				ds_adicional,
				qt_item,
				nr_seq_proj_rec)
			values (	clock_timestamp(),
				nm_usuario_p,
				nr_seq_licitacao_p,
				nr_seq_lic_item_w,
				cd_material_w,
				cd_unidade_medida_compra_w,
				'',
				qt_material_w,
				nr_seq_proj_rec_w);
		else
			update	reg_lic_item
			set	qt_item		= (qt_item + qt_material_w)
			where	nr_seq_lic_item	= nr_seq_lic_item_w
			and	nr_seq_licitacao	= nr_seq_licitacao_p;
		end if;

		insert into reg_lic_solic_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_licitacao,
			nr_seq_lic_item,
			nr_solic_compra,
			nr_item_solic_compra,
			qt_item)
		values (	nextval('reg_lic_solic_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_licitacao_p,
			nr_seq_lic_item_w,
			nr_solic_compra_p,
			nr_item_solic_compra_w,
			qt_material_w);
		end;
	end loop;
	close C01;

	commit;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_gerar_itens_solic ( nr_seq_licitacao_p bigint, nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

