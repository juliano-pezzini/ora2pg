-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desdobramento_item_audit (nr_sequencia_p bigint, qt_item_p bigint, ie_proc_mat_p text, nr_seq_motivo_audit_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
nr_seq_gerada_w		bigint;
nr_seq_item_w		bigint;
qt_diferenca_w		double precision:=0;
qt_original_w		double precision:=0;
cd_convenio_w		integer;
cd_local_estoque_w		smallint;
dt_atualizacao_estoque_w	timestamp;
	

BEGIN 
 
if (ie_proc_mat_p = 'M') then 
 
	select 	max(nr_seq_matpaci) 
	into STRICT	nr_seq_item_w 
	from 	auditoria_matpaci 
	where 	nr_sequencia = nr_sequencia_p;
 
	nr_seq_gerada_w := Duplicar_mat_paciente(nr_seq_item_w, nm_usuario_p, 'N', nr_seq_gerada_w);
	 
	select 	coalesce(max(qt_material),0), 
		coalesce(max(cd_convenio),0), 
		max(cd_local_estoque), 
		max(dt_atualizacao_estoque) 
	into STRICT	qt_original_w, 
		cd_convenio_w, 
		cd_local_estoque_w, 
		dt_atualizacao_estoque_w 
	from 	material_atend_paciente 
	where 	nr_sequencia = nr_seq_item_w;
	 
	qt_diferenca_w:= qt_original_w - qt_item_p;
	 
	update	material_atend_paciente 
	set 	qt_material = qt_item_p, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp(),		 
		ds_observacao = Wheb_mensagem_pck.get_Texto(305949) /*'Desdobramento Item -> Auditoria Conta Paciente'*/
 
	where 	nr_sequencia = nr_seq_item_w;
	 
	CALL atualiza_preco_material(nr_seq_item_w, nm_usuario_p);
	 
	update	material_atend_paciente 
	set 	qt_material = qt_diferenca_w, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp(), 
		ie_auditoria = 'S', 
		nr_seq_mat_desdob = nr_seq_item_w, 
		cd_local_estoque = CASE WHEN cd_local_estoque_w = NULL THEN  cd_local_estoque  ELSE cd_local_estoque_w END , 
		dt_atualizacao_estoque = CASE WHEN cd_local_estoque_w = NULL THEN  dt_atualizacao_estoque  ELSE dt_atualizacao_estoque_w END , 
		ds_observacao = Wheb_mensagem_pck.get_Texto(305949) /*'Desdobramento Item -> Auditoria Conta Paciente'*/
 
	where 	nr_sequencia = nr_seq_gerada_w;
	 
	CALL atualiza_preco_material(nr_seq_gerada_w, nm_usuario_p);
	 
	commit;
	 
	CALL Atualizar_Lista_Itens_Audit(null, nr_seq_gerada_w, 1, qt_diferenca_w, nm_usuario_p, nr_seq_motivo_audit_p, null, 'N');
	 
	update auditoria_matpaci 
	set 	qt_original = qt_item_p, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp() 
	where	nr_sequencia = nr_sequencia_p;
else 
 
	select 	max(nr_seq_propaci) 
	into STRICT	nr_seq_item_w 
	from 	auditoria_propaci 
	where 	nr_sequencia = nr_sequencia_p;
 
	nr_seq_gerada_w := Duplicar_proc_paciente(nr_seq_item_w, nm_usuario_p, nr_seq_gerada_w);
	 
	select 	coalesce(max(qt_procedimento),0), 
		coalesce(max(cd_convenio),0) 
	into STRICT	qt_original_w, 
		cd_convenio_w 
	from 	procedimento_paciente 
	where 	nr_sequencia = nr_seq_item_w;
	 
	qt_diferenca_w:= qt_original_w - qt_item_p;
	 
	update	procedimento_paciente 
	set 	qt_procedimento = qt_item_p, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp(), 
		ds_observacao = Wheb_mensagem_pck.get_Texto(305949) /*'Desdobramento Item -> Auditoria Conta Paciente'*/
 
	where 	nr_sequencia = nr_seq_item_w;
	 
	CALL atualiza_preco_procedimento(nr_seq_item_w, cd_convenio_w, nm_usuario_p);
	 
	update	procedimento_paciente 
	set 	qt_procedimento = qt_diferenca_w, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp(), 
		ie_auditoria = 'S', 
		ds_observacao = Wheb_mensagem_pck.get_Texto(305949) /*'Desdobramento Item -> Auditoria Conta Paciente'*/
 
	where 	nr_sequencia = nr_seq_gerada_w;
	 
	CALL atualiza_preco_procedimento(nr_seq_gerada_w, cd_convenio_w, nm_usuario_p);
	 
	commit;
	 
	CALL Atualizar_Lista_Itens_Audit(null, nr_seq_gerada_w, 2, qt_diferenca_w, nm_usuario_p, nr_seq_motivo_audit_p, null, 'N');
	 
	update auditoria_propaci 
	set 	qt_original = qt_item_p, 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp() 
	where	nr_sequencia = nr_sequencia_p;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desdobramento_item_audit (nr_sequencia_p bigint, qt_item_p bigint, ie_proc_mat_p text, nr_seq_motivo_audit_p bigint, nm_usuario_p text) FROM PUBLIC;

