-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_categoria_convenio ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_senha_p text, cd_guia_p text, dt_validade_carteira_p timestamp, cd_usuario_convenio_p text, nr_seq_origem_p bigint, NR_DOC_CONV_PRINCIPAL_p text, dt_final_vigencia_p timestamp, cd_compl_usuario_p text, ds_erro_p INOUT text, ds_consistencia_p INOUT text, cd_categoria_p text, cd_convenio_glosa_p text, cd_categoria_glosa_p text, cd_usuario_conv_glosa_p text, cd_complemento_glosa_p text, dt_validade_cart_glosa_p timestamp, cd_empresa_p bigint) AS $body$
DECLARE

 
ie_tipo_atendimento_w		smallint;
dt_entrada_w			timestamp;
hr_inicio_w			timestamp;
hr_fim_w			timestamp;
ie_atende_w			varchar(1);
ie_ver_atende_w			varchar(1) := 'S';
ie_exige_senha_atend_w		varchar(1);
ie_exige_plano_w		varchar(1);
ie_exige_carteira_atend_w	varchar(1);
ie_exige_validade_atend_W	varchar(1);
ie_senha_w			varchar(1);
ie_guia_w			varchar(1);
ie_exige_fim_vigencia_w		varchar(1);
cd_setor_atendimento_w		integer;
ie_dia_semana_w			varchar(3);
ie_dia_semana_entrada_w		varchar(3);
ds_erro_w			varchar(255) := '';
qt_reg_w			bigint;
cd_estabelecimento_w		smallint;
ie_exige_origem_w		varchar(1);/* Rafael em 01/03/2007 OS51372 */
IE_EXIGE_GUIA_PRINC_W		varchar(01);
cd_carater_internacao_w		varchar(02);
ie_consiste_guia_atend_w	varchar(01);
ie_exige_compl_usuario_w	varchar(01);
ie_regra_prescr_w		varchar(01);
nm_usuario_w			varchar(30);
ds_erro_ww			varchar(4000) := '';
ie_clinica_w			integer;
qt_consiste_w			bigint;
ie_plano_w			varchar(1);
ie_carteira_w			varchar(1);
ie_validade_w			varchar(1);
ie_compl_usuario_w		varchar(1);
ie_exige_senha_w		varchar(1);
ie_exige_guia_w   		varchar(1);
ie_conv_categ_glosa_w	    varchar(1);
cd_categoria_glosa_w		varchar(10);
cd_convenio_glosa_w		varchar(10);
ie_exige_conv_glosa_w 		varchar(1);
ie_exige_usuario_glosa_w 	varchar(1);
ie_exige_compl_glosa_w  	varchar(1);
ie_exige_validade_glosa_w	varchar(1);
ie_utiliza_conv_glosa_w		varchar(1);
ie_conv_glosa_usuario_w		varchar(1);
nr_seq_classificacao_w		bigint;
cd_procedencia_w		integer;


BEGIN 
 
cd_categoria_glosa_w	:= 	cd_categoria_glosa_p;
cd_convenio_glosa_w	:= 	cd_convenio_glosa_p;
 
if (coalesce(cd_convenio_p,0)	> 0) then 
	begin 
	select	ie_tipo_atendimento, 
		cd_estabelecimento, 
		ie_carater_inter_sus, 
		nm_usuario, 
		ie_clinica, 
		nr_seq_classificacao, 
		cd_procedencia 
	into STRICT	ie_tipo_atendimento_w, 
		cd_estabelecimento_w, 
		cd_carater_internacao_w, 
		nm_usuario_w, 
		ie_clinica_w, 
		nr_seq_classificacao_w, 
		cd_procedencia_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_p;
	exception 
		when others then 
		cd_estabelecimento_w	:= 1;
	end;
 
	select	count(*) 
	into STRICT	qt_consiste_w 
	from	regra_cons_vigencia_cart 
	where	coalesce(cd_convenio,cd_convenio_p) = cd_convenio_p 
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) = ie_tipo_atendimento_w 
	and	cd_estabelecimento 	= cd_estabelecimento_w 
	and	coalesce(ie_consiste,'N') 	= 'S';
 
	ie_regra_prescr_w := OBTER_PARAM_USUARIO(916, 159, Obter_Perfil_Ativo, nm_usuario_w, cd_estabelecimento_w, ie_regra_prescr_w);
	ie_utiliza_conv_glosa_w	:= coalesce(Obter_Valor_Param_Usuario(916, 837, Obter_Perfil_Ativo, nm_usuario_w, cd_estabelecimento_w),'N');
 
	select	Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_SENHA_ATEND') ie_exige_senha_atend, /*regra especial = 'E' regra especial*/ 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_PLANO') ie_exige_plano, 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_CARTEIRA_ATEND') ie_exige_carteira_atend, 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_VALIDADE_ATEND') ie_exige_validade_atend, 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_ORIGEM') ie_exige_origem, 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_GUIA_PRINC') IE_EXIGE_GUIA_PRINC, 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_FIM_VIGENCIA'), 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_CONSISTE_GUIA_ATEND'), 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_COMPL_USUARIO'), 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_CONV_CATEG_GLOSA'), 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_CONV_GLOSA'),   
		Obter_Valor_Conv_Estab(CASE WHEN ie_utiliza_conv_glosa_w='S' THEN  cd_convenio_glosa_w  ELSE cd_convenio END , cd_estabelecimento_w, 'IE_EXIGE_USUARIO_GLOSA'), 
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_COMPL_GLOSA'),  
		Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'IE_EXIGE_VALIDADE_GLOSA')	 
	into STRICT	ie_exige_senha_atend_w, 
		ie_exige_plano_w, 
		ie_exige_carteira_atend_w, 
		ie_exige_validade_atend_W, 
		ie_exige_origem_w, 
		IE_EXIGE_GUIA_PRINC_w, 
		ie_exige_fim_vigencia_w, 
		ie_consiste_guia_atend_w, 
		ie_exige_compl_usuario_w, 
		ie_conv_categ_glosa_w, 
		ie_exige_conv_glosa_w, 
		ie_exige_usuario_glosa_w, 
		ie_exige_compl_glosa_w, 
		ie_exige_validade_glosa_w 
	from	convenio 
	where	cd_convenio	= cd_convenio_p;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'S', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, 
				null,nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p, cd_procedencia_w) 
		into STRICT	ie_exige_senha_w 
		;
	end if;
 
	if (coalesce(cd_senha_p::text, '') = '') and (ie_exige_senha_w = 'S') and (ie_regra_prescr_w <> 'P') then 
		ds_erro_ww	:= WHEB_MENSAGEM_PCK.get_texto(281172) || chr(13) || chr(10);
	end if;
 
 
	if (qt_consiste_w > 0) and (coalesce(dt_final_vigencia_p::text, '') = '') then 
		begin 
		ds_erro_ww	:= WHEB_MENSAGEM_PCK.get_texto(281173);
		end;
	end if;
 
 
	if (coalesce(dt_final_vigencia_p::text, '') = '') and (ie_exige_fim_vigencia_w = 'S') then 
		ds_erro_ww	:= WHEB_MENSAGEM_PCK.get_texto(281173);
	end if;
 
	if (ie_exige_senha_atend_w = 'E') and (ie_exige_guia_princ_w <> 'G') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'G', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, null, 
				nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p, cd_procedencia_w) 
		into STRICT	ie_exige_guia_w 
		;
	end if;
 
	if (coalesce(cd_guia_p::text, '') = '') and 
		((IE_EXIGE_GUIA_PRINC_w	= 'S') or (ie_exige_guia_w = 'S')) and (ie_regra_prescr_w <> 'P') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281174) || chr(13) || chr(10);
	elsif (coalesce(cd_guia_p::text, '') = '') and (IE_EXIGE_GUIA_PRINC_w	= 'G') and (ie_regra_prescr_w <> 'P') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281174) || chr(13) || chr(10);	
	end if;
 
	if (cd_guia_p IS NOT NULL AND cd_guia_p::text <> '') and (ie_consiste_guia_atend_w	in ('S','A')) then 
		select	count(*) 
		into STRICT	qt_reg_w 
		from	atend_categoria_convenio a, 
			atendimento_paciente b 
		where	a.nr_atendimento		<> nr_atendimento_p 
		and	a.cd_convenio		= cd_convenio_p 
		and	a.nr_doc_convenio		= cd_guia_p 
		and   a.nr_atendimento = b.nr_atendimento 
		and	coalesce(b.dt_cancelamento::text, '') = '';
		 
		if (qt_reg_w	> 0) and (ie_consiste_guia_atend_w = 'S') then 
			ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281175) || chr(13) || chr(10);
		elsif (qt_reg_w	> 0) and (ie_consiste_guia_atend_w = 'A') then 
			ds_consistencia_p	:= WHEB_MENSAGEM_PCK.get_texto(281175) || chr(13) || chr(10);	
		end if;
	end if;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'P', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, null, 
				nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p, cd_procedencia_w) 
		into STRICT	ie_exige_plano_w 
		;
	end if;
 
	if (coalesce(cd_plano_p::text, '') = '') and (ie_exige_plano_w = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281176) || chr(13) || chr(10);
	end if;
 
	if (cd_plano_p IS NOT NULL AND cd_plano_p::text <> '') and (ie_exige_plano_w = 'S') then 
		select	count(*) 
		into STRICT qt_reg_w 
		from	convenio_plano 
		where	cd_convenio		= cd_convenio_p 
		and	cd_plano		= cd_plano_p;
		if (qt_reg_w = 0) then 
			ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281177) || chr(13) || chr(10);
		end if;
	end if;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'C', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, 
				null,nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p,cd_procedencia_w) 
		into STRICT	ie_exige_carteira_atend_w 
		;
	end if;
 
	if (coalesce(cd_usuario_convenio_p::text, '') = '') and (ie_exige_carteira_atend_w = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281178) || chr(13) || chr(10);
	end if;
 
	if (ie_exige_senha_atend_w in ('S','E')) then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'V', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, 
				null,nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p, cd_procedencia_w) 
		into STRICT	ie_exige_validade_atend_W 
		;
	end if;
 
	if (coalesce(dt_validade_carteira_p::text, '') = '') and (ie_exige_validade_atend_W = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281179) || chr(13) || chr(10);
	end if;
 
	if (coalesce(nr_seq_origem_p::text, '') = '') and (coalesce(ie_exige_origem_w,'N') = 'S') then 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281180) || chr(13) || chr(10);
	end if;
 
 
	if (coalesce(NR_DOC_CONV_PRINCIPAL_p::text, '') = '') and (coalesce(IE_EXIGE_GUIA_PRINC_w, 'N') = 'S') then 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281181) || chr(13) || chr(10);
	end if;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_w, 1,'U', cd_estabelecimento_w, cd_carater_internacao_w, ie_clinica_w, null, 
				null,nr_seq_classificacao_w,null,cd_categoria_p,cd_plano_p, cd_procedencia_w) 
		into STRICT	ie_exige_compl_usuario_w 
		;
	end if;
 
	if (coalesce(cd_compl_usuario_p::text, '') = '') and (coalesce(ie_exige_compl_usuario_w, 'N') = 'S') then 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281182) || chr(13) || chr(10);
	end if;
 
	if (coalesce(ie_conv_categ_glosa_w,'N') = 'S') and 
		((cd_convenio_glosa_w IS NOT NULL AND cd_convenio_glosa_w::text <> '') and (coalesce(cd_categoria_glosa_w::text, '') = '')) then 
		 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281183) || chr(13) || chr(10);
 
	end if;	
 
	if (coalesce(ie_exige_conv_glosa_w,'N') = 'S') and (coalesce(cd_convenio_glosa_w::text, '') = '') then	 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281184) || chr(13) || chr(10);
	end if;
 
	if (coalesce(ie_exige_usuario_glosa_w,'N') = 'S') and (coalesce(cd_usuario_conv_glosa_p::text, '') = '') then 
		if (ie_utiliza_conv_glosa_w = 'S') then 
			ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281185) || chr(13) || chr(10);
		else 
			ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281186) || chr(13) || chr(10);
		end if;
	end if;
 
	if (coalesce(ie_exige_compl_glosa_w,'N') = 'S') and (coalesce(cd_complemento_glosa_p::text, '') = '') then	 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281187) || chr(13) || chr(10);
	end if;
 
	if (coalesce(ie_exige_validade_glosa_w,'N') = 'S') and (coalesce(dt_validade_cart_glosa_p::text, '') = '') then	 
		ds_erro_ww := ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281188) || chr(13) || chr(10);
	end if;
 
	ds_erro_w := consiste_regra_horario_plano(nr_atendimento_p, cd_convenio_p, cd_plano_p, null, ds_erro_w, cd_empresa_p);
 
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
		ds_erro_ww	:= ds_erro_ww || ds_erro_w;
	end if;
 
end if;
 
ds_erro_p	:= substr(ds_erro_ww, 1, 255);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_categoria_convenio ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_senha_p text, cd_guia_p text, dt_validade_carteira_p timestamp, cd_usuario_convenio_p text, nr_seq_origem_p bigint, NR_DOC_CONV_PRINCIPAL_p text, dt_final_vigencia_p timestamp, cd_compl_usuario_p text, ds_erro_p INOUT text, ds_consistencia_p INOUT text, cd_categoria_p text, cd_convenio_glosa_p text, cd_categoria_glosa_p text, cd_usuario_conv_glosa_p text, cd_complemento_glosa_p text, dt_validade_cart_glosa_p timestamp, cd_empresa_p bigint) FROM PUBLIC;

