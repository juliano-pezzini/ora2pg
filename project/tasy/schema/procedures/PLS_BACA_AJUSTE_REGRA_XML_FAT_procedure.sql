-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_ajuste_regra_xml_fat () AS $body$
DECLARE


cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	x.nr_seq_campo,
		x.nr_sequencia,
		x.nr_seq_pagador,
		x.dt_atualizacao,
		x.nm_usuario,
		x.dt_atualizacao_nrec,
		x.nm_usuario_nrec,
		a.ds_valor
	from	pls_fat_regra_campo	x,
		pls_fat_regra_valor	a
	where	x.nr_sequencia	= a.nr_seq_regra
	and	x.nr_seq_campo not in (3,5);

C02 CURSOR FOR
	SELECT	x.nr_seq_campo,
		x.nr_sequencia,
		x.nr_seq_pagador,
		x.dt_atualizacao,
		x.nm_usuario,
		x.dt_atualizacao_nrec,
		x.nm_usuario_nrec,
		a.ds_valor
	from	pls_fat_regra_campo_mat	x,
		pls_fat_regra_valor_mat	a
	where	x.nr_sequencia	= a.nr_seq_regra
	and	x.nr_seq_campo not in (3,5);
BEGIN
select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	pls_lote_faturamento;

for r_C01_w in C01() loop
	insert into pls_regra_campos_guia_xml(nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_campo,
		ie_origem,
		nr_seq_pagador,
		ds_valor)
	values (nextval('pls_regra_campos_guia_xml_seq'),
		cd_estabelecimento_w,
		r_C01_w.dt_atualizacao,
		r_C01_w.nm_usuario,
		r_C01_w.dt_atualizacao_nrec,
		r_C01_w.nm_usuario_nrec,
		r_C01_w.nr_seq_campo,
		null,
		r_C01_w.nr_seq_pagador,
		r_C01_w.ds_valor);

	delete	FROM pls_fat_regra_valor
	where	nr_seq_regra = r_C01_w.nr_sequencia;

	delete	FROM pls_fat_regra_campo
	where	nr_sequencia = r_C01_w.nr_sequencia;
end loop;

commit;

for r_C02_w in C02() loop
	insert into pls_regra_campos_guia_xml(nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_campo,
		ie_origem,
		nr_seq_pagador,
		ds_valor)
	values (nextval('pls_regra_campos_guia_xml_seq'),
		cd_estabelecimento_w,
		r_C02_w.dt_atualizacao,
		r_C02_w.nm_usuario,
		r_C02_w.dt_atualizacao_nrec,
		r_C02_w.nm_usuario_nrec,
		r_C02_w.nr_seq_campo,
		null,
		r_C02_w.nr_seq_pagador,
		r_C02_w.ds_valor);

	delete	FROM pls_fat_regra_valor_mat
	where	nr_seq_regra = r_C02_w.nr_sequencia;

	delete	FROM pls_fat_regra_campo_mat
	where	nr_sequencia = r_C02_w.nr_sequencia;
end loop;

commit;

-- Nivel de procedimento
update	pls_fat_campo
set	ie_nivel	= 'P'
where	nr_sequencia	in (3);

-- Nivel de procedimento e material
update	pls_fat_campo
set	ie_nivel	= 'PM'
where	nr_sequencia	in (5);

-- Nivel de conta
update	pls_fat_campo
set	ie_nivel	= 'C'
where	nr_sequencia	not in (3,5);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_ajuste_regra_xml_fat () FROM PUBLIC;

