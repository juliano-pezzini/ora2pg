-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_hor_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w				bigint;
hr_prim_hor_prescr_w			varchar(5);
hr_prim_hor_medic_w			varchar(5);
hr_prim_hor_medic_ini_w			varchar(5);
dt_primeiro_horario_w			timestamp;
dt_prescricao_w				timestamp;
cd_intervalo_w				varchar(7);
ie_acm_w				varchar(1);
nr_hora_validade_w			integer;
cd_material_w				integer;
nr_intervalos_w				bigint := 0;
ds_horarios_w				varchar(2000);
ds_horarios2_w				varchar(2000);
nr_atendimento_w			bigint;
nr_horas_validade_w			bigint;
nr_seq_material_w			bigint;
qt_conversao_dose_w			double precision;
qt_dose_w				double precision;
cd_classif_setor_w			varchar(2);
dt_inicio_prescr_w			timestamp;
ie_via_aplicacao_w			varchar(5);
ie_se_necessario_w			varchar(5);
qt_unitaria_w				double precision;
qt_material_w				double precision;
qt_dose_especial_w			double precision;
nr_ocorrencia_w				bigint;
cd_estabelecimento_w			bigint;
cd_setor_atendimento_w			bigint;
ds_dose_diferenciada_w			varchar(50);
ie_origem_inf_w				varchar(1);
cd_unidade_medida_dose_w		varchar(30);
qt_dispensar_w				double precision;
ds_erro_w				varchar(255);
ie_regra_disp_w				varchar(1);
qt_hora_intervalo_w			smallint;
qt_min_intervalo_w			integer;
qt_dia_prim_hor_w			smallint;
ie_recalc_sem_prim_hor_w		varchar(1);
ie_mesmo_zerado_w			varchar(1);
ie_recalc_hor_w				varchar(1);
ie_limpar_w				varchar(1);
ie_acm_sn_w				varchar(1) := '';

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.cd_intervalo, 
	a.ie_acm, 
	coalesce(a.hr_prim_horario,to_char(b.dt_primeiro_horario,'hh24:mi')), 
	coalesce(a.hr_prim_horario,to_char(b.dt_primeiro_horario,'hh24:mi')), 
	a.cd_material, 
	a.ds_horarios, 
	coalesce(a.qt_unitaria,0), 
	coalesce(a.qt_material,0), 
	coalesce(a.qt_dose_especial,0), 
	a.ds_dose_diferenciada, 
	coalesce(a.ie_origem_inf,'1'), 
	a.ie_via_aplicacao, 
	a.cd_unidade_medida_dose, 
	a.qt_hora_intervalo, 
	a.qt_min_intervalo, 
	a.ie_se_necessario, 
	a.qt_dia_prim_hor, 
	a.nr_ocorrencia 
from	prescr_material a, 
	prescr_medica b 
where	a.nr_prescricao = b.nr_prescricao 
and	a.nr_prescricao	= nr_prescricao_p 
and	a.ie_agrupador	in (1,2) 
and	coalesce(a.ie_sem_aprazamento,'N')	= 'N';

c02 CURSOR FOR 
SELECT	cd_intervalo, 
	nr_sequencia 
from	prescr_gasoterapia a 
where	a.nr_prescricao	= nr_prescricao_p 
and	(cd_intervalo IS NOT NULL AND cd_intervalo::text <> '');

c03 CURSOR FOR 
SELECT	nr_sequencia, 
	cd_material, 
	ie_via_aplicacao, 
	coalesce(a.qt_unitaria,0), 
	coalesce(a.qt_material,0), 
	qt_dose_especial, 
	ds_dose_diferenciada, 
	ie_origem_inf, 
	cd_unidade_medida_dose, 
	coalesce(ie_se_necessario,'N'), 
	coalesce(ie_acm,'N'), 
	qt_conversao_dose, 
	qt_dose 
from	prescr_material a 
where	nr_prescricao	= nr_prescricao_p 
and	ie_agrupador	= 15 
and	nr_seq_gasoterapia = nr_sequencia_w;


BEGIN 
ie_recalc_hor_w := Obter_Param_Usuario(924, 79, Wheb_Usuario_pck.Get_cd_perfil, nm_usuario_p, Wheb_Usuario_pck.Get_cd_estabelecimento, ie_recalc_hor_w);
ie_recalc_sem_prim_hor_w := Obter_Param_Usuario(924, 780, Wheb_Usuario_pck.Get_cd_perfil, nm_usuario_p, Wheb_Usuario_pck.Get_cd_estabelecimento, ie_recalc_sem_prim_hor_w);
 
select	to_char(dt_primeiro_horario,'hh24:mi'), 
	dt_primeiro_horario, 
	nr_horas_validade, 
	nr_atendimento, 
	dt_prescricao, 
	cd_setor_atendimento, 
	cd_estabelecimento, 
	dt_inicio_prescr, 
	nr_horas_validade 
into STRICT	hr_prim_hor_prescr_w, 
	dt_primeiro_horario_w, 
	nr_hora_validade_w, 
	nr_atendimento_w, 
	dt_prescricao_w, 
	cd_setor_atendimento_w, 
	cd_estabelecimento_w, 
	dt_inicio_prescr_w, 
	nr_horas_validade_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then 
	select	max(cd_classif_setor) 
	into STRICT	cd_classif_setor_w 
	from	setor_atendimento 
	where	cd_setor_atendimento = (SELECT Obter_Unidade_Atendimento(nr_atendimento_w,'A','CS') );
end if;
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	cd_intervalo_w, 
	ie_acm_w, 
	hr_prim_hor_medic_w, 
	hr_prim_hor_medic_ini_w, 
	cd_material_w, 
	ds_horarios_w, 
	qt_unitaria_w, 
	qt_material_w, 
	qt_dose_especial_w, 
	ds_dose_diferenciada_w, 
	ie_origem_inf_w, 
	ie_via_aplicacao_w, 
	cd_unidade_medida_dose_w, 
	qt_hora_intervalo_w, 
	qt_min_intervalo_w, 
	ie_se_necessario_w, 
	qt_dia_prim_hor_w, 
	nr_intervalos_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	if (hr_prim_hor_prescr_w	<> hr_prim_hor_medic_w) and (ie_recalc_hor_w	= 'S') then 
		hr_prim_hor_medic_w	:= obter_primeiro_horario(cd_intervalo_w, nr_prescricao_p, cd_material_w,ie_via_aplicacao_w);
		if (cd_classif_setor_w	= '1') then 
			hr_prim_hor_medic_w	:= hr_prim_hor_prescr_w;
		end if;
	end if;
 
	if (substr(hr_prim_hor_medic_w,1,2) = '24') then 
		hr_prim_hor_medic_w	:= '00'||substr(hr_prim_hor_medic_w,3,3);
	end if;
 
	if (qt_dia_prim_hor_w = 1) and (hr_prim_hor_medic_w >= hr_prim_hor_prescr_w ) then 
		qt_dia_prim_hor_w := 0;
	end if;
 
	if (hr_prim_hor_medic_ini_w IS NOT NULL AND hr_prim_hor_medic_ini_w::text <> '') then 
		if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then 
			nr_intervalos_w := obter_nr_intervalos_dose_dif(ds_dose_diferenciada_w);
		end if;
		 
		nr_intervalos_w	:= null;
		SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), to_date( hr_prim_hor_medic_w,'hh24:mi'), nr_hora_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalos_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_intervalos_w, ds_horarios_w, ds_horarios2_w;
		ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
 
		if (ie_se_necessario_w = 'S') then 
			select	coalesce(max(b.qt_se_necessario),0), 
				coalesce(max(b.ie_mesmo_zerado),'N') 
			into STRICT	nr_intervalos_w, 
				ie_mesmo_zerado_w 
			from	intervalo_prescricao a, 
				intervalo_setor b 
			where	a.cd_intervalo 		= b.cd_intervalo 
			and	coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
			and	coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w 
			and	a.cd_intervalo 		= cd_intervalo_w 
			and	((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = '')) 
			and	((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = '')) 
			and	((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
 
 
			if (coalesce(nr_intervalos_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then 
				select	coalesce(max(qt_se_necessario),1) 
				into STRICT	nr_intervalos_w 
				from	intervalo_prescricao 
				where	cd_intervalo	= cd_intervalo_w;
			end if;
		end if;
 
		SELECT * FROM Obter_Quant_Dispensar(1, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_intervalos_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
		if (ie_acm_w = 'S') then 
			ds_horarios_w	:= 'ACM';
		elsif (ie_se_necessario_w = 'S') then 
			ds_horarios_w	:= 'SN';
		end if;
		 
		if (coalesce(obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_w),'N') = 'S') then 
			hr_prim_hor_medic_w := null;
		end if;
		 
		if (ie_acm_w = 'S' or ie_se_necessario_w = 'S') then 
			ie_acm_sn_w := 'S';
		end if;
		 
		update	prescr_material 
		set	hr_prim_horario		= CASE WHEN ie_acm_sn_w='S' THEN  null  ELSE CASE WHEN ie_recalc_sem_prim_hor_w='S' THEN  null  ELSE hr_prim_hor_medic_w END  END , 
			ds_horarios		= ds_horarios_w, 
			nr_ocorrencia		= nr_intervalos_w, 
			qt_total_dispensar	= qt_dispensar_w, 
			qt_material		= coalesce(qt_material_w,1), 
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
			qt_dia_prim_hor 	= qt_dia_prim_hor_w 
		where	nr_prescricao		= nr_prescricao_p 
		and	nr_sequencia		= nr_sequencia_w;
		 
		nr_intervalos_w	:= 0;
	else 
		SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), to_date(hr_prim_hor_prescr_w,'hh24:mi'), nr_hora_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalos_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_intervalos_w, ds_horarios_w, ds_horarios2_w;
 
		ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
 
 
		if (ie_se_necessario_w = 'S') then 
			select	coalesce(max(b.qt_se_necessario),0), 
				coalesce(max(b.ie_mesmo_zerado),'N') 
			into STRICT	nr_intervalos_w, 
				ie_mesmo_zerado_w 
			from	intervalo_prescricao a, 
				intervalo_setor b 
			where	a.cd_intervalo 		= b.cd_intervalo 
			and	coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
			and	coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w 
			and	a.cd_intervalo 		= cd_intervalo_w 
			and	((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = '')) 
			and	((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = '')) 
			and	((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
 
 
			if (coalesce(nr_intervalos_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then 
				select	coalesce(max(qt_se_necessario),1) 
				into STRICT	nr_intervalos_w 
				from	intervalo_prescricao 
				where	cd_intervalo	= cd_intervalo_w;
			end if;
		end if;
 
		SELECT * FROM Obter_Quant_Dispensar(1, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_intervalos_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
		if (ie_acm_w = 'S') then 
			ds_horarios_w	:= 'ACM';
		elsif (ie_se_necessario_w = 'S') then 
			ds_horarios_w	:= 'SN';
		end if;
 
		update	prescr_material 
		set	nr_ocorrencia		= nr_intervalos_w, 
			qt_total_dispensar	= qt_dispensar_w, 
			qt_material		= qt_material_w	, 
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
			qt_dia_prim_hor 	= qt_dia_prim_hor_w 
		where	nr_prescricao		= nr_prescricao_p 
		and	nr_sequencia		= nr_sequencia_w;
		 
		nr_intervalos_w	:= 0;
	end if;
	 
	CALL Ajustar_Prescr_Material(nr_prescricao_p, nr_sequencia_w);
	ds_erro_w := consistir_prescr_material(nr_prescricao_p, nr_sequencia_w, nm_usuario_p, Obter_Perfil_Ativo, ds_erro_w);
 
	end;
end loop;
close c01;
 
commit;
 
open C02;
loop 
fetch C02 into	 
	cd_intervalo_w, 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_inicio_prescr_w, nr_horas_validade_w, 0, 0, 0, nr_intervalos_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_intervalos_w, ds_horarios_w, ds_horarios2_w;
	 
	update	prescr_gasoterapia 
	set	dt_prev_execucao	= dt_inicio_prescr_w, 
		ds_horarios		= ds_horarios_w 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_sequencia		= nr_sequencia_w;
	 
	commit;
	 
	open C03;
	loop 
	fetch C03 into	 
		nr_seq_material_w, 
		cd_material_w, 
		ie_via_aplicacao_w, 
		qt_unitaria_w, 
		qt_material_w, 
		qt_dose_especial_w, 
		ds_dose_diferenciada_w, 
		ie_origem_inf_w, 
		cd_unidade_medida_dose_w, 
		ie_se_necessario_w, 
		ie_acm_w, 
		qt_conversao_dose_w, 
		qt_dose_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		 
		nr_intervalos_w	:= coalesce(obter_ocorrencias_horarios_rep(ds_horarios_w),0);
		qt_material_w	:= qt_dose_w / qt_conversao_dose_w;
		 
		SELECT * FROM Obter_Quant_Dispensar(1, cd_material_w, nr_prescricao_p, nr_seq_material_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_intervalos_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
		update		prescr_material 
		set		ds_horarios		= ds_horarios_w, 
				nr_ocorrencia		= nr_intervalos_w, 
				qt_total_dispensar	= qt_dispensar_w, 
				qt_material		= qt_material_w, 
				ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END  
		where		nr_prescricao		= nr_prescricao_p 
		and		nr_sequencia		= nr_seq_material_w 
		and		coalesce(ie_acm,'N')		= 'N' 
		and		coalesce(ie_se_necessario,'N') = 'N';
		commit;
		 
	end loop;
	close C03;
	 
end loop;
close C02;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_hor_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

