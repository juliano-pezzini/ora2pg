-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_hemoterapia ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p text, nr_seq_item_gerado_p INOUT text, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w				log_cpoe.ds_stack%type;
ds_log_cpoe_w			log_cpoe.ds_log%type;
nr_seq_banco_sangue_w			prot_solic_bco_sangue.nr_sequencia%type;
ie_tipo_w				prot_solic_bco_sangue.ie_tipo%type;
ie_tipo_paciente_w			prot_solic_bco_sangue.ie_tipo_paciente%type;
ie_porte_cirurgico_w			prot_solic_bco_sangue.ie_porte_cirurgico%type;

nr_seq_derivado_w			protocolo_medic_proc.nr_seq_derivado%type;
qt_procedimento_w			protocolo_medic_proc.qt_procedimento%type;
qt_vol_hemocomp_w			protocolo_medic_proc.qt_vol_hemocomp%type;
cd_intervalo_w				protocolo_medic_proc.cd_intervalo%type;
qt_veloc_inf_hemo_w			protocolo_medic_proc.qt_veloc_inf_hemo%type;
ie_util_hemocomponente_w	protocolo_medic_proc.ie_util_hemocomponente%type;
ds_observacao_w				protocolo_medic_proc.ds_observacao%type;
cd_intervalo_agora_w		protocolo_medic_proc.cd_intervalo%type;

nr_seq_indicacao_w			protocolo_solic_indicacao.nr_seq_indicacao%type;

nr_seq_hemoterapia_w		cpoe_hemoterapia.nr_sequencia%type;
qt_aborto_w					cpoe_hemoterapia.qt_aborto%type;
qt_gravidez_w				cpoe_hemoterapia.qt_gravidez%type;
ie_gravidez_w				cpoe_hemoterapia.ie_gravidez%type;
nr_seq_derivado_reac_w		cpoe_hemoterapia.nr_seq_derivado_reac%type;
nr_seq_reacao_w				cpoe_hemoterapia.nr_seq_reacao%type;
dt_ultima_transf_w			cpoe_hemoterapia.dt_ultima_transf%type;
ie_trans_anterior_w			cpoe_hemoterapia.ie_trans_anterior%type;
cd_doenca_cid_w				cpoe_hemoterapia.cd_doenca_cid%type;
ds_sintoma_w				cpoe_hemoterapia.ds_sintoma%type;
dt_programada_w				cpoe_hemoterapia.dt_programada%type;
dt_fim_w					cpoe_hemoterapia.dt_fim%type;
ie_reserva_w				cpoe_hemoterapia.ie_reserva%type;
ie_tipo_paciente_cpoe_w		cpoe_hemoterapia.ie_tipo_paciente%type;
ie_urgencia_w				cpoe_hemoterapia.ie_urgencia%type;
ds_horarios_w				cpoe_hemoterapia.ds_horarios%type;
ds_horarios_aux_w			cpoe_hemoterapia.ds_horarios%type;
hr_prim_horario_w			cpoe_procedimento.hr_prim_horario%type;

nr_ocorrencia_w				prescr_procedimento.nr_ocorrencia%type;

qt_min_intervalo_w			intervalo_prescricao.qt_min_intervalo%type;

cd_estabelecimento_w			atendimento_paciente.cd_estabelecimento%type;

nr_seq_item_gerado_w 	varchar(4000);
sql_w					varchar(4000);
ds_parametros_w				varchar(2000);
ds_sep_bv_w				varchar(10);
qt_indicacao_w				bigint;
ie_prescr_alta_agora_w			varchar(1);

qt_mat_hem_w				bigint;

cd_mat_hem1_w				cpoe_hemoterapia.cd_mat_hem1%type;
ie_via_mat_hem1_w			cpoe_hemoterapia.ie_via_mat_hem1%type;		
qt_dose_hem1_w				cpoe_hemoterapia.qt_dose_hem1%type;		
cd_unid_medida_dose_hem1_w		cpoe_hemoterapia.cd_unid_medida_dose_hem1%type;
cd_interv_hem1_w			cpoe_hemoterapia.cd_interv_hem1%type;
ie_urgencia_mat_hem1_w			cpoe_hemoterapia.ie_urgencia_mat_hem1%type;
ds_hor_hem1_w				cpoe_hemoterapia.ds_hor_hem1%type;

nr_sequencia_proc_w			protocolo_medic_proc.nr_seq_proc%type;
ie_coombs_direto_w			prot_solic_bco_sangue.ie_coombs_direto%type;
ds_coagulopatia_w			prot_solic_bco_sangue.ds_coagulopatia%type;
ie_aliquotado_w				protocolo_medic_proc.ie_aliquotado%type;
ie_filtrado_w				protocolo_medic_proc.ie_filtrado%type;
ie_lavado_w				protocolo_medic_proc.ie_lavado%type;
ie_irradiado_w				protocolo_medic_proc.ie_irradiado%type;
cd_interv_hem_w				protocolo_medic_material.cd_intervalo%type;

c01 CURSOR FOR							
	SELECT	a.nr_sequencia,
		a.ie_tipo,
		a.ie_tipo_paciente,
		a.ie_porte_cirurgico,
		a.ie_reserva,
		a.ie_coombs_direto,
		a.ds_coagulopatia
	from	prot_solic_bco_sangue a
	where	a.cd_protocolo = cd_protocolo_p
	and	a.nr_seq_protocolo = nr_seq_protocolo_p
	and	a.nr_sequencia = coalesce(nr_seq_item_p, a.nr_sequencia);
	
c02 CURSOR FOR
	SELECT	a.nr_seq_derivado,
		a.qt_procedimento,
		a.qt_vol_hemocomp,
		a.cd_intervalo,
		a.qt_veloc_inf_hemo, /*  unidade padrao gotas/min */
		a.ie_util_hemocomponente,
		a.ds_observacao,
		a.nr_seq_proc,
		a.ie_aliquotado,
		a.ie_filtrado,
		a.ie_lavado,
		a.ie_irradiado
	from	protocolo_medic_proc a,
		san_derivado b
	where	a.nr_seq_derivado = b.nr_sequencia
	and	a.cd_protocolo = cd_protocolo_p
	and	a.nr_sequencia = nr_seq_protocolo_p
	and	a.nr_seq_solic_bs = nr_seq_banco_sangue_w
	and	coalesce(b.ie_mostra_prescricao,'S') = 'S'
	and	coalesce(b.ie_situacao,'A') = 'A'
	order by 
		a.nr_seq_proc;

c03 CURSOR FOR
	SELECT	a.nr_seq_indicacao
	from	protocolo_solic_indicacao a,
		san_indicacao b
	where	a.nr_seq_indicacao = b.nr_sequencia
	and	a.nr_seq_solic_bs = nr_seq_banco_sangue_w
	and	b.ie_situacao = 'A'
	order by
		a.nr_sequencia;
			
c04 CURSOR FOR
	SELECT	cd_material,
		ie_via_aplicacao,
		qt_dose,
		cd_unidade_medida,
		cd_intervalo,
		ie_urgencia,
		ds_horarios
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_seq_proc	= nr_sequencia_proc_w
	and	ie_agrupador	= 13;
		

BEGIN
cd_estabelecimento_w	:= obter_estab_atendimento(nr_atendimento_p);
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_prescr_alta_agora_w);

select	max(qt_aborto),
	max(qt_gravidez),
	max(ie_gravidez),
	max(nr_seq_derivado_reac),
	max(nr_seq_reacao),
	max(ds_sintoma)
into STRICT qt_aborto_w,
	qt_gravidez_w,
	ie_gravidez_w,
	nr_seq_derivado_reac_w,
	nr_seq_reacao_w,
	ds_sintoma_w
from	cpoe_hemoterapia
where	nr_sequencia	=	(SELECT	max(nr_sequencia)
				from	cpoe_hemoterapia
				where	((nr_atendimento  = nr_atendimento_p) or (cd_pessoa_fisica = cd_paciente_p and coalesce(nr_atendimento::text, '') = '')));

cd_doenca_cid_w 	:= obter_cod_diagnostico_atend( nr_atendimento_p);
dt_ultima_transf_w	:= obter_data_ult_transf( nr_atendimento_p, cd_paciente_p);
ie_trans_anterior_w	:= 'N';
ds_sep_bv_w		:= obter_separador_bv;

if (obter_qt_tansfusao_hosp(cd_paciente_p) > 0) then
	ie_trans_anterior_w	:= 'S';
end if;

open c01;
loop
fetch c01 into
	nr_seq_banco_sangue_w,
	ie_tipo_w,
	ie_tipo_paciente_w,
	ie_porte_cirurgico_w,
	ie_reserva_w,
	ie_coombs_direto_w,
	ds_coagulopatia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	open c02;
	loop
	fetch c02 into
		nr_seq_derivado_w,
		qt_procedimento_w,
		qt_vol_hemocomp_w,
		cd_intervalo_w,
		qt_veloc_inf_hemo_w,
		ie_util_hemocomponente_w,
		ds_observacao_w,
		nr_sequencia_proc_w,
		ie_aliquotado_w,
		ie_filtrado_w,
		ie_lavado_w,
		ie_irradiado_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
			cd_intervalo_agora_w	:= cpoe_busca_intervalo_agora(nr_atendimento_p,'B',cd_estabelecimento_w,cd_perfil_p, nm_usuario_p);
			
			if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
				cd_intervalo_w	:= cd_intervalo_agora_w;
				ie_urgencia_w	:= 'S';
			end if;
		end if;			
		
		ie_tipo_paciente_cpoe_w	:= 'C';
		
		if (ie_tipo_paciente_w = 'CI') then
			ie_tipo_paciente_cpoe_w	:= 'I';
		end if;

		if (ie_util_hemocomponente_w = 'R') then
			ie_reserva_w	:= 'S';
		end if;

		if (ie_trans_anterior_w = 'N') then
			dt_ultima_transf_w	:= null;
		end if;
		
		if (dt_inicio_presc_p IS NOT NULL AND dt_inicio_presc_p::text <> '') then
			dt_programada_w := dt_inicio_presc_p;
			dt_fim_w := dt_fim_presc_p;
		else
			dt_programada_w	:= trunc(clock_timestamp(),'hh24');
			dt_fim_w	:= dt_programada_w + 1;
		end if;

		
		if	((ie_tipo_w = 4) and (coalesce(dt_inicio_presc_p::text, '') = '')) then
			dt_programada_w := (trunc(clock_timestamp(),'mi') + (1/1440));
			dt_fim_w := (dt_programada_w + (1/1440));
		elsif (coalesce(dt_inicio_presc_p::text, '') = '') then
			
			if (cpoe_obter_hor_setor_ps(nm_usuario_p, cd_estabelecimento_w, nr_atendimento_p, cd_perfil_p, cd_intervalo_w) = 'S') then
			
				dt_programada_w := clock_timestamp();
				ie_urgencia_w := 'S';
				hr_prim_horario_w := to_char(dt_programada_w,'hh24:mi');
			else
				
				hr_prim_horario_w  := substr(cpoe_obter_primeiro_horario(nr_atendimento_p, cd_intervalo_w, null, cd_estabelecimento_w, cd_perfil_p, nm_usuario_p, cd_paciente_p),1,5);
			
				if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
					dt_programada_w	:= trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_programada_w, hr_prim_horario_w),'mi');				
				end if;
				
				if (dt_programada_w < clock_timestamp()) then
					dt_programada_w := dt_programada_w + 1;
				end if;
			end if;
		end if;
		
		if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then					
			select	max(qt_min_intervalo)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;

			SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_w, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;					

			ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;				

			hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);

			dt_programada_w	:= trunc(ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(hr_prim_horario_w), 'mi');								

			if (dt_programada_w < clock_timestamp()) then
				dt_programada_w	:= dt_programada_w + 1;
			end if;
		end if;
		
		if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
			dt_programada_w := dt_inicio_p;
			dt_fim_w	:= (dt_programada_w + 1) - 1/1440;
			ie_urgencia_w	:= null;
			ie_tipo_w := 1;
			
			select	max(qt_min_intervalo)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;

			SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_programada_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_w, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;					

			ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		end if;
		
		select	nextval('cpoe_hemoterapia_seq')
		into STRICT	nr_seq_hemoterapia_w
		;
		
		insert into cpoe_hemoterapia(	nr_sequencia,
				nr_atendimento,
				cd_pessoa_fisica,
				cd_doenca_cid,
				ie_tipo_paciente,
				ie_porte_cirurgico,
				ie_tipo,
				ds_horarios,
				ie_tipo_hemoterap,
				nr_seq_derivado,
				qt_procedimento,
				qt_vol_hemocomp,
				qt_veloc_inf_hemo,
				ie_unid_med_hemo,
				ie_reserva,
				ds_observacao,
				dt_ultima_transf,
				ie_trans_anterior,
				qt_aborto,
				qt_gravidez,
				ie_gravidez,
				nr_seq_derivado_reac,
		                nr_seq_reacao,
		                ds_sintoma,
				cd_intervalo,
				dt_inicio,
				dt_programada,
				dt_fim,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				cd_funcao_origem,
				cd_perfil_ativo,
				ie_urgencia,
				nr_seq_pend_pac_acao,
				nr_seq_transcricao,
				ie_item_alta,
				ie_prescritor_aux,
				cd_medico,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				nr_seq_conclusao_apae,
				cd_protocolo,
				nr_seq_protocolo,
				ie_retrogrado,
				ie_futuro,
				ie_forma_geracao,
				ie_coombs_direto,
				ds_coagulopatia,
				ie_aliquotado,
				ie_filtrado,
				ie_lavado,
				ie_irradiado,
				ie_fenotipado,
				IE_ADM_MAT_HEM1,
				nr_seq_cpoe_order_unit)
		values (	nr_seq_hemoterapia_w,
				nr_atendimento_p,
				cd_paciente_p,
				cd_doenca_cid_w,
				ie_tipo_paciente_cpoe_w,
				ie_porte_cirurgico_w,
				ie_tipo_w,
				ds_horarios_w,
				0,
				nr_seq_derivado_w,
				qt_procedimento_w,
				qt_vol_hemocomp_w,
				qt_veloc_inf_hemo_w,
				'gpm',
				ie_reserva_w,
				ds_observacao_w,
				dt_ultima_transf_w,
				ie_trans_anterior_w,
				qt_aborto_w,
				qt_gravidez_w,
				ie_gravidez_w,
				nr_seq_derivado_reac_w,
				nr_seq_reacao_w,
				ds_sintoma_w,
				cd_intervalo_w,
				dt_programada_w,
				dt_programada_w,
				dt_fim_w,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				2314,
				cd_perfil_p,
				ie_urgencia_w,
				nr_seq_pend_pac_acao_p,
				nr_seq_transcricao_p,
				ie_item_alta_p,
				ie_prescritor_aux_p,
				cd_medico_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				nr_seq_conclusao_apae_p,
				cd_protocolo_p,
				nr_seq_protocolo_p,
				ie_retrogrado_p,
				ie_futuro_p,
				'P',
				ie_coombs_direto_w,
				ds_coagulopatia_w,
				ie_aliquotado_w,
				ie_filtrado_w,
				ie_lavado_w,
				ie_irradiado_w,
				'N',
				'P',
				nr_seq_cpoe_order_unit_p);						
			
		qt_indicacao_w	:= 0;
			
		open c03;
		loop
		fetch c03 into
			nr_seq_indicacao_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			qt_indicacao_w	:= qt_indicacao_w + 1;
			
			ds_parametros_w	:= 	'nr_seq_indicacao='	|| nr_seq_indicacao_w		|| ds_sep_bv_w ||
						'nr_sequencia='		|| nr_seq_hemoterapia_w		|| ds_sep_bv_w;
						
			sql_w	:=	'update	cpoe_hemoterapia '	||
					'set	nr_seq_indicacao' 	|| qt_indicacao_w	|| '	= :nr_seq_indicacao ' ||
					'where	nr_sequencia = :nr_sequencia';
					
			CALL exec_sql_dinamico_bv('TASY', sql_w, ds_parametros_w);
			
			if (qt_indicacao_w = 2) then
				exit;
			end if;	
			end;
		end loop;
		close c03;

		ds_parametros_w	:= '';
		sql_w		:= '';		
		qt_mat_hem_w	:= 0;

		open c04;
		loop
		fetch c04 into
			cd_mat_hem1_w,
			ie_via_mat_hem1_w,
			qt_dose_hem1_w,
			cd_unid_medida_dose_hem1_w,
			cd_interv_hem1_w,
			ie_urgencia_mat_hem1_w,
			ds_hor_hem1_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			qt_mat_hem_w	:= qt_mat_hem_w + 1;

			ds_parametros_w	:= 	'cd_mat_hem='  			|| cd_mat_hem1_w       		|| ds_sep_bv_w ||
						'ie_via_mat_hem=' 		|| ie_via_mat_hem1_w   		|| ds_sep_bv_w ||
						'qt_dose_hem='			|| qt_dose_hem1_w	   	|| ds_sep_bv_w ||
						'cd_unid_medida_dose_hem='	|| cd_unid_medida_dose_hem1_w   || ds_sep_bv_w ||
						'cd_interv_hem='		|| cd_interv_hem1_w		|| ds_sep_bv_w ||
						'ie_urgencia_mat_hem='		|| ie_urgencia_mat_hem1_w	|| ds_sep_bv_w ||
						'ds_hor_hem=' 			|| ds_hor_hem1_w		|| ds_sep_bv_w ||									
						'nr_sequencia='			|| nr_seq_hemoterapia_w		|| ds_sep_bv_w;

			sql_w	:=	'update cpoe_hemoterapia ' 		||
					'set	cd_mat_hem' 			|| qt_mat_hem_w || ' = :cd_mat_hem, ' 			||
					'	ie_via_mat_hem' 		|| qt_mat_hem_w || ' = :ie_via_mat_hem, ' 		||
					'	qt_dose_hem' 			|| qt_mat_hem_w || ' = :qt_dose_hem, ' 			||
					'	cd_unid_medida_dose_hem'	|| qt_mat_hem_w || ' = :cd_unid_medida_dose_hem, '	||
					'	cd_interv_hem' 			|| qt_mat_hem_w || ' = :cd_interv_hem, ' 		||
					'	ie_urgencia_mat_hem' 		|| qt_mat_hem_w || ' = :ie_urgencia_mat_hem, ' 		||
					'	ds_hor_hem' 			|| qt_mat_hem_w || ' = :ds_hor_hem ' 			||
					'where	nr_sequencia = :nr_sequencia';

			CALL exec_sql_dinamico_bv('TASY', sql_w, ds_parametros_w);
			
			if (qt_mat_hem_w = 5) then
				exit;
			end if;				
			end;
		end loop;
		close c04;
		nr_seq_item_gerado_w := nr_seq_item_gerado_w || nr_seq_hemoterapia_w || ';';
		end;
	end loop;
	close c02;	
	end;
	
	CALL cpoe_gerar_plano_protocolo(nr_atendimento_p, dt_fim_presc_p, nr_seq_hemoterapia_w, nm_usuario_p, 'H');

    CALL cpoe_utils_pck.set_list_itens(nr_seq_hemoterapia_w, 'H');
end loop;
close c01;

commit;
if (obter_funcao_ativa = 281) then
	nr_seq_item_gerado_p := nr_seq_hemoterapia_w;
else
	nr_seq_item_gerado_p := nr_seq_item_gerado_w;
end if;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_PROT_HEMOTERAPIA '
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
		|| chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
		|| chr(13) || ' - nr_seq_item_p: ' || nr_seq_item_p
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - nr_seq_pend_pac_acao_p: ' || nr_seq_pend_pac_acao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - dt_fim_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_presc_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)
		|| chr(13) || ' - dt_inicio_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_presc_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.GETTIMEZONE)
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_hemoterapia ( cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p text, nr_seq_item_gerado_p INOUT text, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

