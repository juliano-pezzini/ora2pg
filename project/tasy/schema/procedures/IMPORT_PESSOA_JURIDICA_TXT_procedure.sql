-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_pessoa_juridica_txt ( cd_cnpj_p text, ds_razao_social_p text, nm_fantasia_p text, cd_cep_p text, ds_endereco_p text, ds_bairro_p text, ds_municipio_p text, sg_estado_p text, nm_usuario_p text, ds_complemento_p text, nr_telefone_p text, nr_endereco_p text, nr_fax_p text, ds_email_p text, nm_pessoa_contato_p text, nr_ramal_contato_p text, nr_inscricao_estadual_p text, cd_tipo_pessoa_p text, cd_conta_contabil_p text, ds_site_internet_p text, cd_cond_pagto_p text, ds_nome_abrev_p text, ie_situacao_p text, cd_sistema_ant_p text, ds_observacao_p text) AS $body$
DECLARE

				
nr_seq_pj_estab_w	bigint;
cd_cnpj_w		varchar(14);
cd_estabelecimento_w	smallint := wheb_usuario_pck.get_cd_estabelecimento;


BEGIN
cd_cnpj_w := substr(elimina_caracteres_especiais(cd_cnpj_p),1,14);


if (coalesce(cd_cnpj_w,'X') <> 'X') then
	begin
	
	begin
	insert into pessoa_juridica(
		cd_cgc,
		ds_razao_social,
		nm_fantasia,
		cd_cep,
		ds_endereco,
		ds_bairro,
		ds_municipio,
		sg_estado,
		dt_atualizacao,
		nm_usuario,
		ds_complemento,
		nr_telefone,
		nr_endereco,
		nr_fax,
		ds_email,
		nm_pessoa_contato,
		nr_ramal_contato,
		nr_inscricao_estadual,
		cd_tipo_pessoa,
		cd_conta_contabil,
		ie_prod_fabric,
		ds_site_internet,
		cd_cond_pagto,
		ds_nome_abrev,
		ie_situacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_sistema_ant,
		ie_transporte,
		ds_observacao,
		ie_fornecedor_opme,
		dt_integracao,
		ie_empreendedor_individual)
	values (	cd_cnpj_w,
		substr(ds_razao_social_p,1,255),
		substr(coalesce(nm_fantasia_p,ds_razao_social_p),1,80),
		substr(cd_cep_p,1,15),
		substr(ds_endereco_p,1,40),
		substr(ds_bairro_p,1,40),
		substr(ds_municipio_p,1,40),
		substr(sg_estado_p,1,15),
		clock_timestamp(),
		nm_usuario_p,
		substr(ds_complemento_p,1,255),
		substr(nr_telefone_p,1,15),
		substr(nr_endereco_p,1,10),
		substr(nr_fax_p,1,15),
		substr(ds_email_p,1,60),
		substr(nm_pessoa_contato_p,1,255),
		substr(nr_ramal_contato_p,1,5),
		substr(nr_inscricao_estadual_p,1,220),
		substr(cd_tipo_pessoa_p,1,3),
		substr(cd_conta_contabil_p,1,20),
		'N',
		substr(ds_site_internet_p,1,255),
		substr(cd_cond_pagto_p,1,10),
		substr(ds_nome_abrev_p,1,18),
		coalesce(substr(ie_situacao_p,1,1),'A'),
		clock_timestamp(),
		nm_usuario_p,
		substr(cd_sistema_ant_p,1,20),
		'N',
		substr(ds_observacao_p,1,4000),
		'N',
		clock_timestamp(),
		'N');
	exception
	when unique_violation then
		update	pessoa_juridica
		set	ds_razao_social		= substr(ds_razao_social_p,1,255),
			nm_fantasia		= substr(coalesce(nm_fantasia_p,ds_razao_social_p),1,80),
			cd_cep			= substr(cd_cep_p,1,15),
			ds_endereco		= substr(ds_endereco_p,1,40),
			ds_bairro			= substr(ds_bairro_p,1,40),
			ds_municipio		= substr(ds_municipio_p,1,40),
			sg_estado		= substr(sg_estado_p,1,15),
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ds_complemento		= substr(ds_complemento_p,1,255),
			nr_telefone		= substr(nr_telefone_p,1,15),
			nr_endereco		= substr(nr_endereco_p,1,10),
			nr_fax			= substr(nr_fax_p,1,15),
			ds_email			= substr(ds_email_p,1,60),
			nm_pessoa_contato	= substr(nm_pessoa_contato_p,1,255),
			nr_ramal_contato		= substr(nr_ramal_contato_p,1,5),
			nr_inscricao_estadual	= substr(nr_inscricao_estadual_p,1,220),
			cd_tipo_pessoa		= substr(cd_tipo_pessoa_p,1,3),
			cd_conta_contabil		= substr(cd_conta_contabil_p,1,20),
			ds_site_internet		= substr(ds_site_internet_p,1,255),
			cd_cond_pagto		= substr(cd_cond_pagto_p,1,10),
			ds_nome_abrev		= substr(ds_nome_abrev_p,1,18),
			ie_situacao		= coalesce(substr(ie_situacao_p,1,1),'A'),
			cd_sistema_ant		= substr(cd_sistema_ant_p,1,20),
			ds_observacao		= substr(ds_observacao_p,1,4000),
			dt_integracao		= clock_timestamp()
		where	cd_cgc			= cd_cnpj_w;
	end;
	
	if (coalesce(ds_email_p,'X') <> 'X') or (coalesce(cd_cond_pagto_p,'X') <> 'X') or (coalesce(nm_pessoa_contato_p,'X') <> 'X') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_pj_estab_w
		from	pessoa_juridica_estab
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_cgc 		= cd_cnpj_w;
		
		if (coalesce(nr_seq_pj_estab_w,0) = 0) then
			insert into pessoa_juridica_estab(
					nr_sequencia,
					cd_cgc,
					cd_estabelecimento,
					dt_atualizacao,
					nm_usuario,
					nm_pessoa_contato,
					ds_email,
					cd_cond_pagto,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_conta_dif_nf)
				values (	nextval('pessoa_juridica_estab_seq'),
					cd_cnpj_w,
					cd_estabelecimento_w,
					clock_timestamp(),
					nm_usuario_p,
					substr(nm_pessoa_contato_p,1,255),
					substr(ds_email_p,1,255),
					cd_cond_pagto_p,
					clock_timestamp(),
					nm_usuario_p,
					'N');
		else
			update	pessoa_juridica_estab
			set	nm_pessoa_contato	= substr(nm_pessoa_contato_p,1,255),
				ds_email			= substr(ds_email_p,1,255),
				cd_cond_pagto		= cd_cond_pagto_p,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	nr_sequencia		= nr_seq_pj_estab_w;
		end if;
	end if;
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_pessoa_juridica_txt ( cd_cnpj_p text, ds_razao_social_p text, nm_fantasia_p text, cd_cep_p text, ds_endereco_p text, ds_bairro_p text, ds_municipio_p text, sg_estado_p text, nm_usuario_p text, ds_complemento_p text, nr_telefone_p text, nr_endereco_p text, nr_fax_p text, ds_email_p text, nm_pessoa_contato_p text, nr_ramal_contato_p text, nr_inscricao_estadual_p text, cd_tipo_pessoa_p text, cd_conta_contabil_p text, ds_site_internet_p text, cd_cond_pagto_p text, ds_nome_abrev_p text, ie_situacao_p text, cd_sistema_ant_p text, ds_observacao_p text) FROM PUBLIC;

