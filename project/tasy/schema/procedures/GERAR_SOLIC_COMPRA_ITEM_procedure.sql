-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_compra_item ( nr_solic_compra_p bigint, cd_material_p bigint, ie_unidade_p text, qt_comprar_p bigint, dt_entrega_p timestamp, nm_usuario_p text, atualiza_valor_previsto_p text, qt_dias_obter_compra_p bigint, ds_observacao_p text) AS $body$
DECLARE


nr_item_w			bigint;
cd_unidade_w			varchar(30);
cd_unidade_compra_w		varchar(30);
cd_unidade_estoque_w		varchar(30);
cd_unidade_consumo_w		varchar(30);
cd_estabelecimento_w		smallint;
nr_seq_nf_w			bigint;
vl_ultima_compra_w		double precision := 0;
ds_observacao_w			varchar(255);
cd_local_estoque_w		bigint;
cd_perfil_w			bigint;
ie_valor_previsto_w			varchar(15);


BEGIN

cd_perfil_w	:= Obter_Perfil_ativo;

select	cd_estabelecimento,
	cd_local_estoque
into STRICT	cd_estabelecimento_w,
	cd_local_estoque_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;



select (max(obter_valor_param_usuario(913, 165, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)))
into STRICT	ie_valor_previsto_w
;

select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMC'),1,255) cd_unidade_medida_compra,
	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo
into STRICT	cd_unidade_compra_w,
	cd_unidade_estoque_w,
	cd_unidade_consumo_w
from	material
where	cd_material = cd_material_p;

cd_unidade_w		:= cd_unidade_compra_w;
if (ie_unidade_p = 'C') then
	cd_unidade_w	:= cd_unidade_compra_w;
elsif (ie_unidade_p = 'E') then
	cd_unidade_w	:= cd_unidade_estoque_w;
elsif (ie_unidade_p = 'M') then
	cd_unidade_w	:= cd_unidade_consumo_w;
end if;


ds_observacao_w := substr(coalesce(ds_observacao_p,null),1,255);


if (atualiza_valor_previsto_p = 'S') then
	begin
	
	if (ie_valor_previsto_w = '2') then
	
		select	obter_maior_vl_compra_mat(cd_estabelecimento_w, 9999, cd_material_p, null, 'N')
		into STRICT	vl_ultima_compra_w
		;
	else
		SELECT * FROM Obter_ultima_compra_material(
				cd_estabelecimento_w, cd_material_p, cd_unidade_compra_w, 'C', clock_timestamp() - coalesce(qt_dias_obter_compra_p, 90), nr_seq_nf_w, vl_ultima_compra_w) INTO STRICT nr_seq_nf_w, vl_ultima_compra_w;
	end if;
	end;
end if;

select	coalesce(max(nr_item_solic_compra),0) + 1
into STRICT	nr_item_w
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;

insert into solic_compra_item(
	nr_solic_compra,
	nr_item_solic_compra,
	cd_material,
	cd_unidade_medida_compra,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	ds_material_direto,
	ds_observacao,
	nr_cot_compra,
	nr_item_cot_compra,
	cd_motivo_baixa,
	dt_baixa,
	dt_solic_item,
	nr_seq_aprovacao,
	dt_autorizacao,
	vl_unit_previsto,
	ie_geracao,
	qt_conv_compra_est_orig,
	qt_saldo_disp_estoque)
values (nr_solic_compra_p,
	nr_item_w,
	cd_material_p,
	cd_unidade_w,
	qt_comprar_p,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	null,
	ds_observacao_w,
	null,
	null,
	null,
	null,
	dt_entrega_p,
	null,
	null,
	vl_ultima_compra_w,
	'S',
	obter_dados_material(cd_material_p,'QCE'),
	obter_saldo_estoque_nuvem(cd_estabelecimento_w, cd_material_p, cd_local_estoque_w, ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(clock_timestamp())));

insert into solic_compra_item_entrega(
	nr_solic_compra,
	nr_item_solic_compra,
	nr_item_solic_compra_entr,
	qt_entrega_solicitada,
	dt_entrega_solicitada,
	dt_atualizacao,
	nm_usuario,
	ds_observacao)
values (nr_solic_compra_p,
	nr_item_w,
	1,
	qt_comprar_p,
	dt_entrega_p,
	clock_timestamp(),
	nm_usuario_p,
	null);

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_compra_item ( nr_solic_compra_p bigint, cd_material_p bigint, ie_unidade_p text, qt_comprar_p bigint, dt_entrega_p timestamp, nm_usuario_p text, atualiza_valor_previsto_p text, qt_dias_obter_compra_p bigint, ds_observacao_p text) FROM PUBLIC;

