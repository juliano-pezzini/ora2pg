-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajusta_dias_tratamentos_fase (nr_sequencia_p bigint) AS $body$
DECLARE

  nr_seq_volume_tratamento_w    rxt_fase_tratamento.nr_seq_volume_tratamento%type;
  nr_seq_tratamento_w           RXT_VOLUME_TRATAMENTO.nr_seq_tratamento%type;
  qt_duracao_trat_w             rxt_fase_tratamento.qt_duracao_trat%type;
  qt_dose_total_w               rxt_fase_tratamento.qt_dose_total%type;
  qt_dose_fase_w                rxt_fase_tratamento.qt_dose_fase%type;
  total_fase_tratamento_w       bigint;
  total_fase_dose_total_w       bigint;
  total_fase_dose_fase_w        bigint;
  total_volume_tratamento_w     bigint;
  total_volume_dose_total_w     bigint;
  total_volume_dose_fase_w      bigint;

BEGIN

  select rxt_fase_tratamento.nr_seq_volume_tratamento,
         rxt_fase_tratamento.qt_duracao_trat,
         rxt_fase_tratamento.qt_dose_total, 
         rxt_fase_tratamento.qt_dose_fase
    into STRICT nr_seq_volume_tratamento_w,
         qt_duracao_trat_w,
         qt_dose_total_w,
         qt_dose_fase_w
    from rxt_fase_tratamento
   where rxt_fase_tratamento.nr_sequencia = nr_sequencia_p;

  
  update RXT_CAMPO
     set RXT_CAMPO.Nr_Aplicacoes = qt_duracao_trat_w,
         RXT_CAMPO.Qt_Dose_Total = qt_dose_total_w,
         RXT_CAMPO.Qt_Dose_Diaria = qt_dose_fase_w
   where RXT_CAMPO.NR_SEQ_FASE = nr_sequencia_p;

  select sum(rxt_fase_tratamento.qt_duracao_trat), 
         sum(rxt_fase_tratamento.qt_dose_total), 
         sum(rxt_fase_tratamento.qt_dose_fase)
    into STRICT total_fase_tratamento_w,
         total_fase_dose_total_w,
         total_fase_dose_fase_w
    from rxt_fase_tratamento
   where rxt_fase_tratamento.nr_seq_volume_tratamento = nr_seq_volume_tratamento_w;

  
  update RXT_VOLUME_TRATAMENTO
     set RXT_VOLUME_TRATAMENTO.Qt_Duracao_Trat = total_fase_tratamento_w,
         RXT_VOLUME_TRATAMENTO.Qt_Dose_Total = total_fase_dose_total_w,
         RXT_VOLUME_TRATAMENTO.Qt_Dose_Fase = total_fase_dose_fase_w
   where RXT_VOLUME_TRATAMENTO.Nr_Sequencia = nr_seq_volume_tratamento_w;

  select RXT_VOLUME_TRATAMENTO.nr_seq_tratamento
    into STRICT nr_seq_tratamento_w
    from RXT_VOLUME_TRATAMENTO
   where RXT_VOLUME_TRATAMENTO.Nr_Sequencia = nr_seq_volume_tratamento_w;

  
  select sum(RXT_VOLUME_TRATAMENTO.qt_duracao_trat),
         sum(RXT_VOLUME_TRATAMENTO.qt_dose_total), 
         sum(RXT_VOLUME_TRATAMENTO.qt_dose_fase)
    into STRICT total_volume_tratamento_w,
         total_volume_dose_total_w,
         total_volume_dose_fase_w
    from RXT_VOLUME_TRATAMENTO
   where RXT_VOLUME_TRATAMENTO.nr_seq_tratamento = nr_seq_tratamento_w;

     
  update RXT_TRATAMENTO
     set RXT_TRATAMENTO.Qt_Duracao_Trat = total_volume_tratamento_w,
         RXT_TRATAMENTO.Qt_Dose_Total = total_volume_dose_total_w,
         RXT_TRATAMENTO.Qt_Dose_Fracao = total_volume_dose_fase_w
   where RXT_TRATAMENTO.Nr_Sequencia = nr_seq_tratamento_w;

  commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajusta_dias_tratamentos_fase (nr_sequencia_p bigint) FROM PUBLIC;

