-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE tabela AS (nm_tabela 	varchar(100));


CREATE OR REPLACE PROCEDURE oft_inativar_formulario ( nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, vLista strRecTypeFormOft) AS $body$
DECLARE

 
nr_seq_consulta_form_w	oft_consulta_formulario.nr_sequencia%TYPE;
nm_usuario_w				usuario.nm_usuario%TYPE := wheb_usuario_pck.get_nm_usuario;
nr_seq_interno_w			diagnostico_doenca.nr_seq_interno%TYPE;
x 			 					integer;
TYPE Vetor IS TABLE OF tabela INDEX 	BY integer;

c01 CURSOR FOR 
	SELECT	nr_sequencia 
	FROM		oft_consulta_formulario	 
	WHERE		nr_seq_consulta 	= nr_seq_consulta_p 
	AND		nr_sequencia		= nr_seq_consulta_form_p 
	AND		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	AND		coalesce(dt_inativacao::text, '') = '';

BEGIN 
OPEN C01;
LOOP 
FETCH C01 INTO	 
	nr_seq_consulta_form_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
	CALL inativar_informacao('OFT_CONSULTA_FORMULARIO','NR_SEQUENCIA',nr_seq_consulta_form_w,NULL,nm_usuario_w);
	FOR j IN 1..vLista.COUNT LOOP 
		BEGIN 
		CALL inativar_informacao(vLista[j].nm_tabela,'NR_SEQ_CONSULTA_FORM',nr_seq_consulta_form_w,NULL,nm_usuario_w);
		IF (vLista[j].nm_tabela = 'OFT_REFRACAO') THEN 
			CALL inativar_informacao('OFT_OCULOS','NR_SEQ_CONSULTA_FORM',nr_seq_consulta_form_w,NULL,nm_usuario_w);
		ELSIF (vLista[j].nm_tabela = 'DIAGNOSTICO_DOENCA') OR (vLista[j].nm_tabela = 'OFT_DIAGNOSTICO') THEN 
			SELECT	MAX(nr_seq_interno) 
			INTO STRICT 		nr_seq_interno_w 
			FROM		diagnostico_doenca 
			WHERE		NR_SEQ_CONSULTA_FORM = nr_seq_consulta_form_w 
			AND		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
			AND		coalesce(dt_inativacao::text, '') = '';
			IF (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '') THEN 
				CALL inativar_informacao('DIAGNOSTICO_DOENCA','NR_SEQ_INTERNO',nr_seq_interno_w,NULL,nm_usuario_w);
			END IF;	
		END IF;	
		END;
	END LOOP;	
	END;
END LOOP;
CLOSE C01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE oft_inativar_formulario ( nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, vLista strRecTypeFormOft) FROM PUBLIC;

