-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_gerar_inicio_cir ( nr_atendimento_sel_p bigint, nr_atendimento_pac_p bigint, nr_cirurgia_p bigint, dt_entrada_p timestamp, dt_inicio_real_p timestamp, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, ds_sala_selecao_p text, cd_pessoa_fisica_p text, nm_maquina_atual_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_consistencia_w	varchar(255);
ev_inicio_cirurgia_w	integer;
cd_local_estoque_w	integer;
dt_inicio_cirurgia_w	timestamp;
nr_seq_eve_cir_w	integer;
		

BEGIN 
ds_consistencia_w := consistir_inicio_cirurgia(nr_atendimento_sel_p, nr_cirurgia_p, cd_estabelecimento_p, nm_usuario_p, ds_consistencia_w);
 
if (ds_consistencia_w <> '') then 
	begin 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(233795,'DS_CONSISTENCIA_W=' || ds_consistencia_w);
	end;
end if;
 
if (nr_atendimento_pac_p > 0) and (nr_atendimento_sel_p <> nr_atendimento_pac_p) then		 
	begin 
	--A cirurgia não será iniciada. Os atendimentos selecionados não conferem! 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(35157);
	end;
end if;
 
if (nr_atendimento_sel_p IS NOT NULL AND nr_atendimento_sel_p::text <> '') and (dt_entrada_p IS NOT NULL AND dt_entrada_p::text <> '') and (dt_inicio_real_p IS NOT NULL AND dt_inicio_real_p::text <> '') and (ds_sala_selecao_p IS NOT NULL AND ds_sala_selecao_p::text <> '') then 
	begin 
 
	ev_inicio_cirurgia_w := obter_param_usuario(872, 75, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ev_inicio_cirurgia_w);
	cd_local_estoque_w := obter_local_estoque(900, 73, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, nm_maquina_atual_p, cd_setor_atendimento_p, nr_cirurgia_p, 0, cd_local_estoque_w);
	CALL iniciar_cirurgia(nr_atendimento_sel_p,nr_cirurgia_p,dt_entrada_p,dt_inicio_real_p,cd_setor_atendimento_p,cd_unidade_basica_p,cd_unidade_compl_p,cd_tipo_acomodacao_p,nm_usuario_p,872,cd_estabelecimento_p);
 
	select	max(dt_inicio_real) 
	into STRICT	dt_inicio_cirurgia_w 
	from 	cirurgia 
	where	nr_cirurgia = nr_cirurgia_p;
 
	begin 
	nr_seq_eve_cir_w := gerar_evento_cirurgia(cd_pessoa_fisica_p, dt_inicio_real_p, nr_cirurgia_p, ev_inicio_cirurgia_w, cd_local_estoque_w, '', nm_usuario_p, nr_seq_eve_cir_w, null);
	exception 
		when others then 
		null;
	end;
	end;
else 
	begin 
	--A cirurgia não será iniciada. Os atendimentos selecionados não conferem! 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(35157);
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_gerar_inicio_cir ( nr_atendimento_sel_p bigint, nr_atendimento_pac_p bigint, nr_cirurgia_p bigint, dt_entrada_p timestamp, dt_inicio_real_p timestamp, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, ds_sala_selecao_p text, cd_pessoa_fisica_p text, nm_maquina_atual_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

