-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_gravar_ret_estoque ( nm_usuario_p text, nr_seq_estoque_p bigint, nr_seq_motivo_p bigint, qt_retirada_p bigint, ds_observacao_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

nr_seq_ret_w 	bigint;
cd_material_w 	bigint;
nr_seq_lote_fornec_w bigint;
qt_estoque_w 	double precision;
ie_baixar_estoque_w varchar(1);
cd_unidade_medida_w varchar(30);
cd_local_estoque_w smallint;

BEGIN
 
select 	coalesce(max(a.qt_estoque), 0), 
    max(a.cd_material), 
    max(a.nr_seq_lote_fornec), 
    max(b.cd_unidade_medida_consumo), 
    max(cd_local_estoque) 
into STRICT 	qt_estoque_w, 
    cd_material_w, 
    nr_seq_lote_fornec_w, 
    cd_unidade_medida_w, 
    cd_local_estoque_w 
from  adep_area_prep c, 
    material b,	 
    gedipa_estoque_cabine a     
where 	a.nr_sequencia = nr_seq_estoque_p 
and 	a.cd_material = b.cd_material 
and   a.nr_seq_area_prep = c.nr_sequencia;
 
if (qt_estoque_w < qt_retirada_p) then 
CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(227114);
end if;
 
update 	gedipa_estoque_cabine 
set 	qt_estoque = qt_estoque_w - qt_retirada_p 
where 	nr_sequencia = nr_seq_estoque_p;
 
select 	nextval('estoque_gedipa_retirada_seq') 
into STRICT 	nr_seq_ret_w
;
 
insert into estoque_gedipa_retirada( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_seq_gedipa_estoque, 
	nr_seq_motivo, 
	qt_retirada, 
	ds_observacao 
	) 
values ( 
	nr_seq_ret_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_estoque_p, 
	nr_seq_motivo_p, 
	qt_retirada_p, 
	ds_observacao_p 
	);
 
select 	max(ie_baixar_estoque) 
into STRICT 	ie_baixar_estoque_w 
from 	motivo_retirada_estoque 
where 	nr_sequencia = nr_seq_motivo_p;
	 
if (coalesce(ie_baixar_estoque_w, 'N') = 'S') then 
	begin 
  if (coalesce(cd_local_estoque_w::text, '') = '') then 
    cd_local_estoque_w := obter_local_estoque_setor(wheb_usuario_pck.get_cd_setor_atendimento, cd_estabelecimento_p);
  end if;
	CALL Gerar_Prescricao_Estoque(	cd_estabelecimento_p, null, null, cd_material_w, clock_timestamp(), 1, 
					cd_local_estoque_w, qt_retirada_p, wheb_usuario_pck.get_cd_setor_atendimento, 
					cd_unidade_medida_w, nm_usuario_p, 'I', null, null, null, null, 
					null, null, nr_seq_lote_fornec_w, null, null, null, 'N', null, 
					null);
	end;
end if;
	 
commit;	
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_gravar_ret_estoque ( nm_usuario_p text, nr_seq_estoque_p bigint, nr_seq_motivo_p bigint, qt_retirada_p bigint, ds_observacao_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

