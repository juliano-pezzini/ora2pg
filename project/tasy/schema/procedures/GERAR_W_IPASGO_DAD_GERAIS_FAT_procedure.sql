-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_ipasgo_dad_gerais_fat ( dt_mesano_referencia_p timestamp, cd_convenio_p bigint, nr_seq_tipo_fatura_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_linha_arq_p INOUT bigint) AS $body$
DECLARE


cd_tipo_fatura_w	fatur_tipo_fatura.cd_tipo_fatura%type;
vl_conta_w		double precision;
qt_guia_w		bigint;
ds_list_estab_w		w_ipasgo_dados_gerais_fat.ds_linha%type;
count_w		        integer := 0;


BEGIN

ds_list_estab_w := obter_param_usuario(999, 103, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ds_list_estab_w);

select	cd_tipo_fatura
into STRICT	cd_tipo_fatura_w
from	fatur_tipo_fatura
where	nr_sequencia = nr_seq_tipo_fatura_p;

begin
select  count(nr_sequencia)
into STRICT    count_w
from    w_ipasgo_dados_gerais_fat
where   dt_mesano_referencia = dt_mesano_referencia_p
and     tp_fatura = cd_tipo_fatura_w
and     nm_usuario = nm_usuario_p;
exception
when no_data_found then
        count_w := 0;
when too_many_rows then
        count_w := 0;
when data_exception then
        count_w := 0;
end;

if (coalesce(count_w,0) = 0) then

select	max(qt),
	max(vl_conta)
into STRICT	qt_guia_w,
	vl_conta_w
from (	SELECT	count(*) qt,
		0 vl_conta --sum(nvl(ipasgo_obter_valor_conta(b.nr_interno_conta,0),b.vl_conta)) vl_conta	
	from	atendimento_paciente c,
		conta_paciente b,
		protocolo_convenio a
	where	a.dt_mesano_referencia 	between dt_mesano_referencia_p and fim_mes(dt_mesano_referencia_p)
	and	a.cd_convenio		= cd_convenio_p
	and	c.nr_atendimento		= b.nr_atendimento
	and	a.ie_status_protocolo	= 2
	and	b.nr_seq_protocolo		= a.nr_seq_protocolo
	and	cd_estabelecimento_p	<> 0
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	b.nr_seq_tipo_fatura	= nr_seq_tipo_fatura_p
        and     coalesce(ds_list_estab_w,'X') = 'X'
	
union

	SELECT	count(*),
		0 vl_conta --sum(nvl(ipasgo_obter_valor_conta(b.nr_interno_conta,0),b.vl_conta)) vl_conta
	from	fatur_tipo_fatura f,
		atendimento_paciente c,
		conta_paciente b,
		protocolo_convenio a
	where	a.dt_mesano_referencia 	between dt_mesano_referencia_p and fim_mes(dt_mesano_referencia_p)
	and	a.cd_convenio		= cd_convenio_p
	and	c.nr_atendimento		= b.nr_atendimento
	and	a.ie_status_protocolo	= 2
	and	b.nr_seq_protocolo		= a.nr_seq_protocolo
	and	b.nr_seq_tipo_fatura	= f.nr_sequencia
	and	cd_estabelecimento_p	= 0
	and	f.cd_tipo_fatura		= cd_tipo_fatura_w
        and     coalesce(ds_list_estab_w,'X') = 'X'
        
union

	select	count(*) qt,
		0 vl_conta
	from	atendimento_paciente c,
		conta_paciente b,
		protocolo_convenio a
	where	a.dt_mesano_referencia 	between dt_mesano_referencia_p and fim_mes(dt_mesano_referencia_p)
	and	a.cd_convenio		= cd_convenio_p
	and	c.nr_atendimento		= b.nr_atendimento
	and	a.ie_status_protocolo	= 2
	and	b.nr_seq_protocolo		= a.nr_seq_protocolo
	and	cd_estabelecimento_p	<> 0
	and (coalesce(ds_list_estab_w,'X') <> 'X' and obter_se_contido(coalesce(a.cd_estabelecimento,ds_list_estab_w), ds_list_estab_w) = 'S')) alias16;

qt_linha_arq_p := qt_linha_arq_p + 1;

insert into w_ipasgo_dados_gerais_fat(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_linha,
		tp_registro,
		tp_fatura,
		qt_guia,
		vl_apresentado,
		dt_mesano_referencia,
		ds_linha,
		nr_seq_tipo_fatura)
	values (	nextval('w_ipasgo_dados_gerais_fat_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		qt_linha_arq_p,
		1,
		cd_tipo_fatura_w,
		qt_guia_w,
		vl_conta_w,
		dt_mesano_referencia_p,
		qt_linha_arq_p || '|' ||
		'1' || '|' ||
		cd_tipo_fatura_w || '|' ||
		qt_guia_w || '|' || 
		replace(replace(Campo_Mascara_virgula_casas(vl_conta_w,4),'.',''),',','.') || '|||||||||',
		nr_seq_tipo_fatura_p);
commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_ipasgo_dad_gerais_fat ( dt_mesano_referencia_p timestamp, cd_convenio_p bigint, nr_seq_tipo_fatura_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_linha_arq_p INOUT bigint) FROM PUBLIC;

