-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_preco_amb () AS $body$
DECLARE

 
cd_edicao_amb_w		integer;
cd_procedimento_w		bigint;
nr_sequencia_w		bigint;
qt_registros_w		bigint;
ds_retorno_w		varchar(10);

 
 
C01 CURSOR FOR 
SELECT 
	cd_edicao_amb, 
	cd_procedimento, 
	nr_sequencia 
from	preco_amb 
where	coalesce(nr_sequencia::text, '') = '' 
order by cd_edicao_amb,cd_procedimento;


BEGIN 
qt_registros_w	:= 0;
OPEN C01;
LOOP 
FETCH C01 into 
	cd_edicao_amb_w, 
	cd_procedimento_w, 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	qt_registros_w	:= qt_registros_w + 1;
 
	select nextval('preco_amb_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	update preco_amb 
	set	nr_sequencia		= nr_sequencia_w, 
		dt_inicio_vigencia	= to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss') 
	where	cd_edicao_amb		= cd_edicao_amb_w 
	and	cd_procedimento	= cd_procedimento_w;
 
	if (qt_registros_w	> 500) then 
		begin 
		qt_registros_w	:= 0;
		commit;
		end;
	end if;
	end;
END LOOP;
close c01;
commit;
 
qt_registros_w	:= 0;
select count(*) 
into STRICT	 qt_registros_w 
from	 preco_amb 
where	 coalesce(nr_sequencia::text, '') = '';
 
if (qt_registros_w	= 0) then 
	begin 
	ds_retorno_w := Executar_SQL_Dinamico('ALTER TABLE PRECO_AMB 
			   DROP CONSTRAINT PREAMB_UK ', ds_retorno_w);
	 
	ds_retorno_w := Executar_SQL_Dinamico('ALTER TABLE PRECO_AMB ADD 
					( 
   					CONSTRAINT PREAMB_UK Unique ( 
        				CD_EDICAO_AMB, 
        				CD_PROCEDIMENTO, 
        				DT_INICIO_VIGENCIA) 
						USING INDEX  Tablespace TASY_INDEX)', ds_retorno_w);
 
	ds_retorno_w := Executar_SQL_Dinamico('ALTER TABLE PRECO_AMB 
			   DROP CONSTRAINT PREAMB_PK ', ds_retorno_w);
 
	ds_retorno_w := Executar_SQL_Dinamico('ALTER TABLE PRECO_AMB ADD 
					( 
   					CONSTRAINT PREAMB_PK Primary Key ( 
        				NR_SEQUENCIA) 
						USING INDEX  Tablespace TASY_INDEX)', ds_retorno_w);
	 
	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE PRECO_AMB MODIFY (NR_SEQUENCIA NOT NULL) ', ds_retorno_w);
 
	ds_retorno_w := Executar_SQL_Dinamico('drop index PREAMB_I1', ds_retorno_w);
 
	ds_retorno_w := Executar_SQL_Dinamico('create index PREAMB_I1 
					on preco_amb(cd_edicao_amb,cd_procedimento)', ds_retorno_w);
 
	end;
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_preco_amb () FROM PUBLIC;

