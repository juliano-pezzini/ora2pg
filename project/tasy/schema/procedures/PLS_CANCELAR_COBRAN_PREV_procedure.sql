-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancelar_cobran_prev ( nr_seq_cobranca_p pls_cobranca_previa_serv.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	a.nr_titulo nr_titulo
	from	titulo_receber a,
		pls_cobranca_previa_serv b
	where	a.nr_seq_cob_previa	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_cobranca_p;

c02 CURSOR(nr_titulo_pc	titulo_receber.nr_titulo%type) FOR
	SELECT	b.nr_titulo nr_titulo
	from	titulo_receber_desdob b,
		titulo_receber a
	where	a.nr_titulo	= b.nr_titulo
	and	b.nr_titulo	= nr_titulo_pc
	and	(b.nr_titulo_dest IS NOT NULL AND b.nr_titulo_dest::text <> '');
BEGIN

for	r_c01_w in c01 loop
	for	r_c02_w in c02(r_c01_w.nr_titulo) loop
		CALL cancelar_desdobramento_titulo(r_c02_w.nr_titulo, nm_usuario_p);
	end loop;
	CALL cancelar_titulo_receber(r_c01_w.nr_titulo, nm_usuario_p, 'N', clock_timestamp());
end loop;

update	pls_cobranca_previa_serv
set	ie_situacao	= 'C',
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_sequencia	= nr_seq_cobranca_p;

select	nr_seq_requisicao
into STRICT	nr_seq_requisicao_w
from	pls_cobranca_previa_serv
where	nr_sequencia	= nr_seq_cobranca_p;

CALL pls_requisicao_gravar_hist(nr_seq_requisicao_w,'L','Realizado cancelamento da cobran√ßa prevista.',null,nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancelar_cobran_prev ( nr_seq_cobranca_p pls_cobranca_previa_serv.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

