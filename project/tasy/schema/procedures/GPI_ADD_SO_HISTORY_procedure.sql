-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpi_add_so_history ( nr_seq_ordem_serv_p bigint, ds_relat_tecnico_p text, nm_usuario_p text ) AS $body$
DECLARE


    ds_relat_tecnico_w        text;
    cd_pessoa_solicitante_w   bigint;
    cd_pessoa_origem_w        bigint;
    ds_email_origem_w         varchar(255);
    ds_email_destino_w        varchar(255);

BEGIN
    IF ds_relat_tecnico_p = '283709' THEN
        ds_relat_tecnico_w := obter_desc_expressao(283709);
    ELSE
        ds_relat_tecnico_w := ds_relat_tecnico_p;
    END IF;

    INSERT INTO man_ordem_serv_tecnico(
        nr_sequencia,
        nr_seq_ordem_serv,
        dt_atualizacao,
        nm_usuario,
        ds_relat_tecnico,
        dt_historico,
        ie_origem,
        nr_seq_tipo,
        dt_liberacao,
        nm_usuario_lib
    ) VALUES (
        nextval('man_ordem_serv_tecnico_seq'),
        nr_seq_ordem_serv_p,
        clock_timestamp(),
        nm_usuario_p,
        ds_relat_tecnico_w,
        clock_timestamp(),
        'I',
        1,
        clock_timestamp(),
        nm_usuario_p
    );

    COMMIT;
    SELECT
        cd_pessoa_solicitante
    INTO STRICT cd_pessoa_solicitante_w
    FROM
        man_ordem_servico_v
    WHERE
        nr_sequencia = nr_seq_ordem_serv_p;

    SELECT
        coalesce(MAX(ds_email), 'X')
    INTO STRICT ds_email_destino_w
    FROM
        usuario
    WHERE
        cd_pessoa_fisica = cd_pessoa_solicitante_w;

    IF ( ds_email_destino_w = 'X' ) THEN
        ds_email_destino_w := coalesce(substr(obter_dados_pf_pj(cd_pessoa_solicitante_w, NULL, 'M'), 1, 255), 'X');
    END IF;

    IF ( ds_email_destino_w = 'X' ) THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1167557);
    END IF;
    SELECT
        coalesce(MAX(ds_email), 'X'),
        coalesce(MAX(cd_pessoa_fisica), 'X')
    INTO STRICT
        ds_email_origem_w,
        cd_pessoa_origem_w
    FROM
        usuario
    WHERE
        nm_usuario = nm_usuario_p;

    IF ( ds_email_origem_w = 'X' ) THEN
        ds_email_origem_w := coalesce(substr(obter_dados_pf_pj(cd_pessoa_origem_w, NULL, 'M'), 1, 255), 'X');
    END IF;

    IF ( ds_email_origem_w = 'X' ) THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1167558);
    END IF;
    CALL enviar_email('GPI - OS Pendentes', ds_relat_tecnico_w, ds_email_origem_w, ds_email_destino_w, 'Tasy',
                 'M');
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpi_add_so_history ( nr_seq_ordem_serv_p bigint, ds_relat_tecnico_p text, nm_usuario_p text ) FROM PUBLIC;

