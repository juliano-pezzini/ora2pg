-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_autocreateval () AS $body$
DECLARE

NR_SEQ_VAL_W bigint;
NR_SEQUENCIA_W bigint;
NR_SEQ_ACTION_W bigint;
NM_VARIABLE_W varchar(255);
QTD_W bigint;
QTD_W2 bigint;

--Loop variables of action
C01 CURSOR FOR
  SELECT variable1.NR_SEQUENCIA NR_SEQ_VAL, variable1.NM_VARIABLE NM_VARIABLE
      INTO STRICT NR_SEQ_VAL_W, NM_VARIABLE_W
  FROM SCHEM_TEST_VARIABLE variable1
  WHERE variable1.NR_SEQ_ACTION = NR_SEQ_ACTION_W
  GROUP BY variable1.NR_SEQUENCIA, variable1.NM_VARIABLE
  ORDER BY variable1.NM_VARIABLE ASC;


BEGIN
  --procedure that auto create variables when add step
  SELECT COUNT(step.NR_SEQUENCIA) QTD 
      INTO STRICT QTD_W
  FROM SCHEM_TEST_STEP step 
  WHERE step.IE_JOBS = '0'  LIMIT 1;

  IF (QTD_W <> 0) THEN
    SELECT MAX(step.NR_SEQUENCIA) NR_SEQUENCIA, step.NR_SEQ_ACTION NR_SEQ_ACTION
      INTO STRICT NR_SEQUENCIA_W, NR_SEQ_ACTION_W
    FROM SCHEM_TEST_STEP step
    WHERE step.IE_JOBS = '0' 
    GROUP BY step.NR_SEQUENCIA, step.NR_SEQ_ACTION LIMIT 1;

    UPDATE SCHEM_TEST_STEP SET IE_JOBS = '85' WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;
    COMMIT;

    SELECT COUNT(val.NR_SEQUENCIA)
        INTO STRICT QTD_W2
    FROM SCHEM_TEST_STEP step 
    INNER JOIN SCHEM_TEST_VALUES val ON (val.NR_SEQ_STEP = step.NR_SEQUENCIA) 
    WHERE step.NR_SEQUENCIA = NR_SEQUENCIA_W;

    IF (QTD_W2 = 0) THEN
        OPEN C01;
        LOOP
        FETCH C01 INTO	
           NR_SEQ_VAL_W,
           NM_VARIABLE_W;
        EXIT WHEN NOT FOUND; /* apply on C01 */
        BEGIN	
            delete from schem_test_values	where nr_seq_step = NR_SEQUENCIA_W and NR_SEQ_VARIABLE = NR_SEQ_VAL_W and coalesce(NR_SEQ_SERVICE::text, '') = '' and coalesce(DS_VALUE::text, '') = '';
            COMMIT;

            INSERT INTO SCHEM_TEST_VALUES(nr_sequencia, nr_seq_step, nr_seq_variable, ds_value, dt_atualizacao, nm_usuario, nm_usuario_nrec)
                 VALUES (nextval('schem_test_values_seq'), NR_SEQUENCIA_W, NR_SEQ_VAL_W, '', clock_timestamp(), 'Auto Robot', 'Auto Robot');
            COMMIT;
        END;
        END LOOP;
        CLOSE C01;
    END IF;
  END IF;
  EXCEPTION
  WHEN no_data_found THEN
      RAISE NOTICE 'Erro: Data not found';
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_autocreateval () FROM PUBLIC;

