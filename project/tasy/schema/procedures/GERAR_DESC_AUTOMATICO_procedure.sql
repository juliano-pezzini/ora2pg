-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desc_automatico ( nr_interno_conta_p bigint, ie_tipo_desconto_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

			 
qt_regra_desc_item_w	bigint;
nr_seq_desc_w		bigint;
cd_convenio_w		integer;
vl_conta_w		double precision;
ds_erro_w		varchar(2000)	:= '';
ie_gerar_desc_w		varchar(1);


BEGIN 
 
select	max(cd_convenio_parametro) 
into STRICT	cd_convenio_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
/*select	max(obter_valor_conta(nr_interno_conta,0)) 
into	vl_conta_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;*/
 
 
begin 
vl_conta_w	:= obter_valor_conta(nr_interno_conta_p, 0);
exception 
when others then 
	vl_conta_w	:= 0;
end;
	 
select	count(1) 
into STRICT	qt_regra_desc_item_w 
from	conv_regra_desc a, 
	conv_regra_desc_item b 
where	a.nr_sequencia	= b.nr_seq_regra_desc 
and	cd_convenio	= cd_convenio_w 
and	trunc(clock_timestamp(),'dd') between coalesce(trunc(dt_inicio_vigencia,'dd'), trunc(clock_timestamp(),'dd')) and coalesce(dt_final_vigencia, clock_timestamp()) 
and	vl_conta_w between vl_inicial and vl_final  LIMIT 1;
 
if (qt_regra_desc_item_w > 0) then	 
	select	nextval('conta_paciente_desconto_seq') 
	into STRICT	nr_seq_desc_w 
	;
	 
	ie_gerar_desc_w	:= 'S';
	 
	begin 
	insert into conta_paciente_desconto(nr_sequencia, 
		nr_interno_conta, 
		ie_tipo_desconto, 
		dt_atualizacao, 
		nm_usuario, 
		vl_conta, 
		pr_desconto, 
		vl_desconto, 
		vl_liquido, 
		dt_desconto, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		ie_pacote, 
		ie_valor_inf) 
	values (nr_seq_desc_w, 
		nr_interno_conta_p, 
		ie_tipo_desconto_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		vl_conta_w, 
		0, 
		0, 
		vl_conta_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		'A', 
		'A');
	exception 
		when others then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280692);
		ie_gerar_desc_w	:= 'N';
	end;
	 
	 
	if (ie_gerar_desc_w = 'S') then 
		commit;
		 
		CALL Gerar_ConPaci_Desc_Item(nr_seq_desc_w,nm_usuario_p);
	 
		CALL Gerar_Conv_Regra_Desc(nr_seq_desc_w,nm_usuario_p);
		 
		--Calcular_ConPaci_Desc_Item(nr_seq_desc_w,nm_usuario_p); 
	 
		CALL Calcular_Conpaci_Desconto(nr_seq_desc_w,'I',nm_usuario_p);
	 
	else 
		rollback;
	end if;
	 
end if;
 
ds_erro_p	:= ds_erro_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desc_automatico ( nr_interno_conta_p bigint, ie_tipo_desconto_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

