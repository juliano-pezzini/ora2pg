-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_analise_glosa_exis_contas ( nr_seq_conta_p bigint, nr_seq_analise_conta_item_p bigint, nr_seq_mot_liberacao_p bigint, ds_parecer_p text, nr_seq_analise_p bigint, nr_seq_grupo_atual_p bigint, ie_comitar_p text, ie_lib_demais_glosas_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_motivo_liberacao_w		varchar(255);
ds_tipo_motivo_w		varchar(50);
ds_observacao_w			varchar(255);

ie_tipo_glosa_oc_w		varchar(1);
ie_tipo_historico_w		varchar(1);
ie_tipo_item_w			varchar(1);
ie_status_w			varchar(1) := 'N';
ie_situacao_w			varchar(1);
ie_tipo_motivo_w		varchar(1);

qt_apresentado_w		double precision;
qt_glosa_w			double precision := 0;

nr_seq_mot_liberacao_w		bigint;
nr_seq_item_glosa_oc_w		bigint;
nr_seq_conta_w			bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_partic_proc_w		bigint;
nr_seq_ocorrencia_w		bigint;
nr_seq_glosa_w			bigint;
nr_seq_conta_proc_ww		bigint;
nr_seq_conta_mat_ww		bigint;
nr_seq_partic_proc_ww		bigint;
nr_seq_conta_ww			bigint;

vl_total_apres_w		double precision;
vl_glosa_w			double precision := 0;
ie_origem_analise_w		bigint;
nr_seq_w_resumo_conta_w		bigint;
qt_liberado_w			double precision;
vl_liberado_w			double precision;

ie_analise_multipla_w		varchar(1)	:= 'N';
qt_liberada_w			double precision;
ie_valor_base_w			double precision;
vl_liberado_material_w		double precision;
vl_liberado_hi_w		double precision;
vl_liberado_co_w		double precision;
vl_unitario_apres_w		double precision;
vl_unitario_calc_w		double precision;
vl_glosa_hi_w			double precision;
vl_glosa_co_w			double precision;
vl_glosa_material_w		double precision;
ie_pagamento_w			varchar(1);
ie_pagamento_ww			varchar(1);
nr_seq_ordem_w			bigint;

qt_proc_conta_w			bigint;
qt_proc_conta_glosado_w		bigint;

C01 CURSOR FOR 
	SELECT	ie_tipo, 
		nr_sequencia, 
		ie_status, 
		ie_situacao, 
		nr_seq_conta, 
		nr_seq_conta_mat, 
		nr_seq_conta_proc, 
		nr_seq_proc_partic, 
		vl_glosa, 
		qt_glosa 
	from	pls_analise_conta_item 
	where	nr_seq_conta = nr_seq_conta_p 
	and (coalesce(nr_seq_conta_proc,0) 	= 0) 
	and (coalesce(nr_seq_conta_mat,0) 	= 0) 
	and (coalesce(nr_seq_proc_partic,0) = 0) 
	and	ie_status not in ('I', 'E', 'C') 
	order by 1;


BEGIN 
 
-- QUANDO GLOSA A CONTA NÃO PODE TER NADA DE VALOR LIBERADO!!!!!!!!!! 
update	w_pls_resumo_conta 
set	qt_liberado = 0, 
	vl_total = 0 
where	nr_seq_analise	= nr_seq_analise_p 
and	nr_seq_conta	= nr_seq_conta_p;
 
select	max(nr_seq_w_resumo_conta) 
into STRICT	nr_seq_w_resumo_conta_w 
from	pls_analise_conta_item 
where	nr_sequencia	= nr_seq_analise_conta_item_p;
 
select	coalesce(qt_apresentado,0), 
	coalesce(vl_total_apres,0), 
	coalesce(qt_liberado,0), 
	vl_total, 
	nr_seq_conta_proc, 
	nr_seq_conta 
into STRICT	qt_apresentado_w, 
	vl_total_apres_w, 
	qt_liberado_w, 
	vl_liberado_w, 
	nr_seq_conta_proc_ww, 
	nr_seq_conta_w 
from	w_pls_resumo_conta 
where	nr_sequencia	= nr_seq_w_resumo_conta_w;
 
if (coalesce(ie_lib_demais_glosas_p,'N') = 'S') then 
	/*Obter o motivo de liberação padrão para liberação manual.*/
 
	begin 
	select	nr_sequencia, 
		ie_tipo_motivo, 
		ds_motivo_liberacao 
	into STRICT	nr_seq_mot_liberacao_w, 
		ie_tipo_motivo_w, 
		ds_motivo_liberacao_w 
	from	pls_mot_lib_analise_conta 
	where	nr_sequencia =	(SELECT	max(nr_sequencia) 
				from	pls_mot_lib_analise_conta 
				where	coalesce(ie_glosa_manual,'N') = 'S');
	exception 
	when others then 
		nr_seq_mot_liberacao_w	:= null;
		ie_tipo_motivo_w	:= null;
	end;
 
	if (ie_tipo_motivo_w = 'N') then 
		ds_tipo_motivo_w	:= 'Liberação desfavorável';
	else 
		ds_tipo_motivo_w	:= 'Liberação favorável';
	end if;
 
	/*Se o motivo de liberação manual não existe, o processo não pode continuar. */
 
	if (coalesce(nr_seq_mot_liberacao_w,0) = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(176126);
		--'Não existe motivo padrão de liberação de glosas/ocorrências para glosa manual. O motivo de liberação citado, é o campo "Glosa manual", dos "Cadastros gerais / Plano de Saúde / Contas médicas / Motivos de liberação da análise da conta"' 
	end if;
 
	open C01;
	loop 
	fetch C01 into 
		ie_tipo_glosa_oc_w, 
		nr_seq_item_glosa_oc_w, 
		ie_status_w, 
		ie_situacao_w, 
		nr_seq_conta_w, 
		nr_seq_conta_mat_w, 
		nr_seq_conta_proc_w, 
		nr_seq_partic_proc_w, 
		vl_glosa_w, 
		qt_glosa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		/*Desfeita qualquer liberação que pode ter ocorrido préviamente*/
 
		/*Apagar parecer*/
 
		delete	FROM pls_analise_parecer_item 
		where	nr_seq_item	= nr_seq_item_glosa_oc_w;
 
		/*Atualizar o item para pendente.*/
 
		update	pls_analise_conta_item 
		set	ie_status	= 'P', 
			qt_glosa	= CASE WHEN coalesce(nr_seq_conta_proc,coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0)))=0 THEN  0  ELSE coalesce(qt_apresentado_w,0) END , 
			vl_glosa	= CASE WHEN coalesce(nr_seq_conta_proc,coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0)))=0 THEN  0  ELSE coalesce(vl_total_apres_w,0) END , 
			ie_consistencia = 'N', 
			ie_situacao	= 'A' 
		where	nr_sequencia	= nr_seq_item_glosa_oc_w 
		and	ie_status	<> 'I';
 
		select	nr_seq_ocorrencia, 
			nr_seq_glosa 
		into STRICT	nr_seq_ocorrencia_w, 
			nr_seq_glosa_w 
		from	pls_analise_conta_item 
		where 	nr_sequencia	= nr_seq_item_glosa_oc_w;
 
		/*Obtem o tipo de histórico se é uma liberação de glosa ou de ocorrencia*/
 
		select	CASE WHEN ie_tipo_glosa_oc_w='G' THEN  5 WHEN ie_tipo_glosa_oc_w='O' THEN  6 END  
		into STRICT	ie_tipo_historico_w 
		;
 
		/*Atualizado a glosa / ocorrencia*/
 
		update	pls_analise_conta_item 
		set	ie_status 	= CASE WHEN ie_tipo_motivo_w='S' THEN  'A'  ELSE 'N' END , 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao 	= clock_timestamp(), 
			ie_consistencia	= 'N', 
			ie_principal	= 'N', 
			qt_glosa	= CASE WHEN coalesce(nr_seq_conta_proc,coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0)))=0 THEN  0  ELSE coalesce(qt_apresentado_w,0) END , 
			vl_glosa	= CASE WHEN coalesce(nr_seq_conta_proc,coalesce(nr_seq_conta_mat,coalesce(nr_seq_proc_partic,0)))=0 THEN  0  ELSE coalesce(vl_total_apres_w,0) END , 
			ie_situacao	= CASE WHEN ie_tipo_motivo_w='N' THEN  'A' WHEN ie_tipo_motivo_w='L' THEN  'A' WHEN ie_tipo_motivo_w='S' THEN  'I' END  
		where	nr_sequencia	= nr_seq_item_glosa_oc_w 
		and	ie_status	<> 'I';
 
		/*Criado o parecer*/
 
		insert into pls_analise_parecer_item(nr_sequencia, 
			nr_seq_item, 
			nr_seq_motivo, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ds_parecer, 
			ie_tipo_motivo) 
		values (nextval('pls_analise_parecer_item_seq'), 
			nr_seq_item_glosa_oc_w, 
			nr_seq_mot_liberacao_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			'Parecer criado automáticamente pelo sistema na glosa/ocorrência manual.', 
			ie_tipo_motivo_w);
 
		ds_observacao_w := 	'Tipo de liberação: '||chr(13)||chr(10)|| 
					chr(9)||ds_tipo_motivo_w||chr(13)||chr(10)||chr(13)||chr(10)|| 
					'Motivo de liberação:'||chr(13)||chr(10)|| 
					chr(9)||ds_motivo_liberacao_w||chr(13)||chr(10)||chr(13)||chr(10)|| 
					'Observação/Parecer: '||chr(13)||chr(10)|| 
					chr(9)||'Parecer criado automáticamente pelo sistema na glosa/ocorrência manual.';
 
		/*Adiciona o histórico da ação*/
 
		CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_p, ie_tipo_historico_w, 
								 coalesce(nr_seq_ocorrencia_w, nr_seq_glosa_w), ie_tipo_item_w, nr_seq_ocorrencia_w, 
								 nr_seq_glosa_w, ds_observacao_w, nr_seq_grupo_atual_p, 
								 nm_usuario_p, cd_estabelecimento_p);
 
		end;
	end loop;
	close C01;
end if;
 
/*Apagar o parecer de modo se este existir*/
 
delete	FROM pls_analise_parecer_item 
where	nr_seq_item	= nr_seq_analise_conta_item_p;
 
if (qt_liberado_w > 0) and (qt_liberado_w < qt_apresentado_w) then 
	qt_glosa_w	:= qt_apresentado_w - qt_liberado_w;
	ie_status_w	:= 'L';
	 
	if (nr_seq_conta_proc_ww IS NOT NULL AND nr_seq_conta_proc_ww::text <> '') then 
		 
		ie_pagamento_ww	:= 'P';
	end if;
	 
	ds_observacao_w	:= ds_observacao_w || chr(13) || chr(10) || 'Glosa parcial' || chr(13) || chr(10) || 'Qt. glosada: ' || Campo_Mascara_virgula_casas(qt_glosa_w,4) || 
					chr(13) || chr(10);
elsif (vl_liberado_w > 0) and (vl_liberado_w < vl_total_apres_w) then 
	vl_glosa_w	:= vl_total_apres_w - vl_liberado_w;
	ie_status_w	:= 'L';
	 
	if (nr_seq_conta_proc_ww IS NOT NULL AND nr_seq_conta_proc_ww::text <> '') then 
		 
		ie_pagamento_ww	:= 'P';
	end if;
 
	ds_observacao_w	:= ds_observacao_w || chr(13) || chr(10) || 'Glosa parcial' || chr(13) || chr(10) || 'Vl. glosado: ' || Campo_Mascara_virgula_casas(vl_glosa_w,2) || 
		chr(13) || chr(10);
else 
	qt_glosa_w	:= qt_apresentado_w - qt_liberado_w;
	vl_glosa_w	:= vl_total_apres_w - vl_liberado_w;	
	ie_status_w	:= 'N';
	 
	if (nr_seq_conta_proc_ww IS NOT NULL AND nr_seq_conta_proc_ww::text <> '') then 
		 
		ie_pagamento_ww	:= 'P';
	end if;
	 
	ds_observacao_w	:= ds_observacao_w || chr(13) || chr(10) || 'Glosa total' || chr(13) || chr(10);
end if;
 
if (qt_liberado_w = 0 and vl_liberado_w = 0) then 
	 
	ie_pagamento_ww	:= 'G';
	 
elsif (qt_liberado_w <> qt_apresentado_w and vl_liberado_w <> vl_total_apres_w) then 
 
	ie_pagamento_ww	:= 'P';
	 
elsif (qt_liberado_w = qt_apresentado_w and vl_liberado_w = vl_total_apres_w) then 
 
	ie_pagamento_ww	:= 'L';
else 
	-- Indefinido 
	ie_pagamento_ww	:= 'I';
end if;
 
 
/*Atualizado a glosa / ocorrencia*/
 
update	pls_analise_conta_item 
set	ie_status 		= ie_status_w,--'N', 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao 		= clock_timestamp(), 
	ie_consistencia 	= 'N', 
	ie_situacao 		= 'A', --Ativada a glosa/ocorrencia 
	nr_seq_glosa_manual	 = NULL, 
	qt_glosa		= 0, 
	vl_glosa		= 0 
where	nr_sequencia		= nr_seq_analise_conta_item_p 
and	ie_status		<> 'I';
 
ie_analise_multipla_w := obter_param_usuario(1317, 20, null, nm_usuario_p, cd_estabelecimento_p, ie_analise_multipla_w);
 
if (coalesce(ie_analise_multipla_w,'N') = 'N') then 
	if (coalesce(qt_liberado_w,0) > 0) then 
		if (coalesce(ie_valor_base_w,'1') = '1') then 
			vl_liberado_w	:= round((vl_unitario_apres_w*qt_liberado_w)::numeric,2);
		else 
			vl_liberado_w	:= round((vl_unitario_calc_w*qt_liberado_w)::numeric,2);
		end if;
			 
		qt_liberada_w		:= qt_liberado_w;
		vl_liberado_hi_w 	:= null;
		vl_liberado_co_w 	:= null;
		vl_liberado_material_w 	:= null;			
	elsif (coalesce(vl_liberado_w,0) > 0) then				 
		vl_liberado_w		:= vl_liberado_w;
		qt_liberada_w		:= qt_apresentado_w;
	else 
		vl_liberado_w		:= 0;
		qt_liberada_w		:= 0;
		vl_liberado_hi_w 	:= 0;
		vl_liberado_co_w 	:= 0;
		vl_liberado_material_w 	:= 0;
	end if;			
 
	select	max(a.nr_seq_ordem) 
	into STRICT	nr_seq_ordem_w 
	from	pls_tempo_conta_grupo b, 
		pls_auditoria_conta_grupo a 
	where	a.nr_sequencia 		= b.nr_seq_auditoria 
	and	a.nr_seq_analise	= nr_seq_analise_p 
	and	a.nr_seq_grupo		= nr_seq_grupo_atual_p 
	and	coalesce(a.dt_liberacao::text, '') = '' 
	and	(b.dt_inicio_analise IS NOT NULL AND b.dt_inicio_analise::text <> '') 
	and	coalesce(b.dt_final_analise::text, '') = '';
		 
	SELECT * FROM pls_obter_valores_lib_analise(nr_seq_w_resumo_conta_w, cd_estabelecimento_p, vl_glosa_w, vl_liberado_w, qt_liberada_w, vl_liberado_co_w, vl_liberado_material_w, vl_liberado_hi_w, vl_glosa_co_w, vl_glosa_material_w, vl_glosa_hi_w) INTO STRICT vl_glosa_w, vl_liberado_w, qt_liberada_w, vl_liberado_co_w, vl_liberado_material_w, vl_liberado_hi_w, vl_glosa_co_w, vl_glosa_material_w, vl_glosa_hi_w;
	 
	if (nr_seq_ordem_w IS NOT NULL AND nr_seq_ordem_w::text <> '') then 
		if (coalesce(vl_liberado_w,0) = 0) and (coalesce(qt_liberada_w,0) = 0) then 
			ie_pagamento_w	:= 'G';
		elsif (coalesce(vl_glosa_w,0) > 0) and (coalesce(vl_liberado_w,0) > 0) then 
			ie_pagamento_w	:= 'P';	
		else 
			ie_pagamento_w	:= 'L';				
		end if;	
	 
		insert into pls_analise_fluxo_item(nr_sequencia, 
			nm_usuario, 
			dt_atualizacao, 
			nm_usuario_nrec, 
			dt_atualizacao_nrec, 
			nr_seq_analise, 
			nr_seq_grupo, 
			nr_seq_conta_proc, 
			nr_seq_conta_mat, 
			nr_seq_proc_partic, 
			nr_seq_ordem, 
			vl_glosa, 
			vl_liberado_hi, 
			vl_liberado_co,  
			vl_liberado_material, 
			vl_total, 
			vl_glosa_co,  
			vl_glosa_hi, 
			vl_glosa_material, 
			qt_liberada, 
			ie_pagamento, 
			nr_seq_glosa_item) 
		values (nextval('pls_analise_fluxo_item_seq'), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nr_seq_analise_p, 
			nr_seq_grupo_atual_p, 
			nr_seq_conta_proc_ww, 
			nr_seq_conta_mat_ww, 
			nr_seq_partic_proc_ww, 
			nr_seq_ordem_w, 
			vl_glosa_w, 
			vl_liberado_hi_w, 
			vl_liberado_co_w,  
			vl_liberado_material_w, 
			vl_liberado_w, 
			vl_glosa_co_w,  
			vl_glosa_hi_w, 
			vl_glosa_material_w, 
			qt_liberada_w, 
			ie_pagamento_w, 
			nr_seq_analise_conta_item_p);
	end if;
	 
	update	w_pls_resumo_conta 
	set	nm_usuario_glosa 	= nm_usuario_p, 
		nm_usuario_liberacao 	= '', 
		ie_fluxo_com_glosa	= 'S' 
	where	nr_sequencia	 	= nr_seq_w_resumo_conta_w;
end if;	
 
/*Criado o parecer*/
 
insert into pls_analise_parecer_item(nr_sequencia, 
	nr_seq_item, 
	nr_seq_motivo, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_parecer, 
	ie_tipo_motivo) 
values (nextval('pls_analise_parecer_item_seq'), 
	nr_seq_analise_conta_item_p, 
	nr_seq_mot_liberacao_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	ds_parecer_p, 
	'A');
 
CALL pls_analise_status_item(nr_seq_conta_p, null, null, nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p, null);
 
CALL pls_analise_status_pgto(nr_seq_conta_p, null, null, nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p, null, null, null, null);
 
/*incluído a atualização da análise, para que os valores de participante sejam atualizados após a pls_análise_status_pgto Diogo*/
				 
select	max(ie_origem_analise) 
into STRICT	ie_origem_analise_w 
from	pls_analise_conta 
where	nr_sequencia	= nr_seq_analise_p;
 
if (ie_origem_analise_w = 3) then 
	CALL pls_atual_w_resumo_conta_ptu(nr_seq_conta_p, null, null, null, nr_seq_analise_p, nm_usuario_p);
 
else 
	CALL pls_atualiza_w_resumo_conta(nr_seq_conta_p, null, null, null, nr_seq_analise_p, nm_usuario_p);
end if;	
 
update	w_pls_resumo_conta 
set	ie_pagamento		= ie_pagamento_ww 
where	nr_seq_conta_proc	= nr_seq_conta_proc_ww;
	 
if (coalesce(ie_comitar_p,'S') = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_glosa_exis_contas ( nr_seq_conta_p bigint, nr_seq_analise_conta_item_p bigint, nr_seq_mot_liberacao_p bigint, ds_parecer_p text, nr_seq_analise_p bigint, nr_seq_grupo_atual_p bigint, ie_comitar_p text, ie_lib_demais_glosas_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

