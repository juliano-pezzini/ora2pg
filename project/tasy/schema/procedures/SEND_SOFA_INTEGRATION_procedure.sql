-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE send_sofa_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_liberacao_p timestamp, dt_avaliacao_p timestamp, qt_rel_pao_fio2_p bigint, ie_dopamina_p bigint, qt_pam_p bigint, ie_dobutamina_p text, ie_noradrenalina_p bigint, qt_plaquetas_p bigint, qt_creatinina_serica_p bigint, qt_bilirrubina_serica_p bigint, qt_glasgow_p bigint, qt_pa_sistolica_p bigint) AS $body$
DECLARE

				
hospital_attendance_number_w	escala_sofa.nr_atendimento%type;
patient_id_w 					pessoa_fisica.cd_pessoa_fisica%type;
module_id_w						varchar(3);
module_name_w					varchar(50);
question_id_w					varchar(2);
answer_id_w						bigint;
answer_value_w					varchar(5);
ds_integracao_w					text;
aux_question_id_w				varchar(500);
aux_answer_id_w					varchar(500);
separator_w						varchar(1) := '@';
nm_user_w						escala_sofa.nm_usuario%type;
establishment_id_w   smallint;

c01 CURSOR FOR		
SELECT
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 1) question_id, 
(case 
    when qt_rel_pao_fio2_p >= 400 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_REL_PAO2_FIO2', 1)
    when qt_rel_pao_fio2_p between 300 and 399 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_REL_PAO2_FIO2', 2)
    when qt_rel_pao_fio2_p between 200 and 299 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_REL_PAO2_FIO2', 3)
    when qt_rel_pao_fio2_p between 100 and 199 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_REL_PAO2_FIO2', 4)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_REL_PAO2_FIO2', 5)
    end) answer_id, 
	null answer_value


union all

SELECT 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 2) question_id, 
(case 
    when ie_dopamina_p = 0 then Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_DOPAMINA', 1)
    when qt_pam_p < 70 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PAM', 2)
    when ie_dopamina_p = 1 or  ie_dobutamina_p = 'S' then Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_DOPAMINA', 3)
    when ie_dopamina_p = 2 or  ie_noradrenalina_p = 1 then Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_DOPAMINA', 4)
    when ie_dopamina_p = 3 or  ie_noradrenalina_p = 2 then Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_DOPAMINA', 5)
    end) answer_id, 
  null answer_value


union all

select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 3) question_id,
  (case 
    when qt_plaquetas_p >= 150 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PLAQUETAS', 1)
    when qt_plaquetas_p between 100 and 149 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PLAQUETAS', 2)
    when qt_plaquetas_p between 50 and 99 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PLAQUETAS', 3)
    when qt_plaquetas_p between 20 and 49 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PLAQUETAS', 4)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PLAQUETAS', 5)
    end) answer_id, 
  null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 4) question_id, 
  (case 
    when qt_creatinina_serica_p < 1.2 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_CREATININA_SERICA', 1)
    when qt_creatinina_serica_p between 1.2 and 1.9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_CREATININA_SERICA', 2)
    when qt_creatinina_serica_p between 2.0 and 3.4 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_CREATININA_SERICA', 3)
    when qt_creatinina_serica_p between 3.5 and 4.9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_CREATININA_SERICA', 4)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_CREATININA_SERICA', 5)
    end) answer_id,
   null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 5) question_id,
  (case 
    when qt_bilirrubina_serica_p <1.2 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_BILIRRUBINA_SERICA', 1)
    when qt_bilirrubina_serica_p between 1.2 and 1.9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_BILIRRUBINA_SERICA', 2)
    when qt_bilirrubina_serica_p between 2.0 and 5.9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_BILIRRUBINA_SERICA', 3)
    when qt_bilirrubina_serica_p between 6.0 and 11.9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_BILIRRUBINA_SERICA', 4)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_BILIRRUBINA_SERICA', 5)
    end) answer_id, 
   null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 6) question_id, 
  (case 
    when qt_glasgow_p = 15 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_GLASGOW', 1)
    when qt_glasgow_p between 13 and 14 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_GLASGOW', 2)
    when qt_glasgow_p between 10 and 12 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_GLASGOW', 3)
    when qt_glasgow_p between 6 and 9 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_GLASGOW', 4)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_GLASGOW', 1)
    end) answer_id, 
   null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 7) question_id,
    (case 
    when qt_pa_sistolica_p <= 100 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PA_SISTOLICA', 1)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_PA_SISTOLICA', 2)
    end) answer_id, 
   null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 8) question_id, 
    (case
    when obter_sinal_vital(nr_atendimento_p,'FR')>=22 then Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_FREQ_RESP', 1)
    else Obter_Conversao_Externa(null,'ESCALA_SOFA','QT_FREQ_RESP', 2)
    end) answer_id, 
   null answer_value


union all

 select 
    Obter_Conversao_Externa(null,'ESCALA_SOFA','QUESTION_ID', 9) question_id, 
coalesce((select (case when b.ie_nivel_consciencia = 1 then Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_NIVEL_CONSCIENCIA', 1)
        else Obter_Conversao_Externa(null,'ESCALA_SOFA','IE_NIVEL_CONSCIENCIA', 2) end) 
    from atendimento_sinal_vital b
    where b.nr_atendimento = nr_atendimento_p
    and   (b.ie_nivel_consciencia IS NOT NULL AND b.ie_nivel_consciencia::text <> '') 
    and   b.dt_liberacao = (select max(c.dt_liberacao) from atendimento_sinal_vital c
    where c.nr_atendimento = nr_atendimento_p and (c.ie_nivel_consciencia IS NOT NULL AND c.ie_nivel_consciencia::text <> ''))),0) answer_id, 
 null answer_value
;


BEGIN

if	((obter_setor(obter_setor_atual_paciente(nr_atendimento_p)) is not null) and (dt_liberacao_p IS NOT NULL AND dt_liberacao_p::text <> '')) then

	nm_user_w := WHEB_USUARIO_PCK.GET_NM_USUARIO;
	patient_id_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');
	module_id_w := Obter_Conversao_Externa(null,'ESCALA_SOFA','MODULE_ID',1);
	hospital_attendance_number_w := nr_atendimento_p;
	module_name_w := obter_conversao_externa(null,'ESCALA_SOFA','MODULE_NAME', '1');

	open c01;
	loop
	fetch c01 into
		question_id_w,
		answer_id_w,
		answer_value_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (coalesce(aux_question_id_w::text, '') = '') then
		aux_question_id_w := question_id_w;
		aux_answer_id_w := answer_id_w;
	else
		aux_question_id_w := aux_question_id_w||separator_w||question_id_w;
		aux_answer_id_w := aux_answer_id_w||separator_w||answer_id_w;
	end if;

	end;
	end loop;
	close c01;

	if (aux_question_id_w IS NOT NULL AND aux_question_id_w::text <> '') then

    select
      obter_estabelecimento_setor(obter_setor_atual_paciente(nr_atendimento_p))
    into STRICT
      establishment_id_w
;
	
		select bifrost.send_integration( 'patientinformation.sofa',
									'com.philips.tasy.integration.atepac.patientinformation.sofa.Sofa',
									'{ "patientId" : "' ||patient_id_w || '",'
                  ||'"establishmentId" : "'||establishment_id_w||'",'
									||'"hospitalAttendance" : "' ||hospital_attendance_number_w || '",'
									||'"checklistDate" : "' ||to_char(dt_avaliacao_p, 'yyyymmddhh24miss') || '",'	
									||'"updateTimeStamp" : "' || to_char(dt_liberacao_p, 'yyyymmddhh24miss') ||'",'
									||'"checklistId" : "' ||nr_sequencia_p || '",'
									||'"moduleId" : "' || module_id_w ||'",'
									||'"moduleName" : "' || module_name_w ||'" ,'
									||'"questionId" : "' || aux_question_id_w ||'" ,'
									||'"answerId" : "' || aux_answer_id_w ||'"'
									||'}',
									nm_user_w)
		into STRICT ds_integracao_w
		;
		
		end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE send_sofa_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_liberacao_p timestamp, dt_avaliacao_p timestamp, qt_rel_pao_fio2_p bigint, ie_dopamina_p bigint, qt_pam_p bigint, ie_dobutamina_p text, ie_noradrenalina_p bigint, qt_plaquetas_p bigint, qt_creatinina_serica_p bigint, qt_bilirrubina_serica_p bigint, qt_glasgow_p bigint, qt_pa_sistolica_p bigint) FROM PUBLIC;

