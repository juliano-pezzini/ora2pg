-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dias_inter_cid ( nr_atendimento_p bigint, cd_doenca_p text, nr_seq_interno_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_atual_dias_prev_inter_cid_w 	varchar(1);
qt_dias_inter_w			smallint;

ie_retorno_w		varchar(1)	:=	'N';
nr_seq_interno_w	bigint;
					

BEGIN 
if (nr_atendimento_p > 0) and (nr_seq_interno_p > 0) then 
	begin 
 
-- Verifica se é o primeiro registro, na tabela diagnostico_doenca, com classificação 'P' Principal.	 
	select	min(a.nr_seq_interno) 
	into STRICT	nr_seq_interno_w 
	from	diagnostico_doenca a, 
		diagnostico_medico b 
	where 	a.nr_atendimento = b.nr_atendimento 
	and	a.dt_diagnostico = b.dt_diagnostico 
	and	a.ie_classificacao_doenca	= 'P' 
	and	b.ie_tipo_diagnostico = 1 
	and	a.nr_atendimento		= nr_atendimento_p;
		 
	if (nr_seq_interno_p = nr_seq_interno_w) then 
		ie_retorno_w	:= 'S';
		 
	end if;
	end;
end if;
	 
ie_atual_dias_prev_inter_cid_w := Obter_param_Usuario(916, 1066, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atual_dias_prev_inter_cid_w);
 
if (ie_retorno_w = 'S') and (nr_atendimento_p > 0) and (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') and (ie_atual_dias_prev_inter_cid_w = 'S')then 
  begin 
 
  select	coalesce(max(qt_dias_prev_inter),0) 
  into STRICT	qt_dias_inter_w 
  from	cid_doenca 
  where	cd_doenca_cid = cd_doenca_p;
 
		 
	if (qt_dias_inter_w > 0) then  
 
		update atendimento_paciente 
		set 	qt_dias_prev_inter = qt_dias_inter_w 
		where	nr_atendimento	  = nr_atendimento_p;
 
	end if;
  end;
		 
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dias_inter_cid ( nr_atendimento_p bigint, cd_doenca_p text, nr_seq_interno_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

