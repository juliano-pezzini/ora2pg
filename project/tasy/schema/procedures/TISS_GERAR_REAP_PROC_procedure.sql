-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_reap_proc ( nr_seq_conta_reap_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_procedimento_w		bigint;
qt_procedimento_w			double precision;
cd_procedimento_w		varchar(255);
nr_seq_conta_proc_w		bigint;
nr_interno_conta_w		bigint;
vl_procedimento_w		double precision;
vl_unitario_w			double precision;
dt_procedimento_w		timestamp;
dt_inicio_proc_w		timestamp;
dt_fim_proc_w			timestamp;
dt_atualizacao_w		timestamp;
ie_honorario_w			varchar(3);
ie_tecnica_utilizada_w		varchar(5);
ie_via_acesso_w			varchar(5);
nm_usuario_w			varchar(15);
ie_tiss_tipo_guia_w		varchar(255);
cd_autorizacao_w		varchar(255);
ds_procedimento_w		varchar(255);
tx_reduca_acrescimo_w		double precision;
ds_justificativa_w		varchar(4000);
nr_seq_tiss_tabela_w		bigint;
cd_edicao_amb_w			varchar(10);
cd_procedimento_tuss_w		bigint;
ie_proc_tuss_w			varchar(5);
ie_desc_proc_interno_w		varchar(5);
cd_proc_convenio_w		varchar(255);
cd_proc_envio_w			varchar(20);
ds_proc_envio_w			varchar(255);
ds_texto_w			varchar(255);

c01 CURSOR FOR 
SELECT	nr_seq_procedimento, 
	dt_atualizacao, 
	nm_usuario, 
	to_char(a.cd_procedimento), 
	qt_procedimento, 
	vl_procedimento, 
	ie_via_acesso, 
	vl_unitario, 
	dt_procedimento, 
    	dt_inicio_proc, 
	dt_fim_proc, 
	'N' ie_honorario, 
	ie_tecnica_utilizada, 
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_Proced),1,254), 
	coalesce(tx_reducao_acresc,0), 
	substr(ds_justificativa_revisao,1,499), 
	a.nr_seq_tiss_tabela, 
	a.cd_procedimento_tuss, 
	a.cd_proc_convenio, 
	a.cd_proc_envio, 
	a.ds_proc_envio 
from	tiss_reap_proc a 
where	a.nr_seq_conta	= nr_seq_conta_reap_p;


BEGIN 
 
ds_texto_w := substr(wheb_mensagem_pck.get_texto(305785),1,255); --NÃ£o Informado 
select	ie_tiss_tipo_guia, 
	coalesce(cd_autorizacao,ds_texto_w), 
	nr_interno_conta 
into STRICT	ie_tiss_tipo_guia_w, 
	cd_autorizacao_w, 
	nr_interno_conta_w 
from	tiss_reap_conta 
where	nr_sequencia	= nr_seq_conta_reap_p;
 
select	coalesce(max(b.ie_proc_tuss),'N'), 
	coalesce(max(b.ie_desc_proc_interno),'N') 
into STRICT	ie_proc_tuss_w, 
	ie_desc_proc_interno_w 
from	tiss_parametros_convenio b, 
	conta_paciente a 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.cd_convenio_parametro	= b.cd_convenio 
and	a.nr_interno_conta	= nr_interno_conta_w;
 
open c01;
loop 
fetch c01 into 
	nr_seq_procedimento_w, 
	dt_atualizacao_w, 
	nm_usuario_w, 
	cd_procedimento_w, 
	qt_procedimento_w, 
	vl_procedimento_w, 
	ie_via_acesso_w, 
	vl_unitario_w, 
	dt_procedimento_w, 
	dt_inicio_proc_w, 
	dt_fim_proc_w, 
	ie_honorario_w, 
	ie_tecnica_utilizada_w, 
	ds_procedimento_w, 
	tx_reduca_acrescimo_w, 
	ds_justificativa_w, 
	nr_seq_tiss_tabela_w, 
	cd_procedimento_tuss_w, 
	cd_proc_convenio_w, 
	cd_proc_envio_w, 
	ds_proc_envio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select nextval('tiss_conta_proc_seq') 
	into STRICT  nr_seq_conta_proc_w 
	;
 
	select	CASE WHEN ie_via_acesso_w='B' THEN  'U'  ELSE ie_via_acesso_w END  
	into STRICT	ie_via_acesso_w 
	;
 
	select	coalesce(max(cd_tabela_xml), '00') 
	into STRICT	cd_edicao_amb_w 
	from	tiss_tipo_tabela 
	where	nr_sequencia	= nr_seq_tiss_tabela_w;
 
	if (coalesce(cd_procedimento_tuss_w,0) <> 0) then 
		if (ie_proc_tuss_w = 'S') then 
			cd_procedimento_w	:= cd_procedimento_tuss_w;
		elsif (ie_proc_tuss_w = 'C') then 
			if (to_char(cd_procedimento_w) <> coalesce(cd_proc_convenio_w,'X')) and (coalesce(cd_proc_convenio_w,'X') <> 'X') then 
				cd_procedimento_w	:= cd_proc_convenio_w;
			else 
				cd_procedimento_w	:= cd_procedimento_tuss_w;
			end if;
		end if;
	else 
		cd_procedimento_w	:= coalesce(cd_proc_convenio_w,cd_procedimento_w);
	end if;
 
	if (coalesce(cd_procedimento_tuss_w,0) <> 0) and (ie_desc_proc_interno_w	= 'T') then 
		ds_procedimento_w	:= coalesce(substr(Obter_Desc_Procedimento(cd_procedimento_tuss_w,8),1,255),ds_procedimento_w);
	end if;
	 
	cd_procedimento_w	:= coalesce(cd_proc_envio_w,cd_procedimento_w);
	ds_procedimento_w	:= coalesce(ds_proc_envio_w,ds_procedimento_w);
 
	insert into tiss_Conta_Proc( 
		nr_sequencia, 
		nr_seq_proc, 
		dt_atualizacao, 
		nm_usuario, 
		cd_procedimento, 
		qt_procedimento, 
		vl_procedimento, 
		ie_via_acesso, 
		vl_unitario, 
	    	dt_procedimento, 
		dt_inicio_cir, 
		dt_fim_cir, 
		ie_honorario, 
		ie_tecnica_utilizada, 
		nr_seq_reap_conta, 
		cd_autorizacao, 
		ie_tiss_tipo_guia, 
		ds_procedimento, 
		cd_edicao_amb, 
		vl_reducao_acrescimo, 
		ds_justificativa_revisao) 
	values (	nr_seq_conta_proc_w, 
	    nr_seq_procedimento_w, 
	    dt_atualizacao_w, 
	    nm_usuario_w, 
	    lpad(cd_procedimento_w,8,0), 
	    qt_procedimento_w, 
	    vl_procedimento_w, 
	    	ie_via_acesso_w, 
	    	vl_unitario_w, 
	    	dt_procedimento_w, 
	    	dt_inicio_proc_w, 
	    	dt_fim_proc_w, 
	    	ie_honorario_w, 
	    	ie_tecnica_utilizada_w, 
		nr_Seq_conta_Reap_p, 
		cd_autorizacao_w, 
		ie_tiss_tipo_guia_w, 
		substr(ds_procedimento_w,1,60), 
		cd_edicao_amb_w, 
		tx_reduca_acrescimo_w, 
		ds_justificativa_w);
		 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_reap_proc ( nr_seq_conta_reap_p bigint, nm_usuario_p text) FROM PUBLIC;

