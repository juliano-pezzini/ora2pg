-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpt_farm_liberar_item (nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_lib_farm_p text, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_horas_quimio_p bigint) AS $body$
DECLARE


ie_gerar_kit_w			varchar(1);
cd_estabelecimento_w	smallint;
nr_sequencia_w			bigint;
cd_pessoa_farm_w		cpoe_material.cd_farmac_lib%type;
nr_prescr_analise_w		prescr_medica.nr_prescricao%type;
ie_itens_incons_w		varchar(1) := 'N';
dt_atual_w				timestamp;
ds_observacao_copia_w	prescr_medica.ds_observacao_copia%type;
ie_consiste_prot_onc_w	prescr_medica_compl.ie_consiste_prot_onc%type := 'N';
ie_lib_prot_onc_w		gpt_presentation_rule.ie_lib_prot_onc%type;
nr_seq_atend_w			prescr_medica.nr_seq_atend%type := null;

ie_param33_w			varchar(1) := 'N';
ie_param39_w			varchar(1) := 'S';
ie_param40_w			varchar(1) := 'S';
ie_param41_w			varchar(1) := 'N';
ie_param49_w			varchar(1) := 'N';
ie_param64_w			varchar(1) := 'N';

ds_erro_w				varchar(2000);
ds_log_w				varchar(4000);

c01 CURSOR FOR
	SELECT	a.nr_prescricao
	from	prescr_medica a
	where	a.nr_atendimento 		= 	nr_atendimento_p
	and		a.cd_pessoa_fisica 		= 	cd_pessoa_fisica_p
	and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and		(dt_inicio_analise_farm IS NOT NULL AND dt_inicio_analise_farm::text <> '')
	and		a.nm_usuario_analise_farm    = nm_usuario_p
    and  	((dt_prescricao between inicio_dia(clock_timestamp() - interval '3 days') and fim_dia(clock_timestamp()))
	or		((nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '') and dt_prescricao between inicio_dia(clock_timestamp() - interval '3 days') and clock_timestamp() + (qt_horas_quimio_p / 24)))
	
union

	SELECT	a.nr_prescricao
	from	prescr_medica a
	where	coalesce(a.nr_atendimento::text, '') = ''
	and 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
	and		(dt_inicio_analise_farm IS NOT NULL AND dt_inicio_analise_farm::text <> '')
	and		a.nm_usuario_analise_farm    = nm_usuario_p
    and  	((dt_prescricao between inicio_dia(clock_timestamp() - interval '3 days') and fim_dia(clock_timestamp())) 
	or		((nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '') and dt_prescricao between inicio_dia(clock_timestamp() - interval '3 days') and clock_timestamp() + (qt_horas_quimio_p / 24)));WITH RECURSIVE cte AS (


c02 CURSOR(ds_observacao_copia_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT		regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) as ds_item_liberar_w

(regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) IS NOT NULL AND (regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level))::text <> '')  UNION ALL


c02 CURSOR(ds_observacao_copia_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT		regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) as ds_item_liberar_w

(regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) IS NOT NULL AND (regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;

c03 CURSOR(ds_item_liberar_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT	a.nr_prescricao
from	prescr_medica a
where	a.nr_atendimento = nr_atendimento_p
and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
and		a.nm_usuario_analise_farm = nm_usuario_p
and		a.nr_prescricao > nr_prescr_analise_w
and		a.ds_observacao_copia like '%' || ds_item_liberar_pc || '%'
order by 1;

c04 CURSOR(ds_item_liberar_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT	a.nr_prescricao
from	prescr_medica a
where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
and		coalesce(a.nr_atendimento::text, '') = ''
and 	((coalesce(ie_lib_farm_p,'S') = 'N') or (coalesce(ie_lib_farm,'N') = 'S'))
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and		(a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '')
and		a.nm_usuario_analise_farm = nm_usuario_p
and		a.nr_prescricao > nr_prescr_analise_w
and		a.ds_observacao_copia like '%' || ds_item_liberar_pc || '%'
order by 1;

BEGIN

ie_param33_w := obter_param_usuario(252, 33, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param33_w);
ie_param39_w := obter_param_usuario(252, 39, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param39_w);
ie_param40_w := obter_param_usuario(252, 40, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param40_w);
ie_param41_w := obter_param_usuario(252, 41, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param41_w);
ie_param49_w := obter_param_usuario(252, 49, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param49_w);
ie_param64_w := obter_param_usuario(252, 64, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param64_w);

select	coalesce(max(ie_lib_prot_onc), 'N')
into STRICT	ie_lib_prot_onc_w
from	gpt_presentation_rule
where	cd_perfil = wheb_usuario_pck.get_cd_perfil;

open c01;
loop
fetch c01 into
	nr_prescr_analise_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	ie_itens_incons_w	:= gpt_obter_itens_incons(nr_atendimento_p, cd_pessoa_fisica_p, nr_prescr_analise_w, null, nm_usuario_p);

	if (ie_itens_incons_w = 'S') then

		if (ie_lib_prot_onc_w = 'S') then
			select	max(a.nr_seq_atend),
					coalesce(max(b.ie_consiste_prot_onc), 'N')
			into STRICT	nr_seq_atend_w,
					ie_consiste_prot_onc_w
			from	prescr_medica a,
					prescr_medica_compl b
			where	a.nr_prescricao = b.nr_prescricao
			and		a.nr_prescricao = nr_prescr_analise_w;
		end if;

		if (ie_param64_w = 'S') then
			ds_erro_w := gerar_evolucao_farm_incon(nr_prescr_analise_w, nm_usuario_p, cd_estabelecimento_p, ds_erro_w);
		end if;

		if (ie_consiste_prot_onc_w = 'N') and (coalesce(nr_seq_atend_w::text, '') = '') then
			CALL liberar_prescricao_farmacia(nr_prescr_analise_w, 0, nm_usuario_p, 'S');
		end if;

	else

		ds_erro_w := liberar_prescricao_farm_html5(nr_prescr_analise_w, 'N', ie_param40_w, 'N', ie_param39_w, ie_param33_w, ie_param41_w, ie_param49_w, nm_usuario_p, cd_estabelecimento_p, ds_erro_w);

	end if;

	select	max(a.ds_observacao_copia)
	into STRICT	ds_observacao_copia_w
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescr_analise_w;
	
	if (ds_observacao_copia_w IS NOT NULL AND ds_observacao_copia_w::text <> '') then
		for r_c02_w in c02(ds_observacao_copia_w)
		loop
			if (r_c02_w.ds_item_liberar_w IS NOT NULL AND r_c02_w.ds_item_liberar_w::text <> '') then
				
				ds_log_w := substr(obter_desc_expressao(942996) || ' / gpt_farm_liberar_item = ' || chr(13)
									|| ' 01 - linha'
									|| ' nr_prescr_analise_w: '	|| nr_prescr_analise_w
									|| ' nr_atendimento_p: '	|| nr_atendimento_p
									|| ' ds_item_liberar_w: '	|| r_c02_w.ds_item_liberar_w
									|| ' cd_pessoa_fisica_p: '	|| cd_pessoa_fisica_p
									|| ' cd_perfil_p: '			|| cd_perfil_p
									|| ' ie_param40_w: '		|| ie_param40_w
									|| ' ie_param39_w: '		|| ie_param39_w
									|| ' ie_param33_w: '		|| ie_param33_w
									|| ' ie_param41_w: '		|| ie_param41_w
									|| ' ie_param49_w: '		|| ie_param49_w
									|| ' ie_param64_w: '		|| ie_param64_w, 1, 4000);

				CALL gerar_log_prescricao(	nr_prescricao_p => nr_prescr_analise_w,
										nr_seq_item_p => null,
										ie_agrupador_p => null,
										nr_seq_horario_p => null,
										ie_tipo_item_p => null,
										ds_log_p => ds_log_w,
										nm_usuario_p => nm_usuario_p,
										nr_seq_objeto_p => 71829,
										ie_commit_p => 'N');

				if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
					for r_c03_w in c03(r_c02_w.ds_item_liberar_w)
					loop
						ie_itens_incons_w := gpt_obter_itens_incons(nr_atendimento_p => nr_atendimento_p,
																	cd_pessoa_fisica_p => cd_pessoa_fisica_p,
																	nr_prescricao_p => r_c03_w.nr_prescricao,
																	ie_lib_farm_p => null,
																	nm_usuario_p => nm_usuario_p);
	
						if (ie_itens_incons_w = 'S') then

							if (ie_param64_w = 'S') then
								ds_erro_p => ds_erro_w := gerar_evolucao_farm_incon(	nr_prescricao_p => r_c03_w.nr_prescricao, nm_usuario_p => nm_usuario_p, cd_estabelecimento_p => cd_estabelecimento_p, ds_erro_p => ds_erro_w);
							end if;

							CALL liberar_prescricao_farmacia(nr_prescricao_p => r_c03_w.nr_prescricao,
														nr_seq_item_p => 0,
														nm_usuario_p => nm_usuario_p,
														ie_lib_parc_p => 'S');
						else
							ds_msg_informativa_p => ds_erro_w := liberar_prescricao_farm_html5(	nr_prescricao_p => r_c03_w.nr_prescricao, ie_libera_parcial_p => 'N', ie_libera_inconsistente_p => ie_param40_w, ie_inicio_analise_p => 'N', ie_permite_lib_farm_p => ie_param39_w, ie_lib_disp_indefinida_p => ie_param33_w, ie_solic_nao_padrao_p => ie_param41_w, ie_gerar_evolucao_p => ie_param49_w, nm_usuario_p => nm_usuario_p, cd_estabelecimento_p => cd_estabelecimento_p, ds_msg_informativa_p => ds_erro_w);
						end if;
					end loop;
				else
					for r_c04_w in c04(r_c02_w.ds_item_liberar_w)
					loop
						ie_itens_incons_w := gpt_obter_itens_incons(nr_atendimento_p => nr_atendimento_p,
																	cd_pessoa_fisica_p => cd_pessoa_fisica_p,
																	nr_prescricao_p => r_c04_w.nr_prescricao,
																	ie_lib_farm_p => null,
																	nm_usuario_p => nm_usuario_p);
	
						if (ie_itens_incons_w = 'S') then

							if (ie_param64_w = 'S') then
								ds_erro_p => ds_erro_w := gerar_evolucao_farm_incon(	nr_prescricao_p => r_c04_w.nr_prescricao, nm_usuario_p => nm_usuario_p, cd_estabelecimento_p => cd_estabelecimento_p, ds_erro_p => ds_erro_w);
							end if;

							CALL liberar_prescricao_farmacia(nr_prescricao_p => r_c04_w.nr_prescricao,
														nr_seq_item_p => 0,
														nm_usuario_p => nm_usuario_p,
														ie_lib_parc_p => 'S');
						else
							ds_msg_informativa_p => ds_erro_w := liberar_prescricao_farm_html5(	nr_prescricao_p => r_c04_w.nr_prescricao, ie_libera_parcial_p => 'N', ie_libera_inconsistente_p => ie_param40_w, ie_inicio_analise_p => 'N', ie_permite_lib_farm_p => ie_param39_w, ie_lib_disp_indefinida_p => ie_param33_w, ie_solic_nao_padrao_p => ie_param41_w, ie_gerar_evolucao_p => ie_param49_w, nm_usuario_p => nm_usuario_p, cd_estabelecimento_p => cd_estabelecimento_p, ds_msg_informativa_p => ds_erro_w);

						end if;
					end loop;
				end if;
			end if;
		end loop;
	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_farm_liberar_item (nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_lib_farm_p text, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_horas_quimio_p bigint) FROM PUBLIC;

