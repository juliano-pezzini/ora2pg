-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cf_gerar_remessa ( nm_usuario_p text, ie_destino_remessa_p text, cd_pessoa_destino_p text, nr_remessa_p INOUT bigint) AS $body$
DECLARE


cd_pessoa_envio_w 	varchar(20);
ie_destino_remessa_w	varchar(3);
cd_setor_destino_regra_w	bigint;
nr_sequencia_w		bigint;
cd_setor_origem_w	protocolo_documento.cd_setor_origem%type;


BEGIN

cd_setor_origem_w := null;

select	coalesce(max(cd_pessoa_fisica),'0')
into STRICT	cd_pessoa_envio_w
from	pessoa_fisica
where	nm_usuario = nm_usuario_p;

select	max(ie_destino_remessa),
	max(cd_setor_destino)
into STRICT	ie_destino_remessa_w,
	cd_setor_destino_regra_w
from	cf_regra_geracao_remessa
where	ie_destino_remessa = ie_destino_remessa_p
and	obter_se_destino_liberado(ie_destino_remessa, obter_perfil_ativo, nm_usuario_p ) = 'S';

select	nextval('protocolo_documento_seq')
into STRICT	nr_sequencia_w
;

select	max(cd_setor_atendimento)
into STRICT	cd_setor_origem_w
from	usuario
where	nm_usuario = nm_usuario_p;

insert into	protocolo_documento(nr_sequencia,
		 dt_atualizacao,
		 nm_usuario,
		 dt_atualizacao_nrec,
		 nm_usuario_nrec,
		 ie_tipo_protocolo,
		 nm_usuario_envio,
		 cd_estabelecimento,
		 dt_envio,
		 ie_status_protocolo,
		 cd_pessoa_origem,
		 cd_setor_destino,
		 ie_destino_remessa,
		 cd_pessoa_destino,
		 cd_setor_origem)
	values (
		 nr_sequencia_w,
		 clock_timestamp(),
		 nm_usuario_p,
		 clock_timestamp(),
		 nm_usuario_p,
		 5,
		 null,
		 null,
		 null,
		 'T',
		 cd_pessoa_envio_w,
		 cd_setor_destino_regra_w,
		 ie_destino_remessa_w,
		 cd_pessoa_destino_p,
		 cd_setor_origem_w);

nr_remessa_p	:= nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cf_gerar_remessa ( nm_usuario_p text, ie_destino_remessa_p text, cd_pessoa_destino_p text, nr_remessa_p INOUT bigint) FROM PUBLIC;

