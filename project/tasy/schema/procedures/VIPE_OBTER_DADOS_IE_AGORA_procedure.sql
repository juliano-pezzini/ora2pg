-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vipe_obter_dados_ie_agora ( nr_prescricao_p bigint, nr_prescricoes_p text, cd_intervalo_ent_p text, cd_intervalo_p INOUT text, ie_intervalo_agora_p INOUT bigint, hr_prim_horario_p INOUT text) AS $body$
DECLARE


nr_prescr_w		bigint	:= 0;
cd_intervalo_w		varchar(7);
ie_intervalo_agora_w	bigint	:= 0;
qt_min_agora_w		smallint	:= 0;
hr_prim_horario_w	varchar(10)	:= '';


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	nr_prescr_w	:= nr_prescricao_p;
else
	nr_prescr_w	:= Obter_Max_NrPrescricao(nr_prescricoes_p);
end if;

if (nr_prescr_w > 0) then

	select	max(cd_intervalo)
	into STRICT	cd_intervalo_w
	from	intervalo_prescricao
	where	ie_agora	= 'S'
	and    obter_se_intervalo(cd_intervalo, 1)  = 'S'
        and    cd_intervalo	= Obter_Menor_Intervalo_agora(1, nr_prescr_w)
        and    ie_situacao  	= 'A';

end if;

if (cd_intervalo_ent_p IS NOT NULL AND cd_intervalo_ent_p::text <> '') then
	select	count(*)
	into STRICT	ie_intervalo_agora_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_ent_p
	and	ie_agora = 'S';

	select	coalesce(qt_min_agora,0)
	into STRICT	qt_min_agora_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_ent_p;

	select	to_char((clock_timestamp() + (qt_min_agora_w/1440)), 'hh24:mi')
	into STRICT	hr_prim_horario_w
	;

end if;

cd_intervalo_p		:= cd_intervalo_w;
ie_intervalo_agora_p	:= ie_intervalo_agora_w;
hr_prim_horario_p	:= hr_prim_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vipe_obter_dados_ie_agora ( nr_prescricao_p bigint, nr_prescricoes_p text, cd_intervalo_ent_p text, cd_intervalo_p INOUT text, ie_intervalo_agora_p INOUT bigint, hr_prim_horario_p INOUT text) FROM PUBLIC;

