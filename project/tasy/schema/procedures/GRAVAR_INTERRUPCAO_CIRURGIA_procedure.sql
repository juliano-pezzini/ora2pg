-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_interrupcao_cirurgia ( nr_seq_interrupcao_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_altera_interrompida_w	varchar(2);
qt_agenda_espera_w             bigint;


BEGIN

if (nr_seq_interrupcao_p > 0) then
	update	cirurgia
	set	nr_seq_interrupcao	=	nr_seq_interrupcao_p,
       		  ie_status_cirurgia	= 	4,
      		  nm_usuario		      =	nm_usuario_p
	where	 nr_cirurgia		      =	nr_cirurgia_p;

	ie_altera_interrompida_w := obter_param_usuario(900, 426, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_interrompida_w);

	if (ie_altera_interrompida_w IS NOT NULL AND ie_altera_interrompida_w::text <> '')	then
		update	agenda_paciente
		set	   ie_status_agenda	= ie_altera_interrompida_w
		where	   nr_cirurgia      	= nr_cirurgia_p;
	end if;

   select   count(*)
   into STRICT      qt_agenda_espera_w
   from      paciente_espera a,
            	agenda_paciente b
   where    a.nr_seq_agenda = b.nr_sequencia
   and      b.nr_cirurgia   = nr_cirurgia_p;

   if (coalesce(qt_agenda_espera_w,0) > 0) then
         update  	 paciente_espera
         set     	 nr_seq_agenda  = NULL
         where    	nr_seq_agenda in (SELECT nr_sequencia
                                  		from   agenda_paciente
                               			where  nr_cirurgia = nr_cirurgia_p);
   end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_interrupcao_cirurgia ( nr_seq_interrupcao_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

