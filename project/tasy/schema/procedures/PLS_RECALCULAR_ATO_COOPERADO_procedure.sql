-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_recalcular_ato_cooperado ( dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Buscar as mensalidades que o lote seja do mês de referência especificado e 
excluir as informações de ato cooperado e calculá-las novamente. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
	Deletar da PLS_MENSALIDADE_ATO_COOP antes de calcular 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
	OPS - Atualização do Movimento Contábil 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
nr_seq_lote_w			pls_lote_mensalidade.nr_sequencia%type;
nr_seq_mensalidade_w		pls_mensalidade.nr_sequencia%type;

c_lotes_mensalidades CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	pls_lote_mensalidade	a 
	where	trunc(a.dt_mesano_referencia,'month') = dt_mes_competencia_p 
	or	trunc(a.dt_contabilizacao,'month') = dt_mes_competencia_p;

c_mensalidades CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_mensalidade	a 
	where	a.nr_seq_lote	= nr_seq_lote_w;


BEGIN 
open c_lotes_mensalidades;
loop 
fetch c_lotes_mensalidades into 
	nr_seq_lote_w;
EXIT WHEN NOT FOUND; /* apply on c_lotes_mensalidades */
	begin 
	open c_mensalidades;
	loop 
	fetch c_mensalidades into 
		nr_seq_mensalidade_w;
	EXIT WHEN NOT FOUND; /* apply on c_mensalidades */
		begin 
		delete	from pls_mensalidade_ato_coop 
		where	nr_seq_mensalidade	= nr_seq_mensalidade_w;
		 
		CALL pls_gerar_valor_ato_cooperado(nr_seq_mensalidade_w, null);
		CALL pls_gerar_pro_rata_dia(nr_seq_mensalidade_w);
		end;
	end loop;
	close c_mensalidades;
	end;
end loop;
close c_lotes_mensalidades;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recalcular_ato_cooperado ( dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

