-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_adiant_tit_repasse (nr_repasse_terceiro_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


vl_adiantamento_w			adiantamento_pago.vl_adiantamento%type;
nr_sequencia_w				titulo_pagar_adiant.nr_sequencia%type;
nr_titulo_w					repasse_terceiro_venc.nr_titulo%type;
vl_saldo_titulo_w			titulo_pagar.vl_saldo_titulo%type;
ds_observacao_w				adiantamento_pago.ds_observacao%type;

nr_adiantamento_w			adiantamento_pago.nr_adiantamento%type;
nr_seq_terceiro_w			terceiro_pessoa_fisica.nr_seq_terceiro%type;

dt_periodo_inicial_w   		repasse_terceiro.dt_periodo_inicial%type;
dt_periodo_final_w    		repasse_terceiro.dt_periodo_final%type;
ie_vincula_adiant_w		varchar(1);


c01 CURSOR FOR
SELECT	nr_adiantamento,
	vl_adiantamento,
	nr_seq_trans_fin,
	dt_adiantamento,
	ds_observacao		
from	adiantamento_pago a
where	a.vl_saldo > 0
and	a.cd_estabelecimento = cd_estabelecimento_p
and	a.dt_adiantamento between dt_periodo_inicial_w and dt_periodo_final_w
and	exists (	SELECT	1
		from	terceiro y
		where (y.cd_cgc = a.cd_cgc or y.cd_pessoa_fisica = a.cd_pessoa_fisica)
		and	y.nr_sequencia = nr_seq_terceiro_w
		and	ie_vincula_adiant_w in ('S','V')
		
union
	
		select	1
		from	terceiro_pessoa_fisica x
		where	x.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	x.nr_seq_terceiro = nr_seq_terceiro_w
		and	ie_vincula_adiant_w = 'V');

BEGIN

ie_vincula_adiant_w	:= obter_param_usuario_logado(89,135);

begin

select	b.nr_titulo,
	a.nr_seq_terceiro,
	a.dt_periodo_inicial,
	a.dt_periodo_final
into STRICT	nr_titulo_w,
	nr_seq_terceiro_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w
from	repasse_terceiro_venc b,
	repasse_terceiro a
where	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	a.nr_repasse_terceiro	= nr_repasse_terceiro_p;
EXCEPTION
WHEN OTHERS THEN
	nr_titulo_w 			:= null;
	nr_seq_terceiro_w		:= null;
	dt_periodo_inicial_w		:= null;
	dt_periodo_final_w		:= null;
END;

select 	sum(a.vl_saldo_titulo)
into STRICT	vl_saldo_titulo_w
from	titulo_pagar a
where	nr_titulo = nr_titulo_w;

for r_C01 in c01 loop
	begin
				
		if ( coalesce(r_C01.vl_adiantamento,0) > coalesce(vl_saldo_titulo_w,0) ) then -- Se o valor do adiantamento for maior que o valor  do titulo, o valor do adiantamento vinculado sera o valor do titulo AAMFIRMO OS 684176
			r_C01.vl_adiantamento := coalesce(vl_saldo_titulo_w,0);	
		end if;
		
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	titulo_pagar_adiant a
		where	a.nr_titulo	= nr_titulo_w;
		

		insert 	into titulo_pagar_adiant(nr_sequencia,
				nr_titulo,
				nr_adiantamento,
				vl_adiantamento,
				nr_seq_trans_fin,
				dt_contabil,
				dt_atualizacao,
				nm_usuario,
				ds_observacao)
			values (	nr_sequencia_w,
				nr_titulo_w,
				r_C01.nr_adiantamento,
				r_C01.vl_adiantamento,
				r_C01.nr_seq_trans_fin,
				r_C01.dt_adiantamento,
				clock_timestamp(),
				nm_usuario_p,
				r_C01.ds_observacao);
		
		CALL atualiza_adiantamento_pago(nr_titulo_w,r_C01.nr_adiantamento,r_C01.vl_adiantamento,nr_sequencia_w,nm_usuario_p,'I');	
		
		update	repasse_terceiro_venc
		set	vl_liquido		= vl_liquido - coalesce(r_C01.vl_adiantamento,0)
		where	nr_repasse_terceiro	= nr_repasse_terceiro_p
		and	nr_titulo		= nr_titulo_w;
		

	end;
end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_adiant_tit_repasse (nr_repasse_terceiro_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

