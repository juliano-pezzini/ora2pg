-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_protocolo_hemoterapia (cd_protocolo_dest_p bigint , nr_seq_destino_p bigint , nr_seq_hemoterapia_p text) AS $body$
DECLARE

 ie_porte_cirurgico_w    cpoe_hemoterapia.ie_porte_cirurgico%TYPE;
 ie_tipo_w         cpoe_hemoterapia.ie_tipo%TYPE;
 ie_tipo_paciente_w     cpoe_hemoterapia.ie_tipo_paciente%TYPE;
 ie_reserva_w        cpoe_hemoterapia.ie_reserva%TYPE;
 cd_procedimento_w     cpoe_hemoterapia.cd_procedimento%TYPE;
 ie_origem_proced_w     cpoe_hemoterapia.ie_origem_proced%TYPE;
 nr_seq_proc_interno_w   cpoe_hemoterapia.nr_seq_proc_interno%TYPE;
 nr_seq_derivado_w     cpoe_hemoterapia.nr_seq_derivado%TYPE;
 qt_procedimento_w     cpoe_hemoterapia.qt_procedimento%TYPE;
 qt_vol_hemocomp_w     cpoe_hemoterapia.qt_vol_hemocomp%TYPE;
 cd_intervalo_w       cpoe_hemoterapia.cd_intervalo%TYPE;
 qt_veloc_inf_hemo_w    cpoe_hemoterapia.qt_veloc_inf_hemo%TYPE;
 cd_setor_atendimento_w   cpoe_hemoterapia.cd_setor_atendimento%TYPE;
 ds_observacao_w      cpoe_hemoterapia.ds_observacao%TYPE;
 nr_sequencia_w       bigint;
 nr_sequencia_proc_w    bigint;
 ie_tipo_hemoc_w      varchar(3);
 nr_sequencia_indicacao_w  bigint;
 nr_seq_indicacao1_w    bigint;
 nr_seq_indicacao2_w    bigint;
 ie_coombs_direto_w     varchar(15);
 ds_coagulopatia_w     varchar(80);
 ie_aliquotado_w      varchar(1);
 ie_filtrado_w       varchar(1);
 ie_irradiado_w       varchar(1);
 ie_lavado_w        varchar(1);
 -- diluentes 
 cd_mat_dil_w        integer;
 cd_unid_med_dose_dil_w   varchar(30);
 qt_dose_dil_w       bigint;
 -- materiais extras (itens) 
 cd_interv_hem1_w      varchar(7);
 cd_mat_hem1_w       integer;
 cd_unid_medida_dose_hem1_w varchar(30);
 ds_hor_hem1_w       varchar(2000);
 dt_inicio_hem1_w      timestamp;
 dt_prim_hor_hem1_w     timestamp;
 hr_prim_hor_hem1_w     varchar(5);
 ie_adm_mat_hem1_w     varchar(3);
 ie_urgencia_mat_hem1_w   varchar(3);
 ie_via_mat_hem1_w     varchar(5);
 qt_dose_hem1_w       bigint;
 -- Reconstituinte 
 cd_mat_recons_w      integer;
 cd_unid_med_rec_w     varchar(30);
 qt_dose_rec_w       bigint;
 nm_usuario_w        varchar(255);

 c02 CURSOR FOR 
  SELECT cd_interv_hem 
      , cd_mat_hem 
      , cd_unid_medida_dose_hem 
      , ds_hor_hem 
      , dt_inicio_hem 
      , dt_prim_hor_hem 
      , hr_prim_hor_hem 
      , ie_adm_mat_hem 
      , ie_urgencia_mat_hem 
      , ie_via_mat_hem 
      , qt_dose_hem 
  FROM  cpoe_material_hemo_item_v 
  WHERE nr_sequencia = nr_seq_hemoterapia_p;

 c03 CURSOR FOR 
  SELECT cd_mat_recons 
      , cd_unid_med_rec 
      , qt_dose_rec 
  FROM  cpoe_material_hemo_reconst_v 
  WHERE nr_sequencia = nr_seq_hemoterapia_p;

 c04 CURSOR FOR 
  SELECT cd_mat_dil 
      , cd_unid_med_dose_dil 
      , qt_dose_dil 
  FROM  cpoe_material_hemo_diluente_v 
  WHERE nr_sequencia = nr_seq_hemoterapia_p;


BEGIN 
  nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
 
  IF (nr_seq_hemoterapia_p IS NOT NULL AND nr_seq_hemoterapia_p::text <> '') THEN 
   SELECT nextval('prot_solic_bco_sangue_seq') 
       , ie_porte_cirurgico 
       , ie_tipo 
       , ie_tipo_paciente 
       , ie_reserva 
       , cd_procedimento 
       , ie_origem_proced 
       , nr_seq_proc_interno 
       , nr_seq_derivado 
       , coalesce(qt_procedimento, 0) 
       , qt_vol_hemocomp 
       , cd_intervalo 
       , qt_veloc_inf_hemo 
       , cd_setor_atendimento 
       , Substr(ds_observacao, 1, 255) 
       , nr_seq_indicacao1 
       , nr_seq_indicacao2 
       , ie_coombs_direto 
       , ds_coagulopatia 
       , ie_aliquotado, 
	   ie_filtrado, 
	   ie_lavado, 
	   ie_irradiado 
   INTO STRICT  nr_sequencia_w 
     , ie_porte_cirurgico_w 
     , ie_tipo_w, ie_tipo_paciente_w 
     , ie_reserva_w 
     , cd_procedimento_w 
     , ie_origem_proced_w 
     , nr_seq_proc_interno_w 
     , nr_seq_derivado_w 
     , qt_procedimento_w 
     , qt_vol_hemocomp_w 
     , cd_intervalo_w 
     , qt_veloc_inf_hemo_w 
     , cd_setor_atendimento_w 
     , ds_observacao_w 
     , nr_seq_indicacao1_w 
     , nr_seq_indicacao2_w 
     , ie_coombs_direto_w 
     , ds_coagulopatia_w 
     , ie_aliquotado_w, 
	 ie_filtrado_w, 
	 ie_lavado_w, 
	 ie_irradiado_w 
   FROM  cpoe_hemoterapia 
   WHERE nr_sequencia = nr_seq_hemoterapia_p;
 
   -- Incluindo protocolos de banco de sangue (hemoterapia) 
   INSERT INTO prot_solic_bco_sangue(nr_sequencia 
          , cd_protocolo 
          , dt_atualizacao 
          , dt_atualizacao_nrec 
          , nm_usuario 
          , nm_usuario_nrec 
          , nr_seq_protocolo 
          , ie_porte_cirurgico 
          , ie_tipo 
          , ie_tipo_paciente 
          , ie_reserva 
          , ie_coombs_direto 
          , ds_coagulopatia) 
   VALUES ( nr_sequencia_w 
          , cd_protocolo_dest_p 
          , clock_timestamp() 
          , clock_timestamp() 
          , nm_usuario_w 
          , nm_usuario_w 
          , nr_seq_destino_p 
          , ie_porte_cirurgico_w 
          , ie_tipo_w 
          , ie_tipo_paciente_w 
          , ie_reserva_w 
          , ie_coombs_direto_w 
          , ds_coagulopatia_w);
 
   -- Incluindo protocolos de indicação 
   INSERT INTO protocolo_solic_indicacao(nr_sequencia 
          , nr_seq_solic_bs 
          , nm_usuario_nrec 
          , nm_usuario 
          , dt_atualizacao_nrec 
          , dt_atualizacao 
          , nr_seq_indicacao 
          , ie_grupo_hemocom) 
   SELECT nextval('protocolo_solic_indicacao_seq') 
       , nr_sequencia_w 
       , nm_usuario_w 
       , nm_usuario_w 
       , clock_timestamp() 
       , clock_timestamp() 
       , nr_sequencia 
       , ie_tipo_hemoc 
   FROM  san_indicacao 
   WHERE nr_sequencia IN ( nr_seq_indicacao1_w, nr_seq_indicacao1_w );
 
   ---- Incluindo protocolos de Hemocomponente 
   SELECT coalesce(Max(nr_seq_proc), 0) + 1 
   INTO STRICT  nr_sequencia_proc_w 
   FROM  protocolo_medic_proc 
   WHERE cd_protocolo = cd_protocolo_dest_p 
     AND nr_sequencia = nr_seq_destino_p;
 
   INSERT INTO protocolo_medic_proc(cd_protocolo 
          , nr_sequencia 
          , nr_seq_proc 
          , nr_seq_solic_bs 
          , cd_procedimento 
          , ie_origem_proced 
          , dt_atualizacao 
          , nm_usuario 
          , ds_dado_clinico 
          , cd_material_exame 
          , nr_seq_exame 
          , ie_se_necessario 
          , ie_acm 
          , ds_material_especial 
          , ie_urgencia 
          , nr_seq_proc_interno 
          , ie_lado 
          , ie_multiplicar_quant 
          , ie_respiracao 
          , cd_mod_vent 
          , ie_disp_resp_esp 
          , qt_fluxo_oxigenio 
          , ds_justificativa 
          , nr_seq_prot_glic 
          , nr_seq_derivado 
          , qt_procedimento 
          , qt_vol_hemocomp 
          , cd_intervalo 
          , qt_veloc_inf_hemo 
          , cd_setor_atendimento 
          , ds_observacao 
          , cd_procedimento_lcb 
          , ie_aliquotado 
          , ie_filtrado 
          , ie_irradiado 
          , ie_lavado 
    ) 
   VALUES (cd_protocolo_dest_p 
          , nr_seq_destino_p 
          , nr_sequencia_proc_w 
          , nr_sequencia_w 
          , cd_procedimento_w 
          , ie_origem_proced_w 
          , clock_timestamp() 
          , nm_usuario_w 
          , NULL 
          , NULL 
          , NULL 
          , 'N' 
          , 'N' 
          , NULL 
          , 'N' 
          , nr_seq_proc_interno_w 
          , NULL 
          , NULL 
          , NULL 
          , NULL 
          , NULL 
          , NULL 
          , NULL 
          , NULL 
          , nr_seq_derivado_w 
          , qt_procedimento_w 
          , qt_vol_hemocomp_w 
          , cd_intervalo_w 
          , qt_veloc_inf_hemo_w 
          , cd_setor_atendimento_w 
          , Substr(ds_observacao_w, 1, 255) 
          , nr_seq_proc_interno_w 
          , ie_aliquotado_w 
          , ie_filtrado_w 
          , ie_irradiado_w 
          , ie_lavado_w);
		 
   -- incluindo materiais Protocolo (itens) 
   OPEN c02;
   LOOP 
     FETCH c02 INTO 
      cd_interv_hem1_w 
      , cd_mat_hem1_w 
      , cd_unid_medida_dose_hem1_w 
      , ds_hor_hem1_w 
      , dt_inicio_hem1_w 
      , dt_prim_hor_hem1_w 
      , hr_prim_hor_hem1_w 
      , ie_adm_mat_hem1_w 
      , ie_urgencia_mat_hem1_w 
      , ie_via_mat_hem1_w 
      , qt_dose_hem1_w;
     EXIT WHEN NOT FOUND; /* apply on c02 */
 
     CALL Incluir_prot_derivado_material(cd_protocolo_dest_p, nr_seq_destino_p, cd_mat_hem1_w, NULL, 13, qt_dose_hem1_w, NULL, ie_via_mat_hem1_w, cd_unid_medida_dose_hem1_w, ds_hor_hem1_w, NULL, cd_interv_hem1_w, hr_prim_hor_hem1_w, NULL, NULL, clock_timestamp(), ie_urgencia_mat_hem1_w, null, null, null, nr_sequencia_proc_w);
   END LOOP;
   CLOSE c02;
 
   -- incluindo materiais Protocolo (Reconstituinte) 
   OPEN c03;
   LOOP 
     FETCH c03 INTO 
      cd_mat_recons_w 
      , cd_unid_med_rec_w 
      , qt_dose_rec_w;
     EXIT WHEN NOT FOUND; /* apply on c03 */
 
     CALL Incluir_prot_derivado_material(cd_protocolo_dest_p, nr_seq_destino_p, cd_mat_recons_w, NULL, 9, qt_dose_rec_w, NULL, NULL, cd_unid_med_rec_w);
   END LOOP;
   CLOSE c03;
 
   -- incluindo materiais Protocolo (diluentes) 
   OPEN c04;
   LOOP 
     FETCH c04 INTO 
      cd_mat_dil_w 
      , cd_unid_med_dose_dil_w 
      , qt_dose_dil_w;
 
     EXIT WHEN NOT FOUND; /* apply on c04 */
 
     CALL Incluir_prot_derivado_material(cd_protocolo_dest_p, nr_seq_destino_p, cd_mat_dil_w, NULL, 7, qt_dose_dil_w, NULL, NULL, cd_unid_med_dose_dil_w);
   END LOOP;
   CLOSE c04;
  END IF;
 
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_protocolo_hemoterapia (cd_protocolo_dest_p bigint , nr_seq_destino_p bigint , nr_seq_hemoterapia_p text) FROM PUBLIC;

