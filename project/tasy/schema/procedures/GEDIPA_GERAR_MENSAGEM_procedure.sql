-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_gerar_mensagem ( nr_seq_processo_p bigint, nr_seq_area_prep_p bigint, ie_evento_p text, nm_usuario_p text) AS $body$
DECLARE


ds_mensagem_w		varchar(4000);
ie_condicao_w		varchar(2);
ie_evento_w		varchar(2);
nr_seq_mensagem_w	bigint;
qt_kit_w		bigint;
cd_kit_material_w	bigint;

c01 CURSOR FOR
SELECT	ds_mensagem,
	ie_condicao,
	cd_kit_material
from	adep_proc_regra_mensagem
where	((ie_evento		= ie_evento_p) or (coalesce(ie_evento::text, '') = ''));

c02 CURSOR FOR
SELECT	ds_mensagem,
	ie_condicao,
	cd_kit_material,
	ie_evento
from	adep_proc_regra_mensagem;


BEGIN

if (coalesce(ie_evento_p,'XX') <> 'XX') then

	delete from adep_processo_mensagem
	where	nm_usuario	= nm_usuario_p
	and	ie_evento	= ie_evento_p;

	open c01;
	loop
	fetch c01 into
		ds_mensagem_w,
		ie_condicao_w,
		cd_kit_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if (ie_condicao_w	= 'K') then
			select	count(*)
			into STRICT	qt_kit_w
			from	prescr_material c,
				prescr_mat_hor b,
				adep_processo a
			where	a.nr_sequencia		= b.nr_seq_processo
			and	c.nr_sequencia		= b.nr_seq_material
			and	c.nr_prescricao		= b.nr_prescricao
			and	coalesce(b.nr_seq_area_prep,0)	= coalesce(nr_seq_area_prep_p,coalesce(b.nr_seq_area_prep,0))
			and	c.cd_kit_material	= cd_kit_material_w
			and	a.nr_sequencia		= nr_seq_processo_p
			and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';

			if (coalesce(qt_kit_w,0)	> 0) then
				select	nextval('adep_processo_mensagem_seq')
				into STRICT	nr_seq_mensagem_w
				;

				insert into adep_processo_mensagem(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_processo,
					ds_mensagem,
					ie_evento)
				values (nr_seq_mensagem_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_processo_p,
					ds_mensagem_w,
					ie_evento_p);
			end if;

		end if;

	end loop;
	close c01;
else
	delete from adep_processo_mensagem
	where	nm_usuario	= nm_usuario_p
	and	coalesce(ie_evento::text, '') = '';

	open c02;
	loop
	fetch c02 into
		ds_mensagem_w,
		ie_condicao_w,
		cd_kit_material_w,
		ie_evento_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (ie_condicao_w	= 'K') then
			select	count(*)
			into STRICT	qt_kit_w
			from	prescr_material c,
				prescr_mat_hor b,
				adep_processo a
			where	a.nr_sequencia		= b.nr_seq_processo
			and	c.nr_sequencia		= b.nr_seq_material
			and	c.nr_prescricao		= b.nr_prescricao
			and	c.cd_kit_material	= cd_kit_material_w
			and	a.nr_sequencia		= nr_seq_processo_p
			and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';

			if (coalesce(qt_kit_w,0)	> 0) then
				select	nextval('adep_processo_mensagem_seq')
				into STRICT	nr_seq_mensagem_w
				;

				insert into adep_processo_mensagem(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_processo,
					ds_mensagem,
					ie_evento)
				values (nr_seq_mensagem_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_processo_p,
					ds_mensagem_w,
					null);
			end if;
		end if;

	end loop;
	close c02;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_gerar_mensagem ( nr_seq_processo_p bigint, nr_seq_area_prep_p bigint, ie_evento_p text, nm_usuario_p text) FROM PUBLIC;

