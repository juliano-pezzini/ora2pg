-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_hsbc_cnab_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
-- header					 
ds_conteudo_w		varchar(400) 	:= null;
nr_seq_reg_arquivo_w	integer := 	000001;

cd_agencia_cobr_w	smallint;
nm_cliente_w		varchar(30);
dt_gravacao_w		varchar(6);
nr_conta_corrente_w	varchar(50);

--detalhe 
cd_inscricao_w		smallint;
nr_inscricao_empresa_w	varchar(14);
cd_agencia_bancaria_w	varchar(4);
nr_titulo_w		varchar(25);
dt_vencimento_w		varchar(6);
vl_titulo_w		bigint;
dt_emissao_w		varchar(6);
tx_juros_w		smallint;
vl_desconto_w		bigint;
nm_pagador_w		varchar(40);
ds_endereco_w		varchar(38);
ds_bairro_w		varchar(12);
cd_cep_w		varchar(5);
ds_cidade_w		varchar(15);
ds_uf_w			varchar(2);
vl_abatimento_w		bigint;
sacador_avalista_w 	varchar(39);
sufixo_cep_w		varchar(5);
nr_seu_numero_w		bigint;
tx_multa_w		integer;
dt_prorrogacao_w	varchar(6);
nosso_numero_w		bigint;

-- Brancos 
ds_brancos_393_w	varchar(393);
ds_banco_277_w		varchar(277);

C01 CURSOR FOR 
	SELECT	CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN '02'  ELSE '01' END  cd_inscricao, 
		CASE WHEN coalesce(coalesce(b.cd_pessoa_fisica,null)::text, '') = '' THEN substr(coalesce(x.cd_cgc,'0'),1,14)  ELSE coalesce(Obter_Cpf_Pessoa_Fisica(x.cd_pessoa_fisica),'0') END  nr_inscricao, 
		coalesce(c.cd_agencia_bancaria,'0') agencia_cedente, 
		coalesce(substr(e.cd_agencia_bancaria,1,4),'0') || coalesce(substr(e.cd_conta,1,6),'0') || coalesce(substr(e.ie_digito_conta,1,2),'0')conta_corrente, 
		coalesce(c.nr_titulo,'0') nr_titulo, 
		coalesce(x.nr_nosso_numero,coalesce(substr(obter_nosso_numero_interf(e.cd_banco,b.nr_titulo),1,11),'0')) nr_nosso_numero, 
		replace(to_char(c.vl_desconto, 'fm00000000000.00'),'.','') vl_desconto, 
		coalesce(c.nr_titulo,'0') seu_numero, 
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'ddmmyy') dt_vencimento, 
		coalesce(b.vl_titulo,'0') vl_titulo, 
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'ddmmyy') dt_emissao, 
		coalesce(x.tx_juros,'0') taxa_juros, 
		replace(to_char(substr(x.vl_abatimento,1,11), 'fm00000000000.00'),'.','') vl_abatimento, 
		coalesce(substr(b.tx_multa,1,7),'0') vl_multa, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc))),' ')),1,40) nm_pagador, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'R'))),' ')),1,38) ds_endereco, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B'))),' ')),1,12) ds_bairro, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'))),' ')),1,5) cd_cep, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'))),' ')),6,8) sufixo_cep, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI'))),' ')),1,15) ds_cidade, 
		substr(upper(coalesce(nfe_elimina_caractere_especial(elimina_caractere_especial(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'))),' ')),1,2)ds_uf, 
		substr(upper(elimina_caractere_especial(obter_nome_estabelecimento(cd_estabelecimento_p))),1,20) || substr(' - ' || obter_cgc_estabelecimento(cd_estabelecimento_p),1,18) sacador_avalista 
	from  titulo_receber         x, 
		titulo_receber_v        b, 
		titulo_receber_cobr       c, 
		cobranca_escritural       a, 
		banco_estabelecimento      e 
	where  x.nr_titulo       = b.nr_titulo 
	and   c.nr_titulo       = b.nr_titulo 
	and   a.nr_sequencia     = c.nr_seq_cobranca 
	and   a.nr_seq_conta_banco  = e.nr_sequencia 
	and   a.nr_sequencia     = nr_seq_cobr_escrit_p;


BEGIN 
delete	FROM w_envio_banco 
where	nm_usuario = nm_usuario_p;
 
--Brancos 
select	lpad(' ',393,' '), 
	lpad(' ',277, ' ') 
into STRICT	ds_brancos_393_w, 
	ds_banco_277_w
;
 
-- INICIO DO HEADER  
 
select	substr(coalesce(b.cd_agencia_bancaria,'0'),1,4) cd_agencia, 
	substr(coalesce(substr(b.cd_agencia_bancaria,1,4),'0') || coalesce(substr(b.cd_conta,1,6),'0') || coalesce(substr(b.ie_digito_conta,1,2),'0'),1,11)conta_corrente, 
	upper(substr(elimina_caractere_especial(obter_nome_estabelecimento(cd_estabelecimento_p)),1,30)) nm_cliente, 
	to_char(clock_timestamp(), 'DDMMYY') dt_gravacao, 
	ds_banco_277_w 
into STRICT	cd_agencia_cobr_w, 
	nr_conta_corrente_w, 
	nm_cliente_w, 
	dt_gravacao_w, 
	ds_banco_277_w 
from	banco_estabelecimento b, 
	cobranca_escritural a 
where	a.nr_seq_conta_banco	= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'01REMESSA01COBRANCA    0' || 
			lpad(cd_agencia_cobr_w,4,'0') || 
			'55' || 
			rpad(nr_conta_corrente_w,11,' ') || 
			rpad(' ',2,' ') || 
			rpad(coalesce(nm_cliente_w,' '),30,' ') || 
			'399HSBC      ' || 
			dt_gravacao_w || 
			'01600BPI' || 
			rpad(' ',2,' ') || 
			'LANCV08' || 
			ds_banco_277_w || 
			lpad(nr_seq_reg_arquivo_w,6,'0');
 
insert into w_envio_banco(	nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
values (	nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
 
-- FIM DO HEADER 
 
--DETALHE 
open C01;
loop 
fetch C01 into	 
		 
	cd_inscricao_w, 
	nr_inscricao_empresa_w, 
	cd_agencia_bancaria_w, 
	nr_conta_corrente_w, 
	nr_titulo_w, 
	nosso_numero_w, 
	vl_desconto_w, 
	nr_seu_numero_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	dt_emissao_w, 
	tx_juros_w, 
	vl_abatimento_w, 
	tx_multa_w, 
	nm_pagador_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	cd_cep_w, 
	sufixo_cep_w, 
	ds_cidade_w, 
	ds_uf_w, 
	sacador_avalista_w;
	 
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	 
	ds_conteudo_w	:=	'1' || 
				lpad(substr(cd_inscricao_w,1,2),2,'0') || 
				lpad(substr(nr_inscricao_empresa_w,1,14),14,'0') || 
				'0' || 
				lpad(substr(cd_agencia_bancaria_w,1,4),4,'0') || 
				'55' || 
				rpad(substr(nr_conta_corrente_w,1,11),11,' ') || 
				rpad(' ',2,' ') || 
				rpad(substr(nr_titulo_w,1,25),25,'0') || 
				lpad(coalesce(substr(nosso_numero_w,1,11),'0'),11,'0') || 
				'999999' || 
				lpad(substr(vl_desconto_w,1,11),11,'0') || 
				'999999' || 
				lpad(substr(vl_desconto_w,1,11),11,'0') || 
				'1' || 
				'01' || 
				lpad(substr(nr_seu_numero_w,1,10),10,'0') || 
				lpad(substr(dt_vencimento_w,1,6),6,'0') || 
				lpad(substr(vl_titulo_w,1,13),13,'0') || 
				'399' || 
				'00000' || 
				'98' || 
				'N' || 
				lpad(substr(dt_emissao_w,1,6),6,'0') || 
				'29' || 
				'67' || 
				rpad('    ',8,' ') || 
				'T' || 
				lpad(substr(tx_juros_w,1,4),4,'0') || 
				'999999' || 
				lpad(replace(to_char('00000000000.00'),'.',''),13,'0') || 
				lpad(replace(to_char('00000000000.00'),'.',''),13,'0') || -- valor iof 
				lpad(substr(vl_abatimento_w,1,13),13,'0') ||		 
				lpad(substr(tx_multa_w,1,13),13,'0') || 
				lpad(substr(cd_inscricao_w,1,2),2,'0') || 
				lpad(substr(nr_inscricao_empresa_w,1,14),14,'0') || 
				rpad(substr(nm_pagador_w,1,40),40,' ') ||	 
				rpad(substr(ds_endereco_w,1,38),38,' ') || 
				rpad(' ',2,' ') || 
				rpad(substr(ds_bairro_w,1,12),12,' ') || 
				rpad(substr(cd_cep_w,1,5),5,' ') || 
				rpad(substr(sufixo_cep_w,1,3),3,' ') || 
				rpad(substr(ds_cidade_w,1,15),15,' ')|| 
				rpad(ds_uf_w,2,' ') || 
				rpad(substr(sacador_avalista_w,1,39),39,' ') || 
				'S' || 
				rpad(' ',2,' ') || 
				'9' || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
 
	insert into 	w_envio_banco(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_estabelecimento, 
			ds_conteudo, 
			nr_seq_apres) 
	values (	nextval('w_envio_banco_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_estabelecimento_p, 
			ds_conteudo_w, 
			nr_seq_reg_arquivo_w);
 
	end;
 
end loop;
close C01;
-- FIM DO DETALHE 
 
-- INICIO TRAILER 
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
ds_conteudo_w	:= 	'9' || 
			ds_brancos_393_w || 
			lpad(nr_seq_reg_arquivo_w,6,'0');
 
insert	into w_envio_banco(	nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
values (	nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
--FIM TRAILER 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_hsbc_cnab_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

