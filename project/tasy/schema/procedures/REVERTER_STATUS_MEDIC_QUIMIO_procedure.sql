-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_status_medic_quimio ( nr_seq_atendimento_p bigint, nr_seq_p bigint, nm_usuario_p text, ie_tipo_seq_p text) AS $body$
DECLARE

nr_seq_material_w 	bigint;
nr_seq_ordem_w  	can_ordem_prod.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_seq_material
	from 	paciente_atend_medic
	where	nr_seq_atendimento	=	nr_seq_atendimento_p
	and	nr_agrupamento		=	nr_seq_p;


BEGIN

if (ie_tipo_seq_p = 'A') then  -- Agrupador
	update	paciente_atend_medic
	set	ie_administracao	=	'P',
		nm_usuario		=	nm_usuario_p,
		dt_atualizacao		=	clock_timestamp()
	where	nr_seq_atendimento	=	nr_seq_atendimento_p
	and	nr_agrupamento		=	nr_seq_p;

elsif (ie_tipo_seq_p = 'M') then  -- Material	
	update	paciente_atend_medic
	set	ie_administracao	=	'P',
		nm_usuario		=	nm_usuario_p,
		dt_atualizacao		=	clock_timestamp()
	where	nr_seq_atendimento	=	nr_seq_atendimento_p
	and	nr_seq_material		=	nr_seq_p;
end if;

if (ie_tipo_seq_p = 'A') then
	open C01;
	loop
	fetch C01 into	
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	
		delete from	paciente_atend_medic_adm 		
		where 		nr_seq_atendimento	= nr_seq_atendimento_p
		and		nr_seq_material		= nr_seq_material_w;
		end;
	end loop;
	close C01;
end if;

if (ie_tipo_seq_p = 'M') then
	delete from	paciente_atend_medic_adm
	where 	nr_seq_atendimento	= nr_seq_atendimento_p
	and		nr_seq_material		= nr_seq_p;
end if;

select 	max(a.nr_sequencia)
into STRICT    nr_seq_ordem_w
from    can_ordem_prod a,
        prescr_medica b,
        prescr_material c,
        prescr_mat_hor d,
        can_ordem_item_prescr e
where 	b.nr_seq_atend          = nr_seq_atendimento_p
and     c.nr_seq_material       = nr_seq_p
and   	a.nr_sequencia          = e.nr_seq_ordem
and   	b.nr_prescricao         = c.nr_prescricao
and   	c.nr_prescricao         = d.nr_prescricao
and   	c.nr_sequencia          = d.nr_seq_material
and     coalesce(c.nr_sequencia_diluicao::text, '') = ''
and     d.nr_sequencia          = e.nr_seq_mat_hor
and 	(a.dt_checagem IS NOT NULL AND a.dt_checagem::text <> '')
and     a.ie_cancelada 	        = 'N'
order by  a.nr_sequencia desc;

if (nr_seq_ordem_w > 0) then
    update  can_ordem_prod
    set     dt_checagem 	 = NULL,
            nm_usuario 	= nm_usuario_p,
            dt_atualizacao 	= clock_timestamp()
    where   nr_seq_atendimento 	= nr_seq_atendimento_p
    and     nr_sequencia  	= nr_seq_ordem_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_status_medic_quimio ( nr_seq_atendimento_p bigint, nr_seq_p bigint, nm_usuario_p text, ie_tipo_seq_p text) FROM PUBLIC;

