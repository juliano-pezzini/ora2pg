-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_marcar_doc_pend_leitura ( nr_seq_doc_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w			integer := obter_perfil_ativo;
ie_visualiza_setor_usuario_w	varchar(15);
ie_consid_toda_regra_w		varchar(15);
nm_usuario_w			varchar(15);
nr_seq_filho_w			bigint;

c01 CURSOR FOR
	SELECT	nm_usuario
	from	usuario
	where	ie_situacao = 'A'
	and	substr(obter_acesso_docto_qual(	nr_seq_doc_p,
						nm_usuario,
						cd_estabelecimento_w,
						ie_visualiza_setor_usuario_w, 
						ie_consid_toda_regra_w),1,1) = 'S';

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	qua_documento
	where	nr_seq_superior = nr_seq_doc_p;


BEGIN
	ie_visualiza_setor_usuario_w := obter_param_usuario(4000, 112, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_visualiza_setor_usuario_w);
	ie_consid_toda_regra_w := obter_param_usuario(4000, 113, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_consid_toda_regra_w);

	open C01;
	loop
	fetch C01 into	
		nm_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			insert  into qua_doc_log_acesso(
				dt_acesso,
				dt_atualizacao,
				nm_usuario,
				nr_seq_doc,
				nr_sequencia,
				dt_atualizacao_nrec,
				dt_leitura,
				ie_log,
				nm_usuario_nrec,
				cd_estabelecimento,
				cd_funcao,
                                dt_pendente)
			values (	clock_timestamp(),
				clock_timestamp(),
				nm_usuario_w,
				nr_seq_doc_p,
				nextval('qua_doc_log_acesso_seq'),
				clock_timestamp(),
				null,
				'C',
				nm_usuario_w,
				cd_estabelecimento_w,
				wheb_usuario_pck.get_cd_funcao,
                                clock_timestamp());

			open c02;
			loop
			fetch c02 into	
				nr_seq_filho_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
					insert  into qua_doc_log_acesso(
						dt_acesso,
						dt_atualizacao,
						nm_usuario,
						nr_seq_doc,
						nr_sequencia,
						dt_atualizacao_nrec,
						dt_leitura,
						ie_log,
						nm_usuario_nrec,
						cd_estabelecimento,
						cd_funcao,
                                                dt_pendente)
					values (	clock_timestamp(),
						clock_timestamp(),
						nm_usuario_w,
						nr_seq_filho_w,
						nextval('qua_doc_log_acesso_seq'),
						clock_timestamp(),
						null,
						'C',
						nm_usuario_w,
						cd_estabelecimento_w,
						wheb_usuario_pck.get_cd_funcao,
                                                clock_timestamp());
				end;
			end loop;
			close c02;
		end;
	end loop;
	close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_marcar_doc_pend_leitura ( nr_seq_doc_p bigint, nm_usuario_p text) FROM PUBLIC;

