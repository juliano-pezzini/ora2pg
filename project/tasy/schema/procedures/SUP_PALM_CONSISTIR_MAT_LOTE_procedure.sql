-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_palm_consistir_mat_lote ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, dt_entrada_unidade_p timestamp, cd_tipo_baixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_atendimento_w		bigint;					
ie_conta_aberta_w		varchar(1):= 'N';
ie_fim_conta_w		varchar(1);
dt_fim_conta_w		timestamp;
ie_local_valido_w		varchar(1);
ie_baixa_estoque_pac_w	varchar(1);
ie_estoque_disp_w		varchar(1);
ie_atualiza_estoque_w	varchar(1);
ie_saldo_estoque_w	varchar(1);
nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;
dt_prescricao_w		timestamp;	
nr_seq_atepacu_w		bigint;
cd_unidade_medida_w	varchar(30);
cd_cgc_fornec_w		varchar(14);
ie_consignado_w		varchar(1);
ds_erro_w		varchar(255);

					 

BEGIN 
 
ds_erro_w:= '';
 
select 	coalesce(max(nr_atendimento),0) 
into STRICT	nr_atendimento_w 
from 	prescr_medica 
where 	nr_prescricao = nr_prescricao_p;
 
select 	max(ie_fim_conta), 
	max(dt_fim_conta) 
into STRICT	ie_fim_conta_w, 
	dt_fim_conta_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_w;
 
select	substr(obter_dados_material(cd_material_p,'UME'),1,5) 
into STRICT	cd_unidade_medida_w
;
 
select	max(cd_setor_atendimento), 
	max(nr_seq_interno) 
into STRICT	cd_setor_atendimento_w, 
	nr_seq_atepacu_w 
from 	atend_paciente_unidade 
where 	nr_atendimento = nr_atendimento_w 
and 	dt_entrada_unidade = dt_entrada_unidade_p;
 
 
select 	max(ie_atualiza_estoque) 
into STRICT	ie_atualiza_estoque_W 
from 	ap_lote 
where 	nr_sequencia = nr_seq_lote_p;
 
if (coalesce(ie_atualiza_estoque_w::text, '') = '') then 
    	select	coalesce(max(ie_atualiza_estoque),'S') 
	into STRICT	ie_atualiza_estoque_w 
	from	tipo_baixa_prescricao 
	where	ie_prescricao_devolucao = 'P' 
	and 	cd_tipo_baixa = cd_tipo_baixa_p 
	and 	ie_situacao = 'A';
 
end if;
 
 
if (ie_fim_conta_w <> 'F') and (coalesce(dt_fim_conta_w::text, '') = '') then 
	ie_conta_aberta_w:= 'S';
else 
	ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(279983);
end if;
 
if (ie_conta_aberta_w = 'S') and (coalesce(ds_erro_w::text, '') = '') then 
	 
	ie_local_valido_w := obter_local_valido(cd_estabelecimento_p, cd_local_estoque_p, cd_material_p, null, ie_local_valido_w);
	 
	select	obter_se_baixa_estoque_pac(cd_setor_atendimento_w, cd_material_p,null,0) 
	into STRICT	ie_baixa_estoque_pac_w 
	;
 
	 
	SELECT	coalesce(ie_consignado,'0') 
	INTO STRICT	ie_consignado_w 
	FROM	material 
	WHERE	cd_material = cd_material_p;
	IF (ie_consignado_w <> '0') THEN 
		BEGIN 
		IF (coalesce(nr_seq_lote_fornec_p, 0) > 0) THEN 
			SELECT	cd_cgc_fornec 
			INTO STRICT	cd_cgc_fornec_w 
			FROM	material_lote_fornec 
			WHERE	nr_sequencia = nr_seq_lote_fornec_p;
		ELSE 
			cd_cgc_fornec_w	:= obter_fornecedor_regra_consig( 
						cd_estabelecimento_p, 
						cd_material_p, 
						'1');
		END IF;
		END;
	END IF;
	 
	 
	ie_saldo_estoque_w := obter_disp_estoque(cd_material_p, cd_local_estoque_p, cd_estabelecimento_p, 0, qt_material_p, cd_cgc_fornec_w, ie_saldo_estoque_w);
 
		 
	if	((ie_baixa_estoque_pac_w = 'N') or (ie_saldo_estoque_w = 'S') 	or (ie_atualiza_estoque_w = 'N')) 	then 
		ie_estoque_disp_w:= 'S';
	else 
		ie_estoque_disp_w:= 'N';
	end if;
	 
	if (ie_atualiza_estoque_w = 'S') then 
		begin 
		if 	not(ie_local_valido_w = 'S') then 
			ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(279985);
		elsif	not(ie_estoque_disp_w = 'S') then 
			ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(279986);
		end if;
		end;
	end if;
	 
end if;
	 
ds_erro_p:= ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_palm_consistir_mat_lote ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, dt_entrada_unidade_p timestamp, cd_tipo_baixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

