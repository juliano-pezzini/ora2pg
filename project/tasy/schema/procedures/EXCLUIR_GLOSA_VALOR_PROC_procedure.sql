-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_glosa_valor_proc ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_status_acerto_w	smallint;
nr_sequencia_w		bigint;
nr_atendimento_w	bigint;


BEGIN 
 
/*select	nvl(min(nr_sequencia),0) 
into 	nr_sequencia_w 
from 	procedimento_paciente 
where 	(nr_atendimento, dt_entrada_unidade, cd_procedimento, trunc(dt_procedimento), cd_setor_atendimento) = 
	(select nr_atendimento, dt_entrada_unidade, cd_procedimento, trunc(dt_procedimento), cd_setor_atendimento 
	 from procedimento_paciente 
	 where nr_sequencia = nr_sequencia_p) 
and nr_sequencia 	<> nr_sequencia_p 
and qt_procedimento 	= 0;*/
 
 
nr_sequencia_w:= 0;
 
if (nr_sequencia_w = 0) then 
	 
	select 	coalesce(max(nr_atendimento),0) 
	into STRICT	nr_atendimento_w 
	from 	procedimento_paciente 
	where 	nr_sequencia = nr_sequencia_p;
	 
	select	coalesce(min(nr_sequencia),0) 
	into STRICT 	nr_sequencia_w 
	from 	procedimento_paciente 
	where 	nr_seq_proc_princ = 
		(SELECT nr_sequencia 
		from 	procedimento_paciente 
		where 	nr_sequencia = nr_sequencia_p) 
	and 	nr_sequencia 	<> nr_sequencia_p 
	and 	qt_procedimento 	= 0 
	and 	nr_atendimento = nr_atendimento_w;
 
end if;
 
if (nr_sequencia_w <> 0) then 
	select 	coalesce(max(b.ie_status_acerto),0) 
	into STRICT 	ie_status_acerto_w 
	from 	conta_paciente b, 
		procedimento_paciente a 
	where 	a.nr_interno_conta = b.nr_interno_conta 
	and 	a.nr_sequencia = nr_sequencia_w;
 
	if (ie_status_acerto_w = 1) then 
		delete FROM procedimento_paciente 
		where nr_sequencia = nr_sequencia_w;
		commit;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_glosa_valor_proc ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

