-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bloqueia_desbloqueia_captura (nr_prescricao_p bigint, nr_seq_prescricoes_p text, ie_opcao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_prescricao_w bigint;
cd_pessoa_fisica_w             bigint;
ds_possib_w                         varchar(6000);
qt_controle_w                       bigint;
qt_pos_separador_w            bigint;


BEGIN
  cd_pessoa_fisica_w := cd_pessoa_fisica_p;
  ds_possib_w             := nr_seq_prescricoes_p || ',';

  qt_controle_w      := 0;
  qt_pos_separador_w := position(',' in ds_possib_w);

  IF (qt_pos_separador_w = 0) THEN
    qt_pos_separador_w := -1;
  END IF;

  WHILE(qt_pos_separador_w >= 0)
  AND (qt_controle_w < 1000) LOOP
  BEGIN
    IF (qt_pos_separador_w = 0) THEN
      nr_sequencia_prescricao_w   := (ds_possib_w)::numeric;
      qt_pos_separador_w := -1;
    ELSE
      nr_sequencia_prescricao_w := (SUBSTR(ds_possib_w,1,qt_pos_separador_w-1))::numeric;
    END IF;

	  if (ie_opcao_p = 'B') then
	    INSERT INTO controle_captura_imagem(
				nr_sequencia,
				dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        cd_pessoa_fisica,
				nr_prescricao,
				nr_sequencia_prescricao)
		VALUES (nextval('controle_captura_imagem_seq'),
				clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        cd_pessoa_fisica_p,
        nr_prescricao_p,
				nr_sequencia_prescricao_w);
	  elsif (ie_opcao_p = 'D') then
      DELETE FROM controle_captura_imagem
	    WHERE nr_prescricao	= nr_prescricao_p
	    AND	   nr_sequencia_prescricao	= nr_sequencia_prescricao_w;
	  END IF;

	  IF (qt_pos_separador_w > 0) THEN
      ds_possib_w        := SUBSTR(ds_possib_w,qt_pos_separador_w+1,length(ds_possib_w));
      qt_pos_separador_w := position(',' in ds_possib_w);
    END IF;

    qt_controle_w := qt_controle_w + 1;

    END;
    END LOOP;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bloqueia_desbloqueia_captura (nr_prescricao_p bigint, nr_seq_prescricoes_p text, ie_opcao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

