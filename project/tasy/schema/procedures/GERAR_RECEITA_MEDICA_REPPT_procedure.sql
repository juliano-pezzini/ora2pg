-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_receita_medica_reppt ( cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
ds_masc_receita_w	varchar(255);
ds_receita_final_w	varchar(32000)	:= '';
ds_receita_parcial_w	varchar(32000);

 
ds_material_w		varchar(255);
qt_dose_w		double precision;
cd_unidade_medida_w	varchar(50);
ds_unidade_medida_w	varchar(50);
ie_via_aplicacao_w	varchar(50);
cd_intervalo_w		varchar(20);
ds_intervalo_w		varchar(80);
ds_fim_uso_w		varchar(100);
ds_observacao_w		varchar(255);

nr_atendimento_w	bigint;
ds_enter_padrao_w	varchar(20)	:= chr(13)||chr(10);
ds_enter_w		varchar(20)	:= ' \par\par ';

ds_cabecalho_w		varchar(1000);
ds_rodape_w		varchar(1);
ds_fonte_w		varchar(100);
ds_tam_fonte_w		varchar(10);
nr_tam_fonte_w		integer;
cd_estabelecimento_w	smallint;
nr_dias_uso_w		integer;
ds_via_aplicacao_w	varchar(80);
cd_pessoa_fisica_w	varchar(20);
qt_tamanho_w		bigint;
nr_prescricao_w		bigint;
nr_seq_material_w    bigint;
ds_horarios_w		varchar(2000);

c00 CURSOR FOR 
SELECT	nr_prescricao, 
	nr_seq_material 
from	REP_MEDICAMENTO_RECEITA 
where	nm_usuario	= nm_usuario_p 
order by nr_prescricao;

 
c01 CURSOR FOR 
	SELECT	substr(obter_desc_material(cd_material),1,255), 
		qt_dose, 
		cd_unidade_medida_dose, 
		ie_via_aplicacao, 
		cd_intervalo, 
		substr(obter_desc_intervalo_prescr(cd_intervalo),1,80), 
		substr(ds_observacao,1,255), 
		substr(obter_unidade_medida(cd_unidade_medida_dose),1,40), 
		substr(Obter_Via_Aplicacao(ie_via_aplicacao,'D'),1,70), 
		substr(ds_horarios,1,2000) 
	from	prescr_material 
	where	nr_prescricao	 = nr_prescricao_w 
	and	nr_sequencia = nr_seq_material_w 
	and	coalesce(dt_suspensao::text, '') = '' 
	order by 1;	
 

BEGIN 
 
if (nr_seq_formatacao_p = 0) then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277528);
elsif (coalesce(ie_tipo_receita_p::text, '') = '') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277530);
elsif (coalesce(cd_profissional_p::text, '') = '') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277535);
elsif (obter_se_medico(cd_profissional_p, 'M') = 'N') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277536);
else 
	/* seleciona a formatação da receita médica */
 
	select	ds_receita 
	into STRICT	ds_masc_receita_w 
	from	medic_mascara_receita 
	where	nr_sequencia	= nr_seq_formatacao_p;
	 
 
	 
	open C00;
	loop 
	fetch C00 into	 
	    nr_prescricao_w, 
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
	begin 
		 
	 
	 
		/* leitura dos medicamentos e geração da receita */
 
		open c01;
		loop 
		fetch c01 into 
			ds_material_w, 
			qt_dose_w, 
			cd_unidade_medida_w, 
			ie_via_aplicacao_w, 
			cd_intervalo_w, 
			ds_intervalo_w, 
			ds_observacao_w, 
			ds_unidade_medida_w, 
			ds_via_aplicacao_w, 
			ds_horarios_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			 
			ds_receita_parcial_w	:= ds_masc_receita_w;
			 
			if (position('{' in ds_material_w) > 0) or (position('}' in ds_material_w) > 0) then 
				ds_material_w := replace(ds_material_w,'{','#$');
				ds_material_w := replace(ds_material_w,'}','$#');
			end if;		
			 
			select	retorna_medic_formatado(ds_receita_parcial_w,'@Medicamento',ds_material_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@Dose',qt_dose_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsUnidMedDose',ds_unidade_medida_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@UnidMedDose',cd_unidade_medida_w) 
			into STRICT	ds_receita_parcial_w 
			;		
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsViaAplicacao',ds_via_aplicacao_w) 
			into STRICT	ds_receita_parcial_w 
			;		
			select	retorna_medic_formatado(ds_receita_parcial_w,'@ViaAplicacao',ie_via_aplicacao_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@IntervaloAdm',cd_intervalo_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@FimUtilizacao','') 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DscIntervaloAdm',ds_intervalo_w) 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DiasUtil','') 
			into STRICT	ds_receita_parcial_w 
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@Observacao',ds_observacao_w) 
			into STRICT	ds_receita_parcial_w 
			;
 
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsHorarios',ds_horarios_w) 
			into STRICT	ds_receita_parcial_w 
			;
 
			select	coalesce(length(ds_receita_final_w),0) + coalesce(length(ds_receita_parcial_w),0) + coalesce(length(ds_enter_w),0) 
			into STRICT	qt_tamanho_w 
			;
			 
			if (qt_tamanho_w < 4000) then 
				ds_receita_final_w	:= ds_receita_final_w || ds_receita_parcial_w || ds_enter_w;
			end if;	
			 
			if (position('#$' in ds_receita_final_w) > 0) or (position('$#' in ds_receita_final_w) > 0) then 
				ds_receita_final_w := replace(ds_receita_final_w,'#$','{');
				ds_receita_final_w := replace(ds_receita_final_w,'$#','}');
			end if;
			 
			end;
		end loop;
		close c01;
	end;
	end loop;
	close C00;	
	 
	select 	cd_pessoa_fisica 
	into STRICT	cd_pessoa_fisica_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_w;
 
	if (nr_atendimento_p > 0) then 
		nr_atendimento_w := nr_atendimento_p;
	else 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_w 
		from  	atendimento_paciente 
		where 	cd_pessoa_fisica	= cd_pessoa_fisica_w 
		and	ie_fim_conta		<> 'F' 
		and	coalesce(dt_alta::text, '') = '';
	end if;
	 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_w;
	 
	ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
	ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_tam_fonte_w);
	 
 	nr_tam_fonte_w	:= somente_numero(ds_tam_fonte_w)*2;
  
	ds_cabecalho_w	:= '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '||ds_fonte_w||';}}'|| 
			  '{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'||nr_tam_fonte_w||' ';
			   
	ds_rodape_w	:= '}';
	ds_receita_final_w	:= substr(replace(ds_receita_final_w, ds_enter_padrao_w, ' \par '),1,32000);
	ds_receita_final_w	:= substr(ds_cabecalho_w||ds_receita_final_w||ds_rodape_w,1,32000);
	 
	insert into med_receita( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_receita, 
		ds_receita, 
		cd_pessoa_fisica, 
		cd_medico, 
		ie_tipo_receita, 
		nr_atendimento_hosp, 
		ie_situacao, 
		nr_prescricao 
	) values ( 
		nextval('med_receita_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		dt_receita_p, 
		ds_receita_final_w, 
		cd_pessoa_fisica_w, 
		cd_profissional_p, 
		ie_tipo_receita_p, 
		nr_atendimento_w, 
		'A', 
		nr_prescricao_w);
	end if;
 
 
delete	from rep_medicamento_receita 
where	nm_usuario	= nm_usuario_p;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_receita_medica_reppt ( cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

