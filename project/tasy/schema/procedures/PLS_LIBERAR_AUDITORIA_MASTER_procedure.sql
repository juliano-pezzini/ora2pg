-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_auditoria_master ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_item_pendente_p INOUT text) AS $body$
DECLARE



cd_pessoa_fisica_w		varchar(14);
qt_liberacao_w			bigint;
nr_seq_grupo_w			bigint;
qt_grupo_w			integer;
qt_item_pendente_w		integer;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
ds_liberar_parecer_w		varchar(1);
ds_liberar_parecer_auditor_w	varchar(1);
nr_seq_auditoria_item_w		bigint;
nr_seq_grupo_auditor_w		bigint;
qt_parecer_w			integer;
ie_tipo_item_w			varchar(1);
ie_parecer_auditor_item_w	varchar(1);
nr_seq_item_origem_w		bigint;
ie_envia_email_aud_externo_w	varchar(2);
ie_tipo_processo_w		varchar(2);
nr_seq_execucao_w		bigint;
ie_exige_senha_ext_w		varchar(2);
ie_tipo_auditoria_w		smallint;
ie_encerrar_analise_grupos_w	varchar(1);
ie_existe_item_pendente_w	varchar(1) := 'N';
nr_seq_historico_aud_w		bigint;
ie_utiliza_nivel_lib_w		varchar(10);
ie_regra_despesa_w		varchar(1);
ie_tipo_despesa_w		varchar(10);	
ie_possui_nivel_lib_w		varchar(1)	:= 'S';
ie_parecer_w			varchar(1) := 'S';
dt_ult_parecer_dia_w 		varchar(255);
dt_ult_parecer_hora_w 		varchar(255);
dt_atual_grupo_hora_w		varchar(255);
dt_atual_grupo_dia_w		varchar(255);
qt_original_w			double precision;
qt_ajuste_w			double precision;
ds_observacao_w			varchar(4000);
ie_inserir_parecer_glosa_w	varchar(1)	:= 'N';
ie_status_w			pls_auditoria_item.ie_status%type;
qt_itens_aut_w			integer := 0;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status_solicitacao	= 'P';	
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_status
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p;
	
C04 CURSOR FOR	
	SELECT	nr_sequencia,
		ie_tipo_despesa,
		CASE WHEN coalesce(cd_procedimento::text, '') = '' THEN  'M'  ELSE 'P' END ,
		qt_original,
		qt_ajuste
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status_solicitacao	= 'P'
	and	((coalesce(ie_acao_auditor::text, '') = '') or (ie_acao_auditor <> 'E'));	
	

BEGIN
select	coalesce(pls_obter_grupo_analise_atual(nr_seq_auditoria_p),0)
into STRICT	nr_seq_grupo_w
;

ie_inserir_parecer_glosa_w	:= obter_valor_param_usuario(1270, 77, Obter_Perfil_Ativo, nm_usuario_p, 0);

select	nr_seq_guia,
	nr_seq_requisicao,
	nr_seq_execucao
into STRICT	nr_seq_guia_w,
	nr_seq_requisicao_w,
	nr_seq_execucao_w
from	pls_auditoria
where	nr_sequencia	= nr_seq_auditoria_p;

select	nr_seq_grupo
into STRICT	nr_seq_grupo_auditor_w
from	pls_auditoria_grupo
where	nr_sequencia = nr_seq_grupo_w;

begin
	select	ie_tipo_auditoria
	into STRICT	ie_tipo_auditoria_w
	from	pls_grupo_auditor
	where	nr_sequencia	= nr_seq_grupo_auditor_w;
exception
when others then
	ie_tipo_auditoria_w	:= 0;
end;

ie_utiliza_nivel_lib_w	:= pls_obter_se_uti_nivel_lib_aut(obter_estabelecimento_ativo);

/* Verificar o parâmetro [5] */

if (ds_liberar_parecer_w = 'N') and (ie_tipo_auditoria_w <> 3) then
	
	if (coalesce(nr_seq_guia_w,0) > 0) then
		open C04;
		loop
		fetch C04 into
			nr_seq_auditoria_item_w,
			ie_tipo_despesa_w,
			ie_tipo_item_w,
			qt_original_w,
			qt_ajuste_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			ie_regra_despesa_w	:= pls_obter_se_regra_despesa_aud(	ie_tipo_despesa_w,
											ie_tipo_item_w,
											nr_seq_grupo_auditor_w);

			if (ie_utiliza_nivel_lib_w	= 'S') then
				ie_possui_nivel_lib_w	:= pls_obter_se_auditor_nivel_lib(	nr_seq_auditoria_p,
												nr_seq_auditoria_item_w,
												nr_seq_grupo_auditor_w,
												nm_usuario_p,
												'N');
			end if;

			if (ie_regra_despesa_w = 'S') and (ie_possui_nivel_lib_w = 'S') then
				select	count(1)
				into STRICT	qt_parecer_w
				from	pls_guia_plano_historico
				where (ie_tipo_historico = 'AP'
				or	ie_tipo_historico = 'AM')
				and	nr_seq_grupo	= nr_seq_grupo_auditor_w
				and	nr_Seq_item	= nr_seq_auditoria_item_w;

				Select 	to_char(min(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(min(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_atual_grupo_dia_w,
					dt_atual_grupo_hora_w
				From	Pls_Auditoria_Grupo
				Where	Nr_Seq_Grupo 		= nr_seq_grupo_auditor_w
				And	coalesce(Dt_Liberacao::text, '') = ''
				And	Nr_Seq_Auditoria 	= nr_seq_auditoria_p
				and	nm_usuario_exec		= nm_usuario_p;

				Select	to_char(max(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(max(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_ult_parecer_dia_w,
					dt_ult_parecer_hora_w
				From	Pls_Guia_Plano_Historico
				Where (Ie_Tipo_Historico = 'AP'
				Or	Ie_Tipo_Historico = 'AM')
				And	Nr_Seq_Grupo	= nr_seq_grupo_auditor_w
				And	Nr_Seq_Item	= nr_seq_auditoria_item_w;

				if (qt_parecer_w = 0) or (to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') > to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) or
					((to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') = to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) and (to_date(dt_atual_grupo_hora_w, 'HH24:MI:SS') > to_date(dt_ult_parecer_hora_w, 'HH24:MI:SS'))) then

					ie_parecer_w	:= 'N';
					exit;
				end if;	
			end if;
			end;
		end loop;
		close C04;
		
	elsif (coalesce(nr_seq_requisicao_w, 0) > 0) then
		open C04;
		loop
		fetch C04 into
			nr_seq_auditoria_item_w,
			ie_tipo_despesa_w,
			ie_tipo_item_w,
			qt_original_w,
			qt_ajuste_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			if (ie_utiliza_nivel_lib_w	= 'S') then
				ie_possui_nivel_lib_w	:= pls_obter_se_auditor_nivel_lib(	nr_seq_auditoria_p,
												nr_seq_auditoria_item_w,
												nr_seq_grupo_auditor_w,
												nm_usuario_p,
												'N');
			end if;
			
			if (ie_possui_nivel_lib_w = 'S') then
				select	count(1)
				into STRICT	qt_parecer_w
				from	pls_requisicao_historico
				where (ie_tipo_historico = 'AP'
				or	ie_tipo_historico = 'AM')
				and	nr_seq_grupo	= nr_seq_grupo_auditor_w
				and	nr_Seq_item	= nr_seq_auditoria_item_w;

				if (qt_parecer_w = 0) then
					ie_parecer_w	:= 'N';
					exit;
				end if;
			end if;
			end;
		end loop;
		close C04;
	end if;
end if;	

if (ie_utiliza_nivel_lib_w	= 'S') and (ie_tipo_auditoria_w <> 4) then
	ie_possui_nivel_lib_w	:= pls_obter_se_auditor_nivel_lib(	nr_seq_auditoria_p,
									null,
									nr_seq_grupo_auditor_w,
									nm_usuario_p,
									'S');

	if (ie_possui_nivel_lib_w = 'N') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(318988,'');
		--'Você não pode encerrar totalmente a análise pois você não possui nível de liberação. '
	end if;
end if;

if (ie_parecer_w = 'S') then
	select	count(*)
	into STRICT	qt_item_pendente_w
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status in ('P','J');

	if (qt_item_pendente_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191622,'');
		--'Você não pode encerrar totalmente a análise enquanto houver algum item pendente ou aguardando justificativa! '
	end if;

	update	pls_auditoria_grupo
	set	dt_liberacao	= clock_timestamp(),
		ie_status	= 'P',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_seq_auditoria = nr_seq_auditoria_p
	and	coalesce(dt_liberacao::text, '') = '';

	select	count(*)
	into STRICT	qt_liberacao_w
	from	pls_auditoria_grupo
	where	coalesce(dt_liberacao::text, '') = ''
	and	nr_seq_auditoria = nr_seq_auditoria_p;

	if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
		select	ie_tipo_processo
		into STRICT	ie_tipo_processo_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	end if;

	if (qt_liberacao_w = 0) then
		update	pls_auditoria
		set	dt_liberacao	= clock_timestamp(),
			ie_status	= 'F',
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_auditoria_p;	

		/* OS 482469 - Realizado o tratamento abaixo para setar ao campo ie_auditor_finaliza o valor "S", sendo utilizado para saber qual foi o ultimo histórico gerado para o item da análise */

		if (coalesce(nr_seq_guia_w,0) > 0) then
			open C02;
			loop
			fetch C02 into	
				nr_seq_auditoria_item_w,
				ie_status_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				select	max(nr_sequencia)
				into STRICT	nr_seq_historico_aud_w
				from	pls_guia_plano_historico
				where	ie_tipo_historico in ('AP','AM')
				and	nr_seq_item	= nr_seq_auditoria_item_w;
				
				if (coalesce(nr_seq_historico_aud_w,0) > 0) then
					update	pls_guia_plano_historico
					set	ie_auditor_finaliza = 'S'
					where	nr_sequencia = nr_seq_historico_aud_w;
					
					if (ie_inserir_parecer_glosa_w = 'S') and (ie_status_w = 'N') then								
						select	substr(ds_observacao,position('-' in ds_observacao)+2,3800)
						into STRICT	ds_observacao_w
						from	pls_guia_plano_historico
						where	nr_sequencia	= nr_seq_historico_aud_w;
								
						update	pls_auditoria_item
						set	ds_observacao_glosa	= ds_observacao_w
						where	nr_sequencia		= nr_seq_auditoria_item_w;
					end if;
				end if;
				end;
			end loop;
			close C02;
		elsif (coalesce(nr_seq_requisicao_w,0) > 0) then
			open C02;
			loop
			fetch C02 into	
				nr_seq_auditoria_item_w,
				ie_status_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				select	max(nr_sequencia)
				into STRICT	nr_seq_historico_aud_w
				from	pls_requisicao_historico
				where	ie_tipo_historico in ('AP','AM')
				and	nr_seq_item	= nr_seq_auditoria_item_w;
				
				if (coalesce(nr_seq_historico_aud_w,0) > 0) then
					update	pls_requisicao_historico
					set	ie_auditor_finaliza = 'S'
					where	nr_sequencia = nr_seq_historico_aud_w;
					
					if (ie_inserir_parecer_glosa_w = 'S') and (ie_status_w = 'N') then								
						select	substr(ds_historico,position('-' in ds_historico)+2,3800)
						into STRICT	ds_observacao_w
						from	pls_requisicao_historico
						where	nr_sequencia	= nr_seq_historico_aud_w;
						
						update	pls_auditoria_item
						set	ds_observacao_glosa	= ds_observacao_w
						where	nr_sequencia		= nr_seq_auditoria_item_w;
					end if;
				end if;
				end;
			end loop;
			close C02;
		end if;
		
		if (coalesce(nr_seq_guia_w,0) > 0) then
			CALL pls_atualizar_guia_liberada( nr_seq_auditoria_p, nm_usuario_p);
			
			/*if	(ie_tipo_processo_w	= 'I')  then		
				pls_insere_paracer_guia_int(nr_seq_guia_w, nm_usuario_p);
			end if;*/
		elsif (coalesce(nr_seq_requisicao_w,0) > 0) then
		
			select	count(1)
			into STRICT	qt_itens_aut_w
			from	pls_auditoria_item
			where	nr_seq_auditoria	= nr_seq_auditoria_p
			and	ie_status		= 'A';

			if (qt_itens_aut_w > 0) then
				ie_exige_senha_ext_w	:= pls_obter_se_exige_senha_ext(null, nr_seq_requisicao_w);
			else	
				ie_exige_senha_ext_w	:= 'N';
			end if;
			
			if (ie_exige_senha_ext_w	= 'S') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(177258,'');
				--'Esta requisição necessita de senha externa para ser liberada !');
			else
				CALL pls_atualizar_req_liberada( nr_seq_auditoria_p, nm_usuario_p);
			end if;
		elsif (coalesce(nr_seq_execucao_w,0) > 0) then
			CALL pls_atualizar_exec_liberada(nr_seq_auditoria_p, nm_usuario_p);
		end if;	
		CALL pls_gerar_alerta_evento(1,nr_seq_auditoria_p,null,null,nm_usuario_p);
		
		-- Retirada a chamada para gerar a ordem de compra, conforme solicitação da Unimed Maringá na OS 977328

		--pls_gerar_ordem_compra_cotacao(	nr_seq_auditoria_p, obter_estabelecimento_ativo, nm_usuario_p);
		
	elsif (qt_liberacao_w > 0) and (coalesce(nr_seq_guia_w,0) > 0) then
		ie_envia_email_aud_externo_w := obter_valor_param_usuario(1270, 12, Obter_Perfil_Ativo, nm_usuario_p, 0);
				
		if (ie_tipo_processo_w	<> 'P') and (ie_envia_email_aud_externo_w	= 'S') then
			CALL pls_gerar_email_aud_externo(nr_seq_auditoria_p, nm_usuario_p);
		end if;
	end if;
elsif (ie_parecer_w = 'N') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(177259,'');
	/*'Você não pode encerrar a análise enquanto não informar pelo menos um parecer para cada item, '||
					'que tenha o status de solicitação como pendente. Verificar o  parâmetro[5]! '||'#@#@');*/
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_auditoria_master ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_item_pendente_p INOUT text) FROM PUBLIC;

