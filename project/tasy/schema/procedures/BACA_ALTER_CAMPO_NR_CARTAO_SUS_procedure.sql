-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_alter_campo_nr_cartao_sus () AS $body$
DECLARE



qt_existe_w	bigint;

BEGIN
/*Testar se já é varchar2, não precisa fazer a alteração*/

select	count(*)
into STRICT	qt_existe_w
from	user_tab_columns
where	table_name 	= 'PESSOA_FISICA'
and	column_name 	= 'NR_CARTAO_NAC_SUS'
and	data_type		= 'VARCHAR2';

if (qt_existe_w = 0) then
	begin
	/*Testar se existe registros no campo, se não existir, o sincronizar já alterará para varchar2*/

	select	count(*)
	into STRICT	qt_existe_w
	from	pessoa_fisica
	where	(nr_cartao_nac_sus IS NOT NULL AND nr_cartao_nac_sus::text <> '');

	if (qt_existe_w > 0) then
		begin
		CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');

		CALL exec_sql_dinamico('Anderson', 'alter table pessoa_fisica rename column nr_cartao_nac_sus to nr_cartao_nac_sus_ant');
		CALL exec_sql_dinamico('Anderson', 'alter table pessoa_fisica add nr_cartao_nac_sus2 varchar2(20)');
		CALL exec_sql_dinamico('Anderson', 'alter table pessoa_fisica rename column nr_cartao_nac_sus2 to nr_cartao_nac_sus');
		CALL exec_sql_dinamico('Anderson', 'update pessoa_fisica set nr_cartao_nac_sus = nr_cartao_nac_sus_ant where nr_cartao_nac_sus_ant is not null');

		CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');
		end;
	end if;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_alter_campo_nr_cartao_sus () FROM PUBLIC;

