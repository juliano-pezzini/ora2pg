-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_acomod_quimio_html5 ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_acomodacao_p bigint, dt_prevista_p timestamp, dt_real_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


ie_registra_chegada_w	varchar(1);
ie_acomod_todos_pac_w	varchar(1);
ie_acomodacao_w		varchar(1);
ie_param_60_w		varchar(1);
ds_texto_w		varchar(255);

ie_controla_acomodacao	varchar(1);


BEGIN

/* Quimioterapia - Parâmetro [60] - Ao definir acomodação consistir se o local já está alocado para outro paciente */

ie_param_60_w := obter_param_usuario(3130, 60, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param_60_w);

if (ie_param_60_w <> 'N') then
	begin
	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_acomodacao_w
	from	paciente_atendimento
	where	coalesce(dt_fim_adm::text, '') = ''
	and	coalesce(dt_real, dt_prevista) between trunc(clock_timestamp()) and fim_dia(clock_timestamp())
	and	nr_seq_local	= cd_acomodacao_p
	and	nr_seq_atendimento	<> nr_seq_paciente_p;

select coalesce(max(obter_se_controla_acomodacao(cd_acomodacao_p)),'S') into STRICT ie_controla_acomodacao;


	if	(ie_acomodacao_w = 'S' AND ie_controla_acomodacao ='S')  then
		begin
		ds_texto_w	:= substr(obter_texto_dic_objeto(59642, wheb_usuario_pck.get_nr_seq_idioma, 'cd_acomodacao='||cd_acomodacao_p),1,255);

		if (ie_param_60_w = 'A') then
			ds_msg_p	:= ds_texto_w;
		elsif (ie_param_60_w = 'S') then
			begin
			  ds_erro_p	:= ds_texto_w;
			end;
		end if;
		end;

	end if;
	end;
end if;

/* Quimioterapia - Parâmetro [83] - Ao definir acomodação registrar chegada do paciente */

ie_registra_chegada_w := obter_param_usuario(3130, 83, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_registra_chegada_w);

if (coalesce(ds_erro_p::text, '') = '') then
/* Quimioterapia - Parâmetro [73] - Vincula os agendamentos diários do paciente ao acomodar o paciente. */

	ie_acomod_todos_pac_w := obter_param_usuario(3130, 73, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_acomod_todos_pac_w);
end if;
	if (ie_acomod_todos_pac_w = 'S') then -- N
		begin
			update	paciente_atendimento
			set	nr_seq_local		= cd_acomodacao_p,
				dt_acomodacao_paciente	= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				dt_chegada		= coalesce(dt_chegada, clock_timestamp())
			where	obter_dados_paciente_setor(nr_seq_paciente, 'C')	= obter_dados_paciente_setor(nr_seq_paciente_p, 'C')
			and	dt_prevista		= dt_prevista_p;
			end;
	elsif (ie_acomod_todos_pac_w = 'R') then
		begin
		update	paciente_atendimento
		set	nr_seq_local		= cd_acomodacao_p,
			dt_acomodacao_paciente	= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			dt_chegada		= coalesce(dt_chegada, clock_timestamp())
		where	obter_dados_paciente_setor(nr_seq_paciente, 'C')	= obter_dados_paciente_setor(nr_seq_paciente_p, 'C')
		and	dt_real		= dt_real_p;
		end;
	else
    begin
			update	paciente_atendimento
			set	nr_seq_local		= cd_acomodacao_p,
				dt_acomodacao_paciente	= clock_timestamp(),
        dt_chegada = coalesce(dt_chegada,clock_timestamp()),
				nm_usuario		= nm_usuario_p
			where	nr_seq_atendimento		= nr_seq_atendimento_p;
			end;
		end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_acomod_quimio_html5 ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_acomodacao_p bigint, dt_prevista_p timestamp, dt_real_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

