-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_repasse_rec_caixa ( nr_seq_caixa_rec_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE



nr_interno_conta_w		bigint	:= null;
nr_seq_protocolo_w		bigint	:= null;
nr_seq_movto_cartao_w		bigint;
nr_seq_trans_troco_w		bigint;
ie_repasse_especie_w		varchar(1);
ie_repasse_cartao_w		varchar(1);
ie_repasse_adiant_w		varchar(1);
vl_especie_w			double precision;
vl_cartao_w			double precision;
cont_w				integer;
vl_total_recebido_w		double precision;
vl_recebido_w			double precision;
pr_proporcional_w		double precision;
vl_proporcional_w		double precision;
vl_troco_w			double precision;
cd_estabelecimento_w		smallint;
dt_fechamento_w			timestamp;
vl_outros_receb_w		double precision;
vl_total_monetario_w		double precision;
ie_desp_repasse_cartao_w	varchar(1);
vl_cartao_despesa_w		double precision;
vl_cheque_w			double precision;
IE_LIB_REP_TIT_CHEQUE_w		varchar(1);
ie_gerar_estorno_recebido_w	varchar(1);
ie_juros_multa_w		varchar(1);
ie_gerou_repasse_w		varchar(1);
vl_proporcional_imposto_w	double precision;
vl_adiantamento_w 		double precision;
nr_seq_parcela_w		movto_cartao_cr_baixa.nr_seq_parcela%type;
nr_seq_forma_pagto_w		forma_pagto_regra.nr_sequencia%type;


/* Contas */

c01 CURSOR FOR
SELECT	b.nr_interno_conta,
	b.nr_seq_protocolo,
	coalesce(sum(a.vl_recebido),0)
from	titulo_receber b,
	titulo_receber_liq a
where	a.nr_titulo		= b.nr_titulo
and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
group by
	b.nr_interno_conta,
	b.nr_seq_protocolo;


BEGIN

ie_gerou_repasse_w	:= 'N';
select	count(*),
	max(b.cd_estabelecimento)
into STRICT	cont_w,
	cd_estabelecimento_w
from	titulo_receber b,
	titulo_receber_liq a
where	a.nr_titulo		= b.nr_titulo
and	a.nr_seq_caixa_rec	= coalesce(nr_seq_caixa_rec_p,0);

ie_gerar_estorno_recebido_w := obter_param_usuario(813, 166, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_estorno_recebido_w);
ie_juros_multa_w := obter_param_usuario(813, 179, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_juros_multa_w);

if (nr_seq_caixa_rec_p IS NOT NULL AND nr_seq_caixa_rec_p::text <> '') and (cont_w > 0) then

	select	coalesce(max(ie_repasse_especie),'N'),
		coalesce(max(ie_repasse_cartao),'N'),
		coalesce(max(ie_repasse_adiant),'N')
	into STRICT	ie_repasse_especie_w,
		ie_repasse_cartao_w,
		ie_repasse_adiant_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	coalesce(max(a.IE_LIB_REP_TIT_CHEQUE),'N')
	into STRICT	IE_LIB_REP_TIT_CHEQUE_w
	from	parametro_faturamento a
	where	a.cd_estabelecimento	= cd_estabelecimento_w;

	select	max(nr_seq_trans_troco)
	into STRICT	nr_seq_trans_troco_w
	from	parametro_tesouraria
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	coalesce(sum(vl_recebido),0)
	into STRICT	vl_total_recebido_w
	from	titulo_receber_liq
	where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

	/*wmvieira*/

	if (ie_repasse_adiant_w = 'S') then

		select	coalesce(sum(vl_transacao),0)
		into STRICT	vl_troco_w
		from	movto_trans_financ
		where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	nr_seq_trans_financ	= nr_seq_trans_troco_w;

		select	dt_fechamento
		into STRICT	dt_fechamento_w
		from	caixa_receb
		where	nr_sequencia	= nr_seq_caixa_rec_p;

		select	coalesce(sum(a.vl_transacao),0)
		into STRICT	vl_outros_receb_w
		from	transacao_financeira b,
			movto_trans_financ a
		where	a.nr_seq_trans_financ	= b.nr_sequencia
		and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	b.ie_acao		= 0
		and	b.ie_caixa		= 'D'
		and	a.dt_transacao		< dt_fechamento_w;

		select	coalesce(sum(vl_adiantamento),0)
		into STRICT	vl_adiantamento_w
		from	adiantamento
		where	nr_seq_caixa_rec 	= nr_seq_caixa_rec_p;

		if (coalesce(ie_juros_multa_w,'S')	= 'N') then
			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VTJM'),0);
		else
			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VT'),0);
		end if;
		vl_troco_w		:= dividir_sem_round(vl_adiantamento_w,vl_total_monetario_w) * vl_troco_w;
		vl_outros_receb_w	:= dividir_sem_round(vl_adiantamento_w,vl_total_monetario_w) * vl_outros_receb_w;
		vl_adiantamento_w	:= coalesce(vl_adiantamento_w,0) - coalesce(vl_troco_w,0) - coalesce(vl_outros_receb_w,0); /* Francisco - OS 184395 - 17/12/09 Tem que descontar os outros recebimentos*/
		if (vl_adiantamento_w > 0) then

			pr_proporcional_w	:= dividir_sem_round(vl_adiantamento_w * 100,vl_total_recebido_w);

			open c01;
			loop
			fetch c01 into
				nr_interno_conta_w,
				nr_seq_protocolo_w,
				vl_recebido_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				if (ie_opcao_p	= 'E') and (coalesce(ie_gerar_estorno_recebido_w,'N') = 'S') then
					CALL estornar_repasse_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
					/*if	(nvl(ie_gerou_repasse_w,'N') = 'N') then
						Recalcular_Conta_Repasse(nr_interno_conta_w,null,null,nm_usuario_p,null);
						--Gerar_repasse_est_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
						ie_gerou_repasse_w	:= 'S';
					end if;	*/
				else
					if (pr_proporcional_w <> 0) then
						vl_proporcional_imposto_w	:= dividir_sem_round((obter_valor_conta_imposto(nr_interno_conta_w, '3') * pr_proporcional_w)::numeric,100);
						vl_proporcional_w		:= dividir_sem_round((vl_recebido_w * pr_proporcional_w)::numeric,100);

						CALL atualizar_repasse_valor(nr_seq_protocolo_w,nr_interno_conta_w,vl_proporcional_w - vl_proporcional_imposto_w,nm_usuario_p,null,null);
					end if;
				end if;
			end loop;
			close c01;

		end if;
	end if;

	if (ie_repasse_especie_w = 'R') then

		select	coalesce(sum(vl_transacao),0)
		into STRICT	vl_troco_w
		from	movto_trans_financ
		where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	nr_seq_trans_financ	= nr_seq_trans_troco_w;

		select	dt_fechamento
		into STRICT	dt_fechamento_w
		from	caixa_receb
		where	nr_sequencia	= nr_seq_caixa_rec_p;

		select	coalesce(sum(a.vl_transacao),0)
		into STRICT	vl_outros_receb_w
		from	transacao_financeira b,
			movto_trans_financ a
		where	a.nr_seq_trans_financ	= b.nr_sequencia
		and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	b.ie_acao		= 0
		and	b.ie_caixa		= 'D'
		and	a.dt_transacao		< dt_fechamento_w;

		select	coalesce(vl_especie,0)
		into STRICT	vl_especie_w
		from	caixa_receb
		where	nr_sequencia		= nr_seq_caixa_rec_p;

		if (coalesce(ie_juros_multa_w,'S')	= 'N') then

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VTJM'),0);

		else

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VT'),0);

		end if;

		vl_troco_w		:= dividir_sem_round(vl_especie_w,vl_total_monetario_w) * vl_troco_w;

		vl_outros_receb_w		:= dividir_sem_round(vl_especie_w,vl_total_monetario_w) * vl_outros_receb_w;

		vl_especie_w		:= coalesce(vl_especie_w,0) - coalesce(vl_troco_w,0) - coalesce(vl_outros_receb_w,0); /* Francisco - OS 184395 - 17/12/09 Tem que descontar os outros recebimentos*/
		if (vl_especie_w > 0) then

			pr_proporcional_w	:= dividir_sem_round(vl_especie_w * 100,vl_total_recebido_w);

			open c01;
			loop
			fetch c01 into
				nr_interno_conta_w,
				nr_seq_protocolo_w,
				vl_recebido_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				if (ie_opcao_p	= 'E') and (coalesce(ie_gerar_estorno_recebido_w,'N') = 'S') then
					CALL estornar_repasse_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
					/*if	(nvl(ie_gerou_repasse_w,'N') = 'N') then
						Recalcular_Conta_Repasse(nr_interno_conta_w,null,null,nm_usuario_p,null);
						--Gerar_repasse_est_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
						ie_gerou_repasse_w	:= 'S';
					end if;*/
				else
					if (pr_proporcional_w <> 0) then
						vl_proporcional_imposto_w	:= dividir_sem_round((obter_valor_conta_imposto(nr_interno_conta_w, '3') * pr_proporcional_w)::numeric,100);
						vl_proporcional_w		:= dividir_sem_round((vl_recebido_w * pr_proporcional_w)::numeric,100);

						CALL atualizar_repasse_valor(nr_seq_protocolo_w,nr_interno_conta_w,vl_proporcional_w - vl_proporcional_imposto_w,nm_usuario_p,null,null);
					end if;
				end if;
			end loop;
			close c01;

		end if;
	end if;

	if (ie_repasse_cartao_w = 'R') then

		select	coalesce(sum(vl_transacao),0)
		into STRICT	vl_troco_w
		from	movto_trans_financ
		where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	nr_seq_trans_financ	= nr_seq_trans_troco_w;

		select	dt_fechamento
		into STRICT	dt_fechamento_w
		from	caixa_receb
		where	nr_sequencia	= nr_seq_caixa_rec_p;

		select	coalesce(sum(a.vl_transacao),0)
		into STRICT	vl_outros_receb_w
		from	transacao_financeira b,
			movto_trans_financ a
		where	a.nr_seq_trans_financ	= b.nr_sequencia
		and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	b.ie_acao		= 0
		and	b.ie_caixa		= 'D'
		and	a.dt_transacao		< dt_fechamento_w;

		select	coalesce(sum(a.vl_transacao),0),
			coalesce(sum(b.vl_despesa),0)
		into STRICT	vl_cartao_w,
			vl_cartao_despesa_w
		FROM movto_cartao_cr a
LEFT OUTER JOIN movto_cartao_cr_baixa b ON (a.nr_sequencia = b.nr_seq_movto)
WHERE a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

		begin
		select	b.nr_seq_parcela
		into STRICT	nr_seq_parcela_w
		from	movto_cartao_cr_baixa b,
			movto_cartao_cr a
		where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	a.nr_sequencia		= b.nr_seq_movto;
		exception
		when others then
			nr_seq_parcela_w	:= null;
		end;

		select	coalesce(max(ie_desp_repasse_cartao),'S')
		into STRICT	ie_desp_repasse_cartao_w
		from	parametro_faturamento
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (ie_desp_repasse_cartao_w = 'S') then
			vl_cartao_w	:= vl_cartao_w + vl_cartao_despesa_w;
		elsif (ie_desp_repasse_cartao_w = 'D') then

			begin
			select	obter_forma_pagto_regra_cartao(a.nr_sequencia)
			into STRICT	nr_seq_forma_pagto_w
			from	movto_cartao_cr a
			where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;
			exception
			when others then
				nr_seq_forma_pagto_w := null;
			end;

			begin
			select	tx_administracao
			into STRICT	vl_cartao_despesa_w
			from	forma_pagto_regra
			where	nr_sequencia = nr_seq_forma_pagto_w;
			exception
			when others then
				vl_cartao_despesa_w := 0;
			end;

			vl_cartao_w	:= vl_cartao_w - (vl_cartao_w * dividir_sem_round((vl_cartao_despesa_w)::numeric,100));

		end if;

		if (coalesce(ie_juros_multa_w,'S')	= 'N') then

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VTJM'),0);

		else

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VT'),0);

		end if;


		vl_troco_w		:= dividir_sem_round(vl_cartao_w,vl_total_monetario_w) * vl_troco_w;

		vl_outros_receb_w	:= dividir_sem_round(vl_cartao_w,vl_total_monetario_w) * vl_outros_receb_w;

		vl_cartao_w	:= coalesce(vl_cartao_w,0) - coalesce(vl_troco_w,0) - coalesce(vl_outros_receb_w,0); /* Francisco - OS 184395 - 17/12/09 Tem que descontar os outros recebimentos*/
		if (vl_cartao_w > 0) then

			pr_proporcional_w	:= dividir_sem_round(vl_cartao_w * 100,vl_total_recebido_w);

			open c01;
			loop
			fetch c01 into
				nr_interno_conta_w,
				nr_seq_protocolo_w,
				vl_recebido_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				if (ie_opcao_p	= 'E') and (coalesce(ie_gerar_estorno_recebido_w,'N') = 'S') then
					CALL estornar_repasse_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
					/*if	(nvl(ie_gerou_repasse_w,'N') = 'N') then
						Recalcular_Conta_Repasse(nr_interno_conta_w,null,null,nm_usuario_p,null);
						--Gerar_repasse_est_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
						ie_gerou_repasse_w	:= 'S';
					end if;	*/
				else
					if (pr_proporcional_w <> 0) then
						vl_proporcional_imposto_w	:= dividir_sem_round((obter_valor_conta_imposto(nr_interno_conta_w, '3') * pr_proporcional_w)::numeric,100);
						vl_proporcional_w		:= dividir_sem_round((vl_recebido_w * pr_proporcional_w)::numeric,100);

						CALL atualizar_repasse_valor(nr_seq_protocolo_w,nr_interno_conta_w,vl_proporcional_w - vl_proporcional_imposto_w,nm_usuario_p,null,vl_proporcional_w,nr_seq_parcela_w,nr_seq_caixa_rec_p);
					end if;
				end if;
			end loop;
			close c01;
		end if;
	end if;

	if (IE_LIB_REP_TIT_CHEQUE_w	= 'S') then

		select	coalesce(sum(vl_transacao),0)
		into STRICT	vl_troco_w
		from	movto_trans_financ
		where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	nr_seq_trans_financ	= nr_seq_trans_troco_w;

		select	dt_fechamento
		into STRICT	dt_fechamento_w
		from	caixa_receb
		where	nr_sequencia	= nr_seq_caixa_rec_p;

		select	coalesce(sum(a.vl_transacao),0)
		into STRICT	vl_outros_receb_w
		from	transacao_financeira b,
			movto_trans_financ a
		where	a.nr_seq_trans_financ	= b.nr_sequencia
		and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
		and	b.ie_acao		= 0
		and	b.ie_caixa		= 'D'
		and	a.dt_transacao		< dt_fechamento_w;

		select	coalesce(sum(a.vl_cheque),0)
		into STRICT	vl_cheque_w
		from	cheque_cr a
		where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

		if (coalesce(ie_juros_multa_w,'S')	= 'N') then

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VTJM'),0);

		else

			vl_total_monetario_w	:= coalesce(obter_valores_caixa_rec(nr_seq_caixa_rec_p,'VT'),0);

		end if;


		vl_troco_w		:= dividir_sem_round(vl_cheque_w,vl_total_monetario_w) * vl_troco_w;

		vl_outros_receb_w	:= dividir_sem_round(vl_cheque_w,vl_total_monetario_w) * vl_outros_receb_w;

		vl_cheque_w	:= coalesce(vl_cheque_w,0) - coalesce(vl_troco_w,0) - coalesce(vl_outros_receb_w,0);

		if (vl_cheque_w > 0) then

			pr_proporcional_w	:= dividir_sem_round(vl_cheque_w * 100,vl_total_recebido_w);

			open c01;
			loop
			fetch c01 into
				nr_interno_conta_w,
				nr_seq_protocolo_w,
				vl_recebido_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				if (ie_opcao_p	= 'E') and (coalesce(ie_gerar_estorno_recebido_w,'N') = 'S') then
					CALL estornar_repasse_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
					/*if	(nvl(ie_gerou_repasse_w,'N') = 'N') then
						Recalcular_Conta_Repasse(nr_interno_conta_w,null,null,nm_usuario_p,null);
						--Gerar_repasse_est_recebido(nr_seq_protocolo_w,nr_interno_conta_w,nm_usuario_p);
						ie_gerou_repasse_w	:= 'S';
					end if;	*/
				else
					if (pr_proporcional_w <> 0) then
						vl_proporcional_imposto_w	:= dividir_sem_round((obter_valor_conta_imposto(nr_interno_conta_w, '3') * pr_proporcional_w)::numeric,100);
						vl_proporcional_w		:= dividir_sem_round((vl_recebido_w * pr_proporcional_w)::numeric,100);

						CALL atualizar_repasse_valor(nr_seq_protocolo_w,nr_interno_conta_w,vl_proporcional_w - vl_proporcional_imposto_w,nm_usuario_p,null,vl_proporcional_w);
					end if;
				end if;
			end loop;
			close c01;
		end if;

	end if;

	if (ie_opcao_p	= 'E') and (coalesce(ie_gerar_estorno_recebido_w,'N') = 'S') then
		open c01;
		loop
		fetch c01 into
			nr_interno_conta_w,
			nr_seq_protocolo_w,
			vl_recebido_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			CALL Recalcular_Conta_Repasse(nr_interno_conta_w,null,null,nm_usuario_p,null);
		end loop;
		close c01;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_repasse_rec_caixa ( nr_seq_caixa_rec_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

