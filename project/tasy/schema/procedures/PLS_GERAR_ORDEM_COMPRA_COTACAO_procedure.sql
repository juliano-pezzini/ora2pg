-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ordem_compra_cotacao ( nr_seq_auditoria_p pls_auditoria.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar uma ordem de compra para as análises que tiveram itens cotados
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção: Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_cotacao_w			integer;
qt_item_cotacao_w		integer;
nr_ordem_compra_w		bigint;
nr_ordem_item_w			integer;
nr_seq_guia_w			pls_auditoria.nr_seq_guia%type;
nr_seq_requisicao_w		pls_auditoria.nr_seq_requisicao%type;
dt_internacao_sugerida_w	timestamp;
cd_unidade_medida_compra_w	varchar(30);
cd_pessoa_fisica_w		usuario.cd_pessoa_fisica%type;
cd_material_w			pls_material.cd_material%type;



C01 CURSOR(nr_seq_auditoria_pc bigint) FOR
	SELECT	nr_sequencia,
		nr_seq_material,
		vl_item,
		nr_seq_material_forn,
		qt_ajuste
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_pc
	and	ie_status		= 'A'
	and	coalesce(cd_procedimento::text, '') = '';

BEGIN
if (nr_seq_auditoria_p IS NOT NULL AND nr_seq_auditoria_p::text <> '') then

	select	nr_seq_guia,
		nr_seq_requisicao
	into STRICT	nr_seq_guia_w,
		nr_seq_requisicao_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_auditoria_p;

	if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then

		select	dt_internacao_sugerida
		into STRICT	dt_internacao_sugerida_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;

	elsif (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

		select	dt_internacao_sugerida
		into STRICT	dt_internacao_sugerida_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	end if;

	select	count(1)
	into STRICT	qt_cotacao_w
	from	pls_cotacao
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status		= 3; -- Cotação finalizada
	if (qt_cotacao_w > 0) then

		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	usuario
		where	nm_usuario	= nm_usuario_p;

		select	nextval('ordem_compra_seq')
		into STRICT	nr_ordem_compra_w
		;

		insert into ordem_compra(
				nr_ordem_compra, cd_estabelecimento, cd_condicao_pagamento,
				cd_comprador, dt_ordem_compra, dt_atualizacao,
				nm_usuario, cd_moeda, ie_situacao,
				dt_inclusao, cd_pessoa_solicitante, ie_frete,
				dt_entrega, ie_aviso_chegada, ie_emite_obs,
				ie_urgente, cd_pessoa_fisica)
		values (
				nr_ordem_compra_w, cd_estabelecimento_p, 2,
				cd_pessoa_fisica_w, clock_timestamp(), clock_timestamp(),
				nm_usuario_p, 1, 'A',
				clock_timestamp(), cd_pessoa_fisica_w, 'N',
				coalesce(dt_internacao_sugerida_w,clock_timestamp() + interval '15 days'), 'N', 'N',
				'N', cd_pessoa_fisica_w);

		nr_ordem_item_w	:= 0;

		for r_C01_w in C01(nr_seq_auditoria_p) loop
			begin
				select	count(1)
				into STRICT	qt_item_cotacao_w
				from	pls_item_cotacao
				where	nr_seq_aud_item	= r_C01_w.nr_sequencia
				and	ie_status	= 4; -- Finalizado
				if (qt_item_cotacao_w > 0) then

					select	cd_material
					into STRICT	cd_material_w
					from	pls_material
					where	nr_sequencia	= r_C01_w.nr_seq_material;

					cd_unidade_medida_compra_w := substr(obter_dados_material_estab(cd_material_w, cd_estabelecimento_p,'UMC'),1,30);

					nr_ordem_item_w	:= nr_ordem_item_w + 1;

					insert into ordem_compra_item(
							nr_ordem_compra, nr_item_oci, cd_material,
							cd_unidade_medida_compra, vl_unitario_material, qt_material,
							dt_atualizacao, nm_usuario, ie_situacao, vl_total_item)
					values (
							nr_ordem_compra_w, nr_ordem_item_w, cd_material_w,
							cd_unidade_medida_compra_w, r_C01_w.vl_item, r_C01_w.qt_ajuste,
							clock_timestamp(), nm_usuario_p, 'A', round((r_C01_w.vl_item * r_C01_w.qt_ajuste)::numeric,4));
				end if;
			end;
		end loop;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ordem_compra_cotacao ( nr_seq_auditoria_p pls_auditoria.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;

