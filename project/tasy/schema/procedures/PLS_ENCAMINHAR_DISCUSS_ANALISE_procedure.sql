-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_encaminhar_discuss_analise (nr_seq_lote_discussao_p bigint, ie_parecer_externo_p text, nm_usuario_p text, cd_estabelecimento_p text) AS $body$
DECLARE

 
nr_seq_lote_contest_w		bigint;
nr_seq_acao_w			bigint;
nr_seq_ptu_fatura_w		bigint;
nr_seq_pls_fatura_w		bigint;
nr_seq_discussao_w		bigint;
vl_recurso_w			double precision;
vl_recursado_conta_w		double precision;
qt_reg_proc_w			bigint;
qt_reg_mat_w			bigint;
qt_registros_w			bigint := 0;
vl_total_recurso_w		double precision;
vl_apresentado_w		double precision;
nr_titulo_w			bigint;
			

BEGIN 
-- Parâmetro [3] - Permite encaminhar discussão para análise com itens sem parecer externo 
if (coalesce(ie_parecer_externo_p,'S') = 'N') then 
	select	count(1) 
	into STRICT	qt_reg_proc_w 
	from	pls_contestacao_discussao 	c, 
		pls_discussao_proc		b 
	where	c.nr_seq_lote		= nr_seq_lote_discussao_p 
	and	b.nr_seq_discussao	= c.nr_sequencia 
	and	coalesce(b.ds_parecer_origem::text, '') = '';
	 
	select	count(1) 
	into STRICT	qt_reg_mat_w 
	from	pls_contestacao_discussao 	c, 
		pls_discussao_mat		b 
	where	c.nr_seq_lote		= nr_seq_lote_discussao_p 
	and	b.nr_seq_discussao	= c.nr_sequencia 
	and	coalesce(b.ds_parecer_origem::text, '') = '';
	 
	qt_registros_w := qt_reg_proc_w + qt_reg_mat_w;
	 
	if (qt_registros_w > 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(164041);
	end if;
end if;
 
if (nr_seq_lote_discussao_p IS NOT NULL AND nr_seq_lote_discussao_p::text <> '') then 
	select	max(a.nr_seq_lote_contest), 
		max(a.vl_apresentado) 
	into STRICT	nr_seq_lote_contest_w, 
		vl_apresentado_w 
	from	pls_lote_discussao a 
	where	a.nr_sequencia		= nr_seq_lote_discussao_p;
	 
	select	max(a.nr_seq_ptu_fatura), 
		max(a.nr_seq_pls_fatura) 
	into STRICT	nr_seq_ptu_fatura_w, 
		nr_seq_pls_fatura_w 
	from	pls_lote_contestacao a 
	where	a.nr_sequencia		= nr_seq_lote_contest_w;
 
--	select	sum(a.vl_recurso) 
--	into	vl_total_recurso_w 
--	from	pls_contestacao_discussao a 
--	where	a.nr_seq_lote = nr_seq_lote_discussao_p; 
	 
--	if	(vl_total_recurso_w <> vl_apresentado_w) and 
--		(vl_apresentado_w is not null) then 
--		wheb_mensagem_pck.exibir_mensagem_abort(189160, 'VL_RECURSO=' || Campo_Mascara_virgula(vl_total_recurso_w)||';'|| 
--														'VL_APRESENTADO=' || Campo_Mascara_virgula(vl_apresentado_w)); 
--	end if;		 
	 
--	open C01; -- OS 628064 - WCBERNARDINO 
--	loop 
--	fetch C01 into	 
--		nr_seq_discussao_w, 
--		vl_recurso_w; 
--	exit when C01%notfound; 
--		begin 
--		select 	sum(vl_recursado) 
--		into	vl_recursado_conta_w 
--		from  (select	sum(a.vl_recurso) vl_recursado 
--			from 	pls_discussao_proc a 
--			where 	a.nr_seq_discussao = nr_seq_discussao_w 
--			union all 
--			select 	sum(a.vl_recurso) vl_recursado 
--			from 	pls_discussao_mat a 
--			where 	a.nr_seq_discussao = nr_seq_discussao_w); 
--			 
--		if	(vl_recurso_w <> vl_recursado_conta_w) then 
--			wheb_mensagem_pck.exibir_mensagem_abort(189161, 'NR_SEQ_DISCUSSAO=' || nr_seq_discussao_w ||';'|| 
--									'VL_RECURSADO=' || Campo_Mascara_virgula(vl_recursado_conta_w)||';'|| 
--									'VL_RECURSO=' || Campo_Mascara_virgula(vl_recurso_w)); 
--		end if;			 
--		end; 
--	end loop; 
--	close C01; 
	 
	-- Gerar o lote de análise da discussão 
	CALL pls_gerar_lote_analise_disc(nr_seq_lote_discussao_p,nm_usuario_p);
 
	-- Pagamento 
	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then 
		nr_seq_acao_w := pls_obter_acao_intercambio(	'9',  -- Encaminhamento da discussão para análise 
						'2',  -- Gerar título a pagar 
						nr_seq_ptu_fatura_w, null, null, null, clock_timestamp(), 'A550', 'N', nr_seq_acao_w);
						 
		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then	 
			-- Gerar título a pagar 
			CALL pls_gerar_tit_pagar_discussao(nr_seq_lote_discussao_p,nr_seq_acao_w,nm_usuario_p,cd_estabelecimento_p);
		end if;
	end if;
	 
	-- Faturamento 
	if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then 
		nr_seq_acao_w := pls_obter_acao_intercambio(	'9',  -- Encaminhamento da discussão para análise 
						'2',  -- Gerar título a pagar 
						null, nr_seq_pls_fatura_w, null, null, clock_timestamp(), 'A550', 'N', nr_seq_acao_w);
						 
		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then	 
			-- Gerar título a pagar 
			CALL pls_gerar_tit_pagar_discussao(nr_seq_lote_discussao_p,nr_seq_acao_w,nm_usuario_p,cd_estabelecimento_p);
		end if;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_encaminhar_discuss_analise (nr_seq_lote_discussao_p bigint, ie_parecer_externo_p text, nm_usuario_p text, cd_estabelecimento_p text) FROM PUBLIC;

