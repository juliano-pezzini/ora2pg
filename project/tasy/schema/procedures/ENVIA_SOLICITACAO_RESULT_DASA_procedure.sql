-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_solicitacao_result_dasa () AS $body$
DECLARE


qt_tentativa_dasa_w smallint;
nr_sequencia_w      bigint;
cd_resultado_w      varchar(25);

C01 CURSOR FOR
  SELECT nr_sequencia, cd_resultado
    from LAB_FILA_RESULTADO_INT
   where coalesce(dt_integracao::text, '') = ''
     and to_char(dt_prevista + ((60/1440)*nr_qtd_tentativas), 'DD/MM/YYYY HH24:MI:SS') < to_char(clock_timestamp(),'DD/MM/YYYY HH24:MI:SS')
     and nr_qtd_tentativas < qt_tentativa_dasa_w;

BEGIN
  select coalesce(max(qt_tentativa_dasa), 3)
    into STRICT qt_tentativa_dasa_w
    from lab_parametro
   where cd_estabelecimento = obter_estabelecimento_ativo;

	OPEN C01;
    LOOP
      FETCH C01 into
        nr_sequencia_w,
        cd_resultado_w;
      EXIT WHEN NOT FOUND; /* apply on c01 */
      begin
        CALL gravar_agend_integracao(640, 'nrSeqFila='||nr_sequencia_w||';'||'cdResultado='||cd_resultado_w||';');
      end;
    END LOOP;
	CLOSE C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_solicitacao_result_dasa () FROM PUBLIC;

