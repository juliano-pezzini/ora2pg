-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_tranfusao_reserva ( nr_seq_reserva_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, ds_mensagem_p INOUT text, ie_bloqueia_p INOUT text, IE_CODIGO_EXCESSAO_P INOUT bigint) AS $body$
DECLARE

					
/*Codigo de excessao - Para identificar a origem da mensagem
1 - Itens solicitados da transfusao que ainda nao foram reservados.

*/
ds_mensagem_w			varchar(32767);
ds_mensagem_aux_w		varchar(32767);
sql_item_w			varchar(2000);
qt_exame_pai_w			bigint;
qt_reserva_w			bigint;
qt_bolsa_fenotipo_w		bigint;
nr_Seq_producao_w		bigint;
nr_Seq_fenotipo_w		bigint;
qt_exames_fenotipo_w		bigint;
qt_concentrado_hemacias_w 	bigint;
ie_bloqueia_w			varchar(1);
ie_existe_fenotipo_w		varchar(1);
ds_derivado_w			varchar(250);
qt_item_solic_w			bigint;
qt_exam_anticorpo_w		bigint;
nr_seq_item_w			bigint;
qt_solicitada_w			san_reserva_item.qt_solicitada%type;
qt_reservada_w			bigint;
nr_seq_derivado_w		bigint;
ie_irradiado_w			varchar(1);
ie_filtrado_w			varchar(1);
ie_lavado_w			varchar(1);
ie_aliquotado_w			varchar(1);
ie_status_reserva_w		varchar(1);
dt_liberacao_solicitacao_w	timestamp;

/*parametros*/

ie_obriga_fenotip_w		varchar(1);
ie_obriga_res_solic_w		varchar(1);
ie_consist_res_sem_solic_w	varchar(1);



c01 CURSOR FOR
	SELECT	a.nr_seq_producao
	from	SAN_RESERVA_PROD a
	where	a.nr_Seq_Reserva = nr_seq_reserva_p
	and (exists (SELECT	1
			from	san_producao b,
				san_derivado c
			where	b.nr_seq_derivado = c.nr_sequencia
			and	c.ie_tipo_derivado = 'CH'
			and	b.nr_sequencia = a.nr_seq_producao)
	or	ie_obriga_fenotip_w <> 'H');

C04 CURSOR FOR
	SELECT	a.nr_seq_item,
		e.ds_derivado||CASE WHEN coalesce(a.ie_irradiado, coalesce(d.ie_irradiado,'N'))='S' THEN  ' - '||upper(Wheb_mensagem_pck.get_texto(306980))/*' - IRRADIADO' */ END ||CASE WHEN coalesce(a.ie_filtrado, coalesce(d.ie_filtrado,'N'))='S' THEN  ' - '||upper(Wheb_mensagem_pck.get_texto(306981)) /*' - FILTRADO'*/ END ||CASE WHEN coalesce(a.ie_lavado, coalesce(d.ie_lavado,'N'))='S' THEN  ' - '||upper(Wheb_mensagem_pck.get_texto(306982)) /*' - LAVADO' END */)||CASE WHEN coalesce(a.ie_aliquotado, coalesce(d.ie_aliquotado,'N'))='S' THEN  ' - '||upper(Wheb_mensagem_pck.get_texto(306983))/*' - ALIQUOTADO'*/ END  ds_derivado
	FROM san_derivado e, san_reserva_item a
LEFT OUTER JOIN prescr_procedimento d ON (a.nr_prescricao = d.nr_prescricao AND a.nr_seq_prescr = d.nr_sequencia)
WHERE a.nr_seq_reserva = nr_seq_reserva_p   and a.nr_seq_derivado = e.nr_sequencia  and not exists( 	SELECT	1
				from	san_producao c,
					san_reserva_prod b						 								
				where	b.nr_seq_reserva  = a.nr_seq_reserva						 
				and	b.nr_seq_producao = c.nr_sequencia
				and	a.nr_seq_derivado = c.nr_seq_derivado
				and	((coalesce(c.ie_irradiado,'N') = coalesce(a.ie_irradiado, coalesce(d.ie_irradiado,'N'))) or (coalesce(a.ie_irradiado, coalesce(d.ie_irradiado,'N')) = 'N'))
				and	((coalesce(c.ie_filtrado,'N')  = coalesce(a.ie_filtrado, coalesce(d.ie_filtrado,'N'))) or (coalesce(a.ie_filtrado, coalesce(d.ie_filtrado,'N')) = 'N'))
				and	((coalesce(c.ie_lavado,'N')	  = coalesce(a.ie_lavado, coalesce(d.ie_lavado,'N'))) or (coalesce(a.ie_lavado, coalesce(d.ie_lavado,'N')) = 'N'))
				and	((coalesce(c.ie_aliquotado,'N')  = coalesce(a.ie_aliquotado, coalesce(d.ie_aliquotado,'N'))) or (coalesce(a.ie_aliquotado, coalesce(d.ie_aliquotado,'N')) = 'N'))
				having count(*) >= (	select	sum(f.qt_solicitada)
							from	san_reserva_item f
							where	f.nr_seq_reserva = a.nr_seq_reserva
							and	f.nr_seq_derivado = a.nr_seq_derivado
							and	coalesce(f.ie_irradiado,'N') = coalesce(a.ie_irradiado,'N')
							and	coalesce(f.ie_filtrado,'N')  = coalesce(a.ie_filtrado,'N')
							and	coalesce(f.ie_lavado,'N')	  = coalesce(a.ie_lavado,'N')
							and	coalesce(f.ie_aliquotado,'N')  = coalesce(a.ie_aliquotado,'N')))  LIMIT 3;

C05 CURSOR FOR
	SELECT	count(*),
		e.ds_derivado||CASE WHEN coalesce(c.ie_irradiado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306980))/*' - IRRADIADO' */ END ||CASE WHEN coalesce(c.ie_filtrado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306981)) /*' - FILTRADO'*/ END ||CASE WHEN coalesce(c.ie_lavado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306982)) /*' - LAVADO' END */)||CASE WHEN coalesce(c.ie_aliquotado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306983))/*' - ALIQUOTADO'*/ END  ds_derivado,
		c.nr_seq_derivado,
		coalesce(c.ie_irradiado,'N'),
		coalesce(c.ie_filtrado,'N'),
		coalesce(c.ie_lavado,'N'),
		coalesce(c.ie_aliquotado,'N')
	from	san_producao c,
		san_reserva_prod b,
		san_derivado e						 								
	where	b.nr_seq_reserva  = nr_seq_reserva_p						 
	and	b.nr_seq_producao = c.nr_sequencia
	and	c.nr_seq_derivado = e.nr_sequencia
	group by e.ds_derivado||CASE WHEN coalesce(c.ie_irradiado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306980))/*' - IRRADIADO' */ END ||CASE WHEN coalesce(c.ie_filtrado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306981)) /*' - FILTRADO'*/ END ||CASE WHEN coalesce(c.ie_lavado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306982)) /*' - LAVADO' END */)||CASE WHEN coalesce(c.ie_aliquotado,'N')='S' THEN ' - '||upper(Wheb_mensagem_pck.get_texto(306983))/*' - ALIQUOTADO'*/ END ,
		c.nr_seq_derivado,
		coalesce(c.ie_irradiado,'N'),
		coalesce(c.ie_filtrado,'N'),
		coalesce(c.ie_lavado,'N'),
		coalesce(c.ie_aliquotado,'N');


BEGIN

ie_obriga_fenotip_w 		:= Obter_Valor_Param_Usuario(450, 216, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
ie_obriga_res_solic_w		:= Obter_Valor_Param_Usuario(450, 239, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
ie_consist_res_sem_solic_w	:= Obter_Valor_Param_Usuario(450, 395, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);

ie_bloqueia_w 		:= 'N';

select	count(*)
into STRICT	qt_exame_pai_w
from	san_exame_lote a,	
	san_exame_realizado b,
	san_exame c
where	a.nr_sequencia = b.nr_seq_exame_lote
and	b.nr_seq_exame = c.nr_Sequencia
and	a.nr_seq_reserva = nr_seq_reserva_p
and	upper(b.ds_Resultado) = 'POSITIVO'
and	c.ie_tipo_exame = 2;

--SAN_EXAME_ANTICORPOS
if (qt_exame_pai_w > 0) then

	select	count(*)
	into STRICT	qt_concentrado_hemacias_w
	from	san_reserva_prod x,
		san_producao y,
		san_derivado z
	where  	x.nr_seq_producao 	= y.nr_sequencia
	and	x.nr_seq_reserva  	= nr_seq_reserva_p
	and	y.nr_seq_derivado	= z.nr_sequencia
	and	z.ie_tipo_derivado	= 'CH';

	if (ie_obriga_fenotip_w = 'S') or (ie_obriga_fenotip_w = 'H' AND qt_concentrado_hemacias_w > 0) then		
		SELECT	COUNT(*)
		INTO STRICT	qt_exame_pai_w
		FROM	san_exame_lote a,	
			san_exame_realizado b,
			san_exame c
		WHERE	a.nr_sequencia = b.nr_seq_exame_lote
		AND	b.nr_seq_exame = c.nr_Sequencia
		AND	a.nr_seq_reserva = nr_seq_reserva_p
		AND	UPPER(b.ds_Resultado) = 'POSITIVO'
		AND	c.ie_tipo_exame = 2;

		if (qt_exame_pai_w > 0) then

			select 	count(*)
			into STRICT	qt_exames_fenotipo_w
			from   	san_reserva_prod x,
				san_producao		y,
				san_result_fenotipagem z
			where  	x.nr_seq_producao 	= y.nr_sequencia
			and (z.nr_seq_doacao	 	= y.nr_seq_doacao  or z.nr_seq_producao = y.nr_sequencia)
			and	x.nr_seq_reserva  	= nr_seq_reserva_p
			and (z.dt_liberacao IS NOT NULL AND z.dt_liberacao::text <> '')
			and coalesce(z.dt_inativacao::text, '') = '';

			--verificar se a bolsa possui exames de fenotipagem
			if (qt_exames_fenotipo_w = 0) then
				ds_mensagem_w := Wheb_mensagem_pck.get_texto(306915);  -- 'Voce deve cadastrar o exame de fenotipagem para as bolsas reservadas.';
				ie_bloqueia_w 		:= 'S';
			else
			
				select	count(*)
				into STRICT 	qt_exam_anticorpo_w	
				from 	san_exame_realizado x,
					san_exame y
				where 	x.nr_seq_exame = y.nr_sequencia
				and 	ie_possui_anticorpos = 'S'
				and 	nr_seq_exame_lote in((
						SELECT	a.nr_sequencia
						from 	san_exame_lote a,
							san_reserva_prod b
						where (a.nr_Seq_Reserva = nr_seq_reserva_p or a.NR_SEQ_RES_PROD = b.nr_sequencia)
						and 	b.nr_Seq_Reserva = nr_seq_reserva_p));
						
				if ( qt_exam_anticorpo_w > 0 ) then
					--verificar se o receptor possui oregistro de anticorpos
					SELECT	COUNT(*)
					into STRICT	qt_exames_fenotipo_w
					FROM  	san_exame_lote a,
						san_exame_realizado b,
						san_exame_anticorpos c,
						san_anticorpos d
					WHERE	a.nr_Seq_Reserva 	= nr_seq_reserva_p
					AND	a.nr_sequencia 		= b.nr_seq_exame_lote
					AND	b.nr_seq_exame_lote 	= c.nr_seq_exame_lote
					AND	c.nr_seq_anticorpo 	= d.nr_sequencia
					and (c.ie_resultado 		= 'S'
					or	coalesce(c.ie_anti_nao_identificado,'N') = 'S');
	
					if (qt_exames_fenotipo_w = 0) then
						ds_mensagem_w :=  Wheb_mensagem_pck.get_texto(306918); -- 'E necessario registrar os anticorpos. Favor verificar!';
						ie_bloqueia_w 		:= 'S';
					end if;
				end if;
			end if;

		end if;
	end if;

	if ( coalesce(ds_mensagem_w::text, '') = '') then

		open c01;
		loop
		fetch c01 into nr_Seq_producao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			sql_item_w	:= nr_Seq_producao_w||','||sql_item_w;
		end loop;
		close c01;

		SELECT * FROM san_consistir_fenotipagem(sql_item_w, nr_seq_reserva_p, '1', ds_mensagem_w, ie_bloqueia_w, nm_usuario_p) INTO STRICT ds_mensagem_w, ie_bloqueia_w;
	end if;
end if;

if (ie_obriga_res_solic_w <> 'N') and ( coalesce(ds_mensagem_w::text, '') = '') then

	select	count(*)
	into STRICT	qt_item_solic_w
	from	san_reserva_item
	where	nr_seq_reserva = nr_seq_reserva_p;

	if (qt_item_solic_w > 0) then

		ds_mensagem_aux_w := '';

		open c04;
		loop
		fetch c04 into 	nr_Seq_item_w,
				ds_derivado_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			ds_mensagem_aux_w := substr((ds_mensagem_aux_w || chr(13) || to_char(nr_seq_item_w) ||' - '|| ds_derivado_w),1,32767);
			end;
		end loop;
		close c04;

		if (ds_mensagem_aux_w IS NOT NULL AND ds_mensagem_aux_w::text <> '') then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(306933)||chr(13)||ds_mensagem_aux_w; -- 'Existe itens solicitados que nao foram reservados:'||chr(13)||ds_mensagem_aux_w;
			if (ie_obriga_res_solic_w = 'Q') then			
				ie_bloqueia_w := 'N';
			else
				ie_bloqueia_w := 'S';
			end if;
			ie_codigo_excessao_p := 1;
		end if;

	end if;

	if (ie_consist_res_sem_solic_w = 'S') then

		ds_mensagem_aux_w := '';

		open C05;
		loop
		fetch C05 into	
			qt_reservada_w,
			ds_derivado_w,
			nr_seq_derivado_w,
			ie_irradiado_w,
			ie_filtrado_w,
			ie_lavado_w,
			ie_aliquotado_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin

			select	coalesce(sum(a.qt_solicitada),0)
			into STRICT	qt_solicitada_w
			FROM san_derivado e, san_reserva_item a
LEFT OUTER JOIN prescr_procedimento d ON (a.nr_prescricao = d.nr_prescricao AND a.nr_seq_prescr = d.nr_sequencia)
WHERE a.nr_seq_reserva = nr_seq_reserva_p   and a.nr_seq_derivado = e.nr_sequencia and a.nr_seq_derivado = nr_seq_derivado_w and ((ie_irradiado_w = coalesce(a.ie_irradiado, coalesce(d.ie_irradiado,'N'))) or (coalesce(a.ie_irradiado, coalesce(d.ie_irradiado,'N')) = 'N')) and ((ie_filtrado_w  = coalesce(a.ie_filtrado, coalesce(d.ie_filtrado,'N'))) or (coalesce(a.ie_filtrado, coalesce(d.ie_filtrado,'N')) = 'N')) and ((ie_lavado_w	  = coalesce(a.ie_lavado, coalesce(d.ie_lavado,'N'))) or (coalesce(a.ie_lavado, coalesce(d.ie_lavado,'N')) = 'N')) and ((ie_aliquotado_w = coalesce(a.ie_aliquotado, coalesce(d.ie_aliquotado,'N'))) or (coalesce(a.ie_aliquotado, coalesce(d.ie_aliquotado,'N')) = 'N'));

			if (qt_reservada_w > qt_solicitada_w) then
				ds_mensagem_aux_w := substr((ds_mensagem_aux_w || chr(13) || ds_derivado_w),1,32767);			
			end if;

			end;
		end loop;
		close C05;

		if (ds_mensagem_aux_w IS NOT NULL AND ds_mensagem_aux_w::text <> '') then
			if (coalesce(ds_mensagem_w::text, '') = '') then
				ds_mensagem_w := substr((Wheb_mensagem_pck.get_texto(306934) || chr(13) || ds_mensagem_aux_w),1,32767); -- 'Existe itens reservados que nao foram solicitados:'||chr(13)||ds_mensagem_aux_w;
			else
				ds_mensagem_w := substr((ds_mensagem_w || chr(13) || chr(13) || Wheb_mensagem_pck.get_texto(306934)||chr(13)||ds_mensagem_aux_w),1,32767); -- 'Existe itens reservados que nao foram solicitados:'||chr(13)||ds_mensagem_aux_w;
			end if;

			if (ie_obriga_res_solic_w = 'Q') then			
				ie_bloqueia_w := 'N';
			else
				ie_bloqueia_w := 'S';
			end if;
			ie_codigo_excessao_p := 1;
		end if;

	end if;	
end if;

select	max(ie_status),
	max(dt_liberacao_solicitacao)
into STRICT	ie_status_reserva_w,
	dt_liberacao_solicitacao_w
from	san_reserva
where	nr_sequencia = nr_seq_reserva_p;

if (ie_status_reserva_w = 'S') and (coalesce(dt_liberacao_solicitacao_w::text, '') = '') then

	ds_mensagem_w := Wheb_mensagem_pck.get_texto(306937); --'Para gerar transfusao e necessario que o status esteja como Reservado ou a solicitacao esteja liberada';
	ie_bloqueia_w := 'S';

end if;

ds_mensagem_p 	:= ds_mensagem_w;
ie_bloqueia_p	:= ie_bloqueia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_tranfusao_reserva ( nr_seq_reserva_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, ds_mensagem_p INOUT text, ie_bloqueia_p INOUT text, IE_CODIGO_EXCESSAO_P INOUT bigint) FROM PUBLIC;

