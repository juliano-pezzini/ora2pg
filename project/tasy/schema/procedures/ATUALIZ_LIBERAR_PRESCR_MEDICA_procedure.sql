-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiz_liberar_prescr_medica ( nr_prescricao_p bigint, nr_atendimento_p bigint, cd_local_estoque_p bigint, ie_tipo_pessoa_p text, cd_perfil_p bigint, nm_usuario_p text, ie_prescricao_p text, ds_erro_p INOUT text, nr_seq_assinatura_p tasy_assinatura_digital.nr_sequencia%type default null) AS $body$
DECLARE


		
ds_erro_w	varchar(4000)	:= null;
ie_gerar_kit_proc	varchar(2);


BEGIN

ie_gerar_kit_proc := obter_param_usuario(998, 10, cd_perfil_p, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_kit_proc);

if (coalesce(cd_local_estoque_p, 0) <> 0) then
	
	CALL atualizar_local_prescr_medica(	nr_prescricao_p,
					cd_local_estoque_p);
end if;

if (ie_gerar_kit_proc = 'S') then
	
	CALL gerar_kit_procedimento(wheb_usuario_pck.get_cd_estabelecimento, nr_prescricao_p, null, nm_usuario_p);

end if;

if (coalesce(nr_seq_assinatura_p, 0) > 0) then
	update	prescr_medica	a
	set		a.nr_seq_assinatura	= nr_seq_assinatura_p
	where	a.nr_prescricao		= nr_prescricao_p
	and		coalesce(a.nr_seq_assinatura::text, '') = '';
end if;

ds_erro_w := liberar_prescricao(	nr_prescricao_p, nr_atendimento_p, ie_tipo_pessoa_p, cd_perfil_p, nm_usuario_p, ie_prescricao_p, ds_erro_w);


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiz_liberar_prescr_medica ( nr_prescricao_p bigint, nr_atendimento_p bigint, cd_local_estoque_p bigint, ie_tipo_pessoa_p text, cd_perfil_p bigint, nm_usuario_p text, ie_prescricao_p text, ds_erro_p INOUT text, nr_seq_assinatura_p tasy_assinatura_digital.nr_sequencia%type default null) FROM PUBLIC;

