-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE integra_centro_custo_protheus ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w		integer;
cd_cadastro_w		varchar(20);
ds_cadastro_w		varchar(80);
ie_operacao_w		varchar(15);
qt_registros_w		bigint;
cd_classificacao_w		varchar(40);
ie_erro_w			varchar(1) := 'N';
cd_estab_protheus_w	varchar(10);
cd_estab_int_w		varchar(10);


BEGIN

select	cd_cadastro,
	ds_cadastro,
	ie_operacao,
	cd_estabelecimento
into STRICT	cd_cadastro_w,
	ds_cadastro_w,
	ie_operacao_w,
	cd_estab_protheus_w
from	w_protheus_cadastro
where	nr_sequencia = nr_sequencia_p
and	tp_cadastro = 'CC';

if (coalesce(cd_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'CC', WHEB_MENSAGEM_PCK.get_texto(309633), nm_usuario_p);
	ie_erro_w := 'S';
end if;

if (coalesce(ds_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'CC', WHEB_MENSAGEM_PCK.get_texto(309634) , nm_usuario_p);
	ie_erro_w := 'S';
end if;

select	obter_conversao_interna_int(null,'ESTABELECIMENTO','CD_ESTABELECIMENTO',cd_estab_protheus_w,'PTH')
into STRICT	cd_estab_int_w
;

select	count(*)
into STRICT	qt_registros_w
from	estabelecimento
where	cd_estabelecimento = cd_estab_int_w;

if (qt_registros_w = 0) then
	CALL gravar_log_protheus('ERRO', 'CC', WHEB_MENSAGEM_PCK.get_texto(309636, 'CD_ESTAB_PROTHEUS_W=' || cd_estab_protheus_w), nm_usuario_p);
	ie_erro_w := 'S';
end if;

if (ie_erro_w = 'N') and (cd_cadastro_w IS NOT NULL AND cd_cadastro_w::text <> '') and (ds_cadastro_w IS NOT NULL AND ds_cadastro_w::text <> '') then
	begin

	if (ie_operacao_w in ('I','A')) then

		select	count(*)
		into STRICT	qt_registros_w
		from	centro_custo
		where	cd_sistema_contabil = cd_cadastro_w;

		if (qt_registros_w = 0) and (ie_operacao_w = 'I') then

			cd_classificacao_w := '';

			if (length(cd_cadastro_w) > 4) then

				cd_classificacao_w := substr(cd_cadastro_w,1,4) || '.';
				cd_classificacao_w := substr(cd_classificacao_w || substr(cd_cadastro_w,5,40),1,40);
			end if;

			select	coalesce(max(cd_centro_custo),0) + 1
			into STRICT	cd_centro_custo_w
			from	centro_custo;

			insert into centro_custo(
				cd_centro_custo,
				ds_centro_custo,
				cd_sistema_contabil,
				ie_situacao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_estabelecimento,
				ie_tipo,
				ie_periodo_proj_receita,
				cd_classificacao)
			values (
				cd_centro_custo_w,
				substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,80),
				cd_cadastro_w,
				'A',
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_estab_int_w,
				'A',
				'U',
				cd_classificacao_w);

		end if;

		if (qt_registros_w > 0) and (ie_operacao_w = 'A') then

			update	centro_custo
			set	ds_centro_custo		= substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,80),
				ie_situacao		= 'A',
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	cd_sistema_contabil	= cd_cadastro_w;
		end if;

	elsif (ie_operacao_w = 'E') then

		update	centro_custo
		set	ie_situacao = 'I',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	cd_sistema_contabil = cd_cadastro_w;

	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integra_centro_custo_protheus ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

