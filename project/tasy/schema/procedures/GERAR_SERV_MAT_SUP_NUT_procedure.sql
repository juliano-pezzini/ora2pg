-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_serv_mat_sup_nut (nr_seq_servico_p bigint, dt_servico_p timestamp, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_serv_dia_w		bigint;
dt_servico_w			timestamp;
ie_unico_servico_npt_adult_w	varchar(1);
nr_prescricao_w			bigint;
ie_unico_servico_leites_w	varchar(1);

k				smallint;
i				smallint;
j				smallint;


BEGIN



if (nr_seq_servico_p IS NOT NULL AND nr_seq_servico_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	ie_unico_servico_npt_adult_w	:= coalesce(Obter_valor_param_usuario(1003, 67, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');
	ie_unico_servico_leites_w	:= coalesce(Obter_valor_param_usuario(1003, 116, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'S');


	dt_servico_w	:= dt_servico_p;
	nr_prescricao_w	:= nr_prescricao_p;
	j		:= 1;
	k		:= 1;
	i		:= 1;
	
	

	if 	((nut_obter_tipo_servico(nr_seq_servico_p) = 5) or (ie_unico_servico_leites_w = 'S' and nut_obter_tipo_servico(nr_seq_servico_p) = 8)) then
			
		select	obter_valor_maior(coalesce(max(obter_somente_numero(trunc(dt_validade_prescr,'dd')-trunc(dt_inicio_prescr,'dd'))),0)+1,1)
		into STRICT	j
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		nr_prescricao_w	:= null;
	end if;

	for i in k..j loop
		begin
		
		if ((ie_unico_servico_npt_adult_w = 'S') and (nut_obter_tipo_servico(nr_seq_servico_p) = 5)) or
		    ((ie_unico_servico_leites_w = 'S') and (nut_obter_tipo_servico(nr_seq_servico_p) = 8)) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_serv_dia_w
			from	nut_atend_serv_dia
			where	nr_seq_servico 	= nr_seq_servico_p
			and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_servico) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_servico_w)
			and	nr_atendimento 	= nr_atendimento_p
			and	cd_setor_atendimento = cd_setor_atendimento_p;
	
		
		end if;
		
		if (coalesce(nr_seq_serv_dia_w::text, '') = '') then
			select 	nextval('nut_atend_serv_dia_seq')
			into STRICT	nr_seq_serv_dia_w
			;

			insert into nut_atend_serv_dia(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_servico,
				dt_servico,
				cd_setor_atendimento,
				nr_atendimento,
				ie_status,
				nr_prescricao,
				nr_seq_material,
				nr_seq_horario
				)
			values (nr_seq_serv_dia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_servico_p,
				dt_servico_w,
				cd_setor_atendimento_p,
				nr_atendimento_p,
				'A',
				CASE WHEN nr_prescricao_w=0 THEN null  ELSE nr_prescricao_w END ,
				CASE WHEN nr_seq_material_p=0 THEN null  ELSE nr_seq_material_p END ,
				nr_seq_horario_p);
		end if;
				
		CALL inserir_serv_prescr_aval(nr_prescricao_w,nr_seq_serv_dia_w,nm_usuario_p);
		
		dt_servico_w	:= ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_servico_w,'01:00');
		dt_servico_w	:= dt_servico_w+1;
		
		end;
	end loop;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_serv_mat_sup_nut (nr_seq_servico_p bigint, dt_servico_p timestamp, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text) FROM PUBLIC;

