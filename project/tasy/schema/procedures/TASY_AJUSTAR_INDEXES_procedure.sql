-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_indexes () AS $body$
DECLARE


nm_tablespace_origem_w 	varchar(30);
nm_tablespace_destino_w varchar(30);
nm_index_w		varchar(30);
ds_comando_w		varchar(1000);


/*Retorna o Nome dos Indexes errados*/

c01 CURSOR FOR
	SELECT  index_name
	from  	user_indexes
	where	tablespace_name = nm_tablespace_origem_w;

BEGIN


/*Retorna as TableSpace com indexes errados*/

select  distinct max(tablespace_name)
into STRICT	nm_tablespace_origem_w
from  	user_segments
where 	segment_type = 'INDEX'
and	tablespace_name like '%_DATA';

if (nm_tablespace_origem_w IS NOT NULL AND nm_tablespace_origem_w::text <> '') then

	nm_tablespace_destino_w := substr(nm_tablespace_origem_w,1,position('_DATA' in nm_tablespace_origem_w)) ||

'INDEX';

	OPEN C01;
	LOOP
	FETCH C01 into
		nm_index_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
     		BEGIN

		ds_comando_w := 'ALTER INDEX ' || nm_index_w || ' REBUILD TABLESPACE ' || nm_tablespace_destino_w;
		CALL exec_sql_dinamico('MOVENDO INDEX -> ' || nm_index_w,ds_comando_w);
		END;
	END LOOP;
	CLOSE C01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_indexes () FROM PUBLIC;

