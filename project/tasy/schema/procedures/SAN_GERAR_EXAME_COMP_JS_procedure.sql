-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_exame_comp_js ( nr_seq_doacao_p san_doacao.nr_sequencia%type, nr_seq_exame_p san_exame_realizado.nr_seq_exame%type, nr_seq_exame_lote_p san_exame_realizado.nr_seq_exame_lote%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_atualizar_p text, ie_auto_exclusao_p san_doacao.ie_auto_exclusao%type, dt_auto_exclusao_p san_doacao.dt_auto_exclusao%type, ie_outros_exames_p text, cd_estabelecimento_p san_parametro.cd_estabelecimento%type, nm_usuario_p san_doacao.nm_usuario%type) AS $body$
DECLARE


nr_seq_exame_rh_w	san_parametro.nr_seq_exame_rh%type;
nr_seq_exame_tipo_w	san_parametro.nr_seq_exame_tipo%type;
ds_resultado_w san_exame_realizado.ds_resultado%type;
ds_subtipo_p subtipo_sanguineo.ds_subtipo%type;
nr_seq_exame_sub_abo_w	san_parametro.nr_seq_exame_sub_abo%type;
nr_seq_subgrupo_w	subtipo_sanguineo.nr_sequencia%type;	



BEGIN

CALL san_gerar_exame_complementar(nr_seq_exame_lote_p, nr_seq_exame_p, nm_usuario_p);

if (ie_atualizar_p = 'S') then
	begin
	update 	san_doacao
	set 	ie_auto_exclusao	= ie_auto_exclusao_p, dt_auto_exclusao = dt_auto_exclusao_p
	where 	nr_sequencia	= nr_seq_doacao_p;
	end;
end if;

if (ie_outros_exames_p = 'S') then
	begin
	select	ds_resultado
	into STRICT	ds_resultado_w
	from	san_exame_realizado
	where	nr_seq_exame_lote	= nr_seq_exame_lote_p
	and	nr_seq_exame	= nr_seq_exame_p;

	if (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then
		begin
		select	nr_seq_exame_rh,
			nr_seq_exame_tipo,
			nr_seq_exame_sub_abo
		into STRICT	nr_seq_exame_rh_w,
			nr_seq_exame_tipo_w,
			nr_seq_exame_sub_abo_w
		from	san_parametro
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (nr_seq_exame_p = nr_seq_exame_tipo_w) then
			begin
			update	pessoa_fisica
			set	ie_tipo_sangue = obter_valor_dominio(1173, ds_resultado_w)
			where	cd_pessoa_fisica = cd_pessoa_fisica_p;
			end;
		end if;

		if (nr_seq_exame_p = nr_seq_exame_rh_w) then
			begin
			if (ds_resultado_w = 'Negativo') or (ds_resultado_w = 'NEG') then
				ds_resultado_w	:= '-';

			elsif (ds_resultado_w = 'Positivo') or (ds_resultado_w = 'POS') then
				ds_resultado_w	:= '+';
			end if;

			update	pessoa_fisica
			set	ie_fator_rh	= obter_valor_dominio(1174, ds_resultado_w)
			where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			end;
		end if;
		
		if (nr_seq_exame_p = nr_seq_exame_sub_abo_w and ds_resultado_w <> '') then
      ds_subtipo_p := substr(ds_resultado_w, 1, 20);
			select	max(nr_sequencia)
			into STRICT	nr_seq_subgrupo_w
			from	subtipo_sanguineo
			where	ds_subtipo = ds_subtipo_p;

			if (nr_seq_subgrupo_w IS NOT NULL AND nr_seq_subgrupo_w::text <> '') then	
				update 	pessoa_fisica
				set 	ie_subtipo_sanguineo = nr_seq_subgrupo_w
				where  	cd_pessoa_fisica = cd_pessoa_fisica_p;
			end if;

		end if;
		
		end;
	end if;
	
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_exame_comp_js ( nr_seq_doacao_p san_doacao.nr_sequencia%type, nr_seq_exame_p san_exame_realizado.nr_seq_exame%type, nr_seq_exame_lote_p san_exame_realizado.nr_seq_exame_lote%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_atualizar_p text, ie_auto_exclusao_p san_doacao.ie_auto_exclusao%type, dt_auto_exclusao_p san_doacao.dt_auto_exclusao%type, ie_outros_exames_p text, cd_estabelecimento_p san_parametro.cd_estabelecimento%type, nm_usuario_p san_doacao.nm_usuario%type) FROM PUBLIC;

