-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_gerar_medic_suporte ( nr_seq_pac_p bigint ) AS $body$
DECLARE


nr_seq_material_w           paciente_protocolo_medic.nr_seq_material%type;
nr_agrupamento_w            paciente_protocolo_medic.nr_agrupamento%type;
nm_usuario_w	            paciente_protocolo_medic.nm_usuario%type;
nr_seq_grupo_suporte_w      protocolo_medicacao.nr_seq_grupo_suporte%type;
cd_material_w               grupo_medic_suporte_item.cd_material%type;
qt_dose_w                   grupo_medic_suporte_item.qt_dose%type;
cd_unidade_medida_w         grupo_medic_suporte_item.cd_unidade_medida%type;
ds_dias_aplicacao_w         grupo_medic_suporte_item.ds_dias_aplicacao%type;
ds_ciclos_aplicacao_w       grupo_medic_suporte_item.ds_ciclos_aplicacao%type;
ie_via_aplicacao_w          grupo_medic_suporte_item.ie_via_aplicacao%type;
qt_medic_paciente_w         bigint;
nr_agrup_medic_sup_w        bigint := 0;

--medicamentos do protocolo sem os diluentes			
c01 CURSOR FOR
	SELECT	nr_seq_material,
            nr_agrupamento
	from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_pac_p
    and     coalesce(nr_seq_diluicao::text, '') = ''
	order by 1;

c02 CURSOR FOR
	SELECT  cd_material,
            qt_dose,
            cd_unidade_medida,
            ds_dias_aplicacao,
            ds_ciclos_aplicacao,
            ie_via_aplicacao
    from    grupo_medic_suporte_item
    where   nr_sequencia = nr_seq_grupo_suporte_w;


BEGIN
if (nr_seq_pac_p IS NOT NULL AND nr_seq_pac_p::text <> '') then
    select  coalesce(b.nr_seq_grupo_suporte,0)
    into STRICT    nr_seq_grupo_suporte_w
    from    paciente_setor a,
            protocolo_medicacao b
    where   a.nr_seq_paciente = nr_seq_pac_p
    and     a.cd_protocolo = b.cd_protocolo
    and a.nr_seq_medicacao = b.nr_sequencia;
	
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
	
	if (coalesce(nm_usuario_w::text, '') = '') then
		select nm_usuario
		into STRICT nm_usuario_w
		from paciente_setor
		where nr_seq_paciente = nr_seq_pac_p;
	end if;

    if (nr_seq_grupo_suporte_w > 0) then
        select  count(*)
        into STRICT    qt_medic_paciente_w
        from    grupo_medic_suporte_item
        where   nr_sequencia = nr_seq_grupo_suporte_w;

        open c01;
        loop
        fetch c01 into	
            nr_seq_material_w,
            nr_agrupamento_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
            begin
                update paciente_protocolo_medic
                set     nr_agrupamento = nr_agrupamento_w + qt_medic_paciente_w
                where   nr_seq_paciente = nr_seq_pac_p
                and     nr_seq_material = nr_seq_material_w;
            end;
        end loop;
        close c01;

        open c02;
        loop
        fetch c02 into	
            cd_material_w,
            qt_dose_w,
            cd_unidade_medida_w,
            ds_dias_aplicacao_w,
            ds_ciclos_aplicacao_w,
            ie_via_aplicacao_w;
        EXIT WHEN NOT FOUND; /* apply on c02 */
            begin
                nr_agrup_medic_sup_w := nr_agrup_medic_sup_w + 1;

                select	coalesce(max(nr_seq_material),0) +1
                into STRICT	nr_seq_material_w
                from	paciente_protocolo_medic
                where	nr_seq_paciente	= nr_seq_pac_p;
				
                insert into paciente_protocolo_medic(
                    nr_seq_paciente,
                    nr_seq_material,
                    nr_agrupamento,
                    cd_material,
                    qt_dose,
                    cd_unidade_medida,
                    ds_dias_aplicacao,
                    ds_ciclos_aplicacao,
                    ie_via_aplicacao,
                    dt_atualizacao,
                    nm_usuario,
                    ie_bomba_infusao,
                    nr_seq_interno

                ) values (
                    nr_seq_pac_p,
                    nr_seq_material_w,
                    nr_agrup_medic_sup_w,
                    cd_material_w,
                    qt_dose_w,
                    cd_unidade_medida_w,
                    ds_dias_aplicacao_w,
                    ds_ciclos_aplicacao_w,
                    ie_via_aplicacao_w,
                    clock_timestamp(),
                    nm_usuario_w,
                    'n',
                    nextval('paciente_protocolo_medic_seq')
                );
            end;
        end loop;
        close c02;
    end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_gerar_medic_suporte ( nr_seq_pac_p bigint ) FROM PUBLIC;

