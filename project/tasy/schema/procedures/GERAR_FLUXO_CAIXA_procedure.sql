-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa (cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_conta_financ_p bigint, ie_classif_fluxo_p text, nm_usuario_p text, vl_fluxo_p bigint, ie_origem_p text, ie_periodo_p text, ie_integracao_p text, cd_empresa_p bigint, ie_contrato_p text, ie_somente_ativa_p text, cd_moeda_p bigint default null) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/

/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */

/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */

/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */

/* existam diferenças entre os fluxos de caixa.                                                                                                                */

/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

ie_conta_financ_ativa_w	varchar(1);
/* Projeto Multimoeda - Variáveis */

cd_moeda_empresa_w	integer;


BEGIN

select	CASE WHEN ie_somente_ativa_p='S' THEN ie_situacao  ELSE 'A' END
into STRICT	ie_conta_financ_ativa_w
from	conta_financeira
where	cd_conta_financ = cd_conta_financ_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

if (ie_conta_financ_ativa_w = 'A') then
	begin
	/* Projeto Multimoeda - Acrescentado o campo cd_moeda na tabela. Quando não for passado o parâmetro cd_moeda_p será
			gravado na tabela a moeda padrão da empresa, sendo assim todos os fluxos gerados terão uma moeda,
			seja ela moeda nacional ou estrangeira. Por questões de integridade dos registros existentes, quando
			a moeda estiver nula, será considerado que equivale a moeda padrão da empresa. */
	insert	into fluxo_caixa(cd_estabelecimento,
		dt_referencia,
		cd_conta_financ,
		ie_classif_fluxo,
		dt_atualizacao,
		nm_usuario,
		vl_fluxo,
		ie_origem,
		ie_periodo,
		ie_integracao,
		cd_empresa,
		ie_contrato,
		cd_moeda)
	values (cd_estabelecimento_p,
		dt_referencia_p,
		cd_conta_financ_p,
		ie_classif_fluxo_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_fluxo_p,
		ie_origem_p,
		ie_periodo_p,
		ie_integracao_p,
		cd_empresa_p,
		ie_contrato_p,
		coalesce(cd_moeda_p,cd_moeda_empresa_w));
	exception
		when unique_violation then
			update	fluxo_caixa
			set	vl_fluxo		= vl_fluxo + vl_fluxo_p
			where	cd_estabelecimento	= cd_estabelecimento_p
			and	cd_conta_financ		= cd_conta_financ_p
			and	dt_referencia		= dt_referencia_p
			and	ie_periodo		= ie_periodo_p
			and	ie_classif_fluxo	= ie_classif_fluxo_p
			and	ie_integracao		= ie_integracao_p
			and	cd_empresa		= cd_empresa_p
			and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_p,cd_moeda_empresa_w);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa (cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_conta_financ_p bigint, ie_classif_fluxo_p text, nm_usuario_p text, vl_fluxo_p bigint, ie_origem_p text, ie_periodo_p text, ie_integracao_p text, cd_empresa_p bigint, ie_contrato_p text, ie_somente_ativa_p text, cd_moeda_p bigint default null) FROM PUBLIC;

