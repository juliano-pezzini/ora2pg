-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_repasse_terceiro (dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_pessoa_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_acao_p bigint, cd_convenio_p bigint, ie_desvinc_rep_reg_p text, ie_tipo_convenio_p bigint, nr_seq_tipo_p bigint, dt_aprovacao_p timestamp) AS $body$
DECLARE

 
/*	ie_acao_p 
 
0	Sem ação 
1	Excluir vencimentos 
2	Mudar status e excluir vencimentos 
3	Desfazer aprovação, mudar status e excluir vencimentos 
4	Desvincular título, desfazer aprovação, mudar status e excluir vencimentos 
 
*/
 
 
nr_seq_terceiro_w		bigint;
ie_desvinv_contabil_w		varchar(1);
qt_titulo_w			bigint;
nr_repasse_terceiro_w		bigint;
qt_contabilizado_w		bigint;
nr_titulo_w			bigint;
qt_titulo_nf_w			bigint;
ie_reabrir_contabil_w		varchar(1);
dt_aprovacao_terceiro_w		timestamp;
ie_status_w			varchar(1);
nm_terceiro_w			varchar(255);
ie_excluir_rep_desfazer_w	varchar(3);

c01 CURSOR FOR 
SELECT	b.nr_sequencia, 
	a.nr_repasse_terceiro, 
	a.dt_aprovacao_terceiro, 
	a.ie_status, 
	substr(obter_nome_terceiro(b.nr_sequencia),1,255) nm_terceiro 
from	terceiro b, 
	repasse_terceiro a 
where (coalesce(nr_seq_tipo_p,0) = 0 or a.nr_seq_tipo = nr_seq_tipo_p) 
and (ie_acao_p = 4 or (ie_acao_p = 3 and not exists (SELECT	1 
					from	titulo_pagar x 
					where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro)) or (ie_acao_p = 2 and coalesce(a.dt_aprovacao_terceiro::text, '') = '') or (ie_acao_p = 1 and a.ie_status = 'A') or (ie_acao_p = 0 and not exists (select	1 
					from	repasse_terceiro_venc x 
					where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro))) 
and	b.ie_situacao		= 'A' 
and	b.cd_estabelecimento	= cd_estabelecimento_p 
and	coalesce(b.ie_utilizacao, 'A') in ('A','R') 
and (ie_tipo_pessoa_p = 'T' or (ie_tipo_pessoa_p = 'F' and (b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_p = 'J' and (b.cd_cgc IS NOT NULL AND b.cd_cgc::text <> ''))) 
and	a.nr_seq_terceiro	= b.nr_sequencia 
and ((dt_aprovacao_p IS NOT NULL AND dt_aprovacao_p::text <> '') or (a.dt_periodo_inicial	between dt_inicial_p and dt_final_p)) 
and (coalesce(dt_aprovacao_p::text, '') = '' or (trunc(a.dt_aprovacao_terceiro,'dd')	= trunc(dt_aprovacao_p,'dd'))) 
and (a.cd_convenio	= cd_convenio_p or ('0' = coalesce(cd_convenio_p,'0'))) 
and ('0' = ie_tipo_convenio_p or (coalesce(a.ie_tipo_convenio,coalesce(obter_tipo_convenio(a.cd_convenio),0)) = ie_tipo_convenio_p)) 
and	a.ie_status not in ('U','C') 
and ('N' = coalesce(ie_desvinc_rep_reg_p,'N') 
	or ('S' = coalesce(ie_desvinc_rep_reg_p,'S') and exists (	select	1 
								from	procedimento_repasse x 
								where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro 
								
union	all
 
								select	1 
								from	material_repasse x 
								where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro 
								
union	all
	 
								select	1 
								from	repasse_terceiro_item x 
								where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro)));


BEGIN 
 
ie_desvinv_contabil_w := obter_param_usuario(89, 63, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_desvinv_contabil_w);
ie_reabrir_contabil_w := obter_param_usuario(89, 64, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_reabrir_contabil_w);
 
select	coalesce(max(a.ie_excluir_rep_desfazer),'N') 
into STRICT	ie_excluir_rep_desfazer_w 
from	parametro_faturamento a 
where	a.cd_estabelecimento	= cd_estabelecimento_p;
 
open	c01;
loop 
fetch	c01 into 
	nr_seq_terceiro_w, 
	nr_repasse_terceiro_w, 
	dt_aprovacao_terceiro_w, 
	ie_status_w, 
	nm_terceiro_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	count(*) 
	into STRICT	qt_titulo_w 
	from	titulo_pagar a 
	where	a.nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
	select	count(*) 
	into STRICT	qt_contabilizado_w 
	from	repasse_terceiro_item a 
	where	coalesce(a.nr_lote_contabil,0)	> 0 
	and	a.nr_repasse_terceiro		= nr_repasse_terceiro_w;
 
	if (qt_titulo_w		> 0) then 
		 
		if (ie_desvinv_contabil_w	<> 'S') and (qt_contabilizado_w	> 0) then 
			/*'Não é permitido desvincular título com item de repasse contabilizado! Parâmetro [63]' || chr(10) || chr(13) || 
							'Terceiro: ' || nm_terceiro_w || chr(10) || chr(13) || 
							'Repasse: ' || nr_repasse_terceiro_w);*/
 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215467,'NM_TERCEIRO_W='||nm_terceiro_w||';NR_REPASSE_TERCEIRO_W='|| nr_repasse_terceiro_w);
		end if;
 
		select	count(*) 
		into STRICT	qt_titulo_nf_w 
		from	nota_fiscal b, 
			titulo_pagar a 
		where	coalesce(b.ie_situacao,1)	= 1 
		and	a.nr_seq_nota_fiscal	= b.nr_sequencia 
		and	a.nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
		if (qt_titulo_nf_w	> 0) then 
			/*'Não é possível desvincular o título pois o mesmo possui nota fiscal!' || chr(10) || chr(13) || 
							'Terceiro: ' || nm_terceiro_w || chr(10) || chr(13) || 
							'Repasse: ' || nr_repasse_terceiro_w);*/
 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215468,'NM_TERCEIRO_W='||nm_terceiro_w||';NR_REPASSE_TERCEIRO_W='|| nr_repasse_terceiro_w);				
		end if;
 
		CALL desvincular_titulo_repasse(nr_repasse_terceiro_w,nm_usuario_p,'N');
 
	end if;
 
	if (dt_aprovacao_terceiro_w IS NOT NULL AND dt_aprovacao_terceiro_w::text <> '') then 
		CALL desfazer_aprovacao_repasse(nr_repasse_terceiro_w,nm_usuario_p,'N');
	end if;
 
	if (ie_status_w	= 'F') then 
 
		if (ie_reabrir_contabil_w	<> 'S') and (qt_contabilizado_w	> 0) then 
			/*'Não é permitido reabrir repasses com itens contabilizados! Parâmetro [64]' || chr(10) || chr(13) || 
							'Terceiro: ' || nm_terceiro_w || chr(10) || chr(13) || 
							'Repasse: ' || nr_repasse_terceiro_w);*/
 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(215469,'NM_TERCEIRO_W='||nm_terceiro_w||';NR_REPASSE_TERCEIRO_W='|| nr_repasse_terceiro_w);				
		end if;
 
		CALL altera_status_repasse_terceiro(nr_repasse_terceiro_w,nm_usuario_p,'N');
 
	end if;
 
	delete	from repasse_terc_venc_trib 
	where	nr_seq_rep_venc	in (SELECT	a.nr_sequencia 
		from	repasse_terceiro_venc a 
		where	a.nr_repasse_terceiro	= nr_repasse_terceiro_w);
 
	delete	from repasse_terceiro_venc 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
	delete	from repasse_terceiro_item 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
	update	material_repasse 
	set	nr_repasse_terceiro	 = NULL 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
	update	procedimento_repasse 
	set	nr_repasse_terceiro	 = NULL 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
 
	if (coalesce(ie_excluir_rep_desfazer_w,'N')	= 'S') then 
		delete	from repasse_terceiro 
		where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	end if;
 
end	loop;
close	c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_repasse_terceiro (dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_pessoa_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_acao_p bigint, cd_convenio_p bigint, ie_desvinc_rep_reg_p text, ie_tipo_convenio_p bigint, nr_seq_tipo_p bigint, dt_aprovacao_p timestamp) FROM PUBLIC;

