-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_info_cpoe (cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_tecnica_w		hd_tecnica_acesso.nr_sequencia%type;
nr_tecnica_insert_w		paciente_tratamento.ie_tratamento%type;

c01 CURSOR FOR
 SELECT ie_tipo_hemodialise,
	ie_cateter,
	nr_atendimento
from 	cpoe_dialise a
where 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
and	a.dt_inicio between inicio_dia(clock_timestamp()) and fim_dia(clock_timestamp());

BEGIN
for r_c01 in c01 loop

	if (r_c01.ie_cateter IS NOT NULL AND r_c01.ie_cateter::text <> '') then

		select	max(nr_sequencia)
		into STRICT	nr_seq_tecnica_w
		from	hd_tecnica_acesso
		where	ie_acesso_prescricao = r_c01.ie_cateter;

		if (nr_seq_tecnica_w IS NOT NULL AND nr_seq_tecnica_w::text <> '') then
			insert 	into hd_acesso(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						cd_pessoa_fisica,
						nr_seq_tecnica)
				values (
						nextval('hd_acesso_seq'),
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_p,
						nr_seq_tecnica_w);
		end if;
	end if;

	if (r_c01.ie_tipo_hemodialise IS NOT NULL AND r_c01.ie_tipo_hemodialise::text <> '') then
		if (r_c01.ie_tipo_hemodialise = 'CHDI') then
			nr_tecnica_insert_w := 'IHDF';
		elsif (r_c01.ie_tipo_hemodialise = 'PAF') then
			nr_tecnica_insert_w := 'PL';
		elsif (r_c01.ie_tipo_hemodialise = 'IUF') then
			nr_tecnica_insert_w := 'IHF';
		else
			nr_tecnica_insert_w := r_c01.ie_tipo_hemodialise;
		end if;

		if (nr_tecnica_insert_w IS NOT NULL AND nr_tecnica_insert_w::text <> '') then
			CALL hd_insere_trat_pac(cd_pessoa_fisica_p,nr_tecnica_insert_w,nm_usuario_p,cd_estabelecimento_p,r_c01.nr_atendimento);
		end if;
	end if;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_info_cpoe (cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

