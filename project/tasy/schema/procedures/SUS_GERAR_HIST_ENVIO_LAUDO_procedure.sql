-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_hist_envio_laudo ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
tp_registro_w		bigint;
cd_estabelecimento_w	smallint;
nr_lote_w			bigint;
nr_seq_laudo_w     	bigint;
ie_tipo_laudo_w     	varchar(1);
nr_laudo_w        	varchar(13);
cd_procedimento_princ_w	bigint;
nr_aih_w        		bigint;
nr_seq_aih_w      	bigint;
cd_procedimento_supl_w 	bigint;
cd_cid_principal_w    	varchar(4);
qt_procedimento_w		bigint;
dt_competencia_w     	varchar(6);
nr_prontuario_w     	varchar(20);
nr_cartao_sus_w     	varchar(20);
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
qt_solic_w			integer;

C01 CURSOR FOR 
	SELECT	tp_registro, 
		nr_lote, 
		nr_seq_laudo, 
		ie_tipo_laudo, 
		nr_laudo, 
		cd_procedimento_solic, 
		nr_aih, 
		nr_sequencia, 
		cd_proced_solic, 
		cd_cid_principal, 
		qt_procedimento, 
		dt_competencia, 
		nr_prontuario, 
		nr_cartao_sus, 
		nr_atendimento, 
		nr_interno_conta, 
		qt_solic 
	from	sus_interf_aih_iscmpoa_v 
	where	nr_lote = nr_seq_lote_p 
	and	tp_registro <> 1 
	order by	tp_registro, 
		nr_seq_laudo, 
		ie_tipo_laudo, 
		cd_proced_solic;			
			 

BEGIN 
 
cd_estabelecimento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);
 
delete from sus_hist_envio_laudo_pac 
where	nr_lote = nr_seq_lote_p;
 
open C01;
loop 
fetch C01 into	 
	tp_registro_w, 
	nr_lote_w, 
	nr_seq_laudo_w, 
	ie_tipo_laudo_w, 
	nr_laudo_w, 
	cd_procedimento_princ_w, 
	nr_aih_w, 
	nr_seq_aih_w, 
	cd_procedimento_supl_w, 
	cd_cid_principal_w, 
	qt_procedimento_w, 
	dt_competencia_w, 
	nr_prontuario_w, 
	nr_cartao_sus_w, 
	nr_atendimento_w, 
	nr_interno_conta_w, 
	qt_solic_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	nextval('sus_hist_envio_laudo_pac_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into sus_hist_envio_laudo_pac(	 
		nr_sequencia, 
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_lote, 
		nr_seq_laudo, 
		ie_tipo_laudo, 
		nr_laudo, 
		cd_procedimento_princ, 
		nr_aih, 
		nr_seq_aih, 
		cd_procedimento_supl, 
		cd_cid_principal, 
		qt_procedimento, 
		dt_competencia, 
		nr_prontuario, 
		nr_cartao_sus, 
		nr_atendimento, 
		nr_interno_conta, 
		qt_solic) 
	values (	nr_sequencia_w, 
		cd_estabelecimento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_lote_w, 
		nr_seq_laudo_w, 
		ie_tipo_laudo_w, 
		nr_laudo_w, 
		cd_procedimento_princ_w, 
		nr_aih_w, 
		nr_seq_aih_w, 
		cd_procedimento_supl_w, 
		cd_cid_principal_w, 
		qt_procedimento_w, 
		dt_competencia_w, 
		nr_prontuario_w, 
		nr_cartao_sus_w, 
		nr_atendimento_w, 
		nr_interno_conta_w, 
		qt_solic_w);
		 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_hist_envio_laudo ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

