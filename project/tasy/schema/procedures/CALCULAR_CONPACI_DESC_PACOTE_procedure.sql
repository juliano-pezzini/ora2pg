-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_conpaci_desc_pacote (nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_interno_conta_w	bigint;

cd_convenio_w			integer;
cd_categoria_w			varchar(10);
nr_seq_pacote_w			bigint;
vl_itens_pacote_w		double precision;
vl_pacote_w			double precision;

vl_desc_procedimento_w		double precision;

nr_seq_w			bigint;

vl_desconto_w			double precision;

c01 CURSOR FOR 
	SELECT cd_convenio, 
		 cd_categoria, 
		 nr_seq_proc_pacote, 
		 sum(vl_item) 
	from conta_paciente_v 
	where nr_interno_conta = nr_interno_conta_w 
	 and (nr_seq_proc_pacote IS NOT NULL AND nr_seq_proc_pacote::text <> '') 
	 and nr_sequencia <> nr_seq_proc_pacote 
	group by	cd_convenio, 
			cd_categoria, 
			nr_seq_proc_pacote;


BEGIN 
 
select	nr_interno_conta 
into STRICT	nr_interno_conta_w 
from	conta_paciente_desconto 
where nr_sequencia = nr_sequencia_p;
 
OPEN C01;
LOOP 
	FETCH C01 into	cd_convenio_w, 
				cd_categoria_w, 
				nr_seq_pacote_w, 
				vl_itens_pacote_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
 
		select vl_procedimento 
		into STRICT vl_pacote_w 
		from procedimento_paciente 
		where nr_sequencia = nr_seq_pacote_w;
 
		if (vl_pacote_w <> vl_itens_pacote_w) then 
			begin 
			update procedimento_paciente 
			set vl_procedimento = vl_itens_pacote_w, 
			  vl_custo_operacional = vl_itens_pacote_w 
			where nr_sequencia = nr_seq_pacote_w;
			end;
 
			vl_desc_procedimento_w := vl_pacote_w - vl_itens_pacote_w;
			if (vl_pacote_w < vl_itens_pacote_w) then 
				vl_desc_procedimento_w := vl_itens_pacote_w - vl_pacote_w;
			end if;
 
			if (ie_acao_p	= 'I') then 
				begin 
				select coalesce(max(nr_sequencia), 0) + 1 
				into STRICT	 nr_seq_w 
				from	 proc_paciente_valor 
				where	 nr_seq_procedimento	= nr_seq_pacote_w;
 
				insert into proc_paciente_valor(nr_seq_procedimento, 
					nr_sequencia, 
					ie_tipo_valor, 
					dt_atualizacao, 
					nm_usuario, 
					vl_procedimento, 
					vl_medico, 
					vl_anestesista, 
					vl_materiais, 
					vl_custo_operacional, 
					vl_auxiliares, 
					cd_convenio, 
					cd_categoria, 
					pr_valor) 
				values (nr_seq_pacote_w, 
					nr_seq_w, 
					3, 
					clock_timestamp(), 
					nm_usuario_p, 
					vl_desc_procedimento_w, 
					0, 
					0, 
					0, 
					vl_desc_procedimento_w, 
					0, 
					cd_convenio_w, 
					cd_categoria_w, 
					0);
				exception 
					when others then 
						--Erro Incluir Desconto Proc' || chr(13) || chr(10) || SQLERRM); 
						CALL Wheb_mensagem_pck.exibir_mensagem_abort(261629, 'ERRO='|| SQLERRM);
				end;
			else 
				select coalesce(sum(vl_procedimento),0) 
				into STRICT vl_desconto_w 
				from proc_paciente_valor 
				where nr_seq_procedimento = nr_seq_pacote_w 
				 and ie_tipo_valor = 3;
 
				update procedimento_paciente 
				set	 vl_procedimento		= (vl_procedimento + vl_desconto_w), 
					 vl_custo_operacional	= (vl_procedimento + vl_desconto_w) 
				where	 nr_sequencia		= nr_seq_pacote_w;
 
				/* excluir proc_paciente_valor */
 
				delete from proc_paciente_valor 
				where	 nr_seq_procedimento 	= nr_seq_pacote_w 
				and	 ie_tipo_valor		= 3;
				 
			end if;
		end if;
		end;
end loop;
CLOSE C01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_conpaci_desc_pacote (nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

