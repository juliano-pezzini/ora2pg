-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_venc_nota_fiscal_pac ( nr_sequencia_p bigint, dt_base_vencimento_p timestamp) AS $body$
DECLARE


dt_atualizacao_w        			timestamp 		:= clock_timestamp();
cd_estabelecimento_w			smallint;
cd_cgc_emitente_w			varchar(14);
cd_serie_nf_w				nota_fiscal.cd_serie_nf%type;
nr_nota_fiscal_w				varchar(255);
nr_sequencia_nf_w				bigint;
nm_usuario_w				varchar(15);
cd_condicao_pagamento_w			bigint	:= 0;
ie_erro_w					smallint	:= 0;
ie_forma_pagamento_w			smallint	:= 0;
nr_parcela_w				smallint	:= 0;
nr_ult_parcela_w				smallint	:= 0;
tx_fracao_parcela_w			double precision	:= 0;
tx_acrescimo_w				double precision	:= 0;
dt_base_w        				timestamp		:= clock_timestamp();
vl_total_nota_w				double precision	:= 0;
dt_parcela_w     				timestamp		:= clock_timestamp();
vl_parcela_w				double precision	:= 0;
vl_total_w				double precision	:= 0;
cd_natureza_operacao_w			smallint	:= 0;
nr_sequencia_w				bigint;
dt_vencimento_w				timestamp;
nr_seq_protocolo_w			bigint;
ie_tipo_acrescimo_w			varchar(2)	:= 'P';
vl_base_juros_w				double precision;
qt_vencimentos_w				integer;
ds_vencimentos_w				varchar(2000);
nr_interno_conta_w			bigint;

C01 CURSOR FOR
	SELECT	nr_parcela,
		tx_fracao_parcela,
		coalesce(tx_acrescimo,0)
	from	parcela
	where (cd_condicao_pagamento = cd_condicao_pagamento_w)
	and (cd_condicao_pagamento_w <> 1)
	order by nr_parcela;


BEGIN

/* Seleciona dados da nota fiscal - ERRO(1)*/

IE_ERRO_W := 0;
begin
select	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	nm_usuario,
	vl_total_nota,
	nr_seq_protocolo,
	coalesce(cd_condicao_pagamento,0),
	coalesce(cd_natureza_operacao,0),
	nr_interno_conta
INTO STRICT	cd_estabelecimento_w,
	cd_cgc_emitente_w,
	cd_serie_nf_w,
	nr_nota_fiscal_w,
	nr_sequencia_nf_w,
	nm_usuario_w,
	vl_total_nota_w,
	nr_seq_protocolo_w,
	cd_condicao_pagamento_w,
	cd_natureza_operacao_w,
	nr_interno_conta_w
from	nota_fiscal
where	nr_sequencia     = nr_sequencia_p;
exception
     when others then
          IE_ERRO_W := 1;
end;

select	count(*)
into STRICT	qt_vencimentos_w
from	parcela
where (cd_condicao_pagamento = cd_condicao_pagamento_w)
and (cd_condicao_pagamento_w <> 1);

dt_base_w	:= dt_base_vencimento_p;

/* Verifica se nota possui condicao de pagamento - ERRO(2)*/

if (IE_ERRO_W = 0) and (cd_condicao_pagamento_w = 0) then
	IE_ERRO_W := 2;
end if;

/* Seleciona dados da condicao de pagamento - ERRO(3)*/

if (IE_ERRO_W = 0) then
	begin
	select	ie_forma_pagamento,
		coalesce(ie_tipo_acrescimo,'P')
	into STRICT	ie_forma_pagamento_w,
		ie_tipo_acrescimo_w
  	from	condicao_pagamento
	where	cd_condicao_pagamento = cd_condicao_pagamento_w
	and	ie_situacao           = 'A';
      	exception
		when others then
		IE_ERRO_W := 3;
	end;
end if;

/* Seleciona ultima parcela - ERRO(3)*/

if (IE_ERRO_W = 0) then
	begin
	select	max(nr_parcela)
	into STRICT	nr_ult_parcela_w
	from	parcela
	where	cd_condicao_pagamento = cd_condicao_pagamento_w;
      	exception
		when others then
		IE_ERRO_W := 3;
	end;
end if;

/* Elimina dados anteriores */

if (IE_ERRO_W = 0) then
	begin
  	delete 	from nota_fiscal_venc
 	where	nr_sequencia     = nr_sequencia_p;
	exception
		when others then
		IE_ERRO_W := 0;
	end;
end if;

/* Grava condição de pagamento (a vista)*/

if (IE_ERRO_W = 0)	and (ie_forma_pagamento_w = 1) then
	begin
	insert into nota_fiscal_venc(
					cd_estabelecimento,
					cd_cgc_emitente,
					cd_serie_nf,
					nr_nota_fiscal,
					nr_sequencia_nf,
					dt_vencimento,
					vl_vencimento,
					dt_atualizacao,
					nm_usuario,
					nr_sequencia,
					ie_origem)
			      values (	cd_estabelecimento_w,
					cd_cgc_emitente_w,
					cd_serie_nf_w,
					nr_nota_fiscal_w,
					nr_sequencia_nf_w,
					dt_base_w,
					vl_total_nota_w,
					dt_atualizacao_w,
					nm_usuario_w,
					nr_sequencia_p,
					'N');
	exception when others then
		--r.aise_application_error(-20011,'FatVct01: Erro ao gravar vencimento da nota');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265809);
	end;
end if;

/* Grava condição de pagamento (a prazo) */

if (IE_ERRO_W = 0) and (ie_forma_pagamento_w > 1) then
	begin
	if (ie_tipo_acrescimo_w	= 'B') then
		vl_base_juros_w	:= obter_base_acresc_cond_pagto(cd_condicao_pagamento_w,vl_total_nota_w);
	end if;

	SELECT * FROM Calcular_Vencimento(
			cd_estabelecimento_w, cd_condicao_pagamento_w, dt_base_w, qt_vencimentos_w, ds_vencimentos_w) INTO STRICT qt_vencimentos_w, ds_vencimentos_w;

	vl_total_w	:= 0;
	OPEN  C01;
	LOOP
	FETCH C01 into
		nr_parcela_w,
            	tx_fracao_parcela_w,
            	tx_acrescimo_w;
	if	C01%FOUND then
		begin
		dt_parcela_w	:= To_Date(substr(ds_vencimentos_w,1,10),'dd/mm/yyyy');
		ds_vencimentos_w	:= substr(ds_vencimentos_w,12, length(ds_vencimentos_w));

		vl_parcela_w 	:= ((vl_total_nota_w * tx_fracao_parcela_w) / 100);
            		vl_total_w 	:= vl_total_w + vl_parcela_w;

		if (nr_parcela_w = nr_ult_parcela_w) and (vl_total_w <> vl_total_nota_w) then
			vl_parcela_w := vl_parcela_w + (vl_total_nota_w - vl_total_w);
		end if;

		if (cd_natureza_operacao_w > 500) then
			begin
			if (ie_tipo_acrescimo_w = 'P') then
				vl_parcela_w := vl_parcela_w + ((vl_parcela_w * tx_acrescimo_w) / 100);
			elsif (ie_tipo_acrescimo_w = 'B') then
				vl_parcela_w := vl_parcela_w + ((vl_base_juros_w * tx_acrescimo_w) / 100);
			end if;
			end;
		end if;

		insert into nota_fiscal_venc(
			cd_estabelecimento,
			cd_cgc_emitente,
			cd_serie_nf,
			nr_nota_fiscal,
			nr_sequencia_nf,
			dt_vencimento,
			vl_vencimento,
			dt_atualizacao,
			nm_usuario,
			nr_sequencia,
			ie_origem)
		values (	cd_estabelecimento_w,
			cd_cgc_emitente_w,
			cd_serie_nf_w,
			nr_nota_fiscal_w,
			nr_sequencia_nf_w,
			dt_parcela_w,
			vl_parcela_w,
			dt_atualizacao_w,
			nm_usuario_w,
			nr_sequencia_p,
			'N');
		exception when others then
			--r.aise_application_error(-20011,'FatVct01: Erro ao gravar vencimento da nota');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265809);
		end;
	else
		begin
		ie_erro_w := 4;
		exit;
		end;
	end if;
	END LOOP;
	CLOSE C01;
	end;
end if;

if (ie_erro_w = 4) and ((nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') or (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '')) and (cd_condicao_pagamento_w = 1) then
	begin

	if (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
		select	coalesce(max(dt_vencimento), DT_BASE_W)
		into STRICT	dt_vencimento_w
		from	protocolo_convenio
		where	nr_seq_protocolo = nr_seq_protocolo_w;
	elsif (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
		select	coalesce(max(a.dt_vencimento), DT_BASE_W)
		into STRICT	dt_vencimento_w
		from	protocolo_convenio a,
			conta_paciente b
		where	b.nr_seq_protocolo	= a.nr_seq_protocolo
		and	b.nr_interno_conta 	= nr_interno_conta_w;
	end if;


	if (dt_vencimento_w IS NOT NULL AND dt_vencimento_w::text <> '') then
		begin
		insert into nota_fiscal_venc(
						cd_estabelecimento,
						cd_cgc_emitente,
						cd_serie_nf,
						nr_nota_fiscal,
						nr_sequencia_nf,
						dt_vencimento,
						vl_vencimento,
						dt_atualizacao,
						nm_usuario,
						nr_sequencia,
						ie_origem)
				values (	cd_estabelecimento_w,
						cd_cgc_emitente_w,
						cd_serie_nf_w,
						nr_nota_fiscal_w,
						nr_sequencia_nf_w,
						dt_vencimento_w,
						vl_total_nota_w,
						dt_atualizacao_w,
						nm_usuario_w,
						nr_sequencia_p,
						'N');
		exception
			when others then
                	--r.aise_application_error(-20011,'FatVct01: Erro ao gravar vencimento da nota');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265809);
		end;
        end if;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_venc_nota_fiscal_pac ( nr_sequencia_p bigint, dt_base_vencimento_p timestamp) FROM PUBLIC;

