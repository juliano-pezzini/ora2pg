-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_contrato ( nr_seq_contrato_p bigint, ds_compl_aviso_p text, nm_usuario_p text) AS $body$
DECLARE

 
				 
ds_compl_aviso_w		varchar(255);
ds_destino_w		varchar(255);
ds_historico_w		varchar(2000);
ds_objeto_contrato_w	varchar(255);
ds_titulo_w		varchar(255);
nm_contratato_w		varchar(255);		
nm_usuario_lib_w		varchar(15);
qt_tamanho_w		bigint;
ds_titulo_contrato_w	contrato.ds_titulo_contrato%type;
qt_usuarios_w		bigint;
				
c01 CURSOR FOR 
SELECT	distinct 
	substr(a.nm_usuario_lib,1,15) 
from	usuario b, 
	contrato_usuario_lib a 
where	a.nm_usuario_lib	= b.nm_usuario 
and	b.ie_situacao	= 'A' 
and	a.nr_seq_contrato	= nr_seq_contrato_p 
order by	1;

 

BEGIN 
 
select	count(*) 
into STRICT	qt_usuarios_w 
from	usuario b, 
	contrato_usuario_lib a 
where	a.nm_usuario_lib	= b.nm_usuario 
and	b.ie_situacao	= 'A' 
and	a.nr_seq_contrato	= nr_seq_contrato_p;
 
if (qt_usuarios_w = 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(819927);
	/*Esse contrato não possue nenhum usuário informado na aba Liberação usuário. Favor informar pelo menos um usuário nessa aba para poder enviar a comunicação interna.*/
 
end if;
	 
 
ds_destino_w	:= '';
ds_historico_w	:= '';
ds_titulo_w	:= '';
nm_usuario_lib_w	:= '';
 
select	substr(obter_nome_pf_pj(a.cd_pessoa_contratada, a.cd_cgc_contratado),1,255), 
	substr(a.ds_objeto_contrato,1,255), 
	a.ds_titulo_contrato 
into STRICT	nm_contratato_w, 
	ds_objeto_contrato_w, 
	ds_titulo_contrato_w 
from	contrato a 
where	a.nr_sequencia	= nr_seq_contrato_p;
 
 
ds_compl_aviso_w	:= substr(ds_compl_aviso_p,1,255);
ds_titulo_w	:= substr(wheb_mensagem_pck.get_Texto(312734, 'NR_SEQ_CONTRATO_P='|| NR_SEQ_CONTRATO_P),1,255); /*Alteração no contrato: #@NR_SEQ_CONTRATO_P#@*/
 
 
ds_historico_w	:= substr(wheb_mensagem_pck.get_texto(312737, 
			'NR_SEQ_CONTRATO_P='|| NR_SEQ_CONTRATO_P || 
			';DS_TITULO_CONTRATO_W='|| DS_TITULO_CONTRATO_W || 
			';NM_CONTRATATO_W='|| NM_CONTRATATO_W || 
			';DS_OBJETO_CONTRATO_W='|| DS_OBJETO_CONTRATO_W || 
			';DS_OBSERVACAO_W='|| DS_COMPL_AVISO_W),1,2000);
			/*Este contrato foi alterado: 
			Contrato: #@NR_SEQ_CONTRATO_P#@ 
			Título:#@DS_TITULO_CONTRATO_W#@ 
			Contratado: #@NM_CONTRATATO_W#@ 
			Objeto: #@DS_OBJETO_CONTRATO_W#@ 
			Observação: #@DS_OBSERVACAO_W#@*/
 
 
open c01;
loop 
fetch c01 into	 
	nm_usuario_lib_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	qt_tamanho_w	:= 0;
	qt_tamanho_w	:= length(ds_destino_w || nm_usuario_lib_w || ',');
	if (qt_tamanho_w <= 255) then 
		ds_destino_w	:= substr(ds_destino_w || nm_usuario_lib_w || ',' ,1,255);
	end if;
	end;
end loop;
close c01;
 
ds_destino_w	:= substr(ds_destino_w, 1, (length(ds_destino_w) -1));
 
 
	CALL gerar_comunic_padrao(clock_timestamp(), 
			ds_titulo_w, 
			ds_historico_w, 
			nm_usuario_p, 
			'N', 
			ds_destino_w, 
			'N', 
			null, 
			'', 
			null, 
			'', 
			clock_timestamp(), 
			'', 
			'');
 
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_contrato ( nr_seq_contrato_p bigint, ds_compl_aviso_p text, nm_usuario_p text) FROM PUBLIC;

