-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_cod_tit_benef ( nr_seq_segurado_p bigint, ie_titularidade_p text, ie_consistir_p text, nm_usuario_p text) AS $body$
DECLARE


ie_titularidade_ant_w	pls_segurado.ie_titularidade%type;
qt_registro_w		bigint;
cd_matricula_familia_w	pls_segurado.cd_matricula_familia%type;
nr_seq_contrato_w	pls_segurado.nr_seq_contrato%type;


BEGIN

select	max(ie_titularidade),
	max(cd_matricula_familia),
	max(nr_seq_contrato)
into STRICT	ie_titularidade_ant_w,
	cd_matricula_familia_w,
	nr_seq_contrato_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

if (ie_consistir_p = 'S') then
	select 	count(1)
	into STRICT	qt_registro_w
	from	pls_segurado
	where	cd_matricula_familia = cd_matricula_familia_w
	and	nr_seq_contrato = nr_seq_contrato_w
	and	nr_sequencia <> nr_seq_segurado_p
	and	ie_titularidade = ie_titularidade_p;

	if (qt_registro_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Não é permitido código de titularidade duplicado para beneficiários que tenham o mesmo código de matrícula familiar.');
	end if;
end if;

if (ie_titularidade_p <> ie_titularidade_ant_w) then
	update	pls_segurado
	set	ie_titularidade	= ie_titularidade_p
	where	nr_sequencia	= nr_seq_segurado_p;

	CALL pls_gerar_segurado_historico(	nr_seq_segurado_p, '87', clock_timestamp(), 'Código anterior: '||ie_titularidade_ant_w||' - Código alterado: '||ie_titularidade_p,
					'pls_alterar_cod_tit_benef', null, null, null,
					null, clock_timestamp(), null, null,
					null, null, null, null,
					nm_usuario_p, 'N');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_cod_tit_benef ( nr_seq_segurado_p bigint, ie_titularidade_p text, ie_consistir_p text, nm_usuario_p text) FROM PUBLIC;

