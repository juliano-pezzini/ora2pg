-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function aghos_importa_solicitacoes as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE aghos_importa_solicitacoes () AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL aghos_importa_solicitacoes_atx ()';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE aghos_importa_solicitacoes_atx () AS $body$
DECLARE


ds_sep_bv_w			varchar(50);
ds_comando_w			varchar(2000);
nr_internacao_w			integer;
ie_situacao_w			varchar(2);
BEGIN

/*  tabela      GSH_I_INTERN_SOLICI_ENT

IDF_GSH_I_INTERN_SOLICI_(ENT/SAI)	NUMBER			not null
TIP_STATUS 			VARCHAR2(1)		not null	A ¿ Aguardando (registro aguardando ser integrado) / P ¿ Processado (registro já integrado)   / E ¿ Erro (erro na integração)
DES_ERRO 			VARCHAR2(500)		null
DAT_INTEGRACAO 		DATE			not null
DES_USUARIO 			VARCHAR2(15)		not null
COD_CNES_SOLICITANTE 		NUMBER(7)		not null
IDF_PRONTUARIO 		NUMBER(9) 		null
DES_NOME_PACIENTE 		VARCHAR2(60) 		not null
DAT_NASCIMENTO 		DATE 			not null
IDF_SEXO 			NUMBER(2) 		not null     1 - M / 2 - F / 3 - Ambos
IDF_ESTADO_CIVIL 		NUMBER(2) 		null	1 - solteiro / 2 - casado / 3 - divorciado / 4 - viúva (o)
DES_NOME_MAE 			VARCHAR2(60) 		not null
DES_NOME_PAI 			VARCHAR2(60) 		null
COD_CEP 			NUMBER(8) 		not null
NUM_ENDERECO			NUMBER(10) 		not null
DES_COMPLEMENTO 		VARCHAR2(100) 		null
COD_OCUPACAO 			VARCHAR2(6) 		null
IDF_COR_RACA 			NUMBER(2) 		not null	0 ¿ nulo / 1 - branca / 2 - negra /  3 - amarela / 4 - parda / 5 ¿ indígena
COD_NATURALIDADE		NUMBER(7) 		null
COD_NACIONALIDADE 		NUMBER(5) 		null
NUM_IDENTIDADE 		VARCHAR2(20) 		null
NUM_CPF 			NUMBER(11) 		null
NUM_CARTAO_SUS		NUMBER(15) 		null
IDF_INTERNACAO 		NUMBER(9) 		null	retorno do aghos
IDF_PRIORIDADE 			NUMBER(2) 		not null	1 - urgência / 2 - emergência / 3 - eletiva
NUM_CPF_MEDICO_SOLICITANTE 	NUMBER(11) 		not null
COD_PROCEDIMENTO_UNIFICADO 	NUMBER(10) 		not null
COD_CID 			VARCHAR2(4) 		not null
DES_LAUDO_SINAIS_SINTOMAS 	VARCHAR2(1000) 		not null
DES_LAUDO_JUSTIFICATIVA 	VARCHAR2(1000) 		not null
DES_LAUDO_RESULT_DIAGNOSTICO 	VARCHAR2(1000) 		not null
TIP_UTI 				NUMBER(1) 		not null
DES_PRONTUARIO_SOLICITANTE 	VARCHAR2(11) 		null
*/
ds_sep_bv_w  := obter_separador_bv;

ds_comando_w := null;
ds_comando_w :=	'declare '||
		' solici_sai gsh_i_pkg_integra_sai.solici_sai@tasy_aghos; '||
		' ds_erro_ww varchar2(500); '||
		' cd_cgc_w varchar2(14); '||
		' nr_seq_solicitacao_w	number(10); '||
		' var_teste_w varchar2(10); '||
		'begin '||
		'   begin ' ||
		' '||
		' var_teste_w := :var_teste; '||
		' gsh_i_pkg_integra_sai.gsh_i_prc_intern_solici_sai@tasy_aghos(solici_sai); '||
		' '||
		' if (solici_sai.first is not null) then '||
		' for i in solici_sai.first..solici_sai.last loop '||
		' '||
		' begin '||
		' select nr_sequencia '||
		' into nr_seq_solicitacao_w '||
		' from solicitacao_tasy_aghos '||
		' where	nr_internacao = solici_sai(i).idf_internacao '||
		' and rownum = 1; '||
		' exception '||
		' when no_data_found then '||
		' nr_seq_solicitacao_w := 0; '||
		' end; '||
		' '||
		' If (nr_seq_solicitacao_w = 0) and '||
		' (solici_sai(i).idf_prioridade = 3) then '||
		' '||
		' select max(cd_cgc) '||
		' into cd_cgc_w '||
		' from pessoa_juridica '||
		' where	nvl(cd_cnes, ''0'') = solici_sai(i).cod_cnes_solicitante; '||
		' '||
		' insert into solicitacao_tasy_aghos ( '||
		'nr_sequencia, '||
		'dt_atualizacao, '||
		'nm_usuario, '||
		'dt_atualizacao_nrec, '||
		'nm_usuario_nrec, '||
		'nr_internacao, '||
		'ie_urgencia, '||
		'nr_seq_laudo, '||
		'nr_atend_original, '||
		'ie_situacao , '||
		'ie_motivo_rejeicao, '||
		'nr_atendimento, '||
		'ie_erro, '||
		'ds_erro, '||
		'ds_motivo_situacao, '||
		'cd_cgc, '||
		'nm_paciente) '||
		' values (solicitacao_tasy_aghos_seq.nextval, '||
		'sysdate, '||
		'''Aghos'', '||
		'sysdate, '||
		'''Aghos'', '||
		'solici_sai(i).idf_internacao, '||
		'solici_sai(i).idf_prioridade, '||
		'null, '||
		'null, '||
		'''A'', '||
		'null, '||
		'null, '||
		'decode(solici_sai(i).des_erro, null, ''N'', ''S''), '||
		'solici_sai(i).des_erro, '||
		'''Solicitação de outra instituição'', '||
		'cd_cgc_w, '||
		'solici_sai(i).des_nome_paciente); '||
		' '||
		' commit;'||
		' '||
		' gsh_i_prc_intern_solici_s_u@tasy_aghos(solici_sai(i).idf_gsh_i_intern_solici_sai,  '||
		'					 ''P'', '||
		'					 ds_erro_ww); '||
		' end if; '||
		' end loop; '||
		' end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		' exception '||
		' when others then '||
		' rollback; ' ||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		' end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'var_teste=teste');

/* Verifica solicitações rejeitadas */

ds_comando_w :=	'declare '||
		'	rejsol_sai gsh_i_pkg_integra_sai.rejsol_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_rejsol_sai@tasy_aghos(rejsol_sai); '||
		' '||
		'	if	(rejsol_sai.first is not null) then '||
		'		for i in rejsol_sai.first..rejsol_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = rejsol_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''R'', '||
		'					ie_motivo_rejeicao = rejsol_sai(i).idf_motivo_rejeicao, '||
		'					ds_motivo_situacao = substr(obter_valor_dominio(5060, rejsol_sai(i).idf_motivo_rejeicao), 1, 100) '||
		'				where	nr_internacao = rejsol_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_rejsol_s_u@tasy_aghos(	rejsol_sai(i).idf_gsh_i_intern_rejsol_sai,  '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'nr_internacao='|| nr_internacao_w);

/* Verifica solicitações autorizadas clinicamente */

ds_comando_w :=	'declare '||
		'	autcli_sai gsh_i_pkg_integra_sai.autcli_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_autcli_sai@tasy_aghos(autcli_sai); '||
		' '||
		'	if	(autcli_sai.first is not null) then '||
		'		for i in autcli_sai.first..autcli_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = autcli_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''AC'', '||
		'					ds_motivo_situacao = ''Solicitação autorizada clinicamente no Aghos'' '||
		'				where	nr_internacao = autcli_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_autcli_s_u@tasy_aghos(	autcli_sai(i).idf_gsh_i_intern_autcli_sai, '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

/* Verifica solicitações agendadas */

ds_comando_w :=	'declare '||
		'	agenda_sai gsh_i_pkg_integra_sai.agenda_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_agenda_sai@tasy_aghos(agenda_sai); '||
		' '||
		'	if	(agenda_sai.first is not null) then '||
		'		for i in agenda_sai.first..agenda_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = agenda_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''AG'', '||
		'					ds_motivo_situacao = ''Solicitação agendada'' '||
		'				where	nr_internacao = agenda_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_agenda_s_u@tasy_aghos(	agenda_sai(i).idf_gsh_i_intern_agenda_sai,  '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'nr_internacao='|| nr_internacao_w);

/* Verifica solicitações autorizadas */

ds_comando_w :=	'declare '||
		'	autori_sai gsh_i_pkg_integra_sai.autori_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_autori_sai@tasy_aghos(autori_sai); '||
		' '||
		'	if	(autori_sai.first is not null) then '||
		'		for i in autori_sai.first..autori_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = autori_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''AU'', '||
		'					ds_motivo_situacao = ''Solicitação autorizada no Aghos'' '||
		'				where	nr_internacao = autori_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_autori_s_u@tasy_aghos(	autori_sai(i).idf_gsh_i_intern_autori_sai, '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				Aghos_ajusta_leito(	nr_sequencia_w, '||
		'							autori_sai(i).COD_POSTO_ENFERMAGEM, '||
		'							autori_sai(i).COD_ENFERMARIA, '||
		'							autori_sai(i).COD_LEITO, '||
		'							autori_sai(i).COD_DIGITO_LEITO); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'nr_internacao='|| nr_internacao_w);

/* Verifica solicitações canceladas */

ds_comando_w :=	'declare '||
		'	cancel_sai gsh_i_pkg_integra_sai.cancel_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_cancel_sai@tasy_aghos(cancel_sai); '||
		' '||
		'	if	(cancel_sai.first is not null) then '||
		'		for i in cancel_sai.first..cancel_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = cancel_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''C'', '||
		'					ds_motivo_situacao = ''Solicitação cancelada'' '||
		'				where	nr_internacao = cancel_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_cancel_s_u@tasy_aghos(	cancel_sai(i).idf_gsh_i_intern_cancel_sai,  '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'nr_internacao='|| nr_internacao_w);

/* Verifica solicitações internadas */

ds_comando_w :=	'declare '||
		'	intern_sai gsh_i_pkg_integra_sai.intern_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'	nr_sequencia_w	number(10); '||
		'begin '||
		'   begin ' ||
		'	nr_sequencia_w := :nr_internacao; '||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_intern_sai@tasy_aghos(intern_sai); '||
		' '||
		'	if	(intern_sai.first is not null) then '||
		'		for i in intern_sai.first..intern_sai.last loop '||
		' '||
		'			select	max(nr_sequencia) '||
		'			into	nr_sequencia_w '||
		'			from	solicitacao_tasy_aghos '||
		'			where	nr_internacao = intern_sai(i).idf_internacao; '||
		' '||
		'			if	(nr_sequencia_w is not null) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''I'', '||
		'					ds_motivo_situacao = ''Internado (anterior ao Tasy)'' '||
		'				where	nr_internacao = intern_sai(i).idf_internacao; '||
		' '||
		'				gsh_i_prc_intern_intern_s_u@tasy_aghos(	intern_sai(i).idf_gsh_i_intern_intern_sai,  '||
		'									''P'', '||
		'									ds_erro_ww); '||
		' '||
		'				commit; '||
		' '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		' commit; '||
		' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   exception '||
		'   when others then '||
		'      rollback; ' ||
		'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
		'   end; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 'nr_internacao='|| nr_internacao_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_importa_solicitacoes () FROM PUBLIC; -- REVOKE ALL ON PROCEDURE aghos_importa_solicitacoes_atx () FROM PUBLIC;

