-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_mat_lib_nao_atend ( qt_dia_adicional_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, dt_parametro_p timestamp) AS $body$
DECLARE


/* o motivo de baixa deve ser o mesmo utilizado na procedure de baixa das prescrições */

nr_prescricao_w		bigint;
ie_atualiza_estoque_w	varchar(01);
ie_conta_paciente_w		varchar(01);

c010 CURSOR FOR
	SELECT	distinct a.nr_prescricao
	from	Prescr_medica b,
		prescr_material a
	where	a.cd_motivo_baixa	= 0
	and a.nr_prescricao	= b.nr_prescricao
	and b.dt_prescricao 	< (dt_parametro_p - qt_dia_adicional_p)
	and ((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> ''))
	and not exists (SELECT 1
		from cirurgia c
		where c.nr_prescricao = b.nr_prescricao)
	and not exists (select	1
		from	conclusao_recom_apae w
		where	w.nr_prescricao = b.nr_prescricao);


BEGIN

select	coalesce(max(ie_atualiza_estoque),'X'),
	coalesce(max(ie_conta_paciente),'X')
into STRICT	ie_atualiza_estoque_w,
	ie_conta_paciente_w
from	tipo_baixa_prescricao
where	cd_tipo_baixa			= cd_motivo_baixa_p
and	ie_prescricao_devolucao	= 'P';
if (ie_atualiza_estoque_w = 'X') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264590); -- Motivo não cadastrado
elsif (ie_atualiza_estoque_w = 'S') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264591); -- Este motivo baixa estoque. Não pode ser utilizado
elsif (ie_conta_paciente_w = 'S') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264592); -- Este motivo lança na conta do paciente. Não pode ser utilizado
end if;

OPEN C010;
LOOP
FETCH C010 into nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C010 */
	BEGIN
	update	prescr_material
	set	cd_motivo_baixa	= cd_motivo_baixa_p,
		dt_baixa		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_prescricao		= nr_prescricao_w
	and	cd_motivo_baixa	= 0;
	END;
END LOOP;
close c010;

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_mat_lib_nao_atend ( qt_dia_adicional_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, dt_parametro_p timestamp) FROM PUBLIC;

