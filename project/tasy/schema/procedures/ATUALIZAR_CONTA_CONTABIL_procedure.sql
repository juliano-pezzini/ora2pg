-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (nr_interno_conta bigint);


CREATE OR REPLACE PROCEDURE atualizar_conta_contabil ( nr_seq_protocolo_p bigint, ie_atualiza_todos_p text) AS $body$
DECLARE

type Vetor is table of campos index by integer;
i				integer := 1;
Vetor_Conta_w			Vetor;
ie_conta_ok_w	varchar(1);

nr_interno_conta_w			bigint;
qt_reg				bigint;
cd_estabelecimento_w		smallint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_setor_atendimento_w		integer;
ie_classif_convenio_w		varchar(3);
cd_conta_contabil_w		varchar(40);
cd_centro_custo_w			bigint	:= 0;
nr_sequencia_w			bigint;
cd_material_w			bigint;
ie_tipo_atendimento_w		smallint;
ie_tipo_convenio_w			smallint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
ie_clinica_w			integer;
cd_local_estoque_w		smallint;
dt_mesano_referencia_w		timestamp;
nr_atendimento_w			bigint;
cd_plano_w			varchar(10);
ie_regra_pacote_ctb_w		varchar(1);
dt_material_w			timestamp;
dt_procedimento_w			timestamp;
dt_vigencia_w			timestamp;
ie_data_base_atual_conta_w		varchar(15);
ie_complexidade_sus_w		varchar(2);
ie_tipo_financ_sus_w		varchar(4);
cd_estab_logado_w		smallint;
ie_estabelecimento_conta_w		varchar(1);
ie_contab_rec_proc_aih_w		varchar(1);
nr_aih_w				bigint;
cd_proced_aih_unif_w		varchar(255);
cd_conta_contab_aih_w		varchar(20);
ie_cancelamento_w			conta_paciente.ie_cancelamento%type;
ie_complex_aih_orig_w		conta_paciente.ie_complex_aih_orig%type;
nr_seq_proc_interno_w	procedimento_paciente.nr_seq_proc_interno%type;
cd_sequencia_parametro_w	procedimento_paciente.cd_sequencia_parametro%type;
cd_sequencia_parametro_ww   procedimento_paciente.cd_sequencia_parametro%type;

/*Fabio em 12/03/2008
No cursor abaixo, alterei para buscar o estabelecimento da conta ao invez do atendimento.
Isto porque da problemas quando o atendimento e de uma empresa e a conta de outra
EX:OS85313*/
c01 CURSOR FOR
SELECT	d.nr_atendimento,
	a.nr_interno_conta,
	b.nr_sequencia,
	a.cd_estabelecimento,
	b.cd_procedimento,
	b.ie_origem_proced,
	b.cd_setor_atendimento,
	c.ie_classif_contabil,
	c.ie_tipo_convenio,
	d.ie_tipo_atendimento,
	b.cd_convenio,
	b.cd_categoria,
	d.ie_clinica,
	substr(CASE WHEN coalesce(b.nr_seq_proc_pacote,0)=0 THEN 'N'  ELSE 'S' END ,1,1),
	b.dt_procedimento,
	a.ie_complex_aih_orig,
	a.ie_cancelamento,
	b.nr_seq_proc_interno
from	conta_paciente a,
	procedimento_paciente b,
	convenio c,
	atendimento_paciente d
where 	a.nr_seq_protocolo	 	= nr_seq_protocolo_p
and	a.nr_interno_conta		= b.nr_interno_conta
and	a.cd_convenio_parametro	= c.cd_convenio
and	a.nr_atendimento		= d.nr_atendimento
and	((coalesce(b.cd_conta_contabil::text, '') = '') or (coalesce(ie_atualiza_todos_p,'N') = 'S'));

/*Fabio em 12/03/2008
No cursor abaixo, alterei para buscar o estabelecimento da conta ao invez do atendimento.
Isto porque da problemas quando o atendimento e de uma empresa e a conta de outra
EX:OS85313*/
c02 CURSOR FOR
SELECT	d.nr_atendimento,
	a.nr_interno_conta,
	b.nr_sequencia,
	a.cd_estabelecimento,
	b.cd_material,
	b.cd_setor_atendimento,
	c.ie_classif_contabil,
	c.ie_tipo_convenio,
	d.ie_tipo_atendimento,
	b.cd_convenio,
	b.cd_categoria,
	d.ie_clinica,
	b.cd_local_estoque,
	substr(CASE WHEN coalesce(b.nr_seq_proc_pacote,0)=0 THEN 'N'  ELSE 'S' END ,1,1),
	b.dt_atendimento,
	a.ie_complex_aih_orig,
	a.ie_cancelamento
from	conta_paciente a,
	material_atend_paciente b,
	convenio c,
	atendimento_paciente d
where	a.nr_seq_protocolo	 	= nr_seq_protocolo_p
and	a.nr_interno_conta		= b.nr_interno_conta
and	a.cd_convenio_parametro	= c.cd_convenio
and	a.nr_atendimento		= d.nr_atendimento
and	((coalesce(b.cd_conta_contabil::text, '') = '') or (coalesce(ie_atualiza_todos_p,'N') = 'S'));


BEGIN

select	dt_mesano_referencia
into STRICT	dt_mesano_referencia_w
from	protocolo_convenio
where	nr_seq_protocolo = nr_seq_protocolo_p;

cd_estab_logado_w := Wheb_Usuario_Pck.get_cd_estabelecimento;

select	coalesce(max(ie_estabelecimento_conta),'A'),
	coalesce(max(ie_contab_rec_proc_aih),'N')
into STRICT	ie_estabelecimento_conta_w,
	ie_contab_rec_proc_aih_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estab_logado_w;

begin
ie_data_base_atual_conta_w	:= substr(coalesce(Obter_Valor_Param_Usuario(85,151, Obter_Perfil_Ativo, Wheb_Usuario_Pck.GET_NM_USUARIO, Wheb_Usuario_Pck.GET_CD_ESTABELECIMENTO),'MP'),1,15);
exception when others then
	ie_data_base_atual_conta_w	:= 'MP';
end;

dt_vigencia_w	:= dt_mesano_referencia_w;

open C01;
loop
fetch C01 into
	nr_atendimento_w,
	nr_interno_conta_w,
	nr_sequencia_w,
	cd_estabelecimento_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_setor_atendimento_w,
	ie_classif_convenio_w,
	ie_tipo_convenio_w,
	ie_tipo_atendimento_w,
	cd_convenio_w,
	cd_categoria_w,
	ie_clinica_w,
	ie_regra_pacote_ctb_w,
	dt_procedimento_w,
	ie_complex_aih_orig_w,
	ie_cancelamento_w,
	nr_seq_proc_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(cd_plano_convenio)
	into STRICT	cd_plano_w
	from	atend_categoria_convenio
	where	Obter_Atecaco_Atendimento(nr_atendimento_w) = nr_seq_interno;

	cd_centro_custo_w	:= null;
	cd_sequencia_parametro_ww := null;

	if (ie_data_base_atual_conta_w = 'IC') then
		dt_vigencia_w	:= dt_procedimento_w;
	end if;

	begin

	/*APAC*/

	ie_complexidade_sus_w	:= substr(Sus_Obter_Dados_Apac_Conta(nr_interno_conta_w, 'CX','C'),1,2);
	ie_tipo_financ_sus_w	:= substr(Sus_Obter_Dados_Apac_Conta(nr_interno_conta_w, 'TF','C'),1,4);
	/*AIH*/

	if (coalesce(ie_complexidade_sus_w::text, '') = '') and (coalesce(ie_tipo_financ_sus_w::text, '') = '') then
		begin

		if (((ie_cancelamento_w = 'E') or (ie_cancelamento_w = 'C')) and (ie_complex_aih_orig_w IS NOT NULL AND ie_complex_aih_orig_w::text <> '')) then
			ie_complexidade_sus_w	:= ie_complex_aih_orig_w;
		else
			ie_complexidade_sus_w	:= substr(Sus_Obter_Complexidade_Aih(nr_interno_conta_w),1,2);
		end if;


		ie_tipo_financ_sus_w	:= substr(Sus_Obter_Tipo_Financ_Aih(nr_interno_conta_w),1,4);

		select	max(CASE WHEN coalesce(ie_cancelamento_w::text, '') = '' THEN  ie_complexidade  ELSE ie_complex_aih_orig_w END ),
			max(ie_tipo_financiamento)
		into STRICT	ie_complexidade_sus_w,
			ie_tipo_financ_sus_w
		from	sus_aih_unif
		where	nr_interno_conta	= nr_interno_conta_w;
		end;
	end if;
	/*Demais procedimentos*/

	if (coalesce(ie_complexidade_sus_w::text, '') = '') and (coalesce(ie_tipo_financ_sus_w::text, '') = '') then
			select	ie_complexidade,
				ie_tipo_financiamento
			into STRICT	ie_complexidade_sus_w,
				ie_tipo_financ_sus_w
			from	sus_procedimento
			where	cd_procedimento		= cd_procedimento_w
			and	ie_origem_proced	= ie_origem_proced_w  LIMIT 1;
	end if;
	exception when others then
		ie_complexidade_sus_w	:= null;
		ie_tipo_financ_sus_w	:= null;
	end;

	SELECT * FROM define_conta_procedimento(
		cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, 1, ie_clinica_w, cd_setor_atendimento_w, ie_classif_convenio_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w, dt_mesano_referencia_w, cd_conta_contabil_w, cd_centro_custo_w, cd_plano_w, ie_regra_pacote_ctb_w, ie_complexidade_sus_w, ie_tipo_financ_sus_w, null, null, null, ie_cancelamento_w, null, nr_seq_proc_interno_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
		
		cd_sequencia_parametro_ww := philips_contabil_pck.get_parametro_conta_contabil();

		if (ie_contab_rec_proc_aih_w = 'S') then
			nr_aih_w	:= Sus_Obter_Aihunif_Conta(nr_interno_conta_w);
		end if;

		if (ie_contab_rec_proc_aih_w = 'S') and (coalesce(nr_aih_w,0) <> 0) then
			begin
			cd_proced_aih_unif_w	:= Sus_Obter_Proced_Aih_Unif(nr_interno_conta_w,2,'C');
			end;
		end if;

		if (ie_contab_rec_proc_aih_w = 'S') and (coalesce(nr_aih_w,0) <> 0) and (cd_procedimento_w = cd_proced_aih_unif_w) and (coalesce(cd_conta_contabil_w,'X') <> 'X') then
			begin
			cd_conta_contab_aih_w	:= cd_conta_contabil_w;
			end;
		end if;

	update	procedimento_paciente
	set	cd_conta_contabil		= cd_conta_contabil_w,
		cd_centro_custo_receita	= CASE WHEN cd_centro_custo_w=0 THEN null  ELSE cd_centro_custo_w END ,
		cd_sequencia_parametro = cd_sequencia_parametro_ww
	where	nr_sequencia 		= nr_sequencia_w;

	if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
		ie_conta_ok_w	:= 'N';
		if (Vetor_Conta_w.count >= 1) then
			for i in 1..Vetor_Conta_w.count loop
				if (nr_interno_conta_w = Vetor_Conta_w[i].nr_interno_conta) then
					ie_conta_ok_w	:= 'S';
				end if;
			end loop;
		end if;

		if (ie_conta_ok_w = 'N') then
			Vetor_Conta_w(coalesce(Vetor_Conta_w.count,0) + 1).nr_interno_conta	:= nr_interno_conta_w;
		end if;

	end if;

	end;
end loop;
close c01;

if (ie_contab_rec_proc_aih_w = 'S') and (coalesce(cd_conta_contab_aih_w,'X') <> 'X') then
	begin
	update	procedimento_paciente
	set	cd_conta_contabil	= cd_conta_contab_aih_w,
	cd_sequencia_parametro  = cd_sequencia_parametro_ww
	where	nr_interno_conta	= nr_interno_conta_w
	and	((ie_atualiza_todos_p = 'N') or (coalesce(cd_conta_contabil::text, '') = ''));
	end;
end if;

commit;

cd_conta_contabil_w	:= null;
cd_centro_custo_w	:= 0;

open c02;
loop
fetch c02 into
	nr_atendimento_w,
	nr_interno_conta_w,
	nr_sequencia_w,
	cd_estabelecimento_w,
	cd_material_w,
	cd_setor_atendimento_w,
	ie_classif_convenio_w,
	ie_tipo_convenio_w,
	ie_tipo_atendimento_w,
	cd_convenio_w,
	cd_categoria_w,
	ie_clinica_w,
	cd_local_estoque_w,
	ie_regra_pacote_ctb_w,
	dt_material_w,
	ie_complex_aih_orig_w,
	ie_cancelamento_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	qt_reg  := qt_reg + 1;
	cd_sequencia_parametro_w := null;
	begin

	/*APAC*/

	ie_complexidade_sus_w	:= substr(Sus_Obter_Dados_Apac_Conta(nr_interno_conta_w, 'CX','C'),1,2);
	ie_tipo_financ_sus_w	:= substr(Sus_Obter_Dados_Apac_Conta(nr_interno_conta_w, 'TF','C'),1,4);
	/*AIH*/

	if (coalesce(ie_complexidade_sus_w::text, '') = '') and (coalesce(ie_tipo_financ_sus_w::text, '') = '') then

		if (((ie_cancelamento_w = 'E') or (ie_cancelamento_w = 'C')) and (ie_complex_aih_orig_w IS NOT NULL AND ie_complex_aih_orig_w::text <> '')) then
			ie_complexidade_sus_w	:= ie_complex_aih_orig_w;
		else
			ie_complexidade_sus_w	:= substr(Sus_Obter_Complexidade_Aih(nr_interno_conta_w),1,2);
		end if;

		ie_tipo_financ_sus_w	:= substr(Sus_Obter_Tipo_Financ_Aih(nr_interno_conta_w),1,4);

		select	max(CASE WHEN coalesce(ie_cancelamento_w::text, '') = '' THEN  ie_complexidade  ELSE ie_complex_aih_orig_w END ),
			max(ie_tipo_financiamento)
		into STRICT	ie_complexidade_sus_w,
			ie_tipo_financ_sus_w
		from	sus_aih_unif
		where	nr_interno_conta	= nr_interno_conta_w;

	end if;
	exception when others then
		ie_complexidade_sus_w	:= null;
		ie_tipo_financ_sus_w	:= null;
	end;

	select	max(cd_plano_convenio)
	into STRICT	cd_plano_w
	from	atend_categoria_convenio
	where	Obter_Atecaco_Atendimento(nr_atendimento_w) = nr_seq_interno;

	if (ie_data_base_atual_conta_w = 'IC') then
		dt_vigencia_w	:= dt_material_w;
	end if;

	SELECT * FROM define_conta_material(
			cd_estabelecimento_w, cd_material_w, 1, ie_clinica_w, cd_setor_atendimento_w, ie_classif_convenio_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w, cd_local_estoque_w, null, dt_vigencia_w, cd_conta_contabil_w, cd_centro_custo_w, cd_plano_w, ie_regra_pacote_ctb_w, null, ie_complexidade_sus_w, ie_tipo_financ_sus_w, null, ie_cancelamento_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
	
	cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();

	if (coalesce(cd_conta_contab_aih_w::text, '') = '') then
		update	material_atend_paciente
		set	cd_conta_contabil	= cd_conta_contabil_w,
		cd_centro_custo_receita	= CASE WHEN cd_centro_custo_w=0 THEN null  ELSE cd_centro_custo_w END ,
		cd_sequencia_parametro = cd_sequencia_parametro_w
		where	nr_sequencia 	= nr_sequencia_w;
	else
		update	material_atend_paciente
		set	cd_conta_contabil	= cd_conta_contab_aih_w,
		cd_centro_custo_receita	= CASE WHEN cd_centro_custo_w=0 THEN null  ELSE cd_centro_custo_w END ,
		cd_sequencia_parametro = cd_sequencia_parametro_ww
		where	nr_sequencia 	= nr_sequencia_w;
	end if;


	if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
		ie_conta_ok_w	:= 'N';
		if (Vetor_Conta_w.count >= 1) then
			for i in 1..Vetor_Conta_w.count loop
				if (nr_interno_conta_w = Vetor_Conta_w[i].nr_interno_conta) then
					ie_conta_ok_w	:= 'S';
				end if;
			end loop;
		end if;

		if (ie_conta_ok_w = 'N') then
			Vetor_Conta_w(coalesce(Vetor_Conta_w.count,0) + 1).nr_interno_conta	:= nr_interno_conta_w;
		end if;

	end if;

	end;
end loop;
close c02;

/* OS 622899
if	(Vetor_Conta_w.count >= 1) then
	for i in 1..Vetor_Conta_w.count loop
		atualizar_resumo_conta(Vetor_Conta_w(i).nr_interno_conta,2);
	end loop;
end if;
*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_conta_contabil ( nr_seq_protocolo_p bigint, ie_atualiza_todos_p text) FROM PUBLIC;

