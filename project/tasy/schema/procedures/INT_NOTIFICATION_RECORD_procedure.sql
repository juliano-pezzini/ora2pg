-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE int_notification_record (cd_notificacao_integracao_p text DEFAULT 'SV',cd_registro_notificacao_p text DEFAULT 'SVI',msg_identificacao_registro text DEFAULT NULL) AS $body$
DECLARE

				
	
	nr_sequencia_w   	          varchar(10);
	ds_nome_usuario_destino_w	  varchar(200);
	ds_title_w	  				  varchar(200);	
	
	c2_w CURSOR FOR SELECT
      a.CD_PERFIL,
      a.CD_PESSOA_FISICA
	FROM REGRA_NOT_INTEGRACAO a
	WHERE ((a.CD_NOTIFICACAO_INTEGRACAO = cd_notificacao_integracao_p) OR (a.CD_NOTIFICACAO_INTEGRACAO IS NOT NULL AND a.CD_NOTIFICACAO_INTEGRACAO::text <> ''))
	  and ((a.CD_REGISTRO_NOTIFICACAO = cd_registro_notificacao_p) OR (a.CD_REGISTRO_NOTIFICACAO IS NOT NULL AND a.CD_REGISTRO_NOTIFICACAO::text <> ''));	

	r2_w c2_w % rowtype;


BEGIN
	OPEN c2_w;<<

	loop_insert >> LOOP

	FETCH c2_w
	INTO r2_w;

	EXIT WHEN NOT FOUND; /* apply on c2_w  */

    BEGIN  
    
    SELECT coalesce(OBTER_EXPRESSAO_DIC_OBJETO(1150429),null)
    into STRICT ds_title_w  
;

    SELECT coalesce(OBTER_USUARIO_ATIVO_PF(r2_w.CD_PESSOA_FISICA),null)
    into STRICT ds_nome_usuario_destino_w 
;

    SELECT nextval('device_int_notification_seq') 
    into STRICT nr_sequencia_w  
;

		INSERT INTO device_int_notification(
			nr_sequencia,         
			dt_atualizacao,      
			nm_usuario,           
			dt_atualizacao_nrec, 
			nm_usuario_nrec,      
			ds_titulo,          
			ds_conteudo,         
			nm_usuario_destino,
			cd_perfil,            
			dt_criacao,           
			cd_grupos_destino,    
			cd_setores_desitno  
			)
		VALUES (
			 nr_sequencia_w
			,clock_timestamp()			
			,'integration'
			,clock_timestamp()
			,'integration'
			,ds_title_w
			,msg_identificacao_registro
			,ds_nome_usuario_destino_w
			,r2_w.cd_perfil
			,clock_timestamp()
			,null
			,null			
			);

		exception when others then CALL gravar_log_sistema(20304,'INT_NOTIFICATION_RECORD - '|| msg_identificacao_registro || ' Usuario(cd_pessoa_fisica): ' || ds_nome_usuario_destino_w || ' - ' || SUBSTR(SQLERRM, 1, 200), 'integration');

		GOTO loop_insert;
	END;
END

LOOP;

CLOSE c2_w;

COMMIT;

RAISE NOTICE 'INT_NOTIFICATION_RECORD: Executado com sucesso.';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE int_notification_record (cd_notificacao_integracao_p text DEFAULT 'SV',cd_registro_notificacao_p text DEFAULT 'SVI',msg_identificacao_registro text DEFAULT NULL) FROM PUBLIC;

