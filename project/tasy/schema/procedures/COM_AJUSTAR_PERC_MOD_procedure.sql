-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_ajustar_perc_mod ( nm_usuario_p text, nr_seq_cliente_p bigint, dt_importacao_p timestamp default null) AS $body$
DECLARE


nr_seq_mod_implant_w		bigint; --FK tabela funcao e modulo implantacao
nr_seq_mod_implant_com_w	bigint; --Busca a sequencia  da tabela COM_CLIENTE_MOD_IMPL
cd_funcao_w			bigint;
dt_atualizacao_funcao_w		timestamp;
qt_funcao_modulo_w		bigint;
qt_funcao_modulo_utilizado_w	bigint;
cd_cnpj_w			varchar(14);
dt_importacao_w			com_cliente_mod_impl.dt_importacao%type;


c02 CURSOR FOR
SELECT	a.nr_seq_mod_impl,
	a.cd_funcao
from	funcao a,
	modulo_implantacao b
where	b.nr_sequencia = a.nr_seq_mod_impl
and	b.ie_comercial = 'S'
and	exists (
			SELECT	1
			from	com_cliente_mod_impl
			where	nr_seq_modulo = a.nr_seq_mod_impl
		)
and	not exists (
				select 1
				from com_cliente_mod_impl m,
					com_cliente_fun_impl f
				where m.nr_sequencia = f.nr_seq_mod_impl
				and m.nr_seq_cliente = nr_seq_cliente_p
				and trunc(m.dt_importacao) = trunc(dt_importacao_w)
				and cd_funcao        = a.cd_funcao
			);

c03 CURSOR FOR
	SELECT	nr_sequencia
	from	com_cliente_mod_impl
	where	nr_seq_cliente = nr_seq_cliente_p
	and	trunc(dt_importacao) = trunc(dt_importacao_w);
	

BEGIN

dt_importacao_w := coalesce(dt_importacao_p, clock_timestamp());

select	max(cd_cnpj)
into STRICT	cd_cnpj_w
from	com_cliente
where	nr_sequencia = nr_seq_cliente_p;

-- Para as funcoes definidas manualmente inicialmente atribui como utilizadas
update	com_cliente_fun_impl
set	ie_utilizacao = 'U'
where	coalesce(ie_utilizacao::text, '') = ''
and	nr_seq_mod_impl in (	SELECT	nr_sequencia 
				from	com_cliente_mod_impl 
				where	nr_seq_cliente = nr_seq_cliente_p
				and	trunc(dt_importacao) = trunc(dt_importacao_w));

--Insere as demais funcoes para realizar o calculo de porcentagem ao final
open c02;
loop
fetch c02 into
	nr_seq_mod_implant_w,	
	cd_funcao_w;	
EXIT WHEN NOT FOUND; /* apply on c02 */
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_mod_implant_com_w
	from	com_cliente_mod_impl a
	where	a.nr_seq_cliente = nr_seq_cliente_p
	and	trunc(a.dt_importacao) = trunc(dt_importacao_w)
	and	a.nr_seq_modulo = nr_seq_mod_implant_w;
	
	if (nr_seq_mod_implant_com_w IS NOT NULL AND nr_seq_mod_implant_com_w::text <> '') then
		begin		
			insert into com_cliente_fun_impl(
				nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_mod_impl,
				cd_funcao,
				dt_inicio_util,
				ie_utilizacao)
			values (	nextval('com_cliente_fun_impl_seq'),
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_mod_implant_com_w,
				cd_funcao_w,
				dt_atualizacao_funcao_w,
				'NA');
		end;
	end if;
end loop;
close c02;

open c03;
loop
fetch c03 into
	nr_seq_mod_implant_com_w;
EXIT WHEN NOT FOUND; /* apply on c03 */

	select	count(1)
	into STRICT	qt_funcao_modulo_w
	from	com_cliente_mod_impl a,
		com_cliente_fun_impl b
	where	a.nr_seq_cliente = nr_seq_cliente_p
	and	trunc(a.dt_importacao) = trunc(dt_importacao_w)
	and	a.nr_sequencia = b.nr_seq_mod_impl
	and	a.nr_sequencia = nr_seq_mod_implant_com_w;

	select	count(1)
	into STRICT	qt_funcao_modulo_utilizado_w
	from	com_cliente_mod_impl a,
		com_cliente_fun_impl b
	where	a.nr_seq_cliente = nr_seq_cliente_p
	and	trunc(a.dt_importacao) = trunc(dt_importacao_w)
	and	a.nr_sequencia = b.nr_seq_mod_impl
	and 	b.ie_utilizacao = 'U'
	and	a.nr_sequencia = nr_seq_mod_implant_com_w;
		
	if (qt_funcao_modulo_w > 0) then	
		update	com_cliente_mod_impl
		set	pr_utilizacao = ((100 * qt_funcao_modulo_utilizado_w) / qt_funcao_modulo_w)
		where	nr_sequencia = nr_seq_mod_implant_com_w
		and	nr_seq_cliente	= nr_seq_cliente_p;
	end if;

end loop;
close c03;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_ajustar_perc_mod ( nm_usuario_p text, nr_seq_cliente_p bigint, dt_importacao_p timestamp default null) FROM PUBLIC;

