-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_sae_mentor ( nr_atendimento_p bigint, nr_seq_pend_pac_acao_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text) AS $body$
DECLARE


nr_sequencia_w				bigint;
cd_prescritor_w				varchar(10);
cd_pessoa_fisica_w			varchar(10);
cd_setor_atendimento_w		bigint;
nr_seq_proc_w				bigint;
dt_primeiro_horario_w		timestamp;
ie_Prim_Hor_Sae_w			varchar(10);
ie_Prox_Hor_Setor_w			varchar(1);
dt_validade_prescr_w		timestamp;
dt_inicio_prescr_w			timestamp;
qt_horas_validade_w			smallint := 24;
ie_estender_w				varchar(10);
sql_errm_w					varchar(2000);
ie_agora_w					varchar(1) := 'N';


BEGIN

--obter_param_usuario(281,388,obter_perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo,ie_Prim_Hor_Sae_w);
ie_Prim_Hor_Sae_w := obter_param_usuario(355, 4, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_Prim_Hor_Sae_w);
ie_estender_w := obter_param_usuario(281, 775, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_estender_w);
ie_Prox_Hor_Setor_w := obter_param_usuario(281, 782, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_Prox_Hor_Setor_w);


select	nextval('pe_prescricao_seq')
into STRICT	nr_sequencia_w
;

select	max(substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10)),		
		max(obter_setor_Atendimento(nr_atendimento_p))
into STRICT	cd_prescritor_w,
		cd_setor_atendimento_w
;


if (coalesce(nr_atendimento_p,0) > 0) then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
else
	cd_pessoa_fisica_w := cd_pessoa_fisica_p;
end if;

dt_primeiro_horario_w := clock_timestamp();

if (ie_Prim_Hor_Sae_w = 'A') then
	ie_agora_w := 'S';
end if;

if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') and (ie_Prim_Hor_Sae_w = 'S') then
	
    select	max(to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' ' || to_char(hr_inicio_prescricao_sae,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'))
    into STRICT	dt_primeiro_horario_w
    from	setor_Atendimento
    where	cd_setor_atendimento = cd_setor_atendimento_w;

    if (ie_Prox_Hor_Setor_w = 'S') and ((trim(both dt_primeiro_horario_w) IS NOT NULL AND (trim(both dt_primeiro_horario_w))::text <> '')) and (dt_primeiro_horario_w < clock_timestamp()) then
    	select	max(to_date(to_char(clock_timestamp() + interval '1 days'/24,'dd/mm/yyyy hh24') || ':00:00','dd/mm/yyyy hh24:mi:ss'))
    	into STRICT	dt_primeiro_horario_w
    	;
    end if;
	
elsif (ie_Prim_Hor_Sae_w = 'C') then
		select	max(to_date(to_char(clock_timestamp() + interval '1 days'/24,'dd/mm/yyyy hh24') || ':00:00','dd/mm/yyyy hh24:mi:ss'))
		into STRICT	dt_primeiro_horario_w
		;
elsif (ie_Prim_Hor_Sae_w = 'H') then	

	select	max(to_date(to_char(coalesce(dt_atualizacao_nrec,clock_timestamp()) +1/24,'dd/mm/yyyy hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss'))
    into STRICT	dt_primeiro_horario_w
	from   gqa_pend_pac_acao
	where  nr_sequencia = nr_seq_pend_pac_acao_p;

end if;

/*  OS 957482
if	(cd_setor_atendimento_w is not null) and 
	(ie_Prim_Hor_Sae_w = '1') then

	
	select	max(to_date(to_char(sysdate,'dd/mm/yyyy')||' ' || to_char(hr_inicio_prescricao_sae,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'))
	into	dt_primeiro_horario_w
	from	setor_Atendimento 
	where	cd_setor_atendimento = cd_setor_atendimento_w;
	
	
	if	(ie_Prox_Hor_Setor_w = 'S') and
		(Trim(dt_primeiro_horario_w) is not null) and
		(dt_primeiro_horario_w < sysdate) then
		select	max(to_date(to_char(sysdate +1/24,'dd/mm/yyyy hh') || ':00:00','dd/mm/yyyy hh24:mi:ss'))
		into	dt_primeiro_horario_w
		from	dual;
	end if;
elsif	(ie_Prim_Hor_Sae_w = '2') or
		(ie_Prim_Hor_Sae_w = '4') then
		select	max(to_date(to_char(sysdate +1/24,'dd/mm/yyyy hh') || ':00:00','dd/mm/yyyy hh24:mi:ss'))
		into	dt_primeiro_horario_w
		from	dual;
elsif	(ie_Prim_Hor_Sae_w = '5') then
	select	max(to_date(trunc(sysdate) || ' ' || to_char(Obter_Prim_Horario_Prescricao(nr_atendimento_p,cd_setor_atendimento_w,sysdate,nm_usuario_p,'S'),'hh24:mi')||':00','dd/mm/yyyy hh24:mi:ss'))
	into	dt_primeiro_horario_w
	from	dual;
end if;
*/
select	max(Obter_Inicio_Prescr_Sae(cd_setor_atendimento_w,clock_timestamp(),dt_primeiro_horario_w))
into STRICT	dt_inicio_prescr_w
;

/*
if	(dt_inicio_prescr_w is not null) then
	if	(ie_Prim_Hor_Sae_w = '4') then
		obter_data_equipe_leito('VA',null,dt_validade_prescr_w);
	else
		dt_validade_prescr_w := dt_inicio_prescr_w + (qt_horas_validade_w / 24 - 1/86400);
	end if;
end if;
*/
insert into pe_prescricao(	nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_prescricao,
							cd_prescritor,
							nr_atendimento,
							cd_pessoa_fisica,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							qt_horas_validade,
							ie_situacao,
							cd_setor_atendimento,
							ie_rn,
							nr_seq_pend_pac_acao,
							dt_primeiro_horario,
							dt_validade_prescr,
                                   ie_agora)
			values (		nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							cd_prescritor_w,
							nr_atendimento_p,
							cd_pessoa_fisica_w,
							clock_timestamp(),
							nm_usuario_p,
							qt_horas_validade_w,
							'A',
							cd_setor_atendimento_w,
							'N',
							nr_seq_pend_pac_acao_p,
							dt_primeiro_horario_w,
							dt_validade_prescr_w,
                            ie_agora_w);

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_sae_mentor ( nr_atendimento_p bigint, nr_seq_pend_pac_acao_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text) FROM PUBLIC;

