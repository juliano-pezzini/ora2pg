-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_adep_web_futuro ( nr_atendimento_p adep_horarios_web.nr_atendimento%type, id_sessao_p adep_horarios_web.id_sessao_web%type, nm_usuario_p adep_horarios_web.nm_usuario%type) AS $body$
DECLARE


ds_exp_inicio_w			varchar(100);
ds_date_mask_w  		varchar(30);
cd_pessoa_fisica_w      atendimento_paciente.cd_pessoa_fisica%type;


BEGIN
    ds_exp_inicio_w := obter_desc_expressao_idioma(648277, null, wheb_usuario_pck.get_nr_seq_idioma);
    ds_date_mask_w :=  pkg_date_formaters.localize_mask('shortDate', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario));

    select cd_pessoa_fisica
    into STRICT cd_pessoa_fisica_w
    from atendimento_paciente
    where nr_atendimento = nr_atendimento_p;

    insert into adep_horarios_web(id_sessao_web, nm_usuario, dt_atualizacao_nrec, nr_seq_ordem, nr_sequencia,
        ie_tipo_item, ie_acm_sn, ds_prescrito, ds_prescrito_cpoe, nr_seq_cpoe,
        nr_atendimento, ie_classif_adep, ie_ordem)
	SELECT id_sessao_p, nm_usuario_p, clock_timestamp(), tbl.nr_seq_ordem, tbl.nr_sequencia, tbl.ie_tipo_item, 'N', tbl.ds_prescrito, substr(tbl.ds_prescrito ||' '||' <span style=''color:#0096ED; padding-left:10px;'' class=''DS_MAT_IDENTIFIC''>'||ds_exp_inicio_w ||' '|| pkg_date_formaters.to_varchar(tbl.dt_inicio, ds_date_mask_w, null) ||'</span>',1,1900), tbl.nr_seq_cpoe, tbl.nr_atendimento, 'FUT', 10
    from (
        -- DIETAS
        SELECT distinct DIETA.NR_ATENDIMENTO ,
                CASE WHEN dieta.ie_tipo_dieta='L' THEN  obter_desc_material(cd_mat_prod1) WHEN dieta.ie_tipo_dieta='E' THEN  obter_desc_material(cd_material) WHEN dieta.ie_tipo_dieta='S' THEN  obter_desc_material(cd_material) WHEN dieta.ie_tipo_dieta='I' THEN  obter_desc_expressao( CASE WHEN  cpoe_obter_tipo_npt(cd_pessoa_fisica_w, dieta.nr_atendimento)='I' THEN  722485  ELSE 305334 END  ) WHEN dieta.ie_tipo_dieta='P' THEN  obter_desc_expressao(607186) WHEN dieta.ie_tipo_dieta='J' THEN  Obter_desc_tipo_jejum(nr_seq_tipo)  ELSE OBTER_DESC_DIETA(coalesce(DIETA.CD_DIETA,0)) END  AS DS_PRESCRITO,
                DIETA.DT_INICIO,
                DIETA.NR_SEQUENCIA AS NR_SEQUENCIA,
                DIETA.NR_SEQUENCIA AS NR_SEQ_CPOE,
                CASE WHEN ie_tipo_dieta='L' THEN  'LD' WHEN ie_tipo_dieta='E' THEN  'SNE' WHEN ie_tipo_dieta='S' THEN  'S' WHEN ie_tipo_dieta='I' THEN  CASE WHEN  cpoe_obter_tipo_npt(cd_pessoa_fisica_w, dieta.nr_atendimento)='I' THEN  'NPP'  ELSE 'NPN' END  WHEN ie_tipo_dieta='P' THEN  'NAN' WHEN ie_tipo_dieta='J' THEN  'J'  ELSE 'D' END  AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep(
                    CASE WHEN ie_tipo_dieta='L' THEN  'LD' WHEN ie_tipo_dieta= -- leites e derivados
                        'E' THEN  'SNE' WHEN ie_tipo_dieta= -- dieta enteral
                        'S' THEN  'S' WHEN ie_tipo_dieta= -- suplementos
                        'I' THEN  CASE WHEN  cpoe_obter_tipo_npt(cd_pessoa_fisica_w, dieta.nr_atendimento)='I' THEN  'NPP'  ELSE 'NPN' END  WHEN ie_tipo_dieta= -- npt infantil/pediatrica
                        'P' THEN  'NAN' WHEN ie_tipo_dieta= -- npt adulta
                        'J' THEN  'J'  ELSE  -- jejum
                        'D' /* dieta oral */ END  , 'R', null ) AS NR_SEQ_ORDEM 
                    , dieta.dt_suspensao 
                    , dieta.dt_liberacao
        FROM CPOE_DIETA DIETA
        -- MEDICAMENTOS
       
UNION ALL

        SELECT  MEDICAMENTO.NR_ATENDIMENTO,
                OBTER_DESC_MATERIAL(coalesce(MEDICAMENTO.CD_MATERIAL,0)) AS DS_PRESCRITO,
                MEDICAMENTO.DT_INICIO,
                coalesce(MEDICAMENTO.NR_SEQUENCIA,1) AS NR_SEQUENCIA,
                MEDICAMENTO.NR_SEQUENCIA AS NR_SEQ_CPOE,
                CASE WHEN medicamento.ie_controle_tempo='S' THEN  'SOL'  ELSE 'M' END  AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep(CASE WHEN medicamento.ie_controle_tempo='S' THEN  'SOL'  ELSE 'M' END , 'R', null) AS NR_SEQ_ORDEM
                    , medicamento.dt_suspensao 
                    , medicamento.dt_liberacao
        FROM CPOE_MATERIAL MEDICAMENTO
        WHERE coalesce(MEDICAMENTO.IE_MATERIAL, 'Z') = 'N'
--        MATERIAL
        
UNION ALL

        SELECT  MATERIAL.NR_ATENDIMENTO,
                OBTER_DESC_MATERIAL(coalesce(MATERIAL.CD_MATERIAL,0)) AS DS_PRESCRITO,
                MATERIAL.DT_INICIO,
                coalesce(MATERIAL.NR_SEQUENCIA,1) AS NR_SEQUENCIA,
                MATERIAL.NR_SEQUENCIA AS NR_SEQ_CPOE,
                'MAT' AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep('MAT', 'R', null) AS NR_SEQ_ORDEM
                    , material.dt_suspensao 
                    , material.dt_liberacao
        FROM CPOE_MATERIAL MATERIAL
        WHERE coalesce(MATERIAL.IE_MATERIAL, 'Z') = 'S'
        --RECOMENDACAO
        
UNION ALL

        SELECT  RECOMENDACAO.NR_ATENDIMENTO,
                OBTER_DESC_RECOMENDACAO(coalesce(RECOMENDACAO.CD_RECOMENDACAO,0)) AS DS_PRESCRITO,
                RECOMENDACAO.DT_INICIO,
                RECOMENDACAO.NR_SEQUENCIA AS NR_SEQUENCIA,
                RECOMENDACAO.NR_SEQUENCIA AS NR_SEQ_CPOE,
                'R' AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep('R', 'R', null) AS NR_SEQ_ORDEM    
                    , recomendacao.dt_suspensao 
                    , recomendacao.dt_liberacao
        FROM CPOE_RECOMENDACAO RECOMENDACAO
        --GASOTERAPIA
        
UNION ALL

        SELECT  GASOTERAPIA.NR_ATENDIMENTO,
                OBTER_DESC_GAS(coalesce(GASOTERAPIA.NR_SEQ_GAS,0)) AS DS_PRESCRITO,
                GASOTERAPIA.DT_INICIO,
                GASOTERAPIA.NR_SEQUENCIA AS NR_SEQUENCIA,
                GASOTERAPIA.NR_SEQUENCIA AS NR_SEQ_CPOE,
                'O' AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep('O', 'R', null) AS NR_SEQ_ORDEM    
                    , gasoterapia.dt_suspensao 
                    , gasoterapia.dt_liberacao
        FROM CPOE_GASOTERAPIA GASOTERAPIA  
        -- HEMOTERAPIAS - BLOOD PRODUCTS
        
UNION ALL

        select distinct HEMOTERAPIA.nr_atendimento,
                substr(obter_desc_san_derivado(HEMOTERAPIA.nr_seq_derivado),1,150) as ds_prescrito,
                HEMOTERAPIA.dt_inicio as dt_inicio,
                HEMOTERAPIA.nr_sequencia as nr_sequencia, --* nao tem na hemoterapia
                HEMOTERAPIA.nr_sequencia as nr_seq_cpoe,
                'HM' as ie_tipo_item,
                obter_ordem_informacoes_adep('HM', 'R', null) as nr_seq_ordem
                    , hemoterapia.dt_suspensao 
                    , hemoterapia.dt_liberacao
        from cpoe_hemoterapia HEMOTERAPIA
        where (HEMOTERAPIA.nr_seq_derivado IS NOT NULL AND HEMOTERAPIA.nr_seq_derivado::text <> '')
        --HEMOTERAPIA - PROCEDURE
        
UNION ALL

        SELECT distinct HEMOTERAPIA.NR_ATENDIMENTO,
                SUBSTR(OBTER_DESC_PRESCR_PROC(hemoterapia.CD_PROCEDIMENTO, hemoterapia.IE_ORIGEM_PROCED, HEMOTERAPIA.NR_SEQ_PROC_INTERNO),1,60) AS DS_PRESCRITO,
                hemoterapia.DT_INICIO as DT_INICIO,
                HEMOTERAPIA.NR_SEQUENCIA AS NR_SEQUENCIA,
                HEMOTERAPIA.NR_SEQUENCIA AS NR_SEQ_CPOE,
                'HM' AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep('HM', 'R', null) AS NR_SEQ_ORDEM
                    , hemoterapia.dt_suspensao 
                    , hemoterapia.dt_liberacao
        FROM CPOE_HEMOTERAPIA HEMOTERAPIA
        WHERE (HEMOTERAPIA.CD_PROCEDIMENTO IS NOT NULL AND HEMOTERAPIA.CD_PROCEDIMENTO::text <> '')
        --EXAMES E PROCEDIMENTOS - COLETA1   
        
UNION ALL

        SELECT DISTINCT PROCED.NR_ATENDIMENTO,
                substr(cpoe_obter_desc_proc_interno(proced.nr_seq_proc_interno),1,255) AS DS_PRESCRITO,
                PROCED.DT_INICIO AS DT_INICIO,
                PROCED.NR_SEQUENCIA AS NR_SEQUENCIA,
                PROCED.NR_SEQUENCIA AS NR_SEQ_CPOE,
                case
                    when proci.ie_ctrl_glic = 'CIG' then 'C'
                    when proci.ie_ctrl_glic = 'CCG' then 'G'
                    when(coalesce(proci.ie_ctrl_glic::text, '') = '' or proci.ie_ctrl_glic = 'NC') and (proci.nr_seq_exame_lab IS NOT NULL AND proci.nr_seq_exame_lab::text <> '') then 'L'
                else
                    'P'
                end AS IE_TIPO_ITEM,
                case
                    when proci.ie_ctrl_glic = 'CIG' then obter_ordem_informacoes_adep('C', 'R', null)
                    when proci.ie_ctrl_glic = 'CCG' then obter_ordem_informacoes_adep('G', 'R', null)
                    when(coalesce(proci.ie_ctrl_glic::text, '') = '' or proci.ie_ctrl_glic = 'NC') and (proci.nr_seq_exame_lab IS NOT NULL AND proci.nr_seq_exame_lab::text <> '') then obter_ordem_informacoes_adep('L', 'R', null)
                else
                    obter_ordem_informacoes_adep('P', 'R', 'P')
                end AS NR_SEQ_ORDEM
                    , proced.dt_suspensao 
                    , proced.dt_liberacao
        FROM CPOE_PROCEDIMENTO PROCED, PROC_INTERNO PROCI
        WHERE PROCED.NR_SEQ_PROC_INTERNO = PROCI.NR_SEQUENCIA
        --EXAME DE ANATOMIA PATOLOGICA - COLETA2
        
UNION ALL

        SELECT DISTINCT PROCED.NR_ATENDIMENTO,
                substr(cpoe_obter_desc_proc_interno(nr_seq_proc_interno),1,255) AS DS_PRESCRITO,
                PROCED.DT_INICIO,
                PROCED.NR_SEQUENCIA AS NR_SEQUENCIA,
                PROCED.NR_SEQUENCIA AS NR_SEQ_CPOE,
                'L' AS IE_TIPO_ITEM,
                obter_ordem_informacoes_adep('L', 'R', null) AS NR_SEQ_ORDEM   
                    , proced.dt_suspensao 
                    , proced.dt_liberacao
        FROM CPOE_ANATOMIA_PATOLOGICA PROCED
    ) tbl
    where
        pkg_date_formaters.to_varchar(tbl.DT_INICIO, 'YYYY-MM-DD', NULL) > pkg_date_formaters.to_varchar(clock_timestamp(), 'YYYY-MM-DD', NULL)
        and (tbl.DT_LIBERACAO IS NOT NULL AND tbl.DT_LIBERACAO::text <> '')
        and coalesce(tbl.dt_suspensao::text, '') = ''
        and tbl.nr_atendimento = nr_atendimento_p
    order by tbl.nr_seq_ordem asc, tbl.dt_inicio asc;

 commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_adep_web_futuro ( nr_atendimento_p adep_horarios_web.nr_atendimento%type, id_sessao_p adep_horarios_web.id_sessao_web%type, nm_usuario_p adep_horarios_web.nm_usuario%type) FROM PUBLIC;

