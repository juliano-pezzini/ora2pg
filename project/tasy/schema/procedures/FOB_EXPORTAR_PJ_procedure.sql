-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fob_exportar_pj ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE


contador_w	bigint;	
ds_arquivo_w	varchar(4000);
ds_linha_w	varchar(4000);
nr_linha_w	bigint := 0;
sep_w		varchar(1) := '';

c01 CURSOR FOR
	SELECT	rpad(substr(p.cd_cgc,1,14),14,' ') cd_cgc,
		rpad(substr(p.ds_razao_social,1,255),255,' ') ds_razao_social,
		rpad(substr((p.ds_endereco || p.nr_endereco),1,80),80,' ') ds_endereco,
		rpad(substr(obter_dados_pf_pj('',p.cd_cgc,'CDMDV'),1,8),8,' ') cd_municipio_ibge,
		rpad(substr(elimina_caractere_especial(p.cd_cep),1,8),8,' ') cd_cep,
		rpad(substr(p.ds_bairro,1,20),20,' ') ds_bairro,
		rpad(substr(CASE WHEN coalesce(obter_dados_pf_pj('',p.cd_cgc,'CDMDV'),'0')='0' THEN p.ds_municipio  ELSE ' ' END ,1,20),20,' ') ds_cidade,
		rpad(substr(CASE WHEN coalesce(obter_dados_pf_pj('',p.cd_cgc,'CDMDV'),'0')='0' THEN p.sg_estado  ELSE ' ' END ,1,2),2,' ') sg_estado,
		rpad(substr((p.nr_ddi_telefone || p.nr_ddd_telefone || p.nr_telefone),1,12),12,' ') nr_telefone,
		rpad(' ',8,' ') dt_nascimento,
		rpad(substr(p.nr_inscricao_municipal,1,20), 20, ' ') nr_inscricao_municipal,
		rpad(' ',11,' ') nr_inscricao_inss,
		rpad(' ',6,' ') nr_cbo,
		rpad(' ',2,' ') nr_sefip,
		rpad('N',1,' ') ds_rpa,
		rpad(' ',3,' ') ds_banco,
		rpad(' ',8,' ') cd_agencia,
		rpad(' ',30,' ') nm_agencia,
		rpad(' ',12,' ') nr_conta,
		rpad(' ',8,' ') dt_inclusao_sistema,
		rpad(' ',8,' ') dt_ultima_geracao,
		p.cd_cgc cd_cnpj
	from	pessoa_juridica p
	where	dt_atualizacao_nrec between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	and	not exists (	SELECT 	1
				from 	pj_integracao_envio x
				where	x.cd_cnpj = p.cd_cgc);
	--where	p.dt_easy_way is null;
vet01	c01%rowtype;
	

BEGIN
delete 	from w_dacon
where	nm_usuario = nm_usuario_p;
commit;

open c01;
loop
fetch c01 into	
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	-- Montagem das linhas do arquivo
	ds_linha_w :=	substr(	sep_w 	|| 	vet01.cd_cgc			|| sep_w ||
						vet01.ds_razao_social		|| sep_w ||
						vet01.ds_endereco			|| sep_w ||
						vet01.cd_municipio_ibge		|| sep_w ||
						vet01.cd_cep			|| sep_w ||
						vet01.ds_bairro			|| sep_w ||
						vet01.ds_cidade			|| sep_w ||
						vet01.sg_estado			|| sep_w ||
						vet01.nr_telefone			|| sep_w ||
						vet01.dt_nascimento		|| sep_w ||
						vet01.nr_inscricao_municipal		|| sep_w ||
						vet01.nr_inscricao_inss		|| sep_w ||
						vet01.nr_cbo			|| sep_w ||
						vet01.nr_sefip			|| sep_w ||
						vet01.ds_rpa			|| sep_w ||
						vet01.ds_banco			|| sep_w ||
						vet01.cd_agencia			|| sep_w ||
						vet01.nm_agencia			|| sep_w ||
						vet01.nr_conta			|| sep_w ||
						vet01.dt_inclusao_sistema		|| sep_w ||
						vet01.dt_ultima_geracao		|| sep_w,1,4000);

	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	nr_linha_w		:= nr_linha_w + 1;
		
		
	insert into 	w_dacon(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_linha,
					ds_arquivo,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
			values (	nextval('w_dacon_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_linha_w,
					ds_arquivo_w,
					clock_timestamp(),
					nm_usuario_p);
					
					
					
	insert into pj_integracao_envio(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ie_tipo_integracao,
					cd_cnpj)
			values (nextval('pj_integracao_envio_seq'),
					clock_timestamp(),
					nm_usuario_p,
					1,
					vet01.cd_cnpj);				
	
	contador_w := contador_w + 1;
	
	if (mod(contador_w,100) = 0) then
		commit;
	end if;
	
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fob_exportar_pj ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

