-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_conferencia_sib ( nr_seq_lote_sib_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_linha_w			integer;
ie_tipo_registro_w		smallint;
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(70);

dt_nascimento_w			timestamp;
dt_nascimento_ww		varchar(8);

ie_sexo_w			varchar(1);
nr_cpf_w			varchar(11);
nr_pis_pasep_w			varchar(11);
nm_mae_w			varchar(70);
cd_plano_ans_w			varchar(30);

dt_adesao_plano_w		timestamp;
dt_adesao_plano_ww		varchar(8);

dt_rescisao_contrato_w		timestamp;
dt_rescisao_contrato_ww		varchar(8);

dt_reativacao_contrato_w	timestamp;
dt_reativacao_contrato_ww	varchar(8);

ds_logradouro_w			varchar(50);
nr_endereco_w			varchar(5);
ds_complemento_w		varchar(15);
ds_bairro_w			varchar(30);
sg_uf_w				varchar(2);
cd_cep_w			varchar(8);
ie_vinculo_beneficiario_w	smallint;
cd_alteracao_plano_w		smallint;
ie_cobertura_parcial_w		varchar(1);
cd_plano_anterior_w		varchar(30);
nr_cns_w			bigint;
nr_identidade_w			varchar(30);
ds_orgao_emissor_w		pessoa_fisica.ds_orgao_emissor_ci%type;
cd_pais_emissor_w		smallint;
cd_cgc_w			varchar(14);
cd_titular_plano_w		varchar(30);
ie_item_exc_cobertura_w		smallint;

dt_migracao_w			timestamp;
dt_migracao_ww			varchar(8);

nr_cei_w			bigint;

dt_inclusao_w			timestamp;
dt_inclusao_ww			varchar(8);

dt_exclusao_w			timestamp;
dt_exclusao_ww			varchar(8);

ie_situacao_nome_w		smallint;
ie_situacao_nasc_w		smallint;
ie_situacao_sexo_w		smallint;
ie_situacao_cpf_w		smallint;
ie_situacao_pis_w		smallint;
ie_situacao_mae_w		smallint;
ie_situacao_plano_w		smallint;
ie_situacao_adesao_plano_w	smallint;
ie_situacao_cancelamento_w	smallint;
ie_situacao_reinclusao_w	smallint;
ie_situacao_uf_w		smallint;
ie_situacao_cep_w		smallint;
ie_situacao_vinculo_w		smallint;
ie_situacao_alteracao_w		smallint;
ie_situacao_cobertura_w		smallint;
ie_situacao_cod_plano_w		smallint;
ie_situacao_cns_w		smallint;
ie_situacao_identidade_w	smallint;
ie_situacao_orgao_emissor_w	smallint;
ie_situacao_pais_w		smallint;
ie_situacao_cgc_w		smallint;
ie_situacao_titular_w		smallint;
ie_situacao_exc_cobert_w	smallint;
ie_situacao_migracao_w		smallint;
ie_situacao_cei_w		smallint;
ds_ans_w			varchar(6);
ie_tipo_retorno_w		varchar(10);
cd_motivo_inclusao_w		smallint;
nr_cco_w			bigint;
ie_digito_cco_w			smallint;
nr_plano_ans_w			integer;
cd_municipio_ibge_w		integer;
ie_resid_brasil_w		smallint;
nr_seq_motivo_cancelamento_w	smallint;

dt_alteracao_registro_w		timestamp;
dt_alteracao_registro_ww	varchar(8);

dt_ultima_reinclusao_w		timestamp;
dt_ultima_reinclusao_ww		varchar(8);

ie_situacao_cod_plano_ant_w	smallint;
ie_situacao_ibge_municipio_w	smallint;
ie_situacao_resid_brasil_w	smallint;
ie_situacao_motivo_canc_w	smallint;
ds_brancos_w			varchar(29);
ds_conteudo_w			varchar(4000);
i_w				bigint := 0;

C01 CURSOR FOR
	SELECT	ds_conteudo
	from	w_sib_conferencia
	where	nr_seq_lote_conf	= nr_seq_lote_sib_p;

TYPE 		fetch_array IS TABLE OF c01%ROWTYPE;
s_array 	fetch_array;
i		integer := 1;
type Vetor is table of fetch_array index by integer;
Vetor_c01_w	Vetor;

BEGIN

open c01;
loop
FETCH C01 BULK COLLECT INTO s_array LIMIT 1000;
	Vetor_c01_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on C01 */
END LOOP;
CLOSE C01;

for i in 1..Vetor_c01_w.COUNT loop
	s_array := Vetor_c01_w(i);
	for z in 1..s_array.COUNT loop
	ds_conteudo_w		:= s_array[z].ds_conteudo;

/*open C01;
loop
fetch C01 into
	ds_conteudo_w;
exit when C01%notfound;*/
	begin
	i_w	:= i_w +1;
	dt_nascimento_w			:= null;
	dt_adesao_plano_w		:= null;
	dt_migracao_w			:= null;
	dt_rescisao_contrato_w		:= null;
	dt_reativacao_contrato_w	:= null;
	dt_alteracao_registro_w		:= null;
	dt_inclusao_w			:= null;
	dt_exclusao_w			:= null;
	dt_ultima_reinclusao_w		:= null;

	if (ds_conteudo_w IS NOT NULL AND ds_conteudo_w::text <> '') then
		nr_seq_linha_w			:= rtrim(substr(ds_conteudo_w,1,7));
		ie_tipo_registro_w		:= rtrim(substr(ds_conteudo_w,8,1));
		cd_motivo_inclusao_w		:= rtrim(substr(ds_conteudo_w,9,2));
		nr_cco_w			:= rtrim(substr(ds_conteudo_w,11,10));
		ie_digito_cco_w			:= rtrim(substr(ds_conteudo_w,21,2));
		cd_usuario_plano_w		:= rtrim(substr(ds_conteudo_w,23,30));
		nm_beneficiario_w		:= rtrim(substr(ds_conteudo_w,53,70));

		dt_nascimento_ww		:= substr(ds_conteudo_w,129,2) || substr(ds_conteudo_w,127,2)|| substr(ds_conteudo_w,123,4);
		if (dt_nascimento_ww <> '        ') and (dt_nascimento_ww <> '00000000') then
			dt_nascimento_w			:= to_date(dt_nascimento_ww,'dd/mm/yyyy');
		end if;

		ie_sexo_w			:= rtrim(substr(ds_conteudo_w,131,1));
		nr_cpf_w			:= rtrim(substr(ds_conteudo_w,132,11));
		cd_titular_plano_w		:= rtrim(substr(ds_conteudo_w,143,30));
		nr_pis_pasep_w			:= rtrim(substr(ds_conteudo_w,173,11));
		nm_mae_w			:= rtrim(substr(ds_conteudo_w,184,70));
		nr_cns_w			:= rtrim(substr(ds_conteudo_w,254,15));
		nr_identidade_w			:= rtrim(substr(ds_conteudo_w,269,30));
		ds_orgao_emissor_w		:= rtrim(substr(ds_conteudo_w,299,30));
		cd_pais_emissor_w		:= rtrim(substr(ds_conteudo_w,329,3));
		nr_plano_ans_w			:= rtrim(substr(ds_conteudo_w,332,9));
		cd_plano_ans_w			:= rtrim(substr(ds_conteudo_w,341,30));
		cd_plano_anterior_w		:= rtrim(substr(ds_conteudo_w,371,9));
		--------------------------------------------------------------------------------------------------------------------------------
		dt_adesao_plano_ww		:= substr(ds_conteudo_w,386,2) || substr(ds_conteudo_w,384,2) || substr(ds_conteudo_w,380,4);
		if (dt_adesao_plano_ww <> '        ') and (dt_adesao_plano_ww <> '00000000') then
			dt_adesao_plano_w	:= to_date(dt_adesao_plano_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		ie_vinculo_beneficiario_w	:= substr(ds_conteudo_w,388,2);
		ie_cobertura_parcial_w		:= substr(ds_conteudo_w,390,1);
		ie_item_exc_cobertura_w		:= substr(ds_conteudo_w,391,1);
		--------------------------------------------------------------------------------------------------------------------------------
		dt_migracao_ww			:= substr(ds_conteudo_w,398,2) || substr(ds_conteudo_w,396,2) || substr(ds_conteudo_w,392,4);
		if (dt_migracao_ww <> '        ') and (dt_migracao_ww <> '00000000') then
			dt_migracao_w		:= to_date(dt_migracao_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		cd_cgc_w			:= rtrim(substr(ds_conteudo_w,400,14));
		if (substr(ds_conteudo_w,414,14) <> '              ') then
			nr_cei_w		:= substr(ds_conteudo_w,414,14);
		else
			nr_cei_w		:= null;
		end if;
		ds_logradouro_w			:= rtrim(substr(ds_conteudo_w,428,50));
		nr_endereco_w			:= rtrim(substr(ds_conteudo_w,478,5));
		ds_complemento_w		:= rtrim(substr(ds_conteudo_w,483,15));
		ds_bairro_w			:= rtrim(substr(ds_conteudo_w,498,30));
		cd_municipio_ibge_w		:= rtrim(substr(ds_conteudo_w,528,7));
		sg_uf_w				:= rtrim(substr(ds_conteudo_w,535,2));
		ie_resid_brasil_w		:= rtrim(substr(ds_conteudo_w,537,1));
		cd_cep_w			:= rtrim(substr(ds_conteudo_w,538,8));
		--------------------------------------------------------------------------------------------------------------------------------
		dt_rescisao_contrato_ww		:= substr(ds_conteudo_w,552,2) || substr(ds_conteudo_w,550,2) || substr(ds_conteudo_w,546,4);
		if (dt_rescisao_contrato_ww <> '        ') and (dt_rescisao_contrato_ww <> '00000000') then
			dt_rescisao_contrato_w	:= to_date(dt_rescisao_contrato_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		nr_seq_motivo_cancelamento_w	:= substr(ds_conteudo_w,554,2);
		--------------------------------------------------------------------------------------------------------------------------------
		dt_reativacao_contrato_ww	:= substr(ds_conteudo_w,562,2) || substr(ds_conteudo_w,560,2) || substr(ds_conteudo_w,556,4);
		if (dt_reativacao_contrato_ww <> '        ') and (dt_reativacao_contrato_ww <> '00000000') then
			dt_reativacao_contrato_w := to_date(dt_reativacao_contrato_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		dt_alteracao_registro_ww	:= substr(ds_conteudo_w,570,2) || substr(ds_conteudo_w,568,2) || substr(ds_conteudo_w,564,4);
		if (dt_alteracao_registro_ww <> '        ') and (dt_alteracao_registro_ww <> '00000000') then
			dt_alteracao_registro_w		:= to_date(dt_alteracao_registro_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		cd_alteracao_plano_w		:= substr(ds_conteudo_w,572,2);
		--------------------------------------------------------------------------------------------------------------------------------
		dt_inclusao_ww			:= substr(ds_conteudo_w,580,2) || substr(ds_conteudo_w,578,2) || substr(ds_conteudo_w,574,4);
		if (dt_inclusao_ww <> '        ') and (dt_inclusao_ww <> '00000000') then
			dt_inclusao_w		:= to_date(dt_inclusao_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		dt_exclusao_ww			:= substr(ds_conteudo_w,588,2) || substr(ds_conteudo_w,586,2) || substr(ds_conteudo_w,582,4);
		if (dt_exclusao_ww <> '        ') and (dt_exclusao_ww <> '00000000') then
			dt_exclusao_w		:= to_date(dt_exclusao_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		dt_ultima_reinclusao_ww		:= substr(ds_conteudo_w,596,2) || substr(ds_conteudo_w,594,2) || substr(ds_conteudo_w,590,4);
		if (dt_ultima_reinclusao_ww <> '        ') and (dt_ultima_reinclusao_ww <> '00000000') then
			dt_ultima_reinclusao_w		:= to_date(dt_ultima_reinclusao_ww,'dd/mm/yyyy');
		end if;
		--------------------------------------------------------------------------------------------------------------------------------
		ds_brancos_w			:= substr(ds_conteudo_w,598,29);
		ie_situacao_nome_w		:= substr(ds_conteudo_w,627,1);
		ie_situacao_nasc_w		:= substr(ds_conteudo_w,628,1);
		ie_situacao_sexo_w		:= substr(ds_conteudo_w,629,1);
		ie_situacao_cpf_w		:= substr(ds_conteudo_w,630,1);
		ie_situacao_titular_w		:= substr(ds_conteudo_w,631,1);
		ie_situacao_pis_w		:= substr(ds_conteudo_w,632,1);
		ie_situacao_mae_w		:= substr(ds_conteudo_w,633,1);
		ie_situacao_cns_w		:= substr(ds_conteudo_w,634,1);
		ie_situacao_identidade_w	:= substr(ds_conteudo_w,635,1);
		ie_situacao_orgao_emissor_w	:= substr(ds_conteudo_w,636,1);
		ie_situacao_pais_w		:= substr(ds_conteudo_w,637,1);
		ie_situacao_plano_w		:= substr(ds_conteudo_w,638,1);
		ie_situacao_cod_plano_w		:= substr(ds_conteudo_w,639,1);
		ie_situacao_cod_plano_ant_w	:= substr(ds_conteudo_w,640,1);
		ie_situacao_adesao_plano_w	:= substr(ds_conteudo_w,641,1);
		ie_situacao_vinculo_w		:= substr(ds_conteudo_w,642,1);
		ie_situacao_cobertura_w		:= substr(ds_conteudo_w,643,1);
		ie_situacao_exc_cobert_w	:= substr(ds_conteudo_w,644,1);
		ie_situacao_migracao_w		:= substr(ds_conteudo_w,645,1);
		ie_situacao_cgc_w		:= substr(ds_conteudo_w,646,1);
		ie_situacao_cei_w		:= substr(ds_conteudo_w,647,1);
		ie_situacao_ibge_municipio_w	:= substr(ds_conteudo_w,648,1);
		ie_situacao_uf_w		:= substr(ds_conteudo_w,649,1);
		ie_situacao_resid_brasil_w	:= substr(ds_conteudo_w,650,1);
		ie_situacao_cep_w		:= substr(ds_conteudo_w,651,1);
		ie_situacao_cancelamento_w	:= substr(ds_conteudo_w,652,1);
		ie_situacao_motivo_canc_w	:= substr(ds_conteudo_w,653,1);
		ie_situacao_reinclusao_w	:= substr(ds_conteudo_w,654,1);
		ie_situacao_alteracao_w		:= substr(ds_conteudo_w,655,1);
		ds_ans_w			:= substr(ds_conteudo_w,656,6);
		ie_tipo_retorno_w		:= '35';

		insert into pls_retorno_sib(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_linha,ie_tipo_registro,cd_usuario_plano,nm_beneficiario,dt_nascimento,
				ie_sexo,nr_cpf,nr_pis_pasep,nm_mae,cd_plano_ans,
				dt_adesao_plano,dt_rescisao_contrato,dt_reativacao_contrato,ds_logradouro,nr_endereco,
				ds_complemento,ds_bairro,sg_uf,cd_cep,ie_vinculo_beneficiario,
				cd_alteracao_plano,ie_cobertura_parcial,cd_plano_anterior,nr_cns,nr_identidade,
				ds_orgao_emissor,cd_pais_emissor,cd_cgc,cd_titular_plano,ie_item_exc_cobertura,
				dt_migracao,nr_cei,dt_inclusao,dt_exclusao,ie_situacao_nome,
				ie_situacao_nasc,ie_situacao_sexo,ie_situacao_cpf,ie_situacao_pis,ie_situacao_mae,
				ie_situacao_plano,ie_situacao_adesao_plano,ie_situacao_cancelamento,ie_situacao_reinclusao,ie_situacao_uf,
				ie_situacao_cep,ie_situacao_vinculo,ie_situacao_alteracao,ie_situacao_cobertura,ie_situacao_cod_plano,
				ie_situacao_cns,ie_situacao_identidade,ie_situacao_orgao_emissor,ie_situacao_pais,ie_situacao_cgc,
				ie_situacao_titular,ie_situacao_exc_cobert,ie_situacao_migracao,ie_situacao_cei,ds_ans,
				ie_tipo_retorno,cd_motivo_inclusao,nr_cco,ie_digito_cco,nr_plano_ans,
				cd_municipio_ibge,ie_resid_brasil,nr_seq_motivo_cancelamento,dt_alteracao_registro,dt_ultima_reinclusao,
				ie_situacao_cod_plano_ant,ie_situacao_ibge_municipio,ie_situacao_resid_brasil,ie_situacao_motivo_canc,nr_seq_lote_sib,
				ie_carteira_anterior,ie_enviar_sib)
		values (	nextval('pls_retorno_sib_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_linha_w,ie_tipo_registro_w,cd_usuario_plano_w,nm_beneficiario_w,dt_nascimento_w,
				ie_sexo_w,nr_cpf_w,nr_pis_pasep_w,nm_mae_w,cd_plano_ans_w,
				dt_adesao_plano_w,dt_rescisao_contrato_w,dt_reativacao_contrato_w,ds_logradouro_w,nr_endereco_w,
				ds_complemento_w,ds_bairro_w,sg_uf_w,cd_cep_w,ie_vinculo_beneficiario_w,
				cd_alteracao_plano_w,ie_cobertura_parcial_w,cd_plano_anterior_w,nr_cns_w,nr_identidade_w,
				ds_orgao_emissor_w,cd_pais_emissor_w,cd_cgc_w,cd_titular_plano_w,ie_item_exc_cobertura_w,
				dt_migracao_w,nr_cei_w,dt_inclusao_w,dt_exclusao_w,ie_situacao_nome_w,
				ie_situacao_nasc_w,ie_situacao_sexo_w,ie_situacao_cpf_w,ie_situacao_pis_w,ie_situacao_mae_w,
				ie_situacao_plano_w,ie_situacao_adesao_plano_w,ie_situacao_cancelamento_w,ie_situacao_reinclusao_w,ie_situacao_uf_w,
				ie_situacao_cep_w,ie_situacao_vinculo_w,ie_situacao_alteracao_w,ie_situacao_cobertura_w,ie_situacao_cod_plano_w,
				ie_situacao_cns_w,ie_situacao_identidade_w,ie_situacao_orgao_emissor_w,ie_situacao_pais_w,ie_situacao_cgc_w,
				ie_situacao_titular_w,ie_situacao_exc_cobert_w,ie_situacao_migracao_w,ie_situacao_cei_w,ds_ans_w,
				ie_tipo_retorno_w,cd_motivo_inclusao_w,nr_cco_w,ie_digito_cco_w,nr_plano_ans_w,
				cd_municipio_ibge_w,ie_resid_brasil_w,nr_seq_motivo_cancelamento_w,dt_alteracao_registro_w,dt_ultima_reinclusao_w,
				ie_situacao_cod_plano_ant_w,ie_situacao_ibge_municipio_w,ie_situacao_resid_brasil_w,ie_situacao_motivo_canc_w,nr_seq_lote_sib_p,
				'N','N');
	end if;

	if (i_w = 1000) then
		commit;
		i_w := 0;
	end if;
	end;
	end loop;
end loop;
/*end loop;
close C01;	*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_conferencia_sib ( nr_seq_lote_sib_p bigint, nm_usuario_p text) FROM PUBLIC;

