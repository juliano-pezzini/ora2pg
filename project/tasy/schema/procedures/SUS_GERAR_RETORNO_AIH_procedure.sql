-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_retorno_aih ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) AS $body$
DECLARE

 
ds_erro_w			varchar(255);
nr_seq_retorno_w		bigint;
cd_convenio_w			integer;
cd_estabelecimento_w		smallint;
nr_seq_retorno_item_w		bigint;
nr_aih_w			bigint;
nr_seq_aih_w			bigint;
nr_processo_w			bigint;
vl_aih_import_w			double precision;
vl_aih_tasy_w			double precision;
vl_glosado_w			double precision;
nr_interno_conta_w		bigint;
nr_titulo_w			bigint;

C01 CURSOR FOR 
SELECT	a.nr_aih, 
	a.nr_seq_aih, 
	a.nr_processo, 
	a.vl_aih, 
	c.nr_interno_conta, 
	sus_obter_valor(c.nr_interno_conta,'') 
from	conta_paciente	c, 
	sus_aih 	b, 
	sus_aih_paga	a 
where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
and	a.nr_aih		= b.nr_aih 
and	a.nr_seq_aih		= b.nr_sequencia 
and	b.nr_interno_conta	= c.nr_interno_conta 
order by  1,2,3;
	

BEGIN 
 
ds_erro_w	:= wheb_mensagem_pck.get_texto(279919);
 
/* Selecionar dados do protocolo */
 
select 	coalesce(max(cd_convenio),0), 
	coalesce(max(cd_estabelecimento),0) 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
select	nextval('convenio_retorno_seq') 
into STRICT	nr_seq_retorno_w
;
 
select	coalesce(max(nr_titulo),0) 
into STRICT	nr_titulo_w 
from	titulo_receber 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
/* Gravar convenio retorno */
 
begin 
insert into convenio_retorno( 
	NR_SEQUENCIA , 
	CD_CONVENIO, 
	DT_RETORNO, 
	IE_STATUS_RETORNO, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	NM_USUARIO_RETORNO, 
	DS_LOTE_CONVENIO, 
	DT_INICIAL, 
	DT_FINAL, 
	DT_FECHAMENTO, 
	NM_USUARIO_FECHAMENTO, 
	DS_OBSERVACAO, 
	NR_SEQ_PROTOCOLO, 
	DT_REF_PRECO, 
	DT_BAIXA_CR, 
	CD_ESTABELECIMENTO, 
	NR_SEQ_PROT_ADIC, 
	DT_RECEBIMENTO, 
	DT_CONSISTENCIA, 
	DT_VINCULACAO) 
values (nr_seq_retorno_w, 
	cd_convenio_w, 
	clock_timestamp(), 
	'R', 
	clock_timestamp(), 
	nm_usuario_p, 
	nm_usuario_p, 
	--'Prot.= '||to_char(nr_seq_protocolo_p), 
	wheb_mensagem_pck.get_texto(299953, 'NR_SEQ_PROTOCOLO=' || to_char(nr_seq_protocolo_p)), 
	null, 
	null, 
	null, 
	null, 
	null, 
	nr_seq_protocolo_p, 
	null, 
	null, 
	cd_estabelecimento_w, 
	null, 
	null, 
	null, 
	null);
end;
 
 
/* Gravar convenio retorno item */
 
OPEN C01;
LOOP 
FETCH C01 into 
	nr_aih_w, 
	nr_seq_aih_w, 
	nr_processo_w, 
	vl_aih_import_w, 
	nr_interno_conta_w, 
	vl_aih_tasy_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	vl_glosado_w	:= vl_aih_tasy_w - vl_aih_import_w;
	if (vl_glosado_w	< 0) then 
		vl_glosado_w	:= 0;
	end if;
 
	select	nextval('convenio_retorno_item_seq') 
	into STRICT	nr_seq_retorno_item_w 
	;
 
	insert	into convenio_retorno_item( 
		NR_SEQUENCIA, 
		NR_SEQ_RETORNO, 
		VL_PAGO, 
		VL_GLOSADO, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		IE_GLOSA, 
		NR_INTERNO_CONTA, 
		CD_AUTORIZACAO, 
		DS_OBSERVACAO, 
		VL_ADICIONAL, 
		NR_TITULO, 
		VL_AMENOR, 
		VL_ADEQUADO, 
		CD_MOTIVO_GLOSA, 
		IE_LIBERA_REPASSE, 
		IE_ANALISADA) 
	values (nr_seq_retorno_item_w, 
		nr_seq_retorno_w, 
		vl_aih_import_w, 
		vl_glosado_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		'S', 
		nr_interno_conta_w, 
		to_char(nr_aih_w), 
		null, 
		0, 
		nr_titulo_w, 
		0, 
		0, 
		null, 
		'S', 
		'N');
	end;
END LOOP;
CLOSE C01;
 
commit;
 
ds_erro_p		:= ds_erro_w;
nr_seq_retorno_p	:= to_char(coalesce(nr_seq_retorno_w,0));
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_retorno_aih ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) FROM PUBLIC;

