-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_benef_compl_a300 ( nr_seq_beneficiario_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) is ds_endereco_w varchar(100) RETURNS varchar AS $body$
DECLARE

ds_retorno_w	varchar(255);
C04 CURSOR FOR
	SELECT	cd_intercambio
	from	pls_interc_tipo_logradouro
	where (cd_tipo_logradouro = cd_tipo_logradouro_p or coalesce(cd_tipo_logradouro::text, '') = '')
	order by coalesce(cd_tipo_logradouro,0);
BEGIN
ds_retorno_w	:= null;
for r_c04_w in C04 loop
	begin
	ds_retorno_w	:= r_c04_w.cd_intercambio;
	end;
end loop;
return	ds_retorno_w;
end;
	
begin

select	d.nr_seq_segurado,
	a.nr_sequencia,
	a.cd_estabelecimento
into STRICT	nr_seq_segurado_w,
	nr_seq_lote_w,
	cd_estabelecimento_w
from	ptu_mov_produto_benef		d,
	ptu_mov_produto_empresa		c,
	ptu_movimentacao_produto	b,
	ptu_mov_produto_lote		a
where	d.nr_seq_empresa		= c.nr_sequencia
and	c.nr_seq_mov_produto		= b.nr_sequencia
and	b.nr_seq_lote			= a.nr_sequencia
and	d.nr_sequencia			= nr_seq_beneficiario_p;

for r_c01_w in c01 loop
	begin
	select	substr(ds_endereco,1,40),
		substr(cd_cep,1,8),
		substr(obter_desc_municipio_ibge(cd_municipio_ibge),1,30),
		coalesce(sg_estado,''),
		substr(ds_bairro,1,30),
		substr(nr_ddd_telefone,1,4),
		substr(somente_numero(nr_telefone),1,8),
		substr(nr_ramal,1,4),
		ds_complemento,
		cd_municipio_ibge,
		nr_endereco,
		cd_tipo_logradouro
	into STRICT	ds_endereco_w,
		cd_cep_w,
		nm_municipio_w,
		sg_uf_w,
		ds_bairro_w,
		nr_ddd_w,
		nr_fone_w,
		nr_ramal_w,
		ds_complemento_w,
		cd_municipio_ibge_w,
		nr_endereco_w,
		cd_tipo_logradouro_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ie_tipo_complemento	= r_c01_w.ie_tipo_complemento;
	exception
	when others then
		ie_erro_w	:= 'S';
		CALL ptu_gravar_log_erro_a300(nr_seq_lote_w,nr_seq_segurado_w,wheb_mensagem_pck.get_texto(1188060, 	'IE_TIPO_COMPLEMENTO='||obter_valor_dominio(8,r_c01_w.ie_tipo_complemento))
														||chr(13)||chr(10)||sqlerrm(SQLSTATE),cd_estabelecimento_w,nm_usuario_p);
	end;
	
	begin
	if (ie_erro_w	= 'N') then
		cd_cep_w	:= somente_numero(cd_cep_w);
		
		cd_tipo_logradouro_w	:= obter_cd_tipo_logradouro(cd_tipo_logradouro_w);
		
		nm_municipio_w	:= elimina_acentos(nm_municipio_w);
		nm_municipio_w	:= replace(replace(nm_municipio_w,chr(231),'c'),chr(199),'C');
		
		if (nm_municipio_w IS NOT NULL AND nm_municipio_w::text <> '') then	
			ds_endereco_w	:= elimina_caractere_especial(ds_endereco_w);
			ds_endereco_w	:= replace(replace(ds_endereco_w,chr(231),'c'),chr(199),'C');
			ds_endereco_w	:= elimina_acentuacao(ds_endereco_w);
			ds_endereco_w	:= replace(replace(ds_endereco_w,chr(180),''), chr(96), '');
			
			ds_complemento_w	:= elimina_caractere_especial(ds_complemento_w);
			ds_complemento_w	:= replace(replace(ds_complemento_w,chr(231),'c'),chr(199),'C');
			ds_complemento_w	:= elimina_acentuacao(ds_complemento_w);
			ds_complemento_w	:= replace(replace(ds_complemento_w,chr(180),''), chr(96), '');
			
			ds_bairro_w	:= replace(ds_bairro_w,'/',' ');
			ds_bairro_w	:= elimina_acentuacao(ds_bairro_w);
			ds_bairro_w	:= elimina_caractere_especial(ds_bairro_w);
			ds_bairro_w	:= replace(replace(ds_bairro_w,chr(231),'c'),chr(199),'C');

			nr_ddd_w	:= replace(nr_ddd_w,' ','');
			
			if (nr_endereco_w IS NOT NULL AND nr_endereco_w::text <> '') then
				ds_endereco_w	:= substr(ds_endereco_w,1,40-length(nr_endereco_w)-2) || ' ' || nr_endereco_w;
			end if;

			begin
			insert into ptu_movimento_benef_compl(	nr_sequencia, nr_seq_beneficiario, ds_endereco,
					cd_cep, nm_municipio, sg_uf, dt_atualizacao, 
					nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_bairro, 
					nr_ddd, nr_fone, nr_ramal,ds_complemento,cd_municipio_ibge, nr_endereco,
					cd_tipo_logradouro, ie_tipo_endereco)
			values (	nextval('ptu_movimento_benef_compl_seq'), nr_seq_beneficiario_p, ds_endereco_w,
					cd_cep_w, nm_municipio_w, sg_uf_w,clock_timestamp(), 
					nm_usuario_p, clock_timestamp(), nm_usuario_p, ds_bairro_w, nr_ddd_w,
					nr_fone_w, nr_ramal_w,ds_complemento_w,cd_municipio_ibge_w, nr_endereco_w,
					cd_tipo_logradouro_w, r_c01_w.ie_tipo_complemento);
			exception
			when others then		
				ie_erro_w	:= 'S';
				CALL ptu_gravar_log_erro_a300(nr_seq_lote_w,nr_seq_segurado_w,wheb_mensagem_pck.get_texto(1188060, 	'IE_TIPO_COMPLEMENTO='||obter_valor_dominio(8,r_c01_w.ie_tipo_complemento))
																||chr(13)||chr(10)||sqlerrm(SQLSTATE),cd_estabelecimento_w,nm_usuario_p);
			end;
		else
			ie_erro_w	:= 'S';
			CALL ptu_gravar_log_erro_a300(nr_seq_lote_w,nr_seq_segurado_w,wheb_mensagem_pck.get_texto(1188060, 	'IE_TIPO_COMPLEMENTO='||obter_valor_dominio(8,r_c01_w.ie_tipo_complemento))
															||chr(13)||chr(10)||wheb_mensagem_pck.get_texto(1188062),cd_estabelecimento_w,nm_usuario_p);
		end if;
	end if;
	end;
end loop;

-- Contatos - Telefone
for r_c02_w in C02 loop
	begin
	insert into ptu_movimento_benef_contat(	nr_sequencia, nr_seq_beneficiario, ie_tipo_contato,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			ie_tipo_telefone, nr_ddd, nr_telefone)
	values (
			nextval('ptu_movimento_benef_contat_seq'), nr_seq_beneficiario_p, 'T',
			clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
			r_c02_w.ie_tipo_complemento, r_c02_w.nr_ddd_telefone, r_c02_w.nr_telefone);
	exception
	when others then		
		ie_erro_w	:= 'S';
		CALL ptu_gravar_log_erro_a300(nr_seq_lote_w,nr_seq_segurado_w,wheb_mensagem_pck.get_texto(1188063, 	'IE_TIPO_COMPLEMENTO='||obter_valor_dominio(8,r_c02_w.ie_tipo_complemento))
														||chr(13)||chr(10)||sqlerrm(SQLSTATE),cd_estabelecimento_w,nm_usuario_p);
	end;
end loop;

-- Contatos - Email
for r_c03_w in C03 loop
	begin
	insert into ptu_movimento_benef_contat(	nr_sequencia, nr_seq_beneficiario, ie_tipo_contato,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			ie_tipo_email, ds_email)
	values (
			nextval('ptu_movimento_benef_contat_seq'), nr_seq_beneficiario_p, 'E',
			clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
			ie_tipo_email_w, r_c03_w.ds_email);
	
	ie_tipo_email_w		:= 2;
	exception
	when others then		
		ie_erro_w	:= 'S';
		CALL ptu_gravar_log_erro_a300(nr_seq_lote_w,nr_seq_segurado_w,wheb_mensagem_pck.get_texto(1188064, 	'IE_TIPO_COMPLEMENTO='||obter_valor_dominio(8,r_c03_w.ie_tipo_complemento))
														||chr(13)||chr(10)||sqlerrm(SQLSTATE),cd_estabelecimento_w,nm_usuario_p);
	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_benef_compl_a300 ( nr_seq_beneficiario_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) is ds_endereco_w varchar(100) FROM PUBLIC;

