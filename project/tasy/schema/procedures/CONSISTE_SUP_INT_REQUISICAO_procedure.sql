-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_sup_int_requisicao ( nr_seq_int_requisicao_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, cd_pessoa_requisitante_p text, cd_estabelecimento_destino_p bigint, cd_local_estoque_destino_p bigint, cd_setor_atendimento_p bigint, cd_centro_custo_p bigint) AS $body$
DECLARE


qt_existe_w		bigint;
cd_material_w		integer;
cd_material_ww		integer;
ie_de_para_material_w	varchar(1);

c01 CURSOR FOR
SELECT	cd_material
from	sup_int_req_item
where	nr_sequencia = nr_seq_int_requisicao_p;


BEGIN

delete
from	sup_int_req_consist
where	nr_sequencia = nr_seq_int_requisicao_p;

select	count(*)
into STRICT	qt_existe_w
from	estabelecimento_v
where	cd_estabelecimento = cd_estabelecimento_p
and	ie_situacao = 'A';

if (qt_existe_w = 0) then
	CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313247));
end if;

select	count(*)
into STRICT	qt_existe_w
from	local_estoque
where	cd_local_estoque = cd_local_estoque_p
and	ie_situacao = 'A';

if (qt_existe_w = 0) then
	CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313248));
end if;

select	count(*)
into STRICT	qt_existe_w
from	operacao_estoque
where	cd_operacao_estoque = cd_operacao_estoque_p
and	ie_situacao = 'A';

if (qt_existe_w = 0) then
	CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313249));
end if;

select	count(*)
into STRICT	qt_existe_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_requisitante_p;

if (qt_existe_w = 0) then
	CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313250));
end if;

if (cd_estabelecimento_destino_p IS NOT NULL AND cd_estabelecimento_destino_p::text <> '') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	estabelecimento_v
	where	cd_estabelecimento = cd_estabelecimento_destino_p
	and	ie_situacao = 'A';

	if (qt_existe_w = 0) then
		CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313251));
	end if;

	end;
end if;

if (cd_local_estoque_destino_p IS NOT NULL AND cd_local_estoque_destino_p::text <> '') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	local_estoque
	where	cd_local_estoque = cd_local_estoque_destino_p
	and	ie_situacao = 'A';

	if (qt_existe_w = 0) then
		CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313252));
	end if;

	end;
end if;

if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_p
	and	ie_situacao = 'A';

	if (qt_existe_w = 0) then
		CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313253));
	end if;

	end;
end if;

if (cd_centro_custo_p IS NOT NULL AND cd_centro_custo_p::text <> '') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	centro_custo
	where	cd_centro_custo = cd_centro_custo_p
	and	ie_situacao = 'A';

	if (qt_existe_w = 0) then
		CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313254));
	end if;

	end;
end if;

select	obter_ie_de_para_sup_integr('RM','R','MATERIAL')
into STRICT	ie_de_para_material_w
;

open c01;
loop
fetch c01 into
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (ie_de_para_material_w = 'C') then
		cd_material_ww		:= coalesce(Obter_Conversao_externa(null,'MATERIAL','CD_MATERIAL',cd_material_w),cd_material_w);
	elsif (ie_de_para_material_w = 'S') then
		begin

		select	coalesce(max(cd_material),0)
		into STRICT	cd_material_ww
		from	material_estab
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_sistema_ant = to_char(cd_material_w);

		if (cd_material_ww = 0) then
			begin

			select	coalesce(max(cd_material),0)
			into STRICT	cd_material_ww
			from	material
			where	cd_sistema_ant = to_char(cd_material_w);

			end;
		end if;

		end;
	end if;

	select	count(*)
	into STRICT	qt_existe_w
	from	material
	where	cd_material = cd_material_ww;

	if (qt_existe_w = 0) then
		CALL grava_sup_int_req_consist(nr_seq_int_requisicao_p,wheb_mensagem_pck.get_texto(313255,'CD_MATERIAL_W='||CD_MATERIAL_W));
	end if;

	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_sup_int_requisicao ( nr_seq_int_requisicao_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_operacao_estoque_p bigint, cd_pessoa_requisitante_p text, cd_estabelecimento_destino_p bigint, cd_local_estoque_destino_p bigint, cd_setor_atendimento_p bigint, cd_centro_custo_p bigint) FROM PUBLIC;

