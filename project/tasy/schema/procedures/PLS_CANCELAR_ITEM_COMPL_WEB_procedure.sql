-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancelar_item_compl_web ( nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Cancelar o item no complemento de contas médicas

ds_mensagem_p := 	'OK' : Item excluído
		'NP' : Conta sem itens, ou seja, tal item não pode ser cancelado/excluído
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatórios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ie_estagio_complemento_w	smallint;
qt_itens_conta_w		bigint;
ds_mensagem_w			varchar(2) := 'OK';


BEGIN

select 	sum(qt_registros)
into STRICT	qt_itens_conta_w
from	(	SELECT	count(1) qt_registros
		from	pls_conta_mat
		where	nr_seq_conta = nr_seq_conta_p
		and	(( ie_tipo_item_p = 'M' and nr_sequencia <> nr_seq_item_p ) or (ie_tipo_item_p = 'P'))
		and	ie_status <> 'D'
		
union all

		SELECT	count(1) qt_registros
		from	pls_conta_proc
		where	nr_seq_conta = nr_seq_conta_p
		and	(( ie_tipo_item_p = 'P' and nr_sequencia <> nr_seq_item_p ) or (ie_tipo_item_p = 'M'))
		and	ie_status <> 'D'	) alias9;


if (ie_tipo_item_p = 'M') then

	if (qt_itens_conta_w > 0) then
		CALL pls_desfazer_consistir_conta(nr_seq_conta_p, cd_estabelecimento_p, nm_usuario_p);

		select	max(ie_estagio_complemento)
		into STRICT	ie_estagio_complemento_w
		from	pls_conta_mat
		where	nr_sequencia = nr_seq_item_p;

		if (coalesce(ie_estagio_complemento_w,0) = 3) then
			 update pls_conta_mat
			 set    ie_status = 'D',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			 where  nr_sequencia = nr_seq_item_p;

			insert into	pls_conta_log(nr_sequencia, nm_usuario, dt_atualizacao,
							nm_usuario_nrec, dt_atualizacao_nrec, nm_usuario_alteracao,
							dt_alteracao, nr_seq_conta, nr_seq_conta_mat,
							ds_alteracao)
						values (nextval('pls_conta_log_seq'), nm_usuario_p, clock_timestamp(),
							nm_usuario_p, clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nr_seq_conta_p, nr_seq_item_p,
							'Conta mat: '||nr_seq_item_p||' cancelada no complemento');
		else
			delete  from pls_conta_mat
			where	nr_sequencia = nr_seq_item_p;
		end if;

		CALL pls_consistir_conta_web(null, nr_seq_conta_p, 'C', nm_usuario_p, cd_estabelecimento_p,'S');
	else
		ds_mensagem_w := 'NP';
	end if;

elsif (ie_tipo_item_p = 'P') then

	if (qt_itens_conta_w > 0) then
		CALL pls_desfazer_consistir_conta(nr_seq_conta_p, cd_estabelecimento_p, nm_usuario_p);

		select	max(ie_estagio_complemento)
		into STRICT	ie_estagio_complemento_w
		from	pls_conta_proc
		where	nr_sequencia = nr_seq_item_p;

		if (coalesce(ie_estagio_complemento_w,0) = 3) then
			 update pls_conta_proc
			 set    ie_status = 'D',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			 where  nr_sequencia = nr_seq_item_p;

			 insert into	pls_conta_log(nr_sequencia, nm_usuario, dt_atualizacao,
							 nm_usuario_nrec, dt_atualizacao_nrec, nm_usuario_alteracao,
							 dt_alteracao, nr_seq_conta, nr_seq_conta_proc,
							 ds_alteracao)
						values (nextval('pls_conta_log_seq'), nm_usuario_p, clock_timestamp(),
							 nm_usuario_p, clock_timestamp(), nm_usuario_p,
							 clock_timestamp(), nr_seq_conta_p, nr_seq_item_p,
							 'Conta proc: '||nr_seq_item_p||' cancelado no complemento ');
		else
			delete  from pls_conta_proc
			where	nr_sequencia = nr_seq_item_p;
		end if;

		CALL pls_consistir_conta_web(null, nr_seq_conta_p, 'C', nm_usuario_p, cd_estabelecimento_p,'S');
	else
		ds_mensagem_w := 'NP';
	end if;
end if;

commit;

ds_mensagem_p := ds_mensagem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancelar_item_compl_web ( nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text) FROM PUBLIC;

