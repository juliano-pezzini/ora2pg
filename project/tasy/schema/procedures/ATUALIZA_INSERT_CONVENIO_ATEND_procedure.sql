-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_insert_convenio_atend (nr_seq_interno_p bigint, nr_atendimento_p bigint, cd_empresa_p bigint, cd_usuario_convenio_p text, ds_guia_p text) AS $body$
DECLARE


cd_usuario_convenio_w  atend_categoria_convenio.cd_usuario_convenio%TYPE;
cd_empresa_w   atend_categoria_convenio.cd_empresa%TYPE;
ds_guia_w   atend_categoria_convenio.nr_doc_convenio%TYPE;


BEGIN

SELECT  max(cd_usuario_convenio),
	max(cd_empresa),
	max(nr_doc_convenio)
INTO STRICT 	cd_usuario_convenio_w,
	cd_empresa_w,
	ds_guia_w
FROM 	atend_categoria_convenio
WHERE  	nr_atendimento = nr_atendimento_p
AND  	nr_seq_interno = nr_seq_interno_p;

if ((coalesce(cd_usuario_convenio_w::text, '') = '') and (cd_usuario_convenio_p IS NOT NULL AND cd_usuario_convenio_p::text <> '')) or
	((coalesce(cd_empresa_w::text, '') = '') and (cd_empresa_p IS NOT NULL AND cd_empresa_p::text <> '')) or
	((coalesce(ds_guia_w::text, '') = '') and (ds_guia_p IS NOT NULL AND ds_guia_p::text <> '')) then
	INSERT INTO log_mov(dt_atualizacao, nm_usuario, ds_log, cd_log)
	VALUES (clock_timestamp(), 'TASY', nr_atendimento_p || ' - ' || nr_seq_interno_p || ' - ' || cd_usuario_convenio_w || ' - ' || cd_usuario_convenio_p || ' - ' || cd_empresa_w || ' - ' || cd_empresa_p || ' - ' || ds_guia_w || ' - ' || ds_guia_p, 41788714);

	UPDATE  atend_categoria_convenio
	SET  cd_empresa = CASE WHEN cd_empresa_p=0 THEN  NULL  ELSE cd_empresa_p END ,
	 cd_usuario_convenio = cd_usuario_convenio_p,
	 nr_doc_convenio = ds_guia_p
	WHERE nr_atendimento = nr_atendimento_p
	AND nr_seq_interno = nr_seq_interno_p;
end if;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_insert_convenio_atend (nr_seq_interno_p bigint, nr_atendimento_p bigint, cd_empresa_p bigint, cd_usuario_convenio_p text, ds_guia_p text) FROM PUBLIC;

