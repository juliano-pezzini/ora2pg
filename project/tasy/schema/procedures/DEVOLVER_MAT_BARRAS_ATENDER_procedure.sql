-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE devolver_mat_barras_atender ( nr_prescricao_p bigint, nr_cirurgia_p bigint, cd_material_p bigint, qt_saldo_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			integer;
cd_kit_material_w		integer;
nr_seq_kit_estoque_w		bigint;
nr_seq_interno_w		bigint;
cd_motivo_baixa_w		smallint;
cd_motivo_baixa_original_w	smallint;


c01 CURSOR FOR
	SELECT	cd_material,
		cd_kit_material,
		nr_seq_kit_estoque,
		nr_seq_interno
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and	coalesce(dt_baixa::text, '') = ''
	and	cd_motivo_baixa = 0
	and	qt_material > 0;



BEGIN
cd_motivo_baixa_w := obter_param_usuario(36, 21, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, 0, cd_motivo_baixa_w);

cd_motivo_baixa_original_w	:= cd_motivo_baixa_w;

update	prescr_material
set	qt_material 		= coalesce(qt_atendido,0),
	qt_total_dispensar	= coalesce(qt_atendido,0),
	qt_dose			= coalesce(qt_atendido,0),
	qt_unitaria		= coalesce(qt_atendido,0)
where	nr_prescricao		= nr_prescricao_p
and	cd_motivo_baixa		= 0
and	coalesce(dt_baixa::text, '') = '';

open C01;
loop
fetch C01 into
	cd_material_w,
	cd_kit_material_w,
	nr_seq_kit_estoque_w,
	nr_seq_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	if ((obter_se_mat_baixa_estoque_cir(cd_material_w, cd_local_estoque_p, nr_cirurgia_p,cd_kit_material_w,nr_seq_kit_estoque_w,nr_seq_interno_w) IS NOT NULL AND (obter_se_mat_baixa_estoque_cir(cd_material_w, cd_local_estoque_p, nr_cirurgia_p,cd_kit_material_w,nr_seq_kit_estoque_w,nr_seq_interno_w))::text <> '')) then
		cd_motivo_baixa_w := obter_se_mat_baixa_estoque_cir(cd_material_w, cd_local_estoque_p, nr_cirurgia_p,cd_kit_material_w,nr_seq_kit_estoque_w,nr_seq_interno_w);
	else
		cd_motivo_baixa_w := cd_motivo_baixa_original_w;
	end if;

	update	prescr_material
	set	dt_baixa 		= clock_timestamp(),
		cd_motivo_baixa 	= cd_motivo_baixa_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		cd_local_estoque	= cd_local_estoque_p
	where	nr_seq_interno		= nr_seq_interno_w;
	commit;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE devolver_mat_barras_atender ( nr_prescricao_p bigint, nr_cirurgia_p bigint, cd_material_p bigint, qt_saldo_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

