-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageweb_alterar_status (cd_agenda_p bigint, nr_seq_agenda_p bigint, cd_tipo_agenda_p bigint, ie_status_p text, cd_motivo_p text, ds_motivo_p text, ie_erro_p INOUT text) AS $body$
DECLARE

			    
ds_motivo_status_w	varchar(255);
cd_mot_cancel_cons_w	varchar(3);
cd_mot_cancel_exame_w	varchar(3);

cd_pessoa_fisica_w	varchar(10);
dt_agenda_w		varchar(30);

nm_paciente_w		varchar(255);
ds_email_destino_w	varchar(255);
ds_titulo_w		varchar(255);
ds_remetente_w		varchar(255);
ds_mensagem_w		varchar(4000);

ds_especialidade_w	varchar(255);
nm_especialista_w	varchar(255);

nr_seq_proc_interno_w	bigint;
cd_medico_exec_w	varchar(10);
ds_proc_exame_w		varchar(100);

qt_cancelado_w		bigint;
ds_erro_w		varchar(4000);
			

BEGIN 
 
if (ie_status_p = 'C') then 
	select	max(ds_motivo_cancel), 
		max(cd_mot_cancel_cons), 
		max(cd_mot_cancel_exame) 
	into STRICT	ds_motivo_status_w, 
		cd_mot_cancel_cons_w, 
		cd_mot_cancel_exame_w 
	from	parametro_agenda_web;
end if;
 
if (cd_tipo_agenda_p = 3) then 
 
	select	count(*) 
	into STRICT	qt_cancelado_w 
	from	agenda_consulta 
	where	nr_sequencia = nr_seq_agenda_p 
	and	ie_status_agenda = 'C';
	 
	if (qt_cancelado_w = 0) then 
		CALL alterar_status_agecons(	cd_agenda_p, 
					nr_seq_agenda_p, 
					ie_status_p, 
					coalesce(cd_motivo_p,cd_mot_cancel_cons_w), 
					coalesce(ds_motivo_p,ds_motivo_status_w), 
					'N', 
					'Tasy', 
					null);
		ie_erro_p	:= 'OK';
					 
		select	max(ds_titulo), 
			max(ds_remetente), 
			max(ds_mensagem) 
		into STRICT	ds_titulo_w, 
			ds_remetente_w, 
			ds_mensagem_w 
		from	ageweb_cadastro_email 
		where	ie_tipo_email = 'CA' 
		and	((ie_tipo_agenda = 'C') or (ie_tipo_agenda = 'A'));
		 
		select	max(cd_pessoa_fisica), 
			max(to_char(dt_agenda,'dd/mm/yyyy hh24:mi')) 
		into STRICT	cd_pessoa_fisica_w, 
			dt_agenda_w 
		from	agenda_consulta 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		select	max(b.ds_email), 
			max(substr(obter_nome_pf(a.cd_pessoa_fisica),1,255)) 
		into STRICT	ds_email_destino_w, 
			nm_paciente_w 
		from	pessoa_fisica a, 
			compl_pessoa_fisica b 
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica 
		and	b.ie_tipo_complemento 	= 1 
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
			 
		 
		begin    
		 
			if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') and (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then 
				 
				select	max(b.ds_especialidade), 
					max(substr(obter_nome_pf(c.cd_pessoa_fisica),1,255)) 
				into STRICT	ds_especialidade_w, 
					nm_especialista_w 
				from	agenda a, 
					especialidade_medica b, 
					pessoa_fisica c 
				where	a.cd_especialidade = b.cd_especialidade 
				and	a.cd_pessoa_fisica = c.cd_pessoa_fisica 
				and	a.cd_agenda = cd_agenda_p;
							 
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@paciente', nm_paciente_w);									
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@data', dt_agenda_w);			
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@dia', to_char(to_date(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy'));
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@hora', to_char(to_date(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss'),'hh24:mi'));
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@hrCanc', to_char(clock_timestamp(),'dd/mm/yyyy'));	
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@dtCanc', to_char(clock_timestamp(),'dd/mm/yyyy'));			
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@agendamento', ds_especialidade_w);
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@especialista', nm_especialista_w);
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@motivoCanc', coalesce(ds_motivo_p,ds_motivo_status_w));
				 
				CALL enviar_email(ds_titulo_w, ds_mensagem_w, ds_remetente_w, ds_email_destino_w, 'Tasy', 'A');
			end if;
			 
		exception 
		when others then 
			ds_erro_w	:= substr(sqlerrm,1,2000);			
			ds_erro_w	:= substr(ds_erro_w||'- ageweb_alterar_status -Parm>'||cd_agenda_p||'-'||nr_seq_agenda_p||'-'||cd_tipo_agenda_p||'-'||ie_status_p||'-'||cd_motivo_p||'-'||ds_motivo_p,1,4000);				
			insert into log_ageweb(dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_log) values (clock_timestamp(),'ageWeb',clock_timestamp(),'ageWeb',ds_erro_w);			
			ie_erro_p := 'EMAIL';
		end;
	else 
		ie_erro_p := upper(Wheb_mensagem_pck.get_texto(307630)); --'CANCELADO'; 
	end if;
	 
elsif (cd_tipo_agenda_p = 2) then 
 
	select	count(*) 
	into STRICT	qt_cancelado_w 
	from	agenda_paciente 
	where	nr_sequencia = nr_seq_agenda_p 
	and	ie_status_agenda = 'C';
 
	if (qt_cancelado_w = 0) then 
		CALL Alterar_status_agenda(cd_agenda_p, 
					nr_seq_agenda_p, 
					ie_status_p, 
					coalesce(cd_motivo_p,cd_mot_cancel_exame_w), 
					coalesce(ds_motivo_p,ds_motivo_status_w), 
					'N', 
					'Tasy');
		ie_erro_p	:= 'OK';
					 
		select	max(ds_titulo), 
			max(ds_remetente), 
			max(ds_mensagem) 
		into STRICT	ds_titulo_w, 
			ds_remetente_w, 
			ds_mensagem_w 
		from	ageweb_cadastro_email 
		where	ie_tipo_email = 'CA' 
		and	((ie_tipo_agenda = 'E') or (ie_tipo_agenda = 'A'));
			 
		select	max(cd_pessoa_fisica), 
			max(to_char(hr_inicio,'dd/mm/yyyy hh24:mi')), 
			max(nr_seq_proc_interno), 
			max(cd_medico_exec) 
		into STRICT	cd_pessoa_fisica_w, 
			dt_agenda_w, 
			nr_seq_proc_interno_w, 
			cd_medico_exec_w 
		from	agenda_paciente 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		select	max(b.ds_email), 
			max(substr(obter_nome_pf(a.cd_pessoa_fisica),1,255)) 
		into STRICT	ds_email_destino_w, 
			nm_paciente_w 
		from	pessoa_fisica a, 
			compl_pessoa_fisica b 
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica 
		and	b.ie_tipo_complemento 	= 1 
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		 
		begin		 
			if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') and (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then 
				 
				nm_especialista_w	:= obter_nome_pf(cd_medico_exec_w);
				 
				select	max(ds_proc_exame) 
				into STRICT	ds_proc_exame_w 
				from	proc_interno 
				where	nr_sequencia = nr_seq_proc_interno_w;
							 
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@paciente', nm_paciente_w);									
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@data', dt_agenda_w);	
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@dia', to_char(to_date(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy'));
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@hora', to_char(to_date(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss'),'hh24:mi'));						
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@hrCanc', to_char(clock_timestamp(),'dd/mm/yyyy'));
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@dtCanc', to_char(clock_timestamp(),'dd/mm/yyyy'));
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@agendamento', ds_proc_exame_w);
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@especialista', nm_especialista_w);
				ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@motivoCanc', coalesce(ds_motivo_p,ds_motivo_status_w));
				 
				CALL enviar_email(ds_titulo_w, ds_mensagem_w, ds_remetente_w, ds_email_destino_w, 'Tasy', 'A');
			end if;
		exception 
		when others then 
			ds_erro_w	:= substr(sqlerrm,1,2000);			
			ds_erro_w	:= substr(ds_erro_w||'- ageweb_alterar_status -Parm>'||cd_agenda_p||'-'||nr_seq_agenda_p||'-'||cd_tipo_agenda_p||'-'||ie_status_p||'-'||cd_motivo_p||'-'||ds_motivo_p,1,4000);				
			insert into log_ageweb(dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_log) values (clock_timestamp(),'ageWeb',clock_timestamp(),'ageWeb',ds_erro_w);			
			ie_erro_p := 'EMAIL';
		end;		
	else 
		ie_erro_p := upper(Wheb_mensagem_pck.get_texto(307630)); --'CANCELADO'; 
	end if;
end if;					
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageweb_alterar_status (cd_agenda_p bigint, nr_seq_agenda_p bigint, cd_tipo_agenda_p bigint, ie_status_p text, cd_motivo_p text, ds_motivo_p text, ie_erro_p INOUT text) FROM PUBLIC;

