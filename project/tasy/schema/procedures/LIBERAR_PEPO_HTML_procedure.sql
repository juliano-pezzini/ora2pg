-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_pepo_html ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_local_estoque_p bigint, ie_opcao_p text) AS $body$
DECLARE

 
ie_parametro_158_w 	varchar(1);
ie_gerar_lanc_autom_w 	varchar(1);
cd_perfil_w  		integer;
nm_usuario_w  		varchar(15);
cd_estabelecimento_w 	integer;
nr_cirurgia_w  		cirurgia.NR_CIRURGIA%TYPE;
nr_prescricao_w  		cirurgia.NR_PRESCRICAO%TYPE;

c01 CURSOR FOR 
	SELECT  	nr_cirurgia, 
		nr_prescricao 
	from   	cirurgia 
	where  	nr_seq_pepo = nr_seq_pepo_p;


BEGIN 
 
cd_perfil_w  		:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w  		:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
 
ie_gerar_lanc_autom_w := obter_param_usuario(872, 323, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_gerar_lanc_autom_w);
ie_parametro_158_w := obter_param_usuario(872, 158, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_parametro_158_w);
 
if (coalesce(nr_cirurgia_p,0) = 0) and (coalesce(nr_seq_pepo_p,0) > 0) then 
	open C01;
	loop 
	fetch C01 into 
		nr_cirurgia_w, 
		nr_prescricao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
		CALL liberar_pepo(nr_cirurgia_w, ie_opcao_p, nm_usuario_w, nr_seq_pepo_p);
		if (ie_gerar_lanc_autom_w = 'S') and (ie_opcao_p = 'L') then 
			CALL liberar_pepob_js(nr_cirurgia_w, nr_prescricao_w, cd_local_estoque_p, nm_usuario_w);
		end if;
	end;
	end loop;
	close c01;
elsif (coalesce(nr_cirurgia_p,0) > 0) then 
	select 	max(nr_prescricao) 
	into STRICT 	nr_prescricao_w 
	from 	cirurgia 
	where 	nr_cirurgia = nr_cirurgia_p;
 
	CALL liberar_pepo(nr_cirurgia_p, ie_opcao_p, nm_usuario_w);
	if (ie_gerar_lanc_autom_w = 'S') and (ie_opcao_p = 'L') then 
		CALL liberar_pepob_js(nr_cirurgia_p, nr_prescricao_w, cd_local_estoque_p, nm_usuario_w);
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_pepo_html ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_local_estoque_p bigint, ie_opcao_p text) FROM PUBLIC;

