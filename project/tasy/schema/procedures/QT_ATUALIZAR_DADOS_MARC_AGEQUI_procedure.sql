-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_atualizar_dados_marc_agequi ( nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_minuto_duracao_p bigint, ie_gerar_p INOUT text) AS $body$
DECLARE


dt_prevista_w		timestamp;
dt_real_w		timestamp;
qt_tempo_medic_w	bigint;
qt_marcacao_w		bigint;
qt_em_agenda_w		bigint;
qt_pendencia_marcada_w	bigint;
dt_ultimo_horario_w	timestamp;
ie_dia_quimio_w		varchar(1)	:= 'S';
ie_gerar_w		varchar(1)	:= 'N';
qt_tempo_prep_medic_w	bigint;
qt_tempo_prep_pac_w	bigint;
cd_pessoa_fisica_w	varchar(10);
ds_result_pac_prof_w	varchar(255);
ie_prof_marcado_w	varchar(1)	:= 'N';
nr_seq_prof_w		bigint;
ie_tipo_agendamento_w	varchar(15)	:= 'P';
ie_perm_mesmo_horario_w	varchar(1)	:= 'N';
nr_min_apres_w		bigint;
nr_min_apres_local_w	smallint;


BEGIN
select	coalesce(max(Obter_Valor_Param_Usuario(865, 1, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_medic_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	qt_tempo_prep_pac_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 4, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	ie_perm_mesmo_horario_w
;

select	coalesce(max(Obter_Valor_Param_Usuario(865, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),0)
into STRICT	nr_min_apres_w
;

select	max(nr_min_apres)
into STRICT	nr_min_apres_local_w
from	qt_local
where	nr_sequencia = nr_seq_local_p;

/*begin
select	b.dt_prevista,
	b.dt_real,
	a.qt_tempo_medic,
	a.cd_pessoa_fisica
into	dt_prevista_w,
	dt_real_w,
	qt_tempo_medic_w,
	cd_pessoa_fisica_w
from	paciente_setor a,
	paciente_atendimento b
where	b.nr_seq_pend_agenda	= nr_seq_pendencia_p
and	a.nr_seq_paciente	= b.nr_seq_paciente
and	trunc(nvl(b.dt_real, b.dt_prevista))	= trunc(dt_agenda_p);
exception
	when others then
	ie_dia_quimio_w	:= 'N';
end;*/
ie_dia_quimio_w	:= 'S';

if (ie_dia_quimio_w	= 'S') then
	select	max(nr_seq_prof)
	into STRICT	nr_seq_prof_w
	from	agenda_quimio
	where	nr_Sequencia	= nr_seq_agenda_p;

	qt_tempo_medic_w	:= nr_minuto_duracao_p;

	select	count(*)
	into STRICT	qt_marcacao_w
	from	agenda_quimio_marcacao
	where	dt_agenda_p between dt_Agenda and dt_Agenda + (nr_duracao - 1) / 1440
	and	nr_seq_local		= nr_seq_local_p
	and	nm_usuario		= nm_usuario_p
	and	nr_seq_agenda		= nr_seq_agenda_p;

	if (qt_marcacao_w	> 0) then
		delete 	FROM agenda_quimio_marcacao
		where	dt_agenda_p + 1 /1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440
		and	nr_seq_local		= nr_seq_local_p
		and	nm_usuario		= nm_usuario_p
		and	nr_seq_agenda		= nr_seq_agenda_p;

		ie_gerar_w	:= 'S';
	else
		ds_result_pac_prof_w := Qt_Consistir_Pac_Prof(nr_seq_prof_w, nr_seq_local_p, dt_agenda_p, qt_tempo_prep_pac_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_agenda_p, ds_result_pac_prof_w);
		if (ds_result_pac_prof_w = 'M') then
			ie_gerar_w		:= 'E';
			ie_prof_marcado_w	:= 'S';
		elsif (ds_result_pac_prof_w = 'L') then
			ie_gerar_w		:= 'L';
			ie_prof_marcado_w	:= 'S';
		elsif (ds_result_pac_prof_w = 'H') then
			ie_gerar_w		:= 'H';
			ie_prof_marcado_w	:= 'S';
		end if;

		if (ie_prof_marcado_w	= 'N') then
			select	count(*)
			into STRICT	qt_pendencia_marcada_w
			from	agenda_quimio_marcacao
			where	nr_seq_agenda		= nr_seq_agenda_p
			and	trunc(dt_agenda)		= trunc(dt_agenda_p);

			if (qt_pendencia_marcada_w = 0) then
				select	count(*)
				into STRICT	qt_marcacao_w
				from	agenda_quimio_marcacao
				where	((dt_agenda_p between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
				or	(dt_agenda_p + (qt_tempo_medic_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
				or	(dt_agenda between dt_agenda_p and dt_agenda_p + (qt_tempo_medic_w - 1) / 1440)
				or	(dt_agenda + (nr_duracao - 1) / 1440 between dt_agenda_p and dt_agenda_p + (qt_tempo_medic_w - 1) / 1440))
				and	nr_seq_local	= nr_seq_local_p
				and	nr_seq_agenda		<> nr_seq_agenda_p;

				if (qt_marcacao_w	> 0) then
					ie_Gerar_w	:= 'A';
				end if;

				select	count(*)
				into STRICT	qt_em_agenda_w
				from	w_agenda_quimio
				where	nr_seq_local	= nr_seq_local_p
				and	nm_usuario	= nm_usuario_p
				and	ie_status = 'EA'
				and	trunc(dt_horario)	= trunc(dt_agenda_p)
				and	nr_seq_agequi		= nr_seq_agenda_p;

				select	max(dt_horario)
				into STRICT	dt_ultimo_horario_w
				from	w_agenda_quimio
				where	dt_horario between dt_agenda_p and dt_agenda_p + qt_tempo_medic_w / 1440
				and	nr_seq_local	= nr_seq_local_p
				and	nm_usuario	= nm_usuario_p;
				--and	nr_seq_agequi		= nr_seq_agenda_p;
			else
				ie_Gerar_w	:= 'M';
			end if;
		end if;

		if (ie_perm_mesmo_horario_w = 'S') and
			(((dt_agenda_p + qt_tempo_medic_w / 1440) >= (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) and (qt_marcacao_w		> 0) or (qt_em_agenda_w		> 0)) then
			ie_tipo_agendamento_w	:= 'E';
			ie_Gerar_w		:= 'X';
		end if;
		/*
		if	(nr_seq_agenda_p	= 3572) then
			(-20011,qt_marcacao_w||'-'||qt_em_agenda_w||'-'||ie_perm_mesmo_horario_w||'-'||qt_pendencia_marcada_w||'-'||ie_prof_marcado_w||'-'||qt_tempo_medic_w||'-'||dt_ultimo_horario_w||'-'||nr_min_apres_w);
		end if;*/
		if	(((dt_agenda_p + qt_tempo_medic_w / 1440) <= (dt_ultimo_horario_w + coalesce(nr_min_apres_local_w,nr_min_apres_w) / 1440)) and (qt_marcacao_w		= 0) and (qt_em_agenda_w		= 0) or (ie_perm_mesmo_horario_w = 'S')) and (qt_pendencia_marcada_w	= 0) and (ie_prof_marcado_w	= 'N') then

			insert into agenda_quimio_marcacao(nr_sequencia,
				dt_agenda,
				nm_usuario,
				nr_seq_local,
				nr_duracao,
				nr_seq_agenda,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_gerado,
				ie_transferencia,
				nr_seq_prof,
				ie_tipo_agendamento)
			values (nextval('agenda_quimio_marcacao_seq'),
				dt_agenda_p,
				nm_usuario_p,
				nr_seq_local_p,
				qt_tempo_medic_w,
				nr_seq_agenda_p,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				'N',
				'N',
				nr_seq_prof_w,
				ie_tipo_agendamento_w);
			if (ie_Gerar_w	<> 'X') then
				ie_gerar_w	:= 'S';
			end if;
		end if;
	end if;
end if;

ie_gerar_p	:= ie_gerar_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_atualizar_dados_marc_agequi ( nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_seq_local_p bigint, cd_estabelecimento_p bigint, nr_minuto_duracao_p bigint, ie_gerar_p INOUT text) FROM PUBLIC;

