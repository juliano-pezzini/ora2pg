-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_fpr_dialise_mensal (dt_inicial_p timestamp, dt_final_p timestamp, cd_empresa_param_p bigint, nr_seq_unid_dialise_p bigint, nm_usuario_p text) AS $body$
DECLARE

dt_inicial_w	timestamp;
dt_final_w	timestamp;
dt_atual_w	timestamp;
	
qt_entrada_agudo_w  			bigint;
qt_entrada_cronico_w			bigint;
qt_obito_agudo_w			bigint;
qt_obito_cro_menos_90_dias_w		bigint;
qt_obito_cro_mais_90_dias_w		bigint;
qt_saida_tx_w				bigint;
qt_desistencia_w			bigint;
qt_transferencia_w			bigint;
qt_hd_hp_w				bigint;
qt_alta_cronico_w			bigint;
qt_alta_agudo_w				bigint;
qt_fim_mes_cronico_w			bigint;
qt_cronicos_fim_mes_ant_w		bigint;
qt_agudos_fim_mes_ant_w			bigint;
qt_fim_mes_agudo_w			bigint;
qt_pac_transito_w			bigint;
qt_sessoes_dialise_w			bigint;
qt_pac_diabeticos_w			bigint;
qt_acesso_adequado_w			bigint;
qt_acesso_inadequado_w			bigint;
qt_acesso_dl_w				bigint;
qt_acesso_permcath_w			bigint;
qt_acesso_protese_w			bigint;
qt_perdas_acessos_w			bigint;
qt_perdas_permcath_w			bigint;
qt_perdas_dl_w				bigint;
qt_novos_cateter_dl_w			bigint;
qt_novos_permcath_w			bigint;
qt_acessos_realizados_w			bigint;
qt_pirogenia_w				bigint;
qt_transfusoes_w			bigint;
qt_culturas_w				bigint;
qt_pressao_alta_pos_w			bigint;
qt_pressao_alta_pre_w			bigint;
qt_internados_w				bigint; -- faltante
nr_seq_unid_dialise_w			bigint;
nr_seq_evento_pirogenia_w		bigint;
cd_pessoa_fisica_w			varchar(10);
vl_pressao_pres_med_w			real;
vl_pressao_pred_med_w			real;
vl_pressao_poss_med_w			real;
vl_pressao_posd_med_w			real;
nr_tipo_evento_internacao_w		bigint;

qt_mes_atual_w				bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	hd_unidade_dialise
	where	((nr_sequencia = nr_seq_unid_dialise_p) or (coalesce(nr_seq_unid_dialise_p,0) = 0))
	and	((obter_empresa_estab(cd_estabelecimento) = cd_empresa_param_p) or (coalesce(cd_empresa_param_p,0) = 0));
	
C02 CURSOR FOR
	SELECT  distinct cd_pessoa_fisica
	from	hd_dialise
	where	PKG_DATE_UTILS.start_of(dt_dialise,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
	and	coalesce(dt_cancelamento::text, '') = ''
	and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
	and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
	

BEGIN

dt_inicial_w	:= fim_mes(dt_inicial_p);
dt_final_w	:= fim_mes(dt_final_p);

dt_atual_w	:= dt_inicial_w;

select	trunc(months_between(dt_final_p,dt_inicial_p) + 1)
into STRICT	qt_mes_atual_w
;

delete	FROM w_fpr_dialise_mensal
where	nm_usuario = nm_usuario_p;

while dt_atual_w <= dt_final_w loop
	begin	
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_unid_dialise_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		begin
		
		select  max(nr_seq_evento_pirogenia),
			max(nr_seq_tipo_evento)
		into STRICT	nr_seq_evento_pirogenia_w,
			nr_tipo_evento_internacao_w
		from	hd_parametro
		where	cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w);
				
		select 	count(*)
		into STRICT	qt_entrada_agudo_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(dt_inicio_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	ie_paciente_agudo = 'S'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_entrada_cronico_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(dt_inicio_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	ie_paciente_agudo = 'N'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_obito_agudo_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	a.ie_paciente_agudo = 'S'
		and	b.ie_tipo_tratamento = 'O'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_obito_cro_menos_90_dias_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'O'
		and (clock_timestamp() - a.dt_inicio_tratamento) < 90
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_obito_cro_mais_90_dias_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'O'
		and (clock_timestamp() - a.dt_inicio_tratamento) >= 90
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select	count(*)
		into STRICT	qt_saida_tx_w
		from	hd_pac_renal_cronico a,
			tx_receptor b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	PKG_DATE_UTILS.start_of(b.dt_transplante,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	tx_obter_estab_receptor(b.nr_sequencia) = 		HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w);
		
		select 	count(*)
		into STRICT	qt_desistencia_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	b.ie_tipo_tratamento = 'D'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_transferencia_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	b.ie_tipo_tratamento = 'TU'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_hd_hp_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	b.ie_tipo_tratamento = 'TDP'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_alta_agudo_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	a.ie_paciente_agudo = 'S'
		and	b.ie_tipo_tratamento = 'A'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_alta_cronico_w
		from 	paciente_tratamento a,
			motivo_fim b
		where	a.nr_seq_motivo_fim = b.nr_sequencia
		and	a.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	PKG_DATE_UTILS.start_of(a.dt_final_tratamento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	a.ie_paciente_agudo = 'N'
		and	b.ie_tipo_tratamento = 'A'
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_fim_mes_agudo_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'S'
		and	((PKG_DATE_UTILS.start_of(dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_fim_mes_cronico_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'N'
		and	((PKG_DATE_UTILS.start_of(dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_cronicos_fim_mes_ant_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'N'
		and	((PKG_DATE_UTILS.start_of(dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_atual_w,-1,0)), 'dd', 0)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_atual_w,-1,0)), 'dd', 0))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_agudos_fim_mes_ant_w
		from 	paciente_tratamento
		where	ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	ie_paciente_agudo = 'S'
		and	((PKG_DATE_UTILS.start_of(dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_atual_w,-1,0)), 'dd', 0)) or (coalesce(dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_atual_w,-1,0)), 'dd', 0))
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select	count(*)
		into STRICT	qt_pac_transito_w
		from	hd_pac_renal_cronico a,
			paciente_tratamento b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	b.nr_seq_unid_dialise <> hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w)
		and	b.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	((PKG_DATE_UTILS.start_of(b.dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(b.dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(b.dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	b.nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_sessoes_dialise_w
		from 	hd_dialise
		where	PKG_DATE_UTILS.start_of(dt_dialise,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	coalesce(dt_cancelamento::text, '') = ''
		and	(dt_fim_dialise IS NOT NULL AND dt_fim_dialise::text <> '')
		and	nr_seq_unid_dialise = nr_seq_unid_dialise_w;
		
		select	count(*)
		into STRICT	qt_pac_diabeticos_w
		from	hd_pac_renal_cronico a,
			paciente_tratamento b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and	b.ie_tratamento in ('HD','PL','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DDC','IHF','IHDF')
		and	a.ie_diabetico = 'S'
		and	((PKG_DATE_UTILS.start_of(b.dt_final_tratamento, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(b.dt_final_tratamento::text, '') = ''))
		and (PKG_DATE_UTILS.start_of(b.dt_inicio_tratamento, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	b.nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_acesso_adequado_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and	ie_adequado = 'S'
		and (PKG_DATE_UTILS.start_of(dt_instalacao, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	((PKG_DATE_UTILS.start_of(dt_perda_retirada, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_acesso_inadequado_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and	ie_adequado = 'N'
		and (PKG_DATE_UTILS.start_of(dt_instalacao, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	((PKG_DATE_UTILS.start_of(dt_perda_retirada, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_acesso_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (PKG_DATE_UTILS.start_of(dt_instalacao, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	((PKG_DATE_UTILS.start_of(dt_perda_retirada, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_acesso_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (PKG_DATE_UTILS.start_of(dt_instalacao, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	((PKG_DATE_UTILS.start_of(dt_perda_retirada, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_acesso_protese_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PR'
		and (PKG_DATE_UTILS.start_of(dt_instalacao, 'dd', 0) <= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0))
		and	((PKG_DATE_UTILS.start_of(dt_perda_retirada, 'dd', 0) >= PKG_DATE_UTILS.start_of(dt_atual_w, 'dd', 0)) or (coalesce(dt_perda_retirada::text, '') = ''))
		and	hd_obter_se_pac_ativo_data(a.cd_pessoa_fisica,dt_atual_w) = 'S'
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_perdas_acessos_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and (PKG_DATE_UTILS.start_of(dt_perda_retirada,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_perdas_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (PKG_DATE_UTILS.start_of(dt_perda_retirada,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_perdas_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (PKG_DATE_UTILS.start_of(dt_perda_retirada,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		
		select 	count(*)
		into STRICT	qt_acessos_realizados_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'FAV'
		and (PKG_DATE_UTILS.start_of(dt_instalacao,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		select 	count(*)
		into STRICT	qt_novos_cateter_dl_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'DL'
		and (PKG_DATE_UTILS.start_of(dt_instalacao,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_novos_permcath_w
		from	hd_acesso a,
			hd_tecnica_acesso b,
			hd_pac_renal_cronico c
		where	a.nr_seq_tecnica = b.nr_sequencia
		and	c.cd_pessoa_fisica = a.cd_pessoa_fisica
		and	b.ie_tipo_acesso = 'PE'
		and (PKG_DATE_UTILS.start_of(dt_instalacao,'month',0) >= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0))
		and	hd_obter_unid_dialise_data(a.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
	
		select	count(*)
		into STRICT	qt_pirogenia_w
		from	HD_DIALISE_EVENTO a,
			hd_dialise b
		where	a.nr_seq_dialise = b.nr_sequencia
		and	NR_SEQ_TIPO_EVENTO = nr_seq_evento_pirogenia_w
		and	PKG_DATE_UTILS.start_of(dt_dialise,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	coalesce(b.dt_cancelamento::text, '') = ''
		and	(b.dt_fim_dialise IS NOT NULL AND b.dt_fim_dialise::text <> '')
		and	b.nr_seq_unid_dialise = nr_seq_unid_dialise_w;

		select 	count(*)
		into STRICT	qt_transfusoes_w
		from	prescr_procedimento a,
			prescr_medica b
		where	a.nr_prescricao = b.nr_prescricao
		and	PKG_DATE_UTILS.start_of(dt_prescricao,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '')
		and	ie_suspenso = 'N'
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w);
		
		select 	count(*)
		into STRICT	qt_culturas_w
		from	prescr_procedimento a,
			prescr_medica b,
			exame_laboratorio c
		where	a.nr_prescricao 		= b.nr_prescricao
		and	a.nr_seq_exame			= c.nr_seq_exame
		and	PKG_DATE_UTILS.start_of(dt_prescricao,'month',0) 	= PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')
		and	ie_suspenso = 'N'
		and	ie_formato_resultado in ('SDM','SM')
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	b.cd_estabelecimento = HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w);
		
		qt_pressao_alta_pre_w	:= 0;
		qt_pressao_alta_pos_w	:= 0;
		
		open C02;
		loop
		fetch C02 into	
			cd_pessoa_fisica_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			vl_pressao_pres_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,PKG_DATE_UTILS.start_of(dt_atual_w,'month',0),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PRES'))::numeric )::numeric,2);
			vl_pressao_pred_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,PKG_DATE_UTILS.start_of(dt_atual_w,'month',0),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PRED'))::numeric )::numeric,2);
			vl_pressao_poss_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,PKG_DATE_UTILS.start_of(dt_atual_w,'month',0),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PROS'))::numeric )::numeric,2);
			vl_pressao_posd_med_w	:=	round(((hd_obter_media_pressao_data(cd_pessoa_fisica_w,PKG_DATE_UTILS.start_of(dt_atual_w,'month',0),dt_atual_w,HD_OBTER_ESTAB_UNIDADE(nr_seq_unid_dialise_w),nr_seq_unid_dialise_w,'PROD'))::numeric )::numeric,2);
			
			if (vl_pressao_pres_med_w > 140) or (vl_pressao_pred_med_w > 90) then
				qt_pressao_alta_pre_w	:= qt_pressao_alta_pre_w + 1;
			end if;
			
			if (vl_pressao_poss_med_w > 140) or (vl_pressao_posd_med_w > 90) then
				qt_pressao_alta_pos_w	:= qt_pressao_alta_pos_w + 1;
			end if;
			
			end;
		end loop;
		close C02;
		
		select	count(*)
		into STRICT	qt_internados_w
		from	QUA_EVENTO_PACIENTE a,
			atendimento_paciente b,
			qua_evento c
		where	a.nr_atendimento = b.nr_atendimento
		and	a.nr_seq_evento = c.nr_sequencia
		and	hd_obter_se_pac_ativo_data(b.cd_pessoa_fisica,dt_atual_w) = 'S'		
		and	nr_seq_tipo = nr_tipo_evento_internacao_w
		and	PKG_DATE_UTILS.start_of(dt_evento,'month',0) = PKG_DATE_UTILS.start_of(dt_atual_w,'month',0)
		and	coalesce(a.ie_tipo_evento,'E') = 'E'
		and	hd_obter_unid_dialise_data(b.cd_pessoa_fisica,dt_atual_w) = nr_seq_unid_dialise_w;
		
		insert into w_fpr_dialise_mensal(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_referencia,
				nr_seq_unid_dialise,
				qt_entrada_agudo,
				qt_entrada_cronico,
				qt_obito_agudo,
				qt_obito_cronico_menos_90_dias,
				qt_obito_cronico_mais_90_dias,
				qt_saida_tx,
				qt_desistencia,
				qt_transferencia,
				qt_hd_hp,
				qt_alta_cronico,
				qt_alta_agudo,
				qt_agudos_fim_mes,
				qt_cronicos_fim_mes,
				qt_pac_transito,
				qt_sessoes_dialise,
				qt_acesso_adequado,
				qt_acesso_inadequado,
				qt_cateter_dl,
				qt_permcath,
				qt_protese,
				qt_acessos_realizados,
				qt_pressao_alta_pre,
				qt_pressao_alta_pos,
				qt_transfusoes,
				qt_culturas,
				qt_perdas_acessos,
				qt_perdas_dl,
				qt_perdas_permcath,
				qt_novos_cateter_dl,
				qt_novos_permcatch,
				qt_pirogenia,
				qt_internados,
				qt_pac_diabeticos,
				qt_cronicos_fim_mes_ant,
				qt_agudos_fim_mes_ant,
				qt_mes_atual)
			values (	nextval('w_fpr_dialise_mensal_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				dt_atual_w,
				nr_seq_unid_dialise_w,
				qt_entrada_agudo_w,
				qt_entrada_cronico_w,
				qt_obito_agudo_w,
				qt_obito_cro_menos_90_dias_w,
				qt_obito_cro_mais_90_dias_w,
				qt_saida_tx_w,
				qt_desistencia_w,
				qt_transferencia_w,
				qt_hd_hp_w,
				qt_alta_cronico_w,
				qt_alta_agudo_w,
				qt_fim_mes_agudo_w,
				qt_fim_mes_cronico_w,
				qt_pac_transito_w,
				qt_sessoes_dialise_w,
				qt_acesso_adequado_w,
				qt_acesso_inadequado_w,
				qt_acesso_dl_w,
				qt_acesso_permcath_w,
				qt_acesso_protese_w,
				qt_acessos_realizados_w,
				qt_pressao_alta_pre_w,
				qt_pressao_alta_pos_w,
				qt_transfusoes_w,
				qt_culturas_w,
				qt_perdas_acessos_w,
				qt_perdas_dl_w,
				qt_perdas_permcath_w,
				qt_novos_cateter_dl_w,
				qt_novos_permcath_w,
				qt_pirogenia_w,
				qt_internados_w,
				qt_pac_diabeticos_w,
				qt_cronicos_fim_mes_ant_w,
				qt_agudos_fim_mes_ant_w,
				qt_mes_atual_w);
		end;
	end loop;
	close C01;

	dt_atual_w	:= fim_mes(dt_atual_w + 1);
	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_fpr_dialise_mensal (dt_inicial_p timestamp, dt_final_p timestamp, cd_empresa_param_p bigint, nr_seq_unid_dialise_p bigint, nm_usuario_p text) FROM PUBLIC;

