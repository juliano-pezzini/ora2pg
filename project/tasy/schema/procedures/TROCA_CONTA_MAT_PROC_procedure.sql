-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE troca_conta_mat_proc (nr_seq_mat_p bigint, nr_seq_proc_p bigint, nr_interno_conta_p bigint, ie_commit_p text) AS $body$
DECLARE


dt_acerto_conta_w		timestamp;
cd_convenio_parametro_w		integer;
cd_categoria_parametro_w	varchar(20);
ie_guia_transf_conta_w		varchar(1);
cd_estabelecimento_w		integer;
nm_usuario_w			varchar(15);
ie_guia_transf_conta_ww		varchar(1);
ie_consiste_periodo_w		varchar(1);
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;
qt_periodo_w			bigint;
cd_convenio_w			material_atend_paciente.cd_convenio%type;


BEGIN
select	dt_acerto_conta,
	cd_convenio_parametro,
	cd_categoria_parametro,
	cd_estabelecimento,
	dt_periodo_inicial,
	dt_periodo_final
into STRICT	dt_acerto_conta_w,
	cd_convenio_parametro_w,
	cd_categoria_parametro_w,
	cd_estabelecimento_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

select	coalesce(max(ie_guia_transf_conta),'N')
into STRICT	ie_guia_transf_conta_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_parametro_w
and	cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(max(ie_guia_transf_conta),'R')
into STRICT	ie_guia_transf_conta_ww
from	parametro_faturamento
where	cd_estabelecimento = cd_estabelecimento_w;

ie_consiste_periodo_w := coalesce(obter_valor_param_usuario(67, 562, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w),'N');
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

if (coalesce(nr_seq_mat_p,0) > 0) then

	if (ie_consiste_periodo_w = 'S') then
	
		qt_periodo_w:= 0;
	
		select 	count(*)
		into STRICT	qt_periodo_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_seq_mat_p
		and 	coalesce(dt_conta,dt_atendimento) between dt_periodo_inicial_w and dt_periodo_final_w;
		
		if (qt_periodo_w = 0) then
			--R.aise_application_error(-20011,'The date of the item is outside the term of the account selected. It is impossible to execute this transference. Parameter [562]'||'#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263636);
		end if;
	
	end if;

	if (ie_guia_transf_conta_ww = 'R') then
		update 	material_atend_paciente
		set	nr_doc_convenio	= CASE WHEN ie_guia_transf_conta_w='S' THEN null  ELSE nr_doc_convenio END
		where	nr_sequencia = nr_seq_mat_p;
	elsif (ie_guia_transf_conta_ww = 'T') then
		update 	material_atend_paciente
		set	nr_doc_convenio	 = NULL
		where	nr_sequencia = nr_seq_mat_p;
	end if;
		
	update 	material_atend_paciente
	set	dt_acerto_conta = dt_acerto_conta_w,
		nr_interno_conta = nr_interno_conta_p,
		cd_convenio = cd_convenio_parametro_w,
		cd_categoria = cd_categoria_parametro_w,
		cd_motivo_exc_conta  = NULL,
		ds_compl_motivo_excon  = NULL,
		nm_usuario = coalesce(substr(wheb_usuario_pck.get_nm_usuario,1,15),nm_usuario),
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_mat_p;
	
	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'es_AR') then
		CALL transfer_coinsurance_item(
			nr_seq_mat_p 		=> nr_seq_mat_p,
			nr_seq_proc_p 		=> nr_seq_proc_p,
			nr_interno_conta_p 	=> nr_interno_conta_p,
			nm_usuario_p 		=> nm_usuario_w
		);
	end if;

	CALL atualiza_preco_material(nr_seq_mat_p,nm_usuario_w);

	select	coalesce(max(nm_usuario), 'Tasy'),
		coalesce(max(cd_convenio), 0)
	into STRICT	nm_usuario_w, 
		cd_convenio_w
	from 	material_atend_paciente
	where 	nr_sequencia = nr_seq_mat_p;
		
	if (cd_convenio_w = cd_convenio_parametro_w) then 		
		CALL trocar_conta_auditoria(nr_interno_conta_p, nr_seq_mat_p, 2, nm_usuario_w ,null, 'N', 'N');
	end if;
	
elsif (coalesce(nr_seq_proc_p,0) > 0) then

	if (ie_consiste_periodo_w = 'S') then
	
		qt_periodo_w:= 0;
	
		select 	count(*)
		into STRICT	qt_periodo_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_seq_proc_p
		and 	coalesce(dt_conta,dt_procedimento) between dt_periodo_inicial_w and dt_periodo_final_w;
		
		if (qt_periodo_w = 0) then
			--R.aise_application_error(-20011,'The date of the item is outside the term of the account selected. It is impossible to execute this transference. Parameter [562]'||'#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263636);
		end if;
	
	end if;
	
	if (ie_guia_transf_conta_ww = 'R') then
		update 	procedimento_paciente
		set	nr_doc_convenio	= CASE WHEN ie_guia_transf_conta_w='S' THEN null  ELSE nr_doc_convenio END
		where	nr_sequencia = nr_seq_proc_p;
	elsif (ie_guia_transf_conta_ww = 'T') then
		update	procedimento_paciente
		set	nr_doc_convenio	 = NULL
		where	nr_sequencia = nr_seq_proc_p;
	end if;
	
	update 	procedimento_paciente
	set	dt_acerto_conta = dt_acerto_conta_w,
		nr_interno_conta = nr_interno_conta_p,
		cd_convenio = cd_convenio_parametro_w,
		cd_categoria = cd_categoria_parametro_w,
		cd_motivo_exc_conta  = NULL,
		ds_compl_motivo_excon  = NULL,
		nm_usuario = coalesce(substr(wheb_usuario_pck.get_nm_usuario,1,15),nm_usuario),
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_proc_p;

	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'es_AR') then
		CALL transfer_coinsurance_item(
			nr_seq_mat_p 		=> nr_seq_mat_p,
			nr_seq_proc_p 		=> nr_seq_proc_p,
			nr_interno_conta_p 	=> nr_interno_conta_p,
			nm_usuario_p 		=> nm_usuario_w
		);
	end if;

	CALL atualiza_preco_procedimento(nr_seq_proc_p,cd_convenio_parametro_w,nm_usuario_w);

	select	coalesce(max(nm_usuario), 'Tasy'),
		coalesce(max(cd_convenio), 0)
	into STRICT	nm_usuario_w,
		cd_convenio_w
	from 	procedimento_paciente
	where 	nr_sequencia = nr_seq_proc_p;

	if (cd_convenio_w = cd_convenio_parametro_w) then 		
		CALL trocar_conta_auditoria(nr_interno_conta_p, nr_seq_proc_p, 1, nm_usuario_w,null,'N', 'N');
	end if;
end if;

if (ie_commit_p	= 'S') then
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE troca_conta_mat_proc (nr_seq_mat_p bigint, nr_seq_proc_p bigint, nr_interno_conta_p bigint, ie_commit_p text) FROM PUBLIC;

