-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_convenio_cheque_itau ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* VERSÃO 04.2 */
 
 
ds_conteudo_w		varchar(240);
nr_seq_apres_w		bigint;
cd_estabelecimento_w	smallint;
cd_cgc_estab_w		varchar(14);
nm_empresa_w		varchar(30);
dt_geracao_w		varchar(14);
cd_agencia_estab_w	varchar(4);
nr_conta_estab_w	varchar(5);
ie_digito_estab_w	varchar(1);
nm_emitente_cheque_w	pessoa_juridica.ds_razao_social%type;
dt_pagamento_w		bordero_cheque.dt_bordero%type;
cd_cnpj_cpf_w		cheque_cr.cd_cgc%type;
dt_bordero_w		bordero_cheque.dt_bordero%type;
ds_cmc7_w			cheque_cr.ds_cmc7%type;
vl_cheque_w			cheque_cr.vl_cheque%type;
vl_total_cobranca_w	cheque_cr.vl_cheque%type;
nr_seq_cheque_w		cheque_cr.nr_seq_cheque%type;

c01 CURSOR FOR 
SELECT	CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN  '00000000000000'  ELSE b.cd_cgc END , 
		obter_dados_pf_pj(null, b.cd_cgc, 'N'), 
		c.dt_bordero, 
		b.ds_cmc7, 
		b.vl_cheque, 
		b.nr_seq_cheque 
from	cheque_bordero a, 
		cheque_cr b, 
		bordero_cheque c 
where	a.nr_seq_cheque		= b.nr_seq_cheque 
and		c.nr_sequencia		= a.nr_seq_bordero 
and		c.nr_sequencia		= nr_seq_envio_p;


BEGIN 
 
delete	from w_envio_banco 
where	nm_usuario	= nm_usuario_p;
 
/* header de arquivo */
 
nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
 
select	a.cd_estabelecimento, 
	lpad(b.cd_cgc,14,'0'), 
	rpad(substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,30),30,' '), 
	to_char(clock_timestamp(),'ddmmyyyyhh24miss'), 
	lpad(coalesce(substr(c.cd_agencia_bancaria,1,4),'0'),4,'0'), 
	lpad(coalesce(substr(c.cd_conta,1,5),'0'),5,'0'), 
	coalesce(substr(c.ie_digito_conta,1,1),'0') 
into STRICT	cd_estabelecimento_w, 
	cd_cgc_estab_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	cd_agencia_estab_w, 
	nr_conta_estab_w, 
	ie_digito_estab_w 
from	banco_estabelecimento c, 
	estabelecimento b, 
	bordero_cheque a 
where	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_sequencia			= nr_seq_envio_p;
 
ds_conteudo_w	:=	'341' || 
			'0000' || 
			'0' || 
			rpad(' ',9,' ') || 
			'2' || 
			cd_cgc_estab_w || 
			rpad(' ',20,' ') || 
			'0' || 
			cd_agencia_estab_w || 
			' ' || 
			'0000000' || 
			nr_conta_estab_w || 
			' ' || 
			ie_digito_estab_w || 
			nm_empresa_w || 
			rpad('BANCO ITAU',30,' ') || 
			rpad(' ',10,' ') || 
			'1' || 
			dt_geracao_w || 
			lpad(nr_seq_apres_w,6,'0') || 
			'040' || 
			'00000' || 
			rpad(' ',69,' ');
 
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
/* header de lote */
 
nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
 
/* concatenar nessa variável os campos conforme layout do banco */
 
ds_conteudo_w	:=	'341' 	|| 
					'0001' 	|| 
					'1'		|| 
					'C'		|| 
					'06'	|| 
					'01'	|| 
					'030'	|| 
					' '		|| 
					'2'		|| 
					cd_cgc_estab_w		|| 
					rpad(' ',20,' ')	|| 
					'0'		|| 
					cd_agencia_estab_w	|| 
					' '		|| 
					'0000000'			|| 
					nr_conta_estab_w	|| 
					' '		|| 
					ie_digito_estab_w 	|| 
					nm_empresa_w 		|| 
					rpad(' ', 7, ' ')	|| 
					'   ' || 
					rpad(' ',125,' ')	|| 
					'1'; -- Tipo de Deposíto (Verificar o que deve ser enviado) 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
open	c01;
loop 
fetch	c01 into 
		cd_cnpj_cpf_w, 
		nm_emitente_cheque_w, 
		dt_bordero_w, 
		ds_cmc7_w, 
		vl_cheque_w, 
		nr_seq_cheque_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	/* segmento D */
 
	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
	vl_total_cobranca_w	:= coalesce(vl_total_cobranca_w,0) + coalesce(vl_cheque_w,0);
 
	/* concatenar nessa variável os campos conforme layout do banco */
 
	ds_conteudo_w	:=	'341' 	|| 
						'0001'	|| 
						'3'		|| 
						lpad(nr_seq_apres_w, 5, 0)	|| 
						'D'		|| 
						'000'	|| 
						'2'		|| 
						cd_cgc_estab_w			|| 
						rpad(' ',20,' ')		|| 
						'0'		|| 
						cd_agencia_estab_w		|| 
						' '		|| 
						'0000000'				|| 
						nr_conta_estab_w		|| 
						' '		|| 
						ie_digito_estab_w		|| 
						rpad(coalesce(nm_emitente_cheque_w, ' '), 30, ' ')		|| 
						'2'		|| 
						lpad(coalesce(cd_cnpj_cpf_w,0), 14, 0)				|| 
						to_char(dt_bordero_w, 'ddmmyyyy')		|| 
						to_char(dt_bordero_w, 'ddmmyyyy')		|| 
						lpad(coalesce(ds_cmc7_w, '0'), 30, '0')		|| 
						lpad(somente_numero(to_char(coalesce(vl_cheque_w,0),'9999999999999990.00')),18,'0') || 
						'0000000'				|| 
						rpad(' ', 16, ' ')		|| 
						rpad(coalesce(to_char(nr_seq_cheque_w),' '), 24, ' ')	|| 
						'000040' 				|| 
						'   '	|| 
						'1';
											 
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_apres, 
		nr_seq_apres_2, 
		nr_sequencia) 
	values (cd_estabelecimento_w, 
		ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_apres_w, 
		nr_seq_apres_w, 
		nextval('w_envio_banco_seq'));
 
end	loop;
close	c01;
 
/* trailer de lote */
 
 
 
/* concatenar nessa variável os campos conforme layout do banco */
 
ds_conteudo_w	:=	'341' 	|| 
					'0001'	|| 
					'5'		|| 
					rpad(' ', 9, ' ')	|| 
					'2'		|| 
					cd_cgc_estab_w 		|| 
					rpad(' ',20,' ')	|| 
					'0'		|| 
					cd_agencia_estab_w	|| 
					' '		|| 
					'0000000'			|| 
					nr_conta_estab_w	|| 
					' '		|| 
					ie_digito_estab_w	|| 
					rpad(' ', 98, ' ') 	|| 
					lpad(nr_seq_apres_w, 6, 0)	|| 
					lpad(somente_numero(to_char(coalesce(vl_total_cobranca_w,0),'9999999999999990.00')),18,'0') || 
					rpad(' ', 46, ' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
/* trailer de arquivo */
 
nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
 
/* concatenar nessa variável os campos conforme layout do banco */
 
ds_conteudo_w	:=	'341' 	|| 
					'9999'	|| 
					'9'		|| 
					rpad(' ', 9, ' ')			|| 
					'000001'					|| 
					lpad(nr_seq_apres_w, 6, 0)	|| 
					lpad(somente_numero(to_char(coalesce(vl_total_cobranca_w,0),'9999999999999990.00')),18,'0') || 
					rpad(' ', 193, ' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_convenio_cheque_itau ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

