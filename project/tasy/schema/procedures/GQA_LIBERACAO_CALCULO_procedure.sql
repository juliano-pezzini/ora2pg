-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_liberacao_calculo ( nr_seq_calculo_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text DEFAULT NULL, qt_valor_p bigint DEFAULT NULL, ie_atendeu_regra_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


nr_sequencia_w                bigint;
qt_idade_w                  	bigint;
cd_setor_atendimento_w      	bigint := null;
qt_idade_dias_w             	integer;
qt_peso_gramas_w            	double precision;
ie_retorno_w varchar(1) := 'N';

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_regra
	from    gqa_pendencia_regra a,
		gqa_pendencia b
	where   b.nr_sequencia	= a.nr_seq_pendencia
	and	b.ie_situacao 		= 'A'
	and	a.ie_situacao		= 'A'
  and b.NR_SEQ_CALC = nr_seq_calculo_p
	and	obter_se_gqa_regra_liberada(a.nr_sequencia) = 'S'
	and	qt_idade_w       between coalesce(a.qt_idade_min,0) and coalesce(a.qt_idade_max,999)
	and	qt_idade_dias_w  between coalesce(a.qt_dias_min ,0) and coalesce(a.qt_dias_max ,99999)
	and	qt_peso_gramas_w between coalesce(a.qt_peso_gramas_min,0) and coalesce(a.qt_peso_gramas_max,999999999)
	and	coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0)
  and qt_valor_p between coalesce(a.vl_minimo,0) and coalesce(a.vl_maximo,999);
	
BEGIN

    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
      cd_setor_atendimento_w		:= obter_setor_atendimento(nr_atendimento_p);
    end if;
		qt_idade_w		        := obter_idade_pf(cd_pessoa_fisica_p,clock_timestamp(),'A');
		qt_idade_dias_w		    	:= obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'DIA');
		qt_peso_gramas_w		:= (coalesce(obter_peso_pf(cd_pessoa_fisica_p),0) * 1000);

  for regras in c01 loop
    begin

    ie_retorno_w := 'S';

    select	nextval('gqa_pendencia_pac_seq')
    into STRICT	nr_sequencia_w
;

    insert into gqa_pendencia_pac(	nr_sequencia,
						    dt_atualizacao,
						    nm_usuario,
						    dt_atualizacao_nrec,
						    nm_usuario_nrec,
						    cd_pessoa_fisica,
						    nr_atendimento,
						    nr_seq_pend_regra)
					values (    nr_sequencia_w,
						    clock_timestamp(),
						    nm_usuario_p,
						    clock_timestamp(),
						    nm_usuario_p,
						    cd_pessoa_fisica_p,
						    nr_atendimento_p,
						    regras.nr_seq_regra);
					commit;
          
    CALL gqa_gerar_acao_regra(regras.nr_seq_regra,nr_sequencia_w,nr_atendimento_p,cd_pessoa_fisica_p,nm_usuario_p);
    end;
  end loop;

commit;

ie_atendeu_regra_p := ie_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_liberacao_calculo ( nr_seq_calculo_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_pessoa_fisica_p text DEFAULT NULL, qt_valor_p bigint DEFAULT NULL, ie_atendeu_regra_p INOUT text  DEFAULT NULL) FROM PUBLIC;

