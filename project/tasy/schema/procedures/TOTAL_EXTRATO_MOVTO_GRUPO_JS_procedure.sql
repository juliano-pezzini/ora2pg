-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE total_extrato_movto_grupo_js ( ie_consulta_p text, nr_seq_extrato_p bigint, nr_seq_extrato_arq_p bigint, vl_nao_conciliado_p INOUT text, vl_conciliado_p INOUT text, vl_total_p INOUT text, vl_bruto_p INOUT text, vl_liquido_p INOUT text) AS $body$
DECLARE


vl_nao_conciliado_w	bigint := 0;
vl_conciliado_w		bigint := 0;
vl_total_w		bigint := 0;
vl_bruto_w		bigint := 0;
vl_liquido_w		bigint := 0;
qt_nao_conciliado_w	bigint := 0;


BEGIN
if (ie_consulta_p = 'S') then
	begin
	select 	coalesce(sum(vl_saldo_concil_fin),0) vl_nao_conciliado,
		coalesce(sum(vl_parcela),0) - coalesce(sum(vl_saldo_concil_fin),0) vl_conciliado
	into STRICT	vl_nao_conciliado_w,
		vl_conciliado_w
	from   	extrato_cartao_cr_movto
	where  	nr_seq_extrato       = nr_seq_extrato_p
	and    	nr_seq_extrato_arq   = nr_seq_extrato_arq_p;
	end;
else
	select  coalesce(sum(CASE WHEN coalesce(nr_seq_extrato_parcela::text, '') = '' THEN 1  ELSE 0 END ),0),
		coalesce(sum(CASE WHEN coalesce(nr_seq_extrato_parcela::text, '') = '' THEN vl_parcela  ELSE 0 END ),0) vl_nao_conciliado,
		coalesce(sum(CASE WHEN coalesce(nr_seq_extrato_parcela::text, '') = '' THEN 0  ELSE vl_parcela END ),0) vl_conciliado
	into STRICT	qt_nao_conciliado_w,
		vl_nao_conciliado_w,
		vl_conciliado_w
        	from    extrato_cartao_cr_movto
       	where   nr_seq_extrato   = nr_seq_extrato_p
        	and    	nr_seq_extrato_arq   = nr_seq_extrato_arq_p;
end if;

select  coalesce(sum(vl_bruto),0) vl_bruto,
	coalesce(sum(vl_liquido),0) vl_liquido
into STRICT	vl_bruto_w,
	vl_liquido_w
from    extrato_cartao_cr_res
where   nr_seq_extrato   = nr_seq_extrato_p
and    	nr_seq_extrato_arq   = nr_seq_extrato_arq_p;

vl_nao_conciliado_p 	:= campo_mascara_virgula(vl_nao_conciliado_w);
vl_conciliado_p		:= campo_mascara_virgula(vl_conciliado_w);
vl_total_p		:= campo_mascara_virgula(vl_nao_conciliado_w + vl_conciliado_w);
vl_bruto_p		:= campo_mascara_virgula(vl_bruto_w);
vl_liquido_p		:= campo_mascara_virgula(vl_liquido_w);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE total_extrato_movto_grupo_js ( ie_consulta_p text, nr_seq_extrato_p bigint, nr_seq_extrato_arq_p bigint, vl_nao_conciliado_p INOUT text, vl_conciliado_p INOUT text, vl_total_p INOUT text, vl_bruto_p INOUT text, vl_liquido_p INOUT text) FROM PUBLIC;

