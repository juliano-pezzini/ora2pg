-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_ajuste_mat ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_setor_atendimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



cd_convenio_w			integer;
cd_plano_convenio_w		varchar(10);
cd_categoria_w			varchar(10);
cd_tipo_acomod_w			smallint;
ie_tipo_atendimento_w		smallint;
ie_glosa_w			varchar(01);
vl_retorno_w			double precision;
vl_retorno_ww			varchar(5);
ds_retorno_w			varchar(255)	:= '';
ie_autor_particular_w		varchar(1);
cd_convenio_glosa_ww		integer:= 0;
cd_categoria_glosa_ww		varchar(10):= ' ';
nr_seq_origem_w			bigint;
nr_seq_cobertura_w		bigint;
qt_dias_internacao_w		bigint;
nr_seq_lib_dieta_conv_w		bigint;
ie_clinica_w			integer;
cd_usuario_convenio_w		varchar(30);
nr_seq_classif_atend_w		atendimento_paciente.nr_seq_classificacao%type;


BEGIN

select	coalesce(max(obter_convenio_atendimento(nr_atendimento_p)),0),
	coalesce(max((obter_dados_atendimento(nr_atendimento_p, 'TA'))::numeric ),0),
	coalesce(max(obter_dados_categ_conv(nr_atendimento_p, 'P')),'0'),
	coalesce(max(obter_categoria_atendimento(nr_atendimento_p)),'0'),
	coalesce(max((obter_tipo_acomod_atend(nr_atendimento_p,'C'))::numeric ),0),
	coalesce(max((obter_dados_categ_conv(nr_atendimento_p,'OC'))::numeric ),0),
	coalesce(max((obter_dados_categ_conv(nr_atendimento_p,'COB'))::numeric ),0),
	coalesce(max((obter_dados_categ_conv(nr_atendimento_p,'LDC'))::numeric ),0),
	max(obter_dados_categ_conv(nr_atendimento_p,'U'))
into STRICT	cd_convenio_w,
	ie_tipo_atendimento_w,
	cd_plano_convenio_w,
	cd_categoria_w,
	cd_tipo_acomod_w,
	nr_seq_origem_w,
	nr_seq_cobertura_w,
	nr_seq_lib_dieta_conv_w,
	cd_usuario_convenio_w
;

select	coalesce(max(trunc(coalesce(dt_alta, clock_timestamp()) - dt_entrada)),0),
	max(ie_clinica),
	max(nr_seq_classificacao)
into STRICT	qt_dias_internacao_w,
	ie_clinica_w,
	nr_seq_classif_atend_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

SELECT * FROM obter_regra_ajuste_mat(cd_estabelecimento_p, 		--cd_estabelecimento_p	
		cd_convenio_w,                   --cd_convenio_p
		cd_categoria_w,                  --cd_categoria_p
		cd_material_p,                   --cd_material_p
		dt_atendimento_p,                --dt_vigencia_p
		coalesce(cd_tipo_acomod_w,0),         --cd_tipo_acomodacao_p
		coalesce(ie_tipo_atendimento_w,0),    --ie_tipo_atendimento_p
		coalesce(cd_setor_atendimento_p,0), 	--cd_setor_atendimento_p
		0,                               --qt_idade_p
		null,                            --nr_sequencia_p
		null,                            --cd_plano_p
		null,                            --cd_proc_referencia_p
		null,                            --ie_origem_proced_p
		null,                            --nr_seq_proc_interno_p
		null,                            --dt_entrada_p
		vl_retorno_w,                    --OUT tx_ajuste_p
		vl_retorno_w,                    --OUT vl_negociado_p
		vl_retorno_ww,                   --OUT ie_preco_informado_p
		ie_glosa_w,                      --OUT ie_glosa_p
		vl_retorno_w,                    --OUT tx_brasindice_pfb_p
		vl_retorno_w,                    --OUT tx_brasindice_pmc_p
		vl_retorno_w,                    --OUT tx_pmc_neg_p
		vl_retorno_w,                    --OUT tx_pmc_pos_p
		vl_retorno_w,                    --OUT tx_afaturar_p
		vl_retorno_w,                    --OUT tx_simpro_pfb_p
		vl_retorno_w,                    --OUT tx_simpro_pmc_p
		vl_retorno_ww,                   --OUT ie_origem_preco_p
 		vl_retorno_ww,                   --OUT ie_precedencia_p
		vl_retorno_w,                    --OUT pr_glosa_p
		vl_retorno_w,                    --OUT vl_glosa_p
		vl_retorno_w, 			--OUT cd_tabela_preco_p
		vl_retorno_w,                    --OUT cd_motivo_exc_conta_p
		vl_retorno_w,                    --OUT nr_seq_regra_p
		ie_autor_particular_w,           --OUT ie_autor_particular_p
		cd_convenio_glosa_ww,            --OUT cd_convenio_glosa_p
		cd_categoria_glosa_ww,           --OUT cd_categoria_glosa_p
		null,                            --ie_atend_retorno_p
		vl_retorno_w,                    --OUT tx_pfb_neg_p
		vl_retorno_w,                    --OUT tx_pfb_pos_p
		vl_retorno_ww,                   --OUT ie_ignora_preco_venda_p
		vl_retorno_w,                    --OUT tx_simpro_pos_pfb_p
		vl_retorno_w,                    --OUT tx_simpro_neg_pfb_p
		vl_retorno_w,                    --OUT tx_simpro_pos_pmc_p
		vl_retorno_w,                    --OUT tx_simpro_neg_pmc_p
		nr_seq_origem_w,                 --nr_seq_origem_p
		nr_seq_cobertura_w,              --nr_seq_cobertura_p
		qt_dias_internacao_w,            --qt_dias_internacao_p
		null,                            --nr_seq_regra_lanc_p
		nr_seq_lib_dieta_conv_w,         --nr_seq_lib_dieta_conv_p
		ie_clinica_w,                    --ie_clinica_p
		cd_usuario_convenio_w,           --cd_usuario_convenio_p
		nr_seq_classif_atend_w) INTO STRICT 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_ww, 
		ie_glosa_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_ww, 
 		vl_retorno_ww, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		ie_autor_particular_w, 
		cd_convenio_glosa_ww, 
		cd_categoria_glosa_ww, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_ww, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w, 
		vl_retorno_w;        --nr_seq_classif_atend_p
		

	if (ie_glosa_w	in ('G','T')) then
		ds_retorno_w	:= wheb_mensagem_pck.get_texto(313053);
	end if;

ds_erro_p	:= ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_ajuste_mat ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, cd_material_p bigint, dt_atendimento_p timestamp, cd_setor_atendimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

