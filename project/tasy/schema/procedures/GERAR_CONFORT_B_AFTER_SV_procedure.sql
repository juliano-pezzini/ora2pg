-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_confort_b_after_sv ( nr_seq_sv_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, qt_pontuacao_p bigint, ie_conciencia_p bigint, ie_agitacao_p bigint, ie_ventilacao_p bigint, ie_choro_p bigint, ie_fisico_p bigint, ie_tonus_p bigint, ie_tensao_p bigint, ie_liberacao_p text default 'N', nr_seq_analgesia_p bigint default null) AS $body$
DECLARE


 nr_sequencia_w 	 bigint := null;
 dt_liberacao_sv_w 	 timestamp := null;
 count_confort_b_w 	 smallint;
 qt_cftb_analgesia_w smallint;
 dt_liberacao_w 	 timestamp := null;


BEGIN  
  select count(*)
  into STRICT count_confort_b_w
  from escala_comfort_b
  where nr_seq_sv = nr_seq_sv_p;

  select count(1)
  into STRICT   qt_cftb_analgesia_w
  from escala_comfort_b
  where nr_seq_analgesia = nr_seq_analgesia_p;

  if (ie_liberacao_p = 'S') then
	dt_liberacao_w := clock_timestamp();
  end if;

  if count_confort_b_w > 0 then
	begin
    select dt_liberacao
    into STRICT dt_liberacao_sv_w
    from atendimento_sinal_vital
    where nr_sequencia = nr_seq_sv_p;

    if (coalesce(dt_liberacao_sv_w::text, '') = '') then
      update ESCALA_COMFORT_B
      set 
        dt_atualizacao = clock_timestamp(),
        ie_conciencia = ie_conciencia_p,  
        ie_ventilacao = ie_ventilacao_p,     
        ie_choro = ie_choro_p,     
        ie_tonus = ie_tonus_p,   
        ie_tensao = ie_tensao_p,   
        qt_pontuacao = qt_pontuacao_p, 
        ie_agitacao = ie_agitacao_p, 
        ie_fisico = ie_fisico  
      where nr_seq_sv = nr_seq_sv_p;
    end if;
	end;
  elsif (qt_cftb_analgesia_w > 0) then
	begin
	select dt_liberacao
    into STRICT dt_liberacao_sv_w
    from atend_aval_analgesia
    where nr_sequencia = nr_seq_analgesia_p;

    if (coalesce(dt_liberacao_sv_w::text, '') = '') then
      update escala_comfort_b
      set 
        dt_atualizacao = clock_timestamp(),
        ie_conciencia = ie_conciencia_p,  
        ie_ventilacao = ie_ventilacao_p,     
        ie_choro = ie_choro_p,     
        ie_tonus = ie_tonus_p,   
        ie_tensao = ie_tensao_p,   
        qt_pontuacao = qt_pontuacao_p, 
        ie_agitacao = ie_agitacao_p, 
        ie_fisico = ie_fisico  
      where nr_seq_analgesia = nr_seq_analgesia_p;
    end if;
	end;
  else
	begin
    select coalesce(max(nr_sequencia),0)+1
    into STRICT nr_sequencia_w
    from escala_comfort_b;

    insert into escala_comfort_b(
        nr_sequencia,    
        dt_atualizacao,   
        dt_atualizacao_nrec,               
        nm_usuario, 
        nm_usuario_nrec, 
        nr_atendimento,    
        ie_situacao,   
        dt_avaliacao,
		dt_liberacao,
        cd_profissional,  
        ie_conciencia,   
        ie_ventilacao,     
        ie_choro,     
        ie_tonus,   
        ie_tensao,   
        qt_pontuacao, 
        ie_agitacao, 
        ie_fisico,
        nr_seq_sv,
		nr_seq_analgesia
      ) values (
        nr_sequencia_w,   
        clock_timestamp(),        
        clock_timestamp(),   
        wheb_usuario_pck.get_nm_usuario, 
        wheb_usuario_pck.get_nm_usuario, 
        nr_atendimento_p,
        'A',  
        clock_timestamp(),
		dt_liberacao_w,
        cd_profissional_p,
        ie_conciencia_p,      
        ie_ventilacao_p,      
        ie_choro_p,     
        ie_tonus_p, 
        ie_tensao_p,     
        qt_pontuacao_p,
        ie_agitacao_p,    
        ie_fisico_p,
        nr_seq_sv_p,
		nr_seq_analgesia_p
      );
  end;
  end if;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_confort_b_after_sv ( nr_seq_sv_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, qt_pontuacao_p bigint, ie_conciencia_p bigint, ie_agitacao_p bigint, ie_ventilacao_p bigint, ie_choro_p bigint, ie_fisico_p bigint, ie_tonus_p bigint, ie_tensao_p bigint, ie_liberacao_p text default 'N', nr_seq_analgesia_p bigint default null) FROM PUBLIC;

