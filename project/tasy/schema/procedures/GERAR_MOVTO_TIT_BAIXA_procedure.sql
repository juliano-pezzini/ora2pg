-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_tit_baixa (nr_titulo_p bigint, nr_sequencia_p bigint, ie_opcao_p text, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


dt_recebimento_w			timestamp;
dt_baixa_w			timestamp;
vl_pago_w			double precision;
vl_recebido_w			double precision;
cd_tipo_baixa_w			integer;
cd_tipo_recebimento_w		integer;
cd_estabelecimento_w		integer;
ie_gerar_movto_bco_baixa_w	varchar(10);
nr_seq_trans_w			bigint;
nr_seq_conta_banco_w		bigint;
nr_seq_trans_desp_banco_w	bigint;
nr_seq_movto_trans_w		bigint;
nr_seq_trans_acres_banco_w	bigint;
vl_despesa_bancaria_w		double precision;
vl_acrescimo_w			double precision;
vl_total_recebido_w		double precision := 0;
cont_w				bigint;
ds_observacao_w			varchar(255);
cd_empresa_w			bigint;
nr_seq_cobr_escrit_w		bigint;
nr_seq_proj_rec_w		bigint;
ie_consiste_proj_rec_saldo_w	varchar(1);
ie_variacao_cambial_w		varchar(10);
ie_variacao_cambial_tf_w	varchar(10);
vl_cambial_ativo_w		double precision;
vl_cambial_passivo_w		double precision;
nr_seq_trans_var_ativo_w	bigint;
nr_seq_trans_var_passivo_w	bigint;
ie_doc_movto_trans_fin_w	varchar(1);
nr_documento_w			numeric(20);
nr_documento_ww			numeric(22);
nr_seq_baixa_origem_w		titulo_pagar_baixa.nr_seq_baixa_origem%type;
nr_seq_movto_trans_fin_w	titulo_pagar_baixa.nr_seq_movto_trans_fin%type;
ie_estorno_w			movto_trans_financ.ie_estorno%type;
/* Projeto Multimoeda - Variaveis */

vl_baixa_estrang_w		double precision;
vl_total_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
nr_seq_movto_bco_bx_orig_w	titulo_pagar_baixa.nr_seq_movto_trans_fin%type;	
ie_utiliza_trans_orig_w		varchar(1);
nr_seq_liq_origem_w		titulo_receber_liq.nr_seq_liq_origem%type;
ie_despesa_bancaria_w		varchar(1);
NR_SEQ_ESCRIT_W			TITULO_PAGAR_BAIXA.NR_SEQ_ESCRIT%type;


/*
ie_opcao_p
P - TITULO_PAGAR
R - TITULO_RECEBER
*/
BEGIN

if (ie_opcao_p = 'P') then
	select	c.cd_estabelecimento,
		a.dt_baixa,
		a.vl_pago,
		a.cd_tipo_baixa,
		c.ie_gerar_movto_bco_baixa,
		a.nr_seq_conta_banco,
		a.nr_seq_trans_fin,
		d.cd_empresa,
		b.nr_seq_proj_rec,
		c.ie_doc_movto_trans_fin,
		b.nr_documento,
		a.nr_seq_baixa_origem,
		a.vl_baixa_estrang,  -- Projeto Multimoeda - Busca os dados em moeda estrangeira
		a.vl_cotacao,
		a.cd_moeda,
		a.NR_SEQ_ESCRIT
	into STRICT	cd_estabelecimento_w,
		dt_baixa_w,
		vl_pago_w,
		cd_tipo_baixa_w,
		ie_gerar_movto_bco_baixa_w,
		nr_seq_conta_banco_w,
		nr_seq_trans_w,
		cd_empresa_w,
		nr_seq_proj_rec_w,
		ie_doc_movto_trans_fin_w,
		nr_documento_w,
		nr_seq_baixa_origem_w,
		vl_baixa_estrang_w,
		vl_cotacao_w,
		cd_moeda_w,
		NR_SEQ_ESCRIT_W
	from	estabelecimento d,
		parametros_contas_pagar c,
		titulo_pagar b,
		titulo_pagar_baixa a
	where	c.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_estabelecimento	= d.cd_estabelecimento
	and	a.nr_titulo			= b.nr_titulo
	and	a.nr_titulo			= nr_titulo_p
	and	a.nr_sequencia		= nr_sequencia_p;

	ie_consiste_proj_rec_saldo_w := obter_param_usuario(851, 119, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_proj_rec_saldo_w);

	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and (ie_gerar_movto_bco_baixa_w = 'S') then

		CALL consiste_movto_banco(nr_seq_conta_banco_w, dt_baixa_w);
		
		ie_utiliza_trans_orig_w := obter_param_usuario(855, 84, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_utiliza_trans_orig_w);
		/*Inicio OS 1286791 - Baixas por bordero que movimentam o banco por cheque, utilizam TF diferentes,  que podem possuir acao diferente no banco*/

		if (coalesce(ie_utiliza_trans_orig_w,'N') = 'S') then
			select	max(b.nr_seq_movto_trans_fin)
			into STRICT	nr_seq_movto_bco_bx_orig_w
			from	movto_trans_financ a,
					titulo_pagar_baixa b
			where	a.nr_sequencia	= b.nr_seq_movto_trans_fin
			and		b.nr_titulo		= nr_titulo_p	
			and		b.nr_sequencia	= nr_seq_baixa_origem_w;
		
			if (nr_seq_movto_bco_bx_orig_w IS NOT NULL AND nr_seq_movto_bco_bx_orig_w::text <> '') then
			
				select	max(nr_seq_trans_financ)
				into STRICT	nr_seq_trans_w
				from	movto_trans_financ
				where	nr_sequencia = nr_seq_movto_bco_bx_orig_w;
				
			end if;
		
		end if;
		/*Fim 1286791*/

		if (coalesce(nr_seq_trans_w,0) = 0) then

			select	coalesce(min(nr_sequencia), 0)
			into STRICT	nr_seq_trans_w
			from	transacao_financeira
			where	ie_acao 	= 2
			and	coalesce(ie_banco,'N') <> 'N'
			and (cd_estabelecimento	= cd_estabelecimento_w or coalesce(cd_estabelecimento::text, '') = '')
			and	cd_empresa		= cd_empresa_w
			and	coalesce(ie_situacao, 'A')	= 'A';

		end if;

		if (nr_seq_trans_w = 0) then
			--r.aise_application_error(-20011, 'Transacao de baixa de titulo a pagar nao cadastrada!');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(249038);
		end if;

		select	max(a.nr_seq_movto_trans_fin)
		into STRICT	nr_seq_movto_trans_fin_w
		from	titulo_pagar_baixa a
		where	a.nr_sequencia	= nr_seq_baixa_origem_w
		and	a.nr_titulo	= nr_titulo_p;

		if (nr_seq_movto_trans_fin_w IS NOT NULL AND nr_seq_movto_trans_fin_w::text <> '') then

			ie_estorno_w	:= 'E';

		else

			ie_estorno_w	:= null;

		end if;

		select	nextval('movto_trans_financ_seq')
		into STRICT	nr_seq_movto_trans_w
		;
		
		/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso negativo limpa as variaveis antes de gravar o movimento. */

		if (coalesce(vl_baixa_estrang_w,0) <> 0) then
			vl_complemento_w := vl_pago_w - vl_baixa_estrang_w;
		else
			vl_baixa_estrang_w	:= null;
			vl_complemento_w	:= null;
			vl_cotacao_w		:= null;
			cd_moeda_w		:= null;
		end if;

		insert into movto_trans_financ(NR_SEQUENCIA,
			DT_TRANSACAO,
			NR_SEQ_TRANS_FINANC,
			VL_TRANSACAO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			NR_SEQ_TITULO_PAGAR,
			dt_referencia_saldo,
			nr_seq_banco,
			cd_tipo_baixa_cpa,
			nr_lote_contabil,
			ie_conciliacao,
			nr_seq_proj_rec,
			nr_seq_movto_orig,
			ie_estorno,
			vl_transacao_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda,
			nr_documento)
		values (nr_seq_movto_trans_w,
			dt_baixa_w,
			nr_seq_trans_w,
			vl_pago_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_titulo_p,
			clock_timestamp(),
			nr_seq_conta_banco_w,
			cd_tipo_baixa_w,
			0,
			'N',
			nr_seq_proj_rec_w,
			nr_seq_movto_trans_fin_w,
			ie_estorno_w,
			vl_baixa_estrang_w,
			vl_complemento_w,
			vl_cotacao_w,
			cd_moeda_w,
			NR_SEQ_ESCRIT_W);
			
		if (ie_doc_movto_trans_fin_w = 'S') then
			update  movto_trans_financ
			set	nr_documento = nr_documento_w
			where	nr_sequencia = nr_seq_movto_trans_w;
		end if;
		
		-- AAMFIRMO OS545851 gravar na baixa de estorno o numero da movimentacao do banco.
		if (nr_seq_movto_trans_w IS NOT NULL AND nr_seq_movto_trans_w::text <> '') then
			update	titulo_pagar_baixa
			set	NR_SEQ_MOVTO_TRANS_FIN 	= nr_seq_movto_trans_w
			where 	nr_titulo		= nr_titulo_p	
			and	nr_sequencia		= nr_sequencia_p;	
		end if;

		CALL GERAR_TRANS_FINANC_TAXA(nr_seq_movto_trans_w, cd_estabelecimento_w, nm_usuario_p);

	end if;

	/* Francisco - 26/07/2008 - Gerar comunicacao tambem nas baixas */

	CALL gerar_comunic_trans_financ(nr_seq_movto_trans_w,nm_usuario_p,null,nr_titulo_p,nr_sequencia_p);
elsif (ie_opcao_p = 'R') then
	select	count(*)
	into STRICT	cont_w
	from	titulo_receber_liq
	where	nr_titulo		= nr_titulo_p
	and	nr_sequencia	= nr_sequencia_p;

	/* Francisco - OS 60119 - 18/06/07 If para nao dar no_data_found*/

	if (cont_w > 0) then
		select	c.cd_estabelecimento,
			c.ie_gerar_movto_bco_baixa,
			a.dt_recebimento,
			a.vl_recebido,
			a.cd_tipo_recebimento,
			a.nr_seq_conta_banco,
			a.nr_seq_trans_fin,
			coalesce(a.vl_despesa_bancaria,0),
			(coalesce(a.vl_juros,0) + coalesce(a.vl_rec_maior,0) + coalesce(a.vl_multa,0)),
			c.nr_seq_trans_desp_banco,
			c.nr_seq_trans_acres,
			a.ds_observacao,
			d.cd_empresa,
			a.nr_seq_cobranca,
			b.nr_seq_proj_rec,
			c.nr_seq_trans_var_ativo,
			c.nr_seq_trans_var_passivo,
			coalesce(a.vl_cambial_ativo,0),
			coalesce(a.vl_cambial_passivo,0),
			c.ie_doc_movto_trans_fin,
			b.nr_documento,
			a.vl_recebido_estrang,
			a.vl_cotacao,
			a.cd_moeda,
			a.nr_seq_liq_origem
		into STRICT	cd_estabelecimento_w,
			ie_gerar_movto_bco_baixa_w,
			dt_recebimento_w,
			vl_recebido_w,
			cd_tipo_recebimento_w,
			nr_seq_conta_banco_w,
			nr_seq_trans_w,
			vl_despesa_bancaria_w,
			vl_acrescimo_w,
			nr_seq_trans_desp_banco_w,
			nr_seq_trans_acres_banco_w,
			ds_observacao_w,
			cd_empresa_w,
			nr_seq_cobr_escrit_w,
			nr_seq_proj_rec_w,
			nr_seq_trans_var_ativo_w,
			nr_seq_trans_var_passivo_w,
			vl_cambial_ativo_w,
			vl_cambial_passivo_w,
			ie_doc_movto_trans_fin_w,
			nr_documento_ww,
			vl_baixa_estrang_w,
			vl_cotacao_w,
			cd_moeda_w,
			nr_seq_liq_origem_w
		from	estabelecimento d,
			parametro_contas_receber c,
			titulo_receber b,
			titulo_receber_liq a
		where	b.nr_titulo		= a.nr_titulo
		and	b.cd_estabelecimento	= d.cd_estabelecimento
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	a.nr_titulo		= nr_titulo_p
		and	a.nr_sequencia		= nr_sequencia_p
		and	coalesce(ie_lib_caixa, 'S') 	= 'S';

		if (nr_seq_cobr_escrit_w IS NOT NULL AND nr_seq_cobr_escrit_w::text <> '') then
			select	coalesce(max(dt_credito_bancario), dt_recebimento_w)
			into STRICT	dt_recebimento_w
			from	cobranca_escritural
			where	nr_sequencia	= nr_seq_cobr_escrit_w;
		end if;
		
		select	coalesce(max(ie_variacao_cambial),'N')
		into STRICT	ie_variacao_cambial_w
		from	parametro_controle_banc
		where	cd_estabelecimento	= cd_estabelecimento_w;

		select	coalesce(max(ie_variacao_cambial),'N')
		into STRICT	ie_variacao_cambial_tf_w
		from	transacao_financeira
		where	nr_sequencia		= nr_seq_trans_w;
		
		ie_consiste_proj_rec_saldo_w := obter_param_usuario(801, 105, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_proj_rec_saldo_w);
		ie_despesa_bancaria_w := obter_param_usuario(815, 35, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_despesa_bancaria_w);

		if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and (ie_gerar_movto_bco_baixa_w = 'S') then

			if (coalesce(nr_seq_trans_w,0) = 0) then
		
				select	coalesce(min(nr_sequencia), 0)
				into STRICT	nr_seq_trans_w
				from	transacao_financeira
				where	ie_acao 	= 1
				and	coalesce(ie_banco,'N') <> 'N'
				and (cd_estabelecimento	= cd_estabelecimento_w or coalesce(cd_estabelecimento::text, '') = '')
				and	cd_empresa		= cd_empresa_w
				and	coalesce(ie_situacao, 'A')	= 'A';

			end if;
			
			if (nr_seq_trans_w = 0) then
				--r.aise_application_error(-20011, 'Transacao de baixa de titulo a receber nao cadastrada!');
				CALL wheb_mensagem_pck.exibir_mensagem_abort(249039);
			end if;

			/* Francisco - OS 53209 - 22/03/07 - Gravar acrescimos na transacao principal se nao houver transacoes nos parametros */

			vl_total_recebido_w	:= vl_recebido_w;
			vl_total_estrang_w	:= vl_baixa_estrang_w;

			if (coalesce(nr_seq_trans_desp_banco_w::text, '') = '') then
				if (coalesce(ie_despesa_bancaria_w,'N') = 'S') then
					vl_total_recebido_w	:= vl_total_recebido_w + coalesce(vl_despesa_bancaria_w,0);
				end if;
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte a despesa bancaria para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := vl_total_estrang_w + (coalesce(vl_despesa_bancaria_w,0)/vl_cotacao_w);
				end if;
			end if;

			if (coalesce(nr_seq_trans_acres_banco_w::text, '') = '') then
				vl_total_recebido_w	:= vl_total_recebido_w + coalesce(vl_acrescimo_w,0);
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte o acrescimo para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := vl_total_estrang_w + (coalesce(vl_acrescimo_w,0)/vl_cotacao_w);
				end if;
			end if;

			/*lhalves OS378003 em 21/11/2011*/

			if (ie_variacao_cambial_w = 'S') and (ie_variacao_cambial_tf_w in ('P','A')) then
				select	CASE WHEN ie_variacao_cambial_tf_w='P' THEN coalesce(vl_cambial_passivo,0) WHEN ie_variacao_cambial_tf_w='A' THEN coalesce(vl_cambial_ativo,0) END
				into STRICT	vl_total_recebido_w
				from	titulo_receber_liq
				where	nr_titulo	= nr_titulo_p
				and	nr_sequencia	= nr_sequencia_p;
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte a variacao cambial para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := (coalesce(vl_total_recebido_w,0)/vl_cotacao_w);
				end if;
			end if;
			
			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_trans_w
			;
			
			/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso negativo limpa as variaveis antes de gravar o movimento. */

			if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
				vl_complemento_w := vl_total_recebido_w - vl_total_estrang_w;
			else
				vl_baixa_estrang_w	:= null;
				vl_total_estrang_w	:= null;
				vl_complemento_w	:= null;
				vl_cotacao_w		:= null;
				cd_moeda_w		:= null;
			end if;
			
			/*OS 2081559 - Inicio, quando for estorno, gravar no movimento bancario gerado no estorno a seq da transacao de origem da baixa, para fins de agrupamento na contabilizacao*/

			if (nr_seq_liq_origem_w IS NOT NULL AND nr_seq_liq_origem_w::text <> '') then
				select	max(nr_seq_movto_trans_fin)
				into STRICT	nr_seq_movto_trans_fin_w
				from	titulo_receber_liq a
				where	nr_titulo	= nr_titulo_p
				and	nr_sequencia	= nr_seq_liq_origem_w;
			end if;
			
			if (nr_seq_movto_trans_fin_w IS NOT NULL AND nr_seq_movto_trans_fin_w::text <> '') then
				ie_estorno_w	:= 'E';
			else
				ie_estorno_w	:= null;
			end if;
			/*OS 2081559  - fim*/

			insert into movto_trans_financ(NR_SEQUENCIA,
				DT_TRANSACAO,
				NR_SEQ_TRANS_FINANC,
				VL_TRANSACAO,
				DT_ATUALIZACAO,
				NM_USUARIO,
				NR_SEQ_TITULO_RECEBER,
				dt_referencia_saldo,
				nr_seq_banco,
				CD_TIPO_RECEBIMENTO,
				nr_lote_contabil,
				ie_conciliacao,
				ds_historico,
				nr_seq_cobr_escrit,
				nr_seq_proj_rec,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda,
				nr_seq_movto_orig,
				ie_estorno)
			values (nr_seq_movto_trans_w,
				dt_recebimento_w,
				nr_seq_trans_w,
				vl_total_recebido_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_titulo_p,
				clock_timestamp(),
				nr_seq_conta_banco_w,
				cd_tipo_recebimento_w,
				0,
				'N',
				ds_observacao_w,
				nr_seq_cobr_escrit_w,
				nr_seq_proj_rec_w,
				vl_total_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_w,
				nr_seq_movto_trans_fin_w,
				ie_estorno_w);
				
				if (ie_doc_movto_trans_fin_w = 'S') then
					update  movto_trans_financ
					set	nr_documento = nr_documento_ww
					where	nr_sequencia = nr_seq_movto_trans_w;
				end if;
				
			if (nr_seq_movto_trans_w IS NOT NULL AND nr_seq_movto_trans_w::text <> '') then --AAMFIRMO OS 639003 - Gravar a sequencia do movimento no banco na baixa gerada no titulo.
			
				update	titulo_receber_liq
				set	NR_SEQ_MOVTO_TRANS_FIN 	= nr_seq_movto_trans_w
				where 	nr_titulo		= nr_titulo_p	
				and	nr_sequencia		= nr_sequencia_p;
				
			end if;	
			
			if (vl_despesa_bancaria_w <> 0) and (nr_seq_trans_desp_banco_w IS NOT NULL AND nr_seq_trans_desp_banco_w::text <> '') then
				
				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_seq_movto_trans_w
				;
				
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte a despesa bancaria para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := (coalesce(vl_despesa_bancaria_w,0)/vl_cotacao_w);
					vl_complemento_w := vl_despesa_bancaria_w - vl_total_estrang_w;
				end if;
				
				insert into movto_trans_financ(NR_SEQUENCIA,
					DT_TRANSACAO,
					NR_SEQ_TRANS_FINANC,
					VL_TRANSACAO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					NR_SEQ_TITULO_RECEBER,
					dt_referencia_saldo,
					nr_seq_banco,
					CD_TIPO_RECEBIMENTO,
					nr_lote_contabil,
					ie_conciliacao,
					nr_seq_cobr_escrit,
					nr_seq_proj_rec,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda)
				values (nr_seq_movto_trans_w,
					dt_recebimento_w,
					nr_seq_trans_desp_banco_w,
					vl_despesa_bancaria_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_titulo_p,
					clock_timestamp(),
					nr_seq_conta_banco_w,
					cd_tipo_recebimento_w,
					0,
					'N',
					nr_seq_cobr_escrit_w,
					nr_seq_proj_rec_w,
					vl_total_estrang_w,
					vl_complemento_w,
					vl_cotacao_w,
					cd_moeda_w);
					
					if (ie_doc_movto_trans_fin_w = 'S') then
						update  movto_trans_financ
						set	nr_documento = nr_documento_ww
						where	nr_sequencia = nr_seq_movto_trans_w;
					end if;
			end if;
		
			if (vl_acrescimo_w <> 0) and (nr_seq_trans_acres_banco_w IS NOT NULL AND nr_seq_trans_acres_banco_w::text <> '') then
				
				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_seq_movto_trans_w
				;
				
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte o acrescimo para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := (coalesce(vl_acrescimo_w,0)/vl_cotacao_w);
					vl_complemento_w := vl_acrescimo_w - vl_total_estrang_w;
				end if;
			
				insert into movto_trans_financ(NR_SEQUENCIA,
					DT_TRANSACAO,
					NR_SEQ_TRANS_FINANC,
					VL_TRANSACAO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					NR_SEQ_TITULO_RECEBER,
					dt_referencia_saldo,
					nr_seq_banco,
					CD_TIPO_RECEBIMENTO,
					nr_lote_contabil,
					ie_conciliacao,
					nr_seq_cobr_escrit,
					nr_seq_proj_rec,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda)
				values (nr_seq_movto_trans_w,
					dt_recebimento_w,
					nr_seq_trans_acres_banco_w,
					vl_acrescimo_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_titulo_p,
					clock_timestamp(),
					nr_seq_conta_banco_w,
					cd_tipo_recebimento_w,
					0,
					'N',
					nr_seq_cobr_escrit_w,
					nr_seq_proj_rec_w,
					vl_total_estrang_w,
					vl_complemento_w,
					vl_cotacao_w,
					cd_moeda_w);
					
					if (ie_doc_movto_trans_fin_w = 'S') then
						update  movto_trans_financ
						set	nr_documento = nr_documento_ww
						where	nr_sequencia = nr_seq_movto_trans_w;
					end if;
			end if;

			if (vl_cambial_ativo_w <> 0) and	/* ahoffelder - OS 400095 - 17/01/2012 */
				(nr_seq_trans_var_ativo_w IS NOT NULL AND nr_seq_trans_var_ativo_w::text <> '') and (ie_variacao_cambial_w <> 'S') then
				
				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_seq_movto_trans_w
				;
				
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte a variacao cambial para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := (coalesce(vl_cambial_ativo_w,0)/vl_cotacao_w);
					vl_complemento_w := vl_cambial_ativo_w - vl_total_estrang_w;
				end if;

				insert into movto_trans_financ(NR_SEQUENCIA,
					DT_TRANSACAO,
					NR_SEQ_TRANS_FINANC,
					VL_TRANSACAO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					NR_SEQ_TITULO_RECEBER,
					dt_referencia_saldo,
					nr_seq_banco,
					CD_TIPO_RECEBIMENTO,
					nr_lote_contabil,
					ie_conciliacao,
					nr_seq_cobr_escrit,
					nr_seq_proj_rec,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda)
				values (nr_seq_movto_trans_w,
					dt_recebimento_w,
					nr_seq_trans_var_ativo_w,
					vl_cambial_ativo_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_titulo_p,
					clock_timestamp(),
					nr_seq_conta_banco_w,
					cd_tipo_recebimento_w,
					0,
					'N',
					nr_seq_cobr_escrit_w,
					nr_seq_proj_rec_w,
					vl_total_estrang_w,
					vl_complemento_w,
					vl_cotacao_w,
					cd_moeda_w);
					
					if (ie_doc_movto_trans_fin_w = 'S') then
						update  movto_trans_financ
						set	nr_documento = nr_documento_ww
						where	nr_sequencia = nr_seq_movto_trans_w;
					end if;

			end if;

			if (vl_cambial_passivo_w <> 0) and	/* ahoffelder - OS 400095 - 17/01/2012 */
				(nr_seq_trans_var_passivo_w IS NOT NULL AND nr_seq_trans_var_passivo_w::text <> '') and (ie_variacao_cambial_w <> 'S') then

				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_seq_movto_trans_w
				;
				
				/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo converte a variacao cambial para moeda estrangeira.*/

				if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
					vl_total_estrang_w := (coalesce(vl_cambial_passivo_w,0)/vl_cotacao_w);
					vl_complemento_w := vl_cambial_passivo_w - vl_total_estrang_w;
				end if;
					
				insert into movto_trans_financ(NR_SEQUENCIA,
					DT_TRANSACAO,
					NR_SEQ_TRANS_FINANC,
					VL_TRANSACAO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					NR_SEQ_TITULO_RECEBER,
					dt_referencia_saldo,
					nr_seq_banco,
					CD_TIPO_RECEBIMENTO,
					nr_lote_contabil,
					ie_conciliacao,
					nr_seq_cobr_escrit,
					nr_seq_proj_rec,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda)
				values (nr_seq_movto_trans_w,
					dt_recebimento_w,
					nr_seq_trans_var_passivo_w,
					vl_cambial_passivo_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_titulo_p,
					clock_timestamp(),
					nr_seq_conta_banco_w,
					cd_tipo_recebimento_w,
					0,
					'N',
					nr_seq_cobr_escrit_w,
					nr_seq_proj_rec_w,
					vl_total_estrang_w,
					vl_complemento_w,
					vl_cotacao_w,
					cd_moeda_w);
					
					if (ie_doc_movto_trans_fin_w = 'S') then
						update  movto_trans_financ
						set	nr_documento = nr_documento_ww
						where	nr_sequencia = nr_seq_movto_trans_w;
					end if;

			end if;

		end if;

		/* Francisco - 26/07/2008 - Gerar comunicacao tambem nas baixas */

		CALL gerar_comunic_trans_financ(nr_seq_movto_trans_w,nm_usuario_p,nr_titulo_p,null,nr_sequencia_p);
	end if;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_tit_baixa (nr_titulo_p bigint, nr_sequencia_p bigint, ie_opcao_p text, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

