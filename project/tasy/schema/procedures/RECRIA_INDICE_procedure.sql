-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recria_indice ( nm_indice_p text, qt_registros_p bigint) AS $body$
DECLARE

nm_objeto_w            		varchar(32)      := null;
ie_tipo_objeto_w       		varchar(32)      := null;
c001				  	integer;
ds_comando_w                  varchar(2000);
vl_retorno_w			varchar(255);
nm_tabela_w	                  varchar(50);
nm_tablespace_w	            varchar(50);
nm_atributo_w	            varchar(50);
nm_indice_w	            	varchar(50);
ie_tipo_atributo_w	      varchar(10);
qt_registros_w                double precision;
qt_initial_w                  bigint;
qt_next_w                     bigint;
qt_bytes_w	                  bigint;
qt_tamanho_w                  bigint;
ie_tipo_calculo_w             varchar(1);

C010 CURSOR FOR
SELECT a.nm_atributo, a.ie_tipo_atributo, a.qt_tamanho
FROM indice_atributo b, tabela_atributo a
where a.nm_tabela    = b.nm_tabela
  and a.nm_atributo  = b.nm_atributo
  and a.nm_tabela    = nm_tabela_w
  and b.nm_indice    = nm_indice_w
order by b.nr_sequencia;



BEGIN

nm_indice_w   := upper(nm_indice_p);
begin
select nm_tabela
into STRICT nm_tabela_w
from indice
where nm_indice = nm_indice_w;
exception
	when others then
		nm_tabela_w := 'N';
end;

select 	obter_tablespace_index(nm_indice_p)
into STRICT	nm_tablespace_w
;

if (nm_tabela_w <> 'N') then
	begin
	select 	qt_registros_previsto,
			ie_tipo_calculo
	into STRICT qt_registros_w,
           ie_tipo_calculo_w
	from tabela_sistema
	where nm_tabela = nm_tabela_w;

---- Drop Indice -----
	ds_comando_w := 'DROP INDEX ' || nm_indice_w;
	vl_retorno_w := Obter_Valor_Dinamico(ds_comando_w, vl_retorno_w);

---- Cria Indice -----
	if (qt_registros_p > 0) then
		qt_registros_w	:= qt_registros_p;
	end if;
	if (qt_registros_p < 0) or
		(qt_registros_p = 0 AND ie_tipo_calculo_w = 'R') then
		begin
		ds_comando_w := 'select count(*) from ' || nm_tabela_w;
		qt_registros_w := obter_valor_dinamico(ds_comando_w, qt_registros_w);
		end;
	end if;

	qt_bytes_w	 := 0;
	ds_comando_w := 'CREATE INDEX ' || nm_indice_w;
	ds_comando_w := ds_comando_w || ' on ' || nm_tabela_w || '(';
	OPEN C010;
	LOOP
	FETCH C010 INTO 	nm_atributo_w,
				ie_tipo_atributo_w,
				qt_tamanho_w;
	EXIT WHEN NOT FOUND; /* apply on C010 */
		begin
		if  	qt_bytes_w > 0 then
			ds_comando_w := ds_comando_w || ', ';
		end if;
		ds_comando_w := ds_comando_w || nm_atributo_w;
		if  	ie_tipo_atributo_w = 'DATE' then
			qt_bytes_w 	:= qt_bytes_w + 5;
		end if;
		if  	ie_tipo_atributo_w = 'NUMBER' then
			qt_bytes_w 	:= qt_bytes_w + qt_tamanho_w;
		end if;
		if  	ie_tipo_atributo_w = 'VARCHAR2' or
			ie_tipo_atributo_w = 'LONG' then
			qt_bytes_w 	:= trunc(qt_bytes_w + qt_tamanho_w / 2) + 1;
		end if;
		end;
	END LOOP;
	CLOSE C010;

	qt_initial_w := trunc(qt_registros_w * qt_bytes_w / 1024 * 1.3);
	qt_next_w  	 := trunc(qt_initial_w *.4);

	ds_comando_w := ds_comando_w || ') STORAGE(INITIAL ' || QT_INITIAL_W || 'K';
	ds_comando_w := ds_comando_w || ' NEXT ' || QT_NEXT_W || 'K';
	ds_comando_w := ds_comando_w || ' PCTINCREASE 20)';
	ds_comando_w := ds_comando_w || ' PCTFREE 10';
	ds_comando_w := ds_comando_w || ' Tablespace ' || nm_tablespace_w;
	vl_retorno_w := Obter_Valor_Dinamico(ds_comando_w, vl_retorno_w);
	/*insert into Logxxxxxxx_Tasy values (sysdate, 'Tasy', 2, ds_comando_w);
	commit;*/
	end;
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recria_indice ( nm_indice_p text, qt_registros_p bigint) FROM PUBLIC;

