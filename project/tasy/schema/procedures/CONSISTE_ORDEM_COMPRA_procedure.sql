-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_ordem_compra (nr_ordem_p text, ie_consiste_vl_minimo_p text, nm_usuario_p text, ds_erro_p INOUT text, ds_alerta_p INOUT text) AS $body$
DECLARE


cd_perfil_w				bigint;
ie_dia_util_ent_urgente_w			varchar(1);
qt_dias_util_w				integer;
dt_inicial_w				timestamp;
dt_final_w				timestamp;
nr_item_oci_w				integer;
qt_material_w				double precision;
vl_unitario_material_w			ordem_compra_item.vl_unitario_material%type;
vl_total_material_w			ordem_compra_item.vl_unitario_material%type;
qt_material_entrega_w			double precision;
ds_erro_w				varchar(2000);
ds_alerta_w				varchar(2000);
ds_erro_ww				varchar(2000) := null;
cd_item_erro_w				varchar(255) := null;
ds_erro_ccusto_w				varchar(255) := null;
qt_item_compra_w				bigint;
qt_item_zerado_w				smallint := 0;
vl_total_ordem_w				double precision;
vl_total_venc_w				double precision;
cd_material_w				integer;
ds_material_w				varchar(255);
cd_centro_custo_w				integer;
cd_local_estoque_w			smallint;
ie_aprovacao_ext_w			varchar(255);
qt_inativo_w				integer;
qt_condicao_inativo_w			smallint;
qt_reg_w					bigint;
cd_conta_contabil_w			varchar(20);
vl_minimo_nf_w				double precision;
qt_validade_vencida_w			integer;
cd_estabelecimento_w			smallint;
ie_consiste_validade_anvisa_w		varchar(1);
ie_consiste_valid_marca_mat_w		varchar(1);
ds_erro_validade_w				varchar(2000);
qt_dia_entrega_urgente_w			integer;
qt_entrega_w				integer;
nr_seq_marca_w				bigint;
dt_validade_anvisa_marca_w			timestamp;
nr_seq_subgrupo_compra_w			bigint;
ie_liberado_w				varchar(1);
ie_consiste_subgrupo_compras_w		varchar(1);
ie_consiste_regra_w			varchar(1) := 'N';
ie_consiste_revisao_w			varchar(15);
ie_consiste_fornec_adiant_w			varchar(15);
ie_marcar_urgente_oc_w			varchar(1);
ie_forma_revisao_w				varchar(15);
nr_seq_licitacao_w				bigint;
nr_seq_reg_lic_item_w			bigint;
cd_cgc_fornecedor_w			varchar(14);
cd_centro_custo_ordem_w			integer;
cd_local_entrega_ordem_w			smallint;
ie_tipo_local_w				varchar(5);
Consiste_CCusto_Local_Direto_w 		varchar(1) := 'N';
Restringe_CCusto_Regra_w			varchar(1) := 'N';
Consiste_CCusto_Ordem_Item_w		varchar(1) := 'N';
ie_tipo_ordem_w				varchar(15);
qt_existe_regra_cc_usuario_w		smallint;
nr_seq_reg_preco_w			bigint;
ie_vigente_w				varchar(1);
qt_existe_w				bigint;
qt_forn_adiant_aberto_w			bigint;
ie_consiste_saldo_disp_atend_w		varchar(1) := 'N';
cd_estab_transf_w				smallint;
cd_local_transf_w				smallint;
qt_estoque_disp_atend_w			double precision;
cd_unidade_medida_compra_w		varchar(30);
qt_material_estoque_w			double precision;
ie_consiste_doc_vencido_w			varchar(1);
pr_juros_negociado_w			double precision;
ie_juros_negociado_oc_w			varchar(1);
ie_qualificado_w				varchar(15) := 'S';
dt_lib_estrut_pj_w				timestamp := null;
cd_setor_atendimento_w			integer;
ie_centro_custo_ordem_w			varchar(15);
ie_momento_consiste_garantia_w		varchar(1);
cd_grupo_consiste_garantia_w		varchar(100);
dt_inicio_garantia_w			timestamp;
dt_fim_garantia_w				timestamp;
qt_dias_garantia_w				integer;
qt_grupo_garantia_w			bigint;
ie_permite_valor_zerado_w			varchar(1);
ie_consiste_dt_entrega_dif_w			varchar(1);
qt_entrega_dif_w				smallint := 0;
ie_urgente_w				varchar(1);
ie_consiste_ccusto_sem_aprov_w		varchar(1);
ie_exige_marca_w				varchar(1);
ie_exige_fabric_w				varchar(1);
qt_existe_exigencia_regra_w			bigint;
ie_exige_ca_w				varchar(1);
ie_exige_anvisa_w				varchar(1);
ie_exige_tipo_compra_w			varchar(1);
nr_seq_tipo_compra_w			bigint;
cd_conta_contabil_ww			varchar(20);
ie_consiste_conta_cont_vazia_w		varchar(1);
cd_pessoa_fisica_w			varchar(10);
ie_fornec_liberado_w			varchar(1);
nr_contrato_w				bigint;
vl_saldo_contrato_w			double precision;
vl_total_contrato_w				double precision;
vl_saldo_format_w				varchar(35);
cd_cgc_fabricante_w			varchar(14);
ie_consiste_doc_venc_fabric_w		varchar(1);
ie_servico_realizado_w			varchar(15);
ie_orcado_w				varchar(1);
ie_consiste_orcado_w			varchar(1);
ie_perm_consist_contrato_w			varchar(1);
ie_material_projeto_w			varchar(1);
ie_qtd_vl_projeto_w				varchar(1);
ie_mat_proj_rec_w				varchar(1);
qt_mat_proj_rec_w				bigint;
vl_mat_proj_rec_w				double precision;
cd_material_ordem_w			bigint;
qt_material_ordem_w			bigint;
vl_material_ordem_w			double precision;
cd_moeda_w				integer;
ie_exige_conv_oc_w			varchar(1);
vl_conv_moeda_w				double precision;
ie_consiste_regra_mat_w			varchar(1);
ie_consiste_permissao_mat_w			varchar(1);
ie_consiste_permissao_compra_w		varchar(15);
cd_classe_material_w			bigint;
ds_retorno_consistencia_w			varchar(2000);
nr_item_solic_compra_w			ordem_compra_item.nr_seq_lic_item%type;
nr_solic_compra_ww			ordem_compra_item.nr_solic_compra%type;
ie_exige_anexo_w			varchar(1) := 'N';
nr_seq_proj_rec_w		projeto_recurso.nr_sequencia%type;
vl_inicio_projeto_w		projeto_recurso.vl_inicio_projeto%type;
vl_total_ordem_acum_w		ordem_compra_item.vl_unitario_material%type;
vl_total_ordem_ww		ordem_compra_item.vl_unitario_material%type;
ie_consiste_saldo_proj_w	varchar(15);
qt_mat_solic_w			double precision;
qt_mat_ordens_w			double precision;
nr_ordem_liberada_w		ordem_compra.nr_ordem_compra%type;
ds_material_item_w		material.ds_material%type;
nr_item_oci_lib_w			ordem_compra_item.nr_item_oci%type;
ie_consiste_qt_solic_w		varchar(1) := 'N';
ie_vigente_anvisa_w  		material_estab.ie_vigente_anvisa%type;
ie_consiste_saldo_contrato_w	varchar(1) := 'S';
nr_seq_regra_contrato_w		ordem_compra_item.nr_seq_regra_contrato%type;
qt_material_fixa_w		contrato_regra_nf.qt_material_fixa%type;
qt_acumulado_oc_contrato_w	ordem_compra_item.qt_material%type;
ie_permite_varios_proj_rec_w	varchar(1) := 'S';
ie_consiste_qt_rateio_w 	varchar(15);
ie_consiste_vl_rateio_w		varchar(15);
qt_rateio_w			ordem_compra_item_rateio.qt_rateio%type;
vl_rateio_w			ordem_compra_item_rateio.vl_rateio%type;
ie_vigente_anvisa_marca_w	material_marca.ie_vigente_anvisa%type;
qt_proj_rec_w			bigint;
nr_cot_compra_w			cot_compra.nr_cot_compra%type;
nr_item_cot_compra_w		cot_compra_item.nr_item_cot_compra%type;
ie_considera_local_ordem_w	parametro_compras.ie_considera_local_ordem%type;
ie_local_w			loc_estoque_estrut_materiais.ie_liberar%type;
ie_consiste_oc_sem_anexo_w	varchar(1) := 'S';
qt_entrega_cancelada_w ordem_compra_item_entrega.qt_prevista_entrega%type;
nr_contrato_oci_w 		ordem_compra_item.nr_contrato%type;
qt_total_material_oc_w		ordem_compra_item.qt_material%type;
ie_consiste_avaliacao_oc_w	varchar(1);
qt_consiste_avaliacao_w		smallint;
cd_estab_ativo_w		estabelecimento.cd_estabelecimento%type := obter_estabelecimento_ativo;
vl_max_purchase_w	rule_regulated_price.vl_max_purchase%type;
is_regulated_price_w	varchar(1);


c01 CURSOR FOR
SELECT	coalesce(a.cd_centro_custo,0) cd_centro_custo,
	coalesce(a.cd_local_estoque,0) cd_local_estoque,
	b.cd_material,
	b.ds_material,
	a.nr_item_oci,
	a.qt_material,
	a.vl_unitario_material,
	a.nr_seq_marca,
	a.nr_seq_reg_lic_item,
	a.cd_unidade_medida_compra,
	a.dt_lib_estrut_pj,
	a.dt_inicio_garantia,
	a.dt_fim_garantia,
	a.qt_dias_garantia,
	a.cd_conta_contabil,
	a.nr_seq_marca cd_cgc_fabricante,
	a.ie_servico_realizado,
	b.cd_classe_material,
	a.nr_seq_regra_contrato,
	a.nr_contrato
from	material b,
	ordem_compra_item a
where	a.cd_material = b.cd_material
and	a.nr_ordem_compra = nr_ordem_p;

c02 CURSOR FOR
SELECT	distinct
	lic_obter_registro_preco(a.nr_seq_licitacao, a.nr_seq_lic_item)
from	reg_lic_item_solic a
where	a.nr_solic_compra = nr_solic_compra_ww
and	a.nr_item_solic_compra = nr_item_solic_compra_w
and	(lic_obter_registro_preco(a.nr_seq_licitacao, a.nr_seq_lic_item) IS NOT NULL AND (lic_obter_registro_preco(a.nr_seq_licitacao, a.nr_seq_lic_item))::text <> '');

C03 CURSOR FOR
SELECT	cd_material,
	qt_material,
	vl_unitario_material,
	obter_se_item_proj_recurso(nr_seq_proj_rec,cd_material) ie_mat_proj_rec,
	obter_dados_item_proj_recurso(nr_seq_proj_rec,cd_material,'Q') qt_mat_proj_rec,
	obter_dados_item_proj_recurso(nr_seq_proj_rec,cd_material,'V') vl_mat_proj_rec
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_p
and	(nr_seq_proj_rec IS NOT NULL AND nr_seq_proj_rec::text <> '');

c04 CURSOR FOR
SELECT	nr_item_solic_compra,
	nr_solic_compra,
	substr(obter_desc_material(cd_material),1,255) ds_material,
	nr_item_oci,
	nr_cot_compra,
	nr_item_cot_compra
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_p;	

BEGIN

select	count(1)
into STRICT	qt_item_compra_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_p;

cd_perfil_w	:= obter_perfil_ativo;

select	coalesce(sum(obter_valor_liquido_ordem(nr_ordem_compra)),0),
	max(cd_estabelecimento),
	coalesce(max(nr_seq_subgrupo_compra),0),
	max(ie_tipo_ordem),
	max(cd_local_entrega),
	max(cd_centro_custo),
	max(cd_setor_atendimento),
	coalesce(max(cd_pessoa_fisica),0),
	coalesce(max(cd_cgc_fornecedor),0),
	coalesce(max(pr_juros_negociado),0),
	coalesce(max(ie_urgente),'N'),
	coalesce(max(nr_seq_tipo_compra),0),
	coalesce(max(ie_orcado),'N'),
	coalesce(max(cd_moeda),0),
	coalesce(max(vl_conv_moeda),0)
into STRICT	vl_total_ordem_w,
	cd_estabelecimento_w,
	nr_seq_subgrupo_compra_w,
	ie_tipo_ordem_w,
	cd_local_entrega_ordem_w,
	cd_centro_custo_ordem_w,
	cd_setor_atendimento_w,
	cd_pessoa_fisica_w,
	cd_cgc_fornecedor_w,
	pr_juros_negociado_w,
	ie_urgente_w,
	nr_seq_tipo_compra_w,
	ie_orcado_w,
	cd_moeda_w,
	vl_conv_moeda_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_p;

ie_permite_valor_zerado_w	:= Obter_Valor_Param_Usuario(917, 124, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_dt_entrega_dif_w	:= Obter_Valor_Param_Usuario(917, 125, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_conta_cont_vazia_w	:= Obter_Valor_Param_Usuario(917, 157, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_orcado_w		:= Obter_Valor_Param_Usuario(917, 192, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_perm_consist_contrato_w	:= coalesce(Obter_Valor_Param_Usuario(917, 154, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'S');
ie_material_projeto_w		:= Obter_Valor_Param_Usuario(917, 200, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_qtd_vl_projeto_w		:= Obter_Valor_Param_Usuario(917, 201, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_regra_mat_w		:= Obter_Valor_Param_Usuario(917, 211, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_permissao_compra_w	:= Obter_Valor_Param_Usuario(917, 212, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_saldo_proj_w	:= Obter_Valor_Param_Usuario(917, 229, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_qt_solic_w		:= Obter_Valor_Param_Usuario(917, 230, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_saldo_contrato_w	:= Obter_Valor_Param_Usuario(917, 233, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_permite_varios_proj_rec_w    := Obter_Valor_Param_Usuario(917, 232, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_qt_rateio_w 	:= Obter_Valor_Param_Usuario(917, 234, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_vl_rateio_w		:= Obter_Valor_Param_Usuario(917, 235, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
ie_consiste_oc_sem_anexo_w	:= coalesce(Obter_Valor_Param_Usuario(917, 239, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'S');
ie_consiste_avaliacao_oc_w	:= Obter_Valor_Param_Usuario(917, 242, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);

if (coalesce(ie_permite_valor_zerado_w,'S') = 'N') then
	select	count(1)
	into STRICT	qt_item_zerado_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_p
	and	vl_unitario_material = 0;
end if;

if (coalesce(ie_consiste_dt_entrega_dif_w,'N') = 'S') then
	select	count(1)
	into STRICT	qt_entrega_dif_w
	from (SELECT	dt_prevista_entrega qt_entrega_dif
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_p
		and	coalesce(dt_cancelamento::text, '') = ''
		group by dt_prevista_entrega) alias4;
end if;

select	coalesce(sum(vl_vencimento),0) vl_total_venc_w
into STRICT	vl_total_venc_w
from	ordem_compra_venc
where	nr_ordem_compra = nr_ordem_p;

if (ie_tipo_ordem_w <> 'T') then
	begin
	select (max(Obter_Valor_Param_Usuario(917, 73, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		(max(Obter_Valor_Param_Usuario(917, 75, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		(max(Obter_Valor_Param_Usuario(917, 79, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		(max(Obter_Valor_Param_Usuario(917, 91, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		(max(Obter_Valor_Param_Usuario(917, 93, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		(max(Obter_Valor_Param_Usuario(917, 50, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),
		coalesce(max(Obter_Valor_Param_Usuario(917, 123, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'A'),
		coalesce(max(Obter_Valor_Param_Usuario(917, 98, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'0'),
		coalesce(max(Obter_Valor_Param_Usuario(917, 137, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
		coalesce(max(Obter_Valor_Param_Usuario(917, 185, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N')		
	into STRICT	ie_consiste_subgrupo_compras_w,
		ie_consiste_regra_w,
		ie_consiste_revisao_w,
		ie_consiste_fornec_adiant_w,
		ie_marcar_urgente_oc_w,
		ie_consiste_doc_vencido_w,
		ie_momento_consiste_garantia_w,
		cd_grupo_consiste_garantia_w,
		ie_consiste_ccusto_sem_aprov_w,
		ie_consiste_doc_venc_fabric_w
	;
	end;
else
	begin
	Consiste_CCusto_Local_Direto_w 	:= 	Obter_Valor_Param_Usuario(146, 42, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	Restringe_CCusto_Regra_w 	:=	Obter_Valor_Param_Usuario(146, 43, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	Consiste_CCusto_Ordem_Item_w 	:=	Obter_Valor_Param_Usuario(146, 44, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	ie_consiste_saldo_disp_atend_w	:= 	Obter_Valor_Param_Usuario(146, 71, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w);
	
	if (ie_consiste_saldo_disp_atend_w = 'S') then
		begin
		select	cd_estab_transf,
			cd_local_transf
		into STRICT	cd_estab_transf_w,
			cd_local_transf_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_p;
		end;
	end if;
	end;
end if;

select	count(distinct coalesce(nr_seq_proj_rec,0))
into STRICT	qt_proj_rec_w
from   ordem_compra_item
where  nr_ordem_compra = nr_ordem_p;

if (ie_permite_varios_proj_rec_w = 'N') and (qt_proj_rec_w > 1) then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(445567) || chr(13) || chr(10),1,2000);
	
end if;

select	coalesce(ie_consiste_validade_anvisa,'N'),
	coalesce(ie_consiste_validade_marca_mat,'N'),
	qt_dia_entrega_urgente,
	coalesce(ie_juros_negociado_oc,'N'),
	coalesce(ie_considera_local_ordem,'N')
into STRICT	ie_consiste_validade_anvisa_w,
	ie_consiste_valid_marca_mat_w,
	qt_dia_entrega_urgente_w,
	ie_juros_negociado_oc_w,
	ie_considera_local_ordem_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

open c01;
loop
fetch c01 into
	cd_centro_custo_w,
	cd_local_estoque_w,
	cd_material_w,
	ds_material_w,
	nr_item_oci_w,
	qt_material_w,
	vl_unitario_material_w,
	nr_seq_marca_w,
	nr_seq_reg_lic_item_w,
	cd_unidade_medida_compra_w,
	dt_lib_estrut_pj_w,
	dt_inicio_garantia_w,
	dt_fim_garantia_w,
	qt_dias_garantia_w,
	cd_conta_contabil_ww,
	cd_cgc_fabricante_w,
	ie_servico_realizado_w,
	cd_classe_material_w,
	nr_seq_regra_contrato_w,
	nr_contrato_oci_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	ds_erro_ccusto_w := ' ';
	
	
	select 	coalesce(max(cd_cnpj),0)
	into STRICT	cd_cgc_fabricante_w
	from	material_marca
	where 	nr_sequencia = nr_seq_marca_w
	and	cd_material  = cd_material_w;
		
	if (ie_consiste_doc_venc_fabric_w = 'S') and (obter_se_existe_doc_vencido(cd_cgc_fabricante_w) = 'S') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279370) || nr_item_oci_w || WHEB_MENSAGEM_PCK.get_texto(279371) || chr(13) || chr(10),1,2000);	
	end if;
	
	if (ie_consiste_regra_mat_w = 'S') then

		select	coalesce(obter_regra_material_usuario(cd_classe_material_w, cd_material_w, nm_usuario_p, '6'),'S')
		into STRICT	ie_consiste_permissao_mat_w
		;
		
		if (ie_consiste_permissao_mat_w = 'N') then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279372) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279373) || chr(13) || chr(10),1,2000);

		end if;
	end if;
	
	if (ie_consiste_permissao_compra_w = 'S') then

		select	coalesce(obter_permissao_compra_mat(cd_estabelecimento_w, cd_material_w, 'O'),'S')
		into STRICT	ie_consiste_permissao_mat_w
		;
		
		if (ie_consiste_permissao_mat_w = 'N') then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279372) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279374) || chr(13) || chr(10),1,2000);

		end if;
	end if;
	
	
	if (cd_centro_custo_w	= 0) and (cd_local_estoque_w	= 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279377) || chr(13) || chr(10),1,2000);
	end if;
	
	if (cd_centro_custo_w > 0) and (ie_consiste_ccusto_sem_aprov_w = 'S') then
		
		ds_erro_ccusto_w := consiste_ccusto_oc_sem_aprov(	cd_centro_custo_w, cd_local_estoque_w, cd_estabelecimento_w, cd_setor_atendimento_w, ie_urgente_w, ds_erro_ccusto_w);
		
		if (ds_erro_ccusto_w IS NOT NULL AND ds_erro_ccusto_w::text <> '') then
			ds_erro_w := substr(ds_erro_w || ds_erro_ccusto_w,1,2000);
		end if;
	end if;	
	
	if (ie_consiste_conta_cont_vazia_w = 'S') and (coalesce(cd_conta_contabil_ww::text, '') = '') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279378) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279379) || chr(13) || chr(10),1,2000);		
	end if;
	
	if (cd_local_estoque_w > 0) then
	
		select	coalesce(ie_centro_custo_ordem,'D')
		into STRICT	ie_centro_custo_ordem_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;
		
		if (ie_centro_custo_ordem_w = 'S') then
		
			select	count(1)
			into STRICT	qt_existe_w
			from	ordem_compra_item_rateio
			where	nr_ordem_compra = nr_ordem_p
			and	nr_item_oci = nr_item_oci_w;
		
			if (cd_centro_custo_w = 0) and (qt_existe_w = 0) then				
				ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279378) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279380) || chr(13) || chr(10),1,2000);
			elsif (cd_centro_custo_w = 0) and (qt_existe_w > 0) then
			
				select	count(1)
				into STRICT	qt_existe_w
				from	ordem_compra_item_rateio
				where	nr_ordem_compra = nr_ordem_p
				and	nr_item_oci = nr_item_oci_w
				and	coalesce(cd_centro_custo::text, '') = '';
				
				if (qt_existe_w > 0) then
					ds_erro_w := substr(ds_erro_w || wheb_mensagem_pck.get_Texto(318634, 'DS_MATERIAL_w='|| ds_material_w) || chr(13) || chr(10),1,2000);
				end if;
			end if;
		end if;
		
		if (ie_centro_custo_ordem_w = 'N') and (cd_centro_custo_w > 0) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279378) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279382) || chr(13) || chr(10),1,2000);
		end if;
		
		if (ie_considera_local_ordem_w = 'S') then
		
			ie_local_w := OBTER_LOCAL_VALIDO(
				cd_estabelecimento_w, cd_local_estoque_w, cd_material_w, null, ie_local_w);
				
			if (ie_local_w <> 'S') then
				ds_erro_w := substr(ds_erro_w || wheb_mensagem_pck.get_Texto(298954, 'CD_MATERIAL_W='|| cd_material_w) || chr(13) || chr(10),1,2000);
			end if;
		end if;
	end if;

	if (coalesce(ie_momento_consiste_garantia_w,'A') = 'L') and (coalesce(cd_grupo_consiste_garantia_w,'0') <> '0') and
		(((coalesce(dt_inicio_garantia_w::text, '') = '') or (coalesce(dt_fim_garantia_w::text, '') = '')) and (coalesce(qt_dias_garantia_w::text, '') = '')) then
		begin

		select	count(1)
		into STRICT	qt_grupo_garantia_w
                        	from	estrutura_material_v
                          where	cd_material = cd_material_w
                          and	substr(obter_se_contido(cd_grupo_material,cd_grupo_consiste_garantia_w),1,1) = 'S';

		if (qt_grupo_garantia_w > 0) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279378) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279383) || chr(13) || chr(10),1,2000);
		end if;
		
		end;
	end if;
	
	/*Consiste local do servico*/

	if (coalesce(ie_servico_realizado_w::text, '') = '') and (obter_se_exige_local_serv_oc(cd_estabelecimento_w, cd_material_w) = 'S') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279378) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279384) || chr(13) || chr(10),1,2000);		
	end if;
	
	if (Consiste_CCusto_Local_Direto_w = 'S') and (coalesce(cd_local_estoque_w,0) > 0) and (coalesce(cd_centro_custo_w,0) = 0) then
		begin
		select 	ie_tipo_local
		into STRICT	ie_tipo_local_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;
		
		if (ie_tipo_local_w = '8') then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279386) || chr(13) || chr(10),1,2000);
		end if;
		end;
	end if;
	
	if (Consiste_CCusto_Ordem_Item_w = 'S') and (coalesce(cd_centro_custo_w,0) > 0) and (coalesce(cd_centro_custo_ordem_w,0) > 0) and (coalesce(cd_centro_custo_w,0) <> coalesce(cd_centro_custo_ordem_w,0)) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279389) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279390) || chr(13) || chr(10),1,2000);
	end if;

	if (Restringe_CCusto_Regra_w = 'S') and (coalesce(cd_centro_custo_w,0) > 0) then
		begin
		select	count(1)
		into STRICT	qt_existe_regra_cc_usuario_w
		from	sup_regra_centro_setor a
		where	a.ie_situacao = 'A'
		and	ie_transf_estab = 'S'
		and	obter_se_usuario_setor(nm_usuario_p, a.cd_setor_atendimento) = 'S' 
		and	a.cd_centro_custo = cd_centro_custo_w;
		
		if (qt_existe_regra_cc_usuario_w = 0) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279389) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279391) || chr(13) || chr(10),1,2000);
		end if;
		end;
	end if;

	select	coalesce(sum(qt_prevista_entrega), 0)
	into STRICT	qt_material_entrega_w
	from	ordem_compra_item_entrega
	where	nr_ordem_compra	= nr_ordem_p
	and	nr_item_oci	= nr_item_oci_w;

	if (qt_material_w	<> qt_material_entrega_w) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279392) || chr(13) || chr(10),1,2000);
	end if;
	
	select	max(qt_item)
	into STRICT	qt_reg_w
	from (
		SELECT	count(1) qt_item,
			trunc(dt_prevista_entrega)
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_p
		and	nr_item_oci = nr_item_oci_w
		and	coalesce(dt_cancelamento::text, '') = ''
		group by trunc(dt_prevista_entrega)) alias5;

	if (qt_reg_w > 1) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279395)|| chr(13) || chr(10),1,2000); 	
	end if;
	
	if (ie_consiste_regra_w = 'S') then
		ds_erro_ww := consiste_regra_aprov_ordem(cd_local_estoque_w, cd_material_w, cd_centro_custo_w, cd_setor_atendimento_w, nr_item_oci_w, cd_estabelecimento_w, nm_usuario_p, nr_ordem_p, ds_erro_ww);
		if (ds_erro_ww <> ' ') then
			ds_erro_w := substr(ds_erro_w || ds_erro_ww || chr(13) || chr(10),1,2000); 	
		end if;
	end if;
	
	/* consiste se validade do registro da anvisa vencida*/

	if (ie_consiste_validade_anvisa_w = 'S') then
		
		select	count(1)
		into STRICT	qt_validade_vencida_w
		from	material_estab
		where	cd_material = cd_material_w
		and		cd_estabelecimento = cd_estabelecimento_w
		and		(dt_validade_reg_anvisa IS NOT NULL AND dt_validade_reg_anvisa::text <> '')
		and		dt_validade_reg_anvisa < clock_timestamp();
		
		select	max(coalesce(ie_vigente_anvisa,'N'))
		into STRICT 	ie_vigente_anvisa_w
		from	material_estab
		where	cd_material 		= cd_material_w
		and		cd_estabelecimento 	= cd_estabelecimento_w;
		
		if (qt_validade_vencida_w > 0) and (ie_vigente_anvisa_w = 'N') then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279396) || chr(13) || chr(10),1,2000);
		end if;
	end if;
	
	/*Consiste a data de validade da marca do material*/
	
	if (ie_consiste_valid_marca_mat_w = 'S') then

		select	max(dt_validade_reg_anvisa),
				max(ie_vigente_anvisa)
		into STRICT	dt_validade_anvisa_marca_w,
				ie_vigente_anvisa_marca_w
		from	material_marca
		where	cd_material = cd_material_w
		and	nr_sequencia = nr_seq_marca_w;
		
		if	((coalesce(ie_vigente_anvisa_marca_w,'X') = 'N') or (coalesce(dt_validade_anvisa_marca_w,clock_timestamp()) < trunc(clock_timestamp()))) then
			ds_erro_w :=	substr(	ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279397) || obter_desc_marca(nr_seq_marca_w) || WHEB_MENSAGEM_PCK.get_texto(279398) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279399) ||
						WHEB_MENSAGEM_PCK.get_texto(279401),1,255);
		end if;	
	end if;
	
	if (ie_consiste_subgrupo_compras_w = 'S') and (nr_seq_subgrupo_compra_w > 0) then
		
		select	coalesce(obter_se_mat_lib_subgrupo_com(nr_seq_subgrupo_compra_w, cd_material_w), 'S')
		into STRICT	ie_liberado_w
		;
		
		if (ie_liberado_w = 'N') then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279404) || chr(13) || chr(10),1,2000);
		end if;
	end if;
	
	if (ie_consiste_saldo_disp_atend_w = 'S') then
		begin
		qt_estoque_disp_atend_w := coalesce(obter_saldo_disp_estoque(cd_estab_transf_w,cd_material_w,cd_local_transf_w,trunc(clock_timestamp(),'mm')),0);
		qt_material_estoque_w	:= coalesce(obter_quantidade_convertida(cd_material_w,qt_material_w,cd_unidade_medida_compra_w,'UME'),0);
		if (qt_estoque_disp_atend_w < qt_material_estoque_w) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279406) || chr(13) || chr(10),1,2000);
		end if;
		end;
	end if;

	/*consistir dados na material_estab*/

	select	count(1)
	into STRICT	qt_reg_w
	from	material_estab
	where	cd_material		= cd_material_w
	and	cd_estabelecimento 	= cd_estabelecimento_w;

	if (qt_reg_w = 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279409) || chr(13) || chr(10),1,2000);
	end if;

	/* Verifica a regra na funcao Pessoa Juridica - Pasta Regra liberacao por estrutura */

	select	substr(obter_se_mat_lib_fornec(cd_cgc_fornecedor_w, cd_material_w, cd_estabelecimento_w, 'O'),1,1) ie_qualificado
	into STRICT	ie_qualificado_w
	;

	if (ie_qualificado_w in ('N', 'L', 'V')) and (coalesce(dt_lib_estrut_pj_w::text, '') = '') then
		begin
		if (ie_qualificado_w = 'N') then
			ds_erro_w := substr(ds_erro_w ||WHEB_MENSAGEM_PCK.get_texto(279412)|| cd_material_w ||WHEB_MENSAGEM_PCK.get_texto(279416) ||
							WHEB_MENSAGEM_PCK.get_texto(279419) || chr(13) || chr(10),1,2000);
		end if;
		if (ie_qualificado_w = 'L') then
			ds_erro_w := substr(ds_erro_w ||WHEB_MENSAGEM_PCK.get_texto(279375)|| cd_material_w ||WHEB_MENSAGEM_PCK.get_texto(279420) ||
							WHEB_MENSAGEM_PCK.get_texto(279421) || chr(13) || chr(10),1,2000);
		end if;
		if (ie_qualificado_w = 'V') then
			ds_erro_w := substr(ds_erro_w ||WHEB_MENSAGEM_PCK.get_texto(279375)|| cd_material_w ||WHEB_MENSAGEM_PCK.get_texto(279422) ||
							WHEB_MENSAGEM_PCK.get_texto(279421) || chr(13) || chr(10),1,2000);
		end if;
		end;
	end if;

	select	coalesce(max(qt),0)
	into STRICT	qt_reg_w
	from (SELECT	count(*) qt,
			trunc(dt_vencimento,'dd')
		from	ordem_compra_venc
		where	nr_ordem_compra = nr_ordem_p
		GROUP BY trunc(dt_vencimento,'dd')) alias5;

	if (qt_reg_w > 0 HAVING	count(trunc(dt_vencimento,'dd')) > 1
		) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279423) || chr(13) || chr(10),1,2000);
	end if;
	
	if (nr_seq_reg_lic_item_w > 0) then
	
		select	coalesce(max(nr_seq_licitacao),0)
		into STRICT	nr_seq_licitacao_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_p;
		
		if (nr_seq_licitacao_w > 0) and (qt_material_w > lic_obter_saldo_item_solic(nr_seq_licitacao_w, nr_seq_reg_lic_item_w)) then
			ds_erro_w := 	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279424) ||
					campo_mascara_virgula(lic_obter_saldo_item_solic(nr_seq_licitacao_w, nr_seq_reg_lic_item_w)) || chr(13) || chr(10),1,2000);
		end if;		
	end if;

	select	coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'M',cd_estabelecimento_w),'N'),
		coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'F',cd_estabelecimento_w),'N'),
		coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'CA',cd_estabelecimento_w),'N'),
		coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'AN',cd_estabelecimento_w),'N'),
		coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'TC',cd_estabelecimento_w),'N'),
		coalesce(obter_se_consiste_regra_lib_oc(cd_material_w,'A',cd_estabelecimento_w),'N')
	into STRICT	ie_exige_marca_w,
		ie_exige_fabric_w,
		ie_exige_ca_w,
		ie_exige_anvisa_w,
		ie_exige_tipo_compra_w,
		ie_exige_anexo_w
	;
	
	if (ie_exige_anexo_w = 'S') then
	
		select	count(1)
		into STRICT	qt_existe_exigencia_regra_w
		from	ordem_compra_anexo
		where	nr_ordem_compra = nr_ordem_p;
		
		if (qt_existe_exigencia_regra_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || wheb_mensagem_pck.get_Texto(334165, 'DS_MATERIAL_W='|| ds_material_w) || chr(13) || chr(10),1,2000);
		end if;
	end if;
	
	if (ie_exige_tipo_compra_w = 'S') and (nr_seq_tipo_compra_w = 0) then
		ds_erro_w :=	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279425) || chr(13) || chr(10),1,2000);		
	end if;
	
	if (ie_exige_marca_w = 'S') then
		begin

		select	count(1)
		into STRICT	qt_existe_exigencia_regra_w
		from	material_marca
		where	cd_material = cd_material_w;

		if (qt_existe_exigencia_regra_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279426) || chr(13) || chr(10),1,2000);
		end if;

		end;
	end if;

	if (ie_exige_fabric_w = 'S') then
		begin

		select	count(1)
		into STRICT	qt_existe_exigencia_regra_w
		from	material
		where	cd_material = cd_material_w
		and	(nr_seq_fabric IS NOT NULL AND nr_seq_fabric::text <> '');

		if (qt_existe_exigencia_regra_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279427) || chr(13) || chr(10),1,2000);
		end if;

		end;
	end if;

	if (ie_exige_ca_w = 'S') then
		begin

		select	count(1)
		into STRICT	qt_existe_exigencia_regra_w
		from	material
		where	cd_material = cd_material_w
		and	(nr_certificado_aprovacao IS NOT NULL AND nr_certificado_aprovacao::text <> '')
		and	dt_validade_certificado_aprov >= trunc(clock_timestamp());

		if (qt_existe_exigencia_regra_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279428) || chr(13) || chr(10),1,2000);
		end if;

		end;
	end if;

	if (ie_exige_anvisa_w = 'S') then
		begin

		select	count(1)
		into STRICT	qt_existe_exigencia_regra_w
		from	material_estab
		where	cd_material = cd_material_w
		and		cd_estabelecimento = cd_estabelecimento_w
		and		(nr_registro_anvisa IS NOT NULL AND nr_registro_anvisa::text <> '')
		and		((dt_validade_reg_anvisa >= trunc(clock_timestamp()))
		and (coalesce(ie_vigente_anvisa,'N') = 'N'));

		if (qt_existe_exigencia_regra_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || ds_material_w || WHEB_MENSAGEM_PCK.get_texto(279429) || chr(13) || chr(10),1,2000);
		end if;

		end;
	end if;
	
	ds_retorno_consistencia_w := obter_regra_permissao_oc(nr_ordem_p, cd_material_w, 'SP', ds_retorno_consistencia_w);
	
	if (ds_retorno_consistencia_w IS NOT NULL AND ds_retorno_consistencia_w::text <> '') then
		ds_erro_w := substr(ds_erro_w || ds_retorno_consistencia_w || chr(13) || chr(10),1,2000);
	end if;
	
	
	if (length(ds_erro_w) > 1700) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279430),1,2000);
		exit;
	end if;
	
	if (ie_consiste_saldo_contrato_w = 'S') then
	
		if (nr_seq_regra_contrato_w > 0) then
			select	coalesce(max(qt_material_fixa),0)
			into STRICT	qt_material_fixa_w
			from	contrato_regra_nf
			where	nr_sequencia = nr_seq_regra_contrato_w;
			
			if (qt_material_fixa_w > 0) then
				select	coalesce(sum(b.qt_material),0)
				into STRICT	qt_acumulado_oc_contrato_w
				from	ordem_compra a,
					ordem_compra_item b
				where	a.nr_ordem_compra = b.nr_ordem_compra
				and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
				and	b.nr_seq_regra_contrato = nr_seq_regra_contrato_w
				and	a.nr_ordem_compra <> nr_ordem_p;
				
				select	coalesce(sum(a.qt_prevista_entrega),0)
				into STRICT	qt_entrega_cancelada_w
				from	ordem_compra_item_entrega a,
					ordem_compra_item b,
					ordem_compra c
				where	a.nr_ordem_compra = b.nr_ordem_compra
				and	c.nr_ordem_compra = b.nr_ordem_compra
				and 	(a.dt_cancelamento IS NOT NULL AND a.dt_cancelamento::text <> '')
				and	b.nr_seq_regra_contrato = nr_seq_regra_contrato_w
				and 	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
				and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and	a.nr_ordem_compra <> nr_ordem_p;
			end if;
		else		
			select	coalesce(max(qt_material_fixa),0)
			into STRICT	qt_material_fixa_w
			from 	contrato_regra_nf a
			where	a.cd_material 			= cd_material_w
			and 	a.nr_seq_contrato 		= nr_contrato_oci_w
			and 	((coalesce(a.cd_estab_regra, cd_estab_ativo_w) = cd_estab_ativo_w) or (exists (	SELECT	1
														from	contrato_regra_nf_estab x
														where	x.cd_estab_regra = cd_estab_ativo_w
														and	x.nr_seq_regra_nf = a.nr_sequencia)))
			and 	trunc(clock_timestamp()) 			>= coalesce(a.dt_inicio_vigencia, trunc(clock_timestamp()))
			and 	trunc(clock_timestamp()) 			<= coalesce(a.dt_fim_vigencia, trunc(clock_timestamp()))
            and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A');
			
			if (qt_material_fixa_w > 0) then
				select	coalesce(sum(b.qt_material),0)
				into STRICT	qt_acumulado_oc_contrato_w
				from	ordem_compra a,
					ordem_compra_item b
				where	a.nr_ordem_compra = b.nr_ordem_compra
				and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
				and	b.nr_contrato = nr_contrato_oci_w
				and 	b.cd_material = cd_material_w
				and	a.nr_ordem_compra <> nr_ordem_p;
				
				select	coalesce(sum(a.qt_prevista_entrega),0)
				into STRICT	qt_entrega_cancelada_w
				from	ordem_compra_item_entrega a,
					ordem_compra_item b,
					ordem_compra c
				where	a.nr_ordem_compra = b.nr_ordem_compra
				and	c.nr_ordem_compra = b.nr_ordem_compra
				and 	(a.dt_cancelamento IS NOT NULL AND a.dt_cancelamento::text <> '')
				and	b.nr_contrato = nr_contrato_w
				and 	b.cd_material = cd_material_w
				and 	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
				and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and	a.nr_ordem_compra <> nr_ordem_p;
			end if;
		end if;
		
		select 	coalesce(sum(oci.qt_material), 0)
		into STRICT 	qt_total_material_oc_w
		from 	ordem_compra_item oci,
			ordem_compra oc
		where 	oc.nr_ordem_compra 	= oci.nr_ordem_compra
		and 	oci.nr_ordem_compra 	= nr_ordem_p
		and 	cd_material 		= cd_material_w;
			
		if (qt_entrega_cancelada_w > 0) then
			qt_acumulado_oc_contrato_w := qt_acumulado_oc_contrato_w - qt_entrega_cancelada_w;
		end if;
		
		if ((qt_acumulado_oc_contrato_w + qt_total_material_oc_w) > qt_material_fixa_w) then
			ds_erro_w := substr(ds_erro_w || wheb_mensagem_pck.get_Texto(445243, 'DS_MATERIAL_W='|| DS_MATERIAL_W) || chr(13) || chr(10),1,2000);
		end if;
	end if;
	
	if (ie_consiste_oc_sem_anexo_w = 'N') then
		select	count(1)
		into STRICT qt_existe_w
		from	ordem_compra_anexo b,
			ordem_compra a
		where	a.nr_ordem_compra = b.nr_ordem_compra
		and	a.nr_ordem_compra = nr_ordem_p;
		
		if (qt_existe_w = 0) then
			ds_erro_w :=	substr(ds_erro_w || wheb_mensagem_pck.get_Texto(1128249) || chr(13) || chr(10),1,2000);
		end if;
	end if;

	open C04;
	loop
	fetch C04 into	
		nr_item_solic_compra_w,
		nr_solic_compra_ww,
		ds_material_item_w,
		nr_item_oci_lib_w,
		nr_cot_compra_w,
		nr_item_cot_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		
		if (nr_solic_compra_ww > 0) then
		
			if (ie_consiste_qt_solic_w = 'S') then			
				
				select	count(1)
				into STRICT	qt_reg_w
				from	cot_compra_solic_agrup
				where	nr_cot_compra = nr_cot_compra_w
				and	nr_item_cot_compra = nr_item_cot_compra_w;
				
				/*Se nao tem registros na cot_compra_solic_agrup, faz dessa forma*/

				if (qt_reg_w = 0) then

					select	sum(qt_material)			
					into STRICT	qt_mat_solic_w		
					from	solic_compra_item
					where	nr_item_solic_compra = nr_item_solic_compra_w
					and	nr_solic_compra = nr_solic_compra_ww;
					
					select	sum(b.qt_material)
					into STRICT	qt_mat_ordens_w
					from	ordem_compra a,
						ordem_compra_item b
					where	a.nr_ordem_compra = b.nr_ordem_compra
					and	b.nr_item_solic_compra = nr_item_solic_compra_w
					and	b.nr_solic_compra = nr_solic_compra_ww
					and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nr_ordem_compra = nr_ordem_p));
					
					select	max(a.nr_ordem_compra)
					into STRICT	nr_ordem_liberada_w
					from	ordem_compra a,
						ordem_compra_item b
					where	a.nr_ordem_compra = b.nr_ordem_compra
					and	b.nr_item_solic_compra = nr_item_solic_compra_w
					and	b.nr_solic_compra = nr_solic_compra_ww
					and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');					
				else
					/*Se tem registros na cot_compra_solic_agrup, faz dessa forma, pois precisa considerar o agrupado*/
				
					select	sum(qt_material)			
					into STRICT	qt_mat_solic_w
					from	cot_compra_item
					where	nr_item_cot_compra = nr_item_cot_compra_w
					and	nr_cot_compra = nr_cot_compra_w;
					
					select	sum(b.qt_material)
					into STRICT	qt_mat_ordens_w
					from	ordem_compra a,
						ordem_compra_item b
					where	a.nr_ordem_compra = b.nr_ordem_compra
					and	b.nr_item_cot_compra = nr_item_cot_compra_w
					and	b.nr_cot_compra = nr_cot_compra_w
					and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nr_ordem_compra = nr_ordem_p));
					
					select	max(a.nr_ordem_compra)
					into STRICT	nr_ordem_liberada_w
					from	ordem_compra a,
						ordem_compra_item b
					where	a.nr_ordem_compra = b.nr_ordem_compra
					and	b.nr_item_cot_compra = nr_item_cot_compra_w
					and	b.nr_cot_compra = nr_cot_compra_w
					and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');
				end if;
				
				if (qt_mat_ordens_w > qt_mat_solic_w) then
					--ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(355529) || chr(13) || chr(10),1,2000);	
					CALL wheb_mensagem_pck.exibir_mensagem_abort(355529,'NR_ORDEM_LIB=' || nr_ordem_liberada_w ||
											';NR_ITEM=' || nr_item_oci_lib_w ||
											';DS_MATERIAL=' || ds_material_item_w);
				end if;
			end if;		
		
			select	count(1)
			into STRICT	qt_existe_w
			from	reg_lic_item_solic
			where	nr_solic_compra = nr_solic_compra_ww
			and	nr_item_solic_compra = nr_item_solic_compra_w;

			if (qt_existe_w > 0) then
				open C02;
				loop
				fetch C02 into
					nr_seq_reg_preco_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin

					select	lic_obter_se_reg_preco_vigente(nr_seq_reg_preco_w)
					into STRICT	ie_vigente_w
					;

					if (ie_vigente_w = 'N') then
						CALL wheb_mensagem_pck.exibir_mensagem_abort(191780,'NR_SEQ_REG_PRECO=' || nr_seq_reg_preco_w ||
												';NR_SOLIC_COMPRA=' || nr_solic_compra_ww ||
												';CD_MATERIAL=' || cd_material_w ||
												';DS_MATERIAL=' || ds_material_w);

						/*(-20011,'O registro de preco ' || nr_seq_reg_preco_w || ' vinculado na solicitacao ' || nr_solic_compra_w || ' com o material ' || cd_material_w || ' - ' || ds_material_w 				|| ', esta fora da vigencia.');*/

					end if;
					end;
				end loop;
				close C02;
			end if;
		end if;
		end;
	end loop;
	close c04;
	
	select	count(1)
	into STRICT	qt_reg_w
	from	ordem_compra_item_rateio
	where	nr_ordem_compra = nr_ordem_p
	and	nr_item_oci = nr_item_oci_w;
	
	
	/*Consiste a diferenca da quantidade do rateio*/

	if (qt_reg_w > 0) and (ie_consiste_qt_rateio_w = 'S') then
		
		select	coalesce(sum(qt_rateio),0)
		into STRICT	qt_rateio_w
		from	ordem_compra_item_rateio
		where	nr_ordem_compra = nr_ordem_p
		and	nr_item_oci = nr_item_oci_w;
		
		if (qt_rateio_w <> qt_material_w) then		
			CALL wheb_mensagem_pck.exibir_mensagem_abort(299024,'CD_MATERIAL_W='||cd_material_w||';DS_MATERIAL_W='||ds_material_w);		
			/*O material ' || cd_material_w || ' - ' || ds_material_w || ' esta com diferenca na quantidade do rateio.*/

		end if;	
	end if;
	
	
	/*Consiste a diferenca do valor do rateio*/

	if (qt_reg_w > 0) and (ie_consiste_vl_rateio_w = 'S') then
		
		vl_total_material_w	:= qt_material_w * vl_unitario_material_w;
	
		select	coalesce(sum(vl_rateio),0)
		into STRICT	vl_rateio_w
		from	ordem_compra_item_rateio
		where	nr_ordem_compra = nr_ordem_p
		and	nr_item_oci = nr_item_oci_w;
	
	
		if (round((vl_rateio_w)::numeric,2) <> round((vl_total_material_w)::numeric,2)) then		
			CALL wheb_mensagem_pck.exibir_mensagem_abort(299022,'CD_MATERIAL_W='||cd_material_w||';DS_MATERIAL_W='||ds_material_w);		
			/*O material ' || cd_material_w || ' - ' || ds_material_w || ' esta com diferenca no valor do rateio.*/

		end if;	
	end if;	
	end;
end loop;
close c01;

if (ie_consiste_avaliacao_oc_w = 'S') then

	select	count(1)
	into STRICT	qt_consiste_avaliacao_w
	from	material b,
		ordem_compra_item a,
		material_estab c,
		ordem_compra d
	where	a.cd_material = b.cd_material
	and 	c.cd_material = a.cd_material
	and     d.nr_ordem_compra = a.nr_ordem_compra
	and 	(a.nr_contrato IS NOT NULL AND a.nr_contrato::text <> '')
	and 	c.ie_material_estoque = 'N'
	and	(d.cd_cgc_fornecedor IS NOT NULL AND d.cd_cgc_fornecedor::text <> '')
	and 	c.cd_estabelecimento = cd_estabelecimento_w
	and     coalesce(d.nr_avaliacao_fornec::text, '') = ''
	and 	a.nr_ordem_compra = nr_ordem_p;

	if (qt_consiste_avaliacao_w > 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(1178432) || chr(13) || chr(10),1,2000);
	end if;
end if;

select	coalesce(max(ie_dia_util_ent_urgente),'N')
into STRICT	ie_dia_util_ent_urgente_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (ie_dia_util_ent_urgente_w = 'S') then
	begin
	dt_inicial_w	:= trunc(clock_timestamp(),'dd');
	dt_final_w	:= dt_inicial_w + qt_dia_entrega_urgente_w;
	
	select	obter_qt_dia_util_periodo(dt_inicial_w,dt_final_w,cd_estabelecimento_w)
	into STRICT	qt_dias_util_w
	;
	
	if (obter_qt_dia_util_periodo(trunc(clock_timestamp(),'dd'), trunc(clock_timestamp(),'dd'), cd_estabelecimento_w) > 0) then
	qt_dias_util_w	:= qt_dias_util_w -1;
	end if;
	
	qt_dia_entrega_urgente_w	:= qt_dia_entrega_urgente_w + ((dt_final_w - dt_inicial_w) - qt_dias_util_w);
			
			
	end;
end if;
			
if (qt_dia_entrega_urgente_w IS NOT NULL AND qt_dia_entrega_urgente_w::text <> '') then
	begin
	select	count(1)
	into STRICT	qt_entrega_w
	FROM ordem_compra_item a
LEFT OUTER JOIN ordem_compra_item_entrega b ON (a.nr_ordem_compra = b.nr_ordem_compra AND a.nr_item_oci = b.nr_item_oci)
WHERE dt_prevista_entrega	<= trunc(clock_timestamp()) + qt_dia_entrega_urgente_w and a.nr_ordem_compra 	= nr_ordem_p;

	if (qt_entrega_w > 0) and (ie_marcar_urgente_oc_w = 'S') then
		
		update	ordem_compra
		set	ie_urgente = 'S'
		where	nr_ordem_compra = nr_ordem_p;
		end if;
	end;
end if;

select	coalesce(max(nr_seq_contrato),0)
into STRICT	nr_contrato_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_p;

if (nr_contrato_w = 0) then
	
	select	coalesce(max(nr_contrato),0)
	into STRICT	nr_contrato_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_p;

end if;

if (nr_contrato_w > 0) then
	begin

	ie_fornec_liberado_w	:= 'S';

	if (cd_cgc_fornecedor_w <> '0') then

		select	coalesce(max(substr(obter_se_contrato_do_cnpj(nr_contrato_w,cd_cgc_fornecedor_w,'OC'),1,1)),'S')
		into STRICT	ie_fornec_liberado_w
		;

	else

		select	coalesce(max(substr(obter_se_contrato_pessoa(nr_contrato_w,cd_pessoa_fisica_w,'OC'),1,1)),'S')
		into STRICT	ie_fornec_liberado_w
		;

	end if;

	if (ie_fornec_liberado_w = 'N') and (ie_perm_consist_contrato_w = 'N') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279431) || chr(13) || chr(10),1,2000);
	end if;

	select	coalesce(max(vl_total_contrato),0),
		coalesce(obter_saldo_contrato_oc(nr_contrato_w),0)
	into STRICT	vl_total_contrato_w,
		vl_saldo_contrato_w
	from	contrato
	where	nr_sequencia = nr_contrato_w;

	if (vl_total_contrato_w > 0) and (vl_total_ordem_w > vl_saldo_contrato_w) and (ie_perm_consist_contrato_w = 'N') then

		select	campo_mascara_virgula(vl_saldo_contrato_w)
		into STRICT	vl_saldo_format_w
		;

		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279432) || to_char(nr_contrato_w) || WHEB_MENSAGEM_PCK.get_texto(279433) || vl_saldo_format_w || ') '  || chr(13) || chr(10),1,2000);
	end if;

	end;
end if;


if (qt_item_compra_w = 0) then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279435) || chr(13) || chr(10),1,2000);
end if;

if (qt_item_zerado_w > 0) then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279438) || chr(13) || chr(10),1,2000);
end if;

if (qt_entrega_dif_w > 1) then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279439) || chr(13) || chr(10),1,2000);
end if;

if (Consiste_CCusto_Local_Direto_w = 'S') and (coalesce(cd_local_entrega_ordem_w,0) > 0) and (coalesce(cd_centro_custo_ordem_w,0) = 0) then
	begin
	select 	ie_tipo_local
	into STRICT	ie_tipo_local_w
	from	local_estoque
	where	cd_local_estoque = cd_local_entrega_ordem_w;
	
	if (ie_tipo_local_w = '8') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279440) || chr(13) || chr(10),1,2000);
	end if;
	end;
end if;

if (Restringe_CCusto_Regra_w = 'S') and (coalesce(cd_centro_custo_ordem_w,0) > 0) then
	begin
	select	count(1)
	into STRICT	qt_existe_regra_cc_usuario_w
	from	sup_regra_centro_setor a
	where	a.ie_situacao = 'A'
	and	ie_transf_estab = 'S'
	and	obter_se_usuario_setor(nm_usuario_p, a.cd_setor_atendimento) = 'S' 
	and	a.cd_centro_custo = cd_centro_custo_ordem_w;
	
	if (qt_existe_regra_cc_usuario_w = 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279441) || chr(13) || chr(10),1,2000);
	end if;
	end;
end if;


if (ie_consiste_doc_vencido_w = 'S') and (obter_se_existe_doc_vencido(cd_cgc_fornecedor_w) = 'S') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279442) || chr(13) || chr(10),1,2000);	
end if;

if (ie_juros_negociado_oc_w = 'S') and (pr_juros_negociado_w > 0) then
	vl_total_ordem_w	:= 	vl_total_ordem_w  + dividir((vl_total_ordem_w * pr_juros_negociado_w),100);
end if;	
	
if (vl_total_ordem_w <> vl_total_venc_w)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279443) || chr(13) || chr(10),1,2000);	
end if;

select	obter_aprov_ext_ordem(nr_ordem_p)
into STRICT	ie_aprovacao_ext_w
;
if (ie_aprovacao_ext_w <> 'S') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279444) || ie_aprovacao_ext_w || chr(13) || chr(10),1,2000);
end if;

select	count(1)
into STRICT	qt_inativo_w
from	pessoa_juridica b,
	ordem_compra a
where	a.nr_ordem_compra	= nr_ordem_p
and	a.cd_cgc_fornecedor	= b.cd_cgc
and	b.ie_situacao		<> 'A';
if (qt_inativo_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279446) || chr(13) || chr(10),1,2000);	
end if;

select	count(1)
into STRICT	qt_condicao_inativo_w
from	condicao_pagamento b,
	ordem_compra a
where	a.nr_ordem_compra	= nr_ordem_p
and	a.cd_condicao_pagamento	= b.cd_condicao_pagamento
and	b.ie_situacao		<> 'A';
if (qt_condicao_inativo_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279447) || chr(13) || chr(10),1,2000);	
end if;

select	count(1)
into STRICT	qt_reg_w
from	ordem_compra a
where	a.nr_ordem_compra	= nr_ordem_p
and	(cd_cgc_fornecedor IS NOT NULL AND cd_cgc_fornecedor::text <> '')
and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');
if (qt_reg_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279448) || chr(13) || chr(10),1,2000);	
end if;

select	count(1)
into STRICT	qt_reg_w
from	ordem_compra a
where	a.nr_ordem_compra	= nr_ordem_p
and	coalesce(cd_cgc_fornecedor::text, '') = ''
and	coalesce(cd_pessoa_fisica::text, '') = '';
if (qt_reg_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279474) || chr(13) || chr(10),1,2000);	
end if;

select	count(1),
	max(a.cd_conta_contabil)
into STRICT	qt_reg_w,
	cd_conta_contabil_w
from	conta_contabil b,
	ordem_compra_item a
where	a.nr_ordem_compra	= nr_ordem_p
and	a.cd_conta_contabil	= b.cd_conta_contabil
and	b.ie_tipo		= 'T';	
if (qt_reg_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279475) || cd_conta_contabil_w || WHEB_MENSAGEM_PCK.get_texto(279476) || chr(13) || chr(10),1,2000);	
end if;

select	coalesce(max(a.cd_conta_contabil), 'X')
into STRICT	cd_conta_contabil_w
from	ordem_compra b,
	ordem_compra_item a
where	a.nr_ordem_compra	= b.nr_ordem_compra
and	a.nr_ordem_compra	= nr_ordem_p
and (substr(obter_se_conta_vigente(a.cd_conta_contabil, b.dt_ordem_compra),1,1) = 'N');
if (cd_conta_contabil_w <> 'X') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279475) || cd_conta_contabil_w || WHEB_MENSAGEM_PCK.get_texto(279477) || chr(13) || chr(10),1,2000);	
end if;

select	count(1),
	max(a.cd_centro_custo)
into STRICT	qt_reg_w,
	cd_centro_custo_w
from	centro_custo b, 
	ordem_compra_item a
where	a.nr_ordem_compra	= nr_ordem_p
and	a.cd_centro_custo	= b.cd_centro_custo
and	b.ie_tipo		= 'T';	
if (qt_reg_w > 0)	then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279478) || cd_centro_custo_w || WHEB_MENSAGEM_PCK.get_texto(279479) || chr(13) || chr(10),1,2000);	
end if;

if (ie_consiste_vl_minimo_p = 'S') then
	begin
	select	(substr(obter_dados_pf_pj_estab(cd_estabelecimento, null, cd_cgc_fornecedor, 'EVM'),1,20))::numeric
	into STRICT	vl_minimo_nf_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_p;

	if (vl_total_ordem_w < vl_minimo_nf_w) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279480) || chr(13) || chr(10),1,2000);
	end if;
	end;
end if;

if (ie_consiste_revisao_w <> 'N') then
	select	obter_dados_pf_pj(null,cd_cgc_fornecedor,'RE')
	into STRICT	ie_forma_revisao_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_p;
	
	if (ie_consiste_revisao_w = 'NA') and
		((ie_forma_revisao_w = 'A') or (ie_forma_revisao_w = 'N')) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279481) || chr(13) || chr(10),1,2000);
	elsif (ie_consiste_revisao_w = 'AR') and (ie_forma_revisao_w = 'A') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279481) || chr(13) || chr(10),1,2000);
	elsif (ie_consiste_revisao_w = 'NR') and (ie_forma_revisao_w = 'N') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279481) || chr(13) || chr(10),1,2000);
	end if;
end if;

if (ie_consiste_fornec_adiant_w = 'S') and (cd_cgc_fornecedor_w <> 0) then
	begin
	select	count(1)
	into STRICT	qt_forn_adiant_aberto_w
	from 	adiantamento_pago_v
	where 	coalesce(dt_baixa::text, '') = ''
	and	cd_estabelecimento = cd_estabelecimento_w
	and    	cd_cgc = cd_cgc_fornecedor_w;

	if (qt_forn_adiant_aberto_w > 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279483) || chr(13) || chr(10),1,2000);
	end if;
	end;
end if;

if (ie_consiste_orcado_w = 'S') and (ie_orcado_w = 'N') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279484) || chr(13) || chr(10),1,2000);
end if;

if (cd_moeda_w > 0) then
	select	coalesce(max(ie_exige_conv_oc),'N')
	into STRICT	ie_exige_conv_oc_w
	from	moeda
	where	cd_moeda = cd_moeda_w;
	
	if (ie_exige_conv_oc_w = 'S') and (vl_conv_moeda_w = 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279486) || chr(13) || chr(10),1,2000);
	end if;
end if;

open C03;
loop
fetch C03 into
	cd_material_ordem_w,
	qt_material_ordem_w,
	vl_material_ordem_w,
	ie_mat_proj_rec_w,
	qt_mat_proj_rec_w,
	vl_mat_proj_rec_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	if (ie_material_projeto_w = 'S') and (ie_mat_proj_rec_w = 'N') then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279375) || cd_material_ordem_w || WHEB_MENSAGEM_PCK.get_texto(279487) || chr(13) || chr(10),1,2000);
	end if;
	if (ie_qtd_vl_projeto_w = 'S') and
		((qt_mat_proj_rec_w <> qt_material_ordem_w) or (vl_mat_proj_rec_w <> vl_material_ordem_w))then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279496) || cd_material_ordem_w || WHEB_MENSAGEM_PCK.get_texto(279495) || chr(13) || chr(10), 1, 2000);
	end if;
	end;
end loop;
close C03;

select  (CASE WHEN (max(nr_sequencia) IS NOT NULL AND (max(nr_sequencia))::text <> '') THEN 'S' ELSE 'N' END)
into STRICT	is_regulated_price_w
from    rule_regulated_price;

if (is_regulated_price_w = 'S') then
	for ordem_compra_w in c01 loop
		select	to_number(obter_regulated_price('VMC', ordem_compra_w.cd_material), '99999D99')
		into STRICT	vl_max_purchase_w
		;

		if (ordem_compra_w.vl_unitario_material > vl_max_purchase_w) then
			ds_alerta_w := substr(ds_alerta_w || Wheb_mensagem_pck.get_Texto(1206805, 'CD_MATERIAL_W='||ordem_compra_w.cd_material) || chr(13) || wheb_mensagem_pck.get_texto(1206806) || chr(13) || chr(10),1,2000);
		end if;
	end loop;
end if;

/* Verifica se o projeto recurso vinculado ao item da ordem possui saldo suficiente para atender esse item da ordem de compra */

ds_erro_w := ds_erro_w || projeto_recurso_pck.consistir_oc_proj_rec(nr_ordem_p, nm_usuario_p, cd_estabelecimento_w);


CALL gerenciamento_contrato_pck.consistir_oc_contrato(nr_ordem_p, nm_usuario_p);

ds_erro_p := substr(ds_erro_w,1,255);
ds_alerta_p := substr(ds_alerta_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_ordem_compra (nr_ordem_p text, ie_consiste_vl_minimo_p text, nm_usuario_p text, ds_erro_p INOUT text, ds_alerta_p INOUT text) FROM PUBLIC;

