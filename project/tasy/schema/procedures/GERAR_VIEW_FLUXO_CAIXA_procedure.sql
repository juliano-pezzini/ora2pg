-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_view_fluxo_caixa ( cd_estabelecimento_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, dt_referencia_p timestamp, ie_periodo_p text, ie_classif_p text, ie_nivel_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, cd_estab_grupo_p text default null, cd_empresa_grupo_p text default null) AS $body$
DECLARE


/*
ie_classif_p

'P' - Passado
'R' - Realizar
''  - Realizado/Realizar
'PRM' - Realizado para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (dias úteis)
'RRM' - A realizar para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (dias úteis)
'RM' - Ralizado/Ralizar para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (dias úteis)
'PGRM' - Realizado para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (todos os dias)
'RGRM' - A realizar para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (todos os dias)
'PRGMRM' - Ralizado/Ralizar para rel de fluxo do mes - vem da procedure GERAR_FLUXO_CAIXA_MENSAL (todos os dias)
'RPR' - Relatório com passado/a realizar do dia separados

A primeira letra do parametro se refere a classificacao do fluxo
As letras subsequentes referen-se a qual tipo de view deve ser gerada: funcao ou relatorio
*/
ds_comando_w		varchar(32000) := '';
vl_fluxo_w		varchar(32000) := '';
dt_fluxo_w		timestamp;
Virgula_w		varchar(0001)  := '';
ds_nivel_w		varchar(255)   := '';
qt_nivel_w		smallint;
cd_conta_saldo_w		bigint;
cd_conta_saldo_nt_w	bigint;
contador_w		bigint;
ds_data_w		varchar(40);
ie_passado_real_w		varchar(40);
ds_sql_where_w		varchar(4000);
cd_conta_saldo_ant_w 	bigint;
ds_datas_w		varchar(255);
cd_moeda_empresa_w	integer;
cd_estabelecimentos_w varchar(1000);

  r1 RECORD;

BEGIN

if (coalesce(cd_empresa_grupo_p::text, '') = '' and coalesce(cd_estab_grupo_p::text, '') = '') then

    /* Obter a conta de Saldo */

    select	cd_conta_financ_saldo,
        cd_conta_financ_sant,
        ie_passado_real
    into STRICT 	cd_conta_saldo_w,
        cd_conta_saldo_ant_w,
        ie_passado_real_w
    from 	Parametro_Fluxo_caixa
    where	cd_estabelecimento = cd_estabelecimento_p;

    /* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */

    select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
    into STRICT	cd_moeda_empresa_w
;

    if (ie_periodo_p	= 'D') and
        ((dt_final_p - dt_inicio_p) > 366) then
        /*Periodo Superior a 366 dias*/

        CALL wheb_mensagem_pck.exibir_mensagem_abort(235399);
    end if;
    if (ie_nivel_p	> 6) or (ie_nivel_p = 0) then
        /*O Nivel deve ser de 1 a 6*/

        CALL wheb_mensagem_pck.exibir_mensagem_abort(235400);
    end if;

    CALL Exec_sql_Dinamico('Tasy', 'drop view Fluxo_Caixa_v');

    if (coalesce(ie_classif_p, '-1')	<> 'C') then

        if (ie_periodo_p	= 'M') then
            dt_fluxo_w		:= last_Day(trunc(dt_inicio_p, 'dd'));
        else
            dt_fluxo_w		:= trunc(dt_inicio_p, 'dd');
        end if;

        contador_w		:= 1;
        while dt_fluxo_w <= dt_final_p LOOP
            begin

            if (coalesce(ie_classif_p, '-1') not in ('PRM','RRM','RM','RPR')) or 	 /* forçar somente dias uteis qdo RM   */
                (trunc(obter_proximo_dia_util(cd_estabelecimento_p, dt_fluxo_w), 'dd') = trunc(dt_fluxo_w, 'dd')) then



                if (coalesce(ie_classif_p,'-1') in ('PRM','RRM','RM','RPR')) then /* Se a geração é de relatório mensal */
                    ds_data_w		:= to_char(contador_w);
                    contador_w		:= contador_w + 1;

                    if (ie_passado_real_w = 'S') and (ie_periodo_p = 'D') and (coalesce(ie_classif_p, '-1') = 'RPR') and (trunc(dt_fluxo_w, 'dd') = trunc(dt_referencia_p, 'dd')) then /* ahoffelder - OS 310509 - 13/04/2011 */
                        begin

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'P' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w;
                        virgula_w	:= ',';
                        ds_data_w	:= to_char(contador_w);
                        contador_w	:= contador_w + 1;
                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'R' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w;

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;		

                    else

                        begin

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia, to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                'D' || ds_data_w;

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;					


                    end if;

                else
                    if (coalesce(ie_classif_p, '-1') in ('PGRM','RGRM','PRGMRM')) then
                        ds_data_w		:= to_char(dt_fluxo_w,'dd');
                    else
                        ds_data_w		:= to_char(dt_fluxo_w,'ddmmyyyy');
                    end if;

                    -- Edgar 04/12/2007, OS 74953
                    if (ie_passado_real_w = 'S') and
                        (((trunc(dt_fluxo_w, 'dd') = trunc(dt_referencia_p, 'dd')) or
                        ((ie_periodo_p	= 'M') and (trunc(dt_fluxo_w, 'month') = trunc(dt_referencia_p, 'month'))))) then

                        begin 

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'P' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w || 'P ';
                        virgula_w	:= ',';
                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'R' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w || 'R';

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;							

                    else
                        if (coalesce(ie_classif_p,'1')	<> 'POM') then

                            begin
                        
                            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                    'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                    to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                    'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                    'D' || ds_data_w;

                            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                            end;						

                        else
                        
                            begin
                        
                            vl_fluxo_w	:=  	vl_fluxo_w || virgula_w ||
                                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                        'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                        'P' || ds_data_w || ', ' ||
                                        ' max(OBTER_VALOR_FLUXO_ORCADO( 	' || cd_estabelecimento_p || ', ' ||
                                        ' a.cd_conta_financ,' ||
                                        ' add_months(to_date(' || chr(39) || to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),0), ' ||
                                        ' to_date(' || chr(39) || to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || cd_empresa_p || chr(39) || ', ' || chr(39) || ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ')) O' || ds_data_w;

                            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                            end;		

                        end if;

                    end if;
                end if;

                virgula_w	:= ',';

            end if;

            if (ie_periodo_p	= 'M') then
                begin
                dt_fluxo_w		:= add_months(dt_fluxo_w, 1);
                dt_fluxo_w		:= last_Day(trunc(dt_fluxo_w, 'dd'));
                end;
            else
                dt_fluxo_w		:= dt_fluxo_w + 1;
            end if;

            end;
        END LOOP;

        if (coalesce(ie_classif_p, '-1') in ('PGRM','RGRM','PRGMRM')) then

            -- Edgar 30/11/2007, OS 75728, tratar todais das CFs de saldo
            begin
            
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'SUM(decode(	cd_conta_financ, ' ||
                                    cd_conta_saldo_ant_w || ', ' ||
                                        ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                    cd_conta_saldo_w || ', ' ||
                                        ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                            ' decode(CD_CONTA_FINANC, ' || cd_conta_saldo_w || ', 0, '
                                || cd_conta_saldo_ant_w || ', 0, vl_fluxo))) Total ';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        else
        
            begin
        
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                            ' decode(obter_se_totaliza_cf(cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ',decode(obter_se_acumula_cf(cd_conta_financ),' || chr(39) || 'S' || chr(39) || ', ' ||
                                            'obter_valor_final_fluxo(' || cd_estabelecimento_p || ', ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '3,
                                                        cd_conta_financ),
                                    decode(CD_CONTA_FINANC, ' ||
                                    cd_conta_saldo_w || ', ' ||
                                            'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    cd_conta_saldo_ant_w || ', ' ||
                                            'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    'sum(vl_fluxo))),  0) Total';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;

        end if;


        /* Edgar 02/08/2004 - OS 9996, tratamento do 4º nível da conta */

        select	coalesce(max(length(CD_CONTA_APRES)), 9)
        into STRICT	qt_nivel_w
        from	conta_financeira
        where	cd_empresa	= cd_empresa_p;

        if (qt_nivel_w = 9) then --00.00.000
            if (ie_nivel_p = 3) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 15) then --00.00.00.00.000
            if (ie_nivel_p = 5) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,13,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 12) then --00.00.00.000
            if (ie_nivel_p = 4) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;				
        else   --00.00.00.00.00.000
            if (ie_nivel_p = 6) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';						
                elsif (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 13, 2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 5) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 16, 3) = ' ||
                            chr(39) || '000' || chr(39) || ')';											
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        end if;


        /* Edgar 12/07/2005, tratamento do valor orcado no final do fluxo */

        begin
        
        vl_fluxo_w	:=  vl_fluxo_w || virgula_w || 	
                ' OBTER_VALOR_FLUXO_ORCADO( 	' || cd_estabelecimento_p || ', ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || cd_empresa_p || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') vl_orcado ';

        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
        end;

        /* Inclusão do campo "% Orçado x Real" para os fluxos Realizado e A Realizar */

        if (ie_classif_p in ('P','R','PGRM','RGRM')) then
            begin
                /* Cálculo:  ( ( Real - Orçado ) / Orçado) * 100 
                    Cálculo será realizado somente quando houver valor orçado */
                vl_fluxo_w	:=  vl_fluxo_w || virgula_w || 'decode(OBTER_VALOR_FLUXO_ORCADO(' || cd_estabelecimento_p || ', ' || ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || cd_empresa_p || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || '),' ||
                                ' 0 , 0 , (((';
                /* Total */

                if (ie_classif_p in ('PGRM','RGRM')) then
                    begin
                        vl_fluxo_w	:= vl_fluxo_w || ' SUM(decode(cd_conta_financ, ' ||
                                        cd_conta_saldo_ant_w || ', ' ||
                                            ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                        cd_conta_saldo_w || ', ' ||
                                            ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                        ' decode(CD_CONTA_FINANC, ' || cd_conta_saldo_w || ', 0, '
                                            || cd_conta_saldo_ant_w || ', 0, vl_fluxo))) ';
                    exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                        /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                        CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                    end;
                else
                    begin
                        vl_fluxo_w	:= vl_fluxo_w || ' decode(obter_se_totaliza_cf(cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ',decode(obter_se_acumula_cf(cd_conta_financ),' || chr(39) || 'S' || chr(39) || ', ' ||
                                            'obter_valor_final_fluxo(' || cd_estabelecimento_p || ', ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '3,
                                                        cd_conta_financ),
                                    decode(CD_CONTA_FINANC, ' ||
                                    cd_conta_saldo_w || ', ' ||
                                            'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    cd_conta_saldo_ant_w || ', ' ||
                                            'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    'sum(vl_fluxo))),  0) ';
                    exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                        /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                        CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                    end;
                end if;
                /* Orçado */

                vl_fluxo_w	:= vl_fluxo_w || ' - OBTER_VALOR_FLUXO_ORCADO( 	' || cd_estabelecimento_p || ', ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || cd_empresa_p || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') )';

                vl_fluxo_w	:= vl_fluxo_w || ' / OBTER_VALOR_FLUXO_ORCADO( 	' || cd_estabelecimento_p || ', ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || cd_empresa_p || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') )';

                vl_fluxo_w	:= vl_fluxo_w || ' * 100)) pr_orcado_real ';
            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;
        end if;

        /* Edgar 28/11/2006, tratamento do orçado - realizado */

        if (ie_classif_p = 'P') then

            begin
        
            vl_fluxo_w	:=	vl_fluxo_w || virgula_w || ' (OBTER_VALOR_FLUXO_ORCADO(' || cd_estabelecimento_p || ', ' || 
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || cd_empresa_p || ', ' || chr(39) || ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') - ' ||
                                ' decode(CD_CONTA_FINANC, ' || cd_conta_saldo_w || ', ' || 
                                    'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    cd_conta_saldo_ant_w || ', '|| 
                                    'obter_valor_fluxo_saldo(' || cd_estabelecimento_p || ', ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    ' sum(vl_fluxo))) * (decode(substr(obter_descricao_padrao(' || chr(39) || 'CONTA_FINANCEIRA' || chr(39) || ',' ||
                                chr(39) || 'IE_OPER_FLUXO' || chr(39) || ',a.cd_conta_financ),1,1),' || chr(39) || 'S' || chr(39) || ',-1,' || chr(39) || 'D' || chr(39) || ',1,decode(substr(obter_descricao_padrao(' || chr(39) || 'CONTA_FINANCEIRA' || chr(39) || ',' ||
                                chr(39) || 'IE_VARIACAO' || chr(39) || ',a.cd_conta_financ),1,1),' || chr(39) || 'S' || chr(39) || ',-1,' || chr(39) || 'D' || chr(39) || ',1,0))) vl_orcado_passado ';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        end if; -- Paulo - OS 45404 - 12/12/2006 - Alterei o comando acima para, se for entrada multiplicar por -1.


        -- Edgar 20/09/20005, OS 22253, Fiz um tratamento para trazer realizado até dt_referencia e a realizar após esta data
        if (ie_periodo_p = 'M') then
            ds_datas_w	:= '   and ((dt_referencia  = last_day(dt_referencia)) and dt_referencia between ';
        else
            ds_datas_w	:= '   and (dt_referencia between ';
        end if;
        if (coalesce(dt_referencia_p::text, '') = '') then	

            begin

            ds_comando_w	:= 'create or replace view fluxo_caixa_v as ' ||
                        ' select cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||')) ds_moeda, ' || vl_fluxo_w ||
                        ' from fluxo_caixa a ' ||
                        ' where ie_classif_fluxo = ' || chr(39) || substr(ie_classif_p,1,1) || chr(39) ||
                        ' and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                        ' and ((a.ie_classif_fluxo	= ''O'' AND	(			
                            (			 
                                (NVL( ' || chr(39) || ie_restringe_estab_p  || chr(39) || ',''E'') = ''E'') AND  
                                (a.cd_estabelecimento	= ' ||  cd_estabelecimento_p || ')
                            ) OR						       	
                            (						       
                                (NVL(' || chr(39) ||ie_restringe_estab_p|| chr(39) ||',''E'') = ''S'') AND  
                            (
                                (a.cd_estabelecimento	= '||cd_estabelecimento_p|| ') OR
                                (obter_estab_financeiro(a.cd_estabelecimento) = '|| cd_estabelecimento_p || ')
                            )
                            ) OR
                            (
                                (NVL( ' || chr(39) || ie_restringe_estab_p || chr(39) || ',''E'') = ''N'')
                            )
                            )		
                        ) OR ( a.ie_classif_fluxo	<> ''O'' AND cd_estabelecimento = ' || cd_estabelecimento_p || 

                        ' )) and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                        ds_datas_w ||
                        '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                        ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')) ' ||
                        ds_nivel_w || ' Group By cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||'))';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        else
            -- Edgar 04/12/2007, OS 74953
            ds_sql_where_w	:= ' where ie_classif_fluxo = ' ||
                    ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || chr(39) || 'R' || chr(39) || ',' ||
                    chr(39) || 'P' || chr(39) || ')';
            if (ie_passado_real_w = 'S') and (ie_periodo_p = 'M') then

                ds_sql_where_w	:= ' where (((ie_classif_fluxo in (' || chr(39) || 'P' || chr(39) || ', ' || chr(39) || 'R' || chr(39) || ')) and ' ||
                            '   (dt_referencia = to_date(' || chr(39) || to_char(fim_mes(dt_referencia_p), 'dd/mm/yyyy') || chr(39) ||  ', '  ||  chr(39) || 'dd/mm/yyyy' || chr(39) || ' ))) or ' ||
                            '   ((ie_classif_fluxo = ' ||
                            ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(fim_mes(dt_referencia_p), 'dd/mm/yyyy')
                            || chr(39) ||  ', '  ||
                            chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || 
                            chr(39) || 'R' || chr(39) || ',' || chr(39) || 'P' || chr(39) || '))))';

            elsif	(ie_passado_real_w = 'S' AND ie_periodo_p <> 'M') or (coalesce(ie_classif_p,'-1') = 'RPR') then

                ds_sql_where_w	:= ' where ((ie_classif_fluxo = ' ||
                        ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy')
                        || chr(39) ||  ', '  ||
                        chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || 
                        chr(39) || 'R' || chr(39) || ',' || chr(39) || 'P' || chr(39) || ')) or ' || 
                        ' (dt_referencia = to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', '  || 
                        chr(39) || 'dd/mm/yyyy' || chr(39) || ' )))';

            end if;

            begin

            ds_comando_w	:= 	'create or replace view fluxo_caixa_v as ' ||
                        ' select cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||')) ds_moeda, ' || vl_fluxo_w ||
                        ' from fluxo_caixa a ' ||
                        ds_sql_where_w ||
                        '   and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                        ' and ((a.ie_classif_fluxo	= ''O'' AND	(			
                            (			 
                                (NVL( ' || chr(39) || ie_restringe_estab_p  || chr(39) || ',''E'') = ''E'') AND  
                                (a.cd_estabelecimento	= ' ||  cd_estabelecimento_p || ')
                            ) OR						       	
                            (						       
                                (NVL(' || chr(39) ||ie_restringe_estab_p|| chr(39) ||',''E'') = ''S'') AND  
                            (
                                (a.cd_estabelecimento	= '||cd_estabelecimento_p|| ') OR
                                (obter_estab_financeiro(a.cd_estabelecimento) = '|| cd_estabelecimento_p || ')
                            )
                            ) OR
                            (
                                (NVL( ' || chr(39) || ie_restringe_estab_p || chr(39) || ',''E'') = ''N'')
                            )
                            )		
                        ) OR ( a.ie_classif_fluxo	<> ''O'' AND cd_estabelecimento = ' || cd_estabelecimento_p || 
                    ' )) and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                        ds_datas_w ||
                        '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                        ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')) ' ||
                        ds_nivel_w || ' Group By cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||'))';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        end if;
    else
    if (ie_periodo_p	= 'D') then
        dt_fluxo_w	:= trunc(dt_inicio_p, 'dd');

        contador_w	:= 1;

        while dt_fluxo_w <= dt_final_p LOOP
            begin
            
            begin

            
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) || 
                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 
                        'dd/mm/yyyy' || chr(39) || ')' || ',decode(ie_classif_fluxo,' || chr(39) ||
                        'P' || chr(39) || ', vl_fluxo, 0),0)) ' || 
                        'P' || contador_w;

            virgula_w	:= ',';

            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 
                        'dd/mm/yyyy' || chr(39) || ')' || ',decode(ie_classif_fluxo,' || chr(39) ||
                        'R' || chr(39) || ', vl_fluxo, 0),0)) ' || 
                        'R' || contador_w;

            dt_fluxo_w	:= dt_fluxo_w + 1;
            contador_w	:= contador_w + 1;

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;

            end;
        END LOOP;

        select	coalesce(max(length(CD_CONTA_APRES)), 9)
        into STRICT	qt_nivel_w
        from	conta_financeira;

        if (qt_nivel_w = 9) then --00.00.000
            if (ie_nivel_p = 3) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 15) then --00.00.00.00.000
            if (ie_nivel_p = 5) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,13,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 12) then --00.00.00.000
            if (ie_nivel_p = 4) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;		
        else --00.00.00.00.00.000
            if (ie_nivel_p = 6) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';						
                elsif (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 13, 2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 5) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 16, 3) = ' ||
                            chr(39) || '000' || chr(39) || ')';											
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        end if;

        begin

        ds_comando_w	:= 	' create or replace view fluxo_caixa_v as ' ||
                    ' select cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||')) ds_moeda, ' || vl_fluxo_w ||
                    ' from fluxo_caixa a ' ||
                    ' where ie_classif_fluxo in (' || chr(39) || 'P' || chr(39) || ',' || chr(39) || 'R' || chr(39) || ') ' ||
                    ' and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                    ' and ((a.ie_classif_fluxo	= ''O'' AND	(			
                            (			 
                                (NVL( ' || chr(39) || ie_restringe_estab_p  || chr(39) || ',''E'') = ''E'') AND  
                                (a.cd_estabelecimento	= ' ||  cd_estabelecimento_p || ')
                            ) OR						       	
                            (						       
                                (NVL(' || chr(39) ||ie_restringe_estab_p|| chr(39) ||',''E'') = ''S'') AND  
                            (
                                (a.cd_estabelecimento	= '||cd_estabelecimento_p|| ') OR
                                (obter_estab_financeiro(a.cd_estabelecimento) = '|| cd_estabelecimento_p || ')
                            )
                            ) OR
                            (
                                (NVL( ' || chr(39) || ie_restringe_estab_p || chr(39) || ',''E'') = ''N'')
                            )
                            )		
                        ) OR ( a.ie_classif_fluxo	<> ''O'' AND cd_estabelecimento = ' || cd_estabelecimento_p || 
                    ' ))and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                    ' and dt_referencia between ' || 
                    '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                        chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                    ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                        chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' ||
                    ds_nivel_w || ' Group By cd_conta_financ, obter_ds_moeda_estrangeira(nvl(cd_moeda,'||cd_moeda_empresa_w||'))';

        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
        end;	

        end if;
    end if;

else

--Holding


    /* Obter a conta de Saldo */


    /* Ao contrário da rotina padrão, removemos a condição do ie_passado_real 
    e adotamos o ie_passado_real_w como padrão para todos os estabelecimentos 
    espelhados com o estabelecimento logado  */
    select	ie_passado_real
    into STRICT ie_passado_real_w
    from Parametro_Fluxo_caixa
    where cd_estabelecimento = cd_estabelecimento_p;

    if (coalesce(cd_estab_grupo_p, '0') = '0') then
        if (coalesce(cd_empresa_grupo_p, '0') <> '0') then

            for r1 in ( SELECT cd_estabelecimento
                            from estabelecimento
                            where  1=1
                            and obter_se_contido(cd_empresa, cd_empresa_grupo_p) = 'S')
                loop

                    if (coalesce(cd_estabelecimentos_w::text, '') = '') then 
                        cd_estabelecimentos_w := r1.cd_estabelecimento;	
                    else
                        cd_estabelecimentos_w := cd_estabelecimentos_w || ',' || r1.cd_estabelecimento;	
                    end if;

                end loop;

        end if;

    else
        cd_estabelecimentos_w:= cd_estab_grupo_p;
    end if;

    /* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */


    -- select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')

    -- into	cd_moeda_empresa_w

    -- from 	dual;
    if (ie_periodo_p	= 'D') and
        ((dt_final_p - dt_inicio_p) > 366) then
        /*Periodo Superior a 366 dias*/

        CALL wheb_mensagem_pck.exibir_mensagem_abort(235399);
    end if;
    if (ie_nivel_p	> 6) or (ie_nivel_p = 0) then
        /*O Nivel deve ser de 1 a 6*/

        CALL wheb_mensagem_pck.exibir_mensagem_abort(235400);
    end if;

    CALL Exec_sql_Dinamico('Tasy', 'drop view Fluxo_Caixa_v');

    if (coalesce(ie_classif_p, '-1')	<> 'C') then

        if (ie_periodo_p	= 'M') then
            dt_fluxo_w		:= last_Day(trunc(dt_inicio_p, 'dd'));
        else
            dt_fluxo_w		:= trunc(dt_inicio_p, 'dd');
        end if;

        contador_w		:= 1;
        while dt_fluxo_w <= dt_final_p LOOP
            begin

            if (coalesce(ie_classif_p, '-1') not in ('PRM','RRM','RM','RPR')) or 	 /* forçar somente dias uteis qdo RM   */
                (trunc(obter_proximo_dia_util(cd_estabelecimento_p, dt_fluxo_w), 'dd') = trunc(dt_fluxo_w, 'dd')) then



                if (coalesce(ie_classif_p,'-1') in ('PRM','RRM','RM','RPR')) then /* Se a geração é de relatório mensal */
                    ds_data_w		:= to_char(contador_w);
                    contador_w		:= contador_w + 1;

                    if (ie_passado_real_w = 'S') and (ie_periodo_p = 'D') and (coalesce(ie_classif_p, '-1') = 'RPR') and (trunc(dt_fluxo_w, 'dd') = trunc(dt_referencia_p, 'dd')) then /* ahoffelder - OS 310509 - 13/04/2011 */
                        begin

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'P' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w;
                        virgula_w	:= ',';
                        ds_data_w	:= to_char(contador_w);
                        contador_w	:= contador_w + 1;
                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'R' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w;

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;		

                    else

                        begin

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia, to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                'D' || ds_data_w;

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;					


                    end if;

                else
                    if (coalesce(ie_classif_p, '-1') in ('PGRM','RGRM','PRGMRM')) then
                        ds_data_w		:= to_char(dt_fluxo_w,'dd');
                    else
                        ds_data_w		:= to_char(dt_fluxo_w,'ddmmyyyy');
                    end if;

                    -- Edgar 04/12/2007, OS 74953
                    if (ie_passado_real_w = 'S') and
                        (((trunc(dt_fluxo_w, 'dd') = trunc(dt_referencia_p, 'dd')) or
                        ((ie_periodo_p	= 'M') and (trunc(dt_fluxo_w, 'month') = trunc(dt_referencia_p, 'month'))))) then

                        begin 

                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'P' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w || 'P ';
                        virgula_w	:= ',';
                        vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                'dd/mm/yyyy' || chr(39) || '), decode(ie_classif_fluxo, ' || chr(39) ||  'R' || chr(39) ||
                                ', vl_fluxo, 0),0)) ' ||
                                'D' || ds_data_w || 'R';

                        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                            /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                            CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                        end;							

                    else
                        if (coalesce(ie_classif_p,'1')	<> 'POM') then

                            begin
                        
                            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                                    'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                    to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                    'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                    'D' || ds_data_w;

                            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                            end;						

                        else
                        
                            begin
                        
                            vl_fluxo_w	:=  	vl_fluxo_w || virgula_w ||
                                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) ||
                                        'dd/mm/yyyy' || chr(39) || ')' || ',vl_fluxo,0)) ' ||
                                        'P' || ds_data_w || ', ' ||
                                        ' max(OBTER_VALOR_FLUXO_ORCADO( a.cd_estabelecimento, ' ||
                                        ' a.cd_conta_financ,' ||
                                        ' add_months(to_date(' || chr(39) || to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),0), ' ||
                                        ' to_date(' || chr(39) || to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || ' obter_empresa_estab(a.cd_estabelecimento) ' || chr(39) || ', ' || chr(39) || ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ')) O' || ds_data_w;

                            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                            end;		

                        end if;

                    end if;
                end if;

                virgula_w	:= ',';

            end if;

            if (ie_periodo_p	= 'M') then
                begin
                dt_fluxo_w		:= add_months(dt_fluxo_w, 1);
                dt_fluxo_w		:= last_Day(trunc(dt_fluxo_w, 'dd'));
                end;
            else
                dt_fluxo_w		:= dt_fluxo_w + 1;
            end if;

            end;
        END LOOP;

        if (coalesce(ie_classif_p, '-1') in ('PGRM','RGRM','PRGMRM')) then

            -- Edgar 30/11/2007, OS 75728, tratar todais das CFs de saldo
            begin
            
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'SUM(decode(	cd_conta_financ, ' ||
                                    ' b.cd_conta_financ_sant ' || ', ' ||
                                        ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                    'b.cd_conta_financ_saldo' || ', ' ||
                                        ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                            ' decode(CD_CONTA_FINANC, ' || 'b.cd_conta_financ_saldo' || ', 0, '
                                || ' b.cd_conta_financ_sant ' || ', 0, vl_fluxo))) Total ';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        else
        
            begin
        
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                            ' decode(obter_se_totaliza_cf(cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ',decode(obter_se_acumula_cf(cd_conta_financ),' || chr(39) || 'S' || chr(39) || ', ' ||
                                            'obter_valor_final_fluxo( a.cd_estabelecimento, ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '3,
                                                        cd_conta_financ),
                                    decode(CD_CONTA_FINANC, ' ||
                                    ' b.cd_conta_financ_saldo ' || ', ' ||
                                            'obter_valor_fluxo_saldo( a.cd_estabelecimento, ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    ' b.cd_conta_financ_sant ' || ', ' ||
                                            'obter_valor_fluxo_saldo( a.cd_estabelecimento, ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    'sum(vl_fluxo))),  0) Total';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;

        end if;


        /* Edgar 02/08/2004 - OS 9996, tratamento do 4º nível da conta */

        select	coalesce(max(length(CD_CONTA_APRES)), 9)
        into STRICT	qt_nivel_w
        from	conta_financeira
        where	cd_empresa	= cd_empresa_p;

        if (qt_nivel_w = 9) then --00.00.000
            if (ie_nivel_p = 3) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 15) then --00.00.00.00.000
            if (ie_nivel_p = 5) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,13,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 12) then --00.00.00.000
            if (ie_nivel_p = 4) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;				
        else   --00.00.00.00.00.000
            if (ie_nivel_p = 6) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';						
                elsif (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 13, 2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 5) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 16, 3) = ' ||
                            chr(39) || '000' || chr(39) || ')';											
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        end if;


        /* Edgar 12/07/2005, tratamento do valor orcado no final do fluxo */

        begin
        
        vl_fluxo_w	:=  vl_fluxo_w || virgula_w || 	
                ' OBTER_VALOR_FLUXO_ORCADO( 	 a.cd_estabelecimento, ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || ' obter_empresa_estab(a.cd_estabelecimento) ' || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') vl_orcado ';

        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
        end;

        /* Inclusão do campo "% Orçado x Real" para os fluxos Realizado e A Realizar */

        if (ie_classif_p in ('P','R','PGRM','RGRM')) then
            begin
                /* Cálculo:  ( ( Real - Orçado ) / Orçado) * 100 
                    Cálculo será realizado somente quando houver valor orçado */
                vl_fluxo_w	:=  vl_fluxo_w || virgula_w || 'decode(OBTER_VALOR_FLUXO_ORCADO( a.cd_estabelecimento, a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || ' obter_empresa_estab(a.cd_estabelecimento) ' || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || '),' ||
                                ' 0 , 0 , (((';
                /* Total */

                if (ie_classif_p in ('PGRM','RGRM')) then
                    begin
                        vl_fluxo_w	:= vl_fluxo_w || ' SUM(decode(cd_conta_financ, ' ||
                                        ' b.cd_conta_financ_sant ' || ', ' ||
                                            ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                        ' b.cd_conta_financ_saldo ' || ', ' ||
                                            ' decode(dt_referencia, to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , vl_fluxo, 0), ' ||
                                        ' decode(CD_CONTA_FINANC, ' || ' b.cd_conta_financ_saldo ' || ', 0, '
                                            || ' b.cd_conta_financ_sant ' || ', 0, vl_fluxo))) ';
                    exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                        /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                        CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                    end;
                else
                    begin
                        vl_fluxo_w	:= vl_fluxo_w || ' decode(obter_se_totaliza_cf(cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ',decode(obter_se_acumula_cf(cd_conta_financ),' || chr(39) || 'S' || chr(39) || ', ' ||
                                            'obter_valor_final_fluxo( a.cd_estabelecimento, ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '3,
                                                        cd_conta_financ),
                                    decode(CD_CONTA_FINANC, ' ||
                                    ' b.cd_conta_financ_saldo ' || ', ' ||
                                            'obter_valor_fluxo_saldo( a.cd_estabelecimento,' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    ' b.cd_conta_financ_sant ' || ', ' ||
                                            'obter_valor_fluxo_saldo( a.cd_estabelecimento, ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    'sum(vl_fluxo))),  0) ';
                    exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                        /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                        CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
                    end;
                end if;
                /* Orçado */

                vl_fluxo_w	:= vl_fluxo_w || ' - OBTER_VALOR_FLUXO_ORCADO( 	 a.cd_estabelecimento, ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || ' obter_empresa_estab(a.cd_estabelecimento) ' || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') )';

                vl_fluxo_w	:= vl_fluxo_w || ' / OBTER_VALOR_FLUXO_ORCADO( 	 a.cd_estabelecimento, ' ||
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || ' obter_empresa_estab(a.cd_estabelecimento) ' || ', ' || chr(39) ||ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') )';

                vl_fluxo_w	:= vl_fluxo_w || ' * 100)) pr_orcado_real ';
            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;
        end if;

        /* Edgar 28/11/2006, tratamento do orçado - realizado */

        if (ie_classif_p = 'P') then

            begin
        
            vl_fluxo_w	:=	vl_fluxo_w || virgula_w || ' (OBTER_VALOR_FLUXO_ORCADO(  a.cd_estabelecimento, ' || 
                                ' a.cd_conta_financ,' ||
                                ' to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' ||
                                ' to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || ' obter_empresa_estab(a.cd_estabelecimento) ' || ', ' || chr(39) || ie_restringe_estab_p || chr(39) || ', ' || chr(39) || ie_periodo_p || chr(39) || ') - ' ||
                                ' decode(CD_CONTA_FINANC, ' || ' b.cd_conta_financ_saldo ' || ', ' || 
                                    'obter_valor_fluxo_saldo(  a.cd_estabelecimento, ' || 
                                                        chr(39) || ie_classif_p || chr(39) || ', ' || 
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' || 
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '2), ' ||
                                    ' b.cd_conta_financ_sant ' || ', '|| 
                                    'obter_valor_fluxo_saldo( a.cd_estabelecimento, ' ||
                                                        chr(39) || ie_classif_p || chr(39) || ', ' ||
                                                        chr(39) || ie_periodo_p || chr(39) || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_inicio_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
                                                        'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' ), ' ||
                                                        '1), ' ||
                                    ' sum(vl_fluxo))) * (decode(substr(obter_descricao_padrao(' || chr(39) || 'CONTA_FINANCEIRA' || chr(39) || ',' ||
                                chr(39) || 'IE_OPER_FLUXO' || chr(39) || ',a.cd_conta_financ),1,1),' || chr(39) || 'S' || chr(39) || ',-1,' || chr(39) || 'D' || chr(39) || ',1,decode(substr(obter_descricao_padrao(' || chr(39) || 'CONTA_FINANCEIRA' || chr(39) || ',' ||
                                chr(39) || 'IE_VARIACAO' || chr(39) || ',a.cd_conta_financ),1,1),' || chr(39) || 'S' || chr(39) || ',-1,' || chr(39) || 'D' || chr(39) || ',1,0))) vl_orcado_passado ';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        end if; -- Paulo - OS 45404 - 12/12/2006 - Alterei o comando acima para, se for entrada multiplicar por -1.


        -- Edgar 20/09/20005, OS 22253, Fiz um tratamento para trazer realizado até dt_referencia e a realizar após esta data
        if (ie_periodo_p = 'M') then
            ds_datas_w	:= '   and ((dt_referencia  = last_day(dt_referencia)) and dt_referencia between ';
        else
            ds_datas_w	:= '   and (dt_referencia between ';
        end if;
        if (coalesce(dt_referencia_p::text, '') = '') then	

            begin

            ds_comando_w	:= 'create or replace view fluxo_caixa_v as ' ||
                        ' select cd_conta_financ, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda, '|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||')) ds_moeda, ' || vl_fluxo_w ||
                        ' from fluxo_caixa a, Parametro_Fluxo_caixa b' ||
                        ' where ie_classif_fluxo = ' || chr(39) || substr(ie_classif_p,1,1) || chr(39) ||
                        ' and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                        ' and a.cd_estabelecimento = b.cd_estabelecimento ' ||
                        ' and obter_se_contido(a.cd_estabelecimento, (''' || cd_estabelecimentos_w || ''') ) = ''S''' ||
                        ' and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                        ds_datas_w ||
                        '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                        ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')) ' ||
                        ds_nivel_w || ' Group By cd_conta_financ, b.cd_conta_financ_saldo, b.cd_conta_financ_sant, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda,'|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||'))';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        else
            -- Edgar 04/12/2007, OS 74953
            ds_sql_where_w	:= ' where ie_classif_fluxo = ' ||
                    ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || chr(39) || 'R' || chr(39) || ',' ||
                    chr(39) || 'P' || chr(39) || ')';
            if (ie_passado_real_w = 'S') and (ie_periodo_p = 'M') then

                ds_sql_where_w	:= ' where (((ie_classif_fluxo in (' || chr(39) || 'P' || chr(39) || ', ' || chr(39) || 'R' || chr(39) || ')) and ' ||
                            '   (dt_referencia = to_date(' || chr(39) || to_char(fim_mes(dt_referencia_p), 'dd/mm/yyyy') || chr(39) ||  ', '  ||  chr(39) || 'dd/mm/yyyy' || chr(39) || ' ))) or ' ||
                            '   ((ie_classif_fluxo = ' ||
                            ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(fim_mes(dt_referencia_p), 'dd/mm/yyyy')
                            || chr(39) ||  ', '  ||
                            chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || 
                            chr(39) || 'R' || chr(39) || ',' || chr(39) || 'P' || chr(39) || '))))';

            elsif	(ie_passado_real_w = 'S' AND ie_periodo_p <> 'M') or (coalesce(ie_classif_p,'-1') = 'RPR') then

                ds_sql_where_w	:= ' where ((ie_classif_fluxo = ' ||
                        ' decode(obter_data_maior(dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy')
                        || chr(39) ||  ', '  ||
                        chr(39) || 'dd/mm/yyyy' || chr(39) || ' )) , dt_referencia, ' || 
                        chr(39) || 'R' || chr(39) || ',' || chr(39) || 'P' || chr(39) || ')) or ' || 
                        ' (dt_referencia = to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) ||  ', '  || 
                        chr(39) || 'dd/mm/yyyy' || chr(39) || ' )))';

            end if;

            begin

            ds_comando_w	:= 	'create or replace view fluxo_caixa_v as ' ||
                        ' select cd_conta_financ, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda,'|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||')) ds_moeda, ' || vl_fluxo_w ||
                        ' from fluxo_caixa a, Parametro_fluxo_caixa b ' ||
                        ds_sql_where_w ||
                        '   and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                        ' and a.cd_estabelecimento = b.cd_estabelecimento ' ||
                        ' and obter_se_contido(a.cd_estabelecimento, (''' || cd_estabelecimentos_w || ''') ) = ''S''' ||
                        ' and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                        ds_datas_w ||
                        '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                        ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                            chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')) ' ||
                        ds_nivel_w || ' Group By cd_conta_financ, b.cd_conta_financ_saldo, b.cd_conta_financ_sant, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda,'|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||'))';

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                    /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                    CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;	

        end if;
    else
    if (ie_periodo_p	= 'D') then
        dt_fluxo_w	:= trunc(dt_inicio_p, 'dd');

        contador_w	:= 1;

        while dt_fluxo_w <= dt_final_p LOOP
            begin
            
            begin

            
            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) || 
                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 
                        'dd/mm/yyyy' || chr(39) || ')' || ',decode(ie_classif_fluxo,' || chr(39) ||
                        'P' || chr(39) || ', vl_fluxo, 0),0)) ' || 
                        'P' || contador_w;

            virgula_w	:= ',';

            vl_fluxo_w	:=  vl_fluxo_w || virgula_w ||
                        'sum(decode(dt_referencia,' || 'to_date(' || chr(39) ||
                        to_char(dt_fluxo_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 
                        'dd/mm/yyyy' || chr(39) || ')' || ',decode(ie_classif_fluxo,' || chr(39) ||
                        'R' || chr(39) || ', vl_fluxo, 0),0)) ' || 
                        'R' || contador_w;

            dt_fluxo_w	:= dt_fluxo_w + 1;
            contador_w	:= contador_w + 1;

            exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
            end;

            end;
        END LOOP;

        select	coalesce(max(length(CD_CONTA_APRES)), 9)
        into STRICT	qt_nivel_w
        from	conta_financeira;

        if (qt_nivel_w = 9) then --00.00.000
            if (ie_nivel_p = 3) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 15) then --00.00.00.00.000
            if (ie_nivel_p = 5) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,13,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        elsif (qt_nivel_w = 12) then --00.00.00.000
            if (ie_nivel_p = 4) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,3) = ' ||
                            chr(39) || '000' || chr(39) || ')';
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;		
        else --00.00.00.00.00.000
            if (ie_nivel_p = 6) then
                ds_nivel_w	:= '';
            else
                ds_nivel_w	:= ' and cd_conta_financ in (select y.cd_conta_financ from conta_financeira y ';
                if (ie_nivel_p = 3) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,10,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';						
                elsif (ie_nivel_p = 4) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 13, 2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                elsif (ie_nivel_p = 5) then
                    ds_nivel_w	:= ds_nivel_w || 'where SUBSTR(y.cd_conta_apres, 16, 3) = ' ||
                            chr(39) || '000' || chr(39) || ')';											
                elsif (ie_nivel_p = 2) then
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,7,2) = ' ||
                            chr(39) || '00' || chr(39) || ')';
                else
                    ds_nivel_w	:= ds_nivel_w || 'where substr(y.cd_conta_apres,4,2) = ' ||
                        chr(39) || '00' || chr(39) || ')';
                end if;
            end if;
        end if;

        begin

        ds_comando_w	:= 	' create or replace view fluxo_caixa_v as ' ||
                    ' select cd_conta_financ, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda,'|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||')) ds_moeda, ' || vl_fluxo_w ||
                    ' from fluxo_caixa a, Parametro_Fluxo_caixa b ' ||
                    ' where ie_classif_fluxo in (' || chr(39) || 'P' || chr(39) || ',' || chr(39) || 'R' || chr(39) || ') ' ||
                    ' and a.cd_estabelecimento = b.cd_estabelecimento ' || 
                    ' and obter_se_contido(a.cd_estabelecimento, (''' || cd_estabelecimentos_w || ''') ) = ''S''' ||
                    ' and ie_periodo = ' || chr(39) || ie_periodo_p || chr(39) ||
                    ' and ((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, wheb_usuario_pck.get_nm_usuario, null) =' || chr(39) || 'S' || chr(39) || ') or (ie_origem<>' || chr(39) || 'D' || chr(39) || '))' ||
                    ' and dt_referencia between ' || 
                    '	to_date(' || chr(39) || to_char(dt_inicio_p,'dd/mm/yyyy') || 
                        chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
                    ' and	to_date(' || chr(39) || to_char(dt_final_p,'dd/mm/yyyy') || 
                        chr(39) || ', ' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' ||
                    ds_nivel_w || ' Group By cd_conta_financ, b.cd_conta_financ_saldo, b.cd_conta_financ_sant, a.cd_estabelecimento, obter_ds_moeda_estrangeira(nvl(cd_moeda,'|| ' obter_moeda_padrao_empresa(a.cd_estabelecimento, ''E'') ' ||'))';

        exception when data_exception then /*excessão necessaria pois o tamanho da variavel é de 32000 e está excedendo esse tamanho.*/

                /*Período muito longo para gerar o fluxo de caixa, informe um período menor.*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(347912,'DT_INICIO_P='||DT_INICIO_P||';DT_FINAL_P='||DT_FINAL_P);
        end;	

        end if;
    end if;


end if;

-- Limpa o drill down quando um novo fluxo é gerado 
delete from w_fluxo_item_drilldown
where nm_usuario = wheb_usuario_pck.get_nm_usuario;

commit;

CALL Exec_sql_Dinamico('Tasy', ds_comando_w);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_view_fluxo_caixa ( cd_estabelecimento_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, dt_referencia_p timestamp, ie_periodo_p text, ie_classif_p text, ie_nivel_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, cd_estab_grupo_p text default null, cd_empresa_grupo_p text default null) FROM PUBLIC;

