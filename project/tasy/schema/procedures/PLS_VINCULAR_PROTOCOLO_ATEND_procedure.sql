-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_protocolo_atend ( ie_origem_protocolo_p bigint, nr_seq_segurado_p bigint, nr_protocolo_referencia_p bigint, nr_seq_tabela_origem_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Vincular um protocolo de atendimento em outro protocolo já existente.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/* ie_origem_protocolo_p
	1 - OPS - Autorizações
	2 - OPS - Requisições para autorização
	3 - Atendimento (call center)
	4 - Boletim de ocorrência
*/
qt_protocolo_w			integer;
qt_protocolo_funcao_w		integer;
qt_protocolo_segurado_w		integer;
qt_protocolo_ref_w		integer;


BEGIN

select	count(1)
into STRICT	qt_protocolo_w
from	pls_protocolo_atendimento
where	nr_protocolo		= nr_protocolo_referencia_p;

select	count(1)
into STRICT	qt_protocolo_segurado_w
from	pls_protocolo_atendimento
where	nr_seq_segurado 	= nr_seq_segurado_p
and	nr_protocolo		= nr_protocolo_referencia_p;


if (qt_protocolo_w = 0) then
	-- Número de protocolo inválido. Favor verificar.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(445814);

elsif (qt_protocolo_segurado_w = 0) then
	-- Este protocolo não existe para este beneficiário.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(445821);

else
	if (ie_origem_protocolo_p = 1) then
		select	count(1)
		into STRICT	qt_protocolo_ref_w
		from	pls_protocolo_atendimento
		where	nr_seq_guia	= nr_seq_tabela_origem_p
		and	(nr_protocolo_referencia IS NOT NULL AND nr_protocolo_referencia::text <> '');

		if (qt_protocolo_ref_w = 0) then
			update	pls_protocolo_atendimento
			set	nr_protocolo_referencia		= nr_protocolo_referencia_p,
				nm_usuario			= nm_usuario_p,
				dt_atualizacao			= clock_timestamp()
			where	nr_seq_guia			= nr_seq_tabela_origem_p;

			CALL pls_guia_gravar_historico(nr_seq_tabela_origem_p, 2, 'O usuário '||nm_usuario_p||' vinculou esta guia com o protocolo de atendimento '||nr_protocolo_referencia_p||'.', null, nm_usuario_p);
		else
			--Esta guia já possui protocolo de referência informado!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(446069);
		end if;
	elsif (ie_origem_protocolo_p = 2) then
		select	count(1)
		into STRICT	qt_protocolo_ref_w
		from	pls_protocolo_atendimento
		where	nr_seq_requisicao	= nr_seq_tabela_origem_p
		and	(nr_protocolo_referencia IS NOT NULL AND nr_protocolo_referencia::text <> '');

		if (qt_protocolo_ref_w = 0) then
			update	pls_protocolo_atendimento
			set	nr_protocolo_referencia		= nr_protocolo_referencia_p,
				nm_usuario			= nm_usuario_p,
				dt_atualizacao			= clock_timestamp()
			where	nr_seq_requisicao		= nr_seq_tabela_origem_p;

			CALL pls_requisicao_gravar_hist(nr_seq_tabela_origem_p,'L','O usuário '||nm_usuario_p||' vinculou esta requisição com o protocolo de atendimento '||nr_protocolo_referencia_p||'.','',nm_usuario_p);
		else
			--Esta requisição já possui protocolo de referência informado!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(446070);
		end if;
	elsif (ie_origem_protocolo_p = 4) then
		select	count(1)
		into STRICT	qt_protocolo_ref_w
		from	pls_protocolo_atendimento
		where	nr_seq_boletim_ocor	= nr_seq_tabela_origem_p
		and	(nr_protocolo_referencia IS NOT NULL AND nr_protocolo_referencia::text <> '');

		if (qt_protocolo_ref_w = 0) then
			update	pls_protocolo_atendimento
			set	nr_protocolo_referencia		= nr_protocolo_referencia_p,
				nm_usuario			= nm_usuario_p,
				dt_atualizacao			= clock_timestamp()
			where	nr_seq_boletim_ocor		= nr_seq_tabela_origem_p;
		else
			--Este boletim já possui protocolo de referência informado!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(446073);
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_protocolo_atend ( ie_origem_protocolo_p bigint, nr_seq_segurado_p bigint, nr_protocolo_referencia_p bigint, nr_seq_tabela_origem_p bigint, nm_usuario_p text) FROM PUBLIC;

