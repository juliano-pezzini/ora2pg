-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gap_vincular_os_requisito ( nr_seq_requisito_p LATAM_REQUISITO.NR_SEQ_REQUISITO%type, nr_seq_ordem_serv_p LATAM_REQUISITO.NR_SEQ_ORDEM_SERV%type, nm_usuario_p LATAM_REQUISITO.NM_USUARIO%type, ie_classificacao_p LATAM_REQUISITO.IE_CLASSIFICACAO%type default null) AS $body$
DECLARE


dt_atualizacao_w    CONSTANT latam_requisito_os.dt_atualizacao%type := clock_timestamp();
nm_usuario_nrec_w   CONSTANT latam_requisito_os.nm_usuario_nrec%type := wheb_usuario_pck.get_nm_usuario;
ie_exists_w         smallint := 0;
ie_valid_w          smallint := 0;
ie_classificacao_w  latam_requisito_os.ie_tipo_os%type;


BEGIN

select  count(nr_sequencia)
into STRICT    ie_exists_w
from    latam_requisito_os
where   nr_seq_requisito    = nr_seq_requisito_p
and     nr_seq_ordem_serv   = nr_seq_ordem_serv_p;

select count(nr_sequencia) valid
into STRICT ie_valid_w
from man_ordem_servico
where nr_sequencia = nr_seq_ordem_serv_p;

IF (ie_classificacao_p = 1) THEN
select max(ie_tipo_os)
into STRICT ie_classificacao_w
from latam_requisito_os
where nr_seq_requisito = nr_seq_requisito_p
and ie_tipo_os <= '1';

IF (ie_classificacao_w = 1) THEN
CALL wheb_mensagem_pck.exibir_mensagem_abort(1198266);
END IF;
END IF;

IF (ie_exists_w = 0 AND ie_valid_w != 0) THEN

    IF (coalesce(ie_classificacao_p, 0) = 1) THEN
      update    latam_requisito
      set       nr_seq_ordem_serv = nr_seq_ordem_serv_p
      where     nr_sequencia      = nr_seq_requisito_p;
    END IF;

    insert into latam_requisito_os(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        nm_usuario_nrec,
        nr_seq_requisito,
        nr_seq_ordem_serv,
        ie_tipo_os
    ) values (
        nextval('latam_requisito_os_seq'),
        dt_atualizacao_w,
        nm_usuario_p,
        nm_usuario_nrec_w,
        nr_seq_requisito_p,
        nr_seq_ordem_serv_p,
        ie_classificacao_p
    );
ELSIF (ie_valid_w = 0 ) THEN
        CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(1088830);
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gap_vincular_os_requisito ( nr_seq_requisito_p LATAM_REQUISITO.NR_SEQ_REQUISITO%type, nr_seq_ordem_serv_p LATAM_REQUISITO.NR_SEQ_ORDEM_SERV%type, nm_usuario_p LATAM_REQUISITO.NM_USUARIO%type, ie_classificacao_p LATAM_REQUISITO.IE_CLASSIFICACAO%type default null) FROM PUBLIC;

