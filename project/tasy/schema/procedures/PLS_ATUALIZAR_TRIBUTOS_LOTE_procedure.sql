-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_tributos_lote ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_titulo_w			bigint;
nr_titulo_imposto_w		bigint;
nr_seq_prestador_w		bigint;
dt_base_venc_w			timestamp;
qt_imposto_mes_w		integer	:= 0;
ie_mes_fechado_w		varchar(5);

C01 CURSOR FOR 
	SELECT	b.nr_titulo, 
		a.nr_seq_prestador, 
		a.dt_mes_competencia 
	from	titulo_pagar		b, 
		pls_lote_protocolo	a 
	where	a.nr_sequencia		= b.nr_seq_lote_res_pls 
	and	a.nr_sequencia		= nr_seq_lote_p 
	and	b.ie_tipo_titulo <> '4' 
	and	b.ie_situacao	= 'A' 
	
union
 
	SELECT	c.nr_titulo, 
		a.nr_seq_prestador, 
		a.dt_mes_competencia 
	from	pls_lote_protocolo	a, 
		nota_fiscal 		b, 
		titulo_pagar 		c 
	where	a.nr_sequencia		= b.nr_seq_lote_res_pls 
	and	b.nr_sequencia  	= c.nr_seq_nota_fiscal 
	and	a.nr_sequencia  	= nr_seq_lote_p 
	and	c.ie_tipo_titulo <> '4' 
	and	c.ie_situacao	= 'A';

C02 CURSOR FOR 
	SELECT	substr(Obter_Titulo_Imposto(nr_sequencia),1,10) 
	from	titulo_pagar_imposto 
	where	nr_titulo    = nr_titulo_w;


BEGIN 
 
select	pls_obter_se_mes_fechado(dt_mes_competencia,'T', cd_estabelecimento_p) 
into STRICT	ie_mes_fechado_w 
from	pls_lote_protocolo 
where	nr_sequencia	= nr_seq_lote_p;
 
if (ie_mes_fechado_w	= 'S') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267205, null ); /* O mês de competência ou contabilidade do mês está fechado. Verifique! */
end if;
 
open C01;
loop 
fetch C01 into 
	nr_titulo_w, 
	nr_seq_prestador_w, 
	dt_base_venc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	open C02;
	loop 
	fetch C02 into 
		nr_titulo_imposto_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		delete	from titulo_pagar 
		where	nr_titulo = nr_titulo_imposto_w;
		end;
	end loop;
	close C02;
	 
	delete	from titulo_pagar_imposto 
	where	nr_titulo = nr_titulo_w;
	 
	CALL atualizar_saldo_tit_pagar(nr_titulo_w,nm_usuario_p);
	CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w, nm_usuario_p);
	 
	select	count(*) 
	into STRICT	qt_imposto_mes_w 
	from	pls_prestador_tributo 
	where	nr_seq_prestador		= nr_seq_prestador_w 
	and	trunc(dt_referencia,'month')	= trunc(dt_base_venc_w, 'month');
	 
	if (qt_imposto_mes_w > 0) then 
		CALL pls_gerar_tributo_retido(nr_seq_lote_p, nr_titulo_w, nm_usuario_p);
	end if;
	 
	commit;
	 
	CALL gerar_tributo_titulo(	nr_titulo_w, 
				nm_usuario_p, 
				'N', -- ie_baixa_titulo_p 
				null, -- nr_bordero_p 
				null, -- dt_baixa_bordero_p 
				null, -- nr_seq_escrit_p 
				null, -- dt_baixa_escrit_p 
				null, --dt_baixa_p 
				cd_estabelecimento_p, 
				null);
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_tributos_lote ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

