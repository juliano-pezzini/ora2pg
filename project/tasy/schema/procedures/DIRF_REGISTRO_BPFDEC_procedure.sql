-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_bpfdec (nr_seq_lote_p bigint, cd_dirf_p text, nm_usuario_p text, nr_seq_posicao_p bigint, nr_seq_apres_p INOUT bigint) AS $body$
DECLARE

			    
dt_lote_w		timestamp;
vl_min_ano_pf_w		double precision;
cd_pessoa_fisica_w	varchar(15);
nm_pessoa_fisica_w	varchar(255);
nr_cpf_w		varchar(100);
ds_arquivo_w		varchar(2000);
separador_w		varchar(1) := '|';
nr_seq_apres_w		bigint;
cd_estabelecimento_w	varchar(10);
			
 
C01 CURSOR FOR 
	SELECT	distinct 
		p.cd_pessoa_fisica, 
		f.nr_cpf, 
		f.nm_pessoa_fisica 
	FROM pessoa_fisica f, titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto j ON (p.nr_titulo = j.nr_titulo)
WHERE p.cd_pessoa_fisica = f.cd_pessoa_fisica and trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') and (p.cd_pessoa_fisica IS NOT NULL AND p.cd_pessoa_fisica::text <> '') and CASE WHEN j.cd_darf='588' THEN '0588'  ELSE coalesce(j.cd_darf,'0588') END  = cd_dirf_p and p.ie_situacao <> 'C' and p.ie_tipo_titulo in (SELECT z.ie_tipo_titulo from dirf_regra_tipo_tit z) and ( (p.cd_estabelecimento = coalesce(cd_estabelecimento_w,p.cd_estabelecimento)) 
	or	 ((coalesce(p.cd_estabelecimento::text, '') = '') and (coalesce(cd_estabelecimento_w::text, '') = ''))) --and	p.ie_tipo_titulo in ('0','11','13','5') 
  and p.vl_titulo >= coalesce(vl_min_ano_pf_w,6000) 
	 
union
 
	select	distinct 
		a.cd_pessoa_fisica, 
		e.nr_cpf, 
		e.nm_pessoa_fisica 
	from	titulo_pagar a, 
		titulo_pagar_imposto i, 
		pessoa_fisica e 
	where	a.nr_titulo = i.nr_titulo 
	and	a.cd_pessoa_fisica = e.cd_pessoa_fisica 
	and	trunc(a.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	CASE WHEN i.cd_darf='588' THEN '0588'  ELSE coalesce(i.cd_darf,'0588') END  = cd_dirf_p 
	and	a.ie_tipo_titulo in (select z.ie_tipo_titulo from dirf_regra_tipo_tit z) 
	--and	a.ie_tipo_titulo in ('0','11','13','5') 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and	a.ie_situacao <> 'C' 
	and	( (a.cd_estabelecimento = coalesce(cd_estabelecimento_w,a.cd_estabelecimento)) 
	or	 ((coalesce(a.cd_estabelecimento::text, '') = '') and (coalesce(cd_estabelecimento_w::text, '') = ''))) 
	and	a.vl_titulo < coalesce(vl_min_ano_pf_w,6000) 
	
union
 
	select	distinct 
		p.cd_pessoa_fisica, 
		t.nr_cpf, 
		t.nm_pessoa_fisica 
	from	dirf_lote a, 
		gps d, 
		gps_titulo e, 
		titulo_pagar p,  
		titulo_pagar f,  
		pessoa_fisica t 
	where	a.nr_sequencia 	= d.nr_seq_dirf 
	and	d.nr_sequencia 	= e.nr_seq_gps 
	and	f.nr_titulo	= e.nr_titulo 
	and	p.cd_pessoa_fisica = t.cd_pessoa_fisica 
	and	f.nr_titulo_original = p.nr_titulo 
	and	trunc(f.dt_liquidacao,'YYYY') = trunc(dt_lote_w,'YYYY') 
	and	a.nr_sequencia = nr_seq_lote_p 
	and	lpad(cd_dirf_p,4,'0') = '0588' 
	order by nr_cpf;	
			    
 

BEGIN 
 
nr_seq_apres_w := nr_seq_posicao_p;
 
select 	coalesce(dt_lote,clock_timestamp()), 
	coalesce(vl_min_ano_pf,6000), 
	cd_estabelecimento 
into STRICT	dt_lote_w, 
	vl_min_ano_pf_w, 
	cd_estabelecimento_w 
from	dirf_lote 
where	nr_sequencia = nr_seq_lote_p;
 
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	cd_pessoa_fisica_w, 
	nr_cpf_w, 
	nm_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_arquivo_w := 'BPFDEC' || separador_w || lpad(nr_cpf_w,11,'0') || separador_w || ELIMINA_CARACTERE_ESPECIAL(substr(nm_pessoa_fisica_w,1,60)) || separador_w || separador_w;
	nr_seq_apres_w := nr_seq_apres_w + 1;
	insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro, 
				   cd_darf) 
	values (nextval('w_dirf_arquivo_seq'), 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   ds_arquivo_w, 
				   to_char(nr_seq_apres_w), 
				   0, 
				   cd_dirf_p);
	commit;
	nr_seq_apres_w := nr_seq_apres_w + 1;
	-- inserir dados referente a pessoa fisica. Valores mensais de impostos e rendimentos 
	nr_seq_apres_w := DIRF_REGISTRO_VAL_MENSAIS_PF(cd_pessoa_fisica_w, cd_dirf_p, dt_lote_w, nm_usuario_p, nr_seq_apres_w, nr_seq_apres_w, cd_estabelecimento_w);
	 
	if (lpad(cd_dirf_p,4,'0') = '0588') then 
		nr_seq_apres_w := DIRF_REGISTRO_RTPO_PF(nr_seq_lote_p, cd_pessoa_fisica_w, cd_dirf_p, dt_lote_w, nm_usuario_p, nr_seq_apres_w, nr_seq_apres_w);
	end if;
 
 
END LOOP;
CLOSE C01;
 
 
 
	 
 
commit;
nr_seq_apres_p := nr_seq_apres_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_bpfdec (nr_seq_lote_p bigint, cd_dirf_p text, nm_usuario_p text, nr_seq_posicao_p bigint, nr_seq_apres_p INOUT bigint) FROM PUBLIC;

