-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_importar_w_imp_pat_bem ( ds_conteudo_p text, qt_bem_p INOUT bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Importar/excluir os registros de bens importados
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
	IE_OPCAO_P
		G - Gerar
		D - Desfazer
-------------------------------------------------------------------------------------------------------------------

Referencias:
	Controle de patrimonio - 107983
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_estabelecimento_w		smallint;
cd_bem_w			varchar(20);
ds_bem_w			varchar(255);
dt_aquisicao_w			timestamp;
dt_inicio_uso_w			timestamp;
nr_seq_tipo_w			bigint;
nr_seq_local_w			bigint;
ie_imobilizado_w		varchar(1);
ie_situacao_w			varchar(1);
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		integer;
ie_tipo_valor_w			varchar(3);
tx_deprec_w			double precision;
tx_fiscal_w			double precision;
cd_cgc_w			varchar(14);
nr_nota_fiscal_w		varchar(255);
nr_seq_adicao_w			bigint;
ds_serie_w			varchar(40);
cd_pessoa_fisica_w		varchar(10);
vl_original_w			double precision;
nr_seq_marca_w			bigint;
ie_subvencao_w			varchar(1);
dt_garantia_w			timestamp;
ds_observacao_w			varchar(4000);
nr_seq_crit_rateio_w		bigint;
cd_bem_externo_w		varchar(20);
vl_residual_w			double precision;
ie_propriedade_w		varchar(15);
vl_mercado_w			double precision;
nr_seq_regra_conta_w		bigint;
qt_tempo_vida_util_w		bigint;
dt_valor_w			timestamp;
vl_base_deprec_w		double precision;
vl_contabil_w			double precision;
vl_deprec_acum_w		double precision;
vl_deprec_mes_w			double precision;
cd_moeda_w			integer;
nr_seq_nota_fiscal_w		bigint;
nr_seq_princ_w			bigint;

ds_conteudo_w			varchar(8000);
nr_posicao_w			bigint;
qt_registro_w			bigint	:= 0;
ds_valor_w			varchar(8000);
ds_erro_w			varchar(4000);
nm_coluna_w			varchar(2000);
cd_bem_superior_w		varchar(20);
nr_linha_w			w_imp_pat_bem.nr_linha%type;
cd_empresa_obtida  	empresa.cd_empresa%type;
cd_empresa_w  		empresa.cd_empresa%type;


BEGIN

cd_empresa_obtida	:= obter_empresa_estab(cd_estabelecimento_p);

if (ie_opcao_p = 'G') then
	begin
	ds_conteudo_w	:= ds_conteudo_p;

	while(qt_registro_w <= 37) loop
		begin
		nr_posicao_w	:= position(';' in ds_conteudo_w);
		ds_valor_w	:= substr(ds_conteudo_w, 1, nr_posicao_w -1);

		if (qt_registro_w = 0) then
			nm_coluna_w		:= 'CD_ESTABELECIMENTO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				cd_estabelecimento_w	:= (substr(ds_valor_w,1,4))::numeric;
			end if;
		elsif (qt_registro_w = 1) then
			nm_coluna_w		:= 'CD_BEM';
			cd_bem_w		:= substr(ds_valor_w,1,20);
		elsif (qt_registro_w = 2) then
			nm_coluna_w		:= 'DS_BEM';
			ds_bem_w		:= substr(ds_valor_w,1,255);
		elsif (qt_registro_w = 3) then
			nm_coluna_w		:= 'DT_AQUISICAO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				dt_aquisicao_w		:= to_date(substr(ds_valor_w,1,10), 'dd/MM/yyyy');
			end if;
		elsif (qt_registro_w = 4) then
			nm_coluna_w		:= 'DT_INICIO_USO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				dt_inicio_uso_w		:= to_date(substr(ds_valor_w,1,10), 'dd/MM/yyyy');
			end if;
		elsif (qt_registro_w = 5) then
			nm_coluna_w		:= 'NR_SEQ_TIPO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_tipo_w		:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 6) then
			nm_coluna_w		:= 'NR_SEQ_LOCAL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_local_w		:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 7) then
			nm_coluna_w		:= 'IE_IMOBILIZADO';
			ie_imobilizado_w	:= substr(ds_valor_w,1,1);
		elsif (qt_registro_w = 8) then
			nm_coluna_w		:= 'IE_SITUACAO';
			ie_situacao_w		:= substr(ds_valor_w,1,1);
		elsif (qt_registro_w = 9) then
			nm_coluna_w		:= 'CD_CENTRO_CUSTO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				cd_centro_custo_w	:= (substr(ds_valor_w,1,8))::numeric;
			end if;
		elsif (qt_registro_w = 10) then
			nm_coluna_w		:= 'CD_CONTA_CONTABIL';
			cd_conta_contabil_w	:= substr(ds_valor_w,1,20);
		elsif (qt_registro_w = 11) then
			nm_coluna_w		:= 'IE_TIPO_VALOR';
			ie_tipo_valor_w		:= substr(ds_valor_w,1,3);
		elsif (qt_registro_w = 12) then
			nm_coluna_w		:= 'TX_DEPREC';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				tx_deprec_w		:= to_number(substr(ds_valor_w,1,11) || ',' || substr(ds_valor_w,12,4),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 13) then
			nm_coluna_w		:= 'TX_FISCAL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				tx_fiscal_w		:= to_number(substr(ds_valor_w,1,11) || ',' || substr(ds_valor_w,12,4),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 14) then
			nm_coluna_w		:= 'CD_CGC';
			cd_cgc_w		:= substr(ds_valor_w,1,14);
		elsif (qt_registro_w = 15) then
			nm_coluna_w		:= 'NR_NOTA_FISCAL';
			nr_nota_fiscal_w	:= substr(ds_valor_w,1,255);
		/*elsif	(qt_registro_w = 16) then
			nm_coluna_w		:= 'NR_SEQ_NOTA_FISCAL';
			
			if	(ds_valor_w is not null) then
				nr_seq_nota_fiscal_w	:= to_number(substr(ds_valor_w,1,10));
			end if;*/
		elsif (qt_registro_w = 16) then
			nm_coluna_w		:= 'NR_SEQ_ADICAO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_adicao_w		:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 17) then
			nm_coluna_w		:= 'DS_SERIE';
			ds_serie_w		:= substr(ds_valor_w,1,40);
		elsif (qt_registro_w = 18) then
			nm_coluna_w		:= 'CD_PESSOA_FISICA';
			cd_pessoa_fisica_w	:= substr(ds_valor_w,1,10);
		elsif (qt_registro_w = 19) then
			nm_coluna_w		:= 'CD_BEM_SUPERIOR';
			cd_bem_superior_w	:= substr(ds_valor_w,1,20);
		elsif (qt_registro_w = 20) then
			nm_coluna_w		:= 'VL_ORIGINAL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_original_w		:= to_number(substr(ds_valor_w,1,13) || ',' || substr(ds_valor_w,14,2),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 21) then
			nm_coluna_w		:= 'NR_SEQ_MARCA';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_marca_w		:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 22) then
			nm_coluna_w		:= 'CD_MOEDA';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				cd_moeda_w		:= (substr(ds_valor_w,1,5))::numeric;
			end if;
		elsif (qt_registro_w = 23) then
			nm_coluna_w		:= 'IE_SUBVENCAO';
			ie_subvencao_w		:= substr(ds_valor_w,1,1);
		elsif (qt_registro_w = 24) then
			nm_coluna_w		:= 'DT_GARANTIA';
			dt_garantia_w		:= to_date(substr(ds_valor_w,1,10), 'dd/MM/yyyy');
		elsif (qt_registro_w = 25) then
			nm_coluna_w		:= 'DS_OBSERVACAO';
			ds_observacao_w		:= substr(ds_valor_w,1,4000);
		elsif (qt_registro_w = 26) then
			nm_coluna_w		:= 'NR_SEQ_CRIT_RATEIO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_crit_rateio_w	:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 27) then
			nm_coluna_w		:= 'CD_BEM_EXTERNO';
			cd_bem_externo_w	:= substr(ds_valor_w,1,20);
		elsif (qt_registro_w = 28) then
			nm_coluna_w		:= 'VL_RESIDUAL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_residual_w		:= to_number(substr(ds_valor_w,1,13) || ',' || substr(ds_valor_w,14,2),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 29) then
			nm_coluna_w		:= 'IE_PROPRIEDADE';
			ie_propriedade_w	:= substr(ds_valor_w,1,15);
		elsif (qt_registro_w = 30) then
			nm_coluna_w		:= 'VL_MERCADO';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_mercado_w		:= to_number(substr(ds_valor_w,1,13) || ',' || substr(ds_valor_w,14,2),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 31) then
			nm_coluna_w		:= 'NR_SEQ_REGRA_CONTA';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				nr_seq_regra_conta_w	:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 32) then
			nm_coluna_w		:= 'QT_TEMPO_VIDA_UTIL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				qt_tempo_vida_util_w	:= (substr(ds_valor_w,1,10))::numeric;
			end if;
		elsif (qt_registro_w = 33) then
			nm_coluna_w		:= 'DT_VALOR';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				dt_valor_w		:= to_date(substr(ds_valor_w,1,10), 'dd/MM/yyyy');
			end if;
		elsif (qt_registro_w = 34) then
			nm_coluna_w		:= 'VL_BASE_DEPREC';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_base_deprec_w	:= to_number(substr(ds_valor_w,1,18) || ',' || substr(ds_valor_w,19,4),'999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 35) then
			nm_coluna_w		:= 'VL_CONTABIL';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_contabil_w		:= to_number(substr(ds_valor_w,1,18) || ',' || substr(ds_valor_w,19,4),'99999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 36) then
			nm_coluna_w		:= 'VL_DEPREC_ACUM';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_deprec_acum_w	:= to_number(substr(ds_valor_w,1,18) || ',' || substr(ds_valor_w,19,4),'99999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		elsif (qt_registro_w = 37) then
			nm_coluna_w		:= 'VL_DEPREC_MES';
			
			if (ds_valor_w IS NOT NULL AND ds_valor_w::text <> '') then
				vl_deprec_mes_w		:= to_number(substr(ds_valor_w,1,18) || ',' || substr(ds_valor_w,19,4),'99999999999999999999D9999','NLS_NUMERIC_CHARACTERS='',.''');
			end if;
		end if;

		/*
		if	(ds_valor_w is not null) then
			ds_conteudo_w	:= substr(ds_conteudo_w, nr_posicao_w +1, length(ds_conteudo_w));
		end if;
		*/
		
		ds_conteudo_w	:= substr(ds_conteudo_w, nr_posicao_w +1, length(ds_conteudo_w));
		commit;
		
		qt_registro_w	:= qt_registro_w + 1;
		end;
	end loop;

		cd_empresa_w := holding_pck.get_emp_controladora_grupo(cd_grupo_emp_p => 0, cd_empresa_p => obter_empresa_estab(cd_estabelecimento_w));

	if (cd_empresa_obtida = cd_empresa_w or cd_estabelecimento_p = cd_estabelecimento_w) then
		select	max(a.nr_linha)
		into STRICT	nr_linha_w
		from	w_imp_pat_bem	a
		where	cd_estabelecimento	= cd_estabelecimento_p;
		
		nr_linha_w	:= coalesce(nr_linha_w, 0);
		
		nr_linha_w	:= nr_linha_w + 1;
	
		insert into w_imp_pat_bem(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			cd_bem,
			ds_bem,
			dt_aquisicao,
			dt_inicio_uso,
			nr_seq_tipo,
			nr_seq_local,
			ie_imobilizado,
			ie_situacao,
			cd_conta_contabil,
			cd_centro_custo,
			ie_tipo_valor,
			tx_deprec,
			tx_fiscal,
			cd_cgc,
			nr_nota_fiscal,
			nr_seq_adicao,
			ds_serie,
			cd_pessoa_fisica,
			vl_original,
			nr_seq_marca,
			ie_subvencao,
			dt_garantia,
			ds_observacao,
			nr_seq_crit_rateio,
			cd_bem_externo,
			vl_residual,
			ie_propriedade,
			vl_mercado,
			nr_seq_regra_conta,
			qt_tempo_vida_util,
			dt_valor,
			vl_base_deprec,
			vl_contabil,
			vl_deprec_acum,
			vl_deprec_mes,
			cd_moeda,
			cd_bem_superior,
			ie_status_imp,
			nr_linha)
		values (nextval('w_imp_pat_bem_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_w,
			cd_bem_w,
			ds_bem_w,
			dt_aquisicao_w,
			dt_inicio_uso_w,
			nr_seq_tipo_w,
			nr_seq_local_w,
			ie_imobilizado_w,
			ie_situacao_w,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			ie_tipo_valor_w,
			tx_deprec_w,
			tx_fiscal_w,
			cd_cgc_w,
			nr_nota_fiscal_w,
			nr_seq_adicao_w,
			ds_serie_w,
			cd_pessoa_fisica_w,
			vl_original_w,
			nr_seq_marca_w,
			ie_subvencao_w,
			dt_garantia_w,
			ds_observacao_w,
			nr_seq_crit_rateio_w,
			cd_bem_externo_w,
			vl_residual_w,
			ie_propriedade_w,
			vl_mercado_w,
			nr_seq_regra_conta_w,
			qt_tempo_vida_util_w,
			dt_valor_w,
			vl_base_deprec_w,
			vl_contabil_w,
			vl_deprec_acum_w,
			vl_deprec_mes_w,
			cd_moeda_w,
			cd_bem_superior_w,
			'I',
			nr_linha_w);
	end if;
		
	qt_bem_p	:= qt_bem_p + 1;
		
	if (qt_bem_p >= 200) then
		commit;
		
		qt_bem_p	:= 0;
	end if;
	exception
	when others then
		delete	from w_imp_pat_bem;
	
		commit;
	
		ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,4000);
		
		CALL wheb_mensagem_pck.exibir_mensagem_abort(281737, 'NM_COLUNA=' || nm_coluna_w || ';'||
								'DS_VALOR=' || substr(ds_valor_w,1,4000) || ';' ||
								'DS_ERRO=' || ds_erro_w);
	end;
elsif (ie_opcao_p = 'D') then
	delete	from w_imp_pat_bem;
	
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_importar_w_imp_pat_bem ( ds_conteudo_p text, qt_bem_p INOUT bigint, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

