-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_consiste_inter_laudo ( nr_atendimento_p text, ds_mensagem_p INOUT text, ie_permite_lib_p INOUT text) AS $body$
DECLARE

 
 
qt_dias_internacao_w	bigint;
qt_dias_sus_w		bigint;
quebra_w		varchar(20) := chr(13)||chr(10);

BEGIN
ds_mensagem_p	:= '';
qt_dias_internacao_w	:= Obter_Dias_Internacao(nr_atendimento_p);
--qt_dias_sus_w		:=Sus_Obter_Dias_Int_AIH(nr_atendimento_p); 
 
select	coalesce(max(obter_qt_dia_internacao_sus(CD_PROCEDIMENTO_SOLIC, 7)),0) 
into STRICT	qt_dias_sus_w 
from	sus_laudo_paciente a 
where	nr_atendimento	= nr_Atendimento_p 
and	nr_seq_interno	= (	SELECT	min(x.nr_seq_interno) 
				from	sus_laudo_paciente x 
				where	x.nr_atendimento	= a.nr_Atendimento);
 
ie_permite_lib_p	:= 'S';
if (qt_dias_sus_w	<> 0) and (qt_dias_internacao_w	<= qt_dias_sus_w) then 
	ds_mensagem_p:= 'Paciente está internado a '||qt_dias_internacao_w|| ' dia(s). '||quebra_w|| 
			'AIH possui limite de internação de '||qt_dias_sus_w|| ' dia(s)!';
	ie_permite_lib_p	:= 'S';
elsif (qt_dias_sus_w	<> 0) and (qt_dias_internacao_w	> qt_dias_sus_w) then 
	ds_mensagem_p:= 'Paciente está internado a '||qt_dias_internacao_w|| ' dia(s). '||quebra_w|| 
	'AIH possui limite de internação de '||qt_dias_sus_w|| ' dia(s)!'||quebra_w|| 
	'Paciente está internado ' ||(qt_dias_internacao_w - qt_dias_sus_w)|| ' dia(s) a mais.';
	ie_permite_lib_p	:= 'N';
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_consiste_inter_laudo ( nr_atendimento_p text, ds_mensagem_p INOUT text, ie_permite_lib_p INOUT text) FROM PUBLIC;

