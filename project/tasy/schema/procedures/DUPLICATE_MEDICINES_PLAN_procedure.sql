-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicate_medicines_plan ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_plano_versao_w			plano_versao.nr_sequencia%type;
nr_seq_plano_versao_medic_w		plano_versao_medic.nr_sequencia%type;
cd_pessoa_fisica_w			plano_versao.cd_pessoa_fisica%type;
nm_medico_w					plano_versao.nm_medico%type;

  t RECORD;

BEGIN

select	nextval('plano_versao_seq')
into STRICT	nr_seq_plano_versao_w
;

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	plano_versao
where	nr_sequencia	= nr_sequencia_p;

select	coalesce(obter_nome_medico(cd_pessoa_fisica,'G'), nm_pessoa_fisica)
into STRICT	nm_medico_w
from	pessoa_fisica
where	cd_pessoa_fisica = obter_pf_usuario(coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario), 'C');

insert into plano_versao(	cd_pessoa_fisica,
		ds_bar_code,
		ds_versao,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_emissao,		
		nm_medico,
		nm_usuario,
		nm_usuario_inativacao,
		nm_usuario_lib,
		nm_usuario_liberacao,
		nm_usuario_nrec,
		dt_liberacao,
		nr_sequencia,
		qt_peso,
		qt_altura,
		qt_creatinina,
		ie_gravida,
		ie_amamentacao,
		ds_alergias,
		ds_outras_condicoes)
	(SELECT	cd_pessoa_fisica,
		ds_bar_code,
		null,
		clock_timestamp(),
		clock_timestamp(),
		clock_timestamp(),		
		nm_medico_w,
		nm_usuario_p,
		nm_usuario_inativacao,
		nm_usuario_lib,
		nm_usuario_liberacao,
		nm_usuario_p,
		null,
		nr_seq_plano_versao_w,
		qt_peso,
		qt_altura,
		qt_creatinina,
		ie_gravida,
		ie_amamentacao,
		ds_alergias,
		ds_outras_condicoes
	from	plano_versao
	where	nr_sequencia	= nr_sequencia_p);

for t in (
    select
		nr_sequencia,
		nr_seq_versao,
		ds_descricao_complementar,
		ie_classificacao,
		cd_material,
		qt_dose_manha,
		qt_dose_almoco,
		qt_dose_tarde,
		qt_dose_noite,
		cd_unidade_medida,
		ds_observacao,
		ds_motivo,
		ds_horario_especial,
		dt_registro,
		nm_usuario,
		dt_atualizacao,
		cd_pessoa_fisica,
		cd_profissional,
		ds_orientacao,
		ds_medicamento,
		ds_forma_medicamento,
		ds_potencia,
		ds_dose_diferenciada,
		ds_forma_desc,
		ds_unid_med_desc,
		ie_tipo_medicamento,
		ds_princ_ativo,
		ie_exibir_plano_medic
	from	plano_versao_medic
	where	nr_seq_versao	= nr_sequencia_p

) LOOP
    select	nextval('plano_versao_medic_seq')
    into STRICT	nr_seq_plano_versao_medic_w
;

    insert into plano_versao_medic(	nr_sequencia,
		nr_seq_versao,
		ds_descricao_complementar,
		ie_classificacao,
		cd_material,
		qt_dose_manha,
		qt_dose_almoco,
		qt_dose_tarde,
		qt_dose_noite,
		cd_unidade_medida,
		ds_observacao,
		ds_motivo,
		ds_horario_especial,
		dt_registro,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_pessoa_fisica,
		cd_profissional,
		ds_orientacao,
		ds_medicamento,
		ds_forma_medicamento,
		ds_potencia,
		ds_dose_diferenciada,
		ds_forma_desc,
		ds_unid_med_desc,
		ie_tipo_medicamento,
		ds_princ_ativo,
		ie_exibir_plano_medic)
    values (
    	nr_seq_plano_versao_medic_w,
		nr_seq_plano_versao_w,
		t.ds_descricao_complementar,
		t.ie_classificacao,
		t.cd_material,
		t.qt_dose_manha,
		t.qt_dose_almoco,
		t.qt_dose_tarde,
		t.qt_dose_noite,
		t.cd_unidade_medida,
		t.ds_observacao,
		t.ds_motivo,
		t.ds_horario_especial,
		t.dt_registro,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
        t.cd_pessoa_fisica,
		t.cd_profissional,
		t.ds_orientacao,
		t.ds_medicamento,
		t.ds_forma_medicamento,
		t.ds_potencia,
		t.ds_dose_diferenciada,
		t.ds_forma_desc,
		t.ds_unid_med_desc,
		t.ie_tipo_medicamento,
		t.ds_princ_ativo,
		'N'
    );

END LOOP;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicate_medicines_plan ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

