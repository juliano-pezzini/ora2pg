-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisa_solic_os_satisfacao ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w			bigint;
nr_seq_classif_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicado_w			varchar(4000);
cd_pessoa_solicitante_w		varchar(10);
nm_usuario_destino_w		varchar(15);
ie_grau_satisfacao_w		varchar(3);
ie_status_ordem_w			varchar(1);
dt_limite_w			timestamp;
ds_dano_w			varchar(80);
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
ie_grau_satisf_w			varchar(255);
ds_grau_satisf_w			varchar(255);
ds_lista_tipo_solucao_w		varchar(2000);
nr_seq_tipo_solucao_w		bigint;
ie_gerar_w			varchar(01) := 'S';
ie_desconsidera_w			varchar(01) := 'N';
ie_comunic_solic_exec_w		varchar(255) := 'S';
qt_dias_w			bigint;
ds_enter_w			varchar(10) := chr(13) || chr(10);


BEGIN
ie_grau_satisf_w := obter_param_usuario(299, 218, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_grau_satisf_w);
ds_lista_tipo_solucao_w := obter_param_usuario(299, 297, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_lista_tipo_solucao_w);
ie_comunic_solic_exec_w := obter_param_usuario(299, 413, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_comunic_solic_exec_w);
qt_dias_w := obter_param_usuario(299, 461, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, qt_dias_w);

select	coalesce(substr(obter_valor_dominio(1197,ie_grau_satisf_w),1,255),wheb_mensagem_pck.get_texto(305782))
into STRICT	ds_grau_satisf_w
;

select	max(cd_pessoa_solicitante),
	coalesce(max(ie_grau_satisfacao),'0'),
	coalesce(max(ie_status_ordem),'0'),
	trunc(coalesce(max(dt_fim_real), clock_timestamp())) + coalesce(qt_dias_w,14),
	coalesce(max(ds_dano_breve),''),
	coalesce(max(nr_seq_tipo_solucao),0)
into STRICT	cd_pessoa_solicitante_w,
	ie_grau_satisfacao_w,
	ie_status_ordem_w,
	dt_limite_w,
	ds_dano_w,
	nr_seq_tipo_solucao_w
from	man_ordem_servico
where	nr_sequencia = nr_sequencia_p;

if (coalesce(ds_lista_tipo_solucao_w,'X') <> 'X') and /*Lista dos tipos que serÃ£o DESCONSIDERADOS*/
	(nr_seq_tipo_solucao_w > 0) then
	select	substr(obter_se_contido(nr_seq_tipo_solucao_w, ds_lista_tipo_solucao_w),1,1)
	into STRICT	ie_desconsidera_w
	;

	if (ie_desconsidera_w = 'S') then
		ie_gerar_w := 'N';
	end if;
end if;

if (coalesce(ie_gerar_w,'N') = 'S') and (coalesce(ie_comunic_solic_exec_w,'S') = 'N') then
	begin
	select	'N'
	into STRICT	ie_gerar_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = nr_sequencia_p
	and	nm_usuario_exec = substr(obter_usuario_pessoa(cd_pessoa_solicitante_w),1,15)  LIMIT 1;
	exception
	when others then
		ie_gerar_w := 'S';
	end;
end if;

if (ie_gerar_w = 'S') then
	begin
	select	coalesce(max(nm_usuario),'X')
	into STRICT	nm_usuario_destino_w
	from	usuario
	where	cd_pessoa_fisica = cd_pessoa_solicitante_w;

	if (nm_usuario_destino_w <> 'X') and (ie_grau_satisfacao_w = '0') and (ie_status_ordem_w = '3') then

		select	obter_classif_comunic('F')
		into STRICT	nr_seq_classif_w
		;

		ds_titulo_w	:= substr(wheb_mensagem_pck.get_texto(305790) || ' - ' || wheb_mensagem_pck.get_texto(305791),1,255);
		ds_comunicado_w	:= substr(nm_usuario_destino_w || ds_enter_w ||
					wheb_mensagem_pck.get_texto(305819,'NR_SEQUENCIA_P=' || nr_sequencia_p || ';DT_LIMITE_W= ' || dt_limite_w) || ds_enter_w ||
					wheb_mensagem_pck.get_texto(305833,'DS_GRAU_SATISF_W=' || ds_grau_satisf_w)  || ds_enter_w || ds_enter_w ||
					wheb_mensagem_pck.get_texto(305513) || ds_enter_w ||
					ds_dano_w || ds_enter_w || ds_enter_w ||
					wheb_mensagem_pck.get_texto(305846),1,4000);

		select	nextval('comunic_interna_seq')
		into STRICT	nr_sequencia_w
		;

		insert into comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			nr_sequencia,
			ie_gerencial,
			nr_seq_classif,
			dt_liberacao)
		values (	clock_timestamp() + interval '1 days'/86400,
			ds_titulo_w,
			ds_comunicado_w,
			'Tasy',
			clock_timestamp(),
			'N',
			nm_usuario_destino_w,
			nr_sequencia_w,
			'N',
			nr_seq_classif_w,
			clock_timestamp());
	commit;
	end if;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisa_solic_os_satisfacao ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

