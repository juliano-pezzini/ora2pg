-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_sup_impl_estoque ( ie_tipo_virada_p bigint, ie_deleta_p text, ie_custo_medio_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_material_planilha_p text, cd_fornecedor_p text, qt_estoque_p bigint, vl_custo_medio_p bigint, vl_ultima_compra_p bigint, ds_lote_fornec_p text, ds_barras_p text, dt_validade_p timestamp, dt_movimento_estoque_p timestamp) AS $body$
DECLARE



/*ie_tipo_virada_p
0	Saldo normal
2	CM
1	Saldo consignado
5	Consumos
6	Lote fornecedor*/
nr_sequencia_w		integer;
vl_custo_medio_w	double precision;


BEGIN


if (ie_deleta_p = 'S') then
	begin
	delete from sup_impl_estoque;
	delete from sup_impl_consistencia;
	commit;
	end;
end if;

if (coalesce(qt_estoque_p,0) > 0) or (ie_tipo_virada_p = 2) then
	begin
	
	if (ie_custo_medio_p = 0) then
		vl_custo_medio_w	:= coalesce(vl_custo_medio_p, 0);

	elsif (ie_custo_medio_p = 1) then

		select	coalesce(max(vl_custo_medio), 0)
		into STRICT	vl_custo_medio_w
		from	sup_impl_cm
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	cd_material_planilha	= cd_material_planilha_p;

	elsif (ie_custo_medio_p = 2) then

		vl_custo_medio_w	:= coalesce(vl_custo_medio_p, 0);
		if (vl_custo_medio_w = 0) then
			select	coalesce(max(vl_custo_medio), 0)
			into STRICT	vl_custo_medio_w
			from	sup_impl_cm
			where	cd_estabelecimento	= cd_estabelecimento_p
			and	cd_material_planilha	= cd_material_planilha_p;
		end if;

	elsif (ie_custo_medio_p = 3) then

		select	coalesce(max(vl_custo_medio), 0)
		into STRICT	vl_custo_medio_w
		from	sup_impl_cm
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	cd_material_planilha	= cd_material_planilha_p;

		if (vl_custo_medio_w = 0) then
			vl_custo_medio_w	:= coalesce(vl_custo_medio_p, 0);
		end if;
	end if;

	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_w
	from	sup_impl_estoque;

	insert into sup_impl_estoque(
		nr_sequencia,
		cd_estabelecimento,
		cd_local_estoque,
		cd_centro_custo,
		cd_material_planilha,
		cd_fornecedor,
		qt_estoque,
		vl_custo_medio,
		vl_ultima_compra,
		ds_lote_fornec,
		dt_validade,
		ds_barras,
		dt_movimento_estoque)
	values ( nr_sequencia_w,
		cd_estabelecimento_p,
		cd_local_estoque_p,
		cd_centro_custo_p,
		cd_material_planilha_p,
		substr(cd_fornecedor_p,1,14),
		qt_estoque_p,
		vl_custo_medio_w,
		vl_ultima_compra_p,
		substr(trim(both ds_lote_fornec_p),1,20),
		dt_validade_p,
		trim(both ds_barras_p),
		dt_movimento_estoque_p);

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_sup_impl_estoque ( ie_tipo_virada_p bigint, ie_deleta_p text, ie_custo_medio_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_material_planilha_p text, cd_fornecedor_p text, qt_estoque_p bigint, vl_custo_medio_p bigint, vl_ultima_compra_p bigint, ds_lote_fornec_p text, ds_barras_p text, dt_validade_p timestamp, dt_movimento_estoque_p timestamp) FROM PUBLIC;

