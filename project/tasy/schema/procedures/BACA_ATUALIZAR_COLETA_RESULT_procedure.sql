-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atualizar_coleta_result (nm_usuario_p text) AS $body$
DECLARE


dt_coleta_w	timestamp;
nr_Seq_result_w	bigint;
nr_prescricao_w	bigint;
nr_seq_prescr_w	integer;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_prescricao,
		nr_seq_prescricao
	from	result_laboratorio
	where	coalesce(dt_coleta::text, '') = ''
	and	dt_atualizacao > clock_timestamp() - interval '2 days';


BEGIN

OPEN C01;
LOOP
FETCH C01 into
	nr_Seq_result_w,
	nr_prescricao_w,
	nr_seq_prescr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	select	max(coalesce(to_date(lab_obter_data_recoleta(nr_prescricao_w,nr_seq_prescr_w,nm_usuario_p,0),'dd/mm/yyyy hh24:mi:ss') ,(b.dt_coleta)))
	into STRICT	dt_coleta_w
	from	exame_lab_result_item b,
		exame_lab_resultado a
	where	a.nr_seq_resultado	= b.nr_seq_resultado
	and	a.nr_prescricao		= nr_prescricao_w
	and	b.nr_seq_prescr		= nr_seq_prescr_w
	and	(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');
	exception
		when others then
		dt_coleta_w	:= null;
	end;

	if (dt_coleta_w IS NOT NULL AND dt_coleta_w::text <> '') then

		update 	result_laboratorio
		set 	dt_coleta = dt_coleta_w,
			nm_usuario = nm_usuario_p
		where 	nr_prescricao = nr_prescricao_w
		and	nr_sequencia = nr_Seq_result_w
		and	nr_seq_prescricao = nr_seq_prescr_w;

		/*insert into logxxxxx_tasy(nm_usuario,dt_atualizacao,cd_log,ds_log)
		values(nm_usuario_p,sysdate,3217,'Prescrição'|| nr_prescricao_w || 'Seq.Prescr.' || nr_seq_prescr_w);*/
	end if;

END LOOP;
CLOSE C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atualizar_coleta_result (nm_usuario_p text) FROM PUBLIC;

