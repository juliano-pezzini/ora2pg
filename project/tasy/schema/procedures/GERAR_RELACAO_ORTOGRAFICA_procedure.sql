-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relacao_ortografica ( nr_seq_analise_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_lote_w		bigint;
nr_seq_origem_w		bigint;
ie_function_w		varchar(1);
nr_seq_origem_novo_w	bigint;
ds_diferenca_w		varchar(255);
nr_sequencia_w		bigint;
nr_seq_lote_origem_w	bigint;

nm_tabela_orig_w	varchar(50);
nm_atributo_orig_w	varchar(50);
nr_seq_visao_orig_w	bigint;
nm_tabela_origem_orig_w	varchar(50);

nm_tabela_origem_w	varchar(50);
nm_tabela_w		varchar(50);
nm_atributo_w		varchar(50);
nr_seq_visao_w		bigint;
nm_usuario_origem_w	varchar(15);
dt_origem_w		timestamp;

ds_cont_campo_novo_w	varchar(4000);

ds_cont_campo_ant_w	varchar(4000);
ds_campo_ant_w		varchar(255);

ds_conteudo_campo_w	varchar(4000);
qt_campo_w		bigint	:= 0;
nm_outra_tabela_w	varchar(50);

c01 CURSOR FOR
SELECT	'TABELA_VISAO_ATRIBUTO' nm_tabela_origem,
	b.nm_tabela,
	a.nm_atributo,
	a.nr_sequencia nr_seq_visao,
	a.nm_usuario,
	a.dt_atualizacao
from	tabela_atributo c,
	tabela_visao b,
	tabela_visao_atributo a
where	c.nm_atributo			= a.nm_atributo
and	b.nm_tabela			= c.nm_tabela
and	not exists (select	1
	from	analise_ortografica x
	where	x.nm_atributo		= a.nm_atributo
	and	x.nm_tabela		= b.nm_tabela
	and	x.nr_seq_visao		= b.nr_sequencia
	and	x.nm_tabela_origem	= 'TABELA_VISAO_ATRIBUTO'
	and	x.nr_seq_lote		= nr_seq_lote_origem_w)
and	b.nm_tabela			= nm_tabela_orig_w
and	a.nr_sequencia			= b.nr_sequencia
and	a.nm_atributo			= nm_atributo_orig_w
and (qt_campo_w > 0 or nm_tabela_origem_orig_w = 'TABELA_VISAO_ATRIBUTO')
and	a.nr_sequencia			<> coalesce(nr_seq_visao_orig_w,0)

union all

select	'TABELA_ATRIBUTO' nm_tabela_origem,
	a.nm_tabela,
	a.nm_atributo,
	null nr_seq_visao,
	a.nm_usuario,
	a.dt_atualizacao
from	tabela_atributo a
where	not exists (select	1
	from	analise_ortografica x
	where	x.nm_atributo		= a.nm_atributo
	and	x.nm_tabela		= a.nm_tabela
	and	x.nm_tabela_origem	= 'TABELA_ATRIBUTO'
	and	x.nr_seq_lote		= nr_seq_lote_origem_w)
and	a.nm_atributo			= nm_atributo_orig_w
and	a.nm_tabela			= nm_tabela_orig_w
and	qt_campo_w			> 0
and	nm_tabela_origem_orig_w		<> 'TABELA_ATRIBUTO';


BEGIN

select	a.nr_seq_lote,
	a.nr_seq_origem,
	a.ds_conteudo_campo
into STRICT	nr_seq_lote_w,
	nr_seq_origem_w,
	ds_cont_campo_novo_w
from	analise_ortografica a
where	a.nr_sequencia		= nr_seq_analise_p;

select	max(b.ie_function),
	max(a.nr_seq_lote_origem)
into STRICT	ie_function_w,
	nr_seq_lote_origem_w
from	analise_ortografica_lote b,
	analise_ortografica_lote a
where	a.nr_seq_lote_origem	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_lote_w;

select	a.nm_tabela,
	a.nm_atributo,
	a.nr_seq_visao,
	a.nm_tabela_origem,
	a.ds_conteudo_campo,
	a.ds_campo
into STRICT	nm_tabela_orig_w,
	nm_atributo_orig_w,
	nr_seq_visao_orig_w,
	nm_tabela_origem_orig_w,
	ds_cont_campo_ant_w,
	ds_campo_ant_w
from	analise_ortografica a
where	a.nr_sequencia		= nr_seq_origem_w;

if (nm_tabela_origem_orig_w	= 'TABELA_ATRIBUTO') then
	nm_outra_tabela_w	:=  'TABELA_VISAO_ATRIBUTO';
else
	nm_outra_tabela_w	:=  'TABELA_ATRIBUTO';
end if;

select	count(*)
into STRICT	qt_campo_w
from	analise_ort_regra_campo b,
	analise_ortografica_regra a
where	b.ds_campo	= ds_campo_ant_w
and	a.nr_sequencia	= b.nr_seq_regra
and	a.ie_origem	= 'T'
and	a.ds_origem	= nm_outra_tabela_w;

/* se houverem registros relacionados dentro do próprio lote */

update	analise_ortografica a
set	a.ie_origem	= 'R',
	a.ie_diferenca	= 'S'
where	exists (SELECT	1
	from	analise_ortografica x
	where	x.ds_conteudo_campo	= ds_cont_campo_ant_w
	and	x.nr_sequencia		= a.nr_seq_origem)
and	a.ds_conteudo_campo	<> ds_cont_campo_novo_w
and	coalesce(a.ie_diferenca,'N')	= 'N'
and	a.ds_campo		= ds_campo_ant_w
and	a.nm_atributo		= nm_atributo_w
and	a.nm_tabela		= nm_tabela_w
and	a.nm_tabela_origem	in ('TABELA_VISAO_ATRIBUTO','TABELA_ATRIBUTO')
and	a.nr_seq_lote		= nr_seq_lote_w;

select	max(a.nr_sequencia)
into STRICT	nr_sequencia_w
from	analise_ortografica a;

open	c01;
loop
fetch	c01 into
	nm_tabela_origem_w,
	nm_tabela_w,
	nm_atributo_w,
	nr_seq_visao_w,
	nm_usuario_origem_w,
	dt_origem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* excluir para não gerar registros duplicados */

	delete	from analise_ortografica a
	where	a.nm_atributo		= nm_atributo_w
	and	a.nm_tabela		= nm_tabela_w
	and	coalesce(a.nr_seq_visao,0)	= coalesce(nr_seq_visao_w,0)
	and	a.nm_tabela_origem	= nm_tabela_origem_w
	and	a.ds_campo		= ds_campo_ant_w
	and	exists (SELECT	1
		from	analise_ortografica_lote x
		where	(x.dt_analise IS NOT NULL AND x.dt_analise::text <> '')
		and	coalesce(x.dt_confirmacao::text, '') = ''
		and	x.nr_sequencia		= a.nr_seq_lote)
	and	not exists (select	1
		from	analise_ortografica_lote y,
			analise_ortografica x
		where	(y.dt_confirmacao IS NOT NULL AND y.dt_confirmacao::text <> '')
		and	x.nr_seq_lote		= y.nr_sequencia
		and	x.nr_seq_origem		= a.nr_sequencia);

	if (nm_tabela_origem_w	= 'TABELA_ATRIBUTO') then

		ds_conteudo_campo_w := obter_valor_dinamico_4000_bv(	'select max(' || ds_campo_ant_w || ')' ||
						' from tabela_atributo' ||
						' where nm_atributo = :nm_atributo and nm_tabela = :nm_tabela', 'nm_atributo=' || nm_atributo_w || ';nm_tabela=' || nm_tabela_w || ';', ds_conteudo_campo_w);

	elsif (nm_tabela_origem_w	= 'TABELA_VISAO_ATRIBUTO') then

		ds_conteudo_campo_w := obter_valor_dinamico_4000_bv(	'select max(' || ds_campo_ant_w || ')' ||
						' from tabela_visao_atributo' ||
						' where nm_atributo = :nm_atributo and nr_sequencia = :nr_seq_visao', 'nm_atributo=' || nm_atributo_w || ';nr_seq_visao=' || nr_seq_visao_w || ';', ds_conteudo_campo_w);

	end if;

	if (ds_conteudo_campo_w = ds_cont_campo_ant_w) then

		nr_sequencia_w		:= coalesce(nr_sequencia_w,0) + 1;

		insert	into analise_ortografica(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nm_tabela_origem,
			nm_tabela,
			nm_atributo,
			nm_usuario_origem,
			nr_seq_lote,
			dt_origem,
			nr_seq_visao,
			ie_origem,
			ds_campo,
			ds_conteudo_campo)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			nm_tabela_origem_w,
			nm_tabela_w,
			nm_atributo_w,
			nm_usuario_origem_w,
			nr_seq_lote_origem_w,
			dt_origem_w,
			nr_seq_visao_w,
			'R',
			ds_campo_ant_w,
			ds_conteudo_campo_w);

		/* análise ortográfica de correção */

		nr_seq_origem_novo_w	:= nr_sequencia_w;
		nr_sequencia_w		:= coalesce(nr_sequencia_w,0) + 1;

		insert	into analise_ortografica(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nm_tabela_origem,
			nm_tabela,
			nm_atributo,
			nm_usuario_origem,
			nr_seq_lote,
			dt_origem,
			nr_seq_visao,
			nr_seq_origem,
			ie_diferenca,
			ie_origem,
			ds_campo,
			ds_conteudo_campo)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			nm_tabela_origem_w,
			nm_tabela_w,
			nm_atributo_w,
			nm_usuario_origem_w,
			nr_seq_lote_w,
			dt_origem_w,
			nr_seq_visao_w,
			nr_seq_origem_novo_w,
			'S',
			'R',
			ds_campo_ant_w,
			ds_cont_campo_novo_w);

	end if;

end	loop;
close	c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relacao_ortografica ( nr_seq_analise_p bigint, nm_usuario_p text) FROM PUBLIC;

