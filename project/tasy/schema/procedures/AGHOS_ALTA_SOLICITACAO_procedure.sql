-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function aghos_alta_solicitacao as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE aghos_alta_solicitacao ( nr_atendimento_p bigint, nm_usuario_p text, cd_motivo_alta_p bigint default null) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL aghos_alta_solicitacao_atx ( ' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(nm_usuario_p) || ',' || quote_nullable(cd_motivo_alta_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE aghos_alta_solicitacao_atx ( nr_atendimento_p bigint, nm_usuario_p text, cd_motivo_alta_p bigint default null) AS $body$
DECLARE


ds_motivo_cancelamento_w	varchar(1000);
cd_cnes_solicitante_w		varchar(1000);
ds_sep_bv_w			varchar(50);
ds_comando_w			varchar(2000);
cd_motivo_alta_w		smallint;
cd_motivo_alta_sus_w		smallint;
cd_cpf_medico_alta_w		bigint;
cd_cid_alta_w			varchar(4);
ds_motivo_alta_w		varchar(80);
nr_internacao_w			bigint;
ds_usuario_w			varchar(15);
ie_integra_aghos_w	varchar(1);
BEGIN

/*
IDF_GSH_I_INTERN_ALTA_(ENT/SAI)  NUMBER 	not null
TIP_STATUS 			VARCHAR2 1 	not null
DES_ERRO 			VARCHAR2 500 	null
DAT_INTEGRACAO 		DATE 		not null
DES_USUARIO 			VARCHAR2 15 	not null
COD_CNES_SOLICITANTE 		NUMBER 7 	not null
IDF_INTERNACAO 		NUMBER 9 	not null
COD_SUS_MOTIVO_ALTA		VARCHAR2 2 	not null
NUM_CPF_MEDICO_ALTA 		NUMBER 11 	not null
COD_CID_ALTA 			VARCHAR2 4 	not null
*/
select	max(substr(obter_cnes_estab(a.cd_estabelecimento), 1, 7)),
	coalesce(max(a.cd_motivo_alta), cd_motivo_alta_p),
	max(substr(obter_cpf_pessoa_fisica(cd_medico_resp), 1, 11)),
	max(substr(Obter_cid_princ_atendimento(a.nr_atendimento), 1, 4)),
	max(nr_internacao),
	coalesce(max(substr(obter_dados_param_atend(a.cd_estabelecimento, 'US'), 1, 15)), 'TREINA')
into STRICT	cd_cnes_solicitante_w,
	cd_motivo_alta_w,
	cd_cpf_medico_alta_w,
	cd_cid_alta_w,
	nr_internacao_w,
	ds_usuario_w
from	atendimento_paciente a,
	solicitacao_tasy_aghos b
where	a.nr_atendimento = b.nr_atendimento
and	b.nr_atendimento = nr_atendimento_p
and	a.ie_tipo_atendimento = 1;

select	max(cd_motivo_alta_sus),
	max(ds_motivo_alta)
into STRICT	cd_motivo_alta_sus_w,
	ds_motivo_alta_w
from	motivo_alta
where	cd_motivo_alta = coalesce(cd_motivo_alta_w, 0);

ds_sep_bv_w := obter_separador_bv;
ie_integra_aghos_w := obter_dados_param_atend(wheb_usuario_pck.get_cd_estabelecimento, 'AG');

If (cd_cnes_solicitante_w IS NOT NULL AND cd_cnes_solicitante_w::text <> '') then

	if (ie_integra_aghos_w = 'S') then
		ds_comando_w :=	'declare '||
				'	alta_sai gsh_i_pkg_integra_sai.alta_sai@tasy_aghos; '||
				'	ds_erro_ww	varchar2(500); '||
				'begin '||
				' '||
				'   begin ' ||
				'	gsh_i_prc_intern_alta_ent@tasy_aghos(	0, '||
				'						''A'',  '||
				'						ds_erro_ww, '||
				'						sysdate, '||
				'						:ds_usuario_p, '||
				'						:cd_cnes_solicitante_p, '||
				'						:nr_internacao_p, '||
				'						:cd_motivo_alta_sus_p, '||
				'						:cd_cpf_medico_alta_p, '||
				'						:cd_cid_alta_p '||
				'						); '||
				' '||
				'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_alta_sai@tasy_aghos(alta_sai); '||
				' '||
				'	if	(alta_sai.first is not null) then '||
				'		for i in alta_sai.first..alta_sai.last loop '||
				' '||
				'		if	(alta_sai(i).idf_internacao = :nr_internacao_p) then '||
				' '||
				'			update	solicitacao_tasy_aghos '||
				'			set	ie_situacao = ''AL'', '||
				'				ds_motivo_situacao = :ds_motivo_alta_p '||
				'			where	nr_internacao = :nr_internacao_p; '||
				' '||
				'			if (nvl(wheb_usuario_pck.get_ie_commit, ''S'') = ''S'') then commit; end if; '||
				' '||
				'			ds_erro_ww := null; '||
				'			gsh_i_prc_intern_alta_s_u@tasy_aghos(	alta_sai(i).idf_gsh_i_intern_alta_sai,  '||
				'								''P'', '||
				'								ds_erro_ww); '||
				'		end if; '||
				'		end loop; '||
				'	end if; '||
				' commit; '||
				' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
				'   exception '||
				'   when others then '||
				'      rollback; ' ||
				'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
				'   end; '||
				'end;';

		CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 	'ds_motivo_alta_p='	|| coalesce(ds_motivo_alta_w, 'Alta realizada no Tasy')	|| ds_sep_bv_w ||
								'nr_internacao_p='	|| nr_internacao_w					|| ds_sep_bv_w ||
								'cd_cnes_solicitante_p='|| cd_cnes_solicitante_w				|| ds_sep_bv_w ||
								'cd_motivo_alta_sus_p='	|| cd_motivo_alta_sus_w					|| ds_sep_bv_w ||
								'cd_cpf_medico_alta_p=' || cd_cpf_medico_alta_w					|| ds_sep_bv_w ||
								'cd_cid_alta_p='	|| cd_cid_alta_w					|| ds_sep_bv_w ||
								'ds_usuario_p='		|| ds_usuario_w);
	elsif (coalesce(obter_funcao_ativa, 916) not in (916, 3111)) then
		ds_sep_bv_w := ';';
		CALL gravar_agend_integracao(334, 'IDF_INTERNACAO='				|| nr_internacao_w 			|| ds_sep_bv_w ||
										'COD_SUS_MOTIVO_ALTA='	|| cd_motivo_alta_sus_w	 	|| ds_sep_bv_w ||
										'NUM_CPF_MEDICO_ALTA='	|| cd_cpf_medico_alta_w	 	|| ds_sep_bv_w ||
										'COD_CID_ALTA='			|| cd_cid_alta_w		 	|| ds_sep_bv_w ||
										'DES_USUARIO='			|| ds_usuario_w 			|| ds_sep_bv_w);
	end if;
End if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_alta_solicitacao ( nr_atendimento_p bigint, nm_usuario_p text, cd_motivo_alta_p bigint default null) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE aghos_alta_solicitacao_atx ( nr_atendimento_p bigint, nm_usuario_p text, cd_motivo_alta_p bigint default null) FROM PUBLIC;

