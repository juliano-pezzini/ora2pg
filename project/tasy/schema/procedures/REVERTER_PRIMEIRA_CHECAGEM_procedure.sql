-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_primeira_checagem ( nr_seq_horario_p bigint, ds_justificativa_p text, ds_observacao_p text, ie_tipo_item_p text, dt_evento_p timestamp, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE


nr_prescricao_w			bigint;
nr_seq_material_w		bigint;
ie_agrupador_w			smallint;
dt_horario_w			timestamp;
nr_atendimento_w		bigint;
cd_item_w				varchar(255);
cd_pessoa_fisica_w		varchar(10);
nr_seq_alteracao_w		bigint;
nr_seq_procedimento_w	bigint;
nr_seq_proc_interno_w	bigint;
nr_seq_assinatura_w		bigint;
nr_seq_prot_glic_w		bigint;
nr_seq_processo_w		prescr_mat_hor.nr_seq_processo%type;
					

BEGIN

if (coalesce(nr_seq_horario_p,0) > 0) then
	if (ie_tipo_item_p in ('IAH', 'M','S')) then
		select	max(b.nr_prescricao),
				max(b.nr_sequencia),
				max(b.ie_agrupador),
				max(c.dt_horario),
				max(a.nr_atendimento),
				max(b.cd_material),
				maX(c.nr_seq_processo)
		into STRICT	nr_prescricao_w,
				nr_seq_material_w,
				ie_agrupador_w,
				dt_horario_w,
				nr_atendimento_w,
				cd_item_w,
				nr_seq_processo_w
		from	prescr_medica a,
				prescr_material b,
				prescr_mat_hor c
		where	a.nr_prescricao	= b.nr_prescricao
		and		a.nr_prescricao	= c.nr_prescricao
		and		b.nr_prescricao	= c.nr_prescricao
		and		b.nr_sequencia	= c.nr_seq_material
		and		c.nr_sequencia	= nr_seq_horario_p;

		cd_pessoa_fisica_w	:= obter_dados_usuario_opcao(nm_usuario_p,'C');	

		update	prescr_mat_hor
		set		dt_primeira_checagem	 = NULL,
				nm_usuario				= nm_usuario_p,
				dt_atualizacao			= clock_timestamp()
		where	nr_sequencia			= nr_seq_horario_p;
		
		update	adep_processo
		set		dt_primeira_checagem 	 = NULL,
				dt_atualizacao 			= clock_timestamp()
		where	nr_sequencia 			= nr_seq_processo_w
		and		nr_prescricao			= nr_prescricao_w
		and		(dt_primeira_checagem IS NOT NULL AND dt_primeira_checagem::text <> '');

		select	nextval('prescr_mat_alteracao_seq')
		into STRICT	nr_seq_alteracao_w
		;
		
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_prescricao,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_horario,
							ds_justificativa,
							ds_observacao,
							ie_agrupador,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item)
								values (
							nr_seq_alteracao_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_w,
							nr_seq_material_w,
							coalesce(dt_evento_p,clock_timestamp()),
							cd_pessoa_fisica_w,
							50,
							nr_seq_horario_p,
							ds_justificativa_p,
							ds_observacao_p,
							ie_agrupador_w,
							ie_tipo_item_p,
							dt_horario_w,
							nr_atendimento_w,
							cd_item_w);
	commit;
		
	elsif (ie_tipo_item_p in ('P','L','C','G','HM')) then
		select	max(b.nr_prescricao),
				max(b.nr_sequencia),
				max(b.nr_seq_proc_interno),
				max(b.nr_seq_assinatura),
				max(b.nr_seq_prot_glic),
				max(c.dt_horario),
				max(a.nr_atendimento),
				max(b.cd_procedimento),
				max(c.nr_seq_processo)
		into STRICT	nr_prescricao_w,
				nr_seq_procedimento_w,
				nr_seq_proc_interno_w,
				nr_seq_assinatura_w,
				nr_seq_prot_glic_w,
				dt_horario_w,
				nr_atendimento_w,
				cd_item_w,
				nr_seq_processo_w
		from	prescr_medica a,
				prescr_procedimento b,
				prescr_proc_hor c
		where	a.nr_prescricao	= b.nr_prescricao
		and		a.nr_prescricao	= c.nr_prescricao
		and		b.nr_prescricao	= c.nr_prescricao
		and		b.nr_sequencia	= c.nr_seq_procedimento
		and		c.nr_sequencia	= nr_seq_horario_p;
		
		cd_pessoa_fisica_w	:= obter_dados_usuario_opcao(nm_usuario_p,'C');
		
		update	prescr_proc_hor
		set		dt_primeira_checagem	 = NULL,
				nm_usuario				= nm_usuario_p,
				dt_atualizacao			= clock_timestamp()
		where	nr_sequencia			= nr_seq_horario_p;
		
		update	adep_processo
		set		dt_primeira_checagem 	 = NULL,
				dt_atualizacao 			= clock_timestamp()
		where	nr_sequencia 			= nr_seq_processo_w
		and		nr_prescricao			= nr_prescricao_w
		and		(dt_primeira_checagem IS NOT NULL AND dt_primeira_checagem::text <> '');
		
		select	nextval('prescr_mat_alteracao_seq')
		into STRICT		nr_seq_alteracao_w
		;
		
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_procedimento,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_horario_proc,
							ds_justificativa,
							ds_observacao,
							ie_agrupador,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item,
							nr_seq_assinatura,
							ie_mostra_adep,
							nr_seq_prot_glic,
							nr_seq_proc_interno)
								values (
							nr_seq_alteracao_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_w,
							nr_seq_procedimento_w,
							coalesce(dt_evento_p,clock_timestamp()),
							cd_pessoa_fisica_w,
							50,
							nr_seq_horario_p,
							ds_justificativa_p,
							ds_observacao_p,
							ie_agrupador_w,
							ie_tipo_item_p,
							dt_horario_w,
							nr_atendimento_w,
							cd_item_w,
							nr_seq_assinatura_w,
							'S',
							nr_seq_prot_glic_w,
							nr_seq_proc_interno_w);
	end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_primeira_checagem ( nr_seq_horario_p bigint, ds_justificativa_p text, ds_observacao_p text, ie_tipo_item_p text, dt_evento_p timestamp, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

