-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_vinculo_padrao_usuario ( nm_usuario_cad_p text, nr_seq_grupo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_perfil_w					integer;
qt_perfil_w					integer;
cd_setor_atendimento_w		integer;
qt_setor_atendimento_w		integer;
ie_tipo_evolucao_w			varchar(3);

C01 CURSOR FOR
	SELECT	cd_perfil
	from	usuario_grupo_perfil
	where 	nr_seq_grupo = nr_seq_grupo_p;

C02 CURSOR FOR
	SELECT	cd_setor_atendimento
	from	usuario_grupo_setor
	where	nr_seq_grupo = nr_seq_grupo_p;


BEGIN
select	max(ie_tipo_evolucao)
into STRICT	ie_tipo_evolucao_w
from	usuario_grupo_cad
where	nr_sequencia = nr_seq_grupo_p;

if (coalesce(ie_tipo_evolucao_w,'X') <> 'X') then
	begin
	update 	usuario
	set 	ie_tipo_evolucao = ie_tipo_evolucao_w
	where 	nm_usuario = nm_usuario_cad_p;
	end;
end if;

open C01;
loop
fetch C01 into
	cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	count(*)
	into STRICT	qt_perfil_w
	from	usuario_perfil
	where	cd_perfil = cd_perfil_w
	and		nm_usuario = nm_usuario_cad_p;

	if (qt_perfil_w = 0) then
		begin
		insert into usuario_perfil(
				nm_usuario,
				cd_perfil,
				dt_atualizacao,
				nm_usuario_atual)
		values (	nm_usuario_cad_p,
				cd_perfil_w,
				clock_timestamp(),
				nm_usuario_p);
		end;
	end if;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select 	count(*)
	into STRICT 	qt_setor_atendimento_w
	from 	usuario_setor
	where	cd_setor_atendimento = cd_setor_atendimento_w
	and 	nm_usuario = nm_usuario_cad_p;
	if (qt_setor_atendimento_w = 0) then
		begin
		insert	into usuario_setor(
				nm_usuario_param,
				cd_setor_atendimento,
				dt_atualizacao,
				nm_usuario)
		values (	nm_usuario_cad_p,
				cd_setor_atendimento_w,
				clock_timestamp(),
				nm_usuario_p);
		end;
	end if;
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_vinculo_padrao_usuario ( nm_usuario_cad_p text, nr_seq_grupo_p bigint, nm_usuario_p text) FROM PUBLIC;

