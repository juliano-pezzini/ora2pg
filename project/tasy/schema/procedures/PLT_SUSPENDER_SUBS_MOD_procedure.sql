-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_suspender_subs_mod ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, ie_tipo_item_p text, cd_item_p text, ie_acao_p text, nm_usuario_p text, suspende_extensoes_p text, nr_seq_alter_p INOUT bigint, ie_inconsistencia_p INOUT text) AS $body$
DECLARE

 
cd_pessoa_fisica_w		varchar(10);
nr_prescr_orig_w			bigint;
nr_seq_orig_w			bigint;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
nr_prescr_atual_w			bigint;
nr_seq_atual_w			bigint;
nr_atendimento_w			bigint;
nr_seq_alter_w			bigint;
dt_suspensao_w			timestamp;
ie_inconsistencia_w			varchar(5);
ie_periodo_w			varchar(1);
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
					
c01 CURSOR FOR 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_material a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_material a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c02 CURSOR FOR 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_dieta a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_dieta a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c03 CURSOR FOR 
SELECT	a.nr_sequencia 
from	rep_jejum a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_sequencia 
from	rep_jejum a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c04 CURSOR FOR 
SELECT	a.nr_sequencia 
from	nut_pac a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_sequencia 
from	nut_pac a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c05 CURSOR FOR 
SELECT	a.nr_prescricao, 
	a.nr_seq_solucao 
from	prescr_solucao a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_prescricao, 
	a.nr_seq_solucao 
from	prescr_solucao a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c06 CURSOR FOR 
SELECT	a.nr_sequencia 
from	prescr_gasoterapia a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_sequencia 
from	prescr_gasoterapia a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c07 CURSOR FOR 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_procedimento a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_procedimento a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';

c08 CURSOR FOR 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_recomendacao a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.nr_atendimento		= nr_atendimento_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 

union all
 
SELECT	a.nr_prescricao, 
	a.nr_sequencia 
from	prescr_recomendacao a, 
	prescr_medica b 
where	a.nr_prescricao			= b.nr_prescricao 
and	a.nr_prescricao_original	= nr_prescr_orig_w 
and	a.nr_seq_anterior		= nr_seq_orig_w 
and	b.cd_pessoa_fisica		= cd_pessoa_fisica_w 
and	b.dt_inicio_prescr		> dt_suspensao_w 
and	coalesce(b.nr_atendimento::text, '') = '' 
and	coalesce(nr_atendimento_w::text, '') = '';
					

BEGIN 
 
select	max(dt_inicio_prescr), 
	max(dt_validade_prescr) 
into STRICT	dt_inicio_prescr_w, 
	dt_validade_prescr_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;	
 
if (clock_timestamp()	> dt_inicio_prescr_w) then 
	ie_periodo_w	:= 'N';
else 
	ie_periodo_w	:= 'S';
end if;
 
nr_prescr_orig_w	:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'P');
nr_seq_orig_w		:= PLT_obter_item_orig(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'S');
nr_prescr_atual_w	:= PLT_obter_item_plano_atual(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'P',ie_periodo_w,dt_inicio_prescr_w,dt_validade_prescr_w);
nr_seq_atual_w		:= PLT_obter_item_plano_atual(nr_prescricao_p, nr_sequencia_p, upper(nm_tabela_p),'S',ie_periodo_w,dt_inicio_prescr_w,dt_validade_prescr_w);
 
select	max(cd_pessoa_fisica), 
	max(nr_atendimento) 
into STRICT	cd_pessoa_fisica_w, 
	nr_atendimento_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescr_orig_w;
 
if (upper(nm_tabela_p)	= 'PRESCR_SOLUCAO') or 
	((upper(nm_tabela_p)	= 'PRESCR_PROCEDIMENTO') and (ie_tipo_item_p	= 'HM')) then 
  ie_inconsistencia_w := Consiste_supensao_prescr(nr_prescricao_p, nr_sequencia_p, nm_tabela_p, 'A', wheb_usuario_pck.get_cd_estabelecimento, ie_inconsistencia_w, wheb_usuario_pck.get_nm_usuario, Obter_perfil_Ativo);
end if;
 
if (ie_inconsistencia_w in ('SSI','SA')) then 
	ie_inconsistencia_p := ie_inconsistencia_w;
else 
	CALL PLT_atualizar_ie_modificar(nr_prescr_atual_w, nr_seq_atual_w, nm_tabela_p, 'S');
	CALL suspender_item_prescricao(nr_prescr_atual_w, nr_seq_atual_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
	nr_seq_alter_p := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescr_atual_w, nr_seq_atual_w, cd_item_p, ie_acao_p, '', nr_seq_alter_p, nm_usuario_p);
 
	if (suspende_extensoes_p = 'S') then 
	  select	max(dt_validade_prescr) 
		into STRICT	dt_suspensao_w 
		from	prescr_medica 
		where	nr_prescricao	= nr_prescr_atual_w;				
 
		if (nr_prescr_orig_w IS NOT NULL AND nr_prescr_orig_w::text <> '') and (nr_seq_orig_w IS NOT NULL AND nr_seq_orig_w::text <> '') then 
 
			if (upper(nm_tabela_p) = 'PRESCR_MATERIAL') then 
 
				open C01;
				loop 
				fetch C01 into	 
					nr_prescricao_w, 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C01;
			 
			elsif (upper(nm_tabela_p) = 'PRESCR_DIETA') then 
 
				open C02;
				loop 
				fetch C02 into	 
					nr_prescricao_w, 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C02;
			 
			elsif (upper(nm_tabela_p) = 'REP_JEJUM') then 
 
				open C03;
				loop 
				fetch C03 into	 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C03;		
 
			 
			elsif (upper(nm_tabela_p) = 'NUT_PAC') then 
 
				open C04;
				loop 
				fetch C04 into	 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C04;
			 
			elsif (upper(nm_tabela_p) = 'PRESCR_SOLUCAO') then 
 
				open C05;
				loop 
				fetch C05 into	 
					nr_prescricao_w, 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C05;		
			 
			elsif (upper(nm_tabela_p) = 'PRESCR_GASOTERAPIA') then 
			 
				open C06;
				loop 
				fetch C06 into	 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C06;
			 
			elsif (upper(nm_tabela_p) = 'PRESCR_PROCEDIMENTO') then 
 
				open C07;
				loop 
				fetch C07 into	 
					nr_prescricao_w, 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					begin 
					 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C07;		
 
			elsif (upper(nm_tabela_p) = 'PRESCR_RECOMENDACAO') then 
			 
				open C08;
				loop 
				fetch C08 into 
					nr_prescricao_w, 
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C08 */
					begin 
 
					CALL PLT_atualizar_ie_modificar(nr_prescricao_w, nr_sequencia_w, nm_tabela_p, 'S');
					CALL suspender_item_prescricao(nr_prescricao_w, nr_sequencia_w, 0, null, nm_tabela_p, nm_usuario_p, null,950);
					nr_seq_alter_w := PLT_atualizar_gerar_evento(ie_tipo_item_p, nr_prescricao_w, nr_sequencia_w, cd_item_p, ie_acao_p, '', nr_seq_alter_w, nm_usuario_p);
					end;
				end loop;
				close C08;				
			end if;
		end if;			
	end if;
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_suspender_subs_mod ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_tabela_p text, ie_tipo_item_p text, cd_item_p text, ie_acao_p text, nm_usuario_p text, suspende_extensoes_p text, nr_seq_alter_p INOUT bigint, ie_inconsistencia_p INOUT text) FROM PUBLIC;

