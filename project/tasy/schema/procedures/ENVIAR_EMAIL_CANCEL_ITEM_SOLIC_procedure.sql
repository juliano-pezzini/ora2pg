-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_cancel_item_solic ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, cd_motivo_baixa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_motivo_baixa_w				integer;
cd_estabelecimento_w			smallint;
cd_setor_atendimento_w			integer;
nm_usuario_sc_w				varchar(15);
dt_liberacao_w				timestamp;
ds_motivo_cancel_w			varchar(255);
cd_material_w				integer;
ds_material_w				varchar(255);

/* Enviar EMAIL para APROVADOR da solicitação de compra ( Solicitação - Ao cancelar item da solicitação de compra (Avisa o(s) aprovador(es)) ) */
 
nr_seq_regra_email_w			bigint;
ds_email_adicional_w			varchar(2000);
ds_email_destino_w				varchar(255);
ds_email_usuario_aprov_w			varchar(255);
ds_assunto_w				varchar(200);
ds_mensagem_w				varchar(2000);
ds_email_origem_w				varchar(255);
ie_usuario_w				varchar(3);
cd_perfil_disparar_w			integer;
ds_usuario_origem_w			varchar(255);
cd_comprador_w				varchar(10);
ds_email_comprador_w			varchar(255);
ds_usuario_comprador_w			varchar(255);

c06 CURSOR FOR 
	SELECT	distinct 
		Obter_Dados_Usuario_Opcao(substr(obter_usuarios_proc_aprov(a.nr_sequencia, a.nr_seq_proc_aprov),1,15),'E') ds_email_usuarios_aprov 
	from 	processo_aprov_compra a, 
		pessoa_fisica b 
	where 	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and 	a.nr_sequencia in (SELECT	distinct 
			nr_seq_aprovacao 
		from 	solic_compra_item 
		where 	nr_solic_compra = nr_solic_compra_p) 
	
union all
 
	select	distinct 
		Obter_Dados_Usuario_Opcao(substr(obter_usuarios_proc_aprov(a.nr_sequencia, a.nr_seq_proc_aprov),1,15),'E') ds_email_usuarios_aprov 
	from 	processo_aprov_compra a, 
		cargo b 
	where 	a.cd_cargo = b.cd_cargo 
	and 	a.nr_sequencia in (select	distinct 
			nr_seq_aprovacao 
		from 	solic_compra_item 
		where 	nr_solic_compra = nr_solic_compra_p) 
	order by 1;


BEGIN 
 
begin -- Inicio Exception 
 
cd_motivo_baixa_w	:= coalesce(cd_motivo_baixa_p,2);
 
select	coalesce(max(nr_sequencia),0), 
	max(replace(ds_email_adicional,',',';')) 
into STRICT	nr_seq_regra_email_w, 
	ds_email_adicional_w 
from	regra_envio_email_compra 
where	ie_tipo_mensagem = 50 
and	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p;
 
if (nr_seq_regra_email_w > 0) and (nr_item_solic_compra_p > 0) and (cd_motivo_baixa_w in (2,3)) then 
	begin 
 
	select	cd_estabelecimento, 
		cd_setor_atendimento, 
		nm_usuario, 
		dt_liberacao, 
		substr(obter_valor_dominio(45,cd_motivo_baixa_p),1,255), 
		cd_comprador_resp 
	into STRICT	cd_estabelecimento_w, 
		cd_setor_atendimento_w, 
		nm_usuario_sc_w, 
		dt_liberacao_w, 
		ds_motivo_cancel_w, 
		cd_comprador_w 
	from	solic_compra 
	where	nr_solic_compra = nr_solic_compra_p;
 
	if (nr_item_solic_compra_p > 0) then 
		select	cd_material, 
			substr(obter_desc_material(cd_material),1,255) 
		into STRICT	cd_material_w, 
			ds_material_w 
		from	solic_compra_item 
		where	nr_solic_compra = nr_solic_compra_p 
		and	nr_item_solic_compra = nr_item_solic_compra_p;
	end if;
 
	/* Enviar EMAIL para APROVADOR da solicitação de compra ( Solicitação - Ao cancelar item da solicitação de compra (Avisa o(s) aprovador(es)) ) */
 
	select	max(ds_email), 
		max(nm_guerra) 
	into STRICT	ds_email_comprador_w, 
		ds_usuario_comprador_w 
	from	comprador 
	where	cd_pessoa_fisica = cd_comprador_w 
	and	cd_estabelecimento = cd_estabelecimento_w;
 
	select	ds_assunto, 
		substr(ds_mensagem_padrao,1,2000) 
	into STRICT	ds_assunto_w, 
		ds_mensagem_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_email_w;
 
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@solicitacao',nr_solic_compra_p),1,200);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@nr_item',nr_item_solic_compra_p),1,200);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@material',cd_material_w),1,200);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@descricao',ds_material_w),1,200);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@motivo_cancelamento',ds_motivo_cancel_w),1,200);
 
	 
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@solicitacao',nr_solic_compra_p),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@nr_item',nr_item_solic_compra_p),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@material',cd_material_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@descricao',ds_material_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@motivo_cancelamento',ds_motivo_cancel_w),1,2000);
 
	select	coalesce(max(ie_usuario),'U'), 
		max(cd_perfil_disparar) 
	into STRICT	ie_usuario_w, 
		cd_perfil_disparar_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_email_w;
 
	if (ie_usuario_w = 'U') then --Usuario 
		select	ds_email, 
			nm_usuario 
		into STRICT	ds_email_origem_w, 
			ds_usuario_origem_w 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
	elsif (ie_usuario_w = 'C') then --Setor compras 
		select	ds_email 
		into STRICT	ds_email_origem_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_w;
 
		select	coalesce(ds_fantasia,ds_razao_social) 
		into STRICT	ds_usuario_origem_w 
		from	estabelecimento_v 
		where	cd_estabelecimento = cd_estabelecimento_w;
	elsif (ie_usuario_w = 'O') then --Comprador 
		ds_email_origem_w := ds_email_comprador_w;
		ds_usuario_origem_w := ds_usuario_comprador_w;
	end if;
 
	open C06;
	loop 
	fetch C06 into 
		ds_email_usuario_aprov_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin 
		if (ds_email_usuario_aprov_w IS NOT NULL AND ds_email_usuario_aprov_w::text <> '') and (obter_se_contido_char(ds_email_destino_w, ds_email_usuario_aprov_w) = 'N') then 
			ds_email_destino_w := ds_email_destino_w || ds_email_usuario_aprov_w || ';';
		end if;
		end;
	end loop;
	close C06;
 
	if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') and 
		((coalesce(cd_perfil_disparar_w::text, '') = '') or 
		(cd_perfil_disparar_w IS NOT NULL AND cd_perfil_disparar_w::text <> '' AND cd_perfil_disparar_w = obter_perfil_ativo)) then 
		ds_email_destino_w := ds_email_destino_w || ds_email_adicional_w || ';';
	end if;
 
	begin 
		CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_email_destino_w,ds_usuario_origem_w,'M');
	exception when others then 
		ds_assunto_w := '';
	end;
 
	end;
end if;
exception when others then 
	null;
end;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_cancel_item_solic ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, cd_motivo_baixa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

