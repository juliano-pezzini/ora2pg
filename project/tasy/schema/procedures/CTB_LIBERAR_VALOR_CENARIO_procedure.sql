-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_liberar_valor_cenario ( nr_seq_valores_p text, cd_centro_custo_p bigint, cd_conta_contabil_p text, ie_operacao_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_valores_w		varchar(4000);
nr_seq_orc_cen_valor_w	bigint;
pos_separador_w		bigint;



BEGIN

if (coalesce(cd_centro_custo_p, 0) = 0) and (coalesce(cd_conta_contabil_p, '0') = '0') then

	nr_seq_valores_w				:= substr(nr_seq_valores_p, 1, 4000);
	nr_seq_valores_w				:= replace(nr_seq_valores_w, ' ', '');

	while length(nr_seq_valores_w) > 0 loop
		begin

		pos_separador_w		:= position(',' in nr_seq_valores_w);
		if (pos_separador_w > 0) then

			nr_seq_orc_cen_valor_w	:= substr(nr_seq_valores_w, 1, pos_separador_w -1);
			nr_seq_valores_w		:= substr(nr_seq_valores_w, pos_separador_w +1,  length(nr_seq_valores_w));
		else
			nr_seq_orc_cen_valor_w	:= nr_seq_valores_w;
			nr_seq_valores_w		:= '';
		end if;

		if (ie_operacao_p = 'L') then

			update	ctb_orc_cen_valor
			set	dt_liberacao	= clock_timestamp(),
				nm_usuario_lib	= nm_usuario_p,
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_orc_cen_valor_w
			and	coalesce(dt_liberacao::text, '') = '';

		elsif (ie_operacao_p = 'E') then

			update	ctb_orc_cen_valor
			set	dt_liberacao	 = NULL,
				nm_usuario_lib	 = NULL,
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_orc_cen_valor_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

		end if;
		end;
	end loop;
else
	begin

	if (ie_operacao_p = 'L') then

		update	ctb_orc_cen_valor
		set	dt_liberacao		= clock_timestamp(),
			nm_usuario_lib		= nm_usuario_p,
			nm_usuario		= nm_usuario_p
		where	cd_centro_custo		= cd_centro_custo_p
		and	cd_conta_contabil		= coalesce(cd_conta_contabil_p, cd_conta_contabil)
		and	coalesce(dt_liberacao::text, '') = '';

	elsif (ie_operacao_p = 'E') then

		update	ctb_orc_cen_valor
		set	dt_liberacao		 = NULL,
			nm_usuario_lib		 = NULL,
			nm_usuario		= nm_usuario_p
		where	cd_centro_custo		= cd_centro_custo_p
		and	cd_conta_contabil		= coalesce(cd_conta_contabil_p, cd_conta_contabil)
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_liberar_valor_cenario ( nr_seq_valores_p text, cd_centro_custo_p bigint, cd_conta_contabil_p text, ie_operacao_p text, nm_usuario_p text) FROM PUBLIC;

