-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fechar_fluxo_mes (cd_estabelecimento_p bigint, dt_referencia_p timestamp, vl_saldo_inicial_p INOUT bigint, vl_saldo_final_p INOUT bigint, ie_tipo_fluxo_p text, nm_usuario_p text) AS $body$
DECLARE

			
cd_conta_financ_sant_w		bigint;
cont_w				bigint;
cd_conta_financ_saldo_w		bigint;
vl_saldo_inicial_w		double precision := 0;
vl_saldo_final_w		double precision := 0;
dt_referencia_inicial_w		timestamp;
dt_referencia_final_w		timestamp;
ie_fechamento_diario_w		varchar(10);


BEGIN

select	count(*)
into STRICT	cont_w
from	fluxo_caixa_fechamento
where	dt_referencia	= dt_referencia_p
and	coalesce(ie_tipo_fluxo, 'G') = coalesce(ie_tipo_fluxo_p, 'G')
and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

ie_fechamento_diario_w := Obter_Param_Usuario(830, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_fechamento_diario_w);

if (cont_w > 0) then
	--Ja existe um fechamento para este tipo de fluxo neste mes de referencia
	CALL wheb_mensagem_pck.exibir_mensagem_abort(218860,'',-20012);
end if;

if (coalesce(ie_tipo_fluxo_p, 'G') = 'G') then
	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '' AND dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
		select	max(cd_conta_financ_sant),
			max(cd_conta_financ_saldo)
		into STRICT	cd_conta_financ_sant_w,
			cd_conta_financ_saldo_w
		from	parametro_fluxo_caixa
		where	cd_estabelecimento	= cd_estabelecimento_p;

		if (cd_conta_financ_sant_w IS NOT NULL AND cd_conta_financ_sant_w::text <> '' AND cd_conta_financ_saldo_w IS NOT NULL AND cd_conta_financ_saldo_w::text <> '') then
			if (ie_fechamento_diario_w = 'S') then	
				
				select	min(dt_referencia),
					max(dt_referencia)
				into STRICT	dt_referencia_inicial_w,
					dt_referencia_final_w
				from	fluxo_caixa
				where	cd_estabelecimento		= cd_estabelecimento_p
				and	ie_classif_fluxo		= 'P'
				and	ie_periodo			= 'D'
				and	dt_referencia			= dt_referencia_p;
			
			else
		
				select	min(dt_referencia),
					max(dt_referencia)
				into STRICT	dt_referencia_inicial_w,
					dt_referencia_final_w
				from	fluxo_caixa
				where	cd_estabelecimento		= cd_estabelecimento_p
				and	ie_classif_fluxo		= 'P'
				and	trunc(dt_referencia, 'month') = trunc(dt_referencia_p, 'month');
		
			end if;

			select	max(vl_fluxo)
			into STRICT	vl_saldo_inicial_w
			from	fluxo_caixa
			where	cd_conta_financ		= cd_conta_financ_sant_w
			and	cd_estabelecimento	= cd_estabelecimento_p
			and	dt_referencia		= dt_referencia_inicial_w
			and	ie_classif_fluxo	= 'P';

			select	max(vl_fluxo)
			into STRICT	vl_saldo_final_w
			from	fluxo_caixa
			where	cd_conta_financ		= cd_conta_financ_saldo_w
			and	cd_estabelecimento	= cd_estabelecimento_p
			and	dt_referencia		= dt_referencia_final_w
			and	ie_classif_fluxo	= 'P';

		end if;

		if (coalesce(vl_saldo_inicial_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(218861,'',-20012);
			/*'Nao foi possivel obter o saldo inicial do fluxo para fechamento!' || chr(13) ||
							'E necessario ter um saldo inicial no primeiro dia do mes a ser fechado!#@#@');	*/
		elsif (coalesce(vl_saldo_final_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(218862,'',-20012);
			/*(-20011,'Nao foi possivel obter o saldo final do fluxo para fechamento!' || chr(13) ||
							'E necessario ter um saldo final no ultimo dia do mes a ser fechado#@#@!');*/
		end if;	
	end if;
end if;

vl_saldo_inicial_p	:= vl_saldo_inicial_w;
vl_saldo_final_p	:= vl_saldo_final_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fechar_fluxo_mes (cd_estabelecimento_p bigint, dt_referencia_p timestamp, vl_saldo_inicial_p INOUT bigint, vl_saldo_final_p INOUT bigint, ie_tipo_fluxo_p text, nm_usuario_p text) FROM PUBLIC;

