-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_bloq_lote_fornec ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_lote_fornec_p bigint) AS $body$
DECLARE


--Comunicação
nr_sequencia_w		bigint;
--Regra
cd_perfil_w		integer;
cd_setor_destino_w	integer;
cd_setor_adic_w		integer;
ds_comunicacao_w	varchar(2000);
ds_titulo_w		varchar(80);
ie_ci_lida_w		varchar(1);
nm_usuarios_adic_w	varchar(255);
nr_seq_evento_w		bigint;
cd_estab_destino_w	smallint;
ds_setor_adicional_w	varchar(2000);
--Lote
cd_material_w		bigint;
ds_lote_fornec_w	varchar(20);
ds_material_w		varchar(255);
dt_validade_w		timestamp;
dt_reimpressao_w	timestamp;
qt_saldo_w		double precision;
qt_material_w		bigint;
ds_bloqueio_w		varchar(20);

C01 CURSOR FOR
	SELECT	a.cd_estabelecimento,
		b.nr_sequencia,
		b.cd_perfil,
		b.cd_setor_destino,
		b.ds_comunicacao,
		b.ds_titulo,
		b.ie_ci_lida,
		b.nm_usuarios_adic
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.cd_evento = 55
	and	b.ie_situacao = 'A'
	and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p) = cd_estabelecimento_p
	and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,nr_seq_lote_fornec_p,'LF',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

c02 CURSOR FOR
	SELECT	cd_setor_atendimento
	from	regra_envio_comunic_usu
	where	nr_seq_evento = nr_seq_evento_w;


BEGIN

open C01;
loop
fetch C01 into
	cd_estab_destino_w,
	nr_seq_evento_w,
	cd_perfil_w,
	cd_setor_destino_w,
	ds_comunicacao_w,
	ds_titulo_w,
	ie_ci_lida_w,
	nm_usuarios_adic_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		open C02;
		loop
		fetch C02 into
			cd_setor_adic_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (coalesce(cd_setor_adic_w,0) <> 0) then
				ds_setor_adicional_w := substr(cd_setor_adic_w || ',' || ds_setor_adicional_w,1,2000);
			end if;
			end;
		end loop;
		close C02;

		select	cd_material,
			ds_lote_fornec,
			dt_validade,
			dt_reimpressao,
			qt_material,
			CASE WHEN ie_bloqueio='S' THEN wheb_mensagem_pck.get_Texto(311895) WHEN ie_bloqueio='N' THEN  wheb_mensagem_pck.get_Texto(311896)  ELSE wheb_mensagem_pck.get_Texto(311897) END
						/*'Bloqueado'*/
				/*Desbloqueado*/
				/*Não definido*/

		into STRICT	cd_material_w,
			ds_lote_fornec_w,
			dt_validade_w,
			dt_reimpressao_w,
			qt_material_w,
			ds_bloqueio_w
		from 	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_p;

		ds_material_w := substr(obter_desc_material(cd_material_w),1,255);

		qt_saldo_w := obter_saldo_lote_fornec(nr_seq_lote_fornec_p);

		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Usuario', nm_usuario_p),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Nr_sequencia', nr_seq_lote_fornec_p),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Cod_material', cd_material_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Desc_material', ds_material_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Ds_lote_fornec', ds_lote_fornec_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Dt_validade', dt_validade_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Dt_reimpressao', dt_reimpressao_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Qt_saldo', qt_saldo_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Qt_material', qt_material_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w, '@Bloqueio', ds_bloqueio_w),1,80);

		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Usuario', nm_usuario_p),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Nr_sequencia', nr_seq_lote_fornec_p),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Cod_material', cd_material_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Desc_material', ds_material_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Ds_lote_fornec', ds_lote_fornec_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Dt_validade', dt_validade_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Dt_reimpressao', dt_reimpressao_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Qt_saldo', qt_saldo_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Qt_material', qt_material_w),1,2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@Bloqueio', ds_bloqueio_w),1,2000);

		select	nextval('comunic_interna_seq')
		into STRICT	nr_sequencia_w
		;

		insert into	comunic_interna(
					dt_comunicado,
					ds_titulo,
					ds_comunicado,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_destino,
					cd_perfil,
					nr_sequencia,
					ie_gerencial,
					ie_geral,
					cd_setor_destino,
					cd_estab_destino,
					ds_setor_adicional,
					dt_liberacao)
				values (
					clock_timestamp(),
					ds_titulo_w,
					ds_comunicacao_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuarios_adic_w,
					cd_perfil_w,
					nr_sequencia_w,
					'N',
					'N',
					cd_setor_destino_w,
					cd_estab_destino_w,
					ds_setor_adicional_w,
					clock_timestamp());

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_bloq_lote_fornec ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_lote_fornec_p bigint) FROM PUBLIC;

