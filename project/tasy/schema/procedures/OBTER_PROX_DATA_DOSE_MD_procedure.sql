-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_prox_data_dose_md (qt_hora_intervalo_p bigint, dt_proxima_dose_p INOUT timestamp, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, qt_dia_prim_hor_p INOUT bigint, hr_prim_horario_p text, dt_horario_p timestamp, ie_info_rastre_prescr_p text, ds_alteracao_rastre_p INOUT text, ds_horarios_medic_p text, ie_dose_espec_agora_p text, nr_seq_kit_p bigint, ds_horarios_ww_p INOUT text, ie_altera_dt_proxima_dose_p text, ie_update_um_p INOUT text, ie_update_dois_p INOUT text, ie_update_tres_p INOUT text, ie_update_quatro_p INOUT text, ie_update_cinco_p INOUT text) AS $body$
BEGIN

ie_update_um_p   := 'N';
ie_update_dois_p  := 'N';
ie_update_tres_p   := 'N';
ie_update_quatro_p  := 'N';
ie_update_cinco_p  := 'N';


      if (qt_hora_intervalo_p > 24) then
        if ((coalesce(dt_proxima_dose_p::text, '') = '') or (dt_proxima_dose_p between dt_inicio_prescr_p and dt_validade_prescr_p)) then
          begin

            if (dt_proxima_dose_p IS NOT NULL AND dt_proxima_dose_p::text <> '') then
              if (dt_inicio_prescr_p > dt_proxima_dose_p) then
                qt_dia_prim_hor_p := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_p) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_p);
              else
                qt_dia_prim_hor_p := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_p) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_p);
              end if;
            else
              if (hr_prim_horario_p < to_char(dt_inicio_prescr_p,'hh24:mi')) then
                qt_dia_prim_hor_p := 1;
              else
                qt_dia_prim_hor_p := 0;
              end if;
            end if;

            if (qt_dia_prim_hor_p not between 0 and 1) then
              qt_dia_prim_hor_p := 0;
            end if;

            dt_proxima_dose_p  := coalesce(dt_horario_p, dt_proxima_dose_p) + dividir_sem_round_md(qt_hora_intervalo_p,24);

            if (mod(qt_hora_intervalo_p,24) > 0) then
              if (ie_info_rastre_prescr_p = 'S') then
                ds_alteracao_rastre_p := substr(ds_alteracao_rastre_p   || chr(13)
                              || ' 06 - linha: '
                              || ' qt_hora_intervalo_p: '   || qt_hora_intervalo_p
                              || ' dt_proxima_dose_p: '   || to_char(dt_proxima_dose_p,'dd/mm/yyyy hh24:mi:ss')
                              || ' dt_horario_p: '      || to_char(dt_horario_p,'dd/mm/yyyy hh24:mi:ss')
                              ,1,1800);
              end if;

              ie_update_um_p := 'S';

            else

              if ((coalesce(ds_horarios_medic_p::text, '') = '') and (ie_dose_espec_agora_p = 'S') and (nr_seq_kit_p IS NOT NULL AND nr_seq_kit_p::text <> '')) then

                ds_horarios_ww_p := null;
              else
                ds_horarios_ww_p := to_char(dt_proxima_dose_p, 'hh24:mi');
              end if;

              if (ie_info_rastre_prescr_p = 'S') then
                ds_alteracao_rastre_p := substr(ds_alteracao_rastre_p   || chr(13)
                              || ' 07 - linha: '
                              || ' qt_hora_intervalo_p: '   || qt_hora_intervalo_p
                              || ' dt_proxima_dose_p: '   || to_char(dt_proxima_dose_p,'dd/mm/yyyy hh24:mi:ss')
                              || ' dt_horario_p: '      || to_char(dt_horario_p,'dd/mm/yyyy hh24:mi:ss')
                              ,1,1800);
              end if;

              ie_update_dois_p := 'S';

            end if;

          end;
        elsif (ie_altera_dt_proxima_dose_p = 'S') and (dt_proxima_dose_p IS NOT NULL AND dt_proxima_dose_p::text <> '') and (dt_proxima_dose_p < dt_inicio_prescr_p) then
          begin

            if((dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (dt_horario_p >= dt_inicio_prescr_p) and (dt_horario_p < dt_validade_prescr_p)) then
              dt_proxima_dose_p := dt_horario_p + dividir_sem_round_md(qt_hora_intervalo_p,24);
            else
              dt_proxima_dose_p := dt_inicio_prescr_p + dividir_sem_round_md(qt_hora_intervalo_p,24);
            end if;

            qt_dia_prim_hor_p := to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_p), 'dd') - to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_p),'dd');
            if (qt_dia_prim_hor_p < 0) then
              qt_dia_prim_hor_p := 0;
            end if;

            if ((coalesce(ds_horarios_medic_p::text, '') = '') and (ie_dose_espec_agora_p = 'S')) then
              ds_horarios_ww_p := null;
            else
              ds_horarios_ww_p := to_char(dt_proxima_dose_p, 'hh24:mi');
            end if;

            if (ie_info_rastre_prescr_p = 'S') then
              ds_alteracao_rastre_p := substr( ds_alteracao_rastre_p    || chr(13)
                            || ' 08 - linha: '
                            || ' dt_proxima_dose_p: '   || to_char(dt_proxima_dose_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' ds_horarios_ww_p: '      || ds_horarios_ww_p
                            || ' dt_horario_p: '      || to_char(dt_horario_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' dt_inicio_prescr_p: '    || to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' dt_validade_prescr_p: '  || to_char(dt_validade_prescr_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' qt_hora_intervalo_p: '   || qt_hora_intervalo_p
                            || ' ds_horarios_medic_p: '   || ds_horarios_medic_p
                            || ' ie_dose_espec_agora_p: ' || ie_dose_espec_agora_p
                            ,1,1800);
            end if;

            ie_update_tres_p := 'S';


          end;
        elsif (dt_proxima_dose_p IS NOT NULL AND dt_proxima_dose_p::text <> '') then
          begin

            ie_update_quatro_p := 'S';


          end;
        end if;
      elsif (ie_altera_dt_proxima_dose_p = 'S') and (dt_proxima_dose_p IS NOT NULL AND dt_proxima_dose_p::text <> '') and (dt_proxima_dose_p < dt_inicio_prescr_p) then
        begin

          if ((dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (dt_horario_p >= dt_inicio_prescr_p) and (dt_horario_p < dt_validade_prescr_p)) then
            dt_proxima_dose_p := dt_horario_p + dividir_sem_round_md(qt_hora_intervalo_p,24);
          else
            dt_proxima_dose_p := dt_inicio_prescr_p + dividir_sem_round_md(qt_hora_intervalo_p,24);
          end if;

          qt_dia_prim_hor_p := to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_p), 'dd') - to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_p), 'dd');
          if (qt_dia_prim_hor_p < 0) then
            qt_dia_prim_hor_p := 0;
          end if;

          if ((coalesce(ds_horarios_medic_p::text, '') = '') and (ie_dose_espec_agora_p = 'S')) then
            ds_horarios_ww_p := null;
          else
            ds_horarios_ww_p := to_char(dt_proxima_dose_p, 'hh24:mi');
          end if;

          if (ie_info_rastre_prescr_p = 'S') then
            ds_alteracao_rastre_p := substr( ds_alteracao_rastre_p      || chr(13)
                            || ' 09 - linha: '
                            || ' dt_proxima_dose_p: '   || to_char(dt_proxima_dose_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' ds_horarios_ww_p: '      || ds_horarios_ww_p
                            || ' dt_horario_p: '      || to_char(dt_horario_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' dt_inicio_prescr_p: '    || to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' dt_validade_prescr_p: '  || to_char(dt_validade_prescr_p,'dd/mm/yyyy hh24:mi:ss')
                            || ' qt_hora_intervalo_p: '   || qt_hora_intervalo_p
                            || ' ds_horarios_medic_p: '   || ds_horarios_medic_p
                            || ' ie_dose_espec_agora_p: ' || ie_dose_espec_agora_p
                            ,1,1800);
          end if;

          
          ie_update_cinco_p := 'S';

        end;
      end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_prox_data_dose_md (qt_hora_intervalo_p bigint, dt_proxima_dose_p INOUT timestamp, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, qt_dia_prim_hor_p INOUT bigint, hr_prim_horario_p text, dt_horario_p timestamp, ie_info_rastre_prescr_p text, ds_alteracao_rastre_p INOUT text, ds_horarios_medic_p text, ie_dose_espec_agora_p text, nr_seq_kit_p bigint, ds_horarios_ww_p INOUT text, ie_altera_dt_proxima_dose_p text, ie_update_um_p INOUT text, ie_update_dois_p INOUT text, ie_update_tres_p INOUT text, ie_update_quatro_p INOUT text, ie_update_cinco_p INOUT text) FROM PUBLIC;

