-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sip_calcular_total_despesa ( ie_tipo_beneficiario_p text, ie_tipo_plano_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_lote_sip_p bigint, nm_usuario_p text, cd_estrutura_sup_p text, ie_tipo_despesa_p text, ie_tipo_guia_p text, nr_seq_tipo_atend_p bigint, cd_estabelecimento_p bigint, vl_total_despesa_p INOUT bigint, vl_total_eventos_p INOUT bigint, vl_total_recuperacao_p INOUT bigint, vl_total_glosa_p INOUT bigint) AS $body$
DECLARE

 
cd_conta_contabil_w		varchar(20);
cd_conta_contabil_ww		varchar(20);
ie_tipo_item_despesa_w		varchar(1);
vl_despesa_w			double precision	:= 0;
vl_despesa_ww			double precision	:= 0;
vl_glosa_item_w			double precision	:= 0;
vl_eventos_w			double precision	:= 0;
vl_eventos_ww			double precision	:= 0;
vl_recuperacao_w		double precision	:= 0;
vl_recuperacao_ww		double precision	:= 0;
vl_glosa_w			double precision	:= 0;
vl_glosa_ww			double precision	:= 0;
cd_classificacao_w		varchar(40);
qt_caracteres_classif_w		integer	:= 0;
vl_coparticipacao_proc_w	double precision	:= 0;
cd_conta_ans_w			varchar(20);
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;
vl_diops_w			double precision	:= 0;
vl_sip_diops_w			double precision	:= 0;
nr_seq_transacao_w		bigint;
cd_estabelecimento_w		smallint;

/* IE_TIPO_DESPESA_P 
	C - Contas médicas 
*/
 
 
C01 CURSOR FOR 
	SELECT	c.cd_conta_contabil, 
		b.ie_tipo_item_despesa, 
		substr(obter_dados_conta_contabil(c.cd_conta_contabil, c.cd_estabelecimento, 'CL'),1,40), 
		b.cd_conta_ans 
	from	sip_conta_contabil	c, 
		sip_tipo_item_despesa	b, 
		sip_tipo_despesa	a 
	where	a.nr_sequencia		= b.nr_seq_tipo_despesa 
	and	b.nr_sequencia		= c.nr_seq_tipo_item_desp 
	and	a.cd_estrutura		= cd_estrutura_sup_p;

C02 CURSOR FOR 
	SELECT	cd_conta_contabil 
	from	conta_contabil 
	where	substr(cd_classificacao,1,qt_caracteres_classif_w) = cd_classificacao_w 
	order by cd_classificacao desc;


BEGIN 
 
begin 
select	dt_periodo_inicial, 
	coalesce(dt_periodo_final, clock_timestamp()), 
	cd_estabelecimento 
into STRICT	dt_periodo_inicial_w, 
	dt_periodo_final_w, 
	cd_estabelecimento_w 
from	pls_lote_sip 
where	nr_sequencia	= nr_seq_lote_sip_p;	
exception 
	when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 266994, 'NR_SEQ_LOTE_SIP='||nr_seq_lote_sip_p);
end;
 
open C01;
loop 
fetch C01 into	 
	cd_conta_contabil_w, 
	ie_tipo_item_despesa_w, 
	cd_classificacao_w, 
	cd_conta_ans_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	vl_eventos_w		:= 0;
	vl_recuperacao_w	:= 0;
	vl_glosa_w		:= 0;	
	qt_caracteres_classif_w	:= length(cd_classificacao_w);
	open C02;
	loop 
	fetch C02 into	 
		cd_conta_contabil_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		vl_coparticipacao_proc_w	:= 0;
		/* Conta médica Ambulatorial */
 
		if (ie_tipo_despesa_p = 'A') then 
			/* Não for glosa */
 
			if (ie_tipo_item_despesa_w	<> 'G') then 
				select	coalesce(sum(c.vl_liberado + c.vl_glosa),0) 
				into STRICT	vl_despesa_w 
				from	pls_conta_proc		c, 
					pls_conta		b, 
					pls_protocolo_conta	a 
				where	a.nr_sequencia	= b.nr_seq_protocolo 
				and	b.nr_sequencia	= c.nr_seq_conta 
				and	c.cd_procedimento	= cd_procedimento_p 
				and	c.ie_origem_proced	= ie_origem_proced_p 
				and	ie_tipo_beneficiario	= ie_tipo_beneficiario_p 
				and	ie_tipo_plano		= ie_tipo_plano_p 
				and	pls_obter_se_internado(b.nr_sequencia, 'C')	= 'N' 
				and	c.cd_conta_deb 	= cd_conta_contabil_ww 
				and	a.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w 
				and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
			/* Somente as glosas */
 
			elsif (ie_tipo_item_despesa_w	= 'G') then 
				select	coalesce(sum(c.vl_glosa),0) 
				into STRICT	vl_glosa_item_w 
				from	pls_conta_proc		c, 
					pls_conta		b, 
					pls_protocolo_conta	a 
				where	a.nr_sequencia	= b.nr_seq_protocolo 
				and	b.nr_sequencia	= c.nr_seq_conta 
				and	c.cd_procedimento	= cd_procedimento_p 
				and	c.ie_origem_proced	= ie_origem_proced_p 
				and	ie_tipo_beneficiario	= ie_tipo_beneficiario_p 
				and	ie_tipo_plano		= ie_tipo_plano_p 
				and	pls_obter_se_internado(b.nr_sequencia, 'C')	= 'N' 
				and	c.cd_conta_glosa_deb 	= cd_conta_contabil_ww 
				and	a.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w 
				and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
			end if;
			 
			select	coalesce(sum(d.vl_coparticipacao),0) 
			into STRICT	vl_coparticipacao_proc_w 
			from 	pls_lote_mensalidade		g, 
				pls_mensalidade			f, 
				pls_mensalidade_segurado 	e, 
				pls_conta_coparticipacao 	d, 
				pls_conta_proc  		c, 
				pls_conta			b, 
				pls_protocolo_conta		a 
			where 	a.nr_sequencia			= b.nr_seq_protocolo 
			and	b.nr_sequencia 		= c.nr_seq_conta 
			and 	c.nr_sequencia 		= d.nr_seq_conta_proc 
			and 	d.nr_seq_mensalidade_seg	= e.nr_sequencia 
			and	e.nr_seq_mensalidade		= f.nr_sequencia 
			and	f.nr_seq_lote			= g.nr_sequencia 
			and	c.cd_procedimento		= cd_procedimento_p 
			and	c.ie_origem_proced		= ie_origem_proced_p 
			and	ie_tipo_beneficiario		= ie_tipo_beneficiario_p 
			and	ie_tipo_plano			= ie_tipo_plano_p 
			and	d.cd_conta_cred 		= cd_conta_contabil_ww 
			and 	g.dt_mesano_referencia between dt_periodo_inicial_w and dt_periodo_final_w 
			and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
		/* Material Ambulatorial */
 
		elsif (ie_tipo_despesa_p = 'MA') then 
			select	coalesce(sum(c.vl_glosa),0) 
			into STRICT	vl_glosa_item_w 
			from	pls_conta_mat		c, 
				pls_conta		b, 
				pls_protocolo_conta	a 
			where	a.nr_sequencia	= b.nr_seq_protocolo 
			and	b.nr_sequencia	= c.nr_seq_conta 
			and	a.ie_status	= 3 
			and	a.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w 
			and	pls_obter_se_internado(b.nr_sequencia, 'C')	= 'N' 
			and	c.nr_seq_grupo_ans	= 6 
			and	ie_tipo_beneficiario	= ie_tipo_beneficiario_p 
			and	ie_tipo_plano		= ie_tipo_plano_p 
			and	c.cd_conta_glosa_deb 	= cd_conta_contabil_ww 
			and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
		/* Material de internação de até 24 horas */
 
		elsif (ie_tipo_despesa_p = 'MI1') then 
			select	coalesce(sum(c.vl_glosa),0) 
			into STRICT	vl_glosa_item_w 
			from	pls_conta_mat		c, 
				pls_conta		b, 
				pls_protocolo_conta	a 
			where	a.nr_sequencia	= b.nr_seq_protocolo 
			and	b.nr_sequencia	= c.nr_seq_conta 
			and	a.ie_status	= 3 
			and	a.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w 
			and	coalesce(b.qt_diarias_sip,2)	= 1 
			and	pls_obter_se_internado(b.nr_sequencia, 'C')	= 'S' 
			and	c.nr_seq_grupo_ans in (10,11) 
			and	ie_tipo_beneficiario	= ie_tipo_beneficiario_p 
			and	ie_tipo_plano		= ie_tipo_plano_p 
			and	c.cd_conta_glosa_deb 	= cd_conta_contabil_ww 
			and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
		/* Material de internação de mais de 24 horas */
 
		elsif (ie_tipo_despesa_p = 'MI2') then 
			select	coalesce(sum(c.vl_glosa),0) 
			into STRICT	vl_glosa_item_w 
			from	pls_conta_mat		c, 
				pls_conta		b, 
				pls_protocolo_conta	a 
			where	a.nr_sequencia	= b.nr_seq_protocolo 
			and	b.nr_sequencia	= c.nr_seq_conta 
			and	a.ie_status	= 3 
			and	a.dt_mes_competencia between dt_periodo_inicial_w and dt_periodo_final_w 
			and	coalesce(b.qt_diarias_sip,2)	<> 1 
			and	pls_obter_se_internado(b.nr_sequencia, 'C')	= 'S' 
			and	c.nr_seq_grupo_ans in (10,11) 
			and	ie_tipo_beneficiario	= ie_tipo_beneficiario_p 
			and	ie_tipo_plano		= ie_tipo_plano_p 
			and	c.cd_conta_glosa_deb 	= cd_conta_contabil_ww 
			and	coalesce(b.ie_tipo_segurado,'B')	= 'B';
		end if;
		 
		if (ie_tipo_item_despesa_w	= 'E') then 
			vl_eventos_w		:= vl_eventos_w + vl_despesa_w;
		elsif (ie_tipo_item_despesa_w	= 'R') then 
			vl_recuperacao_w	:= vl_recuperacao_w + vl_despesa_w;
		elsif (ie_tipo_item_despesa_w	= 'G') then 
			vl_glosa_w		:= vl_glosa_w + vl_glosa_item_w + vl_coparticipacao_proc_w;
		end if;
		end;
	end loop;
	close C02;
	end;
	vl_despesa_w	:= vl_eventos_w - (vl_recuperacao_w + vl_glosa_w);
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_transacao_w 
	from	diops_transacao 
	where	ie_tipo_transacao	= 'F' 
	and	cd_estabelecimento = cd_estabelecimento_p;	
	 
	select	coalesce(sum(CASE WHEN trunc(d.dt_referencia,'month')=trunc(dt_periodo_final_w,'month') THEN  c.vl_saldo  ELSE 0 END ),0) 
	into STRICT	vl_diops_w 
	from	ctb_mes_ref			d, 
		ctb_balancete_v			c, 
		diops_trans_conta_contab	b, 
		diops_trans_conta		a 
	where	a.nr_sequencia			= b.nr_seq_trans_conta 
	and	b.cd_conta_contabil		= c.cd_conta_contabil 
	and	c.nr_seq_mes_ref		= d.nr_sequencia 
	and	a.nr_seq_transacao		= nr_seq_transacao_w 
	and	c.ie_normal_encerramento	= 'N' 
	and	c.ie_tipo_conta			= 'D' 
	and	a.ie_tipo_conta			= 'C' 
	and	a.ie_plano_conta		= 'D' 
	and	a.ds_conta			= cd_conta_ans_w 
	and	d.dt_referencia between dt_periodo_inicial_w and dt_periodo_final_w 
	and	a.cd_estabelecimento		= cd_estabelecimento_w;
	 
	vl_sip_diops_w	:= vl_despesa_w - vl_diops_w;
	 
	insert into pls_desp_sip_diops_conta(	 
		nr_sequencia, cd_estrutura, nr_seq_lote_sip, 
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec, 
		nm_usuario_nrec, vl_sip, vl_diops, 
		vl_sip_diops, vl_eventos, vl_recuperacao, 
		vl_glosa, cd_conta_ans) 
	values (	nextval('pls_desp_sip_diops_conta_seq'), cd_estrutura_sup_p, nr_seq_lote_sip_p, 
		clock_timestamp(), nm_usuario_p, clock_timestamp(), 
		nm_usuario_p, vl_despesa_w, vl_diops_w, 
		vl_sip_diops_w, vl_eventos_w, vl_recuperacao_w, 
		vl_glosa_w, cd_conta_ans_w);
	 
	vl_eventos_ww		:= vl_eventos_ww + vl_eventos_w;
	vl_recuperacao_ww	:= vl_recuperacao_ww + vl_recuperacao_w;
	vl_glosa_ww		:= vl_glosa_ww + vl_glosa_w;
end loop;
close C01;
 
/*Página 6 da RN 152 - 4. Total de despesa: É o gasto total da operadora com os eventos realizados pelos expostos nos itens de despesas assistenciais definidos, descontados os 
valores de glosas, e as recuperações de eventos em co-responsabilidade, expressos em reais. */
 
vl_despesa_ww		:= vl_eventos_ww - (vl_recuperacao_ww + vl_glosa_ww);
if (ie_tipo_despesa_p in ('MA','MI1','MI2')) then 
	vl_despesa_ww	:= vl_glosa_ww;
end if;
 
vl_total_despesa_p	:= vl_despesa_ww;
vl_total_eventos_p	:= vl_eventos_ww;
vl_total_recuperacao_p	:= vl_recuperacao_ww;
vl_total_glosa_p	:= vl_glosa_ww;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sip_calcular_total_despesa ( ie_tipo_beneficiario_p text, ie_tipo_plano_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_lote_sip_p bigint, nm_usuario_p text, cd_estrutura_sup_p text, ie_tipo_despesa_p text, ie_tipo_guia_p text, nr_seq_tipo_atend_p bigint, cd_estabelecimento_p bigint, vl_total_despesa_p INOUT bigint, vl_total_eventos_p INOUT bigint, vl_total_recuperacao_p INOUT bigint, vl_total_glosa_p INOUT bigint) FROM PUBLIC;

