-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_projeto_html ( nr_seq_projeto_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nm_usuario_exec_w		varchar(15);
nr_seq_gerencia_w		bigint;
cd_estabelecimento_w	smallint;
nr_seq_grupo_des_w		bigint;
nr_seq_cliente_w		bigint;
nr_seq_localizacao_w	bigint;
nr_seq_equipamento_w	bigint;
nr_seq_proj_cron_etp_w	bigint;
cd_funcao_w		integer;
ds_etapa_w		varchar(4000);
ds_atividade_w		varchar(255);
cd_coordenador_w		varchar(10);
nr_seq_ordem_w		bigint;
nr_seq_projeto_w		bigint;
ie_gera_ordem_auto_w	varchar(1);
ie_fase_w		varchar(1);

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		p.nr_seq_cliente, 
		p.cd_estabelecimento, 
		p.cd_funcao, 
		substr(obter_usuario_pessoa(p.cd_coordenador),1,15), 
		p.cd_coordenador, 
		p.nr_seq_grupo_des 
	from 	proj_projeto p 
	Where 	p.nr_sequencia	= nr_seq_projeto_p;

 
C02 CURSOR FOR 
	SELECT	e.nr_sequencia, 
		trim(both coalesce(e.ds_etapa,e.ds_atividade)) ds_etapa, 
		trim(both e.ds_atividade), 
		coalesce(c.ie_gera_ordem_auto,'A'), 
		coalesce(e.ie_fase,'N') 
	from	proj_projeto p, 
		proj_cronograma c, 
		proj_cron_etapa e 
	where	p.nr_sequencia = nr_seq_projeto_w 
	and	p.nr_sequencia = c.nr_seq_proj 
	and	c.nr_sequencia = e.nr_seq_cronograma 
	and	c.ie_tipo_cronograma = 'E' 
	and	c.ie_situacao = 'A' 
	and 	coalesce(e.pr_etapa,0) <> 100 
	and    not exists (	SELECT	1 
				from	man_ordem_servico_v x 
				where	x.nr_seq_proj_cron_etapa = e.nr_sequencia) 
	and	not exists (	select	1 
			from	proj_cron_etapa x 
			where	x.nr_seq_superior = e.nr_sequencia);


BEGIN 
 
open C01;
loop 
fetch C01 into 
	nr_seq_projeto_w, 
	nr_seq_cliente_w, 
	cd_estabelecimento_w, 
	cd_funcao_w, 
	nm_usuario_exec_w, 
	cd_coordenador_w, 
	nr_seq_grupo_des_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
 
	nr_seq_equipamento_w:= 41;
 
	nr_seq_localizacao_w	:= 41;
 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_proj_cron_etp_w, 
		ds_etapa_w, 
		ds_atividade_w, 
		ie_gera_ordem_auto_w, 
		ie_fase_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		if (ie_gera_ordem_auto_w <> 'N') and (ie_fase_w = 'N') then 
		 
			nr_seq_ordem_w := man_gerar_os_proj_etapa_html(nr_seq_ordem_w, /*nr_sequencia_w*/
 
					cd_coordenador_w, /*cd_pessoa_solicitante_p*/
 
					nr_seq_localizacao_w, /*nr_seq_localizacao_p*/
 
					nr_seq_equipamento_w, /*nr_seq_equipamento_p*/
 
					'Proj. ' ||nr_seq_projeto_w|| ' - ' || ds_atividade_w, /*ds_dano_breve_p*/
 
					coalesce(ds_etapa_w,ds_atividade_w), /*ds_dano_p*/
 
					cd_funcao_w, /*cd_funcao_p*/
 
					'S', /*ie_classificacao_p*/
 
					'U', /*ie_forma_receb_p*/
 
					clock_timestamp() + interval '1 days', /*dt_inicio_previsto_p*/
 
					clock_timestamp() + interval '20 days', /*dt_fim_previsto_p*/
 
					4, /*nr_seq_estagio_p*/
 
					'4', /*ie_tipo_ordem_p*/
 
					'1', /*nr_grupo_planej_p*/
 
					'1', /*nr_grupo_trabalho_p*/
 
					'M', /*ie_prioridade_p*/
 
					'1', /*ie_status_ordem_p*/
 
					substr(obter_usuario_pessoa(cd_coordenador_w),1,15), /*nm_usuario_p*/
 
					nr_seq_proj_cron_etp_w, /*nr_seq_proj_cron_etapa_p*/
 
					nr_seq_grupo_des_w, /*nr_seq_grupo_des_p*/
 
					nr_seq_projeto_w, /*nr_seq_projeto_w*/
 
					10, null, null, cd_estabelecimento_w); 						/*nr_seq_ativ_exec_p*/
		end if;	
		end;
	end loop;
	close C02;	
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_projeto_html ( nr_seq_projeto_p bigint, nm_usuario_p text) FROM PUBLIC;

