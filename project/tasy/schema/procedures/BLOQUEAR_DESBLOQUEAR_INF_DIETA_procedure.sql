-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bloquear_desbloquear_inf_dieta ( nr_seq_horario_p bigint, nr_seq_justificativa_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE

 
ora2pg_rowcount int;
dt_bloqueio_w				timestamp;
nr_prescricao_w				bigint;
dt_horario_w				timestamp;
dt_bloqueio_sup_w			timestamp;
nr_seq_alteracao_w			bigint;
ie_alteracao_w				smallint;
ds_justificativa_w			varchar(100);
nr_atendimento_w			bigint;
cd_refeicao_w				varchar(15);
cd_dieta_w					bigint;
ie_horarios_dietas_orais_w	varchar(1);
cd_estabelecimento_w		smallint;
cd_item_w					varchar(255);
ie_agrupa_servico_w			varchar(1);
ie_bloqueia_suplemento_w	varchar(1);
ie_alterar_todos_w			varchar(1);
nr_seq_horario_dieta_w		bigint;
nr_seq_nut_atend_w			bigint;
nr_seq_material_w			bigint;
nr_seq_horario_w			bigint;


BEGIN 
 
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then 
	 
	if (ie_tipo_item_p	= 'D') then 
	 
		select	max(c.nr_prescricao), 
				max(c.dt_horario), 
				max(c.cd_refeicao), 
				max(c.dt_bloqueio),		 
				max(b.cd_dieta), 
				max(a.nr_atendimento), 
				max(a.cd_estabelecimento) 
		into STRICT	nr_prescricao_w, 
				dt_horario_w, 
				cd_refeicao_w, 
				dt_bloqueio_w, 
				cd_dieta_w, 
				nr_atendimento_w, 
				cd_estabelecimento_w 
		from	prescr_medica a, 
				prescr_dieta b, 
				prescr_dieta_hor c 
		where	a.nr_prescricao	= b.nr_prescricao 
		and		a.nr_prescricao	= c.nr_prescricao 
		and		b.nr_prescricao	= c.nr_prescricao 
		and		c.nr_seq_dieta	= b.nr_sequencia 
		and		c.nr_sequencia	= nr_seq_horario_p;
			 
		ie_horarios_dietas_orais_w := Obter_Param_Usuario(1113, 148, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_horarios_dietas_orais_w);
		ie_bloqueia_suplemento_w := obter_param_usuario(1113, 558, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_bloqueia_suplemento_w);
		 
		if (ie_horarios_dietas_orais_w	= 'S') and (cd_refeicao_w IS NOT NULL AND cd_refeicao_w::text <> '') then 
			cd_item_w	:= cd_refeicao_w;
		else 
			cd_item_w	:= cd_dieta_w;
		end if;	
		 
		if (coalesce(dt_bloqueio_w::text, '') = '') then 
			update	prescr_dieta_hor 
			set		dt_bloqueio = clock_timestamp(), 
					dt_desbloqueio_dieta  = NULL, 
					nr_seq_justif_bloqueio = nr_seq_justificativa_p, 
					nm_usuario_bloqueio = nm_usuario_p 
			where	((nr_sequencia = nr_seq_horario_p) or (dt_horario > dt_horario_w)) 
			and 	nr_prescricao = nr_prescricao_w;
 
			if (ie_bloqueia_suplemento_w = 'S') then 
				CALL bloqueia_suplemento_oral(nr_atendimento_w,dt_horario_w,'B');
			end if;				
			ie_alteracao_w := 43;
			 
		elsif (dt_bloqueio_w IS NOT NULL AND dt_bloqueio_w::text <> '') then 
			update	prescr_dieta_hor 
			set		dt_bloqueio  = NULL, 
					dt_desbloqueio_dieta = clock_timestamp(), 
					nm_usuario_bloqueio  = NULL 
			where	((nr_sequencia = nr_seq_horario_p) or (dt_horario > dt_horario_w)) 
			and 	nr_prescricao = nr_prescricao_w;
 
			if (ie_bloqueia_suplemento_w = 'S') then 
				CALL bloqueia_suplemento_oral(nr_atendimento_w,dt_horario_w,'D');
			end if;
			ie_alteracao_w := 44;
		end if;
		nr_seq_horario_dieta_w	:= nr_seq_horario_p;
		 
	elsif (ie_tipo_item_p	= 'DE') then 
 
		select	max(a.nr_prescricao), 
				max(x.dt_servico), 
				max(x.dt_bloqueio), 
				max(a.nr_atendimento), 
				max(a.cd_estabelecimento) 
		into STRICT	nr_prescricao_w, 
				dt_horario_w, 
				dt_bloqueio_w, 
				nr_atendimento_w, 
				cd_estabelecimento_w 
		from	prescr_medica a, 
				nut_atend_serv_dia x, 
				prescr_dieta c 
		where	x.nr_atendimento	= a.nr_atendimento 
		and		c.nr_prescricao		= a.nr_prescricao 
		and		x.nr_sequencia		= nr_seq_horario_p;
 
		ie_agrupa_servico_w := Obter_Param_Usuario(1113, 477, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_agrupa_servico_w);
		ie_alterar_todos_w := Obter_Param_Usuario(1113, 486, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_alterar_todos_w);
		 
		select	max(CASE WHEN ie_agrupa_servico_w='S' THEN  to_char(d.nr_sequencia)  ELSE to_char(x.nr_sequencia) END ) 
		into STRICT	cd_item_w 
		from	prescr_dieta d, 
				prescr_medica a, 
				nut_atend_serv_dia x	 
		where	x.nr_atendimento	= a.nr_atendimento 
		and		x.nr_sequencia		= nr_seq_horario_p 
		and		d.nr_prescricao		= a.nr_prescricao;
		 
		if (coalesce(dt_bloqueio_w::text, '') = '') then 
			update	nut_atend_serv_dia 
			set		dt_bloqueio	= clock_timestamp(), 
					dt_desbloqueio	 = NULL, 
					nr_seq_justif_bloqueio = nr_seq_justificativa_p, 
					nm_usuario_bloqueio = nm_usuario_p 
			where	((nr_sequencia	= nr_seq_horario_p) or 
					 (ie_alterar_todos_w = 'S' AND dt_servico > dt_horario_w)) 
			and 	nr_atendimento	= nr_atendimento_w;
			ie_alteracao_w := 43;
			 
		elsif (dt_bloqueio_w IS NOT NULL AND dt_bloqueio_w::text <> '') then 
			update	nut_atend_serv_dia 
			set		dt_bloqueio 	 = NULL, 
					dt_desbloqueio	= clock_timestamp(), 
					nm_usuario_bloqueio  = NULL 
			where	((nr_sequencia	= nr_seq_horario_p) or 
					 (ie_alterar_todos_w = 'S' AND dt_servico > dt_horario_w)) 
			and 	nr_atendimento	= nr_atendimento_w;
			ie_alteracao_w := 44;
		end if;
		nr_seq_nut_atend_w	:= nr_seq_horario_p;	
 
	elsif (ie_tipo_item_p = 'LD') then 
		select 	max(b.dt_horario), 
				max(b.dt_bloqueio), 
				max(b.nr_prescricao), 
				max(b.nr_seq_material), 
				max(b.cd_material) 
		into STRICT	dt_horario_w, 
				dt_bloqueio_w, 
				nr_prescricao_w, 
				nr_seq_material_w, 
				cd_item_w 
		from	prescr_mat_hor b 
		where	b.nr_sequencia = nr_seq_horario_p 
		and		b.ie_agrupador = 16;
		 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_w;
		 
		if (coalesce(dt_bloqueio_w::text, '') = '') then 
			update	prescr_mat_hor 
			set		dt_bloqueio 		= clock_timestamp(), 
					nm_usuario_bloqueio = nm_usuario_p 
			where	((nr_sequencia = nr_seq_horario_p) or (dt_horario > dt_horario_w)) 
			and		nr_prescricao = nr_prescricao_w 
			and		nr_seq_material = nr_seq_material_w;
			ie_alteracao_w := 53;
		else 
			update	prescr_mat_hor 
			set		dt_bloqueio 		 = NULL, 
					nm_usuario_bloqueio  = NULL 
			where	((nr_sequencia = nr_seq_horario_p) or (dt_horario > dt_horario_w)) 
			and		nr_prescricao = nr_prescricao_w 
			and		nr_seq_material = nr_seq_material_w;
			ie_alteracao_w := 54;
		end if;
		nr_seq_horario_w := nr_seq_horario_p;
	end if;
 
 
	ds_justificativa_w := '';
	 
	select	max(ds_justificativa) 
	into STRICT	ds_justificativa_w 
	from	dieta_justif_bloqueio 
	where	nr_sequencia = nr_seq_justificativa_p;
 
	GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

 
	if ( ora2pg_rowcount > 0) then 
	 
		select	nextval('prescr_mat_alteracao_seq') 
		into STRICT	nr_seq_alteracao_w 
		;
 
		insert	into	prescr_mat_alteracao( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_horario_dieta,			 
			nr_seq_nut_atend, 
			nr_seq_horario, 
			dt_alteracao, 
			cd_pessoa_fisica, 
			ie_alteracao, 
			ds_justificativa, 
			ie_tipo_item, 
			dt_horario, 
			nr_atendimento, 
			cd_item 
			) 
		values ( 
			nr_seq_alteracao_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_prescricao_w, 
			nr_seq_horario_dieta_w, 
			nr_seq_nut_atend_w, 
			nr_seq_horario_w, 
			clock_timestamp(), 
			obter_dados_usuario_opcao(nm_usuario_p,'C'), 
			ie_alteracao_w, 
			ds_justificativa_w, 
			ie_tipo_item_p, 
			dt_horario_w, 
			nr_atendimento_w, 
			cd_item_w);
	end if;		
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bloquear_desbloquear_inf_dieta ( nr_seq_horario_p bigint, nr_seq_justificativa_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

