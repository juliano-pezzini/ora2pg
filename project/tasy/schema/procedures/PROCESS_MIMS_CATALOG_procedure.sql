-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE process_mims_catalog ( nr_mims_version_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


nr_sequencia_tech_w			bigint;
cd_classe_material_w		bigint;
cd_sub_groupo_material_w	bigint;

c_imp_material_w CURSOR FOR
	SELECT	a.cd_material
	from 	imp_material a
	where	a.nr_seq_mims_version=nr_mims_version_p;	

c_imp_material_new_w CURSOR FOR
	SELECT	a.cd_material
	from 	imp_material a
	where	a.nr_seq_mims_version=nr_mims_version_p and ie_dirty_check=2;		

c_imp_material_upd_w CURSOR FOR
	SELECT	a.cd_material
	from 	imp_material a
	where	a.nr_seq_mims_version=nr_mims_version_p and IE_CD_SISTEMA_ANT_UPDATED=1;		

c_medic_ficha CURSOR FOR
	SELECT	c.cd_dcb
	from   	imp_dcb_medic_controlado c
	EXCEPT
	SELECT 	c.cd_dcb
	from 	dcb_medic_controlado c;

BEGIN
	begin
      CALL imp_interacao_medic_ficha(nm_usuario_p,nr_mims_version_p);
	exception
	when others then
		rollback;
		raise;
	end;	


	begin      
      CALL insert_material_mims(cd_estabelecimento_p,nr_mims_version_p,nm_usuario_p);
	 exception
		when others then
			rollback;
			raise;
	end;
      update	mims_version
      set		ie_status = 2,
        DT_IMPORTATION_MATERIAL_CAT = clock_timestamp() -- Process completed
      where 	nr_sequencia = nr_mims_version_p;

	begin
		CALL UPD_ORIENTACAO_USUARIO();
	exception
	when others then
		commit;
	end;

	for r_imp_material_w in c_imp_material_w loop
		begin						   
			CALL compare_mims_material(r_imp_material_w.cd_material,
									nr_mims_version_p,
									nm_usuario_p,
									cd_estabelecimento_p);
		exception when others then
			rollback;
			raise;
		end;		
	end loop;

	--Due to the nature in which MIMS handles changes to PACKDAT a new PACKCODE is being created for few cases where there are modifications related to PBS for existing PACKCODE. As per TASY, such items should be identified as Updates to existing records instead of creating a new duplicate material record.

	--Let us loop through all the records marked as NEW and update them as UPDATES AVAILABLE whenerever applicable, thereby avoiding duplicate entries.
	for r_imp_material_new_w in c_imp_material_new_w loop
		begin
			CALL mims_adjust_new_materials(r_imp_material_new_w.cd_material, nr_mims_version_p, nm_usuario_p, cd_estabelecimento_p);
		exception when others then
			rollback;
		end;
	end loop;
	
	--Rerun the compare_mims_material for the imp_material records adjusted in the above loop.
	for r_imp_material_upd_w in c_imp_material_upd_w loop
		begin
			CALL compare_mims_material(r_imp_material_upd_w.cd_material,
									nr_mims_version_p,
									nm_usuario_p,
									cd_estabelecimento_p);
		exception when others then
			rollback;
		end;
	end loop;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE process_mims_catalog ( nr_mims_version_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

