-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_liberar_solicitacao_js ( nr_seq_lote_p bigint, nr_seq_solic_p bigint, ie_opcao_p text, ie_consistir_p text, nm_usuario_p text) AS $body$
DECLARE

					 
dt_liberacao_w		timestamp	:= clock_timestamp();
nr_seq_solic_w		bigint;
ie_existe_w		varchar(1);
ie_solicitante_lib_w	varchar(1);
cd_pessoa_solicitante_w	varchar(10);

c01 CURSOR FOR	 
	SELECT	nr_sequencia 
	from	same_solic_pront 
	where	coalesce(nr_seq_lote, 0)	= coalesce(coalesce(nr_seq_lote_p, nr_seq_lote), 0) 
	and	nr_sequencia		= coalesce(nr_seq_solic_p, nr_sequencia) 
	and		coalesce(dt_liberacao::text, '') = '' 
	and ((nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') or (nr_seq_solic_p IS NOT NULL AND nr_seq_solic_p::text <> ''));


BEGIN 
ie_solicitante_lib_w := obter_valor_param_usuario(941, 185, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
 
if (ie_opcao_p = '1') then 
	select (cd_pessoa_solicitante) 
	into STRICT	cd_pessoa_solicitante_w 
	from	same_solic_pront 
	where	nr_sequencia = nr_seq_solic_p;
else 
	select	max(cd_pessoa_solicitante) 
	into STRICT	cd_pessoa_solicitante_w 
	from	same_solic_pront_lote 
	where	nr_sequencia = nr_seq_lote_p;
end if;
 
if (ie_solicitante_lib_w = 'S') and (cd_pessoa_solicitante_w <> Obter_Pf_Usuario(nm_usuario_p,'C')) then 
	--É permitida a liberação apenas pela pessoa solicitante! Parâmetro [185]. 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(199202);
end if;
 
if (ie_consistir_p = 'O') then 
 
	if (ie_opcao_p = '1') then 
	 
		select 	coalesce(max('S'),'N') 
		into STRICT	ie_existe_w 
		from 	same_solic_pront_envelope 
		where 	nr_seq_solic = nr_seq_solic_p;
	 
	else 
		select 	coalesce(max('S'),'N') 
		into STRICT	ie_existe_w 
		from 	same_solic_pront_envelope 
		where 	nr_seq_solic in (	SELECT 	nr_sequencia 
						from 	same_solic_pront 
                        where 	nr_seq_lote = nr_seq_lote_p);
	 
	end if;
	 
	if (ie_existe_w = 'N') then 
		--É obrigatória a informação dos envelopes/caixas da solicitação. Parâmetro [26]. 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(66941);
	end if;
 
end if;
 
open c01;
loop 
fetch c01 into	 
	nr_seq_solic_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	update	same_solic_pront 
    set	dt_liberacao	= dt_liberacao_w, 
		nm_usuario_liberacao = nm_usuario_p 
    where	nr_sequencia	= nr_seq_solic_w;
	end;
end loop;
close c01;
 
if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then 
	update	same_solic_pront_lote 
	set	dt_liberacao	= dt_liberacao_w 
	where	nr_sequencia	= nr_seq_lote_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_liberar_solicitacao_js ( nr_seq_lote_p bigint, nr_seq_solic_p bigint, ie_opcao_p text, ie_consistir_p text, nm_usuario_p text) FROM PUBLIC;

