-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_w_esus_zica_micro ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_exp_w				w_esus_zica_microcefalia.nr_sequencia%type;
cd_estabelecimento_w			w_esus_zica_microcefalia.cd_estabelecimento%type := obter_estabelecimento_ativo;
dt_atendimento_w			w_esus_zica_microcefalia.dt_atendimento%type;
cd_profissional_w			w_esus_zica_microcefalia.cd_profissional%type;
cd_cbo_w				w_esus_zica_microcefalia.cd_cbo%type;
cd_cnes_unidade_w			w_esus_zica_microcefalia.cd_cnes_unidade%type;
cd_cnes_unidade_ww			w_esus_zica_microcefalia.cd_cnes_unidade%type;
nr_seq_sus_equipe_w			w_esus_zica_microcefalia.nr_seq_sus_equipe%type;
ie_turno_atendimento_w			w_esus_zica_microcefalia.ie_turno_atendimento%type;
nr_atendimento_w			w_esus_zica_microcefalia.nr_atendimento%type;
cd_pessoa_fisica_w			w_esus_zica_microcefalia.cd_pessoa_fisica%type;
cd_pessoa_responsavel_w			w_esus_zica_microcefalia.cd_pessoa_responsavel%type;
dt_teste_olhinho_w			w_esus_zica_microcefalia.dt_teste_olhinho%type;
ie_result_te_olhinho_w			w_esus_zica_microcefalia.ie_result_te_olhinho%type;
dt_exame_fundo_olho_w			w_esus_zica_microcefalia.dt_exame_fundo_olho%type;
ie_result_ex_fu_olho_w			w_esus_zica_microcefalia.ie_result_ex_fu_olho%type;
dt_teste_orelhinha_w			w_esus_zica_microcefalia.dt_teste_orelhinha%type;
ie_result_te_orelhin_w			w_esus_zica_microcefalia.ie_result_te_orelhin%type;
dt_ultras_transfon_w			w_esus_zica_microcefalia.dt_ultras_transfon%type;
ie_result_ult_transf_w			w_esus_zica_microcefalia.ie_result_ult_transf%type;
dt_tomo_comput_w			w_esus_zica_microcefalia.dt_tomo_comput%type;
ie_result_tomo_compu_w			w_esus_zica_microcefalia.ie_result_tomo_compu%type;
dt_resso_magnetica_w			w_esus_zica_microcefalia.dt_resso_magnetica%type;
ie_result_ress_magne_w			w_esus_zica_microcefalia.ie_result_ress_magne%type;
cd_uuid_original_w			w_esus_zica_microcefalia.cd_uuid_original%type;
cd_municipio_ibge_ww			w_esus_zica_microcefalia.cd_municipio_ibge%type;
cd_municipio_ibge_w			w_esus_zica_microcefalia.cd_municipio_ibge%type;
nr_seq_lote_envio_w			w_esus_zica_microcefalia.nr_seq_lote_envio%type;
nr_seq_ficha_w				w_esus_zica_microcefalia.nr_seq_ficha%type;
cd_cns_paciente_w			w_esus_zica_microcefalia.cd_cns_paciente%type;
dt_nascimento_paciente_w		w_esus_zica_microcefalia.dt_nascimento_paciente%type;
cd_cns_profissional_w			w_esus_zica_microcefalia.cd_cns_profissional%type;
nr_data_atendimento_w			w_esus_zica_microcefalia.nr_data_atendimento%type;
nr_data_exa_fun_olho_w			w_esus_zica_microcefalia.nr_data_exa_fun_olho%type;
nr_data_resso_magnet_w			w_esus_zica_microcefalia.nr_data_resso_magnet%type;
nr_data_teste_olhinh_w			w_esus_zica_microcefalia.nr_data_teste_olhinh%type;
nr_data_teste_orelhi_w			w_esus_zica_microcefalia.nr_data_teste_orelhi%type;
nr_data_tomo_comput_w			w_esus_zica_microcefalia.nr_data_tomo_comput%type;
nr_data_ultras_trans_w			w_esus_zica_microcefalia.nr_data_ultras_trans%type;
nr_data_nasc_pac_w			w_esus_zica_microcefalia.nr_data_nasc_pac%type;
cd_cns_pessoa_resp_w			w_esus_zica_microcefalia.cd_cns_pessoa_resp%type;

cd_contra_chave_rem_w			w_esus_header_footer.cd_contra_chave_rem%type;
cd_uuid_instal_rem_w			w_esus_header_footer.cd_uuid_instal_rem%type;
cd_contra_chave_ori_w			w_esus_header_footer.cd_contra_chave_ori%type;
cd_uuid_instal_orig_w			w_esus_header_footer.cd_uuid_instal_orig%type;

ZicaMicro CURSOR FOR
	SELECT 	nr_sequencia,
		cd_profissional,
		cd_cbo,
		cd_cnes_unidade,
		nr_seq_sus_equipe,
		dt_atendimento,
		ie_turno_atendimento,
		nr_atendimento,
		cd_pessoa_fisica,
		cd_pessoa_responsavel,
		dt_teste_olhinho,
		dt_exame_fundo_olho,
		dt_teste_orelhinha,
		dt_ultras_transfon,
		dt_tomo_comput,
		dt_resso_magnetica,
		cd_uuid_original,
		nr_seq_lote_envio,
		ie_result_te_olhinho,
		ie_result_ex_fu_olho,
		ie_result_te_orelhin,
		ie_result_ult_transf,
		ie_result_tomo_compu,
		ie_result_ress_magne
	from	esus_zica_microcefalia
	where	nr_seq_lote_envio =	nr_seq_lote_p
	order by nr_sequencia;
	
type 		fetch_array is table of ZicaMicro%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_ZicaMicro_w			vetor;
	
BEGIN

delete 	from w_esus_zica_microcefalia
where	nr_seq_lote_envio = nr_seq_lote_p;

open ZicaMicro;
loop
fetch ZicaMicro bulk collect into s_array limit 1000;
	vetor_ZicaMicro_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on ZicaMicro */
end loop;
close ZicaMicro;

for i in 1..vetor_ZicaMicro_w.count loop
	begin
	s_array := vetor_ZicaMicro_w(i);
	for z in 1..s_array.count loop
		begin
		
		nr_seq_ficha_w				:= s_array[z].nr_sequencia;
		cd_profissional_w			:= s_array[z].cd_profissional;
		cd_cbo_w				:= s_array[z].cd_cbo;
		cd_cnes_unidade_w			:= s_array[z].cd_cnes_unidade;
		nr_seq_sus_equipe_w			:= s_array[z].nr_seq_sus_equipe;
		dt_atendimento_w			:= s_array[z].dt_atendimento;
		ie_turno_atendimento_w			:= s_array[z].ie_turno_atendimento;
		nr_atendimento_w			:= s_array[z].nr_atendimento;
		cd_pessoa_fisica_w			:= s_array[z].cd_pessoa_fisica;
		cd_pessoa_responsavel_w			:= s_array[z].cd_pessoa_responsavel;
		dt_teste_olhinho_w			:= s_array[z].dt_teste_olhinho;
		dt_exame_fundo_olho_w			:= s_array[z].dt_exame_fundo_olho;
		dt_teste_orelhinha_w			:= s_array[z].dt_teste_orelhinha;
		dt_ultras_transfon_w			:= s_array[z].dt_ultras_transfon;
		dt_tomo_comput_w			:= s_array[z].dt_tomo_comput;
		dt_resso_magnetica_w			:= s_array[z].dt_resso_magnetica;
		cd_uuid_original_w			:= s_array[z].cd_uuid_original;
		nr_seq_lote_envio_w			:= s_array[z].nr_seq_lote_envio;
		ie_result_te_olhinho_w			:= s_array[z].ie_result_te_olhinho;
		ie_result_ex_fu_olho_w			:= s_array[z].ie_result_ex_fu_olho;
		ie_result_te_orelhin_w			:= s_array[z].ie_result_te_orelhin;
		ie_result_ult_transf_w			:= s_array[z].ie_result_ult_transf;
		ie_result_tomo_compu_w			:= s_array[z].ie_result_tomo_compu;
		ie_result_ress_magne_w			:= s_array[z].ie_result_ress_magne;
		
		
		if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
			begin
			cd_cns_paciente_w		:= substr(obter_dados_pf(cd_pessoa_fisica_w,'CNS'),1,20);
			dt_nascimento_paciente_w	:= to_date(substr(obter_dados_pf(cd_pessoa_fisica_w,'DN'),1,10),'dd/mm/yyyy');
			--ie_sexo_paciente_w		:= substr(sus_gerar_depara_esus(obter_dados_pf(cd_pessoa_fisica_w,'SE'),'SEXO'),1,20);
			end;
		end if;	

		cd_cns_profissional_w			:= substr(obter_dados_pf(cd_profissional_w,'CNS'),1,20);
		cd_cns_pessoa_resp_w			:= substr(obter_dados_pf(cd_pessoa_responsavel_w,'CNS'),1,20);
		cd_municipio_ibge_ww			:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'CDM');
		cd_municipio_ibge_w			:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);
			
		select	nextval('w_esus_zica_microcefalia_seq')
		into STRICT	nr_seq_exp_w
		;		
		
		if (dt_nascimento_paciente_w IS NOT NULL AND dt_nascimento_paciente_w::text <> '') then
			nr_data_nasc_pac_w	:=  rpad(((dt_nascimento_paciente_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_nasc_pac_w	:= null;
		end if;
		
		if (dt_atendimento_w IS NOT NULL AND dt_atendimento_w::text <> '') then
			nr_data_atendimento_w	:=  rpad(((dt_atendimento_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_atendimento_w	:= null;
		end if;
		
		if (dt_exame_fundo_olho_w IS NOT NULL AND dt_exame_fundo_olho_w::text <> '') then
			nr_data_exa_fun_olho_w	:=  rpad(((dt_exame_fundo_olho_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_exa_fun_olho_w	:= null;
		end if;
		
		if (dt_resso_magnetica_w IS NOT NULL AND dt_resso_magnetica_w::text <> '') then
			nr_data_resso_magnet_w	:=  rpad(((dt_resso_magnetica_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_resso_magnet_w	:= null;
		end if;
				
		if (dt_teste_olhinho_w IS NOT NULL AND dt_teste_olhinho_w::text <> '') then
			nr_data_teste_olhinh_w	:=  rpad(((dt_teste_olhinho_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_teste_olhinh_w	:= null;
		end if;
		
		if (dt_teste_orelhinha_w IS NOT NULL AND dt_teste_orelhinha_w::text <> '') then
			nr_data_teste_orelhi_w	:=  rpad(((dt_teste_orelhinha_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_teste_orelhi_w	:= null;
		end if;
		
		if (dt_tomo_comput_w IS NOT NULL AND dt_tomo_comput_w::text <> '') then
			nr_data_tomo_comput_w	:=  rpad(((dt_tomo_comput_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_tomo_comput_w	:= null;
		end if;
		
		if (dt_ultras_transfon_w IS NOT NULL AND dt_ultras_transfon_w::text <> '') then
			nr_data_ultras_trans_w	:=  rpad(((dt_ultras_transfon_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else
			nr_data_ultras_trans_w	:= null;
		end if;
		
		select	coalesce(max(cd_cnes_unidade),'0')
		into STRICT	cd_cnes_unidade_ww
		from	w_esus_header_footer
		where	nr_seq_lote_envio = nr_seq_lote_p;
		
		if (cd_cnes_unidade_w <> cd_cnes_unidade_ww) then
			begin
			cd_contra_chave_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'C'),1,50);
			cd_uuid_instal_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),1,50);
			cd_contra_chave_ori_w	:= cd_contra_chave_rem_w;
			cd_uuid_instal_orig_w	:= cd_uuid_instal_rem_w;			
			cd_municipio_ibge_ww	:= sus_obter_dados_equipe(nr_seq_sus_equipe_w,'CM');
			cd_municipio_ibge_ww	:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);
			
			update 	w_esus_header_footer
			set 	cd_cnes_unidade = cd_cnes_unidade_w,
				cd_cnes_serealizado = cd_cnes_unidade_w,
				cd_contra_chave_rem = cd_contra_chave_rem_w,
				cd_uuid_instal_rem = cd_uuid_instal_rem_w,
				cd_contra_chave_ori = cd_contra_chave_ori_w,
				cd_uuid_instal_orig = cd_uuid_instal_orig_w,
				cd_municipio_ibge = cd_municipio_ibge_ww
			where	nr_seq_lote_envio = nr_seq_lote_p;
			
			end;
		end if;	
		
		if (coalesce(cd_uuid_original_w,'X') = 'X')  then
			cd_uuid_original_w := coalesce(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),'0');
			update esus_zica_microcefalia set cd_uuid_original = cd_uuid_original_w where  nr_sequencia = nr_seq_ficha_w;
		end if;	
				
		insert into w_esus_zica_microcefalia(	nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_estabelecimento,
							dt_atendimento,
							cd_profissional,
							cd_cbo,
							cd_cnes_unidade,
							nr_seq_sus_equipe,
							ie_turno_atendimento,
							nr_atendimento,
							cd_pessoa_fisica,
							cd_pessoa_responsavel,
							dt_teste_olhinho,
							ie_result_te_olhinho,
							dt_exame_fundo_olho,
							ie_result_ex_fu_olho,
							dt_teste_orelhinha,
							ie_result_te_orelhin,
							dt_ultras_transfon,
							ie_result_ult_transf,
							dt_tomo_comput,
							ie_result_tomo_compu,
							dt_resso_magnetica,
							ie_result_ress_magne,
							cd_uuid_original,
							cd_municipio_ibge,
							nr_seq_lote_envio,
							nr_seq_ficha,
							cd_cns_paciente,
							dt_nascimento_paciente,
							cd_cns_profissional,
							nr_data_atendimento,
							nr_data_exa_fun_olho,
							nr_data_resso_magnet,
							nr_data_teste_olhinh,
							nr_data_teste_orelhi,
							nr_data_tomo_comput,
							nr_data_ultras_trans,
							nr_data_nasc_pac,
							cd_cns_pessoa_resp)
				values (		nr_seq_exp_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,							
							cd_estabelecimento_w,
							dt_atendimento_w,
							cd_profissional_w,
							cd_cbo_w,
							cd_cnes_unidade_w,
							nr_seq_sus_equipe_w,
							ie_turno_atendimento_w,
							nr_atendimento_w,
							cd_pessoa_fisica_w,
							cd_pessoa_responsavel_w,
							dt_teste_olhinho_w,
							ie_result_te_olhinho_w,
							dt_exame_fundo_olho_w,
							ie_result_ex_fu_olho_w,
							dt_teste_orelhinha_w,
							ie_result_te_orelhin_w,
							dt_ultras_transfon_w,
							ie_result_ult_transf_w,
							dt_tomo_comput_w,
							ie_result_tomo_compu_w,
							dt_resso_magnetica_w,
							ie_result_ress_magne_w,
							cd_uuid_original_w,
							cd_municipio_ibge_w,
							nr_seq_lote_envio_w,
							nr_seq_ficha_w,
							cd_cns_paciente_w,
							dt_nascimento_paciente_w,
							cd_cns_profissional_w,
							nr_data_atendimento_w,
							nr_data_exa_fun_olho_w,
							nr_data_resso_magnet_w,
							nr_data_teste_olhinh_w,
							nr_data_teste_orelhi_w,
							nr_data_tomo_comput_w,
							nr_data_ultras_trans_w,
							nr_data_nasc_pac_w,
							cd_cns_pessoa_resp_w);
				
		end;
	end loop;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_w_esus_zica_micro ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

