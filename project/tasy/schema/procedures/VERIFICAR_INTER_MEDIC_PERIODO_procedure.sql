-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verificar_inter_medic_periodo (dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_material_w		integer;
ds_retorno_w		varchar(8000) := '';
ds_material_w		varchar(100);
ds_material_ww		varchar(100);
ds_interacao_w		varchar(4000) := '';
ds_tipo_w		varchar(255);
ds_severidade_w		varchar(254);
nr_seq_ficha_tecnica_w	bigint;
nm_usuario_original_w	varchar(15);
cd_material_interacao_w	integer;
ie_severidade_w		varchar(15);
ie_consistir_w		varchar(15);
nr_sequencia_w		bigint;
nr_seq_medic_w		bigint;		
ie_agrupador_w		smallint;
nr_agrupamento_w	double precision;
qt_dependente_w		bigint;
nr_sequencia_diluicao_w	bigint;
nr_sequencia_solucao_w	integer;
nr_prescricao_w		bigint;
cd_pessoa_fisica_w	varchar(10);

C01 CURSOR FOR 
SELECT	distinct 
	b.cd_material, 
	substr(c.ds_material,1,100), 
	c.nr_seq_ficha_tecnica, 
	a.nm_usuario_original, 
	b.nr_sequencia, 
	b.ie_agrupador, 
	b.nr_agrupamento, 
	b.nr_sequencia_diluicao, 
	b.nr_sequencia_solucao, 
	a.nr_prescricao 
from	material c, 
	prescr_material b, 
	prescr_medica a 
where	a.dt_prescricao	between	dt_inicial_p and dt_final_p 
and	a.nr_prescricao		= b.nr_prescricao 
and	b.cd_material		= c.cd_material 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	((a.cd_pessoa_fisica 	= cd_pessoa_fisica_p) or (a.nr_atendimento = nr_atendimento_p));

C02 CURSOR FOR 
SELECT	distinct 
	substr(obter_desc_material(a.cd_material_interacao),1,100), 
	ds_tipo, 
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254), 
	ie_severidade, 
	a.cd_material_interacao, 
	coalesce(a.ie_consistir,'P') 
from	material_interacao_medic a, 
	prescr_material b, 
	prescr_medica k 
where	a.cd_material		= cd_material_w 
and	a.cd_material_interacao	= b.cd_material 
and	k.nr_prescricao		= b.nr_prescricao 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	k.dt_prescricao between	dt_inicial_p and dt_final_p 
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor)) 
and	((k.cd_pessoa_fisica 	= cd_pessoa_fisica_p) or (k.nr_atendimento = nr_atendimento_p)) 

union
 
SELECT	distinct 
	substr(obter_desc_material(b.cd_material),1,100), 
	ds_tipo, 
	substr(obter_valor_dominio(1325, ie_severidade),1,254), 
	ie_severidade, 
	b.cd_material, 
	coalesce(a.ie_consistir,'P') 
from	material x, 
	material_interacao_medic a,	 
	prescr_material b, 
	prescr_medica k 
where	k.nr_prescricao 		= b.nr_prescricao 
and	b.cd_material			= x.cd_material 
and	a.nr_seq_ficha_interacao 	= nr_seq_ficha_tecnica_w 
and	a.nr_seq_ficha			= x.nr_seq_ficha_tecnica 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	k.dt_prescricao between	dt_inicial_p and dt_final_p 
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor)) 
and	((k.cd_pessoa_fisica 		= cd_pessoa_fisica_p) or (k.nr_atendimento = nr_atendimento_p));


BEGIN 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') or (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	CALL exec_sql_dinamico(nm_usuario_p, 'truncate table w_prescr_medica_interacao');
	 
	if (coalesce(cd_pessoa_fisica_p::text, '') = '') then 
		cd_pessoa_fisica_w:= obter_pessoa_atendimento(nr_atendimento_p,'C');
	end if;	
	 
	open C01;
	loop 
		fetch C01 into 
			cd_material_w, 
			ds_material_ww, 
			nr_seq_ficha_tecnica_w, 
			nm_usuario_original_w, 
			nr_seq_medic_w, 
			ie_agrupador_w, 
			nr_agrupamento_w, 
			nr_sequencia_diluicao_w, 
			nr_sequencia_solucao_w, 
			nr_prescricao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ds_interacao_w := '';
		 
		open C02;
		loop 
			fetch C02 into 
				ds_material_w, 
				ds_tipo_w, 
				ds_severidade_w, 
				ie_severidade_w, 
				cd_material_interacao_w, 
				ie_consistir_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */	
			begin 
			 
			if (ie_consistir_w = 'P') then 
				begin 
			 
				insert into w_prescr_medica_interacao( 
					nr_sequencia, 
					nr_prescricao, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_material, 
					cd_material_interacao, 
					ds_interacao, 
					ie_severidade, 
					nr_seq_ficha_tecnica, 
					cd_pessoa_fisica) 
				values (nextval('w_prescr_medica_interacao_seq'), 
					nr_prescricao_w, 
					clock_timestamp(), 
					nm_usuario_original_w, 
					clock_timestamp(), 
					nm_usuario_original_w, 
					cd_material_w, 
					cd_material_interacao_w, 
					ds_tipo_w, 
					ie_severidade_w, 
					nr_seq_ficha_tecnica_w, 
					coalesce(cd_pessoa_fisica_p,cd_pessoa_fisica_w));
				 
				if (coalesce(length(ds_interacao_w),0) < 3000) then 
					begin 
					if (coalesce(ds_interacao_w::text, '') = '') then 
						ds_interacao_w := Wheb_mensagem_pck.get_texto(306005, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
					else 
						ds_interacao_w := ds_interacao_w || chr(13) || chr(10) || Wheb_mensagem_pck.get_texto(306005, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
					end if;
 
					if (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') then 
						ds_interacao_w := ds_interacao_w || ' ' || Wheb_mensagem_pck.get_texto(305995) || ' ' || ds_tipo_w;
					end if;
					if (ds_severidade_w IS NOT NULL AND ds_severidade_w::text <> '') then 
						ds_interacao_w := ds_interacao_w || '. ' || Wheb_mensagem_pck.get_texto(306029) || ' ' || ds_severidade_w;
					end if;
					ds_interacao_w := ds_interacao_w || chr(13) || chr(10);
					end;
				end if;
				end;
			elsif (ie_consistir_w = 'I') then 
				begin 
				if (ie_agrupador_w = 1) then 
					begin 
					select	count(*) 
					into STRICT	qt_dependente_w 
					from	prescr_material 
					where	nr_prescricao		= nr_prescricao_w 
					and	nr_sequencia_diluicao	= nr_seq_medic_w 
					and	cd_material		= cd_material_interacao_w;
					 
					if (qt_dependente_w = 0) then 
						select	count(*) 
						into STRICT	qt_dependente_w 
						from	prescr_material 
						where	nr_prescricao		= nr_prescricao_w 
						and	nr_sequencia		<> nr_seq_medic_w 
						and	ie_agrupador		= 1 
						and	nr_agrupamento		= nr_agrupamento_w 
						and	cd_material		= cd_material_interacao_w;
					end if;
					end;
				elsif (ie_agrupador_w in (3,7,9)) then 
					begin 
					 
					select	count(*) 
					into STRICT	qt_dependente_w 
					from	prescr_material 
					where	nr_prescricao		= nr_prescricao_w 
					and	nr_sequencia		= nr_sequencia_diluicao_w 
					and	cd_material		= cd_material_interacao_w;
					 
					if (qt_dependente_w = 0) then 
						begin 
						select	count(*) 
						into STRICT	qt_dependente_w 
						from	prescr_material 
						where	nr_prescricao		= nr_prescricao_w 
						and	nr_sequencia_diluicao	= nr_sequencia_diluicao_w 
						and	nr_sequencia		<> nr_seq_medic_w 
						and	cd_material		= cd_material_interacao_w;
						end;
					end if;
					end;
				elsif (ie_agrupador_w = 4) then 
					begin 
					select	count(*) 
					into STRICT	qt_dependente_w 
					from	prescr_material 
					where	nr_prescricao		= nr_prescricao_w 
					and	nr_sequencia_solucao	= nr_sequencia_solucao_w 
					and	cd_material		= cd_material_interacao_w;
					end;
				else	 
					begin 
					qt_dependente_w	:= 1;
					end;
				end if;
				end;
				 
				if (qt_dependente_w > 0) then 
					begin 
					insert into w_prescr_medica_interacao( 
						nr_sequencia, 
						nr_prescricao, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						cd_material, 
						cd_material_interacao, 
						ds_interacao, 
						ie_severidade, 
						nr_seq_ficha_tecnica, 
						cd_pessoa_fisica) 
					values (nextval('w_prescr_medica_interacao_seq'), 
						nr_prescricao_w, 
						clock_timestamp(), 
						nm_usuario_original_w, 
						clock_timestamp(), 
						nm_usuario_original_w, 
						cd_material_w, 
						cd_material_interacao_w, 
						ds_tipo_w, 
						ie_severidade_w, 
						nr_seq_ficha_tecnica_w, 
						coalesce(cd_pessoa_fisica_p,cd_pessoa_fisica_w));
					end;
				end if;
			end if;
			end;
		end loop;
		close C02;
		if (ds_interacao_w IS NOT NULL AND ds_interacao_w::text <> '') and (coalesce(length(ds_retorno_w),0) < 3000) then 
			if (coalesce(ds_retorno_w::text, '') = '') then 
				ds_retorno_w := ds_interacao_w;
			else 
				ds_retorno_w := ds_retorno_w ||chr(13) || chr(10) ||ds_interacao_w;
			end if;
		end if;
		end;
	end loop;
	close C01;
end if;	
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verificar_inter_medic_periodo (dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_fisica_p text, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

