-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_item_faturado ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_faturamento_p integer, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

			 
/* IE_TIPO_FATURAMENTO_P 
	1 - Co-participação 
	2 - Custo operacional 
*/
 
tb_nr_seq_proc_w	pls_util_cta_pck.t_number_table;

C01 CURSOR(nr_seq_conta_pc		pls_conta.nr_sequencia%type) FOR 
	SELECT	a.nr_sequencia	 
	from	pls_conta_proc a 
	where	a.nr_seq_conta	= nr_seq_conta_pc 
	and exists (	SELECT	1 
			from	pls_conta_coparticipacao b 
			where	b.nr_seq_conta_proc	= a.nr_sequencia 
			and	(b.nr_seq_mensalidade_seg IS NOT NULL AND b.nr_seq_mensalidade_seg::text <> ''));
	
C02 CURSOR(nr_seq_conta_pc		pls_conta.nr_sequencia%type) FOR 
	SELECT	a.nr_sequencia		 
	from	pls_conta_proc a 
	where	a.nr_seq_conta	= nr_seq_conta_pc 
	and exists (	SELECT	1 
			from	pls_conta_pos_estabelecido	c 
			where	c.nr_seq_conta_proc	= a.nr_sequencia 
			and	(c.nr_seq_mensalidade_seg IS NOT NULL AND c.nr_seq_mensalidade_seg::text <> '') 
			and	((c.ie_situacao		= 'A') or (coalesce(c.ie_situacao::text, '') = '')));


BEGIN 
 
if (ie_tipo_faturamento_p = 1) then	 
	open C01(nr_seq_conta_p);
	loop 
	fetch C01 bulk collect into tb_nr_seq_proc_w 
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_proc_w.count = 0;		
		forall i in tb_nr_seq_proc_w.first..tb_nr_seq_proc_w.last 
			update	pls_conta_proc 
			set	ie_faturamento	= 'F' 
			where	nr_sequencia	= tb_nr_seq_proc_w(i);
	end loop;
	close C01;	
elsif (ie_tipo_faturamento_p = 2) then	 
	open C02(nr_seq_conta_p);
	loop 
	fetch C02 bulk collect into tb_nr_seq_proc_w 
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_proc_w.count = 0;		
		forall i in tb_nr_seq_proc_w.first..tb_nr_seq_proc_w.last 
			update	pls_conta_proc 
			set	ie_faturamento	= 'F' 
			where	nr_sequencia	= tb_nr_seq_proc_w(i);
	end loop;
	close C02;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_item_faturado ( nr_seq_conta_p pls_conta.nr_sequencia%type, ie_tipo_faturamento_p integer, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

