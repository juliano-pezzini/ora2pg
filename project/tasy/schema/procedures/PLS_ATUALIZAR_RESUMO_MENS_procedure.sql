-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_resumo_mens ( dt_mes_referencia_p timestamp, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_mes_referencia_w		timestamp;
nr_seq_resumo_w			bigint;

vl_mensalidade_w		double precision;
vl_coparticipacao_w		double precision;
vl_liq_sem_copartic_w		double precision;
vl_mens_definitivo_w		double precision;
vl_antecipacao_rata_w		double precision;
vl_pro_rata_dia_w		double precision;
vl_cancelado_w			double precision;
vl_imposto_w			double precision;
vl_antecipacao_w		double precision;
vl_antecipacao_rata_ant_w	double precision;
vl_manual_w			double precision;
vl_manual_antec_rata_ant_w	double precision;
vl_carteirinha_w		double precision;
vl_bonificacao_w		double precision;
vl_bonificacao_antec_w		double precision;
vl_bonificacao_antec_rata_w	double precision;
vl_total_w			double precision;
ie_pro_rata_dia_w		varchar(1);

nr_seq_resumo_itens_w		bigint;
ie_tipo_item_w			varchar(2);
vl_item_individual_w		double precision;
vl_item_coletivo_w		double precision;
vl_item_cancelado_individual_w	double precision;
vl_item_cancelado_coletivo_w	double precision;
vl_item_cancelado_w		double precision;
vl_item_estorno_w		double precision;
vl_item_estorno_individual_w	double precision;
vl_item_estorno_coletivo_w	double precision;
vl_antec_estorno_w		double precision;
vl_antec_estorno_individual_w	double precision;
vl_antec_estorno_coletivo_w	double precision;
vl_aberto_w			double precision;
vl_pro_rata_individual_w	double precision;
vl_pro_rata_coletivo_w		double precision;
vl_antec_pro_rata_individual_w	double precision;
vl_antec_pro_rata_coletivo_w	double precision;
vl_antecipacao_individual_w	double precision;
vl_antecipacao_coletivo_w	double precision;
vl_antec_rata_ant_individual_w	double precision;
vl_antec_rata_ant_coletivo_w	double precision;
cd_conta_contabil_w		varchar(20);
vl_credito_w			double precision;
vl_debito_w			double precision;
cd_conta_financ_w		bigint;
vl_classificacao_w		double precision;
nr_seq_forma_cobranca_w		bigint;
nr_seq_conta_banco_w		bigint;
ie_segmentacao_w		varchar(3);
nr_seq_plano_w			bigint;
nr_seq_sca_w			bigint;
qt_lote_mens_w			bigint;
nr_seq_tipo_lanc_w		bigint;
vl_mensalidade_mes_anterior_w	double precision;
vl_total_receita_w		double precision;
nr_seq_bonificacao_w		bigint;
ie_tipo_contratacao_w		varchar(2);
ie_regulamentacao_w		varchar(2);
ie_considera_receita_w		pls_tipo_lanc_adic.ie_considera_receita%type;
nr_seq_lote_w                   pls_lote_mensalidade.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	sum(vl_mensalidade) vl_mensalidade,
		sum(vl_coparticipacao) vl_coparticipacao,
		sum(vl_liq_sem_copartic) vl_liq_sem_copartic,
		sum(vl_mens_definitivo) vl_mens_definitivo,
		sum(vl_antecipacao_rata) vl_antecipacao_rata,
		sum(vl_pro_rata_dia) vl_pro_rata_dia,
		sum(vl_cancelado) vl_cancelado,
		sum(vl_imposto) vl_imposto,
		sum(vl_antecipacao) vl_antecipacao,
		sum(vl_antecipacao_rata_ant) vl_antecipacao_rata_ant,
		sum(vl_manual) vl_manual,
		sum(vl_manual_antec_rata_ant) vl_manual_antec_rata_ant,
		sum(vl_carteirinha) vl_carteirinha,
		sum(vl_bonificacao) vl_bonificacao,
		sum(vl_bonificacao_antec) vl_bonificacao_antec,
		sum(vl_bonificacao_antec_rata_ant) vl_bonificacao_antec_rata,
		sum(vl_mensalidade_mes_anterior) vl_mensalidade_mes_anterior,
		sum(vl_total_receita) vl_total_receita
	from	(SELECT	sum(CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_item  ELSE d.vl_pro_rata_dia END ) vl_mensalidade,
			sum(CASE WHEN d.ie_tipo_item='3' THEN d.vl_item  ELSE 0 END ) vl_coparticipacao,
			(sum(CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_item  ELSE d.vl_pro_rata_dia END ) - sum(CASE WHEN d.ie_tipo_item='3' THEN CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_item  ELSE d.vl_pro_rata_dia END   ELSE 0 END )) vl_liq_sem_copartic,
			sum(CASE WHEN a.ie_status=2 THEN CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_item  ELSE d.vl_pro_rata_dia END   ELSE 0 END ) vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(b.ie_cancelamento::text, '') = '' and ((d.ie_tipo_item not in ('20','11','2')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and a.ie_status	= '2' /* Lepinski - OS 342207 - Somente gerar no resumo, as informacoes de lotes em definitivo */
  and trunc(b.dt_referencia,'month') = dt_mes_referencia_w and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N' and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
union all
 /* Contabilizar os valores de antecipacao, que foram pagos em meses anteriores - conforme Claudinei */
		select	sum(d.vl_antecipacao) vl_mensalidade,
			0 vl_coparticipacao,
			sum(d.vl_antecipacao) vl_liq_sem_copartic,
			sum(CASE WHEN a.ie_status=2 THEN d.vl_antecipacao  ELSE 0 END ) vl_mens_definitivo,
			0 vl_antecipacao_rata,
			sum(CASE WHEN d.ie_tipo_item='3' THEN 0 WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_antecipacao END ) vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(b.ie_cancelamento::text, '') = '' and ((d.ie_tipo_item not in ('20','11','2')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and (a.dt_contabilizacao IS NOT NULL AND a.dt_contabilizacao::text <> '') and a.ie_status	= '2' /* Lepinski - OS 342207 - Somente gerar no resumo, as informacoes de lotes em definitivo */
  and trunc(d.dt_antecipacao,'month') = dt_mes_referencia_w and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N' and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		 
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			sum(CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_antecipacao  ELSE 0 END ) vl_antecipacao_rata,
			sum(d.vl_pro_rata_dia) vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(b.ie_cancelamento::text, '') = '' and ((d.ie_tipo_item not in ('20','11','2')) or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and a.ie_status	= '2' and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N' and trunc(b.dt_referencia,'month') = dt_mes_referencia_w and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0)) and exists (select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade = d.ie_tipo_item)
		 
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_item END ) vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			sum(CASE WHEN d.ie_tipo_item='11' THEN d.vl_item*2 WHEN d.ie_tipo_item='2' THEN d.vl_item*2  ELSE 0 END ) vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and b.ie_cancelamento = 'C' and coalesce(a.dt_contabilizacao::text, '') = '' and a.ie_status	= '2' and ((d.ie_tipo_item <> '20') or (d.ie_tipo_item = '20' and e.ie_considera_receita = 'S')) and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N' and trunc(b.dt_referencia,'month') = dt_mes_referencia_w and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		 
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			CASE WHEN coalesce(e.ie_considera_despesa,'N')='S' THEN 0  ELSE d.vl_item END  vl_cancelado, /* Lepinski - OS 365332 */
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_mensalidade_seg_item_v d,
			pls_tipo_lanc_adic	e,
			pls_mensalidade_segurado c,
			pls_mensalidade		b,
			pls_lote_mensalidade	a
		where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
		and	d.nr_seq_tipo_lanc	= e.nr_sequencia
		and	b.nr_sequencia	= c.nr_seq_mensalidade
		and	a.nr_sequencia	= b.nr_seq_lote
		and	b.ie_cancelamento = 'C'
		and	coalesce(a.dt_contabilizacao::text, '') = ''
		and	a.ie_status	= '2'
		and	d.ie_tipo_item	= '20'
		and	e.ie_considera_receita = 'N'
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	trunc(b.dt_referencia,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			sum(e.vl_tributo) vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_lote_mensalidade a,
			pls_mensalidade c,
			titulo_receber d,
			titulo_receber_trib e,
			tributo f
		where	c.nr_seq_lote	=  a.nr_sequencia
		and	c.nr_sequencia =  d.nr_seq_mensalidade
		and	d.nr_titulo    =  e.nr_titulo
		and	e.cd_tributo   = f.cd_tributo
		and	coalesce(c.ie_cancelamento::text, '') = ''
		and	a.ie_status	= '2'
		and	f.ie_soma_diminui <> 'N'
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	trunc(c.dt_referencia,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			sum(a.vl_lote) vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_lote_mensalidade a
		where	a.ie_status	= '2'
		and	trunc(a.dt_contabilizacao,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			sum(CASE WHEN e.ie_considera_receita='N' THEN 0  ELSE CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_antecipacao  ELSE 0 END  END ) vl_antecipacao_rata_ant,
			0 vl_manual,
			sum(CASE WHEN e.ie_considera_despesa='S' THEN CASE WHEN e.ie_operacao_motivo='S' THEN CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN d.vl_antecipacao  ELSE 0 END   ELSE 0 END   ELSE 0 END ) vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			sum(CASE WHEN d.ie_tipo_item='14' THEN CASE WHEN coalesce(a.dt_contabilizacao::text, '') = '' THEN abs(d.vl_antecipacao)  ELSE 0 END   ELSE 0 END ) vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(b.ie_cancelamento::text, '') = '' and a.ie_status	= '2' and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N' and trunc(d.dt_antecipacao,'month') = dt_mes_referencia_w and a.cd_estabelecimento	= cd_estabelecimento_p /*and	a.dt_contabilizacao is null OS 357010 */

  and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0)) and d.ie_tipo_item not in ('11','2')
		 
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			CASE WHEN coalesce(e.ie_considera_despesa,'N')='S' THEN abs(d.vl_item)  ELSE d.vl_item END  vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_mensalidade_seg_item_v d,
			pls_tipo_lanc_adic	e,
			pls_mensalidade_segurado c,
			pls_mensalidade		b,
			pls_lote_mensalidade	a
		where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
		and	d.nr_seq_tipo_lanc	= e.nr_sequencia
		and	b.nr_sequencia	= c.nr_seq_mensalidade
		and	a.nr_sequencia	= b.nr_seq_lote
		and	d.ie_tipo_item	= '20'
		and	e.ie_considera_receita = 'N'
		and	((coalesce(b.ie_cancelamento::text, '') = '') or (coalesce(e.ie_considera_despesa,'N') = 'S'))
		and	a.ie_status	= '2'
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	trunc(b.dt_referencia,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
UNION ALL

		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			sum(d.vl_item) vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_mensalidade_seg_item_v d,
			pls_mensalidade_segurado c,
			pls_mensalidade		b,
			pls_lote_mensalidade	a
		where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
		and	b.nr_sequencia	= c.nr_seq_mensalidade
		and	a.nr_sequencia	= b.nr_seq_lote
		and	d.ie_tipo_item	in ('11','2')
		and	coalesce(b.ie_cancelamento::text, '') = ''
		and	a.ie_status	= '2'
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	trunc(b.dt_referencia,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
union all
  --Valor de bonificacao
		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			sum(abs(d.vl_item)) vl_bonificacao,
			sum(abs(d.vl_antecipacao)) vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			0 vl_total_receita
		from	pls_mensalidade_seg_item_v d,
			pls_mensalidade_segurado c,
			pls_mensalidade		b,
			pls_lote_mensalidade	a
		where	c.nr_sequencia	= d.nr_seq_mensalidade_seg
		and	b.nr_sequencia	= c.nr_seq_mensalidade
		and	a.nr_sequencia	= b.nr_seq_lote
		and	d.ie_tipo_item	= '14'
		and	a.ie_status	= '2'
		and	coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'N'
		and	trunc(b.dt_referencia,'month') = dt_mes_referencia_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		
UNION ALL
 /* Resumo meses anteiores */
		select	0 vl_mensalidade,
			sum(CASE WHEN d.ie_tipo_item='3' THEN d.vl_item  ELSE 0 END ) vl_coparticipacao,
			sum(CASE WHEN d.ie_tipo_item='3' THEN 0 WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_item END ) vl_liq_sem_copartic,
			sum(CASE WHEN a.ie_status=2 THEN CASE WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_item END   ELSE 0 END ) vl_mens_definitivo,
			0 vl_antecipacao_rata,
			sum(CASE WHEN d.ie_tipo_item='3' THEN 0 WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_item END ) vl_pro_rata_dia,
			CASE WHEN b.ie_cancelamento='C' THEN sum(d.vl_item)  ELSE 0 END  vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			CASE WHEN coalesce(b.ie_cancelamento::text, '') = '' THEN sum(CASE WHEN d.ie_tipo_item='11' THEN d.vl_item WHEN d.ie_tipo_item='2' THEN d.vl_item  ELSE 0 END )  ELSE 0 END  vl_carteirinha,
			sum(CASE WHEN d.ie_tipo_item='14' THEN abs(d.vl_item)  ELSE 0 END ) vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			sum(CASE WHEN d.ie_tipo_item='11' THEN 0 WHEN d.ie_tipo_item='2' THEN 0  ELSE d.vl_item END ) vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'S' and a.ie_status	= '2' and ((d.ie_tipo_item <> '20') or (coalesce(e.ie_considera_receita,'N') = 'S')) and trunc(a.dt_mesano_referencia,'month') = dt_mes_referencia_w and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0)) group by b.ie_cancelamento
		
UNION ALL
 /* Resumo meses anteriores - Lancamento manual de despesa */
		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			sum(abs(d.vl_item)) vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			sum(abs(d.vl_item)) vl_mensalidade_mes_anterior,
			0 vl_total_receita
		FROM pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_mensalidade_seg_item_v d
LEFT OUTER JOIN pls_tipo_lanc_adic e ON (d.nr_seq_tipo_lanc = e.nr_sequencia)
WHERE c.nr_sequencia	= d.nr_seq_mensalidade_seg and b.nr_sequencia	= c.nr_seq_mensalidade and a.nr_sequencia	= b.nr_seq_lote  and coalesce(a.ie_mensalidade_mes_anterior,'N')	= 'S' and a.ie_status	= '2' and d.ie_tipo_item	= '20' and coalesce(e.ie_considera_despesa,'N') = 'S' and trunc(a.dt_mesano_referencia,'month') = dt_mes_referencia_w and a.cd_estabelecimento	= cd_estabelecimento_p and ((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0)) group by b.ie_cancelamento
		
union all
 /* valor total da receita do mes */
		select	0 vl_mensalidade,
			0 vl_coparticipacao,
			0 vl_liq_sem_copartic,
			0 vl_mens_definitivo,
			0 vl_antecipacao_rata,
			0 vl_pro_rata_dia,
			0 vl_cancelado,
			0 vl_imposto,
			0 vl_antecipacao,
			0 vl_antecipacao_rata_ant,
			0 vl_manual,
			0 vl_manual_antec_rata_ant,
			0 vl_carteirinha,
			0 vl_bonificacao,
			0 vl_bonificacao_antec,
			0 vl_bonificacao_antec_rata_ant,
			0 vl_mensalidade_mes_anterior,
			sum(vl_mensalidade) vl_total_receita
		from	pls_mensalidade		a,
			pls_lote_mensalidade	b
		where	a.nr_seq_lote	= b.nr_sequencia
		and	trunc(a.dt_referencia,'month')	= dt_mes_referencia_w
		and	coalesce(a.ie_cancelamento::text, '') = ''
		and	b.ie_status	= '2'
		and	b.cd_estabelecimento	= cd_estabelecimento_p
		and	((b.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	) alias176;  group by	a.ie_tipo_item,
			coalesce(b.ie_considera_receita,'N');

C04 CURSOR FOR
	SELECT	d.cd_conta_financ,
		sum(d.vl_classificacao) vl_classif
	from	pls_lote_mensalidade a,
		pls_mensalidade b,
		titulo_receber c,
		titulo_receber_classif d
	where	a.nr_sequencia	= b.nr_seq_lote
	and	b.nr_sequencia	= c.nr_seq_mensalidade
	and	c.nr_titulo	= d.nr_titulo
	and	a.ie_status	= '2'
	and	trunc(a.dt_mesano_referencia,'month')	= dt_mes_referencia_w
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	c.ie_situacao <>'3'
	and	((a.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.cd_conta_financ;

C05 CURSOR FOR
	SELECT	nr_seq_forma_cobranca,
		sum(vl_item_individual) vl_item_individual,
		sum(vl_item_coletivo) vl_item_coletivo,
		sum(vl_item_cancelado) vl_item_cancelado,
		sum(vl_item_estorno) vl_item_estorno,
		sum(vl_antec_estorno) vl_antec_estorno,
		sum(vl_aberto) vl_aberto,
		sum(vl_pro_rata_dia) vl_pro_rata_dia,
		sum(vl_pro_rata_individual) vl_pro_rata_individual,
		sum(vl_pro_rata_coletivo) vl_pro_rata_coletivo,
		sum(vl_antecipacao) vl_antecipacao,
		sum(vl_antecipacao_individual) vl_antecipacao_individual,
		sum(vl_antecipacao_coletivo) vl_antecipacao_coletivo
	from(	SELECT	e.nr_seq_forma_cobranca,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END  END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	exists (select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_forma_cobranca
		
UNION ALL

		select	e.nr_seq_forma_cobranca,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	not exists (	select	1
					from	pls_regra_pro_rata_dia x
					where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_forma_cobranca
		
UNION ALL

		select	e.nr_seq_forma_cobranca,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
		and	trunc(f.dt_mesano_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_forma_cobranca)
	group by	nr_seq_forma_cobranca;

C06 CURSOR FOR
	SELECT	nr_seq_conta_banco,
		sum(vl_item_individual) vl_item_individual,
		sum(vl_item_coletivo) vl_item_coletivo,
		sum(vl_item_cancelado) vl_item_cancelado,
		sum(vl_item_estorno) vl_item_estorno,
		sum(vl_antec_estorno) vl_antec_estorno,
		sum(vl_aberto) vl_aberto,
		sum(vl_pro_rata_dia) vl_pro_rata_dia,
		sum(vl_pro_rata_individual) vl_pro_rata_individual,
		sum(vl_pro_rata_coletivo) vl_pro_rata_coletivo,
		sum(vl_antecipacao) vl_antecipacao,
		sum(vl_antecipacao_individual) vl_antecipacao_individual,
		sum(vl_antecipacao_coletivo) vl_antecipacao_coletivo
	from(	SELECT	e.nr_seq_conta_banco,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END  END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	exists (select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_conta_banco
		
UNION ALL

		select	e.nr_seq_conta_banco,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	not exists (	select	1
					from	pls_regra_pro_rata_dia x
					where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)	
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_conta_banco
		
UNION ALL

		select	e.nr_seq_conta_banco,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_estorno,	
			sum(CASE WHEN e.ie_cancelamento='E' THEN 0 END ) vl_antec_estorno,
			sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
			sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END ) vl_pro_rata_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END ) vl_pro_rata_coletivo,
			sum(a.vl_antecipacao) vl_antecipacao,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END ) vl_antecipacao_coletivo
		from	pls_mensalidade_seg_item_v a,
			pls_mensalidade_segurado b,
			pls_segurado		c,
			pls_plano		d,
			pls_mensalidade		e,
			pls_lote_mensalidade	f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
		and	trunc(f.dt_mesano_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	e.nr_seq_conta_banco)
	group by	nr_seq_conta_banco;

C07 CURSOR FOR
	SELECT	ie_segmentacao,
		sum(vl_item_individual) 			vl_item_individual,
		sum(vl_item_coletivo) 				vl_item_coletivo,
		sum(vl_item_cancelado)				vl_item_cancelado,
		sum(vl_item_estorno)				vl_item_estorno,
		sum(vl_antec_estorno)				vl_antec_estorno,
		sum(vl_aberto) 					vl_aberto,
		sum(vl_pro_rata_dia) 				vl_pro_rata_dia,
		sum(vl_antecipacao) 				vl_antecipacao
	from	pls_resumo_item_mens_v
	where	dt_referencia	= dt_mes_referencia_w
	and	((nr_seq_lote = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by ie_segmentacao;
	
C08 CURSOR FOR
	SELECT	d.nr_sequencia nr_seq_plano,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
		sum((	SELECT	coalesce(x.vl_antecipacao,0)
			from	pls_mensalidade_seg_item_v x,
				pls_mensalidade_segurado y,
				pls_mensalidade		 w
			where	x.nr_sequencia		= a.nr_sequencia
			and	x.nr_seq_mensalidade_seg = y.nr_sequencia
			and	y.nr_seq_mensalidade	= w.nr_sequencia
			and	w.ie_cancelamento	= 'E'
			and	exists (select	1
					from	pls_regra_pro_rata_dia z
					where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(a.vl_antecipacao) vl_antecipacao,
		0 vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	b.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status	= '2'
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
	and	d.ie_tipo_operacao	= 'B'
	and	a.ie_tipo_item in ('1','12')
	and	trunc(e.dt_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento	= cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia
	
union all

	select	d.nr_sequencia nr_seq_plano,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
		sum((	select	coalesce(x.vl_antecipacao,0)
			from	pls_mensalidade_seg_item_v x,
				pls_mensalidade_segurado y,
				pls_mensalidade		 w
			where	x.nr_sequencia		= a.nr_sequencia
			and	x.nr_seq_mensalidade_seg = y.nr_sequencia
			and	y.nr_seq_mensalidade	= w.nr_sequencia
			and	w.ie_cancelamento	= 'E'
			and	exists (select	1
					from	pls_regra_pro_rata_dia z      
					where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(a.vl_antecipacao) vl_antecipacao,
		0 vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	b.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status	= '2'
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
	and	d.ie_tipo_operacao	= 'B'
	and	a.ie_tipo_item in ('1','12')
	and	trunc(f.dt_mesano_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento	= cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia
	
union all

	select	d.nr_sequencia nr_seq_plano,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_antec_estorno,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_antecipacao,
		sum(a.vl_item) vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_plano		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	b.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status		= '2'
	and	d.ie_tipo_operacao	= 'B'
	and	a.ie_tipo_item		in ('1','12','4','5','25')
	and	coalesce(a.nr_seq_vinculo_sca::text, '') = ''
	and	trunc(e.dt_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento	= cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia;

C09 CURSOR FOR
	SELECT	d.nr_sequencia nr_seq_sca,
		sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN H.ie_tipo_contratacao='I' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE a.vl_pro_rata_dia END  END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(H.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE a.vl_pro_rata_dia END  END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
		sum((	SELECT	coalesce(x.vl_antecipacao,0)
			from	pls_mensalidade_seg_item_v x,
				pls_mensalidade_segurado y,
				pls_mensalidade		 w
			where	x.nr_sequencia		= a.nr_sequencia
			and	x.nr_seq_mensalidade_seg = y.nr_sequencia
			and	y.nr_seq_mensalidade	= w.nr_sequencia
			and	w.ie_cancelamento	= 'E'
			and	exists (select	1
					from	pls_regra_pro_rata_dia z
					where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(a.vl_antecipacao) vl_antecipacao,
		0 vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_sca_vinculo		c,
		pls_plano		d, 
		pls_segurado		g,
		pls_plano		h,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	a.nr_seq_vinculo_sca	= c.nr_sequencia
	and	b.nr_seq_segurado	= g.nr_sequencia
	and	g.nr_seq_plano		= h.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status		= '2'
	and	d.ie_tipo_operacao	= 'A'
	and	a.ie_tipo_item		= '15'
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
	and	trunc(e.dt_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento = cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia
	
union all

	select	d.nr_sequencia nr_seq_sca,
		sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN h.ie_tipo_contratacao='I' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(h.ie_tipo_contratacao,1,1)='C' THEN a.vl_item  ELSE 0 END   ELSE 0 END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
		sum((	select	coalesce(x.vl_antecipacao,0)
			from	pls_mensalidade_seg_item_v x,
				pls_mensalidade_segurado y,
				pls_mensalidade		 w
			where	x.nr_sequencia		= a.nr_sequencia
			and	x.nr_seq_mensalidade_seg = y.nr_sequencia
			and	y.nr_seq_mensalidade	= w.nr_sequencia
			and	w.ie_cancelamento	= 'E'
			and	exists (select	1
					from	pls_regra_pro_rata_dia z      
					where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(a.vl_antecipacao) vl_antecipacao,
		0 vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_sca_vinculo		c,
		pls_plano		d, 
		pls_segurado		g,
		pls_plano		h,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	a.nr_seq_vinculo_sca	= c.nr_sequencia
	and	b.nr_seq_segurado	= g.nr_sequencia
	and	g.nr_seq_plano		= h.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status		= '2'
	and	d.ie_tipo_operacao	= 'A'
	and	a.ie_tipo_item		= '15'
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
	and	trunc(f.dt_mesano_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento = cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia
	
union all

	select	d.nr_sequencia nr_seq_sca,
		0 vl_item_individual,
		0 vl_item_coletivo,
		0 vl_item_cancelado,
		0 vl_item_estorno,
		0 vl_antec_estorno,
		0 vl_aberto,
		0 vl_pro_rata_dia,
		0 vl_antecipacao,
		sum(a.vl_item) vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_sca_vinculo		c,
		pls_plano		d, 
		pls_segurado		g,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	a.nr_seq_vinculo_sca	= c.nr_sequencia
	and	b.nr_seq_segurado	= g.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	f.ie_status		= '2'
	and	d.ie_tipo_operacao	= 'A'
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
	and	trunc(e.dt_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento = cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia
	
union all

	select	d.nr_sequencia nr_seq_sca,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao  ELSE 0 END ) vl_item_individual,
		sum(CASE WHEN d.ie_tipo_contratacao='I' THEN 0  ELSE a.vl_antecipacao END ) vl_item_coletivo,
		0,
		0,
		0,
		sum(a.vl_antecipacao) vl_pro_rata_dia,
		0,
		0,
		0
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_sca_vinculo		c,
		pls_plano		d, 
		pls_segurado		g,
		pls_mensalidade		e,
		pls_lote_mensalidade	f
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	b.nr_seq_mensalidade	= e.nr_sequencia
	and	a.nr_seq_vinculo_sca	= c.nr_sequencia
	and	b.nr_seq_segurado	= g.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_seq_lote		= f.nr_sequencia
	and	coalesce(e.ie_cancelamento::text, '') = ''
	and	(f.dt_contabilizacao IS NOT NULL AND f.dt_contabilizacao::text <> '')
	and	f.ie_status	= '2'
	and	a.ie_tipo_item = '15'
	and	f.cd_estabelecimento = cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
	AND	trunc(a.dt_antecipacao,'month') = dt_mes_referencia_w
	group by	d.nr_sequencia;
	
C10 CURSOR FOR
	SELECT	nr_seq_tipo_lanc,
		sum(vl_item_individual) 			vl_item_individual,
		sum(vl_item_coletivo) 				vl_item_coletivo,
		sum(vl_item_cancelado_individual) 		vl_item_cancelado_individual,
		sum(vl_item_cancelado_coletivo) 		vl_item_cancelado_coletivo,
		sum(vl_item_cancelado)				vl_item_cancelado,
		sum(vl_item_estorno)				vl_item_estorno,	
		sum(vl_item_estorno_individual) 		vl_item_estorno_individual,
		sum(vl_item_estorno_coletivo) 			vl_item_estorno_coletivo,
		sum(vl_antec_estorno)				vl_antec_estorno,
		sum(vl_antec_estorno_individual) 		vl_antec_estorno_individual,
		sum(vl_antec_estorno_coletivo) 			vl_antec_estorno_coletivo,
		sum(vl_aberto) 					vl_aberto,
		sum(vl_pro_rata_dia) 				vl_pro_rata_dia,
		sum(vl_pro_rata_individual) 			vl_pro_rata_individual,
		sum(vl_pro_rata_coletivo) 			vl_pro_rata_coletivo,
		sum(vl_antecipacao) 				vl_antecipacao,
		sum(vl_antec_pro_rata_individual)		vl_antec_pro_rata_individual,
		sum(vl_antec_pro_rata_coletivo)			vl_antec_pro_rata_coletivo,
		sum(vl_antecipacao_individual) 			vl_antecipacao_individual,
		sum(vl_antecipacao_coletivo) 			vl_antecipacao_coletivo,
		sum(vl_antec_rata_ant_individual)		vl_antec_rata_ant_individual,
		sum(vl_antec_rata_ant_coletivo)			vl_antec_rata_ant_coletivo
	from(	SELECT	a.nr_seq_tipo_lanc,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE a.vl_pro_rata_dia END  END   ELSE 0 END ) vl_item_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE a.vl_pro_rata_dia END  END   ELSE 0 END ) vl_item_coletivo,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END  END ) vl_item_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END ) vl_pro_rata_dia,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
			0 vl_antecipacao_individual,
			0 vl_antecipacao_coletivo,
			0 vl_antec_rata_ant_individual,
			0 vl_antec_rata_ant_coletivo
		from	pls_mensalidade_seg_item_v 	a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_mensalidade			e,
			pls_lote_mensalidade		f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	a.ie_tipo_item	= '20'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	exists (select	1
				from	pls_regra_pro_rata_dia x
				where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	a.nr_seq_tipo_lanc
		
UNION ALL

		select	a.nr_seq_tipo_lanc,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END   ELSE 0 END ) vl_item_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END   ELSE 0 END ) vl_item_coletivo,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END ) vl_pro_rata_dia,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
			0 vl_antecipacao_individual,
			0 vl_antecipacao_coletivo,
			0 vl_antec_rata_ant_individual,
			0 vl_antec_rata_ant_coletivo
		from	pls_mensalidade_seg_item_v 	a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_mensalidade			e,
			pls_lote_mensalidade		f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status	= '2'
		and	a.ie_tipo_item	= '20'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	not exists (	select	1
					from	pls_regra_pro_rata_dia x
					where	x.ie_tipo_item_mensalidade	= a.ie_tipo_item)
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	a.nr_seq_tipo_lanc
		
union all

		select	a.nr_seq_tipo_lanc,
			0 vl_item_individual,
			0 vl_item_coletivo,
			0 vl_item_cancelado_individual,
			0 vl_item_cancelado_coletivo,
			0 vl_item_cancelado,
			0 vl_item_estorno,	
			0 vl_item_estorno_individual,
			0 vl_item_estorno_coletivo,
			0 vl_antec_estorno,
			0 vl_antec_estorno_individual,
			0 vl_antec_estorno_coletivo,
			0 vl_aberto,
			0 vl_pro_rata_dia,
			0 vl_pro_rata_individual,
			0 vl_pro_rata_coletivo,
			0 vl_antecipacao,
			0 vl_antec_pro_rata_individual,
			0 vl_antec_pro_rata_coletivo,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_antecipacao_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_antecipacao_coletivo,
			0 vl_antec_rata_ant_individual,
			0 vl_antec_rata_ant_coletivo
		from	pls_mensalidade_seg_item_v 	a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_mensalidade			e,
			pls_lote_mensalidade		f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	coalesce(e.ie_cancelamento::text, '') = ''
		and	f.ie_status	= '2'
		and	a.ie_tipo_item	= '20'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	trunc(f.dt_contabilizacao,'month') = dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	a.nr_seq_tipo_lanc
		
union all

		select	a.nr_seq_tipo_lanc,
			0 vl_item_individual,
			0 vl_item_coletivo,
			0 vl_item_cancelado_individual,
			0 vl_item_cancelado_coletivo,
			0 vl_item_cancelado,
			0 vl_item_estorno,	
			0 vl_item_estorno_individual,
			0 vl_item_estorno_coletivo,
			0 vl_antec_estorno,
			0 vl_antec_estorno_individual,
			0 vl_antec_estorno_coletivo,
			0 vl_aberto,
			0 vl_pro_rata_dia,
			0 vl_pro_rata_individual,
			0 vl_pro_rata_coletivo,
			0 vl_antecipacao,
			0 vl_antec_pro_rata_individual,
			0 vl_antec_pro_rata_coletivo,
			0 vl_antecipacao_individual,
			0 vl_antecipacao_coletivo,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao  ELSE 0 END ) vl_antec_rata_ant_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao  ELSE 0 END ) vl_antec_rata_ant_coletivo
		from	pls_mensalidade_seg_item_v 	a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_mensalidade			e,
			pls_lote_mensalidade		f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	coalesce(e.ie_cancelamento::text, '') = ''
		and	coalesce(f.dt_contabilizacao::text, '') = ''
		and	f.ie_status	= '2'
		and	a.ie_tipo_item	= '20'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'N'
		and	trunc(a.dt_antecipacao,'month') = dt_mes_referencia_w
		and	f.cd_estabelecimento = cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	a.nr_seq_tipo_lanc
		
UNION ALL

		select	a.nr_seq_tipo_lanc,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_item END   ELSE 0 END ) vl_item_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END   ELSE 0 END ) vl_item_coletivo,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_cancelado_coletivo,
			sum(CASE WHEN e.ie_cancelamento='C' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_cancelado,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END ) vl_item_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_item  ELSE 0 END  END   ELSE 0 END ) vl_item_estorno_coletivo,
			sum(CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END ) vl_antec_estorno,
			sum(CASE WHEN d.ie_tipo_contratacao='I' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_individual,
			sum(CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN CASE WHEN e.ie_cancelamento='E' THEN CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END  END   ELSE 0 END ) vl_antec_estorno_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN f.ie_status='3' THEN a.vl_item END   ELSE 0 END ) vl_aberto,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_pro_rata_dia  ELSE 0 END ) vl_pro_rata_dia,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_individual,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_pro_rata_dia END   ELSE 0 END ) vl_pro_rata_coletivo,
			sum(CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN a.vl_antecipacao  ELSE 0 END ) vl_antecipacao,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN d.ie_tipo_contratacao='I' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_individual,
			sum(CASE WHEN coalesce(f.dt_contabilizacao::text, '') = '' THEN CASE WHEN coalesce(e.ie_cancelamento::text, '') = '' THEN CASE WHEN substr(d.ie_tipo_contratacao,1,1)='C' THEN a.vl_antecipacao END   ELSE 0 END   ELSE 0 END ) vl_antec_pro_rata_coletivo,
			0 vl_antecipacao_individual,
			0 vl_antecipacao_coletivo,
			0 vl_antec_rata_ant_individual,
			0 vl_antec_rata_ant_coletivo
		from	pls_mensalidade_seg_item_v 	a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_mensalidade			e,
			pls_lote_mensalidade		f
		where	a.nr_seq_mensalidade_seg = b.nr_sequencia
		and	b.nr_seq_segurado	= c.nr_sequencia
		and	c.nr_seq_plano		= d.nr_sequencia
		and	b.nr_seq_mensalidade	= e.nr_sequencia
		and	e.nr_seq_lote		= f.nr_sequencia
		and	f.ie_status		= '2'
		and	a.ie_tipo_item		= '20'
		and	coalesce(f.ie_mensalidade_mes_anterior,'N') = 'S'
		and	trunc(e.dt_referencia,'month')	= dt_mes_referencia_w
		and	f.cd_estabelecimento	= cd_estabelecimento_p
		and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
		group by	a.nr_seq_tipo_lanc)
	group by	nr_seq_tipo_lanc;

C11 CURSOR FOR
	SELECT	d.nr_sequencia nr_seq_bonificacao,
		sum(CASE WHEN g.ie_tipo_contratacao='I' THEN a.vl_item END ) vl_item_individual,
		sum(CASE WHEN substr(g.ie_tipo_contratacao,1,1)='C' THEN a.vl_item END ) vl_item_coletivo,
		sum(CASE WHEN e.ie_cancelamento='C' THEN a.vl_item END ) vl_item_cancelado,
		sum(CASE WHEN e.ie_cancelamento='E' THEN a.vl_item END ) vl_item_estorno,
		sum((	SELECT	coalesce(x.vl_antecipacao,0)
			from	pls_mensalidade_seg_item_v x,
				pls_mensalidade_segurado y,
				pls_mensalidade		 w
			where	x.nr_sequencia		= a.nr_sequencia
			and	x.nr_seq_mensalidade_seg = y.nr_sequencia
			and	y.nr_seq_mensalidade	= w.nr_sequencia
			and	w.ie_cancelamento	= 'E'
			and	exists (select	1
					from	pls_regra_pro_rata_dia z
					where	x.ie_tipo_item	= z.ie_tipo_item_mensalidade)))	vl_antec_estorno,
		sum(CASE WHEN f.ie_status='3' THEN a.vl_item END ) vl_aberto,
		sum(a.vl_pro_rata_dia) vl_pro_rata_dia,
		sum(a.vl_antecipacao) vl_antecipacao,
		0 vl_total_receita
	from	pls_mensalidade_seg_item_v a,
		pls_mensalidade_segurado b,
		pls_bonificacao_vinculo	c,
		pls_bonificacao		d,
		pls_mensalidade		e,
		pls_lote_mensalidade	f,
		pls_plano		g
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	a.nr_seq_bonificacao_vinculo	= c.nr_sequencia
	and	c.nr_seq_bonificacao		= d.nr_sequencia
	and	b.nr_seq_mensalidade		= e.nr_sequencia
	and	e.nr_seq_lote			= f.nr_sequencia
	and	b.nr_seq_plano			= g.nr_sequencia
	and	f.ie_status	= '2'
	and	a.ie_tipo_item	= '14'
	and	trunc(e.dt_referencia,'month') = dt_mes_referencia_w
	and	f.cd_estabelecimento	= cd_estabelecimento_p
	and	((f.nr_sequencia = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by	d.nr_sequencia;
	
C12 CURSOR FOR
	SELECT	ie_tipo_contratacao,
		ie_regulamentacao,
		sum(CASE WHEN ie_tipo_contratacao='I' THEN vl_item_individual  ELSE vl_item_coletivo END ) vl_item_individual,
		sum(vl_item_cancelado)	vl_item_cancelado,
		sum(vl_pro_rata_dia) 	vl_pro_rata_dia,
		sum(vl_antecipacao) 	vl_antecipacao
	from	pls_resumo_item_mens_v
	where	dt_referencia	= dt_mes_referencia_w
	and	((nr_seq_lote = nr_seq_lote_w) or (nr_seq_lote_w = 0))
	group by ie_tipo_contratacao, ie_regulamentacao;
	

BEGIN
 nr_seq_lote_w :=  coalesce(nr_seq_lote_p , 0);

dt_mes_referencia_w	:= trunc(dt_mes_referencia_p,'month');

if (nr_seq_lote_w <> 0) then
	select	count(*)
	into STRICT	qt_lote_mens_w
	from	pls_lote_mensalidade
	where	nr_sequencia = nr_seq_lote_w
	and	trunc(dt_mesano_referencia,'month') between add_months(dt_mes_referencia_w,-1) and dt_mes_referencia_w;
	
	if (qt_lote_mens_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(231639, 'DT_REFERENCIA=' || to_char(dt_mes_referencia_w,'mm/yyyy'));
		/* Mensagem: O lote informado nao existe ou nao pertence ao mes de competencia DT_REFERENCIA. Favor verifique! */

	end if;
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_resumo_w
from	pls_resumo_mensalidade
where	dt_mes_referencia	= dt_mes_referencia_w;

if (coalesce(nr_seq_resumo_w,0) = 0) then
	select	nextval('pls_resumo_mensalidade_seq')
	into STRICT	nr_seq_resumo_w
	;
	
	insert	into	pls_resumo_mensalidade(	nr_sequencia, cd_estabelecimento, dt_atualizacao,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			dt_mes_referencia)
		values (	nr_seq_resumo_w, cd_estabelecimento_p, clock_timestamp(),
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			dt_mes_referencia_w);
end if;

begin
select	ie_pro_rata_dia
into STRICT	ie_pro_rata_dia_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;
exception
when others then
	ie_pro_rata_dia_w	:= 'N';
end;

open C01;
loop
fetch C01 into
	vl_mensalidade_w,
	vl_coparticipacao_w,
	vl_liq_sem_copartic_w,
	vl_mens_definitivo_w,
	vl_antecipacao_rata_w,
	vl_pro_rata_dia_w,
	vl_cancelado_w,
	vl_imposto_w,
	vl_antecipacao_w,
	vl_antecipacao_rata_ant_w,
	vl_manual_w,
	vl_manual_antec_rata_ant_w,
	vl_carteirinha_w,
	vl_bonificacao_w,
	vl_bonificacao_antec_w,
	vl_bonificacao_antec_rata_w,
	vl_mensalidade_mes_anterior_w,
	vl_total_receita_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_pro_rata_dia_w = 'S') then
		vl_total_w	:= vl_mens_definitivo_w + (vl_cancelado_w * 2) + vl_imposto_w + vl_antecipacao_w + vl_antecipacao_rata_ant_w + vl_manual_w + vl_manual_antec_rata_ant_w +vl_carteirinha_w + vl_bonificacao_w + vl_bonificacao_w + vl_bonificacao_antec_rata_w;
	else
		vl_total_w	:= vl_mens_definitivo_w + vl_antecipacao_w + (vl_cancelado_w * 2) + vl_imposto_w + vl_manual_w + vl_manual_antec_rata_ant_w + vl_carteirinha_w + vl_bonificacao_w - vl_bonificacao_antec_w + vl_bonificacao_antec_rata_w;
	end if;
	
	update	pls_resumo_mensalidade
	set	vl_mensalidade		= coalesce(vl_mensalidade_w,0),
		vl_coparticipacao	= coalesce(vl_coparticipacao_w,0),
		vl_liq_sem_copartic	= coalesce(vl_liq_sem_copartic_w,0),
		vl_mens_definitivo	= coalesce(vl_mens_definitivo_w,0),
		vl_antecipacao_rata	= coalesce(vl_antecipacao_rata_w,0),
		vl_pro_rata_dia		= coalesce(vl_pro_rata_dia_w,0),
		vl_cancelado		= coalesce(vl_cancelado_w,0),
		vl_imposto		= coalesce(vl_imposto_w,0),
		vl_antecipacao		= coalesce(vl_antecipacao_w,0),
		vl_antecipacao_rata_ant	= coalesce(vl_antecipacao_rata_ant_w,0),
		vl_manual		= coalesce(vl_manual_w,0),
		vl_manual_antec_rata_ant=vl_manual_antec_rata_ant_w,
		vl_carteirinha		= coalesce(vl_carteirinha_w,0),
		vl_bonificacao		= coalesce(vl_bonificacao_w,0),
		vl_bonificacao_antec	= coalesce(vl_bonificacao_antec_w,0),
		vl_bonificacao_antec_rata_ant	= coalesce(vl_bonificacao_antec_rata_w,0),
		vl_total		= coalesce(vl_total_w,0),
		vl_mensalidade_mes_anterior	= coalesce(vl_mensalidade_mes_anterior_w,0),
		vl_total_receita	= coalesce(vl_total_receita_w,0),
		ie_pro_rata_dia		= ie_pro_rata_dia_w,
		nr_seq_lote_mensalidade	= nr_seq_lote_w
	where	nr_sequencia		= nr_seq_resumo_w;
	end;
end loop;
close C01;

delete	from	pls_resumo_mens_compl
where	nr_seq_resumo	= nr_seq_resumo_w;
/* Itens da mensalidade */

open C02;
loop
fetch C02 into
	ie_tipo_item_w,
	ie_considera_receita_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_individual_w,
	vl_item_cancelado_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_item_estorno_individual_w,
	vl_item_estorno_coletivo_w,
	vl_antec_estorno_w,
	vl_antec_estorno_individual_w,
	vl_antec_estorno_coletivo_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_pro_rata_individual_w,
	vl_pro_rata_coletivo_w,
	vl_antecipacao_w,
	vl_antec_pro_rata_individual_w,
	vl_antec_pro_rata_coletivo_w,
	vl_antecipacao_individual_w,
	vl_antecipacao_coletivo_w,
	vl_antec_rata_ant_individual_w,
	vl_antec_rata_ant_coletivo_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, ie_tipo_item, vl_item_individual, ie_considera_receita,
			vl_item_coletivo, vl_item_cancelado_individual, vl_item_cancelado_coletivo,
			vl_item_cancelado, vl_item_estorno, vl_item_estorno_individual,
			vl_item_estorno_coletivo, vl_antec_estorno, vl_antec_estorno_individual,
			vl_antec_estorno_coletivo, vl_aberto, vl_pro_rata_dia,
			vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao,
			vl_antec_pro_rata_ind, vl_antec_pro_rat_col, vl_antecipacao_individual,
			vl_antecipacao_coletivo, vl_antec_rata_ant_ind, vl_antec_rata_ant_col)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'I',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, ie_tipo_item_w, coalesce(vl_item_individual_w,0), ie_considera_receita_w,
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_individual_w,0), coalesce(vl_item_cancelado_coletivo_w,0),
			coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0), coalesce(vl_item_estorno_individual_w,0),
			coalesce(vl_item_estorno_coletivo_w,0), coalesce(vl_antec_estorno_w,0), coalesce(vl_antec_estorno_individual_w,0),
			coalesce(vl_antec_estorno_coletivo_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_pro_rata_individual_w,0), coalesce(vl_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_w,0),
			coalesce(vl_antec_pro_rata_individual_w,0), coalesce(vl_antec_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_individual_w,0),
			coalesce(vl_antecipacao_coletivo_w,0), coalesce(vl_antec_rata_ant_individual_w,0), coalesce(vl_antec_rata_ant_coletivo_w,0));
	end;
end loop;
close C02;

/* Conta financeira */

open C04;
loop
fetch C04 into	
	cd_conta_financ_w,
	vl_classificacao_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, cd_conta_financ, vl_classificacao)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'CF',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, cd_conta_financ_w, coalesce(vl_classificacao_w,0));
	end;
end loop;
close C04;

/* Forma de cobranca */

open C05;
loop
fetch C05 into	
	nr_seq_forma_cobranca_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_pro_rata_individual_w,
	vl_pro_rata_coletivo_w,
	vl_antecipacao_w,
	vl_antecipacao_individual_w,
	vl_antecipacao_coletivo_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_forma_cobranca, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao,
			vl_antecipacao_individual, vl_antecipacao_coletivo)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'FC',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_forma_cobranca_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_pro_rata_individual_w,0), coalesce(vl_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_w,0),
			coalesce(vl_antecipacao_individual_w,0), coalesce(vl_antecipacao_coletivo_w,0));
	
	end;
end loop;
close C05;

/* Agencia/conta estabelecimento */

open C06;
loop
fetch C06 into	
	nr_seq_conta_banco_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_pro_rata_individual_w,
	vl_pro_rata_coletivo_w,
	vl_antecipacao_w,
	vl_antecipacao_individual_w,
	vl_antecipacao_coletivo_w;
EXIT WHEN NOT FOUND; /* apply on C06 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_conta_banco, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao,
			vl_antecipacao_individual, vl_antecipacao_coletivo)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'AC',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_conta_banco_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_pro_rata_individual_w,0), coalesce(vl_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_w,0),
			coalesce(vl_antecipacao_individual_w,0), coalesce(vl_antecipacao_coletivo_w,0));
	end;
end loop;
close C06;

open C07;
loop
fetch C07 into	
	ie_segmentacao_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,	
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_antecipacao_w;
EXIT WHEN NOT FOUND; /* apply on C07 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, ie_segmentacao, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_antecipacao)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'SE',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, ie_segmentacao_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_antecipacao_w,0));
	end;
end loop;
close C07;

/* Produto */

open C08;
loop
fetch C08 into	
	nr_seq_plano_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_antecipacao_w,
	vl_total_receita_w;
EXIT WHEN NOT FOUND; /* apply on C08 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_plano, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_antecipacao, vl_total_receita)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'P',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_plano_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_antecipacao_w,0), coalesce(vl_total_receita_w,0));
	end;
end loop;
close C08;

open C09;
loop
fetch C09 into	
	nr_seq_sca_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_antecipacao_w,
	vl_total_receita_w;
EXIT WHEN NOT FOUND; /* apply on C09 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_sca, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_antecipacao, vl_total_receita)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'S',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_sca_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_antecipacao_w,0), coalesce(vl_total_receita_w,0));
	end;
end loop;
close C09;

/* Itens da mensalidade */

open C10;
loop
fetch C10 into
	nr_seq_tipo_lanc_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_individual_w,
	vl_item_cancelado_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_item_estorno_individual_w,
	vl_item_estorno_coletivo_w,
	vl_antec_estorno_w,
	vl_antec_estorno_individual_w,
	vl_antec_estorno_coletivo_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_pro_rata_individual_w,
	vl_pro_rata_coletivo_w,
	vl_antecipacao_w,
	vl_antec_pro_rata_individual_w,
	vl_antec_pro_rata_coletivo_w,
	vl_antecipacao_individual_w,
	vl_antecipacao_coletivo_w,
	vl_antec_rata_ant_individual_w,
	vl_antec_rata_ant_coletivo_w;
EXIT WHEN NOT FOUND; /* apply on C10 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_tipo_lanc, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado_individual, vl_item_cancelado_coletivo,
			vl_item_cancelado, vl_item_estorno, vl_item_estorno_individual,
			vl_item_estorno_coletivo, vl_antec_estorno, vl_antec_estorno_individual,
			vl_antec_estorno_coletivo, vl_aberto, vl_pro_rata_dia,
			vl_pro_rata_individual, vl_pro_rata_coletivo, vl_antecipacao,
			vl_antec_pro_rata_ind, vl_antec_pro_rat_col, vl_antecipacao_individual,
			vl_antecipacao_coletivo, vl_antec_rata_ant_ind, vl_antec_rata_ant_col)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'LM',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_tipo_lanc_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_individual_w,0), coalesce(vl_item_cancelado_coletivo_w,0),
			coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0), coalesce(vl_item_estorno_individual_w,0),
			coalesce(vl_item_estorno_coletivo_w,0), coalesce(vl_antec_estorno_w,0), coalesce(vl_antec_estorno_individual_w,0),
			coalesce(vl_antec_estorno_coletivo_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_pro_rata_individual_w,0), coalesce(vl_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_w,0),
			coalesce(vl_antec_pro_rata_individual_w,0), coalesce(vl_antec_pro_rata_coletivo_w,0), coalesce(vl_antecipacao_individual_w,0),
			coalesce(vl_antecipacao_coletivo_w,0), coalesce(vl_antec_rata_ant_individual_w,0), coalesce(vl_antec_rata_ant_coletivo_w,0));
	end;
end loop;
close C10;

/* Bonificacao */

open C11;
loop
fetch C11 into
	nr_seq_bonificacao_w,
	vl_item_individual_w,
	vl_item_coletivo_w,
	vl_item_cancelado_w,
	vl_item_estorno_w,
	vl_antec_estorno_w,
	vl_aberto_w,
	vl_pro_rata_dia_w,
	vl_antecipacao_w,
	vl_total_receita_w;
EXIT WHEN NOT FOUND; /* apply on C11 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			nr_seq_resumo, nr_seq_bonificacao, vl_item_individual,
			vl_item_coletivo, vl_item_cancelado, vl_item_estorno,
			vl_antec_estorno, vl_aberto, vl_pro_rata_dia,
			vl_antecipacao, vl_total_receita)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'BO',
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			nr_seq_resumo_w, nr_seq_bonificacao_w, coalesce(vl_item_individual_w,0),
			coalesce(vl_item_coletivo_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_item_estorno_w,0),
			coalesce(vl_antec_estorno_w,0), coalesce(vl_aberto_w,0), coalesce(vl_pro_rata_dia_w,0),
			coalesce(vl_antecipacao_w,0), coalesce(vl_total_receita_w,0));
	end;
end loop;
close C11;

/* Contratacao/Regulamentacao */

open C12;
loop
fetch C12 into
	ie_tipo_contratacao_w,
	ie_regulamentacao_w,
	vl_item_individual_w,
	vl_item_cancelado_w,
	vl_pro_rata_dia_w,
	vl_antecipacao_w;
EXIT WHEN NOT FOUND; /* apply on C12 */
	begin
	select	nextval('pls_resumo_mens_compl_seq')
	into STRICT	nr_seq_resumo_itens_w
	;
	
	insert	into	pls_resumo_mens_compl(	nr_sequencia, cd_estabelecimento, dt_atualizacao, ie_resumo,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_resumo,
			vl_item_individual, vl_item_cancelado, vl_pro_rata_dia, vl_antecipacao,
			nr_seq_plano, ie_tipo_contratacao, ie_regulamentacao)
		values (	nr_seq_resumo_itens_w, cd_estabelecimento_p, clock_timestamp(), 'TP',
			nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_resumo_w,
			coalesce(vl_item_individual_w,0), coalesce(vl_item_cancelado_w,0), coalesce(vl_pro_rata_dia_w,0), coalesce(vl_antecipacao_w,0),
			nr_seq_plano_w, ie_tipo_contratacao_w, ie_regulamentacao_w);
	end;
end loop;
close C12;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_resumo_mens ( dt_mes_referencia_p timestamp, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

