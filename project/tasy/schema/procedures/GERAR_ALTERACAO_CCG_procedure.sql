-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alteracao_ccg (nr_seq_glicemia_p bigint, ie_alteracao_p bigint, ds_observacao_P text, nm_usuario_p text) AS $body$
DECLARE

				 
ora2pg_rowcount int;
nr_seq_evento_w	bigint;
ie_gera_adm_w	varchar(1);


BEGIN 
 
if (nr_seq_glicemia_p IS NOT NULL AND nr_seq_glicemia_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (ie_alteracao_p IS NOT NULL AND ie_alteracao_p::text <> '') then 
	if (ie_alteracao_p = 11) then /* Suspensão da medicação da medição */
 
		update	atendimento_glicemia 
		set	nm_usuario_susp = nm_usuario_p, 
			dt_suspensao = clock_timestamp() 
		where	nr_sequencia = nr_seq_glicemia_p 
		and	coalesce(dt_suspensao::text, '') = '';
	end if;
	 
	GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

	 
	if ( ora2pg_rowcount > 0) then /* Atualizou alguma linha? */
 
	 
		select	nextval('atend_glicemia_evento_seq') 
		into STRICT	nr_seq_evento_w 
		;
		/* Gerar o evento */
 
		insert into atend_glicemia_evento( 
			nr_sequencia, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_glicemia, 
			ie_evento, 
			dt_evento, 
			cd_pessoa_evento, 
			ds_observacao) 
		values ( 
			nr_seq_evento_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_glicemia_p, 
			ie_alteracao_p, --9 
			clock_timestamp(), 
			substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10), 
			ds_observacao_P);
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alteracao_ccg (nr_seq_glicemia_p bigint, ie_alteracao_p bigint, ds_observacao_P text, nm_usuario_p text) FROM PUBLIC;

