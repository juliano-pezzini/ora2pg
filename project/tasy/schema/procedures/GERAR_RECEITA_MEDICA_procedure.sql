-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_receita_medica ( cd_pessoa_fisica_p text, cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, ds_medicamento_p text, nm_usuario_p text, nr_atendimento_p bigint, ie_html_p text default 'N', IE_LIBERADO_P text DEFAULT NULL, ds_justificativa_retro_p text DEFAULT NULL, nr_seq_atend_cons_pepa_p bigint default null, ds_erro_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ds_masc_receita_w	varchar(4000);
ds_receita_final_w	varchar(32000)	:= '';
ds_receita_is_null_w varchar(4000);
ds_receita_parcial_w	varchar(4000);
ds_medicamento_w	varchar(1000);

ds_material_w		varchar(255);
qt_dose_w		double precision;
cd_unidade_medida_w	varchar(30);
ds_unidade_medida_w	varchar(40);
ie_via_aplicacao_w	varchar(5);
cd_intervalo_w		varchar(7);
ds_intervalo_w		varchar(80);
ds_fim_uso_w		varchar(100);
ds_incio_uso_w		varchar(100);
ds_observacao_w		varchar(255);

nr_atendimento_w	bigint;
ds_enter_padrao_w	varchar(20)	:= chr(13)||chr(10);
ds_enter_w		varchar(20)	:= ' \par\par ';

ds_cabecalho_w		varchar(1000);
ds_rodape_w		varchar(1);
ds_fonte_w		varchar(100);
ds_tam_fonte_w		varchar(10);
nr_tam_fonte_w		integer;
cd_estabelecimento_w	smallint;
nr_dias_uso_w		integer;
ds_via_aplicacao_w	varchar(80);
qt_medicamento_w	integer;
ie_uso_continuo_w	varchar(1);
ie_laudo_lme_w		varchar(1);
qt_dose_continuo_w	double precision;
qt_dose_2_continuo_w	double precision;
qt_padrao_dose_w	double precision;
ds_cab_via_w		varchar(100);
qt_operacao_w		intervalo_prescricao.qt_operacao%type;
qt_frequencia_w		real;
ds_justificativa_w	varchar(255);
ds_desc_intervalo_w	varchar(80);
nr_dias_WW           varchar(255);
qt_medic_total_w	bigint;
qt_dias_w			bigint;
qt_proced_1_mes_w	medic_uso_continuo.qt_proced_1_mes%type;
qt_proced_2_mes_w	medic_uso_continuo.qt_proced_2_mes%type;
qt_proced_3_mes_w	medic_uso_continuo.qt_proced_3_mes%type;
qt_proced_4_mes_w	medic_uso_continuo.qt_proced_4_mes%type;
qt_proced_5_mes_w	medic_uso_continuo.qt_proced_5_mes%type;
qt_proced_6_mes_w	medic_uso_continuo.qt_proced_6_mes%type;
nr_seq_atend_cons_pepa_w atend_consulta_pepa.nr_sequencia%type;
nr_sequencia_w      med_receita.nr_sequencia%type;
ds_unidade_w        med_receita_item.ds_unidade%type;
ds_posologia_w      med_receita_item.ds_posologia%type;
dt_fim_w            medic_uso_continuo.dt_fim%type;
dt_inicio_w         medic_uso_continuo.dt_inicio%type;
ds_formafarmaceutica_w      med_receita_item.ds_formafarmaceutica%type;
ds_valor_vazio_w varchar(255):= null;
ie_sbis_w smallint;

c01 CURSOR FOR
	SELECT	substr(coalesce(DS_MATERIAL_NAO_CAD,obter_desc_material(cd_material)),1,255),
		qt_dose,
		cd_unidade_medida,
		ie_via_aplicacao,
		cd_intervalo,
		substr(obter_fim_uso_medic(nr_sequencia),1,80),
		substr(obter_desc_intervalo_prescr(cd_intervalo),1,80),
		ds_observacao,
		nr_dias_uso,
		substr(obter_unidade_medida(cd_unidade_medida),1,40),
		substr(Obter_Via_Aplicacao(ie_via_aplicacao,'D'),1,70),
		ie_uso_continuo,
		ie_laudo_lme,
		ds_justificativa,
		substr(OBTER_DESC_INTERVALO(cd_intervalo),1,80),		
		qt_proced_1_mes,
		qt_proced_2_mes,
		qt_proced_3_mes,
		qt_proced_4_mes,
		qt_proced_5_mes,
		qt_proced_6_mes,
		round((Obter_ocorrencia_intervalo(cd_intervalo,24,'O') * CASE WHEN ie_uso_continuo='S' THEN 30  ELSE nr_dias_uso END )*qt_dose,2),
		substr(obter_um_medic_uso_continuo(NR_SEQUENCIA, 'N'),1,50),
		dt_fim,
		dt_inicio,
		substr(obter_unidade_medida(cd_unidade_medida_forma),1,40)
	from	medic_uso_continuo
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ds_medicamento_w like '%' || nr_sequencia || '%'
	and	coalesce(dt_suspensao::text, '') = ''
	order by 1;	


BEGIN

if (nr_seq_formatacao_p = 0) then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277922);
elsif (coalesce(ds_medicamento_p::text, '') = '') then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277925);		
elsif (coalesce(ie_tipo_receita_p::text, '') = '') then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277927);
elsif (coalesce(cd_profissional_p::text, '') = '') then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277928);
elsif (obter_se_medico(cd_profissional_p, 'M') = 'N') then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277930);
else
	
	if (ie_html_p = 'S') then
	
		select	coalesce(ds_receita_novo,ds_receita),
				ds_receita_novo
		into STRICT	ds_masc_receita_w,
				ds_receita_is_null_w
		from	medic_mascara_receita
		where	nr_sequencia	= nr_seq_formatacao_p;
	
	else
	
		select	ds_receita
		into STRICT	ds_masc_receita_w
		from	medic_mascara_receita
		where	nr_sequencia	= nr_seq_formatacao_p;	
	
	end if;
	
	ds_medicamento_w	:= ' ' || ds_medicamento_p || ' ';
	ds_medicamento_w	:= replace(ds_medicamento_w, ',',' ');
	ds_medicamento_w	:= replace(ds_medicamento_w, '  ',' ');	
	
	qt_medicamento_w	:= 0;

	select max(nr_sequencia)
	into STRICT nr_seq_atend_cons_pepa_w
	from ATEND_CONSULTA_PEPA
	where nr_atendimento = nr_atendimento_p;	

	select	nextval('med_receita_seq')
	into STRICT nr_sequencia_w
	;

	insert into med_receita(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_receita,
		ds_receita,
		cd_pessoa_fisica,
		cd_medico,
		ie_tipo_receita,
		nr_atendimento_hosp,
		ie_situacao,
		cd_modelo_formatacao,
		nr_seq_atend_cons_pepa,
        ds_justificativa_retro,
        dt_atualizacao_nrec
	) values (
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_receita_p,
		null,
		cd_pessoa_fisica_p,
		cd_profissional_p,
		ie_tipo_receita_p,
		nr_atendimento_p,
		'A',
		nr_seq_formatacao_p,
		coalesce(nr_seq_atend_cons_pepa_p, nr_seq_atend_cons_pepa_w),
        ds_justificativa_retro_p,
        clock_timestamp()
	);
commit;

	open c01;
	loop
	fetch c01 into
		ds_material_w,
		qt_dose_w,
		cd_unidade_medida_w,
		ie_via_aplicacao_w,
		cd_intervalo_w,
		ds_fim_uso_w,
		ds_intervalo_w,
		ds_observacao_w,
		nr_dias_uso_w,
		ds_unidade_medida_w,
		ds_via_aplicacao_w,
		ie_uso_continuo_w,
		ie_laudo_lme_w,
		ds_justificativa_w,
		ds_desc_intervalo_w,
		qt_proced_1_mes_w,
		qt_proced_2_mes_w,
		qt_proced_3_mes_w,
		qt_proced_4_mes_w,
		qt_proced_5_mes_w,
		qt_proced_6_mes_w,
		qt_medic_total_w,
		ds_posologia_w,
		dt_fim_w,
		dt_inicio_w,
		ds_formafarmaceutica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		qt_medicamento_w	:= qt_medicamento_w + 1;		
		ds_receita_parcial_w	:= ds_masc_receita_w;
		qt_dose_continuo_w	:= null;
		ds_cab_via_w		:= null;
		qt_dose_2_continuo_w := null;
		
		begin
		select	coalesce(Obter_ocorrencia_intervalo(cd_intervalo_w,24,'O'),0),
			coalesce(qt_frequencia_receita,1)
		into STRICT	qt_operacao_w,
			qt_frequencia_w
		from	INTERVALO_PRESCRICAO
		where	CD_INTERVALO = cd_intervalo_w;
		exception
			when others then
			qt_operacao_w 	:= 0;
			qt_frequencia_w := 1;
			end;

		if (ie_uso_continuo_w = 'S') and (ie_laudo_lme_w = 'S') and (qt_dose_w > 0) then			
			qt_dose_continuo_w	:= ceil((qt_dose_w * qt_operacao_w) * qt_frequencia_w * 3);
		end if;
		
		if (qt_dose_w > 0) then			
			qt_dose_2_continuo_w	:= ceil((qt_dose_w * qt_operacao_w) * qt_frequencia_w * 6);
		end if;		
		
		if (ie_uso_continuo_w = 'S') and (ie_laudo_lme_w = 'N') and (qt_dose_w > 0) then			
			qt_dose_continuo_w	:= ceil((qt_dose_w * qt_operacao_w) * qt_frequencia_w);-- 30);			
		end if;

		if (ie_uso_continuo_w = 'N') and (qt_dose_w > 0) then
			qt_dose_continuo_w	:= ceil((qt_dose_w * qt_operacao_w) * qt_frequencia_w);		
			qt_dias_w := round(nr_dias_uso_w/30);
			if (qt_dias_w = 0) then
				qt_dose_continuo_w := qt_dose_w * qt_operacao_w;
			else
				qt_dose_continuo_w := round(qt_dose_continuo_w * (nr_dias_uso_w/30));
			end if;
		end if;
		
		if (ie_uso_continuo_w = 'S') and (qt_dose_w > 0) then			
			qt_padrao_dose_w	:= ceil((qt_dose_w * qt_operacao_w) * qt_frequencia_w);			
		end if;

		if (ds_via_aplicacao_w = 'Oral') then		
			ds_cab_via_w	:= obter_desc_expressao(669174);		
		end if;	

		if (ds_via_aplicacao_w <> 'Oral') then		
			ds_cab_via_w	:= obter_desc_expressao(303265);		
		end if;	
		
		if (qt_dose_w > 1) or (qt_padrao_dose_w > 1) or (qt_dose_continuo_w > 1)then
			ds_unidade_medida_w := ds_unidade_medida_w || '(s)';
			cd_unidade_medida_w := cd_unidade_medida_w || '(s)';
		end if;

      if (nr_dias_uso_w IS NOT NULL AND nr_dias_uso_w::text <> '') then
      nr_dias_WW := 'por '||nr_dias_uso_w||' dia(s)';
      else
      nr_dias_WW := nr_dias_uso_w;
      end if;

		 ie_sbis_w := obter_valor_param_usuario(0, 215, obter_perfil_ativo, nm_usuario_p, OBTER_ESTABELECIMENTO_ATIVO);
		
		if (ie_sbis_w = 1)then
		ds_valor_vazio_w := '---';
		end if;

		select	retorna_medic_formatado(ds_receita_parcial_w,'@Medicamento',coalesce(ds_material_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DoseUsoCont',coalesce(to_char(qt_dose_continuo_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DoisDoseUsoCont',coalesce(to_char(qt_dose_2_continuo_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;		
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DosePadraoMedic',coalesce(to_char(qt_padrao_dose_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@Dose',coalesce(to_char(qt_dose_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DsUnidMedDose',coalesce(ds_unidade_medida_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@UnidMedDose',coalesce(cd_unidade_medida_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;		
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DsViaAplicacao',coalesce(ds_via_aplicacao_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;		
		select	retorna_medic_formatado(ds_receita_parcial_w,'@ViaAplicacao',coalesce(ie_via_aplicacao_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@IntervaloAdm',coalesce(cd_intervalo_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@InicioUtilizacao',coalesce(to_char(dt_inicio_w,'dd/mm/yyyy'), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@FimUtilizacao',coalesce(ds_fim_uso_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@FormaFarmaceutica',coalesce(ds_formafarmaceutica_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DscIntervaloAdm',coalesce(ds_intervalo_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DiasUtil',coalesce(nr_dias_WW, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@Observacao',coalesce(ds_observacao_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;		
		select	retorna_medic_formatado(ds_receita_parcial_w,'@NumMedic',coalesce(to_char(qt_medicamento_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DsCabVia',coalesce(ds_cab_via_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;			
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DsJustificativa',coalesce(ds_justificativa_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;			
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DsUsoContinuo',CASE WHEN ie_uso_continuo_w='S' THEN obter_desc_expressao(300888)  ELSE ds_valor_vazio_w END )
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@DscIntervalo',coalesce(ds_desc_intervalo_w, ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@QtMedicTotal',coalesce(to_char(qt_medic_total_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@1Mes',coalesce(to_char(qt_proced_1_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@2Mes',coalesce(to_char(qt_proced_2_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@3Mes',coalesce(to_char(qt_proced_3_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@4Mes',coalesce(to_char(qt_proced_4_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@5Mes',coalesce(to_char(qt_proced_5_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
		select	retorna_medic_formatado(ds_receita_parcial_w,'@6Mes',coalesce(to_char(qt_proced_6_mes_w), ds_valor_vazio_w))
		into STRICT	ds_receita_parcial_w
		;
	
		if (ie_html_p <> 'S') then
			ds_receita_final_w	:= ds_receita_final_w || ds_receita_parcial_w || ds_enter_w;
		else
			if (coalesce(ds_receita_is_null_w::text, '') = '')then	
			ds_receita_final_w	:= ds_receita_final_w || ds_receita_parcial_w || ds_enter_w;
			else
			ds_receita_final_w	:= ds_receita_final_w || ds_receita_parcial_w;
			end if;
		end if;

	if (IE_LIBERADO_P = 'S') then

		insert into MED_RECEITA_ITEM(
			NR_SEQUENCIA,
			nr_seq_med_receita,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_usuario,
			dt_fim,
			dt_inicio,
			ds_medicamento,
			ds_unidade,
			qt_quantidade,
			ie_usocontinuo,
			ds_via_aplicacao,
			ds_posologia,
			ds_observacao,
			nr_dias_uso,
			ds_formafarmaceutica,
			ds_intervalo
			)
		values (
			nextval('med_receita_item_seq'),
			nr_sequencia_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			dt_fim_w,
			dt_inicio_w,
			ds_material_w,
			ds_unidade_medida_w,
			qt_dose_w,
			ie_uso_continuo_w,
			ds_via_aplicacao_w,
			ds_posologia_w,
			ds_observacao_w,
			nr_dias_uso_w,
			ds_formafarmaceutica_w,
			ds_intervalo_w
			);
	end if;
	
		end;
	end loop;
	close c01;	

	if (nr_atendimento_p > 0) then
		nr_atendimento_w := nr_atendimento_p;
	else
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from   	atendimento_paciente
		where  	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_fim_conta		<> 'F'
		and	coalesce(dt_alta::text, '') = '';
	end if;
	
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_w;
	
	ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
	ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_tam_fonte_w);
	
 	nr_tam_fonte_w	:= somente_numero(ds_tam_fonte_w)*2;

	ds_cabecalho_w	:= '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '||ds_fonte_w||';}}'||
			   '{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'||nr_tam_fonte_w||' ';
			
	ds_rodape_w	:= '}';

	ds_receita_final_w	:= replace(ds_receita_final_w, ds_enter_padrao_w, ' \par ');
	
	if (ie_html_p <> 'S') then
		ds_receita_final_w := ds_cabecalho_w||ds_receita_final_w||ds_rodape_w;
    else
        if (coalesce(ds_receita_is_null_w::text, '') = '')then
        ds_receita_final_w := ds_cabecalho_w||ds_receita_final_w||ds_rodape_w;
        end if;
	end if;
	
	
update med_receita
set ds_receita = ds_receita_final_w,
dt_liberacao = CASE WHEN IE_LIBERADO_P='S' THEN clock_timestamp()  ELSE null END ,
ds_externo = CASE WHEN IE_LIBERADO_P='S' THEN 'ESTRUTURADA'  ELSE null END 
where nr_sequencia = nr_sequencia_w;
		
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_receita_medica ( cd_pessoa_fisica_p text, cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, ds_medicamento_p text, nm_usuario_p text, nr_atendimento_p bigint, ie_html_p text default 'N', IE_LIBERADO_P text DEFAULT NULL, ds_justificativa_retro_p text DEFAULT NULL, nr_seq_atend_cons_pepa_p bigint default null, ds_erro_p INOUT text DEFAULT NULL) FROM PUBLIC;

