-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_deletar_furtran_vitima ( nr_seq_furtran_p formulario_furtran.nr_sequencia%TYPE, nr_seq_vitimas_p text) AS $body$
DECLARE


TYPE fv_tbl IS TABLE OF furtran_vitima%ROWTYPE;
fv_tbl_w fv_tbl := fv_tbl();

c01 CURSOR FOR
SELECT
	nextval('furtran_vitima_seq') nr_sequencia,
	a.nr_registro nr_seq_pessoa_vitima
FROM
	TABLE(lista_pck.obter_lista(nr_seq_vitimas_p)) a
WHERE
	a.nr_registro NOT IN (
		SELECT
			b.nr_seq_pessoa_vitima nr_registro
		FROM
			furtran_vitima b
		WHERE
			b.nr_seq_form_furtran = nr_seq_furtran_p);
			
TYPE inserir_deletar_tbl IS TABLE OF c01%ROWTYPE;
inserir_deletar_tbl_w inserir_deletar_tbl;
	
BEGIN

IF (nr_seq_furtran_p IS NOT NULL AND nr_seq_furtran_p::text <> '') THEN

OPEN c01;
LOOP
	FETCH c01 BULK COLLECT INTO inserir_deletar_tbl_w;
	
		FOR i IN 1..inserir_deletar_tbl_w.count LOOP
		
		fv_tbl_w.extend;
		fv_tbl_w[i].nr_sequencia := inserir_deletar_tbl_w[i].nr_sequencia;
		fv_tbl_w[i].dt_atualizacao := clock_timestamp();
		fv_tbl_w[i].nm_usuario := obter_usuario_ativo;
		fv_tbl_w[i].dt_atualizacao_nrec := clock_timestamp();
		fv_tbl_w[i].nm_usuario_nrec := obter_usuario_ativo;
		fv_tbl_w[i].nr_seq_form_furtran := nr_seq_furtran_p;
		fv_tbl_w[i].nr_seq_pessoa_vitima := inserir_deletar_tbl_w[i].nr_seq_pessoa_vitima;

		END LOOP;
		
		FORALL x IN fv_tbl_w.FIRST..fv_tbl_w.LAST
		INSERT INTO furtran_vitima VALUES fv_tbl_w(x);

	EXIT WHEN NOT FOUND; /* apply on c01 */
END LOOP;
CLOSE C01;

	DELETE FROM
		furtran_vitima a
	WHERE
		a.nr_seq_form_furtran = nr_seq_furtran_p
		AND a.nr_seq_pessoa_vitima NOT IN (
			SELECT
				b.nr_registro nr_seq_pessoa_vitima
			FROM
				TABLE(lista_pck.obter_lista(nr_seq_vitimas_p)) b);
COMMIT;
END IF;
	
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_deletar_furtran_vitima ( nr_seq_furtran_p formulario_furtran.nr_sequencia%TYPE, nr_seq_vitimas_p text) FROM PUBLIC;

