-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recebimento_prescricoes ( nr_prescricao_p bigint, dt_receb_prescr_p timestamp, cd_setor_atend_p bigint, ds_horarios_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_sequencia_w		bigint;
ie_existe_w		bigint;
cd_setor_w		bigint;


BEGIN

select	count(*)
into STRICT	ie_existe_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (ie_existe_w = 0) then
	ds_erro_p	:= wheb_mensagem_pck.get_texto(277893);
end if;

if (coalesce(ds_erro_p::text, '') = '') and (coalesce(cd_setor_atend_p,0) > 0) then
	select	count(*)
	into STRICT	ie_existe_w
	from	prescr_medica
	where	nr_prescricao		= nr_prescricao_p
	and	cd_pessoa_fisica in (	SELECT	a.cd_pessoa_fisica
					from     ocupacao_unidade_v a,
					         setor_atendimento s
					where    a.cd_setor_atendimento = s.cd_setor_atendimento
					and      s.cd_setor_atendimento = cd_setor_atend_p
					and      (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> ''));
	
	if (ie_existe_w = 0) then
		ds_erro_p	:= wheb_mensagem_pck.get_texto(277895);
	end if;
end if;


if (coalesce(ds_erro_p::text, '') = '') then
	begin
	select	nextval('prescr_medic_setor_seq')
	into STRICT	nr_sequencia_w
	;
	
	if (coalesce(cd_setor_atend_p,0) = 0) then
		cd_setor_w := obter_setor_ativo;
	end if;
	
	Insert into prescr_medic_setor(
		nr_sequencia,
		nr_prescricao,
		dt_atualizacao,
		nm_usuario,
		cd_setor_atendimento,
		dt_recebimento,
		ds_horario)
	Values (	nr_sequencia_w,
		nr_prescricao_p,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(cd_setor_w,cd_setor_atend_p),
		dt_receb_prescr_p,
		ds_horarios_p);
	
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recebimento_prescricoes ( nr_prescricao_p bigint, dt_receb_prescr_p timestamp, cd_setor_atend_p bigint, ds_horarios_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

