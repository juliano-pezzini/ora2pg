-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_enteral_rotina ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_paciente_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_produto_p nutricao_produto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w				log_cpoe.ds_stack%type;
ds_log_cpoe_w			log_cpoe.ds_log%type;
nr_etapas_w				cpoe_dieta.nr_etapas%type;
cd_intervalo_w			cpoe_dieta.cd_intervalo%type;
ds_horarios_w			cpoe_dieta.ds_horarios%type;
hr_prim_horario_w		cpoe_dieta.hr_prim_horario%type;
dt_inicio_w				cpoe_dieta.dt_inicio%type;
dt_inicio_base_w		cpoe_dieta.dt_inicio%type;
ie_via_aplicacao_w      cpoe_dieta.ie_via_aplicacao%type;
ie_bomba_infusao_w      cpoe_dieta.ie_bomba_infusao%type;
cd_material_w           cpoe_dieta.cd_material%type;
qt_dose_w               cpoe_dieta.qt_dose%type;
cd_unidade_medida_w     cpoe_dieta.cd_unidade_medida_dose%type;
cd_intervalo_agora_w	cpoe_dieta.cd_intervalo%type;
ie_duracao_w			cpoe_dieta.ie_duracao%type := 'C';
ie_evento_unico_w		cpoe_dieta.ie_evento_unico%type := 'N';
dt_fim_w				cpoe_dieta.dt_fim%type := null;
qt_vel_infusao_w		double precision;

ie_dose_unica_cpoe_w	intervalo_prescricao.ie_dose_unica_cpoe%type;
ie_continuo_w 			intervalo_prescricao.ie_continuo%type;

cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
ie_urgencia_w			char(1):=null;
ie_prescr_alta_agora_w	varchar(1);
ie_exibe_w			intervalo_prescricao.CD_INTERVALO%type;
qt_operacao_w 			intervalo_prescricao.qt_operacao%type;
ie_operacao_w			intervalo_prescricao.ie_operacao%type;
ds_operacao_w			varchar(10):= null;

ds_observacao_w			cpoe_dieta.ds_observacao%type;
ds_observacao_ww		cpoe_dieta.ds_observacao%type;
ds_observacao_www		cpoe_dieta.ds_observacao%type;

cd_intervalo_out_w		material_prescr.cd_intervalo%type;
qt_dose_out_w			material_prescr.qt_dose%type;
cd_unidade_medida_out_w material_prescr.cd_unidade_medida%type;
ie_bomba_infusao_out_w	material_prescr.ie_dispositivo_infusao%type;
hr_prim_horario_out_w	material_prescr.hr_prim_horario%type;
ie_tipo_dosagem_out_w	material_prescr.ie_tipo_dosagem%type;
qt_min_aplicacao_out_w	bigint;
qt_solucao_out_w		material_prescr.qt_solucao%type;
ie_se_necessario_out_w	material_prescr.ie_se_necessario%type;
nr_seq_mat_prescr_out_w	material_prescr.nr_sequencia%type;
qt_dose_terapeutica_w	material_prescr.qt_dose_terap_limite%type;
qt_dose_terap_limite_w	material_prescr.qt_dose_terapeutica%type;
nr_seq_dose_terap_w		material_prescr.nr_seq_dose_terap%type;
qt_dose_terap_min_w			material_prescr.qt_dose_terap_min%type;
ds_orientacao_w			nutricao_produto.ds_orientacao%type;
ie_calc_automatico_w	nutricao_produto.ie_calc_automatico%type;
qt_hora_aplicacao_w		smallint := null;
ie_tipo_dosagem_w       varchar(255);	
qt_volume_w				cpoe_dieta.qt_volume_total%type;
ie_administracao_w		cpoe_dieta.ie_administracao%type := 'P';
ie_dieta_especial_w		cpoe_dieta.ie_dieta_especial%type := 'N';


BEGIN

ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
dt_inicio_base_w	:= trunc(clock_timestamp(),'mi');

select	max(cd_material),
        max(qt_dose),
        max(cd_unidade_medida),
        max(cd_intervalo),
        max(ie_via_aplicacao),
        max(ie_bomba_infusao),
        max(ds_horarios),
		max(ds_orientacao),
		max(ie_calc_automatico)
into STRICT	cd_material_w,
        qt_dose_w,
        cd_unidade_medida_w,
        cd_intervalo_w,
        ie_via_aplicacao_w,
        ie_bomba_infusao_w,
        ds_horarios_w,
		ds_orientacao_w,
		ie_calc_automatico_w
from	nutricao_produto
where	nr_sequencia = nr_seq_produto_p;

hr_prim_horario_w	:= coalesce(substr(cpoe_obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, null, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p ),1,5), hr_prim_horario_w);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	cd_setor_atendimento_w	:= obter_setor_atendimento(nr_atendimento_p);
end if;

cd_intervalo_w		:= coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, cd_setor_atendimento_w, cd_paciente_p, null, null, 'N','I',cd_intervalo_w), cd_intervalo_w);
hr_prim_horario_w	:= coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, cd_setor_atendimento_w, cd_paciente_p, null, null, 'N','H',cd_intervalo_w), hr_prim_horario_w);
qt_dose_w			:= coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, cd_setor_atendimento_w, cd_paciente_p, null, null, 'N','D',cd_intervalo_w), qt_dose_w);
ie_via_aplicacao_w	:= coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, cd_setor_atendimento_w, cd_paciente_p, null, null, 'N','V',cd_intervalo_w), ie_via_aplicacao_w);
ie_tipo_dosagem_w   := coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, cd_setor_atendimento_w, cd_paciente_p, null, null, 'N','TD',cd_intervalo_w),'mlh');

if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
	cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'8',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);

	if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
		cd_intervalo_w := cd_intervalo_agora_w;
		ie_urgencia_w  := '0';
		hr_prim_horario_w :=  to_char(clock_timestamp(),'hh24:mi');			
	end if;
end if;	

if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
	select	max(ie_dose_unica_cpoe)
	into STRICT	ie_dose_unica_cpoe_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

	if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
		ie_duracao_w := 'P';
		ie_evento_unico_w := 'S';
	end if;
end if;

if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then	
	ie_urgencia_w  := '0';	
	hr_prim_horario_w :=  to_char(clock_timestamp(),'hh24:mi');			
end if;

if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
	dt_inicio_w			:= to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ')  || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
else
	dt_inicio_w			:= dt_inicio_base_w;
end if;

if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
	dt_inicio_w := dt_inicio_p;
	dt_fim_w := (dt_inicio_w + 1) - 1/1440;
	ie_duracao_w := 'P';
	ie_urgencia_w  := null;	
	hr_prim_horario_w :=  to_char(dt_inicio_w,'hh24:mi');
end if;

nr_etapas_w			:= null;
ds_horarios_w		:= null;

--CPOE_Calcula_horarios_etapas( nm_usuario_p, dt_inicio_w, 'S', nr_etapas_w, cd_intervalo_w, 24, null, null, ds_horarios_w, 'N' );
SELECT * FROM CPOE_Calcula_horarios_enteral( nm_usuario_p, dt_inicio_w, 'S', nr_etapas_w, cd_intervalo_w, 24, null, null, 'N', null, null, 'N', nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p) INTO STRICT nr_etapas_w, ds_horarios_w;

if (ie_duracao_w = 'P') then
	dt_fim_w := (dt_inicio_w + 1) - 1/1440;
end if;

select	nextval('cpoe_dieta_seq')
into STRICT	nr_seq_item_gerado_p
;

select	CASE WHEN max(ie_continuo)='N' THEN  'I'  ELSE 'C' END
into STRICT	ie_continuo_w
from	intervalo_prescricao
where	cd_intervalo = cd_intervalo_w;

if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '')then
		-- esse select deve ser o mesmo que ata ativando o lookup de intervalo, qualquer alteracao aqui deve ser replicada para o looup e vice-versa
		SELECT coalesce(MAX(cd_intervalo),'N')
		INTO STRICT ie_exibe_w
		FROM intervalo_prescricao
		WHERE 	cd_intervalo = cd_intervalo_w
		AND 	ie_situacao = 'A'
		AND (obter_se_intervalo(cd_intervalo,'8')) = 'S'
		AND	obter_se_interv_regra(cd_intervalo, case to_char('8') when 'G' then 'GAS' when '15' then '15' when '8' then 'DE' end) = 'S'
		and 	cpoe_obter_se_exibe_interv(nr_atendimento_p,cd_estabelecimento_p,cd_intervalo_w,cd_perfil_p,nm_usuario_p) = 'S'
		AND	((coalesce(cd_estabelecimento::text, '') = '') OR (cd_estabelecimento = cd_estabelecimento_p))
		AND	Obter_se_exibe_intervalo(0, cd_intervalo_w, NULL) = 'S'
		AND	Obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p) = 'S'
		AND	Obter_se_intervalo_lib_mat(cd_material_w, cd_intervalo_w) = 'S'
		AND	Obter_se_intervalo_material(cd_material_w, cd_intervalo_w) = 'S'
		AND	((coalesce(ie_so_retrograda,'N') = 'N') OR (coalesce(ie_retrogrado_p,'N') = 'N'));
		
		if (ie_exibe_w = 'N')then
			cd_intervalo_w := null;
		end if;
end if;
	
if (coalesce(cd_intervalo_w::text, '') = '')  or (cd_intervalo_w = '') then
	ds_horarios_w	:= '';
end if;

if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '')then
	select 	campo_numerico(qt_operacao),
		ie_operacao
	into STRICT 	qt_operacao_w,
		ie_operacao_w
	from 	intervalo_prescricao
	where 	CD_INTERVALO = cd_intervalo_w;
	
	if ( ie_continuo_w = 'C') then
		if (ie_operacao_w = 'H')then
			ds_operacao_w := lpad( qt_operacao_w,2,'0') || ':00';
			qt_hora_aplicacao_w := obter_ocorrencia_interv_dieta(cd_intervalo_w, 24, 'O');
		else
			qt_hora_aplicacao_w := 24;
		end if;
	end if;
	
end if;

ds_observacao_ww := obter_dados_via_aplicacao(cd_material_w, ie_via_aplicacao_w, cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p), 'R');

SELECT * FROM cpoe_obter_padrao_terap_prescr(nr_atendimento_p, cd_paciente_p, cd_material_w, ie_via_aplicacao_w, null, cd_intervalo_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_intervalo_out_w, qt_dose_out_w, cd_unidade_medida_out_w, ie_bomba_infusao_out_w, hr_prim_horario_out_w, ie_tipo_dosagem_out_w, ds_observacao_www, qt_min_aplicacao_out_w, qt_solucao_out_w, ie_se_necessario_out_w, nr_seq_mat_prescr_out_w, 0, qt_dose_terapeutica_w, qt_dose_terap_limite_w, nr_seq_dose_terap_w, qt_dose_terap_min_w) INTO STRICT cd_intervalo_out_w, qt_dose_out_w, cd_unidade_medida_out_w, ie_bomba_infusao_out_w, hr_prim_horario_out_w, ie_tipo_dosagem_out_w, ds_observacao_www, qt_min_aplicacao_out_w, qt_solucao_out_w, ie_se_necessario_out_w, nr_seq_mat_prescr_out_w, qt_dose_terapeutica_w, qt_dose_terap_limite_w, nr_seq_dose_terap_w, qt_dose_terap_min_w;


select	substr(CASE WHEN coalesce(ds_orientacao_w::text, '') = '' THEN null  ELSE ds_orientacao_w || chr(13) END  ||
		CASE WHEN coalesce(ds_observacao_ww::text, '') = '' THEN null  ELSE ds_observacao_ww||chr(13) END  ||
		CASE WHEN coalesce(ds_observacao_www::text, '') = '' THEN null  ELSE ds_observacao_www END ,1,4000)
into STRICT 	ds_observacao_w
;

if (ie_calc_automatico_w = 'S') then

	if (upper(cd_unidade_medida_w) <> upper(obter_unid_med_usua('ml'))) then
		qt_dose_w := obter_conversao_ml(cd_material_w, qt_dose_w, cd_unidade_medida_w);
	end if;
	
	if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (coalesce(qt_hora_aplicacao_w, 0) > 0) then
		if (upper(ie_tipo_dosagem_w) = 'MLH') then
			qt_vel_infusao_w	:= round((dividir(qt_dose_w,qt_hora_aplicacao_w))::numeric, 2); -- Realizado a divisao ao inves da multiplicacao
		elsif	((upper(ie_tipo_dosagem_w) = 'GTM') or (upper(ie_tipo_dosagem_w) = 'GPM'))	then
			qt_vel_infusao_w	:= round((dividir(dividir(qt_dose_w * 20, qt_hora_aplicacao_w), 60))::numeric, 2);
		elsif	((upper(ie_tipo_dosagem_w) = 'MGM') or (upper(ie_tipo_dosagem_w) = 'MGPM')) then
			qt_vel_infusao_w	:= round((dividir(dividir(qt_dose_w * 60, qt_hora_aplicacao_w), 60))::numeric,2 );
        end if;	
    end if;	

end if;

if ( ie_continuo_w = 'C') then
	ds_operacao_w := coalesce(ds_operacao_w,'24:00');
end if;	

qt_volume_w :=  coalesce(cpoe_obter_volume_total(cd_material_w, qt_dose_w, cd_unidade_medida_w,
				null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null), 0);
		
if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
	ie_administracao_w := obter_administracao_intervalo(cd_intervalo_w);
end if;

select 	coalesce(max(ie_dieta_especial), 'N')
into STRICT 	ie_dieta_especial_w
from 	nutricao_produto nut,
        material mat
where 	nut.cd_material = cd_material_w
and     mat.cd_material = nut.cd_material
and     mat.ie_tipo_material <> 2;

insert into cpoe_dieta(
				nr_sequencia,
				cd_material,
				ie_via_aplicacao,
				qt_dose,
				cd_unidade_medida_dose,
				nr_seq_via_acesso,
				ie_bomba_infusao,
				ie_continuo,
				qt_volume,
				qt_tempo_aplic,
				qt_tempo_pausa,
				ie_referencia,
				cd_intervalo,
				nr_etapas,
				nr_ocorrencia,
				qt_vel_infusao,
				ie_tipo_dosagem,
				qt_volume_total,
				ie_administracao,
				dt_inicio,
				hr_prim_horario,
				ie_urgencia,
				ds_horarios,
				ie_duracao,
				ie_evento_unico,
				dt_fim,
				ds_justificativa,
				ds_observacao,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nr_atendimento,
				cd_pessoa_fisica,
				ie_tipo_dieta,
				cd_perfil_ativo,
				cd_funcao_origem,
				nr_seq_transcricao,
				ie_item_alta,
				ie_prescritor_aux,
				cd_medico,
				ie_retrogrado,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				nr_seq_conclusao_apae,
				ie_futuro,
				nr_seq_cpoe_order_unit,
                ie_dieta_especial)
			values (
				nr_seq_item_gerado_p,
				cd_material_w,
				ie_via_aplicacao_w,
				qt_dose_w,
				cd_unidade_medida_w,
				null,
				ie_bomba_infusao_w,
				ie_continuo_w,
				qt_volume_w,
				ds_operacao_w,
				null,
				'I',
				cd_intervalo_w,
				nr_etapas_w,
				nr_etapas_w,
				qt_vel_infusao_w,
				ie_tipo_dosagem_w,
				qt_volume_w,
				ie_administracao_w,
				dt_inicio_w,
				hr_prim_horario_w,
				ie_urgencia_w,
				trim(both ds_horarios_w),
				ie_duracao_w,
				ie_evento_unico_w,
				dt_fim_w,
				'',
				ds_observacao_w,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				nr_atendimento_p,
				cd_paciente_p,
				'E',
				cd_perfil_p,
				2314,
				nr_seq_transcricao_p,
				ie_item_alta_p,
				ie_prescritor_aux_p,
				cd_medico_p,
				ie_retrogrado_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				nr_seq_conclusao_apae_p,
				ie_futuro_p,
				nr_seq_cpoe_order_unit_p,
				ie_dieta_especial_w);

commit;

exception
   when others then
	rollback;
	
	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_ENTERAL_ROTINA '
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - nr_seq_produto_p: ' || nr_seq_produto_p
		|| chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || to_char(dt_inicio_p, 'dd/mm/yyyy hh24:mi:ss')
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
		
	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_enteral_rotina ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_paciente_p pessoa_fisica.cd_pessoa_fisica%type, nr_seq_produto_p nutricao_produto.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

