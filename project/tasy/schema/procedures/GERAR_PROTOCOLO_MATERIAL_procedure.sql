-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_protocolo_material (cd_protocolo_dest_p bigint , nr_seq_destino_p bigint , nr_seq_material_p text) AS $body$
DECLARE

 nr_agrupamento_w protocolo_medic_material.nr_agrupamento%TYPE;
 nr_seq_material_w protocolo_medic_material.nr_seq_material%TYPE;
 nm_usuario_w   varchar(255);

BEGIN
  nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
 
  IF (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') THEN 
   SELECT Obter_seq_mat_prot_medic_mat(cd_protocolo_dest_p, nr_seq_destino_p) 
       , coalesce(nr_agrupamento_w, Obter_agrup_prot_medic_mat(cd_protocolo_dest_p, nr_seq_destino_p, 0)) 
   INTO STRICT  nr_seq_material_w, nr_agrupamento_w 
;
 
   begin 
   INSERT INTO protocolo_medic_material(cd_protocolo 
          , nr_sequencia 
          , nr_seq_material 
          , cd_material 
          , qt_dose 
          , cd_unidade_medida 
          , ie_via_aplicacao 
          , ds_horarios 
          , ie_checar_adep 
          , cd_intervalo 
          , hr_prim_horario 
          , ie_urgencia 
          , nr_agrupamento 
          , ie_agrupador 
          , ie_aplic_bolus 
          , ie_aplic_lenta 
          , ie_lado 
          , ie_acm 
          , qt_minuto_aplicacao 
          , qt_hora_aplicacao 
          , ie_bomba_infusao 
          , ds_dose_diferenciada 
          , qt_solucao 
          , ie_objetivo 
          , cd_topografia_cih 
          , cd_microorganismo_cih 
          , cd_amostra_cih 
          , ie_origem_infeccao 
          , ie_indicacao 
          , ie_uso_antimicrobiano 
          , dt_atualizacao 
          , ds_justificativa 
          , nm_usuario) 
   SELECT cd_protocolo_dest_p 
       , nr_seq_destino_p 
       , nr_seq_material_w 
       , cd_material 
       , qt_dose 
       , cd_unidade_medida 
       , ie_via_aplicacao 
       , ds_horarios 
       , '' 
       , cd_intervalo 
       , hr_prim_horario 
       , coalesce(ie_urgencia, 'N') 
       , nr_agrupamento_w 
       , 2 
       , coalesce(ie_aplic_bolus, 'N') 
       , coalesce(ie_aplic_lenta, 'N') 
       , ie_lado 
       , ie_acm 
       , qt_min_aplicacao 
       , qt_hora_aplicacao 
       , coalesce(ie_bomba_infusao, 'N') 
       , ds_dose_diferenciada 
       , qt_solucao 
       , ie_objetivo 
       , cd_topografia_cih 
       , cd_microorganismo_cih 
       , cd_amostra_cih 
       , ie_origem_infeccao 
       , ie_indicacao 
       , ie_uso_antimicrobiano 
       , clock_timestamp() 
       , ds_justificativa 
       , nm_usuario_w 
   FROM  cpoe_material 
   WHERE nr_sequencia = nr_seq_material_p 
     AND coalesce(nr_seq_procedimento::text, '') = '' 
     AND coalesce(ie_material, 'N') = 'S';
	 exception 
	when unique_violation then 
		null;
	end;
  /*and	((decode(dt_lib_suspensao, null, nvl(dt_fim_cih,dt_fim), nvl(dt_suspensao,dt_fim)) >= sysdate) or 
  	 (decode(dt_lib_suspensao, null, nvl(dt_fim_cih,dt_fim), nvl(dt_suspensao,dt_fim)) is null) or 
  	 (NVL(ie_retrogrado,'N') = 'S' AND dt_inicio >= dt_inicio_prescr_p)) ;*/
-- retrograde/backward item 
  END IF;
 
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_protocolo_material (cd_protocolo_dest_p bigint , nr_seq_destino_p bigint , nr_seq_material_p text) FROM PUBLIC;

