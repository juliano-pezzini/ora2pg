-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_itens_sc_contrato ( cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, cd_setor_atendimento_p bigint, cd_moeda_p bigint, ie_frete_p text, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nr_seq_tipo_compra_p bigint, nr_seq_mod_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_entrega_solic_p text, ds_lista_oc_p INOUT text) AS $body$
DECLARE


nr_solic_compra_w			bigint;
nr_item_solic_compra_w			bigint;
nr_contrato_w				bigint;
vl_pagto_w				double precision;
nr_ordem_compra_w			bigint;
cd_cgc_contratado_w			varchar(14);
cd_pessoa_contratada_w			varchar(10);
cd_cgc_contratado_ww			varchar(14);
cd_pessoa_contratada_ww			varchar(10);
cd_condicao_pagamento_w			bigint;
cd_centro_custo_w			bigint;
cd_centro_custo_ww			bigint;
cd_local_estoque_w			bigint;
cd_pessoa_solicitante_w			varchar(10);
cd_material_w				bigint;
qt_material_w				double precision;
cd_unidade_medida_compra_w		varchar(30);
nr_seq_proj_rec_w			bigint;
nr_seq_regra_contrato_w			bigint;
cd_conta_contabil_w			varchar(20);
ie_tipo_conta_w				integer	:= 2;
nr_item_oci_w				integer;
ds_observacao_orig_w			varchar(255);
ds_observacao_w				varchar(255);
ds_lista_oc_w				varchar(2000);
ie_estoque_w				varchar(1);
dt_entrega_w				timestamp;
qt_entrega_solicitada_w			double precision;
dt_entrega_solicitada_w			timestamp;
ie_aprova_aut_oc_w			varchar(1);
vl_total_item_w				ordem_compra_item.vl_total_item%type;
ds_observacao_solic_w			solic_compra.ds_observacao%type;
ds_observacao_item_w		solic_compra_item.ds_observacao%type;
ie_somente_pagto_w		ordem_compra.ie_somente_pagto%type;
ie_aplica_tributos_oc_w		varchar(15);
cd_tributo_w			contrato_regra_pagto_trib.cd_tributo%type;
vl_tributo_w			contrato_regra_pagto_trib.vl_tributo%type;
pr_tributo_w			contrato_regra_pagto_trib.pr_tributo%type;
ie_corpo_item_w			contrato_regra_pagto_trib.ie_corpo_item%type;
ie_centro_custo_oc_contr_w	parametro_compras.ie_centro_custo_oc_contr%type;
vl_desconto_w			contrato_regra_nf.vl_desconto%type;
pr_desconto_w			contrato_regra_nf.pr_desconto%type;
qt_material_fixa_w		contrato_regra_nf.qt_material_fixa%type;
pr_desc_financ_w		contrato_regra_pagto.pr_desc_financ%type;

c01 CURSOR FOR
SELECT	nr_solic_compra,
	nr_item_solic_compra,
	nr_contrato,
	vl_pagto,
	vl_desconto,
	pr_desconto
from	w_itens_oc_contrato_sc
where	nm_usuario = nm_usuario_p
order by nr_contrato,
	nr_solic_compra,
	nr_item_solic_compra;
	
c02 CURSOR FOR
SELECT	nr_ordem_compra
from	ordem_compra
where	obter_se_contido_char(nr_ordem_compra,replace(ds_lista_oc_w,' ','')) = 'S';

c03 CURSOR FOR
SELECT	dt_entrega_solicitada,
	qt_entrega_solicitada
FROM	solic_compra_item_entrega
WHERE	nr_solic_compra = nr_solic_compra_w
AND	nr_item_solic_compra = nr_item_solic_compra_w
and	ie_entrega_solic_p = 'S';

c04 CURSOR FOR
SELECT	cd_tributo,
	vl_tributo,
	pr_tributo,
	ie_corpo_item
from	contrato_regra_pagto_trib
where	nr_seq_regra_nf = nr_seq_regra_contrato_w;
					

BEGIN

select (max(obter_valor_param_usuario(913, 185, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))),
	(max(obter_valor_param_usuario(913, 247, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))),
	(max(obter_valor_param_usuario(913, 289, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)))
into STRICT	ie_estoque_w,
	ie_aprova_aut_oc_w,
	ie_aplica_tributos_oc_w
;

open C01;
loop
fetch C01 into	
	nr_solic_compra_w,
	nr_item_solic_compra_w,
	nr_contrato_w,
	vl_pagto_w,
	vl_desconto_w,
	pr_desconto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	cd_conta_contabil_w := '';
	
	select	a.cd_centro_custo,
		a.cd_local_estoque,
		a.cd_pessoa_solicitante,
		a.ds_observacao
	into STRICT	cd_centro_custo_w,
		cd_local_estoque_w,
		cd_pessoa_solicitante_w,
		ds_observacao_solic_w
	from	solic_compra a
	where	a.nr_solic_compra = nr_solic_compra_w;
	
	select	cd_cgc_contratado,
		cd_pessoa_contratada,
		cd_condicao_pagamento,
		ie_somente_oc_pagto
	into STRICT	cd_cgc_contratado_w,
		cd_pessoa_contratada_w,
		cd_condicao_pagamento_w,
		ie_somente_pagto_w
	from	contrato
	where	nr_sequencia = nr_contrato_w;

	select 	obter_desconto_financ_contr(nr_contrato_w)
	into STRICT   	pr_desc_financ_w
	;
	
	if	((coalesce(cd_cgc_contratado_w,'0') <> coalesce(cd_cgc_contratado_ww,'0')) or (coalesce(cd_pessoa_contratada_w,'0') <> coalesce(cd_pessoa_contratada_ww,'0'))) then
		
				
		if (coalesce(cd_condicao_pagamento_w::text, '') = '') then
			--(-20011,'Nao existe condicao de pagamento informada no contrato seq. ' || NR_CONTRATO_W || '.');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(182427,'NR_CONTRATO_W='||NR_CONTRATO_W);
		end if;

		if (coalesce(cd_cgc_contratado_w::text, '') = '') and (coalesce(cd_pessoa_contratada_w::text, '') = '') then
			--(-20011,'Nao existe pessoa fisica ou juridica informada no contrato seq. ' || nr_contrato_w || ' para a geracao da ordem de compras.');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(182428,'NR_CONTRATO_W='||NR_CONTRATO_W);
		end if;
		
		select	nextval('ordem_compra_seq')
		into STRICT	nr_ordem_compra_w
		;

		if (ie_entrega_solic_p = 'S') then
			dt_entrega_w	:= clock_timestamp();
		else
			dt_entrega_w	:= dt_entrega_p;
		end if;
	
		insert into ordem_compra(
			nr_ordem_compra,
			cd_estabelecimento,
			cd_cgc_fornecedor,
			cd_condicao_pagamento,
			cd_comprador,
			dt_ordem_compra,
			dt_atualizacao,
			nm_usuario,
			cd_moeda,
			ie_situacao,
			dt_inclusao,
			cd_pessoa_solicitante,
			ie_frete,
			vl_frete,
			pr_desconto,
			pr_desc_pgto_antec,
			pr_juros_negociado,
			dt_entrega,
			ie_aviso_chegada,
			cd_pessoa_fisica,
			ie_emite_obs,
			ie_urgente,
			cd_setor_atendimento,
			pr_desc_financeiro,
			vl_desconto,
			ie_somente_pagto,
			ie_tipo_ordem,
			cd_local_entrega,
			nr_seq_tipo_compra,
			nr_seq_mod_compra,
			ds_observacao)
		values (	nr_ordem_compra_w,
			cd_estabelecimento_p,
			cd_cgc_contratado_w,
			cd_condicao_pagamento_w,
			cd_comprador_p,
			coalesce(dt_ordem_p,clock_timestamp()),
			clock_timestamp(),
			nm_usuario_p,
			cd_moeda_p,
			'A',
			coalesce(dt_inclusao_p,clock_timestamp()),
			cd_pessoa_solicitante_w,
			coalesce(ie_frete_p,clock_timestamp()),
			0,
			0,
			0,
			0,
			dt_entrega_w,
			ie_aviso_chegada_p,
			cd_pessoa_contratada_w,
			ie_emite_obs_p,
			ie_urgente_p,
			cd_setor_atendimento_p,
			pr_desc_financ_w,
			0,
			coalesce(ie_somente_pagto_w,'N'),
			'C',
			cd_local_estoque_w,
			CASE WHEN nr_seq_tipo_compra_p=0 THEN null  ELSE nr_seq_tipo_compra_p END ,
			CASE WHEN nr_seq_mod_compra_p=0 THEN null  ELSE nr_seq_mod_compra_p END ,
			substr(ds_observacao_solic_w,1,4000));
		
		cd_cgc_contratado_ww	:= cd_cgc_contratado_w;
		cd_pessoa_contratada_ww	:= cd_pessoa_contratada_w;		
		
		ds_lista_oc_w	:= substr(ds_lista_oc_w || nr_ordem_compra_w || ', ',1,2000);
	end if;

	if (nr_ordem_compra_w > 0) then
		
		select	a.cd_material,
			a.qt_material,
			a.cd_unidade_medida_compra,
			a.nr_seq_proj_rec,
			a.nr_seq_regra_contrato,
			a.ds_observacao
		into STRICT	cd_material_w,
			qt_material_w,
			cd_unidade_medida_compra_w,
			nr_seq_proj_rec_w,
			nr_seq_regra_contrato_w,
			ds_observacao_item_w
		from	solic_compra_item a
		where	a.nr_solic_compra 	= nr_solic_compra_w
		and	a.nr_item_solic_compra	= nr_item_solic_compra_w;
		
		if (ie_estoque_w = 'S') then
			select	coalesce(max(cd_material),cd_material_w)
			into STRICT	cd_material_w
			from	contrato_regra_nf
			where	nr_seq_contrato = nr_contrato_w
			and	obter_dados_material(cd_material,'EST') = obter_dados_material(cd_material_w,'EST');
		
		end if;
		
		select	coalesce(max(nr_item_oci),0) + 1
		into STRICT	nr_item_oci_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_w;
		
		if (nr_contrato_w > 0) and (coalesce(nr_seq_regra_contrato_w,0) = 0) then
		
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_regra_contrato_w
			from	contrato_regra_nf
			where	nr_seq_contrato = nr_contrato_w
			and	cd_material = cd_material_w;		
		end if;
		
		if (nr_seq_regra_contrato_w > 0) then
		
			select 	max(coalesce(ie_centro_custo_oc_contr,'SC'))
			into STRICT 	ie_centro_custo_oc_contr_w		
			from 	parametro_compras
			where 	cd_estabelecimento = cd_estabelecimento_p;
		
			if (ie_centro_custo_oc_contr_w = 'CO') then
				select	cd_centro_custo
				into STRICT	cd_centro_custo_w
				from	contrato_regra_nf
				where	nr_sequencia = nr_seq_regra_contrato_w;
			end if;
			
			select	cd_conta_contabil
			into STRICT	cd_conta_contabil_w
			from	contrato_regra_nf
			where	nr_sequencia = nr_seq_regra_contrato_w;
		
		end if;
		
		cd_centro_custo_ww := cd_centro_custo_w;
				
		if (coalesce(cd_conta_contabil_w::text, '') = '') then

			if (coalesce(cd_centro_custo_w::text, '') = '') then
				ie_tipo_conta_w	:= 2;
			else
				ie_tipo_conta_w	:= 3;
			end if;

			SELECT * FROM define_conta_material(	cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, null, null, null, null, null, null, null, cd_local_estoque_w, Null, dt_ordem_p, cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
		end if;	

		vl_total_item_w	:= qt_material_w * vl_pagto_w;		
		
		insert into ordem_compra_item(
			nr_ordem_compra,
			nr_item_oci,
			cd_material,
			cd_unidade_medida_compra,
			vl_unitario_material,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			cd_pessoa_solicitante,
			pr_descontos,
			cd_local_estoque,
			vl_item_liquido,
			cd_centro_custo,
			cd_conta_contabil,
			pr_desc_financ,
			vl_desconto,
			ie_geracao_solic,
			nr_contrato,
			nr_seq_proj_rec,
			nr_solic_compra,
			nr_item_solic_compra,
			vl_total_item,
			ds_observacao,
            nr_seq_regra_contrato)
		values (	nr_ordem_compra_w,
			nr_item_oci_w,
			cd_material_w,
			cd_unidade_medida_compra_w,
			vl_pagto_w,
			qt_material_w,
			clock_timestamp(),
			nm_usuario_p,
			'A',
			cd_pessoa_solicitante_w,
			pr_desconto_w,
			cd_local_estoque_w,
			vl_pagto_w,
			cd_centro_custo_ww,
			cd_conta_contabil_w,
			0,
			vl_desconto_w,
			'U',
			nr_contrato_w,
			nr_seq_proj_rec_w,
			nr_solic_compra_w,
			nr_item_solic_compra_w,
			vl_total_item_w,
			substr(ds_observacao_item_w,1,255),
            nr_seq_regra_contrato_w);
			
			
		if (ie_aplica_tributos_oc_w = 'S') and (nr_seq_regra_contrato_w > 0) then
			
			select qt_material_fixa
			into STRICT qt_material_fixa_w
			from contrato_regra_nf
			where nr_sequencia = nr_seq_regra_contrato_w;
	
			open C04;
			loop
			fetch C04 into	
				cd_tributo_w,
				vl_tributo_w,
				pr_tributo_w,
				ie_corpo_item_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin

				if (coalesce(pr_tributo_w,0) = 0) then
					pr_tributo_w :=  dividir(vl_tributo_w , (coalesce(qt_material_fixa_w,1) * vl_pagto_w)) * 100; -- gerar percentual
				end if;
				vl_tributo_w :=  vl_total_item_w/100*pr_tributo_w;

				insert into ordem_compra_item_trib(
					nr_ordem_compra,
					nr_item_oci,
					cd_tributo,
					pr_tributo,
					vl_tributo,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_corpo_item)
				values (	nr_ordem_compra_w,
					nr_item_oci_w,
					cd_tributo_w,
					pr_tributo_w,
					coalesce(vl_tributo_w,0),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					ie_corpo_item_w);
				end;
			end loop;
			close C04;
		end if;

		if (ie_entrega_solic_p = 'S') then
			begin

			open C03;
			loop
			fetch C03 into	
				dt_entrega_solicitada_w,
				qt_entrega_solicitada_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				
				insert into ordem_compra_item_entrega(
					nr_ordem_compra,
					nr_item_oci,
					dt_prevista_entrega,
					qt_prevista_entrega,
					dt_atualizacao,
					nm_usuario,
					nr_sequencia)
				values (	nr_ordem_compra_w,
					nr_item_oci_w,
					dt_entrega_solicitada_w,
					qt_entrega_solicitada_w,
					clock_timestamp(),
					nm_usuario_p,
					nextval('ordem_compra_item_entrega_seq'));
				end;
			end loop;
			close C03;

			end;
		else
			begin

			insert into ordem_compra_item_entrega(
				nr_ordem_compra,
				nr_item_oci,
				dt_prevista_entrega,
				qt_prevista_entrega,
				dt_atualizacao,
				nm_usuario,
				nr_sequencia)
			values (	nr_ordem_compra_w,
				nr_item_oci_w,
				dt_entrega_w,
				qt_material_w,
				clock_timestamp(),
				nm_usuario_p,
				nextval('ordem_compra_item_entrega_seq'));

			end;
		end if;
		
		select	ds_observacao
		into STRICT	ds_observacao_orig_w
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w
		and	nr_item_solic_compra = nr_item_solic_compra_w;

		ds_observacao_w	:= wheb_mensagem_pck.get_texto(301884,'NR_ORDEM_COMPRA_W='||nr_ordem_compra_w);
		if (ds_observacao_orig_w IS NOT NULL AND ds_observacao_orig_w::text <> '') then
			ds_observacao_w	:=	substr(ds_observacao_orig_w || chr(10) || chr(13) || ds_observacao_w,1,255);
		end if;

		update	solic_compra_item
		set	ds_observacao = ds_observacao_w
		where	nr_solic_compra = nr_solic_compra_w
		and	nr_item_solic_compra = nr_item_solic_compra_w;	
	
	end if;	
	end;
end loop;
close C01;

ds_lista_oc_w := substr(ds_lista_oc_w,1,length(ds_lista_oc_w)-2);

open C02;
loop
fetch C02 into	
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	if (ie_entrega_solic_p = 'S') then
		begin

		select	min(dt_prevista_entrega)
		into STRICT	dt_entrega_w
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_compra_w;

		update	ordem_compra
		set	dt_entrega = dt_entrega_w
		where	nr_ordem_compra = nr_ordem_compra_w;

		end;
	end if;

	CALL Gerar_Ordem_Compra_Venc(nr_ordem_compra_w, nm_usuario_p);
	
	if (coalesce(ie_aprova_aut_oc_w,'N') = 'S') then
		update	ordem_compra_item
		set	dt_aprovacao		= clock_timestamp(),
			dt_aprovacao_orig 	= clock_timestamp(),
			nm_usuario_lib 		= nm_usuario_p
		where 	nr_ordem_compra 	= nr_ordem_compra_w;
		
		update	ordem_compra
		set	dt_liberacao 		= clock_timestamp(),
			dt_aprovacao 		= clock_timestamp(),
			nm_usuario_aprov 	= nm_usuario_p,
			nm_usuario_lib 		= nm_usuario_p
		where 	nr_ordem_compra 	= nr_ordem_compra_w;
	end if;
	
	end;
end loop;
close C02;

ds_lista_oc_p := ds_lista_oc_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_itens_sc_contrato ( cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, cd_setor_atendimento_p bigint, cd_moeda_p bigint, ie_frete_p text, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nr_seq_tipo_compra_p bigint, nr_seq_mod_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_entrega_solic_p text, ds_lista_oc_p INOUT text) FROM PUBLIC;

