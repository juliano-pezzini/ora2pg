-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_gerar_desconto_pedido ( nm_usuario_p text, nr_seq_vendedor_p bigint, nr_seq_pedido_p bigint, vl_mercadoria_p bigint, vl_desconto_pedido_p bigint ) AS $body$
DECLARE


pr_desconto_pedido_w	double precision;
vl_desconto_max_pedido_w	double precision;
pr_desconto_max_pedido_w	double precision;
vl_desconto_max_item_w	double precision;
pr_desconto_max_item_w	double precision;
existe_regra_pedido_w	integer;
existe_regra_item_w	integer;
cd_material_w		integer;
vl_desconto_w		double precision;
vl_rateado_w		double precision;
vl_unitario_item_w		double precision;
vl_particao_rateiro_w	double precision;
pr_participacao_rateiro_w	double precision;
qt_material_w		bigint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
nr_seq_item_w		bigint;

C01 CURSOR FOR
	SELECT	cd_material,
		vl_desconto,
		vl_unitario_item,
		nr_seq_item
	from	far_pedido_item
	where	nr_seq_pedido = nr_seq_pedido_p;


BEGIN

pr_desconto_pedido_w:= ((100/vl_mercadoria_p)*vl_desconto_pedido_p);

select	count(*)
into STRICT	existe_regra_pedido_w
from	far_regra_limite_desc
where	ie_tipo_desconto = 'P'
and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p;

if (existe_regra_pedido_w > 0) then

	select	coalesce(max(vl_desconto_max),0),
			coalesce(max(pr_desconto_max),0)
	into STRICT	vl_desconto_max_pedido_w,
			pr_desconto_max_pedido_w
	from	far_regra_limite_desc
	where	ie_tipo_desconto = 'P'
	and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p;

	-- Consiste por favlor Fixo do pedido
	if ((coalesce(vl_desconto_max_pedido_w,0) < (vl_desconto_pedido_p)) and (coalesce(vl_desconto_max_pedido_w,0) <> 0)) then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280216);
	end if;

	-- Consiste pelo percentual do pedido
	if (coalesce(pr_desconto_max_pedido_w,0) < pr_desconto_pedido_w) and (coalesce(pr_desconto_max_pedido_w,0) <> 0) then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280217);
	end if;

end if;

select	sum(qt_material)
into STRICT	qt_material_w
from	far_pedido_item
where	nr_seq_pedido = nr_seq_pedido_p;

vl_particao_rateiro_w:= (vl_desconto_pedido_p/qt_material_w);

open C01;
loop
fetch C01 into
	cd_material_w,
	vl_desconto_w,
	vl_unitario_item_w,
	nr_seq_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	count(*)
	into STRICT	existe_regra_item_w
	from	far_regra_limite_desc
	where	ie_tipo_desconto = 'I'
	and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p
	and	coalesce(cd_material,coalesce(cd_material_w,0)) = coalesce(cd_material_w,0)
	and	coalesce(cd_grupo_material,coalesce(cd_grupo_material_w,0)) = coalesce(cd_grupo_material_w,0)
	and	coalesce(cd_subgrupo_material,coalesce(cd_subgrupo_material_w,0)) = coalesce(cd_subgrupo_material_w,0)
	and	coalesce(cd_classe_material,coalesce(cd_classe_material_w,0)) = coalesce(cd_classe_material_w,0);

	if (existe_regra_item_w > 0) then

		select	coalesce(max(vl_desconto_max),0),
				coalesce(max(pr_desconto_max),0)
		into STRICT	vl_desconto_max_item_w,
				pr_desconto_max_item_w
		from	far_regra_limite_desc
		where	ie_tipo_desconto = 'I'
		and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p
		and	coalesce(cd_material,coalesce(cd_material_w,0)) = coalesce(cd_material_w,0)
		and	coalesce(cd_grupo_material,coalesce(cd_grupo_material_w,0)) = coalesce(cd_grupo_material_w,0)
		and	coalesce(cd_subgrupo_material,coalesce(cd_subgrupo_material_w,0)) = coalesce(cd_subgrupo_material_w,0)
		and	coalesce(cd_classe_material,coalesce(cd_classe_material_w,0)) = coalesce(cd_classe_material_w,0);

		pr_participacao_rateiro_w:= ((100/vl_unitario_item_w)*((vl_desconto_w/qt_material_w)+(vl_particao_rateiro_w)));

		-- Consiste por favlor Fixo do item
		if ((coalesce(vl_desconto_max_item_w,0) < vl_desconto_w+vl_particao_rateiro_w) and (coalesce(vl_desconto_max_item_w,0) <> 0)) then
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280219);
		end if;

		-- Consiste pelo percentual do item
		if (coalesce(pr_desconto_max_item_w,0) < pr_participacao_rateiro_w) and (coalesce(pr_desconto_max_item_w,0) <> 0) then
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280220);
		end if;

		update	far_pedido_item
		set	nm_usuario	= nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			vl_rateado = (vl_particao_rateiro_w*qt_material_w),
			vl_liquido_item = (coalesce(vl_total_item,0) - (coalesce(vl_desconto,0) + (coalesce(vl_particao_rateiro_w,0)*qt_material_w)))
		where 	nr_seq_item = nr_seq_item_w
		and	nr_seq_pedido = nr_seq_pedido_p;

		update	far_pedido
		set	vl_desconto = vl_desconto_pedido_p
		where	nr_sequencia = nr_Seq_pedido_p;

	end if;

	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_gerar_desconto_pedido ( nm_usuario_p text, nr_seq_vendedor_p bigint, nr_seq_pedido_p bigint, vl_mercadoria_p bigint, vl_desconto_pedido_p bigint ) FROM PUBLIC;

