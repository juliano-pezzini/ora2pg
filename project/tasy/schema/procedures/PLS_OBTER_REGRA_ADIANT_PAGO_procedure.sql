-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_adiant_pago ( nr_adiantamento_p bigint, dt_competencia_p timestamp, nr_seq_tipo_adiant_p bigint, ie_inclui_evento_p INOUT text, nr_seq_evento_p INOUT bigint, nr_seq_prestador_p INOUT bigint, cd_centro_custo_p INOUT centro_custo.cd_centro_custo%type, ie_desconto_cobranca_nf_p INOUT pls_evento_regra_adiant.ie_desconto_cobranca_nf%type, nr_seq_regra_p INOUT pls_evento_regra_adiant.nr_sequencia%type) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);

C01 CURSOR FOR
	SELECT	a.ie_inclui_evento,
		a.nr_seq_evento,
		a.nr_seq_prestador_dest,
		a.cd_centro_custo,
		a.ie_desconto_cobranca_nf,
		a.nr_sequencia
	from	pls_evento_regra_adiant a,
		pls_evento		b
	where	b.nr_sequencia		= a.nr_seq_evento
	and	b.ie_natureza		= 'D'
	and	(((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (a.ie_tipo_pessoa in ('A','J')) and ((coalesce(a.cd_cgc::text, '') = '') or (a.cd_cgc = cd_cgc_w))) or
		((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.ie_tipo_pessoa in ('A','F')) and ((coalesce(a.cd_pessoa_fisica::text, '') = '') or (a.cd_pessoa_fisica = cd_pessoa_fisica_w))))
	and	((nr_seq_tipo_adiant	= nr_seq_tipo_adiant_p) or (coalesce(nr_seq_tipo_adiant::text, '') = ''))
	and	dt_competencia_p between trunc(coalesce(a.dt_inicio_vigencia,dt_competencia_p),'dd') and fim_dia(coalesce(a.dt_fim_vigencia,dt_competencia_p))
	order by a.nr_sequencia, CASE WHEN coalesce(cd_pessoa_fisica_w::text, '') = '' THEN a.cd_pessoa_fisica  ELSE a.cd_cgc END;


BEGIN

select	max(a.cd_pessoa_fisica),
	max(a.cd_cgc)
into STRICT	cd_pessoa_fisica_w,
	cd_cgc_w
from	adiantamento_pago a
where 	a.nr_adiantamento = nr_adiantamento_p;

open C01;
loop
fetch C01 into
	ie_inclui_evento_p,
	nr_seq_evento_p,
	nr_seq_prestador_p,
	cd_centro_custo_p,
	ie_desconto_cobranca_nf_p,
	nr_seq_regra_p;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

ie_desconto_cobranca_nf_p := coalesce(ie_desconto_cobranca_nf_p,'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_adiant_pago ( nr_adiantamento_p bigint, dt_competencia_p timestamp, nr_seq_tipo_adiant_p bigint, ie_inclui_evento_p INOUT text, nr_seq_evento_p INOUT bigint, nr_seq_prestador_p INOUT bigint, cd_centro_custo_p INOUT centro_custo.cd_centro_custo%type, ie_desconto_cobranca_nf_p INOUT pls_evento_regra_adiant.ie_desconto_cobranca_nf%type, nr_seq_regra_p INOUT pls_evento_regra_adiant.nr_sequencia%type) FROM PUBLIC;

