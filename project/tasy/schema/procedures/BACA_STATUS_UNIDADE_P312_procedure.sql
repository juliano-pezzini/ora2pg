-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_status_unidade_p312 ( nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_interno_w		bigint;
ie_situacao_w			varchar(01);
ie_status_unidade_w		varchar(03);
ie_temporario_w			varchar(01);
nr_atendimento_w		bigint;
ie_status_unidade_p312_w	varchar(15);
ie_utiliza_portaria_w		varchar(1);
qt_registro_w			bigint;

c01 CURSOR FOR
	SELECT	a.nr_seq_interno,
		a.ie_situacao,
		a.ie_status_unidade,
		a.ie_temporario,
		a.nr_atendimento
	from	unidade_atendimento a
	where	1 = 1
	and	not exists (SELECT 1 from unidade_atend_status_p312 b where b.nr_seq_unid_atend = a.nr_seq_interno);


BEGIN

/*Baca com objetivo de inserir um status na portaria nº 312 para cada unidade atendimento existente */

select	count(*)
into STRICT	qt_registro_w
from	user_constraints
where	constraint_name = 'UNAT312_UK';

if (qt_registro_w > 0) then
	CALL Exec_sql_Dinamico('Jerusa', 'alter table unidade_atend_classif_p312 drop constraint UNAT312_UK');
end if;

/* Parâmetro[92] - Utiliza portaria nº 312 (Menu do sistema) */

select	coalesce(max(obter_valor_param_usuario(0, 92, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)), 'N')
into STRICT	ie_utiliza_portaria_w
;

if (ie_utiliza_portaria_w = 'S') then
	begin
	open	c01;
	loop
	fetch	c01 into
		nr_seq_interno_w,
		ie_situacao_w,
		ie_status_unidade_w,
		ie_temporario_w,
		nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_temporario_w = 'S') or (ie_situacao_w = 'I') or (ie_status_unidade_w in ('I', 'O', 'L', 'M', 'P')) or (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
			begin

			if (ie_status_unidade_w = 'L') and (ie_situacao_w <> 'I') and (ie_temporario_w <> 'S') then
				ie_status_unidade_p312_w	:= 'LV';
			elsif	((ie_status_unidade_w in ('I', 'O')) and (ie_situacao_w <> 'I') and (ie_temporario_w <> 'S')) then
				ie_status_unidade_p312_w	:= 'LB';
			elsif (ie_status_unidade_w in ('M', 'P')) or (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and (ie_situacao_w <> 'I') and (ie_temporario_w <> 'S') then
				ie_status_unidade_p312_w	:= 'LO';
			end if;

			if (ie_situacao_w = 'I') then
				ie_status_unidade_p312_w	:= 'LD';
			elsif (ie_situacao_w <> 'I') and (ie_temporario_w = 'S') then
				ie_status_unidade_p312_w	:= 'LE';
			end if;

			if (ie_status_unidade_p312_w IS NOT NULL AND ie_status_unidade_p312_w::text <> '') then
				insert into unidade_atend_status_p312(
					nr_sequencia,
					ie_status_unidade,
					dt_final,
					dt_inicio,
					dt_atualizacao,
					nm_usuario,
					nr_seq_unid_atend)
				values (
					nextval('unidade_atend_status_p312_seq'),
					ie_status_unidade_p312_w,
					null,
					clock_timestamp(),
					clock_timestamp(),
					'Tasy',
					nr_seq_interno_w);
			end if;
			end;
		end if;
		end;
	end loop;
	close c01;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_status_unidade_p312 ( nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

