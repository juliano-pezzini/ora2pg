-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_devolucao_palmweb ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_pessoa_devolucao_p bigint, nm_usuario_p text, nr_devolucao_p INOUT bigint, cd_setor_atend_devol_p INOUT bigint) AS $body$
DECLARE

 
nm_pessoa_fisica_w	varchar(60);
cd_setor_atendimento_w	integer;
dt_entrada_unidade_w	timestamp;
nr_devolucao_w		bigint;


BEGIN 
 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	 
	select	max(substr(obter_nome_pf(b.cd_pessoa_fisica),1,80)), 
		coalesce(max(b.cd_setor_atendimento), max(substr(obter_setor_atendimento(b.nr_atendimento),1,80))), 
		max(to_date(substr(obter_unidade_atendimento(b.nr_atendimento, 'A', 'DT'),1,30), 'dd/mm/yyyy hh24:mi:ss')) 
	into STRICT	nm_pessoa_fisica_w, 
		cd_setor_atendimento_w, 
		dt_entrada_unidade_w 
	from	prescr_medica b, 
		atendimento_paciente a 
	where	a.nr_atendimento = b.nr_atendimento 
	and	b.nr_prescricao = nr_prescricao_p;
 
elsif (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
 
	select	max(substr(obter_nome_pf(cd_pessoa_fisica),1,80)), 
		max(substr(obter_setor_atendimento(nr_atendimento),1,80)), 
		max(to_date(substr(obter_unidade_atendimento(nr_atendimento, 'A', 'DT'),1,30), 'dd/mm/yyyy hh24:mi:ss')) 
	into STRICT	nm_pessoa_fisica_w, 
		cd_setor_atendimento_w, 
		dt_entrada_unidade_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
end if;
 
if	((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') or (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '')) then 
 
	select	nextval('devolucao_material_pac_seq') 
	into STRICT	nr_devolucao_w 
	;
	 
	insert into devolucao_material_pac( 
		nr_devolucao, 
		nr_atendimento, 
		cd_pessoa_fisica_devol, 
		cd_setor_atendimento, 
		dt_atualizacao, 
		dt_devolucao, 
		dt_entrada_unidade, 
		dt_liberacao_baixa, 
		nm_usuario, 
		nm_usuario_devol) 
	values (	nr_devolucao_w, 
		nr_atendimento_p, 
		cd_pessoa_devolucao_p, 
		cd_setor_atendimento_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		dt_entrada_unidade_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p);
		 
	nr_devolucao_p := nr_devolucao_w;
	cd_setor_atend_devol_p := cd_setor_atendimento_w;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_devolucao_palmweb ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_pessoa_devolucao_p bigint, nm_usuario_p text, nr_devolucao_p INOUT bigint, cd_setor_atend_devol_p INOUT bigint) FROM PUBLIC;

