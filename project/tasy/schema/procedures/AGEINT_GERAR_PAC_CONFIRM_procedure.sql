-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_gerar_pac_confirm ( dt_agenda_p timestamp, nm_usuario_p text, ie_futuros_p text, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text default null, nm_pessoa_fisica_p text default null) AS $body$
DECLARE


TYPE t_ageint_confirm_agendamento IS TABLE OF ageint_confirm_agendamento%ROWTYPE INDEX BY integer;

ie_somente_integrada_w		varchar(1);
ie_apresentar_cancelados_w	varchar(1);
ie_em_agenda_w			varchar(1);
nm_usuario_em_agenda_w		varchar(15);
dt_agenda_ini_w			timestamp;
dt_agenda_fim_w			timestamp;
cd_pessoa_fisica_anterior_w	pessoa_fisica.cd_pessoa_fisica%type;
ie_pac_internado_w		varchar(1);
nr_seq_agenda_int_w		agenda_integrada.nr_sequencia%type;
nr_seq_status_w			agenda_integrada.nr_seq_status%type;
nr_sequencia_confirm_w		bigint;
nr_seq_ageint_con_age_w ageint_confirm_agendamento.nr_sequencia%type;

ageint_confirm_agendamento_w	t_ageint_confirm_agendamento;

ie_obs_informada_conf_w	varchar(5);
ie_obs_inf_conf_legenda_w	varchar(1);
exp_nao_w			varchar(5);
exp_sim_w			varchar(5);

C01 CURSOR FOR
	SELECT  a.cd_pessoa_fisica,
		a.nm_paciente,
		c.hr_inicio dt_agenda,
		c.nr_seq_proc_interno,
		null cd_especialidade, 
		null cd_medico, 
		substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia nr_seq_agenda,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN  exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.hr_inicio - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000) DS_OBSERVACAO,
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico_exec,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.hr_inicio,c.cd_convenio,c.cd_medico_exec) ie_bloqueado,
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int NR_SEQ_AGEINT_INT,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_paciente c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_exame   = c.nr_sequencia and c.dt_agenda             = dt_agenda_p and b.ie_tipo_agendamento in ('E','S') and d.cd_dominio            = 83  and ie_futuros_p	= 'N' and not exists (SELECT 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  a.cd_pessoa_fisica, 
		a.nm_paciente,
		c.hr_inicio dt_agenda,
		c.nr_seq_proc_interno,
		null, 
		null, 
		substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.hr_inicio - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico_exec,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.hr_inicio,c.cd_convenio,c.cd_medico_exec),
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_paciente c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_exame   = c.nr_sequencia and c.dt_agenda             >= dt_agenda_p and b.ie_tipo_agendamento in ('E','S') and d.cd_dominio            = 83  and ie_futuros_p	= 'S' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  a.cd_pessoa_fisica, 
		a.nm_paciente,
		c.dt_agenda dt_agenda,
		c.nr_seq_proc_interno,
		null, 
		null, 
		substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico),
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_cons   = c.nr_sequencia and c.dt_agenda             >= dt_agenda_p and b.ie_tipo_agendamento = 'S' and d.cd_dominio            = 83  and ie_futuros_p	= 'S' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  a.cd_pessoa_fisica, 
		a.nm_paciente,
		c.dt_agenda dt_agenda,
		c.nr_seq_proc_interno,
		null, 
		null, 
		substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico),
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_cons   = c.nr_sequencia and c.dt_agenda             between dt_agenda_p and dt_agenda_fim_w and b.ie_tipo_agendamento = 'S' and d.cd_dominio            = 83  and ie_futuros_p	= 'N' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p))) order by 2;

C02 CURSOR FOR
	SELECT  a.cd_pessoa_fisica,
		a.nm_paciente,
		c.dt_agenda dt_agenda,
		NULL nr_Seq_proc_interno,
		b.cd_especialidade,
		b.cd_medico, 
		substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia nr_seq_agenda,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN  exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'C' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000) DS_OBSERVACAO,
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico_req CD_MEDICO_EXEC,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico_req) IE_BLOQUEADO,
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int NR_SEQ_AGEINT_INT,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_cons    = c.nr_sequencia and c.dt_agenda between dt_agenda_ini_w and dt_agenda_fim_w and b.ie_tipo_agendamento   = 'C' and d.cd_dominio            = 83  and ie_futuros_p	= 'N' and not exists (SELECT 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  a.cd_pessoa_fisica, 
		a.nm_paciente,
		c.dt_agenda dt_agenda,
		NULL,
		b.cd_especialidade,
		b.cd_medico, substr(Obter_Item_Grid_Ageint(b.nr_seq_proc_interno, b.cd_medico, b.cd_Especialidade, cd_estabelecimento_p, b.nr_seq_item_selec),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		b.ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN b.ie_anestesia='S' THEN  exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(b.nr_seq_proc_interno, b.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'C' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		a.nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		a.cd_profissional,
		c.cd_medico_req,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico_req),
		a.dt_inicio_agendamento,
		b.nr_seq_grupo_selec,
		b.nr_seq_agenda_int,
		obter_estab_agenda(c.cd_agenda) cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda_integrada_item b, agenda_integrada a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.nr_sequencia  = b.nr_seq_agenda_int and (a.nm_paciente IS NOT NULL AND a.nm_paciente::text <> '') and b.nr_seq_agenda_cons    = c.nr_sequencia and c.dt_agenda >= dt_agenda_ini_w and b.ie_tipo_agendamento   = 'C' and d.cd_dominio            = 83  and ie_futuros_p	= 'S' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(a.nm_paciente) = upper(nm_pessoa_fisica_p))) order by 2;
	
C03 CURSOR FOR
	SELECT  c.cd_pessoa_fisica,
		substr(c.nm_paciente,1,60) nm_paciente,
		c.hr_inicio dt_agenda,
		c.nr_seq_proc_interno,
		null cd_especialidade, 
		null cd_medico, 
		substr(Obter_Item_Grid_Ageint(c.nr_seq_proc_interno, null, null, cd_estabelecimento_p, null),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia nr_seq_agenda,
		'E' ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN c.ie_anestesia='S' THEN  exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.hr_inicio - coalesce(substr(Ageint_Obter_Tempo_Chegada(c.nr_seq_proc_interno, c.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		null nr_seq_status,
		substr(c.ds_observacao,1,4000) DS_OBSERVACAO,
		c.cd_categoria,
		c.cd_plano,
		null cd_profissional,
		c.cd_medico_exec,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.hr_inicio,c.cd_convenio,c.cd_medico_exec) IE_BLOQUEADO,
		c.dt_agendamento DT_INICIO_AGENDAMENTO,
		null NR_SEQ_GRUPO_SELEC,
		0 NR_SEQ_AGEINT_INT,
		a.cd_estabelecimento cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda a, agenda_paciente c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.cd_agenda = c.cd_agenda and (c.nm_paciente IS NOT NULL AND c.nm_paciente::text <> '') and c.dt_agenda             = dt_agenda_p and a.cd_tipo_agenda  	= 2 and d.cd_dominio            = 83  and c.ie_status_agenda 	<> 'L' and ie_futuros_p	= 'N' and not exists (SELECT 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (c.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(c.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  c.cd_pessoa_fisica, 
		substr(c.nm_paciente,1,60) nm_paciente,
		c.hr_inicio dt_agenda,
		c.nr_seq_proc_interno,
		null, 
		null, 
		substr(Obter_Item_Grid_Ageint(c.nr_seq_proc_interno, null, null, cd_estabelecimento_p, null),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		'E' ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		CASE WHEN c.ie_anestesia='S' THEN  exp_sim_w  ELSE exp_nao_w END  ds_anestesia,
		c.hr_inicio - coalesce(substr(Ageint_Obter_Tempo_Chegada(c.nr_seq_proc_interno, c.ie_anestesia),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'E' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		null nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		null cd_profissional,
		c.cd_medico_exec,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.hr_inicio,c.cd_convenio,c.cd_medico_exec),
		c.dt_agendamento,
		null,
		0,
		a.cd_estabelecimento cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda a, agenda_paciente c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.cd_agenda = c.cd_agenda and (c.nm_paciente IS NOT NULL AND c.nm_paciente::text <> '') and c.dt_agenda             >= dt_agenda_p and a.cd_tipo_agenda	= 2 and d.cd_dominio            = 83  and c.ie_status_agenda 	<> 'L' and ie_futuros_p	= 'S' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (c.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(c.nm_paciente) = upper(nm_pessoa_fisica_p))) order by 2;
	
	
C04 CURSOR FOR
	SELECT  c.cd_pessoa_fisica,
		substr(c.nm_paciente,1,60) nm_paciente,
		c.dt_agenda dt_agenda,
		NULL nr_Seq_proc_interno,
		a.cd_especialidade,
		c.cd_medico_req CD_MEDICO, 
		substr(Obter_Item_Grid_Ageint(null, c.cd_medico_req, a.cd_Especialidade, cd_estabelecimento_p, null),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia nr_seq_agenda,
		CASE WHEN a.cd_tipo_agenda=5 THEN 'S'  ELSE 'C' END  ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		exp_nao_w ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(null, null),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'C' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		null nr_seq_status,
		substr(c.ds_observacao,1,4000) DS_OBSERVACAO,
		c.cd_categoria,
		c.cd_plano,
		null cd_profissional,
		c.cd_medico_req CD_MEDICO_EXEC,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico_req) IE_BLOQUEADO,
		c.dt_agendamento DT_INICIO_AGENDAMENTO,
		null NR_SEQ_GRUPO_SELEC,
		0 NR_SEQ_AGEINT_INT,
		a.cd_estabelecimento cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.cd_agenda = c.cd_agenda and (c.nm_paciente IS NOT NULL AND c.nm_paciente::text <> '') and c.dt_agenda between dt_agenda_ini_w and dt_agenda_fim_w and a.cd_tipo_agenda in (3,4,5) and d.cd_dominio            = 83  and c.ie_status_agenda 	<> 'L' and ie_futuros_p	= 'N' and not exists (SELECT 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (c.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(c.nm_paciente) = upper(nm_pessoa_fisica_p)))
	 
union

	SELECT  c.cd_pessoa_fisica, 
		substr(c.nm_paciente,1,60) nm_paciente,
		c.dt_agenda dt_agenda,
		NULL,
		a.cd_especialidade,
		c.cd_medico_req, 
		substr(Obter_Item_Grid_Ageint(null, c.cd_medico_req, a.cd_Especialidade, cd_estabelecimento_p, null),1,255) ds_agendamento,
		c.ie_status_agenda,
		substr(d.ds_valor_dominio,1,20) ds_status_agenda,
		c.nr_sequencia,
		CASE WHEN a.cd_tipo_agenda=5 THEN 'S'  ELSE 'C' END  ie_tipo_agendamento,
		c.cd_agenda,
		c.dt_confirmacao,
		exp_nao_w ds_anestesia,
		c.dt_agenda - coalesce(substr(Ageint_Obter_Tempo_Chegada(null, null),1,100),0)/1440 dt_chegada,
		substr(obter_valor_dominio(1227,c.ie_autorizacao),1,240) ds_autorizacao,
		c.cd_procedimento,
		c.ie_origem_proced,
		c.cd_convenio,
		coalesce(c.ie_confirmacao_aut,'N') ie_confirmacao_aut,
		'C' ie_tipo,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN  exp_nao_w  ELSE exp_sim_w END  ie_obs_informada,
		null nr_seq_status,
		substr(c.ds_observacao,1,4000),
		c.cd_categoria,
		c.cd_plano,
		null cd_profissional,
		c.cd_medico_req,
		Ageint_obter_se_hor_bloq(c.cd_agenda,c.dt_agenda,c.cd_convenio,c.cd_medico_req),
		c.dt_agendamento,
		null,
		0,
		a.cd_estabelecimento cd_estab_agenda,
		C.NM_USUARIO_CONFIRM NM_USUARIO_CONFIRM,
		C.NR_SEQ_FORMA_CONFIRMACAO NR_SEQ_FORMA_CONFIRMACAO,
		CASE WHEN coalesce(c.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END  ie_obs_inf_legenda
	FROM agenda a, agenda_consulta c
LEFT OUTER JOIN valor_dominio d ON (c.ie_status_agenda = d.vl_dominio)
WHERE a.cd_agenda = c.cd_agenda and (c.nm_paciente IS NOT NULL AND c.nm_paciente::text <> '') and c.dt_agenda >= dt_agenda_ini_w and a.cd_tipo_agenda in (3,4,5) and d.cd_dominio            = 83  and c.ie_status_agenda 	<> 'L' and ie_futuros_p	= 'S' and not exists (select 1 from ageint_confirm_agendamento x where c.nr_sequencia = x.nr_seq_agenda and x.nm_usuario = nm_usuario_p) and ((coalesce(cd_pessoa_fisica_p::text, '') = '' and coalesce(nm_pessoa_fisica_p::text, '') = '') 
	or (c.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(cd_pessoa_fisica_p::text, '') = '' and upper(c.nm_paciente) = upper(nm_pessoa_fisica_p))) order by 2;


BEGIN
dt_agenda_ini_w := pkg_date_utils.start_of(dt_agenda_p, 'DD', 0);
dt_agenda_fim_w := pkg_date_utils.end_of(dt_agenda_p, 'DAY', 0);
ie_somente_integrada_w := Obter_Param_Usuario(869, 184, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_somente_integrada_w);
ie_apresentar_cancelados_w := Obter_Param_Usuario(869, 185, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_apresentar_cancelados_w);

exp_nao_w := obter_desc_expressao(327114);
exp_sim_w := obter_desc_expressao(327113);

delete	FROM ageint_confirm_agendamento
where	nm_usuario = nm_usuario_p
and	coalesce(ie_em_agenda,'N')	= 'N';
commit;

if (ie_somente_integrada_w = 'S') then

	for 	r_c01 in c01 loop
		begin
			select CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN exp_nao_w  ELSE exp_sim_w END ,
				CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END
			into STRICT ie_obs_informada_conf_w,
				ie_obs_inf_conf_legenda_w
			from ageint_obs_agenda_confirm e
			where r_c01.nr_seq_agenda = e.nr_seq_agenda;
		exception
			when no_data_found or too_many_rows then
				ie_obs_informada_conf_w := exp_nao_w;
				ie_obs_inf_conf_legenda_w := 'N';
		end;

		if (coalesce(cd_pessoa_fisica_anterior_w::text, '') = '') or (cd_pessoa_fisica_anterior_w <> r_c01.cd_pessoa_fisica) then
			select	max(ie_em_agenda),
				max(nm_usuario_em_agenda)
			into STRICT	ie_em_agenda_w,
				nm_usuario_em_agenda_w
			from	ageint_confirm_agendamento
			where	cd_pessoa_fisica = r_c01.cd_pessoa_fisica;
			
			ie_pac_internado_w := substr(Obter_se_pessoa_internada(r_c01.cd_pessoa_fisica),1,1);
			cd_pessoa_fisica_anterior_w := r_c01.cd_pessoa_fisica;
		end if;
		
		if	((ie_apresentar_cancelados_w = 'S' AND r_c01.ie_status_agenda = 'C') or (r_c01.ie_status_agenda <> 'C')) then

			nr_sequencia_confirm_w := ageint_confirm_agendamento_w.count() + 1;

      select nextval('ageint_confirm_agendamento_seq') into STRICT nr_seq_ageint_con_age_w;

			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_pessoa_fisica := r_c01.cd_pessoa_fisica;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_paciente := r_c01.nm_paciente;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_agenda := r_c01.dt_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_Seq_proc_interno := r_c01.nr_Seq_proc_interno;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_especialidade := r_c01.cd_especialidade;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico := r_c01.cd_medico;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_Agendamento := r_c01.ds_Agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_status_agenda := r_c01.ie_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_status_agenda := r_c01.ds_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_agenda := r_c01.nr_seq_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo_agendamento := r_c01.ie_tipo_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_agenda := r_c01.cd_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_confirmacao := r_c01.dt_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_anestesia := r_c01.ds_anestesia;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_chegada := r_c01.dt_chegada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_autorizacao := r_c01.ds_autorizacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_procedimento := r_c01.cd_procedimento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_origem_proced := r_c01.ie_origem_proced;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_convenio := r_c01.cd_convenio;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_confirmacao_aut := r_c01.ie_confirmacao_aut;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo := r_c01.ie_tipo;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada := r_c01.ie_obs_informada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_Atualizacao := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_nrec := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_atualizacao_nrec := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_sequencia := nr_seq_ageint_con_age_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_status := r_c01.nr_seq_status;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_observacao := r_c01.ds_observacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_categoria := r_c01.cd_categoria;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_plano := r_c01.cd_plano;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_profissional := r_c01.cd_profissional;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico_exec := r_c01.cd_medico_exec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_bloqueado := r_c01.ie_bloqueado;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_inicio_agendamento := r_c01.dt_inicio_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_em_agenda := ie_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_em_agenda := nm_usuario_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_pac_internado := ie_pac_internado_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_grupo_selec := r_c01.nr_seq_grupo_selec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_ageint := r_c01.nr_seq_ageint_int;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada_conf := ie_obs_informada_conf_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_estab_agenda := r_c01.cd_estab_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_confirm := r_c01.nm_usuario_confirm;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_forma_confirmacao := r_c01.nr_seq_forma_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_conf_legenda := ie_obs_inf_conf_legenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_legenda := r_c01.ie_obs_inf_legenda;

		end if;
	end loop;

	for	r_c02 in c02 loop
		begin
			select CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN exp_nao_w  ELSE exp_sim_w END ,
				CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END
			into STRICT ie_obs_informada_conf_w,
				ie_obs_inf_conf_legenda_w
			from ageint_obs_agenda_confirm e
			where r_c02.nr_seq_agenda = e.nr_seq_agenda;
		exception
			when no_data_found or too_many_rows then
				ie_obs_informada_conf_w := exp_nao_w;
				ie_obs_inf_conf_legenda_w := 'N';
		end;
		
		if (coalesce(cd_pessoa_fisica_anterior_w::text, '') = '') or (cd_pessoa_fisica_anterior_w <> r_c02.cd_pessoa_fisica) then
			select	max(ie_em_agenda),
				max(nm_usuario_em_agenda)
			into STRICT	ie_em_agenda_w,
				nm_usuario_em_agenda_w
			from	ageint_confirm_agendamento
			where	cd_pessoa_fisica = r_c02.cd_pessoa_fisica;
			
			ie_pac_internado_w := substr(Obter_se_pessoa_internada(r_c02.cd_pessoa_fisica),1,1);
			cd_pessoa_fisica_anterior_w := r_c02.cd_pessoa_fisica;
		end if;
		
		if	((ie_apresentar_cancelados_w = 'S' AND r_c02.ie_status_agenda = 'C') or (r_c02.ie_status_agenda <> 'C')) then

			nr_sequencia_confirm_w := ageint_confirm_agendamento_w.count() + 1;
      select nextval('ageint_confirm_agendamento_seq') into STRICT nr_seq_ageint_con_age_w;

			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_pessoa_fisica := r_c02.cd_pessoa_fisica;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_paciente := r_c02.nm_paciente;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_agenda := r_c02.dt_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_Seq_proc_interno := r_c02.nr_Seq_proc_interno;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_especialidade := r_c02.cd_especialidade;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico := r_c02.cd_medico;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_Agendamento := r_c02.ds_Agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_status_agenda := r_c02.ie_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_status_agenda := r_c02.ds_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_agenda := r_c02.nr_seq_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo_agendamento := r_c02.ie_tipo_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_agenda := r_c02.cd_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_confirmacao := r_c02.dt_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_anestesia := r_c02.ds_anestesia;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_chegada := r_c02.dt_chegada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_autorizacao := r_c02.ds_autorizacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_procedimento := r_c02.cd_procedimento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_origem_proced := r_c02.ie_origem_proced;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_convenio := r_c02.cd_convenio;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_confirmacao_aut := r_c02.ie_confirmacao_aut;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo := r_c02.ie_tipo;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada := r_c02.ie_obs_informada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_Atualizacao := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_nrec := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_atualizacao_nrec := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_sequencia := nr_seq_ageint_con_age_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_status := r_c02.nr_seq_status;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_observacao := r_c02.ds_observacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_categoria := r_c02.cd_categoria;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_plano := r_c02.cd_plano;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_profissional := r_c02.cd_profissional;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico_exec := r_c02.cd_medico_exec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_bloqueado := r_c02.ie_bloqueado;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_inicio_agendamento := r_c02.dt_inicio_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_em_agenda := ie_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_em_agenda := nm_usuario_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_pac_internado := ie_pac_internado_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_grupo_selec := r_c02.nr_seq_grupo_selec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_ageint := r_c02.nr_seq_ageint_int;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada_conf := ie_obs_informada_conf_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_estab_agenda := r_c02.cd_estab_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_confirm := r_c02.nm_usuario_confirm;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_forma_confirmacao := r_c02.nr_seq_forma_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_conf_legenda := ie_obs_inf_conf_legenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_legenda := r_c02.ie_obs_inf_legenda;

		end if;
	end loop;
else
	for	r_c03 in c03 loop
		begin
			select CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN exp_nao_w  ELSE exp_sim_w END ,
				CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END
			into STRICT ie_obs_informada_conf_w,
				ie_obs_inf_conf_legenda_w
			from ageint_obs_agenda_confirm e
			where r_c03.nr_seq_agenda = e.nr_seq_agenda;
		exception
			when no_data_found or too_many_rows then
				ie_obs_informada_conf_w := exp_nao_w;
				ie_obs_inf_conf_legenda_w := 'N';
		end;
		
		if (coalesce(cd_pessoa_fisica_anterior_w::text, '') = '') or (cd_pessoa_fisica_anterior_w <> r_c03.cd_pessoa_fisica) then
			select	max(ie_em_agenda),
				max(nm_usuario_em_agenda)
			into STRICT	ie_em_agenda_w,
				nm_usuario_em_agenda_w
			from	ageint_confirm_agendamento
			where	cd_pessoa_fisica = r_c03.cd_pessoa_fisica;
			
			ie_pac_internado_w := substr(Obter_se_pessoa_internada(r_c03.cd_pessoa_fisica),1,1);
			cd_pessoa_fisica_anterior_w := r_c03.cd_pessoa_fisica;
		end if;
		
		select max(ai.nr_sequencia),
			   max(ai.nr_seq_status)
		  into STRICT nr_seq_agenda_int_w,
			   nr_seq_status_w
		  from agenda_integrada ai, agenda_integrada_item aii
		 where ai.nr_sequencia = aii.nr_seq_agenda_int 
		   and aii.nr_seq_agenda_exame = r_c03.nr_seq_agenda;
		
		if	((ie_apresentar_cancelados_w = 'S' AND r_c03.ie_status_agenda = 'C') or (r_c03.ie_status_agenda <> 'C')) then

			nr_sequencia_confirm_w := ageint_confirm_agendamento_w.count() + 1;
      select nextval('ageint_confirm_agendamento_seq') into STRICT nr_seq_ageint_con_age_w;

			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_pessoa_fisica := r_c03.cd_pessoa_fisica;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_paciente := r_c03.nm_paciente;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_agenda := r_c03.dt_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_Seq_proc_interno := r_c03.nr_Seq_proc_interno;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_especialidade := r_c03.cd_especialidade;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico := r_c03.cd_medico;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_Agendamento := r_c03.ds_Agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_status_agenda := r_c03.ie_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_status_agenda := r_c03.ds_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_agenda := r_c03.nr_seq_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo_agendamento := r_c03.ie_tipo_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_agenda := r_c03.cd_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_confirmacao := r_c03.dt_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_anestesia := r_c03.ds_anestesia;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_chegada := r_c03.dt_chegada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_autorizacao := r_c03.ds_autorizacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_procedimento := r_c03.cd_procedimento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_origem_proced := r_c03.ie_origem_proced;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_convenio := r_c03.cd_convenio;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_confirmacao_aut := r_c03.ie_confirmacao_aut;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo := r_c03.ie_tipo;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada := r_c03.ie_obs_informada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_Atualizacao := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_nrec := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_atualizacao_nrec := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_sequencia := nr_seq_ageint_con_age_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_status := nr_seq_status_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_observacao := r_c03.ds_observacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_categoria := r_c03.cd_categoria;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_plano := r_c03.cd_plano;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_profissional := r_c03.cd_profissional;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico_exec := r_c03.cd_medico_exec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_bloqueado := r_c03.ie_bloqueado;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_inicio_agendamento := r_c03.dt_inicio_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_em_agenda := ie_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_em_agenda := nm_usuario_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_pac_internado := ie_pac_internado_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_grupo_selec := r_c03.nr_seq_grupo_selec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_ageint := coalesce(nr_seq_agenda_int_w,0);
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada_conf := ie_obs_informada_conf_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_estab_agenda := r_c03.cd_estab_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_confirm := r_c03.nm_usuario_confirm;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_forma_confirmacao := r_c03.nr_seq_forma_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_conf_legenda := ie_obs_inf_conf_legenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_legenda := r_c03.ie_obs_inf_legenda;

		end if;
	end loop;

	for	r_c04 in c04 loop
		begin
			select CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN exp_nao_w  ELSE exp_sim_w END ,
				CASE WHEN coalesce(e.ds_observacao::text, '') = '' THEN 'N'  ELSE 'S' END
			into STRICT ie_obs_informada_conf_w,
				ie_obs_inf_conf_legenda_w
			from ageint_obs_agenda_confirm e
			where r_c04.nr_seq_agenda = e.nr_seq_agenda;
		exception
			when no_data_found or too_many_rows then
				ie_obs_informada_conf_w := exp_nao_w;
				ie_obs_inf_conf_legenda_w := 'N';
		end;
		
		if (coalesce(cd_pessoa_fisica_anterior_w::text, '') = '') or (cd_pessoa_fisica_anterior_w <> r_c04.cd_pessoa_fisica) then
			select	max(ie_em_agenda),
				max(nm_usuario_em_agenda)
			into STRICT	ie_em_agenda_w,
				nm_usuario_em_agenda_w
			from	ageint_confirm_agendamento
			where	cd_pessoa_fisica = r_c04.cd_pessoa_fisica;
			
			ie_pac_internado_w := substr(Obter_se_pessoa_internada(r_c04.cd_pessoa_fisica),1,1);
			cd_pessoa_fisica_anterior_w := r_c04.cd_pessoa_fisica;
		end if;
		
		select max(ai.nr_sequencia),
			   max(ai.nr_seq_status)
		  into STRICT nr_seq_agenda_int_w,
			   nr_seq_status_w
		  from agenda_integrada ai, agenda_integrada_item aii
		 where ai.nr_sequencia = aii.nr_seq_agenda_int 
		   and aii.nr_seq_agenda_cons = r_c04.nr_seq_agenda;
		
		if	((ie_apresentar_cancelados_w = 'S' AND r_c04.ie_status_agenda = 'C') or (r_c04.ie_status_agenda <> 'C')) then

			nr_sequencia_confirm_w := ageint_confirm_agendamento_w.count() + 1;
      select nextval('ageint_confirm_agendamento_seq') into STRICT nr_seq_ageint_con_age_w;

			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_pessoa_fisica := r_c04.cd_pessoa_fisica;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_paciente := r_c04.nm_paciente;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_agenda := r_c04.dt_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_Seq_proc_interno := r_c04.nr_Seq_proc_interno;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_especialidade := r_c04.cd_especialidade;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico := r_c04.cd_medico;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_Agendamento := r_c04.ds_Agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_status_agenda := r_c04.ie_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_status_agenda := r_c04.ds_status_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_agenda := r_c04.nr_seq_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo_agendamento := r_c04.ie_tipo_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_agenda := r_c04.cd_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_confirmacao := r_c04.dt_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_anestesia := r_c04.ds_anestesia;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_chegada := r_c04.dt_chegada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_autorizacao := r_c04.ds_autorizacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_procedimento := r_c04.cd_procedimento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_origem_proced := r_c04.ie_origem_proced;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_convenio := r_c04.cd_convenio;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_confirmacao_aut := r_c04.ie_confirmacao_aut;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_tipo := r_c04.ie_tipo;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada := r_c04.ie_obs_informada;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_Atualizacao := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_nrec := nm_usuario_p;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_atualizacao_nrec := clock_timestamp();
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_sequencia := nr_seq_ageint_con_age_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_status := nr_seq_status_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ds_observacao := r_c04.ds_observacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_categoria := r_c04.cd_categoria;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_plano := r_c04.cd_plano;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_profissional := r_c04.cd_profissional;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_medico_exec := r_c04.cd_medico_exec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_bloqueado := r_c04.ie_bloqueado;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].dt_inicio_agendamento := r_c04.dt_inicio_agendamento;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_em_agenda := ie_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_em_agenda := nm_usuario_em_agenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_pac_internado := ie_pac_internado_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_grupo_selec := r_c04.nr_seq_grupo_selec;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_ageint := coalesce(nr_seq_agenda_int_w,0);
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_informada_conf := ie_obs_informada_conf_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].cd_estab_agenda := r_c04.cd_estab_agenda;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nm_usuario_confirm := r_c04.nm_usuario_confirm;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].nr_seq_forma_confirmacao := r_c04.nr_seq_forma_confirmacao;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_conf_legenda := ie_obs_inf_conf_legenda_w;
			ageint_confirm_agendamento_w[nr_sequencia_confirm_w].ie_obs_inf_legenda := r_c04.ie_obs_inf_legenda;

		end if;
	end loop;
end if;

FORALL i IN ageint_confirm_agendamento_w.first .. ageint_confirm_agendamento_w.last
	INSERT INTO ageint_confirm_agendamento VALUES ageint_confirm_agendamento_w(i);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_gerar_pac_confirm ( dt_agenda_p timestamp, nm_usuario_p text, ie_futuros_p text, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text default null, nm_pessoa_fisica_p text default null) FROM PUBLIC;

