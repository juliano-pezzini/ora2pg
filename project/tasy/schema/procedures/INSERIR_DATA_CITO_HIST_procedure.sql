-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_data_cito_hist ( nr_seq_interno_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_cid_principal_w		varchar(4);
cd_cid_topografia_w	varchar(10);
cd_diag_cito_hist_w	varchar(10);
dt_diag_cito_hist_w		timestamp;
dt_diag_cito_hist_ww		timestamp;
nr_sequencia_w		bigint;


BEGIN 
 
begin 
select 	max(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	can_loco_regional 
where	nr_atendimento = nr_atendimento_p;
exception 
when others then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(278116);
end;
 
select	max(dt_diag_cito_hist) 
into STRICT	dt_diag_cito_hist_ww 
from	sus_laudo_paciente 
where	nr_seq_interno 	= nr_seq_interno_p;
 
if (coalesce(nr_sequencia_w,0) <> 0) then 
	begin 
	select	cd_doenca_cid, 
		cd_topografia, 
		cd_morfologia, 
		dt_diag_histopatologico 
	into STRICT	cd_cid_principal_w, 
		cd_cid_topografia_w, 
		cd_diag_cito_hist_w, 
		dt_diag_cito_hist_w	 
	from	can_loco_regional 
	where	nr_sequencia = nr_sequencia_w;
 
	begin 
	update	sus_laudo_paciente 
	set	dt_diag_cito_hist 	= coalesce(dt_diag_cito_hist_w,dt_diag_cito_hist_ww) 
	where	nr_seq_interno 		= nr_seq_interno_p 
	and	cd_cid_principal 	= cd_cid_principal_w 
	and	cd_cid_topografia 	= cd_cid_topografia_w 
	and	cd_diag_cito_hist	= cd_diag_cito_hist_w;
	exception 
		when others then 
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(278117);
		end;
 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_data_cito_hist ( nr_seq_interno_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

