-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao_prot ( cd_estabelecimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_material_p bigint, ds_dias_aplicacao_p protocolo_medic_material.ds_dias_aplicacao%type) AS $body$
DECLARE



cd_material_w					integer;
cd_intervalo_w				varchar(7);
cd_intervalo_cad_w				varchar(7);
nr_agrupamento_w				double precision;
cd_unidade_medida_w				varchar(30);
nr_seq_acum_w					bigint;
nr_agrup_acum_w				double precision;
nr_sequencia_w				bigint;
qt_conversao_w				double precision;
nm_usuario_w					varchar(15);

cd_diluente_w					integer;
qt_diluicao_w					double precision;
cd_unid_med_diluente_w			varchar(30);
ie_reconstituicao_w				varchar(1);
ie_via_aplicacao_w				varchar(5);
ie_se_necessario_W				varchar(1);
qt_minuto_aplicacao_w			smallint;	
ie_bomba_infusao_w				varchar(1);
ie_aplic_bolus_w				varchar(1);
ie_aplic_lenta_w				varchar(1);
ie_acm_w					varchar(1);
ie_urgencia_w					varchar(1);

Controle_w			smallint := 0;


c01 CURSOR FOR
SELECT	coalesce(nr_seq_acum_w + row_number() OVER () AS rownum,0),
	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	qt_minuto_aplicacao,
	cd_intervalo	
from	material_diluicao
where	cd_material = cd_material_w
and	cd_estabelecimento = cd_estabelecimento_p
and	(nr_sequencia = (SELECT nr_sequencia
			from (
			select	b.nr_sequencia,
				CASE WHEN coalesce(b.nr_sequencia::text, '') = '' THEN 10  ELSE 1 END ,
				b.nr_seq_prioridade
			from	material_diluicao b
			where	b.cd_material = cd_material_w
			and	b.cd_estabelecimento = cd_estabelecimento_p	
			and	b.ie_reconstituicao = 'N'
			and (b.ie_via_aplicacao = ie_via_aplicacao_w)
			
union

			select	b.nr_sequencia,
				2,
				b.nr_seq_prioridade
			from	material_diluicao b
			where	b.cd_material = cd_material_w
			and	b.cd_estabelecimento = cd_estabelecimento_p
			and	b.ie_reconstituicao = 'N'
			and	coalesce(b.ie_via_aplicacao::text, '') = ''
			order by 2,3) alias9 LIMIT 1));

c02 CURSOR FOR
SELECT	coalesce(nr_seq_acum_w + row_number() OVER () AS rownum,0),
	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	cd_intervalo	
from	material_diluicao
where	cd_material = cd_material_w
and	(nr_sequencia = (SELECT nr_sequencia
			from (
			select	b.nr_sequencia,
				CASE WHEN coalesce(b.nr_sequencia::text, '') = '' THEN 10  ELSE 1 END ,
				b.nr_seq_prioridade
			from	material_diluicao b
			where	b.cd_material = cd_material_w
			and	b.cd_estabelecimento = cd_estabelecimento_p
			and	b.ie_reconstituicao = 'S'
			and (b.ie_via_aplicacao = ie_via_aplicacao_w)
			
union

			select	b.nr_sequencia,
				2,
				b.nr_seq_prioridade
			from	material_diluicao b
			where	b.cd_material = cd_material_w
			and	b.cd_estabelecimento = cd_estabelecimento_p
			and	b.ie_reconstituicao = 'S'
			and	coalesce(b.ie_via_aplicacao::text, '') = ''
			order by 2,3) alias9 LIMIT 1));



BEGIN

begin


if (cd_protocolo_p		> 0) and (nr_sequencia_p 	> 0) and (nr_seq_material_p	> 0) then
	begin
	select	coalesce(max(nr_seq_material),0),
		coalesce(max(nr_agrupamento),0)
	into STRICT	nr_seq_acum_w, 
		nr_agrup_acum_w
	from	protocolo_medic_material
	where	cd_protocolo	= cd_protocolo_p
	and	nr_sequencia	= nr_sequencia_p;

	Select	max(coalesce(cd_material,0)),
		max(coalesce(cd_intervalo,null)),
		max(coalesce(nr_agrupamento,0)),
		max(coalesce(cd_unidade_medida, obter_unid_med_usua('ml'))),
		max(coalesce(nm_usuario,'Tasy')),
		max(ie_via_aplicacao),
		max(coalesce(ie_se_necessario,'N')),
		max(coalesce(ie_bomba_infusao,'N')),
		max(coalesce(ie_aplic_bolus,'N')),
		max(coalesce(ie_aplic_lenta,'N')),
		max(coalesce(ie_acm,'N')),
		max(coalesce(ie_urgencia,'N'))
	into STRICT	cd_material_w,
		cd_intervalo_w,
		nr_agrupamento_w,
		cd_unidade_medida_w,
		nm_usuario_w,
		ie_via_aplicacao_w,
		ie_se_necessario_W,
		ie_bomba_infusao_w,
		ie_aplic_bolus_w,
		ie_aplic_lenta_w,
		ie_acm_w,
		ie_urgencia_w
	from	protocolo_medic_material
	where	cd_protocolo	= cd_protocolo_p
	and	nr_sequencia 	= nr_sequencia_p
	and	nr_seq_material	= nr_seq_material_p;
	
	/* Inserir o reconstituinte */

	open C02;
	loop
		fetch C02 into
			nr_sequencia_w,
			cd_diluente_w,
			qt_diluicao_w,
			cd_unid_med_diluente_w,
			ie_reconstituicao_w,
			ie_via_aplicacao_w,
			cd_intervalo_cad_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (coalesce(cd_diluente_w,0) > 0) then
			begin
			select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo
			into STRICT	cd_unidade_medida_w
			from	material
			where	cd_material	= cd_diluente_w;
		
			select	coalesce(max(qt_conversao),1)
			into STRICT	qt_conversao_w
			from	material_conversao_unidade
			where	cd_material		= cd_diluente_w
			and	cd_unidade_medida	= cd_unid_med_diluente_w;

			Select	count(*)
			into STRICT	Controle_w
			from	protocolo_medic_material
			where	cd_protocolo	= cd_protocolo_p
			and	nr_sequencia	= nr_sequencia_p
			and	ie_agrupador	= 9
			and	nr_seq_diluicao	= nr_seq_material_p;

			if (Controle_w = 0) then
				insert into protocolo_medic_material(
					cd_protocolo,
					nr_sequencia,
					nr_seq_material,
					cd_material,
					qt_dose,
					cd_unidade_medida,
					dt_atualizacao,
					nm_usuario,
					nr_agrupamento,
					ie_via_aplicacao,
					nr_seq_diluicao,
					ie_agrupador,
					cd_intervalo,
					ie_se_necessario,
					qt_minuto_aplicacao,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					ie_urgencia,
					ie_intervalo_fixo,
					ie_multiplicar_dose)
				values (	
					cd_protocolo_p,
					nr_sequencia_p,
					nr_sequencia_w,
					cd_diluente_w,
					qt_diluicao_w,
					cd_unid_med_diluente_w,
					clock_timestamp(),
					nm_usuario_w,
					nr_agrupamento_w,
					ie_via_aplicacao_w,
					nr_seq_material_p,
					9,
					coalesce(cd_intervalo_cad_w,cd_intervalo_w),
					ie_se_necessario_W,
					null,
					ie_bomba_infusao_w,
					ie_aplic_bolus_w,
					ie_aplic_lenta_w,
					ie_acm_w,
					ie_urgencia_w,
					'N',
					'N');
			end if;
			end;
		end if;
		end;
	end loop;
	close C02;

	/* Inserir o Diluente */

	select	coalesce(max(nr_seq_material),0),
		coalesce(max(nr_agrupamento),0)
	into STRICT	nr_seq_acum_w, 
		nr_agrup_acum_w
	from	protocolo_medic_material
	where	cd_protocolo	= cd_protocolo_p
	and	nr_sequencia	= nr_sequencia_p;
	
	Select	coalesce(cd_material,0),
		coalesce(cd_intervalo,null),
		coalesce(nr_agrupamento,0),
		coalesce(cd_unidade_medida, obter_unid_med_usua('ml')),
		coalesce(nm_usuario,'Tasy'),
		ie_via_aplicacao,
		coalesce(ie_se_necessario,'N'),
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_aplic_bolus,'N'),
		coalesce(ie_aplic_lenta,'N'),
		coalesce(ie_acm,'N'),
		coalesce(ie_urgencia,'N')
	into STRICT	cd_material_w,
		cd_intervalo_w,
		nr_agrupamento_w,
		cd_unidade_medida_w,
		nm_usuario_w,
		ie_via_aplicacao_w,
		ie_se_necessario_W,
		ie_bomba_infusao_w,
		ie_aplic_bolus_w,
		ie_aplic_lenta_w,
		ie_acm_w,
		ie_urgencia_w
	from	protocolo_medic_material
	where	cd_protocolo	= cd_protocolo_p
	and	nr_sequencia 	= nr_sequencia_p
	and	nr_seq_material	= nr_seq_material_p;
	
	open C01;
	loop
		fetch C01 into
			nr_sequencia_w,
			cd_diluente_w,
			qt_diluicao_w,
			cd_unid_med_diluente_w,
			ie_reconstituicao_w,
			ie_via_aplicacao_w,
			qt_minuto_aplicacao_w,
			cd_intervalo_cad_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo
		into STRICT	cd_unidade_medida_w
		from	material
		where	cd_material	= cd_diluente_w;

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_diluente_w
		and	cd_unidade_medida	= cd_unid_med_diluente_w;

		Select	count(*)
		into STRICT	Controle_w
		from	protocolo_medic_material
		where	cd_protocolo	= cd_protocolo_p
		and	nr_sequencia	= nr_sequencia_p
		and	ie_agrupador	= 3
		and	nr_seq_diluicao	= nr_seq_material_p;
		
		if (Controle_w = 0) then
			insert into protocolo_medic_material(
				cd_protocolo,
				nr_sequencia,
				nr_seq_material,
				cd_material,
				qt_dose,
				cd_unidade_medida,
				dt_atualizacao,
				nm_usuario,
				nr_agrupamento,
				ie_via_aplicacao,
				nr_seq_diluicao,
				ie_agrupador,
				cd_intervalo,
				ie_se_necessario,
				qt_minuto_aplicacao,
				ie_bomba_infusao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				ie_acm,
				ie_urgencia,
				ie_intervalo_fixo,
				ie_multiplicar_dose,
                ds_dias_aplicacao)
			values (	
				cd_protocolo_p,
				nr_sequencia_p,
				nr_sequencia_w,
				cd_diluente_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w,
				clock_timestamp(),
				nm_usuario_w,
				nr_agrupamento_w,
				ie_via_aplicacao_w,
				nr_seq_material_p,
				3,
				coalesce(cd_intervalo_cad_w,cd_intervalo_w),
				ie_se_necessario_W,
				qt_minuto_aplicacao_w,
				ie_bomba_infusao_w,
				ie_aplic_bolus_w,
				ie_aplic_lenta_w,
				ie_acm_w,
				ie_urgencia_w,
				'N',
				'N',
                ds_dias_aplicacao_p);		
		end if;
		end;	
	end loop;	
	close C01;
	end;
end if;

exception
	when others then
	null;
end;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao_prot ( cd_estabelecimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_material_p bigint, ds_dias_aplicacao_p protocolo_medic_material.ds_dias_aplicacao%type) FROM PUBLIC;

