-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_processo_producao ( nr_sequencia_p bigint, nr_seq_processo_p bigint, nr_seq_area_prep_p bigint, ie_opcao_p text, cd_material_p bigint default null, nm_usuario_p text DEFAULT NULL, qt_item_p bigint DEFAULT NULL) AS $body$
DECLARE
		
/* ie_opcao_p   D - Desvincular  V - Vincular */
 
cd_estabelecimento_w		bigint;
cd_material_w				bigint;
qt_material_w				bigint;
qt_real_w					bigint;
qt_unitaria_w				bigint;
cd_unidade_medida_w			varchar(100);
nr_lote_producao_w			bigint;
cd_local_estoque_w			bigint;
ie_baixa_estoque_w			varchar(1);
cd_setor_atendimento_w		bigint;
cd_material_x 				varchar(1000);


BEGIN 
 
cd_material_x := '';
 
cd_estabelecimento_w 	:=	wheb_usuario_pck.get_cd_estabelecimento;
 
ie_baixa_estoque_w := obter_param_usuario(3112, 66, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_baixa_estoque_w);
 
ie_baixa_estoque_w := 'S';
 
if (nr_sequencia_p > 0) then 
	if (ie_opcao_p = 'V') then 
		update	lp_individual 
		set	dt_vinc_ordem		=	clock_timestamp(), 
			nr_seq_processo		=	nr_seq_processo_p, 
			nr_seq_area_prep	=	nr_seq_area_prep_p 
		where	nr_sequencia		=	nr_sequencia_p;
 
		if (ie_baixa_estoque_w = 'S') then 
			 
			select max(NR_LOTE_PRODUCAO) 
			into STRICT	nr_lote_producao_w 
			from	lp_individual 
			where	nr_sequencia = nr_sequencia_p;
			 
			select	MAX(cd_material), 
					max(coalesce(qt_real,qt_prevista)), 
					max(cd_unidade_medida), 
					max(cd_local_estoque), 
					max(qt_real) 
			into STRICT	cd_material_w, 
					qt_material_w, 
					cd_unidade_medida_w, 
					cd_local_estoque_w, 
					qt_real_w 
			from	lote_producao 
			where	nr_lote_producao = nr_lote_producao_w;
			 
			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (cd_material_w > 0) and (coalesce(qt_real_w::text, '') = '') then 
				begin 
 
				select	max(qt_unitaria) 
				into STRICT	qt_unitaria_w 
				from	lote_producao_comp 
				where	cd_material 		= cd_material_w 
				and		nr_lote_producao 	= nr_lote_producao_w;
				 
				if (qt_unitaria_w > 0) then 
					qt_material_w := qt_unitaria_w;
				end if;
				 
				if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then 
					begin 
					 
					update	adep_processo_item 
					set		nr_lote_producao 	= nr_lote_producao_w 
					where	nr_seq_processo 	= nr_seq_processo_p 
					and		cd_material			= cd_material_p;
					 
					end;
				end if;
				 
				end;
			end if;
			 
			if (coalesce(qt_item_p,0) > 0) then 
				qt_material_w	:= qt_item_p;
			end if;
 
			select 	max(cd_setor_atendimento) 
			into STRICT	cd_setor_atendimento_w 
			from	adep_processo 
			where	nr_sequencia 		= 	nr_seq_processo_p;
 
			CALL Gerar_Prescricao_Estoque(cd_estabelecimento_w,null,null, cd_material_w,clock_timestamp(),'1',cd_local_estoque_w, 
							qt_material_w,cd_setor_atendimento_w,cd_unidade_medida_w,nm_usuario_p,'I',null,null,null,null,null,null, 
							null, null, null, null, 'X', null, nr_lote_producao_w);
	 
			 
		end if;
 
elsif (ie_opcao_p = 'D') then 
		update	lp_individual 
		set	dt_vinc_ordem		 = NULL, 
			nr_seq_processo		 = NULL, 
			nr_seq_area_prep	 = NULL 
		where	nr_sequencia		=	nr_sequencia_p;
end if;	
	commit;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_processo_producao ( nr_sequencia_p bigint, nr_seq_processo_p bigint, nr_seq_area_prep_p bigint, ie_opcao_p text, cd_material_p bigint default null, nm_usuario_p text DEFAULT NULL, qt_item_p bigint DEFAULT NULL) FROM PUBLIC;

