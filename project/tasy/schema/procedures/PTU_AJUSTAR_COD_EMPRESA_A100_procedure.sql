-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE empresas_inter_imp_rec AS (	cd_empresa	varchar(10));


CREATE OR REPLACE PROCEDURE ptu_ajustar_cod_empresa_a100 ( nr_seq_intercambio_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_empresa_w		bigint;
cd_usuario_plano_w		varchar(30);
cd_empresa_w			varchar(10);
index_w				bigint;
qt_registros_w			bigint;
nr_seq_empresa_nova_w		bigint;
nr_seq_beneficiario_w		bigint;
cd_empresa_aux_w		varchar(10);
type empresas_inter_imp_rec_v is table of empresas_inter_imp_rec index by integer;
empresas_inter_imp_rec_vetor_w		empresas_inter_imp_rec_v;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	ptu_intercambio_empresa
	where	nr_seq_intercambio	= nr_seq_intercambio_p;

C02 CURSOR FOR
	SELECT	substr(cd_usuario_plano,1,4)
	from	ptu_intercambio_benef
	where	nr_seq_empresa	= nr_seq_empresa_w
	group by substr(cd_usuario_plano,1,4);

C03 CURSOR FOR
	SELECT	nr_sequencia
	from	ptu_intercambio_benef
	where	nr_seq_empresa	= nr_seq_empresa_w
	and	substr(cd_usuario_plano,1,4)	= cd_empresa_aux_w;

C04 CURSOR FOR
	SELECT	x.nr_sequencia
	from	ptu_intercambio_empresa	x
	where	x.nr_seq_intercambio	= nr_seq_intercambio_p
	and	not exists (	SELECT	1
					from	ptu_intercambio_benef	y
					where	y.nr_seq_empresa	= x.nr_sequencia);



BEGIN

open C01;
loop
fetch C01 into
	nr_seq_empresa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open c02;
	loop
	fetch c02 into
		cd_empresa_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		empresas_inter_imp_rec_vetor_w[empresas_inter_imp_rec_vetor_w.count+1].cd_empresa	:= cd_empresa_w;

		end;
	end loop;
	close c02;

	index_w			:= 0;
	nr_seq_empresa_nova_w	:= null;

	for index_w in 1..empresas_inter_imp_rec_vetor_w.count loop
		begin

		select	count(1)
		into STRICT	qt_registros_w
		from	ptu_intercambio_empresa
		where	nr_seq_intercambio	= nr_seq_intercambio_p
		and	cd_empresa_origem	= empresas_inter_imp_rec_vetor_w[index_w].cd_empresa  LIMIT 1;

		if (qt_registros_w = 0) then

			select	nextval('ptu_intercambio_empresa_seq')
			into STRICT	nr_seq_empresa_nova_w
			;

			insert into ptu_intercambio_empresa(nr_sequencia, cd_filial, ds_razao_social,
				nm_empr_abrev, ie_tipo_pessoa, cd_cgc_cpf,
				nr_insc_estadual, ds_endereco, ds_complemento,
				ds_bairro, cd_cep, nm_cidade,
				sg_uf, nr_ddd, nr_telefone,
				nr_fax, dt_inclusao, dt_exclusao,
				cd_empresa_origem, cd_municipio_ibge, nm_usuario,
				nm_usuario_nrec,dt_atualizacao_nrec,dt_atualizacao,
				nr_seq_intercambio, nr_endereco)
			(SELECT nr_seq_empresa_nova_w, cd_filial, ds_razao_social,
				nm_empr_abrev, ie_tipo_pessoa, cd_cgc_cpf,
				nr_insc_estadual, ds_endereco, ds_complemento,
				ds_bairro, cd_cep, nm_cidade,
				sg_uf, nr_ddd, nr_telefone,
				nr_fax, dt_inclusao, dt_exclusao,
				empresas_inter_imp_rec_vetor_w[index_w].cd_empresa, cd_municipio_ibge, nm_usuario_p,
				nm_usuario_p,clock_timestamp(),clock_timestamp(),
				nr_seq_intercambio_p, nr_endereco
			from	ptu_intercambio_empresa
			where	nr_sequencia	= nr_seq_empresa_w);

			insert into ptu_intercambio_plano(nr_sequencia, nr_seq_empresa, cd_plano_origem,
				cd_plano_intercambio, dt_inclusao, dt_exclusao,
				ie_natureza, ie_abrangencia, nr_ind_reembolso,
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, ds_plano_origem, nr_seq_plano,
				cd_ope_ans,cd_prod_ans, ie_plano)
			(SELECT	nextval('ptu_intercambio_plano_seq') , nr_seq_empresa_nova_w, cd_plano_origem,
				cd_plano_intercambio, dt_inclusao, dt_exclusao,
				ie_natureza, ie_abrangencia, nr_ind_reembolso,
				clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, ds_plano_origem, nr_seq_plano,
				cd_ope_ans,cd_prod_ans, ie_plano
			from	ptu_intercambio_plano
			where	nr_seq_empresa	= nr_seq_empresa_w);

			cd_empresa_aux_w	:= empresas_inter_imp_rec_vetor_w[index_w].cd_empresa;

			open c03;
			loop
			fetch c03 into
				nr_seq_beneficiario_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin

				update	ptu_intercambio_benef
				set	nr_seq_empresa	= nr_seq_empresa_nova_w
				where	nr_sequencia	= nr_seq_beneficiario_w;

				end;
			end loop;
			close c03;

		end if;

		end;
	end loop;

	end;
end loop;
close C01;

open c04;
loop
fetch c04 into
	nr_seq_empresa_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin

	delete	FROM ptu_intercambio_plano
	where	nr_seq_empresa	= nr_seq_empresa_w;

	delete	FROM ptu_intercambio_empresa
	where	nr_sequencia	= nr_seq_empresa_w;

	end;
end loop;
close c04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_ajustar_cod_empresa_a100 ( nr_seq_intercambio_p bigint, nm_usuario_p text) FROM PUBLIC;

