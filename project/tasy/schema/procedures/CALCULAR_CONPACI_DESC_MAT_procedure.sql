-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_conpaci_desc_mat ( nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_interno_conta_w	bigint;

cd_estrutura_w		integer;
pr_desconto_w		double precision;
vl_desconto_w		double precision;
vl_liquido_w		double precision;

nr_sequencia_w		bigint;
vl_material_w		double precision;
vl_unitario_w		double precision;
ie_valor_informado_w	varchar(1);
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
qt_material_w		double precision;
cd_material_w		integer;
cd_setor_atendimento_w	integer;
cd_cgc_fornecedor_w	varchar(14);
ds_erro_w		varchar(254);
dt_conta_w		timestamp;
cd_estabelecimento_w	smallint;
ie_tipo_atendimento_w	smallint;

vl_desc_item_w		double precision	:= 0;
vl_desc_item_ww		double precision	:= 0;
vl_desc_acum_w		double precision	:= 0;
vl_mat_acum_w		double precision	:= 0;
vl_mat_valor_w		double precision	:= 0;

ie_tipo_desconto_w		integer;
cd_setor_estrut_w		bigint;
cd_material_filtro_w		bigint;
nr_seq_proc_pacote_w	bigint;
NR_SEQ_VALOR_DESC_W	bigint;
nr_sequencia_ww		bigint;

ds_erro_ww		varchar(2000);
IE_VALOR_INF_DESCONTO_W	varchar(01);
qt_registro_w		bigint;
nr_seq_w		bigint;

ie_pacote_w		varchar(1);
nr_seq_desconto_w	bigint;
qt_reg_mat_atend_pac_valor_w	bigint;
ie_aplic_desc_vl_unit_w	varchar(1);
ie_valor_inf_w			conta_paciente_desconto.ie_valor_inf%type;
vl_conta_item_w			conta_paciente_desc_item.vl_conta%type;
nr_seq_proc_pacote_item_w	material_atend_paciente.nr_seq_proc_pacote%type;

-- Ricardo 17/04/2006 - Modificada a liha do vl_material abaixo.Problema ao desfazer com valor 0 (zero) OS 33016
C01 CURSOR FOR
	SELECT 	a.nr_sequencia,
			a.vl_material,
			a.vl_unitario,
			a.ie_valor_informado,
			a.cd_convenio,
			a.cd_categoria,
			a.qt_material,
			a.cd_material,
			a.cd_setor_atendimento,
			a.cd_cgc_fornecedor,
			coalesce(a.dt_conta, coalesce(dt_prescricao, dt_atendimento)),
			a.qt_material,
			b.cd_estabelecimento,
			b.ie_tipo_atendimento,
			a.nr_seq_proc_pacote
	from		Atendimento_paciente b,
			material_atend_paciente a
	where		a.nr_atendimento		= b.nr_atendimento
	and		a.nr_interno_conta	= nr_interno_conta_w
	and (ie_tipo_desconto_w in (8,9,10) or (a.ie_emite_conta		= cd_estrutura_w))
	and		((a.vl_material		<> 0) or (ie_acao_p = 'E'))
	and		((ie_tipo_desconto_w	<> 5) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 8) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 9) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 10) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 6) or (a.cd_material = cd_material_filtro_w))
	and		((ie_tipo_desconto_w	<> 11) or (a.cd_material = cd_material_filtro_w))
	and		((ie_tipo_desconto_W <> 7)  or (a.nr_seq_proc_pacote = nr_seq_proc_pacote_w))
	and 		((ie_pacote_w = 'A') or
			((ie_pacote_w = 'F') and (coalesce(a.nr_seq_proc_pacote, 0) = 0)) or
			((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, 0) > 0)))
	and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and 		((ie_acao_p = 'E') or (ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(a.ie_valor_informado,'N')))
	order by 	vl_material;
--	order by 	a.nr_sequencia;  Edgar 06/04/2005, OS 16741, troquei pelo order acima, para jogar a dif num valor positivo
C02 CURSOR FOR
	SELECT 		a.nr_sequencia
	from		Atendimento_paciente b,
			material_atend_paciente a
	where		a.nr_atendimento		= b.nr_atendimento
	and		a.nr_sequencia			<> nr_sequencia_w
	and		a.nr_interno_conta	= nr_interno_conta_w
	and (ie_tipo_desconto_w(8,9,10) or (a.ie_emite_conta		= cd_estrutura_w))
	and		((a.vl_material		<> 0) or (ie_acao_p = 'E'))
	and		((ie_tipo_desconto_w	<> 5) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 8) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 9) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 10) or (a.cd_setor_atendimento = cd_setor_estrut_w))
	and		((ie_tipo_desconto_w	<> 6) or (a.cd_material = cd_material_filtro_w))
	and		((ie_tipo_desconto_w	<> 11) or (a.cd_material = cd_material_filtro_w))
	and		((ie_tipo_desconto_W <> 7)  or (a.nr_seq_proc_pacote = nr_seq_proc_pacote_w))
	and 		((ie_pacote_w = 'A') or
			((ie_pacote_w = 'F') and (coalesce(a.nr_seq_proc_pacote, 0) = 0)) or
			((ie_pacote_w = 'P') and (coalesce(a.nr_seq_proc_pacote, 0) > 0)))
	and		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and		not exists (	SELECT 	1
					from 	material_atend_paciente x
					where	x.nr_interno_conta	= a.nr_interno_conta
					and	x.cd_material		= a.cd_material
					and (x.qt_material*-1)	= a.qt_material
					and	x.cd_acao		<> a.cd_acao
					and	coalesce(x.cd_motivo_exc_conta::text, '') = '')
	order by 	vl_material;


BEGIN

ie_aplic_desc_vl_unit_w	:= coalesce(obter_valor_param_usuario(67, 605, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

select	b.nr_interno_conta,
	b.ie_tipo_desconto,
	a.cd_setor_atendimento,
	a.cd_material,
	a.nr_seq_proc_pacote,
	coalesce(b.ie_pacote,'A'),
	a.nr_seq_desconto,
	coalesce(b.ie_valor_inf,'A')
into STRICT	nr_interno_conta_w,
	ie_tipo_desconto_w,
	cd_setor_estrut_w,
	cd_material_filtro_w,
	nr_seq_proc_pacote_w,
	ie_pacote_w,
	nr_seq_desconto_w,
	ie_valor_inf_w
from	conta_paciente_desconto b,
	conta_paciente_desc_item a
where 	a.nr_seq_desconto = b.nr_sequencia
and 	a.nr_sequencia = nr_sequencia_p;


select	cd_estrutura,
	pr_desconto,
	vl_desconto,
	vl_liquido,
	vl_conta
into STRICT	cd_estrutura_w,
	pr_desconto_w,
	vl_desconto_w,
	vl_liquido_w,
	vl_conta_item_w
from	conta_paciente_desc_item
where	nr_sequencia = nr_sequencia_p;

vl_desc_item_w	:= 0;
vl_desc_acum_w	:= 0;
vl_mat_acum_w	:= 0;

OPEN C01;
LOOP
	FETCH C01 into
		nr_sequencia_w,
		vl_material_w,
		vl_unitario_w,
		ie_valor_informado_w,
		cd_convenio_w,
		cd_categoria_w,
		qt_material_w,
		cd_material_w,
		cd_setor_atendimento_w,
		cd_cgc_fornecedor_w,
		dt_conta_w,
		qt_material_w,
		cd_estabelecimento_w,
		ie_tipo_atendimento_w,
		nr_seq_proc_pacote_item_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_acao_p	= 'I') then
			begin
			vl_desc_item_w		:= 0;

			if (coalesce(pr_desconto_w,0) > 0) then

				if (ie_tipo_desconto_w = 6) and (coalesce(vl_desconto_w,0) > 0) and (coalesce(vl_conta_item_w,0) > 0) then
					pr_desconto_w	:= ((vl_desconto_w * 100) / vl_conta_item_w);
				end if;

				if (ie_aplic_desc_vl_unit_w = 'S') and (coalesce(qt_material_w,0) <> 0) then
					vl_material_w	:= dividir(vl_material_w, qt_material_w);
				end if;

				vl_desc_item_w	:= Round( ((vl_material_w * pr_desconto_w) / 100) ,2 );

				if (ie_aplic_desc_vl_unit_w = 'S') and (coalesce(qt_material_w,0) <> 0) then
					vl_desc_item_w	:= vl_desc_item_w * qt_material_w;
					vl_material_w	:= vl_material_w * qt_material_w;
				end if;
			end if;

/*			if	(vl_material_w < 0) then
				vl_desc_item_w := vl_desc_item_w * -1;
			end if;
*/
			vl_desc_acum_w := vl_desc_acum_w + vl_desc_item_w;
			vl_mat_acum_w  := vl_mat_acum_w + (vl_material_w - vl_desc_item_w);


			if (vl_desc_item_w <> 0) then
				begin
				/* Atualizar os registros que estão na tabela mat_atend_paciente_valor com o registro do ie_tipo = 96 (Valor informado), porém que não estão com valor informado mais */

				if (coalesce(ie_valor_informado_w,'S') = 'N') then
					select 	count(*)
					into STRICT	qt_reg_mat_atend_pac_valor_w
					from 	mat_atend_paciente_valor
					where	nr_seq_material 	= nr_sequencia_w
					and	ie_tipo_valor		= 96;

					if (qt_reg_mat_atend_pac_valor_w > 0) then
						delete	from mat_atend_paciente_valor
						where	nr_seq_material 	= nr_sequencia_w
						and	ie_tipo_valor		= 96;
					end if;
				end if;


				/* atualizar material_atend_paciente */

				update material_atend_paciente
				set	 ie_valor_informado 	= 'S',
					 vl_material		= (vl_material - vl_desc_item_w)
				where	 nr_sequencia		= nr_sequencia_w;

				/* gerar mat_atend_paciente_valor */

				select coalesce(max(nr_sequencia),0) + 1
				into STRICT	 nr_seq_w
				from	 mat_atend_paciente_valor
				where	 nr_seq_material	= nr_sequencia_w;

				begin
				insert into mat_atend_paciente_valor(nr_seq_material,
					nr_sequencia,
					ie_tipo_valor,
					dt_atualizacao,
					nm_usuario,
					vl_material,
					cd_convenio,
					cd_categoria,
					pr_valor,
					nr_seq_desconto)
				values (
					nr_sequencia_w,
					nr_seq_w,
					3,
					clock_timestamp(),
					nm_usuario_p,
					vl_desc_item_w,
					null,
					null,
					pr_desconto_w,
					nr_seq_desconto_w);
				exception
					when others then
					ds_erro_ww	:= SQLERRM(SQLSTATE);
					--'Erro Incluir Desconto Mat #@DS_ERRO#@'
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(196113,'DS_ERRO=' || ds_erro_ww);
				end;
				end;
			end if;
			end;
		else
			begin

			select	coalesce(max(IE_VALOR_INF_DESCONTO), 'N')
			into STRICT	IE_VALOR_INF_DESCONTO_w
			from	parametro_faturamento
			where	cd_estabelecimento	= cd_estabelecimento_w;

			if (qt_material_w <> 0)  and (coalesce(nr_seq_proc_pacote_item_w,0) = 0) then

				update	material_atend_paciente
				set	ie_valor_informado 	= 'N'
				where	nr_sequencia		= nr_sequencia_w;

				CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);

			else

				select	coalesce(sum(vl_material),0)
				into STRICT	vl_mat_valor_w
				from	mat_atend_paciente_valor
				where	nr_seq_material 	= nr_sequencia_w
				and 	nr_seq_desconto	        = nr_seq_desconto_w
				and	ie_tipo_valor		= 3;

				update	material_atend_paciente
				set	vl_material		= vl_material + vl_mat_valor_w
				where	nr_sequencia		= nr_sequencia_w;

			end if;


			begin
			delete	from mat_atend_paciente_valor
			where	nr_seq_material 	= nr_sequencia_w
			and	ie_tipo_valor		= 3
			and 	nr_seq_desconto		= nr_seq_desconto_w;
			exception
   				when others then
					ds_erro_w		:= SQLERRM || wheb_mensagem_pck.get_texto(303763) || nr_sequencia_w;
					--#@DS_ERRO#@
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(196119,'DS_ERRO=' || ds_erro_ww);
			end;

			if (IE_VALOR_INF_DESCONTO_w	= 'S') and (coalesce(nr_seq_proc_pacote_item_w,0) = 0) then
				begin

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_valor_desc_w
				from	mat_atend_paciente_valor
				where	nr_seq_material	= nr_sequencia_w
				and	ie_tipo_valor		= 96;

				if (nr_seq_valor_desc_w 	<> 0) then
					select	coalesce(VL_material,0)
					into STRICT	VL_material_w
					from 	mat_atend_paciente_valor
					where 	nr_seq_material		= nr_sequencia_w
					and	ie_tipo_valor		= 96
					and	nr_sequencia		= nr_seq_valor_desc_w;


					update	material_atend_paciente
					set	ie_valor_informado	= 'S',
						vl_material		= VL_material_w,
						vl_unitario     = (VL_material_w / CASE WHEN coalesce(qt_material_w,1)=0 THEN 1  ELSE qt_material_w END )
					where	nr_sequencia		= nr_sequencia_w;

			end if;
			end;
		end if;

			end;
		end if;
		end;
END LOOP;
CLOSE C01;



if (ie_acao_p = 'I') and (not ie_tipo_desconto_w in (8,9,10)) and
	((vl_desconto_w <> vl_desc_acum_w) or (vl_liquido_w <> vl_mat_acum_w)) and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

	/*Felipe Martini OS101919 Início*/

	select	count(*)
	into STRICT	qt_registro_w
	from	material_atend_paciente a
	where	a.nr_sequencia		= nr_sequencia_w
	and	exists (	SELECT 	1
				from 	material_atend_paciente x
				where	x.nr_interno_conta	= a.nr_interno_conta
				and	x.cd_material		= a.cd_material
				and (x.qt_material*-1)	= a.qt_material
				and	coalesce(x.cd_motivo_exc_conta::text, '') = ''
				and	x.cd_acao		<> a.cd_acao);


	if (qt_registro_w		> 0 ) then

		open C02;
		loop
		fetch C02 into
			nr_sequencia_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		end loop;
		close C02;

		if (nr_sequencia_ww IS NOT NULL AND nr_sequencia_ww::text <> '') then
			nr_sequencia_w		:= nr_sequencia_ww;
		end if;
	end if;

	/*Felipe Martini OS101919 Fim*/

	select	vl_material
	into STRICT	vl_material_w
	from	material_atend_paciente
	where	nr_sequencia	=  nr_sequencia_w;

	update	material_atend_paciente
	set	ie_valor_informado 	= 'S',
		vl_material		= (vl_material + (vl_liquido_w - vl_mat_acum_w))
	where	nr_sequencia		= nr_sequencia_w;


	vl_desc_item_w		:= (vl_liquido_w - vl_mat_acum_w);



	select	coalesce(max(vl_material),0)
	into STRICT	vl_desc_item_ww
	from	mat_Atend_paciente_valor
	where	nr_seq_material	= nr_sequencia_w
	and 	nr_seq_desconto = nr_seq_desconto_w
	and	ie_tipo_valor	= 3;

	delete 	from mat_atend_paciente_valor
	where	nr_seq_material	= nr_sequencia_w
	and 	nr_seq_desconto = nr_seq_desconto_w
	and	ie_tipo_valor	= 3;

	select 	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_w
	from	mat_atend_paciente_valor
	where	nr_seq_material	= nr_sequencia_w;

	/*Felipe Martini OS103142*/

	vl_desc_item_w	:= vl_desc_item_w * -1;



	begin
	insert into mat_atend_paciente_valor(nr_seq_material,
		nr_sequencia,
		ie_tipo_valor,
		dt_atualizacao,
		nm_usuario,
		vl_material,
		cd_convenio,
		cd_categoria,
		pr_valor,
		nr_seq_desconto)
	values (
		nr_sequencia_w,
		nr_seq_w,
		3,
		clock_timestamp(),
		nm_usuario_p,
		vl_desc_item_w + vl_desc_item_ww,
		null,
		null,
		pr_desconto_w,
		nr_seq_desconto_w);
	exception
		when others then
		ds_erro_ww	:= SQLERRM(SQLSTATE);
		--'Erro Incluir Desconto Mat #@DS_ERRO#@'
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(196113,'DS_ERRO=' || ds_erro_ww);
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_conpaci_desc_mat ( nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

