-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_regra_preco_mat ( nr_seq_regra_p bigint, ie_opcao_p text, cd_estabalecimento_p text, nm_usuario_p text) AS $body$
DECLARE

/* ie_opcao_p
	'A' - Atualizar
	'D' - Deletar
*/
		

cd_categoria_w			varchar(30);
cd_convenio_w			varchar(30);
cd_estabelecimento_w		varchar(30);
cd_material_w			varchar(30);
cd_prestador_w			varchar(30);
ds_observacao_w			varchar(4000);
dt_base_fixo_w			timestamp;
dt_fim_vigencia_w		timestamp;
dt_inicio_vigencia_w		timestamp;
ie_generico_unimed_w		varchar(10);
ie_internado_w			varchar(10);
ie_mat_autorizacao_esp_w	varchar(10);
ie_origem_preco_w		varchar(10);
ie_pcmso_w			varchar(1);
ie_preco_w			varchar(10);
ie_situacao_w			varchar(10);
ie_tabela_adicional_w		varchar(10);
ie_tipo_contratacao_w		varchar(10);
ie_tipo_despesa_w		varchar(10);
ie_tipo_guia_w			varchar(10);
ie_tipo_intercambio_w		varchar(10);
ie_tipo_preco_brasindice_w	varchar(10);
ie_tipo_preco_simpro_w		varchar(10);
ie_tipo_segurado_w		varchar(10);
ie_tipo_tabela_w		varchar(10);
ie_tipo_vinculo_w		varchar(10);
nr_contrato_w			numeric(30);
nr_seq_categoria_w		numeric(30);
nr_seq_classificacao_w		numeric(30);
nr_seq_clinica_w		numeric(30);
nr_seq_congenere_w		numeric(30);
nr_seq_congenere_prot_w		numeric(30);
nr_seq_contrato_w		numeric(30);
nr_seq_estrutura_mat_w		numeric(30);
nr_seq_grupo_contrato_w		numeric(30);
nr_seq_grupo_material_w		numeric(30);
nr_seq_grupo_prestador_w	numeric(30);
nr_seq_grupo_produto_w		numeric(30);
nr_seq_grupo_uf_w		numeric(30);
nr_seq_material_w		numeric(30);
nr_seq_material_preco_w		numeric(30);
nr_seq_outorgante_w		numeric(30);
nr_seq_plano_w			numeric(30);
nr_seq_prestador_w		numeric(30);
nr_seq_regra_ant_w		numeric(30);
nr_seq_tipo_acomodacao_w	numeric(30);
nr_seq_tipo_atendimento_w	numeric(30);
nr_seq_tipo_prestador_w		numeric(30);
nr_seq_tipo_uso_w		numeric(30);
nr_seq_regra_ref_w		numeric(30);
sg_uf_operadora_intercambio_w	varchar(2);
tx_ajuste_w			double precision;
tx_ajuste_benef_lib_W		double precision;
tx_ajuste_pfb_w			double precision;
tx_ajuste_pmc_neg_w		double precision;
tx_ajuste_pmc_neut_w		double precision;
tx_ajuste_pmc_pos_w		double precision;
tx_ajuste_simpro_pfb_w		double precision;
tx_ajuste_simpro_pmc_w		double precision;
tx_ajuste_tab_propria_w		double precision;
vl_negociado_w			double precision;
nr_seq_regra_w			numeric(30);
nr_seq_regra_mat_ref_w		numeric(30);
ie_saude_ocupacional_w			pls_regra_preco_mat.ie_saude_ocupacional%type;
ie_regime_atendimento_w			pls_regra_preco_mat.ie_regime_atendimento%type;
ie_regime_atendimento_princ_w	pls_regra_preco_mat.ie_regime_atendimento_princ%type;WITH RECURSIVE cte AS (



C01 CURSOR FOR
	SELECT	a.nr_sequencia,a.nr_seq_regra_mat_ref
	from	pls_regra_preco_mat	a WHERE a.nr_sequencia in (SELECT	x.nr_sequencia
					from	pls_regra_preco_mat x
					where	x.nr_sequencia	= nr_seq_regra_p)
  UNION ALL



C01 CURSOR FOR
	SELECT	a.nr_sequencia,a.nr_seq_regra_mat_ref
	from	pls_regra_preco_mat	a JOIN cte c ON (c.prior nr_sequencia = a.nr_seq_regra_mat_ref)

) SELECT * FROM cte;
;WITH RECURSIVE cte AS (

	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_regra_preco_mat	a WHERE a.nr_sequencia in (SELECT	x.nr_sequencia
					from	pls_regra_preco_mat x
					where	x.nr_seq_regra_mat_ref	= nr_seq_regra_p)
  UNION ALL

	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_regra_preco_mat	a JOIN cte c ON (c.prior nr_sequencia = a.nr_seq_regra_mat_ref)

) SELECT * FROM cte ORDER BY  level desc;
;
			

BEGIN

if (ie_opcao_p = 'A') then
	open C01;
	loop
	fetch C01 into	
		nr_seq_regra_w,
		nr_seq_regra_mat_ref_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (coalesce(nr_seq_regra_mat_ref_w,0) <> 0 ) then
			select	cd_categoria,
				cd_convenio,                     
				cd_estabelecimento,          
				cd_material,                     
				cd_prestador,                    
				ds_observacao,                  
				dt_base_fixo,                    
				dt_fim_vigencia,                 
				dt_inicio_vigencia,          
				ie_generico_unimed,             
				ie_internado,                    
				ie_mat_autorizacao_esp,          
				ie_origem_preco,             
				ie_pcmso,                        
				ie_preco,                        
				ie_situacao,                 
				ie_tabela_adicional,             
				ie_tipo_contratacao,             
				ie_tipo_despesa,                 
				ie_tipo_guia,                    
				ie_tipo_intercambio,             
				ie_tipo_preco_brasindice,        
				ie_tipo_preco_simpro,            
				ie_tipo_segurado,                
				ie_tipo_tabela,                  
				ie_tipo_vinculo,                 
				nr_contrato,                     
				nr_seq_categoria,                
				nr_seq_classificacao,            
				nr_seq_clinica,                  
				nr_seq_congenere,                
				nr_seq_congenere_prot,           
				nr_seq_contrato,                 
				nr_seq_estrutura_mat,            
				nr_seq_grupo_contrato,           
				nr_seq_grupo_material,           
				nr_seq_grupo_prestador,          
				nr_seq_grupo_produto,            
				nr_seq_grupo_uf,                 
				nr_seq_material,                 
				nr_seq_material_preco,           
				nr_seq_outorgante,               
				nr_seq_plano,                    
				nr_seq_prestador,                
				nr_seq_regra_ant,                
				nr_seq_tipo_acomodacao,          
				nr_seq_tipo_atendimento,         
				nr_seq_tipo_prestador,           
				nr_seq_tipo_uso,                 
				nr_sequencia,                
				sg_uf_operadora_intercambio,     
				tx_ajuste,                       
				tx_ajuste_benef_lib,             
				tx_ajuste_pfb,               
				tx_ajuste_pmc_neg,           
				tx_ajuste_pmc_neut,          
				tx_ajuste_pmc_pos,           
				tx_ajuste_simpro_pfb,        
				tx_ajuste_simpro_pmc,        
				tx_ajuste_tab_propria,       
				vl_negociado,
				ie_saude_ocupacional_w,			
                ie_regime_atendimento_w,			
				ie_regime_atendimento_princ_w
			into STRICT	cd_categoria_w,                    
				cd_convenio_w,                     
				cd_estabelecimento_w,          
				cd_material_w,                     
				cd_prestador_w,                    
				ds_observacao_w,                  
				dt_base_fixo_w,                    
				dt_fim_vigencia_w,                 
				dt_inicio_vigencia_w,          
				ie_generico_unimed_w,             
				ie_internado_w,                    
				ie_mat_autorizacao_esp_w,          
				ie_origem_preco_w,             
				ie_pcmso_w,                        
				ie_preco_w,                        
				ie_situacao_w,                 
				ie_tabela_adicional_w,             
				ie_tipo_contratacao_w,             
				ie_tipo_despesa_w,                 
				ie_tipo_guia_w,                    
				ie_tipo_intercambio_w,             
				ie_tipo_preco_brasindice_w,        
				ie_tipo_preco_simpro_w,            
				ie_tipo_segurado_w,                
				ie_tipo_tabela_w,                  
				ie_tipo_vinculo_w,                 
				nr_contrato_w,                     
				nr_seq_categoria_w,                
				nr_seq_classificacao_w,            
				nr_seq_clinica_w,                  
				nr_seq_congenere_w,                
				nr_seq_congenere_prot_w,           
				nr_seq_contrato_w,                 
				nr_seq_estrutura_mat_w,            
				nr_seq_grupo_contrato_w,           
				nr_seq_grupo_material_w,           
				nr_seq_grupo_prestador_w,          
				nr_seq_grupo_produto_w,            
				nr_seq_grupo_uf_w,                 
				nr_seq_material_w,                 
				nr_seq_material_preco_w,           
				nr_seq_outorgante_w,               
				nr_seq_plano_w,                    
				nr_seq_prestador_w,                
				nr_seq_regra_ant_w,                
				nr_seq_tipo_acomodacao_w,          
				nr_seq_tipo_atendimento_w,         
				nr_seq_tipo_prestador_w,           
				nr_seq_tipo_uso_w,                 
				nr_seq_regra_ref_w,                
				sg_uf_operadora_intercambio_w,     
				tx_ajuste_w,                       
				tx_ajuste_benef_lib_W,             
				tx_ajuste_pfb_w,               
				tx_ajuste_pmc_neg_w,           
				tx_ajuste_pmc_neut_w,          
				tx_ajuste_pmc_pos_w,           
				tx_ajuste_simpro_pfb_w,        
				tx_ajuste_simpro_pmc_w,        
				tx_ajuste_tab_propria_w,       
				vl_negociado_w,
				ie_saude_ocupacional_w,		
				ie_regime_atendimento_w,		
				ie_regime_atendimento_princ_w
			from	pls_regra_preco_mat
			where	nr_sequencia = nr_seq_regra_mat_ref_w;
			
			update	pls_regra_preco_mat
			set	cd_categoria			= cd_categoria_w,
				cd_convenio			= cd_convenio_w,
				cd_estabelecimento		= cd_estabelecimento_w,
				cd_material                     = cd_material_w,
				cd_prestador                    = cd_prestador_w,
				ds_observacao                   = ds_observacao_w,
				dt_atualizacao               	= clock_timestamp(),
				dt_base_fixo                    = dt_base_fixo_w,
				dt_fim_vigencia                 = dt_fim_vigencia_w,
				dt_inicio_vigencia           	= dt_inicio_vigencia_w,
				ie_generico_unimed              = ie_generico_unimed_w,
				ie_internado                    = ie_internado_w,
				ie_mat_autorizacao_esp          = ie_mat_autorizacao_esp_w,
				ie_origem_preco              	= ie_origem_preco_w,
				ie_pcmso			= ie_pcmso_w,
				ie_preco			= ie_preco_w,                        
				ie_situacao                  	= ie_situacao_w,
				ie_tabela_adicional             = ie_tabela_adicional_w,
				ie_tipo_contratacao             = ie_tipo_contratacao_w,
				ie_tipo_despesa                 = ie_tipo_despesa_w,
				ie_tipo_guia                    = ie_tipo_guia_w,
				ie_tipo_intercambio             = ie_tipo_intercambio_w,
				ie_tipo_preco_brasindice        = ie_tipo_preco_brasindice_w,
				ie_tipo_preco_simpro            = ie_tipo_preco_simpro_w,
				ie_tipo_segurado                = ie_tipo_segurado_w,
				ie_tipo_vinculo                 = ie_tipo_vinculo_w,
				nm_usuario                   	= nm_usuario_p,
				nr_contrato                     = nr_contrato_w,
				nr_seq_categoria                = nr_seq_categoria_w,
				nr_seq_classificacao            = nr_seq_classificacao_w,
				nr_seq_clinica                  = nr_seq_clinica_w,
				nr_seq_congenere                = nr_seq_congenere_w,
				nr_seq_congenere_prot           = nr_seq_congenere_prot_w,
				nr_seq_contrato                 = nr_seq_contrato_w,
				nr_seq_estrutura_mat            = nr_seq_estrutura_mat_w,
				nr_seq_grupo_contrato           = nr_seq_grupo_contrato_w,
				nr_seq_grupo_material           = nr_seq_grupo_material_w,
				nr_seq_grupo_prestador          = nr_seq_grupo_prestador_w,
				nr_seq_grupo_produto            = nr_seq_grupo_produto_w,
				nr_seq_grupo_uf                 = nr_seq_grupo_uf_w,
				nr_seq_material                 = nr_seq_material_w,
				nr_seq_material_preco           = nr_seq_material_preco_w,
				nr_seq_outorgante               = nr_seq_outorgante_w,
				nr_seq_plano                    = nr_seq_plano_w,
				nr_seq_prestador                = nr_seq_prestador_w,
				nr_seq_regra_ant                = nr_seq_regra_ant_w,
				nr_seq_regra_mat_ref            = nr_seq_regra_ref_w,
				nr_seq_tipo_acomodacao          = nr_seq_tipo_acomodacao_w,
				nr_seq_tipo_atendimento         = nr_seq_tipo_atendimento_w,
				nr_seq_tipo_prestador           = nr_seq_tipo_prestador_w,
				nr_seq_tipo_uso                 = nr_seq_tipo_uso_w,                 
				sg_uf_operadora_intercambio     = sg_uf_operadora_intercambio_w,
				tx_ajuste                       = tx_ajuste_w,
				tx_ajuste_benef_lib             = tx_ajuste_benef_lib_w,
				tx_ajuste_pfb                	= tx_ajuste_pfb_w,
				tx_ajuste_pmc_neg            	= tx_ajuste_pmc_neg_w,
				tx_ajuste_pmc_neut           	= tx_ajuste_pmc_neut_w,
				tx_ajuste_pmc_pos            	= tx_ajuste_pmc_pos_w,
				tx_ajuste_simpro_pfb         	= tx_ajuste_simpro_pfb_w,
				tx_ajuste_simpro_pmc         	= tx_ajuste_simpro_pmc_w,
				tx_ajuste_tab_propria        	= tx_ajuste_tab_propria_w,
				vl_negociado			= vl_negociado_w
			where	nr_sequencia = nr_seq_regra_w;
		end if;
		end;
	end loop;
	close C01;
elsif (ie_opcao_p = 'D') then
	open C02;
	loop
	fetch C02 into	
		nr_seq_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			delete	FROM pls_regra_preco_mat
			where	nr_sequencia	= nr_seq_regra_w;
		end;
	end loop;
	close C02;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_regra_preco_mat ( nr_seq_regra_p bigint, ie_opcao_p text, cd_estabalecimento_p text, nm_usuario_p text) FROM PUBLIC;

