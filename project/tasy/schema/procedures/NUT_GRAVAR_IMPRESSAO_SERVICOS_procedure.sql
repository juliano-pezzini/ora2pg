-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gravar_impressao_servicos ( nr_Seq_nut_serv_dia_p bigint, ie_serv_lib_impressao_p text, ie_reimpressao_p text, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, dt_servico_p timestamp, nr_seq_tipo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_nut_serv_dia_w			bigint;
nr_Seq_impressao_w			bigint;

C01 CURSOR FOR
SELECT	nr_sequencia
from	nut_atend_serv_dia
where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	nr_seq_servico = nr_seq_servico_p
and	trunc(dt_servico) = trunc(dt_servico_p)
and	cd_setor_atendimento = cd_setor_atendimento_p
and	((nr_sequencia = nr_seq_nut_serv_dia_p) or (nr_seq_nut_serv_dia_p = 0))
and	(((ie_serv_lib_impressao_p = 'S') and ((obter_ult_data_imp_servico(nr_sequencia, nr_seq_tipo_p) IS NOT NULL AND (obter_ult_data_imp_servico(nr_sequencia, nr_seq_tipo_p))::text <> '')) and (obter_ult_data_imp_servico(nr_sequencia, nr_seq_tipo_p) < dt_liberacao)) or (ie_serv_lib_impressao_p = 'N'))
and	((ie_reimpressao_p = 'S') or (ie_serv_lib_impressao_p = 'S') or (nr_seq_nut_serv_dia_p > 0) or
	 ((ie_reimpressao_p = 'N') and (ie_serv_lib_impressao_p = 'N') and (nr_seq_nut_serv_dia_p = 0) and (coalesce(obter_ult_data_imp_servico(nr_sequencia, nr_seq_tipo_p)::text, '') = '')));


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_nut_serv_dia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into nut_pac_servico_imp(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_atend_serv_dia,
					dt_impressao,
					nr_seq_tipo_imp)
	values (
				nextval('nut_pac_servico_imp_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_nut_serv_dia_w,
				clock_timestamp(),
				nr_seq_tipo_p);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gravar_impressao_servicos ( nr_Seq_nut_serv_dia_p bigint, ie_serv_lib_impressao_p text, ie_reimpressao_p text, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, dt_servico_p timestamp, nr_seq_tipo_p bigint, nm_usuario_p text) FROM PUBLIC;

