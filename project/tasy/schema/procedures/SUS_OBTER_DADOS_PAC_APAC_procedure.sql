-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_obter_dados_pac_apac ( nr_atendimento_p bigint, nr_sequencia_p bigint, nr_apac_p bigint, nm_usuario_p text) AS $body$
DECLARE

				 
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%Type;
dt_pri_dialise_w			hd_pac_renal_cronico.dt_inicio_tratamento%Type;
nr_seq_exame_w				sus_regra_exame_result.nr_seq_exame%Type;
nr_seq_resultado_w			exame_lab_result_item.nr_seq_resultado%Type;
qt_altura_cm_w				atendimento_sinal_vital.qt_altura_cm%Type;
qt_peso_w				atendimento_sinal_vital.qt_peso%Type;
qt_resultado_w				double precision;
qt_glicose_w				sus_apac_unif.qt_glicose%Type;
pr_albumina_w				sus_apac_unif.pr_albumina%Type;
pr_hb_w					sus_apac_unif.pr_hb%Type;
qt_diurese_w				sus_apac_unif.qt_diurese%type;
nr_tru_w				sus_apac_unif.nr_tru%type;
ie_tipo_resultado_w			sus_regra_exame_result.ie_tipo_resultado%Type;

C01 CURSOR FOR 
	SELECT	nr_seq_exame, 
		ie_tipo_resultado 
	from 	sus_regra_exame_result;


BEGIN 
 
cd_pessoa_fisica_w := obter_pessoa_atendimento(nr_atendimento_p,'C');
 
select	max(dt_inicio_tratamento) 
into STRICT	dt_pri_dialise_w 
from	hd_pac_renal_cronico 
where	cd_pessoa_fisica = cd_pessoa_fisica_w;
 
select	coalesce(max(qt_altura_cm),0), 
	coalesce(max(qt_peso),0) 
into STRICT	qt_altura_cm_w, 
	qt_peso_w 
from 	atendimento_sinal_vital 
where	nr_atendimento = nr_atendimento_p;
 
open C01;
loop 
fetch C01 into 
	nr_seq_exame_w, 
	ie_tipo_resultado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	select	max(a.nr_seq_resultado) 
	into STRICT	nr_seq_resultado_w 
	from	exame_lab_result_item a, 
		exame_lab_resultado b, 
		prescr_medica c 
	where	a.nr_seq_resultado		= b.nr_seq_resultado 
	and	b.nr_prescricao		= c.nr_prescricao 
	and	c.cd_pessoa_fisica		= cd_pessoa_fisica_w 
	and	a.nr_seq_exame 		= nr_seq_exame_w;
 
	if (ie_tipo_resultado_w = 'G') then 
		begin 
		 
		begin 
		select	max(qt_resultado) 
		into STRICT	qt_resultado_w 
		from	exame_lab_result_item 
		where	nr_seq_resultado = nr_seq_resultado_w;
		exception 
		when others then 
			qt_resultado_w	:= null;
		end;
		 
		qt_glicose_w := qt_resultado_w;
		 
		end;
	elsif (ie_tipo_resultado_w = 'A') then 
		begin 
		 
		begin 
		select	max(pr_resultado) 
		into STRICT	qt_resultado_w 
		from	exame_lab_result_item 
		where	nr_seq_resultado = nr_seq_resultado_w;
		exception 
		when others then 
			qt_resultado_w	:= null;
		end;
		 
		pr_albumina_w := qt_resultado_w;
		 
		end;
	elsif (ie_tipo_resultado_w = 'H') then 
		begin 
		 
		begin 
		select	max(pr_resultado) 
		into STRICT	qt_resultado_w 
		from	exame_lab_result_item 
		where	nr_seq_resultado = nr_seq_resultado_w;
		exception 
		when others then 
			qt_resultado_w	:= null;
		end;		
		 
		pr_hb_w	:= qt_resultado_w;
		 
		end;		
	elsif (ie_tipo_resultado_w = 'D') then 
		begin 
		 
		begin 
		select	max(pr_resultado) 
		into STRICT	qt_resultado_w 
		from	exame_lab_result_item 
		where	nr_seq_resultado = nr_seq_resultado_w;
		exception 
		when others then 
			qt_resultado_w	:= null;
		end;
		 
		qt_diurese_w := qt_resultado_w;
		 
		end;		
	elsif (ie_tipo_resultado_w = 'T') then 
		begin 
		 
		begin 
		select	max(pr_resultado) 
		into STRICT	qt_resultado_w 
		from	exame_lab_result_item 
		where	nr_seq_resultado = nr_seq_resultado_w;
		exception 
		when others then 
			qt_resultado_w	:= null;
		end;		
		 
		nr_tru_w := qt_resultado_w;
		 
		end;		
	end if;
	end;
end loop;
close C01;
 
update	sus_apac_unif 
set	dt_pri_dialise		= dt_pri_dialise_w, 
	qt_altura_cm		= qt_altura_cm_w, 
	qt_peso			= qt_peso_w, 
	qt_glicose		= qt_glicose_w, 
	pr_albumina		= pr_albumina_w, 
	pr_hb			= pr_hb_w, 
	qt_diurese		= qt_diurese_w, 
	nr_tru			= nr_tru_w, 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao		= clock_timestamp() 
where	nr_sequencia 		= nr_sequencia_p 
and	nr_apac			= nr_apac_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_obter_dados_pac_apac ( nr_atendimento_p bigint, nr_sequencia_p bigint, nr_apac_p bigint, nm_usuario_p text) FROM PUBLIC;

