-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_livro_aux_ops_rec ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
count_w			bigint	:= 0;

c_valores CURSOR FOR 
	SELECT	a.nr_titulo, 
		a.dt_emissao, 
		a.dt_vencimento, 
		substr(pls_obter_dados_segurado(d.nr_sequencia, 'C'),1,255) cd_carteira, 
		substr(obter_nome_pf(d.cd_pessoa_fisica),1,255) nm_beneficiario	, 
		substr(obter_valor_dominio(1669,e.ie_preco),1,255) ds_modalidade, 
		substr(obter_valor_dominio(2157,e.ie_regulamentacao),1,255) ds_tipo_regulamentacao, 
		substr(obter_valor_dominio(1666,e.ie_tipo_contratacao),1,255) ds_tipo_contratacao, 
		substr(obter_valor_dominio(1665,e.ie_segmentacao),1,255) ds_segmentacao, 
		substr(obter_valor_dominio(3418,f.ie_ato_cooperado),1,255) ds_ato_cooperado, 
		c.dt_inicio_cobertura, 
		c.dt_fim_cobertura, 
		c.vl_mensalidade vl_contraprestacao, 
		h.dt_geracao, 
		(SELECT	max(s.cd_classificacao) 
		from	movimento_contabil_doc		r, 
			movimento_contabil		s, 
			lote_contabil			t 
		where	s.nr_sequencia			= r.nr_seq_movimento 
		and	s.nr_lote_contabil		= t.nr_lote_contabil 
		and	r.nr_lote_contabil		= t.nr_lote_contabil 
		and	f.nr_sequencia			= r.nr_documento 
		and	r.nm_tabela			= 'PLS_CONTA_PROC' 
		and	r.nm_atributo			!= 'VL_GLOSA' 
		and	substr(s.cd_classificacao,1,9)	= '4.1.1.1.1' 
		and	s.ie_debito_credito		= 'D' 
		and	t.dt_referencia between dt_inicial_p and dt_final_p) cd_conta_deb, 
		(select	max(s.cd_classificacao) 
		from	movimento_contabil_doc		r, 
			movimento_contabil		s, 
			lote_contabil			t 
		where	s.nr_sequencia			= r.nr_seq_movimento 
		and	s.nr_lote_contabil		= t.nr_lote_contabil 
		and	r.nr_lote_contabil		= t.nr_lote_contabil 
		and	f.nr_sequencia			= r.nr_documento 
		and	r.nm_tabela			= 'PLS_CONTA_PROC' 
		and	r.nm_atributo			!= 'VL_GLOSA' 
		and	substr(s.cd_classificacao,1,9)	= '2.1.1.1.1' 
		and	s.ie_debito_credito		= 'C' 
		and	t.dt_referencia between dt_inicial_p and dt_final_p) cd_conta_cred		 
	FROM pls_lote_mensalidade h, pls_conta g, pls_conta_proc f, pls_plano e, pls_segurado d, pls_mensalidade_segurado c, pls_mensalidade b
LEFT OUTER JOIN titulo_receber a ON (b.nr_sequencia = a.nr_seq_mensalidade)
WHERE b.nr_sequencia 	= c.nr_seq_mensalidade and d.nr_seq_plano	= e.nr_sequencia and d.nr_sequencia	= c.nr_seq_segurado and f.nr_seq_conta	= g.nr_sequencia and g.nr_seq_plano	= e.nr_sequencia and b.nr_seq_lote	= h.nr_sequencia and exists	(select	1 
			from	movimento_contabil_doc		r, 
				movimento_contabil		s, 
				lote_contabil			t 
			where	s.nr_sequencia			= r.nr_seq_movimento 
			and	s.nr_lote_contabil		= t.nr_lote_contabil 
			and	r.nr_lote_contabil		= t.nr_lote_contabil 
			and	b.nr_sequencia			= r.nr_documento 
			and	r.nm_tabela			= 'PLS_CONTA_PROC' 
			and	r.nm_atributo			!= 'VL_GLOSA' 
			and	((substr(s.cd_classificacao,1,9) = '4.1.1.1.1' and s.ie_debito_credito	= 'D') or (substr(s.cd_classificacao,1,9) = '2.1.1.1.1' and s.ie_debito_credito	= 'C')) 
			and	t.dt_referencia between dt_inicial_p and dt_final_p) 
	 
union all
 
	select	a.nr_titulo, 
		a.dt_emissao, 
		a.dt_vencimento, 
		substr(pls_obter_dados_segurado(d.nr_sequencia, 'C'),1,255) cd_carteira, 
		substr(obter_nome_pf(d.cd_pessoa_fisica),1,255) nm_beneficiario	, 
		substr(obter_valor_dominio(1669,e.ie_preco),1,255) ds_modalidade, 
		substr(obter_valor_dominio(2157,e.ie_regulamentacao),1,255) ds_tipo_regulamentacao, 
		substr(obter_valor_dominio(1666,e.ie_tipo_contratacao),1,255) ds_tipo_contratacao, 
		substr(obter_valor_dominio(1665,e.ie_segmentacao),1,255) ds_segmentacao, 
		substr(obter_valor_dominio(3418,f.ie_ato_cooperado),1,255) ds_ato_cooperado, 
		c.dt_inicio_cobertura, 
		c.dt_fim_cobertura, 
		c.vl_mensalidade, 
		h.dt_geracao, 
		(select	max(s.cd_classificacao) 
		from	movimento_contabil_doc		r, 
			movimento_contabil		s, 
			lote_contabil			t 
		where	s.nr_sequencia			= r.nr_seq_movimento 
		and	s.nr_lote_contabil		= t.nr_lote_contabil 
		and	r.nr_lote_contabil		= t.nr_lote_contabil 
		and	f.nr_sequencia			= r.nr_documento 
		and	r.nm_tabela			= 'PLS_CONTA_MAT' 
		and	r.nm_atributo			!= 'VL_GLOSA' 
		and	substr(s.cd_classificacao,1,9)	= '4.1.1.1.1' 
		and	s.ie_debito_credito		= 'D' 
		and	t.dt_referencia between dt_inicial_p and dt_final_p) cd_conta_deb, 
		(select	max(s.cd_classificacao) 
		from	movimento_contabil_doc		r, 
			movimento_contabil		s, 
			lote_contabil			t 
		where	s.nr_sequencia			= r.nr_seq_movimento 
		and	s.nr_lote_contabil		= t.nr_lote_contabil 
		and	r.nr_lote_contabil		= t.nr_lote_contabil 
		and	f.nr_sequencia			= r.nr_documento 
		and	r.nm_tabela			= 'PLS_CONTA_MAT' 
		and	r.nm_atributo			!= 'VL_GLOSA' 
		and	substr(s.cd_classificacao,1,9)	= '2.1.1.1.1' 
		and	s.ie_debito_credito		= 'C' 
		and	t.dt_referencia between dt_inicial_p and dt_final_p) cd_conta_cred		 
	FROM pls_lote_mensalidade h, pls_conta g, pls_conta_mat f, pls_plano e, pls_segurado d, pls_mensalidade_segurado c, pls_mensalidade b
LEFT OUTER JOIN titulo_receber a ON (b.nr_sequencia = a.nr_seq_mensalidade)
WHERE b.nr_sequencia 	= c.nr_seq_mensalidade and d.nr_seq_plano	= e.nr_sequencia and d.nr_sequencia	= c.nr_seq_segurado and f.nr_seq_conta	= g.nr_sequencia and g.nr_seq_plano	= e.nr_sequencia and b.nr_seq_lote	= h.nr_sequencia and exists	(select	1 
			from	movimento_contabil_doc		r, 
				movimento_contabil		s, 
				lote_contabil			t 
			where	s.nr_sequencia			= r.nr_seq_movimento 
			and	s.nr_lote_contabil		= t.nr_lote_contabil 
			and	r.nr_lote_contabil		= t.nr_lote_contabil 
			and	b.nr_sequencia			= r.nr_documento 
			and	r.nm_tabela			= 'PLS_CONTA_MAT' 
			and	r.nm_atributo			!= 'VL_GLOSA' 
			and	((substr(s.cd_classificacao,1,9) = '4.1.1.1.1' and s.ie_debito_credito	= 'D') or (substr(s.cd_classificacao,1,9) = '2.1.1.1.1' and s.ie_debito_credito	= 'C')) 
			and	t.dt_referencia between dt_inicial_p and dt_final_p);

type 		fetch_array is table of c_valores%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_valores_w	vetor;
			
BEGIN 
open c_valores;
loop 
fetch c_valores bulk collect into s_array limit 1000;
	vetor_valores_w(i)	:= s_array;
	i			:= i + 1;
EXIT WHEN NOT FOUND; /* apply on c_valores */
end loop;
close c_valores;
 
delete	from w_ctb_livro_aux_ops_rec 
where	nm_usuario	= nm_usuario_p;
 
for i in 1..vetor_valores_w.count loop 
	begin 
	s_array	:= vetor_valores_w(i);
	 
	for z in 1..s_array.count loop 
		begin 
		insert into w_ctb_livro_aux_ops_rec(nm_usuario, 
			cd_estabelecimento, 
			dt_atualizacao, 
			nr_titulo, 
			dt_emissao, 
			dt_vencimento, 
			cd_carteira, 
			nm_beneficiario, 
			ds_modalidade, 
			ds_tipo_regulamentacao, 
			ds_tipo_contratacao, 
			ds_segmentacao, 
			ds_ato_cooperado, 
			dt_inicio_cobertura, 
			dt_fim_cobertura, 
			vl_contraprestacao, 
			dt_contabilizacao, 
			cd_conta_deb, 
			cd_conta_cred) 
		values (nm_usuario_p, 
			cd_estabelecimento_p, 
			clock_timestamp(), 
			s_array[z].nr_titulo, 
			s_array[z].dt_emissao, 
			s_array[z].dt_vencimento, 
			s_array[z].cd_carteira, 
			s_array[z].nm_beneficiario, 
			s_array[z].ds_modalidade, 
			s_array[z].ds_tipo_regulamentacao, 
			s_array[z].ds_tipo_contratacao, 
			s_array[z].ds_segmentacao, 
			s_array[z].ds_ato_cooperado, 
			s_array[z].dt_inicio_cobertura, 
			s_array[z].dt_fim_cobertura, 
			s_array[z].vl_contraprestacao, 
			s_array[z].dt_geracao, 
			s_array[z].cd_conta_deb, 
			s_array[z].cd_conta_cred);
		 
		count_w	:= count_w + 1;
		 
		if (count_w = 1000) then 
			count_w	:= 0;
			 
			commit;
		end if;
		end;
	end loop;
	end;
end loop;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_livro_aux_ops_rec ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

