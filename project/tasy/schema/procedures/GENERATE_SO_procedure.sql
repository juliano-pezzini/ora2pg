-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_so (nm_request_user_p text, nm_exec_user_p text, ie_classification_p text, ds_damage_p text, ds_damage_brief_p text, ds_text_hist_default_p text, ie_platform_p text, nr_seq_ordem_serv_p INOUT bigint) AS $body$
DECLARE


nr_seq_ordem_w        man_ordem_servico.nr_sequencia%type;
cd_request_user_w    usuario.cd_pessoa_fisica%type;
ds_brief_damage_w        man_ordem_servico.ds_dano_breve%type := ds_damage_p;
ds_damage_w        man_ordem_servico.ds_dano%type := ds_damage_brief_p;
nr_seq_gerencia_w    grupo_desenvolvimento.nr_seq_gerencia%type;
ie_classification_w    man_ordem_servico.ie_classificacao%type := ie_classification_p;
nr_seq_grupo_desenv_w    man_ordem_servico.nr_seq_grupo_des%type;
nm_exec_user_w        usuario.nm_usuario%type := nm_exec_user_p;
nm_request_user_w    usuario.nm_usuario%type := nm_request_user_p;


BEGIN

select cd_pessoa_fisica INTO STRICT cd_request_user_w from usuario where nm_usuario = nm_request_user_w;
select obter_grupo_usuario(nm_exec_user_w) into STRICT nr_seq_grupo_desenv_w;
select Obter_Gerencia_grupo_desen(nr_seq_grupo_desenv_w,'C') into STRICT nr_seq_gerencia_w;

nr_seq_ordem_w := ccd_generate_os(cd_request_user_w, nm_request_user_w, ds_brief_damage_w, ds_damage_w, nr_seq_gerencia_w, nr_seq_grupo_desenv_w, ie_classification_w, nm_exec_user_w, nr_seq_ordem_w);

update man_ordem_servico set ie_plataforma = ie_platform_p where nr_sequencia = nr_seq_ordem_w;

IF (LENGTH(ds_text_hist_default_p) > 0) THEN
    insert into MAN_ORDEM_SERV_TECNICO(NR_SEQUENCIA,
    NR_SEQ_ORDEM_SERV,
    DT_ATUALIZACAO,
    NM_USUARIO,
    DT_HISTORICO,
    DT_LIBERACAO,
    NR_SEQ_TIPO,
    IE_ORIGEM,
    DS_RELAT_TECNICO)
    values (nextval('man_ordem_serv_tecnico_seq'),
    nr_seq_ordem_w,
    clock_timestamp(), 
    nm_exec_user_w, 
    clock_timestamp(),
    clock_timestamp(),
    7,--'Dialogo interno Philips'
    'I',
    ds_text_hist_default_p);
END IF;

nr_seq_ordem_serv_p := nr_seq_ordem_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_so (nm_request_user_p text, nm_exec_user_p text, ie_classification_p text, ds_damage_p text, ds_damage_brief_p text, ds_text_hist_default_p text, ie_platform_p text, nr_seq_ordem_serv_p INOUT bigint) FROM PUBLIC;

