-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_custo_procedimento ( cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, cd_tabela_custo_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, vl_procedimento_p bigint, vl_custo_oper_p bigint, vl_medico_p bigint, vl_material_p bigint, ie_apuracao_custo_p INOUT text, vl_custo_p INOUT bigint, vl_custo_variavel_p INOUT bigint, vl_custo_sadt_p INOUT bigint, vl_custo_dir_apoio_p INOUT bigint, vl_custo_mao_obra_p INOUT bigint, vl_custo_direto_p INOUT bigint, vl_custo_indireto_p INOUT bigint, vl_despesa_p INOUT bigint, vl_custo_hm_p INOUT bigint, pr_imposto_p INOUT bigint, dt_custo_p timestamp, vl_repasse_terceiro_p bigint, vl_original_p bigint, vl_repasse_calc_p bigint, ie_tipo_atendimento_p bigint, vl_preco_calculado_p INOUT bigint, nr_interno_conta_p bigint, ie_gerar_log_p text, nr_seq_item_p bigint, qt_resumo_p bigint, ie_responsavel_credito_p text) AS $body$
DECLARE


cd_area_procedimento_w			bigint;
cd_especialidade_w			bigint;
cd_grupo_proc_w				bigint;
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
cd_setor_atendimento_w			bigint	:= cd_setor_atendimento_p;
cd_edicao_amb_w				integer;
dt_inicio_vigencia_w			timestamp;
nr_seq_exame_w				bigint;
nr_seq_forma_org_w			bigint;
nr_seq_subgrupo_w			bigint;
nr_seq_grupo_w				bigint;
nr_seq_proc_interno_w			bigint;
qt_exame_w				bigint;
vl_custo_w				double precision	:= 0;
pr_aplicar_w				double precision	:= 100;
pr_medico_w				double precision	:= 100;
pr_custo_oper_w				double precision	:= 100;
pr_material_w				double precision	:= 100;
ie_calculo_custo_w			varchar(1)	:= 'S';
vl_custo_variavel_w			double precision	:= 0;
vl_custo_sadt_w				double precision	:= 0;
vl_custo_dir_apoio_w			double precision	:= 0;
vl_custo_mao_obra_w			double precision	:= 0;
vl_custo_direto_w			double precision	:= 0;
vl_custo_indireto_w			double precision	:= 0;
vl_despesa_w				double precision	:= 0;
vl_custo_hm_w				double precision	:= 0;
ie_custo_hm_w				varchar(01)	:= 'S';
pr_imposto_w				double precision	:= 0;
ie_tipo_atendimento_w			smallint;
cd_proc_custo_w				bigint;
ie_origem_proc_custo_w			bigint;
pr_custo_indireto_fixo_w		double precision;
pr_despesa_fixa_w			double precision;
vl_preco_calculado_w			double precision;
vl_custo_aux_w				double precision	:= 0;
cd_estab_execucao_w			estabelecimento.cd_estabelecimento%type;
cd_estab_custo_w			estabelecimento.cd_estabelecimento%type;
cd_tabela_custo_w			tabela_custo.cd_tabela_custo%type := cd_tabela_custo_p;
ie_somente_tab_real_w			parametro_custo.ie_somente_tab_real%type;
ds_log_w				varchar(4000);

c01 CURSOR FOR
SELECT	ie_calculo_custo,
	cd_edicao_amb,
	coalesce(pr_aplicar,100),
	coalesce(pr_custo_oper,100),
	coalesce(pr_medico,100),
	coalesce(pr_material,100),
	coalesce(vl_custo,0),
	coalesce(cd_proc_custo,cd_procedimento_p),
	coalesce(ie_origem_proc_custo, ie_origem_proced_p),
	coalesce(ie_custo_hm,'S'),
	coalesce(pr_imposto,0),
	cd_proc_custo,
	ie_origem_proc_custo
from	regra_aloc_custo_setor
where	cd_setor_atendimento	= cd_setor_atendimento_w
and	cd_estabelecimento	= cd_estab_custo_w
and	coalesce(cd_convenio, cd_convenio_p)				= cd_convenio_p
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w)		= ie_tipo_atendimento_w
and	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and	coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and	coalesce(cd_grupo_proc, cd_grupo_proc_w) 		  	= cd_grupo_proc_w
and	coalesce(cd_procedimento, cd_procedimento_p) 		= cd_procedimento_p
and	coalesce(nr_seq_forma_org, nr_seq_forma_org_w)		= nr_seq_forma_org_w
and	coalesce(nr_seq_grupo, nr_seq_grupo_w)			= nr_seq_grupo_w
and	coalesce(nr_seq_subgrupo, nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
and	coalesce(nr_seq_exame, nr_seq_exame_w)			= nr_seq_exame_w
and	coalesce(nr_seq_proc_interno, nr_seq_proc_interno_w)		= nr_seq_proc_interno_w
and	coalesce(ie_origem_proced, ie_origem_proced_p)		= ie_origem_proced_p
and (coalesce(cd_area_procedimento, 0) + coalesce(cd_especialidade, 0) + coalesce(cd_grupo_proc, 0) + coalesce(cd_procedimento, 0) + coalesce(nr_seq_exame,0) +
	coalesce(nr_seq_grupo,0) + coalesce(nr_seq_subgrupo,0) + coalesce(nr_seq_forma_org,0) + coalesce(nr_seq_proc_interno, 0)) > 0
and (coalesce(dt_inicio_vigencia, dt_custo_p) <= dt_custo_p and coalesce(dt_fim_vigencia, dt_custo_p) >= dt_custo_p)
and	coalesce(ie_responsavel_credito, coalesce(ie_responsavel_credito_p,'0')) = coalesce(ie_responsavel_credito_p,'0')
order by 	coalesce(ie_responsavel_credito,'A'),
		coalesce(cd_convenio,0),
		coalesce(nr_seq_exame,0),
		coalesce(nr_seq_proc_interno,0),
		coalesce(cd_procedimento,0),
		coalesce(nr_seq_forma_org,0),
		coalesce(nr_seq_subgrupo,0),
		coalesce(nr_seq_grupo,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade,0),
		coalesce(cd_area_procedimento,0),
		coalesce(ie_tipo_atendimento,0);


BEGIN

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') and (ie_gerar_log_p = 'S') then
	insert into cus_log_custo_item(
			nr_sequencia,
			nr_seq_item,
			nr_interno_conta,
			nm_usuario,
			ie_informacao,
			dt_atualizacao,
			ds_log,
			ie_tipo)
	values (	nextval('cus_log_custo_item_seq'),
			nr_seq_item_p,
			nr_interno_conta_p,
			wheb_usuario_pck.get_nm_usuario,
			0,
			clock_timestamp(),
			'++Procedure OBTER_CUSTO_PROCEDIMENTO'
,
			3);
end if;

ie_tipo_atendimento_w	:= coalesce(ie_tipo_atendimento_p,1);
cd_procedimento_w	:= cd_procedimento_p;
ie_origem_proced_w	:= ie_origem_proced_p;
nr_seq_exame_w		:= coalesce(nr_seq_exame_p,0);
nr_seq_proc_interno_w	:= coalesce(nr_seq_proc_interno_p,0);

/* Matheus 10/07/2008 Controle Setor de Custo*/

select	coalesce(max(cd_setor_custo),cd_setor_atendimento_p)
into STRICT	cd_setor_atendimento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_p;

--estabelecimento do setor de execucao (setor do conta_paciente_resumo)
select	coalesce(max(cd_estabelecimento_base),cd_estabelecimento_p)
into STRICT	cd_estab_execucao_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_p;

--estabelecimento do setor de custo
select	coalesce(max(cd_estabelecimento_base),cd_estabelecimento_p)
into STRICT	cd_estab_custo_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_w;

begin
select	ie_somente_tab_real
into STRICT	ie_somente_tab_real_w
from 	parametro_custo
where	cd_estabelecimento = cd_estabelecimento_p;
exception when others then
	ie_somente_tab_real_w := 'N';
end;

if (cd_estab_execucao_w <> cd_estab_custo_w)	then
	select	max(cd_tabela_custo)
	into STRICT	cd_tabela_custo_w
	from	tabela_custo
	where	dt_mes_referencia 	= ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_custo_p)
	and	cd_tipo_tabela_custo	= 9
	and	cd_estabelecimento	= cd_estab_custo_w
	and ie_situacao = 'A'
	and 	((ie_somente_tab_real_w = 'N') or (ie_somente_tab_real_w = 'S' AND ie_orcado_real = 'R'));
end	if;

/* Matheus OS86615 31-03-2008 Coloquei a estrutura do SUS buscar e no cursor*/

begin
select 	cd_area_procedimento,
	cd_especialidade,
	cd_grupo_proc,
	coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, 'C', 'G'),'G'),1,10),0),
	coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, 'C', 'S'),'S'),1,10),0),
	coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, 'C', 'F'),'F'),1,10),0)
into STRICT	cd_area_procedimento_w,
	cd_especialidade_w,
	cd_grupo_proc_w,
	nr_seq_grupo_w,
	nr_seq_subgrupo_w,
	nr_seq_forma_org_w
from 	estrutura_procedimento_v
where 	cd_procedimento	= cd_procedimento_p
and 	ie_origem_proced	= ie_origem_proced_p;
exception when others then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(204368, 'CD_PROCED=' || cd_procedimento_p || ';IE_ORIGEM_PROCED=' || ie_origem_proced_p);
end;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') and (ie_gerar_log_p = 'S') then
	ds_log_w	:= ';cd_estabelecimento_p='||cd_estabelecimento_p||
			   ';cd_procedimento_p='||cd_procedimento_p||
			   ';ie_origem_proced_p='||ie_origem_proced_p||
			   ';nr_seq_proc_interno_p='||nr_seq_proc_interno_p||
			   ';nr_seq_exame_p='||nr_seq_exame_p||
			   ';cd_tabela_custo_p='||cd_tabela_custo_p||
			   ';cd_convenio_p='||cd_convenio_p||
			   ';cd_setor_Atendimento_p='||cd_setor_Atendimento_p||
			   ';vl_procedimento_p='||vl_procedimento_p||
			   ';vl_Custo_Oper_p='||vl_Custo_Oper_p||
			   ';vl_Medico_p='||vl_Medico_p||
			   ';vl_Material_p='||vl_Material_p||
			   ';ie_apuracao_custo_p='||ie_apuracao_custo_p ||
			   ';vl_custo_p='||vl_custo_p||
			   ';vl_custo_variavel_p='||vl_custo_variavel_p||
			   ';vl_custo_sadt_p='||vl_custo_sadt_p||
			   ';vl_custo_dir_apoio_p='||vl_custo_dir_apoio_p||
			   ';vl_custo_mao_obra_p='||vl_custo_mao_obra_p||
			   ';vl_custo_direto_p='||vl_custo_direto_p||
			   ';vl_custo_indireto_p='||vl_custo_indireto_p||
			   ';vl_Despesa_p='||vl_Despesa_p||
			   ';vl_custo_hm_p='||vl_custo_hm_p||
			   ';pr_imposto_p='||pr_imposto_p||
			   ';dt_custo_p='||dt_custo_p||
			   ';vl_repasse_terceiro_p='||vl_repasse_terceiro_p||
			   ';vl_original_p='||vl_original_p||
			   ';vl_repasse_calc_p='||vl_repasse_calc_p||
			   ';ie_tipo_atendimento_p='||ie_tipo_atendimento_p||
			   ';vl_preco_calculado_p='||vl_preco_calculado_p ||
			   ';nr_interno_conta_p='||nr_interno_conta_p;

	insert into cus_log_custo_item(
			nr_sequencia,
			nr_seq_item,
			nr_interno_conta,
			nm_usuario,
			ie_informacao,
			dt_atualizacao,
			ds_log,
			ie_tipo)
	values (	nextval('cus_log_custo_item_seq'),
			nr_seq_item_p,
			nr_interno_conta_p,
			wheb_usuario_pck.get_nm_usuario,
			1,
			clock_timestamp(),
			substr(ds_log_w,1,4000),
			3);

	ds_log_w :=	   ';cd_setor_atendimento_w='||cd_setor_atendimento_w||
			   ';cd_estab_execucao_w='||cd_estab_execucao_w||
			   ';cd_estab_custo_w='||cd_estab_custo_w||
			   ';ie_somente_tab_real_w='||ie_somente_tab_real_w||
			   ';cd_tabela_custo_w='||cd_tabela_custo_w||
			   ';cd_area_procedimento_w='||cd_area_procedimento_w||
			   ';cd_especialidade_w='||cd_especialidade_w||
			   ';cd_grupo_proc_w='||cd_grupo_proc_w||
			   ';nr_seq_grupo_w='||nr_seq_grupo_w||
			   ';nr_seq_subgrupo_w='||nr_seq_subgrupo_w||
			   ';nr_seq_forma_org_w='||nr_seq_forma_org_w;

	insert into cus_log_custo_item(
			nr_sequencia,
			nr_seq_item,
			nr_interno_conta,
			nm_usuario,
			ie_informacao,
			dt_atualizacao,
			ds_log,
			ie_tipo)
	values (	nextval('cus_log_custo_item_seq'),
			nr_seq_item_p,
			nr_interno_conta_p,
			wheb_usuario_pck.get_nm_usuario,
			1,
			clock_timestamp(),
			substr(ds_log_w,1,4000),
			3);
end if;

open c01;
loop
fetch c01 into
	ie_calculo_custo_w,
	cd_edicao_amb_w,
	pr_aplicar_w,
	pr_custo_oper_w,
	pr_medico_w,
	pr_material_w,
	vl_custo_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_custo_hm_w,
	pr_imposto_w,
	cd_proc_custo_w,
	ie_origem_proc_custo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_calculo_custo_w	:= ie_calculo_custo_w;
end loop;
close c01;

vl_custo_variavel_w	:= 0;
vl_custo_sadt_w		:= 0;
vl_custo_dir_apoio_w	:= 0;
vl_custo_mao_obra_w	:= 0;
vl_custo_direto_w	:= 0;
vl_custo_indireto_w	:= 0;
vl_despesa_w		:= 0;
vl_custo_hm_w		:= 0;
vl_preco_calculado_w	:= 0;


if ( vl_custo_w 	= 0) and
	((ie_calculo_custo_w = 'S') or (ie_calculo_custo_w = 'T')) then
	begin

	if (nr_seq_proc_interno_w > 0) and (coalesce(cd_proc_custo_w::text, '') = '') then
		begin
		begin
		select	vl_preco_calculado,
			vl_Custo_Variavel,
			vl_Custo_dir_apoio,
			vl_Custo_mao_obra,
			vl_Custo_Direto_Fixo,
			vl_Custo_indireto,
			vl_Despesa,
			vl_custo_hm,
			pr_custo_indireto_fixo,
			pr_despesa_fixa
		into STRICT	vl_preco_calculado_w,
			vl_Custo_Variavel_w,
			vl_Custo_dir_apoio_w,
			vl_Custo_mao_obra_w,
			vl_Custo_Direto_w,
			vl_Custo_indireto_w,
			vl_Despesa_w,
			vl_custo_hm_w,
			pr_custo_indireto_fixo_w,
			pr_despesa_fixa_w
		from (
			SELECT	coalesce(vl_preco_calculado,0) vl_preco_calculado,
				coalesce(vl_Custo_Variavel,0) vl_Custo_Variavel,
				coalesce(vl_Custo_dir_apoio,0) vl_Custo_dir_apoio,
				coalesce(vl_Custo_mao_obra,0) vl_Custo_mao_obra,
				coalesce(vl_Custo_Direto_Fixo,0) vl_Custo_Direto_Fixo,
				coalesce(vl_Custo_indireto,0) vl_Custo_indireto,
				coalesce(vl_Despesa,0) vl_Despesa,
				coalesce(vl_custo_hm,0) vl_custo_hm,
				coalesce(pr_custo_indireto_fixo,0) pr_custo_indireto_fixo,
				coalesce(pr_despesa_fixa,0) pr_despesa_fixa
			from	preco_padrao_proc
			where	cd_estabelecimento	= cd_estab_custo_w
			and	cd_tabela_custo		= cd_tabela_custo_w
			and	nr_seq_proc_interno	= nr_seq_proc_interno_w
			and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
			and	ie_calcula_conta	= 'S'
			order by cd_setor_atendimento desc nulls last
			) alias18 LIMIT 1;
		
		exception
		when no_data_found then
			vl_preco_calculado_w := 0;
			vl_Custo_Variavel_w := 0;
			vl_Custo_dir_apoio_w := 0;
			vl_Custo_mao_obra_w := 0;
			vl_Custo_Direto_w := 0;
			vl_Custo_indireto_w := 0;
			vl_Despesa_w := 0;
			vl_custo_hm_w := 0;
			pr_custo_indireto_fixo_w := 0;
			pr_despesa_fixa_w := 0;
		end;

		begin
		vl_custo_w	:= coalesce((( vl_custo_variavel_w + vl_custo_direto_w ) *
					    (1 + pr_custo_indireto_fixo_w /100 + pr_despesa_fixa_w/100)),0);
		exception when others then
			vl_custo_w	:= 0;
		end;

		if (vl_custo_w = 0) then
			vl_custo_w	:= vl_preco_calculado_w;
		end if;

		end;

	end if;


	if (coalesce(nr_seq_proc_interno_w,0) = 0) or (vl_custo_w = 0) then
		begin
		begin
		select	vl_preco_calculado,
			vl_Custo_Variavel,
			vl_Custo_dir_apoio,
			vl_Custo_mao_obra,
			vl_Custo_Direto_Fixo,
			vl_Custo_indireto,
			vl_Despesa,
			vl_custo_hm,
			pr_custo_indireto_fixo,
			pr_despesa_fixa
		into STRICT	vl_preco_calculado_w,
			vl_Custo_Variavel_w,
			vl_Custo_dir_apoio_w,
			vl_Custo_mao_obra_w,
			vl_Custo_Direto_w,
			vl_Custo_indireto_w,
			vl_Despesa_w,
			vl_custo_hm_w,
			pr_custo_indireto_fixo_w,
			pr_despesa_fixa_w
		from (
			SELECT	coalesce(vl_preco_calculado,0) vl_preco_calculado,
				coalesce(vl_Custo_Variavel,0) vl_Custo_Variavel,
				coalesce(vl_Custo_dir_apoio,0) vl_Custo_dir_apoio,
				coalesce(vl_Custo_mao_obra,0) vl_Custo_mao_obra,
				coalesce(vl_Custo_Direto_Fixo,0) vl_Custo_Direto_Fixo,
				coalesce(vl_Custo_indireto,0) vl_Custo_indireto,
				coalesce(vl_Despesa,0) vl_Despesa,
				coalesce(vl_custo_hm,0) vl_custo_hm,
				coalesce(pr_custo_indireto_fixo,0) pr_custo_indireto_fixo,
				coalesce(pr_despesa_fixa,0) pr_despesa_fixa
			from	preco_padrao_proc
			where	cd_estabelecimento	= cd_estab_custo_w
			and	cd_tabela_custo		= cd_tabela_custo_w
			and	ie_origem_proced	= ie_origem_proced_w
			and	cd_procedimento		= cd_procedimento_w
			and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
			and	ie_calcula_conta	= 'S'
			order by cd_setor_atendimento desc nulls last
			) alias14 LIMIT 1;

		exception
		when no_data_found then
			vl_preco_calculado_w := 0;
			vl_Custo_Variavel_w := 0;
			vl_Custo_dir_apoio_w := 0;
			vl_Custo_mao_obra_w := 0;
			vl_Custo_Direto_w := 0;
			vl_Custo_indireto_w := 0;
			vl_Despesa_w := 0;
			vl_custo_hm_w := 0;
			pr_custo_indireto_fixo_w := 0;
			pr_despesa_fixa_w := 0;
		end;

		begin
		vl_custo_w	:= coalesce(((vl_custo_variavel_w + vl_custo_direto_w) *
					    (1 + pr_custo_indireto_fixo_w /100 + pr_despesa_fixa_w/100)),0);
		exception when others then
			vl_custo_w	:= 0;
		end;

		if (vl_custo_w = 0) then
			vl_custo_w	:= vl_preco_calculado_w;
		end if;
		end;

	end if;
	/* Tratamento para calcular o custo por exame*/

	if (nr_seq_exame_w <> 0) then

		select	count(*)
		into STRICT	qt_exame_w
		from	preco_padrao_proc
		where	cd_estabelecimento	= cd_estab_custo_w
		and	cd_tabela_custo		= cd_tabela_custo_w
		and	nr_seq_exame		= nr_seq_exame_w
		and	ie_calcula_conta	= 'S';

		if (qt_exame_w > 0) then
			begin
			begin
			select	vl_preco_calculado,
				vl_Custo_Variavel,
				vl_Custo_dir_apoio,
				vl_Custo_mao_obra,
				vl_Custo_Direto_Fixo,
				vl_Custo_indireto,
				vl_Despesa,
				vl_custo_hm,
				pr_custo_indireto_fixo,
				pr_despesa_fixa
			into STRICT	vl_preco_calculado_w,
				vl_Custo_Variavel_w,
				vl_Custo_dir_apoio_w,
				vl_Custo_mao_obra_w,
				vl_Custo_Direto_w,
				vl_Custo_indireto_w,
				vl_Despesa_w,
				vl_custo_hm_w,
				pr_custo_indireto_fixo_w,
				pr_despesa_fixa_w
			from (
				SELECT	coalesce(vl_preco_calculado,0) vl_preco_calculado,
					coalesce(vl_Custo_Variavel,0) vl_Custo_Variavel,
					coalesce(vl_Custo_dir_apoio,0) vl_Custo_dir_apoio,
					coalesce(vl_Custo_mao_obra,0) vl_Custo_mao_obra,
					coalesce(vl_Custo_Direto_Fixo,0) vl_Custo_Direto_Fixo,
					coalesce(vl_Custo_indireto,0) vl_Custo_indireto,
					coalesce(vl_Despesa,0) vl_Despesa,
					coalesce(vl_custo_hm,0) vl_custo_hm,
					coalesce(pr_custo_indireto_fixo,0) pr_custo_indireto_fixo,
					coalesce(pr_despesa_fixa,0) pr_despesa_fixa
				from	preco_padrao_proc
				where	cd_estabelecimento	= cd_estab_custo_w
				and	cd_tabela_custo		= cd_tabela_custo_w
				and	nr_seq_exame		= nr_seq_exame_w
				and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
				and	ie_calcula_conta	= 'S'
				order by cd_setor_atendimento desc nulls last
				) alias12 LIMIT 1;	
			
			exception
			when no_data_found then
				vl_preco_calculado_w := 0;
				vl_Custo_Variavel_w := 0;
				vl_Custo_dir_apoio_w := 0;
				vl_Custo_mao_obra_w := 0;
				vl_Custo_Direto_w := 0;
				vl_Custo_indireto_w := 0;
				vl_Despesa_w := 0;
				vl_custo_hm_w := 0;
				pr_custo_indireto_fixo_w := 0;
				pr_despesa_fixa_w := 0;
			end;

			begin
			vl_custo_w	:= coalesce(((vl_custo_variavel_w + vl_custo_direto_w) *
						    (1 + pr_custo_indireto_fixo_w /100 + pr_despesa_fixa_w/100)),0);
			exception when others then
				vl_custo_w	:= 0;
			end;
			end;
		end if;

	end if;


	exception when others then
		vl_custo_w		:= 0;
	end;

else
	vl_custo_direto_w		:= vl_custo_w;
end if;
/*	ie_calculo_custo
	S - Obter o Custo da Tabela de Custo *
	P - Percentual sobre o Total do Procedimento
	F - Tabela de preco do faturamento
	R - Valor de repasse VL_REPASSE_TERCEIRO *
*/
if ( ie_calculo_custo_w = 'P') then
	begin
	ie_apuracao_custo_p		:= 'P';
	if (pr_aplicar_w > 0) then
		vl_custo_w 	:= pr_aplicar_w * vl_procedimento_p / 100;
	else
		vl_custo_w 	:= (pr_custo_oper_w * vl_custo_oper_p / 100) +
		 		(pr_medico_w * vl_medico_p / 100) +
			 	(pr_material_w * vl_material_p / 100);
	end if;
	vl_custo_sadt_w		:= vl_custo_w;
	vl_custo_p		:= vl_custo_w;
	end;
elsif ( ie_calculo_custo_w = 'S') then
	begin
	vl_custo_p		:= ( vl_custo_w * pr_aplicar_w / 100);
	vl_custo_variavel_w	:= (vl_custo_variavel_w * pr_aplicar_w / 100);
	vl_custo_dir_apoio_w	:= (vl_custo_dir_apoio_w * pr_aplicar_w / 100);
	vl_custo_mao_obra_w	:= (vl_custo_mao_obra_w * pr_aplicar_w / 100);
	vl_custo_direto_w	:= (vl_custo_direto_w * pr_aplicar_w / 100);
	vl_custo_indireto_w	:= (vl_custo_indireto_w * pr_aplicar_w / 100);
	vl_despesa_w		:= (vl_despesa_w * pr_aplicar_w / 100);
	vl_custo_hm_w		:= (vl_custo_hm_w * pr_aplicar_w / 100);
	end;
elsif ( ie_calculo_custo_w = 'F') then /* Tabela AMB*/
	begin
	/* Obter a maior vigencia */

	select	max(coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days'))
	into STRICT	dt_inicio_vigencia_w
	from  	preco_amb b
	where	b.cd_edicao_amb	= cd_edicao_amb_w
	and	b.cd_procedimento	= cd_procedimento_p
	and	b.ie_origem_proced	= ie_origem_proced_p
	and	coalesce(b.dt_inicio_vigencia,clock_timestamp() - interval '3650 days') <= dt_custo_p;
	/* obter o valor */

	select	coalesce(max(a.vl_procedimento),0)
	into STRICT	vl_custo_w
	from	preco_amb a
	where	cd_edicao_amb	= cd_edicao_amb_w
	and	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p
	and	coalesce(dt_inicio_vigencia,dt_inicio_vigencia_w) 	= dt_inicio_vigencia_w;
	vl_custo_w			:= dividir(pr_aplicar_w * vl_custo_w,100);
	vl_custo_sadt_w			:= vl_custo_w;
	vl_custo_p			:= vl_custo_w;
	end;
elsif (ie_calculo_custo_w in ('R','O','C')) then /* Valor de repasse e Valor original*/
	begin
	if (ie_calculo_custo_w = 'R') then
		vl_custo_w			:= coalesce(vl_repasse_terceiro_p,0);
	elsif (ie_calculo_custo_w = 'C') then
		vl_custo_w			:= coalesce(vl_repasse_calc_p,0);
	else
		vl_custo_w			:= coalesce(vl_original_p,vl_procedimento_p);
	end if;
	vl_custo_w			:= dividir(pr_aplicar_w * vl_custo_w,100);
	vl_custo_sadt_w			:= vl_custo_w;
	vl_custo_p			:= vl_custo_w;
	ie_apuracao_custo_p			:= 'P';
	end;
elsif (ie_calculo_custo_w = 'T') then /*soma do custo da tabela e repasse calculado*/
	begin

		begin
			vl_custo_w	:= coalesce(((vl_custo_variavel_w + vl_custo_direto_w) *
					    (1 + pr_custo_indireto_fixo_w /100 + pr_despesa_fixa_w/100)),0);
		exception when others then
			vl_custo_w	:= 0;
		end;

		if (vl_custo_w = 0) then
			vl_custo_w	:= vl_preco_calculado_w;
		end if;

	vl_custo_aux_w		:= ( vl_custo_w * pr_aplicar_w / 100);

	vl_custo_variavel_w	:= (vl_custo_variavel_w * pr_aplicar_w / 100);
	vl_custo_dir_apoio_w	:= (vl_custo_dir_apoio_w * pr_aplicar_w / 100);
	vl_custo_mao_obra_w	:= (vl_custo_mao_obra_w * pr_aplicar_w / 100);
	vl_custo_direto_w	:= (vl_custo_direto_w * pr_aplicar_w / 100);
	vl_custo_indireto_w	:= (vl_custo_indireto_w * pr_aplicar_w / 100);
	vl_despesa_w		:= (vl_despesa_w * pr_aplicar_w / 100);
	vl_custo_hm_w		:= (vl_custo_hm_w * pr_aplicar_w / 100);

	vl_custo_w		:= coalesce(vl_repasse_calc_p,0);

	vl_custo_w		:= dividir(pr_aplicar_w * vl_custo_w,100);
	vl_custo_sadt_w		:= vl_custo_w;
	vl_custo_w		:= vl_custo_w + vl_custo_aux_w;

	if (coalesce(qt_resumo_p,0) > 1) then
		begin
		vl_custo_aux_w		:= round((qt_resumo_p * vl_custo_aux_w)::numeric, 2);
		vl_custo_variavel_w	:= round((qt_resumo_p * vl_custo_variavel_w)::numeric, 2);
		vl_custo_dir_apoio_w	:= qt_resumo_p * vl_custo_dir_apoio_w;
		vl_custo_mao_obra_w	:= qt_resumo_p * vl_custo_mao_obra_w;
		vl_custo_direto_w	:= qt_resumo_p * vl_custo_direto_w;
		vl_custo_indireto_w	:= qt_resumo_p * vl_custo_Indireto_w;
		vl_despesa_w		:= qt_resumo_p * vl_despesa_w;
		vl_custo_hm_w		:= qt_resumo_p * vl_custo_hm_w;

		vl_custo_w		:= vl_custo_aux_w + dividir(pr_aplicar_w * coalesce(vl_repasse_calc_p,0),100);
		vl_custo_sadt_w		:= vl_custo_sadt_w;
		ie_apuracao_custo_p	:= 'P';
		end;
	end if;

	vl_custo_p := vl_custo_w;

	end;
else
	vl_custo_p			:= 0;
end if;

vl_custo_variavel_p	:= vl_custo_variavel_w;
vl_custo_sadt_p		:= vl_custo_sadt_w;
vl_custo_dir_apoio_p	:= vl_custo_dir_apoio_w;
vl_custo_mao_obra_p	:= vl_custo_mao_obra_w;
vl_custo_direto_p	:= vl_custo_direto_w;
vl_custo_indireto_p	:= vl_custo_indireto_w;
vl_Despesa_p		:= vl_despesa_w;
pr_imposto_p		:= pr_imposto_w;
vl_preco_calculado_p	:= vl_preco_calculado_w;

if (ie_custo_hm_w = 'S') then
	vl_custo_hm_p		:= vl_custo_hm_w;
else
	vl_custo_hm_p		:= 0;
end if;

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') and (ie_gerar_log_p = 'S') then
	ds_log_w :=	';ie_calculo_custo_w='||ie_calculo_custo_w||
			';vl_custo_variavel_p='||vl_custo_variavel_p||
			';vl_custo_sadt_p='||vl_custo_sadt_p||
			';vl_custo_dir_apoio_p='||vl_custo_dir_apoio_p||
			';vl_custo_mao_obra_p='||vl_custo_mao_obra_p||
			';vl_custo_direto_p='||vl_custo_direto_p||
			';vl_custo_indireto_p='||vl_custo_indireto_p||
			';vl_Despesa_p='||vl_Despesa_p||
			';pr_imposto_p='||pr_imposto_p||
			';vl_preco_calculado_p='||vl_preco_calculado_p||
			';vl_custo_w='||vl_custo_w;

	insert into cus_log_custo_item(
			nr_sequencia,
			nr_seq_item,
			nr_interno_conta,
			nm_usuario,
			ie_informacao,
			dt_atualizacao,
			ds_log,
			ie_tipo)
	values (	nextval('cus_log_custo_item_seq'),
			nr_seq_item_p,
			nr_interno_conta_p,
			wheb_usuario_pck.get_nm_usuario,
			4,
			clock_timestamp(),
			substr(ds_log_w,1,4000),
			3);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_custo_procedimento ( cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, cd_tabela_custo_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, vl_procedimento_p bigint, vl_custo_oper_p bigint, vl_medico_p bigint, vl_material_p bigint, ie_apuracao_custo_p INOUT text, vl_custo_p INOUT bigint, vl_custo_variavel_p INOUT bigint, vl_custo_sadt_p INOUT bigint, vl_custo_dir_apoio_p INOUT bigint, vl_custo_mao_obra_p INOUT bigint, vl_custo_direto_p INOUT bigint, vl_custo_indireto_p INOUT bigint, vl_despesa_p INOUT bigint, vl_custo_hm_p INOUT bigint, pr_imposto_p INOUT bigint, dt_custo_p timestamp, vl_repasse_terceiro_p bigint, vl_original_p bigint, vl_repasse_calc_p bigint, ie_tipo_atendimento_p bigint, vl_preco_calculado_p INOUT bigint, nr_interno_conta_p bigint, ie_gerar_log_p text, nr_seq_item_p bigint, qt_resumo_p bigint, ie_responsavel_credito_p text) FROM PUBLIC;

