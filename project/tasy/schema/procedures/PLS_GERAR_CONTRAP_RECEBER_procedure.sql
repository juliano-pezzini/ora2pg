-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_contrap_receber ( nr_seq_reg_auxiliar_p ctb_livro_auxiliar.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

					
vl_tributo_w					titulo_receber_trib.vl_tributo%type;
ie_idade_saldo_w				varchar(255);
ds_idade_saldo_w				varchar(255);
ds_observacao_w					varchar(255);
vl_receber_w					double precision;
nr_contador_w 					bigint := 0;
nr_dias_vencimento_w				bigint;
ie_gerar_ind_classif_w				ctb_livro_auxiliar.ie_gerar_ind_classif%type;
nr_seq_contra_emit_w				pls_aux_contrap_receber.nr_sequencia%type;
dt_inicial_w					ctb_livro_auxiliar.dt_inicial%type;
dt_final_w					ctb_livro_auxiliar.dt_final%type;
dt_liberacao_w					ctb_livro_auxiliar.dt_liberacao%type;
ie_classificacao_w				ctb_livro_auxiliar.ie_classificacao%type;
nr_seq_contrato_w				pls_contrato.nr_sequencia%type;
ie_tipo_segurado_w				ctb_livro_auxiliar.ie_tipo_segurado%type;
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;
ie_data_rec_faturamento_w			pls_parametro_contabil.ie_data_rec_faturamento%type;

type vetor_ctb_aux_contra_emit is table of pls_aux_contrap_receber%rowtype index by integer;
ctb_aux_contra_emit_w	vetor_ctb_aux_contra_emit;

c_titulo CURSOR FOR
	SELECT 	p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_preco ie_modalidade_contrat,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_deb cd_conta_contabil,
		sum(dividir((t.vl_titulo * i.vl_item),m.vl_mensalidade)) vl_apropriado,
		round(sum(dividir((obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) * i.vl_item),m.vl_mensalidade) - (SELECT coalesce(sum(coalesce(e.vl_tributo,0)),0) FROM i
LEFT OUTER JOIN pls_mensalidade_trib e ON (i.nr_sequencia = e.nr_seq_item_mens) )),2) vl_parcela,
		round(sum((select coalesce(z.vl_item,0)
			from	pls_mensalidade			x,
				pls_mensalidade_segurado	y,
				pls_mensalidade_seg_item	z
			where	x.nr_sequencia = y.nr_seq_mensalidade
			and	y.nr_sequencia = z.nr_seq_mensalidade_seg
			and	z.nr_sequencia = i.nr_sequencia
			and	(z.cd_conta_contabil_ppcng IS NOT NULL AND z.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) / m.vl_mensalidade),2) vl_rec_cobertura,
		sum(i.vl_antecipacao) vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   t.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = i.nr_sequencia
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w)
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4')))
			and 	r.dt_recebimento < l.dt_mesano_referencia )) vl_fat_antec,
		s.nr_sequencia	nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		c.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		m.nr_seq_pagador,
		t.dt_contabil,
		s.ie_tipo_segurado,
		p.nr_protocolo_ans nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		null dt_ref_repasse,
		null nr_seq_congenere
	FROM titulo_receber t, pls_segurado s, pls_plano p, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_contrato c, pls_mensalidade_segurado a, pls_mensalidade m
LEFT OUTER JOIN nota_fiscal n ON (m.nr_sequencia = n.nr_seq_mensalidade)
WHERE l.nr_sequencia = m.nr_seq_lote and m.nr_sequencia = a.nr_seq_mensalidade and a.nr_sequencia = i.nr_seq_mensalidade_seg and m.nr_sequencia = t.nr_seq_mensalidade and p.nr_sequencia = s.nr_seq_plano and s.nr_sequencia = a.nr_seq_segurado and c.nr_sequencia = s.nr_seq_contrato  and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w)) and t.dt_contabil <= dt_final_w and t.ie_situacao <> '3' and ((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_deb in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A')) and m.vl_mensalidade <> 0 and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) group by p.ie_tipo_contratacao,
		p.ie_preco,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		i.cd_conta_deb,
		s.nr_sequencia,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),
		c.nr_sequencia,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),
		m.nr_seq_pagador,
		t.dt_contabil,
		s.ie_tipo_segurado,
		p.nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento
	
union all

	select 	p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_preco ie_modalidade_contrat,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		i.cd_conta_deb cd_conta_contabil,
		sum(dividir((t.vl_titulo * j.vl_item),m.vl_mensalidade)) vl_apropriado,
		round(sum(dividir((obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) * j.vl_item),m.vl_mensalidade) - (	select 	coalesce(sum(e.vl_tributo),0) 
																FROM i
LEFT OUTER JOIN pls_mensalidade_trib e ON (i.nr_sequencia = e.nr_seq_item_mens) )),2) vl_parcela,
		round(sum((	select	coalesce(sum(x.vl_item),0)
				from	pls_mensalidade_seg_item	y,
					pls_mensalidade_item_conta	x
				where	y.nr_sequencia	= x.nr_seq_item
				and	y.nr_sequencia	= i.nr_sequencia
				and	(y.cd_conta_contabil_ppcng IS NOT NULL AND y.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) / m.vl_mensalidade),2) vl_rec_cobertura,
		0 vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   t.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = i.nr_sequencia
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4')))
			and 	r.dt_recebimento < l.dt_mesano_referencia )) vl_fat_antec,
		s.nr_sequencia	nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		c.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		m.nr_seq_pagador,
		t.dt_contabil,
		s.ie_tipo_segurado,
		p.nr_protocolo_ans nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		null dt_ref_repasse,
		null nr_seq_congenere
	from	pls_mensalidade_item_conta	j,
		pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = s.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	i.nr_sequencia = j.nr_seq_item
	and	(j.nr_seq_conta_co IS NOT NULL AND j.nr_seq_conta_co::text <> '')
	and	i.ie_tipo_item = '13'
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	t.dt_contabil <= dt_final_w
	and	t.ie_situacao <> '3'
	and	((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_deb in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A'))
	and	m.vl_mensalidade <> 0
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	group by p.ie_tipo_contratacao,
		p.ie_preco,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		i.cd_conta_deb,
		s.nr_sequencia,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),
		c.nr_sequencia,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),
		m.nr_seq_pagador,
		t.dt_contabil,
		s.ie_tipo_segurado,
		p.nr_protocolo_ans,
		i.nr_sequencia,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento
	
union all

	select 	p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_preco ie_modalidade_contrat,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_deb cd_conta_contabil,
		sum(dividir((t.vl_titulo * d.vl_coparticipacao),m.vl_mensalidade)) vl_apropriado,		
		round(sum(dividir((obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) * d.vl_coparticipacao),m.vl_mensalidade) - (select coalesce(sum(coalesce(e.vl_tributo,0)),0) FROM i
LEFT OUTER JOIN pls_mensalidade_trib e ON (i.nr_sequencia = e.nr_seq_item_mens) )),2) vl_parcela,	
		round(sum((select coalesce(z.vl_item,0)
			from	pls_mensalidade			x,
				pls_mensalidade_segurado	y,
				pls_mensalidade_seg_item	z
			where	x.nr_sequencia = y.nr_seq_mensalidade
			and	y.nr_sequencia = z.nr_seq_mensalidade_seg
			and	z.nr_sequencia = i.nr_sequencia
			and	(z.cd_conta_contabil_ppcng IS NOT NULL AND z.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) / m.vl_mensalidade),2) vl_rec_cobertura,
		sum(i.vl_antecipacao) vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   t.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = i.nr_sequencia
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))) 
			and 	r.dt_recebimento < l.dt_mesano_referencia )) vl_fat_antec,	
		s.nr_sequencia	nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		c.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta 		f,
		pls_conta 			b,
		pls_conta_coparticipacao 	d
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = b.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	f.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = d.nr_seq_conta
	and	b.nr_sequencia = i.nr_seq_conta	
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > clock_timestamp()))
	and	t.dt_contabil <= clock_timestamp()
	and	((ie_gerar_ind_classif_w <> 'N')
	or	d.cd_conta_deb in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A'))
	and	m.vl_mensalidade <> 0
	and	((f.ie_tipo_protocolo		in ('CR','I')
	and	d.ie_status_coparticipacao	in ('D','S'))
	or (f.ie_tipo_protocolo		= 'R'
	and	d.ie_status_coparticipacao	<> 'N'))
	and	t.ie_situacao <> '3'
	and d.ie_status_mensalidade <> 'C'
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	group by p.ie_tipo_contratacao,
		p.ie_preco,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		d.cd_conta_deb,
		s.nr_sequencia,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),
		c.nr_sequencia,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.dt_mes_competencia,
		f.nr_seq_congenere
	
union all

	select 	p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_preco ie_modalidade_contrat,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_deb cd_conta_contabil,
		sum(dividir((t.vl_titulo * j.vl_item),m.vl_mensalidade)) vl_apropriado,		
		round(sum(dividir((obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) * j.vl_item),m.vl_mensalidade) - (	select 	coalesce(sum(e.vl_tributo),0) 
																FROM i
LEFT OUTER JOIN pls_mensalidade_trib e ON (i.nr_sequencia = e.nr_seq_item_mens) )),2) vl_parcela,	
		round(	sum((	select coalesce(z.vl_item,0)
				from	pls_mensalidade			x,
					pls_mensalidade_segurado	y,
					pls_mensalidade_seg_item	z
				where	x.nr_sequencia = y.nr_seq_mensalidade
				and	y.nr_sequencia = z.nr_seq_mensalidade_seg
				and	z.nr_sequencia = i.nr_sequencia
				and	(z.cd_conta_contabil_ppcng IS NOT NULL AND z.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) / m.vl_mensalidade),2) vl_rec_cobertura,
		sum(i.vl_antecipacao) vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   t.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = i.nr_sequencia
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))) 
			and 	r.dt_recebimento < l.dt_mesano_referencia )) vl_fat_antec,	
		s.nr_sequencia	nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		c.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta 		f,
		pls_conta 			b,
		pls_conta_coparticipacao 	d,
		pls_mensalidade_item_conta	j
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = b.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	f.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = d.nr_seq_conta
	and	b.nr_sequencia = i.nr_seq_conta	
	and	i.nr_sequencia	= j.nr_seq_item
	and	d.nr_sequencia	= j.nr_seq_conta_copartic
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	t.dt_contabil <= dt_final_w
	and	((ie_gerar_ind_classif_w <> 'N')
	or	d.cd_conta_deb in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A'))
	and	m.vl_mensalidade <> 0
	and	d.ie_status_coparticipacao <> 'N'
	and	t.ie_situacao <> '3'
	and d.ie_status_mensalidade <> 'C'
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	group by p.ie_tipo_contratacao,
		p.ie_preco,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		d.cd_conta_deb,
		s.nr_sequencia,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),
		c.nr_sequencia,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.dt_mes_competencia,
		f.nr_seq_congenere
	
union all

	select 	p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_preco ie_modalidade_contrat,
		a.dt_inicio_cobertura dt_inicio_cobertura,
		a.dt_fim_cobertura dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		d.cd_conta_deb cd_conta_contabil,
		sum(dividir((t.vl_titulo * j.vl_item),m.vl_mensalidade)) vl_apropriado,		
		round(sum(dividir((obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) * j.vl_item),m.vl_mensalidade) - (	select 	coalesce(sum(e.vl_tributo),0) 
																FROM i
LEFT OUTER JOIN pls_mensalidade_trib e ON (i.nr_sequencia = e.nr_seq_item_mens) )),2) vl_parcela,	
		round(	sum((	select coalesce(z.vl_item,0)
				from	pls_mensalidade			x,
					pls_mensalidade_segurado	y,
					pls_mensalidade_seg_item	z
				where	x.nr_sequencia = y.nr_seq_mensalidade
				and	y.nr_sequencia = z.nr_seq_mensalidade_seg
				and	z.nr_sequencia = i.nr_sequencia
				and	(z.cd_conta_contabil_ppcng IS NOT NULL AND z.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(t.nr_titulo, dt_final_w) / m.vl_mensalidade),2) vl_rec_cobertura,
		sum(i.vl_antecipacao) vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   t.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = i.nr_sequencia
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))) 
			and 	r.dt_recebimento < l.dt_mesano_referencia )) vl_fat_antec,	
		s.nr_sequencia	nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		c.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = d.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = d.nr_seq_conta_mat) END  dt_ref_repasse,
		f.nr_seq_congenere
	from	pls_lote_mensalidade 		l,
		pls_mensalidade 		m,
		pls_mensalidade_segurado 	a,
		pls_mensalidade_seg_item 	i,
		titulo_receber 			t,
		pls_segurado 			s,
		pls_contrato 			c,
		pls_plano 			p,
		pls_protocolo_conta 		f,
		pls_conta 			b,
		pls_conta_pos_estabelecido 	d,
		pls_mensalidade_item_conta	j
	where	l.nr_sequencia = m.nr_seq_lote
	and	m.nr_sequencia = a.nr_seq_mensalidade
	and	a.nr_sequencia = i.nr_seq_mensalidade_seg
	and	m.nr_sequencia = t.nr_seq_mensalidade
	and	p.nr_sequencia = b.nr_seq_plano
	and	s.nr_sequencia = a.nr_seq_segurado
	and	c.nr_sequencia = s.nr_seq_contrato
	and	f.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = d.nr_seq_conta
	and	b.nr_sequencia = i.nr_seq_conta	
	and	i.nr_sequencia	= j.nr_seq_item
	and	d.nr_sequencia	= j.nr_seq_conta_pos_estab
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	t.dt_contabil <= dt_final_w
	and	((ie_gerar_ind_classif_w <> 'N')
	or	d.cd_conta_deb in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A'))
	and	m.vl_mensalidade <> 0
	and	t.ie_situacao <> '3'
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(b.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X'))
	group by p.ie_tipo_contratacao,
		p.ie_preco,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		d.cd_conta_deb,
		s.nr_sequencia,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),
		c.nr_sequencia,
		substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
		substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),
		m.nr_seq_pagador,
		t.dt_contabil,
		b.ie_tipo_segurado,
		p.nr_protocolo_ans,
		c.dt_contrato,
		s.dt_contratacao,
		m.dt_cancelamento,
		d.nr_seq_conta_proc,
		d.nr_seq_conta_mat,
		f.dt_mes_competencia,
		f.nr_seq_congenere
	
union all

	select 	v.ie_tipo_contratacao ie_tipo_contratacao,
		v.ie_preco ie_modalidade_contrat,
		v.dt_inicio_cobertura dt_inicio_cobertura,
		v.dt_fim_cobertura dt_fim_cobertura,
		v.cd_beneficiario,
		v.nm_usuario_principal,
		v.nr_seq_conta nr_documento,
		v.nr_titulo,
		v.dt_emissao,
		v.dt_vencimento,
		v.cd_conta_debito,
		sum(dividir_sem_round((v.vl_titulo * v.vl_provisao),v.vl_mensalidade)) vl_apropriado,
		sum(dividir_sem_round((obter_saldo_titulo_receber(v.nr_titulo, dt_final_w) * v.vl_provisao),v.vl_mensalidade) - (	select 	coalesce(sum(e.vl_tributo),0) 
																	FROM v
LEFT OUTER JOIN pls_mensalidade_trib e ON (v.nr_seq_item_mens = e.nr_seq_item_mens) )) vl_parcela,
		sum(	(select coalesce(z.vl_item,0)
			from	pls_mensalidade			x,
				pls_mensalidade_segurado	y,
				pls_mensalidade_seg_item	z
			where	x.nr_sequencia = y.nr_seq_mensalidade
			and	y.nr_sequencia = z.nr_seq_mensalidade_seg
			and	z.nr_sequencia = v.nr_seq_item_mens
			and	(z.cd_conta_contabil_ppcng IS NOT NULL AND z.cd_conta_contabil_ppcng::text <> '')) * obter_saldo_titulo_receber(v.nr_titulo, dt_final_w) / v.vl_mensalidade) vl_rec_cobertura,
		sum(v.vl_antecipacao) vl_antecipado,
		sum((	select 	sum(q.vl_lancamento)
			from 	titulo_receber_liq r,
				pls_titulo_rec_liq_mens q,
				conta_contabil cc
			where   v.nr_titulo = r.nr_titulo
			and	r.nr_sequencia = q.nr_seq_baixa
			and	r.nr_titulo = q.nr_titulo
			and	q.nr_seq_item_mens = v.nr_seq_item_mens
			and	q.ie_tipo_lancamento = 'PR'
			and	q.cd_conta_credito = cc.cd_conta_contabil
			and	((substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
			or (substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))) 
			and 	r.dt_recebimento < v.dt_mesano_referencia )) vl_fat_antec,	
		v.nr_seq_segurado,
		v.cd_cpf_cnpj,
		v.nr_contrato,
		'CM' ie_tipo_documento,
		v.nr_parcela,
		substr(pls_obter_dados_pagador(v.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		v.nr_seq_pagador,
		v.dt_mesano_referencia dt_contabil,
		v.ie_tipo_segurado,
		v.nr_protocolo_ans,
		v.dt_contrato,
		v.dt_contratacao,
		v.dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = v.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  v.dt_ref_repasse  ELSE v.dt_mes_competencia END  dt_ref_repasse,
		v.nr_seq_congenere
	from	pls_conta_pos_estab_mens_v	v
	where	((coalesce(v.dt_liquidacao::text, '') = '')
	or (v.dt_liquidacao > dt_final_w))
	and	((ie_gerar_ind_classif_w <> 'N')
	or	(v.cd_conta_debito in (	select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
					or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
					and (ie_classificacao_w = 'A'))) 
					and	c.ie_tipo = 'A')))
	and	coalesce(cd_estabelecimento_p,v.cd_estabelecimento) = v.cd_estabelecimento
	and	v.vl_mensalidade <> 0
	and	v.ie_situacao <> '3'
	and	v.dt_mesano_referencia <= dt_final_w
	group by v.ie_tipo_contratacao,
		v.ie_preco,
		v.dt_inicio_cobertura,
		v.dt_fim_cobertura,
		v.cd_beneficiario,
		v.nm_usuario_principal,
		v.nr_seq_conta,
		v.nr_titulo,
		v.dt_emissao,
		v.dt_vencimento,
		v.cd_conta_debito,
		v.nr_seq_segurado,
		v.cd_cpf_cnpj,
		v.nr_contrato,
		v.nr_parcela,
		substr(pls_obter_dados_pagador(v.nr_seq_pagador,'N'),1,255),
		v.nr_seq_pagador,
		v.dt_mesano_referencia,
		v.ie_tipo_segurado,
		v.nr_protocolo_ans,
		v.dt_contrato,
		v.dt_contratacao,
		v.dt_cancelamento,
		v.dt_ref_repasse,
		v.dt_mes_competencia,
		v.nr_seq_congenere
	
union all

	select 	null ds_tipo_contratacao,
		null ds_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		null cd_beneficiario,
		null nm_usuario_principal,
		t.nr_titulo nr_documento,
		t.nr_titulo nr_titulo,
		t.dt_emissao dt_emissao,
		t.dt_vencimento dt_vencimento,
		f.cd_conta_contabil cd_conta_contabil,
		sum(coalesce(f.vl_classificacao,t.vl_titulo)) vl_apropriado,
		sum(obter_saldo_titulo_receber(t.nr_titulo, dt_final_w)) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		null nr_seq_segurado,
		null nr_cpf_cnpj,
		null nr_contrato,
		'TR' ie_tipo_documento,	
		null nr_parcela,
		null,
		null,
		t.dt_contabil,
		null ie_tipo_segurado,
		null nr_protocolo_ans,
		null dt_contrato,
		null dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = t.nr_titulo) dt_recebimento,
		null dt_ref_repasse,
		null nr_seq_congenere
	from	titulo_receber t,
		titulo_receber_classif f
	where	t.nr_titulo = f.nr_titulo
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	t.dt_contabil <= dt_final_w
	and	t.ie_situacao <> '3'
	and	((ie_gerar_ind_classif_w <> 'N')
	or	f.cd_conta_contabil in (	select 	c.cd_conta_contabil
						from 	conta_contabil c
						where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
						or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
						and (ie_classificacao_w = 'A'))) 
						and	c.ie_tipo = 'A'))
	and	t.ie_origem_titulo = '3'
	and	coalesce(t.nr_seq_mensalidade::text, '') = ''
	group by t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento,
		f.cd_conta_contabil,
		t.dt_contabil
	
union all

	select 	n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_preco ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		e.cd_conta_deb_ndc cd_conta_contabil,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_apropriado,
		round(sum(dividir(((obter_saldo_titulo_receber(r.nr_titulo, dt_final_w) + (	select	sum(vl_tributo)
												from	TITULO_RECEBER_TRIB
												where	nr_titulo = r.nr_titulo)) * (coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0))),r.vl_titulo)),2) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		b.nr_seq_segurado nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		t.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,	
		null nr_parcela,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		t.dt_contrato,
		s.dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = a.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = a.nr_seq_conta_mat) END  dt_ref_repasse,
		h.nr_seq_congenere
	FROM titulo_receber r, pls_fatura_proc p, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = p.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = p.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and (e.nr_sequencia        = p.nr_seq_conta_pos_contab or coalesce(p.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(r.dt_liquidacao::text, '') = '')
	or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_ndc in (	select 	c.cd_conta_contabil
		from 	conta_contabil c
		where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
		or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
		and (ie_classificacao_w = 'A'))) 
		and	c.ie_tipo = 'A')) group by n.ie_tipo_contratacao,
		n.ie_preco,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255),
		r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		e.cd_conta_deb_ndc,
		b.nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),	
		t.nr_sequencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,
		t.dt_contrato,
		s.dt_contratacao,
		a.nr_seq_conta_proc,
		a.nr_seq_conta_mat,
		f.dt_mes_competencia,
		h.nr_seq_congenere
	
union all

	select 	n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_preco ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		e.cd_conta_deb_taxa cd_conta_contabil,
		sum(e.vl_administracao) vl_apropriado,
		round(sum(dividir(((obter_saldo_titulo_receber(r.nr_titulo, dt_final_w) + (	select	sum(vl_tributo)
												from	TITULO_RECEBER_TRIB
												where	nr_titulo = r.nr_titulo)) * e.vl_administracao),r.vl_titulo)),2) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		b.nr_seq_segurado nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		t.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,	
		null nr_parcela,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		t.dt_contrato,
		s.dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = a.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = a.nr_seq_conta_mat) END  dt_ref_repasse,
		h.nr_seq_congenere
	FROM titulo_receber r, pls_fatura_proc p, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = p.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = p.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and (e.nr_sequencia        = p.nr_seq_conta_pos_contab or coalesce(p.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(r.dt_liquidacao::text, '') = '')
	or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_taxa in (	select 	c.cd_conta_contabil
		from 	conta_contabil c
		where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
		or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
		and (ie_classificacao_w = 'A'))) 
		and	c.ie_tipo = 'A')) group by n.ie_tipo_contratacao,
		n.ie_preco,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255),
		r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		e.cd_conta_deb_taxa,
		b.nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),	
		t.nr_sequencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,
		t.dt_contrato,
		s.dt_contratacao,
		a.nr_seq_conta_proc,
		a.nr_seq_conta_mat,
		f.dt_mes_competencia,
		h.nr_seq_congenere
	
union all

	select 	n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_preco ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		e.cd_conta_deb_ndc cd_conta_contabil,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_apropriado,
		round(sum(dividir(((obter_saldo_titulo_receber(r.nr_titulo, dt_final_w) + (	select	sum(vl_tributo)
												from	TITULO_RECEBER_TRIB
												where	nr_titulo = r.nr_titulo)) * (coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0))),r.vl_titulo)),2) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		b.nr_seq_segurado nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		t.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,	
		null nr_parcela,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		t.dt_contrato,
		s.dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = a.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = a.nr_seq_conta_mat) END  dt_ref_repasse,
		h.nr_seq_congenere
	FROM titulo_receber r, pls_fatura_mat m, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = m.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = m.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and (e.nr_sequencia        = m.nr_seq_conta_pos_contab or coalesce(m.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(r.dt_liquidacao::text, '') = '')
	or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_ndc in (	select 	c.cd_conta_contabil
		from 	conta_contabil c
		where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
		or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
		and (ie_classificacao_w = 'A'))) 
		and	c.ie_tipo = 'A')) group by n.ie_tipo_contratacao,
		n.ie_preco,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255),
		r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		e.cd_conta_deb_ndc,
		b.nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),	
		t.nr_sequencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,
		t.dt_contrato,
		s.dt_contratacao,
		a.nr_seq_conta_proc,
		a.nr_seq_conta_mat,
		f.dt_mes_competencia,
		h.nr_seq_congenere
	
union all

	select 	n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_preco ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255) nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		e.cd_conta_deb_taxa cd_conta_contabil,
		sum(e.vl_administracao) vl_apropriado,
		round(sum(dividir(((obter_saldo_titulo_receber(r.nr_titulo, dt_final_w) + (	select	sum(vl_tributo)
												from	TITULO_RECEBER_TRIB
												where	nr_titulo = r.nr_titulo)) * e.vl_administracao),r.vl_titulo)),2) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		b.nr_seq_segurado nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF') cd_cpf_cnpj,
		t.nr_sequencia nr_contrato,
		'TR' ie_tipo_documento,	
		null nr_parcela,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_evento,
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		t.dt_contrato,
		s.dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
		from	titulo_receber_liq x
		where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  f.dt_mes_competencia  ELSE (	select	y.dt_procedimento										from	pls_conta_proc y										where	y.nr_sequencia = a.nr_seq_conta_proc										
union
										select	y.dt_atendimento										from	pls_conta_mat y										where	y.nr_sequencia = a.nr_seq_conta_mat) END  dt_ref_repasse,
		h.nr_seq_congenere
	FROM titulo_receber r, pls_fatura_mat m, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = m.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = m.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and (e.nr_sequencia        = m.nr_seq_conta_pos_contab or coalesce(m.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(r.dt_liquidacao::text, '') = '')
	or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_taxa in (	select 	c.cd_conta_contabil
		from 	conta_contabil c
		where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
		or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
		and (ie_classificacao_w = 'A'))) 
		and	c.ie_tipo = 'A')) group by n.ie_tipo_contratacao,
		n.ie_preco,
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'CR'),1,30),
		substr(pls_obter_dados_segurado(b.nr_seq_segurado,'N'),1,255),
		r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		e.cd_conta_deb_taxa,
		b.nr_seq_segurado,
		pls_obter_dados_segurado(s.nr_sequencia,'CPF'),	
		t.nr_sequencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
		s.nr_seq_pagador,
		r.dt_contabil,
		b.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,
		t.dt_contrato,
		s.dt_contratacao,
		a.nr_seq_conta_proc,
		a.nr_seq_conta_mat,
		f.dt_mes_competencia,
		h.nr_seq_congenere	
	
union all

	select	null ie_tipo_contratacao,
		null ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		null cd_beneficiario,
		null nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		i.cd_conta_prov_cred cd_conta_contabil,
		i.vl_evento * (-1) vl_apropriado,	
		i.vl_evento * (-1) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		null nr_seq_segurado,
		null cd_cpf_cnpj,
		null nr_contrato,
		'TR' ie_tipo_documento,
		null nr_parcela,
		null nm_usuario_evento,
		null nr_seq_pagador,
		r.dt_contabil dt_contabil,
		null ie_tipo_segurado,
		null nr_protocolo_ans,
		null dt_contrato,
		null dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		null dt_ref_repasse,
		null nr_seq_congenere
	FROM pls_fatura_trib t, pls_lote_faturamento l, pls_fatura_item_trib i, pls_fatura f
LEFT OUTER JOIN titulo_receber r ON (f.nr_titulo = r.nr_titulo)
WHERE l.nr_sequencia		= f.nr_seq_lote and f.nr_sequencia		= t.nr_seq_fatura and t.nr_sequencia		= i.nr_seq_fatura_trib  and i.ie_tipo_valor_fat 	= 'NDC' and ((coalesce(r.dt_liquidacao::text, '') = '') or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_prov_cred  in (	select 	c.cd_conta_contabil
				from 	conta_contabil c
				where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
				or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
				and (ie_classificacao_w = 'A'))) 
				and	c.ie_tipo = 'A')) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento
	 
union all

	select	null ie_tipo_contratacao,
		null ie_modalidade_contrat,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		null cd_beneficiario,
		null nm_usuario_principal,
		r.nr_titulo nr_documento,
		r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		i.cd_conta_cred cd_conta_contabil,
		i.vl_evento * (-1) vl_apropriado,	
		i.vl_evento * (-1) vl_parcela,
		null vl_rec_cobertura,
		null vl_antecipado,
		null vl_fat_antec,
		null nr_seq_segurado,
		null cd_cpf_cnpj,
		null nr_contrato,
		'TR' ie_tipo_documento,
		null nr_parcela,
		null nm_usuario_evento,
		null nr_seq_pagador,
		r.dt_contabil dt_contabil,
		null ie_tipo_segurado,
		null nr_protocolo_ans,
		null dt_contrato,
		null dt_contratacao,
		null dt_cancelamento,
		(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = r.nr_titulo) dt_recebimento,
		null dt_ref_repasse,
		null nr_seq_congenere
	FROM pls_fatura_trib t, pls_lote_faturamento l, pls_fatura_item_trib i, pls_fatura f
LEFT OUTER JOIN titulo_receber r ON (f.nr_titulo = r.nr_titulo)
WHERE l.nr_sequencia		= f.nr_seq_lote and f.nr_sequencia		= t.nr_seq_fatura and t.nr_sequencia		= i.nr_seq_fatura_trib  and i.ie_tipo_valor_fat 	= 'F' and ((coalesce(r.dt_liquidacao::text, '') = '') or (r.dt_liquidacao > dt_final_w)) and ((ie_data_rec_faturamento_w	= 'TI' -- Emissao do titulo
	and	r.dt_emissao <= dt_final_w) 
	or (ie_data_rec_faturamento_w	= 'EF' -- Emissao da fatura
	and	f.dt_emissao <= dt_final_w) 	
	or (ie_data_rec_faturamento_w	= 'MC' -- Mes competencia
	and	f.dt_mes_competencia <= dt_final_w)) and ((ie_gerar_ind_classif_w <> 'N')
	or	i.cd_conta_cred   in (	select 	c.cd_conta_contabil
				from 	conta_contabil c
				where 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = ie_classificacao_w) 
				or 	((substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) in ('1.2.3','1.2.4'))
				and (ie_classificacao_w = 'A'))) 
				and	c.ie_tipo = 'A')) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento
	 
union all

	select	v.ie_tipo_contratacao ie_tipo_contratacao,
		v.ie_preco,
		v.dt_contratacao dt_inicio_cobertura,
		(v.dt_contratacao + 30) dt_fim_cobertura,
		v.cd_beneficiario,
		v.nm_beneficiario nm_usuario_principal,
		v.nr_seq_conta nr_documento,
		null nr_titulo,
		null dt_emissao,
		null dt_vencimento,
		v.cd_conta_cred_provisao,
		v.vl_provisao vl_apropriado,
		v.vl_provisao vl_pagar,
		0 vl_rec_cobertura,
		0 vl_antecipado,
		0 vl_fat_antec,
		v.nr_seq_segurado,
		v.nr_cpf_cnpj,
		v.nr_contrato,
		'CM' ie_tipo_documento,
		null nr_parcela,
		v.nm_pagador nm_usuario_evento,
		v.nr_seq_pagador,
		v.dt_mes_competencia dt_contabil,
		v.ie_tipo_segurado,
		v.nr_protocolo_ans,
		v.dt_contrato,
		v.dt_contratacao,
		null dt_cancelamento,
		null dt_recebimento,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  v.dt_atendimento_referencia  ELSE v.dt_mes_competencia END  dt_ref_repasse,
		v.nr_seq_congenere
	from	pls_conta_pos_dados_contab_v 	v
	where	v.ie_tipo_movto in ('VLB','VTI','RE')
	and	v.dt_mes_competencia <= dt_final_w
	and	coalesce(v.nr_seq_lote_fat,0) = 0
	and	((ie_gerar_ind_classif_w <> 'N')
	and (substr(v.cd_classif_credito,1,5) = '1.2.3'))
	and	coalesce(v.vl_provisao,0) <> 0
	order by nr_documento;
	
vet_titulo	c_titulo%rowtype;


BEGIN

select	max(a.ie_data_rec_faturamento)
into STRICT	ie_data_rec_faturamento_w
from	pls_parametro_contabil	a
where	a.cd_estabelecimento	= cd_estabelecimento_p;

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	fim_mes(max(dt_final)),
	max(dt_liberacao),
	max(ie_classificacao),
	coalesce(max(ie_gerar_ind_classif),'N'),
	max(ie_tipo_segurado)
into STRICT 	dt_final_w,
	dt_liberacao_w,
	ie_classificacao_w,
	ie_gerar_ind_classif_w,
	ie_tipo_segurado_w
from 	ctb_livro_auxiliar
where 	nr_sequencia = nr_seq_reg_auxiliar_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

dt_final_w 	:= fim_mes(dt_final_w);

delete
from	pls_aux_contrap_receber a
where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;

open c_titulo;
loop
fetch c_titulo into	
	vet_titulo;
EXIT WHEN NOT FOUND; /* apply on c_titulo */
	begin
	
	nr_contador_w := nr_contador_w + 1;
	
	SELECT * FROM pls_obter_dados_repasse(	vet_titulo.dt_ref_repasse, vet_titulo.nr_seq_segurado, vet_titulo.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

	ie_idade_saldo_w 	:= '';
	ds_idade_saldo_w 	:= '';
	
	select	CASE WHEN coalesce(vet_titulo.vl_parcela,0)=0 THEN vet_titulo.vl_apropriado  ELSE vet_titulo.vl_parcela END
	into STRICT	vet_titulo.vl_parcela
	;
	
	nr_dias_vencimento_w 	:= dt_final_w - vet_titulo.dt_vencimento;
	
	if (nr_dias_vencimento_w > 90) then
		ie_idade_saldo_w := '999';	
		ds_idade_saldo_w := substr(obter_desc_expressao(490313), 1, 255);
	elsif (nr_dias_vencimento_w > 60) then
		ie_idade_saldo_w := '90';
		ds_idade_saldo_w := substr(obter_desc_expressao(486914), 1, 255);
	elsif (nr_dias_vencimento_w > 30) then
		ie_idade_saldo_w := '60';
		ds_idade_saldo_w := substr(obter_desc_expressao(486913), 1, 255);
	elsif (nr_dias_vencimento_w > 0) then
		ie_idade_saldo_w := '30';
		ds_idade_saldo_w := substr(obter_desc_expressao(782192), 1, 255);
	elsif (nr_dias_vencimento_w <= 0) then
		ie_idade_saldo_w := '00';
		ds_idade_saldo_w := substr(obter_desc_expressao(330037), 1, 255);
		nr_dias_vencimento_w := 0;
	end if;
	
	select	nextval('pls_aux_contrap_receber_seq')
	into STRICT	nr_seq_contra_emit_w
	;
	
	select	max(nr_sequencia)
	into STRICT 	nr_seq_contrato_w
	from 	pls_contrato 	
	where 	nr_contrato = vet_titulo.nr_contrato;
	
	ctb_aux_contra_emit_w[nr_contador_w].nr_sequencia                        := nr_seq_contra_emit_w;
	ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao                      := clock_timestamp();
	ctb_aux_contra_emit_w[nr_contador_w].nm_usuario                          := nm_usuario_p;
	ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao_nrec                 := clock_timestamp();
	ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_nrec                     := nm_usuario_p;
	ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_modalidade                  := vet_titulo.ie_modalidade_contrat;
	ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_contratacao                 := vet_titulo.ie_tipo_contratacao;
	ctb_aux_contra_emit_w[nr_contador_w].dt_emissao                          := vet_titulo.dt_emissao;
	ctb_aux_contra_emit_w[nr_contador_w].nr_registro_produto                 := vet_titulo.nr_protocolo_ans;
	ctb_aux_contra_emit_w[nr_contador_w].dt_vencimento                       := vet_titulo.dt_vencimento;
	ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_vigencia                  := vet_titulo.dt_inicio_cobertura;
	ctb_aux_contra_emit_w[nr_contador_w].dt_fim_vigencia                     := vet_titulo.dt_fim_cobertura;
	ctb_aux_contra_emit_w[nr_contador_w].ie_idade_saldos                     := ie_idade_saldo_w;
	ctb_aux_contra_emit_w[nr_contador_w].nr_dias_vencimento			 := nr_dias_vencimento_w;
	ctb_aux_contra_emit_w[nr_contador_w].vl_total_titulo                     := vet_titulo.vl_apropriado;
	ctb_aux_contra_emit_w[nr_contador_w].vl_saldo_receber                    := vet_titulo.vl_parcela;
	ctb_aux_contra_emit_w[nr_contador_w].vl_receber_vigencia                 := vet_titulo.vl_rec_cobertura;
	ctb_aux_contra_emit_w[nr_contador_w].vl_ppcng	                         := vet_titulo.vl_antecipado;
	ctb_aux_contra_emit_w[nr_contador_w].vl_receber_antes_vig                := vet_titulo.vl_fat_antec;
	ctb_aux_contra_emit_w[nr_contador_w].cd_conta_contabil                   := vet_titulo.cd_conta_contabil;
	ctb_aux_contra_emit_w[nr_contador_w].nr_titulo                           := vet_titulo.nr_titulo;
	ctb_aux_contra_emit_w[nr_contador_w].nr_seq_reg_auxiliar                 := nr_seq_reg_auxiliar_p;
	ctb_aux_contra_emit_w[nr_contador_w].nr_seq_segurado                     := vet_titulo.nr_seq_segurado;
	ctb_aux_contra_emit_w[nr_contador_w].nr_contrato                         := vet_titulo.nr_contrato;
	ctb_aux_contra_emit_w[nr_contador_w].nr_seq_contrato			 := nr_seq_contrato_w;
	ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_documento                   := vet_titulo.ie_tipo_documento;
	ctb_aux_contra_emit_w[nr_contador_w].nr_parcela                          := vet_titulo.nr_parcela;
	ctb_aux_contra_emit_w[nr_contador_w].nr_documento                        := vet_titulo.nr_documento;
	ctb_aux_contra_emit_w[nr_contador_w].dt_contrato			 := vet_titulo.dt_contrato;
	ctb_aux_contra_emit_w[nr_contador_w].dt_contratacao			 := vet_titulo.dt_contratacao;
	ctb_aux_contra_emit_w[nr_contador_w].dt_cancelamento			 := vet_titulo.dt_cancelamento;
	ctb_aux_contra_emit_w[nr_contador_w].dt_recebimento			 := vet_titulo.dt_recebimento;
	ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_segurado		 	:= vet_titulo.ie_tipo_segurado;
        ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_compartilhamento		 := ie_tipo_compartilhamento_w;
        ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_repasse			 := ie_tipo_repasse_w;
        ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_compartilhamento		 := dt_repasse_w;
        ctb_aux_contra_emit_w[nr_contador_w].dt_fim_compartilhamento		 := dt_fim_repasse_w;
	ctb_aux_contra_emit_w[nr_contador_w].nr_seq_pagador			 := vet_titulo.nr_seq_pagador;
	
	if (vet_titulo.ie_tipo_segurado in ('C','I','T')) then
		ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= ds_observacao_w;
	else
		ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= null;
	end if;
	
	end;
end loop;
close c_titulo;
	
if (ctb_aux_contra_emit_w.count > 0) then		
	forall i in ctb_aux_contra_emit_w.first .. ctb_aux_contra_emit_w.last
		insert into pls_aux_contrap_receber values ctb_aux_contra_emit_w(i);	
end if;
		
update	ctb_livro_auxiliar
set	qt_registros	= nr_contador_w
where	nr_sequencia	= nr_seq_reg_auxiliar_p;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_contrap_receber ( nr_seq_reg_auxiliar_p ctb_livro_auxiliar.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

