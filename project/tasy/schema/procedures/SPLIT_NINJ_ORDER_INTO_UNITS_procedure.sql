-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE split_ninj_order_into_units ( nr_atendimento_p bigint, nr_seq_order_unit_p bigint, nm_usuario_p text, nr_seq_cpoe_rp_p bigint default null) AS $body$
DECLARE


nr_count_w	integer;
dt_curr_w	cpoe_rp.dt_inicio%TYPE;
dt_split_end_w	cpoe_rp.dt_inicio%TYPE;
nr_seq_order_unit_inbetween_w	cpoe_order_unit.nr_sequencia%TYPE;
si_type_of_prescription_w	cpoe_order_unit.si_type_of_prescription%TYPE;
ie_diff_date_rp_exists_w	varchar(1);
ie_diff_interval_match_date_w	varchar(1);
ie_valid_week_w	varchar(1);
nr_seq_comment_out_w	cpoe_comment_linkage.nr_sequencia%type;
nr_seq_order_unit_out_w	cpoe_order_unit.nr_sequencia%type;
nr_seq_rp_out_w	cpoe_order_unit.nr_sequencia%type;

cpoe_rp_cur CURSOR FOR
	SELECT  *
	from    cpoe_rp
	where   nr_seq_cpoe_order_unit = nr_seq_order_unit_p
	order by nr_sequencia_rp;

c_ou_comments CURSOR(nr_seq_cpoe_order_unit_pc  bigint) FOR
	SELECT	a.nr_sequencia
	from	cpoe_comment_linkage a
	where	a.nr_seq_cpoe_order_unit = nr_seq_cpoe_order_unit_pc;

c_rp_comments CURSOR(nr_seq_cpoe_rp_pc  bigint) FOR
	SELECT	a.nr_sequencia
	from	cpoe_comment_linkage a
	where	a.nr_seq_cpoe_rp = nr_seq_cpoe_rp_pc;
BEGIN
if (nr_seq_order_unit_p IS NOT NULL AND nr_seq_order_unit_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	begin
	select 	count(1)
	into STRICT 	nr_count_w
	from 	cpoe_rp
	where 	nr_seq_cpoe_order_unit = nr_seq_order_unit_p;

	if (nr_count_w > 0) then
		begin

		for rt_cpoe_rp_old_w in cpoe_rp_cur loop
			dt_curr_w := rt_cpoe_rp_old_w.dt_inicio;

			select	coalesce(max('S'), 'N')
			into STRICT	ie_diff_date_rp_exists_w
			from	cpoe_rp cr,
					cpoe_diff_date_rp cp
			where	cr.nr_sequencia = cp.nr_seq_cpoe_rp
			and		cr.nr_sequencia = rt_cpoe_rp_old_w.nr_sequencia;

			while(trunc(dt_curr_w) <= trunc(rt_cpoe_rp_old_w.dt_fim)) loop
				ie_diff_interval_match_date_w := 'S';
				ie_valid_week_w := 'S';

				if (ie_diff_date_rp_exists_w = 'S') then
					select	coalesce(max('S'), 'N')
					into STRICT	ie_diff_interval_match_date_w
					from	cpoe_rp cr,
							cpoe_diff_date_rp cp
					where	cr.nr_sequencia = cp.nr_seq_cpoe_rp
					and 	cr.nr_sequencia = nr_seq_cpoe_rp_p
					and 	trunc(cp.dt_administration) = trunc(dt_curr_w);
				else
					select 	substr(get_cpoe_valid_weekday(dt_curr_w, nr_seq_cpoe_rp_p),1,1)
					into STRICT	ie_valid_week_w
					;
				end if;

				if (ie_diff_interval_match_date_w = 'S') and (ie_valid_week_w = 'S') then
					begin
					if (trunc(dt_curr_w) = trunc(rt_cpoe_rp_old_w.dt_fim)) then
						dt_split_end_w := rt_cpoe_rp_old_w.dt_fim;
					else
						dt_split_end_w := fim_dia(dt_curr_w);
					end if;

					select obter_type_of_prescription(nr_atendimento_p,rt_cpoe_rp_old_w.ie_via_aplicacao,nr_seq_order_unit_p,dt_curr_w)
					into STRICT si_type_of_prescription_w;

					select	coalesce(max(nr_sequencia),0)
					into STRICT	nr_seq_order_unit_inbetween_w
					from	cpoe_order_unit
					where	nr_seq_prev_order_unit = nr_seq_order_unit_p
					and		pkg_date_utils.start_of(dt_start, 'DAY') = pkg_date_utils.start_of(dt_curr_w,'DAY')
					and		pkg_date_utils.end_of(dt_end, 'DAY') = pkg_date_utils.end_of(dt_split_end_w, 'DAY')
					and		si_type_of_prescription	= si_type_of_prescription_w;

					if (nr_seq_order_unit_inbetween_w = 0) then
						begin
						select  nextval('cpoe_order_unit_seq')
						into STRICT    nr_seq_order_unit_inbetween_w
						;

						insert into cpoe_order_unit(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_order_unit,
							si_type_of_prescription,
							si_cpoe_type_of_item,
							nr_seq_cpoe_tipo_pedido,
							cd_pessoa_fisica,
							nr_atendimento,
							ie_situacao,
							cd_setor_execucao,
							nr_seq_nais_insurance,
							ie_drug_info,
							si_same_dose,
							si_drug_adjustment,
							si_provide_info_insurance,
							si_dispense_med_insurance,
							ie_tipo_receita,
							id_dispense_for_question,
							id_provide_info_medical,
							cd_setor_coleta,
							nr_seq_prev_order_unit,
							dt_start,
							dt_end)
						SELECT	nr_seq_order_unit_inbetween_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_order_unit,
							si_type_of_prescription_w,
							si_cpoe_type_of_item,
							nr_seq_cpoe_tipo_pedido,
							cd_pessoa_fisica,
							nr_atendimento,
							'A',
							cd_setor_execucao,
							nr_seq_nais_insurance,
							ie_drug_info,
							si_same_dose,
							si_drug_adjustment,
							si_provide_info_insurance,
							si_dispense_med_insurance,
							ie_tipo_receita,
							id_dispense_for_question,
							id_provide_info_medical,
							cd_setor_coleta,
							nr_seq_order_unit_p,
							pkg_date_utils.start_of(dt_curr_w,'DAY'),
							pkg_date_utils.end_of(dt_split_end_w,'DAY')
						from	cpoe_order_unit
						where	nr_sequencia = nr_seq_order_unit_p;
						end;
					end if;

          nr_seq_order_unit_out_w := nr_seq_order_unit_inbetween_w;
          for r_c_ou_comments in c_ou_comments(nr_seq_order_unit_p) loop
            nr_seq_comment_out_w	:= r_c_ou_comments.nr_sequencia;

            nr_seq_comment_out_w := DUPLICAR_REGISTRO('CPOE_COMMENT_LINKAGE', wheb_usuario_pck.get_nm_usuario, nr_seq_comment_out_w);

            update  cpoe_comment_linkage
            set     nr_seq_cpoe_order_unit = nr_seq_order_unit_out_w,
                nm_usuario = nm_usuario_p,
                dt_atualizacao = clock_timestamp(),
                nm_usuario_nrec = nm_usuario_p,
                dt_atualizacao_nrec = clock_timestamp()
            where 	nr_sequencia = nr_seq_comment_out_w;
          end loop;

					select 	count(1)
					into STRICT 	nr_count_w
					from 	cpoe_rp
					where 	nr_seq_cpoe_order_unit = nr_seq_order_unit_inbetween_w
					and		dt_inicio = dt_curr_w
					and		dt_fim = dt_split_end_w
					and		nr_seq_prev_rp = rt_cpoe_rp_old_w.nr_sequencia;

					if (nr_count_w = 0) then
						begin

						select	nextval('cpoe_rp_seq')
						into STRICT	nr_seq_rp_out_w
						;

						insert into cpoe_rp(
							nr_sequencia,
							nr_sequencia_rp,
							ie_via_aplicacao,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_intervalo,
							ds_horarios,
							dt_inicio,
							dt_fim,
							nr_seq_cpoe_order_unit,
							qt_dias_padrao,
							ie_segunda,
							ie_terca,
							ie_quarta,
							ie_quinta,
							ie_sexta,
							ie_sabado,
							ie_domingo,
							nr_seq_start_period,
							nr_seq_subgrupo_interval,
							nr_seq_grupo_interval,
							ie_enable_end_dt,
							si_temporary_admin,
							ie_allow_execution,
							qt_operacao,
							qt_dosagem,
							qt_tempo_aplicacao,
							nr_etapas,
							ie_bomba_infusao,
							qt_hora_fase,
							ie_tipo_solucao,
							ie_tipo_dosagem,
							ie_ref_calculo,
							ie_drip_shot,
							nr_seq_prev_rp)
						SELECT	nr_seq_rp_out_w,
							rt_cpoe_rp_old_w.nr_sequencia_rp,
							rt_cpoe_rp_old_w.ie_via_aplicacao,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							rt_cpoe_rp_old_w.cd_intervalo,
              rt_cpoe_rp_old_w.ds_horarios,
              dt_curr_w,
              dt_split_end_w,
              nr_seq_order_unit_inbetween_w,
              rt_cpoe_rp_old_w.qt_dias_padrao,
              rt_cpoe_rp_old_w.ie_segunda,
              rt_cpoe_rp_old_w.ie_terca,
              rt_cpoe_rp_old_w.ie_quarta,
              rt_cpoe_rp_old_w.ie_quinta,
              rt_cpoe_rp_old_w.ie_sexta,
              rt_cpoe_rp_old_w.ie_sabado,
              rt_cpoe_rp_old_w.ie_domingo,
              rt_cpoe_rp_old_w.nr_seq_start_period,
              rt_cpoe_rp_old_w.nr_seq_subgrupo_interval,
              rt_cpoe_rp_old_w.nr_seq_grupo_interval,
              rt_cpoe_rp_old_w.ie_enable_end_dt,
              rt_cpoe_rp_old_w.si_temporary_admin,
              rt_cpoe_rp_old_w.ie_allow_execution,
              rt_cpoe_rp_old_w.qt_operacao,
              rt_cpoe_rp_old_w.qt_dosagem,
              rt_cpoe_rp_old_w.qt_tempo_aplicacao,
              rt_cpoe_rp_old_w.nr_etapas,
              rt_cpoe_rp_old_w.ie_bomba_infusao,
              rt_cpoe_rp_old_w.qt_hora_fase,
              rt_cpoe_rp_old_w.ie_tipo_solucao,
              rt_cpoe_rp_old_w.ie_tipo_dosagem,
              rt_cpoe_rp_old_w.ie_ref_calculo,
              rt_cpoe_rp_old_w.ie_drip_shot,
              rt_cpoe_rp_old_w.nr_sequencia
						;

            for r_c_rp_comments in c_rp_comments(rt_cpoe_rp_old_w.nr_sequencia) loop
              nr_seq_comment_out_w	:= r_c_rp_comments.nr_sequencia;

              nr_seq_comment_out_w := DUPLICAR_REGISTRO('CPOE_COMMENT_LINKAGE', wheb_usuario_pck.get_nm_usuario, nr_seq_comment_out_w);

              update  cpoe_comment_linkage
              set     nr_seq_cpoe_rp = nr_seq_rp_out_w,
                  nm_usuario = nm_usuario_p,
                  dt_atualizacao = clock_timestamp(),
                  nm_usuario_nrec = nm_usuario_p,
                  dt_atualizacao_nrec = clock_timestamp()
              where 	nr_sequencia = nr_seq_comment_out_w;
            end loop;

            end;
          end if;
          end;
        end if;
        dt_curr_w := trunc(dt_curr_w + 1);
      end loop;
    end loop;
		
		update	cpoe_order_unit
		set	ie_situacao = 'I',
      dt_atualizacao = clock_timestamp(),
      nm_usuario = nm_usuario_p
    where nr_sequencia = nr_seq_order_unit_p;
    commit;
    end;
  end if;
  end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE split_ninj_order_into_units ( nr_atendimento_p bigint, nr_seq_order_unit_p bigint, nm_usuario_p text, nr_seq_cpoe_rp_p bigint default null) FROM PUBLIC;

