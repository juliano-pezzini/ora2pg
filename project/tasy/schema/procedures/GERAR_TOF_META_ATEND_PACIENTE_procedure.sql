-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tof_meta_atend_paciente (nr_atendimento_p bigint, ds_metas_paciente_p text, nm_usuario_p text, ie_liberar_p text default 'S') AS $body$
DECLARE


ds_metas_w		varchar(4000);
nr_seq_meta_w	bigint;
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
qt_reg_w		bigint;
dt_liberacao_w  timestamp;


BEGIN


ds_metas_w	:= ds_metas_paciente_p;

while	(ds_metas_w IS NOT NULL AND ds_metas_w::text <> '') loop
	begin
	tam_lista_w	:= length(ds_metas_w);
	ie_pos_virgula_w	:= position(',' in ds_metas_w);

	if (ie_pos_virgula_w <> 0) then
		nr_seq_meta_w	:= (substr(ds_metas_w, 1, (ie_pos_virgula_w - 1)))::numeric;
		ds_metas_w	:= substr(ds_metas_w, (ie_pos_virgula_w + 1), tam_lista_w);
	end if;

	if (nr_seq_meta_w > 0) then
		begin


		select	count(*)
		into STRICT	qt_reg_w
		from	tof_meta_atend a,
			tof_meta m
		where	m.nr_sequencia = a.nr_seq_meta
		and	nr_atendimento = nr_atendimento_p
		and	a.nr_seq_meta = nr_seq_meta_w
		and	coalesce(m.ie_situacao,'A') = 'A'
		and	((coalesce(a.dt_finalizacao::text, '') = '') and (m.ie_regra <> 'M'))
		and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and coalesce(a.dt_inativacao::text, '') = '';

		if (ie_liberar_p = 'S') then
			dt_liberacao_w := clock_timestamp();
		end if;

		if (qt_reg_w = 0) then

			insert into tof_meta_atend( 	nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											nr_seq_meta,
											dt_inicio,
											dt_finalizacao,
											nr_atendimento,
											ie_status,
											ds_observacao,
											dt_liberacao)
								values (	nextval('tof_meta_atend_seq'),
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											nr_seq_meta_w,
											clock_timestamp(),
											null,
											nr_atendimento_p,
											'',
											'',
											dt_liberacao_w);

		end if;

		end;
	end if;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tof_meta_atend_paciente (nr_atendimento_p bigint, ds_metas_paciente_p text, nm_usuario_p text, ie_liberar_p text default 'S') FROM PUBLIC;

