-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualiza_dt_resultado ( dt_resultado_p timestamp, nr_prescricao_p bigint, nr_seq_prescr_p bigint) AS $body$
DECLARE


qt_registros_w             bigint;
qt_minutos_diferenca_w     bigint;
nr_sequencia_compl_w       prescr_procedimento_compl.nr_sequencia%type;
dt_resultado_atual_w       timestamp;
dt_resultado_atrasado_w    timestamp;
dt_resultado_somada_w      timestamp;


BEGIN

    select  count(1)
    into STRICT    qt_registros_w
    from    prescr_procedimento_compl   ppc
    inner join  prescr_procedimento     pp
          ON (ppc.nr_sequencia = pp.nr_seq_proc_compl)
    where pp.nr_prescricao = nr_prescricao_p
          and pp.nr_sequencia = nr_seq_prescr_p;

    if (qt_registros_w > 0) then

        select  ppc.nr_sequencia,
                pp.dt_resultado,
                ppc.dt_result_atrasado
        into STRICT    nr_sequencia_compl_w,
                dt_resultado_atual_w,
                dt_resultado_atrasado_w
        from    prescr_procedimento_compl   ppc
        inner join prescr_procedimento      pp
              ON (ppc.nr_sequencia = pp.nr_seq_proc_compl)
        where pp.nr_prescricao = nr_prescricao_p
              and pp.nr_sequencia = nr_seq_prescr_p;

        qt_minutos_diferenca_w := obter_dif_data(dt_resultado_atual_w, dt_resultado_atrasado_w, 'TM');

        if (coalesce(qt_minutos_diferenca_w, 0) > 0) then
            /*
             * 1440 eh a quantidade de minutos em 1 dia.
             * A data no Oracle eh representada com um numero onde a parte inteira eh a quantidade de dias e a fracao eh a quantidade de horas / minutos / segundos.
             * Dividir uma quantidade de minutos por 1440 converte em uma fracao que para o Oracle representa essa quantidade de tempo.
             */
            dt_resultado_somada_w := dt_resultado_p + (qt_minutos_diferenca_w / 1440);

            update prescr_procedimento_compl
            set    dt_result_atrasado = dt_resultado_somada_w
            where  nr_sequencia = nr_sequencia_compl_w;

        end if;

    end if;

    update prescr_procedimento
    set    dt_resultado   = dt_resultado_p
    where  nr_prescricao  = nr_prescricao_p
    and    nr_sequencia   = nr_seq_prescr_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualiza_dt_resultado ( dt_resultado_p timestamp, nr_prescricao_p bigint, nr_seq_prescr_p bigint) FROM PUBLIC;

