-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_horarios_duplicados ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_erro_w					varchar(4000);
nr_atendimento_w			bigint;
cd_material_w				bigint;
nr_seq_material_w			integer;
nr_seq_horario_w			bigint;
dt_horario_w				timestamp;
ie_apresenta_rep_ant_w		varchar(1);
nr_prescr_conflito_w		bigint;
ie_gravar_justif_w			varchar(1);
ds_justificativa_w			varchar(255);
ie_agrupador_w				prescr_material.ie_agrupador%type;
ie_tipo_item_w				varchar(1);

c01 CURSOR FOR
SELECT	distinct
	nr_seq_material,
	nr_seq_mat_hor,
	cd_material,
	dt_horario,
	nr_prescricao_conflito
from	prescr_mat_hor_conflito
where	nr_prescricao  = nr_prescricao_p
and	ie_tipo = 'D';


BEGIN

ie_gravar_justif_w := Obter_Param_Usuario(924, 890, obter_perfil_ativo, nm_usuario_p, 0, ie_gravar_justif_w);

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

CALL consiste_hor_prescr_mat_hor(nr_prescricao_p);

if (coalesce(ie_gravar_justif_w,'S') <> 'N') then
	ds_justificativa_w := obter_desc_expressao(727956);
else
	ds_justificativa_w := null;
end if;

open C01;
loop
fetch C01 into	
	nr_seq_material_w,
	nr_seq_horario_w,
	cd_material_w,
	dt_horario_w,
	nr_prescr_conflito_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_erro_w := Consiste_susp_prescr_mat_hor(nr_prescr_conflito_w, nr_seq_horario_w, cd_estabelecimento_p, nm_usuario_p, ds_erro_w);
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
		ds_erro_w	:= '';
	else
	
		select 	coalesce(max(ie_agrupador),99)
		into STRICT	ie_agrupador_w
		from 	prescr_material
		where	nr_prescricao = nr_prescr_conflito_w
		and 	nr_sequencia = nr_seq_material_w;
		
		if (ie_agrupador_w = 12) then
			ie_tipo_item_w := 'S';
		else
			ie_tipo_item_w := 'M';
		end if;

		CALL Suspender_prescr_mat_hor(nr_seq_horario_w, nm_usuario_p, 0, null, 'N',null);
		CALL Gerar_prescr_mat_hor_compl(nr_seq_horario_w, nm_usuario_p, 'S');
		CALL Atualiza_ie_horario_susp(nr_prescr_conflito_w, nr_seq_material_w, 'PRESCR_MATERIAL');
		CALL Gerar_Alter_Hor_Prescr_Adep(nr_atendimento_w, ie_tipo_item_w, cd_material_w, nr_prescr_conflito_w, nr_seq_material_w, nr_seq_horario_w, dt_horario_w, 12, ds_justificativa_w, null, null, nm_usuario_p);
	end if;	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_horarios_duplicados ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

