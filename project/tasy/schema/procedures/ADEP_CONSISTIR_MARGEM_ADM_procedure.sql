-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_margem_adm ( nr_seq_horario_p bigint, ie_tipo_item_p text, dt_evento_med_p timestamp, qt_min_margemadm_p bigint, cd_perfil_p bigint, ie_opcao_margem_p text, ie_opcao_minutos_p text, ie_opcao_tipo_consistencia_p text, qt_min_margemadm_ant_p bigint, nr_prescr_p bigint, dt_horario_p timestamp, ie_margem_valida_p INOUT text, qt_minutos_p INOUT text, ie_tipo_consistencia_p INOUT text, nm_usuario_p text, nr_sequencia_p bigint, ie_html_p text default 'N') AS $body$
DECLARE


ie_margem_valida_w		varchar(20);
qt_minutos_w			varchar(20);
ie_tipo_consistencia_w	varchar(20);
dt_horario_w			timestamp;
nr_prescricao_w         	prescr_mat_hor.nr_prescricao%type;


BEGIN

if (nr_prescr_p IS NOT NULL AND nr_prescr_p::text <> '') then
    nr_prescricao_w := nr_prescr_p;
else
    select  coalesce(max(nr_prescricao), null)
    into STRICT    nr_prescricao_w
    from    prescr_mat_hor
    where   nr_sequencia = nr_seq_horario_p;
end if;

if ((nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') or (nr_prescr_p IS NOT NULL AND nr_prescr_p::text <> '')) and (ie_opcao_margem_p IS NOT NULL AND ie_opcao_margem_p::text <> '') and (ie_opcao_minutos_p IS NOT NULL AND ie_opcao_minutos_p::text <> '') and (ie_opcao_tipo_consistencia_p IS NOT NULL AND ie_opcao_tipo_consistencia_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	dt_horario_w	:= dt_horario_p;

	--Para solucoes no nr_seq_horario_p vem o nr. da etapa
	if	((ie_tipo_item_p = 'SOL') and (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')) then

		select	max(dt_horario)
		into STRICT	dt_horario_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_w
		and		nr_etapa_sol = nr_seq_horario_p
		and		nr_seq_solucao = nr_sequencia_p;

	end if;

	select	consistir_margem_administracao(
			nr_seq_horario_p,
			ie_tipo_item_p,
			dt_evento_med_p,
			qt_min_margemadm_p,
			cd_perfil_p,
			ie_opcao_margem_p,
			qt_min_margemadm_ant_p,
			nr_prescricao_w,
			dt_horario_w,
			ie_html_p)
	into STRICT	ie_margem_valida_w
	;

	select	consistir_margem_administracao(
			nr_seq_horario_p,
			ie_tipo_item_p,
			dt_evento_med_p,
			qt_min_margemadm_p,
			cd_perfil_p,
			ie_opcao_minutos_p,
			qt_min_margemadm_ant_p,
			nr_prescricao_w,
			dt_horario_w,
			ie_html_p)
	into STRICT	qt_minutos_w
	;

	select	consistir_margem_administracao(
			nr_seq_horario_p,
			ie_tipo_item_p,
			dt_evento_med_p,
			qt_min_margemadm_p,
			cd_perfil_p,
			ie_opcao_tipo_consistencia_p,
			qt_min_margemadm_ant_p,
			nr_prescricao_w,
			dt_horario_w,
			ie_html_p)
	into STRICT	ie_tipo_consistencia_w
	;

	ie_margem_valida_p	:= ie_margem_valida_w;
	qt_minutos_p		:= qt_minutos_w;
	ie_tipo_consistencia_p	:= ie_tipo_consistencia_w;
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_margem_adm ( nr_seq_horario_p bigint, ie_tipo_item_p text, dt_evento_med_p timestamp, qt_min_margemadm_p bigint, cd_perfil_p bigint, ie_opcao_margem_p text, ie_opcao_minutos_p text, ie_opcao_tipo_consistencia_p text, qt_min_margemadm_ant_p bigint, nr_prescr_p bigint, dt_horario_p timestamp, ie_margem_valida_p INOUT text, qt_minutos_p INOUT text, ie_tipo_consistencia_p INOUT text, nm_usuario_p text, nr_sequencia_p bigint, ie_html_p text default 'N') FROM PUBLIC;

