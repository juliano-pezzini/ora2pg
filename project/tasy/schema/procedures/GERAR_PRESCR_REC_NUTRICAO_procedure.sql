-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_rec_nutricao ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

--- Declaração das variáveis
cd_recomendacao_w	bigint;
cd_intervalo_w		varchar(7);
nr_sequencia_w		bigint;
ie_urgencia_w		varchar(1);
ie_agora_w		varchar(1);

BEGIN
--- Verifica se há prescrição e se há usuário para gerar a recomendação com a solicitação
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
--- Busca a recomendação a ser gerada
select	max(cd_tipo_recomendacao),
	max(cd_intervalo),
	max(coalesce(ie_urgencia,'N'))
into STRICT	cd_recomendacao_w,
	cd_intervalo_w,
	ie_urgencia_w
from	tipo_recomendacao
where 	coalesce(ie_pedido_parecer,'N') = 'S';

if (ie_urgencia_w = 'S')	then

	ie_agora_w := obter_se_intervalo_agora(cd_intervalo_w);

	if (ie_agora_w 	= 'N') 	and (ie_urgencia_w 	= 'S')	then

		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from 	intervalo_prescricao
		where 	ie_agora = 'S'
		and 	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
		and 	Obter_se_intervalo(cd_intervalo,'R') = 'S'
		and 	ie_situacao = 'A';
	end if;
end if;

--- Obtem a próxima sequencia da tabela
select	nextval('prescr_recomendacao_seq')
into STRICT	nr_sequencia_w
;
--- Insere na tabela a solicitação
if (cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '') and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
	insert into prescr_recomendacao(
		cd_recomendacao,
		nr_prescricao,
		nr_sequencia,
		ie_destino_rec,
		dt_atualizacao,
		nm_usuario,
		cd_intervalo,
		ie_urgencia)
	values (
		cd_recomendacao_w,
		nr_prescricao_p,
		nr_sequencia_w,
		'E',
		clock_timestamp(),
		nm_usuario_p,
		cd_intervalo_w,
		ie_urgencia_w);
	commit;
end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_rec_nutricao ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

