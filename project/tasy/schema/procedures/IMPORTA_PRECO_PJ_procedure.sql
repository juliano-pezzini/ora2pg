-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importa_preco_pj ( CD_CGC_P text, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text, DT_VIGENCIA_P timestamp, CD_ITEM_P text, DS_ITEM_P text, CD_BARRA_P text, VL_ITEM_P bigint, DT_VIGENCIA_FIM_P text default null, CD_PRODUTO_P text default null) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_material_w		integer;
dt_vigencia_w		timestamp;
qt_registros_w		bigint;
ie_envia_sem_barras_w	varchar(1);


BEGIN

if (dt_vigencia_fim_p = '0') then
	dt_vigencia_w := null;
else
	dt_vigencia_w := to_date(dt_vigencia_fim_p,'dd/mm/yyyy');
end if;

select	nextval('preco_pj_seq')
into STRICT	nr_sequencia_w
;

select	Obter_cod_material_barra(cd_barra_p, cd_cgc_p)
into STRICT	cd_material_w
;

ie_envia_sem_barras_w := obter_param_usuario(6, 72, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_envia_sem_barras_w);

if (ie_envia_sem_barras_w = 'N') then

	select	coalesce(count(*),0)
	into STRICT	qt_registros_w
	from	material
	where	cd_material = cd_produto_p;

	if (qt_registros_w > 0) then
		cd_material_w := cd_produto_p;
	else
		cd_material_w := '';
	end if;
end if;

insert into preco_pj(
		nr_sequencia,
		cd_estabelecimento,
		cd_cgc,
		dt_atualizacao,
		nm_usuario,
		dt_vigencia,
		dt_vigencia_fim,
		cd_item,
		ds_item,
		cd_barra,
		vl_item,
		cd_material)
	values (
		nr_sequencia_w,
		cd_estabelecimento_p,
		cd_cgc_p,
		clock_timestamp(),
		nm_usuario_p,
		dt_vigencia_p,
		dt_vigencia_w,
		cd_item_p,
		ds_item_p,
		cd_barra_p,
		vl_item_p,
		cd_material_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importa_preco_pj ( CD_CGC_P text, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text, DT_VIGENCIA_P timestamp, CD_ITEM_P text, DS_ITEM_P text, CD_BARRA_P text, VL_ITEM_P bigint, DT_VIGENCIA_FIM_P text default null, CD_PRODUTO_P text default null) FROM PUBLIC;

