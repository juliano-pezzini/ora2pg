-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alteracao_tasy (dt_alteracao_p timestamp, ie_tipo_alteracao_p text, ds_aplicacao_p text, cd_funcao_p bigint, nr_ordem_servico_p bigint, ds_objetivo_p text, ds_alteracao_p text, ds_acao_p text, ie_destaque_p text, nm_usuario_p text, ie_alteracao_p text, ie_interno_externo_p text, ie_tipo_cliente_p text, ie_componente_p text, ie_libera_news_p text default null, ie_global_p text default null, ie_locales_p text default null, ds_objetivo_eng_p text default null, ds_alteracao_eng_p text default null, ds_acao_eng_p text default null, ie_delphi_p text default null, ie_java_p text default null, ie_html5_p text default null, ie_tws_p text default null) AS $body$
DECLARE


    ds_alteracao_w          varchar(32000);
    ds_alteracao_us_w       varchar(32000);
    qt_reg_old_w            bigint;
    nr_seq_alteracao_tasy_w alteracao_tasy.nr_sequencia%type;WITH RECURSIVE cte AS (


    c_split_locales CURSOR FOR
        SELECT regexp_substr(ie_locales_p, '[^, ]+', 1, level) cd_locale

        (regexp_substr(ie_locales_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(ie_locales_p, '[^, ]+', 1, level))::text <> '')  UNION ALL


    c_split_locales CURSOR FOR
        SELECT regexp_substr(ie_locales_p, '[^, ]+', 1, level) cd_locale
          
        (regexp_substr(ie_locales_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(ie_locales_p, '[^, ]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;

BEGIN

    ds_alteracao_w := substr('OBJETIVO: ' || ds_objetivo_p || chr(13) || chr(10) || 'ALTERA'||chr(199)||chr(195)||'O: ' || ds_alteracao_p || chr(13) ||
                             chr(10) || 'A'||chr(199)||chr(195)||'O: ' || ds_acao_p,
                             1,
                             2000);

    ds_alteracao_us_w := substr('GOAL: ' || ds_objetivo_eng_p || chr(13) || chr(10) || 'CHANGES: ' || ds_alteracao_eng_p ||
                                chr(13) || chr(10) || 'ACTION TO TAKE: ' || ds_acao_eng_p,
                                1,
                                2000);

    select count(*) into STRICT qt_reg_old_w from alteracao_tasy where nr_seq_ordem_serv = nr_ordem_servico_p;

    if (qt_reg_old_w > 0) then
        delete FROM alteracao_tasy where nr_seq_ordem_serv = nr_ordem_servico_p;
    end if;

    select nextval('alteracao_tasy_seq') into STRICT nr_seq_alteracao_tasy_w;

    insert into alteracao_tasy(nr_sequencia,
         ds_aplicacao,
         dt_alteracao,
         ie_alteracao,
         dt_atualizacao,
         nm_usuario,
         ds_alteracao,
         ds_alteracao_origem,
         cd_funcao,
         cd_versao_atual,
         nr_seq_ordem_serv,
         ie_destaque_new,
         dt_atualizacao_nrec,
         nm_usuario_nrec,
         ie_tipo_alteracao,
         ie_interno_externo,
         ie_componente,
         dt_liberacao,
         nm_usuario_liberacao,
         ds_objetivo,
         ds_acao,
         ds_alteracao_txt,
         ie_tipo_cliente,
         ie_gerado_news,
         ie_global,
         ds_alteracao_us,
         ds_alteracao_origem_us,
         ds_objetivo_us,
         ds_acao_us,
         ds_alteracao_txt_us,
         ie_delphi,
         ie_java,
         ie_html5,
         ie_tws)
    values (nr_seq_alteracao_tasy_w,
         ds_aplicacao_p,
         clock_timestamp(),
         ie_alteracao_p,
         clock_timestamp(),
         nm_usuario_p,
         ds_alteracao_w,
         ds_alteracao_w,
         cd_funcao_p,
         null,
         nr_ordem_servico_p,
         ie_destaque_p,
         clock_timestamp(),
         nm_usuario_p,
         ie_tipo_alteracao_p,
         coalesce(ie_interno_externo_p, 'E'),
         ie_componente_p,
         CASE WHEN coalesce(ie_libera_news_p, 'N')='S' THEN  clock_timestamp()  ELSE null END ,
         CASE WHEN coalesce(ie_libera_news_p, 'N')='S' THEN  nm_usuario_p  ELSE null END ,
         ds_objetivo_p,
         ds_acao_p,
         ds_alteracao_p,
         coalesce(ie_tipo_cliente_p, 'A'),
         'S',
         ie_global_p,
         ds_alteracao_us_w,
         ds_alteracao_us_w,
         ds_objetivo_eng_p,
         ds_acao_eng_p,
         ds_alteracao_eng_p,
         ie_delphi_p,
         ie_java_p,
         ie_html5_p,
         ie_tws_p);

    if (ie_locales_p IS NOT NULL AND ie_locales_p::text <> '') then
        for r_c_split_locales in c_split_locales loop
            insert into alteracao_tasy_loc(nr_sequencia,
                 nr_seq_alteracao,
                 cd_localidade,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec)
            values (nextval('alteracao_tasy_loc_seq'),
                 nr_seq_alteracao_tasy_w,
                 r_c_split_locales.cd_locale,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p);
        end loop;
    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alteracao_tasy (dt_alteracao_p timestamp, ie_tipo_alteracao_p text, ds_aplicacao_p text, cd_funcao_p bigint, nr_ordem_servico_p bigint, ds_objetivo_p text, ds_alteracao_p text, ds_acao_p text, ie_destaque_p text, nm_usuario_p text, ie_alteracao_p text, ie_interno_externo_p text, ie_tipo_cliente_p text, ie_componente_p text, ie_libera_news_p text default null, ie_global_p text default null, ie_locales_p text default null, ds_objetivo_eng_p text default null, ds_alteracao_eng_p text default null, ds_acao_eng_p text default null, ie_delphi_p text default null, ie_java_p text default null, ie_html5_p text default null, ie_tws_p text default null) FROM PUBLIC;

