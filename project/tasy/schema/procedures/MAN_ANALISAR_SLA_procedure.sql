-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_analisar_sla () AS $body$
DECLARE


nr_sequencia_w	bigint;
qt_min_real_os_w	bigint;
ie_tempo_w			varchar(15);
nr_seq_ordem_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.ie_tempo,
			b.nr_sequencia
	from	man_ordem_serv_sla a,
			man_ordem_servico b,
			man_estagio_processo c
	where	a.nr_seq_ordem = b.nr_sequencia
	and 	a.nr_seq_estagio = c.nr_sequencia
	and		c.IE_SLA = 'S'
	and		b.IE_STATUS_ORDEM <> 3;


BEGIN


OPEN C01;
LOOP
FETCH C01 into
	nr_sequencia_w,
	ie_tempo_w,
	nr_seq_ordem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_tempo_w = 'COM')	then
		select	SUM(Man_Obter_Min_Com(obter_estabelecimento_ativo, a.dt_atualizacao,
		(coalesce((SELECT MIN(dt_atualizacao) FROM man_ordem_serv_estagio c WHERE nr_seq_ordem = a.nr_seq_ordem AND dt_atualizacao > a.dt_atualizacao),
		clock_timestamp()))))
		into STRICT	qt_min_real_os_w
		from	man_ordem_serv_estagio a,
				man_estagio_processo b
		where	a.nr_seq_estagio = b.nr_sequencia
		and		b.ie_sla = 'S'
		and		a.nr_seq_ordem = nr_seq_ordem_w;
	else
		select	sum(man_obter_tempo_estagio(a.nr_sequencia,a.nr_seq_ordem,'M'))
		into STRICT	qt_min_real_os_w
		from	man_ordem_serv_estagio a,
				man_estagio_processo b
		where	a.nr_seq_estagio = b.nr_sequencia
		and		b.ie_sla = 'S'
		and		a.nr_seq_ordem = nr_seq_ordem_w;
	end if;

	update	man_ordem_serv_sla
	set		qt_min_real_os = qt_min_real_os_w,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = 'Tasy'
	where	nr_sequencia = nr_sequencia_w;

END LOOP;
CLOSE C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_analisar_sla () FROM PUBLIC;

