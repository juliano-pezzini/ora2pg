-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_inf_copia_prescr (nr_atendimento_p bigint, ds_itens_liberar_p text, ie_liberou_enf_p text, ie_liberou_far_p text, cd_perfil_enf_p INOUT perfil.cd_perfil%type, cd_perfil_farm_p INOUT perfil.cd_perfil%type, cd_funcao_ativa_enf_p INOUT funcao.cd_funcao%type, cd_funcao_ativa_farm_p INOUT funcao.cd_funcao%type, nr_prescricoes_p INOUT prescr_medica.nr_prescricoes%type) AS $body$
DECLARE


cd_perfil_enf_w 			perfil.cd_perfil%type;
cd_perfil_farm_w 			perfil.cd_perfil%type;
cd_funcao_ativa_enf_w 		funcao.cd_funcao%type;
cd_funcao_ativa_farm_w 		funcao.cd_funcao%type;
nm_usuario_prescr_compl_w	usuario.nm_usuario%type;
nr_prescricoes_w			prescr_medica.nr_prescricoes%type;
nr_prescricao_compl_w		prescr_medica.nr_prescricao%type;
ie_tipo_dieta_w				cpoe_dieta.ie_tipo_dieta%type;
nr_seq_inf_adic_w			cpoe_inf_adic.nr_sequencia%type;
nr_seq_cpoe_order_unit_w 	cpoe_tipo_pedido.nr_sequencia%type := null;

dt_liberacao_enf_w	timestamp;
dt_liberacao_farm_w	timestamp;

nr_prescr_origem_w			varchar(255);
ie_prescr_duplicada_w			char(1) := 'N';

c01 CURSOR FOR
SELECT trim(both substr(cd_registro, 1, position(','  cd_registro) - 1)) ie_tipo_item,
   (substr(cd_registro, position(',' in cd_registro) + 1, length(cd_registro)))::numeric  nr_seq_cpoe
from table(lista_pck.obter_lista_char(ds_itens_liberar_p, ';'))
where   cd_registro like '%,%';

BEGIN

if (ds_itens_liberar_p IS NOT NULL AND ds_itens_liberar_p::text <> '') then

	for item in c01
	loop
	begin
		if (item.ie_tipo_item in ('M', 'N', 'R', 'G', 'P', 'D') and coalesce(item.nr_seq_cpoe,0) > 0) then

			nr_prescr_origem_w := substr(cpoe_obter_prescricao_original(item.nr_seq_cpoe, item.ie_tipo_item, nr_atendimento_p),1,255);

			if (length(nr_prescricoes_w) > 0) then

				select  coalesce(max('S'), 'N')
				into STRICT	ie_prescr_duplicada_w
				from    table(lista_pck.obter_lista_char(nr_prescricoes_w, ';'))
				where   cd_registro = nr_prescr_origem_w;

				if (ie_prescr_duplicada_w = 'N') then
					nr_prescricoes_w := substr(nr_prescricoes_w || nr_prescr_origem_w || ';',1,255);
				end if;							
			else
				if (nr_prescr_origem_w > 0) then
					nr_prescricoes_w :=  substr(nr_prescr_origem_w || ';',1,255);
				end if;
			end if;
						
			if (coalesce(nr_seq_inf_adic_w, 0) = 0) then
			
				select	max(nr_sequencia),
					max(cd_perfil_enf),
					max(cd_perfil_farm), 
					max(cd_funcao_ativa_enf), 
					max(cd_funcao_ativa_farm),
					max(nm_usuario_nrec)
				into STRICT	nr_seq_inf_adic_w,	
					cd_perfil_enf_w,
					cd_perfil_farm_w,
					cd_funcao_ativa_enf_w,
					cd_funcao_ativa_farm_w,
					nm_usuario_prescr_compl_w
				from	cpoe_inf_adic
				where	CASE WHEN item.ie_tipo_item='M' THEN  nr_seq_mat_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	CASE WHEN item.ie_tipo_item='N' THEN  nr_seq_diet_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	CASE WHEN item.ie_tipo_item='R' THEN  nr_seq_rec_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	CASE WHEN item.ie_tipo_item='G' THEN  nr_seq_gaso_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	CASE WHEN item.ie_tipo_item='P' THEN  nr_seq_exam_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	CASE WHEN item.ie_tipo_item='D' THEN  nr_seq_dial_cpoe  ELSE item.nr_seq_cpoe END  = item.nr_seq_cpoe
				and	((ie_liberou_enf_p = 'S' and (cd_funcao_ativa_enf IS NOT NULL AND cd_funcao_ativa_enf::text <> '') and (cd_perfil_enf IS NOT NULL AND cd_perfil_enf::text <> '')) and (ie_liberou_enf_p = 'N' and coalesce(cd_funcao_ativa_enf::text, '') = '' and coalesce(cd_perfil_enf::text, '') = ''))
				and	((ie_liberou_far_p = 'S' and (cd_funcao_ativa_farm IS NOT NULL AND cd_funcao_ativa_farm::text <> '') and (cd_perfil_farm IS NOT NULL AND cd_perfil_farm::text <> '')) and (ie_liberou_far_p = 'N' and coalesce(cd_funcao_ativa_farm::text, '') = '' and coalesce(cd_perfil_farm::text, '') = ''));

				if (coalesce(nr_seq_inf_adic_w, 0) = 0) then


					if (item.ie_tipo_item = 'M') then --Medicamento
						select  coalesce(min(a.nr_prescricao),0)
						into STRICT	nr_prescricao_compl_w
						from  	prescr_material a,
							prescr_medica b
						where  	a.nr_seq_mat_cpoe = item.nr_seq_cpoe
						and	a.nr_prescricao = b.nr_prescricao
						and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
						and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

					elsif (item.ie_tipo_item = 'N') then --Nutricao
						select	max(ie_tipo_dieta) /*(J,O,E,S,L,P,I)(Jejum,Dietas orais,Dietas enterais,Suplementos,Leites/formulas infantis,NPT Adulta,NPT Infantil)*/
						into STRICT	ie_tipo_dieta_w
						from	cpoe_dieta
						where	nr_sequencia = item.nr_seq_cpoe;

						if (ie_tipo_dieta_w = 'J') then /*Jejum*/
							select	coalesce(min(a.nr_prescricao),0) --Jejum
							into STRICT	nr_prescricao_compl_w
							from	rep_jejum a,
								prescr_medica b
							where	a.nr_seq_dieta_cpoe = item.nr_seq_cpoe
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'O') then

							select	coalesce(min(a.nr_prescricao),0)		--Oral
							into STRICT	nr_prescricao_compl_w
							from	prescr_dieta a,
								prescr_medica b
							where	a.nr_seq_dieta_cpoe = item.nr_seq_cpoe
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'E') then

							select	coalesce(min(a.nr_prescricao),0)	--Enteral
							into STRICT	nr_prescricao_compl_w
							from	prescr_material	a,
								prescr_medica b
							where   nr_seq_dieta_cpoe = item.nr_seq_cpoe
							and	a.ie_agrupador = 8
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'S') then

							select	coalesce(min(a.nr_prescricao),0) --Suplemento
							into STRICT	nr_prescricao_compl_w
							from	prescr_material a,
								prescr_medica b
							where   a.nr_seq_dieta_cpoe = item.nr_seq_cpoe
							and	a.ie_agrupador = 12
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'L') then

							select	coalesce(min(a.nr_prescricao),0) --Leites e Derivados
							into STRICT	nr_prescricao_compl_w
							from	prescr_leite_deriv a,
								prescr_medica b						
							where   a.nr_seq_dieta_cpoe = item.nr_seq_cpoe
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'P') then

							select	coalesce(min(a.nr_prescricao),0)	--Parenteral Adulto
							into STRICT	nr_prescricao_compl_w
							from	nut_pac a,
								prescr_medica b		
							where   a.nr_seq_npt_cpoe = item.nr_seq_cpoe
							and	a.ie_npt_adulta = 'S'
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						elsif (ie_tipo_dieta_w = 'I') then

							select	coalesce(min(a.nr_prescricao),0) --Parenteral Infantil 
							into STRICT	nr_prescricao_compl_w
							from	nut_pac a,
								prescr_medica b	
							where	a.nr_seq_npt_cpoe = item.nr_seq_cpoe
							and a.ie_npt_adulta = 'P'
							and	a.nr_prescricao = b.nr_prescricao
							and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
							and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

						end if;
						
					elsif (item.ie_tipo_item = 'R') then	

						select	coalesce(min(a.nr_prescricao),0)		--Recomendacao
						into STRICT	nr_prescricao_compl_w
						from	prescr_recomendacao a,
							prescr_medica b	
						where   a.nr_seq_rec_cpoe = item.nr_seq_cpoe
						and	a.nr_prescricao = b.nr_prescricao
						and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
						and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

					elsif (item.ie_tipo_item = 'G') then --Gasoterapia
						select	coalesce(min(a.nr_prescricao),0)	
						into STRICT	nr_prescricao_compl_w
						from	prescr_gasoterapia a,
							prescr_medica b	
						where   a.nr_seq_gas_cpoe = item.nr_seq_cpoe
						and	a.nr_prescricao = b.nr_prescricao
						and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
						and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

					elsif (item.ie_tipo_item = 'P') then --Procedimento
						select	coalesce(min(a.nr_prescricao),0)	
						into STRICT	nr_prescricao_compl_w
						from	prescr_procedimento a,
							prescr_medica b	
						where   a.nr_seq_proc_cpoe = item.nr_seq_cpoe
						and	a.nr_prescricao = b.nr_prescricao
						and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
						and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

					elsif (item.ie_tipo_item = 'D') then --Dialise
						select	coalesce(min(a.nr_prescricao),0)	
						into STRICT	nr_prescricao_compl_w
						from	hd_prescricao a,
							prescr_medica b	
						where   a.nr_seq_dialise_cpoe = item.nr_seq_cpoe
						and	a.nr_prescricao = b.nr_prescricao
						and	((ie_liberou_far_p = 'S' and (b.dt_liberacao_farmacia IS NOT NULL AND b.dt_liberacao_farmacia::text <> '')) or (ie_liberou_far_p = 'N' and coalesce(b.dt_liberacao_farmacia::text, '') = ''))
						and	((ie_liberou_enf_p = 'S' and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) or (ie_liberou_enf_p = 'N' and coalesce(b.dt_liberacao::text, '') = ''));

					end if;

					if (coalesce(nr_prescricao_compl_w,0) > 0) then
					
						select	max(cd_perfil_enf),
							max(cd_perfil_farm), 
							max(cd_funcao_ativa_enf), 
							max(cd_funcao_ativa_farm),
							max(nm_usuario_nrec)
						into STRICT	cd_perfil_enf_w,
							cd_perfil_farm_w,
							cd_funcao_ativa_enf_w,
							cd_funcao_ativa_farm_w,
							nm_usuario_prescr_compl_w
						from	prescr_medica_compl b
						where 	nr_prescricao = nr_prescricao_compl_w;

						if (coalesce(ie_liberou_enf_p, 'N') = 'S') then
							dt_liberacao_enf_w := clock_timestamp();
						end if;

						if (coalesce(ie_liberou_far_p, 'N') = 'S') then
							dt_liberacao_farm_w := clock_timestamp();
						end if;
						
						if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
							select 	max(nr_seq_cpoe_order_unit)
							into STRICT 	nr_seq_cpoe_order_unit_w
							from 	obter_order_type_cpoe_info_v
							where 	nr_seq_cpoe = item.nr_seq_cpoe;
						end if;

						CALL cpoe_atualizar_inf_adic(nr_atendimento_p, item.nr_seq_cpoe, item.ie_tipo_item,
									dt_liberacao_enf_w, dt_liberacao_farm_w, cd_perfil_enf_w, cd_perfil_enf_p,
									cd_funcao_ativa_farm_w, cd_funcao_ativa_enf_w, 'S', nr_seq_cpoe_order_unit_w);
					end if;
				end if;
			end if;
		end if;
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_OBTER_INF_COPIA_PRESCR EXCEPTION LOOP NR_PRESCRICOES:' || substr(to_char(sqlerrm),1,2000)
				|| obter_desc_expressao(712423) ||': ds_itens_liberar_p:' || ds_itens_liberar_p
				|| ' nr_atendimento_p: ' || nr_atendimento_p
				|| ' item.ie_tipo_item: ' || item.ie_tipo_item
				|| ' item.nr_seq_cpoe: ' || item.nr_seq_cpoe,1,2000), nr_atendimento_p);
	end;
	end loop;

	cd_perfil_enf_p := cd_perfil_enf_w;
	cd_perfil_farm_p := cd_perfil_farm_w;
	cd_funcao_ativa_enf_p := cd_funcao_ativa_enf_w;
	cd_funcao_ativa_farm_p := cd_funcao_ativa_farm_w;
	nr_prescricoes_p := nr_prescricoes_w;
end if;

commit;

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_OBTER_INF_COPIA_PRESCR EXCEPTION:' || substr(to_char(sqlerrm),1,2000)
			|| obter_desc_expressao(712423) ||': ds_itens_liberar_p:' || ds_itens_liberar_p
			|| ' nr_atendimento_p: ' || nr_atendimento_p
			|| ' ie_liberou_far_p: ' || ie_liberou_far_p
			|| ' ie_liberou_enf_p: ' || ie_liberou_enf_p,1,2000), nr_atendimento_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_inf_copia_prescr (nr_atendimento_p bigint, ds_itens_liberar_p text, ie_liberou_enf_p text, ie_liberou_far_p text, cd_perfil_enf_p INOUT perfil.cd_perfil%type, cd_perfil_farm_p INOUT perfil.cd_perfil%type, cd_funcao_ativa_enf_p INOUT funcao.cd_funcao%type, cd_funcao_ativa_farm_p INOUT funcao.cd_funcao%type, nr_prescricoes_p INOUT prescr_medica.nr_prescricoes%type) FROM PUBLIC;

