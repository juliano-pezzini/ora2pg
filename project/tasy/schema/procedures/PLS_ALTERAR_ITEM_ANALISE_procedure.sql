-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_item_analise ( nr_sequencia_p bigint, nr_seq_item_ref_p bigint, nr_seq_analise_p bigint, ie_tecnica_utilizada_p text, ie_autogerado_p text, tx_item_p bigint, ie_cobranca_prevista_p text, ie_via_acesso_p text, dt_procedimento_p text, dt_fim_proc_p text, dt_inicio_proc_p text, nr_seq_setor_atend_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, ie_criterio_horario_p text, vl_procedimento_imp_p bigint, qt_procedimento_imp_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
ie_tecnica_utilizada_w		varchar(10);
ie_autogerado_w			varchar(10);
ie_cobranca_prevista_w		varchar(10);
ie_via_acesso_w			varchar(10);
ds_setor_atendimento_w		varchar(255);
ds_setor_atendimento_ww		varchar(255);
ds_observacao_w			varchar(4000);
ie_preco_w			varchar(5);
ie_criterio_horario_w		varchar(2);

tx_item_w			bigint;
nr_seq_setor_atend_w		bigint;
nr_seq_conta_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_identificador_w		bigint;
nr_seq_proc_ref_w		bigint;
vl_procedimento_imp_w	double precision;
qt_procedimento_imp_w	double precision;
ie_valor_informado_w	varchar(1);	
 
dt_procedimento_w		timestamp;
dt_procedimento_ww		timestamp;
dt_fim_proc_w			timestamp;
dt_fim_proc_ww			timestamp;
dt_inicio_proc_w		timestamp;
dt_inicio_proc_ww		timestamp;
ie_parametro_w			varchar(2);
ie_origem_conta_w		varchar(2);
ie_vl_apresentado_sistema_w	varchar(1);
nr_seq_regra_via_acesso_w	bigint;
tx_item_via_acesso_w		double precision := null;
ie_atualiza_via_acesso_w	varchar(1);
ie_via_acesso_manual_w		pls_conta_proc.ie_via_acesso_manual%type;


BEGIN 
 
if (dt_procedimento_p = ' / /  ') then 
	dt_procedimento_w := null;
else 
	begin 
	dt_procedimento_w := to_date(dt_procedimento_p,'dd/mm/yyyy');
	exception 
	when others then 
		dt_procedimento_w := null;
	end;
end if;
 
if (dt_inicio_proc_p = ' : : ') then 
	dt_inicio_proc_w := null;
else 
	begin 
	dt_inicio_proc_w := to_date(to_char(coalesce(dt_procedimento_w,clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(dt_inicio_proc_p, '00:00:01'),'dd/mm/yyyy hh24:mi:ss');
	exception 
	when others then 
		dt_inicio_proc_w := null;
	end;
end if;
 
if (dt_fim_proc_p = ' : : ') then 
	dt_fim_proc_w := null;
else 
	begin 
	dt_fim_proc_w := to_date(to_char(coalesce(dt_procedimento_w,clock_timestamp()),'dd/mm/yyyy') || ' ' ||coalesce(dt_fim_proc_p, '00:00:01'),'dd/mm/yyyy hh24:mi:ss');
	exception 
	when others then 
		dt_fim_proc_w := null;
	end;
end if;
 
select	a.ie_tecnica_utilizada, 
	a.ie_autogerado, 
	a.tx_item, 
	coalesce(a.ie_cobranca_prevista,'N'), 
	a.ie_via_acesso, 
	a.dt_procedimento, 
	a.dt_fim_proc, 
	a.dt_inicio_proc, 
	a.nr_seq_setor_atend, 
	a.nr_seq_conta, 
	a.cd_procedimento, 
	a.ie_origem_proced, 
	c.ie_preco, 
	a.ie_criterio_horario, 
	a.vl_procedimento_imp, 
	a.qt_procedimento_imp, 
	d.ie_origem_conta, 
	a.ie_valor_informado, 
	a.ie_vl_apresentado_sistema, 
	a.nr_seq_regra_via_acesso 
into STRICT	ie_tecnica_utilizada_w, 
	ie_autogerado_w, 
	tx_item_w, 
	ie_cobranca_prevista_w, 
	ie_via_acesso_w, 
	dt_procedimento_ww, 
	dt_fim_proc_ww, 
	dt_inicio_proc_ww, 
	nr_seq_setor_atend_w, 
	nr_seq_conta_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	ie_preco_w, 
	ie_criterio_horario_w, 
	vl_procedimento_imp_w, 
	qt_procedimento_imp_w, 
	ie_origem_conta_w, 
	ie_valor_informado_w, 
	ie_vl_apresentado_sistema_w, 
	nr_seq_regra_via_acesso_w 
FROM pls_conta_proc a, pls_conta d
LEFT OUTER JOIN pls_segurado b ON (d.nr_seq_segurado = b.nr_sequencia)
LEFT OUTER JOIN pls_plano c ON (b.nr_seq_plano = c.nr_sequencia)
WHERE d.nr_sequencia		= a.nr_seq_conta and a.nr_sequencia 		= coalesce(nr_sequencia_p, nr_seq_item_ref_p);
 
if (ie_preco_w not in ('2','3')) and (coalesce(ie_cobranca_prevista_p,'N') = 'S') then 
	--(-20011,'Não é permitido gerar cobrança prevista para beneficiário com produto Pós-estabelecido! #@#@');	 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191456);
end if;
 
if (ie_origem_conta_w in ('A','E')) then 
 
	if (coalesce(vl_procedimento_imp_w,0) <> coalesce(vl_procedimento_imp_p,0)) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191454);
		/*Não é permitico alterar o valor apresentado de arquivo importado*/
 
	end if;
 
	if (coalesce(qt_procedimento_imp_w,0) <> coalesce(qt_procedimento_imp_p,0)) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191455);
		/*Não é permitico alterar a quantidade apresentado de arquivo importado*/
 
	end if;
end if;
 
if (coalesce(vl_procedimento_imp_w,0) <> coalesce(vl_procedimento_imp_p,0))then 
	ie_valor_informado_w := 'S';
end if;
 
if (coalesce(vl_procedimento_imp_w,0) <> coalesce(vl_procedimento_imp_p,0)) then 
	ie_vl_apresentado_sistema_w := 'N';
end if;
 
if (coalesce(ie_via_acesso_w,'X') <> coalesce(ie_via_acesso_p,'X')) then 
	ie_via_acesso_manual_w	:= 'S';
	nr_seq_regra_via_acesso_w := null;
	ie_atualiza_via_acesso_w := obter_valor_param_usuario(1208, 28, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p);	
	if (coalesce(ie_atualiza_via_acesso_w,'N') = 'S') then 
		select 	obter_tx_proc_via_acesso(ie_via_acesso_p) 
		into STRICT	tx_item_via_acesso_w 
		;
	end if;	
end if;
 
update	pls_conta_proc 
set	ie_tecnica_utilizada	=	ie_tecnica_utilizada_p, 
	ie_autogerado		=	ie_autogerado_p, 
	tx_item			= 	coalesce(tx_item_via_acesso_w,tx_item_p), 
	ie_cobranca_prevista	=	coalesce(ie_cobranca_prevista_p,'N'), 
	ie_via_acesso		=	ie_via_acesso_p, 
	dt_procedimento		=	dt_procedimento_w, 
	dt_fim_proc		=	dt_fim_proc_w, 
	dt_inicio_proc		=	dt_inicio_proc_w, 
	nr_seq_setor_atend	=	nr_seq_setor_atend_p, 
	ie_criterio_horario	=	ie_criterio_horario_p, 
	vl_procedimento_imp 	= 	vl_procedimento_imp_p, 
	qt_procedimento_imp 	= 	qt_procedimento_imp_p, 
	ie_valor_informado	= 	ie_valor_informado_w, 
	nr_seq_regra_via_acesso = 	nr_seq_regra_via_acesso_w, 
	ie_vl_apresentado_sistema	= ie_vl_apresentado_sistema_w, 
	vl_unitario_imp		=	dividir(vl_procedimento_imp_p,qt_procedimento_imp_p),--jjung 01/11/2012 OS - 490768 - atualizar o valor unitário do item., 
	ie_via_acesso_manual	= 	CASE WHEN ie_via_acesso_manual_w='S' THEN ie_via_acesso_manual_w  ELSE ie_via_acesso_manual END  
where	nr_sequencia 		= 	nr_sequencia_p 
or	nr_seq_proc_ref		=	nr_seq_item_ref_p 
or	nr_sequencia		=	nr_seq_item_ref_p;
 
update	w_pls_resumo_conta 
set	ds_via_acesso		=	obter_valor_dominio(1268, ie_via_acesso_p), 
	tx_item			= 	coalesce(tx_item_via_acesso_w,tx_item_p), 
	dt_item 		=	dt_procedimento_w, 
	dt_inicio_item		=	dt_inicio_proc_w, 
	nr_seq_setor_atend	=	nr_seq_setor_atend_p, 
	ds_setor_atendimento	=	pls_obter_dados_setor_atend(nr_seq_setor_atend_p,'DS'), 
	vl_total_apres		= vl_procedimento_imp_p, 
	qt_apresentado		= qt_procedimento_imp_p, 
	vl_unitario_apres	= dividir(vl_procedimento_imp_p,qt_procedimento_imp_p) 
where (nr_seq_item 		= 	nr_sequencia_p 
or	nr_seq_item_ref		=	nr_seq_item_ref_p) 
and	ie_tipo_item		in ('P', 'R');
 
 
CALL pls_atualizar_proc_ref(coalesce(nr_seq_item_ref_p,nr_sequencia_p), cd_estabelecimento_p, nm_usuario_p);
 
select	max(nr_identificador) 
into STRICT	nr_identificador_w 
from	w_pls_resumo_conta 
where	nr_seq_item 		= 	nr_sequencia_p 
and	ie_tipo_item		=	'P';
 
 
if (coalesce(vl_procedimento_imp_w,0) <> coalesce(vl_procedimento_imp_p,0)) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Valor apresentado:'||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||vl_procedimento_imp_w||' - Modificado: '||vl_procedimento_imp_p||chr(13)||chr(10);
end if;
 
if (coalesce(qt_procedimento_imp_w,0) <> coalesce(qt_procedimento_imp_p,0)) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Quantidade apresentada:'||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||qt_procedimento_imp_w||' - Modificado: '||qt_procedimento_imp_p||chr(13)||chr(10);
end if;
	 
if (coalesce(ie_tecnica_utilizada_p,'X') <> coalesce(ie_tecnica_utilizada_w,'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Técnica utilizada:'||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||obter_valor_dominio(1834, ie_tecnica_utilizada_w)||' - Modificada: '||obter_valor_dominio(1834, ie_tecnica_utilizada_p)||chr(13)||chr(10);
end if;
 
if (coalesce(ie_criterio_horario_w,'X') <> coalesce(ie_criterio_horario_p,'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Critério de horário:'||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||ie_criterio_horario_w||' - Modificado: '||ie_criterio_horario_p||chr(13)||chr(10);
end if;
 
if (coalesce(ie_via_acesso_p,'X') <> coalesce(ie_via_acesso_w,'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Via acesso: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||obter_valor_dominio(1268, ie_via_acesso_w)||' - Modificada: '||obter_valor_dominio(1268, ie_via_acesso_p)||chr(13)||chr(10);							
end if;
 
if (coalesce(tx_item_via_acesso_w,coalesce(tx_item_p,0)) <> coalesce(tx_item_w,0)) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'% Taxa: '||chr(13)||chr(10)||	 
				chr(9)||'Anterior: '||tx_item_w||' - Modificada: '||coalesce(tx_item_via_acesso_w,coalesce(tx_item_p,0))||chr(13)||chr(10);
end if;
 
if (coalesce(nr_seq_setor_atend_p,0) <> coalesce(nr_seq_setor_atend_w,0)) then 
	 
	select	max(ds_setor_atendimento) 
	into STRICT	ds_setor_atendimento_w 
	from 	pls_setor_atendimento 
	where	nr_sequencia = nr_seq_setor_atend_p;
	 
	select	max(ds_setor_atendimento) 
	into STRICT	ds_setor_atendimento_ww 
	from 	pls_setor_atendimento 
	where	nr_sequencia = nr_seq_setor_atend_w;
	 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Setor atend.: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||ds_setor_atendimento_ww||' - Modificado: '||ds_setor_atendimento_w||chr(13)||chr(10);
end if;
 
if (coalesce(to_char(dt_procedimento_w),'X') <> coalesce(to_char(dt_procedimento_ww),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Dt. procedimento: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_procedimento_ww, 'dd/mm/yyyy')||' - Modificada: '||to_char(dt_procedimento_w, 'dd/mm/yyyy')||chr(13)||chr(10);
end if;
 
if (coalesce(to_char(dt_fim_proc_w, 'hh24:mi:ss'),'X') <> coalesce(to_char(dt_fim_proc_ww, 'hh24:mi:ss'),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Hora fim: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_fim_proc_ww, 'hh24:mi:ss')||' - Modificada: '||to_char(dt_fim_proc_w, 'hh24:mi:ss')||chr(13)||chr(10);
end if;
 
if (coalesce(to_char(dt_inicio_proc_w, 'hh24:mi:ss'),'X') <> coalesce(to_char(dt_inicio_proc_ww, 'hh24:mi:ss'),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Hora início: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_inicio_proc_ww, 'hh24:mi:ss')||' - Modificada: '||to_char(dt_inicio_proc_w, 'hh24:mi:ss')||chr(13)||chr(10);
end if;
 
if (coalesce(ie_cobranca_prevista_p,'X') <> coalesce(ie_cobranca_prevista_w,'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Cobrança prevista: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||coalesce(ie_cobranca_prevista_w,'N')||' - Modificada: '||ie_cobranca_prevista_p||chr(13)||chr(10);
end if;
 
if (coalesce(ie_autogerado_p,'X') <> coalesce(ie_autogerado_w,'X')) then	 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Autogerado: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||coalesce(ie_autogerado_w,'N')||' - Modificado: '||coalesce(ie_autogerado_p,'N')||chr(13)||chr(10);
end if;
 
if (coalesce(nr_seq_setor_atend_w,0) <> coalesce(nr_seq_setor_atend_p,0)) then	 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Setor atendimento: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||pls_obter_dados_setor_atend(nr_seq_setor_atend_w,'DS')||' - Modificada: '||pls_obter_dados_setor_atend(nr_seq_setor_atend_p,'DS')||' - '||pls_obter_dados_setor_atend(nr_seq_setor_atend_p,'DS')||chr(13)||chr(10);
end if;
 
if (coalesce(ds_observacao_w,'X') <> 'X') then 
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_p, 15, 
				 nr_sequencia_p, 'P', null, 
				 null, 'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'||chr(13)||chr(10)|| 
					'Item '||nr_identificador_w||' - '||pls_obter_desc_procedimento(cd_procedimento_w, ie_origem_proced_w)||'.'||chr(13)||chr(10)|| 
				 ds_observacao_w, nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
end if;
 
/* ASKONO - OS367634 - SOLICITAÇÃO UNIMED RIO PRETO PARA RECONSISTÊNCIA AUTOMÁTICA APÓS ALTERAÇÃO DAS INFORMAÇÕES DO ITEM OU DA CONTA */
 
ie_parametro_w := obter_valor_param_usuario(1317,15,Obter_Perfil_Ativo,nm_usuario_p,cd_estabelecimento_p);
 
if (coalesce(ie_parametro_w,'N') = 'S') then 
	CALL pls_reconsistir_analise(nr_seq_analise_p,nr_seq_grupo_p,cd_estabelecimento_p, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_item_analise ( nr_sequencia_p bigint, nr_seq_item_ref_p bigint, nr_seq_analise_p bigint, ie_tecnica_utilizada_p text, ie_autogerado_p text, tx_item_p bigint, ie_cobranca_prevista_p text, ie_via_acesso_p text, dt_procedimento_p text, dt_fim_proc_p text, dt_inicio_proc_p text, nr_seq_setor_atend_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, ie_criterio_horario_p text, vl_procedimento_imp_p bigint, qt_procedimento_imp_p bigint, nm_usuario_p text) FROM PUBLIC;

