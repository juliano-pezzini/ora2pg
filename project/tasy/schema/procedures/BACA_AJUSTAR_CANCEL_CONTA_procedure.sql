-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_cancel_conta () AS $body$
DECLARE

 
 
nr_interno_conta_w	bigint;
nr_atendimento_w	bigint;
qt_cancelada_w	integer;

 
 
c01 CURSOR FOR 
SELECT	(somente_numero(substr(ds_log, 75, position('nr_seq_protocolo_w'  ds_log) - 75)))::numeric  
from	log_tasy 
where	cd_log = 55600 
and	substr(ds_log, 75, position('nr_seq_protocolo_w' in ds_log) - 75) is not null 
and	substr(ds_log,1,52) = 'Chamada procedure cancelar_titulo_conta, parametros:'
 
and	dt_atualizacao > clock_timestamp() - interval '5 days';

 

BEGIN 
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	select	nr_atendimento 
	into STRICT	nr_atendimento_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_w;
 
	select	count(*) 
	into STRICT	qt_cancelada_w 
	from	conta_paciente 
	where	nr_atendimento = nr_atendimento_w 
	and	(IE_CANCELAMENTO IS NOT NULL AND IE_CANCELAMENTO::text <> '');
 
	if (qt_cancelada_w = 0) then 
		CALL Estornar_Conta_Paciente(nr_interno_conta_w, 'BacaAjuste_Tasy');
	end if;
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_cancel_conta () FROM PUBLIC;

