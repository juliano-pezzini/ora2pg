-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_macroscopia_por_peca ( nr_prescricao_p bigint, nm_usuario_p text, ie_inserir_iniciais_medico_p text, ds_error_p INOUT text) AS $body$
DECLARE

ds_error_w		varchar(100) := '';
ie_libera_macroscopia_w	varchar(1);
nr_seq_macroscopia_w	bigint;
nr_seq_peca_w		bigint;
ds_macroscopia_w	text;
ds_inciais_w		varchar(10);
C01 CURSOR FOR
	SELECT	nr_sequencia 
	from 	prescr_proc_peca 
	where 	nr_prescricao = nr_prescricao_p 
	and  	(nr_sequencia_princ IS NOT NULL AND nr_sequencia_princ::text <> '') 
	order 	by 1;

C02 CURSOR FOR 
	SELECT 	nr_sequencia 
	from 	prescr_proc_macroscopia a 
	where 	nr_seq_peca = nr_seq_peca_w 
	order 	by 1;


BEGIN 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_peca_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
			open C02;
			loop 
			fetch C02 into	 
				nr_seq_macroscopia_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				 
				select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
				into STRICT	ie_libera_macroscopia_w 
				from	prescr_proc_macroscopia 
				where	nr_sequencia 	= nr_seq_macroscopia_w 
				and	(ds_macroscopia IS NOT NULL AND ds_macroscopia::text <> '') 
				and	coalesce(dt_inativacao::text, '') = '' 
				and	coalesce(dt_liberacao::text, '') = '';
 
				if (ie_libera_macroscopia_w = 'S') then 
					begin 
					if ('N' = 'S') then 
						begin 
						select 	ds_macroscopia, 
							obter_iniciais_nome(cd_profissional,null) 
						into STRICT	ds_macroscopia_w, 
							ds_inciais_w 
						from	prescr_proc_macroscopia 
						where	nr_sequencia = nr_seq_macroscopia_w;
 
						ds_macroscopia_w := ds_macroscopia_w || '#13' || '#13' || ds_inciais_w;
						 
						update	prescr_proc_macroscopia 
						set	ds_macroscopia	= ds_macroscopia_w 
						where	nr_seq_peca = nr_seq_macroscopia_w;
							 
						end;
					end if;					
					 
					CALL gm_liberar_macroscopia(nr_seq_macroscopia_w,nm_usuario_p);
					end;
				else 
					ds_error_w := 'Não é possível liberar todas as Macroscopia, existe macroscopia com descrição em branco!';
				end if;
				end;
			end loop;
			close C02;
		end;
	end loop;
	close C01;
	ds_error_p	:= ds_error_w;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_macroscopia_por_peca ( nr_prescricao_p bigint, nm_usuario_p text, ie_inserir_iniciais_medico_p text, ds_error_p INOUT text) FROM PUBLIC;

