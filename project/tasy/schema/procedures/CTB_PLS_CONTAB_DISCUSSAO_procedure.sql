-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_contab_discussao ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Contabilizar os valores de discussao
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_estabelecimento_w		w_movimento_contabil.cd_estabelecimento%type;
cd_conta_contabil_w			w_movimento_contabil.cd_conta_contabil%type;
ie_debito_credito_w			w_movimento_contabil.ie_debito_credito%type;
vl_contabil_w				w_movimento_contabil.vl_movimento%type;
nr_seq_w_movto_cont_w		w_movimento_contabil.nr_sequencia%type;
cd_historico_w				w_movimento_contabil.cd_historico%type;
nr_seq_conta_w				pls_conta.nr_sequencia%type;
cd_centro_custo_w			w_movimento_contabil.cd_centro_custo%type;
ie_centro_custo_w			conta_contabil.ie_centro_custo%type;
nr_lote_contabil_w			w_movimento_contabil.nr_lote_contabil%type;
nr_seq_prestador_w			pls_prestador.nr_sequencia%type;
nr_seq_protocolo_w			pls_protocolo_conta.nr_sequencia%type;
cd_cgc_prestador_w			pls_prestador.cd_cgc%type;
cd_cpf_prestador_w			pls_prestador.cd_pessoa_fisica%type;
nr_seq_regra_cc_w			pls_regra_centro_custo.nr_sequencia%type;
nr_seq_segurado_w			pls_segurado.nr_sequencia%type;
nr_seq_plano_w				pls_plano.nr_sequencia%type;
ie_regulamentacao_w			pls_plano.ie_regulamentacao%type;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
cd_procedimento_w			procedimento.cd_procedimento%type;
ie_origem_proced_w			procedimento.ie_origem_proced%type;
nr_seq_material_w			pls_material.nr_sequencia%type;
nr_seq_info_ctb_w			informacao_contabil.nr_sequencia%type;
nm_tabela_w					w_movimento_contabil.nm_tabela%type;
nm_atributo_w				w_movimento_contabil.nm_atributo%type;
cd_tipo_lote_contabil_w		lote_contabil.cd_tipo_lote_contabil%type;
nm_agrupador_w				agrupador_contabil.nm_atributo%type;
nr_seq_agrupamento_w		w_movimento_contabil.nr_seq_agrupamento%type;
nr_seq_lote_contest_w		pls_lote_discussao.nr_seq_lote_contest%type;
nr_seq_ptu_fatura_w			pls_lote_contestacao.nr_seq_ptu_fatura%type;
nr_seq_pls_fatura_w			pls_lote_contestacao.nr_seq_pls_fatura%type;
nr_tit_pagar_origem_w		titulo_pagar.nr_titulo%type;
nr_tit_rec_origem_w			titulo_pagar.nr_titulo%type;
ds_conteudo_w				varchar(4000);
vl_retorno_w				varchar(2000);
ds_item_w					varchar(255);
nm_prestador_w				varchar(255);
ds_compl_historico_w		varchar(255);
ds_compl_historico_ww		varchar(255);
nr_pls_fatura_w				varchar(255);
nr_pls_ndr_w				varchar(255);
nr_fatura_w					varchar(255);
nr_ndr_w					varchar(255);
ds_unimed_w					varchar(255);
ie_tipo_item_w				varchar(10);
ie_proc_mat_w				varchar(2);
ie_compl_hist_w				varchar(2);
nr_seq_item_w				bigint;
dt_referencia_w				timestamp;
dt_referencia_mens_w		timestamp;
dt_ref_inicial_w			timestamp;
dt_ref_final_w				timestamp;
nr_lote_contabil_cancel_w		pls_lote_discussao.nr_lote_contabil_cancel%type;
ie_tipo_movimento_w		varchar(1);
nr_lote_contab_movimento_w			pls_lote_discussao.nr_lote_contabil%type;

c_discussao CURSOR FOR
	SELECT	'D', /* debito procedimento*/
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_deb,
		d.vl_aceito,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_ACEITO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	
union all

	SELECT	'C', /* credito procedimento */
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_cred,
		d.vl_aceito,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_ACEITO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	
union all

	/* Valor negado */

	select	'D', /* debito procedimento*/
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_negado_deb,
		d.vl_negado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_NEGADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	and	coalesce(d.ie_tipo_acordo,'X') <> '12'	-- OS 1309700nao considerar os casos de questionamento liberado na Parcial, nos casos de recebimento de arquivos parciais poderia ocorrer contabilizacao em duplicidade.
	
union all

	select	'C', /* credito procedimento */
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_negado_cred,
		d.vl_negado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_NEGADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	and	coalesce(d.ie_tipo_acordo,'X') <> '12' -- OS 1309700nao considerar os casos de questionamento liberado na Parcial, nos casos de recebimento de arquivos parciais poderia ocorrer contabilizacao em duplicidade.
	
union all

	select	'C', /* credito procedimento */
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_negado_cred,
		d.vl_contestado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_CONTESTADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') = '1'
	
union all

	select	'D', /* debito procedimento */
		'P', /*Procedimento*/
		d.nr_sequencia,
		d.cd_conta_negado_deb,
		d.vl_contestado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		f.cd_procedimento,
		f.ie_origem_proced,
		null nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_PROC' nm_tabela,
		'VL_CONTESTADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_proc			f,
		pls_conta			e,
		pls_discussao_proc		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_proc
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') = '1'
	
union all

	select	'D', /* debito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_deb,
		d.vl_aceito,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_ACEITO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	
union all

	select	'C', /* credito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_cred,
		d.vl_aceito,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_ACEITO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	
union all

	/* Valor negado */

	select	'D', /* debito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_negado_deb,
		d.vl_negado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_NEGADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	and	coalesce(d.ie_tipo_acordo,'X') <> '12'	-- OS 1309700nao considerar os casos de questionamento liberado na Parcial, nos casos de recebimento de arquivos parciais poderia ocorrer contabilizacao em duplicidade.
	
union all

	select	'C', /* credito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_negado_cred,
		d.vl_negado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_NEGADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') <> '1'
	and	coalesce(d.ie_tipo_acordo,'X') <> '12'	-- OS 1309700nao considerar os casos de questionamento liberado na Parcial, nos casos de recebimento de arquivos parciais poderia ocorrer contabilizacao em duplicidade.
	
union all

	select	'D', /* debito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_negado_deb,
		d.vl_contestado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_CONTESTADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') = '1'
	
union all

	select	'C', /* credito material */
		'M', /*Material*/
	
		d.nr_sequencia,
		d.cd_conta_negado_cred,
		d.vl_contestado,
		trunc(CASE WHEN coalesce(a.nr_lote_contabil_cancel,0)=nr_lote_contabil_p THEN a.dt_cancelamento  ELSE a.dt_fechamento END ,'dd'),
		d.cd_historico_negado,
		e.nr_sequencia,
		e.nr_seq_segurado,
		null cd_procedimento,
		null ie_origem_proced,
		f.nr_seq_material,
		d.cd_centro_custo,
		'PLS_DISCUSSAO_MAT' nm_tabela,
		'VL_CONTESTADO' nm_atributo,
		29 nr_seq_info_ctb,
		e.nr_seq_plano,
		e.nr_seq_protocolo,
		e.nr_seq_prestador_exec,
		a.nr_seq_lote_contest,
		a.nr_lote_contabil_cancel,
		a.nr_lote_contabil
	from	pls_conta_mat			f,
		pls_conta			e,
		pls_discussao_mat		d,
		pls_contestacao			c,
		pls_contestacao_discussao	b,
		pls_lote_discussao		a
	where	a.nr_sequencia		= b.nr_seq_lote
	and	c.nr_sequencia		= b.nr_seq_contestacao
	and	e.nr_sequencia		= c.nr_seq_conta
	and	b.nr_sequencia		= d.nr_seq_discussao
	and	f.nr_sequencia		= d.nr_seq_conta_mat
	and	((a.nr_lote_contabil 	= nr_lote_contabil_p)
	or (a.nr_lote_contabil_cancel = nr_lote_contabil_p))
	and	coalesce(a.ie_tipo_arquivo,'0') = '1';
	
nr_vetor_w			bigint	:= 0;
type registro is table of w_movimento_contabil%RowType index by integer;
w_movto_contabil_w		registro;

c_tipo_movimento CURSOR FOR
	SELECT	'N'
	
	where	nr_lote_contab_movimento_w = nr_lote_contabil_p
	
union all

	SELECT	'C'
	
	where	nr_lote_contabil_cancel_w = nr_lote_contabil_p;


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 38) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
select	dt_referencia,
	cd_estabelecimento,
	nr_lote_contabil,
	cd_tipo_lote_contabil
into STRICT 	dt_referencia_w,
	cd_estabelecimento_w,
	nr_lote_contabil_w,
	cd_tipo_lote_contabil_w
from 	lote_contabil
where 	nr_lote_contabil 	= nr_lote_contabil_p;

dt_ref_inicial_w	:= trunc(dt_referencia_w,'month');
dt_ref_final_w		:= fim_dia(fim_mes(dt_ref_inicial_w));

delete	from w_pls_movimento_sem_conta
where	ie_tipo_item in ('PCM','MCM')
and	dt_referencia between dt_ref_inicial_w and dt_ref_final_w;

if (ie_exclusao_p = 'S') then
	CALL wheb_usuario_pck.set_ie_lote_contabil('S');
	
	delete from movimento_contabil
	where  nr_lote_contabil		= nr_lote_contabil_p;

	update	lote_contabil
	set	vl_credito 		= 0,
		vl_debito  		= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;
	
	update	pls_discussao_proc a
	set	a.nr_lote_contabil	= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;
	
	update	pls_discussao_mat a
	set	a.nr_lote_contabil	= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;

	update	pls_lote_discussao
	set	nr_lote_contabil	= 0
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	commit;
	
	update	pls_lote_discussao
	set	nr_lote_contabil_cancel	= 0
	where	nr_lote_contabil_cancel 	= nr_lote_contabil_p;
	
	commit;

	CALL wheb_usuario_pck.set_ie_lote_contabil('N');
else
	CALL wheb_usuario_pck.set_ie_lote_contabil('S');
	
	CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
				1,
				wheb_mensagem_pck.get_texto(1097173),
				nm_usuario_p);

	delete	from w_movimento_contabil
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	update	pls_lote_discussao	a
	set	nr_lote_contabil 		= nr_lote_contabil_p
	where 	coalesce(nr_lote_contabil,0) 	= 0
	and	ie_status			= 'F'
	and	dt_fechamento between dt_ref_inicial_w and dt_ref_final_w
	and	exists (SELECT	1
			from	pls_lote_contestacao x
			where	x.nr_sequencia		= a.nr_seq_lote_contest
			and	x.cd_estabelecimento	= cd_estabelecimento_w);
			
	commit;		
			
	update	pls_discussao_mat	d
	set	d.nr_lote_contabil 	= nr_lote_contabil_p
	where	exists (SELECT	1
			from	pls_contestacao_discussao	b,
				pls_lote_discussao		a
			where	a.nr_sequencia		= b.nr_seq_lote
			and	b.nr_sequencia		= d.nr_seq_discussao
			and	a.nr_lote_contabil	= nr_lote_contabil_p);
			
	commit;		
			
	update	pls_discussao_proc	d
	set	d.nr_lote_contabil 	= nr_lote_contabil_p
	where	exists (SELECT	1
			from	pls_contestacao_discussao	b,
				pls_lote_discussao		a
			where	a.nr_sequencia		= b.nr_seq_lote
			and	b.nr_sequencia		= d.nr_seq_discussao
			and	a.nr_lote_contabil	= nr_lote_contabil_p);
			
	commit;		
	
	update	pls_lote_discussao	d
	set	d.nr_lote_contabil_cancel	= nr_lote_contabil_p
	where	coalesce(d.nr_lote_contabil_cancel,0) = 0	
	and	d.ie_status			= 'C'
	and	d.dt_cancelamento between dt_ref_inicial_w and dt_ref_final_w
	and	coalesce(d.nr_lote_contabil,0) <> 0;

	commit;
			
	CALL wheb_usuario_pck.set_ie_lote_contabil('N');
	
	/*  Paulo 29/09/2009 - OS 168594 */

	begin
	ie_compl_hist_w	:= obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil_w);
	exception
	when others then
		ie_compl_hist_w	:= 'N';
	end;
	
	nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(cd_tipo_lote_contabil_w)), 'NR_SEQ_CONTA');
	
	nr_seq_w_movto_cont_w	:= 0;
	
	open c_discussao;
	loop
	fetch c_discussao into
		ie_debito_credito_w,
		ie_proc_mat_w,
		nr_seq_item_w,
		cd_conta_contabil_w,
		vl_contabil_w,
		dt_referencia_mens_w,
		cd_historico_w,
		nr_seq_conta_w,
		nr_seq_segurado_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_material_w,
		cd_centro_custo_w,
		nm_tabela_w,
		nm_atributo_w,
		nr_seq_info_ctb_w,
		nr_seq_plano_w,
		nr_seq_protocolo_w,
		nr_seq_prestador_w,
		nr_seq_lote_contest_w,
		nr_lote_contabil_cancel_w,
		nr_lote_contab_movimento_w;
	EXIT WHEN NOT FOUND; /* apply on c_discussao */
		begin
		
		open c_tipo_movimento;
		loop
		fetch c_tipo_movimento into
			ie_tipo_movimento_w;
		EXIT WHEN NOT FOUND; /* apply on c_tipo_movimento */
			
			if (ie_tipo_movimento_w = 'C') then
				vl_contabil_w := vl_contabil_w * (-1);
			end if;
			
			if (substr(ie_proc_mat_w,1,1) = 'P') then
				ds_item_w	:= substr(obter_descricao_procedimento(cd_procedimento_w,ie_origem_proced_w),1,255);
			elsif (substr(ie_proc_mat_w,1,1) = 'M') then
				ds_item_w	:= substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',nr_seq_material_w),1,255);
			end if;

			if (coalesce(nr_seq_plano_w::text, '') = '') then
				begin		
				select	b.ie_regulamentacao,
					b.nr_sequencia
				into STRICT	ie_regulamentacao_w,
					nr_seq_plano_w
				from	pls_segurado	a,
					pls_plano	b
				where	b.nr_sequencia	= a.nr_seq_plano
				and	a.nr_sequencia	= nr_seq_segurado_w;
				exception
				when others then
					ie_regulamentacao_w	:= null;
					nr_seq_plano_w		:= null;
				end;
			else
				begin		
				select	b.ie_regulamentacao
				into STRICT	ie_regulamentacao_w
				from	pls_plano	b
				where	b.nr_sequencia	= nr_seq_plano_w;
				exception
				when others then
					ie_regulamentacao_w	:= null;
				end;
			end if;

			if (coalesce(cd_conta_contabil_w::text, '') = '') then
				if (substr(ie_proc_mat_w,1,1) = 'P') then
					ie_tipo_item_w	:= 'PCM';
				else
					ie_tipo_item_w	:= 'MCM';
				end if;
				
				insert into w_pls_movimento_sem_conta(nr_sequencia,
					cd_item,
					ds_item,
					ie_tipo_item,
					dt_atualizacao,
					nm_usuario,
					vl_item,
					dt_referencia,
					nr_lote_contabil,
					ie_proc_mat_item,
					ie_deb_cred,
					ds_observacao)
				values (nextval('w_pls_movimento_sem_conta_seq'),
					nr_seq_item_w,
					ds_item_w,
					ie_tipo_item_w,
					clock_timestamp(),
					nm_usuario_p,
					vl_contabil_w,
					dt_referencia_w,
					nr_lote_contabil_w,
					ie_proc_mat_w,
					ie_debito_credito_w,
					CASE WHEN substr(ie_proc_mat_w,2,1)='G' THEN wheb_mensagem_pck.get_texto(298040,null)  ELSE '' END );
			else
				select	ie_centro_custo
				into STRICT	ie_centro_custo_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_contabil_w;
				
				if (ie_centro_custo_w = 'S') then
					if (coalesce(cd_centro_custo_w::text, '') = '') then
						SELECT * FROM pls_obter_centro_custo(	'D', nr_seq_plano_w, cd_estabelecimento_w, '', '', ie_regulamentacao_w, nr_seq_segurado_w, '', cd_centro_custo_w, nr_seq_regra_cc_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
					end if;
				else
					cd_centro_custo_w	:= null;
				end if;
				
				if (ie_compl_hist_w = 'S') then
					if (nr_seq_lote_contest_w IS NOT NULL AND nr_seq_lote_contest_w::text <> '') then
						select	max(a.nr_seq_ptu_fatura),
							max(a.nr_seq_pls_fatura)
						into STRICT	nr_seq_ptu_fatura_w,
							nr_seq_pls_fatura_w
						from	pls_lote_contestacao	a
						where	a.nr_sequencia	= nr_seq_lote_contest_w;
						
						nr_fatura_w	:= null;
						nr_ndr_w	:= null;
						nr_pls_fatura_w	:= null;
						nr_pls_ndr_w	:= null;
						
						if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
							nr_fatura_w	:= substr(pls_obter_dados_ptu_fatura(nr_seq_ptu_fatura_w,'F'),1,255);
							nr_ndr_w	:= substr(pls_obter_dados_ptu_fatura(nr_seq_ptu_fatura_w,'NDC'),1,255);
						end if;
						
						if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
							nr_pls_fatura_w	:= substr(pls_obter_dados_pls_fatura(nr_seq_pls_fatura_w,'PF'),1,255);
							nr_pls_ndr_w	:= substr(pls_obter_dados_pls_fatura(nr_seq_pls_fatura_w,'PN'),1,255);
						end if;
							
						ds_unimed_w	:= substr(pls_obter_dados_lote_contest(nr_seq_lote_contest_w,'UDF'),1,255);
						
						nr_tit_pagar_origem_w := somente_numero(pls_obter_titulos_contest_disc(nr_seq_lote_contest_w,'PF'));
						nr_tit_rec_origem_w := somente_numero(pls_obter_titulos_contest_disc(nr_seq_lote_contest_w,'RF'));
					end if;
				
					ds_conteudo_w	:= substr(	nr_seq_lote_contest_w	|| '#@' ||
									nr_fatura_w		|| '#@' ||
									nr_ndr_w		|| '#@' ||
									nr_pls_fatura_w		|| '#@' ||
									nr_pls_ndr_w		|| '#@' ||
									ds_unimed_w		|| '#@' ||
									nr_tit_pagar_origem_w	|| '#@' ||
									nr_tit_rec_origem_w,1,4000);
					
					begin
					ds_compl_historico_ww	:= substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_w, ds_conteudo_w),1,255);
					exception
					when others then
						ds_compl_historico_ww	:= null;
					end;
					
					ds_compl_historico_w	:= substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
				end if;
				
				nr_seq_w_movto_cont_w	:= nr_seq_w_movto_cont_w + 1;
				
				nr_seq_agrupamento_w	:= null;
			
				if (nm_agrupador_w = 'NR_SEQ_CONTA') then
					nr_seq_agrupamento_w	:= somente_numero(substr(nr_seq_conta_w, 1, 10));
				end if;
				
				nr_vetor_w		:= nr_vetor_w + 1;
				w_movto_contabil_w[nr_vetor_w].nr_lote_contabil		:= nr_lote_contabil_p;
				w_movto_contabil_w[nr_vetor_w].nr_sequencia		:= nr_seq_w_movto_cont_w;
				w_movto_contabil_w[nr_vetor_w].cd_conta_contabil	:= cd_conta_contabil_w;
				w_movto_contabil_w[nr_vetor_w].ie_debito_credito	:= ie_debito_credito_w;
				w_movto_contabil_w[nr_vetor_w].cd_historico		:= cd_historico_w;
				w_movto_contabil_w[nr_vetor_w].dt_movimento		:= dt_referencia_mens_w;
				w_movto_contabil_w[nr_vetor_w].vl_movimento		:= vl_contabil_w;
				w_movto_contabil_w[nr_vetor_w].cd_estabelecimento	:= cd_estabelecimento_w;
				w_movto_contabil_w[nr_vetor_w].cd_centro_custo		:= cd_centro_custo_w;
				w_movto_contabil_w[nr_vetor_w].ds_compl_historico	:= ds_compl_historico_w;
				w_movto_contabil_w[nr_vetor_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
				w_movto_contabil_w[nr_vetor_w].nm_tabela		:= nm_tabela_w;
				w_movto_contabil_w[nr_vetor_w].nr_seq_tab_orig		:= nr_seq_item_w;
				w_movto_contabil_w[nr_vetor_w].nr_seq_info		:= nr_seq_info_ctb_w;
				w_movto_contabil_w[nr_vetor_w].nm_atributo		:= nm_atributo_w;
				
				if (nr_vetor_w >= 1000) then
					forall m in w_movto_contabil_w.first..w_movto_contabil_w.last
						insert into w_movimento_contabil values w_movto_contabil_w(m);
					
					nr_vetor_w	:= 0;
					w_movto_contabil_w.delete;
					
					commit;
				end if;
			end if;
			end loop;
		end loop;
		close c_tipo_movimento;
	end loop;
	close c_discussao;
	
	if (nr_vetor_w > 0) then
		forall m in w_movto_contabil_w.first..w_movto_contabil_w.last
			insert into w_movimento_contabil values w_movto_contabil_w(m);
		
		nr_vetor_w	:= 0;
		w_movto_contabil_w.delete;
		
		commit;
	end if;
	
	CALL agrupa_movimento_contabil(	nr_lote_contabil_p,
					nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
	begin
	update	lote_contabil
	set	ie_situacao		= 'A',
		dt_geracao_lote		= CASE WHEN ie_exclusao_p='N' THEN clock_timestamp() WHEN ie_exclusao_p='S' THEN null END
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
      	if (ie_exclusao_p	= 'S') then
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165188);

		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					2,
					'',
					nm_usuario_p);
	else
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165187);

		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					1,
					wheb_mensagem_pck.get_texto(1097175),
					nm_usuario_p);
	end if;
	
	commit;
	end;
else
	rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_contab_discussao ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

