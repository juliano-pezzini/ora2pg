-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_vol_glic_trev ( nr_seq_rep_he_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_glicose_w				bigint;
nr_seq_ele_rep_glic_w			bigint;
qt_equipo_w						double precision;
qt_etapa_w						bigint;
qt_volume_sem_glic_w			double precision;
qt_aporte_hidrico_diario_w		double precision;
qt_volume_faltante_w			double precision;
qt_diaria_glic_w				double precision;
nr_seq_glic_menor_conc_w		bigint;
qt_conversao_ml_menor_w			double precision := 0;
qt_conv_unid_cons_menor_w		double precision;
nr_seq_glic_maior_conc_w		bigint;
qt_conversao_ml_maior_w			double precision := 9999999;
qt_conv_unid_cons_maior_w		double precision;
nr_seq_rep_elem_mat_he_w		bigint;
qt_conversao_ml_w				double precision;
qt_conv_unid_cons_w				double precision;
pr_menor_concentracao_w			double precision;
pr_maior_concentracao_w			double precision;
qt_ml_total_menor_conc_w		double precision;
qt_volume_elem_mat_men_w		double precision;
qt_volume_corr_mat_men_w		double precision;
qt_volume_etapa_mat_men_w		double precision;
qt_volume_elem_mat_mai_w		double precision;
qt_volume_corr_mat_mai_w		double precision;
qt_volume_etapa_mat_mai_w		double precision;
qt_vol_correcao_equipo_w		double precision;
ie_correcao_w					varchar(1);
qt_vel_inf_glicose_w			double precision;

c01 CURSOR FOR
SELECT	b.nr_sequencia,
		a.qt_conversao_ml,
		a.qt_conv_unid_cons
from 	nut_elem_material a,
		prescr_rep_he_elem_mat b
where	a.nr_sequencia = b.nr_seq_elem_mat
and		b.nr_seq_ele_rep = nr_seq_ele_rep_glic_w
and		a.ie_situacao	= 'A'
and		a.ie_padrao	= 'S'
and		coalesce(a.ie_tipo,'NPT') = 'NPT';


BEGIN

select	max(qt_aporte_hidrico_diario),
		max(qt_equipo),
		max(qt_etapa),
		coalesce(max(ie_correcao),'N'),
		coalesce(max(qt_vel_inf_glicose),0)
into STRICT	qt_aporte_hidrico_diario_w,
		qt_equipo_w,
		qt_etapa_w,
		ie_correcao_w,
		qt_vel_inf_glicose_w
from	prescr_rep_he
where	nr_sequencia = nr_seq_rep_he_p;

select	sum(qt_volume)
into STRICT	qt_volume_sem_glic_w
from	prescr_rep_he_elem
where	nr_seq_rep_he = nr_seq_rep_he_p
and		obter_tipo_elemento(nr_seq_elemento) <> 'C';

select	max(qt_diaria),
		max(nr_sequencia)
into STRICT	qt_diaria_glic_w,
		nr_seq_ele_rep_glic_w
from	prescr_rep_he_elem
where	nr_seq_rep_he = nr_seq_rep_he_p
and		obter_tipo_elemento(nr_seq_elemento) = 'C';
begin

open c01;
loop
fetch c01 into	nr_seq_rep_elem_mat_he_w,
				qt_conversao_ml_w,
				qt_conv_unid_cons_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (qt_conversao_ml_w > qt_conversao_ml_menor_w) then
	nr_seq_glic_menor_conc_w := nr_seq_rep_elem_mat_he_w;
	qt_conversao_ml_menor_w := qt_conversao_ml_w;
	qt_conv_unid_cons_menor_w := qt_conv_unid_cons_w;
	end if;
	if (qt_conversao_ml_w < qt_conversao_ml_maior_w) then
	nr_seq_glic_maior_conc_w := nr_seq_rep_elem_mat_he_w;
	qt_conversao_ml_maior_w  := qt_conversao_ml_w;
	qt_conv_unid_cons_maior_w := qt_conv_unid_cons_w;
	end if;
	end;
end loop;
close c01;
 if (qt_vel_inf_glicose_w > 0) then
	pr_menor_concentracao_w  := (qt_conv_unid_cons_maior_w/qt_conversao_ml_menor_w) * 100;
	pr_maior_concentracao_w  := (qt_conv_unid_cons_menor_w/qt_conversao_ml_maior_w) * 100;
	qt_ml_total_menor_conc_w := (qt_diaria_glic_w * qt_conversao_ml_menor_w);
	qt_vol_correcao_equipo_w := (qt_aporte_hidrico_diario_w + qt_equipo_w) / qt_aporte_hidrico_diario_w;

	qt_volume_elem_mat_mai_w  := (qt_ml_total_menor_conc_w - (qt_aporte_hidrico_diario_w - qt_volume_sem_glic_w)) / ((pr_maior_concentracao_w/pr_menor_concentracao_w) - (pr_menor_concentracao_w/pr_menor_concentracao_w));
	qt_volume_corr_mat_mai_w  := (qt_volume_elem_mat_mai_w * qt_vol_correcao_equipo_w);
	qt_volume_etapa_mat_mai_w := (qt_volume_corr_mat_mai_w / qt_etapa_w);
	qt_volume_elem_mat_men_w  := ((qt_aporte_hidrico_diario_w - qt_volume_sem_glic_w) - qt_volume_elem_mat_mai_w);
	qt_volume_corr_mat_men_w  := (qt_volume_elem_mat_men_w * qt_vol_correcao_equipo_w);
	qt_volume_etapa_mat_men_w := (qt_volume_corr_mat_men_w / qt_etapa_w);
end if;

update	prescr_rep_he_elem_mat
set		qt_volume 		= coalesce(qt_volume_elem_mat_mai_w,0),
		qt_vol_cor	 	= coalesce(qt_volume_corr_mat_mai_w,0),
		qt_vol_etapa 	= coalesce(qt_volume_etapa_mat_mai_w,0)
where	nr_sequencia 	= nr_seq_glic_maior_conc_w
and		nr_seq_ele_rep 	= nr_seq_ele_rep_glic_w;

commit;

update	prescr_rep_he_elem_mat
set		qt_volume 		= coalesce(qt_volume_elem_mat_men_w,0),
		qt_vol_cor 		= coalesce(qt_volume_corr_mat_men_w,0),
		qt_vol_etapa	= coalesce(qt_volume_etapa_mat_men_w,0)
where	nr_sequencia	= nr_seq_glic_menor_conc_w
and		nr_seq_ele_rep 	= nr_seq_ele_rep_glic_w;

commit;

update	prescr_rep_he_elem
set		qt_volume			= coalesce(qt_volume_elem_mat_mai_w + qt_volume_elem_mat_men_w,0),
		qt_volume_corrigido	= coalesce(qt_volume_corr_mat_mai_w + qt_volume_corr_mat_men_w,0),
		qt_volume_etapa		= coalesce(qt_volume_etapa_mat_mai_w + qt_volume_etapa_mat_men_w,0)
where	nr_sequencia 		= nr_seq_ele_rep_glic_w
and		nr_seq_rep_he 		= nr_seq_rep_he_p;

exception when others then
	null;
end;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_vol_glic_trev ( nr_seq_rep_he_p bigint, nm_usuario_p text) FROM PUBLIC;

