-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_att_mes_reaj_contrato ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_grupo_contrato_p pls_grupo_contrato.nr_sequencia%type, ie_origem_p text, nr_mes_reajuste_p bigint, ie_reajuste_grupo_p pls_contrato_grupo.ie_reajuste_grupo%type, nr_seq_grupo_alt_p pls_grupo_contrato.nr_sequencia%type, ie_commit_p text) AS $body$
DECLARE


/*
ie_origem_p
IG	= Inclusão em grupo contratual
EG	= Exclusão de grupo contratual
AR	= Atualizar o contrato no grupo de reajuste
BR	= Alteração da data base do reajuste de beneficiário para contrato
*/
nr_seq_grupo_alt_w		pls_grupo_contrato.nr_sequencia%type;
nr_mes_reajuste_w		pls_grupo_contrato.nr_mes_reajuste%type;
ie_gerar_historico_w		varchar(2);
ds_mensagem_w			pls_contrato_historico.ds_historico%type;
dt_reaj_contrato_w		timestamp;


BEGIN

ie_gerar_historico_w := 'N';

select	coalesce(dt_reajuste, dt_contrato)
into STRICT	dt_reaj_contrato_w
from	pls_contrato
where	nr_sequencia = nr_seq_contrato_p;

if (ie_origem_p = 'IG') then
	if	((nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') and (nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') and (nr_mes_reajuste_p IS NOT NULL AND nr_mes_reajuste_p::text <> '') and (ie_reajuste_grupo_p = 'S')) then
		update	pls_contrato
		set	nr_seq_grupo_reajuste = nr_seq_grupo_contrato_p,
			nr_mes_reajuste = nr_mes_reajuste_p,
			nm_usuario	= wheb_usuario_pck.get_nm_usuario,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia 	= nr_seq_contrato_p;

		ie_gerar_historico_w := ie_origem_p;
	end if;
elsif (ie_origem_p = 'EG') then
	nr_mes_reajuste_w 	:= null;
	nr_seq_grupo_alt_w	:= nr_seq_grupo_alt_p;

	if (nr_seq_grupo_alt_w IS NOT NULL AND nr_seq_grupo_alt_w::text <> '') then
		select	max(nr_mes_reajuste)
		into STRICT	nr_mes_reajuste_w
		from	pls_grupo_contrato
		where	nr_sequencia = nr_seq_grupo_alt_w;

		if (coalesce(nr_mes_reajuste_w::text, '') = '') then
			nr_seq_grupo_alt_w	:= null;
			nr_mes_reajuste_w	:= (to_char(dt_reaj_contrato_w, 'mm'))::numeric;
		end if;
	else
		nr_seq_grupo_alt_w 	:= null;
		nr_mes_reajuste_w	:= (to_char(dt_reaj_contrato_w, 'mm'))::numeric;
	end if;

	update	pls_contrato
	set	nr_seq_grupo_reajuste = nr_seq_grupo_alt_w,
		nr_mes_reajuste = nr_mes_reajuste_w,
		nm_usuario	= wheb_usuario_pck.get_nm_usuario,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_contrato_p;

	ie_gerar_historico_w	:= ie_origem_p;
elsif (ie_origem_p = 'AR') then
	if	(ie_reajuste_grupo_p IS NOT NULL AND ie_reajuste_grupo_p::text <> '' AND nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') then
		if	((coalesce(nr_mes_reajuste_p, 0) <> 0) and (ie_reajuste_grupo_p = 'S')) then
			nr_mes_reajuste_w	:= nr_mes_reajuste_p;
			nr_seq_grupo_alt_w	:= nr_seq_grupo_contrato_p;
		else
			nr_seq_grupo_alt_w 	:= null;
			nr_mes_reajuste_w	:= (to_char(dt_reaj_contrato_w, 'mm'))::numeric;
		end if;

		update	pls_contrato
		set	nr_mes_reajuste 	= nr_mes_reajuste_w,
			nr_seq_grupo_reajuste 	= nr_seq_grupo_alt_w,
			nm_usuario		= wheb_usuario_pck.get_nm_usuario,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia 		= nr_seq_contrato_p;

		ie_gerar_historico_w	:= ie_origem_p;
	end if;
end if;

if (ie_gerar_historico_w in ('AR', 'EG', 'IG', 'BR')) then
	if (ie_gerar_historico_w in ('AR','EG')) then
		if (nr_seq_grupo_alt_w IS NOT NULL AND nr_seq_grupo_alt_w::text <> '') then
			ds_mensagem_w	:= 'Alterado para reajustar o contrato no mês ' || nr_mes_reajuste_w || ' conforme o grupo de contrato ' || nr_seq_grupo_alt_w;
		else
			ds_mensagem_w	:= 'Alterado para não permitir reajustar o contrato pelo mês de reajuste do grupo de contrato';
		end if;
	elsif (ie_gerar_historico_w = 'IG') then
		ds_mensagem_w	:= 'Alterado para reajustar o contrato no mês ' || nr_mes_reajuste_p || ' conforme o grupo de contrato ' || nr_seq_grupo_contrato_p;
	elsif (ie_gerar_historico_w = 'BR') then
		if (nr_seq_grupo_alt_w IS NOT NULL AND nr_seq_grupo_alt_w::text <> '') then
			ds_mensagem_w	:= 'Alterado para reajustar o contrato no mês ' || nr_mes_reajuste_w || ' conforme o grupo de contrato ' || nr_seq_grupo_alt_w;
		else
			ds_mensagem_w	:= 'Alterado para reajustar o contrato no mês ' || nr_mes_reajuste_w;
		end if;
	end if;

	insert into pls_contrato_historico(nr_sequencia, cd_estabelecimento, nr_seq_contrato, dt_historico, ie_tipo_historico,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_historico,
		ds_observacao)
	values (nextval('pls_contrato_historico_seq'), wheb_usuario_pck.get_cd_estabelecimento, nr_seq_contrato_p, clock_timestamp(), '95',
		clock_timestamp(), wheb_usuario_pck.get_nm_usuario, clock_timestamp(), wheb_usuario_pck.get_nm_usuario, ds_mensagem_w,
		'pls_att_mes_reaj_contrato, ' || 'origem ' || ie_gerar_historico_w);
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_att_mes_reaj_contrato ( nr_seq_contrato_p pls_contrato.nr_sequencia%type, nr_seq_grupo_contrato_p pls_grupo_contrato.nr_sequencia%type, ie_origem_p text, nr_mes_reajuste_p bigint, ie_reajuste_grupo_p pls_contrato_grupo.ie_reajuste_grupo%type, nr_seq_grupo_alt_p pls_grupo_contrato.nr_sequencia%type, ie_commit_p text) FROM PUBLIC;

