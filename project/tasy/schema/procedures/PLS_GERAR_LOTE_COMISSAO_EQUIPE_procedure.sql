-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_comissao_equipe ( nr_seq_lote_p bigint, nr_seq_canal_venda_p bigint, nr_seq_comissao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_referencia_w			timestamp;
nr_seq_equipe_w			bigint;

/* Campos do cursor 1 */

qt_meta_w			bigint;
ie_tipo_contrato_w		varchar(2);
nr_seq_meta_equipe_w		bigint;
ie_tipo_meta_w			varchar(1);
nr_seq_grupo_produto_w		bigint;
nr_seq_plano_meta_w		bigint;
ie_acao_contrato_meta_w		varchar(255);

/* Campos do cursor 2 */

nr_seq_sca_vidas_w		bigint;

/* Campos do cursor 3 */

ie_sca_embutido_w		varchar(1);
nr_seq_segurado_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
nr_parcela_w			bigint;
ie_acao_contrato_w		varchar(15);
ie_tipo_pessoa_w		varchar(2);
ie_preco_w			varchar(2);
qt_idade_w			bigint;
nr_seq_plano_w			bigint;
nr_seq_item_mens_w		bigint;
ie_tipo_item_w			varchar(2);
nr_seq_sca_w			bigint;
vl_item_w			double precision;
nr_seq_vinculo_sca_w		bigint;
nr_seq_bonificacao_vinculo_w	bigint;
dt_mesano_referencia_w		timestamp;
nr_seq_portabilidade_w		bigint;
nr_seq_motivo_inclusao_w	pls_segurado.nr_seq_motivo_inclusao%type;
nr_seq_tipo_comissao_w		pls_contrato.nr_seq_tipo_comissao%type;
nr_parcela_contrato_w		pls_mensalidade_segurado.nr_parcela_contrato%type;
nr_titulo_w			pls_comissao_beneficiario.nr_titulo%type;
nr_seq_vendedor_pf_w		pls_comissao_beneficiario.nr_seq_vendedor_pf%type;
nr_seq_proposta_w		pls_segurado.nr_proposta_adesao%type;
cd_pessoa_fisica_w		pls_segurado.cd_pessoa_fisica%type;

/* Campos do cursor 4 */

nr_seq_regra_meta_w		bigint;
pr_comissao_w			double precision;
vl_comissao_w			double precision;
ie_vl_integral_1_parcela_w	pls_equipe_meta_comissao.ie_vl_integral_1_parcela%type;

/*Campos do cursor 5 */

nr_seq_comissao_benef_total_w	bigint;

qt_vidas_w			bigint;
qt_vidas_total_sca_w		bigint;
qt_vidas_sca_w			bigint;
pr_meta_w			double precision;
nr_seq_meta_atingir_w		bigint;
vl_sca_embutido_w		double precision;
qt_tot_vidas_w			bigint;
vl_comissao_venda_w		double precision;
qt_comissao_gerada_w		bigint;
nr_seq_comissao_benef_w		bigint;
vl_comissao_total_benef_w	double precision;
vl_comissao_total_w		double precision;
qt_reg_comissao_w		bigint;
qt_estornos			bigint;
nr_seq_plano_item_w 		bigint;
nr_seq_sca_ww			bigint;
nr_seq_bonificacao_w		bigint;
qt_vidas_inferiores_w		bigint;
nr_seq_segurado_preco_origem_w	bigint;
ie_dt_ref_comissao_equipe_w	pls_parametros.ie_dt_ref_comissao_equipe%type;
qt_reg_repasse_w		integer;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
qt_item_seg_gerado_w		integer;
nm_canal_venda_w		varchar(255);
ie_recebe_comissao_w		pls_equipe_vend_vinculo.ie_recebe_comissao%type;
ie_gerar_juro_mult_tit_w	varchar(1);
vl_juros_multa_w		double precision := 0;
vl_origem_w			pls_repasse_mens_item.vl_origem%type;
vl_origem_total_w		pls_repasse_mens.vl_origem%type;
vl_recebido_w			titulo_receber_liq.vl_recebido%type;
ie_comissao_equipe_tit_abert_w	pls_parametros.ie_comissao_equipe_tit_aberto%type;
dt_contrato_w			pls_contrato.dt_contrato%type;

C01 CURSOR FOR
	SELECT	a.qt_meta,
		a.ie_tipo_contrato,
		a.nr_sequencia,
		a.ie_tipo_meta,
		a.nr_seq_grupo_produto,
		a.nr_seq_plano,
		a.ie_acao_contrato
	from	pls_equipe_vend_meta	a,
		pls_equipe_vendedor	b
	where	a.nr_seq_equipe	= b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_equipe_w
	and	coalesce(a.nr_seq_vendedor_canal,nr_seq_canal_venda_p) = nr_seq_canal_venda_p
	and	dt_referencia_w	between a.dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_referencia_w);

C02 CURSOR FOR
	SELECT	a.nr_seq_plano_sca
	from	pls_equipe_meta_comissao	a,
		pls_equipe_meta_atingir		b
	where	a.nr_seq_meta_atingir	= b.nr_sequencia
	and	a.ie_tipo_item_mensalidade = '15'
	and	b.nr_seq_meta_equipe	= nr_seq_meta_equipe_w
	group by a.nr_seq_plano_sca;

C03 CURSOR FOR
	SELECT	'N' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		b.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		a.ie_tipo_item,
		d.nr_seq_plano,
		a.vl_item,
		b.dt_mesano_referencia,
		a.nr_seq_vinculo_sca,
		a.nr_seq_bonificacao_vinculo,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		h.nr_titulo,
		e.dt_contratacao,
		e.nr_seq_vendedor_pf,
		e.nr_proposta_adesao,
		e.cd_pessoa_fisica,
		g.dt_contrato
	FROM titulo_receber h, pls_contrato g, pls_plano f, pls_segurado e, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo d ON (a.nr_seq_vinculo_sca = d.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg 	= b.nr_sequencia and c.nr_sequencia			= b.nr_seq_mensalidade and e.nr_sequencia			= b.nr_seq_segurado and f.nr_sequencia			= e.nr_seq_plano and e.nr_seq_contrato		= g.nr_sequencia and h.nr_seq_mensalidade		= c.nr_sequencia  and coalesce(c.ie_cancelamento::text, '') = '' and (h.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S') and ((e.nr_seq_vendedor_canal = nr_seq_canal_venda_p) or
		((ie_recebe_comissao_w = 'E') and (exists (	SELECT	1
								from	pls_equipe_vend_vinculo	x
								where	x.nr_seq_equipe		= nr_seq_equipe_w
								and	x.nr_seq_vendedor	= e.nr_seq_vendedor_canal
								and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))))) and (((ie_dt_ref_comissao_equipe_w = 'C') and (trunc(e.dt_contratacao,'month') = dt_referencia_w)) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (trunc(h.dt_liquidacao,'month') = dt_referencia_w))) and ((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A')) and ((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w))) and ((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
	
union all

	select	'N' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		b.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		a.ie_tipo_item,
		d.nr_seq_plano,
		a.vl_item,
		b.dt_mesano_referencia,
		a.nr_seq_vinculo_sca,
		a.nr_seq_bonificacao_vinculo,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		h.nr_titulo,
		e.dt_contratacao,
		i.nr_seq_vendedor_vinculado,
		e.nr_proposta_adesao,
		e.cd_pessoa_fisica,
		g.dt_contrato
	FROM pls_segurado_canal_compl i, titulo_receber h, pls_contrato g, pls_plano f, pls_segurado e, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo d ON (a.nr_seq_vinculo_sca = d.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg	= b.nr_sequencia and c.nr_sequencia			= b.nr_seq_mensalidade and e.nr_sequencia			= b.nr_seq_segurado and f.nr_sequencia			= e.nr_seq_plano and e.nr_seq_contrato		= g.nr_sequencia and h.nr_seq_mensalidade		= c.nr_sequencia  and i.nr_seq_segurado		= e.nr_sequencia and coalesce(c.ie_cancelamento::text, '') = '' and (h.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S') and ((i.nr_seq_vendedor_canal = nr_seq_canal_venda_p) or
		((ie_recebe_comissao_w = 'E') and (exists (	select	1
								from	pls_equipe_vend_vinculo	x
								where	x.nr_seq_equipe		= nr_seq_equipe_w
								and	x.nr_seq_vendedor	= i.nr_seq_vendedor_canal
								and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))))) and (((ie_dt_ref_comissao_equipe_w = 'C') and (trunc(e.dt_contratacao,'month') = dt_referencia_w)) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (trunc(h.dt_liquidacao,'month') = dt_referencia_w))) and ((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A')) and ((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w))) and ((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
	 
union all

	select	'S' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		i.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		'15',
		d.nr_seq_plano,
		i.vl_parcela,
		b.dt_mesano_referencia,
		i.nr_seq_vinculo_sca,
		null,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		h.nr_titulo,
		e.dt_contratacao,
		e.nr_seq_vendedor_pf,
		e.nr_proposta_adesao,
		e.cd_pessoa_fisica,
		g.dt_contrato
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_sca		i,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c,
		pls_sca_vinculo			d,
		pls_segurado			e,
		pls_plano			f,
		pls_contrato			g,
		titulo_receber			h
	where	a.nr_seq_mensalidade_seg 	= b.nr_sequencia
	and	i.nr_seq_item_mens		= a.nr_sequencia
	and	c.nr_sequencia			= b.nr_seq_mensalidade
	and	e.nr_sequencia			= b.nr_seq_segurado
	and	f.nr_sequencia			= e.nr_seq_plano
	and	e.nr_seq_contrato		= g.nr_sequencia
	and	h.nr_seq_mensalidade		= c.nr_sequencia
	and	i.nr_seq_vinculo_sca		= d.nr_sequencia
	and	coalesce(c.ie_cancelamento::text, '') = ''
	and (h.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
	and	a.ie_tipo_item	= '1'
	and	((e.nr_seq_vendedor_canal = nr_seq_canal_venda_p) or
		((ie_recebe_comissao_w = 'E') and (exists (	select	1
								from	pls_equipe_vend_vinculo	x
								where	x.nr_seq_equipe		= nr_seq_equipe_w
								and	x.nr_seq_vendedor	= e.nr_seq_vendedor_canal
								and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w)))))
	and	(((ie_dt_ref_comissao_equipe_w = 'C') and (trunc(e.dt_contratacao,'month') = dt_referencia_w)) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (trunc(h.dt_liquidacao,'month') = dt_referencia_w)))
	and	((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
	and	((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w)))
	and	((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
	order by nr_seq_mens_seg,
		 ie_tipo_item;

C04 CURSOR FOR
	SELECT	a.nr_sequencia,
		coalesce(a.pr_comissao,0),
		coalesce(a.vl_comissao,0),
		a.ie_vl_integral_1_parcela
	from	pls_equipe_meta_comissao	a,
		pls_equipe_meta_atingir		b
	where	a.nr_seq_meta_atingir = b.nr_sequencia
	and	b.nr_sequencia = nr_seq_meta_atingir_w
	and	((pls_obter_se_item_lista(a.ie_acao_contrato,ie_acao_contrato_w) = 'S') or (coalesce(a.ie_acao_contrato::text, '') = ''))
	and	((pls_obter_se_item_lista(a.ie_tipo_item_mensalidade,ie_tipo_item_w) = 'S') or (coalesce(a.ie_tipo_item_mensalidade::text, '') = ''))
	and	qt_idade_w between coalesce(a.qt_idade_inicial,qt_idade_w) and coalesce(a.qt_idade_final,qt_idade_w)
	and	((a.nr_seq_plano_sca = nr_seq_sca_w) or (coalesce(a.nr_seq_plano_sca::text, '') = ''))
	and	((coalesce(a.ie_portabilidade,'N') = 'S' and (nr_seq_portabilidade_w IS NOT NULL AND nr_seq_portabilidade_w::text <> '')) or coalesce(a.ie_portabilidade,'N') = 'N')
	and	((a.nr_seq_motivo_inclusao = nr_seq_motivo_inclusao_w) or (coalesce(a.nr_seq_motivo_inclusao::text, '') = ''))
	and	((a.nr_seq_tipo_comissao = nr_seq_tipo_comissao_w) or (coalesce(a.nr_seq_tipo_comissao::text, '') = ''))
	and	nr_parcela_w between coalesce(a.nr_parcela_inicial,nr_parcela_w) and coalesce(a.nr_parcela_final,nr_parcela_w)
	and	nr_parcela_contrato_w between coalesce(a.nr_parcela_contr_inicial,nr_parcela_contrato_w) and coalesce(a.nr_parcela_contr_final,nr_parcela_contrato_w)
	and	((a.nr_seq_contrato = nr_seq_contrato_w) or (coalesce(a.nr_seq_contrato::text, '') = ''))
	and 	dt_contratacao_w between coalesce(a.dt_adesao_inicial,dt_contratacao_w) and coalesce(a.dt_adesao_final,dt_contratacao_w)
	and	dt_contrato_w between coalesce(a.dt_contrato_inicial, dt_contrato_w) and coalesce(a.dt_contrato_final, dt_contrato_w)
	order by
		coalesce(a.nr_seq_contrato, '0'),
		coalesce(a.nr_seq_plano_sca, '0'),
		coalesce(a.ie_acao_contrato, ' '),
		coalesce(a.ie_tipo_item_mensalidade, ' '),
		coalesce(a.ie_portabilidade, ' '),
		coalesce(a.nr_seq_motivo_inclusao, '0'),
		coalesce(a.nr_seq_tipo_comissao, '0');

C05 CURSOR FOR 	--Filtrando beneficiários por comissão
	SELECT	nr_sequencia
	from	pls_comissao_beneficiario
	where	nr_seq_comissao	= nr_seq_comissao_p;


BEGIN

qt_tot_vidas_w 		:= 0;
vl_comissao_total_w 	:= 0;
qt_vidas_w		:= 0;

select	dt_referencia
into STRICT	dt_referencia_w
from	pls_lote_comissao
where	nr_sequencia	= nr_seq_lote_p;

dt_referencia_w	:= trunc(dt_referencia_w,'month');

begin
select	a.nr_seq_equipe,
	a.ie_recebe_comissao
into STRICT	nr_seq_equipe_w,
	ie_recebe_comissao_w
from	pls_equipe_vend_vinculo	a
where	a.nr_seq_vendedor = nr_seq_canal_venda_p
and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
exception
when no_data_found then
	select	pls_obter_dados_vendedor(nr_seq_canal_venda_p,'N') nm_canal_venda
	into STRICT	nm_canal_venda_w
	;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(226164, 'NR_SEQ_CANAL_VENDA=' || nr_seq_canal_venda_p || ';NM_CANAL_VENDA=' || nm_canal_venda_w);
	/* Mensagem: O canal de venda NR_SEQ_CANAL_VENDA - NM_CANAL_VENDA não está vinculado a uma equipe! */

when too_many_rows then
	select	pls_obter_dados_vendedor(nr_seq_canal_venda_p,'N') nm_canal_venda
	into STRICT	nm_canal_venda_w
	;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(226165, 'NR_SEQ_CANAL_VENDA=' || nr_seq_canal_venda_p || ';NM_CANAL_VENDA=' || nm_canal_venda_w);
	/* Mensagem: O canal de venda NR_SEQ_CANAL_VENDA - NM_CANAL_VENDA está vinculado a mais de uma equipe! */

end;
ie_recebe_comissao_w := coalesce(ie_recebe_comissao_w,'C');

begin
select	coalesce(ie_dt_ref_comissao_equipe,'L'),
	coalesce(ie_comissao_equipe_tit_aberto,'N')
into STRICT	ie_dt_ref_comissao_equipe_w,
	ie_comissao_equipe_tit_abert_w
from	pls_parametros
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
exception
when others then
	ie_dt_ref_comissao_equipe_w	:= 'L';
	ie_comissao_equipe_tit_abert_w	:= 'N';
end;

ie_gerar_juro_mult_tit_w := pls_obter_se_gera_juro_mult(wheb_usuario_pck.get_cd_estabelecimento);

open C01;
loop
fetch C01 into
	qt_meta_w,
	ie_tipo_contrato_w,
	nr_seq_meta_equipe_w,
	ie_tipo_meta_w,
	nr_seq_grupo_produto_w,
	nr_seq_plano_meta_w,
	ie_acao_contrato_meta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	count(1)
	into STRICT	qt_vidas_w
	from	pls_mensalidade			a,
		pls_mensalidade_segurado	b,
		pls_segurado			c,
		pls_plano			d,
		pls_contrato			e,
		titulo_receber			f
	where	a.nr_sequencia		= b.nr_seq_mensalidade
	and	c.nr_sequencia		= b.nr_seq_segurado
	and	d.nr_sequencia		= c.nr_seq_plano
	and	c.nr_seq_contrato	= e.nr_sequencia
	and	f.nr_seq_mensalidade	= a.nr_sequencia
	and	coalesce(a.ie_cancelamento::text, '') = ''
	and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
	and	(((ie_dt_ref_comissao_equipe_w = 'C') and (trunc(c.dt_contratacao,'month') = dt_referencia_w)) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (trunc(f.dt_liquidacao,'month') = dt_referencia_w)))
	and	c.nr_seq_vendedor_canal = nr_seq_canal_venda_p
	and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
	and	b.nr_parcela = 1
	and	((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	SELECT	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= c.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w)))
	and	((c.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
	and	((pls_obter_se_item_lista(ie_acao_contrato_meta_w,c.ie_acao_contrato) = 'S') or (coalesce(ie_acao_contrato_meta_w::text, '') = ''));

	qt_vidas_inferiores_w := pls_obter_vidas_canal_inferior(nr_seq_lote_p, nr_seq_canal_venda_p, nr_seq_comissao_p, qt_vidas_inferiores_w, dt_referencia_w, nr_seq_equipe_w, ie_tipo_contrato_w, null, nm_usuario_p, cd_estabelecimento_p);
	qt_vidas_w := coalesce(qt_vidas_w,0) + coalesce(qt_vidas_inferiores_w,0);

	qt_vidas_total_sca_w	:= 0;

	open C02;
	loop
	fetch C02 into
		nr_seq_sca_vidas_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	count(1)
		into STRICT	qt_vidas_sca_w
		from	pls_mensalidade_seg_item 	g,
			pls_mensalidade			a,
			pls_mensalidade_segurado 	b,
			pls_segurado			c,
			pls_plano			d,
			pls_contrato			e,
			titulo_receber			f,
			pls_sca_vinculo			h
		where	g.nr_seq_mensalidade_seg 	= b.nr_sequencia
		and	a.nr_sequencia			= b.nr_seq_mensalidade
		and	c.nr_sequencia			= b.nr_seq_segurado
		and	d.nr_sequencia			= c.nr_seq_plano
		and	c.nr_seq_contrato		= e.nr_sequencia
		and	f.nr_seq_mensalidade		= a.nr_sequencia
		and	g.nr_seq_vinculo_sca		= h.nr_sequencia
		and	coalesce(a.ie_cancelamento::text, '') = ''
		and	g.ie_tipo_item	= '15'
		and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
		and	b.nr_parcela	= 1
		and	trunc(f.dt_liquidacao,'month')	= dt_referencia_w
		and	trunc(c.dt_contratacao,'month') = dt_referencia_w
		and	c.nr_seq_vendedor_canal = nr_seq_canal_venda_p
		and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
		and	h.nr_seq_plano	= nr_seq_sca_vidas_w;

		qt_vidas_inferiores_w := pls_obter_vidas_canal_inferior(nr_seq_lote_p, nr_seq_canal_venda_p, nr_seq_comissao_p, qt_vidas_inferiores_w, dt_referencia_w, nr_seq_equipe_w, ie_tipo_contrato_w, nr_seq_sca_vidas_w, nm_usuario_p, cd_estabelecimento_p);
		qt_vidas_sca_w := coalesce(qt_vidas_sca_w,0) + coalesce(qt_vidas_inferiores_w,0);

		qt_vidas_total_sca_w	:= coalesce(qt_vidas_total_sca_w,0) + coalesce(qt_vidas_sca_w,0);
		end;
	end loop;
	close C02;

	if (coalesce(qt_vidas_total_sca_w,0) > 0) then
		qt_vidas_w	:= qt_vidas_total_sca_w;
	end if;

	begin
	pr_meta_w := ((100 * qt_vidas_w) / qt_meta_w);
	exception
	when others then
		pr_meta_w := 100;
	end;

	if (pr_meta_w > 100) then
		pr_meta_w := 100;
	end if;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_meta_atingir_w
	from	pls_equipe_meta_atingir	a,
		pls_equipe_vend_meta	b
	where	a.nr_seq_meta_equipe	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_meta_equipe_w
	and	pr_meta_w between coalesce(pr_meta_minimo,pr_meta_w) and coalesce(pr_meta_maximo,pr_meta_w);

	if (coalesce(nr_seq_meta_atingir_w,0) > 0) then
		open C03;
		loop
		fetch C03 into
			ie_sca_embutido_w,
			nr_seq_contrato_w,
			nr_seq_mensalidade_seg_w,
			nr_parcela_w,
			nr_parcela_contrato_w,
			ie_acao_contrato_w,
			ie_tipo_pessoa_w,
			ie_preco_w,
			nr_seq_segurado_w,
			qt_idade_w,
			nr_seq_plano_w,
			nr_seq_item_mens_w,
			ie_tipo_item_w,
			nr_seq_sca_w,
			vl_item_w,
			dt_mesano_referencia_w,
			nr_seq_vinculo_sca_w,
			nr_seq_bonificacao_vinculo_w,
			nr_seq_portabilidade_w,
			nr_seq_motivo_inclusao_w,
			nr_seq_tipo_comissao_w,
			nr_titulo_w,
			dt_contratacao_w,
			nr_seq_vendedor_pf_w,
			nr_seq_proposta_w,
			cd_pessoa_fisica_w,
			dt_contrato_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			nr_seq_regra_meta_w	:= null;
			nr_seq_comissao_benef_w	:= null;
			nr_seq_plano_item_w	:= null;
			nr_seq_sca_ww		:= null;
			nr_seq_bonificacao_w	:= null;

			select	sum(vl_recebido)
			into STRICT	vl_recebido_w
			from	titulo_receber_liq
			where	nr_titulo = nr_titulo_w;

			if (coalesce(vl_recebido_w,0) > 0) or (ie_comissao_equipe_tit_abert_w = 'S') then
				if	((pls_obter_se_item_lista(ie_acao_contrato_meta_w,ie_acao_contrato_w) = 'S') or (coalesce(ie_acao_contrato_meta_w::text, '') = '')) then

					select	count(1)
					into STRICT	qt_reg_comissao_w
					from	pls_comissao_beneficiario	b,
						pls_comissao			a
					where	a.nr_sequencia = b.nr_seq_comissao
					and	b.nr_seq_segurado_mens = nr_seq_mensalidade_seg_w
					and	a.nr_sequencia <> nr_seq_comissao_p
					and	coalesce(a.ie_cancelado,'N') = 'N';

					select	count(1)
					into STRICT	qt_reg_repasse_w
					from	pls_repasse_mens	a,
						pls_repasse_vend	b
					where	a.nr_seq_repasse	= b.nr_sequencia
					and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
					and	b.ie_status 		<> 'C';

					if (qt_reg_comissao_w = 0) and (qt_reg_repasse_w = 0) then
						select	max(nr_sequencia)
						into STRICT	nr_seq_comissao_benef_w
						from	pls_comissao_beneficiario
						where	nr_seq_segurado_mens	= nr_seq_mensalidade_seg_w
						and	nr_seq_comissao		= nr_seq_comissao_p;

						if (coalesce(nr_seq_comissao_benef_w,0) = 0) then
							begin
							select	nextval('pls_comissao_beneficiario_seq')
							into STRICT	nr_seq_comissao_benef_w
							;

							insert	into	pls_comissao_beneficiario(	nr_sequencia,
									nr_seq_comissao,
									nr_seq_segurado_mens,
									nr_seq_segurado,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_titulo,
									nr_seq_vendedor_pf,
									nr_seq_proposta,
									cd_pessoa_fisica )
								values (	nr_seq_comissao_benef_w,
									nr_seq_comissao_p,
									nr_seq_mensalidade_seg_w,
									nr_seq_segurado_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_titulo_w,
									nr_seq_vendedor_pf_w,
									nr_seq_proposta_w,
									cd_pessoa_fisica_w );

							qt_tot_vidas_w	:= coalesce(qt_tot_vidas_w,0) + 1;
							end;
						end if;

						open C04;
						loop
						fetch C04 into
							nr_seq_regra_meta_w,
							pr_comissao_w,
							vl_comissao_w,
							ie_vl_integral_1_parcela_w;
						EXIT WHEN NOT FOUND; /* apply on C04 */
						end loop;
						close C04;

						if	((nr_parcela_w = 1) and (coalesce(ie_vl_integral_1_parcela_w,'N') = 'S')) then
							if (ie_sca_embutido_w = 'N') then
								if (ie_tipo_item_w in ('1','12')) then
									begin
									select (vl_preco_atual - vl_desconto)
									into STRICT	vl_item_w
									from	pls_segurado_preco
									where	nr_seq_segurado	= nr_seq_segurado_w
									and	cd_motivo_reajuste = 'C';
									exception
									when others then
										vl_item_w	:= 0;
									end;

									nr_seq_plano_item_w := nr_seq_plano_w;
								elsif (ie_tipo_item_w = '15') then
									select	b.vl_preco_atual
									into STRICT	vl_item_w
									from	pls_mensalidade_seg_item	a,
										pls_segurado_preco_origem	b
									where	a.nr_seq_seg_preco_origem = b.nr_sequencia
									and	a.nr_sequencia		= nr_seq_item_mens_w;

									select	max(nr_seq_plano)
									into STRICT	nr_seq_sca_ww
									from	pls_sca_vinculo
									where	nr_sequencia	= nr_seq_vinculo_sca_w;
								end if;

								if	((coalesce(nr_seq_bonificacao_vinculo_w,0) <> 0) and (ie_tipo_item_w = '14')) then
									select	nr_seq_bonificacao
									into STRICT	nr_seq_bonificacao_w
									from	pls_bonificacao_vinculo
									where	nr_sequencia	= nr_seq_bonificacao_vinculo_w;
								end if;
							elsif (ie_sca_embutido_w = 'S') then
								select	max(nr_sequencia)
								into STRICT	nr_seq_segurado_preco_origem_w
								from	pls_segurado_preco_origem
								where	nr_seq_segurado	= nr_seq_segurado_w
								and	nr_seq_plano	= nr_seq_sca_w
								and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and	(((dt_mesano_referencia_w >= trunc(dt_reajuste, 'month')) and (cd_motivo_reajuste <> 'E')) or
									 ((cd_motivo_reajuste = 'E') and (dt_mesano_referencia_w >= trunc(add_months(dt_reajuste,1), 'month'))));

								select	max(vl_preco_atual)
								into STRICT	vl_item_w
								from	pls_segurado_preco_origem
								where	nr_sequencia = nr_seq_segurado_preco_origem_w;
							end if;
						end if;

						if (coalesce(nr_seq_regra_meta_w,0) <> 0) then
							if (ie_gerar_juro_mult_tit_w = 'S') then
								vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
							end if;

							vl_comissao_venda_w	:= coalesce(((pr_comissao_w * coalesce(vl_item_w,0)) / 100),0) + vl_comissao_w;
							vl_origem_w 		:= vl_comissao_venda_w;

							if (vl_juros_multa_w > 0) then
								vl_comissao_venda_w := 0;
							end if;

							select	count(1)
							into STRICT	qt_comissao_gerada_w
							from	pls_comissao_beneficiario	c,
								pls_comissao			b,
								pls_lote_comissao		a
							where	a.nr_sequencia	= b.nr_seq_lote
							and	b.nr_sequencia	= c.nr_seq_comissao
							and	c.nr_seq_segurado_mens = nr_seq_mensalidade_seg_w
							and	a.ie_tipo_repasse = 'L'
							and	coalesce(b.ie_cancelado,'N') = 'N';

							select	count(1)
							into STRICT	qt_item_seg_gerado_w
							from	pls_comissao_benef_item		c,
								pls_comissao_beneficiario	b,
								pls_comissao			a
							where	a.nr_sequencia 	= b.nr_seq_comissao
							and	b.nr_sequencia	= c.nr_seq_comissao_benef
							and	b.nr_seq_segurado_mens = nr_seq_mensalidade_seg_w
							and	c.ie_tipo_item = ie_tipo_item_w
							and	coalesce(a.ie_cancelado,'N') = 'N';

							/* Obs: a variável vl_comissao_venda_w não pode ser restringida para serem gerados somente os itens cujo valor é maior que zero porque existe os casos de
							     itens de bonificação em que os valores são negativos e mesmo assim devem ser apresentados no comissionamento. */
							if (vl_comissao_venda_w <> 0 or vl_origem_w <> 0) and (qt_comissao_gerada_w = 0) and (qt_item_seg_gerado_w = 0) then
								insert	into	pls_comissao_benef_item(	nr_sequencia,
										nr_seq_comissao_benef,
										ie_tipo_item,
										vl_item_mensalidade,
										tx_comissao,
										vl_incremento,
										vl_comissao,
										vl_origem,
										nr_seq_plano,
										nr_seq_plano_sca,
										nr_seq_bonificacao,
										ie_sca_embutido,
										dt_atualizacao,
										nm_usuario,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										nr_seq_regra_equipe )
									values (	nextval('pls_comissao_benef_item_seq'),
										nr_seq_comissao_benef_w,
										ie_tipo_item_w,
										vl_item_w,
										pr_comissao_w,
										vl_comissao_w,
										vl_comissao_venda_w,
										vl_origem_w,
										nr_seq_plano_item_w,
										nr_seq_sca_ww,
										nr_seq_bonificacao_w,
										ie_sca_embutido_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_regra_meta_w );
							end if;
						end if;
					end if;
				end if;
			end if;
			end;
		end loop;
		close C03;
	end if;
	end;
end loop;
close C01;

if (ie_gerar_juro_mult_tit_w = 'S') then
	CALL pls_acrescentar_juros_multa(null, nr_seq_comissao_p, 'CE', nm_usuario_p, cd_estabelecimento_p);
end if;

open C05;
loop
fetch C05 into
	nr_seq_comissao_benef_total_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	select	sum(vl_comissao),
		sum(vl_origem)
	into STRICT	vl_comissao_total_benef_w,
		vl_origem_total_w
	from	pls_comissao_benef_item
	where	nr_seq_comissao_benef	= nr_seq_comissao_benef_total_w;

	update	pls_comissao_beneficiario
	set	vl_comissao_benef	= vl_comissao_total_benef_w,
		vl_origem		= vl_origem_total_w
	where	nr_sequencia		= nr_seq_comissao_benef_total_w;
	end;
end loop;
close C05;

select	sum(vl_comissao_benef)
into STRICT	vl_comissao_total_w
from	pls_comissao_beneficiario
where	nr_seq_comissao	= nr_seq_comissao_p;

select	count(1) /* Verificando a quantidade de estornos pendentes */
into STRICT	qt_estornos
from	pls_estorno_comissao
where	nr_seq_canal_venda = nr_seq_canal_venda_p
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	coalesce(nr_seq_comissao_benef::text, '') = '';

if (qt_estornos > 0) then
	CALL pls_gerar_comissao_estornada(nr_seq_canal_venda_p, nr_seq_comissao_p, vl_comissao_total_w, nm_usuario_p);
else
	update	pls_comissao
	set	vl_comissao_canal	= coalesce(vl_comissao_total_w,0)
	where	nr_sequencia		= nr_seq_comissao_p;
end if;

delete	from pls_comissao_benef_item
where	nr_seq_comissao_benef in (	SELECT	x.nr_sequencia
					from	pls_comissao_beneficiario	x
					where	x.nr_seq_comissao = nr_seq_comissao_p
					and	coalesce(x.vl_comissao_benef,0) = 0
					and	coalesce(x.vl_estorno,0) = 0
					and	coalesce(x.vl_origem,0) = 0);

delete	from pls_comissao_beneficiario
where	nr_seq_comissao	= nr_seq_comissao_p
and	coalesce(vl_comissao_benef,0) = 0
and	coalesce(vl_estorno,0) = 0
and	coalesce(vl_origem,0) = 0;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_comissao_equipe ( nr_seq_lote_p bigint, nr_seq_canal_venda_p bigint, nr_seq_comissao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

