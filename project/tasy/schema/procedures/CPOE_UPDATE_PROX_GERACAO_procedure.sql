-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_update_prox_geracao ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nr_seq_horario_p bigint, dt_horario_desejado_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

										 
--ATENÇÃO: O CAMPO IE_TIPO_ITEM_P TEM AS OPÇÕES DO CAMPO DA REP. 
 
dt_prox_geracao_w	timestamp;
dt_horario_w 		timestamp;
dt_min_horario_w	timestamp;
nr_horas_copia_w	bigint := 0;


BEGIN 
 
nr_horas_copia_w := get_qt_hours_after_copy_cpoe(obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
dt_prox_geracao_w := (dt_horario_desejado_p - (nr_horas_copia_w/24)) + 1;
 
if ('R' = ie_tipo_item_p) then 
 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_rec_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_rec_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_recomendacao 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif ('D' = ie_tipo_item_p) then 
 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_dieta_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_dieta_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_dieta 
		set		dt_prox_geracao = trunc(dt_horario_desejado_p,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif (('M' = ie_tipo_item_p) or ('MAT' = ie_tipo_item_p) or ('SOL' = ie_tipo_item_p)) then 
	 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_mat_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_mat_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_material 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif ('1' = ie_tipo_item_p) then	 
	if (nr_seq_horario_p = '1') then 
		update	cpoe_material 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif (('S' = ie_tipo_item_p) or ('LD' = ie_tipo_item_p) or ('2' = ie_tipo_item_p)) then 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_mat_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_mat_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_dieta 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif (('P' = ie_tipo_item_p) or ('G' = ie_tipo_item_p) or ('C' = ie_tipo_item_p) or ('I' = ie_tipo_item_p)) then 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_proc_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_proc_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_procedimento 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
elsif ('O' = ie_tipo_item_p) then 
	select	min(dt_horario) 
	into STRICT	dt_min_horario_w 
	from	prescr_gasoterapia_hor 
	where	nr_prescricao = nr_prescricao_p;
 
	select 	max(dt_horario) 
	into STRICT	dt_horario_w 
	from 	prescr_gasoterapia_hor 
	where	nr_sequencia = nr_seq_horario_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (dt_min_horario_w = dt_horario_w) then 
		update	cpoe_gasoterapia 
		set		dt_prox_geracao = trunc(dt_prox_geracao_w,'hh24') 
		where	nr_sequencia = nr_seq_cpoe_p;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_update_prox_geracao ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nr_seq_horario_p bigint, dt_horario_desejado_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

