-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_aplica_versao_tiss_monit ( nr_seq_regra_p pls_regra_tab_tiss_proc.nr_sequencia%type, ie_todas_p text, ie_10000_p text, ie_10001_p text, ie_10100_p text, ie_10300_p text, ie_tipo_regra_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


C01 CURSOR(			ie_10000_pc		 text,
				ie_10001_pc		 text,
				ie_10100_pc		 text,
				ie_10300_pc		 text,
				ie_todas_pc		 text,
				nr_seq_regra_pc		 pls_regra_tab_tiss_proc.nr_sequencia%type) FOR
	SELECT	a.vl_dominio,
		(SELECT	count(1)
		 from	pls_monit_grupo_ans_tiss b
		 where	b.ie_versao_tiss = a.vl_dominio
		 and	b.nr_seq_regra_grupo_ans = nr_seq_regra_pc) qt_grupo,
		(select	count(1)
		 from	pls_monitor_tab_ref_tiss c
		 where	c.ie_versao_tiss = a.vl_dominio
		 and	c.nr_seq_regra_tab_ref = nr_seq_regra_pc) gt_tab
	from	valor_dominio_v a
	where	a.cd_dominio = 9203
	and	a.vl_dominio in ('1.00.00', '1.00.01', '1.01.00', '1.03.00')
	and	ie_todas_pc = 'S'
	
union all

	select	a.vl_dominio,
		(select	count(1)
		 from	pls_monit_grupo_ans_tiss b
		 where	b.ie_versao_tiss = a.vl_dominio
		 and	b.nr_seq_regra_grupo_ans = nr_seq_regra_pc) qt_grupo,
		(select	count(1)
		 from	pls_monitor_tab_ref_tiss c
		 where	c.ie_versao_tiss = a.vl_dominio
		 and	c.nr_seq_regra_tab_ref = nr_seq_regra_pc) gt_tab
	from	valor_dominio_v a
	where	a.cd_dominio = 9203
	and	a.vl_dominio = ie_10000_pc
	and	ie_todas_pc = 'N'
	
union all

	select	a.vl_dominio,
		(select	count(1)
		 from	pls_monit_grupo_ans_tiss b
		 where	b.ie_versao_tiss = a.vl_dominio
		 and	b.nr_seq_regra_grupo_ans = nr_seq_regra_pc) qt_grupo,
		(select	count(1)
		 from	pls_monitor_tab_ref_tiss c
		 where	c.ie_versao_tiss = a.vl_dominio
		 and	c.nr_seq_regra_tab_ref = nr_seq_regra_pc) gt_tab
	from	valor_dominio_v a
	where	a.cd_dominio = 9203
	and	a.vl_dominio = ie_10001_pc
	and	ie_todas_pc = 'N'
	
union all

	select	a.vl_dominio,
		(select	count(1)
		 from	pls_monit_grupo_ans_tiss b
		 where	b.ie_versao_tiss = a.vl_dominio
		 and	b.nr_seq_regra_grupo_ans = nr_seq_regra_pc) qt_grupo,
		(select	count(1)
		 from	pls_monitor_tab_ref_tiss c
		 where	c.ie_versao_tiss = a.vl_dominio
		 and	c.nr_seq_regra_tab_ref = nr_seq_regra_pc) gt_tab
	from	valor_dominio_v a
	where	a.cd_dominio = 9203
	and	a.vl_dominio = ie_10100_pc
	and	ie_todas_pc = 'N'
	
union all

	select	a.vl_dominio,
		(select	count(1)
		 from	pls_monit_grupo_ans_tiss b
		 where	b.ie_versao_tiss = a.vl_dominio
		 and	b.nr_seq_regra_grupo_ans = nr_seq_regra_pc) qt_grupo,
		(select	count(1)
		 from	pls_monitor_tab_ref_tiss c
		 where	c.ie_versao_tiss = a.vl_dominio
		 and	c.nr_seq_regra_tab_ref = nr_seq_regra_pc) gt_tab
	from	valor_dominio_v a
	where	a.cd_dominio = 9203
	and	a.vl_dominio = ie_10300_pc
	and	ie_todas_pc = 'N';

BEGIN
if (ie_tipo_regra_p = 'G') then
		
	for r_C01_w in C01( ie_10000_p, ie_10001_p, ie_10100_p, ie_10300_p, ie_todas_p, nr_seq_regra_p)  loop
		
		if (r_C01_w.qt_grupo = 0) then
		
			insert	into	pls_monit_grupo_ans_tiss(	nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
					nm_usuario, nm_usuario_nrec, nr_seq_regra_grupo_ans,
					ie_versao_tiss)
			values (	nextval('pls_monit_grupo_ans_tiss_seq'), clock_timestamp(), clock_timestamp(),
					nm_usuario_p, nm_usuario_p, nr_seq_regra_p,
					r_c01_w.vl_dominio);
		end if;
	end loop;
	
else
	for r_C01_w in C01(ie_10000_p, ie_10001_p, ie_10100_p, ie_10300_p, ie_todas_p, nr_seq_regra_p)  loop

		if (r_C01_w.gt_tab = 0) then
	
			insert	into	pls_monitor_tab_ref_tiss(	nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
					nm_usuario, nm_usuario_nrec, nr_seq_regra_tab_ref,
					ie_versao_tiss)
			values (	nextval('pls_monitor_tab_ref_tiss_seq'), clock_timestamp(), clock_timestamp(),
					nm_usuario_p, nm_usuario_p, nr_seq_regra_p,
					r_c01_w.vl_dominio);
		end if;
	end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_aplica_versao_tiss_monit ( nr_seq_regra_p pls_regra_tab_tiss_proc.nr_sequencia%type, ie_todas_p text, ie_10000_p text, ie_10001_p text, ie_10100_p text, ie_10300_p text, ie_tipo_regra_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

