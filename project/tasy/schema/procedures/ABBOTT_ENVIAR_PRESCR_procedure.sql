-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function abbott_enviar_prescr as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE abbott_enviar_prescr ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_tipo_order_p text default 'NW') AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL abbott_enviar_prescr_atx ( ' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(nr_seq_prescr_p) || ',' || quote_nullable(nr_seq_prescr_proc_mat_p) || ',' || quote_nullable(ie_tipo_order_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE abbott_enviar_prescr_atx ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_tipo_order_p text default 'NW') AS $body$
DECLARE


ds_sep_bv_w		varchar(100);
ds_param_integ_hl7_w	varchar(4000);
qt_exames_w		bigint;

ie_abbot_w		varchar(1);

cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
BEGIN

begin
	qt_exames_w := lab_obter_qt_exames_prescr(nr_prescricao_p);

	if (qt_exames_w > 0) then

		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_abbot_w
		from    prescr_medica a,
				prescr_procedimento b,
				lab_exame_equip c,
				equipamento_lab d
		where   a.nr_prescricao = b.nr_prescricao
		and     b.nr_seq_exame = c.nr_seq_exame
		and     c.cd_equipamento = d.cd_equipamento
		and     upper(d.ds_sigla) = 'ABBOTT'
		and     a.nr_prescricao = nr_prescricao_p
      and     b.nr_sequencia = nr_seq_prescr_p;

		if (ie_abbot_w = 'S') then
			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_w
			from	prescr_medica a
			where	a.nr_prescricao = nr_prescricao_p;

			ds_sep_bv_w := obter_separador_bv;
			ds_param_integ_hl7_w :=
                           'nr_prescricao=' || nr_prescricao_p || ds_sep_bv_w ||
									'cd_pessoa_fisica=' || cd_pessoa_fisica_w || ds_sep_bv_w ||
                           'nr_seq_prescricao='||nr_seq_prescr_p || ds_sep_bv_w ||
                           'nr_seq_prescr_proc_mat='||nr_seq_prescr_proc_mat_p || ds_sep_bv_w ||
                           'ie_tipo_order_p='||ie_tipo_order_p || ds_sep_bv_w;

			CALL gravar_agend_integracao(705, ds_param_integ_hl7_w);
		end if;
	end if;
exception
	when	others then
		null;
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE abbott_enviar_prescr ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_tipo_order_p text default 'NW') FROM PUBLIC; -- REVOKE ALL ON PROCEDURE abbott_enviar_prescr_atx ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_prescr_proc_mat_p bigint, ie_tipo_order_p text default 'NW') FROM PUBLIC;

