-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_hist_mod_dados_req ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

						
cd_medico_solicitante_w			varchar(10);
nr_seq_prestador_w			bigint;
nr_seq_prestador_exec_w			bigint;
ie_regime_internacao_w			varchar(1);
qt_dia_solicitado_w			smallint;
ie_carater_internacao_w			varchar(1);
nr_seq_clinica_w			bigint;
ds_observacao_w				varchar(4000);
ie_tipo_atendimento_w			pls_requisicao.ie_tipo_atendimento%type;
ie_tipo_consulta_w			pls_requisicao.ie_tipo_consulta%type;
dt_entrada_hospital_w			varchar(255);
dt_validade_w				varchar(255);
ie_regime_atendimento_w			pls_requisicao.ie_regime_atendimento%type;
ie_saude_ocupacional_w			pls_requisicao.ie_saude_ocupacional%type;


BEGIN

if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	select	max(a.cd_medico_solicitante),
		max(a.nr_seq_prestador),
		max(a.ie_regime_internacao),
		max(a.qt_dia_solicitado),
		max(a.ie_carater_atendimento),
		max(a.nr_seq_clinica),
		max(a.nr_seq_prestador_exec),
		max(a.ie_tipo_atendimento),
		max(a.ie_tipo_consulta),
		max(to_char(a.dt_validade_senha, 'dd/mm/yyyy')),
		max(to_char(a.dt_entrada_hospital, 'dd/mm/yyyy')),
		max(a.ie_regime_atendimento),
		max(a.ie_saude_ocupacional)
	into STRICT	cd_medico_solicitante_w,
		nr_seq_prestador_w,
		ie_regime_internacao_w,
		qt_dia_solicitado_w,
		ie_carater_internacao_w,
		nr_seq_clinica_w,
		nr_seq_prestador_exec_w,
		ie_tipo_atendimento_w,
		ie_tipo_consulta_w,
		dt_validade_w,
		dt_entrada_hospital_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w
	from	pls_requisicao a
	where	a.nr_sequencia = nr_seq_requisicao_p;
	
	ds_observacao_w :=
	'O usuario '||substr(obter_nome_usuario(nm_usuario_p),1,80)||' alterou os dados da requisicao em '||
	to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')||'.'||chr(13)||chr(10)||chr(13)||chr(10)||
	'Medico solicitante: '||cd_medico_solicitante_w||' - '||substr(obter_nome_pf(cd_medico_solicitante_w),1,80)||'.'||chr(13)||chr(10)||
	'Prestador: '||nr_seq_prestador_w||' - '||substr(pls_obter_dados_prestador(nr_seq_prestador_w, 'N'),1,80)||'.'||chr(13)||chr(10)||
	'Prestador executor: '||nr_seq_prestador_exec_w||' - '||substr(pls_obter_dados_prestador(nr_seq_prestador_exec_w, 'N'),1,80)||'.'||chr(13)||chr(10)||	
	'Tipo internacao: '||substr(pls_obter_desc_tipo_internacao(nr_seq_clinica_w),1,80)||'.'||chr(13)||chr(10)||
	'Regime internacao: '||substr(obter_valor_dominio(1757,ie_regime_internacao_w),1,80)||'.'||chr(13)||chr(10)||
	'Carater atendimento: '||substr(obter_valor_dominio(1016,ie_carater_internacao_w),1,80)||'.'||chr(13)||chr(10)||
	'Tipo atendimento: '||substr(obter_valor_dominio(1761,ie_tipo_atendimento_w),1,80)||'.'||chr(13)||chr(10)||
	'Tipo consulta: '||substr(obter_valor_dominio(3435,ie_tipo_consulta_w),1,80)||'.'||chr(13)||chr(10)||
	'Dias solicitados: '||qt_dia_solicitado_w||'.'||chr(13)||chr(10)||
	'Data validade: '|| dt_validade_w ||'.'||chr(13)||chr(10)||
	'Data entrada hospital: '|| dt_entrada_hospital_w ||'.'||chr(13)||chr(10)||
	'Regime de atendimento: '|| ie_regime_atendimento_w ||'.'||chr(13)||chr(10)||
	'Saude ocupacional: '|| ie_saude_ocupacional_w ||'.';
	
	insert into pls_requisicao_historico(nr_sequencia,
			nr_seq_requisicao,
			dt_historico,
			dt_atualizacao,
			nm_usuario,
			ds_historico,
			ie_origem_historico,
			ie_tipo_historico)
	values (	nextval('pls_requisicao_historico_seq'),
			nr_seq_requisicao_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			ds_observacao_w,
			'A',
			'L');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_hist_mod_dados_req ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

