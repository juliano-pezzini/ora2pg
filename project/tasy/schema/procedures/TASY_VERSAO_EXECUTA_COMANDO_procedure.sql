-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_executa_comando (nm_usuario_p text, ds_comando_p text, NM_FASE_P text) AS $body$
DECLARE


ds_log_p 	varchar(100);
ds_comando_w	text;	
ds_erro_w		text;

BEGIN

ds_comando_w:= ds_comando_p;

<<tentative>>
begin
	EXECUTE ds_comando_w;
    CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO', ds_comando_w, NM_FASE_P);
	commit;
exception
when others then

	ds_erro_w:= substr(sqlerrm,1,1000);

	if ((upper(sqlerrm) like '%ORA-01450%') or (upper(sqlerrm) like '%ORA-14451%')) then
		CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO - '||ds_erro_w, ds_comando_w, NM_FASE_P);
        ds_comando_w:= 	substr(ds_comando_w,1,position('STORAGE(' in ds_comando_w)-1);
		goto tentative;
	elsif (upper(sqlerrm) like '%ORA-01407%') then
		-- No update altera o campo para null		
        CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO - '||ds_erro_w, ds_comando_w, NM_FASE_P);
		EXECUTE 'Alter table '|| replace(replace(substr(sqlerrm,position('.' in sqlerrm)+2,length(sqlerrm)),'"."', ' modify '),'") para',' ');
		goto tentative;				
	elsif ((upper(sqlerrm) like '%ORA-00955%') or (upper(sqlerrm) like '%ORA-02275%') or (upper(sqlerrm) like '%ORA-01430%')) then
        CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO - '||ds_erro_w, ds_comando_w, NM_FASE_P);
		ds_comando_w:= ds_comando_p;
	elsif ((upper(sqlerrm) like '%ORA-02270%') or (upper(sqlerrm) like '%ORA-14455%') or (upper(sqlerrm) like '%ORA-02267%')) then
		-- VER MAIS PRA FRENTE
        CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO - '||ds_erro_w, ds_comando_w, NM_FASE_P);
		ds_comando_w:= ds_comando_p;
	else
        CALL insert_log_cloud(null,null, 'atualizacao', 'TASY_VERSAO_EXECUTA_COMANDO - '||ds_erro_w, ds_comando_w, NM_FASE_P);
		ds_comando_w:= ds_comando_p;
	end if;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_executa_comando (nm_usuario_p text, ds_comando_p text, NM_FASE_P text) FROM PUBLIC;

