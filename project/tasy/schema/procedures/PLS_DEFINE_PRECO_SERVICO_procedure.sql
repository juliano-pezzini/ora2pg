-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_preco_servico ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, dt_servico_p timestamp, cd_servico_p bigint, ie_origem_proced_p bigint, ie_tipo_tabela_p text, nr_seq_procedimento_p bigint, ie_gravar_log_p text, ie_tipo_contratacao_p text, nr_seq_plano_p bigint, ds_parametro_p text, ds_parametro_dois_p text, ds_parametro_tres_p text, nr_seq_contrato_p bigint, nr_seq_classificacao_P bigint, nr_seq_categoria_p bigint, ie_internado_p text, ie_tipo_vinculo_p text, nr_seq_contrato_intercambio_p bigint, nr_seq_segurado_p text, ie_tipo_intercambio_p text, ie_tipo_guia_p text, nr_seq_cbo_saude_p bigint, ie_carater_internacao_p text, nr_seq_clinica_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_tipo_acomodacao_p bigint, dados_prestador_prot_p pls_cta_valorizacao_pck.dados_prestador_prot, dados_conta_p pls_cta_valorizacao_pck.dados_conta, dados_regra_preco_servico_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_servico, ie_tipo_beneficiario_p pls_regra_preco_servico.ie_tipo_segurado%type default null, cd_prestador_solic_p pls_prestador.cd_prestador%type default null, ie_regime_atendimento_p pls_regra_preco_servico.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_regra_preco_servico.ie_saude_ocupacional%type default null) AS $body$
DECLARE


vl_servico_w			double precision	:= 0;
vl_servico_ww			double precision	:= 0;
tx_ajuste_w			double precision	:= 1;
vl_negociado_w			double precision	:= 0;
vl_negociado_ww			double precision	:= 0;
ie_origem_proced_w		bigint;
cd_area_procedimento_w		integer;
cd_especialidade_w		integer;
cd_grupo_proc_w			bigint;
qt_registros_w			bigint;
nr_seq_regra_w			bigint;
nr_seq_regra_ww			bigint;
cd_tabela_servico_w		smallint;
cd_tabela_servico_ww		smallint;
dt_vigencia_w			timestamp;
dt_vigencia_ww			timestamp;
dt_guia_w			timestamp;
ds_observacao_log_w		varchar(4000);
ie_preco_w			varchar(2);
nr_seq_grupo_contrato_w		bigint;
nr_seq_grupo_produto_w		bigint;
ie_grupo_produto_w		varchar(10);
ie_grupo_contrato_w		varchar(10);
nr_seq_grupo_prestador_w	bigint;
ie_grupo_prestador_w		varchar(1)	:= 'S';
ie_tipo_segurado_w		varchar(10);
nr_seq_grupo_servico_w		bigint;
cd_prestador_w			varchar(30);
nr_seq_grupo_rec_w		bigint;
ie_acomodacao_w			varchar(1)	:= 'N';
nr_seq_intercambio_w		bigint;
nr_seq_grupo_intercambio_w	bigint;
qt_excecao_preco_serv_w		bigint;
nr_seq_tipo_prestador_w		bigint;
nr_seq_excecao_preco_serv_w	bigint;
nr_seq_congenere_w		bigint;
nr_seq_classificacao_w		bigint;
dt_servico_w			timestamp;
nr_seq_conta_w			bigint;
nr_seq_congenere_prot_w		bigint;
cd_moeda_w			smallint;
vl_ch_servico_w			double precision;
tx_ajuste_ww			double precision;
cd_moeda_ww			smallint;	
ie_pcmso_w			varchar(2);	
cd_especialidade_prest_w	varchar(4000);
ie_cooperado_w			varchar(1)	:= 'N';
cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
dt_procedimento_w		timestamp	:= clock_timestamp();
dt_preco_w			timestamp	:= clock_timestamp();
cd_medico_w			varchar(10);
qt_regra_w			bigint;	
tx_ajuste_preco_ww		pls_regra_preco_servico.TX_AJUSTE_PRECO%type := null;
tx_ajuste_preco_w		pls_regra_preco_servico.TX_AJUSTE_PRECO%type := null;
qt_servico_w			integer;
ie_carteira_valida_w		varchar(1)	:= 'S';
ie_especialidade_prest_w	varchar(1);
vl_servico_tabela_w		pls_conta_proc.vl_unitario%type;
ie_origem_protocolo_w		pls_conta_proc_v.ie_origem_protocolo%type;
cd_versao_tiss_w		pls_conta_proc_v.cd_versao_tiss%type;
ie_grupo_operadora_w		varchar(1);
nr_seq_prest_inter_w		pls_conta_proc_v.nr_seq_prest_inter%type;
nr_seq_prest_inter_ww		pls_conta_proc_v.nr_seq_prest_inter%type;
ie_tipo_protocolo_w		pls_conta_proc_v.ie_tipo_protocolo%type;
ie_acomodacao_autorizada_w	pls_regra_preco_servico.ie_acomodacao_autorizada%type;
ie_tipo_atendimento_reemb_w	pls_protocolo_conta.ie_tipo_atendimento%type;
nr_seq_mot_reembolso_w		pls_protocolo_conta.nr_seq_mot_reembolso%type;
ie_atend_pcmso_w		pls_regra_preco_servico.ie_atend_pcmso%type;
qt_idade_benef_w		integer := 0;
nr_seq_guia_w			pls_conta.nr_seq_guia%type;
vl_proc_autorizado_w		pls_conta_proc.vl_procedimento%type;
qt_proc_autorizado_w		pls_conta_proc.qt_procedimento%type;
ie_valor_autorizado_w		pls_regra_preco_proc.ie_valor_autorizado%type;
ie_benef_remido_w		varchar(1);
ie_benef_remido_ok_w		varchar(1);

c01 CURSOR FOR
	SELECT	b.vl_negociado,
		b.tx_ajuste,
		b.dt_inicio_vigencia,
		b.cd_tabela_servico,
		b.nr_sequencia,
		b.nr_seq_grupo_contrato,
		b.nr_seq_grupo_produto,
		coalesce(b.nr_seq_grupo_prestador,0) nr_seq_grupo_prestador,
		coalesce(b.nr_seq_grupo_servico,0) nr_seq_grupo_servico,
		cd_moeda,
		b.TX_AJUSTE_PRECO,
		b.nr_seq_regra_atend_cart,
		b.cd_especialidade_prest,
		b.nr_seq_grupo_operadora,
		b.ie_valor_autorizado,
                coalesce(b.ie_gerar_remido,'N') ie_gerar_remido
	from	pls_regra_preco_servico	b
	where (b.cd_estabelecimento		= cd_estabelecimento_p)
	and	((coalesce(b.cd_procedimento::text, '') = '') or ( b.cd_procedimento = cd_servico_p AND b.ie_origem_proced = ie_origem_proced_w))
	and	dt_servico_w	 		>= b.dt_inicio_vigencia
	and (dt_servico_w 			<= b.dt_fim_vigencia or coalesce(b.dt_fim_vigencia::text, '') = '')
	and	((coalesce(b.cd_grupo_proc::text, '') = '') or ( b.cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(b.cd_especialidade::text, '') = '') or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or ( cd_area_procedimento = cd_area_procedimento_w))
	and	b.ie_situacao			= 'A'
	and	((b.ie_tipo_tabela		= coalesce(ie_tipo_tabela_p,b.ie_tipo_tabela))
	or	(((ie_tipo_tabela_p		= 'IP') or (ie_tipo_tabela_p	= 'IC'))
	and (b.ie_tipo_tabela		= 'I')))
	and	((coalesce(b.ie_tipo_contratacao::text, '') = '') or (b.ie_tipo_contratacao = coalesce(ie_tipo_contratacao_p,0)))
	and	((coalesce(b.ie_preco::text, '') = '') or (b.ie_preco = ie_preco_w))
	and	((coalesce(b.nr_seq_plano::text, '') = '') or (b.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(b.nr_seq_contrato::text, '') = '') or (b.nr_seq_contrato = nr_seq_contrato_p))
	--Campos Prestador
	and	((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = coalesce(nr_seq_prestador_p,0)))
	and	((coalesce(b.cd_prestador::text, '') = '') or (b.cd_prestador = coalesce(cd_prestador_w,'0')))
	and	((coalesce(b.cd_prestador_prot::text, '') = '') or (b.cd_prestador_prot = dados_prestador_prot_p.cd_prestador))
	and	((coalesce(b.ie_tipo_vinculo::text, '') = '') or (b.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(b.nr_seq_classificacao::text, '') = '') or (b.nr_seq_classificacao = nr_seq_classificacao_p))
	and	((coalesce(b.nr_seq_tipo_prestador::text, '') = '') or (b.nr_seq_tipo_prestador = coalesce(nr_seq_tipo_prestador_w,'')))
	and	((coalesce(b.nr_seq_tipo_prestador_prot::text, '') = '') or (b.nr_seq_tipo_prestador_prot = dados_prestador_prot_p.nr_seq_tipo_prestador))
	and	((coalesce(b.nr_seq_prestador_inter::text, '') = '') or (b.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(b.nr_seq_grupo_prest_int::text, '') = '') or (pls_obter_se_grupo_prest_int(b.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))
	and	(coalesce(b.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= b.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_p))
			)
		)
	--fim	
	and	((coalesce(b.nr_seq_categoria::text, '') = '') or (b.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(b.ie_internado::text, '') = '') or (b.ie_internado = 'N') or (b.ie_internado = ie_internado_p))
	and	((coalesce(b.ie_tipo_segurado::text, '') = '') or (b.ie_tipo_segurado	= ie_tipo_segurado_w))
	and	((coalesce(b.nr_seq_grupo_rec::text, '') = '') or (b.nr_seq_grupo_rec	= coalesce(nr_seq_grupo_rec_w,0)))
	and	((coalesce(b.ie_tipo_intercambio::text, '') = '') or (b.ie_tipo_intercambio = 'A') or (b.ie_tipo_intercambio = ie_tipo_intercambio_p))
	and	((coalesce(b.ie_acomodacao::text, '') = '') or (b.ie_acomodacao 	= ie_acomodacao_w) or (b.ie_acomodacao = 'N'))
	and	((coalesce(b.nr_seq_intercambio::text, '') = '') or (b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)))
	and	((coalesce(b.ie_cooperado::text, '') = '') or (b.ie_cooperado	= 'N' ) or (b.ie_cooperado	= ie_cooperado_w))
	and	((coalesce(b.nr_seq_cbo_saude::text, '') = '') or (b.nr_seq_cbo_saude = coalesce(nr_seq_cbo_saude_p,0)))
	and	((coalesce(b.nr_seq_clinica::text, '') = '') or (b.nr_seq_clinica = nr_seq_clinica_p))
	and	((coalesce(b.ie_pcmso::text, '') = '') or (b.ie_pcmso = 'N') or (b.ie_pcmso = ie_pcmso_w))
	and	((coalesce(b.ie_ref_guia_internacao::text, '') = '') or (b.ie_ref_guia_internacao	= 'A') or (b.ie_ref_guia_internacao = dados_conta_p.ie_ref_guia_internacao))
	and	((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia 	= ie_tipo_guia_p))
	and	((coalesce(b.nr_seq_grupo_intercambio::text, '') = '') or (b.nr_seq_grupo_intercambio = coalesce(nr_seq_grupo_intercambio_w,0)))
	and	((coalesce(b.ie_carater_internacao::text, '') = '') or (coalesce(b.ie_carater_internacao,'X')	 = coalesce(ie_carater_internacao_p,'X')))
	and	((coalesce(b.nr_seq_tipo_atendimento::text, '') = '') or (b.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))	
	and	((coalesce(b.nr_seq_tipo_atend_princ::text, '') = '') or (b.nr_seq_tipo_atend_princ = dados_conta_p.nr_seq_tipo_atendimento))		
	and	((coalesce(b.ie_regime_atendimento::text, '') = '') or (b.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(b.ie_saude_ocupacional::text, '') = '') or (b.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(b.ie_regime_atendimento_princ::text, '') = '') or (b.ie_regime_atendimento_princ = dados_conta_p.ie_regime_atendimento))
	and	((coalesce(b.nr_seq_tipo_acomodacao::text, '') = '') or (b.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(b.nr_seq_congenere::text, '') = '') or (b.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(b.nr_seq_congenere_prot::text, '') = '') or (b.nr_seq_congenere_prot = nr_seq_congenere_prot_w))
	and	((coalesce(b.ie_origem_protocolo::text, '') = '') or (b.ie_origem_protocolo	= ie_origem_protocolo_w))
	and	((coalesce(b.cd_versao_tiss::text, '') = '') or (b.cd_versao_tiss		= cd_versao_tiss_w))
	and	((coalesce(b.ie_atend_pcmso::text, '') = '') or (b.ie_atend_pcmso = 'A') or (b.ie_atend_pcmso = ie_atend_pcmso_w))
	and	((coalesce(b.nr_seq_grupo_servico::text, '') = '') or (exists (select	1
									from	table(pls_grupos_pck.obter_procs_grupo_servico(b.nr_seq_grupo_servico, ie_origem_proced_p,cd_servico_p)) grupo)))
	and	((coalesce(b.cd_prestador_solic::text, '') = '') or (b.cd_prestador_solic =  cd_prestador_solic_p))
	and     (((coalesce(b.ie_acomodacao_autorizada::text, '') = '') or (b.ie_acomodacao_autorizada = 'N')) or (b.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(b.ie_tipo_atendimento::text, '') = '') or (b.ie_tipo_atendimento = 'A') or (b.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(b.nr_seq_mot_reembolso::text, '') = '') or (b.nr_seq_mot_reembolso	= nr_seq_mot_reembolso_w)) 
	and	((coalesce(b.qt_idade_inicial::text, '') = '') or (b.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(b.qt_idade_final::text, '') = '') or (b.qt_idade_final >= qt_idade_benef_w))  
	and ( (coalesce(b.nr_seq_tipo_conta::text, '') = '') or (dados_conta_p.nr_seq_tipo_conta = b.nr_seq_tipo_conta))
	order by
		coalesce(b.nr_seq_prestador,0),
		coalesce(b.cd_prestador,0),
		coalesce(b.nr_seq_grupo_prestador,0),
		coalesce(b.cd_procedimento,0),
		coalesce(b.nr_seq_grupo_servico,0),
		coalesce(b.nr_seq_cbo_saude,0),
		coalesce(b.ie_tipo_tabela,'A'),
		coalesce(b.nr_seq_grupo_rec,0),
		coalesce(b.ie_tipo_guia,0),
		coalesce(b.ie_acomodacao,'A') desc, 
		coalesce(b.nr_seq_tipo_prestador,0),
		coalesce(b.nr_seq_contrato,0),
		coalesce(b.nr_seq_grupo_contrato,0),
		coalesce(b.nr_seq_classificacao,0),
		coalesce(b.nr_seq_categoria,0),
		coalesce(b.ie_internado,''),
		coalesce(b.ie_tipo_vinculo,''),
		coalesce(b.nr_seq_grupo_intercambio,0),
		coalesce(b.cd_grupo_proc,0),
		coalesce(b.cd_especialidade,0),
		coalesce(b.cd_area_procedimento,0),
		coalesce(b.nr_seq_tipo_acomodacao,0),
		coalesce(b.nr_seq_tipo_atendimento,0),
		coalesce(b.nr_seq_tipo_atend_princ,0),		
		coalesce(b.nr_seq_congenere_prot,0),
		coalesce(b.nr_seq_clinica,0),
		coalesce(b.nr_seq_regra_atend_cart,0),
		coalesce(b.ie_tipo_intercambio,'A'), 
		coalesce(b.ie_tipo_contratacao,''),
		coalesce(b.nr_seq_intercambio,0),
		coalesce(b.nr_seq_grupo_operadora,0),
		coalesce(b.ie_carater_internacao,''),
		coalesce(b.ie_origem_protocolo,'A'),
		coalesce(b.cd_versao_tiss,'A'),
		coalesce(b.ie_preco,0),
		coalesce(b.nr_seq_plano,0),
		coalesce(b.ie_tipo_segurado,0),
		coalesce(b.nr_seq_congenere,0),
		coalesce(b.ie_pcmso,'N'),
		coalesce(b.ie_atend_pcmso,'A'),
		coalesce(b.cd_especialidade_prest,0),
		coalesce(b.ie_cooperado,'N'),
		coalesce(b.nr_seq_prestador_inter,0),
		coalesce(b.cd_prestador_solic, 0),
		coalesce(b.ie_acomodacao_autorizada,'N'),
		coalesce(b.ie_tipo_atendimento,'A'),
		coalesce(b.nr_seq_grupo_prest_int,0),
		coalesce(b.dt_inicio_vigencia,clock_timestamp()),
		coalesce(b.nr_seq_mot_reembolso,0),
		coalesce(b.nr_seq_tipo_conta, 0);
		
c03 CURSOR FOR
	SELECT	b.vl_negociado,
		b.tx_ajuste,
		b.dt_inicio_vigencia,
		b.cd_tabela_servico,
		b.nr_sequencia,
		b.nr_seq_grupo_contrato,
		b.nr_seq_grupo_produto,
		coalesce(b.nr_seq_grupo_prestador,0) nr_seq_grupo_prestador,
		coalesce(b.nr_seq_grupo_servico,0) nr_seq_grupo_servico,
		cd_moeda,
		b.TX_AJUSTE_PRECO,
		b.nr_seq_regra_atend_cart,
		b.cd_especialidade_prest,
		b.nr_seq_grupo_operadora,
		b.ie_valor_autorizado,
                coalesce(b.ie_gerar_remido,'N') ie_gerar_remido
	from	pls_regra_preco_servico	b
	where (b.cd_estabelecimento		= cd_estabelecimento_p)
	and	((coalesce(b.cd_procedimento::text, '') = '') or ( b.cd_procedimento = cd_servico_p AND b.ie_origem_proced = ie_origem_proced_w))
	and	dt_servico_w	 		>= b.dt_inicio_vigencia
	and (dt_servico_w 			<= b.dt_fim_vigencia or coalesce(b.dt_fim_vigencia::text, '') = '')
	and	((coalesce(b.cd_grupo_proc::text, '') = '') or ( b.cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(b.cd_especialidade::text, '') = '') or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or ( cd_area_procedimento = cd_area_procedimento_w))
	and	b.ie_situacao			= 'A'
	and	((b.ie_tipo_tabela		= coalesce(ie_tipo_tabela_p,b.ie_tipo_tabela))
	or	(((ie_tipo_tabela_p		= 'IP') or (ie_tipo_tabela_p	= 'IC'))
	and (b.ie_tipo_tabela		= 'I')))
	and	((coalesce(b.ie_tipo_contratacao::text, '') = '') or (b.ie_tipo_contratacao = coalesce(ie_tipo_contratacao_p,0)))
	and	((coalesce(b.ie_preco::text, '') = '') or (b.ie_preco = ie_preco_w))
	and	((coalesce(b.nr_seq_plano::text, '') = '') or (b.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(b.nr_seq_contrato::text, '') = '') or (b.nr_seq_contrato = nr_seq_contrato_p))
	--Campos Prestador
	and	((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = coalesce(nr_seq_prestador_p,0)))
	and	((coalesce(b.cd_prestador::text, '') = '') or (b.cd_prestador = coalesce(cd_prestador_w,'0')))
	and	((coalesce(b.cd_prestador_prot::text, '') = '') or (b.cd_prestador_prot = dados_prestador_prot_p.cd_prestador))
	and	((coalesce(b.ie_tipo_vinculo::text, '') = '') or (b.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(b.nr_seq_classificacao::text, '') = '') or (b.nr_seq_classificacao = nr_seq_classificacao_p))
	and	((coalesce(b.nr_seq_tipo_prestador::text, '') = '') or (b.nr_seq_tipo_prestador = coalesce(nr_seq_tipo_prestador_w,'')))
	and	((coalesce(b.nr_seq_tipo_prestador_prot::text, '') = '') or (b.nr_seq_tipo_prestador_prot = dados_prestador_prot_p.nr_seq_tipo_prestador))
	and	((coalesce(b.nr_seq_prestador_inter::text, '') = '') or (b.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(b.nr_seq_grupo_prest_int::text, '') = '') or (pls_obter_se_grupo_prest_int(b.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))	
	and	(coalesce(b.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= b.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_p))
			)
		)
	--fim	
	and	((coalesce(b.nr_seq_categoria::text, '') = '') or (b.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(b.ie_internado::text, '') = '') or (b.ie_internado = 'N') or (b.ie_internado = ie_internado_p))
	and	((coalesce(b.ie_tipo_segurado::text, '') = '') or (b.ie_tipo_segurado	= ie_tipo_segurado_w))
	and	((coalesce(b.nr_seq_grupo_rec::text, '') = '') or (b.nr_seq_grupo_rec	= coalesce(nr_seq_grupo_rec_w,0)))
	and	((coalesce(b.ie_tipo_intercambio::text, '') = '') or (b.ie_tipo_intercambio = 'A') or (b.ie_tipo_intercambio = ie_tipo_intercambio_p))
	and	((coalesce(b.ie_acomodacao::text, '') = '') or (b.ie_acomodacao 	= ie_acomodacao_w) or (b.ie_acomodacao = 'N'))
	and	((coalesce(b.nr_seq_intercambio::text, '') = '') or (b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)))
	and	((coalesce(b.ie_cooperado::text, '') = '') or (b.ie_cooperado	= 'N' ) or (b.ie_cooperado	= ie_cooperado_w))
	and	((coalesce(b.nr_seq_cbo_saude::text, '') = '') or (b.nr_seq_cbo_saude = coalesce(nr_seq_cbo_saude_p,0)))
	and	((coalesce(b.nr_seq_clinica::text, '') = '') or (b.nr_seq_clinica = nr_seq_clinica_p))
	and	((coalesce(b.ie_pcmso::text, '') = '') or (b.ie_pcmso = 'N') or (b.ie_pcmso = ie_pcmso_w))
	and	((coalesce(b.ie_ref_guia_internacao::text, '') = '') or (b.ie_ref_guia_internacao	= 'A') or (b.ie_ref_guia_internacao = dados_conta_p.ie_ref_guia_internacao))
	and	((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia 	= ie_tipo_guia_p))
	and	((coalesce(b.nr_seq_grupo_intercambio::text, '') = '') or (b.nr_seq_grupo_intercambio = coalesce(nr_seq_grupo_intercambio_w,0)))
	and	((coalesce(b.ie_carater_internacao::text, '') = '') or (coalesce(b.ie_carater_internacao,'X')	 = coalesce(ie_carater_internacao_p,'X')))
	and	((coalesce(b.nr_seq_tipo_atendimento::text, '') = '') or (b.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(b.nr_seq_tipo_atend_princ::text, '') = '') or (b.nr_seq_tipo_atend_princ = dados_conta_p.nr_seq_tipo_atendimento))
	and	((coalesce(b.ie_regime_atendimento::text, '') = '') or (b.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(b.ie_saude_ocupacional::text, '') = '') or (b.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(b.ie_regime_atendimento_princ::text, '') = '') or (b.ie_regime_atendimento_princ = dados_conta_p.ie_regime_atendimento))	
	and	((coalesce(b.nr_seq_tipo_acomodacao::text, '') = '') or (b.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(b.nr_seq_congenere::text, '') = '') or (b.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(b.nr_seq_congenere_prot::text, '') = '') or (b.nr_seq_congenere_prot = nr_seq_congenere_prot_w))
	and	((coalesce(b.ie_origem_protocolo::text, '') = '') or (b.ie_origem_protocolo	= ie_origem_protocolo_w))
	and	((coalesce(b.cd_versao_tiss::text, '') = '') or (b.cd_versao_tiss		= cd_versao_tiss_w))
	and	((coalesce(b.ie_atend_pcmso::text, '') = '') or (b.ie_atend_pcmso = 'A') or (b.ie_atend_pcmso = ie_atend_pcmso_w))
	and	((coalesce(b.nr_seq_grupo_servico::text, '') = '') or (exists (select	1
									 from	pls_grupo_servico_tm grupo
									 where	grupo.nr_seq_grupo_servico = b.nr_seq_grupo_servico
									 and	grupo.ie_origem_proced = ie_origem_proced_p
									 and	grupo.cd_procedimento = cd_servico_p)))
	and	((coalesce(b.cd_prestador_solic::text, '') = '') or (b.cd_prestador_solic = cd_prestador_solic_p))
	and     (((coalesce(b.ie_acomodacao_autorizada::text, '') = '') or (b.ie_acomodacao_autorizada = 'N')) or (b.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(b.ie_tipo_atendimento::text, '') = '') or (b.ie_tipo_atendimento = 'A') or (b.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(b.nr_seq_mot_reembolso::text, '') = '') or (b.nr_seq_mot_reembolso	= nr_seq_mot_reembolso_w))
	and	((coalesce(b.qt_idade_inicial::text, '') = '') or (b.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(b.qt_idade_final::text, '') = '') or (b.qt_idade_final >= qt_idade_benef_w))
	and 	((coalesce(b.nr_seq_tipo_conta::text, '') = '') or (dados_conta_p.nr_seq_tipo_conta = b.nr_seq_tipo_conta)) 	
	order by
		coalesce(b.nr_seq_prestador,0),
		coalesce(b.cd_prestador,0),
		coalesce(b.nr_seq_grupo_prestador,0),
		coalesce(b.cd_procedimento,0),
		coalesce(b.nr_seq_grupo_servico,0),
		coalesce(b.nr_seq_cbo_saude,0),
		coalesce(b.ie_tipo_tabela,'A'),
		coalesce(b.nr_seq_grupo_rec,0),
		coalesce(b.ie_tipo_guia,0),
		coalesce(b.ie_acomodacao,'A') desc, 
		coalesce(b.nr_seq_tipo_prestador,0),
		coalesce(b.nr_seq_contrato,0),
		coalesce(b.nr_seq_grupo_contrato,0),
		coalesce(b.nr_seq_classificacao,0),
		coalesce(b.nr_seq_categoria,0),
		coalesce(b.ie_internado,''),
		coalesce(b.ie_tipo_vinculo,''),
		coalesce(b.nr_seq_grupo_intercambio,0),
		coalesce(b.cd_grupo_proc,0),
		coalesce(b.cd_especialidade,0),
		coalesce(b.cd_area_procedimento,0),
		coalesce(b.nr_seq_tipo_acomodacao,0),
		coalesce(b.nr_seq_tipo_atendimento,0),
		coalesce(b.nr_seq_tipo_atend_princ,0),
		coalesce(b.nr_seq_congenere_prot,0),
		coalesce(b.nr_seq_clinica,0),
		coalesce(b.nr_seq_regra_atend_cart,0),
		coalesce(b.ie_tipo_intercambio,'A'), 
		coalesce(b.ie_tipo_contratacao,''),
		coalesce(b.nr_seq_intercambio,0),
		coalesce(b.nr_seq_grupo_operadora,0),
		coalesce(b.ie_carater_internacao,''),
		coalesce(b.ie_origem_protocolo,'A'),
		coalesce(b.cd_versao_tiss,'A'),
		coalesce(b.ie_preco,0),
		coalesce(b.nr_seq_plano,0),
		coalesce(b.ie_tipo_segurado,0),
		coalesce(b.nr_seq_congenere,0),
		coalesce(b.ie_pcmso,'N'),
		coalesce(b.ie_atend_pcmso,'A'),
		coalesce(b.cd_especialidade_prest,0),
		coalesce(b.ie_cooperado,'N'),
		coalesce(b.nr_seq_prestador_inter,0),
		coalesce(b.cd_prestador_solic, 0),
		coalesce(b.ie_acomodacao_autorizada,'N'),
		coalesce(b.ie_tipo_atendimento,'A'),
		coalesce(b.nr_seq_grupo_prest_int,0),
		coalesce(b.dt_inicio_vigencia,clock_timestamp()),
		coalesce(b.nr_seq_mot_reembolso,0),
		coalesce(b.nr_seq_tipo_conta, 0 );
		
c02 CURSOR FOR
	SELECT	b.vl_negociado,
		b.tx_ajuste,
		b.dt_inicio_vigencia,
		b.cd_tabela_servico,
		b.nr_sequencia,
		b.nr_seq_grupo_contrato,
		b.nr_seq_grupo_produto,
		coalesce(b.nr_seq_grupo_prestador,0) nr_seq_grupo_prestador,
		coalesce(b.nr_seq_grupo_servico,0) nr_seq_grupo_servico,
		cd_moeda,
		b.TX_AJUSTE_PRECO,
		b.nr_seq_regra_atend_cart,
		b.cd_especialidade_prest,
		b.nr_seq_grupo_operadora,
		b.ie_valor_autorizado,
                coalesce(b.ie_gerar_remido,'N') ie_gerar_remido
	from	pls_regra_preco_servico_v	b
	where (b.cd_estabelecimento		= cd_estabelecimento_p)
	and	((coalesce(b.cd_procedimento::text, '') = '') or ( b.cd_procedimento = cd_servico_p AND b.ie_origem_proced = ie_origem_proced_w))
	and	dt_servico_w	 		>= b.dt_inicio_vigencia 
	and (dt_servico_w 			<= b.dt_fim_vigencia or coalesce(b.dt_fim_vigencia::text, '') = '')
	and	((coalesce(b.cd_grupo_proc::text, '') = '') or ( b.cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(b.cd_especialidade::text, '') = '') or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or ( cd_area_procedimento = cd_area_procedimento_w))
	and	b.ie_situacao			= 'A'
	and	((b.ie_tipo_tabela		= coalesce(ie_tipo_tabela_p,b.ie_tipo_tabela))
	or	(((ie_tipo_tabela_p		= 'IP') or (ie_tipo_tabela_p	= 'IC'))
	and (b.ie_tipo_tabela		= 'I')))
	and	((coalesce(b.ie_tipo_contratacao::text, '') = '') or (b.ie_tipo_contratacao = coalesce(ie_tipo_contratacao_p,0)))
	and	((coalesce(b.ie_preco::text, '') = '') or (b.ie_preco = ie_preco_w))
	and	((coalesce(b.nr_seq_plano::text, '') = '') or (b.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(b.nr_seq_contrato::text, '') = '') or (b.nr_seq_contrato = nr_seq_contrato_p))
	--Campos Prestador
	and	((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = coalesce(nr_seq_prestador_p,0)))
	and	((coalesce(b.cd_prestador::text, '') = '') or (b.cd_prestador = coalesce(cd_prestador_w,'0')))
	and	((coalesce(b.cd_prestador_prot::text, '') = '') or (b.cd_prestador_prot = dados_prestador_prot_p.cd_prestador))
	and	((coalesce(b.ie_tipo_vinculo::text, '') = '') or (b.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(b.nr_seq_classificacao::text, '') = '') or (b.nr_seq_classificacao = nr_seq_classificacao_p))
	and	((coalesce(b.nr_seq_tipo_prestador::text, '') = '') or (b.nr_seq_tipo_prestador = coalesce(nr_seq_tipo_prestador_w,'')))
	and	((coalesce(b.nr_seq_tipo_prestador_prot::text, '') = '') or (b.nr_seq_tipo_prestador_prot = dados_prestador_prot_p.nr_seq_tipo_prestador))
	and	((coalesce(b.nr_seq_prestador_inter::text, '') = '') or (b.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(b.nr_seq_grupo_prest_int::text, '') = '') or (pls_obter_se_grupo_prest_int(b.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))
	and	(coalesce(b.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= b.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_p))
			)
		)
	--fim	
	and	((coalesce(b.nr_seq_categoria::text, '') = '') or (b.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(b.ie_internado::text, '') = '') or (b.ie_internado = 'N') or (b.ie_internado = ie_internado_p))
	and	((coalesce(b.ie_tipo_segurado::text, '') = '') or (b.ie_tipo_segurado	= ie_tipo_segurado_w))
	and	((coalesce(b.nr_seq_grupo_rec::text, '') = '') or (b.nr_seq_grupo_rec	= coalesce(nr_seq_grupo_rec_w,0)))
	and	((coalesce(b.ie_tipo_intercambio::text, '') = '') or (b.ie_tipo_intercambio = 'A') or (b.ie_tipo_intercambio = ie_tipo_intercambio_p))
	and	((coalesce(b.ie_acomodacao::text, '') = '') or (b.ie_acomodacao 	= ie_acomodacao_w) or (b.ie_acomodacao = 'N'))
	and	((coalesce(b.nr_seq_intercambio::text, '') = '') or (b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)))
	and	((coalesce(b.ie_cooperado::text, '') = '') or (b.ie_cooperado	= 'N' ) or (b.ie_cooperado	= ie_cooperado_w))
	and	((coalesce(b.nr_seq_cbo_saude::text, '') = '') or (b.nr_seq_cbo_saude = coalesce(nr_seq_cbo_saude_p,0)))
	and	((coalesce(b.nr_seq_clinica::text, '') = '') or (b.nr_seq_clinica = nr_seq_clinica_p))
	and	((coalesce(b.ie_pcmso::text, '') = '') or (b.ie_pcmso = 'N') or (b.ie_pcmso = ie_pcmso_w))
	and	((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia 	= ie_tipo_guia_p))
	and	((coalesce(b.nr_seq_grupo_intercambio::text, '') = '') or (b.nr_seq_grupo_intercambio = coalesce(nr_seq_grupo_intercambio_w,0)))
	and	((coalesce(b.ie_carater_internacao::text, '') = '') or (coalesce(b.ie_carater_internacao,'X')	 = coalesce(ie_carater_internacao_p,'X')))
	and	((coalesce(b.ie_ref_guia_internacao::text, '') = '') or (b.ie_ref_guia_internacao	= 'A') or (b.ie_ref_guia_internacao = dados_conta_p.ie_ref_guia_internacao))
	and	((coalesce(b.nr_seq_tipo_atendimento::text, '') = '') or (b.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(b.nr_seq_tipo_atend_princ::text, '') = '') or (b.nr_seq_tipo_atend_princ = dados_conta_p.nr_seq_tipo_atendimento))	
	and	((coalesce(b.ie_regime_atendimento::text, '') = '') or (b.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(b.ie_saude_ocupacional::text, '') = '') or (b.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(b.ie_regime_atendimento_princ::text, '') = '') or (b.ie_regime_atendimento_princ = dados_conta_p.ie_regime_atendimento))	
	and	((coalesce(b.nr_seq_tipo_acomodacao::text, '') = '') or (b.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(b.nr_seq_congenere::text, '') = '') or (b.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(b.nr_seq_congenere_prot::text, '') = '') or (b.nr_seq_congenere_prot = nr_seq_congenere_prot_w))
	and	((coalesce(b.ie_origem_protocolo::text, '') = '') or (b.ie_origem_protocolo	= ie_origem_protocolo_w))
	and	((coalesce(b.cd_versao_tiss::text, '') = '') or (b.cd_versao_tiss		= cd_versao_tiss_w))	
	and	((coalesce(b.ie_atend_pcmso::text, '') = '') or (b.ie_atend_pcmso = 'A') or (b.ie_atend_pcmso = ie_atend_pcmso_w))
	and	((coalesce(b.nr_seq_grupo_servico::text, '') = '') or (exists (select	1
									from	table(pls_grupos_pck.obter_procs_grupo_servico(b.nr_seq_grupo_servico, ie_origem_proced_p,cd_servico_p)) grupo)))
	and	((coalesce(b.cd_prestador_solic::text, '') = '') or ( b.cd_prestador_solic = cd_prestador_solic_p))
	and     (((coalesce(b.ie_acomodacao_autorizada::text, '') = '') or (b.ie_acomodacao_autorizada = 'N')) or (b.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(b.ie_tipo_atendimento::text, '') = '') or (b.ie_tipo_atendimento = 'A') or (b.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(b.nr_seq_mot_reembolso::text, '') = '') or (b.nr_seq_mot_reembolso	= nr_seq_mot_reembolso_w))
	and	((coalesce(b.qt_idade_inicial::text, '') = '') or (b.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(b.qt_idade_final::text, '') = '') or (b.qt_idade_final >= qt_idade_benef_w)) 
	and 	((coalesce(b.nr_seq_tipo_conta::text, '') = '') or (dados_conta_p.nr_seq_tipo_conta = b.nr_seq_tipo_conta));
									
c04 CURSOR FOR
	SELECT	b.vl_negociado,
		b.tx_ajuste,
		b.dt_inicio_vigencia,
		b.cd_tabela_servico,
		b.nr_sequencia,
		b.nr_seq_grupo_contrato,
		b.nr_seq_grupo_produto,
		coalesce(b.nr_seq_grupo_prestador,0) nr_seq_grupo_prestador,
		coalesce(b.nr_seq_grupo_servico,0) nr_seq_grupo_servico,
		cd_moeda,
		b.tx_ajuste_preco,
		b.nr_seq_regra_atend_cart,
		b.cd_especialidade_prest,
		b.nr_seq_grupo_operadora,
		b.nr_seq_grupo_rec,
		b.ie_valor_autorizado,
                coalesce(b.ie_gerar_remido,'N') ie_gerar_remido
	from	pls_regra_preco_servico_v	b
	where (b.cd_estabelecimento		= cd_estabelecimento_p)
	and	((coalesce(b.cd_procedimento::text, '') = '') or ( b.cd_procedimento = cd_servico_p AND b.ie_origem_proced = ie_origem_proced_w))
	and	dt_servico_w	 		>= b.dt_inicio_vigencia 
	and (dt_servico_w 			<= b.dt_fim_vigencia or coalesce(b.dt_fim_vigencia::text, '') = '')
	and	((coalesce(b.cd_grupo_proc::text, '') = '') or ( b.cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(b.cd_especialidade::text, '') = '') or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or ( cd_area_procedimento = cd_area_procedimento_w))
	and	b.ie_situacao			= 'A'
	and	((b.ie_tipo_tabela		= coalesce(ie_tipo_tabela_p,b.ie_tipo_tabela))
	or	(((ie_tipo_tabela_p		= 'IP') or (ie_tipo_tabela_p	= 'IC'))
	and (b.ie_tipo_tabela		= 'I')))
	and	((coalesce(b.ie_tipo_contratacao::text, '') = '') or (b.ie_tipo_contratacao = coalesce(ie_tipo_contratacao_p,0)))
	and	((coalesce(b.ie_preco::text, '') = '') or (b.ie_preco = ie_preco_w))
	and	((coalesce(b.nr_seq_plano::text, '') = '') or (b.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(b.nr_seq_contrato::text, '') = '') or (b.nr_seq_contrato = nr_seq_contrato_p))
	--Campos Prestador
	and	((coalesce(b.nr_seq_prestador::text, '') = '') or (b.nr_seq_prestador = coalesce(nr_seq_prestador_p,0)))
	and	((coalesce(b.cd_prestador::text, '') = '') or (b.cd_prestador = coalesce(cd_prestador_w,'0')))
	and	((coalesce(b.cd_prestador_prot::text, '') = '') or (b.cd_prestador_prot = dados_prestador_prot_p.cd_prestador))
	and	((coalesce(b.ie_tipo_vinculo::text, '') = '') or (b.ie_tipo_vinculo = ie_tipo_vinculo_p))
	and	((coalesce(b.nr_seq_classificacao::text, '') = '') or (b.nr_seq_classificacao = nr_seq_classificacao_p))
	and	((coalesce(b.nr_seq_tipo_prestador::text, '') = '') or (b.nr_seq_tipo_prestador = coalesce(nr_seq_tipo_prestador_w,'')))
	and	((coalesce(b.nr_seq_tipo_prestador_prot::text, '') = '') or (b.nr_seq_tipo_prestador_prot = dados_prestador_prot_p.nr_seq_tipo_prestador))
	and	((coalesce(b.nr_seq_prestador_inter::text, '') = '') or (b.nr_seq_prestador_inter = nr_seq_prest_inter_w))
	and	((coalesce(b.nr_seq_grupo_prest_int::text, '') = '') or (pls_obter_se_grupo_prest_int(b.nr_seq_grupo_prest_int, nr_seq_prest_inter_w) = 'S'))
	and	(coalesce(b.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= b.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= nr_seq_prestador_p))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= nr_seq_classificacao_p))
			)
		)
	--fim	
	and	((coalesce(b.nr_seq_categoria::text, '') = '') or (b.nr_seq_categoria = nr_seq_categoria_p))
	and	((coalesce(b.ie_internado::text, '') = '') or (b.ie_internado = 'N') or (b.ie_internado = ie_internado_p))
	and	((coalesce(b.ie_tipo_segurado::text, '') = '') or (b.ie_tipo_segurado	= ie_tipo_segurado_w))
	and	((coalesce(b.nr_seq_grupo_rec::text, '') = '') or (b.nr_seq_grupo_rec	= coalesce(nr_seq_grupo_rec_w,0)))
	and	((coalesce(b.ie_tipo_intercambio::text, '') = '') or (b.ie_tipo_intercambio = 'A') or (b.ie_tipo_intercambio = ie_tipo_intercambio_p))
	and	((coalesce(b.ie_acomodacao::text, '') = '') or (b.ie_acomodacao 	= ie_acomodacao_w) or (b.ie_acomodacao = 'N'))
	and	((coalesce(b.nr_seq_intercambio::text, '') = '') or (b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)))
	and	((coalesce(b.ie_cooperado::text, '') = '') or (b.ie_cooperado	= 'N' ) or (b.ie_cooperado	= ie_cooperado_w))
	and	((coalesce(b.nr_seq_cbo_saude::text, '') = '') or (b.nr_seq_cbo_saude = coalesce(nr_seq_cbo_saude_p,0)))
	and	((coalesce(b.nr_seq_clinica::text, '') = '') or (b.nr_seq_clinica = nr_seq_clinica_p))
	and	((coalesce(b.ie_pcmso::text, '') = '') or (b.ie_pcmso = 'N') or (b.ie_pcmso = ie_pcmso_w))
	and	((coalesce(b.ie_tipo_guia::text, '') = '') or (b.ie_tipo_guia 	= ie_tipo_guia_p))
	and	((coalesce(b.nr_seq_grupo_intercambio::text, '') = '') or (b.nr_seq_grupo_intercambio = coalesce(nr_seq_grupo_intercambio_w,0)))
	and	((coalesce(b.ie_carater_internacao::text, '') = '') or (coalesce(b.ie_carater_internacao,'X')	 = coalesce(ie_carater_internacao_p,'X')))
	and	((coalesce(b.ie_ref_guia_internacao::text, '') = '') or (b.ie_ref_guia_internacao	= 'A') or (b.ie_ref_guia_internacao = dados_conta_p.ie_ref_guia_internacao))
	and	((coalesce(b.nr_seq_tipo_atendimento::text, '') = '') or (b.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(b.nr_seq_tipo_atend_princ::text, '') = '') or (b.nr_seq_tipo_atend_princ = dados_conta_p.nr_seq_tipo_atendimento))	
	and	((coalesce(b.ie_regime_atendimento::text, '') = '') or (b.ie_regime_atendimento = ie_regime_atendimento_p))
	and	((coalesce(b.ie_saude_ocupacional::text, '') = '') or (b.ie_saude_ocupacional = ie_saude_ocupacional_p))
	and	((coalesce(b.ie_regime_atendimento_princ::text, '') = '') or (b.ie_regime_atendimento_princ = dados_conta_p.ie_regime_atendimento))	
	and	((coalesce(b.nr_seq_tipo_acomodacao::text, '') = '') or (b.nr_seq_tipo_acomodacao = nr_seq_tipo_acomodacao_p))
	and	((coalesce(b.nr_seq_congenere::text, '') = '') or (b.nr_seq_congenere		= nr_seq_congenere_w))
	and	((coalesce(b.nr_seq_congenere_prot::text, '') = '') or (b.nr_seq_congenere_prot = nr_seq_congenere_prot_w))
	and	((coalesce(b.ie_origem_protocolo::text, '') = '') or (b.ie_origem_protocolo	= ie_origem_protocolo_w))
	and	((coalesce(b.cd_versao_tiss::text, '') = '') or (b.cd_versao_tiss		= cd_versao_tiss_w))	
	and	((coalesce(b.ie_atend_pcmso::text, '') = '') or (b.ie_atend_pcmso = 'A') or (b.ie_atend_pcmso = ie_atend_pcmso_w))
	and	((coalesce(b.nr_seq_grupo_servico::text, '') = '') or (exists (select	1
									from	pls_grupo_servico_tm grupo
									where	grupo.nr_seq_grupo_servico = b.nr_seq_grupo_servico
									and	grupo.ie_origem_proced = ie_origem_proced_p
									and	grupo.cd_procedimento = cd_servico_p)))
	and	((coalesce(b.cd_prestador_solic::text, '') = '') or (b.cd_prestador_solic = cd_prestador_solic_p))
	and     (((coalesce(b.ie_acomodacao_autorizada::text, '') = '') or (b.ie_acomodacao_autorizada = 'N')) or (b.ie_acomodacao_autorizada = ie_acomodacao_autorizada_w))
	and	((coalesce(b.ie_tipo_atendimento::text, '') = '') or (b.ie_tipo_atendimento = 'A') or (b.ie_tipo_atendimento = ie_tipo_atendimento_reemb_w))
	and	((coalesce(b.nr_seq_mot_reembolso::text, '') = '') or (b.nr_seq_mot_reembolso	= nr_seq_mot_reembolso_w))
	and	((coalesce(b.qt_idade_inicial::text, '') = '') or (b.qt_idade_inicial <= qt_idade_benef_w))
	and	((coalesce(b.qt_idade_final::text, '') = '') or (b.qt_idade_final >= qt_idade_benef_w)) 
	and 	((coalesce(b.nr_seq_tipo_conta::text, '') = '') or (dados_conta_p.nr_seq_tipo_conta = b.nr_seq_tipo_conta));
BEGIN

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then

	qt_idade_benef_w := coalesce(pls_obter_dados_segurado(nr_seq_segurado_p,'ID'),0);

end if;

if (coalesce(dados_conta_p.ie_atend_pcmso::text, '') = '') then
	ie_atend_pcmso_w := 'N';
else
	ie_atend_pcmso_w := dados_conta_p.ie_atend_pcmso;
end if;

-- padrao null no inicio da execucao da rotina, para que seja usado de forma mais inteligente e otimizada
ie_benef_remido_w	:= null;

--tratamento para SLA OS 576555 - Na funcao OPS - Consulta de Precos Servicos e passado null para o parametro nr_seq_procedimento_p o que resultava em um no data found.
if (nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') then
	-- A variavel populada neste select nao estava sendo utilizada e ainda estava sendo populada no select abaixo deste.
	begin
		select	nr_seq_congenere_prot,
			nr_seq_conta,
			dt_procedimento,
			cd_medico_executor,
			nr_seq_grupo_rec,
			cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento,
			ie_origem_proced,
			cd_prestador_exec,
			nr_seq_tipo_prest_exec,
			nr_seq_clas_prest_exec,
			cd_pessoa_fisica_prest,
			dt_procedimento,
			ie_origem_protocolo,
			cd_versao_tiss,
			nr_seq_prest_inter,
			ie_tipo_protocolo,
			ie_tipo_atendimento_reemb,
			nr_seq_mot_reembolso,
			nr_seq_guia,
			ie_tipo_segurado
		into STRICT	nr_seq_congenere_prot_w,
			nr_seq_conta_w,
			dt_procedimento_w,
			cd_medico_w,
			nr_seq_grupo_rec_w,
			cd_grupo_proc_w,
			cd_especialidade_w,
			cd_area_procedimento_w,
			ie_origem_proced_w,
			cd_prestador_w,
			nr_seq_tipo_prestador_w,
			nr_seq_classificacao_w,
			cd_pessoa_fisica_w,
			dt_preco_w,
			ie_origem_protocolo_w,
			cd_versao_tiss_w,
			nr_seq_prest_inter_w,
			ie_tipo_protocolo_w,
			ie_tipo_atendimento_reemb_w,
			nr_seq_mot_reembolso_w,
			nr_seq_guia_w,
			ie_tipo_segurado_w
		from	pls_conta_proc_v
		where	nr_sequencia	= nr_seq_procedimento_p;
	exception
	when others then
		nr_seq_congenere_prot_w := null;
		dt_procedimento_w	:= clock_timestamp();
	end;
	-- 12/05/15 - jtonon - OS 828349 - Buscar o Prestador de Intercambio da 'PLS_PROC_PARTICIPANTE'
	if (ie_tipo_protocolo_w = 'I') then
		select	max(nr_seq_prest_inter)
		into STRICT	nr_seq_prest_inter_ww
		from	pls_proc_participante
		where	nr_seq_conta_proc	= nr_seq_procedimento_p;
		
		if (nr_seq_prest_inter_ww IS NOT NULL AND nr_seq_prest_inter_ww::text <> '') then
			nr_seq_prest_inter_w	:=	nr_seq_prest_inter_ww;
		end if;
	end if;
end if;

dt_servico_w	:= trunc(dt_servico_p,'dd');

if (coalesce(nr_seq_procedimento_p::text, '') = '') then
	/* Obter estrutura do procedimento */

	SELECT * FROM pls_obter_estrut_proc(cd_servico_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;
			
	begin
		select	nr_seq_grupo_rec
		into STRICT	nr_seq_grupo_rec_w
		from	procedimento
		where	cd_procedimento		= cd_servico_p
		and	ie_origem_proced	= ie_origem_proced_p;
	exception
		when others then
		nr_seq_grupo_rec_w	:= null;
	end;

	begin
		select	cd_prestador,
			nr_seq_tipo_prestador,
			nr_seq_classificacao,
			cd_pessoa_fisica
		into STRICT	cd_prestador_w,
			nr_seq_tipo_prestador_w,
			nr_seq_classificacao_w,
			cd_pessoa_fisica_w
		from	pls_prestador
		where	nr_sequencia	= nr_seq_prestador_p;
	exception
	when others then
		nr_seq_tipo_prestador_w	:= null;
	end;
end if;
/* Obter dados do beneficiario */

begin
	select	CASE WHEN coalesce(ie_tipo_segurado_w::text, '') = '' THEN  ie_tipo_segurado  ELSE ie_tipo_segurado_w END ,
		coalesce(nr_seq_intercambio,0),
		nr_seq_grupo_intercambio,
		nr_seq_congenere,
		ie_pcmso,
		ie_preco,
		ie_acomodacao
	into STRICT	ie_tipo_segurado_w,
		nr_seq_intercambio_w,
		nr_seq_grupo_intercambio_w,
		nr_seq_congenere_w,
		ie_pcmso_w,
		ie_preco_w,
		ie_acomodacao_w
	from	pls_segurado_conta_v
	where	nr_sequencia	= nr_seq_segurado_p;
exception
when others then
	ie_tipo_segurado_w	:= null;
	nr_seq_intercambio_w	:= null;
end;

if (ie_tipo_beneficiario_p IS NOT NULL AND ie_tipo_beneficiario_p::text <> '') then
	ie_tipo_segurado_w	:= ie_tipo_beneficiario_p;
end if;

if (ie_gravar_log_p = 'S') then
	ds_observacao_log_w	:= 'Prestador: ' || nr_seq_prestador_p || ' / Data servico: ' || dt_servico_p ||
				' / Codigo: ' || cd_servico_p ||  ' / Origem: ' || ie_origem_proced_w || 
				' / Grupo: ' || cd_grupo_proc_w || ' / Especialidade:  ' || cd_especialidade_w ||
				' / Area:  ' || cd_area_procedimento_w || ' / Tipo tabela: ' || ie_tipo_tabela_p;
			
	CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
					'Inicio do log', ds_observacao_log_w, 'pls_define_preco_servico',
					0, 0, 0, 
					0, 0, 0,
					1, '', null,
					null,null,null, coalesce(wheb_usuario_pck.get_nm_usuario,'Log'));
end if;

begin
	cd_especialidade_prest_w	:= substr(pls_obter_cod_espec_prest(nr_seq_prestador_p, cd_pessoa_fisica_w)||',',1,4000);
exception
when others then
	cd_especialidade_prest_w	:= null;
end;

dt_guia_w	:= trunc(dt_preco_w,'dd');

if (cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') then
	ie_cooperado_w	:= pls_obter_se_cooperado_ativo(cd_medico_w,coalesce(dt_procedimento_w,dt_guia_w),'X');
end if;

select	count(1)
into STRICT	qt_regra_w
from	pls_regra_preco_ordem_serv
where	ie_tipo_preco = 'S'
and	((ie_tipo_tabela	= ie_tipo_tabela_p)
or	(((ie_tipo_tabela_p	= 'IP') or (ie_tipo_tabela_p	= 'IC')) and (ie_tipo_tabela	= 'I')))  LIMIT 1;

select  max(a.ie_tipo_acomodacao )
into STRICT    ie_acomodacao_autorizada_w
from    pls_tipo_acomodacao a,
	pls_guia_plano b,
	pls_conta_v c
where   a.nr_sequencia	= b.nr_seq_tipo_acomodacao
and 	b.nr_sequencia	= c.nr_seq_guia
and	c.nr_sequencia	= dados_conta_p.nr_sequencia;

select	count(1)
into STRICT	qt_servico_w
from	procedimento
where	cd_procedimento		= cd_servico_p
and	ie_origem_proced	= ie_origem_proced_P
and	ie_classificacao	in ('2','3');
--verifica aqui se o procedimento e realmente um servico para nao existir a necessidade de validar no cursor
if (qt_servico_w	> 0 ) then

	if (qt_regra_w > 0) then		
		if (pls_util_cta_pck.usar_novo_agrup = 'S') then
		
			for r_c04_w in C04() loop
				begin
				vl_negociado_ww			:= r_c04_w.vl_negociado;
				tx_ajuste_ww			:= r_c04_w.tx_ajuste;
				dt_vigencia_ww			:= r_c04_w.dt_inicio_vigencia;
				cd_tabela_servico_ww		:= r_c04_w.cd_tabela_servico;
				nr_seq_regra_ww			:= r_c04_w.nr_sequencia;
				nr_seq_grupo_contrato_w		:= r_c04_w.nr_seq_grupo_contrato;
				nr_seq_grupo_produto_w		:= r_c04_w.nr_seq_grupo_produto;
				nr_seq_grupo_servico_w		:= r_c04_w.nr_seq_grupo_servico;
				cd_moeda_ww			:= r_c04_w.cd_moeda;
				tx_ajuste_preco_ww		:= r_c04_w.tx_ajuste_preco;
				
				ie_grupo_produto_w	:= 'S';
				ie_grupo_contrato_w	:= 'S';
				ie_carteira_valida_w	:= 'S';
				ie_especialidade_prest_w:= 'S';
				ie_grupo_operadora_w	:= 'S';
                                ie_benef_remido_ok_w    := 'S';
				/* Grupo de contratos */


				/* Grupo de prestadores */


				/* Grupo de servicos */

			
				if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
					((coalesce(nr_seq_contrato_p,0)	> 0) or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
					ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
				elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
					ie_grupo_contrato_w	:= 'N';
				end if;	
				
				if (ie_grupo_contrato_w = 'S') then
					/* Grupo de produtos */

					if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
						ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
					end if;
					
					if (ie_grupo_produto_w = 'S') then
						if (r_c04_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c04_w.nr_seq_regra_atend_cart::text <> '') then
							ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c04_w.nr_seq_regra_atend_cart);
						end if;
						
						if (ie_carteira_valida_w	= 'S') then
							if (r_c04_w.cd_especialidade_prest	> 0) then
								if	not(cd_especialidade_prest_w like('%'||r_c04_w.cd_especialidade_prest||',%')) then
									ie_especialidade_prest_w	:= 'N';
								end if;	
							end if;
							if (ie_especialidade_prest_w	= 'S') and (r_c04_w.nr_seq_grupo_operadora IS NOT NULL AND r_c04_w.nr_seq_grupo_operadora::text <> '') then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(r_c04_w.nr_seq_grupo_operadora,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w));
							end if;
						end if;
						
					end if;
				end if;

                                -- se a regra deve limitar aos benef remidos
                                if (r_c04_w.ie_gerar_remido = 'S') then

                                        -- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
                                        if (coalesce(ie_benef_remido_w::text, '') = '') then
                                        
                                                ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_servico_w, dt_guia_w));
                                        end if;

                                        ie_benef_remido_ok_w := ie_benef_remido_w;
                                end if;
				
								
				if (ie_grupo_contrato_w	= 'S') and (ie_grupo_produto_w	= 'S') and (ie_carteira_valida_w	= 'S') and (ie_grupo_operadora_w	= 'S') and (ie_especialidade_prest_w = 'S') and (ie_benef_remido_ok_w   = 'S') then
					
					nr_seq_excecao_preco_serv_w	:= 0;
					
					select	count(1)
					into STRICT	qt_excecao_preco_serv_w
					from	pls_excecao_preco_servico
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_serv_w > 0) then
						nr_seq_excecao_preco_serv_w := pls_obter_excecao_preco_serv(	nr_seq_regra_ww, cd_servico_p, ie_origem_proced_w, dt_servico_p, ie_preco_w, ie_tipo_contratacao_p, ie_tipo_segurado_w, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_w, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_classificacao_w, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_serv_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_p.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, nr_seq_grupo_rec_w, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_serv_w,0)	= 0) then
						nr_seq_regra_w		:= nr_seq_regra_ww;
						dt_vigencia_w		:= dt_vigencia_ww;
						cd_tabela_servico_w	:= cd_tabela_servico_ww;
						tx_ajuste_w		:= tx_ajuste_ww;
						cd_moeda_w		:= cd_moeda_ww;
						vl_negociado_w		:= coalesce(vl_negociado_ww,0);
						tx_ajuste_preco_w	:= coalesce(tx_ajuste_preco_ww,0);
						ie_valor_autorizado_w	:= r_c04_w.ie_valor_autorizado;
					end if;
				end if;
				
				end;
			end loop;
		else
		
			for r_c02_w in C02() loop
				begin
				vl_negociado_ww			:= r_c02_w.vl_negociado;
				tx_ajuste_ww			:= r_c02_w.tx_ajuste;
				dt_vigencia_ww			:= r_c02_w.dt_inicio_vigencia;
				cd_tabela_servico_ww		:= r_c02_w.cd_tabela_servico;
				nr_seq_regra_ww			:= r_c02_w.nr_sequencia;
				nr_seq_grupo_contrato_w		:= r_c02_w.nr_seq_grupo_contrato;
				nr_seq_grupo_produto_w		:= r_c02_w.nr_seq_grupo_produto;
				nr_seq_grupo_servico_w		:= r_c02_w.nr_seq_grupo_servico;
				cd_moeda_ww			:= r_c02_w.cd_moeda;
				TX_AJUSTE_PRECO_ww		:= r_c02_w.TX_AJUSTE_PRECO;
				
				ie_grupo_produto_w	:= 'S';
				ie_grupo_contrato_w	:= 'S';
				ie_carteira_valida_w	:= 'S';
				ie_especialidade_prest_w:= 'S';
				ie_grupo_operadora_w	:= 'S';
                                ie_benef_remido_ok_w    := 'S';
				/* Grupo de contratos */


				/* Grupo de prestadores */


				/* Grupo de servicos */

			
				if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
					((coalesce(nr_seq_contrato_p,0)	> 0) or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
					ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
				elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
					ie_grupo_contrato_w	:= 'N';
				end if;	
				
				if (ie_grupo_contrato_w = 'S') then
					/* Grupo de produtos */

					if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
						ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
					end if;
					
					if (ie_grupo_produto_w = 'S') then
						if (r_c02_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c02_w.nr_seq_regra_atend_cart::text <> '') then
							ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c02_w.nr_seq_regra_atend_cart);
						end if;
						
						if (ie_carteira_valida_w	= 'S') then
							if (r_c02_w.cd_especialidade_prest	> 0) then
								if	not(cd_especialidade_prest_w like('%'||r_c02_w.cd_especialidade_prest||',%')) then
									ie_especialidade_prest_w	:= 'N';
								end if;	
							end if;
							if (ie_especialidade_prest_w	= 'S') and (r_c02_w.nr_seq_grupo_operadora IS NOT NULL AND r_c02_w.nr_seq_grupo_operadora::text <> '') then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(r_c02_w.nr_seq_grupo_operadora,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w));
							end if;
						end if;
						
					end if;
				end if;

                                -- se a regra deve limitar aos benef remidos
                                if (r_c02_w.ie_gerar_remido = 'S') then

                                        -- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
                                        if (coalesce(ie_benef_remido_w::text, '') = '') then
                                        
                                                ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_servico_w, dt_guia_w));
                                        end if;

                                        ie_benef_remido_ok_w := ie_benef_remido_w;
                                end if;
				
								
				if (ie_grupo_contrato_w	= 'S') and (ie_grupo_produto_w	= 'S') and (ie_carteira_valida_w	= 'S') and (ie_grupo_operadora_w	= 'S') and (ie_especialidade_prest_w = 'S') and (ie_benef_remido_ok_w   = 'S') then
					
					nr_seq_excecao_preco_serv_w	:= 0;
					
					select	count(1)
					into STRICT	qt_excecao_preco_serv_w
					from	pls_excecao_preco_servico
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_serv_w > 0) then
						nr_seq_excecao_preco_serv_w := pls_obter_excecao_preco_serv(	nr_seq_regra_ww, cd_servico_p, ie_origem_proced_w, dt_servico_p, ie_preco_w, ie_tipo_contratacao_p, ie_tipo_segurado_w, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_w, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_classificacao_w, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_serv_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_p.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, nr_seq_grupo_rec_w, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_serv_w,0)	= 0) then
						nr_seq_regra_w		:= nr_seq_regra_ww;
						dt_vigencia_w		:= dt_vigencia_ww;
						cd_tabela_servico_w	:= cd_tabela_servico_ww;
						tx_ajuste_w		:= tx_ajuste_ww;
						cd_moeda_w		:= cd_moeda_ww;
						vl_negociado_w		:= coalesce(vl_negociado_ww,0);
						tx_ajuste_preco_w	:= coalesce(tx_ajuste_preco_ww,0);
						ie_valor_autorizado_w	:= r_c02_w.ie_valor_autorizado;
					end if;
				end if;
				
				end;
			end loop;
		end if;
		
	else
		if (pls_util_cta_pck.usar_novo_agrup = 'S') then			
			for r_c03_w in C03() loop
				begin
				vl_negociado_ww			:= r_c03_w.vl_negociado;
				tx_ajuste_ww			:= r_c03_w.tx_ajuste;
				dt_vigencia_ww			:= r_c03_w.dt_inicio_vigencia;
				cd_tabela_servico_ww		:= r_c03_w.cd_tabela_servico;
				nr_seq_regra_ww			:= r_c03_w.nr_sequencia;
				nr_seq_grupo_contrato_w		:= r_c03_w.nr_seq_grupo_contrato;
				nr_seq_grupo_produto_w		:= r_c03_w.nr_seq_grupo_produto;
				nr_seq_grupo_servico_w		:= r_c03_w.nr_seq_grupo_servico;
				cd_moeda_ww			:= r_c03_w.cd_moeda;
				TX_AJUSTE_PRECO_ww		:= r_c03_w.TX_AJUSTE_PRECO;
				
				ie_grupo_produto_w	:= 'S';
				ie_grupo_contrato_w	:= 'S';
				ie_carteira_valida_w	:= 'S';
				ie_especialidade_prest_w:= 'S';
				ie_grupo_operadora_w	:= 'S';
                                ie_benef_remido_ok_w    := 'S';
				/* Grupo de contratos */


				/* Grupo de prestadores */


				/* Grupo de servicos */

				
				if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
					((coalesce(nr_seq_contrato_p,0)	> 0) or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
					ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
				elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
					ie_grupo_contrato_w	:= 'N';
				end if;	
				if (ie_grupo_contrato_w = 'S') then
					/* Grupo de produtos */

					if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
						ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
					end if;
					if (ie_grupo_produto_w = 'S') then
						if (r_c03_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c03_w.nr_seq_regra_atend_cart::text <> '') then
							ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c03_w.nr_seq_regra_atend_cart);
						end if;
						
						if (ie_carteira_valida_w	= 'S') then
							if (r_c03_w.cd_especialidade_prest	> 0) then
								if	not(cd_especialidade_prest_w like('%'||r_c03_w.cd_especialidade_prest||',%')) then
									ie_especialidade_prest_w	:= 'N';
								end if;
							end if;
							
							if (ie_especialidade_prest_w	= 'S') and (r_c03_w.nr_seq_grupo_operadora IS NOT NULL AND r_c03_w.nr_seq_grupo_operadora::text <> '') then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(r_c03_w.nr_seq_grupo_operadora,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w));
							end if;
						end if;
					end if;
				end if;

                                -- se a regra deve limitar aos benef remidos
                                if (r_c03_w.ie_gerar_remido = 'S') then

                                        -- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
                                        if (coalesce(ie_benef_remido_w::text, '') = '') then
                                        
                                                ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_servico_w, dt_guia_w));
                                        end if;

                                        ie_benef_remido_ok_w := ie_benef_remido_w;
                                end if;
				
				if (ie_grupo_contrato_w	= 'S') and (ie_grupo_produto_w	= 'S') and (ie_carteira_valida_w	= 'S') and (ie_grupo_operadora_w	= 'S') and (ie_especialidade_prest_w = 'S') and (ie_benef_remido_ok_w   = 'S') then
					
					nr_seq_excecao_preco_serv_w	:= 0;
					
					select	count(1)
					into STRICT	qt_excecao_preco_serv_w
					from	pls_excecao_preco_servico
					where	nr_seq_regra	= nr_seq_regra_ww;
					
					if (qt_excecao_preco_serv_w > 0) then
						nr_seq_excecao_preco_serv_w := pls_obter_excecao_preco_serv(	nr_seq_regra_ww, cd_servico_p, ie_origem_proced_w, dt_servico_p, ie_preco_w, ie_tipo_contratacao_p, ie_tipo_segurado_w, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_w, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_classificacao_w, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_serv_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_p.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, nr_seq_grupo_rec_w, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_serv_w,0)	= 0) then
						nr_seq_regra_w		:= nr_seq_regra_ww;
						dt_vigencia_w		:= dt_vigencia_ww;
						cd_tabela_servico_w	:= cd_tabela_servico_ww;
						tx_ajuste_w		:= tx_ajuste_ww;
						cd_moeda_w		:= cd_moeda_ww;
						vl_negociado_w		:= coalesce(vl_negociado_ww,0);
						tx_ajuste_preco_w	:= coalesce(tx_ajuste_preco_ww,0);
						ie_valor_autorizado_w	:= r_c03_w.ie_valor_autorizado;
					end if;
				end if;
				
				end;
			end loop;
		
		else
			for r_c01_w in C01() loop				
				begin								
				vl_negociado_ww			:= r_c01_w.vl_negociado;
				tx_ajuste_ww			:= r_c01_w.tx_ajuste;
				dt_vigencia_ww			:= r_c01_w.dt_inicio_vigencia;
				cd_tabela_servico_ww		:= r_c01_w.cd_tabela_servico;
				nr_seq_regra_ww			:= r_c01_w.nr_sequencia;
				nr_seq_grupo_contrato_w		:= r_c01_w.nr_seq_grupo_contrato;
				nr_seq_grupo_produto_w		:= r_c01_w.nr_seq_grupo_produto;
				nr_seq_grupo_servico_w		:= r_c01_w.nr_seq_grupo_servico;
				cd_moeda_ww			:= r_c01_w.cd_moeda;
				TX_AJUSTE_PRECO_ww		:= r_c01_w.TX_AJUSTE_PRECO;
				
				ie_grupo_produto_w	:= 'S';
				ie_grupo_contrato_w	:= 'S';
				ie_carteira_valida_w	:= 'S';
				ie_especialidade_prest_w:= 'S';
				ie_grupo_operadora_w	:= 'S';
                                ie_benef_remido_ok_w    := 'S';
				/* Grupo de contratos */


				/* Grupo de prestadores */


				/* Grupo de servicos */

				
				if (coalesce(nr_seq_grupo_contrato_w,0) > 0) and
					((coalesce(nr_seq_contrato_p,0)	> 0) or (coalesce(nr_seq_contrato_intercambio_p,0) > 0)) then
					ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_seq_contrato_p, nr_seq_contrato_intercambio_p);
				elsif (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
					ie_grupo_contrato_w	:= 'N';
				end if;	
				if (ie_grupo_contrato_w = 'S') then
					/* Grupo de produtos */

					if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
						ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
					end if;
					if (ie_grupo_produto_w = 'S') then
						if (r_c01_w.nr_seq_regra_atend_cart IS NOT NULL AND r_c01_w.nr_seq_regra_atend_cart::text <> '') then
							ie_carteira_valida_w	:= pls_valida_regra_cart(nr_seq_segurado_p, r_c01_w.nr_seq_regra_atend_cart);
						end if;
						if (ie_carteira_valida_w	= 'S') then
							if (r_c01_w.cd_especialidade_prest	> 0) then
								if	not(cd_especialidade_prest_w like('%'||r_c01_w.cd_especialidade_prest||',%')) then
									ie_especialidade_prest_w	:= 'N';
								end if;
							end if;
							
							if (ie_especialidade_prest_w	= 'S') and (r_c01_w.nr_seq_grupo_operadora IS NOT NULL AND r_c01_w.nr_seq_grupo_operadora::text <> '') then
								ie_grupo_operadora_w := pls_se_grupo_preco_operadora(r_c01_w.nr_seq_grupo_operadora,coalesce(nr_seq_congenere_w,nr_seq_congenere_prot_w));
							end if;							
						end if;
					end if;
				end if;
				
                                -- se a regra deve limitar aos benef remidos
                                if (r_c01_w.ie_gerar_remido = 'S') then

                                        -- aqui verifica se ja buscado se o benef e remido, como a execucao desta rotina e feita por procedimento, entao so precisa levantar essa informacao uma unica vez
                                        if (coalesce(ie_benef_remido_w::text, '') = '') then
                                        
                                                ie_benef_remido_w := pls_obter_se_benef_remido(nr_seq_segurado_p, coalesce(dt_servico_w, dt_guia_w));
                                        end if;

                                        ie_benef_remido_ok_w := ie_benef_remido_w;
                                end if;

				if (ie_grupo_contrato_w	= 'S') and (ie_grupo_produto_w	= 'S') and (ie_carteira_valida_w	= 'S') and (ie_grupo_operadora_w	= 'S') and (ie_especialidade_prest_w = 'S') and (ie_benef_remido_ok_w = 'S') then
					nr_seq_excecao_preco_serv_w	:= 0;
					
					select	count(1)
					into STRICT	qt_excecao_preco_serv_w
					from	pls_excecao_preco_servico
					where	nr_seq_regra	= nr_seq_regra_ww;				

					if (qt_excecao_preco_serv_w > 0) then
						nr_seq_excecao_preco_serv_w := pls_obter_excecao_preco_serv(	nr_seq_regra_ww, cd_servico_p, ie_origem_proced_w, dt_servico_p, ie_preco_w, ie_tipo_contratacao_p, ie_tipo_segurado_w, nr_seq_contrato_p, nr_seq_prestador_p, nr_seq_congenere_w, nr_seq_tipo_prestador_w, nr_seq_grupo_intercambio_w, nr_seq_classificacao_w, nr_seq_classificacao_w, nr_seq_contrato_intercambio_p, nr_seq_congenere_prot_w, nr_seq_excecao_preco_serv_w, ie_origem_protocolo_w, ie_tipo_intercambio_p, dados_prestador_prot_p.nr_seq_tipo_prestador, dados_conta_p.nr_seq_tipo_atendimento, nr_seq_grupo_rec_w, nr_seq_prest_inter_w, dados_conta_p.ie_regime_atendimento, dados_conta_p.ie_saude_ocupacional);
					end if;
					
					if (coalesce(nr_seq_excecao_preco_serv_w,0)	= 0) then
						nr_seq_regra_w		:= nr_seq_regra_ww;
						dt_vigencia_w		:= dt_vigencia_ww;
						cd_tabela_servico_w	:= cd_tabela_servico_ww;
						tx_ajuste_w		:= tx_ajuste_ww;
						cd_moeda_w		:= cd_moeda_ww;
						vl_negociado_w		:= coalesce(vl_negociado_ww,0);
						tx_ajuste_preco_w	:= coalesce(tx_ajuste_preco_ww,0);
						ie_valor_autorizado_w	:= r_c01_w.ie_valor_autorizado;
					end if;
				end if;
				
				end;
			end loop;
		end if;
	end if;
end if;

if (coalesce(cd_moeda_w,0) <> 0 ) then
	vl_ch_servico_w:= obter_valor_cotacao_moeda_data(cd_moeda_w, dt_servico_p);
end if;

if (coalesce(nr_seq_regra_w,0) > 0) then	
	if (ie_valor_autorizado_w	= 'S') then
	
		if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
			select 	coalesce(sum(vl_procedimento),0),
				coalesce(sum(qt_autorizada),0)
			into STRICT	vl_proc_autorizado_w,
				qt_proc_autorizado_w
			from	pls_guia_plano_proc
			where 	nr_seq_guia	= nr_seq_guia_w
			and	cd_procedimento	= cd_servico_p
			and	ie_origem_proced = ie_origem_proced_p
			and	ie_status	in ('L','S','P');
			
			vl_proc_autorizado_w	:= dividir(vl_proc_autorizado_w,qt_proc_autorizado_w);
		else
			vl_proc_autorizado_w := 0;
		end if;
		vl_servico_w		:= vl_proc_autorizado_w;
		ds_observacao_log_w	:= 'Preco autorizado!';
		CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
			'Tabela de preco', ds_observacao_log_w, 'pls_define_preco_servico',
			vl_proc_autorizado_w, 0, 0, 
			0, 0, 0,
			2, '', null,
			null, null, null, coalesce(wheb_usuario_pck.get_nm_usuario,'Log'));
		vl_servico_tabela_w	:= vl_servico_w;
	elsif (coalesce(vl_negociado_w,0) <> 0) then
		vl_servico_w		:= vl_negociado_w;
		ds_observacao_log_w	:= 'Preco informado!';
		CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
			'Tabela de preco', ds_observacao_log_w, 'pls_define_preco_servico',
			vl_negociado_w, 0, 0, 
			0, 0, 0,
			2, '', null,
			null, null, null, coalesce(wheb_usuario_pck.get_nm_usuario,'Log'));
		vl_servico_tabela_w	:= vl_servico_w;
	elsif (coalesce(tx_ajuste_w,0) <> 0) then
		begin
		/* obter os valores da tabela SERVICO   
		Felipe - 20/06/2011 - OS 330776 - Coloquei a restricao por estabelecimento*/
		select	a.vl_servico
		into STRICT	vl_servico_w
		from	preco_servico a
		where	a.cd_tabela_servico	= cd_tabela_servico_w
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		and	a.cd_procedimento	= cd_servico_p
		and	a.ie_origem_proced	= ie_origem_proced_w
		and	coalesce(a.dt_inicio_vigencia, clock_timestamp() - interval '3650 days')	=
					(	SELECT	max(coalesce(b.dt_inicio_vigencia, clock_timestamp() - interval '3650 days'))
					from	preco_servico b
					where	b.cd_tabela_servico	= cd_tabela_servico_w
					and	b.cd_procedimento	= cd_servico_p
					and	b.ie_origem_proced	= ie_origem_proced_w
					and	b.cd_estabelecimento	= a.cd_estabelecimento
					and	dt_servico_w >= b.dt_inicio_vigencia
					and (dt_servico_w <= b.dt_vigencia_final or coalesce(b.dt_vigencia_final::text, '') = ''));
		exception
		when others then
		begin	
			vl_servico_w	:= null;
		end;
		end;
		vl_servico_tabela_w	:= vl_servico_w;
		if (coalesce(cd_moeda_w,9999) <> 9999) then
			vl_servico_w := ( vl_servico_w * vl_ch_servico_w);
		end if;
		ds_observacao_log_w	:= 'Regra: ' || nr_seq_regra_w || ' / Tabela: ' || cd_tabela_servico_w ||  ' / vl_ch_servico_w: ' || vl_ch_servico_w ||
					' / Data: ' || dt_vigencia_w;
		CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
			'Tabela de preco', ds_observacao_log_w, 'pls_define_preco_servico',
			vl_servico_w, 0, 0, 
			0, 0, 0,
			2, nr_seq_regra_w, null,
			null, null, null, coalesce(wheb_usuario_pck.get_nm_usuario,'Log'));

		vl_servico_w	:= (vl_servico_w * tx_ajuste_w);	
		ds_observacao_log_w	:= 'Tx. ajuste: ' || tx_ajuste_w;

		CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
			'Preco x Tx. Ajuste', ds_observacao_log_w, 'pls_define_preco_servico',
			vl_servico_w, 0, 0, 
			0, 0, 0,
			3, nr_seq_regra_w, null,
			null, null, null, 'Log');

		if (coalesce(tx_ajuste_preco_w,0) <> 0) then
			vl_servico_w		:= (vl_servico_w * tx_ajuste_preco_w);	
			ds_observacao_log_w	:= 'Tx. ajuste preco: ' || tx_ajuste_preco_w;
			CALL pls_gravar_log_calculo_proc(ie_gravar_log_p, nr_seq_procedimento_p, cd_estabelecimento_p,
				'Preco x Tx. Ajuste Preco', ds_observacao_log_w, 'pls_define_preco_servico',
				vl_servico_w, 0, 0, 
				0, 0, 0,
				3, nr_seq_regra_w, null,
				null, null, null, coalesce(wheb_usuario_pck.get_nm_usuario,'Log'));
		end if;


	end if;
end if;
dados_regra_preco_servico_p.nr_sequencia	:= nr_seq_regra_w;
dados_regra_preco_servico_p.vl_servico		:= coalesce(vl_servico_w,0);
dados_regra_preco_servico_P.cd_tabela_servico	:= cd_tabela_servico_w;
dados_regra_preco_servico_p.dt_vigencia		:= dt_vigencia_w;
dados_regra_preco_servico_P.cd_moeda		:= cd_moeda_w;
dados_regra_preco_servico_P.vl_servico_tabela	:= vl_servico_tabela_w;
dados_regra_preco_servico_P.vl_ch_servico	:= vl_ch_servico_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_preco_servico ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, dt_servico_p timestamp, cd_servico_p bigint, ie_origem_proced_p bigint, ie_tipo_tabela_p text, nr_seq_procedimento_p bigint, ie_gravar_log_p text, ie_tipo_contratacao_p text, nr_seq_plano_p bigint, ds_parametro_p text, ds_parametro_dois_p text, ds_parametro_tres_p text, nr_seq_contrato_p bigint, nr_seq_classificacao_P bigint, nr_seq_categoria_p bigint, ie_internado_p text, ie_tipo_vinculo_p text, nr_seq_contrato_intercambio_p bigint, nr_seq_segurado_p text, ie_tipo_intercambio_p text, ie_tipo_guia_p text, nr_seq_cbo_saude_p bigint, ie_carater_internacao_p text, nr_seq_clinica_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_tipo_acomodacao_p bigint, dados_prestador_prot_p pls_cta_valorizacao_pck.dados_prestador_prot, dados_conta_p pls_cta_valorizacao_pck.dados_conta, dados_regra_preco_servico_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_servico, ie_tipo_beneficiario_p pls_regra_preco_servico.ie_tipo_segurado%type default null, cd_prestador_solic_p pls_prestador.cd_prestador%type default null, ie_regime_atendimento_p pls_regra_preco_servico.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_regra_preco_servico.ie_saude_ocupacional%type default null) FROM PUBLIC;

