-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_gerar_duplicidade ( dt_inicial_p timestamp, dt_final_p timestamp, nr_atendimento_p bigint, qt_hora_prescricao_p bigint, ie_proc_setor_user_p text, ie_data_proc_p text, nm_usuario_p text) AS $body$
DECLARE

			 
nr_sequencia_w		bigint;
nr_seq_apres_w		integer;
nr_prescricao_w		bigint;
ds_item_w		varchar(255);
dt_liberacao_w		timestamp;
ds_horario_w		varchar(255);
dt_order_by_w		timestamp;
nm_prescritor_w		varchar(255);
nr_seq_horario_w	bigint;
nr_seq_item_w		bigint;
cd_item_w		varchar(15);
ie_tipo_item_w		varchar(5);
dt_horario_w		timestamp;

c01 CURSOR FOR 
	SELECT obter_desc_expressao(624601) || substr(' ' || ds_item,1,150) ds_item, 
		1 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* suplemento oral */
 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario 
	from	adep_pend_v 
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	nr_atendimento = nr_atendimento_p 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and	ie_proc_setor_user_p = 'N' 
	and	ie_tipo_item = 'S' 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'S') = 'S' 
	group by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item 
	
union
	 
	SELECT obter_desc_expressao(293085) || SUBSTR('   ' || ds_item,1,150) ds_item, 
		4 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, --medicamentos 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario 
	from	adep_pend_v 
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	nr_atendimento = nr_atendimento_p 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and	ie_proc_setor_user_p = 'N' 
	and	ie_tipo_item = 'M' 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'M') = 'S' 
	group 	by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item	 
	
union
 
	select obter_desc_expressao(296465) || substr('   ' || ds_item,1,150) ds_item, 
		6 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, -- procedimentos 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario 
	from	adep_pend_v 
	where	nr_atendimento = nr_atendimento_p 
	and	(obter_data_lib_proc_adep(dt_liberacao, dt_liberacao_medico, ie_data_proc_p) IS NOT NULL AND (obter_data_lib_proc_adep(dt_liberacao, dt_liberacao_medico, ie_data_proc_p))::text <> '') 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	ie_tipo_item = 'P' 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'P') = 'S' 
	group 	by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item 
	
union
 
	select obter_desc_expressao(297348) || substr('  ' || ds_item,1,150) ds_item, 
		8 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, -- recomendacoes 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario 
	from	adep_pend_v 
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	nr_atendimento = nr_atendimento_p 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	ie_tipo_item = 'R' 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and	ie_proc_setor_user_p = 'N' 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'R') = 'S' 
	group 	by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item 
	
union
 
	select 'SAE :' || substr('         ' || ds_item,1,150) ds_item, 
		10 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, -- sae 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario  
	from	adep_pend_v 
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	nr_atendimento = nr_atendimento_p 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	ie_tipo_item = 'E' 
	and	ie_proc_setor_user_p = 'N' 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'E') = 'S' 
	group 	by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item 
	
union
 
	select obter_desc_expressao(314959) || substr('         ' || ds_item,1,150) ds_item, 
		12 nr_seq_apresent, 
		nr_prescricao, 
		dt_liberacao, 
		to_char(dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, -- procedimentos 
		dt_horario dt_order_by, 
		nm_prescritor, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item, 
		dt_horario 
	from	adep_pend_v 
	where	nr_atendimento = nr_atendimento_p 
	and	(obter_data_lib_proc_adep(dt_liberacao, dt_liberacao_medico, ie_data_proc_p) IS NOT NULL AND (obter_data_lib_proc_adep(dt_liberacao, dt_liberacao_medico, ie_data_proc_p))::text <> '') 
	and	dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24 
	and	ie_tipo_item = 'L' 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	dt_horario between dt_inicial_p and dt_final_p 
	and  	adep_obter_se_hor_duplic(nr_atendimento, nr_prescricao, cd_item, ie_origem_proced, dt_horario, 'L') = 'S' 
	group 	by 
		dt_horario, 
		nr_prescricao, 
		dt_liberacao, 
		ds_item, 
		nm_prescritor, 
		nr_seq_apresent, 
		nr_seq_horario, 
		nr_seq_item, 
		cd_item, 
		ie_tipo_item 
	order 	by nr_seq_apresent, ds_item, dt_order_by, nr_prescricao;


BEGIN 
 
delete	 
from 	w_adep_duplicidade_t 
where	nm_usuario = nm_usuario_p;
 
commit;
 
open C01;
loop 
fetch C01 into	 
	ds_item_w, 
	nr_seq_apres_w, 
	nr_prescricao_w, 
	dt_liberacao_w, 
	ds_horario_w, 
	dt_order_by_w, 
	nm_prescritor_w, 
	nr_seq_horario_w, 
	nr_seq_item_w, 
	cd_item_w, 
	ie_tipo_item_w, 
	dt_horario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	 
	select	nextval('w_adep_duplicidade_t_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	 
	insert into w_adep_duplicidade_t(nr_sequencia, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					dt_atualizacao, 
					nm_usuario, 
					cd_item, 
					ds_item, 
					ie_tipo_item, 
					nr_prescricao, 
					nr_seq_item, 
					nr_seq_horario, 
					nr_seq_apresent, 
					dt_horario, 
					dt_liberacao 
					)					 
				values ( nr_sequencia_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_item_w, 
					ds_item_w, 
					ie_tipo_item_w, 
					nr_prescricao_w, 
					nr_seq_item_w, 
					nr_seq_horario_w, 
					nr_seq_apres_w, 
					dt_horario_w, 
					dt_liberacao_w											 
					);
	 
	 
	end;
end loop;
close C01;	
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_gerar_duplicidade ( dt_inicial_p timestamp, dt_final_p timestamp, nr_atendimento_p bigint, qt_hora_prescricao_p bigint, ie_proc_setor_user_p text, ie_data_proc_p text, nm_usuario_p text) FROM PUBLIC;

