-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_exame_lab_conv_eup_js ( nr_seq_exame_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ie_tipo_convenio_p bigint, nr_seq_proc_interno_p bigint, cd_material_exame_p text, nr_prescricao_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, ds_procedimento_p INOUT text, ds_erro_p INOUT text, cd_setor_p INOUT bigint, qt_material_exame_p INOUT bigint) AS $body$
DECLARE

 
cd_setor_w		integer;	
cd_procedimento_w	bigint;	
ie_origem_proced_w	bigint;		
ds_erro_w		varchar(255);
ds_procedimento_w		PROCEDIMENTO.DS_PROCEDIMENTO%type;
nr_seq_proc_interno_aux_w	bigint;
cd_plano_convenio_w	varchar(10);
				

BEGIN 
 
if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '')then 
	begin 
	 
	select 	obter_plano_conv_atend(nr_atendimento) 
	into STRICT	cd_plano_convenio_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
	 
	SELECT * FROM obter_exame_lab_convenio(	nr_seq_exame_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_estabelecimento_p, ie_tipo_convenio_p, nr_seq_proc_interno_p, cd_material_exame_p, cd_plano_convenio_w, cd_setor_w, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w) INTO STRICT cd_setor_w, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w;
					 
	select	count(*) 
	into STRICT 	qt_material_exame_p 
	FROM material_exame_lab b, exame_lab_material a
LEFT OUTER JOIN exame_lab_mat_estab d ON (a.nr_seq_material = d.nr_seq_material AND a.nr_seq_exame = d.nr_seq_exame)
WHERE a.nr_seq_material	= b.nr_sequencia   and a.ie_situacao 		= 'A' and a.nr_seq_exame 		= nr_seq_exame_p and (d.cd_estabelecimento in (	SELECT	y.cd_estabelecimento 
						from	prescr_medica y 
						where	y.nr_prescricao	= nr_prescricao_p) 
		or	coalesce(d.cd_estabelecimento::text, '') = '');
					 
	if (cd_procedimento_w > 0)then 
		begin 
		 
		if (ds_erro_w <> '')then 
			begin 
			 
			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280522,null);
			 
			end;
		end if;
		 
		select  ds_procedimento 
		into STRICT	 ds_procedimento_w 
		from   procedimento 
		where  cd_procedimento =  cd_procedimento_w 
		and   ie_origem_proced =  ie_origem_proced_w;
		 
		end;
	end if;
	 
	end;
end if;
 
cd_procedimento_p	:= cd_procedimento_w;
ie_origem_proced_p	:= ie_origem_proced_w;
ds_procedimento_p	:= ds_procedimento_w;
ds_erro_p		:= ds_erro_w;
cd_setor_p		:= cd_setor_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_exame_lab_conv_eup_js ( nr_seq_exame_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ie_tipo_convenio_p bigint, nr_seq_proc_interno_p bigint, cd_material_exame_p text, nr_prescricao_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, ds_procedimento_p INOUT text, ds_erro_p INOUT text, cd_setor_p INOUT bigint, qt_material_exame_p INOUT bigint) FROM PUBLIC;

