-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_itens_audit_conta ( nr_seq_auditoria_p bigint, nr_seq_item_p bigint, ie_tipo_item_p bigint, qt_item_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint) AS $body$
DECLARE

										 
dt_item_w		timestamp;
nr_interno_conta_w	bigint;
nr_interno_conta_ww	bigint;
nr_sequencia_w		bigint;
ie_Gerar_Pendencia_w	varchar(1);
cd_estabelecimento_w	smallint;
nr_seq_tipo_w		bigint;
ds_erro_w		varchar(255);
qt_item_w		double precision;


BEGIN 
 
qt_item_w:=qt_item_p;
 
if (nr_seq_auditoria_p IS NOT NULL AND nr_seq_auditoria_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then 
 
	if (ie_tipo_item_p = 1) then 
 
		select	coalesce(max(nr_interno_conta),0), 
			max(coalesce(dt_conta,dt_atendimento)), 
			max(coalesce(qt_material,qt_item_p)) -- fiz a alteração, pois a quantidade pode mudar na material_atend_paciente_insert, devido a regra de quantidade a faturar 
		into STRICT	nr_interno_conta_w, 
			dt_item_w, 
			qt_item_w 
		from	material_atend_paciente 
		where	nr_sequencia = nr_seq_item_p;
		 
	else 
 
		select	coalesce(max(nr_interno_conta),0), 
			coalesce(max(dt_procedimento),clock_timestamp()) 
		into STRICT	nr_interno_conta_w, 
			dt_item_w 
		from	procedimento_paciente 
		where	nr_sequencia = nr_seq_item_p;
		 
	end if;
 
	select	coalesce(max(nr_interno_conta),0) 
	into STRICT	nr_interno_conta_ww 
	from	auditoria_conta_paciente 
	where	nr_sequencia = nr_seq_auditoria_p;
 
	if (coalesce(nr_interno_conta_w,0) = coalesce(nr_interno_conta_ww,0)) then 
		CALL Atualizar_Lista_Itens_Audit(nr_interno_conta_ww, nr_seq_item_p, ie_tipo_item_p, qt_item_w, nm_usuario_p, nr_seq_motivo_p, 
			nr_seq_auditoria_p, 'N');
	else 
		 
		select 	coalesce(max(nr_sequencia),0) 
		into STRICT	nr_sequencia_w 
		from 	auditoria_conta_paciente 
		where 	coalesce(dt_liberacao::text, '') = '' 
		and 	nr_interno_conta = nr_interno_conta_w 
		and 	dt_item_w between dt_periodo_inicial and dt_periodo_final;
		 
		if (coalesce(nr_sequencia_w,0) = 0) and (coalesce(nr_interno_conta_w,0) > 0) then 
 
			select 	nextval('auditoria_conta_paciente_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			insert into auditoria_conta_paciente(			 
					nr_sequencia, 
					nr_interno_conta, 
					cd_auditor, 
					dt_auditoria, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					dt_liberacao, 
					nr_atendimento, 
					dt_periodo_inicial, 
					dt_periodo_final, 
					ie_tipo_auditoria, 
					cd_auditor_externo) 
				SELECT 	nr_sequencia_w, 
					nr_interno_conta_w, 
					cd_auditor, 
					dt_auditoria, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					null, 
					nr_atendimento, 
					dt_periodo_inicial, 
					dt_periodo_final, 
					ie_tipo_auditoria, 
					cd_auditor_externo 
				from 	auditoria_conta_paciente 
				where 	nr_sequencia = nr_seq_auditoria_p;
				 
			CALL Atualizar_Lista_Itens_Audit(nr_interno_conta_w, nr_seq_item_p, ie_tipo_item_p, qt_item_w, nm_usuario_p, nr_seq_motivo_p, 
				nr_sequencia_w, 'N');			
				 
			select 	coalesce(max(cd_estabelecimento),0) 
			into STRICT	cd_estabelecimento_w 
			from 	conta_paciente 
			where 	nr_interno_conta = nr_interno_conta_w;
			 
			ie_Gerar_Pendencia_w := obter_valor_param_usuario(1116, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
			 
			if (ie_Gerar_Pendencia_w = 'V') then 
			 
				update 	auditoria_conta_paciente 
				set 	vl_auditoria_orig = obter_valor_auditoria(nr_sequencia, nr_interno_conta) 
				where 	nr_sequencia = nr_sequencia_w;
			 
				if (ie_tipo_item_p = 2) then 
				 
					update	auditoria_propaci 
					set	ie_original = 'S' 
					where 	nr_seq_propaci = nr_seq_item_p 
					and 	nr_seq_auditoria = nr_sequencia_w;
				 
				end if;
			 
				select 	coalesce(max(nr_seq_tipo),0) 
				into STRICT	nr_seq_tipo_w 
				from 	cta_pendencia 
				where 	nr_seq_auditoria = nr_seq_auditoria_p;
						 
				ds_erro_w := gerar_pendencia_auditoria(nr_sequencia_w, nr_seq_tipo_w, nm_usuario_p, ds_erro_w);
				 
			end if;
			 
								 
		elsif (coalesce(nr_sequencia_w,0) > 0) and -- Para os casos de glosa 
			(coalesce(nr_interno_conta_w,0) > 0) then 
		 
			CALL Atualizar_Lista_Itens_Audit(nr_interno_conta_w, nr_seq_item_p, ie_tipo_item_p, qt_item_w, nm_usuario_p, nr_seq_motivo_p, 
				nr_sequencia_w, 'N');
				 
		end if;
 
	end if;
	 
end if;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_itens_audit_conta ( nr_seq_auditoria_p bigint, nr_seq_item_p bigint, ie_tipo_item_p bigint, qt_item_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint) FROM PUBLIC;

