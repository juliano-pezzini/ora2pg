-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_atend_tele ( nr_seq_pls_atendimento_p pls_atendimento.nr_sequencia%type, dt_atendimento_p timestamp, /* Passa a data do atendimento no call center */
 nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_mprev_part_ciclo_item_p mprev_partic_ciclo_item.nr_sequencia%type, nr_seq_atend_mprev_p INOUT bigint) AS $body$
DECLARE

					 
nr_seq_atendimento_w		bigint;
nr_seq_atend_part_w			bigint;
nr_seq_regra_eup_w			bigint;
nr_seq_pls_atendimento_w	bigint;
cd_pf_participante_w		varchar(10);
nr_seq_operador_w			bigint;
cd_pf_operador_w			varchar(10);
nr_seq_participante_w		bigint;
nr_atend_eup_w				bigint;
nr_seq_regra_event_w		bigint;
nr_seq_tipo_evento_w		bigint;
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
nr_seq_segurado_w			pls_segurado.nr_sequencia%type;


BEGIN 
 
select	cd_pessoa_fisica, 
		nr_seq_operador 
into STRICT	cd_pf_participante_w, 
		nr_seq_operador_w 
from	pls_atendimento 
where	nr_sequencia = nr_seq_pls_atendimento_p;
 
select	cd_pessoa_fisica 
into STRICT	cd_pf_operador_w 
from	pls_operador 
where	nr_sequencia = nr_seq_operador_w;
 
nr_seq_pls_atendimento_w := nr_seq_pls_atendimento_p;
 
select	nextval('mprev_atendimento_seq') 
into STRICT	nr_seq_atendimento_w
;
 
insert into mprev_atendimento(nr_sequencia, 
	nr_seq_pls_atend, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ie_individual_coletivo, 
	ie_forma_atendimento, 
	nr_seq_turma, 
	cd_profissional, 
	dt_inicio, 
	ie_urgencia, 
	cd_estabelecimento) 
values ( nr_seq_atendimento_w, 
	nr_seq_pls_atendimento_w, 
	dt_atendimento_p, 
	nm_usuario_p, 
	dt_atendimento_p, 
	nm_usuario_p, 
	'I', 
	'T', 
	null, 
	cd_pf_operador_w, 
	dt_atendimento_p, 
	'N', 
	cd_estabelecimento_p);
	 
select	max(nr_seq_participante) 
into STRICT	nr_seq_participante_w 
from	mprev_partic_ciclo_item_v 
where	cd_pessoa_fisica = cd_pf_participante_w;
 
if (coalesce(nr_seq_participante_w::text, '') = '') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_participante_w 
	from	mprev_participante a 
	where	a.cd_pessoa_fisica = cd_pf_participante_w;
end if;
 
nr_seq_segurado_w := mprev_obter_benef_partic(nr_seq_participante_w);
 
nr_seq_regra_eup_w := mprev_obter_regra_ger_atend(nr_seq_atendimento_w, nr_seq_segurado_w);
 
if (coalesce(nr_seq_regra_eup_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(292596);
else 
 
	select	nextval('mprev_atend_paciente_seq') 
	into STRICT	nr_seq_atend_part_w 
	;
 
	insert into mprev_atend_paciente(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_atendimento, 
		nr_seq_participante, 
		nr_seq_mprev_regra_atend) 
	values (nr_seq_atend_part_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_atendimento_w, 
		nr_seq_participante_w, 
		nr_seq_regra_eup_w);
	 
	nr_atend_eup_w := mprev_inserir_atend_eup(nr_seq_atendimento_w, nr_seq_regra_eup_w, cd_pf_participante_w, nm_usuario_p, nr_seq_segurado_w, nr_atend_eup_w);
	 
	nr_seq_regra_event_w := mprev_obter_regra_evento_atend(nr_seq_atend_part_w);
	 
	if (coalesce(nr_seq_regra_event_w::text, '') = '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(293212);
	else	 
	 
		select	nr_seq_tipo_evento, 
				cd_procedimento, 
				ie_origem_proced 
		into STRICT	nr_seq_tipo_evento_w, 
				cd_procedimento_w, 
				ie_origem_proced_w 
		from	mprev_regra_evento_atend 
		where	nr_sequencia = nr_seq_regra_event_w;
		 
		insert into mprev_atendimento_evento(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_inicio_evento, 
			cd_procedimento, 
			ie_origem_proced, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_atend_paciente, 
			nr_seq_tipo_evento, 
			cd_profissional, 
			ie_prof_adic, 
			nr_seq_atendimento) 
		values (nextval('mprev_atendimento_evento_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			cd_procedimento_w, 
			ie_origem_proced_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_atend_part_w, 
			nr_seq_tipo_evento_w, 
			cd_pf_operador_w, 
			'N', 
			nr_seq_atendimento_w);
	end if;
 
	update	mprev_atend_paciente 
	set		nr_atendimento	= nr_atend_eup_w 
	where	nr_sequencia	= nr_seq_atend_part_w;
	 
	if (coalesce(nr_seq_mprev_part_ciclo_item_p,0) > 0) then 
		update	pls_atendimento 
		set		nr_seq_mprev_part_ciclo_item = nr_seq_mprev_part_ciclo_item_p 
		where	nr_sequencia = nr_seq_pls_atendimento_p;
	end if;
	 
	nr_seq_atend_mprev_p	:= nr_seq_atendimento_w;
	 
end if;	
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_atend_tele ( nr_seq_pls_atendimento_p pls_atendimento.nr_sequencia%type, dt_atendimento_p timestamp,  nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_mprev_part_ciclo_item_p mprev_partic_ciclo_item.nr_sequencia%type, nr_seq_atend_mprev_p INOUT bigint) FROM PUBLIC;

