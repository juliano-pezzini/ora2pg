-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_mat_paciente_estab ( nr_sequencia_p procedimento_paciente.nr_sequencia%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type, dt_entrada_unidade_p atend_paciente_unidade.dt_entrada_unidade%type, nr_seq_interno_p procedimento_paciente.nr_seq_atepacu%type) AS $body$
DECLARE


nr_sequencia_w			material_atend_paciente.nr_sequencia%type;
cd_local_estoque_w		material_atend_paciente.cd_local_estoque%type;
cd_estabelecimento_w		conta_paciente.cd_estabelecimento%type;
nr_seq_proc_pri_orig_w		material_atend_paciente.nr_seq_proc_princ%type := null;
nr_seq_proc_princ_w		material_atend_paciente.nr_seq_proc_princ%type := null;
nr_atendimento_w		conta_paciente.nr_atendimento%type;
cd_convenio_w			conta_paciente.cd_convenio_parametro%type;
cd_categoria_w			conta_paciente.cd_categoria_parametro%type;
nr_doc_convenio_w		material_atend_paciente.nr_doc_convenio%type := '';


BEGIN

select nextval('material_atend_paciente_seq')
into STRICT nr_sequencia_w
;

select	cd_estabelecimento,
	cd_convenio_parametro,
	cd_categoria_parametro,
	nr_atendimento
into STRICT	cd_estabelecimento_w,
	cd_convenio_w,
	cd_categoria_w,
	nr_atendimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

cd_local_estoque_w := obter_local_estoque_setor(cd_setor_atendimento_p,cd_estabelecimento_w);

nr_doc_convenio_w	:= coalesce(obter_guia_atend(nr_atendimento_w,cd_convenio_w,cd_categoria_w),'');

begin
select	nr_seq_proc_princ
into STRICT	nr_seq_proc_pri_orig_w
from	material_atend_paciente
where 	nr_sequencia = nr_sequencia_p
and	(nr_seq_proc_princ IS NOT NULL AND nr_seq_proc_princ::text <> '');
exception
when others then
	nr_seq_proc_pri_orig_w	:= null;
	nr_seq_proc_princ_w	:= null;
end;
if (coalesce(nr_seq_proc_pri_orig_w,0) > 0) then
	begin

	begin
	select	nr_sequencia
	into STRICT	nr_seq_proc_princ_w
	from	procedimento_paciente
	where	nr_interno_conta = nr_interno_conta_p
	and	nr_seq_origem = nr_seq_proc_pri_orig_w;
	exception
	when others then
		nr_seq_proc_princ_w := null;
	end;

	end;
end if;

insert	into material_atend_paciente(
	nr_sequencia,			nr_atendimento,			dt_entrada_unidade,
	cd_material,			dt_atendimento,			cd_unidade_medida,
	qt_material,			dt_atualizacao,			nm_usuario,
	cd_convenio,			cd_categoria,			dt_prescricao,
	cd_material_prescricao,		ie_via_aplicacao,		ds_observacao,
	vl_material,			cd_tab_preco_material,		dt_vigencia_tabela,
	dt_acerto_conta,		dt_acerto_convenio,		nr_prescricao,
	nr_sequencia_prescricao,	cd_motivo_exc_conta,		ds_compl_motivo_excon,
	cd_local_estoque,		dt_atualizacao_estoque,		cd_acao,
	cd_setor_atendimento,		qt_devolvida,			cd_motivo_devolucao,
	nr_cirurgia,			nr_doc_convenio,		qt_executada,
	dt_conta,			vl_unitario,			cd_proced_referencia,
	cd_conta_contabil,		qt_ajuste_conta,		nr_aih,
	ie_valor_informado,		cd_estabelecimento_custo,	cd_tabela_custo,
	cd_situacao_glosa,		nr_lote_contabil,		cd_material_convenio,
	nr_seq_autorizacao,		nr_interno_conta,		nr_seq_proc_princ,
	ie_guia_informada,		cd_especialidade,		nm_usuario_original,
	nr_seq_proc_pacote,		vl_tabela_original,		ie_emite_conta,
	cd_setor_receita,		cd_cgc_fornecedor,		nr_seq_lote_fornec,
	cd_material_exec,		nr_seq_atepacu,			ie_tipo_guia,
	nr_doc_interno,			ie_auditoria,			nr_seq_grupo_rec,
	cd_motivo_ajuste,		nr_seq_cor_exec,		nr_seq_agenda_pac_opme)
SELECT	nr_sequencia_w,			nr_atendimento_w,		dt_entrada_unidade_p,
	cd_material,			dt_atendimento,			cd_unidade_medida,
	qt_material,			clock_timestamp(),			nm_usuario_p,
	cd_convenio_w,			cd_categoria_w,			dt_prescricao,
	cd_material_prescricao,		ie_via_aplicacao,		ds_observacao,
	0,				cd_tab_preco_material,		dt_vigencia_tabela,
	dt_acerto_conta,		dt_acerto_convenio,		nr_prescricao,
	nr_sequencia_prescricao,	cd_motivo_exc_conta,		ds_compl_motivo_excon,
	cd_local_estoque_w,		dt_atualizacao_estoque,		cd_acao,
	cd_setor_atendimento_p,		qt_devolvida,			cd_motivo_devolucao,
	nr_cirurgia,			CASE WHEN coalesce(nr_doc_convenio,'X')='X' THEN ''  ELSE coalesce(nr_doc_convenio_w,'') END ,
 	qt_executada,
	dt_conta,			vl_unitario,			cd_proced_referencia,
	cd_conta_contabil,		qt_ajuste_conta,		nr_aih,
	ie_valor_informado,		cd_estabelecimento_w,		cd_tabela_custo,
	cd_situacao_glosa,		nr_lote_contabil,		cd_material_convenio,
	nr_seq_autorizacao,		nr_interno_conta_p,		nr_seq_proc_princ_w,
	ie_guia_informada,		cd_especialidade,		nm_usuario_original,
	nr_seq_proc_pacote,		vl_tabela_original,		ie_emite_conta,
	cd_setor_atendimento_p,		cd_cgc_fornecedor,		nr_seq_lote_fornec,
	cd_material_exec,		nr_seq_interno_p,		ie_tipo_guia,
	nr_doc_interno,			ie_auditoria,			nr_seq_grupo_rec,
	cd_motivo_ajuste,		1762,				nr_seq_agenda_pac_opme
from 	material_atend_paciente
where 	nr_sequencia = nr_sequencia_p;

CALL atualiza_preco_material(nr_sequencia_w,nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_mat_paciente_estab ( nr_sequencia_p procedimento_paciente.nr_sequencia%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type, dt_entrada_unidade_p atend_paciente_unidade.dt_entrada_unidade%type, nr_seq_interno_p procedimento_paciente.nr_seq_atepacu%type) FROM PUBLIC;

