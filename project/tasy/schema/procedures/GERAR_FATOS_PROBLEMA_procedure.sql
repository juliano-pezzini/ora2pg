-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fatos_problema ( nr_seq_problema_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
ds_fatos_relevantes_w	lista_problema_pac.ds_fatos_relevantes%type;
ie_tipo_diagnostico_w 	lista_problema_pac.ie_tipo_diagnostico%type;
ie_main_enc_probl_w     lista_problema_pac.ie_main_enc_probl%type;

ds_lista_w				varchar(4000);
ie_pos_enter_w			smallint;
ds_fato_w				varchar(255) := '';
nr_seq_apresentacao_w	bigint	:= 0;

qt_intervalo_status_w   double precision;
ie_fato_informado_w		varchar(1);

ds_observacao_w			varchar(255);



BEGIN


if (coalesce(nr_seq_problema_p,0) > 0 ) then
	
	Select 	max(nr_atendimento),
			max(cd_pessoa_fisica),
			max(ds_fatos_relevantes),
			max(round((clock_timestamp() - dt_atualizacao)::numeric, 4)),
			max(ie_tipo_diagnostico),
            max(ie_main_enc_probl)
	into STRICT	nr_atendimento_w,
			cd_pessoa_fisica_w,
			ds_fatos_relevantes_w,
			qt_intervalo_status_w,
			ie_tipo_diagnostico_w,
            ie_main_enc_probl_w
	from	lista_problema_pac
	where	nr_sequencia = nr_seq_problema_p;
	
	select  coalesce(max('S'),'N')
	into STRICT	ie_fato_informado_w
	from	lista_problema_status
	where	nr_seq_problema  = nr_seq_problema_p
	and		(ds_fatos IS NOT NULL AND ds_fatos::text <> '');
	
	
	if ( (trim(both ds_fatos_relevantes_w) IS NOT NULL AND (trim(both ds_fatos_relevantes_w))::text <> '')) then
	
		delete 	from lista_problema_pac_fatos
		where	nr_seq_problema = nr_seq_problema_p;
		
		commit;
		
		ds_lista_w	:= trim(both ds_fatos_relevantes_w);
		
		
		while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
			begin
			
			nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;
			
			ie_pos_enter_w 	:= position(CHR(10) in ds_lista_w);
			
			if (ie_pos_enter_w <> 0) then
				begin
				ds_fato_w	:= substr(ds_lista_w,1,(ie_pos_enter_w - 1));
				ds_lista_w	:= substr(ds_lista_w,(ie_pos_enter_w + 1),length(ds_lista_w));
				end;
			else
				begin
				ds_fato_w	:= substr(ds_lista_w,1,255);
				ds_lista_w	:= null;
				end;
			end if;
			
			if ( (trim(both ds_fato_w) IS NOT NULL AND (trim(both ds_fato_w))::text <> '')) then
			
				insert into lista_problema_pac_fatos(  nr_sequencia,
														nm_usuario,
														nm_usuario_nrec,
														dt_atualizacao,
														dt_atualizacao_nrec,
														nr_seq_problema,
														nr_seq_apresentacao,
														ds_fato)
											values (   nextval('lista_problema_pac_fatos_seq'),
														nm_usuario_p,
														nm_usuario_p,
														clock_timestamp(),
														clock_timestamp(),
														nr_seq_problema_p,
														nr_seq_apresentacao_w,
														ds_fato_w);
														
				commit;
				
			end if;
									
			end;
		end loop;
		
		if (ie_fato_informado_w = 'S') then
		
			Select 	obter_desc_expressao(893409)||' '||obter_desc_expressao(302570)
			into STRICT	ds_observacao_w
			;
		
		else
		
			Select 	obter_desc_expressao(893409)||' '||obter_desc_expressao(326396)
			into STRICT	ds_observacao_w
			;
			
		
		end if;
		

		insert into lista_problema_status(		
					nr_sequencia,
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec,
					nm_usuario_nrec, 
					qt_intervalo_status, 
					nr_seq_problema,
					ds_fatos,
					ds_observacao,
					ie_tipo_diagnostico,
                    ie_main_enc_probl
					) values (
					nextval('lista_problema_status_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					qt_intervalo_status_w,
					nr_seq_problema_p,
					ds_fatos_relevantes_w,
					ds_observacao_w,
					ie_tipo_diagnostico_w,
                    ie_main_enc_probl_w);
					
		Commit;
		
	
	else
	
		delete 	from lista_problema_pac_fatos
		where	nr_seq_problema = nr_seq_problema_p;
		
		commit;
		
		if ( ie_fato_informado_w = 'S') then
		
			Select 	obter_desc_expressao(893218)||' '||obter_desc_expressao(307668)
			into STRICT	ds_observacao_w
			;
		
			insert into lista_problema_status(		
					nr_sequencia,
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec,
					nm_usuario_nrec, 
					qt_intervalo_status, 
					nr_seq_problema,
					ds_observacao,
					ie_tipo_diagnostico,
                    ie_main_enc_probl
					) values (
					nextval('lista_problema_status_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					qt_intervalo_status_w,
					nr_seq_problema_p,
					ds_observacao_w,
					ie_tipo_diagnostico_w,
                    ie_main_enc_probl_w);
					
		Commit;
		
		
		end if;
	
	
	end if;

end if;
		

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fatos_problema ( nr_seq_problema_p bigint, nm_usuario_p text) FROM PUBLIC;

