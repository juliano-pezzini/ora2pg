-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inativa_exec_obj_repetido (cd_versao_p text, nr_pacote_p bigint) is nm_objeto_w varchar(100) RETURNS varchar AS $body$
DECLARE

    str_aux_w   varchar(100);
    nm_objeto_w varchar(100);
    chr_w       varchar(1);

  s RECORD;
  r RECORD;

BEGIN
    select regexp_replace(replace(replace(to_char(substr(ds_comando, 1, 100)),
                                          chr(10),
                                          ' '),
                                  chr(13),
                                  ' '),
                          '\s{2,}',
                          ' ')
      into STRICT str_aux_w
      from ajuste_versao_cliente v
     where nr_sequencia = nr_sequencia_pp;

    if upper(trim(both substr(trim(both str_aux_w),
                         1,
                         instr(trim(both str_aux_w), ' ', 1, 3)))) =
       'CREATE OR REPLACE' then
      str_aux_w := trim(both substr(trim(both str_aux_w),
                               instr(trim(both str_aux_w), ' ', 1, 4)));

      for i in 1 .. length(str_aux_w) loop
        chr_w := substr(str_aux_w, i, 1);

        if ascii(lower(chr_w)) between ascii('a') and ascii('z') or
           ascii(lower(chr_w)) between ascii('0') and ascii('9') or
           chr_w = '_' then
          nm_objeto_w := nm_objeto_w || chr_w;
        else
          exit;
        end if;

      end loop;

    else
      nm_objeto_w := null;
    end if;
    return nm_objeto_w;
  end;

begin

  for s in (SELECT nr_sequencia
              from ajuste_versao_cliente
             where cd_versao = cd_versao_p
               and nr_pacote = nr_pacote_p) loop
    nm_objeto_w := fnc_get_object_name(s.nr_sequencia);

    for r in (SELECT *
                from ajuste_versao_cliente
               where cd_versao = cd_versao_p
                 and nr_pacote < nr_pacote_p
                 and nr_sequencia != s.nr_sequencia
               order by nr_release desc) loop
    
      if fnc_get_object_name(r.nr_sequencia) = nm_objeto_w then
        update ajuste_versao_cliente a
           set a.ie_compila = 'S'
         where a.nr_sequencia = r.nr_sequencia;
      end if;

    end loop;
  end loop;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inativa_exec_obj_repetido (cd_versao_p text, nr_pacote_p bigint) is nm_objeto_w varchar(100) FROM PUBLIC;

