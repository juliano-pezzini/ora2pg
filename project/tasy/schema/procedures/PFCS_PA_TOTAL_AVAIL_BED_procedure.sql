-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_pa_total_avail_bed ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_indicator_w              pfcs_panel.nr_seq_indicator%type := 121;
pfcs_panel_detail_seq_w      pfcs_panel_detail.nr_sequencia%type;
pfcs_detail_bed_seq_w      pfcs_detail_bed.nr_sequencia%type;
pfcs_panel_seq_w          pfcs_panel.nr_sequencia%type;

qt_available_bed_w              numeric(20) := 0;
qt_total_beds_w                 numeric(20) := 0;


BEGIN

    select count(uni.cd_setor_atendimento)
    into STRICT qt_available_bed_w
    from unidade_atendimento uni
    where uni.cd_setor_atendimento in (
                SELECT cd_setor_atendimento
                    from setor_atendimento
                    where  ie_situacao             = 'A'
                        and ie_ocup_hospitalar      <> 'N'
                        and cd_estabelecimento_base = cd_estabelecimento_p
                        and cd_classif_setor = 1)
        and  uni.ie_situacao = 'A'
        and uni.ie_status_unidade= 'L';

    select count(uni.cd_setor_atendimento)
    into STRICT qt_total_beds_w
    from unidade_atendimento uni
    where uni.cd_setor_atendimento in (
                SELECT cd_setor_atendimento
                    from setor_atendimento
                    where  ie_situacao             = 'A'
                        and ie_ocup_hospitalar      <> 'N'
                        and cd_estabelecimento_base = cd_estabelecimento_p
                        and cd_classif_setor = 1)
        and  uni.ie_situacao           = 'A'
        and uni.ie_status_unidade not in ('U', 'I');

    select  nextval('pfcs_panel_detail_seq')
    into STRICT  pfcs_panel_detail_seq_w
;
	
     insert into pfcs_panel_detail(
        nr_sequencia,
        nm_usuario,
        dt_atualizacao,
        nm_usuario_nrec,
        dt_atualizacao_nrec,
        ie_situation,
        nr_seq_indicator,
        nr_seq_operational_level)
    values (
        pfcs_panel_detail_seq_w,
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        'T',
        nr_seq_indicator_w,
        cd_estabelecimento_p);

    commit;

     := pfcs_pck.pfcs_generate_results(
        vl_indicator_p => qt_available_bed_w, vl_indicator_aux_p => qt_total_beds_w, nr_seq_indicator_p => nr_seq_indicator_w, nr_seq_operational_level_p => cd_estabelecimento_p, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => pfcs_panel_seq_w);

    CALL pfcs_pck.pfcs_update_detail(
            nr_seq_indicator_p => nr_seq_indicator_w,
            nr_seq_panel_p => pfcs_panel_seq_w,
            nr_seq_operational_level_p => cd_estabelecimento_p,
            nm_usuario_p => nm_usuario_p);

    CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => nr_seq_indicator_w,
            nr_seq_operational_level_p => cd_estabelecimento_p,
            nm_usuario_p => nm_usuario_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pa_total_avail_bed ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

