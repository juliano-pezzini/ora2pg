-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE start_fleury ( DS_METHOD_P text, NR_PRESCRICAO_P text, NR_SEQ_PRESCRICAO_P text, CD_PESSOA_FISICA_P text, CD_ESTABELECIMENTO_P text, NM_USUARIO_P text, CD_SETOR_ATENDIMENTO_P text, CD_PERFIL_P text, NM_MAQUINA_P text) AS $body$
DECLARE


ie_integra_prescr_fleury varchar(20);
ie_fleury_count bigint;

BEGIN

select
    count(1)
into STRICT
  ie_fleury_count
from
    prescr_medica pm
    inner join lab_parametro lp on lp.cd_estabelecimento = pm.cd_estabelecimento
where
    pm.nr_prescricao = nr_prescricao_p and (IE_FLEURY_SINC_REP in ('A', 'D') or IE_FLEURY_SINC_EUP in ('A', 'D'));

if (ie_fleury_count > 0) then
            ie_integra_prescr_fleury := OBTER_PRESCR_FLEURY_ASYNC(nr_prescricao_p,DS_METHOD_P);
else
    begin

    select coalesce(OBTER_SE_INT_PRESCR_FLEURY((nr_prescricao_p)::numeric ,DS_METHOD_P),'0')
    into STRICT   ie_integra_prescr_fleury
;

    exception
     When others then
          ie_integra_prescr_fleury := '0';
    end;
end if;

if (wheb_usuario_pck.is_evento_ativo(625) = 'S' and ie_integra_prescr_fleury != '0') then

	CALL gravar_agend_integracao(625, 	'DS_METHOD='||DS_METHOD_P||';'||
									'NR_PRESCRICAO='||NR_PRESCRICAO_P||';'||
									'NR_SEQ_PRESCRICAO='||NR_SEQ_PRESCRICAO_P||';'||
									'CD_PESSOA_FISICA='||CD_PESSOA_FISICA_P||';'||
									'CD_ESTABELECIMENTO='||CD_ESTABELECIMENTO_P||';'||
									'NM_USUARIO='||NM_USUARIO_P||';'||
									'CD_SETOR_ATENDIMENTO='||CD_SETOR_ATENDIMENTO_P||';'||
									'CD_PERFIL='||CD_PERFIL_P||';'||
									'NM_MAQUINA='||NM_MAQUINA_P||';');

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE start_fleury ( DS_METHOD_P text, NR_PRESCRICAO_P text, NR_SEQ_PRESCRICAO_P text, CD_PESSOA_FISICA_P text, CD_ESTABELECIMENTO_P text, NM_USUARIO_P text, CD_SETOR_ATENDIMENTO_P text, CD_PERFIL_P text, NM_MAQUINA_P text) FROM PUBLIC;

