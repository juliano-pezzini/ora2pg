-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_lote_reapresentacao ( nr_seq_retorno_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_lote_w			varchar(255);
nr_interno_conta_w		bigint;
nr_seq_protocolo_w		bigint;
cd_estabelecimento_w		integer;
nr_seq_conta_guia_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_opm_w		bigint;
nr_interno_conta_guia_w		bigint;
nr_seq_reap_opm_w		bigint;
nr_seq_conta_desp_w		bigint;
nr_seq_reap_conta_w		bigint;
nr_seq_reap_lote_w		bigint;
nr_seq_propaci_w			bigint;
nr_seq_matpaci_w			bigint;
qt_reap_conta_w			bigint;
cd_procedimento_conv_w		varchar(255);
cd_material_w			bigint;
qt_material_w			double precision;
ie_tiss_tipo_guia_w			varchar(255);
cd_cgc_prestador_w		varchar(255);
nr_doc_convenio_w		varchar(255);
cd_convenio_w			bigint;
cont_w				bigint;
qt_glosa_w			double precision;
vl_glosa_w			double precision;
vl_glosa_ret_w			double precision;
ds_observacao_w			varchar(4000);
cd_procedimento_w		bigint;
cd_procedimento_convenio_w	varchar(255);
ie_carater_atend_w		varchar(255);
cd_material_tiss_w			varchar(255);
cd_material_convenio_w		varchar(255);
cd_cgc_exec_w			varchar(255);
cd_cgc_solic_w			varchar(255);
cd_interno_exec_w		varchar(255);
cd_interno_compl_w		varchar(255);
cd_interno_solic_w		varchar(255);
cd_pessoa_exec_w		varchar(255);
cd_resposta_w			bigint;
ds_resposta_w			varchar(255);
cd_plano_convenio_w		varchar(255);
nr_lote_reap_w			bigint;
ie_lote_reap_w			varchar(255);
cd_procedimento_tuss_w		bigint;
qt_guia_protocolo_w		bigint;
nr_atendimento_w		bigint;
dt_validade_carteira_w		timestamp;	
dt_atendimento_w		timestamp;	
ie_gerar_desp_proc_w		varchar(20);
nr_interno_conta_excl_w		bigint;

c01 CURSOR FOR 
SELECT	nr_seq_propaci, 
	nr_seq_matpaci, 
	ds_observacao, 
	cd_procedimento, 
	cd_procedimento_convenio, 
	vl_glosa, 
	cd_procedimento_tuss, 
	nr_interno_conta 
from ( 
	SELECT	b.nr_seq_propaci, 
		null nr_seq_matpaci, 
		substr(obter_desc_resposta_glosa(b.cd_resposta) || ' / ' || b.ds_observacao || ' / ' || b.ds_complemento,1,3900) ds_observacao, 
		d.cd_procedimento cd_procedimento, 
		d.cd_procedimento_convenio cd_procedimento_convenio, 
		b.vl_glosa, 
		d.cd_procedimento_tuss, 
		a.nr_interno_conta 
	from	motivo_glosa c, 
		convenio_retorno_item a, 
		convenio_retorno_glosa b, 
		procedimento_paciente d 
	where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
	and	a.nr_sequencia				= b.nr_seq_ret_item 
	and	d.nr_sequencia				= b.nr_seq_propaci 
	and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa)	= 'R' 
	and	a.nr_seq_retorno			= nr_seq_retorno_p 
	and	(b.nr_seq_propaci IS NOT NULL AND b.nr_seq_propaci::text <> '') 
	
union all
 
	select	null, 
		b.nr_seq_matpaci, 
		substr(obter_desc_resposta_glosa(b.cd_resposta) || ' / ' || b.ds_observacao || ' / ' || b.ds_complemento,1,3900) ds_observacao, 
		d.cd_material cd_procedimento, 
		coalesce(d.cd_material_tiss, d.cd_material_convenio) cd_procedimento_convenio, 
		b.vl_glosa, 
		null, 
		a.nr_interno_conta 
	from	motivo_glosa c, 
		convenio_retorno_item a, 
		convenio_retorno_glosa b, 
		material_atend_paciente d 
	where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
	and	a.nr_sequencia				= b.nr_seq_ret_item 
	and	d.nr_sequencia				= b.nr_seq_matpaci 
	and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
	and	a.nr_seq_retorno			= nr_seq_retorno_p 
	and	(b.nr_seq_matpaci IS NOT NULL AND b.nr_seq_matpaci::text <> '') 
	
union all
 
	select	d.nr_seq_propaci, 
		null nr_seq_matpaci, 
		d.ds_observacao, 
		(null)::numeric  cd_procedimento, 
		null, -- dsantos em 15/11/2010 -> OS 201783. Se for item do reapresentação de contas, faz o select do cd_procedimento(mat) e do cd_procedimento_conv(mat) depois que abrir o cursor 
		d.vl_amenor, 
		p.cd_procedimento_tuss, 
		c.nr_interno_conta 
	from	lote_audit_hist b, 
		lote_audit_hist_guia c, 
		lote_audit_hist_item d, 
		procedimento_paciente p 
	where	c.nr_seq_lote_hist		= b.nr_sequencia 
	and	d.nr_seq_guia			= c.nr_sequencia 
	and	p.nr_sequencia			= d.nr_seq_propaci 
	and	b.nr_sequencia			= nr_seq_lote_audit_p 
	and	d.vl_amenor			> 0 
	and (d.nr_seq_propaci IS NOT NULL AND d.nr_seq_propaci::text <> '')		 
	
union all
	 
	select	null nr_seq_propaci, 
		d.nr_seq_matpaci, 
		d.ds_observacao, 
		(null)::numeric  cd_procedimento, 
		null, -- dsantos em 15/11/2010 -> OS 201783. Se for item do reapresentação de contas, faz o select do cd_procedimento(mat) e do cd_procedimento_conv(mat) depois que abrir o cursor 
		d.vl_amenor, 
		null, 
		c.nr_interno_conta 
	from	lote_audit_hist b, 
		lote_audit_hist_guia c, 
		lote_audit_hist_item d 
	where	c.nr_seq_lote_hist			= b.nr_sequencia 
	and	d.nr_seq_guia			= c.nr_sequencia 
	and	b.nr_sequencia			= nr_seq_lote_audit_p 
	and	d.vl_amenor			> 0 
	and (d.nr_seq_matpaci IS NOT NULL AND d.nr_seq_matpaci::text <> '') 
	
union all
 /*UNION ABAIXO PARA OS ITENS GLOSADOS QUE NÃO POSSUEM VINCULO COM O ITEM DA CONTA*/
 
	select	d.nr_sequencia nr_seq_propaci, 
		null nr_seq_matpaci, 
		substr(obter_desc_resposta_glosa(b.cd_resposta) || ' / ' || b.ds_observacao || ' / ' || b.ds_complemento,1,3900) ds_observacao, 
		d.cd_procedimento cd_procedimento, 
		d.cd_procedimento_convenio cd_procedimento_convenio, 
		b.vl_glosa, 
		d.cd_procedimento_tuss, 
		a.nr_interno_conta 
	from	motivo_glosa c, 
		convenio_retorno_item a, 
		convenio_retorno_glosa b, 
		procedimento_paciente d 
	where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
	and	a.nr_sequencia				= b.nr_seq_ret_item 
	and	d.nr_interno_conta			= a.nr_interno_conta 
	and	d.nr_sequencia				= TISS_OBTER_SEQ_ITEM_CONTA(a.nr_interno_conta,a.cd_autorizacao,b.cd_procedimento,'P') 
	and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa)	= 'R' 
	and	a.nr_seq_retorno			= nr_seq_retorno_p 
	and	coalesce(b.nr_seq_propaci::text, '') = '' 
	
union all
 /*UNION ABAIXO PARA OS ITENS GLOSADOS QUE NÃO POSSUEM VINCULO COM O ITEM DA CONTA*/
 
	select	null nr_seq_propaci, 
		d.nr_sequencia nr_seq_matpaci, 
		substr(obter_desc_resposta_glosa(b.cd_resposta) || ' / ' || b.ds_observacao || ' / ' || b.ds_complemento,1,3900) ds_observacao, 
		d.cd_material cd_procedimento, 
		coalesce(d.cd_material_tiss, d.cd_material_convenio) cd_procedimento_convenio, 
		b.vl_glosa, 
		null, 
		a.nr_interno_conta 
	from	motivo_glosa c, 
		convenio_retorno_item a, 
		convenio_retorno_glosa b, 
		material_atend_paciente d 
	where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
	and	a.nr_sequencia				= b.nr_seq_ret_item 
	and	d.nr_interno_conta			= a.nr_interno_conta 
	and	d.nr_sequencia				= TISS_OBTER_SEQ_ITEM_CONTA(a.nr_interno_conta,a.cd_autorizacao,b.cd_material,'M') 
	and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
	and	a.nr_seq_retorno			= nr_seq_retorno_p 
	and	coalesce(b.nr_seq_matpaci::text, '') = '') alias24;

c02 CURSOR FOR 
SELECT	distinct 
	e.ie_tiss_tipo_guia 
from	tiss_protocolo_guia e 
where	(	(e.nr_seq_protocolo 	= nr_seq_protocolo_w) 
	or (nr_seq_lote_audit_p IS NOT NULL AND nr_seq_lote_audit_p::text <> '')) 
and	(exists	(SELECT	1 
		from	motivo_glosa c, 
			convenio_retorno_item a, 
			convenio_retorno_glosa b, 
			procedimento_paciente d 
		where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
		and	a.nr_sequencia				= b.nr_seq_ret_item 
		and	d.nr_sequencia				= b.nr_seq_propaci 
		and	((e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia) or (e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia_honor) or (e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia_desp)) 
		and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
		and	a.nr_seq_retorno			= nr_seq_retorno_p 
		and	(b.nr_seq_propaci IS NOT NULL AND b.nr_seq_propaci::text <> '')) or 
	exists (select	1 
		from	motivo_glosa c, 
			convenio_retorno_item a, 
			convenio_retorno_glosa b, 
			material_atend_paciente d 
		where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
		and	a.nr_sequencia				= b.nr_seq_ret_item 
		and	d.nr_sequencia				= b.nr_seq_matpaci 
		and	e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia_desp 
		and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
		and	a.nr_seq_retorno			= nr_seq_retorno_p 
		and	(b.nr_seq_matpaci IS NOT NULL AND b.nr_seq_matpaci::text <> '')) or 
	exists	(select	1 
		from	lote_audit_hist b, 
			lote_audit_hist_guia c, 
			procedimento_paciente a, 
			lote_audit_hist_item d 
		where	c.nr_seq_lote_hist		= b.nr_sequencia 
		and	d.nr_seq_guia			= c.nr_sequencia 
		and	a.nr_sequencia			= d.nr_seq_propaci 
		and	((e.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia) 
			 or (e.ie_tiss_tipo_guia	= a.ie_tiss_tipo_guia_desp)) 
		and	b.nr_sequencia			= nr_seq_lote_audit_p) or 
	exists (select	1 
		from	lote_audit_hist b, 
			lote_audit_hist_guia c, 
			material_atend_paciente a, 
			lote_audit_hist_item d 
		where	c.nr_seq_lote_hist		= b.nr_sequencia 
		and	d.nr_seq_guia			= c.nr_sequencia 
		and	a.nr_sequencia			= d.nr_seq_matpaci 
		and	e.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp 
		and	b.nr_sequencia			= nr_seq_lote_audit_p) or 
	exists	(select	1 /*SELECT ABAIXO PARA OS ITENS GLOSADOS QUE NÃO POSSUEM VINCULO COM O ITEM DA CONTA*/
 
		from	motivo_glosa c, 
			convenio_retorno_item a, 
			convenio_retorno_glosa b, 
			procedimento_paciente d 
		where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
		and	a.nr_sequencia				= b.nr_seq_ret_item 
		and	a.nr_interno_conta			= d.nr_interno_conta 
		and	d.nr_sequencia				= TISS_OBTER_SEQ_ITEM_CONTA(a.nr_interno_conta,a.cd_autorizacao,b.cd_procedimento,'P') 
		and	((e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia) 
			 or (e.ie_tiss_tipo_guia		= d.ie_tiss_tipo_guia_desp)) 
		and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
		and	a.nr_seq_retorno			= nr_seq_retorno_p 
		and	coalesce(b.nr_seq_propaci::text, '') = '') or 
	exists (select	1 /*SELECT ABAIXO PARA OS ITENS GLOSADOS QUE NÃO POSSUEM VINCULO COM O ITEM DA CONTA*/
 
		from	motivo_glosa c, 
			convenio_retorno_item a, 
			convenio_retorno_glosa b, 
			material_atend_paciente d 
		where	b.cd_motivo_glosa			= c.cd_motivo_glosa 
		and	a.nr_sequencia				= b.nr_seq_ret_item 
		and	a.nr_interno_conta			= d.nr_interno_conta 
		and	d.nr_sequencia				= TISS_OBTER_SEQ_ITEM_CONTA(a.nr_interno_conta,a.cd_autorizacao,b.cd_material,'M') 
		and	e.ie_tiss_tipo_guia			= d.ie_tiss_tipo_guia_desp 
		and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) 	= 'R' 
		and	a.nr_seq_retorno			= nr_seq_retorno_p 
		and	coalesce(b.nr_seq_matpaci::text, '') = '')) 
and 	e.ie_tiss_tipo_guia	<> '7' 
order by ie_tiss_tipo_guia;


BEGIN 
 
delete 	from tiss_log_reap 
where	nr_seq_retorno = nr_seq_retorno_p or 
	nr_seq_lote_hist = nr_seq_lote_audit_p;
 
if (coalesce(nr_seq_retorno_p,0) > 0) then 
	select	count(*) 
	into STRICT	cont_w 
	from	tiss_reap_lote 
	where	nr_seq_retorno			= nr_seq_retorno_p;
 
	select	max(c.nr_seq_protocolo), 
		max(c.cd_estabelecimento), 
		max(c.ds_lote_convenio), 
		max(cd_convenio) 
	into STRICT	nr_seq_protocolo_w, 
		cd_estabelecimento_w, 
		ds_lote_w, 
		cd_convenio_w 
	from	convenio_retorno c 
	where	c.nr_sequencia			= nr_seq_retorno_p 
	and	(c.nr_seq_protocolo IS NOT NULL AND c.nr_seq_protocolo::text <> '');
	 
	if (coalesce(nr_seq_protocolo_w::text, '') = '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(184291);
		--r.aise_application_error(-20011, 'Protocolo não encontrado. Lote de reapresentação não será gerado.#@#@'); 
	end if;
 
elsif (coalesce(nr_seq_lote_audit_p,0) > 0) then 
 
	select	count(*) 
	into STRICT	cont_w 
	from	tiss_reap_lote 
	where	nr_seq_lote_audit		= nr_seq_lote_audit_p;
	 
	select	max(b.cd_estabelecimento), 
		max(b.cd_convenio) 
	into STRICT	cd_estabelecimento_w, 
		cd_convenio_w 
	from	lote_audit_hist a, 
		lote_auditoria b 
	where	b.nr_sequencia		= a.nr_seq_lote_audit 
	and	a.nr_sequencia		= nr_seq_lote_audit_p;
end if;	
 
if	coalesce(cont_w, 0) > 0 then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184292);
	--r.aise_application_error(-20011, 'Já foi gerada reapresentação para este retorno!#@#@'); 
end if;
 
if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') and (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then 
 
	select 	coalesce(max(ie_lote_reap),'N') 
	into STRICT 	ie_lote_reap_w 
	from 	convenio_estabelecimento 
	where 	cd_estabelecimento	= cd_estabelecimento_w 
	and	cd_convenio		= cd_convenio_w;
end if;
 
ie_gerar_desp_proc_w := obter_param_usuario(3400, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_desp_proc_w);
 
qt_guia_protocolo_w	:= 0;
open c02;
loop 
fetch c02 into 
	ie_tiss_tipo_guia_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
 
	qt_guia_protocolo_w	:= qt_guia_protocolo_w + 1;
 
	select	nextval('tiss_reap_lote_seq') 
	into STRICT	nr_seq_reap_lote_w 
	;
 
	/*lhalves OS243151 em 27/08/2010*/
 
	if (coalesce(ie_lote_reap_w,'N') = 'S') and (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then 
		nr_lote_reap_w	:= TISS_OBTER_LOTE_ENVIO(nr_seq_protocolo_w, ie_tiss_tipo_guia_w);
	else 
		nr_lote_reap_w 	:= nr_seq_reap_lote_w;
	end if;
 
	insert into tiss_reap_lote(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		nr_lote, 
		nr_seq_protocolo, 
		nr_seq_retorno, 
		ds_lote, 
		cd_estabelecimento, 
		cd_convenio, 
		ie_status_acerto, 
		ie_tiss_tipo_guia, 
		NR_SEQ_LOTE_AUDIT, 
		VL_DIARIA, 
		VL_GASES, 
		VL_MATERIAL, 
		VL_MEDICAMENTO, 
		VL_PROCEDIMENTO, 
		VL_TAXA, 
		VL_TOTAL, 
		VL_TOTAL_HONORARIO) 
	values (	nr_seq_reap_lote_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		--nr_seq_reap_lote_w, 
		nr_lote_reap_w, 
		nr_seq_protocolo_w, 
		nr_seq_retorno_p, 
		ds_lote_w, 
		cd_estabelecimento_w, 
		cd_convenio_w, 
		'1', 
		ie_tiss_tipo_guia_w, 
		nr_seq_lote_audit_p, 
		0, 
		0, 
		0, 
		0, 
		0, 
		0, 
		0, 
		0);
 
	open c01;
	loop 
	fetch c01 into 
		nr_seq_propaci_w, 
		nr_seq_matpaci_w, 
		ds_observacao_w, 
		cd_procedimento_w, 
		cd_procedimento_convenio_w, 
		vl_glosa_ret_w, 
		cd_procedimento_tuss_w, 
		nr_interno_conta_guia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
		if (coalesce(nr_seq_lote_audit_p, 0) > 0) then 
			if (nr_seq_propaci_w IS NOT NULL AND nr_seq_propaci_w::text <> '') then 
				select	cd_procedimento, 
					cd_procedimento_convenio 
				into STRICT	cd_procedimento_w, 
					cd_procedimento_convenio_w 
				from	procedimento_paciente 
				where	nr_sequencia	= nr_seq_propaci_w;
			elsif (nr_seq_matpaci_w IS NOT NULL AND nr_seq_matpaci_w::text <> '') then 
				select	cd_material, 
					coalesce(cd_material_tiss, cd_material_convenio) 
				into STRICT	cd_procedimento_w, 
					cd_procedimento_convenio_w 
				from	material_atend_paciente 
				where	nr_sequencia	= nr_seq_matpaci_w;
			end if;
		end if;
 
 
		if (nr_seq_propaci_w IS NOT NULL AND nr_seq_propaci_w::text <> '') then 
 
			select	max(nr_interno_conta), 
				max(coalesce(cd_cgc_prestador_tiss, cd_cgc_prestador)), 
				max(nr_doc_convenio) 
			into STRICT	nr_interno_conta_w, 
				cd_cgc_prestador_w, 
				nr_doc_convenio_w 
			from	procedimento_paciente 
			where	nr_sequencia		= nr_seq_propaci_w 
			and	((ie_tiss_tipo_guia		= ie_tiss_tipo_guia_w) or (ie_tiss_tipo_guia_honor	= ie_tiss_tipo_guia_w) or (ie_tiss_tipo_guia_desp	= ie_tiss_tipo_guia_w)) 
			and	coalesce(cd_motivo_exc_conta::text, '') = '';
 
			if (coalesce(nr_seq_lote_audit_p,0) = 0) then 
				select	max(qt_glosa), 
					max(vl_glosa) 
				into STRICT	qt_glosa_w, 
					vl_glosa_w 
				from	motivo_glosa c, 
					convenio_retorno_item a, 
					convenio_retorno_glosa b, 
					procedimento_paciente d 
				where	b.cd_motivo_glosa		= c.cd_motivo_glosa 
				and	a.nr_sequencia		= b.nr_seq_ret_item 
				and	d.nr_sequencia		= b.nr_seq_propaci 
				and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) = 'R' 
				and	d.nr_sequencia		= nr_seq_propaci_w;
			else		 
				select	max(d.qt_item), 
					max(d.vl_amenor), 
					max(d.cd_resposta) 
				into STRICT	qt_glosa_w, 
					vl_glosa_w, 
					cd_resposta_w 
				from	lote_audit_hist b, 
					lote_audit_hist_guia c, 
					lote_audit_hist_item d 
				where	c.nr_seq_lote_hist		= b.nr_sequencia 
				and	d.nr_seq_guia			= c.nr_sequencia 
				and	b.nr_sequencia			= nr_seq_lote_audit_p 
				and	d.nr_seq_propaci		= nr_seq_propaci_w;
 
				if (coalesce(ds_observacao_w,'X') = 'X') and (cd_resposta_w IS NOT NULL AND cd_resposta_w::text <> '') then 
					select 	substr(ds_resposta,1,255) 
					into STRICT 	ds_resposta_w 
					from 	motivo_resp_glosa 
					where 	cd_resposta	= cd_resposta_w 
					and 	ie_situacao	= 'A';
 
					ds_observacao_w	:= ds_resposta_w;					
 
				end if;
			end if;
			 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_conta_proc_w 
			from	tiss_conta_proc 
			where	nr_interno_conta	= nr_interno_conta_w 
			and	ie_tiss_tipo_guia	= ie_tiss_tipo_guia_w 
			and	nr_seq_proc		= nr_seq_propaci_w;
			 
			if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then 
			 
				select	max(nr_seq_guia) 
				into STRICT	nr_seq_conta_guia_w 
				from	tiss_conta_proc 
				where	nr_sequencia	= nr_seq_conta_proc_w;
			 
			else			 
 
				SELECT * FROM tiss_obter_conta_proc(	nr_interno_conta_w, ie_tiss_tipo_guia_w, cd_cgc_prestador_w, nr_doc_convenio_w, cd_procedimento_w, cd_procedimento_convenio_w, cd_procedimento_tuss_w, nr_seq_conta_guia_w, nr_seq_conta_proc_w) INTO STRICT nr_seq_conta_guia_w, nr_seq_conta_proc_w;
			end if;
		 
			if (coalesce(nr_seq_conta_guia_w::text, '') = '') then 
				CALL TISS_GRAVAR_LOG_REAP(nr_seq_retorno_p, 
							null, 
							'Guia não localizada !'||chr(13)|| 
							'Conta: '||nr_interno_conta_w||chr(13)|| 
							'Tipo de Guia: '||substr(obter_valor_dominio(1746,ie_tiss_tipo_guia_w),1,255)||chr(13)|| 
							'Prestador: '||cd_cgc_prestador_w||chr(13)|| 
							'Doc Conv: '||nr_doc_convenio_w||chr(13)|| 
							'Procedimento: '||cd_procedimento_w||chr(13)|| 
							'Procedimento Conv: '||cd_procedimento_convenio_w||chr(13)|| 
							'Procedimento TUSS: '||cd_procedimento_tuss_w, 
							nm_usuario_p);
			end if;
 
		elsif (nr_seq_matpaci_w IS NOT NULL AND nr_seq_matpaci_w::text <> '') then 
 
			select	max(nr_interno_conta), 
				max(coalesce(cd_cgc_prestador_tiss, cd_cgc_prestador)), 
				max(nr_doc_convenio), 
				max(e.cd_material) 
			into STRICT	nr_interno_conta_w, 
				cd_cgc_prestador_w, 
				nr_doc_convenio_w, 
				cd_material_w 
			from	classe_material f, 
				material e, 
				material_atend_paciente a 
			where	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
			and	a.cd_material		= e.cd_material 
			and	e.cd_classe_material	= f.cd_classe_material 
			and	f.ie_tipo_classe		in ('O','P','M') 
			and	a.nr_sequencia		= nr_seq_matpaci_w 
			and	ie_tiss_tipo_guia_desp	= ie_tiss_tipo_guia_w;
 
			select	max(qt_glosa), 
				max(vl_glosa) 
			into STRICT	qt_glosa_w, 
				vl_glosa_w 
			from	motivo_glosa c, 
				convenio_retorno_item a, 
				convenio_retorno_glosa b, 
				material_atend_paciente d 
			where	b.cd_motivo_glosa	= c.cd_motivo_glosa 
			and	a.nr_sequencia		= b.nr_seq_ret_item 
			and	d.nr_sequencia		= b.nr_seq_matpaci 
			and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) = 'R' 
			and	d.nr_sequencia		= nr_seq_matpaci_w;
 
			SELECT * FROM tiss_obter_conta_opm(	nr_interno_conta_w, ie_tiss_tipo_guia_w, cd_cgc_prestador_w, nr_doc_convenio_w, cd_procedimento_w, cd_procedimento_convenio_w, nr_seq_conta_guia_w, nr_seq_conta_opm_w) INTO STRICT nr_seq_conta_guia_w, nr_seq_conta_opm_w;
 
			if (coalesce(nr_seq_conta_opm_w::text, '') = '') then 
 
				select	max(nr_interno_conta), 
					max(coalesce(cd_cgc_prestador_tiss, cd_cgc_prestador)), 
					max(nr_doc_convenio), 
					max(e.cd_material), 
					max(cd_material_tiss) 
				into STRICT	nr_interno_conta_w, 
					cd_cgc_prestador_w, 
					nr_doc_convenio_w, 
					cd_material_w, 
					cd_material_tiss_w 
				from	material e, 
					material_atend_paciente a 
				where	coalesce(a.cd_motivo_exc_conta::text, '') = '' 
				and	a.cd_material		= e.cd_material 
				and	a.nr_sequencia		= nr_seq_matpaci_w 
				and	ie_tiss_tipo_guia_desp	= ie_tiss_tipo_guia_w;
 
				select	max(qt_glosa), 
					max(vl_glosa) 
				into STRICT	qt_glosa_w, 
					vl_glosa_w 
				from	motivo_glosa c, 
					convenio_retorno_item a, 
					convenio_retorno_glosa b, 
					material_atend_paciente d 
				where	b.cd_motivo_glosa		= c.cd_motivo_glosa 
				and	a.nr_sequencia		= b.nr_seq_ret_item 
				and	d.nr_sequencia		= b.nr_seq_matpaci 
				and	coalesce(b.ie_acao_glosa,c.ie_acao_glosa) = 'R' 
				and	d.nr_sequencia		= nr_seq_matpaci_w;
 
				SELECT * FROM tiss_obter_conta_desp(	nr_interno_conta_w, ie_tiss_tipo_guia_w, cd_cgc_prestador_w, nr_doc_convenio_w, cd_material_w, cd_procedimento_convenio_w, cd_material_tiss_w, nr_seq_conta_guia_w, nr_seq_conta_desp_w) INTO STRICT nr_seq_conta_guia_w, nr_seq_conta_desp_w;
			end if;
			 
			if (coalesce(nr_seq_conta_guia_w::text, '') = '') then 
				CALL TISS_GRAVAR_LOG_REAP(nr_seq_retorno_p, 
							null, 
							'Guia não localizada !'||chr(13)|| 
							'Conta: '||nr_interno_conta_w||chr(13)|| 
							'Tipo de Guia: '||substr(obter_valor_dominio(1746,ie_tiss_tipo_guia_w),1,255)||chr(13)|| 
							'Prestador: '||cd_cgc_prestador_w||chr(13)|| 
							'Doc Conv: '||nr_doc_convenio_w||chr(13)|| 
							'Material: '||cd_material_w||chr(13)|| 
							'Material Conv: '||cd_procedimento_convenio_w||chr(13)|| 
							'Material TISS: '||cd_material_tiss_w, 
							nm_usuario_p);
			end if;
		end if;
 
		if (coalesce(somente_numero(cd_procedimento_convenio_w),0) <> 0) then 
			cd_procedimento_w	:= coalesce(somente_numero(cd_procedimento_convenio_w), cd_procedimento_w);
		end if;
 
		if (coalesce(nr_seq_conta_guia_w::text, '') = '') then 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_conta_guia_w 
			from	tiss_conta_guia b 
			where	b.nr_interno_conta	= nr_interno_conta_guia_w;
		end if;
 
		if (nr_seq_conta_guia_w IS NOT NULL AND nr_seq_conta_guia_w::text <> '') then 
 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_reap_conta_w 
			from	tiss_reap_conta 
			where	nr_interno_conta	= nr_interno_conta_w 
			and	nr_seq_lote		= nr_seq_reap_lote_w;
 
			if (coalesce(nr_seq_reap_conta_w,0) = 0) then 
 
				select	nextval('tiss_reap_conta_seq') 
				into STRICT	nr_seq_reap_conta_w 
				;
 
				select	max(a.ie_carater_internacao), 
					max(a.dt_entrada) /*lhalves OS349736 em 30/08/2011*/
 
				into STRICT	ie_carater_atend_w, 
					dt_atendimento_w 
				from	tiss_conta_atend a 
				where	a.nr_interno_conta	= nr_interno_conta_w;
 
				/*lhalves OS 223400 em 01/07/2010 - tratar codigo interno*/
 
				select	max(c.cd_interno), 
					max(c.cd_interno_compl), 
					max(b.cd_interno) 
				into STRICT	cd_interno_exec_w, 
					cd_interno_compl_w, 
					cd_interno_solic_w 
				from	tiss_conta_contrat_solic b, 
					tiss_conta_contrat_exec c, 
					conta_paciente f, 
					tiss_conta_guia a 
				where	a.nr_sequencia		= b.nr_seq_guia 
				and	a.nr_sequencia		= c.nr_seq_guia 
				and	f.nr_interno_conta	= a.nr_interno_conta 
				and	a.nr_sequencia		= nr_seq_conta_guia_w;				
			 
				if (cd_interno_solic_w IS NOT NULL AND cd_interno_solic_w::text <> '') then 
					select 	max(b.cd_cgc) 
					into STRICT 	cd_cgc_solic_w 
					from 	convenio_estabelecimento a, 
						estabelecimento b 
					where	a.cd_estabelecimento	= cd_estabelecimento_w 
					and 	a.cd_convenio		= cd_convenio_w 
					and 	a.cd_interno		= cd_interno_solic_w 
					and 	a.cd_estabelecimento 	= b.cd_estabelecimento;
				end if;
				 
				if (cd_interno_exec_w IS NOT NULL AND cd_interno_exec_w::text <> '') then 
					select 	max(b.cd_cgc) 
					into STRICT 	cd_cgc_exec_w 
					from 	convenio_estabelecimento a, 
						estabelecimento b 
					where	a.cd_estabelecimento	= cd_estabelecimento_w					 
					and 	a.cd_convenio		= cd_convenio_w 
					and 	a.cd_interno		= cd_interno_exec_w 
					and 	a.cd_estabelecimento 	= b.cd_estabelecimento;
				end if;
 
				if (cd_interno_compl_w IS NOT NULL AND cd_interno_compl_w::text <> '') then 
					select 	max(a.cd_pessoa_fisica) 
					into STRICT 	cd_pessoa_exec_w 
					from 	medico_convenio a 
					where	a.cd_estabelecimento	= cd_estabelecimento_w 
					and 	a.cd_convenio		= cd_convenio_w 
					and 	a.cd_medico_convenio	= cd_interno_compl_w;	
				end if;
 
				if (nr_seq_conta_guia_w IS NOT NULL AND nr_seq_conta_guia_w::text <> '') then --Feito este select separado para evitar problemas de duplicidade 
					select	max(a.dt_validade_carteira) 
					into STRICT	dt_validade_carteira_w 
					from	tiss_conta_atend a, 
						tiss_conta_guia b 
					where	a.nr_interno_conta	= b.nr_interno_conta 
					and	b.nr_sequencia		= nr_seq_conta_guia_w;
				end if;
 
				select	max(nr_atendimento) 
				into STRICT	nr_atendimento_w 
				from	conta_paciente 
				where	nr_interno_conta	= nr_interno_conta_w;
 
				select	max(a.cd_plano_convenio) 
				into STRICT	cd_plano_convenio_w 
				from	Atend_categoria_convenio a 
				where	a.nr_atendimento	= nr_atendimento_w 
				and	a.cd_convenio		= cd_convenio_w 
				and	a.dt_inicio_vigencia	= 
						(SELECT max(b.dt_inicio_vigencia) 
						from  Atend_categoria_convenio b 
						where  b.nr_atendimento	= nr_atendimento_w 
						and	b.cd_convenio		= cd_convenio_w);
 
				-- dsantos em 30/11/2009 -> tirei tiss_conta_atend do select abaixo por estar duplicando as contas 
				insert into tiss_reap_conta(nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					nr_seq_lote, 
					nr_interno_conta, 
					cd_autorizacao, 
					dt_emissao_guia, 
					nr_guia_prestador, 
					nr_guia_principal, 
					dt_autorizacao, 
					cd_senha_autor, 
					dt_validade_senha, 
					cd_interno_solic, 
					cd_cgc_solic, 
					cd_pessoa_solic, 
					cd_pessoa_solic_compl, 
					cd_interno_exec, 
					cd_cgc_exec, 
					cd_pessoa_exec, 
					cd_pessoa_exec_compl, 
					ds_indicacao_clinica, 
					ie_carater_atend, 
					dt_atendimento, 
					nr_seq_tipo_saida_spsadt, 
					ie_tipo_atend_tiss, 
					VL_DIARIA, 
					VL_GASES, 
					VL_MATERIAL, 
					VL_MEDICAMENTO, 
					VL_PROCEDIMENTO, 
					VL_TAXA, 
					VL_TOTAL, 
					VL_TOTAL_HONORARIO, 
					ds_observacao, 
					nr_seq_tiss_conta, 
					ie_tiss_tipo_guia, 
					ie_status_conta, 
					cd_usuario_convenio, 
					ie_grau_partic_tiss, 
					cd_plano, 
					cd_convenio, 
					dt_validade_carteira) 
				SELECT	nr_seq_reap_conta_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_reap_lote_w, 
					a.nr_interno_conta, 
					a.cd_autorizacao, 
					a.dt_emissao_guia, 
					a.nr_guia_prestador, 
					a.cd_autorizacao_princ, 
					a.dt_autorizacao, 
					a.cd_senha, 
					a.dt_validade_senha, 
					cd_interno_solic_w, 
					coalesce(b.cd_cgc, cd_cgc_solic_w) cd_cgc_solic, 
					CASE WHEN coalesce(b.cd_cgc,'X')='X' THEN  b.cd_pessoa_fisica  ELSE null END  cd_pessoa_solic, 
					b.cd_pessoa_fisica, 
					cd_interno_exec_w, 
					coalesce(c.cd_cgc, cd_cgc_exec_w) cd_cgc_exec, 
					CASE WHEN coalesce(coalesce(c.cd_cgc,cd_cgc_exec_w), 'X')='X' THEN  coalesce(c.cd_pessoa_fisica,cd_pessoa_exec_w)  ELSE null END  cd_pessoa_exec, 
					c.cd_pessoa_fisica, 
					a.ds_indicacao, 
					ie_carater_atend_w, 
--					to_date(obter_dados_atendimento(f.nr_atendimento, 'DET')), 
					dt_atendimento_w, 
					CASE WHEN a.ie_tiss_tipo_guia='4' THEN f.nr_seq_saida_spsadt  ELSE null END , 
					a.ie_tipo_atend_tiss, 
					0, 
					0, 
					0, 
					0, 
					0, 
					0, 
					0, 
					0, 
					a.ds_observacao, 
					a.nr_sequencia, 
					a.ie_tiss_tipo_guia, 
					'1', 
					obter_codigo_usuario_conv(f.nr_atendimento), 
					c.ie_funcao_medico_compl, 
					cd_plano_convenio_w, 
					cd_convenio_w, 
					dt_validade_carteira_w 
				from	tiss_conta_contrat_solic b, 
					tiss_conta_contrat_exec c, 
					conta_paciente f, 
					tiss_conta_guia a 
				where	a.nr_sequencia		= b.nr_seq_guia 
				and	a.nr_sequencia		= c.nr_seq_guia 
				and	f.nr_interno_conta	= a.nr_interno_conta 
				and	a.nr_sequencia		= nr_seq_conta_guia_w;
			 
				insert into tiss_reap_diag(nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_conta, 
					cd_doenca, 
					ds_diagnostico, 
					ie_tipo_doenca, 
					ie_unidade_tempo, 
					qt_tempo) 
				SELECT	nextval('tiss_reap_diag_seq'), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_reap_conta_w, 
					replace(cd_cid,'.',''), 
					null, 
					ie_tipo_cid, 
					ie_unidade_tempo_cid, 
					qt_tempo_cid 
				from	tiss_conta_guia	 
				where	nr_sequencia	= nr_seq_conta_guia_w 
				and	(cd_cid IS NOT NULL AND cd_cid::text <> '');
 
			end if;
 
			insert into tiss_reap_proc(nr_sequencia, 
				dt_procedimento, 
				dt_inicio_proc, 
				dt_fim_proc, 
				ie_via_acesso, 
				ie_tecnica_utilizada, 
				tx_reducao_acresc, 
				vl_unitario, 
				cd_procedimento, 
				ie_origem_proced, 
				nr_seq_conta, 
				nr_seq_procedimento, 
				vl_procedimento, 
				qt_procedimento, 
				nm_usuario, 
				dt_atualizacao, 
				ds_justificativa_revisao, 
				cd_proc_convenio, 
				nr_seq_tiss_tabela, 
				cd_procedimento_tuss, 
				cd_proc_envio, 
				ds_proc_envio) 
			SELECT	nextval('tiss_reap_proc_seq'), 
				coalesce(to_date(obter_dados_propaci('DPF',nr_seq_propaci_w),'dd/mm/yyyy hh24:mi:ss'),a.dt_procedimento), 
				coalesce(to_date(obter_dados_propaci('DPF',nr_seq_propaci_w),'dd/mm/yyyy hh24:mi:ss'),a.dt_inicio), 
				coalesce(to_date(obter_dados_propaci('DPF',nr_seq_propaci_w),'dd/mm/yyyy hh24:mi:ss'),a.dt_fim), 
				a.ie_via_acesso, 
				a.tecnica_utilizada, 
				a.vl_reducao_acrescimo, 
				a.vl_unitario, 
				a.cd_procedimento, 
				a.ie_origem_proced, 
				nr_seq_reap_conta_w, 
				nr_seq_propaci_w, 
				--vl_glosa_w, 
				vl_glosa_ret_w, 
				qt_glosa_w, 
				nm_usuario_p, 
				clock_timestamp(), 
				ds_observacao_w, 
				a.cd_proc_convenio, 
				a.nr_seq_tiss_tabela, 
				a.cd_procedimento_tuss, 
				a.cd_proc_envio, 
				a.ds_proc_envio 
			from	( 
				SELECT	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	somente_numero(a.cd_procedimento)	= b.cd_procedimento 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= to_char(b.cd_procedimento_convenio) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= to_char(b.cd_procedimento_tuss) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_convenio,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_tuss,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	somente_numero(a.cd_procedimento)	= b.cd_procedimento 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia_honor 
				and	coalesce(b.nr_doc_honor_conv,coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador or 
					 a.cd_cgc_prestador		= b.cd_cgc_honorario_tiss) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= to_char(b.cd_procedimento_convenio) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia_honor 
				and	coalesce(b.nr_doc_honor_conv,coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or				 
					 a.cd_cgc_prestador		= b.cd_cgc_honorario_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= to_char(b.cd_procedimento_tuss) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia_honor 
				and	coalesce(b.nr_doc_honor_conv,coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_honorario_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_convenio,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia_honor 
				and	coalesce(b.nr_doc_honor_conv,coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_honorario_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_procedimento dt_procedimento, 
					a.dt_inicio_cir dt_inicio, 
					a.dt_fim_cir dt_fim, 
					a.ie_via_acesso ie_via_acesso, 
					a.ie_tecnica_utilizada tecnica_utilizada, 
					a.vl_reducao_acrescimo vl_reducao_acrescimo, 
					a.vl_unitario vl_unitario, 
					b.cd_procedimento cd_procedimento, 
					b.ie_origem_proced ie_origem_proced, 
					b.cd_procedimento_convenio cd_proc_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_proc a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_tuss,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia_honor 
				and	coalesce(b.nr_doc_honor_conv,coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= b.cd_cgc_prestador_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_honorario_tiss or 
					 a.cd_cgc_prestador		= b.cd_cgc_prestador) or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	b.nr_sequencia			= nr_seq_propaci_w 
				and	a.ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w 
				
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	somente_numero(a.cd_procedimento)	= b.cd_procedimento 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= b.cd_procedimento_convenio 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	to_char(somente_numero(a.cd_procedimento)) = to_char(somente_numero(b.cd_procedimento_convenio)) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss,					 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	to_char(somente_numero(a.cd_procedimento))	= b.cd_procedimento_tuss 
				and	a.nr_interno_conta		= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia		= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	somente_numero(a.cd_procedimento)	= lpad(b.cd_procedimento,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_convenio,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_tuss,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,		coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador		= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia			= nr_seq_propaci_W 
				and	a.nr_sequencia			= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')	= 'S') a;
				 
			/*lhalves OS398566 em 24/01/2012 - gerar as taxas como despesa se param ie_gerar_desp_proc_w = 'N'*/
			 
			insert into tiss_reap_desp(nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				nr_seq_conta, 
				cd_material, 
				cd_procedimento, 
				ie_origem_proced, 
				cd_mat_convenio, 
				cd_proc_convenio, 
				dt_despesa, 
				ie_tipo_despesa, 
				qt_despesa, 
				tx_reducao_acresc, 
				vl_despesa, 
				vl_unitario, 
				ds_justificativa_revisao, 
				nr_seq_tiss_tabela, 
				nr_seq_material, 
				nr_seq_procedimento, 
				cd_proc_envio, 
				ds_proc_envio) 
			SELECT	nextval('tiss_reap_desp_seq'), 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_reap_conta_w, 
				null, 
				a.cd_procedimento, 
				a.ie_origem_proced, 
				null, 
				a.cd_procedimento_convenio, 
				coalesce(to_date(obter_dados_propaci('DPF',nr_seq_propaci_w),'dd/mm/yyyy hh24:mi:ss'),a.dt_item),				 
				a.ie_tipo_despesa, 
				qt_glosa_w, 
				a.vl_reducao_acrescimo, 
				vl_glosa_ret_w, 
				a.vl_unitario, 
				ds_observacao_w, 
				a.nr_seq_tiss_tabela, 
				null, 
				a.nr_sequencia, 
				cd_proc_envio, 
				ds_proc_envio				 
			from	( 
				SELECT	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa,					 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	somente_numero(a.cd_procedimento)	= b.cd_procedimento 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= b.cd_procedimento_convenio 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	to_char(somente_numero(a.cd_procedimento)) = to_char(somente_numero(b.cd_procedimento_convenio)) 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= b.cd_procedimento_tuss 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	somente_numero(a.cd_procedimento)	= lpad(b.cd_procedimento,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_convenio,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' 	or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N' 
				 
union
 
				select	a.dt_item, 
					dt_hora_item, 
					dt_final, 
					'', 
					'', 
					a.vl_reducao_acrescimo, 
					a.vl_unitario, 
					b.cd_procedimento, 
					b.ie_origem_proced, 
					b.cd_procedimento_convenio, 
					coalesce(b.nr_seq_tiss_tabela,20) nr_seq_tiss_tabela, 
					b.cd_procedimento_tuss, 
					b.nr_sequencia, 
					a.ie_tipo_despesa, 
					a.cd_procedimento cd_proc_envio, 
					a.ds_procedimento ds_proc_envio 
				from	procedimento_paciente b, 
					tiss_conta_desp a 
				where	a.cd_procedimento			= lpad(b.cd_procedimento_tuss,8,'0') 
				and	a.nr_interno_conta			= b.nr_interno_conta 
				and	a.ie_tiss_tipo_guia			= b.ie_tiss_tipo_guia 
				and	coalesce(b.nr_doc_convenio,			coalesce(a.cd_autorizacao, 'X')) = coalesce(a.cd_autorizacao, 'X') 
				and	((a.cd_cgc_prestador			= coalesce(b.cd_cgc_prestador_tiss, b.cd_cgc_prestador)) 
					 or (coalesce(a.cd_cgc_prestador::text, '') = '' 	or coalesce(b.cd_cgc_prestador::text, '') = '')) 
				and	b.nr_sequencia				= nr_seq_propaci_W 
				and	a.nr_sequencia				= nr_seq_conta_proc_w 
				and	a.ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w 
				and	coalesce(ie_gerar_desp_proc_w,'S')		= 'N') a;				
 
			if (nr_seq_conta_opm_w IS NOT NULL AND nr_seq_conta_opm_w::text <> '') then 
	 
				nr_seq_conta_desp_w	:= null;
				 
				if (nr_seq_matpaci_w IS NOT NULL AND nr_seq_matpaci_w::text <> '') then 
					insert into tiss_reap_opm(nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_conta, 
						nr_seq_material, 
						vl_unitario, 
						qt_opm, 
						cd_material, 
						vl_opm, 
						nr_seq_tiss_tabela, 
						ds_opm, 
						cd_barras, 
						ds_justificativa_revisao) 
					SELECT	nextval('tiss_reap_opm_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_reap_conta_w, 
						nr_seq_matpaci_w, 
						b.vl_unitario_opm, 
						b.qt_opm, 
						a.cd_material, 
						vl_glosa_ret_w, 
						TISS_OBTER_TABELA_EDICAO(b.cd_tabela), 
						b.ds_opm, 
						b.cd_barras, 
						ds_observacao_w 
					from	material_atend_paciente a, 
						tiss_conta_opm_exec b 
					where	a.nr_interno_conta		= b.nr_interno_conta 
					and	a.nr_sequencia			= nr_seq_matpaci_w 
					and	b.nr_sequencia			= coalesce(nr_seq_conta_opm_w,-1) 
					and	b.ie_tiss_tipo_guia_desp	= ie_tiss_tipo_guia_w;					
				 
				else 
					insert into tiss_reap_opm(nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_conta, 
						nr_seq_material, 
						vl_unitario, 
						qt_opm, 
						cd_material, 
						vl_opm, 
						nr_seq_tiss_tabela, 
						ds_opm, 
						cd_barras, 
						ds_justificativa_revisao) 
					SELECT	nextval('tiss_reap_opm_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_reap_conta_w, 
						nr_seq_matpaci_w, 
						vl_unitario_opm, 
						qt_opm, 
						cd_opm, 
						vl_glosa_ret_w, 
						TISS_OBTER_TABELA_EDICAO(cd_tabela), 
						ds_opm, 
						cd_barras, 
						ds_observacao_w 
					from	tiss_conta_opm_exec 
					where	nr_sequencia			= coalesce(nr_seq_conta_opm_w,-1) 
					and	ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w;
				end if;
			end if;
 
			if (nr_seq_conta_desp_w IS NOT NULL AND nr_seq_conta_desp_w::text <> '') then 
 
				qt_material_w	:= null;
				if (coalesce(nr_seq_matpaci_w, 0) > 0) then 
					/*select	max(qt_material) 
					into	qt_material_w 
					from	material_atend_paciente 
					where 	nr_sequencia	= nr_seq_matpaci_w; 
					lhalves OS435526 em 30/04/2012 - Considerar a conversão de quantidade aplicada para o item na conta*/
 
					select	dividir(a.qt_material,CASE WHEN coalesce(b.tx_conversao_qtde,0)=0 THEN 1  ELSE b.tx_conversao_qtde END ) 
					into STRICT	qt_material_w 
					FROM material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio b ON (a.nr_sequencia = b.nr_seq_material)
WHERE a.nr_sequencia	= nr_seq_matpaci_w;
				end if;
 
				insert into tiss_reap_desp(nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					nr_seq_conta, 
					cd_material, 
					cd_procedimento, 
					cd_mat_convenio, 
					cd_proc_convenio, 
					dt_despesa, 
					ie_tipo_despesa, 
					qt_despesa, 
					tx_reducao_acresc, 
					vl_despesa, 
					vl_unitario, 
					ds_justificativa_revisao, 
					nr_seq_tiss_tabela, 
					nr_seq_material, 
					cd_proc_envio, 
					ds_proc_envio) 
				SELECT	nextval('tiss_reap_desp_seq'), 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_reap_conta_w, 
					CASE WHEN tiss_obter_se_desp_proc(ie_tipo_despesa)='S' THEN  null  ELSE cd_material_w END , 
					CASE WHEN tiss_obter_se_desp_proc(ie_tipo_despesa)='N' THEN  null  ELSE cd_material_w END , 
					CASE WHEN tiss_obter_se_desp_proc(ie_tipo_despesa)='S' THEN  null  ELSE cd_procedimento_w END , 
					CASE WHEN tiss_obter_se_desp_proc(ie_tipo_despesa)='N' THEN  null  ELSE cd_procedimento_w END , 
					coalesce(obter_data_matpaci(nr_seq_matpaci_w,'D'),dt_item), 
					ie_tipo_despesa, 
					coalesce(qt_material_w, qt_item), 
					vl_reducao_acrescimo, 
					vl_glosa_ret_w, 
					Dividir_sem_round(vl_glosa_ret_w,coalesce(qt_material_w, qt_item)), --lhalves OS243082. 
					ds_observacao_w, 
					TISS_OBTER_TABELA_EDICAO(cd_edicao_amb), 
					nr_seq_matpaci_w, 
					cd_procedimento cd_proc_envio, 
					ds_procedimento ds_proc_envio 
				from	tiss_conta_desp 
				where	nr_sequencia			= coalesce(nr_seq_conta_desp_w,-1) 
				and	ie_tiss_tipo_guia_desp		= ie_tiss_tipo_guia_w;
			end if;
			 
			select	max(a.nr_interno_conta) 
			into STRICT	nr_interno_conta_excl_w 
			from	tiss_reap_conta a 
			where	a.nr_sequencia	= nr_seq_reap_conta_w 
			and	not exists (SELECT	1 
						from	tiss_reap_proc b 
						where	b.nr_seq_conta	= a.nr_sequencia) 
			and	not exists (select	1 
						from	tiss_reap_desp c 
						where	c.nr_seq_conta	= a.nr_sequencia) 
			and	not exists (select	1 
						from	tiss_reap_opm d 
						where	d.nr_seq_conta	= a.nr_sequencia);
						 
			if (nr_interno_conta_excl_w IS NOT NULL AND nr_interno_conta_excl_w::text <> '') then 
			 
				delete	from tiss_reap_conta a 
				where	a.nr_sequencia	= nr_seq_reap_conta_w 
				and	not exists (SELECT	1 
							from	tiss_reap_proc b 
							where	b.nr_seq_conta	= a.nr_sequencia) 
				and	not exists (select	1 
							from	tiss_reap_desp c 
							where	c.nr_seq_conta	= a.nr_sequencia) 
				and	not exists (select	1 
							from	tiss_reap_opm d 
							where	d.nr_seq_conta	= a.nr_sequencia);
			 
				CALL TISS_GRAVAR_LOG_REAP(nr_seq_retorno_p, 
							null, 
							'Conta excluida pois foi gerada sem itens. Conta: '||nr_interno_conta_excl_w, 
							nm_usuario_p);
			 
			 
			 
			end if;			
 
		end if;
 
	end loop;
	close c01;
	 
	CALL TISS_ATUALIZAR_LOTE_REAP(nr_seq_reap_lote_w,nm_usuario_p);
 
end loop;
close c02;
 
if (qt_guia_protocolo_w = 0) then 
	CALL TISS_GRAVAR_LOG_REAP(nr_seq_retorno_p,null,'Guias não localizadas no protocolo!',nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_lote_reapresentacao ( nr_seq_retorno_p bigint, nr_seq_lote_audit_p bigint, nm_usuario_p text) FROM PUBLIC;

