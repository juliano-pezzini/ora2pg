-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_item_glosado ( nr_sequencia_p bigint, vl_glosado_p bigint, qt_glosada_p bigint, ie_opcao_p bigint, nm_usuario_p text, nr_seq_conpaci_ret_hist_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
vl_glosa_W		double precision;
vl_glosado_W		double precision;
qt_glosada_w		double precision;
qt_cobrada_w		double precision;
vl_cobrado_w		double precision;
vl_cobrado_ww		double precision;
vl_glosa_ww		double precision;
qt_cobrada_ww		double precision;
nr_seq_ret_item_w	bigint;


BEGIN

if (ie_opcao_p = 1) then

	if (vl_glosado_p >= 0) then		-- Edgar 11/05/2009, OS 129084, alterei de > para >= permitir decompor valor total
		vl_glosado_w	:= vl_glosado_p;
	else
		--r.aise_application_error(-20011,'O valor informado é menor que zero. Impossível desdobrar!');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263300);
	end if;

	select	coalesce(a.vl_glosa,0),
		a.nr_seq_ret_item
	into STRICT	vl_glosa_w,
		nr_seq_ret_item_w
	from	convenio_retorno_glosa a
	where	a.nr_sequencia		= nr_sequencia_p;

	if (vl_glosa_w >= vl_glosado_w) then /*-Edgar 11/05/2009, OS 129084, alterei de > para >= permitir decompor valor total */
		vl_glosa_w	:= vl_glosa_w - vl_glosado_w;

		select	nextval('convenio_retorno_glosa_seq')
		into STRICT	nr_sequencia_w
		;

		insert into convenio_retorno_glosa(nr_sequencia,
			nr_seq_ret_item,
			vl_glosa,
			dt_atualizacao,
			nm_usuario,
			ie_atualizacao,
			qt_glosa,
			cd_material,
			cd_procedimento,
			ie_origem_proced,
			cd_setor_atendimento,
			cd_motivo_glosa,
			cd_item_convenio,
			cd_resposta,
			nr_seq_conpaci_ret_hist,
			ds_observacao)
		SELECT	nr_sequencia_w,
			nr_seq_ret_item,
			vl_glosado_w,
			clock_timestamp(),
			nm_usuario_p,
			ie_atualizacao,
			qt_glosa,
			cd_material,
			cd_procedimento,
			ie_origem_proced,
			cd_setor_atendimento,
			cd_motivo_glosa,
			cd_item_convenio,
			cd_resposta,
			coalesce(nr_seq_conpaci_ret_hist_p,nr_seq_conpaci_ret_hist),
			ds_observacao
		from	convenio_retorno_glosa
		where	nr_sequencia	= nr_sequencia_p;

		update	convenio_retorno_glosa
		set 	vl_glosa	= vl_glosa_w
		where	nr_sequencia	= nr_sequencia_p;

	end if;

elsif (ie_opcao_p = 2) then
	if (qt_glosada_p >= 0) then		/*-Edgar 11/05/2009, OS 129084, alterei de > para >= permitir decompor valor total */
		qt_glosada_w	:= qt_glosada_p;
	else
		--r.aise_application_error(-20011,'A quantidade informada é menor que zero. Impossível desdobrar!');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263301);
	end if;

	select	a.vl_glosa,
		(dividir_sem_round(a.vl_glosa, a.qt_cobrada) * qt_glosada_w),
		(dividir_sem_round(a.vl_cobrado, a.qt_cobrada) * qt_glosada_w),
		(a.qt_cobrada - qt_glosada_w),
		a.qt_cobrada,
		a.vl_cobrado,
		a.nr_seq_ret_item
	into STRICT	vl_glosa_ww,
		vl_glosa_w,
		vl_cobrado_w,
		qt_cobrada_w,
		qt_cobrada_ww,
		vl_cobrado_ww,
		nr_seq_ret_item_w
	from	convenio_retorno_glosa a
	where	a.nr_sequencia		= nr_sequencia_p;

	if (qt_cobrada_ww > 1) and (qt_cobrada_wW >= qt_glosada_w) then /*-Edgar 11/05/2009, OS 129084, alterei de > para >= permitir decompor valor total */
		select	nextval('convenio_retorno_glosa_seq')
		into STRICT		nr_sequencia_w
		;

		insert into convenio_retorno_glosa(nr_sequencia,
			nr_seq_ret_item,
			vl_glosa,
			dt_atualizacao,
			nm_usuario,
			ie_atualizacao,
			qt_glosa,
			cd_material,
			cd_procedimento,
			ie_origem_proced,
			cd_setor_atendimento,
			cd_motivo_glosa,
			cd_item_convenio,
			cd_resposta,
			nr_seq_conpaci_ret_hist,
			ds_observacao,
			qt_cobrada,
			vl_cobrado)
		SELECT	nr_sequencia_w,
			nr_seq_ret_item,
			vl_glosa_w,
			clock_timestamp(),
			nm_usuario_p,
			ie_atualizacao,
			qt_glosa,
			cd_material,
			cd_procedimento,
			ie_origem_proced,
			cd_setor_atendimento,
			cd_motivo_glosa,
			cd_item_convenio,
			cd_resposta,
			nr_seq_conpaci_ret_hist,
			ds_observacao,
			qt_glosada_w,
			vl_cobrado_w
		from	convenio_retorno_glosa
		where	nr_sequencia	= nr_sequencia_p;

		update	convenio_retorno_glosa
		set 	vl_glosa	= vl_glosa_ww - vl_glosa_w,
			qt_cobrada	= qt_cobrada_w,
			vl_cobrado	= vl_cobrado_ww - vl_cobrado_w
		where	nr_sequencia	= nr_sequencia_p;

	end if;

end if;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_item_glosado ( nr_sequencia_p bigint, vl_glosado_p bigint, qt_glosada_p bigint, ie_opcao_p bigint, nm_usuario_p text, nr_seq_conpaci_ret_hist_p bigint) FROM PUBLIC;

