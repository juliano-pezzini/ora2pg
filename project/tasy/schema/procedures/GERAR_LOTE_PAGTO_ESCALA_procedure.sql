-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_pagto_escala ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_inicio_w		timestamp;
dt_fim_w		timestamp;
dt_referencia_lote_w	timestamp;
nr_seq_controle_med_w	bigint;
cd_medico_w		bigint;
ie_existe_med_resumo_w	varchar(1);
qt_hora_w		double precision;
vl_total_medico_w	double precision;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_medico,
		qt_hora,
		vl_total_medico
	from	escala_resumo_medico
	where	trunc(dt_entrada) between trunc(dt_inicio_w) and trunc(dt_fim_w)
	and	coalesce(nr_seq_lote::text, '') = ''
	order by 1;


BEGIN

select	dt_inicio,
	dt_fim,
	dt_referencia_lote
into STRICT	dt_inicio_w,
	dt_fim_w,
	dt_referencia_lote_w
from	escala_lote_pagamento
where	nr_sequencia = nr_seq_lote_p;

open c01;
loop
fetch c01 into
	nr_seq_controle_med_w,
	cd_medico_w,
	qt_hora_w,
	vl_total_medico_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	update	escala_resumo_medico
	set	nr_seq_lote = nr_seq_lote_p
	where	nr_sequencia = nr_seq_controle_med_w;

	begin
	select	'S'
	into STRICT	ie_existe_med_resumo_w
	
	where	exists (SELECT	1
			from	escala_lote_pagto_medico
			where	nr_seq_lote = nr_seq_lote_p
			and	cd_medico = cd_medico_w);
	exception
	when others then
		ie_existe_med_resumo_w := 'N';
	end;

	if (coalesce(ie_existe_med_resumo_w,'N') = 'N') then

		insert into escala_lote_pagto_medico(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
			nm_usuario, nm_usuario_nrec, cd_medico,
			nr_seq_lote, qt_horas, vl_total_medico)
		values (nextval('escala_lote_pagto_medico_seq'), clock_timestamp(), clock_timestamp(),
			nm_usuario_p, nm_usuario_p, cd_medico_w,
			nr_seq_lote_p, qt_hora_w, vl_total_medico_w);

	else
		update	escala_lote_pagto_medico
		set	dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			qt_horas	= qt_horas + qt_hora_w,
			vl_total_medico = vl_total_medico + vl_total_medico_w
		where	cd_medico	= cd_medico_w
		and	nr_seq_lote	= nr_seq_lote_p;

	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_pagto_escala ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

