-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_ndg (nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w		bigint;
qt_reg_w			bigint;
ie_lado_sec_w			diagnostico_doenca.ie_lado%type;
cd_cid_sec_w			d301_segmento_ndg.cd_cid_lateral_2%type;
nr_seq_301_local_1_w		d301_segmento_ndg.nr_seq_301_local_1%type;
nr_seq_301_local_2_w		d301_segmento_ndg.nr_seq_301_local_2%type;

c01 CURSOR FOR
SELECT	d.cd_doenca,
	d.ie_lado
from	atendimento_paciente a,
	medic_diagnostico_doenca b,
	classificacao_diagnostico c,
	diagnostico_doenca d
where	b.nr_seq_classificacao 		= c.nr_sequencia
and	b.nr_atendimento		= a.nr_atendimento
and	d.nr_atendimento		= a.nr_atendimento
and	b.cd_doenca			= d.cd_doenca
and	b.ie_situacao			= 'A'
and	'S'				= OBTER_SE_CLASSIF_DIAG_301(c.nr_sequencia,'NEB',d.DT_DIAGNOSTICO)
and	coalesce(d.cd_doenca_superior::text, '') = ''
and	coalesce(d.dt_inativacao::text, '') = ''
and	(d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
and	a.nr_atendimento 		= nr_atendimento_w;

c01_w	c01%rowtype;


BEGIN

select	nr_atendimento
into STRICT	nr_atendimento_w
from	d301_dataset_envio
where	nr_sequencia = nr_seq_dataset_p;

qt_reg_w := 0;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (qt_reg_w < 40) then

		select	max(a.ie_lado),
			max(a.cd_doenca)
		into STRICT	ie_lado_sec_w,
			cd_cid_sec_w
		from	diagnostico_doenca a,
			medic_diagnostico_doenca b,
			classificacao_diagnostico c
		where	b.nr_seq_classificacao 		= c.nr_sequencia
		and	b.nr_atendimento		= a.nr_atendimento
		and	b.cd_doenca			= a.cd_doenca
		and	coalesce(a.dt_inativacao::text, '') = ''
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	b.ie_situacao			= 'A'
		and	'S'				= OBTER_SE_CLASSIF_DIAG_301(c.nr_sequencia,'NEB',a.DT_DIAGNOSTICO)
		and	a.cd_doenca_superior 		= c01_w.cd_doenca
		and	a.nr_atendimento		= nr_atendimento_w;

		select	max(OBTER_SEQ_VALOR_301('C301_16_LOCALIZACAO','IE_LOCALIZACAO',obter_conversao_301('C301_16_LOCALIZACAO',null,1372,c01_w.ie_lado,'I'))),
			max(OBTER_SEQ_VALOR_301('C301_16_LOCALIZACAO','IE_LOCALIZACAO',obter_conversao_301('C301_16_LOCALIZACAO',null,1372,ie_lado_sec_w,'I')))
		into STRICT	nr_seq_301_local_1_w,
			nr_seq_301_local_2_w
		;

		insert into D301_SEGMENTO_NDG(NR_SEQUENCIA,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			NR_SEQ_DATASET,
			NR_SEQ_301_LOCAL_2,
			CD_CID_LATERAL_1,
			NR_SEQ_301_LOCAL_1,
			CD_CID_LATERAL_2)
		values (nextval('d301_segmento_ndg_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_dataset_p,
			nr_seq_301_local_2_w,
			c01_w.cd_doenca,
			nr_seq_301_local_1_w,
			cd_cid_sec_w);

	end if;

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_ndg (nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

