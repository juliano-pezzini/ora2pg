-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_horario_bolsa_hm ( nr_prescricao_p bigint, nr_seq_procedimento_p bigint, dt_horario_p timestamp, qt_volume_p bigint, nm_usuario_p text, nr_seq_horario_p INOUT bigint) AS $body$
DECLARE


nr_seq_horario_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_etapa_w			bigint;
ie_proc_urgente_w		varchar(1);
cd_material_exame_w		varchar(20);
nr_ocorrencia_w			double precision;


BEGIN

if (coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_seq_procedimento_p,0) > 0) and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then

        select	coalesce(max(nr_etapa),0)
	into STRICT	nr_etapa_w
	from	prescr_proc_hor
	where	nr_prescricao = nr_prescricao_p
	and	nr_seq_procedimento = nr_seq_procedimento_p;

        select	max(cd_procedimento),
		max(ie_origem_proced),
		max(nr_seq_proc_interno),
		coalesce(max(nr_ocorrencia),0),
		coalesce(max(ie_urgencia),'N'),
		max(cd_material_exame)
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		nr_ocorrencia_w,
		ie_proc_urgente_w,
		cd_material_exame_w
	from	prescr_procedimento
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_seq_procedimento_p;

        select	nextval('prescr_proc_hor_seq')
	into STRICT	nr_seq_horario_w
	;

	nr_etapa_w := (nr_etapa_w+1);

        insert into prescr_proc_hor(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_procedimento,
			cd_procedimento,
			ie_origem_proced,
			nr_seq_proc_interno,
			ds_horario,
			dt_horario,
			nr_ocorrencia,
			ie_urgente,
			ie_horario_especial,
			cd_material_exame,
			ie_aprazado,
			dt_lib_horario,
			nr_etapa,
			qt_vol_hemocomp)
		values (
			nr_seq_horario_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_procedimento_p,
			cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_proc_interno_w,
			null,
			dt_horario_p,
			nr_ocorrencia_w,
			ie_proc_urgente_w,
			'N',
			cd_material_exame_w,
			'S',
			clock_timestamp(),
			nr_etapa_w,
			qt_volume_p);

	commit;

end if;

nr_seq_horario_p := nr_seq_horario_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_horario_bolsa_hm ( nr_prescricao_p bigint, nr_seq_procedimento_p bigint, dt_horario_p timestamp, qt_volume_p bigint, nm_usuario_p text, nr_seq_horario_p INOUT bigint) FROM PUBLIC;

