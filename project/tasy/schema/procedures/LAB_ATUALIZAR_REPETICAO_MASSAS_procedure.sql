-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualizar_repeticao_massas (nr_seq_result_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE




nr_seq_ficha_lote_w 	lote_ent_sec_ficha.nr_sequencia%type;
nr_seq_material_w		material_exame_lab.nr_sequencia%type;
nr_repeticao_w			lote_ent_res_ant_repet.nr_repeticao%type;

C01 CURSOR FOR
	SELECT 	distinct
			a.cd_material_exame,
			c.nr_seq_exame,
			c.qt_resultado,
			c.ds_resultado,
			c.pr_resultado,
			c.nr_seq_metodo
	from 	prescr_procedimento a,
			exame_lab_resultado b,
			exame_lab_result_item c
	where 	b.nr_seq_resultado = c.nr_seq_resultado
	and   	a.nr_prescricao = b.nr_prescricao
	and   	a.nr_sequencia = c.nr_seq_prescr
	and  	((qt_resultado <> 0) or (pr_resultado <> 0) or (ds_resultado IS NOT NULL AND ds_resultado::text <> ''))
	and 	(obter_equipamento_exame(a.nr_seq_exame,null,'PERKINMASS') IS NOT NULL AND (obter_equipamento_exame(a.nr_seq_exame,null,'PERKINMASS'))::text <> '')
	and 	c.nr_seq_exame not in (SELECT distinct t.nr_seq_exame
								   from lote_ent_res_ant_repet t
								   where t.nr_prescricao = b.nr_prescricao
								   and t.nr_seq_prescr = c.nr_seq_prescr
								   and t.nr_seq_exame = c.nr_seq_exame
								   --and t.nr_repeticao = (select MAX(x.nr_repeticao) from lote_ent_res_ant_repet x where x.nr_prescricao = t.nr_prescricao and x.nr_seq_prescr = t.nr_seq_prescr and x.nr_seq_exame = t.nr_seq_exame)
								   and t.nr_repeticao = nr_repeticao_w
								   and    ((qt_result_ant <> 0) or (pr_result_ant <> 0) or (ds_result_ant IS NOT NULL AND ds_result_ant::text <> ''))
								   )
	and   	b.nr_prescricao = nr_prescricao_p
	and   	a.nr_sequencia = nr_seq_prescr_p
	and		b.nr_seq_resultado = nr_seq_result_p;

c01_w	c01%rowtype;


BEGIN

select 	MAX(a.nr_sequencia)
into STRICT	nr_seq_material_w
from 	material_exame_lab a,
		prescr_procedimento b
where 	a.cd_material_exame = b.cd_material_exame
and		b.nr_prescricao = nr_prescricao_p
and		b.nr_sequencia = nr_seq_prescr_p;

select 	Max(nr_sequencia)
into STRICT	nr_seq_ficha_lote_w
from	lote_ent_sec_ficha
where	nr_prescricao = nr_prescricao_p;

select  MAX(nr_repeticao)
into STRICT	nr_repeticao_w
from	lote_ent_res_ant_repet
where	nr_prescricao = nr_prescricao_p
and 	nr_seq_prescr =  nr_seq_prescr_p
and		nr_seq_resultado = nr_seq_result_p;

/*gravar_log_tasy	(30,'12121213'||nr_prescricao_p||'-'||nr_seq_prescr_p||' - '||nr_seq_result_p||' - '||nr_repeticao_w,'MASSAS');
commit;
*/
if (nr_repeticao_w < 6) then
	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

	/*	gravar_log_tasy	(30,'1 '||c01_w.nr_seq_exame,'MASSAS');
		commit;
	*/
		insert into lote_ent_res_ant_repet(nr_sequencia,
												dt_atualizacao,
												nm_usuario,
												dt_atualizacao_nrec,
												nm_usuario_nrec,
												nr_prescricao,
												nr_seq_resultado,
												nr_seq_prescr,
												nr_seq_exame,
												nr_seq_ficha_lote,
												nr_repeticao,
												qt_result_ant,
												pr_result_ant,
												ds_result_ant,
												nr_seq_metodo,
												nr_seq_material )
							values (nextval('lote_ent_res_ant_repet_seq'),
												clock_timestamp(),
												nm_usuario_p,
												clock_timestamp(),
												nm_usuario_p,
												nr_prescricao_p,
												nr_seq_result_p,
												nr_seq_prescr_p,
												c01_w.nr_seq_exame,
												nr_seq_ficha_lote_w,
												nr_repeticao_w,
												c01_w.qt_resultado,
												c01_w.pr_resultado,
												c01_w.ds_resultado,
												c01_w.nr_seq_metodo,
												nr_seq_material_w);

					commit;
		end;
	end loop;
	close C01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualizar_repeticao_massas (nr_seq_result_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

