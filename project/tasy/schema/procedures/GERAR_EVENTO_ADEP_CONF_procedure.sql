-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_adep_conf ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_alteracao_p bigint, ds_justificativa_p text, ie_tipo_item_p text, nr_atendimento_p bigint, cd_item_p bigint, nm_usuario_p text, nr_seq_motivo_susp_p bigint, ie_acm_sn_p text, nr_seq_horario_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint) AS $body$
DECLARE

				
nr_seq_alter_w		bigint;	
ds_motivo_susp_w	varchar(255);	
nr_seq_horario_w	prescr_mat_hor.nr_sequencia%type;
nr_seq_lote_w		prescr_mat_hor.nr_seq_lote%type;
dt_horario_w		prescr_mat_hor.dt_horario%type;		
nr_seq_horario_proc_w	prescr_mat_alteracao.nr_seq_horario_proc%type;
nr_prescricao_w		prescr_medica.nr_prescricao%type;
nr_seq_item_w		bigint;
nr_seq_proc_int_w	prescr_procedimento.nr_seq_proc_interno%type;
nr_seq_prot_glic_w	prescr_procedimento.nr_seq_prot_glic%type;
ds_erro_w			varchar(2000);


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (ie_alteracao_p IS NOT NULL AND ie_alteracao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	

	select	max(ds_motivo_susp)
	into STRICT	ds_motivo_susp_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;	
		
	if (ie_tipo_item_p in ('M','G','C')) then
		begin
		
		if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
			begin
		
			nr_seq_horario_w	:= nr_seq_horario_p;
		
			if (ie_tipo_item_p = 'M') then
		
		        select	max(nr_seq_lote),
						max(dt_horario),
						max(nr_prescricao),
						max(nr_seq_material)
				into STRICT	nr_seq_lote_w,
						dt_horario_w,
						nr_prescricao_w,
						nr_seq_item_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_horario_p;

			else
			
				nr_seq_horario_proc_w	:= 	nr_seq_horario_p;	
				
				select	max(a.dt_horario),
						max(a.nr_prescricao),
						max(a.nr_seq_procedimento),
						max(a.nr_seq_proc_interno),
						max(b.nr_seq_prot_glic)
				into STRICT	dt_horario_w,
						nr_prescricao_w,
						nr_seq_item_w,
						nr_seq_proc_int_w,
						nr_seq_prot_glic_w
				from	prescr_proc_hor a,
						prescr_procedimento b
				where	a.nr_prescricao = b.nr_prescricao
				and		a.nr_seq_procedimento = b.nr_sequencia
				and		a.nr_sequencia = nr_seq_horario_proc_w;
				
			end if;
				
			end;
		end if;

		select	nextval('prescr_mat_alteracao_seq')
		into STRICT	nr_seq_alter_w
		;

		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_prescricao,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							ds_justificativa,
							ie_tipo_item,
							nr_atendimento,
							cd_item,
							nr_seq_motivo_susp,
							ie_acm_sn,
							nr_seq_horario,
							nr_seq_lote,
							dt_horario,
							nr_seq_horario_proc,
							nr_seq_procedimento,
							nr_seq_proc_interno,
							cd_procedimento,
							nr_seq_prot_glic,
							ie_evento_valido
							)
						values (
							nr_seq_alter_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_w,
							CASE WHEN ie_tipo_item_p='M' THEN  nr_seq_item_w  ELSE null END ,
							clock_timestamp(),
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							coalesce(ds_justificativa_p, ds_motivo_susp_w),
							CASE WHEN ie_tipo_item_p='IA' THEN  'P'  ELSE ie_tipo_item_p END ,
							nr_atendimento_p,
							cd_item_p,
							nr_seq_motivo_susp_p,
							ie_acm_sn_p,
							CASE WHEN ie_tipo_item_p='M' THEN  nr_seq_horario_w  ELSE null END ,
							nr_seq_lote_w,
							dt_horario_w,
							nr_seq_horario_proc_w,
							CASE WHEN ie_tipo_item_p='M' THEN  null  ELSE nr_seq_item_w END ,
							nr_seq_proc_int_w,
							CASE WHEN ie_tipo_item_p='M' THEN  null  ELSE cd_item_p END ,
							CASE WHEN ie_tipo_item_p='M' THEN  null  ELSE nr_seq_prot_glic_w END ,
							'S'							
							);
		end;
		
	elsif (ie_tipo_item_p = 'IA') then
		begin
			select	max(a.dt_horario)
			into STRICT	dt_horario_w
			from	prescr_mat_hor a
			where	a.nr_sequencia = nr_seq_horario_p;
			
			insert into prescr_mat_alteracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				dt_alteracao,
				cd_pessoa_fisica,
				ie_alteracao,
				ds_justificativa,
				ie_tipo_item,
				nr_atendimento,
				cd_item,
				nr_seq_motivo_susp,
				ie_acm_sn,
				nr_seq_horario,
				dt_horario,
				nr_seq_procedimento,
				nr_seq_proc_interno,
				cd_procedimento,
				ie_evento_valido
				)
			SELECT	nextval('prescr_mat_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					c.nr_prescricao,
					clock_timestamp(),
					obter_dados_usuario_opcao(nm_usuario_p,'C'),
					ie_alteracao_p,
					coalesce(ds_justificativa_p, ds_motivo_susp_w),
					ie_tipo_item_p,
					nr_atendimento_p,
					a.cd_material,
					nr_seq_motivo_susp_p,
					ie_acm_sn_p,
					a.nr_sequencia,
					dt_horario_w,
					c.nr_sequencia,
					c.nr_seq_proc_interno,
					cd_item_p,
					'S'
			from	prescr_mat_hor a,
					prescr_material b,
					prescr_procedimento c
			where	a.nr_prescricao = b.nr_prescricao
			and		a.nr_seq_material = b.nr_sequencia
			and		b.nr_prescricao = c.nr_prescricao
			and		b.nr_sequencia_proc = c.nr_sequencia
			and		a.dt_horario = dt_horario_w
			and		c.nr_sequencia = nr_seq_item_p
			and		c.nr_prescricao = nr_prescricao_p;
		end;
	elsif (ie_tipo_item_p = 'GAS') then
	
		
		select	nextval('prescr_gasoterapia_evento_seq')
		into STRICT	nr_seq_alter_w
		;
		
		insert into prescr_gasoterapia_evento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_gasoterapia,
					ie_evento,
					dt_evento,
					ie_evento_valido,
					nr_seq_horario)
				values (nr_seq_alter_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_item_p,					
					CASE WHEN ie_alteracao_p=99 THEN  'RC'  ELSE 'CR' END ,
					clock_timestamp(),
					'S',
					nr_seq_horario_p					
					);			
	
	elsif (ie_tipo_item_p	in ('SOL', 'SNE')) then
			
		if (nr_seq_horario_p > 0) then
			begin
		
			nr_seq_horario_w	:= nr_seq_horario_p;
		
		    select	max(nr_seq_lote),
					max(dt_horario)
			into STRICT	nr_seq_lote_w,
					dt_horario_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_p;
		
			end;
		end if;	
	
		select	nextval('prescr_solucao_evento_seq')
		into STRICT	nr_seq_alter_w
		;
		
		insert into prescr_solucao_evento(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,	
				cd_pessoa_fisica,
				ie_alteracao,
				ie_evento_valido,
				ie_tipo_solucao,
				nr_seq_lote,
				nr_prescricao,
				nr_seq_solucao,
				nr_seq_material,
				dt_horario,
				dt_alteracao)
		values (nr_seq_alter_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				obter_pf_usuario(nm_usuario_p, 'C'),
				ie_alteracao_p,
				'S',
				CASE WHEN ie_tipo_item_p='SOL' THEN  1  ELSE 2 END ,
				nr_seq_lote_w,
				nr_prescricao_p,				
				CASE WHEN ie_tipo_item_p='SOL' THEN  nr_seq_item_p  ELSE null END ,
				CASE WHEN ie_tipo_item_p='SOL' THEN  null  ELSE nr_seq_item_p END ,				
				dt_horario_w,
				clock_timestamp()
				);
				
	end if;
	
end if;


if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_adep_conf ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_alteracao_p bigint, ds_justificativa_p text, ie_tipo_item_p text, nr_atendimento_p bigint, cd_item_p bigint, nm_usuario_p text, nr_seq_motivo_susp_p bigint, ie_acm_sn_p text, nr_seq_horario_p bigint, nr_seq_proc_interno_p bigint, nr_seq_prot_glic_p bigint) FROM PUBLIC;

