-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_contrato_mult_selc (cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_solicitante_p text, cd_pessoa_fisica_p text, cd_cgc_fornecedor_p text, ie_frete_p text, cd_moeda_p bigint, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nm_usuario_p text, cd_local_estoque_p bigint, nr_ordem_compra_p INOUT bigint) AS $body$
DECLARE


cd_cgc_contratado_w			varchar(14);
cd_pessoa_contratada_w		varchar(10);
cd_condicao_pagamento_w		bigint;
nr_ordem_compra_w			bigint;
ds_observacao_w				varchar(255);
ie_somente_pagto_w			ordem_compra.ie_somente_pagto%type;
pr_desc_financ_w			contrato_regra_pagto.pr_desc_financ%type;


BEGIN
select	cd_cgc_contratado,
	cd_pessoa_contratada,
	cd_condicao_pagamento,
	ie_somente_oc_pagto
into STRICT	cd_cgc_contratado_w,
	cd_pessoa_contratada_w,
	cd_condicao_pagamento_w,
	ie_somente_pagto_w
from	contrato
where	nr_sequencia = nr_seq_contrato_p;

select 	obter_desconto_financ_contr(nr_seq_contrato_p)
into STRICT   	pr_desc_financ_w
;

if (cd_cgc_fornecedor_p IS NOT NULL AND cd_cgc_fornecedor_p::text <> '') then
	begin
	cd_cgc_contratado_w	:= cd_cgc_fornecedor_p;
	cd_pessoa_contratada_w	:= '';
	end;
elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	begin
	cd_cgc_contratado_w	:= '';
	cd_pessoa_contratada_w	:= cd_pessoa_fisica_p;
	end;
end if;

if (coalesce(cd_condicao_pagamento_w::text, '') = '') then
	/*(-20011,'Nao existe condicao de pagamento informada no contrato selecionado.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(187504);
end if;

if (coalesce(cd_cgc_contratado_w::text, '') = '') and (coalesce(cd_pessoa_contratada_w::text, '') = '') then
	/*(-20011,'Nao existe pessoa fisica ou juridica informada no contrato para a geracao da ordem de compras.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(187505);
end if;

select	nextval('ordem_compra_seq')
into STRICT	nr_ordem_compra_w
;

select	substr( Wheb_mensagem_pck.get_Texto(301897, 'DS_OBJETO_CONTRATO_W='|| DS_OBJETO_CONTRATO ),1,255)
into STRICT	ds_observacao_w
from	contrato
where	nr_sequencia = nr_seq_contrato_p;

insert into ordem_compra(
	nr_ordem_compra,
	cd_estabelecimento,
	cd_cgc_fornecedor,
	cd_condicao_pagamento,
	cd_comprador,
	dt_ordem_compra,
	dt_atualizacao,
	nm_usuario,
	cd_moeda,
	ie_situacao,
	dt_inclusao,
	cd_pessoa_solicitante,
	ie_frete,
	vl_frete,
	pr_desconto,
	pr_desc_pgto_antec,
	pr_juros_negociado,
	dt_entrega,
	ie_aviso_chegada,
	cd_pessoa_fisica,
	ie_emite_obs,
	ie_urgente,
	cd_setor_atendimento,
	pr_desc_financeiro,
	vl_desconto,
	ie_somente_pagto,
	ie_tipo_ordem,
	cd_local_entrega,
	nr_seq_contrato,
	ds_observacao)
values (	nr_ordem_compra_w,
	cd_estabelecimento_p,
	cd_cgc_contratado_w,
	cd_condicao_pagamento_w,
	cd_comprador_p,
	dt_ordem_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_moeda_p,
	'A',
	dt_inclusao_p,
	cd_pessoa_solicitante_p,
	ie_frete_p,
	0,
	0,
	0,
	0,
	dt_entrega_p,
	ie_aviso_chegada_p,
	cd_pessoa_contratada_w,
	ie_emite_obs_p,
	ie_urgente_p,
	cd_setor_atendimento_p,
	pr_desc_financ_w,
	0,
	coalesce(ie_somente_pagto_w,'N'),
	'C',
	cd_local_estoque_p,
	nr_seq_contrato_p,
	ds_observacao_w);
	
commit;

nr_ordem_compra_p	:= nr_ordem_compra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_contrato_mult_selc (cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_solicitante_p text, cd_pessoa_fisica_p text, cd_cgc_fornecedor_p text, ie_frete_p text, cd_moeda_p bigint, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nm_usuario_p text, cd_local_estoque_p bigint, nr_ordem_compra_p INOUT bigint) FROM PUBLIC;

