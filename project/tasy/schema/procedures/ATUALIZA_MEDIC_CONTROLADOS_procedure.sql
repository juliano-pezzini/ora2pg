-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_medic_controlados (nm_usuario_p text, ie_import_p text default 'S') AS $body$
DECLARE


cd_dcb_w		w_carga_dcb_medic_control.cd_dcb%type;
ds_dcb_w		w_carga_dcb_medic_control.ds_dcb%type;
nr_cas_w		w_carga_dcb_medic_control.nr_cas%type;
nr_sequencia_w	dcb_medic_controlado.nr_sequencia%type;
ie_atualizou_w  varchar(1);
ie_inseriu_w    varchar(1);
ie_existe_dcb_w varchar(1);

c01 CURSOR FOR

SELECT	cd_dcb,
	ds_dcb,
	nr_cas
from	w_carga_dcb_medic_control;


BEGIN

if (ie_import_p = 'S') then

    open C01;
    loop
    fetch C01 into	
        cd_dcb_w,
        ds_dcb_w,
        nr_cas_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
        begin

            ie_existe_dcb_w := obter_existe_dcb(cd_dcb_p => cd_dcb_w);

            if (ie_existe_dcb_w = 'S') then
                update dcb_medic_controlado
                set ds_dcb = ds_dcb_w,
                    cd_cas = nr_cas_w,
                    dt_atualizacao = clock_timestamp(),
                    nm_usuario = nm_usuario_p
                where cd_dcb = cd_dcb_w;

                ie_atualizou_w := 'S';
            else
                select	coalesce(max(nr_sequencia),0) +1
                into STRICT	nr_sequencia_w
                from	dcb_medic_controlado;

                insert into dcb_medic_controlado(
                    nr_sequencia,
                    cd_dcb,
                    ds_dcb,
                    dt_atualizacao,
                    nm_usuario,
                    cd_cas,
                    ie_situacao,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec)
                values (	nr_sequencia_w,
                    cd_dcb_w,
                    ds_dcb_w,
                    clock_timestamp(),
                    nm_usuario_p,
                    nr_cas_w,
                    'A',
                    clock_timestamp(),
                    nm_usuario_p);

                ie_inseriu_w := 'S';
            end if;
        end;
    end loop;
    close C01;

    
    if (ie_inseriu_w = 'S') then
        CALL gravar_carga_dcb_historico(ds_titulo_p => wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196423), 
                       ds_historico_p => wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196447),
                                    nm_usuario_p => nm_usuario_p);
    end if;

    if (ie_atualizou_w = 'S') then
        CALL gravar_carga_dcb_historico(ds_titulo_p => wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196426), 
                       ds_historico_p => wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196447),
                                    nm_usuario_p => nm_usuario_p);
    end if;

end if;

delete from w_carga_dcb_medic_control;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_medic_controlados (nm_usuario_p text, ie_import_p text default 'S') FROM PUBLIC;

