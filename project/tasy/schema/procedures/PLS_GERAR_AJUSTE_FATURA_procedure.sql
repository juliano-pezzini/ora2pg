-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ajuste_fatura (nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_lote_discussao_p pls_lote_discussao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ajuste_gerado_p INOUT pls_ajuste_fatura.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text default 'S') AS $body$
DECLARE


nr_seq_ajuste_w			pls_ajuste_fatura.nr_sequencia%type := null;
nr_seq_fatura_conta_w		pls_fatura_conta.nr_sequencia%type;
nr_seq_conta_w			pls_conta.nr_sequencia%type;
nr_seq_ajuste_conta_w		pls_ajuste_fatura_conta.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
qt_registro_w			integer;
cd_guia_ok_w            	pls_conta.cd_guia_ok%type;
ie_contestacao_refat_w		pls_parametro_faturamento.ie_contestacao_refat%type;

c01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_fatura_conta,
		b.nr_seq_conta,
		b.nr_seq_segurado,
		(SELECT  max(z.cd_guia_ok)
		from    pls_conta z
		where   z.nr_sequencia    = b.nr_seq_conta) cd_guia_ok
	from	pls_fatura_conta b,
		pls_fatura_evento a
	where	a.nr_sequencia	= b.nr_seq_fatura_evento
	and	b.nr_seq_conta in (	select	(	select  p.nr_seq_conta
							from	pls_conta_proc p
							where	p.nr_sequencia	= ci.nr_seq_conta_proc
							and	((ie_contestacao_refat_w = 'CI') or exists (	select	1
														from	pls_discussao_proc		l,
															pls_contestacao_discussao	d
														where	d.nr_sequencia			= l.nr_seq_discussao
														and	l.nr_seq_conta_proc		= p.nr_sequencia
														and	d.nr_seq_lote			= nr_seq_lote_discussao_p))
							
union

							select	m.nr_seq_conta
							from	pls_conta_mat m
							where	m.nr_sequencia	= ci.nr_seq_conta_mat
							and	((ie_contestacao_refat_w = 'CI') or exists (	select	1
														from	pls_discussao_mat		l,
															pls_contestacao_discussao	d
														where	d.nr_sequencia			= l.nr_seq_discussao
														and	l.nr_seq_conta_mat		= m.nr_sequencia
														and	d.nr_seq_lote			= nr_seq_lote_discussao_p))) nr_seq_conta
					from	ptu_nota_cobranca	c,
						ptu_nota_servico	ci
					where	c.nr_seq_conta		in (	select	x.nr_seq_conta			/* Somente contas que NECESSITAM de ajuste */
										from	w_pls_fatura_refat x)
					and	c.nr_sequencia		= ci.nr_seq_nota_cobr)
	and	a.nr_seq_fatura	= nr_seq_fatura_p;
	

BEGIN

select	coalesce(max(ie_contestacao_refat),'CI')
into STRICT	ie_contestacao_refat_w
from	pls_parametro_faturamento
where	cd_estabelecimento = cd_estabelecimento_p;

if (nr_seq_lote_discussao_p IS NOT NULL AND nr_seq_lote_discussao_p::text <> '') then
	select	max(l.nr_sequencia)
	into STRICT	nr_seq_ajuste_w
	from	pls_ajuste_fatura l
	where	l.nr_seq_lote_disc	= nr_seq_lote_discussao_p;
end if;

if (coalesce(nr_seq_ajuste_w::text, '') = '') then
	select	nextval('pls_ajuste_fatura_seq')
	into STRICT	nr_seq_ajuste_w
	;

	insert	into pls_ajuste_fatura(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_fatura,
		ie_status,
		dt_conclusao_ajuste,
		dt_ajuste,
		nr_seq_lote_disc)
	values (nr_seq_ajuste_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_fatura_p,
		'N',
		null,
		clock_timestamp(),
		nr_seq_lote_discussao_p);
end if;
		
open c01;
loop
fetch c01 into
	nr_seq_fatura_conta_w,
	nr_seq_conta_w,
	nr_seq_segurado_w,
	cd_guia_ok_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	qt_registro_w := 0;
	if (nr_seq_lote_discussao_p IS NOT NULL AND nr_seq_lote_discussao_p::text <> '') then
		select	count(1)
		into STRICT	qt_registro_w
		from	pls_ajuste_fatura	l,
			pls_ajuste_fatura_conta	c
		where	l.nr_sequencia		= c.nr_seq_ajuste_fatura
		and	l.nr_seq_lote_disc	= nr_seq_lote_discussao_p
		and	c.nr_seq_conta		= nr_seq_conta_w
		and	c.nr_seq_segurado	= nr_seq_segurado_w;
	end if;

	if (qt_registro_w = 0) then
		select	nextval('pls_ajuste_fatura_conta_seq')
		into STRICT	nr_seq_ajuste_conta_w
		;

		insert	into pls_ajuste_fatura_conta(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_ajuste_fatura,
			nr_seq_fatura_orig,
			nr_seq_fatura_conta_orig,
			nr_seq_conta,
			ie_status,
			nr_seq_fatura_nova,
			nr_seq_fatura_conta_nova,
			nr_seq_segurado,
			cd_guia)
		values (nr_seq_ajuste_conta_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_ajuste_w,
			nr_seq_fatura_p,
			nr_seq_fatura_conta_w,
			nr_seq_conta_w,
			'N',
			null,
			null,
			nr_seq_segurado_w,
			cd_guia_ok_w);
	end if;
end loop;
close c01;

nr_seq_ajuste_gerado_p	:= nr_seq_ajuste_w;

if (coalesce(ie_commit_p, 'S') = 'S')then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ajuste_fatura (nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_lote_discussao_p pls_lote_discussao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ajuste_gerado_p INOUT pls_ajuste_fatura.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text default 'S') FROM PUBLIC;

