-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conpaci_retorno (nr_seq_retorno_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w		bigint;
ie_auditoria_w			varchar(100);
nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(255);
cd_autorizacao_aux_w		varchar(255);
vl_pago_w			double precision;
vl_glosa_w			double precision;
nr_titulo_w			bigint;
vl_saldo_conpaci_w		double precision;
vl_recebido_outro_ret_w		double precision;
vl_adequado_w			double precision;
vl_guia_w			double precision;
VL_REC_MAIOR_W			double precision;
nr_seq_conpaci_ret_w		bigint;
ie_novo_w			varchar(100);
dt_receb_w			timestamp;
vl_amenor_post_w		double precision;

C01 CURSOR FOR 
SELECT	a.nr_interno_conta, 
	somente_numero(a.cd_autorizacao), 
	a.cd_autorizacao, 
	sum(a.vl_pago), 
	sum(a.vl_glosado), 
	a.nr_titulo, 
	sum(coalesce(a.vl_amenor_post,0)), 
	sum(coalesce(a.vl_guia,obter_valor_conpaci_guia(a.nr_interno_conta,a.cd_autorizacao,1))) 
from	conta_paciente b, 
  	convenio_retorno_item a 
where	a.nr_interno_conta	= b.nr_interno_conta 
and	a.nr_seq_retorno	= nr_seq_retorno_p 
and	ie_auditoria_w		= 'S' 
and	not exists (SELECT	1 
	from	conta_paciente_retorno x 
	where	x.nr_interno_conta	= a.nr_interno_conta 
	and	x.cd_autorizacao	= a.cd_autorizacao) 
group 	by a.nr_interno_conta, 
	somente_numero(a.cd_autorizacao), 
	a.cd_autorizacao, 
	a.nr_titulo 
having	sum(a.vl_pago) >= 0 
and 	coalesce(sum(a.vl_adicional),0) >= 0;

 
C02 CURSOR FOR 
SELECT	a.nr_interno_conta, 
	somente_numero(a.cd_autorizacao), 
	a.cd_autorizacao, 
	sum(a.vl_pago), 
	coalesce(sum(a.vl_adequado),0), 
	sum(coalesce(a.vl_amenor_post,0)) 
from	conta_paciente b, 
	convenio_retorno_item a 
where	a.nr_interno_conta		= b.nr_interno_conta 
and	a.nr_seq_retorno		= nr_seq_retorno_p 
and	ie_auditoria_w			= 'S' 
and	not exists (SELECT	1 
	from	conta_paciente_retorno x 
	where	x.nr_interno_conta	= a.nr_interno_conta 
	and	x.cd_autorizacao	= a.cd_autorizacao) 
group	by a.nr_interno_conta, 
	somente_numero(a.cd_autorizacao), 
	a.cd_autorizacao 
having	sum(a.vl_pago)		< 0;


BEGIN 
 
select	cd_estabelecimento, 
	coalesce(dt_baixa_cr ,clock_timestamp()) 
into STRICT	cd_estabelecimento_w, 
	dt_receb_w 
from	convenio_retorno 
where	nr_sequencia 		= nr_seq_retorno_p;
 
select	ie_audita_retorno 
into STRICT	ie_auditoria_w 
from	parametro_faturamento 
where	cd_estabelecimento 	= cd_estabelecimento_w;
 
 
open C01;
loop 
fetch C01 into 
	nr_interno_conta_w, 
	cd_autorizacao_w, 
	cd_autorizacao_aux_w, 
	vl_pago_w, 
	vl_glosa_w, 
	nr_titulo_w, 
	vl_amenor_post_w, 
	vl_guia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	select	coalesce(sum(vl_recebido + vl_glosa),0) 
	into STRICT	vl_recebido_outro_ret_w 
	from	titulo_receber_liq 
	where	nr_titulo	= nr_titulo_w 
	and	nr_seq_ret_item in (	SELECT	b.nr_sequencia 
					from	convenio_retorno_item b, 
						convenio_retorno a 
					where	a.nr_sequencia		= b.nr_seq_retorno 
					and	a.ie_status_retorno	='F' 
					and	b.nr_interno_conta 	= nr_interno_conta_w 
					and	b.cd_autorizacao	= cd_autorizacao_w 
					and	a.nr_sequencia		<> nr_seq_retorno_p);
 
	/* Francisco - 25/09/2009 - OS 156069 - Tratei o vl_amenor_post */
 
	if (vl_amenor_post_w > 0) then 
		vl_saldo_conpaci_w	:= vl_guia_w - vl_amenor_post_w;
	else 
		vl_saldo_conpaci_w := vl_pago_w + vl_glosa_w + vl_recebido_outro_ret_w;
	end if;
 
 
	SELECT * FROM obter_conpaci_retorno(nr_interno_conta_w, cd_autorizacao_aux_w, nm_usuario_p, dt_receb_w, vl_saldo_conpaci_w, nr_seq_conpaci_ret_w, ie_novo_w) INTO STRICT vl_saldo_conpaci_w, nr_seq_conpaci_ret_w, ie_novo_w;
end loop;
close c01;
 
open C02;
loop 
fetch C02 into	 
	nr_interno_conta_w, 
	cd_autorizacao_w, 
	cd_autorizacao_aux_w, 
	vl_pago_w, 
	vl_adequado_w, 
	vl_amenor_post_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
 
	vl_pago_w 	:= vl_pago_w * -1;
	vl_adequado_w 	:= vl_adequado_w * -1;
	 
	select	coalesce(sum(a.vl_guia),0) 
	into STRICT	vl_guia_w 
	from	conta_paciente_guia a 
	where	a.nr_interno_conta	= nr_interno_conta_w 
	and	a.cd_autorizacao	= cd_autorizacao_aux_w;
 
	select	coalesce(sum(vl_rec_maior),0) 
	into STRICT	vl_rec_maior_w 
	from	titulo_receber_liq 
	where	nr_seq_ret_item in (	SELECT	b.nr_sequencia 
					from	convenio_retorno_item b, 
						convenio_retorno a 
					where	a.nr_sequencia		= b.nr_seq_retorno 
					and	a.ie_status_retorno	='F' 
					and	b.nr_interno_conta 	= nr_interno_conta_w 
					and	b.cd_autorizacao	= cd_autorizacao_aux_w 
					and	a.nr_sequencia		<> nr_seq_retorno_p);
 
	vl_saldo_conpaci_w 	:= vl_guia_w + vl_rec_maior_w - vl_pago_w;
 
	SELECT * FROM obter_conpaci_retorno(	nr_interno_conta_w, cd_autorizacao_aux_w, nm_usuario_p, dt_receb_w, vl_saldo_conpaci_w, nr_seq_conpaci_ret_w, ie_novo_w) INTO STRICT vl_saldo_conpaci_w, nr_seq_conpaci_ret_w, ie_novo_w;
 
end loop;
close C02;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conpaci_retorno (nr_seq_retorno_p bigint, nm_usuario_p text) FROM PUBLIC;

