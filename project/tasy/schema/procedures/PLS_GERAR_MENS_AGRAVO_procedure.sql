-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_mens_agravo ( nr_seq_mensalidade_seg_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
dt_mesano_referencia_w		timestamp;
nr_seq_segurado_agravo_parc_w	bigint;
nr_seq_agravo_w			bigint;
vl_agravo_w			double precision;
ds_agravo_w			varchar(255);
ds_observacao_w			varchar(4000);
nr_parcela_w			bigint;
nr_seq_mens_seg_item_w		bigint;
tx_agravo_w			double precision;
vl_agravo_mensalidade_w		double precision;
vl_mensalidade_w		double precision;
qt_parcelas_w			bigint;
nr_seq_item_mensalidade_w	pls_mensalidade_seg_item.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		a.nr_seq_agravo,
		b.vl_agravo,
		c.ds_agravo,
		b.nr_parcela,
		b.tx_agravo,
		a.qt_parcelas
	from	pls_segurado_agravo	a,
		pls_segurado_agravo_parc b,
		pls_agravo		c
	where	b.nr_seq_segurado_agravo	= a.nr_sequencia
	and	a.nr_seq_agravo			= c.nr_sequencia
	and	a.nr_seq_segurado		= nr_seq_segurado_w
	and	trunc(b.dt_mes_competencia,'month')	= dt_mesano_referencia_w
	and	coalesce(b.nr_seq_mensalidade_item::text, '') = '';


BEGIN

nr_seq_segurado_w		:= pls_store_data_mens_pck.get_nr_seq_segurado;
dt_mesano_referencia_w		:= pls_store_data_mens_pck.get_dt_mesano_referencia;

select	sum(vl_item)
into STRICT	vl_mensalidade_w
from	pls_mensalidade_seg_item
where	nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_p
and	ie_tipo_item		in ('1','12','5','25');

open C01;
loop
fetch C01 into
	nr_seq_segurado_agravo_parc_w,
	nr_seq_agravo_w,
	vl_agravo_w,
	ds_agravo_w,
	nr_parcela_w,
	tx_agravo_w,
	qt_parcelas_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_observacao_w		:= 'Cobrança referente a '||nr_parcela_w||'° parcela no total de ' || qt_parcelas_w || ' do agravo '||ds_agravo_w||'.';
	vl_agravo_mensalidade_w	:= 0;

	if (vl_agravo_w <> 0) then
		vl_agravo_mensalidade_w	:= vl_agravo_w;
	elsif (tx_agravo_w <> 0) then
		vl_agravo_mensalidade_w	:= vl_agravo_mensalidade_w + ((coalesce(tx_agravo_w,0)/100) * coalesce(vl_mensalidade_w,0));
	end if;

	if (vl_agravo_mensalidade_w <> 0) then

		nr_seq_item_mensalidade_w := null;

		nr_seq_item_mensalidade_w := pls_insert_mens_seg_item('21', nm_usuario_p, null, null, ds_observacao_w, null, null, null, null, 'N', null, null, null, null, null, null, null, nr_seq_mensalidade_seg_p, null, null, null, null, null, null, null, null, null, null, null, null, null, vl_agravo_mensalidade_w, nr_seq_item_mensalidade_w);

		if (nr_seq_item_mensalidade_w IS NOT NULL AND nr_seq_item_mensalidade_w::text <> '') then
			update	pls_segurado_agravo_parc
			set	nr_seq_mensalidade_item	= nr_seq_item_mensalidade_w
			where	nr_sequencia	= nr_seq_segurado_agravo_parc_w;
		end if;
	end if;
	end;
end loop;
close C01;

--Não pode dar commit
--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mens_agravo ( nr_seq_mensalidade_seg_p bigint, nm_usuario_p text) FROM PUBLIC;

