-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_prof_follow_up ( nm_usuario_p pessoa_fisica.nm_usuario%TYPE, cd_profissional_p panorama_acomp_prof.cd_profissional%Type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE) AS $body$
DECLARE


nr_sequencia_w          bigint;
dt_atualizacao_w	    timestamp;
nm_usuario_w            pessoa_fisica.nm_usuario%TYPE;
cd_profissional_w       panorama_acomp_prof.cd_profissional%TYPE;
cd_pessoa_fisica_w      pessoa_fisica.cd_pessoa_fisica%TYPE;
ie_acomp_ativo_w        panorama_acomp_prof.ie_acomp_ativo%TYPE;

C01 CURSOR FOR
    SELECT  nr_sequencia,
            nm_usuario,
            cd_pessoa_fisica,
            ie_acomp_ativo,
            cd_profissional
    FROM    PANORAMA_ACOMP_PROF
    WHERE   nr_atendimento = nr_atendimento_p
    AND     cd_pessoa_fisica = cd_pessoa_fisica_p
    AND     cd_profissional = cd_profissional_p;


BEGIN

    SELECT	coalesce(MAX(ie_acomp_ativo),0)
    INTO STRICT	ie_acomp_ativo_w
    FROM	PANORAMA_ACOMP_PROF
    WHERE	cd_pessoa_fisica = cd_pessoa_fisica_p
    AND	    nr_atendimento = nr_atendimento_p
    AND     cd_profissional = cd_profissional_p;
    dt_atualizacao_w	:= clock_timestamp();

    IF (ie_acomp_ativo_w != 'N' AND ie_acomp_ativo_w != 'S') THEN
        BEGIN
            INSERT INTO PANORAMA_ACOMP_PROF(nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                cd_pessoa_fisica,
                ie_acomp_ativo,
                cd_profissional,
                nr_atendimento)
            VALUES (nextval('panorama_acomp_prof_seq'),
                dt_atualizacao_w,
                nm_usuario_p,
                dt_atualizacao_w,
                nm_usuario_p,
                cd_pessoa_fisica_p,
                'N',
                cd_profissional_p,
                nr_atendimento_p);
        END;
    END IF;

OPEN C01;
LOOP
FETCH C01 INTO
    nr_sequencia_w,
    nm_usuario_w,
    cd_pessoa_fisica_w,
    ie_acomp_ativo_w,
    cd_profissional_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

IF (ie_acomp_ativo_w = 'S') THEN
    BEGIN
        UPDATE PANORAMA_ACOMP_PROF
        SET nm_usuario_nrec = nm_usuario_p,
        cd_pessoa_fisica = cd_pessoa_fisica_p,
        ie_acomp_ativo = 'N',
        cd_profissional = cd_profissional_p,
        dt_atualizacao_nrec = dt_atualizacao_w
        WHERE nr_sequencia = nr_sequencia_w;
    END;
ELSE
    BEGIN
        UPDATE PANORAMA_ACOMP_PROF
        SET nm_usuario_nrec = nm_usuario_p,
        cd_pessoa_fisica = cd_pessoa_fisica_p,
        ie_acomp_ativo = 'S',
        cd_profissional = cd_profissional_p,
        dt_atualizacao_nrec = dt_atualizacao_w
        WHERE nr_sequencia = nr_sequencia_w;
    END;
END IF;
END LOOP;
CLOSE C01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_prof_follow_up ( nm_usuario_p pessoa_fisica.nm_usuario%TYPE, cd_profissional_p panorama_acomp_prof.cd_profissional%Type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%TYPE, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE) FROM PUBLIC;

