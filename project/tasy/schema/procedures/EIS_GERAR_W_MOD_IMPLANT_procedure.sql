-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_gerar_w_mod_implant (dt_referencia_p timestamp) AS $body$
DECLARE

 
dt_referencia_w	timestamp;
sg_estado_w		pessoa_juridica.sg_estado%type;
nr_seq_cliente_w	bigint;
nm_fantasia_w		varchar(255);
nr_seq_canal_w	bigint;
ds_canal_w		varchar(255);
dt_inicio_uso_w	timestamp;
pr_funcao_modulo_w	double precision;
ds_modulo_w		varchar(255);
nr_seq_modulo_w	bigint;
qt_cliente_w		bigint;
qt_modulo_w		bigint;
pr_nao_utilizado_w	double precision;

c01 CURSOR FOR 
	SELECT	d.nr_sequencia, 
		substr(obter_dados_pf_pj(null,d.cd_cnpj,'UF'),1,2), 
		substr(obter_dados_pf_pj(null,d.cd_cnpj,'F'),1,254), 
		b.dt_inicio_util, 
		sum(a.pr_funcao_modulo), 
		c.nr_seq_modulo, 
		substr(obter_desc_modulo_implant(c.nr_seq_modulo),1,80) 
	from	com_cliente d, 
		com_cliente_mod_impl c, 
		com_cliente_fun_impl b, 
		funcao a 
	where	a.cd_funcao	= b.cd_funcao 
	and	b.nr_seq_mod_impl = c.nr_sequencia 
	and	c.nr_seq_cliente = d.nr_sequencia 
	and	d.ie_classificacao = 'C' 
	and	trunc(b.dt_inicio_util,'dd') = trunc(dt_referencia_w,'dd') 
	group by	d.nr_sequencia, 
			d.cd_cnpj, 
			b.dt_inicio_util, 
			c.nr_seq_modulo;


BEGIN 
 
/* Exclui todos os registros da tabela */
 
delete from w_eis_modulo_implant;
 
/* Busca a menor data de inicio de utilização das funções */
 
select	trunc(min(dt_inicio_util),'month') 
into STRICT	dt_referencia_w 
from	com_cliente_fun_impl;
 
/* Lê todas as funções utilizadas pelos clientes pela data de inicio de utilização */
 
while(dt_referencia_w <= fim_mes(dt_referencia_p)) loop 
	begin 
	open c01;
	loop 
	fetch c01 into 
		nr_seq_cliente_w, 
		sg_estado_w, 
		nm_fantasia_w, 
		dt_inicio_uso_w, 
		pr_funcao_modulo_w, 
		nr_seq_modulo_w, 
		ds_modulo_w;		
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		select	max(a.nr_seq_canal), 
			max(obter_desc_canal_atuacao(a.nr_seq_canal)) 
		into STRICT	nr_seq_canal_w, 
			ds_canal_w 
		from	com_canal_cliente a 
		where	a.nr_seq_cliente = nr_seq_cliente_w 
		and	a.ie_tipo_atuacao = 'V' 
		and	coalesce(a.dt_fim_atuacao::text, '') = '';
 
		insert into w_eis_modulo_implant( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				sg_estado, 
				nr_seq_cliente, 
				ds_cliente, 
				nr_seq_canal, 
				ds_canal, 
				pr_utilizado, 
				pr_nao_utilizado, 
				nr_seq_modulo, 
				ds_modulo, 
				dt_referencia, 
				ie_periodo, 
				qt_modulo, 
				qt_cliente) 
		values (	nextval('w_eis_modulo_implant_seq'), 
				clock_timestamp(), 
				'Tasy', 
				clock_timestamp(), 
				'Tasy', 
				sg_estado_w, 
				nr_seq_cliente_w, 
				nm_fantasia_w, 
				nr_seq_canal_w, 
				ds_canal_w, 
				pr_funcao_modulo_w, 
				(100 - pr_funcao_modulo_w), 
				nr_seq_modulo_w, 
				ds_modulo_w, 
				dt_referencia_w, 
				'D', 
				0, 
				0);
		end;
	end loop;
	close c01;
	dt_referencia_w := dt_referencia_w + 1;
	end;
end loop;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_gerar_w_mod_implant (dt_referencia_p timestamp) FROM PUBLIC;

