-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_remessa_giss ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

					
ds_conteudo_w			varchar(2000);

cd_indicador_w			varchar(1);
nr_layout_w			varchar(1);
nr_nf_inicial_w			varchar(30);
cd_serie_nf_w			varchar(10);
nr_nf_final_w			varchar(30);
dt_emissao_nf_w			varchar(10);
ie_tipo_nf_w			varchar(1);
vl_base_calculo_w		varchar(12);
vl_nota_fiscal_w		varchar(12);
cd_atividade_prestada_w		varchar(20);
ie_tipo_cadastro_w		varchar(1);
ie_prestador_municipio_w	varchar(1);
ds_razo_social_w		pessoa_juridica.ds_razao_social%type;
nr_inscricao_municipal_w	varchar(20);
nr_inscricao_municipal_dv_w	varchar(1);
cd_cpf_cnpj_w			varchar(14);
ie_isento_w			varchar(1);
nr_inscricao_estadual_w		varchar(20);
cd_cep_w			varchar(8);
ds_logradouro_w			varchar(5);
ie_titulo_logradouro_w		varchar(5);
ds_endereco_w			varchar(50);
ds_complemento_w		varchar(40);
nr_endereco_w			varchar(10);
ds_bairro_w			varchar(50);
sg_estado_w			valor_dominio.vl_dominio%type;
ds_municipio_w			varchar(50);
ie_origem_dados_w		varchar(1);
ie_servico_municipio_w		varchar(1);
sg_pais_w			varchar(2);
ds_observacao_w			varchar(500);
cd_plano_conta_w		varchar(80);
cd_alvara_w			varchar(15);
ie_enquadramento_w		varchar(1);
cd_plano_conta_pai_w		varchar(80);
ie_recolhe_imposto_w		varchar(1);
ie_simples_w			varchar(1);
vl_aliquota_w			varchar(22);
cd_local_prestacao_w		varchar(1);
cd_pais_w			varchar(2)	:= 'BR';
ie_agrupado_w			pls_lote_envio_giss.ie_agrupado%type;

C01 CURSOR FOR
	SELECT	a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(a.nr_nf_inicial,1,10),'0'),10,'0') nr_nf_inicial,
		rpad(coalesce(a.cd_serie_nf,' '),10,' ') cd_serie_nf,
		lpad(coalesce(substr(a.nr_nf_final,1,10),'0'),10,'0') nr_nf_final,
		to_char(a.dt_emissao_nf,'dd/mm/yyyy') dt_emissao_nf,
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END  ie_tipo_nf,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(a.vl_base_calculo)),1,12),'0'),12,'0') vl_base_calculo,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(a.vl_nota_fiscal)),1,12),'0'),12,'0') vl_nota_fiscal,
		a.cd_atividade_prestada,
		'1' ie_tipo_cadastro,
		a.ie_prestador_municipio,
		rpad(b.nm_pessoa_fisica,100,' ') ds_razo_social,
		rpad('0',10,'0') nr_inscricao_municipal,
		'' nr_inscricao_municipal_dv,
		rpad(b.cd_pessoa_fisica,14,' ') cd_cpf_cnpj,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  ie_isento,
		rpad('0',15,'0') nr_inscricao_estadual,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CEP'),1,8),' '),8,' ') cd_cep,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'LO'),1,5),' '),5,' ') ds_logradouro,
		rpad(' ',5,' ') ie_titulo_logradouro,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'R'),1,50),' '),50,' ') ds_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CO'),1,40),' '),40,' ') ds_complemento,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'NR'),1,10),' '),10,' ') nr_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'B'),1,50),' '),50,' ') ds_bairro,
		coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'UF'),1,2),'  ') sg_estado,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CI'),1,50),' '),50,' ') ds_municipio,
		'R' ie_origem_dados,
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END  ie_servico_municipio,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  ') sg_pais,
		'' ds_observacao,
		'' cd_plano_conta,
		'' cd_alvara,
		'' ie_enquadramento,
		'' cd_plano_conta_pai,
		'' ie_recolhe_imposto,
		'' ie_simples,
		'' vl_aliquota,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  cd_local_prestacao
	from	pessoa_fisica			b,
		pls_tomador_prestador_giss	a
	where	a.nr_seq_lote		= nr_seq_lote_p
	and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	coalesce(a.ie_envio,'S') 	= 'S'
	and	a.ie_prestador_municipio = 'S'
	
union all

	SELECT	a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(a.nr_nf_inicial,1,10),'0'),10,'0') nr_nf_inicial,
		rpad(coalesce(a.cd_serie_nf,' '),10,' ') cd_serie_nf,
		lpad(coalesce(substr(a.nr_nf_final,1,10),'0'),10,'0') nr_nf_final,
		to_char(a.dt_emissao_nf,'dd/mm/yyyy') dt_emissao_nf,
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END  ie_tipo_nf,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(a.vl_base_calculo)),1,12),'0'),12,'0') vl_base_calculo,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(a.vl_nota_fiscal)),1,12),'0'),12,'0') vl_nota_fiscal,
		a.cd_atividade_prestada,
		'2' ie_tipo_cadastro,
		a.ie_prestador_municipio,
		rpad(b.ds_razao_social,100,' ') ds_razo_social,
		rpad(coalesce(b.nr_inscricao_municipal,'0'),10,'0') nr_inscricao_municipal,
		'' nr_inscricao_municipal_dv,
		rpad(b.cd_cgc,14,' ') cd_cpf_cnpj,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  ie_isento,
		rpad(coalesce(b.nr_inscricao_estadual,'0'),15,'0') nr_inscricao_estadual,
		rpad(coalesce(substr(b.cd_cep,1,8),' '),8,' ') cd_cep,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'LO'),1,5),' '),5,' ') ds_logradouro,
		rpad(' ',5,' ') ie_titulo_logradouro,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,50),' '),50,' ') ds_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,40),' '),40,' ') ds_complemento,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,10),' '),10,' ') nr_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'B'),1,50),' '),50,' ') ds_bairro,
		coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2),'  ') sg_estado,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,50),' '),50,' ') ds_municipio,
		'R' ie_origem_dados,
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END  ie_servico_municipio,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  ') sg_pais,
		'' ds_observacao,
		'' cd_plano_conta,
		'' cd_alvara,
		'' ie_enquadramento,
		'' cd_plano_conta_pai,
		'' ie_recolhe_imposto,
		'' ie_simples,
		'' vl_aliquota,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  cd_local_prestacao
	from	pessoa_juridica			b,
		pls_tomador_prestador_giss	a
	where	a.nr_seq_lote		= nr_seq_lote_p
	and	a.cd_cgc		= b.cd_cgc
	and	coalesce(a.ie_envio,'S') 	= 'S'
	and	a.ie_prestador_municipio = 'S'	
	order by 11,13;
	
C02 CURSOR FOR
	SELECT	a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0') nr_nf_inicial,
		rpad(coalesce('MC',' '),10,' ') cd_serie_nf,
		lpad(coalesce(substr(23948,1,10),'0'),10,'0') nr_nf_final,
		to_char(a.dt_emissao_nf,'dd/mm/yyyy') dt_emissao_nf,
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END  ie_tipo_nf,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(sum(a.vl_base_calculo))),1,12),'0'),12,'0') vl_base_calculo,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(sum(a.vl_nota_fiscal))),1,12),'0'),12,'0') vl_nota_fiscal,
		a.cd_atividade_prestada,
		'1' ie_tipo_cadastro,
		a.ie_prestador_municipio,
		rpad(b.nm_pessoa_fisica,100,' ') ds_razo_social,
		rpad('0',10,'0') nr_inscricao_municipal,
		'' nr_inscricao_municipal_dv,
		rpad(b.cd_pessoa_fisica,14,' ') cd_cpf_cnpj,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  ie_isento,
		rpad('0',15,'0') nr_inscricao_estadual,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CEP'),1,8),' '),8,' ') cd_cep,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'LO'),1,5),' '),5,' ') ds_logradouro,
		rpad(' ',5,' ') ie_titulo_logradouro,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'R'),1,50),' '),50,' ') ds_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CO'),1,40),' '),40,' ') ds_complemento,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'NR'),1,10),' '),10,' ') nr_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'B'),1,50),' '),50,' ') ds_bairro,
		coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'UF'),1,2),'  ') sg_estado,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CI'),1,50),' '),50,' ') ds_municipio,
		'R' ie_origem_dados,
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END  ie_servico_municipio,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  ') sg_pais,
		'' ds_observacao,
		'' cd_plano_conta,
		'' cd_alvara,
		'' ie_enquadramento,
		'' cd_plano_conta_pai,
		'' ie_recolhe_imposto,
		'' ie_simples,
		'' vl_aliquota,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  cd_local_prestacao
	from	pessoa_fisica			b,
		pls_tomador_prestador_giss	a
	where	a.nr_seq_lote		= nr_seq_lote_p
	and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	coalesce(a.ie_envio,'S') 	= 'S'
	and	a.ie_prestador_municipio = 'S'
	group by
		a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0'),
		rpad(coalesce('MC',' '),10,' '),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0'),
		to_char(a.dt_emissao_nf,'dd/mm/yyyy'),
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END ,
		a.cd_atividade_prestada,
		a.ie_prestador_municipio,
		rpad(b.nm_pessoa_fisica,100,' '),
		rpad(b.cd_pessoa_fisica,14,' '),
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END ,
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CEP'),1,8),' '),8,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'LO'),1,5),' '),5,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'R'),1,50),' '),50,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CO'),1,40),' '),40,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'NR'),1,10),' '),10,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'B'),1,50),' '),50,' '),
		coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'UF'),1,2),'  '),
		rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CI'),1,50),' '),50,' '),
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END ,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  '),
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END
	
union all

	SELECT	a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0') nr_nf_inicial,
		rpad(coalesce('MC',' '),10,' ') cd_serie_nf,
		lpad(coalesce(substr(23948,1,10),'0'),10,'0') nr_nf_final,
		to_char(a.dt_emissao_nf,'dd/mm/yyyy') dt_emissao_nf,
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END  ie_tipo_nf,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(sum(a.vl_base_calculo))),1,12),'0'),12,'0') vl_base_calculo,
		lpad(coalesce(substr(elimina_caracteres_especiais(obter_Valor_sem_virgula(sum(a.vl_nota_fiscal))),1,12),'0'),12,'0') vl_nota_fiscal,
		a.cd_atividade_prestada,
		'2' ie_tipo_cadastro,
		a.ie_prestador_municipio,
		rpad(b.ds_razao_social,100,' ') ds_razo_social,
		rpad(coalesce(b.nr_inscricao_municipal,'0'),10,'0') nr_inscricao_municipal,
		'' nr_inscricao_municipal_dv,
		rpad(b.cd_cgc,14,' ') cd_cpf_cnpj,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  ie_isento,
		rpad(coalesce(b.nr_inscricao_estadual,'0'),15,'0') nr_inscricao_estadual,
		rpad(coalesce(substr(b.cd_cep,1,8),' '),8,' ') cd_cep,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'LO'),1,5),' '),5,' ') ds_logradouro,
		rpad(' ',5,' ') ie_titulo_logradouro,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,50),' '),50,' ') ds_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,40),' '),40,' ') ds_complemento,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,10),' '),10,' ') nr_endereco,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'B'),1,50),' '),50,' ') ds_bairro,
		coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2),'  ') sg_estado,
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,50),' '),50,' ') ds_municipio,
		'R' ie_origem_dados,
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END  ie_servico_municipio,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  ') sg_pais,
		'' ds_observacao,
		'' cd_plano_conta,
		'' cd_alvara,
		'' ie_enquadramento,
		'' cd_plano_conta_pai,
		'' ie_recolhe_imposto,
		'' ie_simples,
		'' vl_aliquota,
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END  cd_local_prestacao
	from	pessoa_juridica			b,
		pls_tomador_prestador_giss	a
	where	a.nr_seq_lote		= nr_seq_lote_p
	and	a.cd_cgc		= b.cd_cgc
	and	coalesce(a.ie_envio,'S') 	= 'S'
	and	a.ie_prestador_municipio = 'S'
	group by
		a.cd_indicador,
		to_char(a.nr_layout),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0'),
		rpad(coalesce('MC',' '),10,' '),
		lpad(coalesce(substr(23948,1,10),'0'),10,'0'),
		to_char(a.dt_emissao_nf,'dd/mm/yyyy'),
		CASE WHEN a.ie_origem_doc='I' THEN '1'  ELSE '' END ,
		a.cd_atividade_prestada,
		a.ie_prestador_municipio,
		rpad(b.ds_razao_social,100,' '),
		rpad(coalesce(b.nr_inscricao_municipal,'0'),10,'0'),
		rpad(b.cd_cgc,14,' '),
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END ,
		rpad(coalesce(b.nr_inscricao_estadual,'0'),15,'0'),
		rpad(coalesce(substr(b.cd_cep,1,8),' '),8,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'LO'),1,5),' '),5,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,50),' '),50,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,40),' '),40,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,10),' '),10,' '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'B'),1,50),' '),50,' '),
		coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2),'  '),
		rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,50),' '),50,' '),
		CASE WHEN a.ie_prestador_municipio='S' THEN 'D'  ELSE 'F' END ,
		coalesce(substr(obter_dados_pais(b.nr_seq_pais,'SG'),1,2),'  '),
		CASE WHEN a.ie_origem_doc='I' THEN 'S'  ELSE 'N' END 
	order by 11,13;


BEGIN
delete from w_pls_envio_giss where nm_usuario = nm_usuario_p;

commit;

select	coalesce(max(a.ie_agrupado),'N')
into STRICT	ie_agrupado_w
from	pls_lote_envio_giss	a
where	a.nr_sequencia	= nr_seq_lote_p;

ds_conteudo_w	:= 	'CD_INDICADOR||NR_LAYOUT||DT_EMISSAO_NF||NR_DOC_NF_INICIAL||NR_DOC_NF_SERIE||NR_DOC_NF_FINAL||TP_DOC_NF||' ||
			'VL_DOC_NF||VL_BASE_CALCULO||CD_ATIVIDADE||CD_PREST_TOM_ESTABELECIDO||CD_LOCAL_PRESTACAO||NM_RAZAO_SOCIAL||NR_CNPJ_CPF||' ||
			'CD_TIPO_CADASTRO||NR_INSCRICAO_MUNICIPAL||NM_INSCRICAO_MUNICIPAL_DV||NR_INSCRICAO_ESTADUAL||'||
			'NM_TIPO_LOGRADOURO||NM_TITULO_LOGRADOURO||NM_LOGRADOURO||NM_COMPL_LOGRADOURO||NR_LOGRADOURO||CD_CEP||' ||
			'NM_BAIRRO||CD_ESTADO||NM_CIDADE||CD_PAIS||NM_OBSERVACAO||CD_PLANO_CONTA||CD_ALVARA||IC_ORIGEM_DADOS||' ||
			'IC_ENQUADRAMENTO||CD_PLANO_CONTA_PAI||IC_RECOLHE_IMPOSTO||VL_ALIQUOTA||FL_ISENTO||FL_SIMPLES';
		
insert into w_pls_envio_giss(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_conteudo)
values (nextval('w_pls_envio_giss_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	ds_conteudo_w);

if (ie_agrupado_w = 'N') then
	open C01;
	loop
	fetch C01 into	
		cd_indicador_w,
		nr_layout_w,
		nr_nf_inicial_w,
		cd_serie_nf_w,
		nr_nf_final_w,
		dt_emissao_nf_w,
		ie_tipo_nf_w,
		vl_base_calculo_w,
		vl_nota_fiscal_w,
		cd_atividade_prestada_w,
		ie_tipo_cadastro_w,
		ie_prestador_municipio_w,
		ds_razo_social_w,
		nr_inscricao_municipal_w,
		nr_inscricao_municipal_dv_w,
		cd_cpf_cnpj_w,
		ie_isento_w,
		nr_inscricao_estadual_w,
		cd_cep_w,
		ds_logradouro_w,
		ie_titulo_logradouro_w,
		ds_endereco_w,
		ds_complemento_w,
		nr_endereco_w,
		ds_bairro_w,
		sg_estado_w,
		ds_municipio_w,
		ie_origem_dados_w,
		ie_servico_municipio_w,
		sg_pais_w,
		ds_observacao_w,
		cd_plano_conta_w,
		cd_alvara_w,
		ie_enquadramento_w,
		cd_plano_conta_pai_w,
		ie_recolhe_imposto_w,
		ie_simples_w,
		vl_aliquota_w,
		cd_local_prestacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_conteudo_w := 	cd_indicador_w			|| '||' ||
					nr_layout_w			|| '||' ||
					dt_emissao_nf_w 		|| '||' ||
					nr_nf_inicial_w			|| '||' ||
					cd_serie_nf_w			|| '||' ||
					nr_nf_final_w 			|| '||' ||
					ie_tipo_nf_w 			|| '||' ||
					vl_nota_fiscal_w 		|| '||' ||
					vl_base_calculo_w 		|| '||' ||
					cd_atividade_prestada_w 	|| '||' ||
					ie_prestador_municipio_w 	|| '||' ||
					ie_servico_municipio_w 		|| '||' ||
					ds_razo_social_w 		|| '||' ||
					cd_cpf_cnpj_w			|| '||' ||
					ie_tipo_cadastro_w		|| '||' ||
					nr_inscricao_municipal_w 	|| '||' ||
					nr_inscricao_municipal_dv_w	|| '||' ||
					nr_inscricao_estadual_w 	|| '||' ||
					ds_logradouro_w 		|| '||' ||
					ie_titulo_logradouro_w 		|| '||' ||
					ds_endereco_w 			|| '||' ||
					ds_complemento_w 		|| '||' ||
					nr_endereco_w 			|| '||' ||
					cd_cep_w 			|| '||' ||
					ds_bairro_w			|| '||' ||
					sg_estado_w 			|| '||' ||
					ds_municipio_w 			|| '||' ||
					sg_pais_w 			|| '||' ||
					ds_observacao_w 		|| '||' ||
					cd_plano_conta_w 		|| '||' ||
					cd_alvara_w 			|| '||' ||
					ie_origem_dados_w 		|| '||' ||
					ie_enquadramento_w 		|| '||' ||
					cd_plano_conta_pai_w		|| '||' ||
					ie_recolhe_imposto_w 		|| '||' ||
					vl_aliquota_w			|| '||' ||
					ie_isento_w 			|| '||' ||
					ie_simples_w;
					
		insert into w_pls_envio_giss(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_conteudo)
		values (nextval('w_pls_envio_giss_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
		end;
	end loop;
	close C01;
else
	open C02;
	loop
	fetch C02 into	
		cd_indicador_w,
		nr_layout_w,
		nr_nf_inicial_w,
		cd_serie_nf_w,
		nr_nf_final_w,
		dt_emissao_nf_w,
		ie_tipo_nf_w,
		vl_base_calculo_w,
		vl_nota_fiscal_w,
		cd_atividade_prestada_w,
		ie_tipo_cadastro_w,
		ie_prestador_municipio_w,
		ds_razo_social_w,
		nr_inscricao_municipal_w,
		nr_inscricao_municipal_dv_w,
		cd_cpf_cnpj_w,
		ie_isento_w,
		nr_inscricao_estadual_w,
		cd_cep_w,
		ds_logradouro_w,
		ie_titulo_logradouro_w,
		ds_endereco_w,
		ds_complemento_w,
		nr_endereco_w,
		ds_bairro_w,
		sg_estado_w,
		ds_municipio_w,
		ie_origem_dados_w,
		ie_servico_municipio_w,
		sg_pais_w,
		ds_observacao_w,
		cd_plano_conta_w,
		cd_alvara_w,
		ie_enquadramento_w,
		cd_plano_conta_pai_w,
		ie_recolhe_imposto_w,
		ie_simples_w,
		vl_aliquota_w,
		cd_local_prestacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_conteudo_w := 	cd_indicador_w			|| '||' ||
					nr_layout_w			|| '||' ||
					dt_emissao_nf_w 		|| '||' ||
					nr_nf_inicial_w			|| '||' ||
					cd_serie_nf_w			|| '||' ||
					nr_nf_final_w 			|| '||' ||
					ie_tipo_nf_w 			|| '||' ||
					vl_nota_fiscal_w 		|| '||' ||
					vl_base_calculo_w 		|| '||' ||
					cd_atividade_prestada_w 	|| '||' ||
					ie_prestador_municipio_w 	|| '||' ||
					ie_servico_municipio_w 		|| '||' ||
					ds_razo_social_w 		|| '||' ||
					cd_cpf_cnpj_w			|| '||' ||
					ie_tipo_cadastro_w		|| '||' ||
					nr_inscricao_municipal_w 	|| '||' ||
					nr_inscricao_municipal_dv_w	|| '||' ||
					nr_inscricao_estadual_w 	|| '||' ||
					ds_logradouro_w 		|| '||' ||
					ie_titulo_logradouro_w 		|| '||' ||
					ds_endereco_w 			|| '||' ||
					ds_complemento_w 		|| '||' ||
					nr_endereco_w 			|| '||' ||
					cd_cep_w 			|| '||' ||
					ds_bairro_w			|| '||' ||
					sg_estado_w 			|| '||' ||
					ds_municipio_w 			|| '||' ||
					sg_pais_w 			|| '||' ||
					ds_observacao_w 		|| '||' ||
					cd_plano_conta_w 		|| '||' ||
					cd_alvara_w 			|| '||' ||
					ie_origem_dados_w 		|| '||' ||
					ie_enquadramento_w 		|| '||' ||
					cd_plano_conta_pai_w		|| '||' ||
					ie_recolhe_imposto_w 		|| '||' ||
					vl_aliquota_w			|| '||' ||
					ie_isento_w 			|| '||' ||
					ie_simples_w;
					
		insert into w_pls_envio_giss(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_conteudo)
		values (nextval('w_pls_envio_giss_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
		end;
	end loop;
	close C02;
end if;

update	pls_lote_envio_giss
set	dt_geracao_arquivo	= clock_timestamp()
where	nr_sequencia		= nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_remessa_giss ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

