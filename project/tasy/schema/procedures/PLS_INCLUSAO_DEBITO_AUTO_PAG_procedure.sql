-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inclusao_debito_auto_pag ( nr_seq_pagador_p bigint, cd_usuario_plano_p text, dt_alteracao_p timestamp, nr_seq_conta_banco_p bigint, cd_agencia_bancaria_p text, ie_digito_agencia_p text, cd_conta_p text, ie_digito_conta_p text, ie_inclusao_exclusao_p text, nm_usuario_p text, ie_fim_vigencia_p titulo_receber.ie_situacao%type default 'D') AS $body$
DECLARE


/*
IE_FIM_VIGENCIA_P
- Criado para controlar se a forma de encerramento da vigencia no pls_contrato_pagador_fin sera na data passada -1 ou no fim do mes
- Por padrao o dt_fim_vigencia sempre era setado como fim_dua(dt_alteracao_p-1) e a Unimed maringa usa dessa forma, para a unimed rio preto eh necessario finalizar no fim do mes.
- Ja o inicio da vigencia da nova forma de pagamento, antes efetuadava baseado na dt_alteracao_p e para a opcao criada sera iniciada no proximo mes
Opcoes
D = Dia
M = Mes
*/
nr_seq_pagador_w	pls_contrato_pagador.nr_sequencia%type;
nr_seq_pagador_fin_w	pls_contrato_pagador_fin.nr_sequencia%type;
cd_portador_w		portador.cd_portador%type;
cd_tipo_portador_w	portador.cd_tipo_portador%type;
cd_banco_w		portador.cd_banco%type;


BEGIN

if (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> '') then
	nr_seq_pagador_w	:= nr_seq_pagador_p;
else
	select	max(b.nr_seq_pagador)
	into STRICT	nr_seq_pagador_w
	from	pls_segurado_carteira a,
		pls_segurado b
	where	b.nr_sequencia		= a.nr_seq_segurado
	and	a.cd_usuario_plano	= cd_usuario_plano_p;
	
	if (coalesce(nr_seq_pagador_w::text, '') = '') and (coalesce(ie_fim_vigencia_p,'D') = 'M') then
		select	max(b.nr_seq_pagador)
		into STRICT	nr_seq_pagador_w
		from	pls_segurado_carteira a,
			pls_segurado b
		where	b.nr_sequencia		= a.nr_seq_segurado
		and	substr(a.cd_usuario_plano,1,14)	= cd_usuario_plano_p;
	end if;
	
end if;

if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_pagador_fin_w
	from	pls_contrato_pagador_fin
	where	nr_seq_pagador	= nr_seq_pagador_w
	and	trunc(dt_alteracao_p) between trunc(dt_inicio_vigencia,'dd') and fim_dia(coalesce(dt_fim_vigencia,dt_alteracao_p));
	
	if (nr_seq_pagador_fin_w IS NOT NULL AND nr_seq_pagador_fin_w::text <> '') then
		update	pls_contrato_pagador_fin
		set	dt_fim_vigencia = CASE WHEN coalesce(ie_fim_vigencia_p,'D')='M' THEN  fim_mes(dt_alteracao_p)  ELSE fim_dia(dt_alteracao_p - 1) END ,
			nm_usuario_fim_vigencia = nm_usuario_p
		where	nr_sequencia = nr_seq_pagador_fin_w;
		
		begin
		select	cd_portador,
			cd_tipo_portador,
			cd_banco
		into STRICT	cd_portador_w,
			cd_tipo_portador_w,
			cd_banco_w
		from	portador
		where	nr_seq_conta_banco = nr_seq_conta_banco_p;
		exception
		when others then
			cd_portador_w 		:= null;
			cd_tipo_portador_w 	:= null;
			cd_banco_w		:= null;
		end;
		
		insert into pls_contrato_pagador_fin(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_pagador,
				dt_inicio_vigencia,
				nr_seq_forma_cobranca,
				nr_seq_conta_banco_deb_aut,
				cd_portador_deb_aut,
				cd_tipo_portador_deb_aut,
				cd_banco,
				cd_agencia_bancaria,
				ie_digito_agencia,
				cd_conta,
				ie_digito_conta,
				nr_seq_conta_banco,
				dt_dia_vencimento,
				nr_seq_empresa,
				cd_matricula,
				cd_condicao_pagamento,
				cd_profissao,
				nr_seq_vinculo_est,
				cd_tipo_portador,
				cd_portador,
				ie_portador_exclusivo,
				nr_seq_vinculo_empresa,
				ie_mes_vencimento,
				ie_geracao_nota_titulo,
				ie_destacar_reajuste,
				nr_seq_carteira_cobr,
				nr_seq_dia_vencimento,
				ie_gerar_cobr_escrit,
				cd_autenticidade,
				ie_boleto_email,
				ds_observacao,
				nr_pensionista,
				nr_seq_mot_cob)
			SELECT	nextval('pls_contrato_pagador_fin_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_pagador_w,
				CASE WHEN coalesce(ie_fim_vigencia_p,'D')='M' THEN  trunc(add_months(dt_alteracao_p,1),'mm')  ELSE dt_alteracao_p END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN '2'  ELSE '1' END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN nr_seq_conta_banco_p  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_portador_w  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_tipo_portador_w  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_banco_w  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_agencia_bancaria_p  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN ie_digito_agencia_p  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_conta_p  ELSE null END ,
				CASE WHEN ie_inclusao_exclusao_p='I' THEN ie_digito_conta_p  ELSE null END ,
				nr_seq_conta_banco,
				dt_dia_vencimento,
				nr_seq_empresa,
				COALESCE(cd_matricula,CASE WHEN ie_inclusao_exclusao_p='I' THEN cd_usuario_plano_p  ELSE null END ), /*Conforme solicitacao da cliente Carina, OS 1217905*/
				cd_condicao_pagamento,
				cd_profissao,
				nr_seq_vinculo_est,
				cd_tipo_portador,
				cd_portador,
				ie_portador_exclusivo,
				nr_seq_vinculo_empresa,
				ie_mes_vencimento,
				ie_geracao_nota_titulo,
				ie_destacar_reajuste,
				nr_seq_carteira_cobr,
				nr_seq_dia_vencimento,
				ie_gerar_cobr_escrit,
				cd_autenticidade,
				ie_boleto_email,
				ds_observacao,
				nr_pensionista,
				nr_seq_mot_cob
			from	pls_contrato_pagador_fin
			where	nr_sequencia = nr_seq_pagador_fin_w;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inclusao_debito_auto_pag ( nr_seq_pagador_p bigint, cd_usuario_plano_p text, dt_alteracao_p timestamp, nr_seq_conta_banco_p bigint, cd_agencia_bancaria_p text, ie_digito_agencia_p text, cd_conta_p text, ie_digito_conta_p text, ie_inclusao_exclusao_p text, nm_usuario_p text, ie_fim_vigencia_p titulo_receber.ie_situacao%type default 'D') FROM PUBLIC;

