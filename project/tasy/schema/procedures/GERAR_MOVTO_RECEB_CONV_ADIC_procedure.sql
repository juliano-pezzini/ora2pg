-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_receb_conv_adic (cd_estabelecimento_p bigint, nr_seq_receb_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_receb_w			bigint;
VL_ADICIONAL_w			double precision;
NR_SEQ_trans_financ_w		bigint;
NR_lote_contabil_W		bigint;
cd_cgc_convenio_w		varchar(14);
ie_movto_conv_receb_w		varchar(100);
qt_movto_w			integer;
NR_SEQ_MOVTO_W		bigint;
cd_convenio_w			varchar(10);
NR_SEQ_CONTA_BANCO_w	bigint;
dt_recebimento_w		timestamp;
ds_observacao_w        varchar(255);


BEGIN

select	max(nr_seq_trans_financ),
	max(nr_lote_contabil),
	max(vl_adicional),
	max(nr_seq_receb)
Into STRICT	nr_seq_trans_financ_w,
	nr_lote_contabil_w,
	vl_adicional_w,
	nr_seq_receb_w
from 	convenio_receb_adic
where 	nr_sequencia	= nr_seq_receb_p;

select	max(a.NR_SEQ_CONTA_BANCO),
	max(a.cd_convenio),
	coalesce(max(a.dt_recebimento),clock_timestamp()),
	substr(max(a.ds_observacao),1,255)
into STRICT	nr_seq_conta_banco_w,
	cd_convenio_w,
	dt_recebimento_w,
	ds_observacao_w
from	convenio_receb a
where	a.nr_sequencia	= nr_seq_receb_w;

select	max(cd_cgc)
into STRICT	cd_cgc_convenio_w
from	convenio
where	cd_convenio	= cd_convenio_w;

select	coalesce(max(ie_movto_conv_receb),'N')
into STRICT	ie_movto_conv_receb_w
from 	parametro_contas_receber
where 	cd_estabelecimento = cd_estabelecimento_p;

if (NR_SEQ_TRANS_FINANC_w > 0) and
   	((ie_movto_conv_receb_w = 'I') or (ie_movto_conv_receb_w = 'L') ) then

	SELECT	nextval('movto_trans_financ_seq')
	INTO STRICT	NR_SEQ_MOVTO_W
	;

	INSERT	INTO MOVTO_TRANS_FINANC(NR_SEQUENCIA,
		DT_TRANSACAO,
		NR_SEQ_TRANS_FINANC,
		VL_TRANSACAO,
		nr_lote_contabil,
		NR_SEQ_CONV_RECEB,
		NR_SEQ_BANCO,
		dt_atualizacao,
		nm_usuario,
		ie_conciliacao,
		ds_historico
		)
	VALUES (NR_SEQ_MOVTO_W,
		coalesce(dt_recebimento_w,clock_timestamp()),
		NR_SEQ_TRANS_FINanc_W,
		vl_adicional_w,
		0,
		nr_seq_receb_w,
		NR_SEQ_CONTA_BANCO_w,
		clock_timestamp(),
		nm_usuario_p,
		'N',
		ds_observacao_w
		);
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_receb_conv_adic (cd_estabelecimento_p bigint, nr_seq_receb_p bigint, nm_usuario_p text ) FROM PUBLIC;

