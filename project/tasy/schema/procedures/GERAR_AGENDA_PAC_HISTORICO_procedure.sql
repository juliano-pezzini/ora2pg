-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agenda_pac_historico ( nr_seq_origem_p bigint, nr_seq_destino_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, ie_tipo_p text, nr_seq_motivo_p bigint default null, ds_motivo_p text default null) AS $body$
DECLARE

nr_sequencia_w		bigint;
ds_historico_w		varchar(4000);
ds_observacao_origem_w	varchar(4000);
ds_procedimento_w	varchar(255);
hr_inicio_w		timestamp;
hr_inicio_ww		timestamp;
nr_seq_agenda_w     agenda_pac_hist.nr_seq_agenda%type;
ds_motivo_tranf_w	varchar(255):= null;
ds_motivo_w		varchar(255);
ds_agenda_w		varchar(50);
ds_agenda_ww		varchar(50);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(293478, null, wheb_usuario_pck.get_nr_seq_idioma);--Motivo
expressao2_w	varchar(255) := obter_desc_expressao_idioma(344235, null, wheb_usuario_pck.get_nr_seq_idioma);--Obs.:
expressao3_w	varchar(255) := obter_desc_expressao_idioma(774033, null, wheb_usuario_pck.get_nr_seq_idioma);--Agenda Duplicada. Procedimento
expressao4_w	varchar(255) := obter_desc_expressao_idioma(619522, null, wheb_usuario_pck.get_nr_seq_idioma);--Dia:
expressao5_w	varchar(255) := obter_desc_expressao_idioma(774040, null, wheb_usuario_pck.get_nr_seq_idioma);--Agenda Transferida. Procedimento
expressao6_w	varchar(255) := obter_desc_expressao_idioma(618483, null, wheb_usuario_pck.get_nr_seq_idioma);--as
expressao7_w	varchar(255) := obter_desc_expressao_idioma(727816, null, wheb_usuario_pck.get_nr_seq_idioma);--para
BEGIN

select	ds_observacao,
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,200),
	hr_inicio,
	substr(obter_nome_agenda(cd_agenda),1,50)
into STRICT	ds_observacao_origem_w,
	ds_procedimento_w,
	hr_inicio_w,
	ds_agenda_w
from	agenda_paciente
where	nr_sequencia = nr_seq_origem_p;

select	hr_inicio,
	substr(obter_nome_agenda(cd_agenda),1,50)
into STRICT	hr_inicio_ww,
	ds_agenda_ww
from	agenda_paciente
where	nr_sequencia = nr_seq_destino_p;


if (nr_seq_motivo_p IS NOT NULL AND nr_seq_motivo_p::text <> '') then
	select	max(ds_motivo)
	into STRICT	ds_motivo_w
	from    agenda_motivo a
	where   nr_sequencia = nr_seq_motivo_p;
	ds_motivo_tranf_w :=  substr(' ' || expressao1_w || ' = ' || ds_motivo_w ||' - '|| ds_motivo_p,1,255);
end if;


if (ie_tipo_p = 'D') then
	ds_historico_w := substr(expressao2_w || ' ' || ds_observacao_origem_w || ' - ' || expressao3_w || ' : ' || ds_procedimento_w || ' '||expressao4_w||' ' ||
	to_char(hr_inicio_w, 'dd/mm/yyyy hh24:mi:ss'),1,4000);
	nr_seq_agenda_w := nr_seq_destino_p;
else
	ds_historico_w := 	substr(	expressao2_w || ' ' || ds_observacao_origem_w || ' - '||expressao5_w||' : ' || ds_procedimento_w ||
					' '||expressao4_w||' ' || ds_agenda_w || ' '||expressao6_w||' ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(hr_inicio_w,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone) || 
					' '||expressao7_w||' ' || ds_agenda_ww || ' '||expressao6_w||' ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(hr_inicio_ww,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone) || ds_motivo_tranf_w,1,4000);

--	ds_historico_w := 'Obs.: ' || ds_observacao_origem_w || ' - Agenda Transferida. Procedimento : ' || ds_procedimento_w || ' Dia: ' || 

--	to_char(hr_inicio_w, 'dd/mm/yyyy hh24:mi:ss') || ds_motivo_tranf_w;
	nr_seq_agenda_w := nr_seq_origem_p;
end if;

select	nextval('agenda_pac_hist_seq')
into STRICT	nr_sequencia_w
;


insert into agenda_pac_hist(nr_sequencia,
	nr_seq_agenda,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_setor_atend_usuario,
	dt_historico,
	cd_pessoa_fisica,
	nr_seq_tipo,
	ds_historico)
values (nr_sequencia_w,
	nr_seq_agenda_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_setor_atendimento_p,
	clock_timestamp(),
	cd_pessoa_fisica_p,
	null,
	ds_historico_w);
commit;							

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agenda_pac_historico ( nr_seq_origem_p bigint, nr_seq_destino_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, ie_tipo_p text, nr_seq_motivo_p bigint default null, ds_motivo_p text default null) FROM PUBLIC;

