-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE surgery_insert_mipres_material ( NR_PRESCRICAO_P PRESCR_MIPRES.NR_PRESCRICAO%TYPE, NR_CIRURGIA_P PRESCR_MIPRES.NR_CIRURGIA%TYPE ) AS $body$
DECLARE

    TYPE PRESCR_MIPRES_V_TYPE   IS TABLE OF SURGERY_ITEM_MIPRES_MATERIAL_V%ROWTYPE  INDEX BY integer;
    TYPE PRESCR_MIPRES_TYPE     IS TABLE OF PRESCR_MIPRES%ROWTYPE                   INDEX BY integer;

    PRESCR_MIPRES_V_ROW         PRESCR_MIPRES_V_TYPE;
    PRESCR_MIPRES_ROW           PRESCR_MIPRES_TYPE;
    DT_INSERT_W                 CONSTANT PRESCR_MIPRES.DT_ATUALIZACAO%TYPE := clock_timestamp();
BEGIN
  SELECT  DISTINCT
          V.*
  BULK    COLLECT INTO STRICT PRESCR_MIPRES_V_ROW
  FROM    SURGERY_ITEM_MIPRES_MATERIAL_V V
  WHERE (V.NR_PRESCRICAO = NR_PRESCRICAO_P OR V.NR_CIRURGIA = NR_CIRURGIA_P)
  AND     HAS_REGISTER_MIPRES(NR_PRESCRICAO_P, NR_CIRURGIA_P, V.NR_SEQ_ITEM_PRESC, V.IE_TIPO_ITEM_PRESC) = 'N'
  ORDER BY
          V.NR_SEQ_ITEM_PRESC;

  IF (PRESCR_MIPRES_V_ROW.FIRST IS NOT NULL AND PRESCR_MIPRES_V_ROW.FIRST::text <> '') THEN
    FOR I IN PRESCR_MIPRES_V_ROW.FIRST..PRESCR_MIPRES_V_ROW.LAST
    LOOP
      PRESCR_MIPRES_ROW[I].NR_SEQUENCIA         := OBTER_NEXTVAL_SEQUENCE('PRESCR_MIPRES');
      PRESCR_MIPRES_ROW[I].DT_ATUALIZACAO       := DT_INSERT_W;
      PRESCR_MIPRES_ROW[I].DT_ATUALIZACAO_NREC  := DT_INSERT_W;
      PRESCR_MIPRES_ROW[I].NM_USUARIO           := WHEB_USUARIO_PCK.GET_NM_USUARIO;
      PRESCR_MIPRES_ROW[I].NM_USUARIO_NREC      := WHEB_USUARIO_PCK.GET_NM_USUARIO;
      PRESCR_MIPRES_ROW[I].IE_STATUS            := '1';
      PRESCR_MIPRES_ROW[I].NR_PRESCRICAO        := PRESCR_MIPRES_V_ROW[I].NR_PRESCRICAO;
      PRESCR_MIPRES_ROW[I].NR_SEQ_ITEM_PRESC    := PRESCR_MIPRES_V_ROW[I].NR_SEQ_ITEM_PRESC;
      PRESCR_MIPRES_ROW[I].IE_TIPO_ITEM_PRESC   := PRESCR_MIPRES_V_ROW[I].IE_TIPO_ITEM_PRESC;
      PRESCR_MIPRES_ROW[I].NR_CIRURGIA          := PRESCR_MIPRES_V_ROW[I].NR_CIRURGIA;
      PRESCR_MIPRES_ROW[I].NR_ATENDIMENTO       := PRESCR_MIPRES_V_ROW[I].NR_ATENDIMENTO;
      PRESCR_MIPRES_ROW[I].IE_PENDENCY_ORIGIN   := 'CIR';
    END LOOP;
  END IF;

  IF (PRESCR_MIPRES_ROW.FIRST IS NOT NULL AND PRESCR_MIPRES_ROW.FIRST::text <> '') THEN
    FORALL I IN PRESCR_MIPRES_ROW.FIRST..PRESCR_MIPRES_ROW.LAST
      INSERT INTO PRESCR_MIPRES VALUES PRESCR_MIPRES_ROW(I);
    COMMIT;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE surgery_insert_mipres_material ( NR_PRESCRICAO_P PRESCR_MIPRES.NR_PRESCRICAO%TYPE, NR_CIRURGIA_P PRESCR_MIPRES.NR_CIRURGIA%TYPE ) FROM PUBLIC;

