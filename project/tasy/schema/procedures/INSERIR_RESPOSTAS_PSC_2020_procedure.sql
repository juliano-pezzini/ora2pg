-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_respostas_psc_2020 (nm_usuario_p text) AS $body$
DECLARE


qt_registros_w		bigint;
ds_resultado_w		com_psc_respostas.ds_resultado%type;
ds_result_long_w	com_psc_respostas.ds_resultado_long%type;
qt_resultado_w		com_psc_respostas.qt_resultado%type;
nr_seq_item_avaliar_w	com_psc_respostas.nr_seq_item%type;
nr_seq_com_cliente_w	com_psc_respostas.nr_seq_com_cliente%type;
nr_seq_avaliacao_w	com_psc_respostas.nr_seq_avaliacao%type;

BEGIN
	
	begin
		EXECUTE 'delete from com_psc_respostas where nm_usuario = :nm_usuario' using nm_usuario_p;
		EXECUTE 'commit';
	exception
	when others then
		qt_registros_w:= 0;
	end;

	insert into com_psc_respostas(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_resultado,
			ds_resultado_long,
			qt_resultado,
			nr_seq_item,
			nr_seq_com_cliente,
			nr_seq_avaliacao,
			dt_avaliacao,
			nr_seq_tipo_avaliacao
		)	SELECT	nextval('com_psc_respostas_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				(
					case	when(mia.ie_resultado = 'S')
							then (
									SELECT	max(miar.ds_resultado)
									from	med_item_avaliar_res miar
									where	mia.nr_sequencia = miar.nr_seq_item
									and	(mar.qt_resultado)::numeric  = miar.nr_seq_res
								)
						else
							mar.ds_resultado
					end
				) ds_resultado,
				to_lob(mar.ds_result_long) ds_result_long,
				mar.qt_resultado qt_resultado,
				mia.nr_sequencia nr_seq_item_avaliar,
				mep.nr_seq_com_cliente,
				mep.nr_sequencia nr_seq_avaliacao,
				mep.dt_avaliacao,
				mep.nr_seq_tipo_avaliacao
			from	med_tipo_avaliacao mta,
				med_item_avaliar mia,
				med_avaliacao_paciente mep,
				med_avaliacao_result mar
			where	mta.nr_sequencia = mep.nr_seq_tipo_avaliacao
			and	mta.nr_sequencia = mia.nr_seq_tipo
			and	mep.nr_sequencia = mar.nr_seq_avaliacao
			and	mia.nr_sequencia = mar.nr_seq_item
			and	mta.nr_sequencia = 1736;

	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_respostas_psc_2020 (nm_usuario_p text) FROM PUBLIC;

