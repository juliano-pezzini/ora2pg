-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_cred_nao_iden_dep ( nr_seq_cred_nao_ident_p bigint, nr_seq_lote_deposito_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_efetua_baixa_w	varchar(1);
vl_depositar_w		double precision;
vl_juros_w		double precision;
vl_multa_w		double precision;
vl_baixa_w		double precision;
vl_credito_w		double precision;
nr_titulo_w		bigint;
qt_registro_w		bigint;
nr_seq_movto_baixa_w	bigint;
cd_estabelimento_w	smallint;
dt_limite_deposito_w	timestamp;
/* Projeto Multimoeda - Variáveis */

vl_baixa_estrang_w	double precision;
vl_complemento_w	double precision;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_w		integer;
vl_credito_estrang_w	double precision;

C01 CURSOR FOR
	SELECT	nr_titulo,
		coalesce((obter_dados_titulo_receber(nr_titulo,'V'))::numeric ,0),
		coalesce((obter_juros_multa_titulo(nr_titulo,dt_limite_deposito_w,'R','J'))::numeric ,0),
		coalesce((obter_juros_multa_titulo(nr_titulo,dt_limite_deposito_w,'R','M'))::numeric ,0),
		vl_depositar_estrang,
		vl_cotacao,
		cd_moeda
	from	deposito_ident_titulo
	where	nr_seq_deposito = nr_seq_lote_deposito_p;


BEGIN
select	max(cd_estabelecimento),
	max(dt_limite_deposito)
into STRICT	cd_estabelimento_w,
	dt_limite_deposito_w
from	deposito_identificado
where	nr_sequencia = nr_seq_lote_deposito_p;

if (nr_seq_cred_nao_ident_p IS NOT NULL AND nr_seq_cred_nao_ident_p::text <> '') then
	select	a.vl_credito,
		a.vl_credito_estrang
	into STRICT	vl_credito_w,
		vl_credito_estrang_w
	from	movto_banco_pend a
	where	a.nr_sequencia	= nr_seq_cred_nao_ident_p;

	open C01;
	loop
	fetch C01 into
		nr_titulo_w,
		vl_depositar_w,
		vl_juros_w,
		vl_multa_w,
		vl_baixa_estrang_w,
		vl_cotacao_w,
		cd_moeda_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	count(1)
		into STRICT	qt_registro_w
		from	movto_banco_pend_baixa
		where	nr_titulo = nr_titulo_w
		and	nr_seq_deposito_ident	= nr_seq_lote_deposito_p;

		/* Projeto Multimoeda - Verifica se o depósito é moeda estrangeira, caso positivo calcula os valores.*/

		if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
			vl_complemento_w := vl_depositar_w - vl_baixa_estrang_w;
		else
			vl_baixa_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end if;

		if (qt_registro_w = 0) then
			insert into movto_banco_pend_baixa(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_movto_pend,
				dt_baixa,
				vl_baixa,
				vl_juros,
				vl_multa,
				nr_titulo,
				nr_seq_deposito_ident,
				vl_baixa_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			values (nextval('movto_banco_pend_baixa_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_cred_nao_ident_p,
				clock_timestamp(),
				vl_depositar_w,
				vl_juros_w,
				vl_multa_w,
				nr_titulo_w,
				nr_seq_lote_deposito_p,
				vl_baixa_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_w);
		end if;
		end;
	end loop;
	close C01;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_movto_baixa_w
	from	movto_banco_pend_baixa	a
	where	a.nr_seq_deposito_ident	= nr_seq_lote_deposito_p
	and	a.nr_seq_movto_pend	= nr_seq_cred_nao_ident_p;

	select	sum(coalesce(a.vl_baixa,0)) + sum(coalesce(a.vl_juros,0)) + sum(coalesce(a.vl_multa,0)),
		sum(coalesce(a.vl_baixa_estrang,0))
	into STRICT	vl_baixa_w,
		vl_baixa_estrang_w
	from	movto_banco_pend_baixa	a
	where	a.nr_seq_deposito_ident	= nr_seq_lote_deposito_p
	and	a.nr_seq_movto_pend	= nr_seq_cred_nao_ident_p;

	if (vl_baixa_w <> vl_credito_w) then -- Arredondamento
		update	movto_banco_pend_baixa
		set	vl_baixa	= vl_baixa + (vl_credito_w - vl_baixa_w)
		where	nr_sequencia	= nr_seq_movto_baixa_w;
	end if;
	/* Projeto Multimoeda - Atualiza o valor em moeda estrangeira quando o crédito é em moeda estrangeira.*/

	if (coalesce(vl_credito_estrang_w,0) <> 0 and coalesce(vl_baixa_estrang_w,0) <> 0) then
		if (vl_baixa_estrang_w <> vl_credito_estrang_w) then
			update	movto_banco_pend_baixa
			set	vl_baixa_estrang = vl_baixa_estrang + (vl_credito_estrang_w - vl_baixa_estrang_w)
			where	nr_sequencia = nr_seq_movto_baixa_w;
		end if;
	end if;

	CALL atualizar_saldo_movto_bco_pend(nr_seq_cred_nao_ident_p,nm_usuario_p,'N');
end if;

/* Baixar automaticamente o depósito ao vincular o crédito não identificado */

ie_efetua_baixa_w := obter_param_usuario(9054, 7, obter_perfil_ativo, nm_usuario_p, cd_estabelimento_w, ie_efetua_baixa_w);

if (coalesce(ie_efetua_baixa_w,'N') = 'S') then
	CALL baixar_itens_deposito_iden(nr_seq_lote_deposito_p,cd_estabelimento_w,nm_usuario_p,'N', null);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_cred_nao_iden_dep ( nr_seq_cred_nao_ident_p bigint, nr_seq_lote_deposito_p bigint, nm_usuario_p text) FROM PUBLIC;

