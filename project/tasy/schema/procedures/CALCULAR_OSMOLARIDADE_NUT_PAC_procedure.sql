-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_osmolaridade_nut_pac ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


VarFormulaOsmNPT_w				varchar(1);
qt_volume_diario_w				double precision;
qt_peso_w						double precision;
qt_vol_lipidio_w				double precision;
qt_vol_glicose_w				double precision;
qt_vol_magnesio_w				double precision;
qt_vol_calcio_w					double precision;
qt_vol_sodio_w					double precision;
qt_vol_potassio_w				double precision;
qt_vol_proteina_w				double precision;
qt_diaria_aa_w					double precision;
qt_vol_eletro_w					double precision;
qt_vol_fosforo_w				double precision;
qt_osmolaridade_total_w			double precision;


BEGIN
VarFormulaOsmNPT_w := Obter_Param_Usuario(924, 1080, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarFormulaOsmNPT_w);

select	max(qt_volume_diario),
		max(coalesce(qt_peso_ajustado,qt_peso))
into STRICT	qt_volume_diario_w,
		qt_peso_w
from 	nut_pac
where	nr_sequencia = nr_sequencia_p;

if (coalesce(qt_volume_diario_w,0) > 0) then

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_lipidio_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'L';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_glicose_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'C';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_proteina_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'P';

	select (coalesce(sum(a.qt_diaria),0))
	into STRICT	qt_vol_sodio_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'N';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_magnesio_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'M';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_calcio_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'I';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_potassio_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'K';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_eletro_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'E';

	select	coalesce(sum(a.qt_diaria),0)
	into STRICT	qt_vol_fosforo_w
	from	nut_elemento b,
			nut_pac_elemento a
	where	a.nr_seq_nut_pac	= nr_sequencia_p
	and		a.nr_seq_elemento	= b.nr_sequencia
	and		b.ie_tipo_elemento	= 'F';

	if (VarFormulaOsmNPT_w = 'P') then
		qt_osmolaridade_total_w	:= (((qt_vol_proteina_w * 10) + (qt_vol_lipidio_w * 0.27) + (qt_vol_glicose_w * 5) + (( qt_vol_sodio_w + qt_vol_potassio_w + qt_vol_magnesio_w + qt_vol_calcio_w) * 2)) / qt_volume_diario_w) *1000;
	elsif (VarFormulaOsmNPT_w = 'C') then
		qt_osmolaridade_total_w	:= ((qt_vol_proteina_w * 11) + (qt_vol_glicose_w * 5.5) + (qt_vol_lipidio_w * 0.3) + (qt_vol_sodio_w + qt_vol_potassio_w + qt_vol_magnesio_w + qt_vol_calcio_w + qt_vol_fosforo_w)) * 1000;
	else
		select	coalesce(sum(a.qt_diaria),0)
		into STRICT	qt_vol_lipidio_w
		from	nut_elemento b,
				nut_pac_elemento a
		where	a.nr_seq_nut_pac	= nr_sequencia_p
		and		a.nr_seq_elemento	= b.nr_sequencia
		and		b.ie_tipo_elemento	= 'L'
		and 	coalesce(a.ie_prod_adicional,'N') = 'N';

		select	coalesce(sum(a.qt_diaria),0)
		into STRICT	qt_vol_glicose_w
		from	nut_elemento b,
				nut_pac_elemento a
		where	a.nr_seq_nut_pac	= nr_sequencia_p
		and		a.nr_seq_elemento	= b.nr_sequencia
		and		b.ie_tipo_elemento	= 'C'
		and 	coalesce(a.ie_prod_adicional,'N') = 'N';

		select	coalesce(sum(a.qt_diaria),0)
		into STRICT	qt_diaria_aa_w
		from	nut_elemento b,
				nut_pac_elemento a
		where	a.nr_seq_nut_pac	= nr_sequencia_p
		and		a.nr_seq_elemento	= b.nr_sequencia
		and		b.ie_tipo_elemento	= 'P'
		and 	coalesce(a.ie_prod_adicional,'N') = 'N';

		select	coalesce(sum(a.qt_diaria),0)
		into STRICT	qt_vol_eletro_w
		from	nut_elemento b,
				nut_pac_elemento a
		where	a.nr_seq_nut_pac	= nr_sequencia_p
		and		a.nr_seq_elemento	= b.nr_sequencia
		and		b.ie_tipo_elemento	= 'E'
		and 	coalesce(a.ie_prod_adicional,'N') = 'N';

		select	coalesce(sum(a.qt_diaria),0)
		into STRICT	qt_vol_fosforo_w
		from	nut_elemento b,
				nut_pac_elemento a
		where	a.nr_seq_nut_pac	= nr_sequencia_p
		and		a.nr_seq_elemento	= b.nr_sequencia
		and		b.ie_tipo_elemento	= 'F'
		and 	coalesce(a.ie_prod_adicional,'N') = 'N';

		if (VarFormulaOsmNPT_w = 'E') then
			qt_volume_diario_w := qt_volume_diario_w+30;
		end if;
		qt_osmolaridade_total_w	:= dividir_sem_round(((qt_diaria_aa_w * 11) + (qt_vol_glicose_w * 5.5) + (qt_vol_lipidio_w * 0.3) + ((qt_vol_sodio_w + qt_vol_potassio_w + qt_vol_magnesio_w + qt_vol_calcio_w) *2)),qt_volume_diario_w) * 1000;
	end if;

	update	Nut_pac
	set		qt_osmolaridade_total	= qt_osmolaridade_total_w
	where	nr_sequencia			= nr_sequencia_p;
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_osmolaridade_nut_pac ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

