-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_notific_automatica ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_mostrar_mensagem_p INOUT text) AS $body$
DECLARE


ie_tipo_guia_w					varchar(4);
ie_acao_notificacao_w			        smallint;
nr_telef_celular_benef_w		        varchar(15);
nr_seq_regra_notif_w			        bigint;
ds_notificacao_w				varchar(4000);
ie_estagio_req_w				smallint;
ie_valida_qtde_igual_regra_w	                varchar(1) := 'S';
qt_item_w					bigint;
qt_item_igual_w					bigint;
nr_seq_requisicao_w				bigint;
nr_seq_guia_w					bigint;
ie_tipo_segurado_w                              varchar(3);
nr_seq_notif_w                                  bigint;
nr_seq_segurado_w                               bigint;
ie_tipo_segurado_guia_req_w                     varchar(3);

ie_tipo_processo_w				pls_regra_notificacao_aut.ie_tipo_processo%type;
ie_carater_atendimento_w		        pls_regra_notificacao_aut.ie_carater_atendimento%type;


C01 CURSOR FOR
	SELECT	ie_acao_notificacao,
		ds_notificacao,
                nr_Sequencia
	from	pls_regra_notificacao_aut
	where	ie_situacao			= 'A'
	and (coalesce(ie_tipo_guia::text, '') = ''	or	ie_tipo_guia		= ie_tipo_guia_w)
	and (coalesce(ie_estagio_requisicao::text, '') = '' or	ie_estagio_requisicao	= ie_estagio_req_w)
	and (ie_celular		= 'S'	or (ie_celular		= 'N'	and	(nr_telef_celular_benef_w IS NOT NULL AND nr_telef_celular_benef_w::text <> '')))
	and (coalesce(ie_quantidade_igual::text, '') = '' or	ie_quantidade_igual 	= ie_valida_qtde_igual_regra_w)
	and (coalesce(ie_tipo_processo::text, '') = ''	or	ie_tipo_processo        = ie_tipo_processo_w)
	and (coalesce(ie_carater_atendimento::text, '') = '' or      ie_carater_atendimento  = ie_carater_atendimento_w)
	and (coalesce(cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento AND pls_obter_se_controle_estab('RE') = 'S')
	
UNION

	SELECT	ie_acao_notificacao,
			ds_notificacao,
			nr_Sequencia
	from	pls_regra_notificacao_aut
	where	ie_situacao			= 'A'
	and (coalesce(ie_tipo_guia::text, '') = ''	or	ie_tipo_guia		= ie_tipo_guia_w)
	and (coalesce(ie_estagio_requisicao::text, '') = '' or	ie_estagio_requisicao	= ie_estagio_req_w)
	and (ie_celular		= 'S'	or (ie_celular		= 'N'	and	(nr_telef_celular_benef_w IS NOT NULL AND nr_telef_celular_benef_w::text <> '')))
	and (coalesce(ie_quantidade_igual::text, '') = '' or	ie_quantidade_igual 	= ie_valida_qtde_igual_regra_w)
	and (coalesce(ie_tipo_processo::text, '') = ''	or	ie_tipo_processo        = ie_tipo_processo_w)
	and (coalesce(ie_carater_atendimento::text, '') = '' or      ie_carater_atendimento  = ie_carater_atendimento_w)
	and pls_obter_se_controle_estab('RE') = 'N';

C02 CURSOR FOR
        SELECT  ie_tipo_segurado
        from    pls_excecao_reg_notif_aut
        where   nr_seq_regra_notif      = nr_seq_notif_w
        and     ie_situacao		= 'A';


BEGIN
ie_mostrar_mensagem_p	:= 'N';

begin
	select	ie_tipo_guia,
		nr_telef_celular_benef,
		nr_seq_requisicao,
		nr_seq_guia
	into STRICT	ie_tipo_guia_w,
		nr_telef_celular_benef_w,
		nr_seq_requisicao_w,
		nr_seq_guia_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_auditoria_p;
exception
when others then
	ie_tipo_guia_w			:= null;
	nr_telef_celular_benef_w	:= null;
end;

if (coalesce(nr_seq_requisicao_w,0) > 0) then
	select	ie_estagio,
		ie_carater_atendimento,
		ie_tipo_processo,
                nr_seq_segurado
	into STRICT	ie_estagio_req_w,
		ie_carater_atendimento_w,
		ie_tipo_processo_w,
                nr_seq_segurado_w
	from	pls_requisicao
	where	nr_sequencia = nr_seq_requisicao_w;
end if;

if (coalesce(nr_seq_guia_w,0) > 0) then
	select	ie_carater_internacao,
		ie_tipo_processo,
                nr_seq_segurado
	into STRICT	ie_carater_atendimento_w,
		ie_tipo_processo_w,
                nr_seq_segurado_w
	from	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_w;
end if;

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
        select  ie_tipo_segurado
        into STRICT    ie_tipo_segurado_guia_req_w
        from    pls_segurado
        where   nr_sequencia = nr_seq_segurado_w;
end if;


select	count(1)
into STRICT	qt_item_w
from	pls_auditoria_item
where	nr_seq_auditoria = nr_seq_auditoria_p
and	ie_status = 'A';

select	count(1)
into STRICT	qt_item_igual_w
from	pls_auditoria_item
where	nr_seq_auditoria = nr_seq_auditoria_p
and	qt_original = qt_ajuste
and	ie_status = 'A';

if (qt_item_w <> qt_item_igual_w) then
	ie_valida_qtde_igual_regra_w := 'N';
end if;

open C01;
loop
fetch C01 into
	ie_acao_notificacao_w,
	ds_notificacao_w,
        nr_seq_notif_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		ie_tipo_segurado_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (ie_tipo_segurado_w	=	ie_tipo_segurado_guia_req_w) then
			ie_acao_notificacao_w	:= 0;
			exit;
		end if;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

if (coalesce(ie_acao_notificacao_w,0)	= 1) then
	CALL pls_solicita_notif_atendimento(nr_seq_auditoria_p,coalesce(ds_notificacao_w,'Sem descrição'), nm_usuario_p);
elsif (coalesce(ie_acao_notificacao_w,0)	= 2) then
	ie_mostrar_mensagem_p	:= 'S';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_notific_automatica ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_mostrar_mensagem_p INOUT text) FROM PUBLIC;

