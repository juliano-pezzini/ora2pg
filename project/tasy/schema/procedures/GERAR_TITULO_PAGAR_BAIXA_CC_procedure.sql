-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_pagar_baixa_cc ( nr_titulo_p bigint, nr_sequencia_p bigint, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w			bigint;
cd_conta_contabil_w		varchar(20);
cd_estabelecimento_w		bigint;
ie_gerar_classif_baixa_w		varchar(1);
nr_sequencia_w			bigint;
nr_seq_classif_w			bigint;
cd_conta_financ_w			bigint;
pr_baixa_w			double precision;
vl_baixa_w			double precision;
vl_titulo_classif_w			double precision;
vl_titulo_w			double precision;
vl_total_cc_w			double precision;
vl_desconto_w			double precision;
vl_total_juros_cc_w		double precision;
vl_total_multa_cc_w		double precision;
vl_total_desconto_cc_w		double precision;
vl_total_outros_acresc_cc_w	double precision;
vl_total_outras_despesas_cc_w titulo_pagar_baixa_cc.vl_outras_despesas%type;
vl_juros_w			double precision;
vl_multa_w			double precision;
vl_outros_acrescimos_w		double precision;
VL_OUTRAS_DESPESAS_W titulo_pagar_baixa_cc.vl_outras_despesas%type;
vl_baixa_cc_w			double precision;
vl_juros_cc_w			double precision;
vl_multa_cc_w			double precision;
vl_desconto_cc_w		double precision;
vl_outros_acrescimos_cc_w	double precision;
vl_outras_despesas_cc_w	titulo_pagar_baixa_cc.vl_outras_despesas%type;
vl_tit_desconto_w		double precision;
vl_pago_cc_w			double precision;
vl_pago_w			double precision;
vl_total_pago_cc_w		double precision;
qtd_w				integer;
/* Projeto Multimoeda - Variáveis */

vl_baixa_estrang_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
vl_baixa_estrang_cc_w		double precision;
vl_complemento_cc_w		double precision;
vl_total_estrang_cc_w		double precision;

c01 CURSOR FOR
SELECT	a.nr_sequencia nr_seq_classif,
	a.cd_centro_custo,
	a.cd_conta_contabil,
	a.vl_titulo,
	a.vl_desconto,
	a.nr_seq_conta_financ
from	titulo_pagar_classif a
where	a.nr_titulo	= nr_titulo_p
and	not exists (	SELECT	1
			from	titulo_pagar_baixa_cc y
			where	y.nr_titulo	= nr_titulo_p
			and	y.nr_seq_baixa	= nr_sequencia_p)
order by 1;


BEGIN

delete	from titulo_pagar_baixa_cc
where	nr_titulo		= nr_titulo_p
and	nr_seq_baixa	= nr_sequencia_p;

select	coalesce(max(vl_titulo),0),
	max(cd_estabelecimento)
into STRICT	vl_titulo_w,
	cd_estabelecimento_w
from	titulo_pagar
where	nr_titulo	= nr_titulo_p;

select count(*)
into STRICT 	qtd_w
from	titulo_pagar_baixa
where	nr_titulo	= nr_titulo_p
and	nr_sequencia	= nr_sequencia_p;

if (qtd_w > 0) 	then
	select	vl_baixa,
		vl_juros,
		vl_multa,
		vl_descontos,
		vl_outros_acrescimos,
		VL_OUTRAS_DESPESAS,
		vl_pago,
		vl_baixa_estrang,
		vl_cotacao,
		cd_moeda
	into STRICT	vl_baixa_w,
		vl_juros_w,
		vl_multa_w,
		vl_tit_desconto_w,
		vl_outros_acrescimos_w,
		VL_OUTRAS_DESPESAS_W,
		vl_pago_w,
		vl_baixa_estrang_w,
		vl_cotacao_w,
		cd_moeda_w
	from	titulo_pagar_baixa
	where	nr_titulo	= nr_titulo_p
	and	nr_sequencia	= nr_sequencia_p;
end if;


select	coalesce(max(ie_gerar_classif_baixa),'N')
into STRICT	ie_gerar_classif_baixa_w
from	parametros_contas_pagar
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_gerar_classif_baixa_w = 'S') then
	begin
	open C01;
	loop
	fetch C01 into	
		nr_seq_classif_w,
		cd_centro_custo_w,
		cd_conta_contabil_w,
		vl_titulo_classif_w,
		vl_desconto_w,
		cd_conta_financ_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('titulo_pagar_baixa_cc_seq')
		into STRICT	nr_sequencia_w
		;

		vl_baixa_cc_w			:= dividir_sem_round(vl_baixa_w , vl_titulo_w) * vl_titulo_classif_w;
		vl_juros_cc_w			:= dividir_sem_round(vl_juros_w , vl_titulo_w) * vl_titulo_classif_w;
		vl_multa_cc_w			:= dividir_sem_round(vl_multa_w , vl_titulo_w) * vl_titulo_classif_w;
		vl_desconto_cc_w		:= dividir_sem_round(vl_tit_desconto_w , vl_titulo_w) * vl_titulo_classif_w;
		vl_outros_acrescimos_cc_w	:= dividir_sem_round(vl_outros_acrescimos_w , vl_titulo_w) * vl_titulo_classif_w;
		vl_outras_despesas_cc_w	:= dividir_sem_round(VL_OUTRAS_DESPESAS_W , vl_titulo_w) * vl_titulo_classif_w;
		vl_pago_cc_w			:= dividir_sem_round(vl_pago_w , vl_titulo_w) * vl_titulo_classif_w;
		/* Projeto Multimoeda - realiza o rateio do valor da baixa em moeda estrangeira, caso exista*/

		if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
			vl_baixa_estrang_cc_w	:= dividir_sem_round(vl_baixa_estrang_w, (vl_titulo_w / vl_cotacao_w)) * (vl_titulo_classif_w / vl_cotacao_w);
			vl_complemento_cc_w	:= vl_baixa_cc_w - vl_baixa_estrang_cc_w;
		else
			vl_baixa_estrang_cc_w	:= null;
			vl_complemento_cc_w	:= null;
			vl_cotacao_w		:= null;
			cd_moeda_w		:= null;
		end if;
		
		insert into titulo_pagar_baixa_cc(
			nr_sequencia,
			nr_titulo,
			nr_seq_baixa, 
			cd_centro_custo,
			cd_conta_contabil,
			vl_baixa, 
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec, 
			nm_usuario_nrec,
			cd_conta_financ,
			vl_juros,
			vl_multa,
			vl_desconto,
			vl_outros_acrescimos,
			VL_OUTRAS_DESPESAS,
			vl_pago,
			nr_seq_classif,
			vl_baixa_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda)
		values (	nr_sequencia_w,
			nr_titulo_p,
			nr_sequencia_p, 
			cd_centro_custo_w,
			cd_conta_contabil_w,
			vl_baixa_cc_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_financ_w,
			vl_juros_cc_w,
			vl_multa_cc_w,
			vl_desconto_cc_w,
			vl_outros_acrescimos_cc_w,
			vl_outras_despesas_cc_w,
			vl_pago_cc_w,
			nr_seq_classif_w,
			vl_baixa_estrang_cc_w,
			vl_complemento_cc_w,
			vl_cotacao_w,
			cd_moeda_w);
		end;
	end loop;
	close C01;

	select	coalesce(sum(vl_baixa), 0),
		coalesce(sum(vl_juros), 0),
		coalesce(sum(vl_multa), 0),
		coalesce(sum(vl_desconto), 0),
		coalesce(sum(vl_outros_acrescimos), 0),
		coalesce(sum(VL_OUTRAS_DESPESAS), 0),
		coalesce(sum(vl_pago), 0),
		coalesce(sum(vl_baixa_estrang), 0)
	into STRICT	vl_total_cc_w,
		vl_total_juros_cc_w,
		vl_total_multa_cc_w,
		vl_total_desconto_cc_w,
		vl_total_outros_acresc_cc_w,
		vl_total_outras_despesas_cc_w,
		vl_total_pago_cc_w,
		vl_total_estrang_cc_w
	from	titulo_pagar_baixa_cc
	where	nr_titulo	= nr_titulo_p
	and	nr_seq_baixa	= nr_sequencia_p;

	if (vl_total_cc_w <> vl_baixa_w) or (vl_total_juros_cc_w <> vl_juros_w) or (vl_total_multa_cc_w <> vl_multa_w) or (vl_total_desconto_cc_w <> vl_tit_desconto_w) or (vl_total_outros_acresc_cc_w <> vl_outros_acrescimos_w) or (vl_total_outras_despesas_cc_w <> VL_OUTRAS_DESPESAS_W) or (vl_total_pago_cc_w <> vl_pago_w) then
		update	titulo_pagar_baixa_cc
		set	vl_baixa		= vl_baixa + vl_baixa_w - vl_total_cc_w,
			vl_juros		= vl_juros + vl_juros_w - vl_total_juros_cc_w,
			vl_multa		= vl_multa + vl_multa_w - vl_total_multa_cc_w,
			vl_desconto		= vl_desconto + vl_tit_desconto_w - vl_total_desconto_cc_w,
			vl_outros_acrescimos	= vl_outros_acrescimos + vl_outros_acrescimos_w - vl_total_outros_acresc_cc_w,
			VL_OUTRAS_DESPESAS	= VL_OUTRAS_DESPESAS + VL_OUTRAS_DESPESAS_W - vl_total_outras_despesas_cc_w,
			vl_pago			= vl_pago + vl_pago_w - vl_total_pago_cc_w
		where	nr_sequencia	= nr_sequencia_w;
	end if;
	
	/* Projeto Multimoeda - verifica diferença entre a soma dos centros de custo e o valor da baixa do título em moeda estrangeira - mesmo processo executado em moeda nacional*/

	if (vl_total_estrang_cc_w <> vl_baixa_estrang_w) then
		update	titulo_pagar_baixa_cc
		set	vl_baixa_estrang	= vl_baixa_estrang + vl_baixa_estrang_w - vl_total_estrang_cc_w,
			vl_complemento		= vl_baixa - (vl_baixa_estrang + vl_baixa_estrang_w - vl_total_estrang_cc_w)
		where	nr_sequencia	= nr_sequencia_w;
	end if;

	if (ie_commit_p = 'S') then
		commit;
	end if;
	end;
	
	CALL gerar_titulo_pagar_baixa_ops(	nr_titulo_p,
					nr_sequencia_p,
					wheb_usuario_pck.get_cd_estabelecimento,
					nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_pagar_baixa_cc ( nr_titulo_p bigint, nr_sequencia_p bigint, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

