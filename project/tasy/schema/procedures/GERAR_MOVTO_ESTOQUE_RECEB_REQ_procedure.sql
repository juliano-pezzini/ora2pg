-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_estoque_receb_req ( nr_requisicao_p bigint, nr_sequencia_p bigint, ie_tipo_recebimento_p text, qt_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
ie_tipo_recebimento_p
recebimento por barras 	 = rb
normal = n
*/
dt_atualizacao_w          		timestamp := clock_timestamp();
dt_atendimento_w			timestamp;
cd_operacao_estoque_w		smallint;
cd_operacao_correspondente_w	smallint := 0;
ie_entrada_saida_w			varchar(1);
cd_estabelecimento_w		smallint;
cd_local_estoque_w		smallint;
cd_local_estoque_destino_w		smallint;
nr_seq_lote_fornec_w		bigint;
dt_validade_w			timestamp;
ds_lote_fornec_w			varchar(20);
qt_material_atendida_w		double precision;
qt_material_requisitada_w		double precision;
cd_material_w			integer;
cd_cgc_fornecedor_w		varchar(14);
qt_existe_w			bigint;
nr_seq_cor_w			bigint;
dt_recebimento_w			timestamp;
cd_motivo_baixa_w			bigint;
qt_mat_recebida_w			double precision;
qt_material_req_w			double precision := 0;
ie_permite_receb_parcial_w		varchar(1)  := 'N';
ie_tipo_recebimento_w		varchar(2);
ie_tipo_requisicao_w		varchar(3);
nr_seq_kit_estoque_w		item_requisicao_material.nr_seq_kit_estoque%type;
ie_origem_requisicao_w		requisicao_material.ie_origem_requisicao%type;
ie_consiste_quant_w		varchar(2);
ie_consiste_material_w		varchar(2);
qt_material_w			double precision;
qt_material_kit_comp_w		kit_estoque_comp.qt_material%type;
nr_seq_kit_estoque_comp_w		kit_estoque_comp.nr_sequencia%type;
ds_erro_w			varchar(255);
nr_seq_novo_item_w		item_requisicao_material.nr_sequencia%type;
qt_desdobrar_w			item_requisicao_material.qt_material_requisitada%type;

c01 CURSOR FOR
SELECT	a.qt_material,
	nr_sequencia
from	kit_estoque_comp a
where	nr_seq_kit_estoque = nr_seq_kit_estoque_w
and 	ie_gerado_barras = 'N'
and	cd_material = cd_material_w
and	coalesce(nr_seq_lote_fornec,coalesce(nr_seq_lote_fornec_w,0)) = coalesce(nr_seq_lote_fornec_w,0)
order	by nr_seq_lote_fornec;


BEGIN
ie_tipo_recebimento_w 	:= coalesce(ie_tipo_recebimento_p,'N');
qt_material_w 		:= qt_material_p;
ie_consiste_quant_w	:= obter_parametro_usuario_js(143,44);
ie_consiste_material_w	:= obter_parametro_usuario_js(143,55);

select	a.cd_estabelecimento,
	a.cd_operacao_estoque,
	coalesce(b.cd_material_lido, b.cd_material),
	b.cd_cgc_fornecedor,
	b.dt_atendimento,
	b.nr_seq_lote_fornec,
	coalesce(b.qt_material_atendida,0),
	qt_material_requisitada_w,
	b.dt_recebimento,
	obter_tipo_motivo_baixa_req(b.cd_motivo_baixa),
	coalesce(nr_seq_kit_estoque,0),
	coalesce(ie_origem_requisicao,'')
into STRICT	cd_estabelecimento_w,
	cd_operacao_estoque_w,
	cd_material_w,
	cd_cgc_fornecedor_w,
	dt_atendimento_w,
	nr_seq_lote_fornec_w,
	qt_material_atendida_w,
	qt_material_requisitada_w,
	dt_recebimento_w,
	cd_motivo_baixa_w,
	nr_seq_kit_estoque_w,
	ie_origem_requisicao_w
from	requisicao_material a,
	item_requisicao_material b
where	a.nr_requisicao = b.nr_requisicao
and	b.nr_requisicao = nr_requisicao_p
and	b.nr_sequencia  = nr_sequencia_p;

if (dt_recebimento_w IS NOT NULL AND dt_recebimento_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(223862);
end if;

if (cd_motivo_baixa_w not in (1,4)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(223863);
end if;

ie_permite_receb_parcial_w := obter_param_usuario(109, 92, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_receb_parcial_w);

select	ie_tipo_requisicao
into STRICT	ie_tipo_requisicao_w
from	operacao_estoque
where	cd_operacao_estoque = cd_operacao_estoque_w;

select	CASE WHEN ie_entrada_saida='S' THEN  cd_operacao_correspondente  ELSE cd_operacao_estoque END ,
	ie_entrada_saida
into STRICT	cd_operacao_estoque_w,
	ie_entrada_saida_w
from	operacao_estoque
where	cd_operacao_estoque  = cd_operacao_estoque_w;

select	CASE WHEN ie_entrada_saida_w='S' THEN  cd_local_estoque_destino  ELSE cd_local_estoque END ,
	CASE WHEN ie_entrada_saida_w='S' THEN  cd_local_estoque  ELSE cd_local_estoque_destino END
into STRICT	cd_local_estoque_w,
	cd_local_estoque_destino_w
from	requisicao_material a
where	a.nr_requisicao  = nr_requisicao_p;

if (nr_seq_lote_fornec_w IS NOT NULL AND nr_seq_lote_fornec_w::text <> '') then
	select	dt_validade,
		ds_lote_fornec
	into STRICT	dt_validade_w,
		ds_lote_fornec_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_w;
end if;

qt_material_req_w := qt_material_atendida_w;
if (coalesce(ie_permite_receb_parcial_w,'N') = 'Q') and (coalesce(qt_material_p,0) > 0 or ie_tipo_recebimento_w = 'RB') then
	qt_material_req_w := qt_material_p;
end if;

if (coalesce(qt_material_req_w,0) > 0) and (ie_tipo_requisicao_w = '21') then
	begin
	insert into movimento_estoque(
		nr_movimento_estoque,
		cd_estabelecimento,
		cd_local_estoque,
		dt_movimento_estoque,
		cd_operacao_estoque,
		cd_acao,
		cd_material,
		dt_mesano_referencia,
		qt_movimento,
		dt_atualizacao,
		nm_usuario,
		ie_origem_documento,
		nr_documento,
		nr_sequencia_item_docto,
		nr_sequencia_documento,
		vl_movimento,
		cd_unidade_medida_estoque,
		cd_setor_atendimento,
		qt_estoque,
		cd_local_estoque_destino,
		cd_centro_custo,
		cd_unidade_med_mov,
		cd_conta_contabil,
		cd_fornecedor,
		nr_seq_lote_fornec,
		dt_validade,
		cd_lote_fabricacao)
	SELECT	nextval('movimento_estoque_seq'),
		a.cd_estabelecimento,
		cd_local_estoque_w,
		dt_atendimento_w,
		cd_operacao_estoque_w,
		'1',
		cd_material_w,
		dt_atendimento_w,
		qt_material_req_w,
		dt_atualizacao_w,
		nm_usuario_p,
		'2',
		a.nr_requisicao,
		b.nr_sequencia,
		0,
		0,
		b.cd_unidade_medida_estoque,
		a.cd_setor_atendimento,
		qt_material_req_w,
		cd_local_estoque_destino_w,
		a.cd_centro_custo,
		b.cd_unidade_medida,
		b.cd_conta_contabil,
		b.cd_cgc_fornecedor,
		nr_seq_lote_fornec_w,
		dt_validade_w,
		ds_lote_fornec_w
	from	requisicao_material a,
		item_requisicao_material b
	where	a.nr_requisicao = b.nr_requisicao
	and	b.nr_requisicao = nr_requisicao_p
	and	b.nr_sequencia  = nr_sequencia_p;

	qt_desdobrar_w	:=	coalesce(qt_material_atendida_w,0) - coalesce(qt_material_req_w,0);

	if (qt_desdobrar_w > 0) then
		begin
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_novo_item_w
		from	item_requisicao_material
		where	nr_requisicao = nr_requisicao_p;

		insert into item_requisicao_material(
			nr_requisicao,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			qt_material_atendida,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			dt_atendimento,
			cd_pessoa_recebe,
			cd_pessoa_atende,
			ie_acao,
			cd_motivo_baixa,
			qt_estoque,
			cd_unidade_medida_estoque,
			cd_conta_contabil,
			cd_material_req,
			nr_seq_lote_fornec,
			cd_cgc_fornecedor,
			ds_observacao,
			ie_geracao,
			nr_seq_cor_exec,
			vl_preco_venda,
			nm_usuario_retirada,
			cd_material_lido,
			ds_justificativa,
			nr_seq_etapa_gpi,
			nr_documento_externo,
			nr_item_docto_externo,
			nr_seq_aprovacao,
			dt_aprovacao,
			nm_usuario_aprov,
			vl_unit_previsto,
			dt_reprovacao,
			ie_msg_estoque_max,
			qt_estoque_superou,
			cd_kit_material,
			ds_justificativa_atend,
			cd_processo_aprov,
			qt_saldo_estoque_dest,
			qt_saldo_estoque,
			dt_desdobr_aprov,
			dt_dispensacao,
			dt_recebimento,
			nm_usuario_receb,
			nm_usuario_disp,
			ie_motivo_reprovacao,
			ds_justificativa_reprov,
			nr_seq_kit_estoque,
			qt_material_req_auto,
			nr_seq_proc_aprov,
			nr_seq_nota_fiscal,
			cd_barras,
			nr_seq_justificativa)
		SELECT	nr_requisicao,
			nr_seq_novo_item_w,
			cd_estabelecimento,
			cd_material,
			qt_desdobrar_w,
			qt_desdobrar_w,
			dividir(vl_material, qt_material_requisitada) * qt_desdobrar_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida,
			dt_atendimento,
			cd_pessoa_recebe,
			cd_pessoa_atende,
			ie_acao,
			cd_motivo_baixa,
			dividir(qt_estoque, qt_material_requisitada) * qt_desdobrar_w,
			cd_unidade_medida_estoque,
			cd_conta_contabil,
			cd_material_req,
			nr_seq_lote_fornec,
			cd_cgc_fornecedor,
			ds_observacao,
			ie_geracao,
			nr_seq_cor_exec,
			vl_preco_venda,
			nm_usuario_retirada,
			cd_material_lido,
			ds_justificativa,
			nr_seq_etapa_gpi,
			nr_documento_externo,
			nr_item_docto_externo,
			nr_seq_aprovacao,
			dt_aprovacao,
			nm_usuario_aprov,
			vl_unit_previsto,
			dt_reprovacao,
			ie_msg_estoque_max,
			0,
			cd_kit_material,
			ds_justificativa_atend,
			cd_processo_aprov,
			qt_saldo_estoque_dest,
			qt_saldo_estoque,
			dt_desdobr_aprov,
			dt_dispensacao,
			null,
			null,
			nm_usuario_disp,
			ie_motivo_reprovacao,
			ds_justificativa_reprov,
			nr_seq_kit_estoque,
			qt_material_req_auto,
			nr_seq_proc_aprov,
			nr_seq_nota_fiscal,
			cd_barras,
			nr_seq_justificativa
		from	item_requisicao_material
		where	nr_requisicao = nr_requisicao_p
		and	nr_sequencia = nr_sequencia_p;

		update	item_requisicao_material
		set	qt_material_atendida	= qt_material_atendida - qt_desdobrar_w,
			qt_material_requisitada	= qt_material_requisitada - qt_desdobrar_w,
			vl_material 		= dividir(vl_material, qt_material_requisitada) * (qt_material_requisitada - qt_desdobrar_w),
			qt_estoque 		= (dividir(qt_estoque, qt_material_requisitada) * (qt_material_requisitada - qt_desdobrar_w))
		where	nr_requisicao		= nr_requisicao_p
		and	nr_sequencia		= nr_sequencia_p;

		qt_material_atendida_w		:= qt_material_atendida_w - qt_desdobrar_w;
		end;
	end if;
	end;
end if;

select	count(*)
into STRICT	qt_existe_w
from	item_requisicao_material
where	nr_requisicao	= nr_requisicao_p
and	nr_sequencia	= nr_sequencia_p
and	(cd_material_lido IS NOT NULL AND cd_material_lido::text <> '');

nr_seq_cor_w	:= 102;
if (qt_existe_w > 0) then
	nr_seq_cor_w	:= 103;
end if;

qt_mat_recebida_w := 0;
qt_mat_recebida_w := coalesce(obter_qt_receb_item_req(nr_requisicao_p, nr_sequencia_p),0);

if (coalesce(qt_mat_recebida_w,0)  >= qt_material_atendida_w) or (ie_tipo_requisicao_w = '1') then
	begin
	update	item_requisicao_material
	set	dt_recebimento 	= dt_atualizacao_w,
		nm_usuario_receb 	= nm_usuario_p,
		nr_seq_cor_exec	= nr_seq_cor_w
	where	nr_requisicao 	= nr_requisicao_p
	and	nr_sequencia 	= nr_sequencia_p;
	end;
end if;

if (nr_seq_kit_estoque_w > 0) and (ie_origem_requisicao_w = 'RKT') then
	open c01;
	loop
	fetch c01 into
		qt_material_kit_comp_w,
		nr_seq_kit_estoque_comp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (qt_material_kit_comp_w > qt_material_w) then
			qt_material_kit_comp_w := qt_material_w;
		end if;
		ds_erro_w := consist_componente_kit_barra(cd_material_w, nr_seq_kit_estoque_w, qt_material_kit_comp_w, nm_usuario_p, ie_consiste_quant_w, ie_consiste_material_w, nr_seq_lote_fornec_w, nr_seq_kit_estoque_comp_w, 'C', ds_erro_w);

		qt_material_w := qt_material_w - qt_material_kit_comp_w;

		if (qt_material_w <= 0) then
			exit;
		end if;
		end;
	end loop;
	close c01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_estoque_receb_req ( nr_requisicao_p bigint, nr_sequencia_p bigint, ie_tipo_recebimento_p text, qt_material_p bigint, nm_usuario_p text) FROM PUBLIC;

