-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_inativar_registro_build ( nr_seq_p bigint, ds_justificativa_p text, nm_usuario_p text) AS $body$
DECLARE


ds_versao_w			varchar(255);
nr_seq_ordem_serv_w	bigint;
ds_email_gerente_w	varchar(255);
cd_pessoa_fisica_w	varchar(10);
ds_titulo_email_w	varchar(255);
ds_mensagem_w		varchar(255);
ds_email_origem_p	varchar(255);


BEGIN

	update	man_os_ctrl_build
	set	ie_situacao = 'I',
		ds_justificativa = ds_justificativa_p,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_seq_p;

commit;

begin

	select	max(obter_cd_pessoa_responsavel(d.nr_seq_gerencia)),
			max(c.cd_versao),
			max(b.nr_seq_ordem_serv)
	into STRICT	cd_pessoa_fisica_w,
			ds_versao_w,
			nr_seq_ordem_serv_w
	from 	man_ordem_servico a,
		man_os_ctrl_desc b,
		man_os_ctrl_build c,
		grupo_desenvolvimento d
	where	a.nr_sequencia = b.nr_seq_ordem_serv
	and 	b.nr_sequencia  =  nr_seq_man_os_ctrl_desc
	and		a.nr_seq_grupo_des = d.nr_sequencia
	and		c.nr_sequencia = nr_seq_p;

	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		select	max(coalesce(a.ds_email, obter_email_pf(a.cd_pessoa_fisica)))
		into STRICT	ds_email_gerente_w
		from	usuario a
		where	a.ie_situacao = 'A'
		and		a.cd_pessoa_fisica = cd_pessoa_fisica_w;
	end if;

	if (ds_email_gerente_w IS NOT NULL AND ds_email_gerente_w::text <> '') then
		select	max(ds_email)
		into STRICT	ds_email_origem_p
		from	usuario
		where	nm_usuario = nm_usuario_p;

		if (ds_email_origem_p IS NOT NULL AND ds_email_origem_p::text <> '') then

			ds_titulo_email_w :=  replace(obter_texto_dic_objeto(1021263, philips_param_pck.get_nr_seq_idioma, 'DS_VERSAO=' || ds_versao_w), '#@NR_SEQ_ORDEM#@', nr_seq_ordem_serv_w);

			ds_mensagem_w := obter_desc_expressao(325773, 'Justificativa') ||chr(10) || chr(10)|| ds_justificativa_p;

			CALL enviar_email(	ds_titulo_email_w,
				ds_mensagem_w,
				ds_email_origem_p,
				ds_email_gerente_w,
				nm_usuario_p,
				'B');
		end if;
	end if;

exception
when others then
	null;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_inativar_registro_build ( nr_seq_p bigint, ds_justificativa_p text, nm_usuario_p text) FROM PUBLIC;

