-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_dupl_proc_ptu_analise ( nr_seq_conta_proc_p bigint, nm_usuario_p text, nr_seq_conta_proc_novo_p INOUT bigint) AS $body$
DECLARE


nr_seq_conta_proc_w		bigint;
qt_partic_w			bigint;
dt_procedimento_w		timestamp;
dt_inicio_proc_w		timestamp;
dt_atendimento_referencia_w	timestamp;
nr_seq_proc_ref_w		bigint;


BEGIN

select	count(nr_sequencia)
into STRICT	qt_partic_w
from	pls_proc_participante
where	nr_seq_conta_proc = nr_seq_conta_proc_p;

if (coalesce(qt_partic_w,0) >= 1) then

	select	nextval('pls_conta_proc_seq')
	into STRICT	nr_seq_conta_proc_w
	;
	
	select	coalesce(nr_seq_proc_ref, nr_sequencia)
	into STRICT	nr_seq_proc_ref_w
	from	pls_conta_proc
	where	nr_sequencia = nr_seq_conta_proc_p;

	insert into pls_conta_proc(cd_classif_cred, cd_classif_deb, cd_classif_glosa_cred,
			cd_classif_glosa_deb, cd_classificacao_sip, cd_classif_prov_cred,
			cd_classif_prov_deb, cd_conta_copartic_cred, cd_conta_copartic_deb,
			cd_conta_cred, cd_conta_deb, cd_conta_glosa_cred,
			cd_conta_glosa_deb, cd_conta_provisao_cred, cd_conta_provisao_deb,
			cd_historico, cd_historico_copartic, cd_historico_glosa,
			cd_historico_prov, cd_historico_rev_prov, cd_item_sip,
			cd_medico_solicitante, cd_porte_anestesico, cd_procedimento,
			cd_procedimento_imp, cd_tipo_tabela_imp, ds_justificativa,
			ds_log, ds_procedimento_imp, dt_atualizacao,
			dt_atualizacao_nrec, dt_fim_proc, dt_fim_proc_imp,
			dt_inicio_proc, dt_inicio_proc_imp, dt_item_sip,
			dt_liberacao, dt_procedimento, dt_procedimento_imp,
			ie_alterado_prestador, ie_ato_cooperado, ie_autogerado,
			ie_cobranca_previa_servico, ie_cobranca_prevista, ie_coparticipacao,
			ie_co_preco_operadora, ie_criterio_horario, ie_estagio_complemento,
			ie_faturamento, ie_glosa, ie_origem_proced,
			ie_origem_provisao, ie_repassa_medico, ie_sca,
			ie_segmentacao_sip, ie_situacao, ie_status,
			ie_tecnica_utilizada, ie_tipo_cobertura, ie_tipo_contratacao,
			ie_tipo_despesa, ie_tipo_despesa_imp, ie_valor_informado,
			ie_via_acesso, ie_via_acesso_imp, ie_vl_apresentado_sistema,
			nm_usuario, nm_usuario_liberacao, nm_usuario_nrec,
			nr_auxiliares, nr_lote_contabil, nr_lote_contabil_prov,
			nr_lote_contab_pag, nr_lote_provisao, nr_seq_atend_item,
			nr_seq_autogerado, nr_seq_cobertura, nr_seq_conta,
			nr_seq_conta_int, nr_seq_conta_medica, nr_seq_conversao_pacote,
			nr_seq_dados_proc, nr_seq_esquema, nr_seq_esquema_glosa,
			nr_seq_esquema_prov, nr_seq_evento, nr_seq_evento_fat,
			nr_seq_evento_prod, nr_seq_exame_coleta, nr_seq_grupo_ans,
			nr_seq_grupo_ans_sup, nr_seq_hon_crit_medico, nr_seq_honorario_crit,
			nr_seq_item_sip, nr_seq_mensalidade_item, nr_seq_pacote,
			nr_seq_pgto_aut, nr_seq_preco_autogerado, nr_seq_preco_pacote,
			nr_seq_prestador_pgto, nr_seq_prest_pgto_coleta, nr_seq_prest_pgto_medico,
			nr_seq_proc_princ, nr_seq_proc_ref, nr_seq_regra,
			nr_seq_regra_cooperado, nr_seq_regra_copartic, nr_seq_regra_ctb_cred,
			nr_seq_regra_ctb_deb, nr_seq_regra_evento_fat, nr_seq_regra_glosa,
			nr_seq_regra_horario, nr_seq_regra_int, nr_seq_regra_lanc_aut,
			nr_seq_regra_liberacao, nr_seq_regra_pos_estab, nr_seq_regra_qtde_exec,
			nr_seq_regra_valor, nr_seq_regra_via_acesso, nr_seq_regra_vinculo,
			nr_seq_sca_cobertura, nr_seq_setor_atend, nr_seq_tabela_sca,
			nr_seq_tipo_limitacao, nr_seq_tiss_tabela, nr_sequencia,
			qt_autorizado, qt_procedimento, qt_procedimento_imp,
			sg_uf_sip, tx_intercambio, tx_intercambio_imp,
			tx_item, tx_participacao, tx_pcmso,
			tx_reducao_acrescimo_imp, vl_adic_co, vl_adic_materiais,
			vl_adic_procedimento, vl_anestesista, vl_auxiliares,
			vl_beneficiario, vl_coparticipacao, vl_co_ptu,
			vl_co_ptu_imp, vl_custo_operacional, vl_exame_coleta,
			vl_glosa, vl_intercambio, vl_liberado,
			vl_liberado_regra, vl_lib_original, vl_liquido,
			vl_materiais, vl_material_ptu, vl_material_ptu_imp,
			vl_medico, vl_pag_medico_conta, vl_participacao,
			vl_pcmso, vl_prestador, vl_proc_copartic,
			vl_procedimento, vl_procedimento_imp, vl_procedimento_ptu,
			vl_procedimento_ptu_imp, vl_proc_unitario, vl_provisao,
			vl_saldo, vl_taxa_co, vl_taxa_co_imp,
			vl_taxa_material, vl_taxa_material_imp, vl_taxa_servico,
			vl_taxa_servico_imp, vl_total_partic, vl_total_procedimento,
			vl_unitario, vl_unitario_imp)
	(	SELECT	cd_classif_cred, cd_classif_deb, cd_classif_glosa_cred,
			cd_classif_glosa_deb, cd_classificacao_sip, cd_classif_prov_cred,
			cd_classif_prov_deb, cd_conta_copartic_cred, cd_conta_copartic_deb,
			cd_conta_cred, cd_conta_deb, cd_conta_glosa_cred,
			cd_conta_glosa_deb, cd_conta_provisao_cred, cd_conta_provisao_deb,
			cd_historico, cd_historico_copartic, cd_historico_glosa,
			cd_historico_prov, cd_historico_rev_prov, cd_item_sip,
			cd_medico_solicitante, cd_porte_anestesico, cd_procedimento,
			cd_procedimento_imp, cd_tipo_tabela_imp, ds_justificativa,
			ds_log, ds_procedimento_imp, clock_timestamp(),
			clock_timestamp(), dt_fim_proc, dt_fim_proc_imp,
			dt_inicio_proc, dt_inicio_proc_imp, dt_item_sip,
			dt_liberacao, dt_procedimento, dt_procedimento_imp,
			ie_alterado_prestador, ie_ato_cooperado, ie_autogerado,
			ie_cobranca_previa_servico, ie_cobranca_prevista, ie_coparticipacao,
			ie_co_preco_operadora, ie_criterio_horario, ie_estagio_complemento,
			ie_faturamento, ie_glosa, ie_origem_proced,
			ie_origem_provisao, ie_repassa_medico, ie_sca,
			ie_segmentacao_sip, ie_situacao, ie_status,
			ie_tecnica_utilizada, ie_tipo_cobertura, ie_tipo_contratacao,
			ie_tipo_despesa, ie_tipo_despesa_imp, ie_valor_informado,
			ie_via_acesso, ie_via_acesso_imp, ie_vl_apresentado_sistema,
			nm_usuario_p, nm_usuario_liberacao, nm_usuario_p,
			nr_auxiliares, nr_lote_contabil, nr_lote_contabil_prov,
			nr_lote_contab_pag, nr_lote_provisao, nr_seq_atend_item,
			nr_seq_autogerado, nr_seq_cobertura, nr_seq_conta,
			nr_seq_conta_int, nr_seq_conta_medica, nr_seq_conversao_pacote,
			nr_seq_dados_proc, nr_seq_esquema, nr_seq_esquema_glosa,
			nr_seq_esquema_prov, nr_seq_evento, nr_seq_evento_fat,
			nr_seq_evento_prod, nr_seq_exame_coleta, nr_seq_grupo_ans,
			nr_seq_grupo_ans_sup, nr_seq_hon_crit_medico, nr_seq_honorario_crit,
			nr_seq_item_sip, nr_seq_mensalidade_item, nr_seq_pacote,
			nr_seq_pgto_aut, nr_seq_preco_autogerado, nr_seq_preco_pacote,
			nr_seq_prestador_pgto, nr_seq_prest_pgto_coleta, nr_seq_prest_pgto_medico,
			nr_seq_proc_princ, nr_seq_proc_ref_w, nr_seq_regra,
			nr_seq_regra_cooperado, nr_seq_regra_copartic, nr_seq_regra_ctb_cred,
			nr_seq_regra_ctb_deb, nr_seq_regra_evento_fat, nr_seq_regra_glosa,
			nr_seq_regra_horario, nr_seq_regra_int, nr_seq_regra_lanc_aut,
			nr_seq_regra_liberacao, nr_seq_regra_pos_estab, nr_seq_regra_qtde_exec,
			nr_seq_regra_valor, nr_seq_regra_via_acesso, nr_seq_regra_vinculo,
			nr_seq_sca_cobertura, nr_seq_setor_atend, nr_seq_tabela_sca,
			nr_seq_tipo_limitacao, nr_seq_tiss_tabela, nr_seq_conta_proc_w,
			qt_autorizado, qt_procedimento, qt_procedimento_imp,
			sg_uf_sip, tx_intercambio, tx_intercambio_imp,
			tx_item, tx_participacao, tx_pcmso,
			tx_reducao_acrescimo_imp, vl_adic_co, vl_adic_materiais,
			vl_adic_procedimento, vl_anestesista, vl_auxiliares,
			vl_beneficiario, vl_coparticipacao, vl_co_ptu,
			null, vl_custo_operacional, vl_exame_coleta,
			vl_glosa, vl_intercambio, vl_liberado,
			vl_liberado_regra, vl_lib_original, vl_liquido,
			vl_materiais, vl_material_ptu, null,
			vl_medico, vl_pag_medico_conta, vl_participacao,
			vl_pcmso, vl_prestador, vl_proc_copartic,
			vl_procedimento, null, vl_procedimento_ptu,
			null, vl_proc_unitario, vl_provisao,
			vl_saldo, vl_taxa_co, null,
			vl_taxa_material, null, vl_taxa_servico,
			null, vl_total_partic, vl_total_procedimento,
			vl_unitario, null
		from	pls_conta_proc
		where	nr_sequencia = nr_seq_conta_proc_p);
		
		CALL pls_cta_proc_mat_regra_pck.cria_copia_regra_proc_tiss(nr_seq_conta_proc_p, nr_seq_conta_proc_w, 'S', nm_usuario_p);
		
	begin
	select	dt_procedimento,
		dt_inicio_proc,
		b.dt_atendimento_referencia
	into STRICT	dt_procedimento_w,
		dt_inicio_proc_w,
		dt_atendimento_referencia_w
	from	pls_conta_proc a,
		pls_conta b
	where	a.nr_sequencia = nr_seq_proc_ref_w
	and	b.nr_sequencia = a.nr_seq_conta;
	exception
	when others then
		dt_procedimento_w	:= null;
		dt_inicio_proc_w	:= null;
		dt_atendimento_referencia_w		:= null;
	end;
	
	if (coalesce(dt_procedimento_w::text, '') = '') then
		dt_procedimento_w := dt_atendimento_referencia_w;
	end if;
	
	if (coalesce(dt_inicio_proc_w::text, '') = '') then
		dt_inicio_proc_w := to_date(dt_atendimento_referencia_w||' '||'00:00:00', 'dd/mm/yyyy hh24:mi:ss');
	end if;
	
	update	pls_conta_proc
	set	dt_procedimento = dt_procedimento_w,
		dt_inicio_proc	= dt_inicio_proc_w
	where	nr_seq_proc_ref = nr_seq_proc_ref_w
	or	nr_sequencia 	= nr_seq_proc_ref_w;
	
	update	w_pls_resumo_conta
	set	dt_inicio_item	= dt_inicio_proc_w,
		dt_item		= dt_procedimento_w
	where	nr_seq_item_ref = nr_seq_proc_ref_w;	
		
	nr_seq_conta_proc_novo_p := nr_seq_conta_proc_w;		
else
	/*No caso do procedimento não possuir participantes então o mesmo será transformado no item com participantes.*/

	nr_seq_conta_proc_novo_p := nr_seq_conta_proc_p;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dupl_proc_ptu_analise ( nr_seq_conta_proc_p bigint, nm_usuario_p text, nr_seq_conta_proc_novo_p INOUT bigint) FROM PUBLIC;

