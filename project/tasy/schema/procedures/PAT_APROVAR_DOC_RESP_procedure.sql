-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_aprovar_doc_resp ( nr_sequencia_p bigint, nr_seq_doc_transf_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


qt_registro_w					bigint;
dt_aprovacao_w					timestamp;
ds_observacao_w					pat_doc_transferencia.ds_observacao%type;
ds_assunto_w					pat_regra_envio_aviso.ds_assunto%type;
ds_mensagem_w					pat_regra_envio_aviso.ds_mensagem_padrao%type;
ds_email_origem_w					varchar(255);
ds_email_destino_w					varchar(255);
ds_email_adicional_w					varchar(255);
ds_usuario_origem_w				varchar(255);
ds_estabelecimento_w				varchar(255);
ds_cargo_usuario_w				cargo.ds_cargo%type;
nr_ramal_w					usuario.nr_ramal%type;
ds_email_w					usuario.ds_email%type;		
dt_documento_w					pat_doc_transferencia.dt_documento%type;
nr_documento_w					pat_doc_transferencia.nr_sequencia%type;
cd_pessoa_fisica_w				usuario.cd_pessoa_fisica%type;
nm_pessoa_fisica_w				pessoa_fisica.nm_pessoa_fisica%type;
nm_pessoa_fisica_dest_w				pessoa_fisica.nm_pessoa_fisica%type;
nm_usuario_destino_w				usuario.nm_usuario%type;
cd_pessoa_fisica_destino_w				pat_doc_transf_resp.cd_pessoa_fisica%type;
ie_comunic_w					pat_regra_envio_aviso.ie_forma_comunicacao%type;
nr_ordem_atual_w					pat_doc_transf_resp.nr_ordem%type;
ie_tipo_aprovador_w				pat_doc_transf_resp.ie_tipo_aprovador%type;
qt_aprov_origem_pend_w				bigint;

C01 CURSOR FOR
SELECT	ds_mensagem_padrao,
ds_assunto,	
ie_forma_comunicacao,
ds_email_adicional
from 	pat_regra_envio_aviso
where	ie_tipo_aviso  = 2;


BEGIN
	
	
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
		
		select	a.ie_tipo_aprovador
		into STRICT	ie_tipo_aprovador_w
		from	pat_doc_transf_resp a
		where	a.nr_sequencia	= nr_sequencia_p;
		
		if (ie_tipo_aprovador_w = 'D') then
			
			select	count(nr_sequencia)
			into STRICT	qt_aprov_origem_pend_w
			from	pat_doc_transf_resp a
			where	a.nr_seq_doc_transf	= nr_seq_doc_transf_p
			and	a.ie_tipo_aprovador	= 'O'
			and	coalesce(a.dt_aprovacao::text, '') = '';
			
			if (qt_aprov_origem_pend_w > 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(291474);
			end if;
		end if;
		
		update	pat_doc_transf_resp
		set	dt_aprovacao	= CASE WHEN ie_opcao_p='A' THEN clock_timestamp() WHEN ie_opcao_p='E' THEN null END ,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p;
	end if;
	
	select	count(nr_seq_doc_transf)
	into STRICT	qt_registro_w
	from	pat_doc_transf_resp
	where	coalesce(dt_aprovacao::text, '') = ''
	and	nr_seq_doc_transf = nr_seq_doc_transf_p;
	
	if (qt_registro_w = 0) then
		CALL pat_aprovar_doc_transf(nr_seq_doc_transf_p, cd_estabelecimento_p, ie_opcao_p, nm_usuario_p, clock_timestamp());
		
	end if;
	
	commit;
	if (ie_opcao_p = 'A') then
		
		select	count(nr_sequencia)
		into STRICT	qt_registro_w
		from	pat_regra_envio_aviso
		where 	ie_tipo_aviso = 2;
		
		if (qt_registro_w > 0) then
			begin
				select	ds_observacao,
				dt_documento,
				nr_sequencia
				into STRICT	ds_observacao_w,
				dt_documento_w,
				nr_documento_w
				from	pat_doc_transferencia
				where	nr_sequencia = nr_seq_doc_transf_p;	
				
				select	nr_ramal,
				ds_email,
				cd_pessoa_fisica
				into STRICT	nr_ramal_w,
				ds_email_w,
				cd_pessoa_fisica_w
				from	usuario
				where	nm_usuario = nm_usuario_p;
				
				begin
					select	substr(obter_desc_cargo(cd_cargo),1,100) ds_cargo,
					SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),0,60)
					into STRICT	ds_cargo_usuario_w,
					nm_pessoa_fisica_w
					from	pessoa_fisica
					where	cd_pessoa_fisica = cd_pessoa_fisica_w;
					exception
					when others then
					ds_cargo_usuario_w := '';
					nm_pessoa_fisica_w := '';
				end;
				
				select	min(nr_ordem)
				into STRICT	nr_ordem_atual_w
				from	pat_doc_transf_resp y
				where	nr_sequencia = nr_sequencia_p;	
				
				begin		
					select	substr(obter_dados_pf_pj(cd_pessoa_fisica,null,'M'),1,255),
					cd_pessoa_fisica
					into STRICT	ds_email_destino_w,
					cd_pessoa_fisica_destino_w
					from	pat_doc_transf_resp a
					where	a.nr_seq_doc_transf = nr_seq_doc_transf_p
					and 	a.nr_ordem = (	SELECT min(y.nr_ordem)
						from pat_doc_transf_resp y
						where y.nr_seq_doc_transf = nr_seq_doc_transf_p
					and y.nr_ordem > nr_ordem_atual_w)
					and   	coalesce(dt_aprovacao::text, '') = '';
					exception
					when others then
					ds_email_destino_w := '';
					cd_pessoa_fisica_destino_w := '';
				end;
				
				if (cd_pessoa_fisica_destino_w IS NOT NULL AND cd_pessoa_fisica_destino_w::text <> '') then		
					select	max(nm_usuario)
					into STRICT	nm_usuario_destino_w
					from	usuario
					where	cd_pessoa_fisica = cd_pessoa_fisica_destino_w;
					
					begin
						select	SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),0,60)
						into STRICT	nm_pessoa_fisica_dest_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_pessoa_fisica_destino_w;
						exception when others then
						nm_pessoa_fisica_dest_w	:= '';
					end;
					
					open C01;
					loop
						
						fetch C01 into	
						ds_mensagem_w,
						ds_assunto_w,
						ie_comunic_w,
						ds_email_adicional_w;
						EXIT WHEN NOT FOUND; /* apply on C01 */
						begin
							
							select  substr(obter_nome_estab(cd_estabelecimento_p),1,255)
							into STRICT	ds_estabelecimento_w
							;
							
							/* ASSUNTO */

							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@data',to_char(dt_documento_w,'dd/mm/yyyy')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@doc',to_char(nr_documento_w)),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@observacao',coalesce(ds_observacao_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@cargo',coalesce(ds_cargo_usuario_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ramal',coalesce(nr_ramal_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@email',coalesce(ds_email_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nm_usuario',coalesce(nm_pessoa_fisica_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@usuario_dest',coalesce(nm_usuario_destino_w,'')),1,2000);	
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nm_usuario_dest',coalesce(nm_pessoa_fisica_dest_w,'')),1,2000);
							ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_estabelecimento',coalesce(ds_estabelecimento_w,'')),1,2000);
							/* TEXTO DA MENSAGEM */

							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@data',to_char(dt_documento_w,'dd/mm/yyyy')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@doc',to_char(nr_documento_w)),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@observacao',coalesce(ds_observacao_w,'')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@cargo',coalesce(ds_cargo_usuario_w,'')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ramal',coalesce(nr_ramal_w,'')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@email',coalesce(ds_email_w,'')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nm_usuario',coalesce(nm_pessoa_fisica_w,'')),1,2000);
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@usuario_dest',coalesce(nm_usuario_destino_w,'')),1,2000);	
							ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nm_usuario_dest',coalesce(nm_pessoa_fisica_dest_w,'')),1,2000);	
							--ds_assunto_w  := substr(replace_macro(ds_mensagem_w,'@ds_estabelecimento',nvl(ds_estabelecimento_w,'')),1,2000);
							ds_mensagem_w  := substr(replace_macro(ds_mensagem_w,'@ds_estabelecimento',coalesce(ds_estabelecimento_w,'')),1,2000);
							
							if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
								if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
									ds_email_destino_w := concat(ds_email_destino_w, concat('; ', ds_email_adicional_w));
									else
									ds_email_destino_w := ds_email_adicional_w;
								end if;
							end if;
							if (ie_comunic_w = 'EM') then
								CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_w, ds_email_destino_w, nm_usuario_p, 'M', null);
								elsif (ie_comunic_w = 'CI') then		
								CALL gerar_comunic_padrao(clock_timestamp(),ds_assunto_w,ds_mensagem_w,nm_usuario_p,'N',nm_usuario_destino_w,'N','','','','',clock_timestamp(),'','');
								else 		
								CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_w, ds_email_destino_w, nm_usuario_p, 'M', null);			
								CALL gerar_comunic_padrao(clock_timestamp(),ds_assunto_w,ds_mensagem_w,nm_usuario_p,'N',nm_usuario_destino_w,'N','','','','',clock_timestamp(),'','');
							end if;
						end;
					end loop;
					close C01;
				end if;
			end;
		end if;
	end if;
	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_aprovar_doc_resp ( nr_sequencia_p bigint, nr_seq_doc_transf_p bigint, cd_estabelecimento_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

