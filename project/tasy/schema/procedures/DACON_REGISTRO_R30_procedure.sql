-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dacon_registro_r30 ( nm_usuario_p text, nr_seq_dacon_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_cgc_w		varchar(14);
cd_darf_w		varchar(4);
cd_tributo_pis_w		smallint;
cd_tributo_cofins_w		smallint;	
base_calculo_w		varchar(14);
vl_pis_w			varchar(14);
vl_cofins_w		varchar(14);
contador_w		bigint := 1;
	
C01 CURSOR FOR 
 
SELECT 	rpad(coalesce(cd_cgc,0),14,0), 
	lpad(coalesce(cd_darf,0),4,0), 
	lpad(replace(campo_mascara(coalesce(sum(vb),'0'),2),'.',''),14,0), 
	lpad(replace(campo_mascara(coalesce(sum(pis),'0'),2),'.',''),14,0), 
	lpad(replace(campo_mascara(coalesce(sum(cofins),'0'),2),'.',''),14,0) 
from (SELECT	distinct 
		b.cd_cgc cd_cgc, 
		b.nr_sequencia, 
		obter_codigo_darf(c.cd_tributo,b.cd_estabelecimento,b.cd_cgc,b.cd_pessoa_fisica) cd_Darf, 
		obter_vl_tributo(b.nr_sequencia, coalesce(cd_tributo_pis_w, cd_tributo_cofins_w), 'VB') vb, 
		obter_vl_tributo(b.nr_sequencia,cd_tributo_pis_w) pis, 
		obter_vl_tributo(b.nr_sequencia,cd_tributo_cofins_w) cofins 
	from	nota_fiscal b, 
		nota_fiscal_trib t, 
		dacon_nota_fiscal a, 
		tributo c 
	where	b.nr_sequencia = t.nr_sequencia 
	and	b.nr_sequencia = a.nr_seq_nota_fiscal 
	and	t.cd_tributo = c.cd_tributo 
	and (c.cd_tributo = cd_tributo_pis_w or c.cd_tributo = cd_tributo_cofins_w) 
	and	a.nr_seq_dacon = nr_seq_dacon_p) alias25 
GROUP BY cd_cgc,cd_darf 
 HAVING	sum(pis) > 0 
and	sum(cofins) > 0 
order by cd_darf,cd_cgc;


BEGIN				 
 
select	cd_tributo_pis, 
	cd_tributo_cofins 
into STRICT	cd_tributo_pis_w, 
	cd_tributo_cofins_w	 
from	dacon 
where	nr_sequencia = nr_seq_dacon_p;	
 
open C01;
loop 
fetch C01 into 
	cd_cgc_w, 
	cd_darf_w, 
	base_calculo_w, 
	vl_pis_w, 
	vl_cofins_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	insert into w_dacon(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ds_arquivo, 
			nr_linha, 
			ie_tipo_registro 
			) 
	values (nextval('w_dacon_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			rpad('R30',4,' ')||lpad(0,4,0)||cd_cgc_w||cd_darf_w||base_calculo_w||vl_pis_w||vl_cofins_w||lpad(' ',10,' '), 
			contador_w, 
			40 
			);
	 
	contador_w := contador_w + 1;
	 
	if (mod(contador_w,100) = 0) then 
		commit;
	end if;	
	 
end loop;
close C01;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dacon_registro_r30 ( nm_usuario_p text, nr_seq_dacon_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

