-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE db_add_build_param_value ( nr_seq_content_build_p db_content_build.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/*
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Objective: Generate the param value of the macro
	------------------------------------------------------------------------
	Direct call: 
	[   ] Dictionary objects
	[ X ] Tasy (Delphi/Java/HTML5)
	[   ] Portal
	[   ] Reports
	[   ] Others:
	 -----------------------------------------------------------------------
	Attention points: N/A
	------------------------------------------------------------------------
	References:
		Tables:	db_content_template_item,
			db_content_macro,
			db_content_macro_param,
			db_content_build,
			db_content_template,
			db_content_build_par_value
		Objects: N/A
	------------------------------------------------------------------------
	Called in:
		Java: N/A
		HTML5:	C:\HTML5\Projects\tasy-backend\CorQua\src\main\java\com\philips\tasy\app\corquagdp\enums\CorQuaGDPProcEnum.java
		Object: N/A
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/
nr_seq_content_build_w	db_content_build.nr_sequencia%type;
nr_seq_template_w	db_content_template.nr_sequencia%type;
ie_exists_w		varchar(1);

c01 CURSOR FOR
	SELECT	cm.ds_macro,
		cmp.ds_parameter,
		cm.ie_macro_type,
		cm.nr_version,
		cmp.nr_sequencia nr_seq_macro_param
	from	db_content_template_item cti,
		db_content_macro cm,
		db_content_macro_param cmp
	where	cm.nr_sequencia = cti.nr_seq_content_macro
	and	cm.nr_sequencia = cmp.nr_seq_content_macro
	and	cti.nr_seq_template = nr_seq_template_w;
	
BEGIN
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_content_build_w
	from	db_content_build cb
	where	cb.nr_sequencia = nr_seq_content_build_p;


	if (nr_seq_content_build_w IS NOT NULL AND nr_seq_content_build_w::text <> '') then
		begin
			select	cb.nr_seq_content_template
			into STRICT	nr_seq_template_w
			from	db_content_build cb
			where	cb.nr_sequencia = nr_seq_content_build_w;

			if (nr_seq_template_w IS NOT NULL AND nr_seq_template_w::text <> '') then
				begin
					for reg01 in c01 loop
						begin
							select	coalesce(max('S'), 'N')
							into STRICT	ie_exists_w
							from	db_content_build_par_value cbpv
							where	cbpv.nr_seq_content_build = nr_seq_content_build_w
							and	cbpv.nr_seq_content_macro_par = reg01.nr_seq_macro_param;

							if (ie_exists_w = 'N') then
								begin
									insert
									into	db_content_build_par_value(
											nr_sequencia,
											nr_seq_content_build,
											nr_seq_content_macro_par,
											dt_atualizacao,
											dt_atualizacao_nrec,
											nm_usuario,
											nm_usuario_nrec
										) values (
											nextval('db_content_build_par_value_seq'),
											nr_seq_content_build_w,
											reg01.nr_seq_macro_param,
											clock_timestamp(),
											clock_timestamp(),
											nm_usuario_p,
											nm_usuario_p
										);
								end;
							end if;
						end;
					end loop;	
					commit;
				end;
			end if;
		end;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE db_add_build_param_value ( nr_seq_content_build_p db_content_build.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

