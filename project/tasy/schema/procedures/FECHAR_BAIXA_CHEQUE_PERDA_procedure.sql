-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fechar_baixa_cheque_perda ( nr_seq_caixa_rec_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_cheque_w		bigint;
ie_tipo_perda_w		varchar(1);
vl_perda_w		double precision;

cd_pessoa_fisica_w	varchar(10);
cd_cgc_w		varchar(14);

nr_seq_perda_w		bigint;
nr_seq_baixa_w		bigint;
nr_seq_tipo_baixa_w	bigint;
nr_seq_cobranca_w	bigint;

dt_fechamento_w		timestamp;
nr_seq_trans_financ_w	bigint;
vl_transacao_w		double precision;
nr_documento_w		bigint;
ie_tipo_movto_w		varchar(2);
nr_seq_saldo_caixa_w	bigint;
nr_seq_caixa_w		bigint;
dt_fechamento_saldo_w	timestamp;
nr_sequencia_w		bigint;
qt_lote_aberto_w	integer;
nr_seq_lote_w		bigint;
cd_estabelecimento_w	smallint;
dt_saldo_caixa_w	timestamp;
dt_recebimento_w	timestamp;
nr_seq_motivo_perda_w	bigint;
nr_seq_trans_financ_regra_w	bigint;
ie_acao_regra_w		varchar(1);
ie_receb_caixa_w	varchar(2);
CD_TIPO_RECEB_CAIXA_w	bigint;
			
c01 CURSOR FOR 
SELECT	a.nr_seq_cheque, 
	coalesce(a.ie_tipo_perda,'R'), 
	a.vl_perda, 
	b.cd_pessoa_fisica, 
	b.cd_cgc, 
	a.nr_seq_motivo_perda 
from	cheque_cr_perda a, 
	cheque_cr b 
where	a.nr_seq_cheque = b.nr_seq_cheque 
and	a.nr_seq_caixa_rec = nr_seq_caixa_rec_p;

c02 CURSOR FOR 
SELECT	nr_sequencia 
from	cobranca 
where	nr_seq_cheque = nr_seq_cheque_w 
and	ie_status = 'P';
			

BEGIN 
select	a.dt_fechamento, 
	a.dt_recebimento, 
	b.nr_sequencia, 
	b.nr_seq_caixa, 
	a.cd_pessoa_fisica, 
	a.cd_cgc, 
	a.nr_seq_trans_financ, 
	a.CD_TIPO_RECEB_CAIXA 
into STRICT	dt_fechamento_w, 
	dt_recebimento_w, 
	nr_seq_saldo_caixa_w, 
	nr_seq_caixa_w, 
	cd_pessoa_fisica_w, 
	cd_cgc_w, 
	nr_seq_trans_financ_w, 
	CD_TIPO_RECEB_CAIXA_w 
from	caixa_saldo_diario b, 
	caixa_receb a 
where	a.nr_seq_saldo_caixa	= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_caixa_rec_p;
 
select	a.dt_fechamento, 
	a.dt_saldo, 
	b.cd_estabelecimento 
into STRICT	dt_fechamento_saldo_w, 
	dt_saldo_caixa_w, 
	cd_estabelecimento_w 
from	caixa b, 
	caixa_saldo_diario a 
where	a.nr_seq_caixa	= b.nr_sequencia 
and	a.nr_sequencia	= nr_seq_saldo_caixa_w;
 
ie_receb_caixa_w := Obter_Param_Usuario(813, 140, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_receb_caixa_w);
if (ie_receb_caixa_w = 'TR') then 
	delete	FROM W_FUNCAO_TF_VALORES 
	where	nm_usuario = nm_usuario_p;
	 
	CALL gravar_w_funcao_tf_valores('MOVTO_TRANS_FINANC','CD_TIPO_RECEB_CAIXA',CD_TIPO_RECEB_CAIXA_w, nm_usuario_p);
 
	SELECT * FROM consistir_funcao_tf(813, 'MOVTO_TRANS_FINANC', 'NR_SEQ_TRANS_FINANC', nr_seq_trans_financ_regra_w, ie_acao_regra_w, nm_usuario_p) INTO STRICT nr_seq_trans_financ_regra_w, ie_acao_regra_w;
			 
	if (coalesce(nr_seq_trans_financ_regra_w::text, '') = '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(224676);
	end if;
end if;
 
select	count(*) 
into STRICT	qt_lote_aberto_w 
from	movto_trans_financ 
where	nr_seq_caixa	= nr_seq_caixa_w 
and	coalesce(dt_fechamento_lote::text, '') = '';
 
if (qt_lote_aberto_w > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184708);
elsif (dt_fechamento_saldo_w IS NOT NULL AND dt_fechamento_saldo_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184709);
elsif (trunc(dt_saldo_caixa_w,'dd') <> trunc(dt_recebimento_w,'dd')) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184710);
elsif (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184711);
end if;
 
select	max(nr_sequencia) 
into STRICT	nr_seq_tipo_baixa_w 
from	fin_tipo_baixa_perda 
where	ie_tipo_consistencia = '2' 
and	ie_situacao = 'A';
 
if (coalesce(nr_seq_tipo_baixa_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(214619);
end if;
 
select	coalesce(max(nr_seq_lote),0) + 1 
into STRICT	nr_seq_lote_w 
from	movto_trans_financ 
where	nr_seq_caixa	= nr_seq_caixa_w;
 
/* necess√°rio atualizar o fechamento aqui para que o saldo do cheque possa ser atualizado corretamente */
 
update	caixa_receb 
set	dt_fechamento	= clock_timestamp(), 
	nm_usuario	= nm_usuario_p, 
	dt_atualizacao	= clock_timestamp() 
where	nr_sequencia	= nr_seq_caixa_rec_p;
 
open c01;
loop 
fetch c01 into	 
	nr_seq_cheque_w, 
	ie_tipo_perda_w, 
	vl_perda_w, 
	cd_pessoa_fisica_w, 
	cd_cgc_w, 
	nr_seq_motivo_perda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	select	nextval('movto_trans_financ_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert	into movto_trans_financ( 
		nr_sequencia, 
		dt_transacao, 
		nr_seq_trans_financ, 
		vl_transacao, 
		dt_atualizacao, 
		nm_usuario, 
		nr_lote_contabil, 
		ie_conciliacao, 
		nr_seq_caixa_rec, 
		nr_seq_caixa, 
		nr_seq_saldo_caixa, 
		dt_referencia_saldo, 
		nr_seq_lote, 
		nr_seq_cheque, 
		nr_seq_movto_cartao, 
		cd_pessoa_fisica, 
		cd_cgc) 
	values (	nr_sequencia_w, 
		dt_recebimento_w, 
		coalesce(nr_seq_trans_financ_w, nr_seq_trans_financ_regra_w), 
		vl_perda_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		0, 
		'N', 
		nr_seq_caixa_rec_p, 
		nr_seq_caixa_w, 
		nr_seq_saldo_caixa_w, 
		dt_saldo_caixa_w, 
		nr_seq_lote_w, 
		nr_Seq_cheque_w, 
		null, 
		cd_pessoa_fisica_w, 
		cd_cgc_w);
		 
	CALL Atualizar_Saldo_Caixa(cd_estabelecimento_w, nr_seq_lote_w, nr_seq_caixa_w, nm_usuario_p, 'N');
	 
	CALL gerar_perda_contas_receber( 
		cd_estabelecimento_w, 
		nr_seq_cheque_w, 
		null, 
		null, 
		vl_perda_w, 
		ie_tipo_perda_w, 
		nm_usuario_p, 
		nr_seq_motivo_perda_w, 
		dt_recebimento_w);
 
	CALL atualizar_saldo_neg_cheque_cr(nr_seq_cheque_w,nm_usuario_p);
 
	CALL gerar_cheque_cr_hist(nr_seq_cheque_w,wheb_mensagem_pck.get_texto(305857) || nr_seq_caixa_rec_p || wheb_mensagem_pck.get_texto(305858) ,'N',nm_usuario_p);
 
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fechar_baixa_cheque_perda ( nr_seq_caixa_rec_p bigint, nm_usuario_p text) FROM PUBLIC;

