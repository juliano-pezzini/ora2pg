-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_interv_solic_mat_med ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

				


ds_erro_w						varchar(2000) := '';
cd_material_w					integer;
qt_horas_intervalo_w			bigint;
cd_grupo_material_w				smallint;
cd_subgrupo_material_w			smallint;
cd_classe_material_w			integer;
cd_material_regra_w				integer;
cd_estabelecimento_w			smallint;
nr_atendimento_w				bigint;
cd_grupo_material_prescr_w		smallint;
cd_subgrupo_material_prescr_w	smallint;
cd_classe_material_prescr_w		integer;
dt_ultima_prescricao_w			timestamp;
dt_prescricao_w					timestamp;
ds_material_w					varchar(255);
ie_considera_kit_w				varchar(2);
ie_todas_atend_w				varchar(2);
ie_permite_justif_w				varchar(2);
ds_material_prob_w				varchar(2000) := '';
cd_convenio_w					integer;
ds_justificativa_w				varchar(255);
qt_permitida_w					double precision	:= 1;
qt_executada_periodo_w			double precision;
cd_setor_atendimento_w			bigint;
ie_considera_regra_w			regra_interv_sol_mat_med.ie_considera_regra%type;
ie_prim_prescricao_w			varchar(2) := 'N';
ie_primeira_prescricao_w	    varchar(1);			

C01 CURSOR FOR
SELECT	distinct cd_material,
		substr(obter_desc_material(cd_material),1,255),
		substr(ds_justificativa,1,255)
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	= nr_sequencia_p
and		coalesce(ie_suspenso,'N')	<> 'S'
and		ie_agrupador not in (3,7,9);

C02 CURSOR FOR
	SELECT	qt_horas_intervalo,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		coalesce(qt_permitida,1),
		coalesce(ie_considera_kit,'S'),
		coalesce(ie_todas_atend,'N'),
		coalesce(ie_permite_justif,'N'),
		coalesce(ie_considera_regra, 'N'),
		coalesce(ie_prim_prescricao, 'N')
	from	regra_interv_sol_mat_med a
	where	cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(cd_grupo_material,coalesce(cd_grupo_material_prescr_w,0))	= coalesce(cd_grupo_material_prescr_w,0)
	and	coalesce(cd_subgrupo_material,coalesce(cd_subgrupo_material_prescr_w,0))	= coalesce(cd_subgrupo_material_prescr_w,0)
	and	coalesce(cd_classe_material,coalesce(cd_classe_material_prescr_w,0))	= coalesce(cd_classe_material_prescr_w,0)
	and	coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))		= coalesce(cd_setor_atendimento_w,0)
	and (
		(coalesce(cd_material,coalesce(cd_material_w,0)) = coalesce(cd_material_w,0)) or
		(
			(cd_material_w IS NOT NULL AND cd_material_w::text <> '') and
			exists (
				SELECT	1
				from	regra_interv_sol_generico x
				where	x.nr_seq_regra = a.nr_sequencia
				and 	x.cd_material = cd_material_w
			)
		)
	)
	and	((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
	order by
		coalesce(cd_material,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_convenio,0);


BEGIN

begin
select	cd_estabelecimento,
	nr_atendimento,
	dt_prescricao,
	obter_convenio_atendimento(nr_atendimento),
	cd_setor_atendimento
into STRICT	cd_estabelecimento_w,
	nr_atendimento_w,
	dt_prescricao_w,
	cd_convenio_w,
	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;
exception
	when others then
		cd_estabelecimento_w	:= 1;
end;

open C01;
loop
fetch C01 into	
	cd_material_w,
	ds_material_w,
	ds_justificativa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */	
	
	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_prescr_w,
		cd_subgrupo_material_prescr_w,
		cd_classe_material_prescr_w
	from	estrutura_material_v
	where	cd_material	= cd_material_w;

	open c02;
	loop
	fetch c02 into	
		qt_horas_intervalo_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_regra_w,
		qt_permitida_w,
		ie_considera_kit_w,
		ie_todas_atend_w,
		ie_permite_justif_w,
		ie_considera_regra_w,
		ie_prim_prescricao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		qt_horas_intervalo_w	:= qt_horas_intervalo_w;
	end loop;
	close c02;
	
	if	((coalesce(ds_justificativa_w::text, '') = '') or (ie_permite_justif_w = 'N')) then
	
		dt_ultima_prescricao_w	:= null;
		
		if (cd_material_regra_w IS NOT NULL AND cd_material_regra_w::text <> '')  then
			begin
			select	max(a.dt_prescricao)
			into STRICT	dt_ultima_prescricao_w
			from	prescr_material b,
					prescr_medica a				
			where	a.nr_prescricao		= b.nr_prescricao
			and		a.nr_atendimento		= nr_atendimento_w
			and		b.cd_material			= cd_material_w
			and		((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
            and	    coalesce(a.dt_suspensao::text, '') = ''
            and	    coalesce(b.ie_suspenso,'N')	<> 'S';
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;
			
			begin			
			
			if (ie_todas_atend_w = 'N') then
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	prescr_material	b,
					prescr_medica a 
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= cd_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	a.dt_prescricao between (dt_prescricao_w - (qt_horas_intervalo_w * 60 /1440)) and dt_prescricao_w
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			else
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	prescr_material	b,
						prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= cd_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S' 
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;		
			end if;
			
			exception
				when others then
					qt_executada_periodo_w	:= 0;
			end;
		elsif (cd_classe_material_w IS NOT NULL AND cd_classe_material_w::text <> '') then
			begin
			select	max(a.dt_prescricao)
			into STRICT	dt_ultima_prescricao_w
			from	estrutura_material_v c,
				prescr_material b,
				prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and	a.nr_atendimento	= nr_atendimento_w
			and	b.cd_material		= c.cd_material
			and	c.cd_classe_material	= cd_classe_material_w
			and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
			and	coalesce(a.dt_suspensao::text, '') = ''
			and	coalesce(b.ie_suspenso,'N')	<> 'S'
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''));
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;

			begin
			
			if (ie_todas_atend_w = 'N') then
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_classe_material	= cd_classe_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	a.dt_prescricao between (dt_prescricao_w - (qt_horas_intervalo_w * 60 /1440)) and dt_prescricao_w
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			else
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_classe_material	= cd_classe_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			end if;
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;
		elsif (cd_subgrupo_material_w IS NOT NULL AND cd_subgrupo_material_w::text <> '') then
			begin
			select	max(a.dt_prescricao)
			into STRICT	dt_ultima_prescricao_w
			from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and	a.nr_atendimento	= nr_atendimento_w
			and	b.cd_material		= c.cd_material
			and	c.cd_subgrupo_material	= cd_subgrupo_material_w
			and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
			and	coalesce(a.dt_suspensao::text, '') = ''
			and	coalesce(b.ie_suspenso,'N')	<> 'S'
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''));
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;

			begin
			
			if (ie_todas_atend_w = 'N') then
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_subgrupo_material	= cd_subgrupo_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	a.dt_prescricao between (dt_prescricao_w - (qt_horas_intervalo_w * 60 /1440)) and dt_prescricao_w
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			else
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_subgrupo_material	= cd_subgrupo_material_w
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			end if;
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;
		elsif (cd_grupo_material_w IS NOT NULL AND cd_grupo_material_w::text <> '') then
			begin
			select	max(a.dt_prescricao)
			into STRICT	dt_ultima_prescricao_w
			from	estrutura_material_v c,
				prescr_material b,
				prescr_medica a
			where	a.nr_prescricao		= b.nr_prescricao
			and	a.nr_atendimento	= nr_atendimento_w
			and	b.cd_material		= c.cd_material
			and	c.cd_grupo_material	= cd_grupo_material_w
			and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
			and	coalesce(a.dt_suspensao::text, '') = ''
			and	coalesce(b.ie_suspenso,'N')	<> 'S'
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''));

			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;

			begin
			if (ie_todas_atend_w = 'N') then
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_grupo_material	= cd_grupo_material_w
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	a.dt_prescricao between (dt_prescricao_w - (qt_horas_intervalo_w * 60 /1440)) and dt_prescricao_w
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			else
				select	CASE WHEN b.ie_agrupador=1 THEN coalesce(sum(b.qt_dose),0) WHEN b.ie_agrupador=2 THEN coalesce(sum(b.qt_total_dispensar),0) END
				into STRICT	qt_executada_periodo_w
				from	estrutura_material_v c,
					prescr_material b,
					prescr_medica a
				where	a.nr_prescricao		= b.nr_prescricao
				and	a.nr_atendimento	= nr_atendimento_w
				and	b.cd_material		= c.cd_material
				and	c.cd_grupo_material	= cd_grupo_material_w
				and	coalesce(a.dt_suspensao::text, '') = ''
				and	coalesce(b.ie_suspenso,'N')	<> 'S'
				and	((ie_considera_kit_w	= 'S') or (coalesce(b.nr_seq_kit::text, '') = ''))
				and	(((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')) or (a.nr_prescricao = nr_prescricao_p))
				group by
					b.ie_agrupador;
			end if;
			exception
				when others then
					dt_ultima_prescricao_w	:= null;
			end;
		end if;
		
		if (ie_considera_regra_w = 'N') then	
			if (dt_ultima_prescricao_w IS NOT NULL AND dt_ultima_prescricao_w::text <> '') and
				(((dt_prescricao_w - dt_ultima_prescricao_w) * 24) < qt_horas_intervalo_w) then	
				ds_material_prob_w	:= substr(ds_material_prob_w ||ds_material_w||' - '||qt_horas_intervalo_w||'h / ',1,2000);
			end if;
			if (qt_executada_periodo_w > qt_permitida_w) then
				ds_material_prob_w	:= substr(ds_material_prob_w ||ds_material_w||' - '||qt_horas_intervalo_w||'h / ',1,2000);
			end if;
		else
		
			select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
			into STRICT	ie_primeira_prescricao_w
			from	prescr_medica a 
			where	a.nr_atendimento 	= nr_atendimento_w
			and		((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
			and	    coalesce(a.dt_suspensao::text, '') = ''
			and exists (
                			SELECT 1 
                			from prescr_material b, 
                				estrutura_material_v e, 
                				prescr_medica c 
                			where c.nr_prescricao = b.nr_prescricao
			                and c.nr_atendimento = nr_atendimento_w
			                and b.cd_material = coalesce(cd_material_regra_w,b.cd_material) 
			                and b.nr_prescricao = a.nr_prescricao 
			                and e.cd_grupo_material = coalesce(cd_grupo_material_w, e.cd_grupo_material) 
			                and e.cd_subgrupo_material = coalesce(cd_subgrupo_material_w,e.cd_subgrupo_material) 
			                and e.cd_classe_material = coalesce(cd_classe_material_w,e.cd_classe_material) 
			                and e.cd_material = b.cd_material
			                and coalesce(b.dt_suspensao::text, '') = ''
			)  LIMIT 1;	

			if (qt_executada_periodo_w > qt_permitida_w) and
				((ie_prim_prescricao_w = 'S') or (ie_primeira_prescricao_w = 'N')) then
                 ds_material_prob_w	:= substr(ds_material_prob_w ||ds_material_w||' - '||qt_horas_intervalo_w||'h / ',1,2000);
			end if;
			
		end if;
	end if;
end loop;
close C01;

if (ds_material_prob_w IS NOT NULL AND ds_material_prob_w::text <> '') and
	((coalesce(ds_justificativa_w::text, '') = '') or (ie_permite_justif_w = 'N')) then
	ds_erro_w	:= qt_horas_intervalo_w||'h ';
end if;

ds_erro_p	:= ds_erro_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_interv_solic_mat_med ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

