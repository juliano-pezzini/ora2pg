-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_suspender_atend_dependente ( nr_seq_titular_p bigint, nr_seq_suspensao_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*

ie_opcao_p
S - Suspender os dependentes
D - Desfazer os dependentes
*/
nr_seq_segurado_w	bigint;
dt_prev_inicio_susp_w	timestamp;
dt_prev_fim_susp_w	timestamp;
dt_inicio_suspensao_w	timestamp;
dt_fim_suspensao_w	timestamp;
nr_seq_motivo_susp_w	bigint;
ds_motivo_fim_susp_w	varchar(4000);
nr_seq_suspensao_w	bigint;
dt_rescisao_w		timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_rescisao
	from	pls_segurado
	where	nr_seq_titular		= nr_seq_titular_p
	and	ie_situacao_atend	= 'A'
	and	ie_opcao_p		= 'S'
	
union

	SELECT	nr_sequencia,
		dt_rescisao
	from	pls_segurado
	where	nr_seq_titular		= nr_seq_titular_p
	and	ie_situacao_atend	= 'S'
	and	ie_opcao_p		= 'D';


BEGIN

select	dt_prev_inicio_susp,
	dt_prev_fim_susp,
	dt_fim_suspensao,
	nr_seq_motivo_susp,
	ds_motivo_fim_susp
into STRICT	dt_prev_inicio_susp_w,
	dt_prev_fim_susp_w,
	dt_fim_suspensao_w,
	nr_seq_motivo_susp_w,
	ds_motivo_fim_susp_w
from	pls_segurado_suspensao
where	nr_sequencia	= nr_seq_suspensao_p;

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	dt_rescisao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_opcao_p = 'S') then
		insert	into	pls_segurado_suspensao(	nr_sequencia,nm_usuario,dt_atualizacao,nm_usuario_nrec,dt_atualizacao_nrec,
				nr_seq_segurado,dt_prev_inicio_susp,dt_prev_fim_susp,dt_inicio_suspensao,
				nr_seq_motivo_susp,ds_observacao)
		values (	nextval('pls_segurado_suspensao_seq'),nm_usuario_p,clock_timestamp(),nm_usuario_p,clock_timestamp(),
				nr_seq_segurado_w,dt_prev_inicio_susp_w,dt_prev_fim_susp_w,clock_timestamp(),
				nr_seq_motivo_susp_w,'Gerado a partir da suspensão do titular');

		/*aaschlote 22/05/2012 - Apenas suspender caso a data seja menor ou atual, senão a JOB irá atualizar o atendimento*/

		if (trunc(dt_prev_inicio_susp_w,'dd') <= trunc(clock_timestamp(),'dd')) then
			update	pls_segurado
			set	ie_situacao_atend	= 'S',
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_sequencia		= nr_seq_segurado_w;
		end if;

	elsif (ie_opcao_p	= 'D') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_suspensao_w
		from	pls_segurado_suspensao
		where	nr_seq_segurado	= nr_seq_segurado_w
		and	coalesce(dt_fim_suspensao::text, '') = '';

		if (coalesce(nr_seq_suspensao_w,0) <> 0) then
			update	pls_segurado_suspensao
			set	dt_fim_suspensao	= dt_fim_suspensao_w,
				ds_motivo_fim_susp	= ds_motivo_fim_susp_w,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				ds_observacao		= chr(10)||'Gerado a partir da reativação do titular'
			where	nr_sequencia		= nr_seq_suspensao_w;

			if (coalesce(dt_rescisao_w::text, '') = '') then
				update	pls_segurado
				set	ie_situacao_atend	= 'A',
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_sequencia		= nr_seq_segurado_w;
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_suspender_atend_dependente ( nr_seq_titular_p bigint, nr_seq_suspensao_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

