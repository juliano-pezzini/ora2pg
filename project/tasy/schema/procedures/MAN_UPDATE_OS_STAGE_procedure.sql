-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_update_os_stage ( nr_seq_tipo_hist_p bigint, nr_seq_ordem_p bigint, ie_atualizar_os_p INOUT text) AS $body$
DECLARE


nr_seq_estagio_w		man_ordem_servico.nr_seq_estagio%type;
ie_area_gerencia_w 		gerencia_wheb.ie_area_gerencia%type;
nr_seq_estagio_os_w		man_ordem_serv_estagio.nr_sequencia%type;
ie_suporte_w			man_estagio_processo.ie_suporte%type;
ie_desenv_w				man_estagio_processo.ie_desenv%type;


BEGIN
	ie_atualizar_os_p := 'N';
	if (nr_seq_tipo_hist_p in (214, 215)) then
		nr_seq_estagio_w := 2577;
	elsif (nr_seq_tipo_hist_p in (216, 217, 218)) then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_estagio_os_w
	from (
			SELECT	a.nr_sequencia
			from	man_estagio_processo b,
					man_ordem_serv_estagio a
			where	a.nr_seq_ordem 		= nr_seq_ordem_p
			and		b.nr_sequencia 		= a.nr_seq_estagio
			and		b.nr_sequencia not in (2577, 2574)) alias4
	order by nr_sequencia desc;
	
	select	max(a.ie_suporte),
			max(a.ie_desenv)
	into STRICT	ie_suporte_w,
			ie_desenv_w
	from	man_estagio_processo a,
			man_ordem_serv_estagio b
	where	b.nr_sequencia = nr_seq_estagio_os_w
	and		b.nr_seq_estagio = a.nr_sequencia;

	if (ie_suporte_w = 'S') then
		nr_seq_estagio_w := 231;
	elsif (ie_desenv_w = 'S') then
		nr_seq_estagio_w := 1051;
	end if;
		
		select	max(ie_area_gerencia)
		into STRICT	ie_area_gerencia_w
		from	gerencia_wheb a,
				grupo_desenvolvimento b,
				man_ordem_servico c
		where	a.nr_sequencia = b.nr_seq_gerencia
		and		b.nr_sequencia = c.nr_seq_grupo_des
		and		c.nr_sequencia = nr_seq_ordem_p;
		
        if ie_area_gerencia_w = 'TEC' then
			nr_seq_estagio_w := 1731;
        end if;
	elsif (nr_seq_tipo_hist_p = 219) then
		nr_seq_estagio_w := 2574;
	end if;
	
	if (nr_seq_estagio_w IS NOT NULL AND nr_seq_estagio_w::text <> '' AND nr_seq_ordem_p IS NOT NULL AND nr_seq_ordem_p::text <> '') then
		update 	man_ordem_servico
		set	nr_seq_estagio = nr_seq_estagio_w
		where nr_sequencia = nr_seq_ordem_p;	
		ie_atualizar_os_p := 'S';
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_update_os_stage ( nr_seq_tipo_hist_p bigint, nr_seq_ordem_p bigint, ie_atualizar_os_p INOUT text) FROM PUBLIC;

