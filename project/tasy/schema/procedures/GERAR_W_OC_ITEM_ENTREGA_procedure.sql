-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_oc_item_entrega ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_ususario_p text, ie_exige_ocorrencia_p text) AS $body$
DECLARE




c01 CURSOR FOR
SELECT	dt_prevista_entrega,
	(qt_prevista_entrega - coalesce(qt_real_entrega,0)) qt_prevista_entrega,
	ds_observacao
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p
and	qt_prevista_entrega > coalesce(qt_real_entrega,0)
and	coalesce(dt_cancelamento::text, '') = ''
order by dt_prevista_entrega;

dt_prevista_entrega_w	ordem_compra_item_entrega.dt_prevista_entrega%type;
qt_prevista_entrega_w	ordem_compra_item_entrega.qt_prevista_entrega%type;
ds_observacao_w		ordem_compra_item_entrega.ds_observacao%type;
qt_registros_w		bigint;


BEGIN

if (ie_exige_ocorrencia_p = 'S') then

	select  count(*)
	into STRICT	qt_registros_w
	from    ordem_compra_registro_ocor
	where   nr_ordem_compra = nr_ordem_compra_p;

	if (qt_registros_w = 0) then
		-- Somente e permitido desdobrar as entregas do item se registrar alguma ocorrencia na ordem de compra.

                -- A ocorrencia e registrada atraves da opcao Gravar registro ocorrencia. Verifique o parametro [145].
		CALL wheb_mensagem_pck.exibir_mensagem_abort(182505);
	end if;

end if;

delete from W_OC_ITEM_ENTREGA
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p
and	nm_usuario = nm_ususario_p;

open C01;
loop
fetch C01 into
	dt_prevista_entrega_w,
	qt_prevista_entrega_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

     CALL grava_log_tasy(882,'qt_prevista_entrega_w=' || qt_prevista_entrega_w || ', nr_ordem_compra_p=' || nr_ordem_compra_p || ', nr_item_oci_p=' || nr_item_oci_p,'TASY');	

	insert into W_OC_ITEM_ENTREGA(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_ordem_compra,
		nr_item_oci,
		qt_prevista_entrega,
		dt_prevista_entrega,
		ds_observacao)
	values (nextval('w_oc_item_entrega_seq'),
		clock_timestamp(),
		nm_ususario_p,
		nr_ordem_compra_p,
		nr_item_oci_p,
		qt_prevista_entrega_w,
		dt_prevista_entrega_w,
		ds_observacao_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_oc_item_entrega ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_ususario_p text, ie_exige_ocorrencia_p text) FROM PUBLIC;

