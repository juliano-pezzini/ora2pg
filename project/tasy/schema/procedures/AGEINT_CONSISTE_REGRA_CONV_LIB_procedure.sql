-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_consiste_regra_conv_lib ( cd_convenio_p bigint, cd_categoria_p text, cd_agenda_p bigint, cd_setor_atendimento_p bigint, cd_plano_convenio_p text, cd_pessoa_fisica_p text, nr_seq_grupo_selec_p bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint default null) AS $body$
DECLARE


nr_seq_regra_w		bigint;	
ie_agenda_w		varchar(1);
ds_mensagem_w		varchar(255);
cd_especialidade_w	integer;
cd_medico_w		agenda.cd_pessoa_fisica%type;
cd_municipio_ibge_w	varchar(6);

c01 CURSOR FOR
	SELECT 	coalesce(a.nr_sequencia,0)
	FROM regra_agecons_convenio a
LEFT OUTER JOIN regra_agecons_conv_grupo b ON (a.nr_sequencia = b.nr_seq_regra_agecons)
WHERE ((a.cd_convenio = cd_convenio_p) or (coalesce(a.cd_convenio::text, '') = '')) and ((a.cd_agenda = cd_agenda_p) or (coalesce(a.cd_agenda::text, '') = '')) and ((a.cd_categoria = cd_categoria_p) or (coalesce(a.cd_categoria::text, '') = '')) and ((a.cd_plano_convenio = cd_plano_convenio_p) or (coalesce(a.cd_plano_convenio::text, '') = '')) and ((a.cd_setor_atendimento = cd_setor_atendimento_p) or (coalesce(a.cd_setor_atendimento::text, '') = '')) and ((a.cd_medico = cd_medico_w) or (coalesce(a.cd_medico::text, '') = '')) and ((a.cd_especialidade = cd_especialidade_w) or (coalesce(a.cd_especialidade::text, '') = '')) and ((a.cd_pessoa_fisica = cd_pessoa_fisica_p) or (coalesce(a.cd_pessoa_fisica::text, '') = '')) and ((b.nr_seq_grupo = nr_seq_grupo_selec_p) or (coalesce(b.nr_seq_grupo::text, '') = '')) and coalesce(dt_inicial_vigencia::text, '') = '' and coalesce(dt_final_vigencia::text, '') = '' and ((a.cd_municipio_ibge = cd_municipio_ibge_w) or (coalesce(a.cd_municipio_ibge::text, '') = '')) and (coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p or coalesce(cd_estabelecimento_p::text, '') = '')
	order 	by	coalesce(cd_pessoa_fisica,0),
			coalesce(cd_convenio,0), 
			coalesce(cd_setor_atendimento,0), 
			coalesce(cd_plano_convenio,0), 
			coalesce(cd_categoria,0),
			coalesce(cd_agenda,0),
			coalesce(cd_especialidade,0),
			coalesce(cd_medico,0),
			coalesce(b.nr_seq_grupo,0);


BEGIN

if (cd_convenio_p > 0) then

	select	max(cd_municipio_ibge)
	into STRICT	cd_municipio_ibge_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and		ie_tipo_complemento	= 1;

	select	max(cd_especialidade),
			max(cd_pessoa_fisica)
	into STRICT	cd_especialidade_w,
			cd_medico_w
	from	agenda
	where	cd_agenda = cd_agenda_p;

	open c01;
	loop
	fetch c01 into	
		nr_seq_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			nr_seq_regra_w := nr_seq_regra_w;
		end;
	end loop;
	close c01;

	if (nr_seq_regra_w > 0) then
			
		select	coalesce(max(ie_permite),'S'),
				coalesce(max(ds_mensagem),'')
		into STRICT	ie_agenda_w,
				ds_mensagem_w
		from	regra_agecons_convenio
		where	nr_sequencia = nr_seq_regra_w;

		if (ie_agenda_w = 'N') then		
			if (coalesce(ds_mensagem_w::text, '') = '') then
				ds_erro_p	:= wheb_mensagem_pck.get_texto(281816,null);
			else
				CALL Wheb_mensagem_pck.exibir_mensagem_abort( 262328 , 'DS_MENSAGEM='||ds_mensagem_w);
			end if;								
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_consiste_regra_conv_lib ( cd_convenio_p bigint, cd_categoria_p text, cd_agenda_p bigint, cd_setor_atendimento_p bigint, cd_plano_convenio_p text, cd_pessoa_fisica_p text, nr_seq_grupo_selec_p bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint default null) FROM PUBLIC;

