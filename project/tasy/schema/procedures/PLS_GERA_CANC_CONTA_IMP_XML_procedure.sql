-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gera_canc_conta_imp_xml ( nr_seq_lote_cancel_p pls_guia_plano_lote_cancel.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE

						 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Gerar o cancelamento das contas médicas conforme solicitado no pedido de cancelamento 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: Status utilizado no pedido de cancelamento 
1 Cancelado com sucesso  2 Não cancelado 3 Guia inexistente 4 Em processamento 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
qt_registros_w		bigint;
ie_estagio_w		varchar(2);

--Inicia com status 2 Não cancelado 
ie_status_w		pls_guia_plano_cancel.ie_status%type := '2';
ds_observacao_w		varchar(255) := '';

 
C01 CURSOR FOR 
	SELECT	a.nr_seq_guia, 
		a.nr_seq_requisicao, 
		a.nr_sequencia, 
		a.nr_protocolo_imp	 
	from	pls_guia_plano_cancel a 
	where	a.nr_seq_lote_cancel = nr_seq_lote_cancel_p 
	and	a.ie_status <> '3';

C02 CURSOR(nr_seq_guia_p 	pls_conta.nr_seq_guia%type)FOR 
	SELECT	nr_sequencia 
	from	pls_conta 
	where	nr_seq_guia = nr_seq_guia_p;
						
BEGIN 
 
for cr_01 in C01 loop 
	begin 
		 
	--Por padrão o status será 2 - Não cancelado, é aplicado quando não aplica o cancelamento na guia 
	ie_status_w := '2';
		 
	--alterações aldellandrea 
	for cr_02_w in C02(cr_01.nr_seq_guia) loop 
		begin 
		ds_observacao_w := pls_cancelar_conta(	cr_02_w.nr_sequencia, 0, nm_usuario_p, cd_estabelecimento_p, 1, ds_observacao_w, 'N'); --passando 0 para o nr_seq_motivo_cancelamento 
		ds_observacao_w := pls_cancelar_conta(	cr_02_w.nr_sequencia, 0, nm_usuario_p, cd_estabelecimento_p, 2, ds_observacao_w, 'N');
		ie_status_w := 1;
		end;
	end loop;
	--fim das alterações aldellandrea 
	--Atualizar status do pedido de cancelamento 
	CALL pls_atualiza_status_canc_tiss(cr_01.nr_sequencia, ie_status_w, nm_usuario_p );
		 
	end;
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gera_canc_conta_imp_xml ( nr_seq_lote_cancel_p pls_guia_plano_lote_cancel.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;

