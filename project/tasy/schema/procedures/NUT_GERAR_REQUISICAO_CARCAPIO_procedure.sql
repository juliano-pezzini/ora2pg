-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gerar_requisicao_carcapio ( nr_seq_ordem_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



				
nr_seq_local_w				bigint;
cd_setor_atendimento_w		integer;
cd_pessoa_fisica_w			varchar(10);
cd_local_estoque_w			bigint;
cd_operacao_estoque_w		smallint;
nr_requisicao_w				bigint;
cd_material_w				integer;
qt_componente_w				double precision;
cd_unidade_medida_estoque_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
qt_conversao_w				double precision;
nr_seq_req_item_w			bigint;
ie_gerar_req_ind_w			varchar(1);
cd_centro_custo_w			integer;
nr_sequencia_w				integer := 0;
ds_ordem_w				    varchar(80);
cd_unidade_medida_genero_w	varchar(30);
ds_erro_w				    varchar(4000);
ds_parametro_120_w  		varchar(1);
NR_SEQ_NUT_CARD_W           nut_cardapio_dia.nr_sequencia%type;
dt_cardapio_w				nut_cardapio_dia.dt_cardapio%type;

C01 CURSOR FOR
	SELECT	distinct
			x.nr_seq_local,
			f.cd_centro_custo
	FROM local_estoque z, nut_local_estoque y, nut_local_estoque_mat x, nut_cardapio d, nut_genero_alim c, nut_receita_comp b, nut_receita a, nut_cardapio_dia e
LEFT OUTER JOIN nut_local_refeicao f ON (e.nr_seq_local = f.nr_sequencia)
WHERE a.nr_sequencia 	   	= b.nr_seq_receita AND c.nr_sequencia 		= b.nr_seq_gen_alim AND ((ds_parametro_120_w = 'N' and d.nr_seq_card_dia 	= e.nr_sequencia)
  			or (ds_parametro_120_w = 'S' and d.nr_seq_card_dia 	= e.nr_sequencia and coalesce(e.nr_seq_cycle,0)>0)) AND a.nr_sequencia 		= d.nr_seq_receita AND x.cd_material		= c.cd_material and x.nr_seq_local 		= y.nr_sequencia and y.nr_seq_local_estoque 	= z.cd_local_estoque and z.cd_estabelecimento 	= cd_estabelecimento_p  AND e.nr_sequencia IN (SELECT nr_seq_cardapio
	   					   FROM   nut_ordem_prod_card
						   WHERE  nr_seq_ordem   = nr_seq_ordem_p) order by 1;

C02 CURSOR FOR  									
	SELECT	DISTINCT(c.cd_material),
			g.qt_refeicao,
			substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
			substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
			e.dt_cardapio,
			c.qt_conversao,
			coalesce(c.cd_unidade_medida,'G')
	FROM material m, nut_ordem_prod_card g, nut_cardapio d, nut_genero_alim c, nut_receita_comp b, nut_receita a, nut_cardapio_dia e
LEFT OUTER JOIN nut_local_refeicao f ON (e.nr_seq_local = f.nr_sequencia)
WHERE a.nr_sequencia 		= b.nr_seq_receita AND c.nr_sequencia 		= b.nr_seq_gen_alim AND ((ds_parametro_120_w = 'N' and d.nr_seq_card_dia 	= e.nr_sequencia)
			or (ds_parametro_120_w = 'S' and d.nr_seq_card_dia 	= e.nr_sequencia and coalesce(e.nr_seq_cycle,0)>0)) AND a.nr_sequencia 		= d.nr_seq_receita AND m.cd_material		= c.cd_material  AND e.nr_sequencia	    = g.nr_seq_cardapio and g.nr_seq_ordem   = nr_seq_ordem_p AND nr_seq_local_w		= (SELECT MAX(x.nr_seq_local) 
						FROM	nut_local_estoque_mat x,
								nut_local_estoque y,
								local_estoque z
					   WHERE	x.cd_material = c.cd_material
						and 	x.nr_seq_local = y.nr_sequencia
						and 	y.nr_seq_local_estoque = z.cd_local_estoque
						and 	z.cd_estabelecimento = cd_estabelecimento_p) AND coalesce(f.cd_centro_custo,0)	= coalesce(cd_centro_custo_w,0)
	GROUP 	BY c.cd_material,
            g.qt_refeicao,
			substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30),
			substr(obter_dados_material_estab(c.cd_material,
			cd_estabelecimento_p,'UME'),1,30),
			e.dt_cardapio,
			c.qt_conversao,
			coalesce(c.cd_unidade_medida,'G');

C04 CURSOR FOR
	SELECT	g.nr_sequencia,
			g.cd_material
	from	nut_receita a,
			nut_receita_comp b,
			nut_ordem_prod_card h,
			nut_cardapio d,
			nut_genero_alim c,
			item_requisicao_material g
	where	a.nr_sequencia 		= b.nr_seq_receita	
	and		c.nr_sequencia 		= b.nr_seq_gen_alim
	and		d.nr_seq_card_dia	= h.nr_seq_cardapio
	and		a.nr_sequencia 		= d.nr_seq_receita
	and		c.cd_material		= g.cd_material
	and		coalesce(c.ie_arred_req,'N') = 'S'
	and		g.nr_requisicao 	= nr_requisicao_w
	and		h.nr_seq_ordem		= nr_seq_ordem_p
	group 	by g.nr_sequencia,
			g.cd_material;


BEGIN
if (nr_seq_ordem_p IS NOT NULL AND nr_seq_ordem_p::text <> '') then
ds_parametro_120_w := obter_valor_param_usuario(1003,120,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
	select	cd_setor_atendimento,
			cd_pessoa_fisica
	into STRICT	cd_setor_atendimento_w,
			cd_pessoa_fisica_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;	

	select 	max(cd_operacao_estoque),
			max(ds_ordem)
	into STRICT	cd_operacao_estoque_w,
			ds_ordem_w
	from 	nut_ordem_prod
	where	nr_sequencia	= nr_seq_ordem_p;

	ie_gerar_req_ind_w := obter_param_usuario(1003, 88, Obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_req_ind_w);

	open C01;
	loop
	fetch C01 into	
		nr_seq_local_w,
		cd_centro_custo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select 	nr_seq_local_estoque
		into STRICT	cd_local_estoque_w
		from	nut_local_estoque
		where	nr_sequencia	= nr_seq_local_w;

		ds_erro_w	:= '';

		if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(783994);
		end if;

		if (coalesce(cd_operacao_estoque_w::text, '') = '') then
			if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
				ds_erro_w	:= ds_erro_w || chr(10) || chr(13);
			end if;

			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(783998);
		end if;

		if (coalesce(cd_local_estoque_w::text, '') = '') then
			if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
				ds_erro_w	:= ds_erro_w || chr(10) || chr(13);
			end if;

			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(783999);
		end if;

		begin
		select	nextval('requisicao_seq')
		into STRICT	nr_requisicao_w
		;

		insert into requisicao_material(	nr_requisicao,
				cd_estabelecimento,
				cd_setor_atendimento,
				cd_local_estoque,
				dt_solicitacao_requisicao,
				dt_atualizacao,
				nm_usuario,
				cd_operacao_estoque,
				cd_pessoa_requisitante,
				cd_estabelecimento_destino,
				cd_local_estoque_destino,
				ie_urgente,
				ds_observacao,
				cd_centro_custo)
		values (	nr_requisicao_w,
				cd_estabelecimento_p,
				cd_setor_atendimento_w,
				cd_local_estoque_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				cd_operacao_estoque_w,
				cd_pessoa_fisica_w,
				cd_estabelecimento_p,
				null,
				'N',
				wheb_mensagem_pck.get_texto(303619,'NR_SEQ_ORDEM_P='|| nr_seq_ordem_p ||';DS_ORDEM_W='|| ds_ordem_w), /*'Gerada pela funcao Gestao da Nutricao a partir da ordem na '||nr_seq_ordem_p||' - '||ds_ordem_w,*/
				cd_centro_custo_w);

		insert into nut_ordem_prod_req(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_ordem,
				nr_requisicao)
		values (	nextval('nut_ordem_prod_req_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_ordem_p,
				nr_requisicao_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(192874,'DS_ERRO=' || ds_erro_w);
            RAISE;
		end;

		open C02;
		loop
		fetch C02 into	
			cd_material_w,
			qt_componente_w,
			cd_unidade_medida_consumo_w,
			cd_unidade_medida_estoque_w,
			dt_cardapio_w,
			qt_conversao_w,
			cd_unidade_medida_genero_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			if (coalesce(qt_componente_w, 0) = 0) then
				begin
				--Deve ser informada a quantidade de refeicoes no planejamento ou cardapio conforme parametro [88]!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1039798);
				end;
			end if;

			if (upper(cd_unidade_medida_consumo_w) <> upper(cd_unidade_medida_genero_w)) then			
				qt_componente_w	:= Obter_dose_convertida(cd_material_w,qt_componente_w,cd_unidade_medida_genero_w,cd_unidade_medida_consumo_w);
			end if;

			select 	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_req_item_w
			from	item_requisicao_material
			where	nr_requisicao	= nr_requisicao_w;

			insert into item_requisicao_material(	nr_requisicao,
					nr_sequencia,
					cd_estabelecimento,
					cd_material,
					qt_material_requisitada,
					qt_material_atendida,
					vl_material,
					dt_atualizacao,
					nm_usuario,
					cd_unidade_medida,
					qt_estoque,
					cd_unidade_medida_estoque,
					ie_acao,
					cd_motivo_baixa)
			values (	nr_requisicao_w,
					nr_seq_req_item_w,
					cd_estabelecimento_p,
					cd_material_w,
					qt_componente_w,
					0,
					0,
					clock_timestamp(),
					nm_usuario_p,
					cd_unidade_medida_consumo_w,
					qt_componente_w,
					cd_unidade_medida_consumo_w,
					'1',
					0);
			end;
		end loop;
		close C02;

		open C04;
		loop
		fetch C04 into	
			nr_sequencia_w,
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			update	item_requisicao_material
			set		qt_estoque 		= ceil(qt_estoque),
					qt_material_requisitada	= ceil(qt_material_requisitada)
			where	nr_requisicao		= nr_requisicao_w
			and		nr_sequencia		= nr_sequencia_w
			and		cd_material		= cd_material_w;
			end;
		end loop;
		close C04;
		end;
	end loop;
	close C01;	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gerar_requisicao_carcapio ( nr_seq_ordem_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

