-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atend_pac_carat_int () AS $body$
DECLARE



vl_dominio_w		varchar(15);
ds_valor_dominio_w	varchar(255);
qt_reg_carater_w	integer	:= 0;
qt_registro_w		integer	:= 0;
qt_reg_novo_w		bigint	:= 0;


c01 CURSOR FOR
	SELECT	substr(vl_dominio,1,2),
		ds_valor_dominio
	from	valor_dominio
	where	cd_dominio	= 802
	order by 1;



BEGIN

OPEN C01;
	LOOP
	FETCH C01 into
		vl_dominio_w,
		ds_valor_dominio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		select	count(*)
		into STRICT	qt_reg_carater_w
		from	sus_carater_internacao
		where	cd_carater_internacao	= vl_dominio_w;

		if (qt_reg_carater_w	= 0) then
			insert into sus_carater_internacao(cd_carater_internacao,
				ds_carater_internacao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (vl_dominio_w,
				substr(ds_valor_dominio_w,1,100),
				clock_timestamp(),
				'Baca',
				clock_timestamp(),
				'Baca');
		end if;
	end LOOP;
CLOSE C01;

update	sus_carater_internacao
set	dt_inicio_validade	= to_date('01/01/2008','dd/mm/yyyy'),
	dt_fim_validade		= to_date('31/12/2099','dd/mm/yyyy')
where	cd_carater_internacao in ('01','02','03','04','05','06')
and	coalesce(dt_inicio_validade::text, '') = '';

select	count(*)
into STRICT	qt_reg_novo_w
from 	sus_carater_internacao
where	cd_carater_internacao in ('01','02','03','04','05','06');

update	sus_carater_internacao
set	dt_inicio_validade	= to_date('01/01/2000','dd/mm/yyyy'),
	dt_fim_validade		= CASE WHEN qt_reg_novo_w=0 THEN  null  ELSE to_date('31/12/2007','dd/mm/yyyy') END
where	cd_carater_internacao not in ('01','02','03','04','05','06')
and	coalesce(dt_inicio_validade::text, '') = '';


select	count(*)
into STRICT	qt_registro_w
from	user_cons_columns
where	constraint_name	= 'ATEPACI_SUSCAIN_FK'
and	column_name	= 'IE_CARATER_INTER_SUS';
if (qt_registro_w = 0) then
	CALL Exec_sql_Dinamico('Felipe',	'	ALTER TABLE ATENDIMENTO_PACIENTE ADD ' ||
					'	(CONSTRAINT ATEPACI_SUSCAIN_FK FOREIGN KEY (IE_CARATER_INTER_SUS) ' ||
					'	REFERENCES SUS_CARATER_INTERNACAO (CD_CARATER_INTERNACAO) ');

	CALL Exec_sql_Dinamico('Felipe',	'	CREATE INDEX ATEPACI_SUSCAIN_FK_I ON ATENDIMENTO_PACIENTE(IE_CARATER_INTER_SUS) ');
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atend_pac_carat_int () FROM PUBLIC;

