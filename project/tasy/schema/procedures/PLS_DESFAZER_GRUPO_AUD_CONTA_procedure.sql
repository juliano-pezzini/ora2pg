-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_grupo_aud_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE

				
cd_guia_w			varchar(20);
nr_lote_w			bigint;
nr_seq_prestador_w		bigint;
nr_seq_segurado_w		bigint;
ds_conta_w			varchar(255);
nr_seq_conta_atual_w		bigint;
nr_seq_ocor_conta_princ_w	bigint;
nr_seq_grupo_conta_princ_w	bigint;
ds_conta_ww			varchar(255);
ds_conta_www			varchar(255);
nr_seq_grupo_w			bigint;
nr_seq_analise_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_conta
	from	pls_auditoria_conta_grupo
	where	position(nr_seq_conta_p  ds_conta) > 0
	and	nr_seq_analise = nr_seq_analise_w;


BEGIN

select	max(coalesce(a.cd_guia_referencia,a.cd_guia)),
	max(nr_seq_lote_conta),
	max(coalesce(a.nr_seq_prestador,a.nr_seq_prestador_exec)),
	max(a.nr_seq_segurado)
into STRICT	cd_guia_w,
	nr_lote_w,
	nr_seq_prestador_w,
	nr_seq_segurado_w
from	pls_conta a,
	pls_protocolo_conta b
where	a.nr_seq_protocolo = b.nr_sequencia
and	a.nr_sequencia	= nr_seq_conta_p;
	
if (coalesce(cd_guia_w,'0') <> '0') then	
	/*Verifica se existe analise para a guia obtida*/
	
	begin
	select	nr_sequencia	
	into STRICT	nr_seq_analise_w		
	from	pls_analise_conta
	where	cd_guia = cd_guia_w
	and	coalesce(nr_seq_lote_protocolo,0) = coalesce(nr_lote_w,0);
	exception
	when others then
		nr_seq_analise_w := 0;	
	end;
	
	if (coalesce(nr_seq_analise_w,0) <> 0) then		
		
		/*Cursor para percorrer os grupos da analise*/

		open C01;
		loop
		fetch C01 into	
			nr_seq_grupo_w,
			ds_conta_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			/*Removermos da string principal o parametro (primeira linha caso seja )o primeiro do string)
			    Ou (na segunda linha)  caso esteja no meio da string*/
			select	replace(ds_conta_w, to_char(nr_seq_conta_p),''),
				replace(ds_conta_w,','||to_char(nr_seq_conta_p),'')
			into STRICT	ds_conta_ww,
				ds_conta_www
			;	
			
			/* Verifica-se qual das string é menor
			     A string menor é a que foi modificada*/
			if (length(ds_conta_ww) > length(ds_conta_www)) then
				ds_conta_w	:= ds_conta_www;
				/*Caso a primeira letra seja uma virgula é removida*/

				if (position(',' in ds_conta_w) = 1) then
					ds_conta_w := substr(ds_conta_w, position(',' in ds_conta_w) + 1, length(ds_conta_w));
				end if;
			else
				ds_conta_w := ds_conta_ww;
				if (position(',' in ds_conta_w) = 1) then
					ds_conta_w := substr(ds_conta_w, position(',' in ds_conta_w) + 1, length(ds_conta_w));
				end if;
			end if;		
			
			update	pls_auditoria_conta_grupo
			set	ds_conta	= ds_conta_w,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia = nr_seq_grupo_w;			
			
			if (coalesce(ds_conta_w,'0') = '0') then

				delete	FROM pls_tempo_conta_grupo
				where	nr_seq_auditoria = nr_seq_grupo_w;
			
				delete	FROM pls_auditoria_conta_grupo
				where	nr_sequencia = nr_seq_grupo_w;		
			end if;			
			
			end;
		end loop;
		close C01;
		
	end if;
	
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_grupo_aud_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

