-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dar_criar_relat_dinamico (nr_seq_relatorio_p relatorio.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


ie_tipo_banda_w 	  banda_relatorio.ie_tipo_banda%type;
nr_seq_banda_w    	banda_relatorio.nr_sequencia%type;
ie_ultima_banda_w    banda_relatorio.ie_tipo_banda%type;
qt_relat_dinamico_w  bigint;
ds_banda_w          banda_relatorio.ds_banda%type;
nr_seq_apresentacao_w  banda_relatorio.nr_seq_apresentacao%type;

C01 CURSOR FOR
	SELECT 	d.*
	from 	  relatorio r, relatorio_dinamico d
	where 	d.nr_seq_relatorio = r.nr_sequencia
	and 	  r.nr_sequencia = nr_seq_relatorio_p
  order by d.nr_tipo_banda, 
           d.nr_seq_apres;

BEGIN

  select 	count(1)
  into STRICT    qt_relat_dinamico_w
	from 	  relatorio r, relatorio_dinamico d
	where 	d.nr_seq_relatorio = r.nr_sequencia
	and 	  r.nr_sequencia = nr_seq_relatorio_p;

  if (qt_relat_dinamico_w = 0) then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1129138);
  end if;

	for r_c01_w in C01 loop
	begin
    select  CASE WHEN r_c01_w.nr_tipo_banda=1 THEN  'C' WHEN r_c01_w.nr_tipo_banda=2 THEN  'S' WHEN r_c01_w.nr_tipo_banda=3 THEN  'S' WHEN r_c01_w.nr_tipo_banda=4 THEN  'R' END
    into STRICT    ie_tipo_banda_w 
;

    if (ie_ultima_banda_w <> ie_tipo_banda_w) then
      nr_seq_banda_w := null;
    end if;

    if (coalesce(nr_seq_banda_w::text, '') = '') then
      select  CASE WHEN r_c01_w.nr_tipo_banda=1 THEN  wheb_mensagem_pck.get_texto(307800) WHEN r_c01_w.nr_tipo_banda=2 THEN  wheb_mensagem_pck.get_texto(1128827) WHEN r_c01_w.nr_tipo_banda=3 THEN wheb_mensagem_pck.get_texto(1128828) WHEN r_c01_w.nr_tipo_banda=4 THEN  wheb_mensagem_pck.get_texto(307801) END
      into STRICT    ds_banda_w
;
      nr_seq_apresentacao_w := r_c01_w.nr_tipo_banda;

      insert into banda_relatorio(nr_sequencia, ds_banda, ie_tipo_banda, nr_seq_apresentacao, nm_usuario,
							    dt_atualizacao, qt_altura, ds_cor_fundo, ie_quebra_pagina, ie_reimprime_nova_pagina, ie_alterna_cor_fundo,
							    ie_imprime_vazio, ie_imprime_primeiro, ie_borda_sup, ie_borda_inf, ie_borda_esq,
							    ie_borda_dir, nr_seq_relatorio, nr_seq_banda_superior, nm_tabela, ds_sql, 
							    ds_expressao, ds_cor_header, ds_cor_footer, ds_cor_quebra, ds_regra, 
							    ie_banda_padrao, qt_max_registro, ds_observacao, ie_direction, ie_fundo_transparente) 
			values (nextval('banda_relatorio_seq'), ds_banda_w, ie_tipo_banda_w, nr_seq_apresentacao_w, nm_usuario_p, 
					clock_timestamp(), 18, 'clWhite', 'N', 'N', 'N',
					'N', 'N', 'N', 'N', 'N', 
					'N', nr_seq_relatorio_p, null, null, r_c01_w.ds_sql,
					null, 'clSilver', 'clWhite', '$00E5E5E5', null, 
					'N', null, null, 'N', 'N') returning nr_sequencia into nr_seq_banda_w;

          ie_ultima_banda_w := ie_tipo_banda_w;
    end if;

    insert into banda_relat_campo(nr_sequencia, nr_seq_banda, ds_campo, ds_label, nr_seq_apresentacao,
						       ie_tipo_campo, qt_altura, qt_tamanho, nm_atributo, qt_topo,
						       qt_esquerda, ds_tipo_fonte, qt_tam_fonte, ds_cor_label, ds_conteudo, 
						       nm_usuario, dt_atualizacao, ds_cor_fundo, ie_ajustar_tamanho, ie_borda_sup, 
						       ie_borda_inf, ie_borda_esq, ie_borda_dir, ie_totalizar, ie_campo_quebra, 
						       ie_quebra_pagina, ie_zera_apos_imprimir, ie_transparente, ie_alinhamento,  ie_estender, 
						       ie_alinhar_banda,DS_COR_FONTE) 
    values (nextval('banda_relat_campo_seq'), nr_seq_banda_w, r_c01_w.nm_label, r_c01_w.ds_label, r_c01_w.nr_seq_apres,
			  0, r_c01_w.nr_altura, r_c01_w.nr_comprimento, r_c01_w.nm_label, r_c01_w.nr_eixo_y, 
				r_c01_w.nr_eixo_x, coalesce(r_c01_w.ie_tipo_fonte,'Arial'), r_c01_w.nr_tam_fonte, coalesce(r_c01_w.ds_cor_fundo_label,'clWhite'), null, 
				nm_usuario_p, clock_timestamp(), coalesce(r_c01_w.ds_cor_fundo_descricao,'clWhite'), r_c01_w.ie_ajustar_tamanho, 'N',
				'N', 'N', 'N', 'N', 'N',
				'N', 'N', 'S', 'E', 'N',
        'N','clBlack');

	end;
	end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dar_criar_relat_dinamico (nr_seq_relatorio_p relatorio.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

