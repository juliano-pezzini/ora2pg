-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_desdobrar_lote_fornec ( nr_sequencia_p bigint, nr_item_nf_p bigint, nr_seq_item_lote_p bigint, qt_gerar_p bigint, nm_usuario_p text, ie_commitar_p text default 'S') AS $body$
DECLARE


cd_cgc_emitente_w		varchar(14);
cd_estabelecimento_w		smallint;
cd_lote_fabricacao_w		varchar(20);
cd_material_w			integer;
dt_validade_w			timestamp;
i				bigint;
nr_nota_fiscal_w		varchar(255);
nr_sequencia_w			bigint;
qt_gerar_w			bigint;
nr_seq_marca_w			bigint;
ie_tipo_programa_w		nota_fiscal_item.ie_tipo_programa%type;
ie_classif_rename_w		nota_fiscal_item.ie_classif_rename%type;
ie_origem_manual_w		nota_fiscal_item.ie_origem_manual%type;

BEGIN

qt_gerar_w	:= round((qt_gerar_p)::numeric,0);

if (coalesce(nr_seq_item_lote_p, 0) = 0) then
	select	a.cd_material,
		a.cd_lote_fabricacao,
		a.dt_validade,
		a.nr_nota_fiscal,
		coalesce(a.nr_seq_marca,0),
		ie_tipo_programa,
		ie_classif_rename,
        ie_origem_manual
	into STRICT	cd_material_w,
		cd_lote_fabricacao_w,
		dt_validade_w,
		nr_nota_fiscal_w,
		nr_seq_marca_w,
		ie_tipo_programa_w,
		ie_classif_rename_w,
        ie_origem_manual_w
	from	nota_fiscal_item a
	where	nr_sequencia		= nr_sequencia_p
	and	nr_item_nf		= nr_item_nf_p
	and	(cd_lote_fabricacao IS NOT NULL AND cd_lote_fabricacao::text <> '');
else	
	select	a.cd_material,
		b.cd_lote_fabricacao,
		b.dt_validade,
		a.nr_nota_fiscal,
		coalesce(b.nr_seq_marca,0),
		ie_tipo_programa,
		ie_classif_rename
	into STRICT	cd_material_w,
		cd_lote_fabricacao_w,
		dt_validade_w,
		nr_nota_fiscal_w,
		nr_seq_marca_w,
		ie_tipo_programa_w,
		ie_classif_rename_w
	from	nota_fiscal_item a,
		nota_fiscal_item_lote b
	where	b.nr_seq_nota		= a.nr_sequencia
	and	b.nr_item_nf		= a.nr_item_nf
	and	b.nr_sequencia		= nr_seq_item_lote_p
	and	a.nr_sequencia		= nr_sequencia_p
	and	coalesce(a.cd_lote_fabricacao::text, '') = '';
end if;


select	max(cd_estabelecimento),
	max(cd_cgc_emitente)
into STRICT	cd_estabelecimento_w,
	cd_cgc_emitente_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

for i in 1..qt_gerar_w loop
	begin
	
	select	nextval('material_lote_fornec_seq')
	into STRICT	nr_sequencia_w
	;

	insert into material_lote_fornec(
		nr_sequencia,
		cd_material,
		nr_digito_verif,
		dt_atualizacao,
		nm_usuario,
		ds_lote_fornec,
		dt_validade,
		cd_cgc_fornec,
		nr_sequencia_nf,
		nr_item_nf,
		qt_material,
		cd_estabelecimento,
		nr_seq_marca,
		ie_origem_lote,
		ie_validade_indeterminada,
		ie_situacao,
		nr_nota_fiscal,
		ie_tipo_programa,
		ie_classif_rename,
        ie_origem_manual)
	values (	nr_sequencia_w,
		cd_material_w,
		calcula_digito('Modulo11', nr_sequencia_w),
		clock_timestamp(),
		nm_usuario_p,
		cd_lote_fabricacao_w,
		dt_validade_w,
		cd_cgc_emitente_w,
		nr_sequencia_p,
		nr_item_nf_p,
		1,
		cd_estabelecimento_w,
		CASE WHEN nr_seq_marca_w=0 THEN null  ELSE nr_seq_marca_w END ,
		'N',
		CASE WHEN coalesce(dt_validade_w::text, '') = '' THEN  'S'  ELSE 'N' END ,
		'A',
		nr_nota_fiscal_w,
		ie_tipo_programa_w,
		ie_classif_rename_w,
        ie_origem_manual_w);

	/*Atualiza a sequencia criada do lote no item da nota fiscal ou na itens por lote*/

	if (coalesce(nr_seq_item_lote_p, 0) = 0) then
		update	nota_fiscal_item
		set	nr_seq_lote_fornec	= nr_sequencia_w
		where	nr_sequencia	= nr_sequencia_p
		and	nr_item_nf	= nr_item_nf_p;
	else
		update	nota_fiscal_item_lote
		set	nr_seq_lote_fornec	= nr_sequencia_w
		where	nr_sequencia	= nr_seq_item_lote_p;
	end if;


	end;
end loop;

if (coalesce(ie_commitar_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_desdobrar_lote_fornec ( nr_sequencia_p bigint, nr_item_nf_p bigint, nr_seq_item_lote_p bigint, qt_gerar_p bigint, nm_usuario_p text, ie_commitar_p text default 'S') FROM PUBLIC;

