-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_justif_rat ( nr_seq_projeto_p bigint, nr_seq_rat_p bigint, nr_seq_rat_ativ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_coordenador_w		varchar(10);
ds_comunicado_w			varchar(4000);
ds_etapa_w				varchar(255);
ds_justificativa_w		varchar(2000);
ds_titulo_w				varchar(80);
ds_titulo_ci_w			varchar(255);
nm_consultor_w			varchar(255);
nm_usuario_destino_w	varchar(15);
qt_registros_w			bigint;


BEGIN
-- Monta o título da CI
ds_titulo_ci_w := substr('Justificativa no Rat ' || nr_seq_rat_p,1,255);

-- Busca o título e o coordenador do projeto
select	max(substr(ds_titulo,1,80)),
		max(coalesce(cd_coordenador, 0))
into STRICT	ds_titulo_w,
		cd_coordenador_w
from	proj_projeto
where	nr_sequencia = nr_seq_projeto_p;

-- Busca o usuário do coordenador do projeto
select	count(*)
into STRICT	qt_registros_w
from	usuario
where	cd_pessoa_fisica = cd_coordenador_w;

if (qt_registros_w > 0) then
	select	max(nm_usuario)
	into STRICT	nm_usuario_destino_w
	from	usuario
	where	cd_pessoa_fisica = cd_coordenador_w;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191476);
end if;

-- Busca o nome do consultor da atividade
select	substr(obter_nome_pf(cd_executor),1,255)
into STRICT	nm_consultor_w
from	proj_rat
where	nr_sequencia = nr_seq_rat_p;

-- Busca o título da etapa e o texto da justificativa
select	substr(trim(both e.ds_atividade),1,255),
	substr(r.ds_justificativa,1,2000)
into STRICT	ds_etapa_w,
	ds_justificativa_w
from	proj_rat_ativ r,
	proj_cron_etapa e
where	e.nr_sequencia = r.nr_seq_etapa_cron
and	r.nr_sequencia = nr_seq_rat_ativ_p;

-- Monta o comunicado
ds_comunicado_w	:= substr(	'Número da Rat: ' 			||	nr_seq_rat_p		|| chr(13) || chr(10) ||
							obter_desc_expressao(296535)/*'Projeto: '*/
 ||': '||	ds_titulo_w			|| chr(13) || chr(10) ||
							obter_desc_expressao(285919)/*'Consultor: '*/
 ||': '||	nm_consultor_w		|| chr(13) || chr(10) ||
							'Atividade da Rat: '		||	ds_etapa_w			|| chr(13) || chr(10) ||
							'Justificativa da Rat: '	||	ds_justificativa_w, 1, 4000);

-- Gera a comunicação interna
CALL gerar_comunic_padrao(	'',
			ds_titulo_ci_w,
			ds_comunicado_w,
			nm_usuario_p,
			'N',
			nm_usuario_destino_w,
			'N',
			'',
			'',
			cd_estabelecimento_p,
			'',
			clock_timestamp(),
			'',
			'');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_justif_rat ( nr_seq_projeto_p bigint, nr_seq_rat_p bigint, nr_seq_rat_ativ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

