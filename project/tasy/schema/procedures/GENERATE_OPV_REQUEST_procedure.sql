-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_opv_request ( cd_estabelecimento_p bigint, CD_PESSOA_FISICA_P text default null, nm_usuario_p text DEFAULT NULL, nr_atendimento_p bigint default null, ie_calling_point_p text DEFAULT NULL, -- 'M' -> Master person index, 'P' -> Patient registeration
 cd_seq_transaction_p INOUT text DEFAULT NULL, cd_error_string_p INOUT text DEFAULT NULL) AS $body$
DECLARE

dt_atualizacao_nrec_w		timestamp;
nm_usuario_nrec_w		varchar(15);
nm_alias_family_w		varchar(40);
nm_alias_first_w		varchar(40);
dt_birth_w			timestamp;
nm_family_w			varchar(40);
nm_first_w			varchar(40);
cd_fund_card_w			varchar(20);
cd_upi_w			bigint;
ie_gender_w			varchar(10);
cd_medicare_card_w		varchar(10);
nr_patient_num_w		bigint := 1;
cd_provider_w			varchar(10);
nr_seq_opv_w			bigint;
cd_externo_w			varchar(10);
nr_seq_opv_patient_w		bigint;
cd_seq_transaction_w		varchar(25);
cd_pessoa_fisica_w		varchar(10);
cd_attribute_w			varchar(50);
cd_field_name_w     		varchar(50);

c03 CURSOR FOR

SELECT	nm_eclipse_field,
	nm_atributo	
from	eclipse_attribute
where	ie_condition in ('M','C')
and 	ie_opv ='S';

BEGIN

select	nextval('opv_request_seq')
into STRICT   	nr_seq_opv_w
;

select	nextval('opv_request_patient_seq')
into STRICT	nr_seq_opv_patient_w
;

if ( ie_calling_point_p = 'M') then

	select 	max(substr(a.cd_usuario_convenio, 1, 10)) cd_fund_card,
		max(substr(a.cd_complemento, 1,2))  cd_upi,
		max(b.cd_externo) ,
		generaterandomnumber cd_seq_transaction
	into STRICT 	cd_fund_card_w,
		cd_upi_w,
		cd_externo_w,
		cd_seq_transaction_w		
	from    pessoa_titular_convenio a,
		convenio b          
	where   a.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
	and     a.CD_CONVENIO = b.CD_CONVENIO
	and     b.IE_TIPO_CONVENIO  = 2    	--Private
  LIMIT 1;

	select 	max(substr(a.cd_usuario_convenio, 1, 10)) cd_medicare_card, 
		max(substr(a.CD_USUARIO_CONVENIO_TIT, 1,2))  nr_patient_num
	into STRICT 	cd_medicare_card_w,
		nr_patient_num_w		
	from    pessoa_titular_convenio a,
		convenio b          
	where   a.CD_PESSOA_FISICA = CD_PESSOA_FISICA_P
	and     a.CD_CONVENIO = b.CD_CONVENIO
	and     b.IE_TIPO_CONVENIO  = 12  	-- Medicare
  LIMIT 1;
	
	elsif (ie_calling_point_p = 'P') then

	select	max(d.cd_usuario_convenio)  cd_fund_card,
		max(substr(d.cd_complemento, 1,2))  cd_upi,
		max(a.cd_medico_atendimento) cd_provider,
		max(e.cd_externo) CD_FUND_BRAND,
		generaterandomnumber cd_seq_transaction
	into STRICT   	cd_fund_card_w,
		cd_upi_w,
		cd_provider_w,
		cd_externo_w,
		cd_seq_transaction_w
	from 	atendimento_paciente a,
		atend_categoria_convenio d,
		convenio e	
	where	a.nr_atendimento 	= nr_atendimento_p
	and	a.nr_atendimento 	= d.nr_atendimento
	and 	coalesce(d.DT_FINAL_VIGENCIA::text, '') = ''
	and 	d.CD_CONVENIO = e.CD_CONVENIO
	and 	e.IE_TIPO_CONVENIO  	= 2		-- Private
  LIMIT 1;
	
	select	max(substr(d.cd_usuario_convenio, 1, 10))  cd_medicare_card,
		max(d.cd_complemento) nr_patient_num
	into STRICT  	cd_medicare_card_w,
		nr_patient_num_w
	from 	atendimento_paciente a,
		atend_categoria_convenio d,
		convenio e
	where	a.nr_atendimento 	= nr_atendimento_p
	and	a.nr_atendimento 	= d.nr_atendimento
	and 	e.CD_CONVENIO 		= d.CD_CONVENIO
	and 	e.IE_TIPO_CONVENIO  	= 12		-- MEDICARE
  LIMIT 1;

end if;

for r03 in c03	loop
	cd_attribute_w := r03.nm_atributo;
	cd_field_name_w :=  r03.nm_eclipse_field;

	if (cd_field_name_w = 'FundBrandId') then
		if (coalesce(cd_externo_w::text, '') = '' ) then

			cd_error_string_p := cd_error_string_p || cd_field_name_w||',';
		end if;
	end if;
end loop;

if (coalesce(cd_error_string_p::text, '') = '') then

	insert into opv_request(nr_sequencia,
		cd_pessoa_fisica,  
		ie_status_tasy,     
		dt_atualizacao,    
		nm_usuario,      
		dt_atualizacao_nrec,  
		nm_usuario_nrec, 
		vl_time_out,  
		dt_service , 
		cd_fund_brand,
		ie_opv_type,
		nr_seq_transaction,
    NR_ATENDIMENTO)
	values (	nr_seq_opv_w,
		CD_PESSOA_FISICA_P,
		'E',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		24,
		clock_timestamp(), 
		cd_externo_w, 
		'OPV',
		cd_seq_transaction_w,
    nr_atendimento_p);
	commit;
end if;

select	max(pkg_name_utils.get_person_name(b.nr_seq_person_name,cd_estabelecimento_p,'givenName')) nm_first,
	max(pkg_name_utils.get_person_name(b.nr_seq_person_name,cd_estabelecimento_p,'familyName')) nm_family,
	max(b.dt_nascimento) dt_birth,
	max(pkg_name_utils.get_person_name(b.nr_seq_person_name,cd_estabelecimento_p,'givenName'))  nm_alias_first,
	max(pkg_name_utils.get_person_name(b.nr_seq_person_name,cd_estabelecimento_p,'familyName')) nm_alias_family,	
	max(b.ie_sexo) ie_gender
into STRICT    nm_first_w,
	nm_family_w,
	dt_birth_w,
	nm_alias_first_w,
	nm_alias_family_w,       
	ie_gender_w
from 	pessoa_fisica b
where	b.cd_pessoa_fisica 	= cd_pessoa_fisica_p  LIMIT 1;


for r04 in c03	loop

	cd_attribute_w 	:= r04.nm_atributo;
	cd_field_name_w := r04.nm_eclipse_field;
	
	if (cd_field_name_w = 'PatientDateOfBirth') then
		if (coalesce(dt_birth_w::text, '') = '' ) then
			cd_error_string_p := cd_error_string_p || Wheb_mensagem_pck.get_texto(1101291)  ||',';
		end if;
	
	elsif (cd_field_name_w = 'PatientFamilyName') then
		if (coalesce(nm_family_w::text, '') = '' ) then
			cd_error_string_p := cd_error_string_p || Wheb_mensagem_pck.get_texto(1101292)  ||',';
		end if;
		
	elsif (cd_field_name_w = 'PatientFirstName') then
		if (coalesce(nm_first_w::text, '') = '' ) then
			cd_error_string_p := cd_error_string_p || Wheb_mensagem_pck.get_texto(1101293)  ||',';
		end if;
		
	elsif (cd_field_name_w = 'PatientMedicareCardNum') then
		if (coalesce(cd_medicare_card_w::text, '') = '') then
			cd_error_string_p := cd_error_string_p || Wheb_mensagem_pck.get_texto(1100197)  ||',';
		end if;
		
	elsif (cd_field_name_w = 'PatientReferenceNum') then
		if (coalesce(nr_patient_num_w::text, '') = '') then
			cd_error_string_p := cd_error_string_p || Wheb_mensagem_pck.get_texto(1100195)  ||',';
		end if;
	end if;
end loop;
if (coalesce(cd_error_string_p::text, '') = '') then
	insert into opv_request_patient(nr_sequencia,
		nr_seq_request,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nm_alias_family,
		nm_alias_first,
		dt_birth,
		nm_family,
		nm_first,
		cd_fund_card, 
		cd_upi, 
		ie_gender, 
		cd_medicare_card,
		nr_patient_num,
		cd_provider)
	values (nr_seq_opv_patient_w,
		nr_seq_opv_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null,--nm_alias_family_w,
		null,--nm_alias_first_w,
		dt_birth_w, 
		nm_family_w,
		nm_first_w,
		cd_fund_card_w, 
		cd_upi_w,
		ie_gender_w,
		cd_medicare_card_w, 
		nr_patient_num_w, 
		cd_provider_w );	
commit;
	cd_seq_transaction_p := cd_seq_transaction_w;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_opv_request ( cd_estabelecimento_p bigint, CD_PESSOA_FISICA_P text default null, nm_usuario_p text DEFAULT NULL, nr_atendimento_p bigint default null, ie_calling_point_p text DEFAULT NULL, cd_seq_transaction_p INOUT text DEFAULT NULL, cd_error_string_p INOUT text DEFAULT NULL) FROM PUBLIC;

