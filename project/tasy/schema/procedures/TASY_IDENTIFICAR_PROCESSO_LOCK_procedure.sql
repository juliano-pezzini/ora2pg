-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_identificar_processo_lock () AS $body$
DECLARE


sid_w			integer;
serial#_w		integer;
program_w		varchar(64);
machine_w		varchar(64);
module_w		varchar(48);
nm_objeto_w		varchar(50);
locked_mode_w	varchar(13);
bd_w			varchar(1);
status_w		varchar(8);

-- Identifica sess√µes de "objetos" em lock e adiciona na tabela: W_SESSAO_LOCK
C01 CURSOR FOR
	SELECT	a.sid,
		a.serial#,
		a.programa,
		a.machine,
		a.modulo,
		a.nm_objeto,
		a.locked_mode,
		a.bd,
		a.status
	from	objeto_lock_v a,
		tabela_sistema b
	where	a.nm_objeto = b.nm_tabela
	and	lower(a.programa) not like '%oracle%'
	
union

	SELECT	a.sid,
		a.serial#,
		a.programa,
		a.machine,
		a.modulo,
		a.nm_objeto,
		a.locked_mode,
		a.bd,
		a.status
	from	processo_lock_v a,
		tabela_sistema b
	where	a.nm_objeto = b.nm_tabela;


BEGIN

EXECUTE 'truncate table W_SESSAO_LOCK';

OPEN C01;
LOOP
FETCH C01 into
	sid_w,
	serial#_w,
	program_w,
	machine_w,
	module_w,
	nm_objeto_w,
	locked_mode_w,
	bd_w,
	status_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	insert into W_SESSAO_LOCK(
		sid,
		serial#,
		program,
		machine,
		module,
		nm_objeto,
		locked_mode,
		bd,
		status)
	values (
		sid_w,
		serial#_w,
		program_w,
		machine_w,
		module_w,
		nm_objeto_w,
		locked_mode_w,
		bd_w,
		status_w);
END LOOP;
CLOSE C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_identificar_processo_lock () FROM PUBLIC;

