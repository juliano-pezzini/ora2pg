-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (vl_medicamento bigint, nr_sequencia bigint, nr_seq_bras_preco bigint);


CREATE OR REPLACE PROCEDURE obter_preco_brasindice ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, tx_brasindice_pmc_p bigint, tx_brasindice_pfb_p bigint, tx_pfb_pos_p bigint, tx_pfb_neg_p bigint, tx_pmc_neg_p bigint, tx_pmc_pos_p bigint, ie_tipo_atendimento_p bigint, nr_seq_marca_p bigint, vl_medicamento_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tiss_p INOUT text, nr_seq_regra_ajuste_p bigint default null, ie_data_fixa_p text default null, cd_plano_p text default null, ie_restrito_p text default null, ie_solucao_p text default null, nr_seq_bras_preco_p INOUT bigint DEFAULT NULL, nr_seq_mat_bras_p INOUT bigint DEFAULT NULL, nr_seq_conv_bras_p bigint default null) AS $body$
DECLARE

type vetor is table of campos index by integer;

cd_laboratorio_w	varchar(6);
cd_medicamento_w	varchar(6);
cd_apresentacao_w	varchar(6);
vl_medicamento_w	double precision	:= 0;
ie_tipo_preco_w		varchar(3);
tx_preco_fabrica_w	CONVENIO_BRASINDICE.TX_PRECO_FABRICA%type := 1;--number(15,4)	:= 1;
qt_conversao_w		double precision	:= 1;
dt_ult_vigencia_w	timestamp		:= clock_timestamp();
dt_vigencia_bras_w	timestamp		:= clock_timestamp();
ie_relacionado_bras_w	varchar(1)	:= 'S';
tx_brasindice_pmc_w	CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type :=1;--number(15,4)	:= 1;
tx_pmc_neg_w		CONVENIO_BRASINDICE.TX_PMC_NEG%type;--number(15,4);
tx_pmc_pos_w		CONVENIO_BRASINDICE.TX_PMC_POS%type;--number(15,4);
ie_brasindice_w		varchar(1)	:= 'N';	
ie_preco_port_w		varchar(1)	:= '';	
pr_ipi_w		real;
ie_exige_lib_w		varchar(01);
ie_pis_cofins_w		varchar(1);

tx_pfb_neg_w		CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
tx_pfb_pos_w		CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
ie_dividir_indice_pmc_w	varchar(1);
ie_dividir_indice_pfb_w	varchar(1);
cd_grupo_material_w	 smallint;
ie_tipo_convenio_w	smallint;
ie_valor_brasindice_w	varchar(1);
i			bigint := 0;
qt_reg_w		bigint := 0;
vl_bras_w		double precision := 0;
ie_preco_medio_bras_w	varchar(1) := 'N';
vetor_valor_w		vetor;

ie_tipo_preco_regra_w	varchar(3);
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
ie_tipo_material_w	varchar(3);

ie_div_indice_pmc_conv_w	varchar(1);
ie_div_indice_pfb_conv_w	varchar(1);
ie_div_indice_pmc_regra_w	varchar(1);
ie_div_indice_pfb_regra_w	varchar(1);

ie_ipi_brasindice_w		varchar(1);
ie_ignora_divisao_bras_w	varchar(1);
ie_ordem_relac_bras_w		varchar(1);
ie_prioridade_brasindice_w	varchar(1);
nr_seq_bras_preco_w		bigint;
nr_seq_mat_bras_w		bigint;
f				bigint;
g				bigint;
ie_data_fixa_w			varchar(1);
ie_restrito_w			varchar(1);
ie_solucao_w			varchar(1);
nr_seq_bras_preco_medio_w	bigint;
nr_seq_mat_bras_medio_w		bigint;
vl_minimo_brasind_w		CONVENIO_BRASINDICE.VL_MINIMO%type;--number(15,2);
vl_maximo_brasind_w		CONVENIO_BRASINDICE.VL_MAXIMO%type;--number(15,2);
ie_arred_vl_bras_ant_w		convenio_estabelecimento.ie_arred_vl_bras_ant%type;


c01 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao,
		qt_conversao,
		nr_sequencia
	from	material_brasindice
	where	cd_material						= cd_material_p
	and	coalesce(ie_situacao, 'A')					= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_bras_w)			<= dt_vigencia_bras_w
	and 	dt_vigencia_bras_w between coalesce(dt_vigencia, dt_vigencia_bras_w) and coalesce(dt_final_vigencia, dt_vigencia_bras_w)	
	and	coalesce(cd_convenio,cd_convenio_p)				= cd_convenio_p
	and	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
	and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_p,0))		= coalesce(nr_seq_marca_p,0)
	order by	coalesce(nr_seq_marca,0),
		coalesce(dt_vigencia,clock_timestamp() - interval '10000 days'),
		coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(cd_estabelecimento,0);
		
c02 CURSOR FOR
	SELECT  'S'
	from	convenio_brasindice
	where	cd_convenio		= cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '') or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	coalesce(cd_plano, coalesce(cd_plano_p, 0)) = coalesce(cd_plano_p, 0)
	and	cd_estabelecimento = cd_estabelecimento_p
	and	coalesce(ie_situacao,'A') = 'A'
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0),
		coalesce(cd_plano, 0);
		
		
c03 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao,
		qt_conversao,
		nr_sequencia
	from	material_brasindice
	where	cd_material						= cd_material_p
	and	coalesce(ie_situacao, 'A')					= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_bras_w)			<= dt_vigencia_bras_w
	and 	dt_vigencia_bras_w between coalesce(dt_vigencia, dt_vigencia_bras_w) and coalesce(dt_final_vigencia, dt_vigencia_bras_w)	
	and	coalesce(cd_convenio,cd_convenio_p)				= cd_convenio_p
	and	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
	and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_p,0))		= coalesce(nr_seq_marca_p,0)
	order by	coalesce(nr_seq_marca,0),	
		coalesce(dt_vigencia,clock_timestamp() - interval '10000 days'),
		coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(obter_valor_medic_brasindice(	cd_estabelecimento_p,
							cd_medicamento,
							cd_apresentacao,
							cd_laboratorio,
							qt_conversao,
							dt_vigencia_bras_w,
							tx_brasindice_pfb_p,
							tx_brasindice_pmc_p,
							tx_pmc_neg_p,
							tx_pmc_pos_p,
							tx_pfb_pos_p,
							tx_pfb_neg_p,
							cd_convenio_p,
							cd_categoria_p,
							cd_material_p,
							ie_tipo_atendimento_p,
							ie_tipo_preco_regra_w),0);
							
c04 CURSOR FOR
		SELECT	cd_medicamento,
			cd_apresentacao,
			cd_laboratorio,
			qt_conversao,
			nr_sequencia
		from	material_brasindice
		where	cd_material						= cd_material_p
		and	coalesce(ie_situacao, 'A')					= 'A'
		--and	nvl(dt_vigencia,dt_vigencia_bras_w)			<= dt_vigencia_bras_w
		and 	dt_vigencia_bras_w between coalesce(dt_vigencia, dt_vigencia_bras_w) and coalesce(dt_final_vigencia, dt_vigencia_bras_w)
		and	coalesce(cd_convenio,cd_convenio_p)				= cd_convenio_p
		and	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)		= ie_tipo_convenio_w
		and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
		and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_p,0))		= coalesce(nr_seq_marca_p,0)
		order by nr_sequencia;
							
c05 CURSOR FOR
	SELECT	ie_tipo_preco
	from	regra_prior_brasindice
	where	dt_vigencia <= dt_vigencia_bras_w
	order by 	dt_vigencia desc,
		nr_prioridade;

c06 CURSOR FOR
	SELECT	coalesce(ie_dividir_indice_pmc,'N')
	from 	convenio_brasindice
	where	cd_convenio = cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '') or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	cd_estabelecimento	= cd_estabelecimento_p
	and 	((coalesce(nr_seq_conv_bras_p,0) = 0) or (nr_sequencia = nr_seq_conv_bras_p))
	and	coalesce(ie_situacao,'A')	= 'A'
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0);
		
c07 CURSOR FOR
	SELECT	coalesce(ie_dividir_indice_pfb,'N')
	from 	convenio_brasindice
	where	cd_convenio = cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '') or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_p) = 'S'))
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	cd_estabelecimento	= cd_estabelecimento_p
	and 	((coalesce(nr_seq_conv_bras_p,0) = 0) or (nr_sequencia = nr_seq_conv_bras_p))
	and	coalesce(ie_situacao,'A')	= 'A'
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_classe_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0);

c08 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao,
		qt_conversao,
		nr_sequencia
	from	material_brasindice
	where	cd_material						= cd_material_p
	and	coalesce(ie_situacao, 'A')					= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_bras_w)			<= dt_vigencia_bras_w
	and 	dt_vigencia_bras_w between coalesce(dt_vigencia, dt_vigencia_bras_w) and coalesce(dt_final_vigencia, dt_vigencia_bras_w)	
	and	coalesce(cd_convenio,cd_convenio_p)				= cd_convenio_p
	and	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
	and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_p,0))		= coalesce(nr_seq_marca_p,0)
	order by	coalesce(nr_seq_marca,0),
		coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(cd_estabelecimento,0),
		coalesce(dt_vigencia,clock_timestamp() - interval '10000 days');		
		
c09 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao,
		qt_conversao,
		nr_sequencia
	from	material_brasindice
	where	cd_material						= cd_material_p
	and	coalesce(ie_situacao, 'A')					= 'A'
	--and	nvl(dt_vigencia,dt_vigencia_bras_w)			<= dt_vigencia_bras_w
	and 	dt_vigencia_bras_w between coalesce(dt_vigencia, dt_vigencia_bras_w) and coalesce(dt_final_vigencia, dt_vigencia_bras_w)	
	and	coalesce(cd_convenio,cd_convenio_p)				= cd_convenio_p
	and	coalesce(ie_tipo_convenio,ie_tipo_convenio_w)		= ie_tipo_convenio_w
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
	and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_p,0))		= coalesce(nr_seq_marca_p,0)
	order by	coalesce(nr_seq_marca,0),
		coalesce(cd_convenio,0),
		coalesce(ie_tipo_convenio,0),
		coalesce(obter_valor_medic_brasindice(	cd_estabelecimento_p,
							cd_medicamento,
							cd_apresentacao,
							cd_laboratorio,
							qt_conversao,
							dt_vigencia_bras_w,
							tx_brasindice_pfb_p,
							tx_brasindice_pmc_p,
							tx_pmc_neg_p,
							tx_pmc_pos_p,
							tx_pfb_pos_p,
							tx_pfb_neg_p,
							cd_convenio_p,
							cd_categoria_p,
							cd_material_p,
							ie_tipo_atendimento_p,
							ie_tipo_preco_regra_w),0),
		coalesce(dt_vigencia,clock_timestamp() - interval '10000 days');
							
							
c04_w	c04%rowtype;							



BEGIN

ie_data_fixa_w:= coalesce(ie_data_fixa_p,'N');
ie_restrito_w := coalesce(ie_restrito_p,'A');
ie_solucao_w  := coalesce(ie_solucao_p,'A');

ie_ignora_divisao_bras_w:= 'N';

if (coalesce(nr_seq_conv_bras_p, 0) > 0) then
	select 	max(vl_minimo),
			max(vl_maximo)
	into STRICT 	vl_minimo_brasind_w, 
			vl_maximo_brasind_w
	from 	convenio_brasindice		
	where	nr_sequencia = nr_seq_conv_bras_p;
end if;

if (coalesce(nr_seq_regra_ajuste_p,0) > 0) then
	select 	coalesce(max(ie_ignora_divisao_bras),'N')
	into STRICT	ie_ignora_divisao_bras_w
	from 	regra_ajuste_material
	where 	nr_sequencia = nr_seq_regra_ajuste_p;	
end if;

select 	max(cd_grupo_material),
	max(cd_subgrupo_material),
	max(cd_classe_material),
	max(ie_tipo_material)
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ie_tipo_material_w
from 	estrutura_material_v
where 	cd_material = cd_material_p;

/* obter regra do bras?ndice para cargas com dois tipos de pre?os (pfb e pmc)  */

select	substr(obter_regra_brasindice_preco(cd_convenio_p,
					cd_categoria_p,
					cd_grupo_material_w,
					cd_subgrupo_material_w,
					cd_classe_material_w,
					cd_material_p,
					dt_vigencia_p,
					cd_estabelecimento_p,
					ie_tipo_atendimento_p),1,3)
into STRICT	ie_tipo_preco_regra_w
;

if (ie_tipo_preco_regra_w = 'REG') then
	
	dt_vigencia_bras_w 	:= coalesce(dt_vigencia_p,clock_timestamp());
	
	open c05;
	loop
	fetch c05 into	
		ie_tipo_preco_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
	
		tx_preco_fabrica_w	:= tx_brasindice_pfb_p;
		tx_pfb_neg_w		:= coalesce(tx_pfb_neg_p, tx_brasindice_pfb_p);
		tx_pfb_pos_w		:= coalesce(tx_pfb_pos_p, tx_brasindice_pfb_p);
		
		tx_brasindice_pmc_w	:= tx_brasindice_pmc_p;
		tx_pmc_neg_w		:= coalesce(tx_pmc_neg_p, tx_brasindice_pmc_p);
		tx_pmc_pos_w		:= coalesce(tx_pmc_pos_p, tx_brasindice_pmc_p);
		
		select	coalesce(max(ie_exige_lib_bras),'N'),
			coalesce(max(ie_dividir_indice_pmc),'N'),
			coalesce(max(ie_dividir_indice_pfb),'N'),
			coalesce(max(ie_valor_brasindice),'N'),
			coalesce(max(ie_ordem_relac_bras),'N'),
			coalesce(max(ie_prioridade_brasindice),'N')
		into STRICT	ie_exige_lib_w,
			ie_dividir_indice_pmc_w,
			ie_dividir_indice_pfb_w,
			ie_valor_brasindice_w,
			ie_ordem_relac_bras_w,
			ie_prioridade_brasindice_w
		from	parametro_faturamento
		where	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (ie_prioridade_brasindice_w = 'R') then
			select 	coalesce(max(ie_prioridade_brasindice),'N')
			into STRICT	ie_prioridade_brasindice_w
			from 	convenio_estabelecimento
			where 	cd_convenio = cd_convenio_p
			and 	cd_estabelecimento = cd_estabelecimento_p;
		end if;
		
		ie_tipo_convenio_w	:= coalesce(obter_tipo_convenio(cd_convenio_p),0);
		
		if (ie_ordem_relac_bras_w	= 'S') and (ie_valor_brasindice_w	= 'N') then
			open c08;
			loop
			fetch c08 into	
					cd_laboratorio_w,
					cd_medicamento_w,
					cd_apresentacao_w,
					qt_conversao_w,
					nr_seq_mat_bras_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
			end loop;
			close c08;
		elsif (ie_ordem_relac_bras_w	= 'S') and (ie_valor_brasindice_w	= 'S') then
			open c09;
			loop
			fetch c09 into	
					cd_laboratorio_w,
					cd_medicamento_w,
					cd_apresentacao_w,
					qt_conversao_w,
					nr_seq_mat_bras_w;
			EXIT WHEN NOT FOUND; /* apply on c09 */
			end loop;
			close c09;
		elsif (ie_ordem_relac_bras_w	= 'N') and (ie_valor_brasindice_w	= 'N') then
			open c01;
			loop
			fetch c01 into	
					cd_laboratorio_w,
					cd_medicamento_w,
					cd_apresentacao_w,
					qt_conversao_w,
					nr_seq_mat_bras_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			end loop;
			close c01;
		elsif (ie_ordem_relac_bras_w	= 'N') and (ie_valor_brasindice_w	= 'S') then
			open c03;
			loop
			fetch c03 into	
					cd_laboratorio_w,
					cd_medicamento_w,
					cd_apresentacao_w,
					qt_conversao_w,
					nr_seq_mat_bras_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
			end loop;
			close c03;
		end if;
		
		select 	coalesce(max(ie_preco_medio_bras),'N'),
				coalesce(max(ie_ipi_brasindice),'S'),
				coalesce(max(ie_arred_vl_bras_ant),'N')
		into STRICT	ie_preco_medio_bras_w,
				ie_ipi_brasindice_w,
				ie_arred_vl_bras_ant_w
		from 	convenio_estabelecimento
		where	cd_convenio = cd_convenio_p
		and	cd_estabelecimento = cd_estabelecimento_p;
		
		if (coalesce(ie_exige_lib_w,'N') = 'R') then
			select 	coalesce(max(ie_exige_lib_bras),'N')
			into STRICT	ie_exige_lib_w
			from 	convenio_estabelecimento
			where	cd_convenio = cd_convenio_p
			and	cd_estabelecimento = cd_estabelecimento_p;
		end if;
		
		if (ie_prioridade_brasindice_w = 'N') then
		
			/* obter pre?o do medicamento */

			if (ie_exige_lib_w	= 'S') then
				begin
				select coalesce(vl_preco_final, vl_preco_medicamento),
					ie_tipo_preco,
					dt_inicio_vigencia,
					coalesce(ie_preco_port,'T'),
					coalesce(pr_ipi,0),
					coalesce(ie_pis_cofins,'T'),
					nr_sequencia
				into STRICT	vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w,
					nr_seq_bras_preco_w
				from	brasindice_preco
				where	cd_laboratorio		= cd_laboratorio_w
				and	cd_medicamento		= cd_medicamento_w
				and	cd_apresentacao		= cd_apresentacao_w
				and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				--and	ie_tipo_preco		= nvl(ie_tipo_preco_regra_w,ie_tipo_preco)
				and	dt_inicio_vigencia	=
					(SELECT max(a.dt_inicio_vigencia)
					from	brasindice_preco a
					where	a.cd_laboratorio      = cd_laboratorio_w
					and	a.cd_medicamento      = cd_medicamento_w
					and	a.cd_apresentacao     = cd_apresentacao_w
					and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					--and	a.ie_tipo_preco	      = nvl(ie_tipo_preco_regra_w,a.ie_tipo_preco)
					and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
					and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
					and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
				exception
					when others then
						begin
						select coalesce(vl_preco_final, vl_preco_medicamento),
							ie_tipo_preco,
							dt_inicio_vigencia,
							coalesce(ie_preco_port,'T'),
							coalesce(pr_ipi,0),
							coalesce(ie_pis_cofins,'T'),
							nr_sequencia
						into STRICT	vl_medicamento_w,
							ie_tipo_preco_w,
							dt_ult_vigencia_w,
							ie_preco_port_w,
							pr_ipi_w,
							ie_pis_cofins_w,
							nr_seq_bras_preco_w
						from	brasindice_preco
						where	cd_laboratorio		= cd_laboratorio_w
						and	cd_medicamento		= cd_medicamento_w
						and	cd_apresentacao		= cd_apresentacao_w 
						and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)
						and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and	dt_inicio_vigencia	=
							(SELECT max(a.dt_inicio_vigencia)
							from	brasindice_preco a
							where	a.cd_laboratorio      = cd_laboratorio_w
							and	a.cd_medicamento      = cd_medicamento_w
							and	a.cd_apresentacao     = cd_apresentacao_w
							and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
							and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
							and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
							and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
							and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
						exception
							when others then					
							ie_tipo_preco_w	:= '';
						end;
				end;
			else
				begin
				select  coalesce(vl_preco_final, vl_preco_medicamento),
					ie_tipo_preco,
					dt_inicio_vigencia,
					coalesce(ie_preco_port,'T'),
					coalesce(pr_ipi,0),
					coalesce(ie_pis_cofins,'T'),
					nr_sequencia
				into STRICT	vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w,
					nr_seq_bras_preco_w
				from	brasindice_preco
				where	cd_laboratorio		= cd_laboratorio_w
				and	cd_medicamento		= cd_medicamento_w
				and	cd_apresentacao		= cd_apresentacao_w
				and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				--and	ie_tipo_preco		= nvl(ie_tipo_preco_regra_w,ie_tipo_preco)   
				and	dt_inicio_vigencia	=
					(SELECT max(a.dt_inicio_vigencia)
					from	brasindice_preco a
					where	a.cd_laboratorio      = cd_laboratorio_w
					and	a.cd_medicamento      = cd_medicamento_w
					and	a.cd_apresentacao     = cd_apresentacao_w
					and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					--and	a.ie_tipo_preco	      = nvl(ie_tipo_preco_regra_w,a.ie_tipo_preco)
					and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
					and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
					and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
				exception
					when others then
						begin
						select  coalesce(vl_preco_final, vl_preco_medicamento),
							ie_tipo_preco,
							dt_inicio_vigencia,
							coalesce(ie_preco_port,'T'),
							coalesce(pr_ipi,0),
							coalesce(ie_pis_cofins,'T'),
							nr_sequencia
						into STRICT	vl_medicamento_w,
							ie_tipo_preco_w,
							dt_ult_vigencia_w,
							ie_preco_port_w,
							pr_ipi_w,
							ie_pis_cofins_w,
							nr_seq_bras_preco_w
						from	brasindice_preco
						where	cd_laboratorio		= cd_laboratorio_w
						and	cd_medicamento		= cd_medicamento_w
						and	cd_apresentacao		= cd_apresentacao_w
						and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)   
						and	dt_inicio_vigencia	=
							(SELECT max(a.dt_inicio_vigencia)
							from	brasindice_preco a
							where	a.cd_laboratorio      = cd_laboratorio_w
							and	a.cd_medicamento      = cd_medicamento_w
							and	a.cd_apresentacao     = cd_apresentacao_w
							and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
							and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
							and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
							and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
							and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
						exception
							when others then					
							ie_tipo_preco_w	:= '';
						end;
				end;
			end if;
			
		elsif (ie_prioridade_brasindice_w = 'S') then
		
			/* obter pre?o do medicamento */

			if (ie_exige_lib_w	= 'S') then
				begin
				select coalesce(vl_preco_final, vl_preco_medicamento),
					ie_tipo_preco,
					dt_inicio_vigencia,
					coalesce(ie_preco_port,'T'),
					coalesce(pr_ipi,0),
					coalesce(ie_pis_cofins,'T'),
					nr_sequencia
				into STRICT	vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w,
					nr_seq_bras_preco_w
				from	brasindice_preco
				where	cd_laboratorio		= cd_laboratorio_w
				and	cd_medicamento		= cd_medicamento_w
				and	cd_apresentacao		= cd_apresentacao_w
				and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
				and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
				and	dt_inicio_vigencia	=
					(SELECT max(a.dt_inicio_vigencia)
					from	brasindice_preco a
					where	a.cd_laboratorio      = cd_laboratorio_w
					and	a.cd_medicamento      = cd_medicamento_w
					and	a.cd_apresentacao     = cd_apresentacao_w
					and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

					and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
					and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
					and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
					and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
					and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
				exception
					when others then
						begin
						select coalesce(vl_preco_final, vl_preco_medicamento),
							ie_tipo_preco,
							dt_inicio_vigencia,
							coalesce(ie_preco_port,'T'),
							coalesce(pr_ipi,0),
							coalesce(ie_pis_cofins,'T'),
							nr_sequencia
						into STRICT	vl_medicamento_w,
							ie_tipo_preco_w,
							dt_ult_vigencia_w,
							ie_preco_port_w,
							pr_ipi_w,
							ie_pis_cofins_w,
							nr_seq_bras_preco_w
						from	brasindice_preco
						where	cd_laboratorio		= cd_laboratorio_w
						and	cd_medicamento		= cd_medicamento_w
						and	cd_apresentacao		= cd_apresentacao_w 
						and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)
						and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
						and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
						and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and	dt_inicio_vigencia	=
							(SELECT max(a.dt_inicio_vigencia)
							from	brasindice_preco a
							where	a.cd_laboratorio      = cd_laboratorio_w
							and	a.cd_medicamento      = cd_medicamento_w
							and	a.cd_apresentacao     = cd_apresentacao_w
							and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
							/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

							and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
							and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
							and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
							and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
							and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
							and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
						exception
							when others then					
							ie_tipo_preco_w	:= '';
						end;
				end;
			else
				begin
				select  coalesce(vl_preco_final, vl_preco_medicamento),
					ie_tipo_preco,
					dt_inicio_vigencia,
					coalesce(ie_preco_port,'T'),
					coalesce(pr_ipi,0),
					coalesce(ie_pis_cofins,'T'),
					nr_sequencia
				into STRICT	vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w,
					nr_seq_bras_preco_w
				from	brasindice_preco
				where	cd_laboratorio		= cd_laboratorio_w
				and	cd_medicamento		= cd_medicamento_w
				and	cd_apresentacao		= cd_apresentacao_w
				and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
				and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
				and	dt_inicio_vigencia	=
					(SELECT max(a.dt_inicio_vigencia)
					from	brasindice_preco a
					where	a.cd_laboratorio      = cd_laboratorio_w
					and	a.cd_medicamento      = cd_medicamento_w
					and	a.cd_apresentacao     = cd_apresentacao_w
					and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

					and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
					and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
					and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
					and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
					and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
				exception
					when others then
						begin
						select  coalesce(vl_preco_final, vl_preco_medicamento),
							ie_tipo_preco,
							dt_inicio_vigencia,
							coalesce(ie_preco_port,'T'),
							coalesce(pr_ipi,0),
							coalesce(ie_pis_cofins,'T'),
							nr_sequencia
						into STRICT	vl_medicamento_w,
							ie_tipo_preco_w,
							dt_ult_vigencia_w,
							ie_preco_port_w,
							pr_ipi_w,
							ie_pis_cofins_w,
							nr_seq_bras_preco_w
						from	brasindice_preco
						where	cd_laboratorio		= cd_laboratorio_w
						and	cd_medicamento		= cd_medicamento_w
						and	cd_apresentacao		= cd_apresentacao_w
						and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
						and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
						and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)   
						and	dt_inicio_vigencia	=
							(SELECT max(a.dt_inicio_vigencia)
							from	brasindice_preco a
							where	a.cd_laboratorio      = cd_laboratorio_w
							and	a.cd_medicamento      = cd_medicamento_w
							and	a.cd_apresentacao     = cd_apresentacao_w
							and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
							/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

							and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
							and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
							and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
							and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
							and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
							and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
						exception
							when others then					
							ie_tipo_preco_w	:= '';
						end;
				end;
			end if;	
		
		end if;
		
		
		if (ie_arred_vl_bras_ant_w = 'S') then
			/*      converte o preco para consumo material */

			if (qt_conversao_w = 0) then
				qt_conversao_w := 1;
			end if;
			
			if (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'S') then
				
				vl_medicamento_w := vl_medicamento_w + (vl_medicamento_w * pr_ipi_w / 100);
				vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,2);
				
			elsif (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'N') then
				vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,2);
			end if;
			
			if (ie_relacionado_bras_w = 'N') then
				vl_medicamento_w := 0;
			end if;
		end if;
		
		if (ie_ignora_divisao_bras_w = 'S') then
			ie_dividir_indice_pfb_w:= 'N';
			ie_dividir_indice_pmc_w:= 'N';
		end if;
		
		if (ie_dividir_indice_pfb_w = 'N') then
		
			if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
				else
					vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
				end if;	
			end if;
			
		elsif (ie_dividir_indice_pfb_w = 'S') then
		
			if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
				else
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
				end if;	
			end if;
			
		elsif (ie_dividir_indice_pfb_w = 'R') then

			select	coalesce(max(ie_dividir_indice_pfb),'N')
			into STRICT	ie_div_indice_pfb_conv_w
			from 	convenio_estabelecimento
			where	cd_convenio		= cd_convenio_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			if (ie_div_indice_pfb_conv_w = 'S') then	
		
				if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
					else
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pfb_conv_w = 'N') then
			
				if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
					else
						vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pfb_conv_w = 'R') then
			
				open c07;
				loop
				fetch c07 into	
					ie_div_indice_pfb_regra_w;
				EXIT WHEN NOT FOUND; /* apply on c07 */
					begin
					ie_div_indice_pfb_regra_w	:= ie_div_indice_pfb_regra_w;
					end;
				end loop;
				close c07;
			
				if (ie_div_indice_pfb_regra_w = 'S') then	
		
					if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
						if (ie_pis_cofins_w = 'S') then
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
						elsif (ie_pis_cofins_w = 'N') then
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
						else
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
						end if;	
					end if;
					
				elsif (ie_div_indice_pfb_regra_w = 'N') then
				
					if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
						if (ie_pis_cofins_w = 'S') then
							vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
						elsif (ie_pis_cofins_w = 'N') then
							vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
						else
							vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
						end if;	
					end if;
				end if;
			end if;	
		
		end if;
		
		/* conforme resolu??o cmed n? 2, de 10 de mar?o de 2006 
		
		art. 4? o pre?o m?ximo ao consumidor - pmc ser? obtido por meio da divis?o do pre?o
		fabricante - pf pelos fatores constantes da tabela abaixo, observadas as cargas tribut?rias do
		icms praticadas nos estados de destino e a incid?ncia da contribui??o para o pis/pasep e
		cofins, conforme o disposto na lei n? 10.147, de 21 de dezembro de 2001.  
		
		icms            lista positiva               lista negativa                     lista neutra 
		19%   	0,7234   		0,7523    		0,7071  
		18%               0,7234     		0,7519      		0,7073  
		17%   	0,7234   		0,7515    		0,7075  
		12%   	0,7234   		0,7499    		0,7084  
		0%   	0,7234   		0,7465     		0,7103  */
		
		if (ie_dividir_indice_pmc_w = 'N') then
		
			if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
				else
					vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
				end if;	
			end if;
			
		elsif (ie_dividir_indice_pmc_w = 'S') then
		
			if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
				else
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
				end if;	
			end if;
			
		elsif (ie_dividir_indice_pmc_w = 'R') then

			select	coalesce(max(ie_dividir_indice_pmc),'N')
			into STRICT	ie_div_indice_pmc_conv_w
			from 	convenio_estabelecimento
			where	cd_convenio		= cd_convenio_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			if (ie_div_indice_pmc_conv_w = 'S') then	
		
				if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
					else
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pmc_conv_w = 'N') then	
			
				if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
					else
						vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pmc_conv_w = 'R') then
			
				open c06;
				loop
				fetch c06 into	
					ie_div_indice_pmc_regra_w;
				EXIT WHEN NOT FOUND; /* apply on c06 */
					begin
					ie_div_indice_pmc_regra_w	:= ie_div_indice_pmc_regra_w;
					end;
				end loop;
				close c06;
				
				if (ie_div_indice_pmc_regra_w = 'S') then	
			
					if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
						if (ie_pis_cofins_w = 'S') then
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
						elsif (ie_pis_cofins_w = 'N') then
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
						else
							vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
						end if;	
					end if;
					
				elsif (ie_div_indice_pmc_regra_w = 'N') then	
				
					if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
						if (ie_pis_cofins_w = 'S') then
							vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
						elsif (ie_pis_cofins_w = 'N') then
							vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
						else
							vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
						end if;	
					end if;
				end if;
			end if;
			
		end if;
		
		
		if (ie_arred_vl_bras_ant_w = 'N') then
			/*      converte o preco para consumo material */

			if (qt_conversao_w = 0) then
				qt_conversao_w := 1;
			end if;
			
			if (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'S') then
				
				vl_medicamento_w := vl_medicamento_w + (vl_medicamento_w * pr_ipi_w / 100);
				vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,4);
				
			elsif (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'N') then
				vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,4);
			end if;
			
			if (ie_relacionado_bras_w = 'N') then
				vl_medicamento_w := 0;
			end if;
		end if;
		
		ie_brasindice_w		:= 'N';
		
		/* passei para o in?cio da function - heckmann 19/05/2010 - os 214864
		select 	max(cd_grupo_material)
		into	cd_grupo_material_w
		from 	estrutura_material_v
		where 	cd_material = cd_material_p;
		*/
		
		if (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') and (coalesce(cd_categoria_p,'0') <> '0') then
			begin
			
			open c02;
			loop
			fetch c02 into	
				ie_brasindice_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				ie_brasindice_w:= ie_brasindice_w;
				end;
			end loop;
			close c02;
			
			end;
		end if;
		
		if (ie_preco_medio_bras_w = 'S') then
			open c04;
			loop
			fetch c04 into	
				c04_w;				
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin
				i := i + 1;

				nr_seq_mat_bras_medio_w:= c04_w.nr_sequencia;				
				
				SELECT * FROM Define_valor_medic_brasindice( 	cd_estabelecimento_p, c04_w.cd_medicamento, c04_w.cd_apresentacao, c04_w.cd_laboratorio, c04_w.qt_conversao, dt_vigencia_bras_w, tx_brasindice_pfb_p, tx_brasindice_pmc_p, tx_pmc_neg_p, tx_pmc_pos_p, tx_pfb_pos_p, tx_pfb_neg_p, cd_convenio_p, cd_categoria_p, cd_material_p, ie_tipo_atendimento_p, vl_bras_w, nr_seq_bras_preco_medio_w) INTO STRICT vl_bras_w, nr_seq_bras_preco_medio_w;
				
				vetor_valor_w[i].vl_medicamento 	:= coalesce(vl_bras_w,0);
				vetor_valor_w[i].nr_sequencia   	:= nr_seq_mat_bras_medio_w;
				vetor_valor_w[i].nr_seq_bras_preco	:= nr_seq_bras_preco_medio_w;
				
				end;
			end loop;
			close c04;
			
			-- Necess?rio reordenar o vetor em ordem crescente de valores
			for  f in 1..vetor_valor_w.count loop
				for  g in f+1..vetor_valor_w.count loop
				
					if (vetor_valor_w[g].vl_medicamento <  vetor_valor_w[f].vl_medicamento) then
						
						vl_bras_w			:= vetor_valor_w[g].vl_medicamento;
						nr_seq_mat_bras_medio_w		:= vetor_valor_w[g].nr_sequencia;
						nr_seq_bras_preco_medio_w	:= vetor_valor_w[g].nr_seq_bras_preco;						
						
						vetor_valor_w[g].vl_medicamento 	:= vetor_valor_w[f].vl_medicamento;
						vetor_valor_w[g].nr_sequencia  		:= vetor_valor_w[f].nr_sequencia;
						vetor_valor_w[g].nr_seq_bras_preco  	:= vetor_valor_w[f].nr_seq_bras_preco;						
						
						
						vetor_valor_w[f].vl_medicamento 	:= vl_bras_w;
						vetor_valor_w[f].nr_sequencia  		:= nr_seq_mat_bras_medio_w;
						vetor_valor_w[f].nr_seq_bras_preco	:= nr_seq_bras_preco_medio_w;
						
						
					end if;
					
				end loop;
			end loop;
			
			select	round(dividir(i,2))
			into STRICT	qt_reg_w
			;
			
			if (i >= 3) then
				vl_medicamento_w 	:= vetor_valor_w[qt_reg_w].vl_medicamento;
				nr_seq_mat_bras_w	:= vetor_valor_w[qt_reg_w].nr_sequencia;
				nr_seq_bras_preco_w	:= vetor_valor_w[qt_reg_w].nr_seq_bras_preco;
			end if;
		end if;
		
		if (ie_brasindice_w = 'N') then
			begin
			vl_medicamento_w	:= 0;
			dt_ult_vigencia_w	:= clock_timestamp();
			end;
		end if;
		
		if ((coalesce(vl_minimo_brasind_w, 0) > 0) or (coalesce(vl_maximo_brasind_w, 0) > 0)) then
			if ((vl_medicamento_w < coalesce(vl_minimo_brasind_w, vl_medicamento_w)) or (vl_medicamento_w > coalesce(vl_maximo_brasind_w, vl_medicamento_w))) then 
				vl_medicamento_w	:= 0;
				dt_ult_vigencia_w	:= clock_timestamp();
			end if;
		end if;
		
		
		vl_medicamento_p	:= vl_medicamento_w;
		dt_ult_vigencia_p	:= dt_ult_vigencia_w;
		nr_seq_mat_bras_p	:= nr_seq_mat_bras_w;
		nr_seq_bras_preco_p	:= nr_seq_bras_preco_w;
		
		if (vl_medicamento_p > 0) then
			exit;
		end if;
	
		end;
	end loop;
	close c05;

else

	tx_preco_fabrica_w	:= tx_brasindice_pfb_p;
	tx_pfb_neg_w		:= coalesce(tx_pfb_neg_p, tx_brasindice_pfb_p);
	tx_pfb_pos_w		:= coalesce(tx_pfb_pos_p, tx_brasindice_pfb_p);
	
	tx_brasindice_pmc_w	:= tx_brasindice_pmc_p;
	tx_pmc_neg_w		:= coalesce(tx_pmc_neg_p, tx_brasindice_pmc_p);
	tx_pmc_pos_w		:= coalesce(tx_pmc_pos_p, tx_brasindice_pmc_p);
	
	select	coalesce(max(ie_exige_lib_bras),'N'),
		coalesce(max(ie_dividir_indice_pmc),'N'),
		coalesce(max(ie_dividir_indice_pfb),'N'),
		coalesce(max(ie_valor_brasindice),'N'),
		coalesce(max(ie_ordem_relac_bras),'N'),
		coalesce(max(ie_prioridade_brasindice),'N')
	into STRICT	ie_exige_lib_w,
		ie_dividir_indice_pmc_w,
		ie_dividir_indice_pfb_w,
		ie_valor_brasindice_w,
		ie_ordem_relac_bras_w,
		ie_prioridade_brasindice_w
	from	parametro_faturamento
	where	cd_estabelecimento	= cd_estabelecimento_p;
	
	if (ie_prioridade_brasindice_w = 'R') then
		select 	coalesce(max(ie_prioridade_brasindice),'N')
		into STRICT	ie_prioridade_brasindice_w
		from 	convenio_estabelecimento
		where 	cd_convenio = cd_convenio_p
		and 	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	
	dt_vigencia_bras_w 	:= coalesce(dt_vigencia_p,clock_timestamp());
	
	/* obter laboratorio, medicamento e apresentacao do material at? 10/12/2003 marcus
	begin
	select	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao,
		qt_conversao  
	into
		cd_laboratorio_w,
		cd_medicamento_w,
		cd_apresentacao_w,
		qt_conversao_w      
	from	material_brasindice
	where	cd_material		= cd_material_p
	and	nvl(ie_situacao, 'A')	= 'A'
	and	ie_prioridade 		= 1;
	exception
	when others then
		cd_laboratorio_w := '';
	end;
	*/
	
	ie_tipo_convenio_w	:= coalesce(obter_tipo_convenio(cd_convenio_p),0);
	
	if (ie_ordem_relac_bras_w	= 'S') and (ie_valor_brasindice_w	= 'N') then
		open c08;
		loop
		fetch c08 into	
				cd_laboratorio_w,
				cd_medicamento_w,
				cd_apresentacao_w,
				qt_conversao_w,
				nr_seq_mat_bras_w;
		EXIT WHEN NOT FOUND; /* apply on c08 */
		end loop;
		close c08;
	elsif (ie_ordem_relac_bras_w	= 'S') and (ie_valor_brasindice_w	= 'S') then
		open c09;
		loop
		fetch c09 into	
				cd_laboratorio_w,
				cd_medicamento_w,
				cd_apresentacao_w,
				qt_conversao_w,
				nr_seq_mat_bras_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */
		end loop;
		close c09;
	elsif (ie_ordem_relac_bras_w	= 'N') and (ie_valor_brasindice_w	= 'N') then
		open c01;
		loop
		fetch c01 into	
				cd_laboratorio_w,
				cd_medicamento_w,
				cd_apresentacao_w,
				qt_conversao_w,
				nr_seq_mat_bras_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
	elsif (ie_ordem_relac_bras_w	= 'N') and (ie_valor_brasindice_w	= 'S') then
		open c03;
		loop
		fetch c03 into	
				cd_laboratorio_w,
				cd_medicamento_w,
				cd_apresentacao_w,
				qt_conversao_w,
				nr_seq_mat_bras_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		end loop;
		close c03;
	end if;
	
	select 	coalesce(max(ie_preco_medio_bras),'N'),
			coalesce(max(ie_ipi_brasindice),'S'),
			coalesce(max(ie_arred_vl_bras_ant),'N')
	into STRICT	ie_preco_medio_bras_w,
			ie_ipi_brasindice_w, 
			ie_arred_vl_bras_ant_w
	from 	convenio_estabelecimento
	where	cd_convenio = cd_convenio_p
	and	cd_estabelecimento = cd_estabelecimento_p;
	
	if (coalesce(ie_exige_lib_w,'N') = 'R') then
		select 	coalesce(max(ie_exige_lib_bras),'N')
		into STRICT	ie_exige_lib_w
		from 	convenio_estabelecimento
		where	cd_convenio = cd_convenio_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;
		
	if (ie_prioridade_brasindice_w = 'N') then
	
		/* obter pre?o do medicamento */

		if (ie_exige_lib_w	= 'S') then
			begin
			select  coalesce(vl_preco_final, vl_preco_medicamento),
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T'),
				coalesce(pr_ipi,0),
				coalesce(ie_pis_cofins,'T'),
				nr_sequencia
			into STRICT	vl_medicamento_w,
				ie_tipo_preco_w,
				dt_ult_vigencia_w,
				ie_preco_port_w,
				pr_ipi_w,
				ie_pis_cofins_w,
				nr_seq_bras_preco_w
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
			--and	ie_tipo_preco		= nvl(ie_tipo_preco_regra_w,ie_tipo_preco)
			and	dt_inicio_vigencia	=
				(SELECT max(a.dt_inicio_vigencia)
				from	brasindice_preco a
				where	a.cd_laboratorio      = cd_laboratorio_w
				and	a.cd_medicamento      = cd_medicamento_w
				and	a.cd_apresentacao     = cd_apresentacao_w
				and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				--and	a.ie_tipo_preco	      = nvl(ie_tipo_preco_regra_w,a.ie_tipo_preco)
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
				and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
			exception
				when others then
					begin
					select  coalesce(vl_preco_final, vl_preco_medicamento),
						ie_tipo_preco,
						dt_inicio_vigencia,
						coalesce(ie_preco_port,'T'),
						coalesce(pr_ipi,0),
						coalesce(ie_pis_cofins,'T'),
						nr_sequencia
					into STRICT	vl_medicamento_w,
						ie_tipo_preco_w,
						dt_ult_vigencia_w,
						ie_preco_port_w,
						pr_ipi_w,
						ie_pis_cofins_w,
						nr_seq_bras_preco_w
					from	brasindice_preco
					where	cd_laboratorio		= cd_laboratorio_w
					and	cd_medicamento		= cd_medicamento_w
					and	cd_apresentacao		= cd_apresentacao_w 
					and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)
					and	dt_inicio_vigencia	=
						(SELECT max(a.dt_inicio_vigencia)
						from	brasindice_preco a
						where	a.cd_laboratorio      = cd_laboratorio_w
						and	a.cd_medicamento      = cd_medicamento_w
						and	a.cd_apresentacao     = cd_apresentacao_w
						and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
						and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
						and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
						and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
					exception
						when others then					
						ie_tipo_preco_w	:= '';
					end;
			end;
		else
			begin
			select  coalesce(vl_preco_final, vl_preco_medicamento),
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T'),
				coalesce(pr_ipi,0),
				coalesce(ie_pis_cofins,'T'),
				nr_sequencia
			into STRICT	vl_medicamento_w,
				ie_tipo_preco_w,
				dt_ult_vigencia_w,
				ie_preco_port_w,
				pr_ipi_w,
				ie_pis_cofins_w,
				nr_seq_bras_preco_w
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
			--and	ie_tipo_preco		= nvl(ie_tipo_preco_regra_w,ie_tipo_preco)   
			and	dt_inicio_vigencia	=
				(SELECT max(a.dt_inicio_vigencia)
				from	brasindice_preco a
				where	a.cd_laboratorio      = cd_laboratorio_w
				and	a.cd_medicamento      = cd_medicamento_w
				and	a.cd_apresentacao     = cd_apresentacao_w
				and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				--and	a.ie_tipo_preco	      = nvl(ie_tipo_preco_regra_w,a.ie_tipo_preco)
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
				and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
			exception
				when others then
					begin
					select  coalesce(vl_preco_final, vl_preco_medicamento),
						ie_tipo_preco,
						dt_inicio_vigencia,
						coalesce(ie_preco_port,'T'),
						coalesce(pr_ipi,0),
						coalesce(ie_pis_cofins,'T'),
						nr_sequencia
					into STRICT	vl_medicamento_w,
						ie_tipo_preco_w,
						dt_ult_vigencia_w,
						ie_preco_port_w,
						pr_ipi_w,
						ie_pis_cofins_w,
						nr_seq_bras_preco_w
					from	brasindice_preco
					where	cd_laboratorio		= cd_laboratorio_w
					and	cd_medicamento		= cd_medicamento_w
					and	cd_apresentacao		= cd_apresentacao_w
					and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)   
					and	dt_inicio_vigencia	=
						(SELECT max(a.dt_inicio_vigencia)
						from	brasindice_preco a
						where	a.cd_laboratorio      = cd_laboratorio_w
						and	a.cd_medicamento      = cd_medicamento_w
						and	a.cd_apresentacao     = cd_apresentacao_w
						and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
						and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
						and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
						and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
					exception
						when others then					
						ie_tipo_preco_w	:= '';
					end;
			end;
		end if;
		
	elsif (ie_prioridade_brasindice_w = 'S') then
	
			/* obter pre?o do medicamento */

		if (ie_exige_lib_w	= 'S') then
			begin
			select  coalesce(vl_preco_final, vl_preco_medicamento),
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T'),
				coalesce(pr_ipi,0),
				coalesce(ie_pis_cofins,'T'),
				nr_sequencia
			into STRICT	vl_medicamento_w,
				ie_tipo_preco_w,
				dt_ult_vigencia_w,
				ie_preco_port_w,
				pr_ipi_w,
				ie_pis_cofins_w,
				nr_seq_bras_preco_w
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
			and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
			and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
			and	dt_inicio_vigencia	=
				(SELECT max(a.dt_inicio_vigencia)
				from	brasindice_preco a
				where	a.cd_laboratorio      = cd_laboratorio_w
				and	a.cd_medicamento      = cd_medicamento_w
				and	a.cd_apresentacao     = cd_apresentacao_w
				and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

				and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
				and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
				and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
			exception
				when others then
					begin
					select  coalesce(vl_preco_final, vl_preco_medicamento),
						ie_tipo_preco,
						dt_inicio_vigencia,
						coalesce(ie_preco_port,'T'),
						coalesce(pr_ipi,0),
						coalesce(ie_pis_cofins,'T'),
						nr_sequencia
					into STRICT	vl_medicamento_w,
						ie_tipo_preco_w,
						dt_ult_vigencia_w,
						ie_preco_port_w,
						pr_ipi_w,
						ie_pis_cofins_w,
						nr_seq_bras_preco_w
					from	brasindice_preco
					where	cd_laboratorio		= cd_laboratorio_w
					and	cd_medicamento		= cd_medicamento_w
					and	cd_apresentacao		= cd_apresentacao_w 
					and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
					and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
					and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)
					and	dt_inicio_vigencia	=
						(SELECT max(a.dt_inicio_vigencia)
						from	brasindice_preco a
						where	a.cd_laboratorio      = cd_laboratorio_w
						and	a.cd_medicamento      = cd_medicamento_w
						and	a.cd_apresentacao     = cd_apresentacao_w
						and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

						and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
						and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
						and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
						and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
						and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
						and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
					exception
						when others then					
						ie_tipo_preco_w	:= '';
					end;
			end;
		else
			begin
			select  coalesce(vl_preco_final, vl_preco_medicamento),
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T'),
				coalesce(pr_ipi,0),
				coalesce(ie_pis_cofins,'T'),
				nr_sequencia
			into STRICT	vl_medicamento_w,
				ie_tipo_preco_w,
				dt_ult_vigencia_w,
				ie_preco_port_w,
				pr_ipi_w,
				ie_pis_cofins_w,
				nr_seq_bras_preco_w
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
			and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
			and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
			and	dt_inicio_vigencia	=
				(SELECT max(a.dt_inicio_vigencia)
				from	brasindice_preco a
				where	a.cd_laboratorio      = cd_laboratorio_w
				and	a.cd_medicamento      = cd_medicamento_w
				and	a.cd_apresentacao     = cd_apresentacao_w
				and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
				/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

				and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
				and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
				and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
			exception
				when others then
					begin
					select  coalesce(vl_preco_final, vl_preco_medicamento),
						ie_tipo_preco,
						dt_inicio_vigencia,
						coalesce(ie_preco_port,'T'),
						coalesce(pr_ipi,0),
						coalesce(ie_pis_cofins,'T'),
						nr_sequencia
					into STRICT	vl_medicamento_w,
						ie_tipo_preco_w,
						dt_ult_vigencia_w,
						ie_preco_port_w,
						pr_ipi_w,
						ie_pis_cofins_w,
						nr_seq_bras_preco_w
					from	brasindice_preco
					where	cd_laboratorio		= cd_laboratorio_w
					and	cd_medicamento		= cd_medicamento_w
					and	cd_apresentacao		= cd_apresentacao_w
					and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
					and 	((ie_restrito_w = 'A') or (coalesce(ie_restrito,'A') = ie_restrito_w))
					and 	((ie_solucao_w = 'A') or (coalesce(ie_solucao,'A') = ie_solucao_w))
					and	ie_tipo_preco		= coalesce(ie_tipo_preco_regra_w,ie_tipo_preco)   
					and	dt_inicio_vigencia	=
						(SELECT max(a.dt_inicio_vigencia)
						from	brasindice_preco a
						where	a.cd_laboratorio      = cd_laboratorio_w
						and	a.cd_medicamento      = cd_medicamento_w
						and	a.cd_apresentacao     = cd_apresentacao_w
						and 	coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
						/* Realizado o tratamento desse par?metro ie_data_fixa_p, apenas aqui no subSelect devido ? OS 650835*/

						and 	((ie_data_fixa_w = 'N') or ((ie_restrito_w = 'A') or (coalesce(a.ie_restrito,'A') = ie_restrito_w)))
						and 	((ie_data_fixa_w = 'N') or ((ie_solucao_w = 'A') or (coalesce(a.ie_solucao,'A') = ie_solucao_w)))
						and	a.ie_tipo_preco	      = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco)
						and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
						and	((ie_data_fixa_w = 'N') or (a.dt_inicio_vigencia = dt_vigencia_bras_w))
						and 	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')));
					exception
						when others then					
						ie_tipo_preco_w	:= '';
					end;
			end;
		end if;	
	
	end if;
	
	if (ie_arred_vl_bras_ant_w = 'S') then
		if (qt_conversao_w = 0) then
			qt_conversao_w := 1;
		end if;
		
		if (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'S') then
			
			vl_medicamento_w := vl_medicamento_w + (vl_medicamento_w * pr_ipi_w / 100);
			vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,2);
			
		elsif (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'N') then
			vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,2);
		end if;
		
		if (ie_relacionado_bras_w = 'N') then
			vl_medicamento_w := 0;
		end if;
	end if;
	
	
	if (ie_ignora_divisao_bras_w = 'S') then
		ie_dividir_indice_pfb_w:= 'N';
		ie_dividir_indice_pmc_w:= 'N';
	end if;
	
	if (ie_dividir_indice_pfb_w = 'N') then
	
		if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
			if (ie_pis_cofins_w = 'S') then
				vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
			elsif (ie_pis_cofins_w = 'N') then
				vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
			else
				vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
			end if;	
		end if;
		
	elsif (ie_dividir_indice_pfb_w = 'S') then
	
		if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
			if (ie_pis_cofins_w = 'S') then
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
			elsif (ie_pis_cofins_w = 'N') then
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
			else
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
			end if;	
		end if;
		
	elsif (ie_dividir_indice_pfb_w = 'R') then

		select	coalesce(max(ie_dividir_indice_pfb),'N')
		into STRICT	ie_div_indice_pfb_conv_w
		from 	convenio_estabelecimento
		where	cd_convenio		= cd_convenio_p
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (ie_div_indice_pfb_conv_w = 'S') then	
		
			if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
				else
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
				end if;	
			end if;
			
		elsif (ie_div_indice_pfb_conv_w = 'N') then
		
			if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
				else
					vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
				end if;	
			end if;
			
		elsif (ie_div_indice_pfb_conv_w = 'R') then
			
			open c07;
			loop
			fetch c07 into	
				ie_div_indice_pfb_regra_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */
				begin
				ie_div_indice_pfb_regra_w	:= ie_div_indice_pfb_regra_w;
				end;
			end loop;
			close c07;
			
			if (ie_div_indice_pfb_regra_w = 'S') then	
		
				if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pfb_neg_w);
					else
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_preco_fabrica_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pfb_regra_w = 'N') then
			
				if (tx_preco_fabrica_w IS NOT NULL AND tx_preco_fabrica_w::text <> '') and (ie_tipo_preco_w = 'PFB') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pfb_neg_w);
					else
						vl_medicamento_w	:= (vl_medicamento_w * tx_preco_fabrica_w);
					end if;	
				end if;
			end if;
		end if;	
	
	end if;
	
	/* conforme resolu??o cmed n? 2, de 10 de mar?o de 2006 
	
	art. 4? o pre?o m?ximo ao consumidor - pmc ser? obtido por meio da divis?o do pre?o
	fabricante - pf pelos fatores constantes da tabela abaixo, observadas as cargas tribut?rias do
	icms praticadas nos estados de destino e a incid?ncia da contribui??o para o pis/pasep e
	cofins, conforme o disposto na lei n? 10.147, de 21 de dezembro de 2001.  
	
	icms            lista positiva               lista negativa                     lista neutra 
	19%   	0,7234   		0,7523    		0,7071  
	18%               0,7234     		0,7519      		0,7073  
	17%   	0,7234   		0,7515    		0,7075  
	12%   	0,7234   		0,7499    		0,7084  
	0%   	0,7234   		0,7465     		0,7103  */
	
	if (ie_dividir_indice_pmc_w = 'N') then
	
		if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
			if (ie_pis_cofins_w = 'S') then
				vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
			elsif (ie_pis_cofins_w = 'N') then
				vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
			else
				vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
			end if;	
		end if;
		
	elsif (ie_dividir_indice_pmc_w = 'S') then
	
		if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
			if (ie_pis_cofins_w = 'S') then
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
			elsif (ie_pis_cofins_w = 'N') then
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
			else
				vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
			end if;	
		end if;
		
	elsif (ie_dividir_indice_pmc_w = 'R') then

		select	coalesce(max(ie_dividir_indice_pmc),'N')
		into STRICT	ie_div_indice_pmc_conv_w
		from 	convenio_estabelecimento
		where	cd_convenio		= cd_convenio_p
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (ie_div_indice_pmc_conv_w = 'S') then	
		
			if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
				else
					vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
				end if;	
			end if;
			
		elsif (ie_div_indice_pmc_conv_w = 'N') then
		
			if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
				if (ie_pis_cofins_w = 'S') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
				elsif (ie_pis_cofins_w = 'N') then
					vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
				else
					vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
				end if;	
			end if;
			
		elsif (ie_div_indice_pmc_conv_w = 'R') then
			
			open c06;
			loop
			fetch c06 into	
				ie_div_indice_pmc_regra_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				begin
				ie_div_indice_pmc_regra_w	:= ie_div_indice_pmc_regra_w;
				end;
			end loop;
			close c06;
			
			if (ie_div_indice_pmc_regra_w = 'S') then	
			
				if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_pmc_neg_w);
					else
						vl_medicamento_w	:= dividir(vl_medicamento_w , tx_brasindice_pmc_w);
					end if;	
				end if;
				
			elsif (ie_div_indice_pmc_regra_w = 'N') then	
			
				if (tx_brasindice_pmc_w IS NOT NULL AND tx_brasindice_pmc_w::text <> '') and (ie_tipo_preco_w = 'PMC') then
					if (ie_pis_cofins_w = 'S') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
					elsif (ie_pis_cofins_w = 'N') then
						vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
					else
						vl_medicamento_w	:= (vl_medicamento_w * tx_brasindice_pmc_w);
					end if;	
				end if;
			end if;
		end if;
		
	end if;
	
	if (ie_arred_vl_bras_ant_w = 'N') then 	
		/*      converte o preco para consumo material */

		if (qt_conversao_w = 0) then
			qt_conversao_w := 1;
		end if;
		
		if (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'S') then
			
			vl_medicamento_w := vl_medicamento_w + (vl_medicamento_w * pr_ipi_w / 100);
			vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,4);
			
		elsif (vl_medicamento_w > 0) and (ie_ipi_brasindice_w = 'N') then
			vl_medicamento_w := trunc(vl_medicamento_w / qt_conversao_w,4);
		end if;
		
		if (ie_relacionado_bras_w = 'N') then
			vl_medicamento_w := 0;
		end if;
	end if;
	
	ie_brasindice_w		:= 'N';
	
	/* passei para o in?cio da function - heckmann 19/05/2010 - os 214864
	select 	max(cd_grupo_material)
	into	cd_grupo_material_w
	from 	estrutura_material_v
	where 	cd_material = cd_material_p;
	*/
	
	if (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') and (coalesce(cd_categoria_p,'0') <> '0') then
		begin
		
		open c02;
		loop
		fetch c02 into	
			ie_brasindice_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			ie_brasindice_w:= ie_brasindice_w;
			end;
		end loop;
		close c02;
		
		end;
	end if;
	
	if (ie_preco_medio_bras_w = 'S') then
		open c04;
		loop
		fetch c04 into	
			c04_w;				
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			i := i + 1;

			nr_seq_mat_bras_medio_w:= c04_w.nr_sequencia;				
			
			SELECT * FROM Define_valor_medic_brasindice( 	cd_estabelecimento_p, c04_w.cd_medicamento, c04_w.cd_apresentacao, c04_w.cd_laboratorio, c04_w.qt_conversao, dt_vigencia_bras_w, tx_brasindice_pfb_p, tx_brasindice_pmc_p, tx_pmc_neg_p, tx_pmc_pos_p, tx_pfb_pos_p, tx_pfb_neg_p, cd_convenio_p, cd_categoria_p, cd_material_p, ie_tipo_atendimento_p, vl_bras_w, nr_seq_bras_preco_medio_w) INTO STRICT vl_bras_w, nr_seq_bras_preco_medio_w;
			
			vetor_valor_w[i].vl_medicamento 	:= coalesce(vl_bras_w,0);
			vetor_valor_w[i].nr_sequencia   	:= nr_seq_mat_bras_medio_w;
			vetor_valor_w[i].nr_seq_bras_preco	:= nr_seq_bras_preco_medio_w;
			
			end;
		end loop;
		close c04;

		-- Necess?rio reordenar o vetor em ordem crescente de valores
		for  f in 1..vetor_valor_w.count loop
			for  g in f+1..vetor_valor_w.count loop
			
				if (vetor_valor_w[g].vl_medicamento <  vetor_valor_w[f].vl_medicamento) then
					
					vl_bras_w			:= vetor_valor_w[g].vl_medicamento;
					nr_seq_mat_bras_medio_w		:= vetor_valor_w[g].nr_sequencia;
					nr_seq_bras_preco_medio_w		:= vetor_valor_w[g].nr_seq_bras_preco;						
					
					vetor_valor_w[g].vl_medicamento 	:= vetor_valor_w[f].vl_medicamento;
					vetor_valor_w[g].nr_sequencia  		:= vetor_valor_w[f].nr_sequencia;
					vetor_valor_w[g].nr_seq_bras_preco  	:= vetor_valor_w[f].nr_seq_bras_preco;						
					
					
					vetor_valor_w[f].vl_medicamento 	:= vl_bras_w;
					vetor_valor_w[f].nr_sequencia  		:= nr_seq_mat_bras_medio_w;
					vetor_valor_w[f].nr_seq_bras_preco	:= nr_seq_bras_preco_medio_w;
					
					
				end if;
				
			end loop;
		end loop;
		
		
		
		select	round(dividir(i,2))
		into STRICT	qt_reg_w
		;
		
		if (i >= 3) then
			vl_medicamento_w 	:= vetor_valor_w[qt_reg_w].vl_medicamento;
			nr_seq_mat_bras_w	:= vetor_valor_w[qt_reg_w].nr_sequencia;
			nr_seq_bras_preco_w	:= vetor_valor_w[qt_reg_w].nr_seq_bras_preco;			
		end if;
	end if;
	
	if (ie_brasindice_w = 'N') then
		begin
		vl_medicamento_w	:= 0;
		dt_ult_vigencia_w	:= clock_timestamp();
		end;
	end if;

	if ((coalesce(vl_minimo_brasind_w, 0) > 0) or (coalesce(vl_maximo_brasind_w, 0) > 0)) then
		if ((vl_medicamento_w < coalesce(vl_minimo_brasind_w, vl_medicamento_w)) or (vl_medicamento_w > coalesce(vl_maximo_brasind_w, vl_medicamento_w))) then 
			vl_medicamento_w	:= 0;
			dt_ult_vigencia_w	:= clock_timestamp();
		end if;
	end if;
	
	vl_medicamento_p	:= vl_medicamento_w;
	dt_ult_vigencia_p	:= dt_ult_vigencia_w;
	nr_seq_mat_bras_p	:= nr_seq_mat_bras_w;
	nr_seq_bras_preco_p	:= nr_seq_bras_preco_w;
	
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_preco_brasindice ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, tx_brasindice_pmc_p bigint, tx_brasindice_pfb_p bigint, tx_pfb_pos_p bigint, tx_pfb_neg_p bigint, tx_pmc_neg_p bigint, tx_pmc_pos_p bigint, ie_tipo_atendimento_p bigint, nr_seq_marca_p bigint, vl_medicamento_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tiss_p INOUT text, nr_seq_regra_ajuste_p bigint default null, ie_data_fixa_p text default null, cd_plano_p text default null, ie_restrito_p text default null, ie_solucao_p text default null, nr_seq_bras_preco_p INOUT bigint DEFAULT NULL, nr_seq_mat_bras_p INOUT bigint DEFAULT NULL, nr_seq_conv_bras_p bigint default null) FROM PUBLIC;

