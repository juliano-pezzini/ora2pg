-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE odonto_inserir_proced_conta (nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint default null, qt_procedimento_p bigint DEFAULT NULL, nr_seq_odont_proced_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_plano_tratamento_p text default 'N') AS $body$
DECLARE


cd_convenio_w		bigint  	:= 0;
cd_categoria_w		bigint  	:= 0;	
nr_seq_atepacu_w	bigint  	:= 0;
dt_ent_unidade_w	timestamp 		:= clock_timestamp();
cd_local_estoque_w	bigint;
nr_seq_proc_pac_w  	bigint  	:= 0;				
ds_erro_w		varchar(255);
cd_setor_atendimento_w	bigint;
cd_medico_executor_w	procedimento_paciente.cd_medico_executor%type;
cd_medico_exec_w	procedimento_paciente.cd_medico_executor%type;
ie_tipo_atendimento_w	atendimento_paciente.ie_tipo_atendimento%type;
ie_medico_executor_w	procedimento_paciente.ie_funcao_medico%type;
cd_cgc_prest_regra_w	procedimento_paciente.cd_cgc_prestador%type;
cd_pes_fis_regra_w	procedimento_paciente.cd_pessoa_fisica%type;
nr_seq_classificacao_w	atendimento_paciente.nr_seq_classificacao%type;
cd_profissional_w	odont_procedimento.cd_profissional%type;
nr_interno_conta_w      conta_paciente.nr_interno_conta%type;
cd_estabelecimento_w    conta_paciente.cd_estabelecimento%type;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	select 	max(obter_convenio_atendimento(a.nr_atendimento)),
		max(obter_dados_categ_conv(a.nr_atendimento,'CA')),
		max(Obter_Atepacu_paciente(nr_atendimento_p,'A')),
		max(ie_tipo_atendimento),
		max(nr_seq_classificacao)
	into STRICT  	cd_convenio_w,
		cd_categoria_w,
		nr_seq_atepacu_w,
		ie_tipo_atendimento_w,
		nr_seq_classificacao_w
	from  	atendimento_paciente a
	where 	a.nr_atendimento = nr_atendimento_p;
		
	select	max(Obter_Dados_AtePacu(nr_seq_atepacu_w,0))
	into STRICT	cd_setor_atendimento_w
	;
	
	select 	max(w.dt_entrada_unidade)
	into STRICT	dt_ent_unidade_w
	from   	atend_paciente_unidade w
	where  	w.nr_atendimento 		= nr_atendimento_p
	and    	w.cd_setor_atendimento 		= cd_setor_atendimento_w;
	
	select	max(cd_local_estoque)
	into STRICT	cd_local_estoque_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;
	
	SELECT * FROM consiste_medico_executor(wheb_usuario_pck.get_cd_estabelecimento, cd_convenio_w, cd_setor_atendimento_w, cd_procedimento_p, ie_origem_proced_p, ie_tipo_atendimento_w, null, nr_seq_proc_interno_p, ie_medico_executor_w, cd_cgc_prest_regra_w, cd_medico_executor_w, cd_pes_fis_regra_w, null, clock_timestamp(), nr_seq_classificacao_w, 'N', null, null) INTO STRICT ie_medico_executor_w, cd_cgc_prest_regra_w, cd_medico_executor_w, cd_pes_fis_regra_w;
			
	if (ie_plano_tratamento_p = 'N') then
		select	max(cd_profissional)
		into STRICT	cd_medico_exec_w
		from	odont_procedimento
		where	nr_sequencia = nr_seq_odont_proced_p;
	else
		select	max(cd_profissional)
		into STRICT	cd_medico_exec_w
		from	odont_procedimento_proc
		where	nr_sequencia = nr_seq_odont_proced_p;
	end if;

	if (coalesce(cd_medico_exec_w::text, '') = '') then
		cd_medico_exec_w := cd_medico_executor_w;
	end if;
	
	select 	nextval('procedimento_paciente_seq')
	into STRICT  	nr_seq_proc_pac_w
	;

	insert into procedimento_paciente(nr_sequencia,
						nr_atendimento,
						dt_entrada_unidade,
						cd_procedimento,
						dt_procedimento,
						qt_procedimento,
						dt_atualizacao,
						nm_usuario,
						cd_setor_atendimento,
						ie_origem_proced,
						nr_seq_atepacu,
						nr_seq_proc_interno,
						cd_convenio,
						cd_categoria,
						cd_pessoa_fisica,
						cd_medico_executor,
						cd_cgc_prestador)
				values (nr_seq_proc_pac_w,
						nr_atendimento_p,
						coalesce(dt_ent_unidade_w,clock_timestamp()),
						cd_procedimento_p,
						clock_timestamp(),
						qt_procedimento_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_setor_atendimento_w,
						ie_origem_proced_p,
						nr_seq_atepacu_w,
						nr_seq_proc_interno_p,
						cd_convenio_w,
						cd_categoria_w,
						cd_pes_fis_regra_w,
						cd_medico_exec_w,
						cd_cgc_prest_regra_w);

	ds_erro_w := consiste_exec_procedimento(nr_seq_proc_pac_w, ds_erro_w);
	CALL atualiza_preco_procedimento(nr_seq_proc_pac_w, cd_convenio_w, nm_usuario_p);
	CALL gerar_lancamento_automatico(nr_atendimento_p,cd_local_estoque_w,34,nm_usuario_p,nr_seq_proc_pac_w,null,null,null,null,null);

    select a.nr_interno_conta,
        a.cd_estabelecimento
    into STRICT nr_interno_conta_w,
        cd_estabelecimento_w
    from conta_paciente a,
        procedimento_paciente b
    where b.nr_sequencia = nr_seq_proc_pac_w
    and b.nr_interno_conta = a.nr_interno_conta;

    CALL tiss_atualizar_conta_paciente(nr_interno_conta_w, null, 'S', cd_estabelecimento_w, nm_usuario_p, null, null);
	
	if (ie_plano_tratamento_p = 'N') then	
		update	odont_procedimento		
		set	nr_seq_propaci = nr_seq_proc_pac_w
		where	nr_sequencia = nr_seq_odont_proced_p;
	
	else
		update 	odont_procedimento_proc
		set	nr_seq_propaci = nr_seq_proc_pac_w
		where	nr_sequencia = nr_seq_odont_proced_p;
	
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE odonto_inserir_proced_conta (nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint default null, qt_procedimento_p bigint DEFAULT NULL, nr_seq_odont_proced_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, ie_plano_tratamento_p text default 'N') FROM PUBLIC;

