-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_unt (( nr_seq_dataset_p bigint, nm_usuario_p text) is qt_segmento_w D301_SEGMENTO_UNT.qt_segmento%type) RETURNS bigint AS $body$
DECLARE

	qt_retorno_w	bigint := 0;

	
BEGIN

	qt_retorno_w := Obter_valor_Dinamico('SELECT COUNT(*) QT FROM D301_SEGMENTO_'||ie_segmento_p||' WHERE NR_SEQ_DATASET = '||nr_seq_dataset_p, qt_retorno_w);

	return qt_retorno_w;

	end;

begin

select	max(a.ie_dataset),
	max(b.nr_seq_estrut_arq)
into STRICT	ie_dataset_w,
	nr_seq_estrut_arq_w
from	d301_dataset_envio a,
	d301_arquivo_envio b
where	a.nr_sequencia		= nr_seq_dataset_p
and	a.nr_seq_arquivo	= b.nr_sequencia;

select	max(NR_REF_SEGMENTO)
into STRICT	nr_ref_segmento_w
from	D301_SEGMENTO_UNH
where	nr_seq_dataset	= nr_seq_dataset_p;

qt_segmento_w	:= 1;

open C01;
loop
fetch C01 into
	ie_segmento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	qt_segmento_w := qt_segmento_w + obter_qt_segmento(ie_segmento_w);

end loop;
close C01;

insert into D301_SEGMENTO_UNT(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	qt_segmento,
	nr_ref_segmento,
	nr_seq_dataset)
values (nextval('d301_segmento_unt_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	qt_segmento_w,
	lpad(nr_ref_segmento_w,5,'0'),
	nr_seq_dataset_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_unt (( nr_seq_dataset_p bigint, nm_usuario_p text) is qt_segmento_w D301_SEGMENTO_UNT.qt_segmento%type) FROM PUBLIC;

