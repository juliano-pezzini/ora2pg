-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_item_central_compra ( nr_seq_sup_central_compra_p bigint, nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_item_oci_w			integer;
cd_material_w			integer;
qt_material_w			double precision;
cd_unidade_medida_compra_w	varchar(30);

C01 CURSOR FOR 
SELECT	b.nr_item_oci, 
	b.cd_material, 
	b.cd_unidade_medida_compra, 
	b.qt_material 
from	ordem_compra_item b, 
	ordem_compra a 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	a.ie_tipo_ordem = 'T' 
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	b.ie_geracao_solic = 'P' 
and (nr_item_oci_p = 0 or b.nr_item_oci = nr_item_oci_p) 
and	a.nr_ordem_compra = nr_ordem_compra_p 
and	exists (	SELECT	1 
		from	ordem_compra_item_entrega x 
		where	x.nr_item_oci = b.nr_item_oci 
		and	x.nr_ordem_compra = b.nr_ordem_compra 
		and	coalesce(x.dt_cancelamento::text, '') = '' 
		and	coalesce(x.qt_prevista_entrega,0) > coalesce(x.qt_real_entrega,0)) 
order by b.nr_item_oci;


BEGIN 
open C01;
loop 
fetch C01 into	 
	nr_item_oci_w, 
	cd_material_w, 
	cd_unidade_medida_compra_w, 
	qt_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	insert into sup_central_compra_item( 
		nr_sequencia, 
		nr_seq_sup_central_compra, 
		nr_ordem_compra, 
		nr_item_oci, 
		cd_material, 
		qt_material, 
		cd_unidade_medida, 
		nm_usuario, 
		nm_usuario_nrec, 
		dt_atualizacao, 
		dt_atualizacao_nrec) 
	values (	nextval('sup_central_compra_item_seq'), 
		nr_seq_sup_central_compra_p, 
		nr_ordem_compra_p, 
		nr_item_oci_w, 
		cd_material_w, 
		qt_material_w, 
		cd_unidade_medida_compra_w, 
		nm_usuario_p, 
		nm_usuario_p, 
		clock_timestamp(), 
		clock_timestamp());
	end;
end loop;
close C01;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_item_central_compra ( nr_seq_sup_central_compra_p bigint, nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_usuario_p text) FROM PUBLIC;

