-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_evo_paciente_req_tie (CD_EVOLUCAO_P bigint, IE_EVENT_TYPE_P text) AS $body$
DECLARE

  /*
    - IE_EVENT_TYPE_P
    A - TIE event name: clinical.notes.import
    I - TIE event name: clinical.notes.inactive
  */
  TIE_EVENT_NAME_W varchar(255);
  DS_JSON_W        text;
  DS_EVOLUCAO_W    text;
  NM_USUARIO_W     EVOLUCAO_PACIENTE.NM_USUARIO%TYPE;

BEGIN
  IF (coalesce(CD_EVOLUCAO_P, 0) > 0 AND UPPER(IE_EVENT_TYPE_P) IN ('A', 'I')) THEN
    IF (UPPER(IE_EVENT_TYPE_P) = 'A') THEN
      TIE_EVENT_NAME_W := 'clinical.notes.import';
    ELSIF (UPPER(IE_EVENT_TYPE_P) = 'I') THEN
      TIE_EVENT_NAME_W := 'clinical.notes.inactive';
    END IF;

    SELECT CONVERT_LONG_('EVOLUCAO_PACIENTE',
                                'DS_EVOLUCAO',
                                'CD_EVOLUCAO = ' || EP.CD_EVOLUCAO) DS_EVOLUCAO_CLOB,
           EP.NM_USUARIO
      INTO STRICT DS_EVOLUCAO_W, NM_USUARIO_W
      FROM EVOLUCAO_PACIENTE EP
     WHERE EP.CD_EVOLUCAO = CD_EVOLUCAO_P;

    IF (UPPER(DS_EVOLUCAO_W) LIKE '%HTML%') THEN
      DS_JSON_W := BIFROST.SEND_INTEGRATION(TIE_EVENT_NAME_W,
                                            'com.philips.tasy.integration.telehealth.clinicalnotes.callback.ClinicalNotesCallback',
                                            '{"id": ' || CD_EVOLUCAO_P || ', "eventType" : "' || IE_EVENT_TYPE_P || '"}',
                                            NM_USUARIO_W);
    END IF;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_evo_paciente_req_tie (CD_EVOLUCAO_P bigint, IE_EVENT_TYPE_P text) FROM PUBLIC;

