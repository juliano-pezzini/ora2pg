-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirmar_agendamento_part_js ( NM_USUARIO_P text, NR_SEQUENCIA_P bigint, DS_OBSERVACAO_P text) AS $body$
DECLARE

 
nr_ordem_servico_w	bigint;
nr_sequencia_solic_w	bigint;
nr_seq_tipo_dem_w	bigint;
ie_ead_w		varchar(1);
nr_seq_regra_w		bigint;

nr_seq_tipo_w      bigint;
ds_historico_w     varchar(4000);
ie_enviar_email_w    varchar(1);

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_tipo_dem 
	from	com_solic_sd 
	where	nr_ordem_servico = nr_ordem_servico_w;					
					 

BEGIN 
 
if (coalesce(nr_sequencia_p,0) > 0) then 
 
	update	agenda_tasy 
	set	ie_status 		= 'F', 
		dt_confirmacao    	= clock_timestamp(), 
		nm_usuario_confirmacao = nm_usuario_p, 
		ds_obs_confirmacao   = ds_observacao_p 
	where	nr_sequencia 		= nr_sequencia_p;
	 
	select	coalesce(max(nr_ordem_servico),0) 
	into STRICT	nr_ordem_servico_w 
	from	agenda_tasy 
	where	nr_sequencia = nr_sequencia_p;
	 
	if (nr_ordem_servico_w > 0) then 
	 
		open C01;
		loop 
		fetch C01 into	 
			nr_sequencia_solic_w, 
			nr_seq_tipo_dem_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			update	com_solic_sd 
			set	ie_status = 'CO' 
			where	nr_sequencia = nr_sequencia_solic_w;
			 
			select	coalesce(max(ie_ead),'N') 
			into STRICT	ie_ead_w 
			from	com_tipo_demonstracao 
			where	nr_sequencia = nr_seq_tipo_dem_w;
			 
			select	coalesce(max(nr_sequencia),0) 
			into STRICT	nr_seq_regra_w 
			from	regra_comunic_conf_age 
			where	ie_ead = ie_ead_w;
			 
			if (nr_seq_regra_w > 0) then 
			 
				select	nr_seq_tipo,   
					ds_historico,  
					ie_enviar_email 
				into STRICT	nr_seq_tipo_w, 
					ds_historico_w, 
					ie_enviar_email_w 
				from	regra_comunic_conf_age 
				where	nr_sequencia = nr_seq_regra_w;
				 
				insert into man_ordem_serv_tecnico( 
							nr_sequencia, 
							nr_seq_ordem_serv, 
							dt_atualizacao, 
							nm_usuario, 
							ds_relat_tecnico, 
							cd_versao_tasy, 
							dt_historico, 
							ie_origem, 
							nr_seq_tipo, 
							nm_usuario_lib, 
							dt_liberacao, 
							ie_grau_satisfacao) 
				values ( 
					nextval('man_ordem_serv_tecnico_seq'), 
					nr_ordem_servico_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					ds_historico_w, 
					null, 
					clock_timestamp(), 
					'I', 
					nr_seq_tipo_w, 
					nm_usuario_p, 
					clock_timestamp(), 
					null);	
				if (coalesce(ie_enviar_email_w,'N') = 'S') then 
					 
					CALL com_enviar_email_conf_age_js(nm_usuario_p, nr_seq_regra_w, nr_ordem_servico_w,nr_sequencia_solic_w);
				end if;
			end if;
			 
			end;
		end loop;
		close C01;
		 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirmar_agendamento_part_js ( NM_USUARIO_P text, NR_SEQUENCIA_P bigint, DS_OBSERVACAO_P text) FROM PUBLIC;

