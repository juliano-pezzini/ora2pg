-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_item_solic_compra ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_item_solic_compra_w			integer;
nr_item_solic_compra_entr_w			integer;
cd_local_estoque_w				bigint;
cd_estabelecimento_w				bigint;

c01 CURSOR FOR
	SELECT	nr_solic_compra,
		nr_item_solic_compra,
		nr_item_solic_compra_entr,
		qt_entrega_solicitada,
		dt_entrega_solicitada,
		dt_atualizacao,
		nm_usuario,
		ds_observacao
	from	solic_compra_item_entrega
	where	nr_solic_compra = nr_solic_compra_p
	and	nr_item_solic_compra = nr_item_solic_compra_p;

vet01	c01%RowType;


BEGIN

select	cd_local_estoque,
	cd_estabelecimento
into STRICT	cd_local_estoque_w,
	cd_estabelecimento_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

select	coalesce(max(nr_item_solic_compra),0) +1
into STRICT	nr_item_solic_compra_w
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;

insert into solic_compra_item(
	nr_solic_compra,
	nr_item_solic_compra,
	cd_material,
	cd_unidade_medida_compra,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	ds_material_direto,
	ds_observacao,
	nr_cot_compra,
	nr_item_cot_compra,
	cd_motivo_baixa,
	dt_baixa,
	dt_solic_item,
	nr_seq_aprovacao,
	dt_autorizacao,
	vl_unit_previsto,
	ie_geracao,
	nr_seq_proj_rec,
	dt_reprovacao,
	nr_seq_motivo_cancel,
	ie_forma_exportar,
	nr_solic_compra_ref,
	nr_item_solic_compra_ref,
	cd_conta_contabil,
	ds_observacao_int,
	nr_contrato,
	ie_bula,
	ie_amostra,
	ie_catalogo,
	qt_conv_compra_est_orig,
	qt_saldo_disp_estoque)
SELECT	nr_solic_compra,
	nr_item_solic_compra_w,
	cd_material,
	cd_unidade_medida_compra,
	qt_material,
	clock_timestamp(),
	nm_usuario_p,
	ie_situacao,
	ds_material_direto,
	ds_observacao,
	nr_cot_compra,
	nr_item_cot_compra,
	cd_motivo_baixa,
	dt_baixa,
	dt_solic_item,
	nr_seq_aprovacao,
	dt_autorizacao,
	vl_unit_previsto,
	ie_geracao,
	nr_seq_proj_rec,
	dt_reprovacao,
	nr_seq_motivo_cancel,
	ie_forma_exportar,
	nr_solic_compra_ref,
	nr_item_solic_compra_ref,
	cd_conta_contabil,
	ds_observacao_int,
	nr_contrato,
	ie_bula,
	ie_amostra,
	ie_catalogo,
	obter_dados_material(cd_material,'QCE'),
	obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material, cd_local_estoque_w, trunc(clock_timestamp(),'mm'))
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p
and	nr_item_solic_compra = nr_item_solic_compra_p;

open c01;
loop
fetch c01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(nr_item_solic_compra_entr),0) +1
	into STRICT	nr_item_solic_compra_entr_w
	from	solic_compra_item_entrega
	where	nr_solic_compra = nr_solic_compra_p
	and	nr_item_solic_compra = nr_item_solic_compra_w;

	insert into solic_compra_item_entrega(
		nr_solic_compra,
		nr_item_solic_compra,
		nr_item_solic_compra_entr,
		qt_entrega_solicitada,
		dt_entrega_solicitada,
		dt_atualizacao,
		nm_usuario,
		ds_observacao)
	values (vet01.nr_solic_compra,
		nr_item_solic_compra_w,
		nr_item_solic_compra_entr_w,
		vet01.qt_entrega_solicitada,
		vet01.dt_entrega_solicitada,
		vet01.dt_atualizacao,
		vet01.nm_usuario,
		vet01.ds_observacao);

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_item_solic_compra ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

