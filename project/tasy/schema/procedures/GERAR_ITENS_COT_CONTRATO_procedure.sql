-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_cot_contrato ( nm_usuario_p text, nr_cot_compra_p bigint, nr_contrato_p bigint) AS $body$
DECLARE


cd_material_w		bigint;
nr_contrato_w		bigint;
nr_sequencia_w		bigint;
vl_unitario_material_w	double precision;
cd_pessoa_contratada_w	varchar(10);
cd_cgc_contratado_w	varchar(14);
vl_desconto_w		contrato_regra_nf.vl_desconto%type;
pr_desconto_w		contrato_regra_nf.pr_desconto%type;

C01 CURSOR FOR
SELECT  distinct
	b.cd_material,
	b.vl_unitario_material,
	b.vl_desconto,
	b.pr_desconto
from 	cot_compra_forn a,
	cot_compra_forn_item b
where	a.nr_sequencia = b.nr_seq_cot_forn
and	a.nr_cot_compra = nr_cot_compra_p
and	((cd_pessoa_contratada_w IS NOT NULL AND cd_pessoa_contratada_w::text <> '' AND a.cd_pessoa_fisica = cd_pessoa_contratada_w) or
	(cd_cgc_contratado_w IS NOT NULL AND cd_cgc_contratado_w::text <> '' AND a.cd_cgc_fornecedor = cd_cgc_contratado_w));


BEGIN

select	cd_pessoa_contratada,
	cd_cgc_contratado
into STRICT	cd_pessoa_contratada_w,
	cd_cgc_contratado_w
from	contrato
where	nr_sequencia = nr_contrato_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	vl_unitario_material_w,
	vl_desconto_w,
	pr_desconto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert into contrato_regra_nf(
		nr_sequencia,
		cd_material,
		nr_seq_contrato,
		dt_atualizacao,
		nm_usuario,
		vl_pagto,
		nr_cot_compra,
		ie_gera_sc_automatico,
		vl_desconto,
		pr_desconto)
	values (	nextval('contrato_regra_nf_seq'),
		cd_material_w,
		nr_contrato_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_unitario_material_w,
		nr_cot_compra_p,
		'N',
		vl_desconto_w,
		pr_desconto_w);
	end;

end loop;
close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_cot_contrato ( nm_usuario_p text, nr_cot_compra_p bigint, nr_contrato_p bigint) FROM PUBLIC;

