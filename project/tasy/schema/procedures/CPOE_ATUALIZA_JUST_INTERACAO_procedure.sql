-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualiza_just_interacao (ds_itens_liberados_p text) AS $body$
DECLARE


	ie_opcao_prescr_ww		varchar(2000);
	ie_opcao_prescr_w		varchar(255);
	item_w					varchar(255);
	nr_seq_reg_item_w		cpoe_material.nr_sequencia%type;
	nr_seq_cpoe_princ_w		cpoe_justif_interacao.nr_seq_cpoe_princ%type;
	ie_integ_lexicomp_w		integer;	
	nr_seq_controle_w		alerta_api.nr_seq_controle%type;
	nr_agrupamento_w		alerta_api.nr_agrupamento%type;
	cd_api_w				alerta_api.cd_api%type;

	C01 CURSOR FOR
		SELECT	distinct
				ds_justificativa,
				nr_seq_mat_cpoe,
				nr_seq_cpoe_princ
		from	cpoe_justif_interacao
		where	((nr_seq_cpoe_princ = nr_seq_reg_item_w) or (nr_seq_mat_cpoe = nr_seq_cpoe_princ_w));

	cAlertasAgrup CURSOR FOR
		SELECT distinct
			   a.nr_seq_controle,
			   a.nr_agrupamento,
			   a.cd_api
		  from alerta_api a
		 where a.nr_seq_cpoe = nr_seq_reg_item_w
		   and coalesce(a.ie_status_requisicao::text, '') = '';
		
	cAlertasJust CURSOR FOR
		SELECT distinct
			   b.nr_seq_mat_cpoe,
			   b.ds_justificativa
		  from alerta_api a,
			   cpoe_justif_interacao b
		 where a.nr_seq_cpoe = b.nr_seq_mat_cpoe
		   and a.cd_material = b.cd_material_interacao
		   and a.cd_api = b.cd_api
		   and coalesce(a.ds_sub_tipo_api, 'XPTO') = coalesce(b.ds_sub_tipo_api, 'XPTO')
		   and a.nr_gravidade = b.nr_gravidade
		   and a.ds_resultado_curto = b.ds_resultado_curto
		   and a.nr_seq_controle = nr_seq_controle_w
		   and a.nr_agrupamento = nr_agrupamento_w
		   and a.cd_api = cd_api_w
		   and coalesce(a.ie_status_requisicao::text, '') = '';

procedure atualizar_justificativa(nr_seq_cpoe_p 		in	cpoe_material.nr_sequencia%type,
								  ds_justificativa_p	in	cpoe_justif_interacao.ds_justificativa%type ) is
								
	ds_justificativa_w	cpoe_material.ds_justificativa%type;
BEGIN
	select max(ds_justificativa)
	  into STRICT ds_justificativa_w
	  from cpoe_material
	 where nr_sequencia = nr_seq_cpoe_p;

	if (coalesce(position(ds_justificativa_p in ds_justificativa_w),0) = 0) then
		
		if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
			update 	cpoe_material
			set		ds_justificativa = substr(trim(both ds_justificativa_w || chr(13) || ds_justificativa_p),1,2000)
			where	nr_sequencia = nr_seq_cpoe_p;
		else
			update 	cpoe_material
			set		ds_justificativa = substr(trim(both ds_justificativa_p),1,2000)
			where	nr_sequencia = nr_seq_cpoe_p;
		end if;
		
		commit;
	end if;
end;

begin
	ie_opcao_prescr_ww := ds_itens_liberados_p;

	while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '')
	loop
		begin

		if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
			ie_opcao_prescr_ww := ie_opcao_prescr_ww||';';
		end if;	
		
		item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
		ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
		nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
		ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
			
		if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') then
			
			if (ie_opcao_prescr_w = 'M') then
			
				select count(*)
				  into STRICT ie_integ_lexicomp_w
				  from cpoe_justif_interacao a
				 where a.nr_seq_mat_cpoe = nr_seq_reg_item_w 
				   and a.ie_integracao = 'LXC';
				
				if (ie_integ_lexicomp_w > 0) then
					for cAlertasAgrup_w in cAlertasAgrup
					loop
						nr_seq_controle_w := cAlertasAgrup_w.nr_seq_controle;
						nr_agrupamento_w := cAlertasAgrup_w.nr_agrupamento;
						cd_api_w := cAlertasAgrup_w.cd_api;
						
						for cAlertasJust_w in cAlertasJust
						loop
							atualizar_justificativa(cAlertasJust_w.nr_seq_mat_cpoe, cAlertasJust_w.ds_justificativa);
						end loop;
					end loop;
				else
					select 	coalesce(max(nr_seq_cpoe_princ),0)
					into STRICT	nr_seq_cpoe_princ_w
					from 	cpoe_justif_interacao
					where	nr_seq_mat_cpoe = nr_seq_reg_item_w
					and 	((nr_seq_cpoe_princ <> nr_seq_mat_cpoe) or (cd_api <> 'DRUG'));

					for c01_w in C01
					loop
						atualizar_justificativa(c01_w.nr_seq_mat_cpoe, c01_w.ds_justificativa);
						atualizar_justificativa(c01_w.nr_seq_cpoe_princ, c01_w.ds_justificativa);
					end loop;
				end if;
			end if;
		end if;
		end;
	end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualiza_just_interacao (ds_itens_liberados_p text) FROM PUBLIC;

