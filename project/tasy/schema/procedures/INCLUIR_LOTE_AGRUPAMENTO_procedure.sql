-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_lote_agrupamento ( cd_setor_atendimento_p bigint, nr_seq_turno_p bigint, nr_seq_classif_p bigint, nr_sequencia_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_seq_agrup_item_w	bigint;
nr_seq_lote_w		bigint;
qt_lotes_agrup_w		integer;
ie_agrupar_lote_copia_w parametros_farmacia.ie_agrupar_lote_copia%type;

C01 CURSOR FOR
	SELECT 	 a.nr_sequencia
	into STRICT	nr_seq_lote_w
	from    	regra_turno_disp b,
		ap_lote a
	where  	 a.nr_seq_turno  = b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_turno_p
	and	a.cd_setor_atendimento = cd_setor_atendimento_p
	and	a.nr_seq_classif  = nr_seq_classif_p
	and     	a.ie_status_lote  = 'A'
	and	trunc(a.dt_atend_lote, 'dd') between dt_inicio_p and dt_final_p
	and not exists ( SELECT 1
			from ap_lote_agrup_item c
			where c.nr_seq_lote = a.nr_sequencia)
    and ((coalesce(a.nr_lote_agrupamento::text, '') = '') or (ie_agrupar_lote_copia_w <> 'S'));


BEGIN

select coalesce(max(ie_agrupar_lote_copia), 'N')
  into STRICT ie_agrupar_lote_copia_w
  from parametros_farmacia
 where cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

open C01;
	loop
	fetch C01 into
		nr_seq_lote_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	nextval('ap_lote_agrup_item_seq')
		into STRICT	nr_seq_agrup_item_w
		;

		insert into ap_lote_agrup_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_agrup,
					nr_seq_lote,
					ie_status)
			values (nr_seq_agrup_item_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_p,
					nr_seq_lote_w,
					'P');
		end;
	end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_lote_agrupamento ( cd_setor_atendimento_p bigint, nr_seq_turno_p bigint, nr_seq_classif_p bigint, nr_sequencia_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

