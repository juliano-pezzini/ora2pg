-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_sepse_ilas (nr_seq_escala_p bigint, nm_usuario_p text) is ds_escala_w varchar(32000) RETURNS ESCALA_SEPSE_STATUS%ROWTYPE AS $body$
DECLARE


status_atual_w escala_sepse_status%rowtype;
ie_status_sepsis_w varchar(10) := '';
BEGIN


	select *
	into STRICT	ie_status_sepsis_w
	from (	SELECT 	ie_status_sepsis
					from 	ESCALA_SEPSE_STATUS 
					where 	NR_SEQ_ESCALA = nr_seq_escala_p 
					order by DT_AVALIACAO desc) alias0 LIMIT 1;

	select max(dt_atualizacao_nrec), max(nm_usuario_nrec), max(ds_justif_status), max(ie_status_sepsis), max(ds_justif_status)
	into STRICT   status_atual_w.dt_atualizacao_nrec, status_atual_w.nm_usuario_nrec, status_atual_w.ds_justif_status, status_atual_w.ie_status_sepsis, status_atual_w.ds_justif_status
	from   escala_sepse_status
	where  nr_seq_escala = nr_seq_escala_p
	and    ie_status_sepsis = coalesce(ie_status_p,ie_status_sepsis_w)
	and    dt_avaliacao between coalesce(dt_avaliacao_p,dt_avaliacao) - 0.0001 and (coalesce(dt_avaliacao_p,dt_avaliacao) + 0.0001);
	
	return status_atual_w;

end;

function date_to_char(dt_atual_w date) return varchar2 is

begin
	
	return PKG_DATE_FORMATERS.TO_VARCHAR(dt_atual_w,'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario);

end;

function obter_dados_acao(ie_status_p varchar2, dt_atual_p date, nr_atendimento_p number) return varchar2 is

c02 CURSOR FOR
	SELECT	e.nr_sequencia, e.ds_regra, f.ds_acao ds_acao, b.nr_sequencia NR_SEQ_PEND_PAC_ACAO, c.dt_justificativa dt_justificativa, c.ds_justificativa ds_justificativa, c.nr_seq_justificativa nr_seq_justificativa
	FROM	pessoa_fisica d,
			gqa_pendencia_pac a,
			GQA_PEND_PAC_ACAO b,
			GQA_PEND_PAC_ACAO_DEST c,
			gqa_pendencia_regra e,
			GQA_ACAO f
	WHERE	a.nr_sequencia = b.nr_seq_pend_pac
	AND		b.nr_sequencia = c.nr_seq_pend_pac_acao
	AND		d.cd_pessoa_fisica = a.cd_pessoa_fisica
	AND     a.nr_seq_pend_regra = e.nr_sequencia
	AND     b.nr_seq_regra_acao = f.nr_sequencia
	AND     e.nr_seq_escala = 124
	AND     e.ie_regra_sepse = ie_status_p
	AND     e.ie_situacao = 'A'
	AND     f.ie_situacao = 'A'
	AND     a.ie_escala = 168
	AND		c.cd_pessoa_fisica = OBTER_PESSOA_FISICA_USUARIO(nm_usuario_p,'C')
	AND		a.nr_atendimento    = nr_atendimento_p
	AND		(((b.nr_seq_proc IS NOT NULL AND b.nr_seq_proc::text <> '') OR (b.nr_seq_proc_saps IS NOT NULL AND b.nr_seq_proc_saps::text <> '')) OR (b.nr_seq_protocolo IS NOT NULL AND b.nr_seq_protocolo::text <> ''))
	AND     c.dt_atualizacao_nrec BETWEEN dt_atual_p - 0.0001  AND dt_atual_p + 0.0001;
	
ds_acoes_w 	   varchar2(32000) := ' ';
nr_seq_atual_w number(10);

begin
nr_seq_atual_w := 0;
for acao in c02 loop
	if (nr_seq_atual_w <> acao.nr_sequencia) then
		ds_acoes_w := '\b ' || obter_desc_expressao(285675, 'Conduta') ||' \b0 : ' || acao.ds_regra || p_linha_w;
		nr_seq_atual_w := acao.nr_sequencia;
	end if;
	
	select count(*)
	into STRICT 	qt_reg_pend_w
	from 	prescr_medica
	where 	nr_seq_pend_pac_acao = acao.nr_seq_pend_pac_acao
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	
	if (qt_reg_pend_w > 0) then
		select CASE WHEN coalesce(acao.dt_justificativa::text, '') = '' THEN ''  ELSE ' ('||obter_desc_expressao(501152) ||')' END  ds_complemento -- Aplicado
		into STRICT ds_complemento_w
		;
	else
		if (acao.nr_seq_justificativa IS NOT NULL AND acao.nr_seq_justificativa::text <> '') then
			select 	max(nm_justificativa) || ': '
			into STRICT	nm_justificativa_w
			from	GQA_PEND_JUSTIFICATIVA
			where	nr_sequencia = acao.nr_seq_justificativa;
		else
			nm_justificativa_w := '';
		end if;
				
		select CASE WHEN coalesce(acao.dt_justificativa::text, '') = '' THEN ''  ELSE ' ('||obter_desc_expressao(891655) || ' - ' || nm_justificativa_w || acao.ds_justificativa||')' END  ds_complemento -- Nao aplicada
		into STRICT ds_complemento_w
		;
	end if;
	ds_acoes_w := ds_acoes_w || acao.ds_acao || ds_complemento_w || p_linha_w;
	
end loop;

return ds_acoes_w;

end;
							
begin

if (nr_seq_escala_p > 0) then

	select	coalesce(max(ie_situacao),'A')
	into STRICT	ie_situacao_w
	from	tipo_evolucao
	where	cd_tipo_evolucao = 'SEP';
	
	if (ie_situacao_w = 'A') then

		/*Titulo da escala*/

		ds_escala_w := '\b ' || obter_desc_expressao(962739, 'Protocolo de Sepse') || ' \b0 : ';
		
		select *
		into STRICT   escala_w
		from   escala_sepse
		where  nr_sequencia = nr_seq_escala_p;
		
		ie_automatico_w := 'S';
		for itens_w in c01 loop
			ds_itens_w := ds_itens_w || itens_w.ds_item || ' ('||obter_desc_expressao(301251, 'Valor')||': '||itens_w.vl_item|| ') '||p_linha_w;
		end loop;
		
		ds_escala_w := ds_escala_w
				/*Data e hora da geracao automatica da escala com o status*/

			|| p_linha_w || '\b ' || obter_desc_expressao(316259,'Geracao automatica') || ' \b0 : ' || substr(obter_des_status_sepse(escala_w.ie_status_sepsis),1,255) || ' (' || date_to_char(escala_w.dt_atualizacao_nrec) || ')'			
				/*Descricao dos deflagradores estartados automaticamente*/

			|| p_linha_w || obter_desc_expressao(891585,'Deflagradores automaticos') || ': ' || p_linha_w || ds_itens_w || p_linha_w;
		
		
		select 	count(1)
		into STRICT	qt_rb_w
		from 	ESCALA_SEPSE_STATUS
		where 	nr_seq_escala = nr_seq_escala_p
		and		ie_status_sepsis = 'RB';
		
		if (qt_rb_w > 0) then
			status_w := obter_dados_status('RB'); --Suspeita de sepse aguardando acao da equipe
		else
			status_w := obter_dados_status('SM'); --Suspeita de infeccao sem disfuncao aguardando equipe
		end if;
		if (status_w.dt_atualizacao_nrec IS NOT NULL AND status_w.dt_atualizacao_nrec::text <> '') then
			ds_usuario_w := Obter_Valor_Dominio(72,OBTER_FUNCAO_USUARIO(status_w.nm_usuario_nrec));
			/*Data e hora da primeira avaliacao do enfermeiro ou profissional em tela - levar o nome do profissional, status da acao tomada (se foi descartada com a justificativa do descarte ou se foi confirmada gerando o novo statu para o medico)*/

			ds_escala_w := ds_escala_w || '\b ' || obter_desc_expressao(891591,'Primeira avaliacao equipe' )|| ' \b0 : '|| date_to_char(status_w.dt_atualizacao_nrec) || p_linha_w
				|| obter_desc_expressao(296509, 'Profissional') || ': ' || Obter_Nome_Usuario(status_w.nm_usuario_nrec) || ' (' || ds_usuario_w || ')' || p_linha_w;
				
			-- Verificar se possui outros status
			select count(1)
			into STRICT   qt_reg_w
			from   escala_sepse_status
			where  nr_seq_escala = nr_seq_escala_p
			and    ie_status_sepsis not in ('SE','RD','RB','SM');

			-- Se so possui o inicial, equipe e descarte, equipe descartou.
			if (qt_reg_w = 0) then
				status_w := obter_dados_status('RD');
				ds_escala_w := ds_escala_w || obter_desc_expressao(892739,'Acao descartada')
					|| p_linha_w || obter_desc_expressao(720315, 'Classificacao') ||': '|| substr(obter_des_status_sepse(escala_w.ie_status_sepsis),1,255)
					|| p_linha_w || obter_desc_expressao(882314,'Justificativa') || ': '|| status_w.ds_justif_status || p_linha_w || p_linha_w;
			else
				ds_escala_w := ds_escala_w || obter_desc_expressao(892741,'Acao confirmada') || p_linha_w || p_linha_w;
			end if;

		end if;
		
		ds_itens_w := '';
		ie_automatico_w := 'N';
		for itens_w in c01 loop
			ds_itens_w := ds_itens_w || itens_w.ds_item;
			if (itens_w.vl_item IS NOT NULL AND itens_w.vl_item::text <> '') then
				ds_itens_w := ds_itens_w || ' ('||obter_desc_expressao(301251, 'Valor')||': '||itens_w.vl_item||') ';
			end if;
			ds_itens_w := ds_itens_w||p_linha_w;
		end loop;
		
		if (qt_reg_w > 0) then
			ds_usuario_w := Obter_Valor_Dominio(72,OBTER_FUNCAO_USUARIO(escala_w.nm_usuario_status));
			ds_escala_w := ds_escala_w || '\b '|| obter_desc_expressao(601588,'Avaliacao medica') || '\b0 : '|| date_to_char(escala_w.dt_liberacao_status) || p_linha_w
				|| obter_desc_expressao(296509, 'Profissional') || ': ' || Obter_Nome_Usuario(escala_w.nm_usuario_status) || ' ('||ds_usuario_w||')' || p_linha_w
				|| obter_desc_expressao(891597, 'Deflagradores confirmados') ||': '|| p_linha_w || ds_itens_w || ' \b0 ' || p_linha_w;
			
			/*Status confirmado pelo medico pos avaliacao inicial*/

			status_w := obter_dados_status(null, escala_w.dt_liberacao_status);
			if (escala_w.ie_fim_vida = 'S') then
				ds_escala_w := ds_escala_w 	|| '\b '|| obter_desc_expressao(720315, 'Classificacao') || ' \b0 : ' || substr(obter_des_status_sepse(status_w.ie_status_sepsis),1,255) || ' - '
											||  obter_desc_expressao(925247,'Fim de vida') || p_linha_w;
			elsif (escala_w.ie_doencas_atipicas = 'S') then
				ds_escala_w := ds_escala_w 	|| '\b '|| obter_desc_expressao(720315, 'Classificacao') || ' \b0 : ' || substr(obter_des_status_sepse(status_w.ie_status_sepsis),1,255) || ' - '
											||  obter_desc_expressao(925249,'Doencas atipicas') || p_linha_w;	
			else
				ds_escala_w := ds_escala_w || '\b '|| obter_desc_expressao(720315, 'Classificacao') || ' \b0 : ' || substr(obter_des_status_sepse(status_w.ie_status_sepsis),1,255) || p_linha_w;
			end if;

			if (status_w.ie_status_sepsis in ('D','RD')) then
				ds_escala_w := ds_escala_w || obter_desc_expressao(882314,'Justificativa') || ': '|| status_w.ds_justif_status || p_linha_w;	
			end if;
		end if;


		/*Regras cadastradas no SDC*/

		status_w := obter_dados_status(null, escala_w.dt_liberacao_status);
		
		if ( status_w.ie_status_sepsis = 'RE') then 
			ds_escala_w := ds_escala_w || obter_dados_acao('SC', escala_w.dt_liberacao_status, escala_w.nr_atendimento) || p_linha_w;
		else
			ds_escala_w := ds_escala_w || obter_dados_acao(status_w.ie_status_sepsis, escala_w.dt_liberacao_status, escala_w.nr_atendimento) || p_linha_w;
		end if;
		
		/*Geracao RTF*/
	
		
		/*inicio substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/

		qt_controle_chr_w :=0;
			
		while(position(chr(13) in ds_escala_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_escala_w := replace(ds_escala_w, chr(13), '\par ');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		qt_controle_chr_w := 0;

		while(position(chr(10) in ds_escala_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_escala_w := replace(ds_escala_w, chr(10), '');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		
		/*fim substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/

		/*pega o cabecalho do rtf*/

		ds_cabecalho_w := '{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 Arial;}{\f1\fnil Arial;}}' ||
							'{\colortbl ;\red0\green0\blue0;}' ||
							'\viewkind4\uc1\pard\cf1\lang1046\fs20  \fs16 \f1 ';
		ds_pos_inicio_rtf_w := position('lang' in ds_cabecalho_w) + 8;
		ds_conteudo_w := substr(ds_cabecalho_w, 1, ds_pos_inicio_rtf_w) || 'fs20 ';
		
		/*acrescenta conteudo texto livre*/

		ds_conteudo_w := ds_conteudo_w || ds_escala_w;
		
		/*acrescenta resto do conteudo do rtf*/

		ds_rodape_w   := '}';
		ds_conteudo_w := ds_conteudo_w || '\par ' || substr(ds_cabecalho_w, ds_pos_inicio_rtf_w, length(ds_cabecalho_w));
		ds_conteudo_w  := ds_conteudo_w || ' ' || ds_rodape_w;
		
		insert into evolucao_paciente(
			cd_evolucao,
			dt_evolucao,
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			ds_evolucao,
			cd_medico,
			dt_liberacao,
			ie_evolucao_clinica,
			ie_situacao)
		values (nextval('evolucao_paciente_seq'),
			clock_timestamp(),
			OBTER_FUNCAO_USUARIO(nm_usuario_p),
			OBTER_PESSOA_ATENDIMENTO(escala_w.nr_atendimento,'C'),
			clock_timestamp(),
			nm_usuario_p,
			escala_w.nr_atendimento,
			ds_conteudo_w,
			Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C'),
			clock_timestamp(),
			'SEP',
			'A');
			
		commit;
		
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_sepse_ilas (nr_seq_escala_p bigint, nm_usuario_p text) is ds_escala_w varchar(32000) FROM PUBLIC;

