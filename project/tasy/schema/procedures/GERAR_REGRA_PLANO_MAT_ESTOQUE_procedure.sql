-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_regra_plano_mat_estoque (nr_seq_regra_mat_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		integer;
cd_material_regra_w	integer;

c01 CURSOR FOR
SELECT	a.cd_material
from	material a
where	a.ie_situacao		= 'A'
and	a.cd_material_estoque	= cd_material_regra_w
and	a.cd_material		<> cd_material_regra_w;


BEGIN

select	max(cd_material)
into STRICT	cd_material_regra_w
from	regra_convenio_plano_mat
where	nr_sequencia	= nr_seq_regra_mat_p;

if (cd_material_regra_w IS NOT NULL AND cd_material_regra_w::text <> '') then
	open c01;
	loop
	fetch c01 into
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		insert	into	regra_convenio_plano_mat(nr_sequencia,
			cd_convenio,
			cd_plano,
			ie_regra,
			dt_atualizacao,
			nm_usuario,
			ie_tipo_atendimento,
			cd_setor_atendimento,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			cd_material,
			ie_valor,
			vl_material_min,
			vl_material_max,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_tipo_acomodacao,
			ds_observacao,
			cd_classif_setor,
			ie_autor_particular,
			ie_carater_inter_sus,
			ie_clinica,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			ie_nova_autorizacao,
			ie_tipo_material,
			IE_GERAR_VL_ZERADO,
			ie_classificacao)
		SELECT	nextval('regra_convenio_plano_mat_seq'),
			cd_convenio,
			cd_plano,
			ie_regra,
			clock_timestamp(),
			nm_usuario_p,
			ie_tipo_atendimento,
			cd_setor_atendimento,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			cd_material_w,
			ie_valor,
			vl_material_min,
			vl_material_max,
			clock_timestamp(),
			nm_usuario_p,
			cd_tipo_acomodacao,
			ds_observacao,
			cd_classif_setor,
			ie_autor_particular,
			ie_carater_inter_sus,
			ie_clinica,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			ie_nova_autorizacao,
			ie_tipo_material,
			coalesce(IE_GERAR_VL_ZERADO,'N'),
			ie_classificacao
		from	regra_convenio_plano_mat
		where	nr_sequencia	= nr_seq_regra_mat_p;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_regra_plano_mat_estoque (nr_seq_regra_mat_p bigint, nm_usuario_p text) FROM PUBLIC;

