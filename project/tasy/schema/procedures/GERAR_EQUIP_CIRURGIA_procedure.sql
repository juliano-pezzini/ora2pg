-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equip_cirurgia ( ds_equip_p text, cd_profissional_p text, cd_estabelecimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w	  bigint;
ie_equip_ident_w  varchar(1);
cd_equipamento_w  varchar(20);
ie_situacao_w  		varchar(1);


BEGIN

ie_equip_ident_w := Obter_Param_Usuario(872, 320, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_equip_ident_w);

if (ie_equip_ident_w = 'X') then
	select max(cd_equipamento)
	into STRICT   cd_equipamento_w
	from   equipamento
	where  cd_imobilizado_ext = ds_equip_p;

elsif (ie_equip_ident_w = 'E') then
	if (LENGTH(ds_equip_p) > 10) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264459);
	end if;

	select max(cd_equipamento)
	into STRICT  cd_equipamento_w
	from   equipamento
	where cd_equipamento = campo_numerico(ds_equip_p);
end if;

if (coalesce(cd_equipamento_w::text, '') = '') then
	-- Código inválido!!!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264459);
else
	select MAX(ie_situacao)
	into STRICT  ie_situacao_w
	from   equipamento
	where cd_equipamento = cd_equipamento_w;

	if (ie_situacao_w = 'I') then
		--Este equipamento está inativo. Não pode ser incluído.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(689288);
	end if;
end if;


select	nextval('equipamento_cirurgia_seq')
into STRICT	nr_sequencia_w
;

nr_sequencia_p	:= nr_sequencia_w;

insert into equipamento_cirurgia(
       	nr_sequencia,
	nr_cirurgia,
	cd_equipamento,
	qt_equipamento,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_pepo,
	cd_profissional,
	ie_situacao)
values (
	nr_sequencia_w,
	nr_cirurgia_p,
	cd_equipamento_w,
	1,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_pepo_p,
	cd_profissional_p,
	'A');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equip_cirurgia ( ds_equip_p text, cd_profissional_p text, cd_estabelecimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

