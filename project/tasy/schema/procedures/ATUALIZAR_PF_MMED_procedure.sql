-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_pf_mmed (cd_pessoa_fisica_p text, /*  V10 */
 nm_pessoa_fisica_p text, /*  V60 */
 dt_nascimento_p timestamp, /*  Date */
 ie_sexo_p text, /*  V1 - 	F - Feminino
								M - Masculino
								I - Indeterminado */
 ie_estado_civil_p text, /*  V2 -	1 - Solteiro
								2 - Casado
								3 - Divorciado
								4 - Desquitado
								5 - Viúvo
								6 - Separado
								7 - Concubinado
								9 - Outros */
 nr_cpf_p text, /*  V11 */
 nr_identidade_p text, /*  V15 */
 nr_prontuario_p bigint, /*  N10 */
 qt_altura_cm_p bigint, /*  N4,1 */
 ds_fonetica_p text, /*  V60 */
 qt_peso_p bigint, /*  N6,3 */
 ds_observacao_p text, /*  V2000 */
 nm_pessoa_fisica_sem_acento_p text, /*  V60 */
 cd_municipio_ibge_p text, /*  V6 */
 ds_profissao_p text, /*  V255 */
 ds_endereco_p text, /*  V100 */
 cd_cep_p text, /*  V15 */
 ds_bairro_p text, /*  V40 */
 ds_municipio_p text, /*  V40 */
 sg_estado_p text, /*  V2 */
 nr_telefone_p text, /*  V15 */
 ds_email_p text, /*  V255 */
 cd_zona_procedencia_p text, /*  V3  - É uma FK de um cadastro do TASY. Na tabela PROCEDENCIA tem o campo CD_PROCEDENCIA_EXTERNO para conversão */
 nm_usuario_p text, /*  V15 */
 ds_retorno_p INOUT text /*  V255 */
) AS $body$
DECLARE

/*objeto chamada no integração da multimed, os novos parâmetros que forem adicionados devem ser definidos como default para não ocorrer problemas na integração*/

/* Havia conflito em 4 campos na correlação:
NM_PESSOA_PESQUISA          	NOMEFONETICO  - Desconsiderado
DS_FONETICA                 	NOMEFONETICO - Considerado
NR_IDENTIDADE          	RG DO PACIENTE - Desconsiderado
NR_CPF                 		CPF DO PACIENTE - Desconsiderado

*/
ie_erro_compl_pf_w	varchar(1)	:= 'N';
ie_erro_pf_w		varchar(1)	:= 'N';
qt_registro_w		bigint;
nr_sequencia_w		bigint;
cd_pessoa_fisica_w	varchar(10);
sql_errm_w		varchar(2000);
ds_retorno_w		varchar(255) := '';
qt_compl_w		bigint;
ie_transforma_nome_w	varchar(10) := 'N';
nm_pessoa_fisica_w	varchar(63);



BEGIN

CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');

if (nr_prontuario_p IS NOT NULL AND nr_prontuario_p::text <> '') then

	select	count(*)
	into STRICT	qt_registro_w
	from	pessoa_fisica
	where	nr_prontuario = nr_prontuario_p;

	if (qt_registro_w = 0) then

		ds_retorno_w := 'Não existe pessoa física cadastrada com o prontuário ' || nr_prontuario_p;

		ie_erro_pf_w	:= 'S';
	end if;
end if;

if (ie_erro_pf_w = 'N') then

	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	pessoa_fisica
	where	nr_prontuario = nr_prontuario_p;

	select	substr(coalesce(vl_parametro, vl_parametro_padrao),1,10) vl_parametro
	into STRICT	ie_transforma_nome_w
	from	funcao_parametro
	where	cd_funcao = 5
	and	nr_sequencia = 10;

	if (ie_transforma_nome_w = 'S')  then
		nm_pessoa_fisica_w := Obter_InitCap(nm_pessoa_fisica_p);
	elsif (ie_transforma_nome_w = 'T') then
		nm_pessoa_fisica_w := upper(nm_pessoa_fisica_p);
	else
		nm_pessoa_fisica_w := nm_pessoa_fisica_p;
	end if;

	begin

	update pessoa_fisica
	set	--cd_pessoa_fisica	= cd_pessoa_fisica_p,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		nm_pessoa_fisica	= nm_pessoa_fisica_w,
		dt_nascimento		= dt_nascimento_p,
		ie_sexo			= ie_sexo_p,
		ie_estado_civil		= ie_estado_civil_p,
		nr_cpf			= nr_cpf_p,
		nr_identidade		= nr_identidade_p,
		nr_prontuario		= nr_prontuario_p,
		qt_altura_cm		= qt_altura_cm_p,
		ds_fonetica		= ds_fonetica_p,
		qt_peso			= qt_peso_p,
		ds_observacao		= ds_observacao_p,
		nm_pessoa_fisica_sem_acento =	nm_pessoa_fisica_sem_acento_p,
		cd_municipio_ibge	= cd_municipio_ibge_p,
		ds_profissao		= ds_profissao_p
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	exception
		when others then
		sql_errm_w	:= sqlerrm;
		ds_retorno_w := 'Erro ao alterar o cadastro da pessoa física. '|| sql_errm_w;

		ie_erro_pf_w	:= 'S';
	end;

	if (ie_erro_pf_w = 'N') then

		select	count(*)
		into STRICT	qt_compl_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	ie_tipo_complemento	= 1;

		if (qt_compl_w = 0) then

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

			insert into compl_pessoa_fisica(nr_sequencia,
				cd_pessoa_fisica,
				ie_tipo_complemento,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nm_usuario,
				dt_atualizacao,
				ds_endereco,
				cd_cep,
				ds_bairro,
				ds_municipio,
				sg_estado,
				nr_telefone,
				ds_email,
				cd_zona_procedencia)
			values (nr_sequencia_w,
				cd_pessoa_fisica_w,
				1,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				ds_endereco_p,
				cd_cep_p,
				ds_bairro_p,
				ds_municipio_p,
				sg_estado_p,
				nr_telefone_p,
				ds_email_p,
				cd_zona_procedencia_p);

		else
			begin
			update compl_pessoa_fisica
			set	nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				ds_endereco		= ds_endereco_p,
				cd_cep			= cd_cep_p,
				ds_bairro		= ds_bairro_p,
				ds_municipio		= ds_municipio_p,
				sg_estado		= sg_estado_p,
				nr_telefone		= nr_telefone_p,
				ds_email		= ds_email_p,
				cd_zona_procedencia	= cd_zona_procedencia_p
			where	cd_pessoa_fisica	= cd_pessoa_fisica_w
			and	ie_tipo_complemento	= 1;
			exception
			when others then
				sql_errm_w	:= sqlerrm;
				ds_retorno_w := 'Erro ao alterar o cadastro do complento da pessoa física. '|| sql_errm_w;

				ie_erro_pf_w	:= 'S';
			end;
		end if;

	end if;

end if;
CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');

ds_retorno_p := ds_retorno_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_pf_mmed (cd_pessoa_fisica_p text,  nm_pessoa_fisica_p text,  dt_nascimento_p timestamp,  ie_sexo_p text,  ie_estado_civil_p text,  nr_cpf_p text,  nr_identidade_p text,  nr_prontuario_p bigint,  qt_altura_cm_p bigint,  ds_fonetica_p text,  qt_peso_p bigint,  ds_observacao_p text,  nm_pessoa_fisica_sem_acento_p text,  cd_municipio_ibge_p text,  ds_profissao_p text,  ds_endereco_p text,  cd_cep_p text,  ds_bairro_p text,  ds_municipio_p text,  sg_estado_p text,  nr_telefone_p text,  ds_email_p text,  cd_zona_procedencia_p text,  nm_usuario_p text,  ds_retorno_p INOUT text  ) FROM PUBLIC;

