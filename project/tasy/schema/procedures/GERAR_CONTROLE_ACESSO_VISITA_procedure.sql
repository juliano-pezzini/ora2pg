-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_controle_acesso_visita ( cd_pessoa_fisica_p text, ie_tipo_visita_p text, nr_atendimento_p bigint, nr_acompanhante_p bigint, nr_seq_visitante_p bigint, nr_identidade_p INOUT text, nm_visitante_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
			 
nr_identidade_w		varchar(15);
cd_barras_w		varchar(10);			
nm_visitante_w		varchar(60);
			

BEGIN 
 
select	max(nr_identidade), 
	max(substr(obter_nome_pf(cd_pessoa_fisica),1,60)) 
into STRICT	nr_identidade_w, 
	nm_visitante_w 
from	pessoa_fisica 
where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
 
if (ie_tipo_visita_p	= 'A') then 
	update	atendimento_acompanhante 
	set	nr_controle_acesso	= cd_barras_w 
	where	nr_atendimento		= nr_atendimento_p 
	and	nr_acompanhante		= nr_acompanhante_p;
else 
	update	atendimento_visita 
	set	nr_controle_Acesso	= cd_barras_w 
	where	nr_sequencia		= nr_seq_visitante_p;
end if;
 
nr_identidade_p	:= nr_identidade_w;
nm_visitante_p	:= nm_visitante_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_controle_acesso_visita ( cd_pessoa_fisica_p text, ie_tipo_visita_p text, nr_atendimento_p bigint, nr_acompanhante_p bigint, nr_seq_visitante_p bigint, nr_identidade_p INOUT text, nm_visitante_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

