-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_parecer_medico ( cd_evolucao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nm_usuario_w			varchar(15);
ie_evolucao_clinica_w		varchar(3);
cd_medico_w			varchar(10);
nm_usuarios_dest_w		varchar(4000);
ds_email_w			varchar(255);	
ds_parecer_w			varchar(2000);	
nr_atendimento_w		numeric(20);
cd_pessoa_fisica_w		numeric(20);

 
C01 CURSOR FOR 
	SELECT	substr(obter_compl_pf(cd_pessoa_fisica,1,'M'),1,150) 
	from	pessoa_destino_evolucao 
	where	cd_evolucao	= cd_evolucao_p 
	and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '') 
	
union
 
	SELECT	substr(obter_compl_pf(b.cd_pessoa_fisica,1,'M'),1,150) 
	from	pessoa_destino_evolucao b, 
		grupo_paracer_pessoa c 
	where	c.nr_seq_grupo	= b.nr_seq_grupo 
	and	cd_evolucao	= cd_evolucao_p;
																	

BEGIN 
 
select	max(nr_atendimento), 
	max(cd_pessoa_fisica), 
	max(cd_medico), 
	max(ie_evolucao_clinica), 
	max(substr(obter_compl_pf(CD_MEDICO_PARECER,1,'M'),1,150)) 
into STRICT	nr_atendimento_w, 
	cd_pessoa_fisica_w, 
	cd_medico_w, 
	ie_evolucao_clinica_w, 
	ds_email_w 
from	evolucao_paciente 
where	cd_evolucao = cd_evolucao_p;
 
 
if (ie_evolucao_clinica_w = 'P') then 
 
 
	 
	nm_usuarios_dest_w := ds_email_w;
	 
	open C01;
	loop 
	fetch C01 into	 
		ds_email_w;		
	EXIT WHEN NOT FOUND; /* apply on C01 */
		if (coalesce(nm_usuarios_dest_w::text, '') = '') then 
			nm_usuarios_dest_w	:= ds_email_w;
		else 
			nm_usuarios_dest_w	:=	nm_usuarios_dest_w || ';' || ds_email_w;
		end if;
	end loop;
	close C01;
	 
	ds_parecer_w := wheb_mensagem_pck.get_texto(307428, 'NR_ATENDIMENTO_W=' || nr_atendimento_w || ';' || 
														'NM_PESSOA_FISICA=' || substr(obter_nome_pf(cd_pessoa_fisica_w),1,60) || ';' || 
														'NM_MEDICO=' || obter_nome_medico(cd_medico_w,'N'));
				/* 
					Existe um pedido de parecer referente ao Atendimento: #@NR_ATENDIMENTO_W#@ 
					Paciente: #@NM_PESSOA_FISICA#@ 
					Médico: #@NM_MEDICO#@ 
					Favor verificar no PEP item Evoluções 
				*/
 
	if (nm_usuarios_dest_w IS NOT NULL AND nm_usuarios_dest_w::text <> '') then 
		CALL enviar_email(wheb_mensagem_pck.get_texto(307424),ds_parecer_w,null,nm_usuarios_dest_w,nm_usuario_p,'N'); -- Pedido de parecer 
	end if;
 
elsif (ie_evolucao_clinica_w = 'R') then 
	 
	if (coalesce(ds_email_w::text, '') = '') then 
 
		select	max(cd_medico) 
		into STRICT	cd_medico_w 
		from	evolucao_paciente 
		where	cd_evolucao = cd_evolucao_p;
	 
		select	max(substr(obter_compl_pf(CD_MEDICO,1,'M'),1,150)) 
		into STRICT	ds_email_w 
		from	evolucao_paciente 
		where	ie_evolucao_clinica = 'P' 
		and	cd_medico_parecer = cd_medico_w;
	end if;
 
 
 
	ds_parecer_w := wheb_mensagem_pck.get_texto(307443,	'NR_ATENDIMENTO_W=' || nr_atendimento_w || ';' || 
														'NM_PESSOA_FISICA=' || substr(obter_nome_pf(cd_pessoa_fisica_w),1,60) || ';' || 
														'NM_MEDICO=' || obter_nome_medico(cd_medico_w,'N'));
			/* 
				Existe uma resposta de parecer referente ao Atendimento: #@NR_ATENDIMENTO_W#@ 
				Paciente: #@NM_PESSOA_FISICA#@ 
				Médico: #@NM_MEDICO#@ 
				Favor verificar no PEP item Evoluções 
			*/
 
	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
	CALL enviar_email(wheb_mensagem_pck.get_texto(307425),ds_parecer_w,null,ds_email_w,nm_usuario_p,'N'); -- Resposta ao Pedido de Parecer 
	end if;
 
end if;
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_parecer_medico ( cd_evolucao_p bigint, nm_usuario_p text) FROM PUBLIC;

