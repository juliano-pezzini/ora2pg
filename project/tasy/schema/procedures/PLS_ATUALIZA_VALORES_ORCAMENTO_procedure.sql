-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_valores_orcamento ( nr_seq_orcamento_p bigint, ie_gravar_log_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_orcamento_proc_w		bigint;
nr_seq_orcamento_mat_w		bigint;
qt_proc_orcamento_w		bigint	:= 0;
qt_mat_orcamento_w		bigint	:= 0;
qt_valor_zerado_w		bigint	:= 0;

C01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_orcamento_proc 
	where	nr_seq_orcamento	= nr_seq_orcamento_p;
	
C02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_orcamento_mat 
	where	nr_seq_orcamento	= nr_seq_orcamento_p;
	

BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_orcamento_proc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	CALL pls_atualiza_valor_proc_orc(nr_seq_orcamento_proc_w, ie_gravar_log_p, nm_usuario_p);
	qt_proc_orcamento_w	:= qt_proc_orcamento_w + 1;
	end;
end loop;
close C01;
 
open C02;
loop 
fetch C02 into	 
	nr_seq_orcamento_mat_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	CALL pls_atualiza_valor_mat_orc(nr_seq_orcamento_mat_w, ie_gravar_log_p, nm_usuario_p);
	qt_mat_orcamento_w	:= qt_mat_orcamento_w + 1;
	end;
end loop;
close C02;
 
if (qt_proc_orcamento_w	> 0) then 
	select	count(1) 
	into STRICT	qt_valor_zerado_w 
	from	pls_orcamento_proc 
	where	nr_seq_orcamento	= nr_seq_orcamento_p 
	and	vl_procedimento		= 0;
	 
	if (qt_valor_zerado_w	> 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(174246);
	end if;
end if;
 
if (qt_mat_orcamento_w	> 0) then 
	select	count(1) 
	into STRICT	qt_valor_zerado_w 
	from	pls_orcamento_mat 
	where	nr_seq_orcamento	= nr_seq_orcamento_p 
	and	vl_material		= 0;
	 
	if (qt_valor_zerado_w	> 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(174246);
	end if;
end if;
 
if (qt_proc_orcamento_w	= 0) and (qt_mat_orcamento_w	= 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174255);
end if;
 
if (qt_valor_zerado_w	= 0) then 
	update	pls_orcamento 
	set	ie_situacao	= 'G' 
	where	nr_sequencia 	= nr_seq_orcamento_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_valores_orcamento ( nr_seq_orcamento_p bigint, ie_gravar_log_p text, nm_usuario_p text) FROM PUBLIC;

