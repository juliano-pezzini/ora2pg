-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gm_duplicar_sub_amostras_desig (nr_seq_designacao_p bigint, nr_seq_peca_p bigint, ie_tipo_designacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_amostra_princ_w		integer;
qt_macroscopia_w 		integer;
nr_seq_apresent_w		bigint;
ds_designacao_w			varchar(255);
nr_fragmentos_w			integer;

qt_macroscopia_aux_w		bigint := 1; --inicar 0
nr_seq_designacao_w		bigint;


BEGIN

select 	a.nr_seq_amostra_princ,
	a.qt_macroscopia,
	a.nr_seq_apresent,
	a.ds_designacao,
	a.nr_fragmentos,
	a.nr_sequencia
into STRICT	nr_seq_amostra_princ_w,
	qt_macroscopia_w,
	nr_seq_apresent_w,
	ds_designacao_w,
	nr_fragmentos_w,
	nr_seq_designacao_w
from	prescr_proc_macro_desig a
where	a.nr_sequencia = nr_seq_designacao_p;


qt_macroscopia_aux_w := nr_seq_apresent_w;
for i in 1..qt_macroscopia_w
	loop
	
	insert 	into PRESCR_PROC_PECA(nr_sequencia,
		 nr_prescricao,
		 nr_seq_prescr,
		 nr_seq_amostra_princ,
		 nm_usuario,
		 nr_seq_peca,
		 nr_seq_apresent,
		 ds_designacao,
		 dt_atualizacao,
		 cd_topografia,
		 nr_fragmentos,
		 ds_amostra_principal,
		 nr_seq_tipo,
		 ds_observacao,
		 ie_tipo_designacao,
		 nr_seq_designacao,
		 ie_situacao)
		(
		SELECT	nextval('prescr_proc_peca_seq'),
			nr_prescricao,
			nr_seq_prescr,
			nr_seq_amostra_princ_w,
			nm_usuario_p,
			nr_seq_peca_p,
			qt_macroscopia_aux_w,
			ds_designacao_w,
			clock_timestamp(),
			cd_topografia,
			nr_fragmentos_w,
			ds_amostra_principal,
			nr_seq_tipo,
			ds_observacao,
			ie_tipo_designacao_p,
			nr_seq_designacao_w,
			coalesce(ie_situacao,'A')
		from	prescr_proc_peca		
		where	nr_sequencia = nr_seq_peca_p
		);

	commit;
	
	qt_macroscopia_aux_w := qt_macroscopia_aux_w + 1;
	
	end loop;
			

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gm_duplicar_sub_amostras_desig (nr_seq_designacao_p bigint, nr_seq_peca_p bigint, ie_tipo_designacao_p text, nm_usuario_p text) FROM PUBLIC;

