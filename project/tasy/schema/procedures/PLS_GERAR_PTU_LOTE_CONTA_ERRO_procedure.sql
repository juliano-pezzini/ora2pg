-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ptu_lote_conta_erro ( cd_dominio_p valor_dominio.cd_dominio%type, ie_status_sispac_p valor_dominio.vl_dominio%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, nr_seq_inconsistencia_p w_pls_inconsistencia_int.nr_seq_inconsistencia%type default null, ie_tipo_arquivo_p w_pls_inconsistencia_int.ie_tipo_arquivo%type default null, ds_complemento_p w_pls_inconsistencia_int.ds_complemento%type default null) AS $body$
DECLARE


ds_valor_dominio_w	valor_dominio.ds_valor_dominio%type;
nr_seq_conta_w		ptu_lote_conta_erro.nr_seq_conta%type;

ds_texto_w		ptu_lote_conta_erro.ds_motivo_erro%type;
nr_sequencia_w		ptu_lote_conta_erro.nr_sequencia%type;



BEGIN

if (cd_dominio_p IS NOT NULL AND cd_dominio_p::text <> '') then
	select	substr(a.ds_valor_dominio,1,90) descricao
	into STRICT	ds_valor_dominio_w
	from	valor_dominio	a
	where	a.cd_dominio = cd_dominio_p
	and	a.vl_dominio = ie_status_sispac_p;

end if;

select	max(a.nr_seq_conta)
into STRICT	nr_seq_conta_w
from	ptu_lote_conta_erro	a
where	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_p
and	a.nr_seq_conta		= nr_seq_conta_p
and	a.nr_seq_lote		= nr_seq_lote_fat_p;

if (coalesce(nr_seq_conta_w::text, '') = '') then

	if (ie_status_sispac_p in (1,2,3,4,5,6,12,13,14,16,10,15)) then

		insert into ptu_lote_conta_erro(	nr_sequencia,				dt_atualizacao,		dt_atualizacao_nrec,
							nm_usuario,				nm_usuario_nrec,	cd_estabelecimento,
							nr_seq_pls_fatura,			nr_seq_conta,		nr_seq_lote,
							ds_motivo_erro)
					values (	nextval('ptu_lote_conta_erro_seq'),	clock_timestamp(),		clock_timestamp(),
							nm_usuario_p,				nm_usuario_p,		cd_estabelecimento_p,
							nr_seq_pls_fatura_p,			nr_seq_conta_p,		nr_seq_lote_fat_p,
							replace(expressao_pck.obter_desc_expressao(974123),'@DS_SIT_PACOTE',ds_valor_dominio_w));
	end if;

	if (ie_status_sispac_p = 11) then
		insert into ptu_lote_conta_erro(	nr_sequencia,				dt_atualizacao,		dt_atualizacao_nrec,
							nm_usuario,				nm_usuario_nrec,	cd_estabelecimento,
							nr_seq_pls_fatura,			nr_seq_conta,		nr_seq_lote,
							ds_motivo_erro)
					values (	nextval('ptu_lote_conta_erro_seq'),	clock_timestamp(),		clock_timestamp(),
							nm_usuario_p,				nm_usuario_p,		cd_estabelecimento_p,
							nr_seq_pls_fatura_p,			nr_seq_conta_p,		nr_seq_lote_fat_p,
							replace(expressao_pck.obter_desc_expressao(974129),'@DS_SIT_PACOTE',ds_valor_dominio_w));

	end if;
	
	if (nr_seq_inconsistencia_p IS NOT NULL AND nr_seq_inconsistencia_p::text <> '') then
	
		nr_sequencia_w	:= null;
		
		select	max(a.nr_sequencia)
		into STRICT	nr_sequencia_w
		from	ptu_lote_conta_erro	a
		where	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_p
		and	coalesce(a.nr_seq_conta::text, '') = ''
		and	coalesce(nr_seq_conta_p::text, '') = ''
		and	a.ie_tipo_critica	= ie_tipo_arquivo_p;
		
		select	max(a.ds_inconsistencia)
		into STRICT	ds_texto_w
		from	pls_inconsistencia_int	a
		where	a.nr_sequencia	= nr_seq_inconsistencia_p;
	
		ds_texto_w	:= ds_texto_w || ds_complemento_p;
		
		if (coalesce(nr_sequencia_w::text, '') = '' ) then
			insert into ptu_lote_conta_erro(	nr_sequencia,				dt_atualizacao,		dt_atualizacao_nrec,
								nm_usuario,				nm_usuario_nrec,	cd_estabelecimento,
								nr_seq_pls_fatura,			nr_seq_conta,		nr_seq_lote,
								ds_motivo_erro,				ie_tipo_critica)
						values (	nextval('ptu_lote_conta_erro_seq'),	clock_timestamp(),		clock_timestamp(),
								nm_usuario_p,				nm_usuario_p,		cd_estabelecimento_p,
								nr_seq_pls_fatura_p,			nr_seq_conta_p,		nr_seq_lote_fat_p,
								ds_texto_w,				ie_tipo_arquivo_p);
	
	
		end if;
		
	end if;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ptu_lote_conta_erro ( cd_dominio_p valor_dominio.cd_dominio%type, ie_status_sispac_p valor_dominio.vl_dominio%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, nr_seq_inconsistencia_p w_pls_inconsistencia_int.nr_seq_inconsistencia%type default null, ie_tipo_arquivo_p w_pls_inconsistencia_int.ie_tipo_arquivo%type default null, ds_complemento_p w_pls_inconsistencia_int.ds_complemento%type default null) FROM PUBLIC;

