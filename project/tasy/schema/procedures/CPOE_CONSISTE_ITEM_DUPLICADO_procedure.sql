-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_consiste_item_duplicado ( nr_seq_mat_cpoe_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p bigint, ds_item_p text, nm_usuario_p text, ds_erro_p INOUT text, ie_campo_mat_p text default null, nr_seq_cpoe_anterior_p bigint default null, nr_seq_ataque_p bigint default null, cd_pessoa_fisica_p text default null) AS $body$
DECLARE

							 
/*-------------------------------------------------------------------- 
Prestar atenção nas seguintes orientações: 
 
	- Passar os tipos da dieta como tipo do item 
	- Dieta enteral trocar o E para M, pois ela vai ser consistida como um medicamento/material 
	- Os campos de nr_seq_proc_interno(procedimento), nr_seq_tipo(jejum), cd_dieta(dieta), cd_recomendacao(recomendacao) e nr_seq_gas(gasoterapia) 
	  devem ser passados no campo cd_item_p; 
*/
 
 
ie_duplicado_w		char(1);
cd_mat_generico_w	material.cd_material%type;
					 	

BEGIN 
if (ie_tipo_item_p = 'M') then 
 
	cd_mat_generico_w	:= obter_mat_generico(cd_item_p);
	 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_material_vig_v 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		cd_material in (cd_item_p, cd_mat_generico_w)  
	and		ie_tipo_item in ('MCOMP1', 'MCOMP2', 'MCOMP3', 'MAT', 'MSOL1', 'MSOL2', 'MSOL3', 'MSOL4', 'MSOL5') 
	AND		((nr_sequencia = nr_seq_mat_cpoe_p AND ie_tipo_item <> ie_campo_mat_p) or (nr_sequencia <> nr_seq_mat_cpoe_p))  
  AND (((nr_seq_cpoe_anterior_p IS NOT NULL AND nr_seq_cpoe_anterior_p::text <> '') and nr_seq_cpoe_anterior_p <> nr_sequencia) or 
    ((coalesce(nr_seq_cpoe_anterior_p::text, '') = '') and (coalesce(nr_seq_cpoe_anterior,0) <> nr_seq_mat_cpoe_p))) 
	AND (((nr_seq_ataque_p IS NOT NULL AND nr_seq_ataque_p::text <> '') and nr_seq_ataque_p <> nr_sequencia) or 
    ((coalesce(nr_seq_ataque_p::text, '') = '') and (coalesce(nr_seq_ataque,0) <> nr_seq_mat_cpoe_p)))		 
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao >= clock_timestamp())) LIMIT 1;	
  
	if (ie_duplicado_w = 'N') then 
		select	coalesce(max('S'),'N') 
		into STRICT	ie_duplicado_w 
		from	cpoe_material_vig_v 
		where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
		and		obter_mat_generico(cd_material) in (cd_item_p, cd_mat_generico_w)  
		and		ie_tipo_item in ('MCOMP1', 'MCOMP2', 'MCOMP3', 'MAT', 'MSOL1', 'MSOL2', 'MSOL3', 'MSOL4', 'MSOL5') 
		AND		((nr_sequencia = nr_seq_mat_cpoe_p AND ie_tipo_item <> ie_campo_mat_p) or (nr_sequencia <> nr_seq_mat_cpoe_p)) 
  AND (((nr_seq_cpoe_anterior_p IS NOT NULL AND nr_seq_cpoe_anterior_p::text <> '') and nr_seq_cpoe_anterior_p <> nr_sequencia) or 
     ((coalesce(nr_seq_cpoe_anterior_p::text, '') = '') and (coalesce(nr_seq_cpoe_anterior,0) <> nr_seq_mat_cpoe_p))) 
	AND (((nr_seq_ataque_p IS NOT NULL AND nr_seq_ataque_p::text <> '') and nr_seq_ataque_p <> nr_sequencia) or 
    ((coalesce(nr_seq_ataque_p::text, '') = '') and (coalesce(nr_seq_ataque,0) <> nr_seq_mat_cpoe_p)))		 
		and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
		and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
		and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	end if;
	 
  
	if (ie_duplicado_w = 'S') then 
		---- O medicamento/material #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312799,'DS_ITEM_W='||ds_item_p);
	end if;
	 
elsif (ie_tipo_item_p = 'P') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_procedimento 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		nr_seq_proc_interno = cd_item_p  
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	if (ie_duplicado_w = 'S') then 
		---- O procedimento #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312808,'DS_ITEM_W='||ds_item_p);
	end if;
 
elsif (ie_tipo_item_p = 'R') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_recomendacao 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		cd_recomendacao = cd_item_p  
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	if (ie_duplicado_w = 'S') then 
		---- A recomendação #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312809,'DS_ITEM_W='||ds_item_p);
	end if;
 
elsif (ie_tipo_item_p = 'G') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_gasoterapia 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		nr_seq_gas = cd_item_p  
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	if (ie_duplicado_w = 'S') then 
		---- A gasoterapia #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312812,'DS_ITEM_W='||ds_item_p);
	end if;
	 
elsif (ie_tipo_item_p = 'O') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_dieta 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		cd_dieta = cd_item_p  
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	if (ie_duplicado_w = 'S') then 
		---- A dieta #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312816,'DS_ITEM_W='||ds_item_p);
	end if;
	 
elsif (ie_tipo_item_p = 'J') then 
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_duplicado_w 
	from	cpoe_dieta 
	where	((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p and coalesce(nr_atendimento::text, '') = '')) 
	and		nr_seq_tipo = cd_item_p  
	and		((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p)) 
	and		((coalesce(dt_lib_suspensao::text, '') = '') or (dt_suspensao	>= clock_timestamp())) 
	and		((coalesce(dt_fim::text, '') = '') or (dt_fim >= clock_timestamp())) LIMIT 1;
	if (ie_duplicado_w = 'S') then 
		---- O jejum #@DS_ITEM_W#@ esta em duplicidade no atendimento! 
		ds_erro_p := wheb_mensagem_pck.get_texto(312817,'DS_ITEM_W='||ds_item_p);
	end if;
			 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_consiste_item_duplicado ( nr_seq_mat_cpoe_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p bigint, ds_item_p text, nm_usuario_p text, ds_erro_p INOUT text, ie_campo_mat_p text default null, nr_seq_cpoe_anterior_p bigint default null, nr_seq_ataque_p bigint default null, cd_pessoa_fisica_p text default null) FROM PUBLIC;

