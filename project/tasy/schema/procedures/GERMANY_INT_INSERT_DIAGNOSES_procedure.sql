-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_int_insert_diagnoses ( nr_atendimento_p text, cd_doenca_cid_p text, dt_diagnostico_p text, nm_usuario_p text, nm_diagnoeses_p text, ds_name_coding_p text, cd_medico_p text) AS $body$
DECLARE


dt_diagnostico_w		timestamp;
nr_posicao_sep_w		bigint;
cd_doenca_cid_w		diagnostico_doenca.cd_doenca%type;
ie_status_diag_w		diagnostico_doenca.ie_status_diag%type;
ie_status_diag_ww		diagnostico_doenca.ie_status_diag%type;
ie_tipo_episodio_w		tipo_episodio.ie_tipo%type;
ie_tipo_diagnostico_w	diagnostico_doenca.ie_tipo_diagnostico%type;


BEGIN
    begin

    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_doenca_cid_p IS NOT NULL AND cd_doenca_cid_p::text <> '')  then
	
        	dt_diagnostico_w		:= to_date(dt_diagnostico_p, 'yyyymmddhh24miss');
	nr_posicao_sep_w		:= position(' ' in cd_doenca_cid_p);
	cd_doenca_cid_w		:= trim(both substr(cd_doenca_cid_p, 1, nr_posicao_sep_w));
	
	select 	obter_tipo_episodio(obter_episodio_atendimento(nr_atendimento_p))
	into STRICT	ie_tipo_episodio_w
	;
	
	if (ie_tipo_episodio_w = '8') then
		ie_status_diag_w	:= trim(both substr(cd_doenca_cid_p, nr_posicao_sep_w, LENGTH(cd_doenca_cid_p)));
		
		if (ie_status_diag_w = 'A') then
			ie_status_diag_ww := 'AU';
		elsif (ie_status_diag_w = 'G') then
			ie_status_diag_ww := 'GE';
			ie_tipo_diagnostico_w := 2;
		elsif (ie_status_diag_w = 'V') then
			ie_status_diag_ww := 'VE';
			ie_tipo_diagnostico_w := 1;
		elsif (ie_status_diag_w = 'Z') then
			ie_status_diag_ww := 'ZU';
		end if;
	end if;

        insert into diagnostico_medico(	CD_MEDICO,
                    	IE_TIPO_DIAGNOSTICO,
                    	DT_DIAGNOSTICO,
                    	NR_ATENDIMENTO,
                    	NM_USUARIO,
                    	DT_ATUALIZACAO)
        values (	
		cd_medico_p,
                    	2,
                    	dt_diagnostico_w,
                    	nr_atendimento_p,
                    	nm_usuario_p,
                   	clock_timestamp());

        insert into diagnostico_doenca(	nr_atendimento,         
                    	dt_diagnostico,         
                    	cd_doenca,              
                    	dt_atualizacao,
                    	nm_usuario,        
                    	dt_liberacao,
		ie_status_diag,
		ie_tipo_diagnostico)        
        values (	nr_atendimento_p,
                    	dt_diagnostico_w,
                    	cd_doenca_cid_w,
                    	clock_timestamp(),
                    	nm_usuario_p,
                    	clock_timestamp(),
		ie_status_diag_ww,
		ie_tipo_diagnostico_w);
    end if;

    exception
    when others then
        CALL gravar_log_cdi(7000,dbms_utility.format_error_backtrace,'GERMANY');
    end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_int_insert_diagnoses ( nr_atendimento_p text, cd_doenca_cid_p text, dt_diagnostico_p text, nm_usuario_p text, nm_diagnoeses_p text, ds_name_coding_p text, cd_medico_p text) FROM PUBLIC;

