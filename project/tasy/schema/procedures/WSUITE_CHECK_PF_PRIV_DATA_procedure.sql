-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_check_pf_priv_data ( cd_pessoa_fisica_p pessoa_fisica_privacidade.cd_pessoa_fisica%type, nm_usuario_p pessoa_fisica_privacidade.nm_usuario%type, nr_seq_pf_privacidade_p INOUT pessoa_fisica_privacidade.nr_sequencia%type) AS $body$
DECLARE


nr_seq_pf_privacidade_old_w	pessoa_fisica_privacidade.nr_sequencia%type;
dt_liberacao_last_record_w			pessoa_fisica_privacidade.dt_liberacao%type;

C01 CURSOR FOR
	SELECT	a.ie_tipo_consentimento,
		a.ie_tipo_documento,
		a.ie_tipo_complemento_pf,
		a.nr_seq_compl_pf,
		a.ie_aceite
	from	pessoa_fisica_privac_item a
	where	a.nr_seq_pf_privacidade = nr_seq_pf_privacidade_old_w;

C01row C01%rowtype;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_pf_privacidade_p
from	pessoa_fisica_privacidade a
where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
and	coalesce(a.ie_situacao,'A') = 'A'
and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or a.nm_usuario = nm_usuario_p)
and	coalesce(a.dt_inativacao::text, '') = '';

if (nr_seq_pf_privacidade_p IS NOT NULL AND nr_seq_pf_privacidade_p::text <> '') then
	select	max(a.dt_liberacao)
	into STRICT	dt_liberacao_last_record_w
	from	pessoa_fisica_privacidade a
	where	a.nr_sequencia = nr_seq_pf_privacidade_p;
end if;	

if	((coalesce(nr_seq_pf_privacidade_p::text, '') = '') or (coalesce(dt_liberacao_last_record_w::text, '') = '')) then

	if (coalesce(nr_seq_pf_privacidade_p::text, '') = '')  then
		insert into pessoa_fisica_privacidade(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_pessoa_fisica,
			ie_situacao,
			dt_criacao)
		values (
			nextval('pessoa_fisica_privacidade_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_pessoa_fisica_p,
			'A',
			clock_timestamp())
		returning nr_sequencia
		into nr_seq_pf_privacidade_p;
	else
		select	max(nr_sequencia)
		into STRICT	nr_seq_pf_privacidade_old_w
		from	pessoa_fisica_privacidade a
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and	coalesce(a.ie_situacao,'A') = 'A'
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	coalesce(a.dt_inativacao::text, '') = '';
	end if;

	if (nr_seq_pf_privacidade_old_w IS NOT NULL AND nr_seq_pf_privacidade_old_w::text <> '') then
		open C01;
		loop
		fetch C01 into	
			C01row;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (C01row.ie_aceite IS NOT NULL AND C01row.ie_aceite::text <> '') then
				update	pessoa_fisica_privac_item a
				set	a.ie_aceite = C01row.ie_aceite
				where	a.nr_seq_pf_privacidade = nr_seq_pf_privacidade_p
				and	a.ie_tipo_consentimento = C01row.ie_tipo_consentimento
				and	coalesce(a.ie_tipo_documento,'#!@$') = coalesce(C01row.ie_tipo_documento,'#!@$')
				and	coalesce(a.ie_tipo_complemento_pf,-1) = coalesce(C01row.ie_tipo_complemento_pf,-1)
				and	coalesce(a.nr_seq_compl_pf,-1) = coalesce(C01row.nr_seq_compl_pf,-1);
			end if;
				
			end;
		end loop;
		close C01;
	end if;
	
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_check_pf_priv_data ( cd_pessoa_fisica_p pessoa_fisica_privacidade.cd_pessoa_fisica%type, nm_usuario_p pessoa_fisica_privacidade.nm_usuario%type, nr_seq_pf_privacidade_p INOUT pessoa_fisica_privacidade.nr_sequencia%type) FROM PUBLIC;

