-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_status_etapa_sol_pmh ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, nm_usuario_p text) AS $body$
DECLARE

	
nr_seq_material_ww	bigint;	
dt_horario_w		timestamp;

C01 CURSOR FOR
	SELECT	nr_seq_material,
			dt_horario
	from	prescr_mat_hor
	where	nr_prescricao	= nr_prescricao_p
	and		nr_seq_solucao	= nr_seq_solucao_p
	and		nr_etapa_sol	= nr_etapa_p;	


BEGIN
CALL Gerar_log_prescricao(nr_prescricao_p, null, null, null, null, ' ATUALIZAR_STATUS_ETAPA_SOL_PMH nr_seq_solucao_p: ' || nr_seq_solucao_p
				|| ' nr_etapa_p: ' || nr_etapa_p, nm_usuario_p, null, wheb_usuario_pck.get_ie_commit);

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (nr_etapa_p IS NOT NULL AND nr_etapa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then	
begin
	begin
		open C01;
		loop
		fetch C01 into	
			nr_seq_material_ww,
			dt_horario_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
				
				update	prescr_mat_hor
				set		dt_suspensao	= clock_timestamp(),
						nm_usuario_susp	= nm_usuario_p
				where	nr_prescricao	= nr_prescricao_p
				and		nr_seq_solucao	= nr_seq_solucao_p
				and		((nr_etapa_sol	= nr_etapa_p AND nr_seq_material = nr_seq_material_ww)
						or ((coalesce(nr_etapa_sol::text, '') = '') and (nr_seq_superior = nr_seq_material_ww)))
				and		dt_horario	= dt_horario_w
				and		coalesce(dt_fim_horario::text, '') = ''
                and     coalesce(ie_horario_especial, 'N') <> 'S';
				
			end;
		end loop;
		close C01;
	exception
	when others then
		CALL gerar_log_prescricao(nr_prescricao_p, nr_seq_material_ww, null, null, null, substr(sqlerrm,1,2000), nm_usuario_p, 12994, 'S');
	end;
	commit;
end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_status_etapa_sol_pmh ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, nm_usuario_p text) FROM PUBLIC;

