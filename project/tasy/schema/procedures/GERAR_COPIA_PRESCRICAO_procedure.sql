-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_copia_prescricao ( nr_prescricao_p text, ie_medico_p text, ie_nome_exame_p text, ie_tit_medic_rotina_p text, /* Parametro 9 - funcao "Copia de Prescricao" */
 cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, dt_protocolo_p timestamp, ie_chamada_protocolo_p text default 'N') AS $body$
DECLARE


/*	
	INDICE DOS GRUPOS
	Nutricao 
	100 - Dieta Oral
	101 - Suplemento e modulos nutricionais e formulas pediatricas
	102 - Suporte Nutricional Enteral
	103 - NPT 
	119 - Leites e derivados
	Solucao15
	104 - Padrao
	Medicamentos
	105 - Medicamento
	Materiais
	106 - Materiais
	Procedimentos
	107 - Exames / Procedimentos / Servicos
	Recomendacoes
	108 - Recomendacoes
	Banco de Sangue
	109 - Banco de Sangue
	Oxigenioterapia
	110 - Oxigenioterapia
	Hemodialise
	111 - Prescricao
	112 - Medicamentos
	113 - Solucoes
	Exames de anatomia patologica
	114 - Exames anatomia
	115 - Citopatologico colo utero e Histopatologico colo utero
	117 - gasoterapia
*/
ds_enter_w					varchar(10) := chr(13) || chr(10);
nr_sequencia_w				bigint;
nr_seq_apres_w				integer;
nr_prescricao_w				bigint;
ds_titulo_w					varchar(200);
ds_informacao_w				varchar(4000);
qt_registros_w				bigint;
ie_duplicado_w				varchar(1);
cd_dieta_w					bigint;
cd_material_w				integer;
cd_procedimento_w			bigint;
cd_recomendacao_w			bigint;
ie_origem_proced_w			bigint;
ie_substituido_w			varchar(1);
ds_cor_w					varchar(255);
nr_agrupamento_w			double precision;
qt_dose_w					double precision;
cd_unidade_medida_dose_w	varchar(30);
ds_material_w				varchar(255);
ds_exame_w					varchar(255);
nr_prescricao_original_w	bigint;
ie_prescr_farm_w			varchar(5);
ie_proced_sangue_copia_w	varchar(1);
cd_protocolo_w				bigint;
nr_seq_mat_protocolo_w		integer;
nr_seq_protocolo_w			integer;
ie_alterar_dose_w			varchar(1);
ds_rotina_w					varchar(255);
ds_mensagem_w				varchar(255);
ie_marcado_w				varchar(1);
ds_cor_ww					varchar(255);
ds_mensagem_ww				varchar(255);
ie_marcado_ww				varchar(1);
ds_procedimento_w			varchar(255);
qt_procedimento_w			double precision;
ie_via_aplicacao_w			varchar(30);
ds_vol_hemocomp_w			varchar(100);
ie_desc_hemocomp_w			varchar(1);
ie_descricao_reduzida_w		varchar(1);
cd_intervalo_w              varchar(7);
ie_princ_grupo_rotina_w	    varchar(1);
nr_seq_grupo_w				bigint;	
nr_seq_exame_w				prescr_procedimento.nr_seq_exame%type;
nr_seq_proc_interno_w		prescr_procedimento.nr_seq_proc_interno%type;
ie_copia_kit_rec_w			varchar(1);
ie_apresenta_procedimento_w	varchar(1);
ie_item_proc_protocolo_W	varchar(1);
ie_questiona_lado_w			varchar(1);
cd_protocolo_proc_w			bigint;
nr_seq_protocolo_proc_w		integer;
nr_seq_proc_protocolo_w		bigint;
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
nr_seq_item_prot_w			prescr_solic_bco_sangue.nr_seq_item_prot%type;

/* Nutricao - Dieta Oral */

c01 CURSOR FOR
	SELECT	nr_sequencia,
			cd_dieta,
			substr(obter_nome_dieta(cd_dieta),1,200),
			substr(Wheb_mensagem_pck.get_texto(308539) || ' ' /*'Descricao: '*/ || substr(obter_desc_dieta(cd_dieta),1,300) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308541) || ': ' /*'Horarios: '*/ || substr(obter_horarios_dieta(nr_prescricao,cd_dieta),1,240) || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308542) || ': ' /*'Observacao: '*/ || substr(ds_observacao,1,3000), 1, 4000),
			nr_prescricao,
			nr_prescricao_original
	from    prescr_dieta
	where	nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao		>= coalesce(dt_protocolo_p,dt_atualizacao)
	order by 
		nr_sequencia;

/* Nutricao - Suplemento e modulos nutricionais e formulas pediatricas */

c03 CURSOR FOR
	SELECT	nr_sequencia,
			cd_material,
			substr(obter_desc_material(cd_material),1,200),
			Wheb_mensagem_pck.get_texto(308545) || ' ' /*'Codigo: '*/ || cd_material || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308547) || ' ' /*'Dose: '*/ || qt_dose|| ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308549) || ': ' /*'Unid Med: '*/ || cd_unidade_medida_dose,
			nr_prescricao,
			nr_prescricao_original
	from	prescr_material
	where	ie_agrupador		= 12
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec)
	order by 
		nr_sequencia;

/* Nutricao - Suporte Nutricional Enteral */

c04 CURSOR FOR
	SELECT	nr_sequencia,
			cd_material,
			substr(obter_desc_material(cd_material),1,200),
			Wheb_mensagem_pck.get_texto(308545) || ' ' /*'Codigo: '*/ || cd_material || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308547) || ' ' /*'Dose: '*/ || qt_dose || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308549) || ': ' /*'Unid Med: '*/ || cd_unidade_medida_dose,
			nr_prescricao,
			nr_prescricao_original
	from	prescr_material
	where	ie_agrupador		= 8
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec)
	order by 
		nr_sequencia;

/* Nutricao - NPT Adulta */

c05 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308550) /*'Adulta'*/
,
			'',
			nr_prescricao,
			nr_prescricao_original
	from	nut_paciente
	where	nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao	>= coalesce(dt_protocolo_p,dt_atualizacao);

/* Nutricao - NPT NeoNatal */

c06 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308551) /*'NPT Neonatal'*/
,
			'',
			nr_prescricao,
			nr_prescricao_original
	from	nut_pac
	where	ie_npt_adulta		= 'N'
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Nutricao - NPT Adulta */

c07 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308552) /*'NPT Adulta'*/
,
			'',
			nr_prescricao,
			nr_prescricao_original
	from	nut_pac
	where	ie_npt_adulta		= 'S'
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
/* Nutricao - NPT Adulta */

c071 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308553) /*'NPT Pediatrica'*/
,
			'',
			nr_prescricao,
			nr_prescricao_original
	from	nut_pac
	where	ie_npt_adulta		= 'P'
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Solucao - Padrao */

c08 CURSOR FOR
	SELECT	nr_seq_solucao,
			nr_agrupamento,
			CASE WHEN coalesce(ds_solucao::text, '') = '' THEN ''  ELSE ds_solucao ||' - ' END  ||
			substr(nr_agrupamento  || Wheb_mensagem_pck.get_texto(308556) || ' ' /*'solucao '*/ || lower(Obter_Desc_via(ie_via_aplicacao)),1,200),
			Wheb_mensagem_pck.get_texto(308555) || ': ' /*'Solucao: '*/ || nr_agrupamento || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308557) || ': ' /*'Etapas: '*/ || nr_etapas || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308558) || ' ' /*'Tempo etapa(h): '*/ || qt_hora_fase || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308559) || ' ' /*'Tempo total(h): '*/ || qt_tempo_aplicacao || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308560) || ': ' /*'Primeiro horario: '*/ || hr_prim_horario || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308561) || ': ' /*'Volume total (ml): '*/ || qt_solucao_total || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308562) || ': ' /*'Velocidade infusao: '*/ || qt_dosagem || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308563) || ': ' /*'Objetivo: '*/ || ds_solucao,
			nr_prescricao,
			nr_prescricao_original
	from	prescr_solucao
	where	coalesce(ie_hemodialise,'N')	= 'N'
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao	>= coalesce(dt_protocolo_p,dt_atualizacao);

/* Medicamentos - Medicamento */

c09 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_material,
			substr(CASE WHEN ie_descricao_reduzida_w='S' THEN obter_desc_material_reduzido(cd_material)  ELSE obter_desc_material(cd_material) END  || ', ' || obter_um_dosagem_prescr(NR_PRESCRICAO,NR_SEQUENCIA) || ' ' || Wheb_mensagem_pck.get_texto(308564) || ' ' /*' Dia/Lib: '*/ || nr_dia_util || '/'|| qt_total_dias_lib,1,200),
			Wheb_mensagem_pck.get_texto(308566) || ' ' /*'Medicamento: '*/ || cd_material || ' - ' || substr(obter_desc_material(cd_material),1,80) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308567) || ': ' /*'Dose/UM/Intervalo/Via: '*/ || substr(obter_um_dosagem_prescr(nr_prescricao,nr_sequencia),1,100) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308564) || ': ' /*'Dia/Lib: '*/ || nr_dia_util || '/'|| qt_total_dias_lib || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308571) || ': ' /*'Reconst / diluicao: '*/ ||substr(obter_diluicao_medic(nr_sequencia,nr_prescricao),1,255) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308541) || ': ' /*'Horarios: '*/ ||substr(ds_horarios,1,255) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || substr(ds_observacao,1,255),
			nr_prescricao,
			CASE WHEN coalesce(nr_seq_substituto::text, '') = '' THEN  'N'  ELSE 'S' END ,
			nr_prescricao_original,
			cd_protocolo,
			nr_seq_protocolo,
			nr_seq_mat_protocolo,
			coalesce(obter_cor_copia_REP(cd_material,'C'),CASE WHEN ie_chamada_protocolo_p='S' THEN obter_cor_protocolo_material(cd_protocolo,nr_seq_protocolo,cd_material)  ELSE null END ) ds_cor,			
			obter_cor_copia_REP(cd_material,'M') ds_mensagem,
			obter_cor_copia_REP(cd_material,'S') ie_marcado,
			cd_intervalo,
			obter_seq_apres_medic(cd_protocolo,nr_seq_protocolo,cd_material) nr_seq_apres
	from	prescr_material
	where   coalesce(nr_sequencia_solucao,0) = 0
	and		coalesce(nr_sequencia_proc,0) = 0
	and		coalesce(nr_sequencia_dieta,0) = 0
	and		coalesce(nr_sequencia_diluicao,0) = 0
	and		((coalesce(nr_seq_kit::text, '') = '') or (ie_copia_kit_rec_w = 'S'))
	and		((ie_origem_inf <> 'K') or (ie_copia_kit_rec_w = 'S'))
	and		ie_agrupador 		= 1
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Materiais */

c10 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_material,
			substr(obter_desc_material(cd_material),1,200),
			Wheb_mensagem_pck.get_texto(308566) || ' ' /*'Medicamento: '*/ || cd_material || ' - ' || substr(obter_desc_material(cd_material),1,80) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308575) || ' ' /*'Quantidade: '*/ || qt_unitaria || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308577) || ': ' /*'Unidade medida: '*/ || cd_intervalo || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308541) || ': ' /*'Horarios: '*/ ||substr(ds_horarios,1,255) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || substr(ds_observacao,1,255),
			nr_prescricao,
			nr_prescricao_original
	from	prescr_material
	where   ie_agrupador 		= 2
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Proced/Exames - Exames / Procedimentos / Servicos */

c11 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_procedimento,
			coalesce(substr(DS_ROTINA,1,150), coalesce(substr(obter_protocolo_descricao(cd_protocolo,nr_seq_protocolo,cd_procedimento,ie_origem_proced,'P',null),1,255),substr(obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,200))),
			ds_observacao,
			nr_prescricao,
			nr_prescricao_original,
			substr(Obter_Desc_Exame(nr_seq_exame),1,240),
			obter_cor_protocolo(cd_protocolo,nr_seq_protocolo,cd_procedimento,ie_origem_proced, nr_seq_proc_interno, nr_seq_exame),
			obter_seq_apres_protocolo(cd_protocolo,nr_seq_protocolo,cd_procedimento,ie_origem_proced) nr_seq_apres,
			ie_origem_proced,
			cd_protocolo,
			nr_seq_protocolo,
			nr_seq_proc_protocolo,
			coalesce(nr_seq_exame,0),
			coalesce(nr_seq_proc_interno,0)
	from	prescr_procedimento
	where	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'O') = 'S'
	and		(((ie_chamada_protocolo_p = 'N' ) and (obter_se_exibe_proc_interno(nr_seq_proc_interno) = 'S')) or (ie_chamada_protocolo_p = 'S'))
	and		coalesce(nr_seq_solic_sangue::text, '') = ''
	and		nr_prescricao = nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Recomendacoes / Ordens */

c13 CURSOR FOR
	SELECT	nr_sequencia,
			cd_recomendacao,
			CASE WHEN coalesce(cd_recomendacao::text, '') = '' THEN  substr(ds_recomendacao,1,200)  ELSE substr(obter_descricao_padrao('TIPO_RECOMENDACAO','DS_TIPO_RECOMENDACAO',CD_RECOMENDACAO),1,200) END ,
			substr(Wheb_mensagem_pck.get_texto(308579) || ': ' /*'Complemento: '*/ || substr(ds_recomendacao,1,200) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308580) || ': ' /*'Intervalos: '*/ || cd_intervalo || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308581) || ': ' /*'Recomendacao suspensa: '*/ || ie_suspenso || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308541) || ': ' /*'Horarios: '*/ || ds_horarios,1,3000),
			nr_prescricao,
			nr_prescricao_original,
			obter_apres_recomendacao_prot(nr_seq_item_prot, nr_seq_protocolo, cd_protocolo) nr_seq_apres
	from	prescr_recomendacao
	where	nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao	>= coalesce(dt_protocolo_p,dt_atualizacao)
	order by nr_seq_apres;
	
/* Banco de Sangue */

c14 CURSOR FOR
	SELECT	nr_sequencia,
			coalesce(substr(obter_protocolo_descricao(cd_protocolo,nr_seq_protocolo,null,null,'HM',nr_seq_item_prot),1,255),ds_diagnostico),
			Wheb_mensagem_pck.get_texto(308583) || ': ' /*'Tipo de paciente: '*/ || CASE WHEN ie_tipo_paciente='CL' THEN  Wheb_mensagem_pck.get_texto(308586) /*'Clinico'*/ WHEN ie_tipo_paciente='CI' THEN  Wheb_mensagem_pck.get_texto(308587) /*'Cirurgico'*/  ELSE '' END  || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308584) || ': ' /*'Tipo atendimento: '*/ || substr(obter_valor_dominio(1223, ie_tipo),1,80) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308585) || ': ' /*'Hemoglobina em g/dl: '*/ || qt_hemoglobina || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308588) || ': ' /*'Hematocrito em %: '*/ || qt_hematocrito || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308589) || ': ' /*'Plaquetas / mm: '*/ || qt_plaqueta || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308590) || ': ' /*'TAP em %: '*/ || qt_tap || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308591) || ': ' /*'TAP em INR: '*/ || qt_tap_inr || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308592) || ': ' /*'Coagulopatia documentada: '*/ || ds_coagulopatia || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || ds_observacao,
			nr_prescricao,
			nr_prescricao_original,
			nr_seq_item_prot
	from	prescr_solic_bco_sangue
	where	nr_prescricao = nr_prescricao_p
	and		dt_atualizacao >= coalesce(dt_protocolo_p,dt_atualizacao);
	
/* Procedimentos do Banco de Sangue */

c141 CURSOR FOR
	SELECT	substr(obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,200),
			substr(Obter_Desc_via(ie_via_aplicacao),1,30),
			qt_procedimento,
			CASE WHEN coalesce(qt_vol_hemocomp::text, '') = '' THEN  null  ELSE '(' || qt_vol_hemocomp || 'ml)' END
	from	prescr_procedimento
	where	coalesce(qt_procedimento,0) > 0
	and		(((ie_chamada_protocolo_p = 'N' ) and (obter_se_exibe_proc_interno(nr_seq_proc_interno) = 'S')) or (ie_chamada_protocolo_p = 'S'))
	--and		obter_se_mostra_proced(nr_prescricao,nr_sequencia,'BSHE') = 'S'
	and		(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
	and		nr_prescricao = nr_prescricao_p
	and		coalesce(dt_atualizacao_nrec,clock_timestamp())	>= coalesce(dt_protocolo_p,coalesce(dt_atualizacao_nrec,clock_timestamp()));
	
/* Oxigenioterapia */
	
c15 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_procedimento,
			substr(obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,200),
			Wheb_mensagem_pck.get_texto(308593) || ': ' /*'Duracao (h): '*/ || qt_procedimento || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308595) || ': ' /*'Respiracao: '*/ || substr(obter_valor_dominio(1299, ie_respiracao),1,80) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308596) || ': ' /*'Modalidade ventilatoria: '*/ || cd_mod_vent || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308597) || ': '/*'Dispositivo acessorio: '*/ || substr(obter_valor_dominio(1612,ie_disp_resp_esp),1,60) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308598) || ': ' /*'Fluxo O (l/min): '*/ || qt_fluxo_oxigenio || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || ds_observacao,
			nr_prescricao,
			nr_prescricao_original
	from	prescr_procedimento
	where	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'G')	= 'S'
	and		nr_prescricao	= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
/* Hemodialise - Prescricao */
	
c16 CURSOR FOR
	SELECT	nr_sequencia,
			substr(CASE WHEN coalesce(IE_TIPO_HEMODIALISE::text, '') = '' THEN  obter_valor_dominio(2154, IE_TIPO_PERITONEAL)  ELSE obter_valor_dominio(1934, IE_TIPO_HEMODIALISE) END ,1,80),
			Wheb_mensagem_pck.get_texto(308599) || ': ' /*'Fluxo de sangue (ml/min): '*/ || QT_FLUXO_SANGUE || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308600) || ': ' /*'Sessoes semanais: '*/ || QT_SESSAO_SEM || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308601) || ': ' /*'Duracao (h/min): '*/ || QT_HORA_SESSAO || ' / ' || QT_MIN_SESSAO || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308602) || ': ' /*'Modelo dialisador: '*/ || substr(obter_descricao_padrao('HD_MODELO_DIALISADOR','DS_MODELO', NR_SEQ_MOD_DIALISADOR),1,200) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308603) || ': ' /*'Ultrafiltracao : '*/ || substr(obter_valor_dominio(1936, IE_ULTRAFILTRACAO),1,80),
			nr_prescricao,
			nr_prescricao_original
	from	hd_prescricao
	where	nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Hemodialise - Medicamentos */

c17 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_material,
			substr(obter_desc_material(cd_material),1,200),
			Wheb_mensagem_pck.get_texto(308566) || ' ' /*'Medicamento: '*/ || cd_material || ' - ' || substr(obter_desc_material(cd_material),1,80) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308567) || ': ' /*'Dose/UM/Intervalo/Via: '*/ || substr(obter_um_dosagem_prescr(nr_prescricao,nr_sequencia),1,100) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308571) || ': ' /*'Reconst / diluicao: '*/ ||substr(obter_diluicao_medic(nr_sequencia,nr_prescricao),1,255) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308541) || ': ' /*'Horarios: '*/ ||substr(ds_horarios,1,255) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || substr(ds_observacao,1,255),
			nr_prescricao,
			CASE WHEN coalesce(nr_seq_substituto::text, '') = '' THEN  'N'  ELSE 'S' END ,
			nr_prescricao_original
	from	prescr_material
	where   coalesce(nr_sequencia_solucao::text, '') = ''
	and		coalesce(nr_sequencia_proc::text, '') = ''
	and		coalesce(nr_sequencia_dieta::text, '') = ''
	and		coalesce(nr_sequencia_diluicao::text, '') = ''
	and		ie_agrupador 		= 14
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
/* Hemodialise - Solucoes */

c18 CURSOR FOR
	SELECT	nr_seq_solucao,
			nr_agrupamento,
			substr(obter_valor_dominio(1935, ie_tipo_solucao),1,80),
			Wheb_mensagem_pck.get_texto(308604) || ': ' /*'Pos-dialisador: '*/ || ie_pos_dialisador || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308606) || ': ' /*'Protocolo: '*/ || substr(obter_descricao_padrao('PROTOCOLO_NPT', 'DS_NPT', nr_seq_protocolo),1,100) || ds_enter_w || 
			Wheb_mensagem_pck.get_texto(308607) || ': ' /*'Volume total: '*/ || qt_solucao_total || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308609) || ': '/*'Velocidade infusao: '*/ || qt_dosagem || ' ' || substr(obter_valor_dominio(1954, ie_unid_vel_inf),1,80) ||ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308610) || ': ' /*'Temperatura (C): '*/ || qt_temp_solucao || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308611) || ' ' /*'Orientacao: '*/ || ds_orientacao,
			nr_prescricao,
			nr_prescricao_original
	from	prescr_solucao
	where	coalesce(ie_hemodialise,'N')	= 'S'
	and		nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao	>= coalesce(dt_protocolo_p,dt_atualizacao);	
	
/* Exames de anatomia patologica */

c19 CURSOR FOR
	SELECT	nr_sequencia,
			nr_agrupamento,
			cd_procedimento,
			substr(obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,200),
			substr(Wheb_mensagem_pck.get_texto(308613) || ': ' /*'Data retirada/coleta: '*/ || to_char(dt_coleta,'dd/mm/yyyy hh24:mi:ss') || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308614) || ': ' /*'Quantidade de pecas: '*/ || qt_peca_ap || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308615) || ': ' /*'Descricao e qualidade do(s) material(is): '*/ || substr(ds_qualidade_peca_ap,1,1500) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308616) || ': ' /*'Dados clinicos: '*/ || substr(ds_dado_clinico,1,1500) || ds_enter_w ||
			Wheb_mensagem_pck.get_texto(308617) || ': ' /*'Diagnostico provavel: '*/ || substr(ds_diag_provavel_ap,1,255),1,4000),
			nr_prescricao,
			nr_prescricao_original
	from	prescr_procedimento
	where	((obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'AP')	= 'S') or (obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'APH') = 'S') or (obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'APC') = 'S'))
	and		nr_prescricao = nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);

/* Exames Citopatologico colo utero */

c20 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308618), /*'Citopatologico do Colo do Utero',*/
			nr_prescricao,
			nr_prescricao_original
	from	prescr_citopatologico
	where	nr_prescricao = nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
/* Exames Histopatologico colo utero */

c21 CURSOR FOR
	SELECT	nr_sequencia,
			Wheb_mensagem_pck.get_texto(308619), /*'Histopatologico do Colo do Utero',*/
			nr_prescricao,
			nr_prescricao_original
	from	prescr_histopatologico
	where	nr_prescricao		= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
c22 CURSOR FOR
	SELECT	substr(obter_desc_material(cd_material),1,255),
			qt_dose,
			cd_unidade_medida_dose,
			obter_cor_copia_REP(cd_material,'C') ds_cor,
			obter_cor_copia_REP(cd_material,'M') ds_mensagem,
			obter_cor_copia_REP(cd_material,'S') ie_marcado
	from	prescr_material
	where	nr_sequencia_solucao	= nr_sequencia_w
	and		nr_prescricao	= nr_prescricao_p
	and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);
	
c23 CURSOR FOR
SELECT	nr_sequencia,
		nr_seq_gas,
		substr(coalesce(Obter_desc_rotina_gas(nr_seq_item_rotina),obter_descricao_padrao('GAS', 'DS_GAS', nr_seq_gas)),1,200),
		substr(Wheb_mensagem_pck.get_texto(308595) || ': ' /*'Respiracao: '*/ || substr(obter_valor_dominio(1299, ie_respiracao),1,80) || ds_enter_w ||
		Wheb_mensagem_pck.get_texto(308596) || ': ' /*'Modalidade ventilatoria: '*/ || substr(obter_descricao_padrao('MODALIDADE_VENTILATORIA', 'DS_MODALIDADE', cd_modalidade_vent),1,155) || ds_enter_w ||
		Wheb_mensagem_pck.get_texto(308597) || ': ' /*'Dispositivo acessorio: '*/ || substr(obter_valor_dominio(1612,ie_disp_resp_esp),1,60) || ds_enter_w ||
		Wheb_mensagem_pck.get_texto(308542) || ' ' /*'Observacao: '*/ || ds_observacao,1,4000),
		nr_prescricao,
		nr_prescricao_original
from	prescr_gasoterapia
where	nr_prescricao = nr_prescricao_p
and		coalesce(dt_atualizacao_nrec,clock_timestamp())	>= coalesce(dt_protocolo_p,coalesce(dt_atualizacao_nrec,clock_timestamp()));

c24 CURSOR FOR
SELECT	nr_sequencia,
		cd_material,
		substr(obter_desc_material(cd_material),1,80),
		nr_prescricao,
		nr_prescricao_original
from	prescr_material
where	ie_agrupador = 16
and		nr_prescricao = nr_prescricao_p
and	dt_atualizacao_nrec	>= coalesce(dt_protocolo_p,dt_atualizacao_nrec);


BEGIN

ie_desc_hemocomp_w := Obter_Param_Usuario(-16, 15, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_desc_hemocomp_w);
ie_copia_kit_rec_w := Obter_Param_Usuario(924, 933, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_copia_kit_rec_w);
ie_apresenta_procedimento_w := Obter_Param_Usuario(-16, 5, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_apresenta_procedimento_w);
ie_descricao_reduzida_w := Obter_Param_Usuario(-16, 19, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_descricao_reduzida_w);

delete  from w_copia_prescricao
where   nr_prescricao		= nr_prescricao_p;

select	coalesce(max(ie_proced_sangue_copia),'S')
into STRICT	ie_proced_sangue_copia_w
from	parametro_medico
where	cd_estabelecimento = cd_estabelecimento_p;

/* Nutricao - Dieta Oral */

open c01;
loop
fetch c01 into	
	nr_sequencia_w,
	cd_dieta_w,
	ds_titulo_w,
	ds_informacao_w,
	nr_prescricao_w,
	nr_prescricao_original_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	select	count(*)
	into STRICT	qt_registros_w
	from	prescr_dieta
	where	cd_dieta	= cd_dieta_w
	and		nr_prescricao	= nr_prescricao_p;
	exception
		when others then
		qt_registros_w	:= 0;
	end;
	
	select	max(coalesce(ie_prescr_farm,'N')),
			max(cd_funcao_origem)
	into STRICT	ie_prescr_farm_w,
			cd_funcao_origem_w
	from 	prescr_medica
	where 	nr_prescricao = nr_prescricao_original_w;

	if (qt_registros_w > 1) then
		ie_duplicado_w	:= 'S';
	else
		ie_duplicado_w	:= 'N';
	end if;
	
	insert into w_copia_prescricao(
		nr_sequencia,
		nr_grupo,
		nr_agrupamento,
		ds_item_prescricao,
		ds_inf_adicional,
		nr_seq_item,
		nr_prescricao,
		ie_duplicado,
		ie_substituido,
		ie_prescr_farm,
		ie_tipo_item,
		cd_funcao_origem
	) values (
		nextval('w_copia_prescricao_seq'),
		100,
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_sequencia_w,
		nr_prescricao_w,
		ie_duplicado_w,
		'N',
		ie_prescr_farm_w,
		'Nut',
		cd_funcao_origem_w
	);

end loop;
close c01;

/* Nutricao - Suplemento e modulos nutricionais e formulas pediatricas */

open c03;
	loop
	fetch c03 into
		nr_sequencia_w,
		cd_material_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	cd_material	= cd_material_w
		and	ie_agrupador	= 12;
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			101,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			ie_prescr_farm_w,
			'Nut',
			cd_funcao_origem_w
		);

	end loop;
close c03;		

/* Nutricao - Suporte Nutricional Enteral */

open c04;
	loop
	fetch c04 into
		nr_sequencia_w,
		cd_material_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_material
		where	cd_material	= cd_material_w
		and		ie_agrupador	= 8
		and		nr_prescricao	= nr_prescricao_p;
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			102,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			ie_prescr_farm_w,
			'Nut',
			cd_funcao_origem_w
		);

	end loop;
close c04;

/* Nutricao - NPT Adulta */

open c05;
	loop
	fetch c05 into
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
	
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			103,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Nut',
			cd_funcao_origem_w
		);

	end loop;
close c05;

/* Nutricao - NPT NeoNatal */

open c06;
	loop
	fetch c06 into
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c06 */
	
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			103,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Nut',
			cd_funcao_origem_w
		);

	end loop;
close c06;

/* Nutricao - NPT Adulta */

open c07;
	loop
	fetch c07 into
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c07 */
	
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			103,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Nut',
			cd_funcao_origem_w
		);

	end loop;
close c07;

/* Nutricao - NPT Pediatrica */

open c071;
loop
fetch c071 into
	nr_sequencia_w,
	ds_titulo_w,
	ds_informacao_w,
	nr_prescricao_w,
	nr_prescricao_original_w;
EXIT WHEN NOT FOUND; /* apply on c071 */

	select	max(cd_funcao_origem)
	into STRICT	cd_funcao_origem_w
	from 	prescr_medica
	where 	nr_prescricao = nr_prescricao_original_w;

	insert into w_copia_prescricao(
		nr_sequencia,
		nr_grupo,
		nr_agrupamento,
		ds_item_prescricao,
		ds_inf_adicional,
		nr_seq_item,
		nr_prescricao,
		ie_duplicado,
		ie_substituido,
		ie_tipo_item,
		cd_funcao_origem
	) values (
		nextval('w_copia_prescricao_seq'),
		118,
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_sequencia_w,
		nr_prescricao_w,
		'N',
		'N',
		'Nut',
		cd_funcao_origem_w
	);

end loop;
close c071;

/* Solucao - Padrao */

open c08;
	loop
	fetch c08 into
		nr_sequencia_w,
		nr_agrupamento_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */
		begin
		ds_cor_ww	:= null;
		ds_mensagem_ww	:= null;
		ie_marcado_ww	:= null;
			
		open C22;
		loop
		fetch C22 into	
			ds_material_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			ds_cor_w,
			ds_mensagem_w,
			ie_marcado_w;
		EXIT WHEN NOT FOUND; /* apply on C22 */
			begin
			
			if (coalesce(ds_cor_ww::text, '') = '') and (ds_cor_w IS NOT NULL AND ds_cor_w::text <> '') then
				ds_cor_ww	:= ds_cor_w;
			end if;
			
			if (coalesce(ds_mensagem_ww::text, '') = '') and (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
				ds_mensagem_ww	:= ds_mensagem_w;
			end if;
			
			if (coalesce(ie_marcado_ww::text, '') = '') and (ie_marcado_w IS NOT NULL AND ie_marcado_w::text <> '') then
				ie_marcado_ww	:= ie_marcado_w;
			end if;
			
			ds_informacao_w	:= ds_informacao_w ||chr(13)||qt_dose_w ||' '||cd_unidade_medida_dose_w||' '||ds_material_w;
			exception
			when others then
				ds_informacao_w := ds_informacao_w;
			end;
		end loop;
		close C22;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ds_cor,
			ds_mensagem,
			ie_marcado,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			104,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			ie_prescr_farm_w,
			ds_cor_ww,
			ds_mensagem_ww,
			ie_marcado_ww,
			'Sol',
			cd_funcao_origem_w);
		end;
	end loop;
close c08;

/* Medicamentos - Medicamento */

open c09;
	loop
	fetch c09 into
		nr_sequencia_w,
		nr_agrupamento_w,
		cd_material_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		ie_substituido_w,
		nr_prescricao_original_w,
		cd_protocolo_w,
		nr_seq_protocolo_w,
		nr_seq_mat_protocolo_w,
		ds_cor_w,
		ds_mensagem_w,
		ie_marcado_w,
		cd_intervalo_w,
		nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c09 */
	
	if (cd_protocolo_w IS NOT NULL AND cd_protocolo_w::text <> '') and (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') and (nr_seq_mat_protocolo_w IS NOT NULL AND nr_seq_mat_protocolo_w::text <> '') then
			Select	coalesce(max(ie_alterar_dose),'N'),
				max(ds_rotina),
				max(coalesce(ie_princ_grupo_rotina,'N')),
				max(nr_seq_grupo)
			into STRICT	ie_alterar_dose_w,
				ds_rotina_w,
				ie_princ_grupo_rotina_w,
				nr_seq_grupo_w
			from 	protocolo_medic_material
			where	cd_protocolo		= cd_protocolo_w
			and	nr_seq_material		= nr_seq_mat_protocolo_w
			and	nr_sequencia		= nr_seq_protocolo_w;
			
			if (ie_tit_medic_rotina_p = 'S') and (ie_chamada_protocolo_p = 'S')  then
				ds_titulo_w	:= coalesce(ds_rotina_w,ds_titulo_w);
			end if;
		end if;

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_material
		where   coalesce(nr_sequencia_solucao,0) = 0
		and		coalesce(nr_sequencia_proc,0) = 0
		and		coalesce(nr_sequencia_dieta,0) = 0
		and		coalesce(nr_sequencia_diluicao,0) = 0
		and		cd_material	= cd_material_w
		and		ie_agrupador 	= 1
		and     coalesce(cd_intervalo,'XPTO') = coalesce(cd_intervalo_w,'XPTO')
		and		nr_prescricao	= nr_prescricao_p;
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		
		if (((ie_princ_grupo_rotina_w = 'S') and (obter_se_repres_grupo_prot(cd_protocolo_w,nr_seq_grupo_w,nr_seq_protocolo_w) = 'S')) or (obter_se_repres_grupo_prot(cd_protocolo_w,nr_seq_grupo_w,nr_seq_protocolo_w) = 'N')) then
		
			insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_alterar_dose,
			ds_cor,
			ds_mensagem,
			ie_marcado,
			ie_tipo_item,
			nr_seq_apres,
			cd_funcao_origem
			) values (
			nextval('w_copia_prescricao_seq'),
			105,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			ie_substituido_w,
			ie_prescr_farm_w,
			ie_alterar_dose_w,
			ds_cor_w,
			ds_mensagem_w,
			ie_marcado_w,
			'Med',
			 nr_seq_apres_w,
			 cd_funcao_origem_w
		);
		
		end if;

	end loop;
close c09;

/* Material */

if (ie_medico_p = 'N') then
	open c10;
		loop
		fetch c10 into
			nr_sequencia_w,
			nr_agrupamento_w,
			cd_material_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_prescricao_w,
			nr_prescricao_original_w;
		EXIT WHEN NOT FOUND; /* apply on c10 */

			if (ie_medico_p = 'N') then
				begin
				select	count(*)
				into STRICT	qt_registros_w
				from	prescr_material
				where   cd_material		= cd_material_w
				and		ie_agrupador 		= 2
				and		nr_prescricao		= nr_prescricao_p;
				exception
					when others then
					qt_registros_w	:= 0;
				end;
			else
				qt_registros_w := 0;
			end if;
			
			select	max(coalesce(ie_prescr_farm,'N')),
					max(cd_funcao_origem)
			into STRICT	ie_prescr_farm_w,
					cd_funcao_origem_w
			from 	prescr_medica
			where 	nr_prescricao = nr_prescricao_original_w;

			if (qt_registros_w > 1) then
				ie_duplicado_w	:= 'S';
			else
				ie_duplicado_w	:= 'N';
			end if;

			insert into w_copia_prescricao(
				nr_sequencia,
				nr_grupo,
				nr_agrupamento,
				ds_item_prescricao,
				ds_inf_adicional,
				nr_seq_item,
				nr_prescricao,
				ie_duplicado,
				ie_substituido,
				ie_prescr_farm,
				ie_tipo_item,
				cd_funcao_origem
			) values (
				nextval('w_copia_prescricao_seq'),
				106,
				nr_agrupamento_w,
				ds_titulo_w,
				ds_informacao_w,
				nr_sequencia_w,
				nr_prescricao_w,
				ie_duplicado_w,
				'N',
				ie_prescr_farm_w,
				'Mat',
				cd_funcao_origem_w
			);

		end loop;

	close c10;
end if;

/* Exames / Procedimentos / Servicos */

if (ie_apresenta_procedimento_w = 'S') then
	open c11;
		loop
		fetch c11 into
			nr_sequencia_w,
			nr_agrupamento_w,
			cd_procedimento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_prescricao_w,
			nr_prescricao_original_w,
			ds_Exame_w,
			ds_cor_w,
			nr_seq_apres_w,
			ie_origem_proced_w,
			cd_protocolo_proc_w,
			nr_seq_protocolo_proc_w,
			nr_seq_proc_protocolo_w,
			nr_seq_exame_w,
			nr_seq_proc_interno_w;
		EXIT WHEN NOT FOUND; /* apply on c11 */

			begin			
			if (ie_chamada_protocolo_p = 'S') then
				if (cd_protocolo_proc_w IS NOT NULL AND cd_protocolo_proc_w::text <> '') and (nr_seq_protocolo_proc_w IS NOT NULL AND nr_seq_protocolo_proc_w::text <> '') then
					select coalesce(max(ie_questiona_lado), 'N')
					into STRICT	ie_questiona_lado_w
					from	protocolo_medic_proc
					where	cd_protocolo	= cd_protocolo_proc_w
					and		nr_sequencia	= nr_seq_protocolo_proc_w	
					and		nr_seq_proc		= nr_seq_proc_protocolo_w					
					and		cd_procedimento	= cd_procedimento_w;
				end if;	
			end if;

			select	count(*)
			into STRICT	qt_registros_w
			from	prescr_procedimento
			where	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'O') = 'S'
			and		cd_procedimento			= cd_procedimento_w
			and		ie_origem_proced		= ie_origem_proced_w
			and		nr_prescricao			= nr_prescricao_p
			and		coalesce(nr_seq_origem::text, '') = ''
			and		coalesce(nr_seq_exame,0)	        = nr_seq_exame_w
			and		coalesce(nr_seq_proc_interno,0)      = nr_seq_proc_interno_w;
			exception
				when others then
				qt_registros_w	:= 0;
			end;
			
			select	max(coalesce(ie_prescr_farm,'N')),
					max(cd_funcao_origem)
			into STRICT	ie_prescr_farm_w,
					cd_funcao_origem_w
			from 	prescr_medica
			where 	nr_prescricao = nr_prescricao_original_w;

			if (qt_registros_w > 1) then
				ie_duplicado_w	:= 'S';
			else
				ie_duplicado_w	:= 'N';
			end if;
			
			if (ds_exame_w IS NOT NULL AND ds_exame_w::text <> '') and (ie_nome_exame_p	= 'S') then
				ds_titulo_w	:= ds_exame_w;
			end if;
			
			insert into w_copia_prescricao(
				nr_sequencia,
				nr_grupo,
				nr_agrupamento,
				ds_item_prescricao,
				ds_inf_adicional,
				nr_seq_item,
				nr_prescricao,
				ie_duplicado,
				ie_substituido,
				ie_prescr_farm,
				ds_cor,
				nr_seq_apres,
				ie_tipo_item,
				ie_questiona_lado,
				cd_funcao_origem
			) values (
				nextval('w_copia_prescricao_seq'),
				107,
				nr_agrupamento_w,
				ds_titulo_w,
				ds_informacao_w,
				nr_sequencia_w,
				nr_prescricao_w,
				ie_duplicado_w,
				'N',
				ie_prescr_farm_w,
				ds_cor_w,
				nr_seq_apres_w,
				'Exa',
				ie_questiona_lado_w,
				cd_funcao_origem_w);

	end loop;
	close c11;
end if;

/* Recomendacoes / Ordens */

open c13;
	loop
	fetch c13 into
		nr_sequencia_w,
		cd_recomendacao_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w,
		nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c13 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_recomendacao
		where	cd_recomendacao		= cd_recomendacao_w
		and		nr_prescricao		= nr_prescricao_p;
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			nr_seq_apres,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			108,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			ie_prescr_farm_w,
			nr_seq_apres_w,
			'Rec',
			cd_funcao_origem_w
		);

	end loop;
close c13;

/* Banco de Sangue */

open c14;
	loop
	fetch c14 into
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w,
		nr_seq_item_prot_w;
	EXIT WHEN NOT FOUND; /* apply on c14 */
		begin

		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_original_w;
		
		begin
			select	count(*)
			into STRICT	qt_registros_w
			from	prescr_solic_bco_sangue a
			where	a.nr_seq_item_prot = nr_seq_item_prot_w
			and		a.nr_prescricao = nr_prescricao_p  LIMIT 2;
		exception
			when others then
			qt_registros_w	:= 0;
		end;

		if (ie_desc_hemocomp_w = 'S') then
			ds_informacao_w		:= Wheb_mensagem_pck.get_texto(308625) || ': ' /*'Diagnostico: '*/ || ds_titulo_w || chr(10) || ds_informacao_w;
			ds_titulo_w			:= '';
			open C141;
			loop
			fetch C141 into	
				ds_procedimento_w,
				ie_via_aplicacao_w,
				qt_procedimento_w,
				ds_vol_hemocomp_w;
			EXIT WHEN NOT FOUND; /* apply on C141 */
				begin
				if (coalesce(ds_procedimento_w::text, '') = '') then
					ds_procedimento_w := Wheb_mensagem_pck.get_texto(308626); --'Proced. sem descricao';
				elsif (length(ds_procedimento_w) > 30) then
					ds_procedimento_w := substr(ds_procedimento_w,1,27) || '...';
				end if;
				
				ds_titulo_w := substr(ds_titulo_w ||
										'*' || ds_procedimento_w || ' ' || 
										qt_procedimento_w || 'un' || ds_vol_hemocomp_w || ' ' || 
										ie_via_aplicacao_w || 'chr(10)', 1, 4000);
				end;
			end loop;
			close C141;	
		else
			open C141;
			loop
			fetch C141 into	
				ds_procedimento_w,
				ie_via_aplicacao_w,
				qt_procedimento_w,
				ds_vol_hemocomp_w;
			EXIT WHEN NOT FOUND; /* apply on C141 */
				begin
				if (coalesce(ds_procedimento_w::text, '') = '') then
					ds_procedimento_w := Wheb_mensagem_pck.get_texto(308626); --'Proced. sem descricao';
				elsif (length(ds_procedimento_w) > 30) then
					ds_procedimento_w := substr(ds_procedimento_w,1,27) || '...';
				end if;
				
				ds_informacao_w := substr(ds_informacao_w ||
											chr(10) || '*' || ds_procedimento_w || ' ' || 
											qt_procedimento_w || 'un' || ds_vol_hemocomp_w || ' ' || 
											ie_via_aplicacao_w, 1, 4000);
				end;
			end loop;
			close C141;
		end if;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			109,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			'San',
			cd_funcao_origem_w
		);
		end;
	end loop;
close c14;

/* Oxigenioterapia */

open c15;
	loop
	fetch c15 into
		nr_sequencia_w,
		nr_agrupamento_w,
		cd_procedimento_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c15 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		and	cd_procedimento		= cd_procedimento_w
		and	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'G') = 'S';
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			110,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			ie_prescr_farm_w,
			'Oxi',
			cd_funcao_origem_w
		);

	end loop;
close c15;

/* Hemodialise - Prescricao */

open c16;
	loop
	fetch c16 into
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c16 */
		begin
		
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			111,
			nr_sequencia_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Pdia',
			cd_funcao_origem_w
		);
		end;
	end loop;
close c16;

/* Hemodialise - Medicamentos */

open c17;
	loop
	fetch c17 into
		nr_sequencia_w,
		nr_agrupamento_w,
		cd_material_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		ie_substituido_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c17 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_material
		where   nr_prescricao		= nr_prescricao_p
		and	cd_material		= cd_material_w
		and	ie_agrupador 		= 14
		and	coalesce(nr_sequencia_solucao,0) = 0
		and	coalesce(nr_sequencia_proc,0) = 0
		and	coalesce(nr_sequencia_dieta,0) = 0
		and	coalesce(nr_sequencia_diluicao,0) = 0;
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			112,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			ie_substituido_w,
			ie_prescr_farm_w,
			'Mdia',
			cd_funcao_origem_w
		);

	end loop;
close c17;

/* Hemodialise - Solucoes */

open c18;
	loop
	fetch c18 into
		nr_sequencia_w,
		nr_agrupamento_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c18 */
	
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			113,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			ie_prescr_farm_w,
			'Sdia',
			cd_funcao_origem_w
		);

	end loop;
close c18;

/* Exames de anatomia patologica */

open c19;
	loop
	fetch c19 into
		nr_sequencia_w,
		nr_agrupamento_w,
		cd_procedimento_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c19 */

		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		and	cd_procedimento		= cd_procedimento_w
		and 	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'AP')	= 'S'
		and 	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'APH')= 'S'
		and 	obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'APC')= 'S';
		exception
			when others then
			qt_registros_w	:= 0;
		end;
		
		select	max(coalesce(ie_prescr_farm,'N')),
				max(cd_funcao_origem)
		into STRICT	ie_prescr_farm_w,
				cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;

		if (qt_registros_w > 1) then
			ie_duplicado_w	:= 'S';
		else
			ie_duplicado_w	:= 'N';
		end if;

		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_prescr_farm,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			114,
			nr_agrupamento_w,
			ds_titulo_w,
			ds_informacao_w,
			nr_sequencia_w,
			nr_prescricao_w,
			ie_duplicado_w,
			'N',
			ie_prescr_farm_w,
			'Epat',
			cd_funcao_origem_w
		);

	end loop;
close c19;

/* Exame Citopatologico do Colo do Utero */

open c20;
	loop
	fetch c20 into
		nr_sequencia_w,
		ds_titulo_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c20 */
		begin		
		
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;
		
		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			115,
			nr_sequencia_w,
			ds_titulo_w,
			'',
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Ecol',
			cd_funcao_origem_w
		);
		end;
	end loop;
close c20;

/* Exame Histopatologico do Colo do Utero */

open c21;
	loop
	fetch c21 into
		nr_sequencia_w,
		ds_titulo_w,
		nr_prescricao_w,
		nr_prescricao_original_w;
	EXIT WHEN NOT FOUND; /* apply on c21 */
		begin		
		
		select	max(cd_funcao_origem)
		into STRICT	cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_original_w;
		
		insert into w_copia_prescricao(
			nr_sequencia,
			nr_grupo,
			nr_agrupamento,
			ds_item_prescricao,
			ds_inf_adicional,
			nr_seq_item,
			nr_prescricao,
			ie_duplicado,
			ie_substituido,
			ie_tipo_item,
			cd_funcao_origem
		) values (
			nextval('w_copia_prescricao_seq'),
			116,
			nr_sequencia_w,
			ds_titulo_w,
			'',
			nr_sequencia_w,
			nr_prescricao_w,
			'N',
			'N',
			'Ecol',
			cd_funcao_origem_w
		);
		end;
	end loop;
close c21;

/* Gasoterapia */

open c23;
loop
fetch c23 into
	nr_sequencia_w,
	cd_procedimento_w,
	ds_titulo_w,
	ds_informacao_w,
	nr_prescricao_w,
	nr_prescricao_original_w;
EXIT WHEN NOT FOUND; /* apply on c23 */

	select	max(cd_funcao_origem)
	into STRICT	cd_funcao_origem_w
	from 	prescr_medica
	where 	nr_prescricao = nr_prescricao_original_w;

	insert into w_copia_prescricao(nr_sequencia,
		nr_grupo,
		nr_agrupamento,
		ds_item_prescricao,
		ds_inf_adicional,
		nr_seq_item,
		nr_prescricao,
		ie_duplicado,
		ie_substituido,
		ie_tipo_item,
		cd_funcao_origem)
	values (nextval('w_copia_prescricao_seq'),
		117,
		nr_sequencia_w,
		ds_titulo_w,
		ds_informacao_w,
		nr_sequencia_w,
		nr_prescricao_w,
		'N',
		'N',
		'Gas',
		cd_funcao_origem_w);

end loop;
close c23;

open c24;
loop
fetch c24 into
	nr_sequencia_w,
	cd_material_w,
	ds_titulo_w,
	nr_prescricao_w,
	nr_prescricao_original_w;
EXIT WHEN NOT FOUND; /* apply on c24 */

	select	max(cd_funcao_origem)
	into STRICT	cd_funcao_origem_w
	from 	prescr_medica
	where 	nr_prescricao = nr_prescricao_original_w;

	insert into w_copia_prescricao(
		nr_sequencia,
		nr_grupo,
		nr_agrupamento,
		ds_item_prescricao,
		ds_inf_adicional,
		nr_seq_item,
		nr_prescricao,
		ie_duplicado,
		ie_substituido,
		ie_prescr_farm,
		ie_tipo_item,
		cd_funcao_origem
	) values (
		nextval('w_copia_prescricao_seq'),
		119,
		nr_sequencia_w,
		ds_titulo_w,
		null,
		nr_sequencia_w,
		nr_prescricao_w,
		'N',
		'N',
		'N',
		'Nut',
		cd_funcao_origem_w
	);
end loop;
close c24;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_copia_prescricao ( nr_prescricao_p text, ie_medico_p text, ie_nome_exame_p text, ie_tit_medic_rotina_p text,  cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, dt_protocolo_p timestamp, ie_chamada_protocolo_p text default 'N') FROM PUBLIC;

