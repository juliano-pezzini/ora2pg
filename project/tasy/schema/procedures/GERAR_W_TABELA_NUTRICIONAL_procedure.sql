-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_tabela_nutricional (nr_seq_receita_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_genero_alim_w		varchar(100);
ie_tipo_w			varchar(1);
nr_atributo_cab_w		bigint;
nr_atributo_res_w		bigint;
ds_comando_w			varchar(4000);
ds_nutriente_w			varchar(40);
qt_calculo_w			varchar(100);
qt_calculo_format_w		varchar(100);
ds_sql_cabecalho_w		varchar(4000);
ds_sql_genero_alim_w		varchar(4000);
ds_sql_nutriente_w		varchar(4000);
ds_sql_resultado_w		varchar(4000);
nr_seq_nutriente_w		bigint;
ds_cabecalho_total_w		varchar(40);
ds_resultado_total_w		varchar(40);
qt_soma_w			double precision;
qt_soma_format_w		varchar(100);
ie_controle			boolean := false;
ds_nutriente_genero_w	varchar(100) := wheb_mensagem_pck.get_texto(1080950);
ds_total_w		varchar(100) := wheb_mensagem_pck.get_texto(802312);

c01 CURSOR FOR
	SELECT	b.ds_genero,
		'C'
	from	nut_receita_comp a,
		nut_genero_alim b
	where	a.nr_seq_gen_alim = b.nr_sequencia
	and	nr_seq_receita = nr_seq_receita_p
	order by 1;
	
c02 CURSOR FOR
	SELECT distinct
		d.ds_nutriente,
		'R',
		c.nr_seq_nutriente
	from	nut_receita_comp a,
		nut_genero_alim b,
		nut_comp_nutricional c,
		nut_nutriente d
	where	a.nr_seq_gen_alim = b.nr_sequencia
	and	b.nr_sequencia = c.nr_seq_gen_alim
	and	c.nr_seq_nutriente = d.nr_sequencia
	and	nr_seq_receita = nr_seq_receita_p
	order by 1;

c03 CURSOR FOR
	SELECT	distinct
		b.ds_genero,
		coalesce(trunc(((c.qt_composicao * a.qt_componente)/100),2),0)
	FROM nut_receita_comp a, nut_genero_alim b
LEFT OUTER JOIN nut_comp_nutricional c ON (b.nr_sequencia = c.nr_seq_gen_alim AND nr_seq_nutriente_w = c.nr_seq_nutriente)
LEFT OUTER JOIN nut_nutriente d ON (c.nr_seq_nutriente = d.nr_sequencia)
WHERE a.nr_seq_gen_alim = b.nr_sequencia   and a.nr_seq_receita = nr_seq_receita_p  order by 1;
	


BEGIN

delete FROM w_tabela_nutricional where nm_usuario = nm_usuario_p;

if (nr_seq_receita_p IS NOT NULL AND nr_seq_receita_p::text <> '') then
	nr_atributo_cab_w := 2;
	nr_atributo_res_w := 2;
	qt_soma_w := 0;

	--Montar o cabe√ßalho
	open C01;
	loop
	fetch 	C01 into	
		ds_genero_alim_w,
		ie_tipo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		ds_sql_cabecalho_w := ds_sql_cabecalho_w || 'DS_RESULTADO' || nr_atributo_cab_w || ',';
		ds_sql_genero_alim_w := ds_sql_genero_alim_w || chr(39) || ds_genero_alim_w || chr(39) || ',';
		
		nr_atributo_cab_w := nr_atributo_cab_w + 1;
		ie_controle := true;

		end;
	end loop;
	close C01;

	ds_cabecalho_total_w := 'DS_RESULTADO' || nr_atributo_cab_w;
	
	if (ie_controle) then
		ds_comando_w := ' insert into w_tabela_nutricional (	nr_sequencia,
									ie_tipo, 
									ds_resultado1,'||
									ds_sql_cabecalho_w ||
									ds_cabecalho_total_w || ',' ||
									'nm_usuario)
							values(		w_tabela_nutricional_seq.nextval ,' ||
									chr(39) || ie_tipo_w || chr(39) || ',
									''' || ds_nutriente_genero_w || ''',' ||
									ds_sql_genero_alim_w ||	
									'''' || ds_total_w || '''' || ',' ||
									chr(39) || nm_usuario_p || chr(39) || ') ';
	else
		ds_comando_w := ' insert into w_tabela_nutricional (	nr_sequencia,
									ie_tipo, 
									ds_resultado1,'||
									ds_sql_cabecalho_w ||
									ds_cabecalho_total_w || ',' ||
									'nm_usuario)
							values(		w_tabela_nutricional_seq.nextval ,
									''C''' || ',
									''' || ds_nutriente_genero_w || ''',' ||
									ds_sql_genero_alim_w ||	
									'''' || ds_total_w || '''' || ',' ||
									chr(39) || nm_usuario_p || chr(39) || ') ';
	end if;
	CALL exec_sql_dinamico('TASY', ds_comando_w);
		
	open C02;
	loop
	fetch 	C02 into	
		ds_nutriente_w,
		ie_tipo_w,
		nr_seq_nutriente_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		open C03;
		loop
		fetch 	C03 into
			ds_genero_alim_w,
			qt_calculo_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			
			select trim(both to_char(qt_calculo_w,'999999990.99'))
			into STRICT	qt_calculo_format_w
			;

			ds_sql_resultado_w := ds_sql_resultado_w || 'DS_RESULTADO' || nr_atributo_res_w || ',';
			ds_sql_nutriente_w := ds_sql_nutriente_w || chr(39) || qt_calculo_format_w || chr(39) || ',';
			
			qt_soma_w := qt_soma_w + qt_calculo_w;

			nr_atributo_res_w := nr_atributo_res_w + 1;
			
			end;
		end loop;
		close C03;
		
		
		select trim(both to_char(qt_soma_w,'999999990.99'))
		into STRICT	qt_soma_format_w
		;
		
		ds_resultado_total_w := 'DS_RESULTADO' || nr_atributo_res_w;
		
		ds_comando_w := ' insert into w_tabela_nutricional (	nr_sequencia,
									ie_tipo, 
									ds_resultado1,' ||
									ds_sql_resultado_w ||
									ds_resultado_total_w || ',' ||
									'nm_usuario)
							values(		w_tabela_nutricional_seq.nextval ,' ||
									chr(39) || ie_tipo_w || chr(39) || ',' ||
									chr(39) || ds_nutriente_w || chr(39) || ',' ||
									ds_sql_nutriente_w ||
									chr(39) || qt_soma_format_w || chr(39) || ',' ||
									chr(39) || nm_usuario_p || chr(39) || ') ';
									
									
		CALL exec_sql_dinamico('TASY', ds_comando_w);
		
		nr_atributo_res_w := 2;
		qt_soma_w := 0;
		qt_soma_format_w := '';
		ds_sql_resultado_w := '';
		ds_sql_nutriente_w := '';
				
		end;
	end loop;
	close C02;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_tabela_nutricional (nr_seq_receita_p bigint, nm_usuario_p text) FROM PUBLIC;

