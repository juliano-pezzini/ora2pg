-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_fornecedor_consignado ( cd_material_p bigint, dt_mesano_referencia_p timestamp, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, qt_quantidade_p bigint, ie_acao_p text, nr_atendimento_p text, cd_cgc_fornecedor_p INOUT text, ds_observacao_p INOUT text, nr_seq_lote_p bigint) AS $body$
DECLARE

/* ie_acao_p
E - Execução ( Novo material)
D - Devolução do material
*/
qt_fornecedor_w		smallint;
ie_consignado_w		varchar(1);
ds_material_w		varchar(255);
cd_fornec_lote_w	varchar(14);


BEGIN

select	ie_consignado,
	ds_material
into STRICT	ie_consignado_w,
	ds_material_w
from	material
where	cd_material = cd_material_p;

if (ie_consignado_w <> 0) then
	begin

	if (coalesce(nr_seq_lote_p, 0) > 0) then	/*Anderson 04/08/2007 - OS60904*/
		select	cd_cgc_fornec
		into STRICT	cd_cgc_fornecedor_p
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_p;
	end if;


	if (ie_acao_p = 'E') and (coalesce(nr_seq_lote_p, 0) = 0) then

		begin

		select	coalesce(count(distinct(a.cd_fornecedor)),0)
		into STRICT	qt_fornecedor_w
		from	fornecedor_mat_consignado a,
			Material m
		where	a.cd_material           	= m.cd_material_estoque
		and	a.dt_mesano_referencia  	> dt_mesano_referencia_p - 60
		and	m.cd_material         		= cd_material_p
		and	a.cd_local_estoque		= cd_local_estoque_p
		and	a.cd_estabelecimento	= cd_estabelecimento_p;

		if (qt_fornecedor_w = 0) then
			ds_observacao_p	:= substr(wheb_mensagem_pck.get_texto(308658,'DS_MATERIAL_W='||ds_material_w),1,255);
		elsif (qt_fornecedor_w > 1) then
			ds_observacao_p	:= substr(wheb_mensagem_pck.get_texto(308659,'DS_MATERIAL_W='||ds_material_w),1,255);
		elsif (qt_fornecedor_w = 1) then
			begin
			select	max(a.cd_fornecedor)
			into STRICT	cd_cgc_fornecedor_p
			from	fornecedor_mat_consignado a,
				Material m
			where	a.cd_material           	= m.cd_material_estoque
			and	a.dt_mesano_referencia  	> dt_mesano_referencia_p - 60
			and	m.cd_material           	= cd_material_p
			and	a.cd_local_estoque		= cd_local_estoque_p
			and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end;
		end if;
		end;
	end if;

	if (ie_acao_p = 'D') then
		begin
		/*Fabio inclui o nvl(cd_material_exec, pois na devolução de um material que foi atendido com regra de material conta,
			no cd_material fica o material conta - OS56749*/
		if (coalesce(nr_seq_lote_p,0) > 0) then
			select	cd_cgc_fornec
			into STRICT	cd_fornec_lote_w
			from	material_lote_fornec
			where	nr_sequencia = nr_seq_lote_p;
		end if;

		select	coalesce(count(distinct(cd_cgc_fornecedor)),0)
		into STRICT	qt_fornecedor_w
		from	material_atend_paciente
		where	nr_atendimento	= nr_atendimento_p
		and	coalesce(cd_material_exec, cd_material) = cd_material_p
		and	cd_acao		= 1
		and	cd_local_estoque	= cd_local_estoque_p
		and	dt_atendimento	> dt_mesano_referencia_p - 60;

		if (qt_fornecedor_w = 0) then
			ds_observacao_p	:= substr(wheb_mensagem_pck.get_texto(308658,'DS_MATERIAL_W='||ds_material_w),1,255);
		elsif (qt_fornecedor_w > 1) then
			if (cd_fornec_lote_w IS NOT NULL AND cd_fornec_lote_w::text <> '') then
				select	coalesce(count(distinct(cd_cgc_fornecedor)),0)
				into STRICT	qt_fornecedor_w
				from	material_atend_paciente
				where	nr_atendimento	= nr_atendimento_p
				and	coalesce(cd_material_exec, cd_material) = cd_material_p
				and	cd_acao		= 1
				and	cd_local_estoque	= cd_local_estoque_p
				and	dt_atendimento	> dt_mesano_referencia_p - 60
				and	cd_cgc_fornecedor = cd_fornec_lote_w;
			end if;

			if (qt_fornecedor_w <> 1) then
				ds_observacao_p	:= substr(wheb_mensagem_pck.get_texto(308659,'DS_MATERIAL_W='||ds_material_w),1,255);
			else
				cd_cgc_fornecedor_p := cd_fornec_lote_w;
			end if;
		elsif (qt_fornecedor_w = 1) then
			begin
			select	max(cd_cgc_fornecedor)
			into STRICT	cd_cgc_fornecedor_p
			from	material_atend_paciente
			where	nr_atendimento	= nr_atendimento_p
			and	coalesce(cd_material_exec, cd_material) = cd_material_p
			and	cd_acao		= 1
			and	cd_local_estoque	= cd_local_estoque_p
			and	dt_atendimento	> dt_mesano_referencia_p - 60;
			end;
		end if;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_fornecedor_consignado ( cd_material_p bigint, dt_mesano_referencia_p timestamp, cd_local_estoque_p bigint, cd_estabelecimento_p bigint, qt_quantidade_p bigint, ie_acao_p text, nr_atendimento_p text, cd_cgc_fornecedor_p INOUT text, ds_observacao_p INOUT text, nr_seq_lote_p bigint) FROM PUBLIC;

