-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_pf_pj_solic_tasy_alt () AS $body$
DECLARE


cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;

c01 CURSOR FOR
	SELECT	ts.nr_sequencia nr_seq_solicitacao,
		max(ta.ds_chave_simples) ds_chave_simples,
		max(ta.ds_chave_composta) ds_chave_composta
	from	tasy_solic_alteracao	ts,
		tasy_solic_alt_campo	ta
	where	ts.nr_sequencia		= ta.nr_seq_solicitacao
	and	ts.ie_tipo_solicitacao	= 'P'
	and	coalesce(ts.cd_pessoa_fisica::text, '') = ''
	and	coalesce(ts.cd_cgc::text, '') = ''
	group by ts.nr_sequencia;

BEGIN
for r_c01_w in c01 loop
	cd_pessoa_fisica_w	:= null;
	cd_cgc_w		:= null;

	-- Pega Pessoa Física se for prestador
	begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	pls_prestador	c
	where	(r_c01_w.ds_chave_simples	= c.cd_pessoa_fisica
	or	substr(r_c01_w.ds_chave_composta,1,length(r_c01_w.ds_chave_composta)-1) = ('CD_PESSOA_FISICA=' || c.cd_pessoa_fisica || '#@#@IE_TIPO_COMPLEMENTO=')
	or	r_c01_w.ds_chave_composta	= 'CD_PESSOA_FISICA=' || c.cd_pessoa_fisica
	or	r_c01_w.ds_chave_composta	= 'CD_PESSOA_FISICA=' || q'{'}' || c.cd_pessoa_fisica ||  q'{'}' ) --Formato portal
  LIMIT 1;
	exception
	when no_data_found then
		cd_pessoa_fisica_w	:= null;
	end;

	--Pega Pessoa Jurídica se for prestador
	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		begin
		select	cd_cgc
		into STRICT	cd_cgc_w
		from	pls_prestador	c
		where	(r_c01_w.ds_chave_simples        = c.cd_cgc
		or	substr(r_c01_w.ds_chave_composta,1,length(r_c01_w.ds_chave_composta)-1) = ('CD_CGC=' || c.cd_cgc || '#@#@IE_TIPO_COMPLEMENTO=')
		or	r_c01_w.ds_chave_composta     = 'CD_CGC=' || c.cd_cgc
		or	r_c01_w.ds_chave_composta     = 'CD_CGC=' || q'{'}' || c.cd_cgc || q'{'}') --Formato portal
  LIMIT 1;
		exception
		when no_data_found then
			cd_cgc_w	:= null;
		end;
	end if;

	-- Pega Pessoa Física se não for mais prestador
	if (coalesce(cd_cgc_w::text, '') = '') and (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		begin
		select	cd_pessoa_fisica
		into STRICT	cd_pessoa_fisica_w
		from	pessoa_fisica	c
		where	(r_c01_w.ds_chave_simples	= c.cd_pessoa_fisica
		or	substr(r_c01_w.ds_chave_composta,1,length(r_c01_w.ds_chave_composta)-1) = ('CD_PESSOA_FISICA=' || c.cd_pessoa_fisica || '#@#@IE_TIPO_COMPLEMENTO=')
		or	r_c01_w.ds_chave_composta	= 'CD_PESSOA_FISICA=' || c.cd_pessoa_fisica
		or	r_c01_w.ds_chave_composta	= 'CD_PESSOA_FISICA=' || q'{'}' || c.cd_pessoa_fisica ||  q'{'}' ) --Formato portal
  LIMIT 1;
		exception
		when no_data_found then
			cd_pessoa_fisica_w	:= null;
		end;
	end if;

	--Pega Pessoa Jurídica se não for mais prestador
	if (coalesce(cd_cgc_w::text, '') = '') and (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		begin
		select	cd_cgc
		into STRICT	cd_cgc_w
		from	pessoa_juridica	c
		where	(r_c01_w.ds_chave_simples        = c.cd_cgc
		or	substr(r_c01_w.ds_chave_composta,1,length(r_c01_w.ds_chave_composta)-1) = ('CD_CGC=' || c.cd_cgc || '#@#@IE_TIPO_COMPLEMENTO=')
		or	r_c01_w.ds_chave_composta     = 'CD_CGC=' || c.cd_cgc
		or	r_c01_w.ds_chave_composta     = 'CD_CGC=' || q'{'}' || c.cd_cgc || q'{'}') --Formato portal
  LIMIT 1;
		exception
		when no_data_found then
			cd_cgc_w	:= null;
		end;
	end if;

	-- Atualizar os dados do prestador solicitante
	update	tasy_solic_alteracao
	set	cd_pessoa_fisica	= cd_pessoa_fisica_w,
		cd_cgc			= cd_cgc_w
	where	nr_sequencia		= r_c01_w.nr_seq_solicitacao
	and	ie_tipo_solicitacao	= 'P';
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_pf_pj_solic_tasy_alt () FROM PUBLIC;

