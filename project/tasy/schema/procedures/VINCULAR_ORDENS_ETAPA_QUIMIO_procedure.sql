-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_ordens_etapa_quimio ( nr_seq_etapa_prod_p bigint, nr_seq_ordem_etapa_lista_p text, dt_etapa_p timestamp, ie_data_maior_p text, nr_hora_p bigint, ie_via_aplicacao_p text, ie_conferido_p text, cd_pessoa_fisica_p text, cd_setor_paciente_p bigint, ie_opcao_p text, etapa_prontuario_p text, ie_permite_suspenso_p text, nr_seq_regra_p bigint, ie_filtro_adic_p text) AS $body$
DECLARE


/*	ie_opcao_p
	V - vincular
	D - desvincular
	DT - desvincular todas
	*/
ds_sql_w		varchar(4000);
ds_parametros_w	varchar(2000);
ds_sep_bv_w	varchar(10);
nr_hora_w		smallint;
nr_seq_lista_w	varchar(4000);
cd_estabelecimento_w smallint;
cd_estab_destino_w	smallint;
nr_sequencia_w bigint;


C01 CURSOR FOR
SELECT a.nr_sequencia
FROM   can_ordem_item_prescr b, 
       can_ordem_prod a 
WHERE  coalesce(a.nr_seq_etapa_prod::text, '') = '' 
       AND coalesce(a.dt_inicio_preparo::text, '') = '' 
       AND a.nr_sequencia = b.nr_seq_ordem 
       AND a.ie_cancelada = 'N' 
       AND ( ( a.ie_suspensa = 'N' ) 
              OR ( ( coalesce('N', ie_permite_suspenso_p) = 'S' ) 
                   AND ( a.ie_suspensa = 'S' ) ) ) 
       AND ( ( Trunc(a.dt_prevista) = Trunc(dt_etapa_p) ) 
              OR ( ( coalesce('N',ie_data_maior_p) = 'S' ) 
                   AND ( Trunc(a.dt_prevista) > dt_etapa_p) ) ) 
	   AND a.ie_conferido = ie_conferido_p
		and ((a.cd_estabelecimento = cd_estabelecimento_w) or (cd_estab_destino_w IS NOT NULL AND cd_estab_destino_w::text <> ''))
		and  coalesce(a.ie_via_aplicacao,'') = coalesce(ie_via_aplicacao_p,coalesce(a.ie_via_aplicacao,''))
		and  coalesce(a.ie_conferido,'') = coalesce(ie_conferido_p,coalesce(a.ie_conferido,''))
		and  coalesce(a.cd_pessoa_fisica,'') = coalesce(cd_pessoa_fisica_p,coalesce(a.cd_pessoa_fisica,''))
		and  coalesce(a.cd_setor_paciente,'') = coalesce(cd_setor_paciente_p,coalesce(a.cd_setor_paciente,''))
		and  coalesce(obter_prontuario_paciente(a.cd_pessoa_fisica) ,'') = coalesce(etapa_prontuario_p,coalesce(obter_prontuario_paciente(a.cd_pessoa_fisica) ,''))
		and ((obter_se_regra_ordem(a.cd_estabelecimento,a.dt_prevista,nr_seq_regra_p) = 'S') or (coalesce(nr_seq_regra_p::text, '') = '')) 
		and  (( to_char(a.dt_prevista, 'hh24') = nr_hora_w) or (coalesce(nr_hora_p::text, '') = ''));

BEGIN
select max(cd_estabelecimento),
	   max(cd_estab_destino)
into STRICT   cd_estabelecimento_w,
	   cd_estab_destino_w
from   far_etapa_producao
where nr_sequencia = nr_seq_etapa_prod_p;


if (ie_opcao_p = 'V') then
	begin	
	if (nr_hora_p IS NOT NULL AND nr_hora_p::text <> '') then
		begin
		if (length(nr_hora_p) = 1) then
			nr_hora_w	:= '0' || nr_hora_p;
		elsif (nr_hora_p = 24) then
			nr_hora_w	:= '00';
		else
			nr_hora_w	:= nr_hora_p;
		end if;
		end;
	end if;

	
						
		OPEN C01;
		LOOP
		FETCH C01 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
					update	can_ordem_prod
					set	nr_seq_etapa_prod = nr_seq_etapa_prod_p
					where	nr_sequencia = nr_sequencia_w;
					commit;
			end;
		END LOOP;
		Close C01;
	
	

	end;
	

elsif (ie_opcao_p = 'D') then
	begin
	update	can_ordem_prod
	set	nr_seq_etapa_prod	 = NULL
	where	substr(obter_se_contido(nr_sequencia, nr_seq_ordem_etapa_lista_p), 1,1) = 'S'
	and	coalesce(dt_inicio_preparo::text, '') = '';
	end;

elsif (ie_opcao_p = 'DT') then
	begin
	update	can_ordem_prod
	set	nr_seq_etapa_prod	 = NULL
	where	nr_seq_etapa_prod	= nr_seq_etapa_prod_p
	and	coalesce(dt_inicio_preparo::text, '') = '';
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_ordens_etapa_quimio ( nr_seq_etapa_prod_p bigint, nr_seq_ordem_etapa_lista_p text, dt_etapa_p timestamp, ie_data_maior_p text, nr_hora_p bigint, ie_via_aplicacao_p text, ie_conferido_p text, cd_pessoa_fisica_p text, cd_setor_paciente_p bigint, ie_opcao_p text, etapa_prontuario_p text, ie_permite_suspenso_p text, nr_seq_regra_p bigint, ie_filtro_adic_p text) FROM PUBLIC;

