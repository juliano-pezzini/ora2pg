-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_ds_horario_enfermagem_md (ds_horarios_p INOUT text, ds_hora_p INOUT text, qt_dia_adic_p INOUT bigint, dt_inicio_medic_p timestamp, dt_horario_p INOUT timestamp, dt_prescricao_p timestamp, ds_tipo_p text, ds_retorno_p INOUT text, ie_exit_p INOUT text) AS $body$
DECLARE


ds_mensagem_w varchar(5000);
k        bigint;


BEGIN

      ie_exit_p := 'N';

      if (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
        k:= position(' ' in ds_horarios_p);

        if (k > 1) and ((substr(ds_horarios_p, 1, k -1) IS NOT NULL AND (substr(ds_horarios_p, 1, k -1))::text <> '')) then
          ds_hora_p    := substr(ds_horarios_p, 1, k-1);
          ds_hora_p    := replace(ds_hora_p, ' ','');
          ds_horarios_p    := substr(ds_horarios_p, k + 1, 2000);
        elsif (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '') then
          ds_hora_p     := replace(ds_horarios_p,' ','');
          ds_horarios_p  := '';
        end if;

        if (position('A' in ds_hora_p) > 0) then
          qt_dia_adic_p  := 1;
        end if;
        if (position('AA' in ds_hora_p) > 0) then
          qt_dia_adic_p  := coalesce(qt_dia_adic_p, 0) + 1;
        end if;

        ds_hora_p  := replace(ds_hora_p,'A','');
        ds_hora_p  := replace(ds_hora_p,'A','');

        if (coalesce(dt_inicio_medic_p::text, '') = '') then
          dt_horario_p  := pkg_date_utils.get_DateTime(dt_prescricao_p + coalesce(qt_dia_adic_p,0), pkg_date_utils.get_time(replace(ds_hora_p || ':00','A','')));

          if (dt_horario_p < dt_prescricao_p) then
            dt_horario_p  := dt_horario_p + 1;
          end if;

        else
          dt_horario_p  := pkg_date_utils.get_DateTime(dt_inicio_medic_p, pkg_date_utils.get_time(replace(ds_hora_p || ':00','A','')));
        end if;

        if (dt_horario_p  < clock_timestamp()) then
          if (ds_tipo_p = 'M') then
            ds_mensagem_w := substr(obter_texto_tasy(235186,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
          elsif (ds_tipo_p = 'S') then
            ds_mensagem_w := substr(obter_texto_tasy(286017,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
          elsif (ds_tipo_p = 'P') then
            ds_mensagem_w := substr(obter_texto_tasy(286020,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
          elsif (ds_tipo_p = 'SNE') then
            ds_mensagem_w := substr(obter_texto_tasy(286021,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
          elsif (ds_tipo_p = 'A') then
            ds_mensagem_w := substr(obter_texto_tasy(290498,wheb_usuario_pck.get_nr_seq_idioma), 1, 255);
          end if;

          ds_retorno_p :=  substr(obter_texto_dic_objeto(285977, wheb_usuario_pck.get_nr_seq_idioma, 'DS_MENSAGEM_W='||ds_mensagem_w), 1, 400);
          ie_exit_p := 'S';

        end if;

			end if;

      end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_ds_horario_enfermagem_md (ds_horarios_p INOUT text, ds_hora_p INOUT text, qt_dia_adic_p INOUT bigint, dt_inicio_medic_p timestamp, dt_horario_p INOUT timestamp, dt_prescricao_p timestamp, ds_tipo_p text, ds_retorno_p INOUT text, ie_exit_p INOUT text) FROM PUBLIC;

