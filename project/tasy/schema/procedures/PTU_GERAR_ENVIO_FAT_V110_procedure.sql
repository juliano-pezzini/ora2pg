-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_envio_fat_v110 ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_arquivo_w			text;
ds_hash_w			ptu_fatura.ds_hash%type;
					
-- 501
vl_total_fatura_w		varchar(14);
vl_ir_w				varchar(14);
nr_fatura_w			ptu_fatura.nr_fatura%type;
dt_geracao_w			varchar(8);
dt_venc_fatura_w		varchar(8);
dt_emissao_fatura_w		varchar(8);
cd_unimed_destino_w		varchar(4);
cd_unimed_origem_w		varchar(4);
nr_competencia_w		varchar(4);
ie_classif_cobranca_w		varchar(1);
nr_nota_credito_debito_w	varchar(30);
dt_vencimento_ndc_w		varchar(8);
dt_emissao_ndc_w		varchar(8);
vl_total_ndc_w			varchar(14);
ie_tipo_documento_1_w		varchar(1);
ie_tipo_documento_2_w		varchar(1);
doc_fiscal_1_w			ptu_fatura.doc_fiscal_1%type;
doc_fiscal_2_w			ptu_fatura.doc_fiscal_2%type;

-- 502
nm_beneficiario_w		varchar(25);
dt_atendimento_w		varchar(21);
cd_usuario_plano_w		varchar(13);
nr_nota_w			ptu_nota_cobranca.nr_nota%type;
nr_guia_principal_w		varchar(20);
nr_lote_w			varchar(8);
cd_cid_w			varchar(6);
cd_unimed_w			varchar(4);
ie_tipo_atendimento_w		varchar(2);
cd_excecao_w			varchar(1);
ie_carater_atendimento_w	varchar(1);
tp_consulta_w			varchar(1);
ie_paciente_w			varchar(1);
ie_tipo_saida_spdat_w		varchar(1);
dt_internacao_502_w		varchar(21);
dt_alta_502_w			varchar(21);
dt_ultima_autoriz_w		varchar(8);
tp_nota_w			varchar(1);
id_nota_principal_w		varchar(1);
nr_ver_tiss_w			varchar(7);
nr_guia_tiss_prestador_w	varchar(20);
nr_guia_tiss_principal_w	varchar(20);
nr_guia_tiss_operadora_w	varchar(20);
tp_ind_acidente_w		varchar(1);
motivo_encerram_w		varchar(2);
nr_cnpj_cpf_req_w		varchar(14);
nm_prest_req_w			varchar(60);
sg_cons_prof_req_502_w		varchar(12);
nr_cons_prof_req_502_w		varchar(15);
sg_uf_cons_req_502_w		varchar(2);
nr_cbo_req_w			varchar(6);
nr_fatura_glosada_w		ptu_nota_cobranca.nr_fatura_glosada%type;
nr_ndr_glosada_w		ptu_nota_cobranca.nr_ndr_glosada%type;
nr_lote_glosado_w		varchar(8);
nr_nota_glosada_w		varchar(20);
dt_protocolo_w			varchar(8);
id_rn_w				varchar(1);
tp_pessoa_w			varchar(1);
nr_cnpj_cpf_w			varchar(14);
cd_cnes_cont_exec_w		varchar(7);
cd_munic_cont_exec_w		varchar(7);
id_liminar_w			varchar(1);
tipo_rede_min_w			varchar(1);

nm_prest_exec_w			ptu_nota_cobranca.nm_prest_exec%type;
id_aviso_w			ptu_nota_cobranca.id_aviso%type;
id_continuado_w			ptu_nota_cobranca.id_continuado%type;
nr_lote_prest_w			ptu_nota_cobranca.nr_lote_prest%type;
dt_conhecimento_w		varchar(8);
tp_prest_exec_w			ptu_nota_cobranca.tp_prest_exec%type;
cd_cid_obito_cobr_w		ptu_nota_cobranca.cd_cid_obito%type;
id_rec_proprio_w		ptu_nota_cobranca.id_rec_proprio%type;

-- 503
nm_hospital_w			varchar(60);
dt_internacao_w			varchar(21);
dt_alta_w			varchar(21);
nr_declara_obito_w		varchar(17);
nr_declara_obito_0_w		varchar(17);
nr_declara_obito_1_w		varchar(17);
nr_declara_obito_2_w		varchar(17);
nr_declara_obito_3_w		varchar(17);
nr_declara_obito_4_w		varchar(17);
nr_declara_obito_5_w		varchar(17);
nr_declara_vivo_0_w		varchar(17);
nr_declara_vivo_1_w		varchar(15);
nr_declara_vivo_2_w		varchar(15);
nr_declara_vivo_3_w		varchar(15);
nr_declara_vivo_4_w		varchar(15);
nr_declara_vivo_5_w		varchar(15);
cd_cgc_hospital_w		varchar(14);
nr_nota_503_w			ptu_nota_hospitalar.nr_nota%type;
nr_lote_503_w			varchar(8);
cd_hospital_w			varchar(8);
cd_cid_obito_w			varchar(6);
cd_cid_obito_0_w		varchar(6);
cd_cid_obito_1_w		varchar(6);
cd_cid_obito_2_w		varchar(6);
cd_cid_obito_3_w		varchar(6);
cd_cid_obito_4_w		varchar(6);
cd_cid_obito_5_w		varchar(6);
cd_unimed_hospital_w		varchar(4);
tx_mult_amb_w			varchar(4);
ie_tipo_acomodacao_w		varchar(2);
cd_motivo_saida_w		varchar(2);
qt_nasc_vivos_w			varchar(2);
qt_nasc_mortos_w		varchar(2);
qt_nasc_vivos_pre_w		varchar(2);
qt_obito_precoce_w		varchar(2);
qt_obito_tardio_w		varchar(2);
ie_ind_acidente_w		varchar(1);
ie_tipo_internacao_w		varchar(1);
ie_int_gestacao_w		varchar(1);
ie_int_aborto_w			varchar(1);
ie_int_transtorno_w		varchar(1);
ie_int_puerperio_w		varchar(1);
ie_int_recem_nascido_w		varchar(1);
ie_int_neonatal_w		varchar(1);
ie_int_baixo_peso_w		varchar(1);
ie_int_parto_cesarea_w		varchar(1);
ie_int_parto_normal_w		varchar(1);
ie_faturamento_w		varchar(1);
ie_obito_mulher_w		varchar(1);
reg_internacao_w		varchar(1);
nm_medico_auditor_w		ptu_nota_hospitalar.nm_medico_auditor%type;
nr_crm_auditor_w		ptu_nota_hospitalar.nr_crm_auditor%type;
nm_enfer_auditor_w		ptu_nota_hospitalar.nm_enfer_auditor%type;
nr_coren_auditor_w		ptu_nota_hospitalar.nr_coren_auditor%type;
cd_uf_crm_w			ptu_nota_hospitalar.cd_uf_crm%type;
cd_uf_coren_w			ptu_nota_hospitalar.cd_uf_coren%type;

-- 504
ds_servico_w			varchar(80);
nm_prestador_w			varchar(60);
nm_profissional_prestador_w	varchar(60);
nm_prestador_requisitante_w	varchar(40);
nr_gui_tiss_w			varchar(20);
nr_cons_prof_prest_w		varchar(15);
nr_cons_prof_req_w		varchar(15);
vl_procedimento_w		varchar(14);
vl_custo_operacional_w		varchar(14);
vl_filme_w			varchar(14);
vl_adic_procedimento_w		varchar(14);
vl_adic_co_w			varchar(14);
vl_adic_filme_w			varchar(14);
nr_cgc_cpf_w			varchar(14);
nr_cgc_cpf_req_w		varchar(14);
vl_pago_prest_w			varchar(14);
sg_cons_prof_prest_w		varchar(12);
sg_cons_prof_req_w		varchar(12);
nr_nota_504_w			ptu_nota_servico.nr_nota%type;
nr_seq_nota_w			varchar(11);
nr_autorizacao_w		varchar(10);
nr_lote_504_w			varchar(8);
cd_prestador_w			varchar(8);
dt_procedimento_w		varchar(8);
cd_procedimento_w		varchar(8);
qt_procedimento_w		varchar(8);
cd_prestador_req_w		varchar(8);
ds_hora_procedimento_w		varchar(8);
cd_pacote_w			varchar(8);
cd_cnes_prest_w			varchar(7);
cd_unimed_prestador_w		varchar(4);
cd_unimed_autorizadora_w	varchar(4);
cd_unimed_pre_req_w		varchar(4);
tx_procedimento_w		varchar(3);
ie_via_acesso_w			varchar(2);
cd_especialidade_w		varchar(2);
ie_tipo_prestador_w		varchar(2);
sg_uf_cons_prest_w		varchar(2);
sg_uf_cons_req_w		varchar(2);
ie_tipo_participacao_w		varchar(1);
ie_tipo_tabela_w		varchar(1);
cd_porte_anestesico_w		varchar(1);
ie_rede_propria_w		varchar(1);
ie_tipo_pessoa_prestador_w	varchar(1);
ie_pacote_w			varchar(1);
cd_ato_w			varchar(1);
ie_reembolso_w			varchar(1);
tp_autoriz_w			varchar(1);
ie_prestador_alto_custo_w	varchar(1);
cd_especialidade_ptu_w		smallint;
hr_final_w			varchar(8);
id_acres_urg_emer_w		varchar(1);
nr_cbo_exec_w			varchar(6);
tec_utilizada_w			varchar(1);
dt_autoriz_w			varchar(8);
dt_solicitacao_w		varchar(8);
unidade_medida_w		varchar(3);
nr_reg_anvisa_w			varchar(15);
cd_munic_w			varchar(7);
cd_ref_material_fab_w		varchar(60);
dt_pgto_prestador_w		varchar(8);
nr_cnpj_fornecedor_w		varchar(14);
cd_rec_prestador_w		varchar(10);
id_pag_forn_w			ptu_nota_servico.id_pag_forn%type;
nm_fornecedor_w			ptu_nota_servico.nm_fornecedor%type;
det_reg_anvisa_w		ptu_nota_servico.det_reg_anvisa%type;
nr_nota_fiscal_forn_w		ptu_nota_servico.nr_nota_fiscal_forn%type;
id_aviso_item_w			ptu_nota_servico.id_aviso_item%type;

-- 505
ds_complemento_w		varchar(100);
nr_nota_505_w			ptu_nota_complemento.nr_nota%type;
nr_lote_505_w			varchar(8);
ie_tipo_complemento_w		varchar(1);
especif_material_w		varchar(500);
ds_complemento_w2		ptu_nota_complemento.ds_complemento%type;

-- 506
nr_nota_fiscal_w		ptu_nota_fiscal.nr_nota_fiscal%type;
ds_link_nfe_w			ptu_nota_fiscal.ds_link_nfe%type;
nr_nota_fiscal_doc2_w		ptu_nota_fiscal.nr_nota_fiscal_doc2%type;
ds_link_nfe_doc2_w		ptu_nota_fiscal.ds_link_nfe_doc2%type;

--508
cd_cnes_w			ptu_nota_cobranca_rrs.cd_cnes%type;
vl_pago_benef_w			ptu_nota_servico_rrs.vl_pago_benef%type;

-- 509
vl_total_serv_w			varchar(14);
qt_total_serv_w			varchar(11);
qt_total_r502_w			varchar(5);
qt_total_r503_w			varchar(5);
qt_total_r504_w			varchar(5);
qt_total_r505_w			varchar(5);
qt_total_r507_w			varchar(5);
qt_total_r508_w			varchar(5);
qt_nota_exec_w			varchar(5);

-- 510
nm_cedente_sacado_w		varchar(60);
ds_endereco_w			varchar(40);
ds_bairro_w			varchar(30);
nm_cidade_w			varchar(30);
ds_complemento_r510_w		varchar(20);
nr_inscricao_estadual_w		varchar(20);
cd_cgc_cpf_w			varchar(14);
cd_ans_w			varchar(10);
cd_cep_w			varchar(8);
nr_telefone_w			varchar(9);
nr_fax_w			varchar(9);
nr_end_w			varchar(6);
nr_ddd_w			varchar(4);
sg_uf_w				varchar(2);
ie_tipo_w			varchar(1);

-- 511
ds_linha_w			varchar(74);
vl_item_w			varchar(14);
nr_linha_w			varchar(2);
ie_documento_w			varchar(1);

-- 512
ds_local_pagamento_w		varchar(60);
ds_obs_local_pagto_w		varchar(60);
cd_agencia_cedente_w		varchar(25);
cd_nosso_numero_w		varchar(20);
ds_obs_banco_w			varchar(15);
vl_documento_w			varchar(14);
ds_carteira_w			varchar(10);
dt_documento_w			varchar(8);
cd_especie_doc_w		varchar(5);
dt_processamento_w		varchar(8);
cd_banc_w			varchar(5);
ds_especie_w			varchar(4);
ie_aceite_w			varchar(2);
tp_boleto_w			varchar(1);

-- 513
ds_instrucao_w			varchar(60);

-- 514
ds_observacao_w			varchar(60);

-- 515
ds_linha_digitavel_w		varchar(60);
cd_barras_w			varchar(44);

ds_conteudo_w			varchar(4000);
nr_seq_registro_w		bigint	:= 0;
qt_registro_w			bigint	:= 0;
nr_seq_nota_cobranca_w		bigint;
nr_seq_ptu_fatura_w		bigint;
nr_seq_nota_servico_w		bigint;
vl_total_adic_w			varchar(14);

ds_meridiano_w			varchar(3);
cd_cooperativa_w		varchar(4);
cd_cgc_w			varchar(14);
sg_estado_w			pessoa_juridica.sg_estado%type;

C00 CURSOR FOR
	SELECT	lpad(coalesce(cd_unimed_destino,'0'),4,'0'),
		lpad(coalesce(cd_unimed_origem,'0'),4,'0'),
		to_char(dt_geracao,'yyyymmdd'),
		lpad(coalesce(nr_competencia,'0'),4,'0'),
		rpad(coalesce(nr_fatura,' '),20,' '),
		to_char(dt_vencimento_fatura,'yyyymmdd'),
		to_char(dt_emissao_fatura,'yyyymmdd'),
		lpad(coalesce(replace(replace(campo_mascara(vl_total_fatura,2),',',''),'.',''),'0'),14,'0') vl_total_fatura,
		lpad(coalesce(replace(replace(campo_mascara(vl_ir,2),',',''),'.',''),'0'),14,'0') vl_ir,
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '502'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '503'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '504'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '505'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, 'qt_nota'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, 'qt_serv')*10000,'0'),11,'0'),
		lpad(coalesce(replace(replace(campo_mascara(vl_total_taxa,2),',',''),'.',''),'0'),14,'0'),
		coalesce(ie_classif_cobranca,'2'),
		rpad(coalesce(nr_nota_credito_debito,' '),20,' '),
		lpad(coalesce(to_char(dt_vencimento_ndc,'yyyymmdd'),' '),8,' '),
		lpad(coalesce(to_char(dt_emissao_ndc,'yyyymmdd'),' '),8,' '),
		lpad(coalesce(replace(replace(campo_mascara(vl_total_ndc,2),',',''),'.',''),'0'),14,'0'),
		nr_sequencia,
		rpad(coalesce(doc_fiscal_1,' '),20,' '),
		rpad(coalesce(doc_fiscal_2,' '),20,' '),
		coalesce(tp_documento_1,'1'),
		coalesce(tp_documento_2,'1'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '507'),'0'),5,'0'),
		lpad(coalesce(obter_qt_registro_ptu_fatura(nr_sequencia, '508'),'0'),5,'0')
	from	ptu_fatura
	where	nr_sequencia	= nr_seq_fatura_p;

C01 CURSOR FOR
	SELECT	lpad(coalesce(elimina_caractere_especial(to_char(nr_lote)),'0'),8,'0'),
		rpad(coalesce(substr(elimina_caractere_especial(to_char(nr_nota)),1,20),' '),20,' '),
		lpad(coalesce(cd_unimed,'0'),4,'0'),
		lpad(coalesce(cd_usuario_plano,'0'),13,'0'),
		rpad(substr(coalesce(ptu_somente_caracter_permitido(nm_beneficiario,'ANS'),' '),1,25),25,' '),
		rpad(coalesce(to_char(dt_atendimento,'yyyy/mm/ddhh24:mi:ss') || ds_meridiano_w,' '),21,' '),
		rpad(coalesce(to_char(cd_excecao),' '),1,' '),
		rpad(coalesce(to_char(ie_carater_atendimento),' '),1,' '),
		rpad(coalesce(to_char(cd_cid),' '),6,' '),
		rpad(coalesce(ie_paciente,' '),1,' '),
		rpad(coalesce(ie_tipo_saida_spdat,' '),1,' '),
		lpad(coalesce(ie_tipo_atendimento,'  '),2,'0'),
		rpad(CASE WHEN id_nota_principal='S' THEN CASE WHEN somente_numero(ie_tipo_atendimento)='7' THEN to_char(nr_guia_principal)  ELSE null END   ELSE to_char(nr_guia_principal) END ,20,' '),
		nr_sequencia,
		rpad(coalesce(to_char(dt_internacao,'yyyy/mm/ddhh24:mi:ss') || CASE WHEN coalesce(dt_internacao::text, '') = '' THEN ' '  ELSE ds_meridiano_w END ,' '),21,' '),
		rpad(coalesce(to_char(dt_alta,'yyyy/mm/ddhh24:mi:ss') || CASE WHEN coalesce(dt_alta::text, '') = '' THEN ' '  ELSE ds_meridiano_w END ,' '),21,' '),		
		rpad(coalesce(to_char(dt_ultima_autoriz,'yyyymmdd'),' '),8,' '),
		coalesce(tp_nota,'0'),
		rpad(coalesce(id_nota_principal,'N'),1,' '),
		rpad(coalesce(nr_ver_tiss,' '),7,' '),
		rpad(coalesce(nr_guia_tiss_prestador,' '),20,' '),
		rpad(coalesce(nr_guia_tiss_principal,' '),20,' '),
		rpad(coalesce(nr_guia_tiss_operadora,' '),20,' '),
		rpad(coalesce(tp_ind_acidente,' '),1,' '),
		rpad(coalesce(motivo_encerram,' '),2,' '),
		lpad(coalesce(nr_cnpj_cpf_req,'0'),14,'0'),
		rpad(coalesce(nm_prest_req,' '),60,' '),
		rpad(coalesce(sg_cons_prof_req,' '),12,' '),
		rpad(coalesce(nr_cons_prof_req,' '),15,' '),
		rpad(coalesce(sg_uf_cons_req,' '),2,' '),
		lpad(coalesce(nr_cbo_req,'0'),6,'0'),
		rpad(coalesce(nr_fatura_glosada,' '),20,' '),
		rpad(coalesce(nr_ndr_glosada,' '),20,' '),
		lpad(coalesce(nr_lote_glosado,'0'),8,'0'),
		rpad(coalesce(nr_nota_glosada,' '),20,' '),
		rpad(coalesce(to_char(dt_protocolo,'yyyymmdd'),' '),8,' '),
		rpad(coalesce(id_rn,'N'),1,' '),
		rpad(coalesce(to_char(tp_consulta),' '),1,' '),
		coalesce(to_char(id_liminar),' '),
		coalesce(to_char(tp_pessoa),' '),
		lpad(coalesce(nr_cnpj_cpf,'0'),14,'0'),
		rpad(coalesce(cd_cnes_cont_exec,' '),7,' '),
		lpad(coalesce(cd_munic_cont_exec,'0') || coalesce(Calcula_Digito('MODULO10',coalesce(cd_munic_cont_exec,'0')),'0'),7,'0'),
		coalesce(tipo_rede_min,'0'),
		rpad(coalesce(nm_prest_exec,' '),60,' '),
		coalesce(id_aviso,' '),
		coalesce(id_continuado,' '),
		rpad(coalesce(nr_lote_prest,' '),12,' '),
		rpad(coalesce(to_char(dt_conhecimento,'yyyymmdd'),' '),8,' '),
		lpad(coalesce(tp_prest_exec,'0'),2,'0'),
		rpad(coalesce(cd_cid_obito,' '),6,' '),
		rpad(coalesce(to_char(id_rec_proprio),' '),1,' ')
	from	ptu_nota_cobranca
	where	nr_seq_fatura	= nr_seq_ptu_fatura_w;

C02 CURSOR FOR
	SELECT	lpad(elimina_caractere_especial(a.nr_lote),8,'0') nr_lote_503,
		rpad(coalesce(substr(elimina_caractere_especial(to_char(a.nr_nota)),1,20),' '),20,' ') nr_nota_503,
		lpad(coalesce(a.cd_unimed_hospital,'0'),4,'0'),
		lpad(coalesce(a.cd_hospital,'0'),8,'0'),
		rpad(coalesce(a.nm_hospital,' '),60,' '),
		rpad(coalesce(a.ie_tipo_acomodacao,' '),2,' '),
		rpad(coalesce(to_char(a.dt_internacao,'yyyy/mm/ddhh24:mi:ss') || CASE WHEN coalesce(a.dt_internacao::text, '') = '' THEN ' '  ELSE ds_meridiano_w END ,' '),21,' '),
		rpad(coalesce(to_char(a.dt_alta,'yyyy/mm/ddhh24:mi:ss') || CASE WHEN coalesce(a.dt_alta::text, '') = '' THEN ' '  ELSE ds_meridiano_w END ,' '),21,' '),
		lpad(replace(replace(campo_mascara(coalesce(a.tx_mult_amb,0),2),',',''),'.',''),4,'0'),
		lpad(coalesce(a.ie_ind_acidente,' '),1,' '),
		rpad(coalesce(a.cd_motivo_saida,' '),2,' '),
		lpad(coalesce(a.cd_cgc_hospital,' '),14,' '),
		coalesce(a.ie_tipo_internacao,'0'),
		lpad(coalesce(a.qt_nasc_vivos,'0'),2,'0'),
		lpad(coalesce(a.qt_nasc_mortos,'0'),2,'0'),
		lpad(coalesce(a.qt_nasc_vivos_pre,'0'),2,'0'),
		lpad(coalesce(a.qt_obito_precoce,'0'),1,'0'),
		lpad(coalesce(a.qt_obito_tardio,'0'),1,'0'),
		lpad(coalesce(a.ie_int_gestacao,'N'),1,' '),
		lpad(coalesce(a.ie_int_aborto,'N'),1,' '),
		lpad(coalesce(a.ie_int_transtorno,'N'),1,' '),
		lpad(coalesce(a.ie_int_puerperio,'N'),1,' '),
		lpad(coalesce(a.ie_int_recem_nascido,'N'),1,' '),
		lpad(coalesce(a.ie_int_neonatal,'N'),1,' '),
		lpad(coalesce(a.ie_int_baixo_peso,'N'),1,' '),
		lpad(coalesce(a.ie_int_parto_cesarea,'N'),1,' '),
		lpad(coalesce(a.ie_int_parto_normal,'N'),1,' '),
		to_char(coalesce(a.ie_faturamento,'1')),
		coalesce(to_char(a.ie_obito_mulher),'0'),
		rpad(coalesce(a.nr_declara_obito,' '),17,' '),
		coalesce(a.reg_internacao,'0'),
		rpad(coalesce(ptu_somente_caracter_permitido(a.nm_medico_auditor, 'ANS'),' '),40,' '),
		rpad(coalesce(a.nr_crm_auditor,' '),15,' '),
		rpad(coalesce(ptu_somente_caracter_permitido(a.nm_enfer_auditor, 'ANS'),' '),40,' '),
		rpad(coalesce(a.nr_coren_auditor,' '),15,' '),
		rpad(coalesce(a.cd_uf_crm,' '),2,' '),
		rpad(coalesce(a.cd_uf_coren,' '),2,' ')
	from	ptu_nota_hospitalar	a,
		ptu_nota_cobranca	c
	where	a.nr_seq_nota_cobr	= c.nr_sequencia
	and	c.nr_sequencia		= nr_seq_nota_cobranca_w;

C03 CURSOR FOR
	SELECT	lpad(coalesce(elimina_caractere_especial(a.nr_lote),'0'),8,'0'),
		rpad(coalesce(substr(elimina_caractere_especial(to_char(a.nr_nota)),1,20),' '),20,' '),
		lpad(coalesce(a.cd_unimed_prestador,'0'),4,'0'),
		coalesce(a.cd_prestador,'0'),
		rpad(coalesce(elimina_caractere_especial(a.nm_prestador),' '),60,' '),
		rpad(coalesce(a.ie_tipo_participacao,' '),1,' '),
		rpad(coalesce(to_char(a.dt_procedimento,'yyyymmdd'),' '),8,' '),
		rpad(coalesce(to_char(a.ie_tipo_tabela),' '),1,' '),
		lpad(coalesce(a.cd_servico,'0'),8,'0'),
		lpad(coalesce(a.qt_procedimento*10000,'0'),8,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_procedimento,2),',',''),'.',''),'0'),14,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_custo_operacional,2),',',''),'.',''),'0'),14,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_filme,2),',',''),'.',''),'0'),14,'0'),
		coalesce(a.cd_porte_anestesico,' '),
		lpad(coalesce(a.cd_unimed_autorizadora,'0'),4,'0'),
		lpad(coalesce(a.cd_unimed_pre_req,'0'),4,'0'),
		lpad(coalesce(a.cd_prestador_req,'0'),8,'0'),
		lpad(coalesce(to_char(a.ie_via_acesso),'0'),2,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_adic_procedimento,2),',',''),'.',''),'0'),14,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_adic_co,2),',',''),'.',''),'0'),14,'0'),
		lpad(coalesce(replace(replace(campo_mascara(a.vl_adic_filme,2),',',''),'.',''),'0'),14,'0'),
		lpad(coalesce(a.cd_especialidade,'0'),2,'0'),
		lpad(coalesce(a.ie_tipo_prestador,'0'),2,'0'),
		rpad(coalesce(to_char(a.ie_rede_propria),' '),1,' '),
		rpad(coalesce(to_char(a.ie_tipo_pessoa_prestador),' '),1,' '),
		lpad(coalesce(a.nr_cgc_cpf,'0'),14,'0'),
		rpad(coalesce(to_char(a.ie_pacote),' '),1,' '),
		rpad(coalesce(to_char(a.cd_ato),' '),1,' '),
		lpad(coalesce(replace(replace(campo_mascara(a.tx_procedimento,2),',',''),'.',''),'0'),3,'0'),
		lpad(coalesce(a.nr_seq_nota,'0'),11,'0'),
		rpad(coalesce(a.ds_hora_procedimento,' '),8,' '),
		rpad(coalesce(a.cd_cnes_prest,' '),7,' '),
		rpad(coalesce(elimina_caractere_especial(a.nm_profissional_prestador),' '),60,' '),
		rpad(coalesce(a.sg_cons_prof_prest,' '),12,' '),
		rpad(coalesce(a.nr_cons_prof_prest,' '),15,' '),
		rpad(coalesce(a.sg_uf_cons_prest,' '),2,' '),
		lpad(coalesce(a.nr_cgc_cpf_req,'0'),14,'0'),
		rpad(coalesce(elimina_caractere_especial(a.nm_prestador_requisitante),' '),40,' '),
		rpad(coalesce(a.sg_cons_prof_req,' '),12,' '),
		rpad(coalesce(a.nr_cons_prof_req,' '),15,' '),
		rpad(coalesce(a.sg_uf_cons_req,' '),2,' '),
		rpad(coalesce(to_char(a.ie_reembolso),' '),1,' '),
		lpad(coalesce(a.nr_autorizacao,'0'),10,'0'),
		lpad(coalesce(replace(replace(campo_mascara(vl_pago_prest,2),',',''),'.',''),'0'),14,'0'),
		a.nr_sequencia,
		lpad(coalesce(to_char(cd_pacote),'0'),8,'0'),
		rpad(coalesce(nr_guia_tiss,' '),20,' '),
		rpad(coalesce(to_char(coalesce(tp_autoriz,1)),' '),1,' '),
		rpad(to_char(coalesce(ptu_somente_caracter_permitido(elimina_caractere_especial(ds_servico),'ANS'),' ')),80,' '),
		rpad(coalesce(a.hr_final,' '),8,' '),
		coalesce(a.id_acres_urg_emer,'N'),
		lpad(coalesce(a.nr_cbo_exec,'0'),6,'0'),
		coalesce(a.tec_utilizada,'0'),
		rpad(coalesce(to_char(a.dt_autoriz,'yyyymmdd'),' '),8,' '),
		rpad(coalesce(to_char(a.dt_solicitacao,'yyyymmdd'),' '),8,' '),
		lpad(coalesce(a.unidade_medida,'0'),3,'0'),
		rpad(coalesce(a.nr_reg_anvisa,' '),15,' '),
		lpad(coalesce(a.cd_munic,'0') || coalesce(Calcula_Digito('MODULO10',coalesce(a.cd_munic,'0')),'0'),7,'0'),
		rpad(coalesce(a.cd_ref_material_fab,' '),60,' '),
		rpad(' ',8,' '), --rpad(nvl(to_char(a.dt_pgto_prestador,'yyyymmdd'),' '),8,' '),
		coalesce(a.ie_alto_custo,'N'),
		lpad(coalesce(a.nr_cnpj_fornecedor,'0'),14,'0'),
		lpad(coalesce(a.cd_rec_prestador,'0'),10,'0'),
		coalesce(a.id_pag_forn,'0'),
		rpad(coalesce(a.nm_fornecedor,' '),60,' '),
		rpad(coalesce(a.det_reg_anvisa,' '),50,' '),
		rpad(coalesce(a.nr_nota_fiscal_forn,' '),20,' '),
		coalesce(a.id_aviso_item,' ')
	from	ptu_nota_servico	a,
		ptu_nota_cobranca	b
	where	a.nr_seq_nota_cobr	= b.nr_sequencia
	and	coalesce(a.qt_procedimento,0) > 0
	and	b.nr_sequencia		= nr_seq_nota_cobranca_w;
	
C04 CURSOR FOR 	-- 505
	SELECT	lpad(coalesce(elimina_caractere_especial(a.nr_lote),'0'),8,'0'),
		rpad(coalesce(substr(elimina_caractere_especial(to_char(a.nr_nota)),1,20),' '),20,' '),
		coalesce(to_char(a.ie_tipo_complemento),' '),
		rpad(coalesce(replace(replace(ptu_somente_caracter_permitido(a.ds_complemento,'ANS'),chr(10),' '),chr(13),' '),' '),100,' '),
		rpad(coalesce(replace(replace(elimina_caractere_especial(a.especif_material),chr(10),' '),chr(13),' '),' '),500,' '),
		replace(replace(ptu_somente_caracter_permitido(a.ds_complemento,'ANS'),chr(10),''),chr(13),'')
	from	ptu_nota_complemento	a,
		ptu_nota_cobranca	b
	where	a.nr_seq_nota_cobr	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_nota_cobranca_w
	order by 3, a.nr_sequencia;
	
C05 CURSOR FOR 	-- 506
	SELECT	rpad(a.nr_nota_fiscal,20,' '),
		a.ds_link_nfe,
		rpad(a.nr_nota_fiscal_doc2,20,' '),
		a.ds_link_nfe_doc2
	from	ptu_nota_fiscal	a
	where	a.nr_seq_fatura	= nr_seq_fatura_p
	and	(a.nr_nota_fiscal IS NOT NULL AND a.nr_nota_fiscal::text <> '')
	
union  all

	PERFORM	rpad(a.nr_nota_fiscal,20,' '),
		a.ds_link_nfe,
		rpad(a.nr_nota_fiscal_doc2,20,' '),
		a.ds_link_nfe_doc2
	from	ptu_nota_fiscal		a,
		ptu_nota_cobranca	b
	where	a.nr_seq_nota_cobr	= b.nr_sequencia
	and	(a.nr_nota_fiscal IS NOT NULL AND a.nr_nota_fiscal::text <> '')
	and	coalesce(a.nr_seq_fatura::text, '') = ''
	and	b.nr_sequencia		in (	select	x.nr_sequencia
						from	ptu_nota_cobranca	x
						where	x.nr_seq_fatura		= nr_seq_fatura_p);
	
C10 CURSOR FOR
	SELECT	rpad(coalesce(b.nr_declara_vivo,' '),15,' '),
		rpad(coalesce(b.cd_cid_obito,' '),6,' '),
		rpad(coalesce(b.nr_declara_obito,' '),17,' ')
	FROM ptu_nota_cobranca c, ptu_nota_hospitalar a
LEFT OUTER JOIN ptu_nota_hosp_compl b ON (a.nr_sequencia = b.nr_seq_nota_hosp)
WHERE a.nr_seq_nota_cobr	= c.nr_sequencia and c.nr_sequencia		= nr_seq_nota_cobranca_w;
	
C11 CURSOR( nr_seq_ptu_fatura_pc	ptu_fatura.nr_sequencia%type ) FOR
	SELECT	nr_sequencia,
		lpad(coalesce(elimina_caractere_especial(to_char(nr_lote)),'0'),8,'0') nr_lote,
		rpad(coalesce(substr(ptu_somente_caracter_permitido(nr_nota,'ANS'),1,20),' '),20,' ') nr_nota,
		lpad(coalesce(cd_unimed,'0'),4,'0') cd_unimed,
		lpad(coalesce(id_benef,'0'),13,'0') id_benef,
		rpad(substr(coalesce(ptu_somente_caracter_permitido(nm_beneficiario,'ANS'),' '),1,25),25,' ') nm_beneficiario,
		rpad(coalesce(to_char(dt_nasc,'yyyymmdd'),' '),8,' ') dt_nasc,
		coalesce(tp_sexo,' ') tp_sexo,
		coalesce(id_rn,' ') id_rn,
		rpad(coalesce(to_char(dt_reembolso,'yyyymmdd'),' '),8,' ') dt_reembolso,
		coalesce(tp_carater_atend,' ') tp_carater_atend,
		coalesce(tp_pessoa,' ') tp_pessoa,
		lpad(coalesce(nr_cnpj_cpf,'0'),14,'0') nr_cnpj_cpf,
		rpad(coalesce(ptu_somente_caracter_permitido(nm_prestador,'ANS'),' '),60,' ') nm_prestador,
		coalesce(id_reembolso_sus,'1') id_reembolso_sus,
		coalesce(id_reem_par_int,'0') id_reem_par_int,
		rpad(coalesce(cd_cnes,' '),7,' ') cd_cnes
	from	ptu_nota_cobranca_rrs
	where	nr_seq_fatura	= nr_seq_ptu_fatura_pc;
	
c12 CURSOR( nr_seq_nota_cobr_rrs_pc	ptu_nota_cobranca_rrs.nr_sequencia%type ) FOR
	SELECT	nr_sequencia,
		lpad(coalesce(elimina_caractere_especial(to_char(nr_lote)),'0'),8,'0') nr_lote,
		rpad(coalesce(substr(ptu_somente_caracter_permitido(nr_nota,'ANS'),1,20),' '),20,' ') nr_nota,
		rpad(coalesce(to_char(dt_servico,'yyyymmdd'),' '),8,' ') dt_servico,
		rpad(coalesce(ptu_somente_caracter_permitido(nm_profissional,'ANS'),' '),60,' ') nm_profissional,
		rpad(coalesce(sg_cons_prof,' '),12,' ') sg_cons_prof,
		rpad(coalesce(nr_cons_prof,' '),15,' ') nr_cons_prof,
		rpad(coalesce(sg_uf_cons_prof,' '),2,' ') sg_uf_cons_prof,
		coalesce(tp_particip,' ') tp_particip,
		coalesce(tp_tabela,'0') tp_tabela,
		lpad(coalesce(cd_servico,'0'),10,'0') cd_servico,
		lpad(coalesce(qt_cobrada*10000,'0'),8,'0') qt_cobrada,
		lpad(coalesce(replace(replace(campo_mascara(vl_dif_vl_inter,2),',',''),'.',''),'0'),14,'0') vl_dif_vl_inter,
		lpad(coalesce(replace(replace(campo_mascara(vl_serv_cob,2),',',''),'.',''),'0'),14,'0') vl_serv_cob,
		lpad(coalesce(nr_autoriz,'0'),10,'0') nr_autoriz,
		rpad(coalesce(ptu_somente_caracter_permitido(ds_servico,'ANS'),' '),80,' ') ds_servico,
		lpad(coalesce(replace(replace(campo_mascara(vl_pago_benef,2),',',''),'.',''),'0'),14,'0') vl_pago_benef
	from	ptu_nota_servico_rrs
	where	nr_seq_nota_cobr_rrs	 = nr_seq_nota_cobr_rrs_pc;

BEGIN
delete from  w_ptu_envio_arq where nm_usuario = nm_usuario_p;

if (nr_seq_fatura_p IS NOT NULL AND nr_seq_fatura_p::text <> '') then
	-- Padrão brasileiro é -3, Regiões Sul, Sudeste e Nordeste, Goiás, Distrito Federal, Tocantins, Amapá e Pará
	ds_meridiano_w := '-03';

	select	lpad(cd_unimed_destino,4,'0')
	into STRICT	cd_cooperativa_w
	from	ptu_fatura
	where	nr_sequencia = nr_seq_fatura_p;

	select	max(cd_cgc)
	into STRICT	cd_cgc_w
	from	pls_congenere
	where	lpad(cd_cooperativa,4,'0') = cd_cooperativa_w;

	select	max(sg_estado)
	into STRICT	sg_estado_w
	from	pessoa_juridica
	where	cd_cgc = cd_cgc_w;

	if (sg_estado_w in ('RN','PB','PE','AL')) then
		ds_meridiano_w := '-02';
	end if;

	if (sg_estado_w in ('MS','MT','RO','AC','AM','RR')) then
		ds_meridiano_w := '-04';
	end if;

	open C00;
	loop
	fetch C00 into	
		cd_unimed_destino_w,
		cd_unimed_origem_w,
		dt_geracao_w,
		nr_competencia_w,
		nr_fatura_w,
		dt_venc_fatura_w,
		dt_emissao_fatura_w,
		vl_total_fatura_w,
		vl_ir_w,
		qt_total_r502_w,
		qt_total_r503_w,
		qt_total_r504_w,
		qt_total_r505_w,
		qt_nota_exec_w,
		qt_total_serv_w,
		vl_total_serv_w,
		ie_classif_cobranca_w,
		nr_nota_credito_debito_w,
		dt_vencimento_ndc_w,
		dt_emissao_ndc_w,
		vl_total_ndc_w,
		nr_seq_ptu_fatura_w,
		doc_fiscal_1_w,
		doc_fiscal_2_w,
		ie_tipo_documento_1_w,
		ie_tipo_documento_2_w,
		qt_total_r507_w,
		qt_total_r508_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin
		nr_seq_registro_w	:= nr_seq_registro_w + 1;
		
		if (ie_classif_cobranca_w = '2') then
			ie_tipo_documento_2_w	:= '0';
		end if;

		ds_conteudo_w	:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
					'501' || 
					cd_unimed_destino_w || 
					cd_unimed_origem_w || 
					dt_geracao_w || 
					nr_competencia_w ||
					rpad(' ',11,' ') || 
					dt_venc_fatura_w || 
					dt_emissao_fatura_w || 
					vl_total_fatura_w || 
					vl_ir_w || 
					rpad(' ',28,' ') || 
					'31' ||
					ie_classif_cobranca_w || 
					rpad(' ',11,' ') || 
					dt_vencimento_ndc_w || 
					dt_emissao_ndc_w || 
					vl_total_ndc_w || 
					nr_fatura_w ||
					nr_nota_credito_debito_w || 
					ie_tipo_documento_1_w || 
					ie_tipo_documento_2_w ||
					doc_fiscal_1_w ||
					doc_fiscal_2_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

		insert into w_ptu_envio_arq(
			nr_sequencia, dt_atualizacao, nm_usuario,
			ds_conteudo, nr_seq_apres
		) values (
			nextval('w_ptu_envio_arq_seq'), clock_timestamp(), nm_usuario_p,
			ds_conteudo_w, nr_seq_registro_w
		);

		open C01;
		loop
		fetch C01 into
			nr_lote_w,
			nr_nota_w,
			cd_unimed_w,
			cd_usuario_plano_w,
			nm_beneficiario_w,
			dt_atendimento_w,
			cd_excecao_w,
			ie_carater_atendimento_w,
			cd_cid_w,
			ie_paciente_w,
			ie_tipo_saida_spdat_w,
			ie_tipo_atendimento_w,
			nr_guia_principal_w,
			nr_seq_nota_cobranca_w,
			dt_internacao_502_w,
			dt_alta_502_w,
			dt_ultima_autoriz_w,
			tp_nota_w,
			id_nota_principal_w,
			nr_ver_tiss_w,
			nr_guia_tiss_prestador_w,
			nr_guia_tiss_principal_w,
			nr_guia_tiss_operadora_w,
			tp_ind_acidente_w,
			motivo_encerram_w,
			nr_cnpj_cpf_req_w,
			nm_prest_req_w,
			sg_cons_prof_req_502_w,
			nr_cons_prof_req_502_w,
			sg_uf_cons_req_502_w,
			nr_cbo_req_w,
			nr_fatura_glosada_w,
			nr_ndr_glosada_w,
			nr_lote_glosado_w,
			nr_nota_glosada_w,
			dt_protocolo_w,
			id_rn_w,
			tp_consulta_w,
			id_liminar_w,
			tp_pessoa_w,
			nr_cnpj_cpf_w,
			cd_cnes_cont_exec_w,
			cd_munic_cont_exec_w,
			tipo_rede_min_w,
			nm_prest_exec_w,
			id_aviso_w,
			id_continuado_w,
			nr_lote_prest_w,
			dt_conhecimento_w,
			tp_prest_exec_w,
			cd_cid_obito_cobr_w,
			id_rec_proprio_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			qt_registro_w		:= 0;
			nr_seq_registro_w	:= nr_seq_registro_w + 1;
			
			select	count(1)
			into STRICT	qt_registro_w
			from	ptu_nota_hospitalar	a,
				ptu_nota_hosp_compl	b,
				ptu_nota_cobranca	c
			where	a.nr_sequencia		= b.nr_seq_nota_hosp
			and	a.nr_seq_nota_cobr	= c.nr_sequencia
			and	c.nr_sequencia		= nr_seq_nota_cobranca_w  LIMIT 1;
			
			-- Quando antecede registro 503, deve ser deixado o espaço em branco - OS 430452
			if (qt_registro_w > 0) or (nr_ver_tiss_w = '3.00.01') then
				ie_tipo_saida_spdat_w := ' ';
			end if;
			
			if (coalesce(trim(both nr_guia_principal_w)::text, '') = '') then
				nr_guia_principal_w := lpad('0',20,'0');
			end if;
			
			-- Regra:	Obrigatório para internação e honorário individual.  

			--	Quando TP_NOTA = 1 ou 2 os campos deverão ser preenchidos com branco. 

			--	Para versões anteriores a TISS 3.00.00, considerar a data da internação e alta. 
			if	((tp_nota_w = '1') or (tp_nota_w = '2')) then
				dt_internacao_502_w	:= lpad(' ',21,' ');
				dt_alta_502_w		:= lpad(' ',21,' ');
			end if;
			
			ds_conteudo_w	:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
						'502' || 
						nr_lote_w || 
						lpad(' ',11,' ') || 
						' ' || 
						cd_unimed_destino_w || 
						lpad(' ',3,' ') || 
						cd_usuario_plano_w || 
						nm_beneficiario_w || 
						dt_atendimento_w || 
						cd_excecao_w || 
						lpad(' ',3,' ') || 
						cd_cid_w || 
						lpad(' ',14,' ') || 
						ie_paciente_w || 
						' ' ||
						ie_tipo_atendimento_w || 
						lpad(' ',11,' ') || 
						nr_nota_w || 
						nr_guia_principal_w || 
						dt_internacao_502_w || 
						dt_alta_502_w || 
						dt_ultima_autoriz_w || 
						tp_nota_w || 
						id_nota_principal_w || 
						nr_ver_tiss_w || 
						nr_guia_tiss_prestador_w || 
						nr_guia_tiss_principal_w || 
						nr_guia_tiss_operadora_w ||
						tp_ind_acidente_w || 
						motivo_encerram_w || 
						nr_cnpj_cpf_req_w || 
						lpad(' ',40,' ') || 
						sg_cons_prof_req_502_w ||
						nr_cons_prof_req_502_w || 
						sg_uf_cons_req_502_w || 
						nr_cbo_req_w || 
						lpad(' ',11,' ') || 
						lpad(' ',11,' ') ||
						nr_lote_glosado_w || 
						nr_nota_glosada_w || 
						dt_protocolo_w || 
						id_rn_w || 
						nr_fatura_glosada_w || 
						nr_ndr_glosada_w ||
						ie_carater_atendimento_w || 
						tp_consulta_w ||
						id_liminar_w ||
						tp_pessoa_w ||
						nr_cnpj_cpf_w ||
						cd_cnes_cont_exec_w ||
						cd_munic_cont_exec_w ||
						nm_prest_req_w ||
						lpad(' ',10,' ') ||
						tipo_rede_min_w ||
						id_aviso_w ||
						id_continuado_w ||
						nr_lote_prest_w ||
						dt_conhecimento_w ||
						nm_prest_exec_w ||
						lpad(' ',10,' ') ||
						tp_prest_exec_w ||
						id_rec_proprio_w ||
						cd_cid_obito_cobr_w;
			pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo,
				nr_seq_apres)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w,
				nr_seq_registro_w);

			open C02;
			loop
			fetch C02 into
				nr_lote_503_w,
				nr_nota_503_w,
				cd_unimed_hospital_w,
				cd_hospital_w,
				nm_hospital_w,
				ie_tipo_acomodacao_w,
				dt_internacao_w,
				dt_alta_w,
				tx_mult_amb_w,
				ie_ind_acidente_w,
				cd_motivo_saida_w,
				cd_cgc_hospital_w,
				ie_tipo_internacao_w,
				qt_nasc_vivos_w,
				qt_nasc_mortos_w,
				qt_nasc_vivos_pre_w,
				qt_obito_precoce_w,
				qt_obito_tardio_w,
				ie_int_gestacao_w,
				ie_int_aborto_w,
				ie_int_transtorno_w,
				ie_int_puerperio_w,
				ie_int_recem_nascido_w,
				ie_int_neonatal_w,
				ie_int_baixo_peso_w,
				ie_int_parto_cesarea_w,
				ie_int_parto_normal_w,
				ie_faturamento_w,
				ie_obito_mulher_w,
				nr_declara_obito_w,
				reg_internacao_w,
				nm_medico_auditor_w,
				nr_crm_auditor_w,
				nm_enfer_auditor_w,
				nr_coren_auditor_w,
				cd_uf_crm_w,
				cd_uf_coren_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin	
				nr_declara_vivo_1_w := null;
				nr_declara_vivo_2_w := null;
				nr_declara_vivo_3_w := null;
				nr_declara_vivo_4_w := null;
				nr_declara_vivo_5_w := null;
				cd_cid_obito_1_w := null;
				cd_cid_obito_2_w := null;
				cd_cid_obito_3_w := null;
				cd_cid_obito_4_w := null;
				cd_cid_obito_5_w := null;
				nr_declara_obito_1_w := null;
				nr_declara_obito_2_w := null;
				nr_declara_obito_3_w := null;
				nr_declara_obito_4_w := null;
				nr_declara_obito_5_w := null;
				
				open C10;
				loop
				fetch C10 into	
					nr_declara_vivo_0_w,
					cd_cid_obito_0_w,
					nr_declara_obito_0_w;
				EXIT WHEN NOT FOUND; /* apply on C10 */
					begin
					if (coalesce(nr_declara_vivo_1_w::text, '') = '') then
						nr_declara_vivo_1_w := nr_declara_vivo_0_w;
					
					elsif (coalesce(nr_declara_vivo_2_w::text, '') = '') then
						nr_declara_vivo_2_w := nr_declara_vivo_0_w;
						
					elsif (coalesce(nr_declara_vivo_3_w::text, '') = '') then
						nr_declara_vivo_3_w := nr_declara_vivo_0_w;
						
					elsif (coalesce(nr_declara_vivo_4_w::text, '') = '') then
						nr_declara_vivo_4_w := nr_declara_vivo_0_w;
					
					elsif (coalesce(nr_declara_vivo_5_w::text, '') = '') then
						nr_declara_vivo_5_w := nr_declara_vivo_0_w;
					end if;
					
					if (coalesce(cd_cid_obito_1_w::text, '') = '') then
						cd_cid_obito_1_w := cd_cid_obito_0_w;
					
					elsif (coalesce(cd_cid_obito_2_w::text, '') = '') then
						cd_cid_obito_2_w := cd_cid_obito_0_w;
						
					elsif (coalesce(cd_cid_obito_3_w::text, '') = '') then
						cd_cid_obito_3_w := cd_cid_obito_0_w;
						
					elsif (coalesce(cd_cid_obito_4_w::text, '') = '') then
						cd_cid_obito_4_w := cd_cid_obito_0_w;
					
					elsif (coalesce(cd_cid_obito_5_w::text, '') = '') then
						cd_cid_obito_5_w := cd_cid_obito_0_w;
					end if;
					
					if (coalesce(nr_declara_obito_1_w::text, '') = '') then
						nr_declara_obito_1_w := nr_declara_obito_0_w;
					
					elsif (coalesce(nr_declara_obito_2_w::text, '') = '') then
						nr_declara_obito_2_w := nr_declara_obito_0_w;
						
					elsif (coalesce(nr_declara_obito_3_w::text, '') = '') then
						nr_declara_obito_3_w := nr_declara_obito_0_w;
						
					elsif (coalesce(nr_declara_obito_4_w::text, '') = '') then
						nr_declara_obito_4_w := nr_declara_obito_0_w;
					
					elsif (coalesce(nr_declara_obito_5_w::text, '') = '') then
						nr_declara_obito_5_w := nr_declara_obito_0_w;
					end if;				
					end;
				end loop;
				close C10;
				
				nr_seq_registro_w	:= nr_seq_registro_w + 1;
				
				-- CAMPOS QUE FORAM "REMOVIDOS" DA VERSÃO 5.0
				dt_internacao_w 	:= lpad(' ',21,' ');
				dt_alta_w		:= lpad(' ',21,' ');
				ie_ind_acidente_w 	:= ' ';
				cd_motivo_saida_w 	:= '  ';
				
				ds_conteudo_w	:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||       -- 001-008      NR_SEQ
							'503' ||                                        -- 009-011      TP_REG
							nr_lote_503_w ||                                -- 012-019      NR_LOTE
							lpad(' ',11,' ') ||                             -- 020-030      RESERVADO
							cd_unimed_hospital_w ||                         -- 031-034      CD_UNI_HOSP
							cd_hospital_w ||                                -- 035-042      CD_HOSP
							lpad(' ',25,' ') ||                             -- 043-067      RESERVADO
							ie_tipo_acomodacao_w ||                         -- 068-069      TP_ACOMODACAO
							dt_internacao_w ||                              -- 070-090      RESERVADO
							dt_alta_w ||                                    -- 091-111      RESERVADO
							tx_mult_amb_w ||                                -- 112-115      FT_MULT_AMB
							ie_ind_acidente_w ||                            -- 116-116      RESERVADO
							cd_motivo_saida_w ||                            -- 117-118      RESERVADO
							cd_cgc_hospital_w ||                            -- 119-132      CNPJ_HOSPITAL
							ie_tipo_internacao_w ||                         -- 133-133      TP_INTERNACAO
							lpad(' ',2,' ') ||                              -- 134-135      RESERVADO
							lpad(' ',17,' ') ||                             -- 136-152      RESERVADO
							ie_faturamento_w ||                             -- 153-153      TP_FATURAMENTO
							lpad(' ',13,' ') ||                             -- 154-159      RESERVADO
                                                                                                        -- 160-166      RESERVADO
							rpad(coalesce(nr_declara_vivo_1_w,' '),15,' ') ||    -- 167-181      NR_DECLARA_VIVO_1
							rpad(coalesce(nr_declara_vivo_2_w,' '),15,' ') ||    -- 182-196      NR_DECLARA_VIVO_2
							rpad(coalesce(nr_declara_vivo_3_w,' '),15,' ') ||    -- 197-211      NR_DECLARA_VIVO_3
							rpad(coalesce(nr_declara_vivo_4_w,' '),15,' ') ||    -- 212-226      NR_DECLARA_VIVO_4
							rpad(coalesce(nr_declara_vivo_5_w,' '),15,' ') ||    -- 227-241      NR_DECLARA_VIVO_5
							' ' ||                                          -- 242-242      RESERVADO
							nr_declara_obito_w ||                           -- 243-259      NR_DECLARA_OBITO
							rpad(coalesce(cd_cid_obito_1_w,' '),6,' ') ||        -- 260-265      CD_CID_OBITO_1
							rpad(coalesce(cd_cid_obito_2_w,' '),6,' ') ||        -- 266-271      CD_CID_OBITO_2
							rpad(coalesce(cd_cid_obito_3_w,' '),6,' ') ||        -- 272-277      CD_CID_OBITO_3
							rpad(coalesce(cd_cid_obito_4_w,' '),6,' ') ||        -- 278-283      CD_CID_OBITO_4
							rpad(coalesce(cd_cid_obito_5_w,' '),6,' ') ||        -- 284-289      CD_CID_OBITO_5
							rpad(coalesce(nr_declara_obito_1_w,' '),17,' ') ||   -- 290-306      NR_DECLARA_OBITO_1
							rpad(coalesce(nr_declara_obito_2_w,' '),17,' ') ||   -- 307-323      NR_DECLARA_OBITO_2
							rpad(coalesce(nr_declara_obito_3_w,' '),17,' ') ||   -- 324-340      NR_DECLARA_OBITO_3
							rpad(coalesce(nr_declara_obito_4_w,' '),17,' ') ||   -- 341-357      NR_DECLARA_OBITO_4
							rpad(coalesce(nr_declara_obito_5_w,' '),17,' ') ||   -- 358-374      NR_DECLARA_OBITO_5
							nr_nota_503_w ||                                -- 375-394      NR_NOTA
							reg_internacao_w ||                             -- 395-395      REG_INTERNACAO
							nm_medico_auditor_w ||                          -- 396-435      NM_MEDICO_AUDITOR
							nr_crm_auditor_w ||                             -- 436-450      NR_CRM_AUDITOR
							nm_enfer_auditor_w ||                           -- 451-490      NM_ENFER_AUDITOR
							nr_coren_auditor_w ||                           -- 491-505      NR_COREN_AUDITOR
							cd_uf_crm_w ||                                  -- 506-507      CD_UF_CRM
							cd_uf_coren_w ||                                -- 508-509      CD_UF_COREN
							rpad(coalesce(nm_hospital_w,' '),60,' ');            -- 510-569      NM_HOSP
				pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
				ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

				insert into w_ptu_envio_arq(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ds_conteudo,
					nr_seq_apres)
				values (nextval('w_ptu_envio_arq_seq'),
					clock_timestamp(),
					nm_usuario_p,
					ds_conteudo_w,
					nr_seq_registro_w);
				end;
			end loop;
			close C02;

			open C03;
			loop
			fetch C03 into
				nr_lote_504_w,
				nr_nota_504_w,
				cd_unimed_prestador_w,
				cd_prestador_w,
				nm_prestador_w,
				ie_tipo_participacao_w,
				dt_procedimento_w,
				ie_tipo_tabela_w,
				cd_procedimento_w,
				qt_procedimento_w,
				vl_procedimento_w,
				vl_custo_operacional_w,
				vl_filme_w,
				cd_porte_anestesico_w,
				cd_unimed_autorizadora_w,
				cd_unimed_pre_req_w,
				cd_prestador_req_w,
				ie_via_acesso_w,
				vl_adic_procedimento_w,
				vl_adic_co_w,
				vl_adic_filme_w,
				cd_especialidade_w,
				ie_tipo_prestador_w,
				ie_rede_propria_w,
				ie_tipo_pessoa_prestador_w,
				nr_cgc_cpf_w,
				ie_pacote_w,
				cd_ato_w,
				tx_procedimento_w,
				nr_seq_nota_w,
				ds_hora_procedimento_w,
				cd_cnes_prest_w,
				nm_profissional_prestador_w,
				sg_cons_prof_prest_w,
				nr_cons_prof_prest_w,
				sg_uf_cons_prest_w,
				nr_cgc_cpf_req_w,
				nm_prestador_requisitante_w,
				sg_cons_prof_req_w,
				nr_cons_prof_req_w,
				sg_uf_cons_req_w,
				ie_reembolso_w,
				nr_autorizacao_w,
				vl_pago_prest_w,
				nr_seq_nota_servico_w,
				cd_pacote_w,
				nr_gui_tiss_w,
				tp_autoriz_w,
				ds_servico_w,
				hr_final_w,
				id_acres_urg_emer_w,
				nr_cbo_exec_w,
				tec_utilizada_w,
				dt_autoriz_w,
				dt_solicitacao_w,
				unidade_medida_w,
				nr_reg_anvisa_w,
				cd_munic_w,
				cd_ref_material_fab_w,
				dt_pgto_prestador_w,
				ie_prestador_alto_custo_w,
				nr_cnpj_fornecedor_w,
				cd_rec_prestador_w,
				id_pag_forn_w,
				nm_fornecedor_w,
				det_reg_anvisa_w,
				nr_nota_fiscal_forn_w,
				id_aviso_item_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				nr_seq_registro_w	:= nr_seq_registro_w + 1;			

				cd_prestador_w := lpad(cd_prestador_w,8,'0');
				
				-- Mesma informação do registro 502
				nr_nota_504_w := nr_nota_w;
				
				if (nr_ver_tiss_w = '2.02.03') then
					nr_cbo_exec_w := '999999';
				end if;
			
				ds_conteudo_w	:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
							'504' || 
							nr_lote_504_w || 
							lpad(' ',11,' ') || 
							cd_unimed_prestador_w || 
							cd_prestador_w || 
							lpad(' ',40,' ') || 
							ie_tipo_participacao_w || 
							dt_procedimento_w ||
							ie_tipo_tabela_w || 
							cd_procedimento_w || 
							qt_procedimento_w || 
							vl_procedimento_w || 
							vl_custo_operacional_w ||
							vl_filme_w || 
							cd_porte_anestesico_w || 
							cd_unimed_autorizadora_w ||
							lpad(' ',21,' ') || 
							ie_via_acesso_w || 
							vl_adic_procedimento_w || 
							vl_adic_co_w || 
							vl_adic_filme_w || 
							lpad(' ',2,' ') ||
							lpad(' ',3,' ') || 
							ie_tipo_pessoa_prestador_w || 
							nr_cgc_cpf_w || 
							ie_pacote_w ||  
							cd_ato_w || 
							tx_procedimento_w || 
							nr_seq_nota_w || 
							ds_hora_procedimento_w || 
							lpad(' ',7,' ') || 
							lpad(' ',40,' ') || 
							sg_cons_prof_prest_w || 
							nr_cons_prof_prest_w || 
							sg_uf_cons_prest_w || 
							lpad(' ',2,' ') || 
							lpad(' ',14,' ') || 
							lpad(' ',40,' ') || 
							lpad(' ',12,' ') || 
							lpad(' ',15,' ') || 
							lpad(' ',2,' ') || 
							ie_reembolso_w || 
							nr_autorizacao_w || 
							vl_pago_prest_w || 
							cd_pacote_w || 
							lpad(' ',20,' ') || 
							tp_autoriz_w ||
							ds_servico_w || 
							' ' || 
							nr_nota_504_w ||
							hr_final_w || 
							id_acres_urg_emer_w || 
							nr_cbo_exec_w || 
							tec_utilizada_w || 
							dt_autoriz_w || 
							dt_solicitacao_w || 
							unidade_medida_w || 
							nr_reg_anvisa_w || 
							lpad(' ',37,' ') || 
							dt_pgto_prestador_w || 
							nr_cnpj_fornecedor_w ||
							cd_rec_prestador_w || 
							cd_ref_material_fab_w||
							id_pag_forn_w||
							lpad(' ',40,' ') ||
							det_reg_anvisa_w||
							nr_nota_fiscal_forn_w ||
							lpad(' ',71,' ') ||
							nm_profissional_prestador_w ||
							lpad(' ',10,' ') ||
							nm_fornecedor_w ||
							lpad(' ',10,' ') ||
							id_aviso_item_w;
				pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
				ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

				insert into w_ptu_envio_arq(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ds_conteudo,
					nr_seq_apres)
				values (nextval('w_ptu_envio_arq_seq'),
					clock_timestamp(),
					nm_usuario_p,
					ds_conteudo_w,
					nr_seq_registro_w);
					
				update	ptu_nota_servico
				set	nr_seq_a500	= nr_seq_registro_w
				where	nr_sequencia	= nr_seq_nota_servico_w;
				end;
			end loop;
			close C03;
			
			open C04;
			loop
			fetch C04 into	
				nr_lote_505_w,
				nr_nota_505_w,
				ie_tipo_complemento_w,
				ds_complemento_w,
				especif_material_w,
				ds_complemento_w2;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				if (ds_complemento_w2 IS NOT NULL AND ds_complemento_w2::text <> '') then
					nr_seq_registro_w	:= nr_seq_registro_w + 1;
					
					-- Mesma informação do registro 502
					nr_nota_505_w := nr_nota_w;

					ds_conteudo_w	:=	lpad(to_char(nr_seq_registro_w),8,'0') ||
								'505' || 
								nr_lote_505_w || 
								lpad(' ',11,' ') || 
								ie_tipo_complemento_w || 
								ds_complemento_w || 
								nr_nota_505_w;
					pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
					ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

					insert into w_ptu_envio_arq(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						ds_conteudo,
						nr_seq_apres)
					values (nextval('w_ptu_envio_arq_seq'),
						clock_timestamp(),
						nm_usuario_p,
						ds_conteudo_w,
						nr_seq_registro_w);
				end if;
				end;
			end loop;
			close C04;
			end;
		end loop;
		close C01;
		
		for r_C11_w in C11(nr_seq_ptu_fatura_w) loop
			nr_seq_registro_w	:= nr_seq_registro_w + 1;
			
			ds_conteudo_w	:=	lpad(to_char(nr_seq_registro_w),8,'0') ||
						'507' || 
						r_C11_w.nr_lote || 
						r_C11_w.nr_nota || 
						r_C11_w.cd_unimed || 
						r_C11_w.id_benef || 
						r_C11_w.nm_beneficiario || 
						r_C11_w.dt_nasc || 
						r_C11_w.tp_sexo || 
						r_C11_w.id_rn || 
						r_C11_w.dt_reembolso || 
						r_C11_w.tp_carater_atend || 
						r_C11_w.tp_pessoa || 
						r_C11_w.nr_cnpj_cpf || 
						lpad(' ',40,' ') || 
						r_C11_w.id_reembolso_sus ||
						r_C11_w.nm_prestador ||
						lpad(' ',10,' ') ||
						r_C11_w.id_reem_par_int ||
						r_C11_w.cd_cnes;
			pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo,
				nr_seq_apres)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w,
				nr_seq_registro_w);
				
			for r_C12_w in C12(r_C11_w.nr_sequencia) loop
				nr_seq_registro_w	:= nr_seq_registro_w + 1;
				
				ds_conteudo_w	:=	lpad(to_char(nr_seq_registro_w),8,'0') ||
							'508' || 
							r_C12_w.nr_lote ||
							r_C12_w.nr_nota ||
							r_C12_w.dt_servico ||
							lpad(' ',40,' ') || 
							r_C12_w.sg_cons_prof ||
							r_C12_w.nr_cons_prof ||
							r_C12_w.sg_uf_cons_prof ||
							r_C12_w.tp_particip || 
							r_C12_w.tp_tabela ||
							lpad(' ',8,' ') ||
							r_C12_w.qt_cobrada ||
							r_C12_w.vl_dif_vl_inter ||
							r_C12_w.vl_serv_cob ||
							r_C12_w.nr_autoriz ||
							r_C12_w.ds_servico ||
							r_C12_w.nm_profissional ||
							lpad(' ',10,' ') ||
							r_C12_w.cd_servico ||
							r_C12_w.vl_pago_benef;
				pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
				ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

				insert into w_ptu_envio_arq(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ds_conteudo,
					nr_seq_apres)
				values (nextval('w_ptu_envio_arq_seq'),
					clock_timestamp(),
					nm_usuario_p,
					ds_conteudo_w,
					nr_seq_registro_w);
			
				update	ptu_nota_servico_rrs
				set	nr_seq_a500	= nr_seq_registro_w
				where	nr_sequencia	= r_C12_w.nr_sequencia;
			end loop;
		end loop;
		
		open C05;
		loop
		fetch C05 into	
			nr_nota_fiscal_w,
			ds_link_nfe_w,
			nr_nota_fiscal_doc2_w,
			ds_link_nfe_doc2_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			nr_seq_registro_w	:= nr_seq_registro_w + 1;

			ds_conteudo_w	:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
						'506' || 
						nr_nota_fiscal_w || 
						ds_link_nfe_w ||
						nr_nota_fiscal_doc2_w ||
						ds_link_nfe_doc2_w;
			pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo,
				nr_seq_apres)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w,
				nr_seq_registro_w);
			end;
		end loop;
		close C05;
		
		select	lpad(coalesce(replace(replace(campo_mascara(coalesce(sum(a.vl_procedimento),0),2),',',''),'.',''),'0'),14,'0')
		into STRICT	vl_total_adic_w
		from	ptu_nota_servico	a,
			ptu_nota_cobranca	b
		where	a.nr_seq_nota_cobr	= b.nr_sequencia
		and	b.nr_seq_fatura		= nr_seq_fatura_p;
		
		nr_seq_registro_w	:= nr_seq_registro_w + 1;

		ds_conteudo_w	:=	lpad(to_char(nr_seq_registro_w),8,'0') ||
					'509' || 
					qt_total_r502_w || 
					qt_total_r503_w || 
					qt_total_r504_w || 
					qt_total_r505_w || 
					qt_nota_exec_w || 
					lpad(' ',5,' ') || 
					qt_total_serv_w || 
					vl_total_adic_w ||
					qt_total_r507_w ||
					qt_total_r508_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
				
		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w,
			nr_seq_registro_w);
		end;
	end loop;
	close C00;
	
	-- R998 ¿ Hash (OBRIGATÓRIO)
	nr_seq_registro_w	:=	nr_seq_registro_w + 1;
	ds_arquivo_w := pls_hash_ptu_pck.obter_hash_txt(ds_arquivo_w); -- Gerar HASH
	ds_conteudo_w		:=	lpad(nr_seq_registro_w,8,'0') || '998' || ds_hash_w;

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo,
		nr_seq_apres)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w,
		nr_seq_registro_w);

	update	ptu_fatura
	set	ds_hash		= ds_hash_w
	where	nr_sequencia	= nr_seq_fatura_p;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_envio_fat_v110 ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

