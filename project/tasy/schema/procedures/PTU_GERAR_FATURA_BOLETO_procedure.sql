-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_fatura_boleto ( nr_seq_fatura_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_banco_portador_w		varchar(5);
nr_nosso_numero_w		varchar(20);
vl_titulo_w			double precision;
dt_emissao_w			timestamp;
dt_processamento_w		timestamp;
cd_agencia_bancaria_w		varchar(25);
ds_compl_contab_w		varchar(255);
nr_bloqueto_w			varchar(44);
ds_observacao_titulo_w		varchar(255);
nr_linha_digitavel_w		varchar(60);
nr_seq_pls_fatura_w		bigint;
ie_boleto_w			varchar(1);
cd_carteira_fat_w		varchar(10);

nr_seq_conta_banco_w		bigint;
cd_agencia_banc_w		varchar(8);
cd_banco_w			banco.cd_banco%type;
cd_carteira_w			varchar(10);

c01 CURSOR FOR
	SELECT	x.cd_banco,
		x.nr_nosso_numero,
		x.vl_titulo,
		x.dt_emissao,
		b.dt_mesano_referencia,
		x.cd_agencia_bancaria,
		null,
		x.nr_bloqueto,
		x.ds_observacao_titulo,
		x.nr_bloqueto_lido,
		x.cd_carteira,
		'1' ie_boleto,
		x.nr_seq_conta_banco
	from	titulo_receber_bloq_v	x,
		pls_lote_faturamento	b,
		pls_fatura		a
	where	a.nr_titulo_ndc	= x.nr_titulo
	and	b.nr_sequencia	= a.nr_seq_lote
	and	a.nr_sequencia	= nr_seq_pls_fatura_w
	
union

	SELECT	x.cd_banco,
		x.nr_nosso_numero,
		x.vl_titulo,
		x.dt_emissao,
		b.dt_mesano_referencia,
		x.cd_agencia_bancaria,
		null,
		x.nr_bloqueto,
		x.ds_observacao_titulo,
		x.nr_bloqueto_lido,
		x.cd_carteira,
		'2' ie_boleto,
		x.nr_seq_conta_banco
	from	titulo_receber_bloq_v	x,
		pls_lote_faturamento	b,
		pls_fatura		a
	where	a.nr_titulo	= x.nr_titulo
	and	b.nr_sequencia	= a.nr_seq_lote
	and	a.nr_sequencia	= nr_seq_pls_fatura_w;


BEGIN
select	max(nr_seq_pls_fatura)
into STRICT	nr_seq_pls_fatura_w
from	ptu_fatura
where	nr_sequencia = nr_seq_fatura_p;

open c01;
loop
fetch c01 into
	cd_banco_portador_w,
	nr_nosso_numero_w,
	vl_titulo_w,
	dt_emissao_w,
	dt_processamento_w,
	cd_agencia_bancaria_w,
	ds_compl_contab_w,
	nr_bloqueto_w,
	ds_observacao_titulo_w,
	nr_linha_digitavel_w,
	cd_carteira_fat_w,
	ie_boleto_w,
	nr_seq_conta_banco_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	-- Pegar informacoes da BANCO_ESTABELECIMENTO
	begin
	select	coalesce(cd_agencia_bancaria,'0'),
		coalesce(cd_banco,0),
		coalesce(cd_carteira,' ')
	into STRICT	cd_agencia_banc_w,
		cd_banco_w,
		cd_carteira_w
	from	banco_estabelecimento
	where	nr_sequencia = nr_seq_conta_banco_w;
	exception
	when others then
		cd_agencia_banc_w := '0';
		cd_banco_w := 0;
		cd_carteira_w := ' ';
	end;

	insert into ptu_fatura_boleto(nr_sequencia,
		nr_seq_fatura,
		cd_banc,
		cd_agencia_cedente,
		cd_nosso_numero,
		vl_documento,
		ds_local_pagamento,
		ds_obs_local_pagto,
		ds_instrucao, 
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_linha_digitavel,
		cd_barras,
		ds_obs_banco,
		ds_carteira,
		ds_especie,
		dt_documento,
		cd_especie_doc,
		ie_aceite,
		dt_processamento,
		ds_observacao,
		tp_boleto)
	values (nextval('ptu_fatura_boleto_seq'),
		nr_seq_fatura_p,
		coalesce(cd_banco_portador_w,cd_banco_w),
		coalesce(cd_agencia_bancaria_w,cd_agencia_banc_w),
		coalesce(nr_nosso_numero_w,'0'), 
		vl_titulo_w,
		' ',
		' ',
		ds_compl_contab_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_linha_digitavel_w,
		nr_bloqueto_w,
		' ',
		coalesce(cd_carteira_fat_w,cd_carteira_w),
		' ',
		dt_emissao_w,
		' ',
		' ',
		dt_processamento_w,
		ds_observacao_titulo_w,
		ie_boleto_w);
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_fatura_boleto ( nr_seq_fatura_p bigint, nm_usuario_p text) FROM PUBLIC;

