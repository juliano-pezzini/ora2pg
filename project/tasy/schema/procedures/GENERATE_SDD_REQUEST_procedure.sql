-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_sdd_request ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_account_p bigint, cd_sdd_reason_P text, cd_seq_transaction_p INOUT text) AS $body$
DECLARE


nm_family_w			sdd_request.nm_family%type;
nm_first_w			sdd_request.nm_first%type;
cd_medicare_card_w		sdd_request.cd_medicare_card%type;
dt_lodgement_w			sdd_request.dt_lodgement%type;
nr_patient_ref_w		sdd_request.nr_patient_ref%type;
nr_time_lod_w			sdd_request.nr_time_lod%type;
nr_seq_request_w		sdd_request.nr_sequencia%type;
cd_seq_transaction_w		sdd_request.nr_seq_transaction%type;
dt_medical_event_w              sdd_request.dt_medical_event%type;
cd_attribute_w             	varchar(100);
cd_field_name_w            	varchar(100);
error_flag_w			varchar(1);
nr_sequence_pci_w		bigint;


c03 CURSOR FOR
	SELECT	nm_eclipse_field,
		nm_atributo
	from	eclipse_attribute
	where	ie_condition = 'M'
	and	ie_sdd = 'S';

BEGIN

	delete	from eclipse_inco_account
	where	nr_interno_conta = nr_seq_account_p;

	select	nextval('sdd_request_seq')
	into STRICT	nr_seq_request_w
	;


	select max(dt_lodgement),
		max(nm_family),
		max(nm_first),
		max(cd_medicare_card),
		max(nr_patient_num),
		max(nr_time_lod),
		max(nr_sequencia),
		generaterandomnumber cd_seq_transaction
	into STRICT	dt_lodgement_w,
		nm_family_w,
		nm_first_w,
		cd_medicare_card_w,
		nr_patient_ref_w,
		nr_time_lod_w,
		nr_sequence_pci_W,
		cd_seq_transaction_w
	from	pci_claim
	where	nr_account = nr_seq_account_p 
	order	by	nr_sequencia desc LIMIT 1;
	
	select	max(dt_service)
	into STRICT	dt_medical_event_w
	from	pci_voucher 
	where	nr_seq_claim = nr_sequence_pci_w  LIMIT 1;
		
for r03 in c03 loop

begin

cd_attribute_w	:= r03.nm_atributo;
cd_field_name_w := r03.nm_eclipse_field;

	if (upper(cd_field_name_w) = upper('PatientFirstName') and (coalesce(nm_first_w::text, '') = '' ) ) then 

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(1112323), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('PatientFamilyName') and (coalesce(nm_family_w::text, '') = '' ) ) then

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(1112322), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('PatientMedicareCardNum') and (coalesce(cd_medicare_card_w::text, '') = '' ) ) then

		CALL generate_inco_eclipse(nr_seq_account_p, 1, Wheb_mensagem_pck.get_texto(1112324), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('PatientReferenceNum') and (coalesce(nr_patient_ref_w::text, '') = '' ) ) then 

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(1112325), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('DateOfLodgement') and (coalesce(dt_lodgement_w::text, '') = '' ) ) then

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(1112318), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('SDDReasonCde') and (coalesce(cd_sdd_reason_P::text, '') = '' ) ) then

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(967406), nm_usuario_p);
		error_flag_w := 'T';

	elsif (upper(cd_field_name_w) = upper('TimeOfLodgement') and (coalesce(nr_time_lod_w::text, '') = '' ) ) then

		CALL generate_inco_eclipse(nr_seq_account_p , 1, Wheb_mensagem_pck.get_texto(1112326), nm_usuario_p);
		error_flag_w := 'T';
		
	end if;
end;

end loop;

if (coalesce(error_flag_w::text, '') = '') then

		insert into sdd_request(nr_sequencia  ,
			dt_atualizacao,    
			nm_usuario  ,        
			dt_atualizacao_nrec,              
			nm_usuario_nrec  ,             
			nm_family ,                   
			nm_first ,                     
			cd_medicare_card ,               
			dt_lodgement ,                     
			nr_patient_ref ,                   
			cd_sdd_reason ,                 
			nr_time_lod,
			nr_seq_transaction,
			ie_referral_override_type,          
			ie_submission_authority,            
			dt_medical_event,                            
			cd_medicare_card_issue,
			cd_registration)
		values (nr_seq_request_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nm_family_w,                   
			nm_first_w,                     
			cd_medicare_card_w,               
			dt_lodgement_w,                     
			nr_patient_ref_w,                   
			cd_sdd_reason_P,                 
			nr_time_lod_w,
			cd_seq_transaction_w,
			'N',          
			'Y',            
			dt_medical_event_w,                            
			nr_patient_ref_w,
			'');

commit;
cd_seq_transaction_p := cd_seq_transaction_w;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_sdd_request ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_account_p bigint, cd_sdd_reason_P text, cd_seq_transaction_p INOUT text) FROM PUBLIC;

