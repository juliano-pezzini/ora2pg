-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE load_data_protocol_short_cate ( nr_seq_protocolo_integrado_p protocolo_integrado_etapa.nr_seq_protocolo_integrado%type, nm_usuario_p usuario.nm_usuario%type, cd_function_p funcao.cd_funcao%type, nr_seq_protocolo_int_copy_p protocolo_integrado_etapa.nr_seq_protocolo_integrado%type default null) AS $body$
DECLARE


C01 is CURSOR
        with table_aux as (
                SELECT	piev.ie_tipo_evento
                from 	protocolo_integrado_evento piev,
                        protocolo_integrado_etapa piet
                where 	piev.nr_seq_etapa = piet.nr_sequencia
                and 	piet.nr_seq_protocolo_integrado = nr_seq_protocolo_integrado_p
                group by ie_tipo_evento)
        SELECT  nextval('protocolo_int_tipo_evento_seq') as nr_sequencia,
                ta.ie_tipo_evento as cd_dominio_tp_evento,
                tep.nr_ordem as nr_ordem
        from 	table_aux ta,
                tipo_evento_protocolo tep
        where 	tep.cd_dominio_tp_evento = ta.ie_tipo_evento
        and	not exists (     select 	1
                                from    protocolo_int_tipo_evento pitv
                                where	pitv.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                and	pitv.cd_dominio_tp_evento = tep.cd_dominio_tp_evento);

C01row C01%rowtype;

C02 is CURSOR
        with table_aux as (
                SELECT  pie.ie_tipo_evento,
                        pite.nr_sequencia as nr_seq_tp_evento,
                        ga.nr_sequencia as nr_seq_acao        
                from    protocolo_integrado pi,
                        protocolo_integrado_etapa pet,
                        protocolo_integrado_evento pie,
                        gqa_pendencia_regra gpr,
                        gqa_acao ga,
                        protocolo_int_tipo_evento pite
                where 	pi.nr_sequencia = pet.nr_seq_protocolo_integrado
                and 	pet.nr_sequencia = pie.nr_seq_etapa
                and 	pie.nr_seq_plano = gpr.nr_sequencia
                and 	ga.nr_seq_pend_regra = gpr.nr_sequencia
                and 	ga.ie_situacao = 'A'
                and 	pi.nr_sequencia = nr_seq_protocolo_integrado_p
                and 	pite.cd_dominio_tp_evento = pie.ie_tipo_evento
                and 	pite.nr_seq_protocolo = pi.nr_sequencia
                group by pie.ie_tipo_evento, ga.nr_sequencia, pite.nr_sequencia
                order by 1)
        SELECT 	nextval('protocolo_int_categoria_seq') as nr_sequencia, 
                ta.nr_seq_tp_evento as nr_seq_tp_evento,
                ta.nr_seq_acao as nr_seq_acao
        from 	table_aux ta
        where 	not exists (     select 	1
                                from 	protocolo_int_categoria pic
                                where 	pic.nr_seq_tp_evento = ta.nr_seq_tp_evento
                                and 	pic.nr_seq_acao = ta.nr_seq_acao );

C02row C02%rowtype;

C03 is CURSOR
        with table_aux as (
                SELECT	pipev.ie_tipo_evento
                from 	protocolo_int_pac_evento pipev,
                        protocolo_int_pac_etapa pipet
                where 	pipev.nr_seq_prt_int_pac_etapa = pipet.nr_sequencia
                and 	pipet.nr_seq_protocolo_int_pac = nr_seq_protocolo_integrado_p
                group by ie_tipo_evento)
        SELECT  nextval('protocolo_int_pac_tp_event_seq') as nr_sequencia,
                ta.ie_tipo_evento as cd_dominio_tp_evento,
                tep.nr_ordem as nr_ordem
        from 	table_aux ta,
                tipo_evento_protocolo tep
        where 	tep.cd_dominio_tp_evento = ta.ie_tipo_evento
        and	not exists (     select 	1
                                from    protocolo_int_pac_tp_event pipte
                                where	pipte.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                and	pipte.cd_dominio_tp_evento = tep.cd_dominio_tp_evento);

C03row C03%rowtype;

C04 is CURSOR
        with table_aux as (
                SELECT  pipev.ie_tipo_evento,
                        pipte.nr_sequencia as nr_seq_tp_evento,
                        ga.nr_sequencia as nr_seq_acao
                from    protocolo_int_paciente pip,
                        protocolo_int_pac_etapa pipet,
                        protocolo_int_pac_evento pipev,
                        gqa_pendencia_regra gpr,
                        gqa_acao ga,
                        protocolo_int_pac_tp_event  pipte
                where 	pip.nr_sequencia = pipet.nr_seq_protocolo_int_pac
                and 	pipet.nr_sequencia = pipev.nr_seq_prt_int_pac_etapa
                and 	pipev.nr_seq_plano = gpr.nr_sequencia
                and 	ga.nr_seq_pend_regra = gpr.nr_sequencia
                and 	ga.ie_situacao = 'A'
                and 	pip.nr_sequencia = nr_seq_protocolo_integrado_p
                and 	pipte.cd_dominio_tp_evento = pipev.ie_tipo_evento
                and 	pipte.nr_seq_protocolo = pip.nr_sequencia
                group by pipev.ie_tipo_evento, ga.nr_sequencia, pipte.nr_sequencia
                order by 1)
        SELECT  nextval('protocolo_int_pac_categori_seq') as nr_sequencia, 
                ta.nr_seq_tp_evento as nr_seq_tp_evento,
                ta.nr_seq_acao as nr_seq_acao
        from 	table_aux ta
        where 	not exists (     select 	1
                                from 	protocolo_int_pac_categori pic
                                where 	pic.nr_seq_tp_evento = ta.nr_seq_tp_evento
                                and 	pic.nr_seq_acao = ta.nr_seq_acao );

C04row C04%rowtype;


BEGIN
        case cd_function_p
        -- Cadastros PEP
        when 99023 then
        begin
                -- Remove categoria(FK com protocolo_int_tipo_evento) que nao esta mais linkado no cadastro do tipo evento protocolo
                delete from protocolo_int_categoria
                where  nr_seq_tp_evento in (	SELECT  pite.nr_sequencia
                                                from    protocolo_int_tipo_evento pite
                                                where   pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                and     not exists (     SELECT  1
                                                                        from    tipo_evento_protocolo tep
                                                                        where   tep.cd_dominio_tp_evento = pite.cd_dominio_tp_evento ) );

                -- Remove os cadastros que nao esta mais linkado no cadastro do tipo evento protocolo.
                delete from protocolo_int_tipo_evento
                where  nr_sequencia in (	SELECT  pite.nr_sequencia
                                                from    protocolo_int_tipo_evento pite
                                                where   pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                and     not exists (     SELECT  1
                                                                        from    tipo_evento_protocolo tep
                                                                        where   tep.cd_dominio_tp_evento = pite.cd_dominio_tp_evento ) );

                -- Del action(Plan) changed
                delete from protocolo_int_categoria
                where nr_sequencia in ( SELECT  pic.nr_sequencia
                                        from    protocolo_int_tipo_evento pite,
                                                protocolo_int_categoria pic
                                        where   pic.nr_seq_tp_evento = pite.nr_sequencia
                                        and     pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                        and     not exists (     SELECT  1
                                                                from    protocolo_integrado pi,
                                                                        protocolo_integrado_etapa pet,
                                                                        protocolo_integrado_evento pie,
                                                                        gqa_pendencia_regra gpr,
                                                                        gqa_acao ga
                                                                where   pi.nr_sequencia = pet.nr_seq_protocolo_integrado
                                                                and     pet.nr_sequencia = pie.nr_seq_etapa
                                                                and     pie.nr_seq_plano = gpr.nr_sequencia
                                                                and     ga.nr_seq_pend_regra = gpr.nr_sequencia
                                                                and     ga.ie_situacao = 'A'
                                                                and     pi.nr_sequencia = pite.nr_seq_protocolo
                                                                and     pie.ie_tipo_evento = pite.cd_dominio_tp_evento
                                                                and     pic.nr_seq_acao = ga.nr_sequencia
                                                                group by pie.ie_tipo_evento, ga.nr_sequencia ) );

                -- Del event changed 
                delete from protocolo_int_tipo_evento
                where nr_sequencia in ( SELECT  pite.nr_sequencia
                                        from    protocolo_int_tipo_evento pite
                                        where   pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                        and     not exists (     SELECT  1
                                                                from    protocolo_integrado pi,
                                                                        protocolo_integrado_etapa pet,
                                                                        protocolo_integrado_evento pie
                                                                where   pi.nr_sequencia = pet.nr_seq_protocolo_integrado
                                                                and     pet.nr_sequencia = pie.nr_seq_etapa
                                                                and     pi.nr_sequencia = pite.nr_seq_protocolo
                                                                and     pie.ie_tipo_evento = pite.cd_dominio_tp_evento
                                                                group by pie.ie_tipo_evento ) );

                -- Ler valores do cadastro e adicionar o que falta na tabela.
                for C01row in C01
                loop
                        insert into protocolo_int_tipo_evento(
                                        nr_sequencia,
                                        nr_seq_protocolo,
                                        cd_dominio_tp_evento,
                                        nr_ordem,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec)
                        values (C01row.nr_sequencia,
                                        nr_seq_protocolo_integrado_p,
                                        C01row.cd_dominio_tp_evento,
                                        C01row.nr_ordem,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        clock_timestamp(),
                                        nm_usuario_p);
                end loop;

                -- Ler valores do cadastro e adicionar o que falta na tabela categoria.
                for C02row in C02
                loop
                        insert into protocolo_int_categoria(
                                        nr_sequencia,
                                        nr_seq_tp_evento,
                                        nr_seq_acao,
                                        nr_ordem,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec)
                        values (C02row.nr_sequencia,
                                        C02row.nr_seq_tp_evento,
                                        C02row.nr_seq_acao,
                                        null,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        clock_timestamp(),
                                        nm_usuario_p);
                end loop;
        end;

        -- Prontuario Eletronico Paciente - PEP
        when 281 then
        begin
                -- nr_seq_protocolo_int_copy_p vai copiar do cadastro do PEP.
                if (nr_seq_protocolo_int_copy_p IS NOT NULL AND nr_seq_protocolo_int_copy_p::text <> '') then
                        insert into protocolo_int_pac_tp_event( nr_sequencia,
                                                                nr_seq_protocolo,
                                                                cd_dominio_tp_evento,
                                                                nr_ordem,
                                                                dt_atualizacao,
                                                                nm_usuario,
                                                                dt_atualizacao_nrec,
                                                                nm_usuario_nrec )
                                                                (       SELECT  nextval('protocolo_int_pac_tp_event_seq'),
                                                                                nr_seq_protocolo_integrado_p,
                                                                                cd_dominio_tp_evento,
                                                                                nr_ordem,
                                                                                clock_timestamp(),
                                                                                nm_usuario_p,
                                                                                clock_timestamp(),
                                                                                nm_usuario_p
                                                                        from    protocolo_int_tipo_evento
                                                                        where   nr_seq_protocolo = nr_seq_protocolo_int_copy_p);

                        insert into protocolo_int_pac_categori(nr_sequencia,
                                                                nr_seq_tp_evento,
                                                                nr_seq_acao,
                                                                nr_ordem,
                                                                dt_atualizacao,
                                                                nm_usuario,
                                                                dt_atualizacao_nrec,
                                                                nm_usuario_nrec)
                                                                (       SELECT  nextval('protocolo_int_categoria_seq'),
                                                                                (       SELECT  nr_sequencia
                                                                                        from    protocolo_int_pac_tp_event c
                                                                                        where   c.cd_dominio_tp_evento  = b.cd_dominio_tp_evento
                                                                                        and     c.nr_seq_protocolo      = nr_seq_protocolo_integrado_p  LIMIT 1),
                                                                                a.nr_seq_acao,
                                                                                a.nr_ordem,
                                                                                clock_timestamp(),
                                                                                nm_usuario_p,
                                                                                clock_timestamp(),
                                                                                nm_usuario_p
                                                                        from    protocolo_int_categoria a,
                                                                                protocolo_int_tipo_evento b
                                                                        where   a.nr_seq_tp_evento = b.nr_sequencia
                                                                        and     b.nr_seq_protocolo = nr_seq_protocolo_int_copy_p
                                                                );

                else
                        -- Remove categoria(FK com protocolo_int_pac_tp_event) que nao esta mais linkado no cadastro do tipo evento protocolo
                        delete from protocolo_int_pac_categori
                        where  nr_seq_tp_evento in (	SELECT  pite.nr_sequencia
                                                        from    protocolo_int_pac_tp_event pite
                                                        where   pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                        and     not exists (     SELECT  1
                                                                                from    tipo_evento_protocolo tep
                                                                                where   tep.cd_dominio_tp_evento = pite.cd_dominio_tp_evento ) );

                        -- Remove os cadastros que nao esta mais linkado no cadastro do tipo evento protocolo.
                        delete from protocolo_int_pac_tp_event
                        where  nr_sequencia in (        SELECT  pipte.nr_sequencia
                                                        from    protocolo_int_pac_tp_event pipte
                                                        where   pipte.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                        and     not exists (     SELECT  1
                                                                                from    tipo_evento_protocolo tep
                                                                                where   tep.cd_dominio_tp_evento = pipte.cd_dominio_tp_evento ) );

                        -- Del action(Plan) changed
                        delete from protocolo_int_pac_categori
                        where nr_sequencia in ( SELECT  pic.nr_sequencia
                                                from    protocolo_int_pac_tp_event pite,
                                                        protocolo_int_pac_categori pic
                                                where   pic.nr_seq_tp_evento = pite.nr_sequencia
                                                and     pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                and     not exists (     SELECT  1
                                                                        from    protocolo_int_paciente pip,
                                                                                protocolo_int_pac_etapa pipet,
                                                                                protocolo_int_pac_evento pipev,
                                                                                gqa_pendencia_regra gpr,
                                                                                gqa_acao ga
                                                                        where 	pip.nr_sequencia = pipet.nr_seq_protocolo_int_pac
                                                                        and 	pipet.nr_sequencia = pipev.nr_seq_prt_int_pac_etapa
                                                                        and 	pipev.nr_seq_plano = gpr.nr_sequencia
                                                                        and 	ga.nr_seq_pend_regra = gpr.nr_sequencia
                                                                        and 	ga.ie_situacao = 'A'
                                                                        and 	pip.nr_sequencia = pite.nr_seq_protocolo
                                                                        and 	pipev.ie_tipo_evento = pite.cd_dominio_tp_evento
                                                                        and     ga.nr_sequencia = pic.nr_seq_acao ) );

                        -- Del event changed
                        delete from protocolo_int_pac_tp_event
                        where nr_sequencia in ( SELECT  pite.nr_sequencia
                                                from    protocolo_int_pac_tp_event pite
                                                where   pite.nr_seq_protocolo = nr_seq_protocolo_integrado_p
                                                and     not exists (     SELECT   1
                                                                        from    protocolo_int_paciente pip,
                                                                                protocolo_int_pac_etapa pipet,
                                                                                protocolo_int_pac_evento pipev
                                                                        where 	pip.nr_sequencia = pipet.nr_seq_protocolo_int_pac
                                                                        and 	pipet.nr_sequencia = pipev.nr_seq_prt_int_pac_etapa
                                                                        and 	pip.nr_sequencia = pite.nr_seq_protocolo
                                                                        and 	pipev.ie_tipo_evento = pite.cd_dominio_tp_evento ) );

                        -- Ler valores do cadastro e adicionar o que falta na tabela.
                        for C03row in C03
                        loop
                                insert into protocolo_int_pac_tp_event(
                                                nr_sequencia,
                                                nr_seq_protocolo,
                                                cd_dominio_tp_evento,
                                                nr_ordem,
                                                dt_atualizacao,
                                                nm_usuario,
                                                dt_atualizacao_nrec,
                                                nm_usuario_nrec)
                                values (C03row.nr_sequencia,
                                                nr_seq_protocolo_integrado_p,
                                                C03row.cd_dominio_tp_evento,
                                                C03row.nr_ordem,
                                                clock_timestamp(),
                                                nm_usuario_p,
                                                clock_timestamp(),
                                                nm_usuario_p);
                        end loop;

                        -- Ler valores do cadastro e adicionar o que falta na tabela categoria.
                        for C04row in C04
                        loop
                                insert into protocolo_int_pac_categori(
                                                nr_sequencia,
                                                nr_seq_tp_evento,
                                                nr_seq_acao,
                                                nr_ordem,
                                                dt_atualizacao,
                                                nm_usuario,
                                                dt_atualizacao_nrec,
                                                nm_usuario_nrec)
                                values (C04row.nr_sequencia,
                                                C04row.nr_seq_tp_evento,
                                                C04row.nr_seq_acao,
                                                null,
                                                clock_timestamp(),
                                                nm_usuario_p,
                                                clock_timestamp(),
                                                nm_usuario_p);
                        end loop;
                end if;
        end;
        else
                null;
        end case;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
		commit;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE load_data_protocol_short_cate ( nr_seq_protocolo_integrado_p protocolo_integrado_etapa.nr_seq_protocolo_integrado%type, nm_usuario_p usuario.nm_usuario%type, cd_function_p funcao.cd_funcao%type, nr_seq_protocolo_int_copy_p protocolo_integrado_etapa.nr_seq_protocolo_integrado%type default null) FROM PUBLIC;

