-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_texto_resumo_sum_col ( nr_seq_atend_sumario_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_html_p text default null) is ds_quebra_w varchar(20) RETURNS varchar AS $body$
BEGIN
    return pkg_date_formaters.to_varchar(dt_register, 'shortDate', cd_estabelecimento_w, nm_usuario_w);
  end;

  function get_datetime_formated(dt_register in date) return varchar2
  is
  begin
    return pkg_date_formaters.to_varchar(dt_register, 'timestamp', cd_estabelecimento_w, nm_usuario_w);
  end;

  function get_dateshort_formated(dt_register in date) return varchar2
  is
  begin
    return pkg_date_formaters.to_varchar(dt_register, 'short', cd_estabelecimento_w, nm_usuario_w);
  end;

  procedure monta_texto_resumo(ds_texto_p in varchar2, ie_titulo_p in varchar2, nr_ordem_p in number, ie_quebra_linha_p in varchar2 default 'S') is

    ds_texto_w    w_sumario_texto_resumo.ds_texto%type;

    begin
      ds_texto_w := ds_texto_p;
      if (trim(both ie_titulo_p) = 'S') then
        if (nr_ordem_p = 1) then
            ds_texto_w := wheb_mensagem_pck.get_texto(307016, null) || ' '; -- Evolucoes
        elsif (nr_ordem_p = 2) then
            ds_texto_w := wheb_mensagem_pck.get_texto(307017, null) || ' '; -- Diagnosticos
        elsif (nr_ordem_p = 3) then
            ds_texto_w := wheb_mensagem_pck.get_texto(306711, 'DS_LISTA_PRESCRICAO_W=') || ' '; -- Prescricoes
        elsif (nr_ordem_p = 4) then
            ds_texto_w := wheb_mensagem_pck.get_texto(307211, null) || ' '; -- Exames/Procedimentos/Cirurgias
        elsif (nr_ordem_p = 5) then
            ds_texto_w	:= wheb_mensagem_pck.get_texto(307212, null) || ' '; -- Laudo Paciente
        elsif (nr_ordem_p = 8) then
            ds_texto_w	:= wheb_mensagem_pck.get_texto(1209680, null) || ' '; -- Medicamentos Administrados
        elsif (nr_ordem_p = 9) then
            ds_texto_w	:= wheb_mensagem_pck.get_texto(1025672, null) || ' '; -- Notas Clinicas
        elsif (nr_ordem_p = 10) then
            ds_texto_w	:= wheb_mensagem_pck.get_texto(1209873, null) || ' '; -- Patient Discharge
        end if;

        if (ie_html_p = 'S') then
          ds_texto_w:= '<b>'||ds_texto_w||'</b>';
        end if;
      end if;

      if (ie_quebra_linha_p = 'S') then
        ds_texto_w:= ds_texto_w || '<br>';
      end if;

      insert into w_sumario_texto_resumo(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  nr_atendimento,
                  nr_ordem,
                  ds_texto,
                  dt_registro)
      values (     nextval('w_sumario_texto_resumo_seq'),
                  clock_timestamp(),
                  nm_usuario_p,
                  nr_atendimento_p,
                  nr_ordem_p,
                  ds_texto_w,
                  clock_timestamp());

    commit;
  end;

  procedure monta_PBS(cd_exp_p in number, is_pbs_p in varchar2) is

  begin

  begin
    nr_count_w := 0;
    is_pbs_w := is_pbs_p;
    for c_exams_line in c_exams
      loop
        if (nr_count_w = 0) then
          monta_texto_resumo('<b>'||obter_desc_expressao(cd_exp_p)|| ':</b>', null, c_exams_line.nr_ordem, 'N');
          monta_texto_resumo('<table style="border-collapse: collapse;justify-content: center;">
              <thead>
                <tr style="border: 1px solid black">
                  <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(286507)|| '</th>
                  <th style="border-right: 1px solid black;width: 25%">'|| obter_desc_expressao(296509)|| '</th>
                  <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(305224)|| '</th>
                  <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(1028477)|| '</th>
                  <th style="border-right: 1px solid black;width: 25%;">'|| obter_desc_expressao(287493)|| '</th>
                  <th style="border-right: 1px solid black;width: 5%;">'|| obter_desc_expressao(296884)|| '</th>
                </tr>
              </thead>
            <tbody>', null, c_exams_line.nr_ordem, 'N');
        end if;

        select  coalesce(nullif(count(b.nr_sequencia),0),1)
        into STRICT    qt_procedimento_w
        from    prescr_medica a,
                prescr_procedimento b,
                procedimento c,
                exame_laboratorio d
        where   b.nr_prescricao = a.nr_prescricao
        and     b.cd_procedimento = c.cd_procedimento
        and     b.ie_origem_proced = c.ie_origem_proced
        and     a.nr_atendimento = nr_atendimento_p
        and     coalesce(b.ie_suspenso,'N') = 'N'
        and     d.nr_seq_exame = b.nr_seq_exame
        and     d.nr_seq_exame = c_exams_line.nr_exame
        and     coalesce(d.ie_sumario_alta,'N') = 'S'
        and     b.ie_status_atend >= 35;

        monta_texto_resumo('
          <tr>
            <td style="border: 0.5px solid black;text-align: center">'|| get_date_formated(c_exams_line.dt_exame) || '</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_exams_line.nm_profissional ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_exams_line.nr_exame ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_exams_line.cups ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_exams_line.nm_exame ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| qt_procedimento_w ||'</td>
          </tr>                
        ', null, c_exams_line.nr_ordem, 'N');
        nr_count_w := nr_count_w + 1;

      end loop;

      monta_texto_resumo('</tbody></table>', null, nr_ordem_w, 'N');

    exception
    when no_data_found then
      null;
    when too_many_rows then
      null;
    end;

  end;

  begin
    ds_texto_w := '{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 Courier New;}{\f1\fnil'||
    'Courier New;}}{\colortbl ;\red0\green0\blue0;}\viewkind4\uc1\pard\cf1\lang1046\f0\fs20 ';--||ds_texto_w  ||'\f1\par }';
      delete from w_sumario_texto_resumo
      where	nm_usuario = nm_usuario_p
      and		nr_atendimento = nr_atendimento_p;

    commit;

    ie_sbis_w := Obter_Valor_Param_Usuario(0, 215, Obter_perfil_Ativo, nm_usuario_p, OBTER_ESTABELECIMENTO_ATIVO);

    monta_texto_resumo('<html><head></head><body>', null, nr_ordem_w, 'N');

    begin
      insert into atend_sumario_alta_resumo(	nr_sequencia,
                                              dt_atualizacao,
                                              nm_usuario,
                                              nr_seq_atend_sumario)
                                  values (		nextval('atend_sumario_alta_resumo_seq'),
                                              clock_timestamp(),
                                              nm_usuario_p,
                                              nr_seq_atend_sumario_p);
    exception
      when unique_violation
        then null;
    end;

  begin	  /*DIAGNOSTICOS */
    select  obter_desc_expressao(b.cd_exp_valor_dominio) ds_servico_entrada
    into STRICT    ds_entrada_servico_w
    from    atendimento_Paciente a,
            valor_dominio b
    where   a.nr_atendimento = nr_atendimento_p
    and     to_char(a.ie_tipo_atendimento) = b.vl_dominio
    and     b.cd_dominio = 12;

    select  dt_entrada
    into STRICT    dt_entrada_w
    from    atendimento_paciente
    where   nr_atendimento = nr_atendimento_p;

    nr_count_w := 0;
      for c_diagnoses_line in c_diagnoses
        loop
          nr_ordem_w := c_diagnoses_line.nr_ordem;
          if (nr_count_w = 0) then
              monta_texto_resumo('<b>'||obter_desc_expressao(289269)|| ':</b>', null, c_diagnoses_line.nr_ordem);
              monta_texto_resumo(obter_desc_expressao(286507)|| ': ' || get_dateshort_formated(dt_entrada_w), null, c_diagnoses_line.nr_ordem);
              monta_texto_resumo(obter_desc_expressao(796617)|| ': ' || ds_entrada_servico_w, null, c_diagnoses_line.nr_ordem);
              monta_texto_resumo(obter_desc_expressao(1078247)|| ': ', null, c_diagnoses_line.nr_ordem);
              monta_texto_resumo('<table style="border-collapse: collapse;justify-content: center;">
                  <thead>
                    <tr style="border: 1px solid black">
                      <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(284902)|| '</th>
                      <th style="border-right: 1px solid black">'|| obter_desc_expressao(288148)|| '</th>
                      <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(299368)|| '</th>
                      <th style="width: 15%">'|| obter_desc_expressao(285080)|| '</th>
                    </tr>
                  </thead>
                <tbody>', null,  c_diagnoses_line.nr_ordem, 'N');
          end if;

          monta_texto_resumo('
            <tr>
              <td style="border: 0.5px solid black;text-align: center">'|| c_diagnoses_line.cd_doenca || '</td>
              <td style="border: 0.5px solid black;text-align: center">'|| c_diagnoses_line.ds_doenca_cid ||'</td>
              <td style="border: 0.5px solid black;text-align: center">'|| c_diagnoses_line.ie_tipo_diagnostico ||'</td>
              <td style="border: 0.5px solid black;text-align: center">'|| c_diagnoses_line.ie_classificacao_doenca ||'</td>
            </tr>                
          ', null,  c_diagnoses_line.nr_ordem, 'N');
          nr_count_w := nr_count_w + 1;
        end loop;

      if (nr_count_w > 0) then
        monta_texto_resumo('</tbody></table>', null,  nr_ordem_w);

        select  a.ds_motivo_consulta,
                a.ds_doenca_atual
        into STRICT    ds_motivo_consulta_w,
                ds_doenca_atual_w
        from    atend_queixa_paciente a
        where   a.nr_atendimento = nr_atendimento_p
        and     a.dt_liberacao = (SELECT  max(b.dt_liberacao)
                                from    atend_queixa_paciente b
                                where   b.nr_atendimento = nr_atendimento_p
                                and     (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> ''));

        monta_texto_resumo('<b>'||obter_desc_expressao(293519)|| ':</b>', null,  nr_ordem_w);
        monta_texto_resumo(ds_motivo_consulta_w, null,  nr_ordem_w);
        monta_texto_resumo('<b>'||obter_desc_expressao(1070555)|| ':</b>', null,  nr_ordem_w);
        monta_texto_resumo(ds_doenca_atual_w, null,  nr_ordem_w);
        monta_texto_resumo(null, null, null);
      end if;

  exception
  when no_data_found then
    null;
  when too_many_rows then
    null;
  end;

  /*HEALTH HISTORY*/

  begin
    select  ap.cd_pessoa_fisica
    into STRICT    cd_pessoa_fisica_w
    from    atendimento_paciente ap
    where   ap.nr_atendimento = nr_atendimento_p;

    nr_count_w := 0;
    nr_sort_w := 0;

    for c_health_history_new_r in c_health_history_new
    loop
      if (nr_count_w = 0) then
        monta_texto_resumo('<b>' || obter_desc_expressao(283521) || ':</b>', null, null);
        monta_texto_resumo(c_health_history_new_r.ds_group || ':', null, null);
      elsif (nr_sort_w != c_health_history_new_r.nr_sort) then
        monta_texto_resumo(null, null, null);
        monta_texto_resumo(c_health_history_new_r.ds_group || ':', null, null);
      end if;
      nr_sort_w := c_health_history_new_r.nr_sort;


      if (c_health_history_new_r.ie_review = 'S') then
        monta_texto_resumo(get_datetime_formated(c_health_history_new_r.dt_review) || '  ' || c_health_history_new_r.ds_item || ' (' || obter_desc_expressao(297890) || ')', null, null);
      else
        monta_texto_resumo(get_datetime_formated(c_health_history_new_r.dt_register) || '  ' || c_health_history_new_r.ds_item, null, null);
      end if;
      nr_count_w := nr_count_w + 1;
    end loop;
    monta_texto_resumo(null, null, null);
  end;

  /*NOTAS CLINICAS */

  begin
    nr_count_w := 0;

    for c_clinical_notes_line in c_clinical_notes
        loop

          if (nr_count_w = 0) then
              Monta_Texto_resumo(null, 'S', 9);
          end if;
          Monta_texto_resumo(obter_desc_expressao(286507)|| ': ' || get_datetime_formated(c_clinical_notes_line.dt_evolucao), null, c_clinical_notes_line.nr_ordem);
          Monta_texto_resumo(obter_desc_expressao(296509)|| ': ' || c_clinical_notes_line.nm_medico, null, c_clinical_notes_line.nr_ordem);
          Monta_texto_resumo(obter_desc_expressao(289431)|| ': ' || c_clinical_notes_line.ds_especialidade, null, c_clinical_notes_line.nr_ordem);
          Monta_texto_resumo(obter_desc_expressao(299368)|| ': ' || c_clinical_notes_line.ie_tipo_sum_alta, null, c_clinical_notes_line.nr_ordem);
          Monta_texto_resumo(obter_desc_expressao(287493)|| ': ' || c_clinical_notes_line.ds_evolucao, null, c_clinical_notes_line.nr_ordem);
          Monta_texto_resumo(null, null, c_clinical_notes_line.nr_ordem);
          nr_count_w := nr_count_w + 1;

        end loop;
  exception
    when no_data_found then
      null;
  end;

  /*Procedimentos e exames PBS*/

  monta_PBS(1079648, 'N');

  /*Procedimentos e exames nao PBS*/

  monta_PBS(1079650, 'S' );

  begin /*Recommendation */
    nr_count_w := 0;
    for c_recommendation_line in c_recommendation
      loop   
        if (nr_count_w = 0) then	
          monta_texto_resumo(null, null, nr_ordem_w);
          monta_texto_resumo('<b>'||obter_desc_expressao(297341)|| ':</b>', null, c_recommendation_line.nr_ordem);
        end if;
        monta_texto_resumo(get_date_formated(c_recommendation_line.dt_atualizacao) || ' - ' ||
              c_recommendation_line.nm_exame || ' - ' ||
              c_recommendation_line.nm_profissional, null, c_recommendation_line.nr_ordem);
        nr_count_w := nr_count_w + 1;
      end loop;
      monta_texto_resumo(null, null, nr_ordem_w);
  exception
    when no_data_found then
      null;
  end;

  /*MEDICAMENTOS ADMINISTRADOS*/

  begin
    nr_count_w := 0;
    for c_adm_medicines_line in c_adm_medicines
      loop
        if (nr_count_w = 0) then
          Monta_Texto_resumo(null, 'S', 8, 'N');
          monta_texto_resumo('<table style="border-collapse: collapse;justify-content: center;">
            <thead>
              <tr style="border: 1px solid black">
              <th style="border-right: 1px solid black;width: 20%;">'|| obter_desc_expressao(286507)|| '</th>
              <th style="border-right: 1px solid black">'|| obter_desc_expressao(293070)|| '</th>
              <th style="border-right: 1px solid black;width: 20%;">'|| obter_desc_expressao(301664)|| '</th>
              <th style="border-right: 1px solid black;width: 15%;">'|| obter_desc_expressao(296110)|| '</th>
              <th style="border-right: 1px solid black;width: 10%;">'|| obter_desc_expressao(288220)|| '</th>
              <th style="width: 10%">'|| obter_desc_expressao(954852)|| '</th>
              </tr>
            </thead>
            <tbody>', null,  c_adm_medicines_line.nr_ordem, 'N');
        end if;

        monta_texto_resumo('
          <tr>
            <td style="border: 0.5px solid black;text-align: center">'|| get_dateshort_formated(c_adm_medicines_line.dt_prescricao) || '</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_adm_medicines_line.ds_material ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_adm_medicines_line.ds_via_aplicacao ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_adm_medicines_line.cd_intervalo ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| c_adm_medicines_line.qt_dose ||'</td>
            <td style="border: 0.5px solid black;text-align: center">'|| obter_valor_dominio(8070, c_adm_medicines_line.ie_nopbs) ||'</td>
          </tr>                
        ', null,  c_adm_medicines_line.nr_ordem, 'N');
        nr_count_w := nr_count_w + 1;
      end loop;
      if (nr_count_w > 0) then
        monta_texto_resumo('</tbody></table>', null,  8);
      end if;
  exception
    when no_data_found then
      null;
  end;

  /*OUTPATIENT PRESCRIPTIONS*/

  begin
    nr_count_w := 0;
    for c_prescription_item_line in c_prescription_item
        loop
          if (nr_count_w = 0) then
            monta_texto_resumo('<b>'||obter_desc_expressao(314086)|| ':</b>', null, null);
          end if;

          if (c_prescription_item_line.nr_dias_receita = 1) then
            cd_exp_dias_w := 653185;
          else
            cd_exp_dias_w := 326313;
          end if;

          monta_texto_resumo(obter_desc_expressao(286507)|| ': ' || get_date_formated(c_prescription_item_line.dt_receita), null, null);
          monta_texto_resumo(obter_desc_expressao(296509)|| ': ' || c_prescription_item_line.nm_medico, null, null);
          monta_texto_resumo(obter_desc_expressao(293070)|| ': ' || c_prescription_item_line.ds_material, null, null);
          monta_texto_resumo(obter_desc_expressao(288220)|| ': ' || c_prescription_item_line.qt_dose, null, null);
          monta_texto_resumo(obter_desc_expressao(292190)|| ': ' || c_prescription_item_line.cd_intervalo, null, null);
          monta_texto_resumo(obter_desc_expressao(954852)|| ': ' || obter_valor_dominio(8070, c_prescription_item_line.ie_nopbs), null, null);
          monta_texto_resumo(obter_desc_expressao(289003)|| ': ' || c_prescription_item_line.nr_dias_receita || ' ' || obter_desc_expressao(cd_exp_dias_w), null, null);
          nr_count_w := nr_count_w + 1;
          monta_texto_resumo(null, null, null);

        end loop;
  exception
    when no_data_found then
      null;
  end;

  /*PRESCRIPTIONS*/

  begin
    nr_count_w := 0;
    for c_pep_prescription_line in c_pep_prescription
        loop
          if (nr_count_w = 0) then
            monta_texto_resumo('<b>'||obter_desc_expressao(307861)|| ':</b>', null, null);
          end if;

          monta_texto_resumo(obter_desc_expressao(286507)|| ': ' || get_date_formated(c_pep_prescription_line.dt_receita), null, null);
          monta_texto_resumo(obter_desc_expressao(296509)|| ': ' || c_pep_prescription_line.nm_medico, null, null);
          monta_texto_resumo(obter_desc_expressao(785832)|| ': ' || c_pep_prescription_line.ds_receita, null, null);
          nr_count_w := nr_count_w + 1;
          monta_texto_resumo(null, null, null);

        end loop;
  exception
    when no_data_found then
      null;
  end;

  /* THERAPEUTIC PLAN MANAGEMENT AND CARE SUMMARY TEXT */
 
  begin
    nr_count_w := 0;
  for c_plan_management_line in c_plan_management
    loop
        if (nr_count_w = 0) then
            monta_texto_resumo('<b>'||obter_desc_expressao(747910)|| ':</b>', null, null);
            monta_texto_resumo(c_plan_management_line.ds_texto || '<br>', null, null);
            monta_texto_resumo('<b>'||obter_desc_expressao(1042006)|| ':</b>', null, null);
            monta_texto_resumo(obter_desc_expressao(327202)|| ' ' || get_datetime_formated(c_plan_management_line.dt_registro), null, null);
            monta_texto_resumo(obter_desc_expressao(951561)|| ': ' || c_plan_management_line.ds_texto || '<br>', null, null);
            dt_old_w := c_plan_management_line.dt_registro;
            nr_count_w := nr_count_w + 1;
        else
            if (trunc(c_plan_management_line.dt_registro) <> trunc(dt_old_w)) then
                monta_texto_resumo(obter_desc_expressao(327202)|| ' ' || get_datetime_formated(c_plan_management_line.dt_registro), null, null);
                monta_texto_resumo(obter_desc_expressao(951561)|| ': ' || c_plan_management_line.ds_texto || '<br>', null, null);
                dt_old_w := c_plan_management_line.dt_registro;
            end if;
         end if;
     end loop;
  end;

  /*PATIENT DISCHARGE*/

  begin
    nr_count_w := 0;
    for c_incapacidade_line in c_incapacidade
    loop
      if (nr_count_w = 0) then
        monta_texto_resumo(null, 'S', 10);
      end if;

      monta_texto_resumo(obter_desc_expressao(299820) || ': ' || c_incapacidade_line.ds_classif_afastamento, null, null);
      monta_texto_resumo(obter_desc_expressao(291978) || ': ' || get_date_formated(c_incapacidade_line.dt_atestado), null, null, 'N');
      monta_texto_resumo('  ' || obter_desc_expressao(299309) || ': ' || get_date_formated(c_incapacidade_line.dt_fim), null, null);
      monta_texto_resumo(obter_desc_expressao(289003) || ': ' || c_incapacidade_line.qt_dias_atestado || ' ' || obter_desc_expressao(c_incapacidade_line.cd_expressao), null, null);

      nr_count_w := nr_count_w + 1;
    end loop;
  exception
    when no_data_found then
      null;
  end;

  begin
    select
            case a.ie_tipo_sumario
                when 'E' then CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN  b.ds_destino_paciente  ELSE obter_nome_pj(a.cd_cgc) END
                else b.ds_destino_paciente
            end destino,
            case a.ie_tipo_sumario
                when 'A' then 283375
                when 'E' then 487526
                when 'T' then 487527
            end cd_expressao
    into STRICT    ds_destino_w,
            cd_expressao_w
    from    atend_sumario_alta a, 
            destino_sumario_alta b 
    where   a.nr_atendimento = nr_atendimento_p 
    and     a.nr_sequencia = nr_seq_atend_sumario_p
    and     b.nr_sequencia = a.nr_seq_destino;
  exception
    when no_data_found then
      ds_destino_w := 'N/A';
      cd_expressao_w := 287627;
    when too_many_rows then
      ds_destino_w := 'N/A';
      cd_expressao_w := 287627;
  end;

  begin
    select  CASE WHEN coalesce(max(dt_obito)::text, '') = '' THEN  'checked'  ELSE null END  ie_vivo,
            CASE WHEN coalesce(max(dt_obito)::text, '') = '' THEN  null  ELSE 'checked' END  ie_morto, 
            CASE WHEN coalesce(max(ie_autopsia)::text, '') = '' THEN  null  ELSE 'checked' END  ie_autopsia
    into STRICT    ie_vivo_w,
            ie_morto_w,
            ie_autopsia_w
    from    declaracao_obito a, 
            atendimento_paciente b
    where   a.nr_atendimento = b.nr_atendimento
    and     b.nr_atendimento = nr_atendimento_p
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_inativacao::text, '') = '';

    monta_texto_resumo('<br><b>' || obter_desc_expressao(287627)|| ':</b>', null, null);
    monta_texto_resumo(obter_desc_expressao(cd_expressao_w)|| ': ' || ds_destino_w, null, null);
    monta_texto_resumo(obter_desc_expressao(301787) || ' <input ' || ie_vivo_w || ' type="checkbox" /><br />', null, null, 'N');
    monta_texto_resumo(obter_desc_expressao(933403) || ' <input ' || ie_morto_w || ' type="checkbox" /><br />', null, null, 'N');
    monta_texto_resumo(obter_desc_expressao(1079677) || ' <input ' || ie_autopsia_w || ' type="checkbox" /><br />', null, null, 'N');
    monta_texto_resumo(obter_desc_expressao(1079679) || ' <input type="checkbox" /><br />', null, null, 'N');
    monta_texto_resumo(obter_desc_expressao(499318) || ' <input type="checkbox" /><br />', null, null);
    monta_texto_resumo(null, null, null);
  exception
    when no_data_found then
      null;
  end;

  monta_texto_resumo('</body></html>', null, nr_ordem_w, 'N');

  nr_ordem_w		:= null;
  ds_texto_w		:= null;

  for C10_line in C10
    loop
      ds_campo_clob_w := ds_campo_clob_w || C10_line.ds_texto;
    end loop;

  ds_conteudo_1_w := substr(ds_campo_clob_w,32764,1);
  ds_conteudo_2_w := substr(ds_campo_clob_w,32764,32765);

  ds_resumo_clob_w := ds_conteudo_1_w||ds_conteudo_2_w;

  SELECT GET_RESUME_SCORE_EPICRISIS(nr_atendimento_p) INTO STRICT ds_conteudo_3_w;

  ds_resumo_clob_w := ds_resumo_clob_w || '<BR>';
  ds_resumo_clob_w := ds_resumo_clob_w || ds_conteudo_3_w;



  update	atend_sumario_alta_resumo
  set		ds_resumo = ds_resumo_clob_w
  where	nr_seq_atend_sumario = nr_seq_atend_sumario_p;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_texto_resumo_sum_col ( nr_seq_atend_sumario_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_html_p text default null) is ds_quebra_w varchar(20) FROM PUBLIC;

