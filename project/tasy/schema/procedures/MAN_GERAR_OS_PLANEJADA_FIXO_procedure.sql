-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_planejada_fixo ( nr_seq_equip_p bigint, nr_seq_planej_p bigint, nm_usuario_p text, dt_prev_geracao_os_p timestamp) AS $body$
DECLARE

 
ie_data_hora_w		man_regra_data_frequencia.ie_data_hora%type;
ie_data_hora_aux_w	man_regra_data_frequencia.ie_data_hora%type;
hr_geracao_w		man_regra_data_frequencia.hr_geracao%type;
ie_fixo_data_w		man_freq_planej.ie_fixo_data%type;
nr_seq_ordem_serv_w	man_ordem_servico.nr_sequencia%type;
dt_ordem_servico_w	timestamp;
qt_reg_w			bigint;

/* Tipo Data e Dia semana */
 
C01 CURSOR FOR 
	SELECT	coalesce(a.ie_data_hora,'D'), 
		rpad(somente_numero_char(a.hr_geracao),4,0) 
	from	man_regra_data_frequencia a 
	where	coalesce(a.ie_data_hora,'D') = 'D' 
	and	trunc(a.dt_geracao,'dd') = trunc(clock_timestamp(),'dd') 
	and	coalesce(a.nr_seq_equipamento,nr_seq_equip_p) = nr_seq_equip_p 
	and	a.nr_seq_planej_prev = nr_seq_planej_p 
	
union all
 
	SELECT	a.ie_data_hora, 
		rpad(somente_numero_char(a.hr_geracao),4,0) 
	from	man_regra_data_frequencia a 
	where	a.ie_data_hora = 'S' 
	and	a.dt_dia_semana = pkg_date_utils.get_WeekDay(clock_timestamp()) 
	and	coalesce(a.nr_seq_equipamento,nr_seq_equip_p) = nr_seq_equip_p 
	and	a.nr_seq_planej_prev = nr_seq_planej_p 
	order by 1;

/* Tipo Hora */
 
C02 CURSOR FOR 
	SELECT	coalesce(c.ie_fixo_data,'N'), 
		rpad(somente_numero_char(a.hr_geracao),4,0) 
	from	man_freq_planej c, 
		man_planej_prev b, 
		man_regra_data_frequencia a 
	where	b.nr_sequencia = a.nr_seq_planej_prev 
	and	c.nr_sequencia = b.nr_seq_frequencia 
	and	a.ie_data_hora = 'H' 
	and	(a.hr_geracao IS NOT NULL AND a.hr_geracao::text <> '') 
	and	trunc(coalesce(a.dt_geracao,clock_timestamp()),'dd') = trunc(clock_timestamp(),'dd') 
	and	coalesce(a.dt_dia_semana,pkg_date_utils.get_WeekDay(clock_timestamp())) = pkg_date_utils.get_WeekDay(clock_timestamp()) 
	and	(trunc(clock_timestamp()) >= trunc(dt_prev_geracao_os_p) 
		or (not exists (	SELECT	1 
				from	man_regra_data_frequencia x 
				where	((coalesce(x.ie_data_hora,'D') = 'D' and (x.dt_geracao IS NOT NULL AND x.dt_geracao::text <> '')) 
					or (x.ie_data_hora = 'S' and (x.dt_dia_semana IS NOT NULL AND x.dt_dia_semana::text <> ''))) 
				and	coalesce(x.nr_seq_equipamento,nr_seq_equip_p) = nr_seq_equip_p 
				and	x.nr_seq_planej_prev = b.nr_sequencia) and c.ie_fixo_data = 'S')) 
	and	coalesce(a.nr_seq_equipamento,nr_seq_equip_p) = nr_seq_equip_p 
	and	b.nr_sequencia = nr_seq_planej_p;


BEGIN 
 
select	count(*) 
into STRICT	qt_reg_w 
from	man_planej_prev_equip_excl x 
where	x.nr_seq_equipamento = nr_seq_equip_p 
and	x.nr_seq_planej_prev = nr_seq_planej_p;
 
if (coalesce(nr_seq_planej_p,0) > 0) and (coalesce(nr_seq_equip_p,0) > 0) and (qt_reg_w = 0) then 
	begin 
	open C01;
	loop 
	fetch C01 into 
		ie_data_hora_w, 
		hr_geracao_w;
	EXIT WHEN NOT FOUND or ie_data_hora_w <> coalesce(ie_data_hora_aux_w,ie_data_hora_w);  /* apply on C01 */
		begin 
		ie_data_hora_aux_w := ie_data_hora_w;
		dt_ordem_servico_w := clock_timestamp();
 
		if (coalesce(hr_geracao_w,'0') <> '0') then 
			begin 
			dt_ordem_servico_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || hr_geracao_w,'dd/mm/yy hh24mi');
			exception 
			when others then 
				dt_ordem_servico_w := clock_timestamp();
			end;
		else 
			begin 
 
			begin 
			select	rpad(somente_numero_char(a.hr_geracao),4,0) 
			into STRICT	hr_geracao_w 
			from	man_regra_data_frequencia a 
			where	coalesce(a.ie_data_hora,'D') = 'H' 
			and	(a.hr_geracao IS NOT NULL AND a.hr_geracao::text <> '') 
			and	trunc(coalesce(a.dt_geracao,clock_timestamp()),'dd') = trunc(clock_timestamp(),'dd') 
			and	coalesce(a.dt_dia_semana,pkg_date_utils.get_WeekDay(clock_timestamp())) = pkg_date_utils.get_WeekDay(clock_timestamp()) 
			and	coalesce(a.nr_seq_equipamento,nr_seq_equip_p) = nr_seq_equip_p 
			and	a.nr_seq_planej_prev = nr_seq_planej_p  LIMIT 1;
			exception 
			when others then 
				hr_geracao_w := '0';
			end;
 
			if (coalesce(hr_geracao_w,'0') <> '0') then 
				begin 
				dt_ordem_servico_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || hr_geracao_w,'dd/mm/yy hh24mi');
				exception 
				when others then 
					dt_ordem_servico_w := clock_timestamp();
				end;
			end if;
			end;
		end if;
 
		nr_seq_ordem_serv_w := man_gerar_os_planejada(nr_seq_equip_p, nr_seq_planej_p, dt_ordem_servico_w, 'PlanejFixo', nr_seq_ordem_serv_w, 'S');
		CALL man_gravar_log_geracao_os_prev(nr_seq_planej_p,nr_seq_equip_p,nr_seq_ordem_serv_w);
		end;
	end loop;
	close C01;
 
	if (coalesce(nr_seq_ordem_serv_w,0) = 0) then 
		open C02;
		loop 
		fetch C02 into 
			ie_fixo_data_w, 
			hr_geracao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
 
			begin 
			dt_ordem_servico_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || hr_geracao_w,'dd/mm/yy hh24mi');
			exception 
			when others then 
				hr_geracao_w := '0';
				dt_ordem_servico_w := clock_timestamp();
			end;
 
			if (coalesce(hr_geracao_w,'0') <> '0') or (ie_fixo_data_w = 'N') then 
				begin 
				nr_seq_ordem_serv_w := man_gerar_os_planejada(nr_seq_equip_p, nr_seq_planej_p, dt_ordem_servico_w, 'PlanejFixo', nr_seq_ordem_serv_w, 'S');
				CALL man_gravar_log_geracao_os_prev(nr_seq_planej_p,nr_seq_equip_p,nr_seq_ordem_serv_w);
				end;
			end if;
			end;
		end loop;
		close C02;
	end if;
 
	if (coalesce(nr_seq_ordem_serv_w,0) = 0) then 
		CALL man_gravar_log_geracao_os_prev(nr_seq_planej_p,nr_seq_equip_p,0);
	end if;
 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_planejada_fixo ( nr_seq_equip_p bigint, nr_seq_planej_p bigint, nm_usuario_p text, dt_prev_geracao_os_p timestamp) FROM PUBLIC;

