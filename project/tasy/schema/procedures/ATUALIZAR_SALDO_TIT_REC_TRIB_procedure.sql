-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_tit_rec_trib (nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE



vl_titulo_w		double precision;
vl_tributo_w		double precision;
nr_sequencia_w		bigint;
NR_SEQ_TRANS_TIT_REC_w	bigint;
nr_seq_tit_liq_w			bigint;
nr_seq_tit_rec_trib_w	bigint;
vl_baixa_w		double precision;
vl_recebido_w		double precision;
vl_tit_baixa_w		double precision;
vl_saldo_tributo_w	titulo_receber_trib.vl_saldo%type;

c01 CURSOR FOR
SELECT	a.vl_tributo,
	a.nr_sequencia,
	b.NR_SEQ_TRANS_TIT_REC
from	tributo b,
	titulo_receber_trib a
where	a.nr_titulo	= nr_titulo_p
and	a.vl_saldo	> 0
and	a.cd_tributo	= b.cd_tributo
and	coalesce(a.ie_origem_tributo, 'C') = 'C';

c02 CURSOR FOR
SELECT	a.vl_recebido,
	a.nr_sequencia
from	titulo_receber_liq a
where	a.nr_titulo	= nr_titulo_p
and		coalesce(a.ie_gerar_baixa_trib,'S') = 'S' --Usado para o MX. Baixas que nao devem baixar tributo.
and	not exists (select	1
		 from	titulo_receber_trib_baixa x
		 where	x.nr_titulo		= a.nr_titulo
		 and	x.nr_seq_tit_liq	= a.nr_sequencia
		 and	x.nr_seq_tit_trib		= nr_sequencia_w);


BEGIN

select	vl_titulo
into STRICT	vl_titulo_w
from	titulo_receber
where	nr_titulo	= nr_titulo_p;

open c01;
loop
fetch c01 into
	vl_tributo_w,
	nr_sequencia_w,
	NR_SEQ_TRANS_TIT_REC_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	open c02;
	loop
	fetch c02 into
		vl_recebido_w,
		nr_seq_tit_liq_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		vl_baixa_w := ((vl_recebido_w * 100) / vl_titulo_w);
		vl_baixa_w := (vl_baixa_w * vl_tributo_w) / 100;

		select	nextval('titulo_receber_trib_baixa_seq')
		into STRICT	nr_seq_tit_rec_trib_w
		;

		insert into titulo_receber_trib_baixa(nr_sequencia,
				vl_baixa,
				dt_atualizacao,
				nm_usuario,
				nr_seq_tit_trib,
				nr_titulo,
				nr_seq_tit_liq,
				nr_seq_trans_financ)
		values (nr_seq_tit_rec_trib_w,
				vl_baixa_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				nr_titulo_p,
				nr_seq_tit_liq_w,
				NR_SEQ_TRANS_TIT_REC_w);


	end loop;
	close c02;

	select	sum(vl_baixa)
	into STRICT	vl_tit_baixa_w
	from 	titulo_receber_trib_baixa
	where 	nr_seq_tit_trib = nr_sequencia_w;

	if (vl_tit_baixa_w <> vl_tributo_w) then
		update	titulo_receber_trib_baixa
		set	vl_baixa		= vl_baixa + vl_tributo_w - vl_tit_baixa_w
		where	nr_sequencia	= nr_seq_tit_rec_trib_w;
	end if;

	update	titulo_receber_trib
	set	vl_saldo 	= vl_tributo_w - coalesce(vl_tit_baixa_w,0)
	where	nr_sequencia 	= nr_sequencia_w;

	/* Verifica o saldo para atualizar a data contabil do tributo */

	select	max(a.vl_saldo)
	into STRICT	vl_saldo_tributo_w
	from	titulo_receber_trib a
	where	a.nr_sequencia	= nr_sequencia_w
	and	a.nr_titulo	= nr_titulo_p;

	if (coalesce(vl_saldo_tributo_w,0) <= 0) then
		update	titulo_receber_trib
		set	dt_contabil = clock_timestamp()
		where	nr_sequencia = nr_sequencia_w;
	else
		update	titulo_receber_trib
		set	dt_contabil  = NULL
		where	nr_sequencia = nr_sequencia_w;
	end if;

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_tit_rec_trib (nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

