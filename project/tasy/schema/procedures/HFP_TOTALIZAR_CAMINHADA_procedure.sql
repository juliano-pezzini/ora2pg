-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hfp_totalizar_caminhada ( nr_seq_caminhada_p bigint, nm_usuario_p text) AS $body$
DECLARE

--atributos
cd_pessoa_fisica_w	varchar(10);
qt_idade_w		bigint;
qt_peso_w		double precision;
qt_altura_cm_w		double precision;
ie_sexo_w		varchar(1);

qt_dist_ideal_w		bigint;
qt_dist_minima_w	bigint;
qt_dist_total_w		bigint;
qt_perc_fc_w		double precision;


BEGIN
--Busca Pessoa física
select	c.cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	hfp_teste_caminhada a,
	hfp_cinesio_funcional b,
	hfp_paciente c
where	a.nr_seq_aval = b.nr_sequencia
and	b.nr_seq_paciente = c.nr_sequencia
and	a.nr_sequencia = nr_seq_caminhada_p;

--Busca dados para permitir cálculos posteriores
select	obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A'),
	qt_peso,
	qt_altura_cm,
	ie_sexo
into STRICT	qt_idade_w,
	qt_peso_w,
	qt_altura_cm_w,
	ie_sexo_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_w;


-- Calcula parâmetros de referencia para a distância percorrida:
if (ie_sexo_w = 'F') then
	qt_dist_ideal_w := ((2.11 * qt_altura_cm_w) - (2.29 * qt_peso_w) - (5.78 * qt_idade_w) + 667);
	qt_dist_minima_w := qt_dist_ideal_w - 139;
else
	qt_dist_ideal_w := ((7.57 * qt_altura_cm_w) - (1.76 * qt_peso_w) - (5.02 * qt_idade_w) - 309);
	qt_dist_minima_w := qt_dist_ideal_w - 153;
end if;

-- Leitura dos parametros lidos na caminhada
select	sum(coalesce(qt_distancia,0))
into STRICT	qt_dist_total_w
from	hfp_teste_cam_min
where	nr_seq_caminhada = nr_seq_caminhada_p;

qt_perc_fc_w := 220 - qt_idade_w;

update	hfp_teste_caminhada
set	qt_perc_fc 		= qt_perc_fc_w,
	qt_dist_total 		= qt_dist_total_w,
	qt_estimativa_ideal 	= qt_dist_ideal_w,
	qt_lim_inf 		= qt_dist_minima_w,
	nm_usuario 		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia 		= nr_seq_caminhada_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hfp_totalizar_caminhada ( nr_seq_caminhada_p bigint, nm_usuario_p text) FROM PUBLIC;

