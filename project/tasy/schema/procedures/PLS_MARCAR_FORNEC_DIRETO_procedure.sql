-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_marcar_fornec_direto ( nr_seq_prot_p pls_protocolo_conta.nr_sequencia%type) AS $body$
DECLARE


ds_log_call_w		varchar(4000);
ds_observacao_w		varchar(1000);
ie_fornec_direto_w	pls_protocolo_conta.ie_fornec_direto%type;
ie_fornec_direto_novo_w pls_protocolo_conta.ie_fornec_direto%type;
ie_monitoramento_w	varchar(1);


BEGIN

select 	coalesce(ie_fornec_direto,'N') ie_fornec_direto,
	CASE WHEN coalesce(ie_fornec_direto,'N')='N' THEN  'S'  ELSE 'N' END  ie_fornec_direto_novo
into STRICT	ie_fornec_direto_w,
	ie_fornec_direto_novo_w
from	pls_protocolo_conta
where	nr_sequencia = nr_seq_prot_p;

select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
into STRICT	ie_monitoramento_w
from	pls_conta a
where	nr_seq_protocolo = nr_seq_prot_p
and exists (	SELECT 	1 
		from 	pls_monitor_tiss_cta_val 
		where 	nr_seq_conta = a.nr_sequencia);

--Se ja tem monitoramento gerado com presenca do protocolo em quetao, nao atualiza. Posteriormente pode ser gerada uma mensagem no else, caso essa rotina nao venha a ser chamada em lote.
if ( ie_monitoramento_w = 'N') then
	ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
	ds_observacao_w := 'Protocolo '||nr_seq_prot_p||' ie_fornec_direto anterior: '||ie_fornec_direto_w||' novo: '||ie_fornec_direto_novo_w;

	update 	pls_protocolo_conta
	set 	ie_fornec_direto = ie_fornec_direto_novo_w
	where 	nr_sequencia = nr_seq_prot_p;

	insert into plsprco_cta( 	nr_sequencia, dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, nm_tabela,
						ds_log, ds_log_call, ds_funcao_ativa,
						ie_aplicacao_tasy, nm_maquina, nr_seq_protocolo, ie_opcao )
			values ( 	nextval('plsprco_cta_seq'), clock_timestamp(), substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuario nao identificado '),1,14),
						clock_timestamp(), substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuario nao identificado '),1,14), 'PLS_PROTOCOLO_CONTA',
						ds_observacao_w, ds_log_call_w, obter_funcao_ativa,
						pls_se_aplicacao_tasy, wheb_usuario_pck.get_machine, nr_seq_prot_p, '0');

else
	CALL wheb_Mensagem_Pck.exibir_mensagem_abort(1117062);
						
end if;
						
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_marcar_fornec_direto ( nr_seq_prot_p pls_protocolo_conta.nr_sequencia%type) FROM PUBLIC;

