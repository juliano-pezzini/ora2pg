-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atual_adminis_adep ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ie_gerar_adep_p text) AS $body$
DECLARE

 
			 
 
nr_seq_exame_w				exame_laboratorio.nr_seq_exame%type;
dt_prev_execucao_w			prescr_procedimento.dt_prev_execucao%type;
ie_proc_hor_val_w			varchar(1);
nr_seq_alteracao_w			prescr_mat_alteracao.nr_sequencia%type;
cd_procedimento_w			prescr_procedimento.cd_procedimento%type;
nr_seq_proc_interno_w		prescr_procedimento.nr_seq_proc_interno%type;
ie_status_pendente_adep_w	varchar(1);
		
			 
C01 CURSOR FOR 
	SELECT	b.nr_sequencia 
	from	prescr_proc_hor b	 
	where	coalesce(b.nr_seq_proc_origem,b.nr_seq_procedimento)	= nr_seq_prescr_p 
	and		b.nr_prescricao			= nr_prescricao_p 
	order by 1;
	
c01_w	C01%rowtype;


BEGIN 
 
select 	MAX(nr_seq_exame), 
		MAX(dt_prev_execucao), 
		MAX(cd_procedimento), 
		MAX(nr_seq_proc_interno) 
into STRICT 	nr_seq_exame_w, 
		dt_prev_execucao_w, 
		cd_procedimento_w, 
		nr_seq_proc_interno_w 
from 	prescr_procedimento 
where	nr_prescricao = nr_prescricao_p 
and		nr_sequencia = nr_seq_prescr_p;
 
if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then 
 
	ie_status_pendente_adep_w := ie_gerar_adep_p;
	 
	if (ie_status_pendente_adep_w = 'S') then 
			 
			open C01;
			loop 
			fetch C01 into	 
				c01_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin 
				 
				 
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
				into STRICT	ie_proc_hor_val_w 
				from	prescr_proc_hor 
				where	nr_sequencia	= c01_w.nr_sequencia 
				and		(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '') -- Já deve possuir o horário finalizado por coleta de material 
				and		coalesce(dt_suspensao::text, '') = '' 
				and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
					 
			 
			if ( ie_proc_hor_val_w = 'S') then 
				 
				select	nextval('prescr_mat_alteracao_seq') 
				into STRICT	nr_seq_alteracao_w 
				;
				 
				begin 
					insert into prescr_mat_alteracao( 
							nr_sequencia, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							nr_prescricao, 
							nr_seq_prescricao, 
							dt_alteracao, 
							cd_pessoa_fisica, 
							ie_alteracao, 
							nr_seq_horario, 
							ds_observacao, 
							ds_justificativa, 
							nr_seq_procedimento, 
							nr_seq_recomendacao, 
							nr_seq_horario_proc, 
							nr_seq_horario_rec, 
							ie_agrupador, 
							ie_tipo_item, 
							nr_seq_horario_sae, 
							nr_seq_item_sae, 
							dt_hor_acm_sn, 
							nr_seq_horario_dieta, 
							nr_seq_qualidade, 
							nr_seq_satisfacao, 
							dt_horario, 
							nr_atendimento, 
							cd_item, 
							qt_dose_adm, 
							cd_um_dose_adm, 
							nr_seq_motivo, 
							nr_seq_proc_interno) 
						values ( 
							nr_seq_alteracao_w, 
							clock_timestamp(), 
							nm_usuario_p, 
							clock_timestamp(), 
							nm_usuario_p, 
							nr_prescricao_p, 
							null, 
							clock_timestamp(), 
							substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10), 
							81, 
							null, 
							'Administração realizada via PalmWeb, confirmação de envio de material, conforme parâmetro 269', 
							null, 
							nr_seq_prescr_p, 
							null, 
							c01_w.nr_sequencia, 
							null, 
							null, 
							'P', 
							null, 
							null, 
							trunc(dt_prev_execucao_w,'mi'), 
							null, 
							null, 
							null, 
							trunc(dt_prev_execucao_w,'mi'), 
							obter_atendimento_prescr(nr_prescricao_p), 
							cd_procedimento_w, 
							null, 
							null, 
							null, 
							nr_seq_proc_interno_w);		
									 
					exception 
					when others then 
					nr_seq_alteracao_w := 0;	
					end;
					 
				end if;
				 
				end;
			end loop;
			close C01;	
	end if;	
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atual_adminis_adep ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ie_gerar_adep_p text) FROM PUBLIC;

