-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_protocolo ( cd_protocolo_origem_p bigint, nm_usuario_p text, cd_protocolo_dest_p bigint) AS $body$
DECLARE


nr_sequencia_o_w		bigint;
nr_sequencia_d_w		bigint;
nm_medicacao_w			varchar(255);
nr_ciclos_w				smallint;
nr_dias_intervalo_w		smallint;
cd_medico_resp_w		bigint;
ie_padrao_usuario_w		varchar(2);
ie_situacao_w			protocolo_medicacao.ie_situacao%type;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		nm_medicacao,
		nr_ciclos,
		nr_dias_intervalo,
		cd_medico_resp,
		ie_padrao_usuario,
		ie_situacao
	from	protocolo_medicacao
	where	cd_protocolo	= cd_protocolo_origem_p;


BEGIN

delete	from protocolo_consulta
where	cd_protocolo 		= cd_protocolo_dest_p;

delete	from protocolo_medic_proc
where	cd_protocolo 	= cd_protocolo_dest_p;

delete	from prot_solic_bco_sangue
where	cd_protocolo		= cd_protocolo_dest_p;

delete	from kit_material
where	nr_seq_protocolo	in (SELECT	nr_seq_interna
	from 	protocolo_medicacao
	where	cd_protocolo	= cd_protocolo_dest_p);

Delete from protocolo_medicacao
where cd_protocolo = cd_protocolo_dest_p;

Delete from protocolo_descricao
where cd_protocolo = cd_protocolo_dest_p;

Delete from protocolo_grupo_descricao
where cd_protocolo = cd_protocolo_dest_p;

delete	from protocolo_procedimento
where	cd_protocolo 	= cd_protocolo_dest_p;

delete	from protocolo_exame
where	cd_protocolo	= cd_protocolo_dest_p;

delete	from protocolo_proc_interno
where	cd_protocolo	= cd_protocolo_dest_p;

open c01;
loop
	fetch c01 into
		nr_sequencia_o_w,
		nm_medicacao_w,
		nr_ciclos_w,
		nr_dias_intervalo_w,
		cd_medico_resp_w,
		ie_padrao_usuario_w,
		ie_situacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	select (coalesce(max(nr_sequencia),0) + 1)
	into STRICT	nr_sequencia_d_w
	from	protocolo_medicacao
	where	cd_protocolo = cd_protocolo_dest_p;

	Insert into protocolo_medicacao(
		nr_seq_interna,
		cd_protocolo,
		nr_sequencia,
		nm_medicacao,
		nr_ciclos,
		nr_dias_intervalo,
		ie_situacao,
		dt_atualizacao,
		nm_usuario,
		cd_medico_resp,
		ie_padrao_usuario)
	values (
		nextval('protocolo_medicacao_seq'),
		cd_protocolo_dest_p,
		nr_sequencia_d_w,
		nm_medicacao_w,
		nr_ciclos_w,
		nr_dias_intervalo_w,
		ie_situacao_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_medico_resp_w,
		ie_padrao_usuario_w);

	commit;

	CALL Copiar_Medicacao_Protocolo(cd_protocolo_origem_p,nr_sequencia_o_w,nm_usuario_p,cd_protocolo_dest_p,nr_sequencia_d_w,'S','S','S','S','S','S','S','S','S','S','S','S','S','S','N');
end loop;
close c01;

insert into protocolo_descricao(
	cd_protocolo,
	nr_sequencia,
	ds_frase,
	ie_padrao,
	dt_atualizacao,
	nm_usuario,
	qt_tamanho_fonte,
	ie_sexo,
	ds_cor_fonte,
	ds_tipo_fonte,
	ds_estilo_fonte,
	cd_interno,
	nr_seq_apres,
	qt_espaco_linha)
SELECT
	cd_protocolo_dest_p,
	nr_sequencia,
	ds_frase,
	ie_padrao,
	clock_timestamp(),
	nm_usuario_p,
	qt_tamanho_fonte,
	ie_sexo,
	ds_cor_fonte,
	ds_tipo_fonte,
	ds_estilo_fonte,
	cd_interno,
	nr_seq_apres,
	qt_espaco_linha
from	protocolo_descricao
where	cd_protocolo = cd_protocolo_origem_p;

insert into protocolo_grupo_descricao(
	nr_sequencia,
	cd_protocolo,
	dt_atualizacao,
	nm_usuario,
	ds_grupo,
	nr_seq_apres)
SELECT
	nextval('protocolo_grupo_descricao_seq'),
	cd_protocolo_dest_p,
	clock_timestamp(),
	nm_usuario_p,
	ds_grupo,
	nr_seq_apres
from	protocolo_grupo_descricao
where	cd_protocolo = cd_protocolo_origem_p;

insert into protocolo_procedimento(
	cd_protocolo,
	cd_procedimento,
	ie_origem_proced,
	dt_atualizacao,
	nm_usuario)
SELECT
	cd_protocolo_dest_p,
	cd_procedimento,
	ie_origem_proced,
	clock_timestamp(),
	nm_usuario_p
from	protocolo_procedimento
where	cd_protocolo = cd_protocolo_origem_p;

insert into protocolo_exame(
	nr_sequencia,
	cd_protocolo,
	nr_seq_exame,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec)
SELECT
	nextval('protocolo_exame_seq'),
	cd_protocolo_dest_p,
	nr_seq_exame,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p
from	protocolo_exame
where	cd_protocolo = cd_protocolo_origem_p;

insert into protocolo_proc_interno(
	nr_sequencia,
	cd_protocolo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_proc_interno,
	dt_atualizacao_nrec,
	nm_usuario_nrec)
SELECT
	nextval('protocolo_proc_interno_seq'),
	cd_protocolo_dest_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_proc_interno,
	clock_timestamp(),
	nm_usuario_p
from	protocolo_proc_interno
where	cd_protocolo = cd_protocolo_origem_p;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_protocolo ( cd_protocolo_origem_p bigint, nm_usuario_p text, cd_protocolo_dest_p bigint) FROM PUBLIC;

