-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE realizar_perda_medic ( nr_seq_ordem_p bigint, cd_setor_atendimento_p bigint, cd_operacao_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
			 
nr_seq_cabine_w		bigint;
nr_seq_etapa_prod_w	bigint;
nr_atendimento_w	bigint;
cd_material_w		integer;
cd_unidade_medida_w	varchar(30);
qt_material_w		double precision;
dt_prescricao_w		timestamp;
nr_prescricao_w		bigint;
cd_motivo_baixa_w	varchar(1);
nr_seq_lote_fornec_w	bigint;
ie_via_aplicacao_w	varchar(5);
nr_seq_item_prescr_w	bigint;
cd_local_estoque_w	smallint;
cd_oper_perda_etq_w	smallint;
nr_sequencia_w		bigint;
			
C01 CURSOR FOR 
	SELECT	coalesce(a.nr_atendimento,c.nr_atendimento), 
		b.cd_material, 
		b.cd_unidade_medida_real, 
		b.qt_dose_real, 
		c.dt_prescricao, 
		a.nr_prescricao, 
		b.nr_seq_lote_fornec, 
		a.ie_via_aplicacao, 
		b.nr_seq_item_prescr, 
		nr_seq_etapa_prod 
	from	prescr_medica c, 
		can_ordem_prod_mat b, 
		can_ordem_prod a 
	where	a.nr_sequencia	= nr_seq_ordem_p 
	and	a.nr_prescricao	= c.nr_prescricao 
	and	a.nr_sequencia	= b.nr_seq_ordem 
	and 	b.cd_material = cd_material_p 
	and 	coalesce(a.ie_medic_paciente,'N') = 'N';

  c02 CURSOR FOR 
  SELECT	nr_sequencia 
	from	material_atend_paciente 
	where 	nr_seq_ordem_prod  = nr_seq_ordem_p 
	and	  cd_material     = cd_material_p;
				

BEGIN 
 
if (cd_operacao_p IS NOT NULL AND cd_operacao_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then 
		 
  open C02;
  loop 
  fetch C02 into	 
  	nr_sequencia_w;
  EXIT WHEN NOT FOUND; /* apply on C02 */
  	begin 
    CALL voltar_item_pendente_prescr(nr_sequencia_w, nm_usuario_p);
    CALL excluir_glosa_valor_mat(nr_sequencia_w, nm_usuario_p);
  	end;
  end loop;
  close C02;
   
 
	open C01;
	loop 
	fetch C01 into	 
		nr_atendimento_w, 
		cd_material_w, 
		cd_unidade_medida_w, 
		qt_material_w, 
		dt_prescricao_w, 
		nr_prescricao_w, 
		nr_seq_lote_fornec_w, 
		ie_via_aplicacao_w, 
		nr_seq_item_prescr_w, 
		nr_seq_etapa_prod_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		select	max(nr_seq_cabine) 
		into STRICT	nr_seq_cabine_w 
		from	far_etapa_producao 
		where	nr_sequencia = nr_seq_etapa_prod_w;
		 
		select	cd_local_estoque, 
			cd_oper_perda_etq 
		into STRICT	cd_local_estoque_w, 
			cd_oper_perda_etq_w 
		from	far_cabine_seg_biol 
		where	nr_sequencia = nr_seq_cabine_w;
		 
		-- Baixa como perda de medicação 
		insert into movimento_estoque( 
			nr_movimento_estoque,		cd_estabelecimento, 
			cd_local_estoque,		dt_movimento_estoque, 
			cd_operacao_estoque,		cd_acao, 
			cd_material,			cd_unidade_med_mov, 
			qt_movimento,			dt_mesano_referencia, 
			dt_atualizacao,			nm_usuario, 
			ie_origem_documento,		nr_documento, 
			cd_unidade_medida_estoque,	cd_setor_atendimento, 
			qt_estoque,			ds_observacao, 
			nr_atendimento,			nr_prescricao, 
			nr_seq_lote_fornec) 
		values (nextval('movimento_estoque_seq'),	wheb_usuario_pck.get_cd_estabelecimento, 
			cd_local_estoque_w,		clock_timestamp(), 
			cd_operacao_p,			'1', 
			cd_material_w,			cd_unidade_medida_w, 
			qt_material_w,			clock_timestamp(), 
			clock_timestamp(),			nm_usuario_p, 
			'10',				nr_seq_ordem_p, 
			cd_unidade_medida_w,		cd_setor_atendimento_p, 
			qt_material_w,			'realizar_perda_medic' || nr_seq_ordem_p, 
			nr_atendimento_w,		nr_prescricao_w, 
			nr_seq_lote_fornec_w);
		commit;
		 
		end;
	end loop;
	close C01;
 
		update 	can_ordem_prod_mat 
	set 	ie_devolve_cabine = 'N' 
	where 	nr_seq_ordem = nr_seq_ordem_p 
	and	cd_material = cd_material_p;
	 
	commit;
	 
	delete 	from can_ordem_prod_mat 
	where 	nr_seq_ordem = nr_seq_ordem_p 
	and	cd_material = cd_material_p;
 
	commit;
 
	update	can_ordem_prod 
	set	dt_entrega_setor 	 = NULL, 
		nm_usuario_disp		 = NULL, 
		dt_inicio_preparo	 = NULL, 
		nm_usuario_inic_prep	 = NULL, 
		dt_fim_preparo		 = NULL, 
		dt_solic_perda 		 = NULL 
	where	nr_sequencia		= nr_seq_ordem_p;
 
 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE realizar_perda_medic ( nr_seq_ordem_p bigint, cd_setor_atendimento_p bigint, cd_operacao_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

