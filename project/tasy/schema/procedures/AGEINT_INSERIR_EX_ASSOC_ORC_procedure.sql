-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_inserir_ex_assoc_orc ( nr_seq_proc_orc_p bigint, nr_seq_ageint_p bigint, nr_seq_ageint_item_princ_p bigint, nr_proc_orc_assoc_p bigint, nr_seq_proc_interno_assoc_p bigint, cd_procedimento_assoc_p bigint, ie_origem_proced_assoc_p bigint, ie_exame_assoc_p text, vl_proc_assoc_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
cd_plano_w		varchar(10);
ie_tipo_atendimento_w	smallint;
nr_seq_proc_interno_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ds_aux_w		varchar(10);
ie_regra_w		integer;
ie_glosa_w		varchar(1);
cd_usuario_convenio_w	varchar(30);
vl_aux_w		double precision;
qt_idade_w		smallint;
ie_sexo_w		varchar(1);
dt_nascimento_w		timestamp;
cd_pessoa_Fisica_w	varchar(10);
nr_seq_regra_w		bigint;
qt_exame_Assoc_w	bigint;
vl_exame_w		double precision;
			

BEGIN 
 
nr_seq_proc_interno_w	:= nr_seq_proc_interno_assoc_p;
cd_procedimento_w	:= cd_procedimento_assoc_p;
ie_origem_proced_w	:= ie_origem_proced_assoc_p;
 
select	cd_convenio, 
	cd_categoria, 
	cd_plano, 
	ie_tipo_atendimento, 
	cd_usuario_convenio, 
	cd_pessoa_fisica 
into STRICT	cd_convenio_w, 
	cd_categoria_w, 
	cd_plano_w, 
	ie_tipo_atendimento_w, 
	cd_usuario_convenio_w, 
	cd_pessoa_fisica_w 
from	orcamento_paciente a, 
	orcamento_paciente_proc b 
where	b.nr_sequencia	= nr_seq_proc_orc_p 
and	a.nr_sequencia_orcamento	= b.nr_sequencia_orcamento;
 
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
	select	max(ie_Sexo), 
		max(dt_nascimento) 
	into STRICT	ie_Sexo_w, 
		dt_nascimento_w 
	from	pessoa_fisica 
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
end if;
 
qt_idade_w	:= obter_idade(dt_nascimento_w, clock_timestamp(), 'A');
 
if (nr_seq_proc_interno_w	> 0) then 
	select	count(*) 
	into STRICT	qt_exame_assoc_w 
	from	ageint_Exame_associado 
	where	nr_seq_proc_interno	= nr_seq_proc_interno_w 
	and	nr_seq_Ageint_item	= nr_seq_ageint_item_princ_p;
	 
	if (coalesce(nr_seq_proc_interno_w::text, '') = '') then 
		if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') and (ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') then 
			select	coalesce(max(nr_sequencia),0) 
			into STRICT	nr_seq_proc_interno_w 
			from	proc_interno 
			where	cd_procedimento		= cd_procedimento_w 
			and	ie_origem_proced	= ie_origem_proced_w;
			 
			if (nr_seq_proc_interno_w	= 0) then	 
				select	max(nr_Seq_proc_interno) 
				into STRICT	nr_Seq_proc_interno_w 
				from	proc_interno_conv 
				where	cd_procedimento		= cd_procedimento_w 
				and	ie_origem_proced	= ie_origem_proced_w;
			end if;
		end if;
	elsif (coalesce(cd_procedimento_w::text, '') = '') or (coalesce(ie_origem_proced_w::text, '') = '') then 
		SELECT * FROM obter_proc_tab_interno(nr_seq_proc_interno_w, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;			
	end if;
	 
	if (ie_exame_assoc_p	= 'S') then 
	 
		SELECT * FROM Consiste_Plano_mat_proc(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_plano_w, null, cd_procedimento_w, ie_origem_proced_w, null, coalesce(ie_tipo_Atendimento_w,0), 0, 0, null, nr_Seq_proc_interno_w, ds_aux_w, ds_aux_w, ie_regra_w, nr_seq_regra_w) INTO STRICT ds_aux_w, ds_aux_w, ie_regra_w, nr_seq_regra_w;
		SELECT * FROM obter_regra_Ajuste_proc( 
					cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), null, coalesce(ie_tipo_Atendimento_w,0), null, null, null, qt_idade_w, NULL, nr_Seq_proc_interno_w, cd_usuario_convenio_w, cd_plano_w, null, null, ie_sexo_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, ds_aux_w, ie_glosa_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, null, null, ds_aux_w, vl_aux_w, ds_aux_w, vl_aux_w, null, null, null, null, null, null, null, null, vl_aux_w, null, null, null, null, null, null, null, null, null, null) INTO STRICT vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, ds_aux_w, ie_glosa_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, vl_aux_w, ds_aux_w, vl_aux_w, ds_aux_w, vl_aux_w, vl_aux_w;		
		 
		if (qt_exame_assoc_w	= 0) then 
			insert into ageint_exame_associado(nr_sequencia, 
				nr_seq_ageint_item, 
				nr_seq_proc_interno, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				cd_procedimento, 
				ie_origem_proced, 
				ie_regra, 
				ie_glosa, 
				vl_exame) 
			values (nextval('ageint_exame_associado_seq'), 
				nr_seq_ageint_item_princ_p, 
				nr_seq_proc_interno_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_procedimento_w, 
				ie_origem_proced_w, 
				ie_regra_w, 
				ie_glosa_w, 
				vl_proc_assoc_p);
		end if;
	else 
		insert into agenda_integrada_item(nr_sequencia, 
				nr_seq_agenda_int, 
				nm_usuario, 
				dt_atualizacao, 
				nm_usuario_nrec, 
				dt_atualizacao_nrec, 
				nr_seq_proc_interno, 
				cd_procedimento, 
				ie_origem_proced, 
				ie_tipo_agendamento) 
			values (nextval('agenda_integrada_item_seq'), 
				nr_seq_ageint_p, 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nr_seq_proc_interno_w, 
				cd_procedimento_w, 
				ie_origem_proced_w, 
				'E');
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_inserir_ex_assoc_orc ( nr_seq_proc_orc_p bigint, nr_seq_ageint_p bigint, nr_seq_ageint_item_princ_p bigint, nr_proc_orc_assoc_p bigint, nr_seq_proc_interno_assoc_p bigint, cd_procedimento_assoc_p bigint, ie_origem_proced_assoc_p bigint, ie_exame_assoc_p text, vl_proc_assoc_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

