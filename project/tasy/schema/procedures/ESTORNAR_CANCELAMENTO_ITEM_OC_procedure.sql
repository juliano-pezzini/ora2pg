-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_cancelamento_item_oc ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_registro_w			bigint;
qt_prevista_entrega_w		double precision;
nr_ordem_compra_w		bigint;
nr_item_oci_w			integer;
dt_prevista_entrega_w		timestamp;
ie_estorna_processo_w		varchar(1);
ds_titulo_w			varchar(80);
ds_mensagem_w			varchar(500);
cd_material_w			varchar(20);
ds_material_w			material.ds_material%type;

qt_material_cancelado_w			solic_compra_item.qt_material_cancelado%type;


BEGIN

select	a.nr_ordem_compra,
	a.nr_item_oci,
	a.dt_prevista_entrega,
	c.cd_material,
	c.ds_material
into STRICT	nr_ordem_compra_w,
	nr_item_oci_w,
	dt_prevista_entrega_w,
	cd_material_w,
	ds_material_w
from	ordem_compra_item_entrega a,
	ordem_compra_item b,
	material c
where	a.nr_sequencia = nr_sequencia_p
and	b.nr_ordem_compra = a.nr_ordem_compra
and	b.nr_item_oci = a.nr_item_oci
and	b.cd_material = c.cd_material;

select	obter_valor_param_usuario(917, 162, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)
into STRICT	ie_estorna_processo_w
;

select	count(*)
into STRICT	qt_registro_w
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_w
and	nr_item_oci = nr_item_oci_w
and	dt_prevista_entrega = dt_prevista_entrega_w
and	coalesce(dt_cancelamento::text, '') = '';

if (ie_estorna_processo_w = 'S') then

	select	qt_prevista_entrega - coalesce(qt_real_entrega,0)
	into STRICT	qt_material_cancelado_w
	from	ordem_compra_item_entrega
	where	nr_sequencia = nr_sequencia_p;

	CALL estorna_cancel_processo_compra(	nr_ordem_compra_w,
				nr_item_oci_w,
				nm_usuario_p,
				qt_material_cancelado_w);
end if;

if (qt_registro_w > 0) then
	begin
	select	qt_prevista_entrega
	into STRICT	qt_prevista_entrega_w
	from	ordem_compra_item_entrega
	where	nr_sequencia = nr_sequencia_p;

	update	ordem_compra_item_entrega
	set	qt_prevista_entrega = qt_prevista_entrega + qt_prevista_entrega_w
	where	nr_ordem_compra = nr_ordem_compra_w
	and	nr_item_oci = nr_item_oci_w
	and	dt_prevista_entrega = dt_prevista_entrega_w
	and	coalesce(dt_cancelamento::text, '') = '';

	delete	FROM ordem_compra_item_entrega
	where	nr_sequencia      = nr_sequencia_p;
	end;
else
	update	ordem_compra_item_entrega
	set	dt_cancelamento	= '',
		ds_observacao		= ''
	where	nr_sequencia		= nr_sequencia_p;
end if;


ds_titulo_w	:= WHEB_MENSAGEM_PCK.get_texto(300328);
ds_mensagem_w	:= WHEB_MENSAGEM_PCK.get_texto(300331,'CD_MATERIAL_W=' || cd_material_w || ';' || 'DS_MATERIAL_W=' || ds_material_w || ';' ||
									'DT_PREVISTA_ENTREGA_W=' || to_char(dt_prevista_entrega_w,'dd/mm/yyyy'));

CALL gerar_ordem_compra_hist(nr_ordem_compra_w,
			'S',
			ds_titulo_w,
			ds_mensagem_w,
			nm_usuario_p);

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_cancelamento_item_oc ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

