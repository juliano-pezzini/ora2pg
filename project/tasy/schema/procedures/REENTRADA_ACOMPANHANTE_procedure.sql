-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reentrada_acompanhante ( nr_atendimento_p bigint, nr_atend_acomp_p bigint, dt_acompanhante_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, dt_acomp_p INOUT timestamp) AS $body$
DECLARE

	
qt_atendimento_w		bigint;
nr_acompanhante_w	smallint;
vl_parametro_w		varchar(255);
vl_param_w		varchar(255);
ds_texto_w		varchar(255);
ds_mensagem_w		varchar(255);
ie_forma_cons_acomp_w	varchar(5);
dt_acomp_w		timestamp;

	

BEGIN
	
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then	
	begin
	
	ie_forma_cons_acomp_w := Obter_Param_Usuario(44, 76, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_forma_cons_acomp_w);

	if (ie_forma_cons_acomp_w = 'EA') then		
		select	coalesce(sum(a.qt_max_acomp),0)
		into STRICT	nr_acompanhante_w
		from	unidade_atendimento a
		where	a.nr_atendimento = nr_atendimento_p;
		
	elsif (ie_forma_cons_acomp_w = 'UEU') then
		select 	max(a.nr_acompanhante)
		into STRICT 	nr_acompanhante_w
		from 	atend_categoria_convenio a
		where 	a.nr_atendimento = nr_atendimento_p
		and 	a.nr_seq_interno = (SELECT max(b.nr_seq_interno) from atend_categoria_convenio b where b.nr_atendimento = nr_atendimento_p);
		
	else
		select	coalesce(sum(a.nr_acompanhante),0)
		into STRICT	nr_acompanhante_w
		from	atend_categoria_convenio a
		where	a.nr_atendimento = nr_atendimento_p;
	end if;

	select	count(*)
	into STRICT	qt_atendimento_w
	from	atendimento_acompanhante
	where	nr_atendimento	= nr_atendimento_p
	and	coalesce(dt_saida::text, '') = '';

	if (qt_atendimento_w >= nr_acompanhante_w) then
		begin		
		vl_parametro_w := Obter_Param_Usuario(44, 23, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, vl_parametro_w);
		if (vl_parametro_w = 'B') then
			begin
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(27307);			
			end;
		elsif (vl_parametro_w = 'A') then
			ds_mensagem_w	:= substr(obter_texto_tasy(27308, null),1,255);
		end if;		
		end;
	end if;
	
	CALL reentrada_atend_acomp(nr_atend_acomp_p, dt_acompanhante_p, nm_usuario_p);
	
	vl_param_w := Obter_Param_Usuario(44, 123, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, vl_param_w);
	
	if (vl_param_w = 'S') then
		select	max(dt_acompanhante)
		into STRICT	dt_acomp_w
		from	atendimento_acompanhante;		
	end if;
	
	end;
end if;

ds_mensagem_p	:= ds_mensagem_w;
dt_acomp_p	:= dt_acomp_w;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reentrada_acompanhante ( nr_atendimento_p bigint, nr_atend_acomp_p bigint, dt_acompanhante_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, dt_acomp_p INOUT timestamp) FROM PUBLIC;

