-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_autor_conv_futura ( cd_estabelecimento_p bigint, nr_seq_paciente_setor_p bigint, dt_inicio_vigencia_p timestamp, nr_ciclo_p bigint, nm_usuario_p text ) AS $body$
DECLARE

	
nr_sequencia_aut_conv_w		bigint;
nr_sequencia_aut_conv_new_w	bigint;
cd_material_w			integer;
qt_solicitada_w			double precision;
nr_seq_fabricante_w		bigint;
nr_seq_estagio_w			bigint;
ie_via_aplicacao_w		material_autorizado.ie_via_aplicacao%type;
cd_int_medic_quimio_w		material_autorizado.cd_intervalo_medic_quimio%type;
cd_material_informado_w		material_autorizado.cd_material_informado%type;	
qt_dose_quimio_w			material_autorizado.qt_dose_quimio%type;
ie_valor_conta_w			material_autorizado.ie_valor_conta%type;
cd_material_convenio_w		material_autorizado.cd_material_convenio%type;
qt_lote_anexo_w			integer;


c01 CURSOR FOR
	SELECT	cd_material,
		qt_solicitada,
		nr_seq_fabricante,
		ie_via_aplicacao,
		cd_intervalo_medic_quimio,
		cd_material_informado,
		qt_dose_quimio,
		ie_valor_conta,
		cd_material_convenio
	from	material_autorizado
	where	nr_sequencia_autor = nr_sequencia_aut_conv_w
	order	by nr_sequencia;
					


BEGIN

select	max(nr_sequencia)
into STRICT	nr_sequencia_aut_conv_w
from	autorizacao_convenio
where	nr_seq_paciente_setor = nr_seq_paciente_setor_p;


if (nr_sequencia_aut_conv_w IS NOT NULL AND nr_sequencia_aut_conv_w::text <> '') then

	select	min(nr_sequencia)
	into STRICT	nr_seq_estagio_w
	from	estagio_autorizacao a
	where	a.cd_empresa	= obter_empresa_estab(cd_estabelecimento_p)
	and	a.ie_situacao	= 'A'
	and	a.ie_interno	= '1';

	select 	nextval('autorizacao_convenio_seq')
	into STRICT	nr_sequencia_aut_conv_new_w
	;
		
	insert	into autorizacao_convenio(
		nr_atendimento,
		nr_seq_autorizacao,
		cd_convenio,
		cd_autorizacao,
		dt_autorizacao,
		dt_inicio_vigencia,
		dt_atualizacao,
		nm_usuario,
		dt_fim_vigencia,
		nm_responsavel,
		ds_observacao,
		cd_senha,
		cd_procedimento_principal,
		ie_origem_proced,
		dt_pedido_medico,
		cd_medico_solicitante,
		ie_tipo_guia,
		qt_dia_autorizado,
		nr_prescricao,
		dt_envio,
		dt_retorno,
		nr_seq_estagio,
		ie_tipo_autorizacao,
		ie_tipo_dia,
		cd_tipo_acomodacao,
		nr_seq_autor_cirurgia,
		ds_indicacao,
		dt_geracao_cih,
		nr_sequencia,
		nr_seq_agenda,
		qt_dia_solicitado,
		nr_seq_proc_interno,
		cd_procedimento_convenio,
		dt_entrada_prevista,
		nr_seq_gestao,
		ie_carater_int_tiss,
		nr_seq_autor_origem,
		ie_resp_autor,
		nr_seq_agenda_consulta,
		nr_seq_autor_desdob,
		cd_cgc_prestador,
		nr_seq_paciente_setor,
		nr_ciclo,
		nr_seq_age_integ,
		nr_seq_paciente,
		cd_medico_solic_tiss,
		nr_seq_classif,
		nr_interno_conta_ref,
		nr_seq_agenda_proc,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_pessoa_fisica,
		ie_previsao_uso_quimio,
		ie_tipo_internacao_tiss,
		nr_seq_rxt_tratamento,
		cd_empresa_pac,
		cd_setor_resp,
		ie_tiss_tipo_anexo_autor,
		cd_setor_origem,
		dt_agenda,
		cd_estabelecimento
		)
		SELECT 	nr_atendimento,
			nr_seq_autorizacao,
			cd_convenio,
			cd_autorizacao,
			clock_timestamp(),
			dt_inicio_vigencia_p,
			clock_timestamp(),
			nm_usuario_p,
			dt_fim_vigencia,
			nm_responsavel,
			ds_observacao,
			cd_senha,
			cd_procedimento_principal,
			ie_origem_proced,
			dt_pedido_medico,
			cd_medico_solicitante,
			ie_tipo_guia,
			qt_dia_autorizado,
			nr_prescricao,
			dt_envio,
			dt_retorno,
			nr_seq_estagio_w,
			ie_tipo_autorizacao,
			ie_tipo_dia,
			cd_tipo_acomodacao,
			nr_seq_autor_cirurgia,
			ds_indicacao,
			dt_geracao_cih,
			nr_sequencia_aut_conv_new_w,
			nr_seq_agenda,
			qt_dia_solicitado,
			nr_seq_proc_interno,
			cd_procedimento_convenio,
			dt_entrada_prevista,
			nr_seq_gestao,
			ie_carater_int_tiss,
			nr_seq_autor_origem,
			ie_resp_autor,
			nr_seq_agenda_consulta,
			nr_seq_autor_desdob,
			cd_cgc_prestador,
			nr_seq_paciente_setor,
			nr_ciclo_p,
			nr_seq_age_integ,
			nr_seq_paciente,
			cd_medico_solic_tiss,
			nr_seq_classif,
			nr_interno_conta_ref,
			nr_seq_agenda_proc,
			clock_timestamp(),
			nm_usuario_p,
			cd_pessoa_fisica,
			ie_previsao_uso_quimio,
			ie_tipo_internacao_tiss,
			nr_seq_rxt_tratamento,
			cd_empresa_pac,
			cd_setor_resp,
			ie_tiss_tipo_anexo_autor,
			cd_setor_origem,
			dt_agenda,
			cd_estabelecimento
		from	autorizacao_convenio
		where	nr_sequencia = nr_sequencia_aut_conv_w;
	
	
	open c01;
	loop
	fetch c01 into
		cd_material_w,
		qt_solicitada_w,
		nr_seq_fabricante_w,
		ie_via_aplicacao_w,
		cd_int_medic_quimio_w,
		cd_material_informado_w,
		qt_dose_quimio_w,
		ie_valor_conta_w,
		cd_material_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
	
		insert	into material_autorizado(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_sequencia_autor,
			cd_material,
			qt_solicitada,
			nr_seq_fabricante,
			qt_autorizada,
			ie_via_aplicacao,
			cd_intervalo_medic_quimio,
			cd_material_informado,
			qt_dose_quimio,
			ie_valor_conta,
			cd_material_convenio
			)
		values (
			nextval('material_autorizado_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_aut_conv_new_w,
			cd_material_w,
			qt_solicitada_w,
			nr_seq_fabricante_w,
			0,
			ie_via_aplicacao_w,
			cd_int_medic_quimio_w,
			cd_material_informado_w,
			qt_dose_quimio_w,
			ie_valor_conta_w,
			cd_material_convenio_w
			);
					
		end;
	end loop;
	close c01;	
	
	commit;
	
	CALL TISS_GERAR_ANEXO_GUIA(nr_sequencia_aut_conv_new_w,nm_usuario_p);
	
else
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262608);	
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_autor_conv_futura ( cd_estabelecimento_p bigint, nr_seq_paciente_setor_p bigint, dt_inicio_vigencia_p timestamp, nr_ciclo_p bigint, nm_usuario_p text ) FROM PUBLIC;

