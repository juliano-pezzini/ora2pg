-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_estagio_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ X ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
	Tipo de protocolo criado 
		T - Tasy 
		P - Portal envio XML (TISS) 
		D - Digitação de conta pelo portal 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ie_tipo_protocolo_w		varchar(3);
ie_forma_imp_w			varchar(3);
ie_analise_cm_nova_w		varchar(3)	:= 'N';
nr_seq_conta_pos_w		bigint;
qt_pos_estab_w			bigint;
qt_item_pos_estab_w		bigint;
nr_seq_analise_w		pls_analise_conta.nr_sequencia%type;
nr_seq_log_exec_w		pls_cta_log_exec.nr_sequencia%type;


BEGIN 
select	coalesce(a.ie_tipo_protocolo, 'C'), 
	coalesce(a.ie_forma_imp, 'T') 
into STRICT	ie_tipo_protocolo_w, 
	ie_forma_imp_w 
from	pls_protocolo_conta	a, 
	pls_conta		b 
where	a.nr_sequencia	= b.nr_seq_protocolo 
and	b.nr_sequencia	= nr_seq_conta_p;
 
begin 
select	coalesce(a.ie_analise_cm_nova, 'N') 
into STRICT	ie_analise_cm_nova_w 
from	pls_parametros	a 
where	a.cd_estabelecimento	= cd_estabelecimento_p;
exception 
when others then 
	ie_analise_cm_nova_w	:= 'N';
end;
 
/* Contas de reembolso não vão pra análise OS - 277557 Diego OPS */
 /*and ie_forma_imp_w <> 'D' retirado da restrição pois não estava gerando análise para contas digitadas no portal, OS 415921*/
 
if (ie_tipo_protocolo_w <> 'R') then 
	if (ie_analise_cm_nova_w = 'S') then 
		nr_seq_log_exec_w := pls_cta_processo_pck.executa_processo(	null, null, null, nr_seq_conta_p, null, null, null, null, '31,', null, nm_usuario_p, cd_estabelecimento_p, null, nr_seq_log_exec_w);
	else 
	 	CALL pls_gerar_analise_conta(nr_seq_conta_p, nm_usuario_p, cd_estabelecimento_p); /*Se houver inconsistencias é gerado analise na conta ou um de seus itens*/
	end if;
	 
	select	count(1) 
	into STRICT	qt_pos_estab_w 
	from	pls_conta_pos_estabelecido a 
	where	a.nr_seq_conta	= nr_seq_conta_p 
	and	((ie_situacao		= 'A') or (coalesce(ie_situacao::text, '') = '')) 
	and	((a.nr_seq_conta_proc IS NOT NULL AND a.nr_seq_conta_proc::text <> '') or (a.nr_seq_conta_mat IS NOT NULL AND a.nr_seq_conta_mat::text <> ''))  LIMIT 1;
	 
	if (qt_pos_estab_w > 0) then /* Tratado para gerar análise de pós somente quando haver itens de pós */
 
	 
		CALL pls_gerar_analise_pos_estab(nr_seq_conta_p, nm_usuario_p, cd_estabelecimento_p,'C');
	end if;
end if;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_estagio_conta ( nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

