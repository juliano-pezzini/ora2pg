-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_hor_prescr_mat_hor ( nr_prescricao_p bigint) AS $body$
DECLARE


dt_inicio_prescr_w			timestamp;
dt_fim_prescricao_w			timestamp;
dt_horario_w				timestamp;
dt_primeiro_horario_w		timestamp;
dt_prim_horario_medic_w		timestamp;
dt_limite_w					timestamp;
hr_prim_horario_w			varchar(5);
cd_material_w				integer;
cd_intervalo_w				varchar(7);
qt_operacao_w				intervalo_prescricao.qt_operacao%type;
ie_operacao_w				varchar(1);
nr_horas_intervalo_w		real;
nr_prescricao_w				bigint;
nm_usuario_original_w		varchar(15);
nr_atendimento_w			bigint;
qt_duplo_w					bigint;
ie_tipo_w					varchar(1);
nr_seq_ficha_tecnica_w		varchar(15);
nr_sequencia_w				bigint;
nr_seq_material_w			integer;
nr_sequencia_ww				bigint;
nr_seq_material_ww			integer;
ie_apresenta_rep_ant_w		char(1) := 'N';
nm_usuario_w				varchar(15);
ie_considera_princ_ativo_w	char(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
qt_dose_w					prescr_material.qt_dose%type;
cd_unidade_medida_w 	   prescr_material.cd_unidade_medida_dose%type;

C01 CURSOR FOR
	SELECT	a.dt_inicio_prescr,
			a.dt_fim_prescricao,
			a.dt_primeiro_horario,
			b.hr_prim_horario,
			b.cd_material,
			b.cd_intervalo,
			a.nm_usuario_original,
			a.nr_atendimento,
			b.qt_dose,
			obter_dados_material(b.cd_material,'FT'),
			b.cd_unidade_medida_dose
	from	prescr_material b,
			prescr_medica a
	where	a.nr_prescricao	= b.nr_prescricao
	and		a.nr_prescricao	= nr_prescricao_p
	and		b.ie_agrupador in (1,4,12);

C02 CURSOR FOR
	SELECT	b.nr_prescricao,
			b.dt_horario,
			b.nr_sequencia,
			b.nr_seq_material
	from	ap_lote c,
			prescr_mat_hor b,
			prescr_medica a,
			prescr_material g
	where	g.nr_prescricao 	= a.nr_prescricao
	and		a.nr_atendimento	= nr_atendimento_w
	and		g.nr_prescricao		= b.nr_prescricao
	and		g.nr_sequencia		= b.nr_seq_material	
	and		((b.cd_material		= cd_material_w) or 
			 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(b.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
	and		b.qt_dose			= qt_dose_w
	and		b.cd_unidade_medida_dose = cd_unidade_medida_w
	and		b.dt_horario		> dt_limite_w
	and		a.nr_prescricao		<> nr_prescricao_p
	and		b.ie_agrupador		in (1,4,12)
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and		b.nr_seq_lote		= c.nr_sequencia
	and		((coalesce(ie_apresenta_rep_ant_w,'N') = 'N') and 
			 ((coalesce(c.ie_status_lote,'G') in ('G')) and
			   exists(	SELECT	1
						from	prescr_mat_hor d,
								prescr_medica e,
								prescr_material f where		a.nr_atendimento	= e.nr_atendimento
						and		e.nr_prescricao		= f.nr_prescricao
						and		f.nr_prescricao     = d.nr_prescricao
						and		f.nr_sequencia      = d.nr_seq_material
						and		e.nr_prescricao		= nr_prescricao_p
						and		((d.cd_material		= b.cd_material) or 
								 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(d.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
						and		d.dt_horario 		= b.dt_horario
						and		coalesce(d.qt_dose,0)	= coalesce(b.qt_dose,0)
						and		coalesce(d.cd_unidade_medida_dose,'XPTO') = coalesce(b.cd_unidade_medida_dose,'XPTO')
						and		d.ie_agrupador		in (1,4,12)
						and		coalesce(d.dt_suspensao::text, '') = ''						
						and		Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'
						and		f.cd_intervalo 		= g.cd_intervalo
						and		f.ie_via_aplicacao 	= g.ie_via_aplicacao
						 LIMIT 1)))
	
union all

	select	b.nr_prescricao,
			b.dt_horario,
			b.nr_sequencia,
			b.nr_seq_material
	from	prescr_mat_hor b,
			prescr_medica a,
			prescr_material g
	where	g.nr_prescricao 	= a.nr_prescricao
	and		a.nr_atendimento	= nr_atendimento_w
	and		g.nr_prescricao		= b.nr_prescricao
	and		g.nr_sequencia		= b.nr_seq_material
	and		((b.cd_material		= cd_material_w) or 
			 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(b.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
	and		b.dt_horario		>= dt_limite_w
	and		a.nr_prescricao		= nr_prescricao_p
	and		b.ie_agrupador		in (1,4,12)
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		coalesce(ie_apresenta_rep_ant_w,'N') <> 'N'
	and		exists(	select	1
					from	ap_lote c,
							prescr_mat_hor d,
							prescr_medica e,
							prescr_material f where		f.nr_prescricao     = e.nr_prescricao
					and		e.nr_atendimento	= a.nr_atendimento
					and		f.nr_prescricao     = d.nr_prescricao
					and		f.nr_sequencia      = d.nr_seq_material
					and		((d.cd_material	= b.cd_material) or 
							 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(d.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
					and		d.dt_horario		>= dt_limite_w
					and		b.dt_horario		= d.dt_horario
					and		coalesce(b.qt_dose,0)	= coalesce(d.qt_dose,0)
					and		coalesce(d.cd_unidade_medida_dose,'XPTO') = coalesce(b.cd_unidade_medida_dose,'XPTO')
					and		e.nr_prescricao		<> a.nr_prescricao
					and		d.ie_agrupador		in (1,4,12)
					and		coalesce(d.dt_suspensao::text, '') = ''
					and		Obter_se_horario_liberado(d.dt_lib_horario, d.dt_horario) = 'S'
					and		d.nr_seq_lote		= c.nr_sequencia
					and		coalesce(c.ie_status_lote,'G') in ('G','A','R','D','E')
					and		f.cd_intervalo 		= g.cd_intervalo
					and		f.ie_via_aplicacao 	= g.ie_via_aplicacao
					 LIMIT 1)
					
	
union all

	select	b.nr_prescricao,
			b.dt_horario,
			b.nr_sequencia,
			b.nr_seq_material
	from	prescr_mat_hor b,
			prescr_medica a,
			prescr_material g
	where	g.nr_prescricao 	= a.nr_prescricao
	and		g.nr_prescricao		= b.nr_prescricao
	and		g.nr_sequencia		= b.nr_seq_material
	and		a.nr_atendimento	= nr_atendimento_w
	and		a.nr_prescricao		= nr_prescricao_p
	and		((b.cd_material		= cd_material_w) or ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(b.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
	and		b.ie_agrupador		in (1,4,12)
	and		coalesce(b.dt_suspensao::text, '') = ''
	and     exists(	select	1
					from	prescr_mat_hor d,
							prescr_medica c,
							prescr_material f where		f.nr_prescricao     = c.nr_prescricao
					and		c.nr_atendimento	= a.nr_atendimento
					and		c.nr_prescricao		= a.nr_prescricao
					and		f.nr_prescricao     = d.nr_prescricao
					and		f.nr_sequencia      = d.nr_seq_material
					and		((d.cd_material		= b.cd_material) or ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(d.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
					and 	d.dt_horario 		= b.dt_horario
					and		coalesce(b.qt_dose,0)	= coalesce(d.qt_dose,0)
					and		coalesce(d.cd_unidade_medida_dose,'XPTO') = coalesce(b.cd_unidade_medida_dose,'XPTO')
					and 	d.nr_sequencia		<> b.nr_sequencia
					and 	d.nr_seq_material	> b.nr_seq_material
					and		d.ie_agrupador in (1,4,12)
					and		coalesce(d.dt_suspensao::text, '') = ''
					and		f.cd_intervalo 		= g.cd_intervalo
					and		f.ie_via_aplicacao 	= g.ie_via_aplicacao
					 LIMIT 1)
	
union all

	select	b.nr_prescricao,
			b.dt_horario,
			b.nr_sequencia,
			b.nr_seq_material
	from	prescr_mat_hor b,
			prescr_medica a,
			prescr_material g
	where	g.nr_prescricao 	= a.nr_prescricao
	and		g.nr_prescricao		= b.nr_prescricao
	and		g.nr_sequencia		= b.nr_seq_material
	and		a.nr_atendimento	= nr_atendimento_w
	and		((b.cd_material		= cd_material_w) or 
			 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(b.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
	and		b.qt_dose			= qt_dose_w
	and		b.cd_unidade_medida_dose = cd_unidade_medida_w
	and		b.dt_horario		> dt_limite_w
	and		a.nr_prescricao		<> nr_prescricao_p
	and		b.ie_agrupador		in (1,4,12)
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		coalesce(b.nr_seq_lote::text, '') = ''
	and		coalesce(b.nr_seq_processo::text, '') = ''
	and		coalesce(b.dt_fim_horario::text, '') = ''
	and     exists(	select	1
					from	prescr_mat_hor d, 
							prescr_medica c,
							prescr_material f where		f.nr_prescricao     = c.nr_prescricao
					and		c.nr_atendimento	= a.nr_atendimento
					and		f.nr_prescricao     = d.nr_prescricao
					and		f.nr_sequencia      = d.nr_seq_material
					and		((d.cd_material		= b.cd_material) or ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(d.cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
					and 	d.dt_horario 		= b.dt_horario
					and		coalesce(b.qt_dose,0)	= coalesce(d.qt_dose,0)
					and		coalesce(d.cd_unidade_medida_dose,'XPTO') = coalesce(b.cd_unidade_medida_dose,'XPTO')
					and 	c.nr_prescricao		= nr_prescricao_p
					and		d.ie_agrupador 		in (1,4,12)
					and		coalesce(d.dt_suspensao::text, '') = ''
					and		f.cd_intervalo 		= g.cd_intervalo
					and		f.ie_via_aplicacao 	= g.ie_via_aplicacao
					 LIMIT 1);


BEGIN
		
select	max(nm_usuario),
		max(cd_estabelecimento)
into STRICT	nm_usuario_w,
		cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_apresenta_rep_ant_w := wheb_assist_pck.obterValorParametroREP(937, ie_apresenta_rep_ant_w);
ie_considera_princ_ativo_w := wheb_assist_pck.obterValorParametroREP(1163, ie_considera_princ_ativo_w);

delete	FROM prescr_mat_hor_conflito
where	nr_prescricao	= nr_prescricao_p;

commit;

open C01;
loop
fetch C01 into
	dt_inicio_prescr_w,
	dt_fim_prescricao_w,
	dt_primeiro_horario_w,
	hr_prim_horario_w,
	cd_material_w,
	cd_intervalo_w,
	nm_usuario_original_w,
	nr_atendimento_w,
	qt_dose_w,
	nr_seq_ficha_tecnica_w,
	cd_unidade_medida_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (hr_prim_horario_w = '  :  ') then
		hr_prim_horario_w := null;
	end if;

	if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (to_char(dt_inicio_prescr_w,'hh24:mi') > hr_prim_horario_w) then
		dt_prim_horario_medic_w	:= to_date(to_char(dt_inicio_prescr_w + 1,'dd/mm/yyyy ') ||hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
	else
		dt_prim_horario_medic_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy ') ||hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
	end if;

	select	coalesce(max(ie_operacao),''),
		coalesce(max(qt_operacao),1)
	into STRICT	ie_operacao_w,
		qt_operacao_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

	if (ie_operacao_w = 'H') then
		nr_Horas_intervalo_w    := qt_operacao_w;
	elsif (ie_operacao_w = 'X') then
		nr_Horas_intervalo_w   	:= floor(24/qt_operacao_w);
	end if;
	
	dt_limite_w	:= dt_prim_horario_medic_w - (coalesce(nr_Horas_intervalo_w,0)/24);

	open C02;
	loop
	fetch C02 into
		nr_prescricao_w,
		dt_horario_w,
		nr_sequencia_w,
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		ie_tipo_w	:= 'C';

		select	coalesce(max('D'),'C')
		into STRICT	ie_tipo_w
		from	prescr_mat_hor where		nr_prescricao	= nr_prescricao_w
		and		((cd_material = cd_material_w) or
				 ((ie_considera_princ_ativo_w = 'S') and (obter_dados_material(cd_material,'FT') = nr_seq_ficha_Tecnica_w)))
		and		dt_horario	= dt_horario_w
		and		coalesce(dt_suspensao::text, '') = ''
		and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S' LIMIT 1;
	
		insert into prescr_mat_hor_conflito(
			nr_sequencia,
			nr_prescricao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao_conflito,
			cd_material,
			dt_horario,
			ie_tipo,
			nr_seq_mat_hor,
			nr_seq_material)
		values (	nextval('prescr_mat_hor_conflito_seq'),
			nr_prescricao_p,
			clock_timestamp(),
			nm_usuario_original_w,
			clock_timestamp(),
			nm_usuario_original_w,
			nr_prescricao_w,
			cd_material_w,
			dt_horario_w,
			ie_tipo_w,
			nr_sequencia_w,
			nr_seq_material_w);	
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_hor_prescr_mat_hor ( nr_prescricao_p bigint) FROM PUBLIC;

