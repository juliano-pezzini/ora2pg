-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_prod_diario ( dt_parametro_P timestamp, nm_usuario_p text) AS $body$
DECLARE


dt_referencia_w	timestamp;


BEGIN

dt_referencia_w	:= trunc(dt_parametro_p,'dd');

delete	from eis_prod_diario
where	dt_referencia	= dt_referencia_w;

insert into eis_prod_diario(
	dt_referencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	cd_convenio,
	cd_setor_atendimento,
	ie_tipo_atendimento,
	vl_prov_sem_alta,
	vl_prov_com_alta,
	vl_conta_def,
	vl_prot_prov,
	vl_prot_def)
SELECT
	dt_referencia_w,
	cd_estabelecimento,
	clock_timestamp(),
	nm_usuario_p,
	cd_convenio,
	cd_setor_atendimento,
	ie_tipo_atendimento,
	sum(CASE WHEN ie_protocolo=2 THEN  vl_procedimento + vl_material + vl_terceiro  ELSE 0 END ),
	sum(CASE WHEN ie_protocolo=4 THEN  vl_procedimento + vl_material + vl_terceiro  ELSE 0 END ),
	sum(CASE WHEN ie_protocolo=6 THEN  vl_procedimento + vl_material + vl_terceiro  ELSE 0 END ),
	sum(CASE WHEN ie_protocolo=8 THEN  vl_procedimento + vl_material + vl_terceiro  ELSE 0 END ),
	sum(CASE WHEN ie_protocolo=10 THEN  vl_procedimento + vl_material + vl_terceiro  ELSE 0 END )
from	eis_resultado
where	dt_receita	between trunc(dt_referencia_w,'month') and last_day(dt_referencia_w)
group by
	dt_referencia_w,
	cd_estabelecimento,
	cd_convenio,
	cd_setor_atendimento,
	ie_tipo_atendimento;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_prod_diario ( dt_parametro_P timestamp, nm_usuario_p text) FROM PUBLIC;

