-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_preco_tb_mat ( nr_seq_material_p pls_material_preco_item.nr_seq_material%type, nr_seq_material_preco_p pls_material_preco_item.nr_seq_material_preco%type, dt_inicio_vigencia_p timestamp, vl_preco_venda_p bigint, cd_moeda_p moeda.cd_moeda%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


dt_vigencia_w        		timestamp;
ie_preco_maior_tab_w		pls_material_preco.ie_ultima_compra%type;
nr_sequencia_ger_w		pls_material_valor_item.nr_sequencia%type;
vl_material_w			pls_material_valor_item.vl_material%type;

ie_criado_atual_w		varchar(1);
ie_atualizar_valor_w		varchar(1);
cd_moeda_tab_w			pls_material_valor_item.cd_moeda%type;

BEGIN

if (nr_seq_material_preco_p IS NOT NULL AND nr_seq_material_preco_p::text <> '') then

	-- Flag para verificar se o valor deve ser inserido ou não conforme regra do campo "Atualiza preço se for à maior" da tabela  de preço
	ie_atualizar_valor_w := 'S';

	-- Tratamento para o campo "Atualiza preço se for à maior" da tabela  de preço, só será atualizado o preço dos materiais caso o preço de venda seja maior que o atual da tabela.
	begin
		select	coalesce(ie_ultima_compra,'S')
		into STRICT	ie_preco_maior_tab_w
		from	pls_material_preco
		where	nr_sequencia	= nr_seq_material_preco_p;
	exception
	when no_data_found then

		ie_preco_maior_tab_w := 'S';
	end;

	if (ie_preco_maior_tab_w = 'S')	then

		SELECT * FROM pls_obter_preco_tabela(cd_estabelecimento_p, null, nr_seq_material_p, nr_seq_material_preco_p, dt_inicio_vigencia_p, 1, null, vl_material_w, dt_vigencia_w, cd_moeda_tab_w) INTO STRICT vl_material_w, dt_vigencia_w, cd_moeda_tab_w;

		ie_atualizar_valor_w := 'N';

		if (vl_material_w < vl_preco_venda_p)	then

			ie_atualizar_valor_w := 'S';
		end if;
	elsif (ie_preco_maior_tab_w = 'N')	then

		ie_atualizar_valor_w := 'S';
	end if;

	if (ie_atualizar_valor_w = 'S') then

		ie_criado_atual_w := pls_inserir_valor_tab_mat(nr_seq_material_preco_p, nr_seq_material_p, vl_preco_venda_p, dt_inicio_vigencia_p, 'N', cd_moeda_p, ie_criado_atual_w, nm_usuario_p, null, null);
	end if;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_preco_tb_mat ( nr_seq_material_p pls_material_preco_item.nr_seq_material%type, nr_seq_material_preco_p pls_material_preco_item.nr_seq_material_preco%type, dt_inicio_vigencia_p timestamp, vl_preco_venda_p bigint, cd_moeda_p moeda.cd_moeda%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

