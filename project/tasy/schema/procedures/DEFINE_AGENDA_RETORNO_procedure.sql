-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_agenda_retorno (cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_tipo_agenda_p bigint, cd_convenio_p bigint, ie_tipo_consulta_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_pessoa_fisica_w		varchar(10);
ie_tipo_atendimento_w	smallint;
cd_convenio_w			integer;
cd_setor_atendimento_w	integer;
cd_medico_resp_w		varchar(10);

nr_atendimento_w		bigint;
nr_atend_origem_w		bigint;
nr_seq_agenda_w		agenda_consulta.nr_sequencia%type;
nr_seq_agenda_pac_w		agenda_paciente.nr_sequencia%type;
cd_medico_w			varchar(10);

ie_regra_w			varchar(1);
qt_dia_w			integer;
ie_regra_agenda_w		varchar(01);
dt_agenda_w			timestamp;
dt_agenda_pac_w		timestamp;
ds_convenio_w			varchar(255);
ds_mensagem_w			varchar(255);
ds_agenda_cons_w		varchar(100);
ds_classif_agenda_w		varchar(40);

cd_classificacao_w		varchar(5);	/* Rafael em 31/08/2006 OS39055 */
ie_tipo_classif_w		varchar(1);	/* Rafael em 31/08/2006 OS39055 */
ie_ok_w				integer;

C01 CURSOR FOR
	SELECT qt_dia
	from 	regra_atend_retorno
	where 	((IE_REGRA_AGENDA = 'A') or (IE_REGRA_AGENDA = 'C') or (IE_REGRA_AGENDA = 'G'))
	and	cd_tipo_agenda_p	in (3,4)
	and	cd_convenio		= cd_convenio_p
	and clock_timestamp() between coalesce(dt_inicio_vigencia, clock_timestamp()) and coalesce(dt_fim_vigencia, clock_timestamp())
	and coalesce(ie_situacao,'A') = 'A'
	order by 1;

C02 CURSOR FOR
	SELECT	nr_atendimento,
		cd_medico_resp
	from 	atendimento_paciente_v
	where 	coalesce(cd_estabelecimento, cd_estabelecimento_w)	= cd_estabelecimento_w
	  and 	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
	  and 	coalesce(cd_convenio, cd_convenio_p) 			= cd_convenio_p
	  and 	cd_pessoa_fisica					= cd_pessoa_fisica_p
	  and 	dt_entrada between clock_timestamp() - qt_dia_w and clock_timestamp()
	order by 1 desc;


BEGIN


select	max(ds_convenio)
into STRICT	ds_convenio_w
from	convenio
where	cd_convenio = cd_convenio_p;

if (cd_tipo_agenda_p in (3,4)) then
	begin

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_agenda_w
	from	agenda_consulta a
	where	a.dt_agenda		< dt_agenda_p
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and	a.ie_status_agenda 	<> 'C';

	select max(b.cd_estabelecimento),
		max(a.cd_pessoa_fisica),
		max(c.ie_tipo_Atendimento),
		max(b.cd_pessoa_fisica),
		max(c.nr_atendimento),
		coalesce(max(dt_agenda), clock_timestamp() - interval '5000 days'),
		max(substr(obter_nome_pf(b.cd_pessoa_fisica),1,200)),
		max(substr(obter_desc_classif_agenda(a.cd_agenda, a.ie_classif_agenda),1,40))
	into STRICT	cd_estabelecimento_w,
		cd_pessoa_fisica_w,
		ie_tipo_atendimento_w,
		cd_medico_resp_w,
		nr_atend_origem_w,
		dt_agenda_w,
		ds_agenda_cons_w,
		ds_classif_agenda_w
	from 	agenda b,
		atendimento_paciente c,
		agenda_consulta a
	where 	a.cd_agenda		= b.cd_agenda
	and	a.nr_atendimento	= c.nr_atendimento
	and	a.nr_sequencia  	= nr_seq_agenda_w;

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_agenda_pac_w
	from	agenda_paciente a
	where	a.dt_agenda		< dt_agenda_p
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and	a.ie_status_agenda <> 'C';

	select max(hr_inicio)
	into STRICT	dt_agenda_pac_w
	from 	agenda b,
		atendimento_paciente c,
		agenda_paciente a
	where 	a.cd_agenda		= b.cd_agenda
	and	a.nr_atendimento	= c.nr_atendimento
	and	a.nr_sequencia  	= nr_seq_agenda_pac_w;


	ds_mensagem_w	:= ds_mensagem_w || WHEB_MENSAGEM_PCK.get_texto(279263) || nr_atend_origem_w || WHEB_MENSAGEM_PCK.get_texto(279264) || ds_agenda_cons_w ||
					    WHEB_MENSAGEM_PCK.get_texto(279266) || to_char(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss') || 
					    WHEB_MENSAGEM_PCK.get_texto(279267) || to_char(dt_agenda_pac_w, 'dd/mm/yyyy hh24:mi:ss') || 
					    WHEB_MENSAGEM_PCK.get_texto(279268) || ds_classif_agenda_w;
					     				

	end;
end if;

open C01;
loop
	fetch C01 into	qt_dia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

if (coalesce(qt_dia_w,0) > 0) then
	begin

	if (cd_tipo_agenda_p	in (3,4)) then
		begin
		select	max(a.ie_classif_agenda)
		into STRICT	cd_classificacao_w
		from	agenda_consulta a
		where	a.nr_sequencia	= nr_seq_agenda_w;

		select	max(a.ie_tipo_classif)
		into STRICT	ie_tipo_classif_w
		from	agenda_classif a
		where	cd_classificacao = cd_classificacao_w
		and	ie_agenda in ('A','C');

		if	((trunc(dt_agenda_w,'dd') + qt_dia_w) >= trunc(dt_agenda_p, 'dd')) and (cd_classificacao_w = 'N') and (ie_tipo_classif_w = 'C') then
			ie_tipo_consulta_p	:= 'R';
			ds_mensagem_p		:= WHEB_MENSAGEM_PCK.get_texto(279270) || ds_convenio_w || WHEB_MENSAGEM_PCK.get_texto(279273) ||

qt_dia_w;
		end if;

			
		if (dt_agenda_pac_w > dt_agenda_w) then
			begin

			if	((trunc(dt_agenda_pac_w,'dd') + qt_dia_w) >= trunc(dt_agenda_p, 'dd')) then
				begin
	
				if	((trunc(dt_agenda_p, 'dd') - trunc(dt_agenda_w,'dd')) = 1) then
					ie_tipo_consulta_p	:= 'P';
					ds_mensagem_p		:= WHEB_MENSAGEM_PCK.get_texto(279274) || ds_convenio_w || ' 

Dias.: ' || qt_dia_w;
				else
					ie_tipo_consulta_p	:= 'C';
					ds_mensagem_p		:= WHEB_MENSAGEM_PCK.get_texto(279276) || ds_convenio_w || ' 

Dias.: ' || qt_dia_w;
				end if;

				end;
			end if;


			end;
		else	
			begin

			if	((trunc(dt_agenda_w,'dd') + qt_dia_w) >= trunc(dt_agenda_p, 'dd')) and
				/* (cd_classificacao_w = 'N') and  -> Rafael em 18/09/06 OS39055 */

				(ie_tipo_classif_w = 'C') then
				begin
	
				if	((trunc(dt_agenda_p, 'dd') - trunc(dt_agenda_w,'dd')) = 1) then
					ie_tipo_consulta_p	:= 'R';
					ds_mensagem_p		:= WHEB_MENSAGEM_PCK.get_texto(279277) || ds_convenio_w || WHEB_MENSAGEM_PCK.get_texto(279273)

|| qt_dia_w;
				else
					ie_tipo_consulta_p	:= 'R';
					ds_mensagem_p		:= WHEB_MENSAGEM_PCK.get_texto(279277) || ds_convenio_w || WHEB_MENSAGEM_PCK.get_texto(279273)

|| qt_dia_w;
				end if;

				end;
			end if;

			end;
		end if;

		end;
	else
		begin

		ds_mensagem_p		:= '';

		end;
	end if;


	end;
end if;

if (coalesce(length(ds_mensagem_p),0) > 0) then
	ds_mensagem_p	:= ds_mensagem_p || ds_mensagem_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_agenda_retorno (cd_pessoa_fisica_p text, dt_agenda_p timestamp, cd_tipo_agenda_p bigint, cd_convenio_p bigint, ie_tipo_consulta_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;

