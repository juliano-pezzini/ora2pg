-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_material_cirurgia ( dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE



nr_prescricao_w		bigint;
nr_seq_prescricao_w	integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_kit_material_w		integer;
nr_seq_kit_estoque_w	bigint;
cd_material_w		integer;
qt_devolucao_kit_w	double precision;
qt_devolucao_intra_w	double precision;
qt_material_w		double precision;
qt_material_kit_w		double precision;
qt_material_intra_w		double precision;
dt_inicio_real_w		timestamp;
cd_medico_cirurgiao_w	varchar(10);
cd_pessoa_fisica_w	varchar(10);

c01 CURSOR FOR
	SELECT	a.nr_prescricao,
		a.nr_sequencia,
		a.cd_kit_material,
		a.cd_material,
		a.qt_material,
		b.cd_procedimento_princ,
		b.ie_origem_proced,
		b.dt_inicio_real,
		b.cd_medico_cirurgiao,
		a.nr_seq_kit_estoque,
		b.cd_pessoa_fisica
	from	prescr_material a,
		cirurgia b,
		prescr_medica c
	where	b.nr_prescricao = c.nr_prescricao
	and	a.nr_prescricao = c.nr_prescricao
	and	b.dt_inicio_real between trunc(dt_referencia_p,'month') and fim_mes(dt_referencia_p);


BEGIN

delete	from eis_material_cirurgia
where 	dt_referencia between trunc(dt_referencia_p,'month') and fim_mes(dt_referencia_p);

open c01;
loop
fetch c01 into
	nr_prescricao_w,
	nr_seq_prescricao_w,
	cd_kit_material_w,
	cd_material_w,
	qt_material_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_inicio_real_w,
	cd_medico_cirurgiao_w,
	nr_seq_kit_estoque_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	qt_devolucao_kit_w 	:= 0;
	qt_devolucao_intra_w	:= 0;
	qt_material_intra_w	:= 0;
	qt_material_kit_w	:= 0;

	if (coalesce(cd_kit_material_w,0) = 0) and (coalesce(nr_seq_kit_estoque_w,0) > 0) then
		select	max(cd_kit_material)
		into STRICT	cd_kit_material_w
		from	kit_estoque
		where	nr_sequencia = nr_seq_kit_estoque_w;
	end if;

	if (coalesce(cd_kit_material_w,0) > 0) then
		begin
		qt_material_kit_w := coalesce(qt_material_w,0);

		select	coalesce(sum(qt_devolucao),0)
		into STRICT	qt_devolucao_kit_w
		from	prescr_material_devolucao a
		where	a.nr_prescricao     =    nr_prescricao_w
		and	a.nr_seq_prescricao =    nr_seq_prescricao_w;
		end;
	else
		begin
		cd_kit_material_w	:= null;
		qt_material_intra_w	:= coalesce(qt_material_w,0);

		select	coalesce(sum(qt_devolucao),0)
		into STRICT	qt_devolucao_intra_w
		from	prescr_material_devolucao a
		where	a.nr_prescricao     	 = nr_prescricao_w
		and	a.nr_seq_prescricao = nr_seq_prescricao_w;
		end;
	end if;

	insert	into eis_material_cirurgia(
		dt_referencia,
		cd_procedimento,
		ie_origem_proced,
		cd_kit_material,
		cd_material,
		qt_material_util_kit,
		qt_material_util_intra,
		qt_material_devol_kit,
		qt_material_devol_intra,
		cd_medico_cirurgiao,
		cd_pessoa_fisica)
	values (	dt_inicio_real_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_kit_material_w,
		cd_material_w,
		(qt_material_kit_w + qt_devolucao_kit_w),
		(qt_material_intra_w + qt_devolucao_intra_w),
		qt_devolucao_kit_w,
		qt_devolucao_intra_w,
		cd_medico_cirurgiao_w,
		cd_pessoa_fisica_w);
	end;
end loop;
close c01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_material_cirurgia ( dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

