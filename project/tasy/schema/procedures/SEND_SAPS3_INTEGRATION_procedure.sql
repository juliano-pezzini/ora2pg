-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE send_saps3_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_atualizacao_p timestamp, ie_cardiologica_p bigint, ie_hepatico_p bigint, ie_abdomem_p bigint, ie_neurologica_p bigint, ie_tipo_operacao_p bigint, ie_infec_nosocomial_p text, ie_infec_resp_p text) AS $body$
DECLARE

				
visit_id_w					escala_saps3.nr_atendimento%type;
patient_id_w 				pessoa_fisica.cd_pessoa_fisica%type;
updatetimestamp_w			varchar(40);
unitadmissiondatetime_w		varchar(40);
saps3_id_w					escala_saps3.nr_sequencia%type;	
saps3_value_w				varchar(1);
saps3_code_w				varchar(10);
saps3_campo_w				varchar(40);
nm_user_w               	escala_saps3.nm_usuario%type;
aux_saps3_value_w			varchar(4000);
aux_saps3_code_w			varchar(4000);
separator_w					varchar(1) := '@';
ds_integracao_w				text;
data_entrada_w 				varchar(50);
establishment_id_w   smallint;

c01 CURSOR FOR		
	SELECT  to_char(1) saps3_value,
			to_char(ie_cardiologica_p) saps3_code
	
	
union all

	SELECT  to_char(1) saps3_value,
			to_char(ie_hepatico_p) saps3_code
	
	
union all

	select  to_char(1) saps3_value,
			to_char(ie_abdomem_p) saps3_code
	
	
union all

	select  to_char(1) saps3_value,
			to_char(ie_neurologica_p) saps3_code
	
	
union all

	select  to_char(1) saps3_value,
			to_char(ie_tipo_operacao_p) saps3_code
	
	
union all

	select  to_char(1) saps3_value,
			ie_infec_nosocomial_p saps3_code
	
	
union all

	select  to_char(1) saps3_value,
			ie_infec_resp_p saps3_code
	;


BEGIN

if (obter_setor(obter_setor_atual_paciente(nr_atendimento_p)) is not null) then

	select 	to_char(max(b.dt_entrada_unidade), 'yyyymmddhh24miss')
	into STRICT	unitadmissiondatetime_w
	from	atend_paciente_unidade b
	where 	nr_atendimento = nr_atendimento_p;
	
	nm_user_w := WHEB_USUARIO_PCK.GET_NM_USUARIO;
	patient_id_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');
	visit_id_w := nr_atendimento_p;
	saps3_id_w := nr_sequencia_p;
	updatetimestamp_w := to_char(dt_atualizacao_p, 'yyyymmddhh24miss');
	
	open c01;
	loop
	fetch c01 into	
		saps3_value_w,
		saps3_code_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
		if (coalesce(aux_saps3_code_w::text, '') = '') then
			aux_saps3_value_w := saps3_value_w;
			aux_saps3_code_w := saps3_code_w;
		else
			aux_saps3_value_w := aux_saps3_value_w||separator_w||saps3_value_w;
			aux_saps3_code_w := aux_saps3_code_w||separator_w||saps3_code_w;
		end if;
		
	end;
	end loop;
	close c01;
	
	if (coalesce(visit_id_w, 0) > 0 ) and (coalesce(saps3_id_w, 0) > 0) then

    select
      obter_estabelecimento_setor(obter_setor_atual_paciente(nr_atendimento_p))
    into STRICT
      establishment_id_w
;
		
		SELECT BIFROST.SEND_INTEGRATION( 'patientinformation.saps3',
									'com.philips.tasy.integration.atepac.patientinformation.saps3.Saps3',
									'{ "patientId" : "' ||patient_id_w || '",'
                  ||'"establishmentId" : "'||establishment_id_w||'",'
									||'"visitId" : "' ||visit_id_w || '",'
									||'"saps3Id" : "' ||saps3_id_w || '",'
									||'"saps3AdmissionDate" : "' || unitadmissiondatetime_w ||'",'
									||'"saps3Code" : "' || aux_saps3_code_w ||'" ,'
									||'"saps3Value" : "' || aux_saps3_value_w ||'" ,'
									||'"updateTimeStamp" : "' || updatetimestamp_w ||'"'
									||'}',
									nm_user_w)
		INTO STRICT DS_INTEGRACAO_W
		;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE send_saps3_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_atualizacao_p timestamp, ie_cardiologica_p bigint, ie_hepatico_p bigint, ie_abdomem_p bigint, ie_neurologica_p bigint, ie_tipo_operacao_p bigint, ie_infec_nosocomial_p text, ie_infec_resp_p text) FROM PUBLIC;

