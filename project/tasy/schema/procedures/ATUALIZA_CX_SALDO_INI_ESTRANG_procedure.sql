-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_cx_saldo_ini_estrang (nr_seq_caixa_saldo_p bigint, dt_saldo_p timestamp, nr_seq_caixa_p bigint) AS $body$
DECLARE


/* Projeto Multimoeda - Procedure utilizada para atualizar o saldo inicial do caixa em moeda estrangeira,
	para caixas que permitam transações em outras moedas que não seja a moeda padrão da empresa. */
-- NÃO REALIZAR COMMIT NESTA PROCEDURE
dt_saldo_anterior_w		timestamp;
vl_saldo_anterior_w		double precision;
vl_especie_anterior_w		double precision;
vl_cheque_pre_anterior_w	double precision;
vl_cheque_vista_anterior_w	double precision;
nr_sequencia_w			bigint;
cd_moeda_w			integer;

c01 CURSOR FOR
SELECT	cd_moeda,
	nr_sequencia
from	caixa_saldo_estrang
where	nr_seq_caixa_saldo = nr_seq_caixa_saldo_p;


BEGIN

select	max(dt_saldo)
into STRICT	dt_saldo_anterior_w
from	caixa_saldo_diario
where	nr_seq_caixa	= nr_seq_caixa_p
and	dt_saldo	< dt_saldo_p;

open c01;
loop
fetch c01 into
	cd_moeda_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	coalesce(max(a.vl_saldo),0),
		coalesce(max(a.vl_especie_atual),0),
		coalesce(max(a.vl_cheque_vista_atual),0),
		coalesce(max(a.vl_cheque_pre_atual),0)
	into STRICT	vl_saldo_anterior_w,
		vl_especie_anterior_w,
		vl_cheque_vista_anterior_w,
		vl_cheque_pre_anterior_w
	from	caixa_saldo_diario b,
		caixa_saldo_estrang a
	where	b.nr_sequencia	= a.nr_seq_caixa_saldo
	and	a.cd_moeda	= cd_moeda_w
	and	b.nr_seq_caixa	= nr_seq_caixa_p
	and	b.dt_saldo	= dt_saldo_anterior_w;

	update	caixa_saldo_estrang
	set	vl_saldo_inicial	= vl_saldo_anterior_w,
		vl_especie_inicial	= vl_especie_anterior_w,
		vl_cheque_vista_inicial	= vl_cheque_vista_anterior_w,
		vl_cheque_pre_inicial	= vl_cheque_pre_anterior_w
	where	nr_seq_caixa_saldo	= nr_seq_caixa_saldo_p
	and	cd_moeda_w		= cd_moeda_w
	and	nr_sequencia		= nr_sequencia_w;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_cx_saldo_ini_estrang (nr_seq_caixa_saldo_p bigint, dt_saldo_p timestamp, nr_seq_caixa_p bigint) FROM PUBLIC;

