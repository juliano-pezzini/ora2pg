-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_imposto_baixa_bordero (nr_bordero_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_titulo_w	bigint;
nr_seq_baixa_w	bigint;
nr_seq_imposto_w	bigint;
cd_tributo_param_w	varchar(255);
cd_tributo_w		smallint;
cd_estabelecimento_w	smallint;

 
c01 CURSOR FOR 
SELECT	a.nr_titulo 
from	titulo_pagar_bordero_v a 
where	nr_bordero	= nr_bordero_p;


BEGIN 
 
select	max(cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	bordero_pagamento 
where	nr_bordero	= nr_bordero_p;
 
cd_tributo_param_w	:= obter_valor_param_usuario(855,22,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w);
 
select	max(cd_tributo) 
into STRICT	cd_tributo_w 
from	tributo 
where	to_char(cd_tributo)	= cd_tributo_param_w;
 
if (coalesce(cd_tributo_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265615,'tributo_param='||cd_tributo_param_w);
	--Não foi encontrado o tributo código ||tributo_param|| definido no parâmetro [22]! 
end if;
 
open c01;
loop 
fetch c01 into 
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_baixa_w 
	from	titulo_pagar_baixa 
	where	nr_titulo	= nr_titulo_w 
	and	nr_bordero	= nr_bordero_p;
 
	select	max(a.nr_sequencia) 
	into STRICT	nr_seq_imposto_w 
	from	titulo_pagar_imposto a 
	where	a.nr_titulo	= nr_titulo_w 
	and	coalesce(a.nr_seq_baixa::text, '') = '' 
	and	a.cd_tributo	= cd_tributo_w;
 
	if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') and (nr_seq_imposto_w IS NOT NULL AND nr_seq_imposto_w::text <> '') then 
 
		CALL vincular_imposto_baixa(nr_seq_imposto_w,nr_seq_baixa_w,nm_usuario_p);
 
	end if;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_imposto_baixa_bordero (nr_bordero_p bigint, nm_usuario_p text) FROM PUBLIC;

