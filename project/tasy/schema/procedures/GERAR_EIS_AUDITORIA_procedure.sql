-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_auditoria (dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


NR_SEQ_TIPO_w			bigint;
CD_SETOR_ATENDIMENTO_w		integer;
NR_SEQ_AMBIENTE_w		bigint;
CD_AUDITOR_RESP_w		varchar(10);
VL_TOTAL_w			double precision;
VL_MEDIA_TOTAL_w		double precision;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
nr_sequencia_w			bigint;

c01 CURSOR FOR
	SELECT	nr_seq_tipo,
		cd_setor_atendimento,
		nr_seq_ambiente,
		cd_auditor_resp,
		sum(vl_total),
		avg(vl_total)
	from	qua_auditoria
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	dt_inicio between dt_inicial_w and dt_final_w
	group by nr_seq_tipo,
		cd_setor_atendimento,
		nr_seq_ambiente,
		cd_auditor_resp;


BEGIN
				/*'Auditoria'*/

nr_sequencia_w := Gravar_Log_Indicador(454, wheb_mensagem_pck.get_Texto(312406), clock_timestamp(), trunc(dt_referencia_p), nm_usuario_p, nr_sequencia_w);

dt_inicial_w	:= trunc(dt_referencia_p, 'dd');
dt_final_w	:= trunc(dt_referencia_p, 'dd') + 86399/86400;


delete 	from eis_auditoria
where	dt_referencia	= trunc(dt_referencia_p, 'dd')
and	ie_periodo	= 'D';

delete 	from eis_auditoria
where	dt_referencia	= trunc(dt_referencia_p, 'month')
and	ie_periodo	= 'M';

open	c01;
loop
fetch	c01 into
	NR_SEQ_TIPO_w,
	CD_SETOR_ATENDIMENTO_w,
	NR_SEQ_AMBIENTE_w,
	CD_AUDITOR_RESP_w,
	VL_TOTAL_w,
	VL_MEDIA_TOTAL_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	insert	into eis_auditoria(DT_REFERENCIA,
		CD_ESTABELECIMENTO     ,
		IE_PERIODO             ,
		DT_ATUALIZACAO         ,
		NM_USUARIO             ,
		NR_SEQ_TIPO            ,
		CD_SETOR_ATENDIMENTO   ,
		NR_SEQ_AMBIENTE        ,
		CD_AUDITOR_RESP        ,
		VL_TOTAL               ,
		VL_MEDIA_TOTAL		)
	values (dt_inicial_w,
		cd_estabelecimento_p,
		'D',
		clock_timestamp(),
		nm_usuario_p,
		NR_SEQ_TIPO_w,
		CD_SETOR_ATENDIMENTO_w,
		NR_SEQ_AMBIENTE_w,
		CD_AUDITOR_RESP_w,
		VL_TOTAL_w,
		VL_MEDIA_TOTAL_w);

	end;
end loop;
close	c01;

insert	into eis_auditoria(DT_REFERENCIA,
	CD_ESTABELECIMENTO     ,
	IE_PERIODO             ,
	DT_ATUALIZACAO         ,
	NM_USUARIO             ,
	NR_SEQ_TIPO            ,
	CD_SETOR_ATENDIMENTO   ,
	NR_SEQ_AMBIENTE        ,
	CD_AUDITOR_RESP        ,
	VL_TOTAL               ,
	VL_MEDIA_TOTAL)
(SELECT	trunc(dt_referencia_p, 'month'),
	CD_ESTABELECIMENTO     ,
	'M'             ,
	clock_timestamp()         ,
	NM_USUARIO_p             ,
	NR_SEQ_TIPO            ,
	CD_SETOR_ATENDIMENTO   ,
	NR_SEQ_AMBIENTE        ,
	CD_AUDITOR_RESP        ,
	sum(VL_TOTAL),
	AVG(VL_TOTAL)
from	eis_auditoria
where	ie_periodo = 'D'
and	dt_referencia between trunc(dt_referencia_p, 'month') and last_day(trunc(dt_referencia_p, 'month'))
group by CD_ESTABELECIMENTO     ,
	NR_SEQ_TIPO            ,
	CD_SETOR_ATENDIMENTO   ,
	NR_SEQ_AMBIENTE        ,
	CD_AUDITOR_RESP        );

CALL Atualizar_Log_Indicador(clock_timestamp(), nr_sequencia_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_auditoria (dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

