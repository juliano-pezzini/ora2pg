-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_regra_exa_agendas (nr_seq_regra_p bigint, ds_lista_agenda_p text) AS $body$
DECLARE


type cd_agenda_w is table of agenda.cd_agenda%type;
vetor_cd_agenda_w cd_agenda_w;

cd_estabelecimento_w agenda_cons_regra_proc.cd_estabelecimento%type;
cd_convenio_w agenda_cons_regra_proc.cd_convenio%type;
cd_categoria_w agenda_cons_regra_proc.cd_categoria%type;
cd_plano_convenio_w agenda_cons_regra_proc.cd_plano_convenio%type;
cd_area_procedimento_w agenda_cons_regra_proc.cd_area_procedimento%type;
cd_especialidade_w agenda_cons_regra_proc.cd_especialidade%type;
cd_grupo_proc_w agenda_cons_regra_proc.cd_grupo_proc%type;
cd_procedimento_w agenda_cons_regra_proc.cd_procedimento%type;
nr_seq_proc_interno_w agenda_cons_regra_proc.nr_seq_proc_interno%type;
ie_permite_w agenda_cons_regra_proc.ie_permite%type;
nr_seq_grupo_ageint_w agenda_cons_regra_proc.nr_seq_grupo_ageint%type;
nr_seq_area_ageint_w agenda_cons_regra_proc.nr_seq_area_ageint%type;
ie_agenda_w agenda_cons_regra_proc.ie_agenda%type;
nm_usuario_w agenda_cons_regra_proc.nm_usuario%type;
ie_origem_proced_w agenda_cons_regra_proc.ie_origem_proced%type;WITH RECURSIVE cte AS (


c01 CURSOR FOR
  SELECT regexp_substr(ds_lista_agenda_p,'[^,]+', 1, level)  (regexp_substr(ds_lista_agenda_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(ds_lista_agenda_p, '[^,]+', 1, level))::text <> '')  UNION ALL


c01 CURSOR FOR
  SELECT regexp_substr(ds_lista_agenda_p,'[^,]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
;


BEGIN

select max(cd_estabelecimento),
      max(cd_convenio),
      max(cd_categoria),
      max(cd_plano_convenio),
      max(cd_area_procedimento),
      max(cd_especialidade),
      max(cd_grupo_proc),
      max(cd_procedimento),
      max(nr_seq_proc_interno),
      max(ie_permite),
      max(nr_seq_grupo_ageint),
      max(nr_seq_area_ageint),
      max(ie_agenda),
      max(nm_usuario),
      max(ie_origem_proced)
into STRICT cd_estabelecimento_w,
      cd_convenio_w,
      cd_categoria_w,
      cd_plano_convenio_w,
      cd_area_procedimento_w,
      cd_especialidade_w,
      cd_grupo_proc_w,
      cd_procedimento_w,
      nr_seq_proc_interno_w,
      ie_permite_w,
      nr_seq_grupo_ageint_w,
      nr_seq_area_ageint_w,
      ie_agenda_w,
      nm_usuario_w,
      ie_origem_proced_w
from agenda_cons_regra_proc
where nr_sequencia = nr_seq_regra_p;

open c01;
loop

  fetch c01 bulk collect into vetor_cd_agenda_w limit 500;
  exit when vetor_cd_agenda_w.count = 0;
  forall i in 1 .. vetor_cd_agenda_w.count
    insert into agenda_cons_regra_proc(
      nr_sequencia,
      cd_estabelecimento,
      cd_agenda,
      cd_convenio,
      cd_categoria,
      cd_plano_convenio,
      cd_area_procedimento,
      cd_especialidade,
      cd_grupo_proc,
      cd_procedimento,
      nr_seq_proc_interno,
      ie_permite,
      nr_seq_grupo_ageint,
      nr_seq_area_ageint,
      ie_agenda,
      nm_usuario,
      nm_usuario_nrec,
      dt_atualizacao,
      dt_atualizacao_nrec,
      ie_origem_proced
    ) values (
      nextval('agenda_cons_regra_proc_seq'),
      cd_estabelecimento_w,
      vetor_cd_agenda_w(i),
      cd_convenio_w,
      cd_categoria_w,
      cd_plano_convenio_w,
      cd_area_procedimento_w,
      cd_especialidade_w,
      cd_grupo_proc_w,
      cd_procedimento_w,
      nr_seq_proc_interno_w,
      ie_permite_w,
      nr_seq_grupo_ageint_w,
      nr_seq_area_ageint_w,
      ie_agenda_w,
      nm_usuario_w,
      nm_usuario_w,
      clock_timestamp(),
      clock_timestamp(),
      ie_origem_proced_w
    );

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_regra_exa_agendas (nr_seq_regra_p bigint, ds_lista_agenda_p text) FROM PUBLIC;

