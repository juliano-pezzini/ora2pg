-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_solic_lead_portab ( nr_seq_portabilidade_p pls_portab_pessoa.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_cep_w		compl_pessoa_fisica.cd_cep%type;
cd_municipio_ibge_w	compl_pessoa_fisica.cd_municipio_ibge%type;
ds_bairro_w		compl_pessoa_fisica.ds_bairro%type;
ds_complemento_w	compl_pessoa_fisica.ds_complemento%type;
ds_email_w		compl_pessoa_fisica.ds_email%type;
ds_endereco_w		compl_pessoa_fisica.ds_endereco%type;
dt_nascimento_w		pessoa_fisica.dt_nascimento%type;
nm_pessoa_fisica_w	pessoa_fisica.nm_pessoa_fisica%type;
nr_cpf_w		pessoa_fisica.nr_cpf%type;
nr_ddd_celular_w	compl_pessoa_fisica.nr_ddd_celular%type;
nr_ddi_telefone_w	compl_pessoa_fisica.nr_ddi_telefone%type;
nr_ddi_celular_w	compl_pessoa_fisica.nr_ddi_celular%type;
nr_endereco_w		compl_pessoa_fisica.nr_endereco%type;
nr_identidade_w		pessoa_fisica.nr_identidade%type;
nr_telefone_w		compl_pessoa_fisica.nr_telefone%type;
nr_telefone_celular_w	compl_pessoa_fisica.nr_telefone_celular%type;
sg_estado_w		compl_pessoa_fisica.sg_estado%type;
nr_seq_solicitacao_w	pls_solicitacao_comercial.nr_sequencia%type;


BEGIN

select  cd_pessoa_fisica
	into STRICT cd_pessoa_fisica_w
from 	pls_portab_pessoa
where   nr_sequencia = nr_seq_portabilidade_p;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	substr(obter_compl_pf(cd_pessoa_fisica,1,'CEP'),1,40),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'CDM'),1,40),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'B'),1,40),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'CO'),1,40),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'M'),1,40),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'EC'),1,40),
		dt_nascimento,
		nm_pessoa_fisica,
		nr_cpf,
		nr_ddd_celular,
		substr(obter_compl_pf(cd_pessoa_fisica,1,'DIT'),1,5),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'DDICEL'),1,5),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'N'),1,40),
		nr_identidade,
		substr(obter_compl_pf(cd_pessoa_fisica,1,'T'),1,15),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'CEL'),1,15),
		substr(obter_compl_pf(cd_pessoa_fisica,1,'UF'),1,40)
	into STRICT	cd_cep_w,
		cd_municipio_ibge_w,
		ds_bairro_w,
		ds_complemento_w,
		ds_email_w,
		ds_endereco_w,
		dt_nascimento_w,
		nm_pessoa_fisica_w,
		nr_cpf_w,
		nr_ddd_celular_w,
		nr_ddi_telefone_w,
		nr_ddi_celular_w,
		nr_endereco_w,
		nr_identidade_w,
		nr_telefone_w,
		nr_telefone_celular_w,
		sg_estado_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	
	insert into pls_solicitacao_comercial(nr_sequencia, cd_estabelecimento, ie_status,
		nm_pessoa_fisica, dt_atualizacao, nm_usuario,
		dt_solicitacao, nr_cpf, nm_usuario_nrec,
		dt_atualizacao_nrec, cd_cep, nr_ddi,
		ds_bairro, cd_municipio_ibge,ds_complemento,
		ds_email, ds_endereco, dt_nascimento,
		nr_ddd_celular, nr_ddi_celular, nr_endereco,
		nr_identidade, nr_telefone, nr_celular, 
		sg_uf_municipio, nr_seq_portabilidade, ie_origem_solicitacao)
	values (nextval('pls_solicitacao_comercial_seq'), cd_estabelecimento_p, 'PE',
		nm_pessoa_fisica_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nr_cpf_w, nm_usuario_p,
		clock_timestamp(), cd_cep_w, nr_ddi_telefone_w, 
		ds_bairro_w, cd_municipio_ibge_w, ds_complemento_w,
		ds_email_w, ds_endereco_w, dt_nascimento_w,
		nr_ddd_celular_w, nr_ddi_celular_w, nr_endereco_w, 
		nr_identidade_w, nr_telefone_w, nr_telefone_celular_w,
		sg_estado_w, nr_seq_portabilidade_p, 'P')
		returning nr_sequencia into nr_seq_solicitacao_w;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_solic_lead_portab ( nr_seq_portabilidade_p pls_portab_pessoa.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

