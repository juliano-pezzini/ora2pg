-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_comunic_alterar_senha ( qt_dias_p bigint, ie_cominicacao_p text, ie_email_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
ds_email_origem_w			varchar(255);
nm_usuario_w				varchar(255) := '';
ds_email_w				varchar(2000);

 
C01 CURSOR FOR 
	SELECT	nm_usuario, 
		ds_email 
	from	usuario 
	where	obter_dias_entre_datas(DT_ALTERACAO_SENHA,clock_timestamp()) = (QT_DIA_SENHA - qt_dias_p) 
	and	cd_estabelecimento = cd_estabelecimento_p 
	and	ie_situacao = 'A' 
	order by nm_usuario;					
					 

BEGIN 
--790954 Alteração da senha de acesso ao Tasy. 
--790955 Restam ? dias para expirar a sua senha de acesso ao Tasy. 
 
select	substr(obter_dados_pf_pj('',cd_cgc,'M'),1,255) 
into STRICT	ds_email_origem_w 
from	estabelecimento 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (coalesce(ds_email_origem_w::text, '') = '') then 
	select	substr(obter_dados_pf_pj_estab(cd_estabelecimento_p, '', cd_cgc, 'M'),1,255) 
	into STRICT	ds_email_origem_w 
	from	estabelecimento 
	where	cd_estabelecimento = cd_estabelecimento_p;
end if;
 
open C01;
loop 
fetch C01 into	 
	nm_usuario_w, 
	ds_email_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (ie_cominicacao_p = 'S') then 
		CALL gerar_comunic_padrao(	clock_timestamp() 
					,wheb_mensagem_pck.get_texto(790954) 
					,wheb_mensagem_pck.get_texto(790955,'QT_DIAS_P='||qt_dias_p) 
					,nm_usuario_p, 'N', nm_usuario_w, 'N', null, '', null, null, clock_timestamp(), null, null);
	end if;
	 
	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') and (ie_email_p = 'S') then 
		begin 
		if (substr(ds_email_w,1,1) = ';') then 
			ds_email_w := substr(ds_email_w,2,255);
		end if;
		 
		begin 
		CALL enviar_email(	wheb_mensagem_pck.get_texto(790954), 
				wheb_mensagem_pck.get_texto(790955,'QT_DIAS_P='||qt_dias_p), 
				ds_email_origem_w, 
				ds_email_w, 
				'Aviso_Tasy', 
				'A');
		exception 
		when others then 
			null;
		end;
		 
		end;
	end if;
		 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_comunic_alterar_senha ( qt_dias_p bigint, ie_cominicacao_p text, ie_email_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

