-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tratar_valor_maior_ted ( nr_titulo_p bigint, vl_recebido_p INOUT bigint, dt_referencia_p timestamp, vl_juros_p INOUT bigint, vl_multa_p INOUT bigint, vl_rec_maior_p INOUT bigint) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/vl_saldo_titulo_w	double precision := 0;
vl_multa_w		double precision := 0;
vl_juros_w		double precision := 0;
vl_diferenca_w		double precision := 0;


BEGIN
vl_juros_p := 0;
vl_multa_p := 0;
vl_rec_maior_p := 0;

begin
select	coalesce(vl_saldo_titulo,0),
	coalesce(obter_juros_multa_titulo(nr_titulo,dt_referencia_p, 'R', 'M'),0),
	coalesce(obter_juros_multa_titulo(nr_titulo,dt_referencia_p, 'R', 'J'),0)
into STRICT	vl_saldo_titulo_w,
	vl_multa_w,
	vl_juros_w
from	titulo_receber
where	nr_titulo	= nr_titulo_p;
exception
when others then
	vl_saldo_titulo_w := 0;
	vl_multa_w := 0;
	vl_juros_w := 0;
end;

if (vl_recebido_p > vl_saldo_titulo_w) then
	vl_diferenca_w := (vl_recebido_p - vl_saldo_titulo_w);
	vl_recebido_p := vl_saldo_titulo_w;

	if (vl_diferenca_w >= vl_juros_w) and (vl_juros_w > 0) then
		vl_juros_p := vl_juros_w;
		vl_diferenca_w := vl_diferenca_w - vl_juros_w;

	elsif (vl_diferenca_w > 0) then
		vl_juros_p := vl_diferenca_w;
		vl_diferenca_w := 0;
	end if;

	if (vl_diferenca_w >= vl_multa_w) and (vl_multa_w > 0) then
		vl_multa_p := vl_multa_w;
		vl_diferenca_w := vl_diferenca_w - vl_multa_w;

	elsif (vl_diferenca_w > 0) then
		vl_multa_p := vl_diferenca_w;
		vl_diferenca_w := 0;
	end if;

	if (vl_diferenca_w > 0) then
		vl_rec_maior_p := vl_diferenca_w;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tratar_valor_maior_ted ( nr_titulo_p bigint, vl_recebido_p INOUT bigint, dt_referencia_p timestamp, vl_juros_p INOUT bigint, vl_multa_p INOUT bigint, vl_rec_maior_p INOUT bigint) FROM PUBLIC;

