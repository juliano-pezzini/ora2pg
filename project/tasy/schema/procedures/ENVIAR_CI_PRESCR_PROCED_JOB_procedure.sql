-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_prescr_proced_job (nm_usuario_p text) AS $body$
DECLARE

 
ds_titulo_w		varchar(255);
nm_paciente_w		varchar(255);
nm_medico_w		varchar(255);
nm_medico_exec_w	varchar(255);
ds_comunicado_w		text;
ds_comunic_w		varchar(4000);
ds_procedimento_w	varchar(4000);
nm_usuario_destino_w	varchar(255);
ds_lista_usuario_destino_w	varchar(1000);
ds_observacao_w		varchar(255);
ds_dado_clinico_w	varchar(255);
ds_erro_w		varchar(255);
ds_unidade_w		varchar(255);
cd_procedimento_w	bigint;
nr_atendimento_w	bigint;
cd_perfil_w			varchar(4000);
cd_setor_envio_w  varchar(4000);
cd_setor_destino_w	bigint;
nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
nr_sequencia_www	bigint;
cd_area_procedimento_w	bigint;
cd_perfil_destino_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_setor_w		bigint;
ie_origem_proced_w	bigint;
ie_tipo_atendimento_w	bigint;
nr_seq_regra_w		bigint;
ie_enviar_prescritor_w	varchar(1);
cd_pessoa_fisica_w	varchar(50);
ie_enviar_executor_w	varchar(1);
nr_seq_comunic_w	bigint;
nr_seq_proc_interno_w	bigint;
ds_quebra_w		varchar(2) := chr(13) || chr(10);

cd_intervalo_w		varchar(30);
ds_horarios_w		varchar(255);
ds_intervalo_w		varchar(255);
ds_setor_exec_w		varchar(255);
ds_setor_prescr_w	varchar(255);	
dt_liberacao_w		timestamp;
dt_prescricao_w		timestamp;
dt_prev_exec_w		timestamp;
qt_procedimento_w	double precision;
ds_convenio_w		varchar(255);
cd_protocolo_w		bigint;
nr_seq_protocolo_w	bigint;
cd_medico_exec_w	bigint;
ie_gerar_comunic_w	varchar(1);
ie_aplica_prescr_eup_w	varchar(1);
cd_estabelecimento_w	bigint	:= obter_estab_usuario(nm_usuario_p);

 
nr_prescricao_w		bigint;

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.ds_titulo, 
	a.ds_comunicado, 
	a.cd_area_procedimento, 
	a.cd_especialidade, 
	a.cd_grupo_proc, 
	a.cd_procedimento, 
	a.ie_origem_proced, 
	a.ie_tipo_atendimento, 
	coalesce(a.ie_enviar_prescritor,'S'), 
	a.nr_seq_proc_interno, 
	a.cd_protocolo, 
	a.nr_seq_protocolo, 
	coalesce(a.ie_enviar_executor,'S'), 
	a.cd_pessoa_fisica, 
	coalesce(a.ie_aplica_prescr_eup,'S') 
from	rep_regra_envio_ci_proced a 
where	coalesce(ie_job,'N') = 'S' 
and		((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_Perfil_ativo)) 
and		coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,0))	= coalesce(cd_estabelecimento_w,0);

c001 CURSOR FOR 
SELECT	distinct 
	p.nr_prescricao, 
	obter_nome_pf_pj(p.cd_pessoa_fisica,null), 
	obter_nome_pf_pj(p.cd_prescritor,null), 
	p.cd_setor_atendimento, 
	p.nr_atendimento, 
	obter_unidade_atendimento(p.nr_atendimento,'A','U'), 
	p.dt_prescricao, 
	coalesce(p.dt_liberacao_medico,p.dt_liberacao), 
	obter_nome_setor(p.cd_setor_atendimento), 
	substr(obter_desc_convenio(obter_convenio_atendimento(p.nr_atendimento)),1,100) 
from	prescr_medica p, 
	estrutura_procedimento_v a, 
	prescr_procedimento c 
where	a.cd_procedimento	= c.cd_procedimento 
and	a.ie_origem_proced	= c.ie_origem_proced 
and	c.nr_prescricao		= p.nr_prescricao 
and	trunc(p.dt_prescricao,'dd') = trunc(clock_timestamp() - interval '1 days','dd') 
and	((coalesce(cd_procedimento_w::text, '') = '') or (c.cd_procedimento	= cd_procedimento_w)) 
and	((coalesce(ie_origem_proced_w::text, '') = '') or (c.ie_origem_proced	= ie_origem_proced_w) or (coalesce(cd_procedimento_w::text, '') = '')) 
and	((coalesce(cd_grupo_proc_w::text, '') = '') or (a.cd_grupo_proc = cd_grupo_proc_w)) 
and	((coalesce(cd_area_procedimento_w::text, '') = '') or (a.cd_area_procedimento = cd_area_procedimento_w)) 
and	((p.cd_prescritor = cd_pessoa_fisica_w) or (coalesce(cd_pessoa_fisica_w::text, '') = '')) 
and	((coalesce(cd_especialidade_w::text, '') = '') or (a.cd_especialidade = cd_especialidade_w)) 
and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (c.nr_seq_proc_interno	= nr_seq_proc_interno_w)) 
and	((coalesce(ie_tipo_atendimento_w::text, '') = '') or (obter_tipo_atendimento(obter_atendimento_prescr(p.nr_prescricao)) = ie_tipo_atendimento_w)) 
and	((ie_aplica_prescr_eup_w = 'S') or (coalesce(p.cd_funcao_origem,924) <> 916)) 
and	((coalesce(cd_protocolo_w::text, '') = '') or (p.cd_protocolo = cd_protocolo_w))	 
and	((coalesce(nr_seq_protocolo_w::text, '') = '') or (p.nr_seq_protocolo = nr_seq_protocolo_w)) 
order by p.nr_atendimento, p.nr_prescricao;
	
c02 CURSOR FOR 
SELECT	b.cd_perfil 
from	rep_perfil_ci_proced b 
where	b.nr_seq_regra	= nr_sequencia_ww;

c03 CURSOR FOR 
SELECT	b.cd_setor_recebimento 
from	rep_regra_ci_proced_setor b 
where	b.nr_seq_regra	= nr_sequencia_ww 
and  (b.cd_setor_recebimento IS NOT NULL AND b.cd_setor_recebimento::text <> '');

c14 CURSOR FOR 
SELECT	substr(obter_descricao_procedimento(c.cd_procedimento, c.ie_origem_proced),1,80), 
	c.ds_observacao, 
	c.ds_dado_clinico, 
	c.cd_procedimento, 
	coalesce(obter_desc_intervalo_prescr(c.cd_intervalo),c.cd_intervalo), 
	obter_desc_intervalo(c.cd_intervalo), 
	c.ds_horarios, 
	c.dt_prev_execucao, 
	c.qt_procedimento, 
	obter_nome_setor(c.cd_setor_atendimento), 
	c.cd_medico_exec 
from	prescr_medica p, 
	estrutura_procedimento_v a, 
	prescr_procedimento c 
where	a.cd_procedimento	= c.cd_procedimento 
and	a.ie_origem_proced	= c.ie_origem_proced 
and	c.nr_prescricao		= p.nr_prescricao 
and	c.nr_prescricao		= nr_prescricao_w;
	
c15 CURSOR FOR 
SELECT	b.nm_usuario_regra 
from	rep_regra_envio_ci_proced a, 
	rep_usuario_ci_proced b 
where	a.nr_sequencia	= b.nr_seq_regra 
and	b.nr_seq_regra	= nr_sequencia_ww 
and	obter_se_envia_ci_setor(a.nr_sequencia, cd_setor_w) = 'S';


BEGIN 
 
select	min(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	comunic_interna_classif 
where	ie_tipo	= 'F';
 
open c01;
loop 
fetch c01 into 
	nr_sequencia_ww, 
	ds_titulo_w, 
	ds_comunic_w, 
	cd_area_procedimento_w, 
	cd_especialidade_w, 
	cd_grupo_proc_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	ie_tipo_atendimento_w, 
	ie_enviar_prescritor_w, 
	nr_seq_proc_interno_w, 
	cd_protocolo_w, 
	nr_seq_protocolo_w, 
	ie_enviar_executor_w, 
	cd_pessoa_fisica_w, 
	ie_aplica_prescr_eup_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	ds_comunicado_w := null;
 
	open C001;
	loop 
	fetch C001 into	 
		nr_prescricao_w, 
		nm_paciente_w, 
		nm_medico_w, 
		cd_setor_w, 
		nr_atendimento_w, 
		ds_unidade_w, 
		dt_prescricao_w, 
		dt_liberacao_w, 
		ds_setor_prescr_w, 
		ds_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on C001 */
	 
		ie_gerar_comunic_w := obter_se_envia_ci_setor(nr_sequencia_www, cd_setor_w);
	 
		if (ie_gerar_comunic_w = 'S') then 
		 
			if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then 
				ds_comunicado_w	:=	ds_comunicado_w || ds_quebra_W || ds_quebra_W|| 
							obter_desc_expressao(325814)/*'Prescrição: '*/
 || nr_prescricao_w || ds_quebra_W || 
							obter_desc_expressao(775048)/*'Atendimento: '*/
 || nr_atendimento_w || ds_quebra_W || 
							obter_desc_expressao(325811)/*'Paciente: '*/
 || nm_paciente_w || ds_quebra_W || 
							obter_desc_expressao(298386)||': ' /*'Setor da prescrição:' */ || ds_setor_prescr_w || ds_quebra_W || 
							obter_desc_expressao(345228)||': ' /*'Leito do paciente:' */ || ds_unidade_w || ds_quebra_W || 
							obter_desc_expressao(326148)/*'Convênio: '*/
|| ds_convenio_w || ds_quebra_w || 
							obter_desc_expressao(335718)||':' ||to_char(dt_prescricao_W,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_W || 
							obter_desc_expressao(595025)/*'Dt Liberação:'*/
 ||to_char(dt_liberacao_w,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_W || 
							obter_desc_expressao(296217)||': ' /*'Prescritor: '*/|| nm_medico_w || ds_quebra_W|| ds_quebra_W;
			else 
				ds_comunicado_w	:=	obter_desc_expressao(325814)||': ' || nr_prescricao_w || ds_quebra_W || 
							obter_desc_expressao(775048)/*'Atendimento: '*/
 || nr_atendimento_w || ds_quebra_W || 
							obter_desc_expressao(325811)/*'Paciente: '*/
 || nm_paciente_w || ds_quebra_W || 
							obter_desc_expressao(298386)||': ' || ds_setor_prescr_w || ds_quebra_W || 
							obter_desc_expressao(345228)||': ' /*'Leito do paciente:' */ || ds_unidade_w || ds_quebra_W || 
							obter_desc_expressao(326148)/*'Convênio: '*/
|| ds_convenio_w || ds_quebra_w || 
							obter_desc_expressao(335718)||':' ||to_char(dt_prescricao_W,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_W || 
							obter_desc_expressao(595025)/*'Dt Liberação:'*/
 ||to_char(dt_liberacao_w,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_W || 
							obter_desc_expressao(296217)||': ' /*'Prescritor: '*/ || nm_medico_w || ds_quebra_W|| ds_quebra_W;
			end if;
			 
			open c14;
			loop 
			fetch c14 into	 
				ds_procedimento_w, 
				ds_observacao_w, 
				ds_dado_clinico_w, 
				cd_procedimento_w, 
				cd_intervalo_w, 
				ds_intervalo_w, 
				ds_horarios_w, 
				dt_prev_exec_w, 
				qt_procedimento_w, 
				ds_setor_exec_w, 
				cd_medico_exec_w;
			EXIT WHEN NOT FOUND; /* apply on c14 */
		 
				if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then 
					ds_comunicado_w := ds_comunicado_w || ds_quebra_w;
				end if;
				 
				ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(296423)/*'  Procedimento: '*/
 || cd_procedimento_w || ' - ' || ds_procedimento_w || ds_quebra_w;
				ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(614525)/*'  Quantidade:  '*/
 || qt_procedimento_w || ds_quebra_w;
				 
				if (dt_prev_exec_w IS NOT NULL AND dt_prev_exec_w::text <> '') then 
					ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(287132) ||':' /*'  Data Prevista execução:  '*/ || to_char(dt_prev_exec_w,'dd/mm/yyyy hh24:mi:ss') || ds_quebra_w;
				end if;
				 
				if ((coalesce(cd_intervalo_w, ds_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_w, ds_intervalo_w))::text <> '')) then 
					ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(326105)/*'  Intervalo:  '*/
 || coalesce(cd_intervalo_w, ds_intervalo_w) || ds_quebra_w;
				end if;
				 
				if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
					ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(771970)||': '/*'  Horarios:  '*/ || ds_horarios_w || ds_quebra_w;
				end if;
				 
				if (ds_setor_exec_w IS NOT NULL AND ds_setor_exec_w::text <> '') then 
					ds_comunicado_w := ds_comunicado_w || obter_desc_expressao(325813)/*'  Setor de execução:  '*/
 || ds_setor_exec_w || ds_quebra_w;
				end if;
				 
				if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then 
					ds_comunicado_w	:= ds_comunicado_w || obter_desc_expressao(329252)/*'  Observação: '*/
 || ds_observacao_w|| ds_quebra_w;		
				end if;
				 
				if (ds_dado_clinico_w IS NOT NULL AND ds_dado_clinico_w::text <> '') then 
					ds_comunicado_w	:= ds_comunicado_w || obter_desc_expressao(291839)/*'  Indicação clínica: '*/
 || ds_dado_clinico_w|| ds_quebra_w;		
				end if;
				 
				if (ie_enviar_executor_w = 'S') and (cd_medico_exec_w IS NOT NULL AND cd_medico_exec_w::text <> '') then 
					select	max(nm_usuario) 
					into STRICT	nm_usuario_destino_w 
					from	usuario 
					where	cd_pessoa_fisica = cd_medico_exec_w;
					 
					if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then 
						ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
					else 
						ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);
					end if;
					 
					 
				end if;
			end loop;
			close C14;
		end if;
	end loop;
	close C001;
	 
	cd_perfil_w := null;
	open c02;
	loop 
	fetch c02 into 
		cd_perfil_destino_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') or (cd_perfil_w <> '') then 
			cd_perfil_w := cd_perfil_w || ',';
		end if;
		 
		cd_perfil_w := substr(cd_perfil_w || cd_perfil_destino_w,1,1000);	
		 
	end loop;
	close c02;
	 
	cd_setor_envio_w := null;
	open c03;
	loop 
	fetch c03 into 
		cd_setor_destino_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		if (cd_setor_envio_w IS NOT NULL AND cd_setor_envio_w::text <> '') or (cd_setor_envio_w <> '') then 
			cd_setor_envio_w := cd_setor_envio_w || ',';
		end if;
		 
		cd_setor_envio_w := substr(cd_setor_envio_w || cd_setor_destino_w,1,1000);	
		 
	end loop;
	close c03;
	 
		 
	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then 
	 
		open C15;
		loop 
		fetch C15 into 
			nm_usuario_destino_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			 
			if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then 
				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
			end if;
			 
			ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);
		end loop;
		close C15;
		 
		if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then 
			begin 
			select	nextval('comunic_interna_seq') 
			into STRICT	nr_seq_comunic_w 
			;
			 
			insert	into comunic_interna(	 
				dt_comunicado, 
				ds_titulo, 
				ds_comunicado, 
				nm_usuario, 
				nm_usuario_destino, 
				dt_atualizacao, 
				ie_geral, 
				ie_gerencial, 
				ds_perfil_adicional, 
				nr_sequencia, 
				nr_seq_classif, 
				ds_setor_adicional, 
				dt_liberacao) 
			values ( 
				clock_timestamp(), 
				ds_titulo_w, 
				ds_comunic_w||ds_quebra_w ||ds_quebra_w||ds_comunicado_w, 
				nm_usuario_p, 
				ds_lista_usuario_destino_w, 
				clock_timestamp(), 
				'N', 
				'N', 
				cd_perfil_w, 
				nr_seq_comunic_w, 
				nr_sequencia_w, 
				cd_setor_envio_w, 
				clock_timestamp());	
				 
			if (ie_enviar_prescritor_w = 'N') then 
			 
				insert into comunic_interna_lida 
				values (	nr_seq_comunic_w, 
					nm_usuario_p, 
					clock_timestamp());
			end if;
			exception when others then 
				ds_erro_w	:= ds_erro_w;
			end;
			commit;
	 
		end if;
		ds_lista_usuario_destino_w := null;
	end if;
	 
end loop;
close C01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_prescr_proced_job (nm_usuario_p text) FROM PUBLIC;

