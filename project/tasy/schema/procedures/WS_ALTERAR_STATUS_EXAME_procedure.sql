-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ws_alterar_status_exame ( nr_prescricao_p text, nr_seq_prescr_p text, ie_status_atend_atual_p bigint, ie_status_atend_novo_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w		varchar(4000);
ds_status_exame_w	varchar(200);
qt_status_w		smallint;


BEGIN
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then

		select 	count(*)
		into STRICT	qt_status_w
		from 	prescr_procedimento
		where 	nr_prescricao 	= nr_prescricao_p
		and 	nr_sequencia 	= nr_seq_prescr_p
		and	ie_status_atend = ie_status_atend_atual_p;

		if (qt_status_w > 0) then
			begin
			update 	prescr_procedimento
			set 	ie_status_atend = ie_status_atend_novo_p,
				dt_atualizacao  = clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where 	nr_prescricao 	= nr_prescricao_p
			and 	nr_sequencia 	= nr_seq_prescr_p
			and	ie_status_atend = ie_status_atend_atual_p;

			commit;

			exception
				when others then
					begin
						ds_erro_w := substr(sqlerrm(SQLSTATE),1,3000);
					end;
			end;
		/*else
			select 	MAX(substr(nvl(Obter_regra_exame_status(vl_dominio),ds_valor_dominio),1,255))
			into	ds_status_exame_w
			from 	valor_dominio
			where 	cd_dominio = 1030
			and	vl_dominio = ie_status_atend_atual_p;

			ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(277786,'NR_SEQ_PRESCR='||nr_seq_prescr_p||';NR_PRESCRICAO='||nr_prescricao_p||';IE_STATUS_ATEND_ATUAL='||ie_status_atend_atual_p||';DS_STATUS_EXAME='||ds_status_exame_w);*/
		end if;
	else
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(277789,null);
	end if;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ws_alterar_status_exame ( nr_prescricao_p text, nr_seq_prescr_p text, ie_status_atend_atual_p bigint, ie_status_atend_novo_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

