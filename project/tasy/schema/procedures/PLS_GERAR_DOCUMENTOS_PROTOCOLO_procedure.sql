-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_documentos_protocolo ( nr_seq_protocolo_p bigint, ds_documento_p text, nm_usuario_p text) AS $body$
DECLARE


ds_documento_w    		varchar(255);
cd_documento_w	   		varchar(10);
qt_documento_w			integer;

BEGIN
ds_documento_w	:=ds_documento_p;
while(position(',' in ds_documento_w) > 0) loop
	begin
	--obtem-se o primeiro documento
	cd_documento_w := substr(ds_documento_w,1,position(',' in ds_documento_w)-1);-- recebe o numero menos  a virgula
	--remove-se essa do conjunto
	ds_documento_w	:= substr(ds_documento_w,position(',' in ds_documento_w)+1,255);
	--conta se documento existe no mesmo protocolo
	select  count(*)
	into STRICT	qt_documento_w
	from	pls_protocolo_reg_doc
	where	nr_seq_documento = cd_documento_w
	and	nr_seq_protocolo = nr_seq_protocolo_p;
	--se nao tem documento no mesmo protocolo entao insere
	if (qt_documento_w <1)then
		insert into pls_protocolo_reg_doc(	nr_sequencia, nr_seq_protocolo, nr_seq_documento,
			dt_entrega, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec)
		values (nextval('pls_protocolo_reg_doc_seq'), nr_seq_protocolo_p, (cd_documento_w)::numeric ,
			clock_timestamp(), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p);
	end if;
	end;
end loop;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_documentos_protocolo ( nr_seq_protocolo_p bigint, ds_documento_p text, nm_usuario_p text) FROM PUBLIC;

