-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_informatins_bed_request (dt_prevista_p timestamp, dt_final_p timestamp) AS $body$
DECLARE






ie_pflegegrad_w                 varchar(4000);

cd_departamento_w	        departamento_medico.cd_departamento%type;

w_ds_valor_dominio              valor_dominio_v.ds_valor_dominio%TYPE;



c_atendimento_vaga CURSOR(dt_prevista_p timestamp, dt_final_p timestamp) FOR

        SELECT  temp.*

        from ( SELECT   distinct('Z_' || obter_sexo_pf(a.cd_pessoa_fisica, 'C')) ie_sexo,

                        substr(obter_nome_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,40) ds_convenio,

                        Obter_Plano_Convenio_Atend(a.nr_atendimento,'D') ds_plano_convenio,

                        obter_valor_dominio(17, a.ie_clinica) ds_clinica,

                        trunc(coalesce(trunc(a.dt_alta), trunc(clock_timestamp())) - trunc(to_date(Obter_Unidade_Atendimento(a.nr_atendimento,'PI','DT'),'dd/mm/yyyy hh24:mi:ss'))) + 1 nr_dias_internado,

                        obter_dados_vaga_mapa(a.nr_atendimento) ds_vaga,

                        a.nr_seq_episodio,

                        a.nr_atendimento,

                        obter_presc_ultimo_sae(a.nr_atendimento,'NC') ds_nivel_complexidade,

                        a.cd_pessoa_fisica,

                        substr(obter_desc_cid(obter_cid_atendimento(a.nr_atendimento,'P')),1,240) ds_diagnostico,

                        substr(Obter_enfermeiro_resp(a.nr_atendimento,'D'),1,100) nm_colab_resp,

                        somente_numero(substr(obter_complexidade_assist(a.nr_atendimento, g.cd_setor_desejado, 'P','1'),1,10)) qt_pontos,

                        substr(obter_complexidade_nut(a.nr_atendimento,g.cd_setor_desejado,'PC'),1,100) qt_ponto_nut,

			substr(obter_complexidade_nut(a.nr_atendimento,g.cd_setor_desejado,'PC', 2),1,100) qt_ponto_nut2,

			substr(obter_escalas_panorama(g.cd_setor_desejado, a.nr_atendimento, 'E'),1,4000) ds_escalas_panorama,

                        substr(obter_anotacao_pendente(a.nr_atendimento),1,255) ds_anotacao,

                        obter_data_cirurgia(a.cd_pessoa_fisica) dt_cirurgia,

                        substr(obter_tipos_isolamentos_cih(a.nr_atendimento,'D'),1,255) ds_tipo_isolamento_cih,

                        obter_data_escala_dor_atend(a.nr_atendimento) dt_escala_dor,

                        CASE WHEN coalesce(obter_desc_escala_dor_inapto(a.nr_atendimento,'DS')::text, '') = '' THEN substr(obter_sinal_vital(a.nr_atendimento,'ESCDOR'),1,100)  ELSE 0 END  qt_escala_dor,

                        coalesce(SUBSTR(obter_desc_escala_dor_inapto(a.nr_atendimento,'DS'),1,255),SUBSTR(obter_desc_result_dor(obter_sinal_vital(a.nr_atendimento,'REDOR'),'D'),1,100)) ds_escala_dor,

                        substr(obter_nome_pf(obter_profissional_resp(a.nr_atendimento,'N')),1,100) nm_nutricionista,

                        a.qt_dias_prev_inter,

                        substr(obter_result_aval_subj_global(a.nr_atendimento,'NM'),1,255) nm_aval_nut,

                        substr(obter_profissional_atend(a.nr_atendimento,'M','N'),1,60) nm_medico_resp,

                        substr(obter_profissional_atend(a.nr_atendimento,'P','N'),1,60) nm_psicologo_resp,

                        substr(obter_profissional_atend(a.nr_atendimento,'F','N'),1,60) nm_farmaceutico_resp,

                        substr(obter_profissional_atend(a.nr_atendimento,'FI','N'),1,60) nm_fisioterapeuta_resp,

                        substr(obter_profissional_atend(a.nr_atendimento,'A','N'),1,60) nm_assistente_resp,

                        substr(obter_profissional_atend(a.nr_atendimento,'E','N'),1,60) nm_enf_resp,

                        a.dt_alta,

                        a.dt_entrada,

                        to_date(CASE WHEN obter_classif_setor_min(a.nr_atendimento)=1 THEN                             CASE WHEN a.ie_tipo_atendimento=1 THEN  Obter_Unidade_Atendimento(a.nr_atendimento,'PI','DT')  ELSE to_char(a.dt_entrada, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) END   ELSE to_char(a.dt_entrada, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) END , pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario))) dt_internacao,

                        obter_dieta_lib_atend(a.nr_atendimento) ds_dieta_liberada,

                        obter_cirurgia_paciente(a.nr_atendimento, 'P') ds_cirurgia,

                        CASE WHEN substr(Obter_Se_atend_sae(a.nr_atendimento),1,1)='S' THEN  obter_desc_expressao(285693) END  ds_sae,

			g.nr_sequencia nr_seq_vaga,

			obter_classif_esp_pac(a.nr_atendimento) ds_classif_esp_pac,

			dt_previsto_alta,

            'LA U90' cd_doenca

                from	atendimento_paciente a,

			gestao_vaga g

                where	g.nr_atendimento   = a.nr_atendimento

		AND pkg_date_utils.start_of(g.dt_prevista, 'DAY') BETWEEN TO_DATE(dt_prevista_p, 'yyyy/mm/dd') AND TO_DATE(dt_final_p, 'yyyy/mm/dd')

		and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')

		and	coalesce(a.dt_cancelamento::text, '') = ''

		and	g.ie_status in ('A', 'E', 'I', 'L')

		and	not exists (select 1 from w_pan_info_adicional w where w.nr_seq_vaga = g.nr_sequencia and w.ie_concluido = 'S')

            ) temp;



procedure insert_inf_adic(      ie_campo_panorama_p	bigint,

				mr_seq_vaga_p		bigint,

				cd_expressao_p		bigint,

				nr_seq_texto_p		bigint,

				ds_valor_p		text,

				nr_valor_p		bigint,

				dt_valor_p		timestamp,

				nr_seq_apres_p		bigint,

				ds_mascara_p		text := null) is




	ie_atrasado_w	varchar(1)	:= 'N';



	
BEGIN



	/* Teste para campo que deva mostrar atraso */

	if (ie_campo_panorama_p = 12) then

		ie_atrasado_w	:= 'S';

	else

		ie_atrasado_w	:= 'N';

	end if;



	insert into w_pan_info_adicional(cd_exp_label,

		nr_seq_texto_label,

		ds_info_adic,

		nr_info_adic,

		dt_info_adic,

		nr_seq_apres,

		ie_concluido,

		ds_mascara,

		ie_campo_panorama,

		ie_atrasado,

		nr_seq_vaga)

	values (cd_expressao_p,

		nr_seq_texto_p,

		substr(ds_valor_p,1,255),

		nr_valor_p,

		dt_valor_p,

		nr_seq_apres_p,

		'S',

		ds_mascara_p,

		ie_campo_panorama_p,

		ie_atrasado_w,

		mr_seq_vaga_p);

end;





begin



delete

from w_pan_info_adicional 

where (nr_seq_vaga IS NOT NULL AND nr_seq_vaga::text <> '') 

and ie_concluido = 'S';

begin

 for r_c_atendimento in c_atendimento_vaga(dt_prevista_p, dt_final_p) loop


	if (r_c_atendimento.cd_doenca IS NOT NULL AND r_c_atendimento.cd_doenca::text <> '') then

	     CALL insert_inf_adic(785,r_c_atendimento.nr_seq_vaga, 309369,1065031,r_c_atendimento.cd_doenca,null,null,785,null);

	end if;

	if (r_c_atendimento.dt_previsto_alta IS NOT NULL AND r_c_atendimento.dt_previsto_alta::text <> '') then

	     CALL insert_inf_adic(75,r_c_atendimento.nr_seq_vaga, 309369,1065031,r_c_atendimento.dt_previsto_alta,null,null,75,null);

	end if;

	

	if (r_c_atendimento.ds_classif_esp_pac IS NOT NULL AND r_c_atendimento.ds_classif_esp_pac::text <> '') then

	     CALL insert_inf_adic(69,r_c_atendimento.nr_seq_vaga, 285109,1061836,r_c_atendimento.ds_classif_esp_pac,null,null,69,null);

	end if;



	if (r_c_atendimento.ie_sexo IS NOT NULL AND r_c_atendimento.ie_sexo::text <> '') then

	    CALL insert_inf_adic(3,r_c_atendimento.nr_seq_vaga  ,298476,968960,r_c_atendimento.ie_sexo,null,null,3,null);

	end if;

	

	if (r_c_atendimento.ds_convenio IS NOT NULL AND r_c_atendimento.ds_convenio::text <> '') then

	    CALL insert_inf_adic(4,r_c_atendimento.nr_seq_vaga  ,696048,968976,r_c_atendimento.ds_convenio,null,null,4,null);

	end if;

	

	if (r_c_atendimento.ds_plano_convenio IS NOT NULL AND r_c_atendimento.ds_plano_convenio::text <> '') then

	    CALL insert_inf_adic(5,r_c_atendimento.nr_seq_vaga  ,697043,969125,r_c_atendimento.ds_plano_convenio,null,null,5,null);

	end if;

	

	if (r_c_atendimento.ds_clinica IS NOT NULL AND r_c_atendimento.ds_clinica::text <> '') then

	    CALL insert_inf_adic(6,r_c_atendimento.nr_seq_vaga  ,284962,969181,r_c_atendimento.ds_clinica,null,null,6, null);

	end if;

	

	if (r_c_atendimento.nr_dias_internado IS NOT NULL AND r_c_atendimento.nr_dias_internado::text <> '') then

	    CALL insert_inf_adic(7,r_c_atendimento.nr_seq_vaga  ,692411,1024110,null,r_c_atendimento.nr_dias_internado,null,7, null);

	end if;

	

	if (r_c_atendimento.ds_vaga IS NOT NULL AND r_c_atendimento.ds_vaga::text <> '') then

	    CALL insert_inf_adic(8,r_c_atendimento.nr_seq_vaga  ,298850,969267,r_c_atendimento.ds_vaga,null,null,8, null);

	end if;



	if (r_c_atendimento.nr_atendimento IS NOT NULL AND r_c_atendimento.nr_atendimento::text <> '') then

	    CALL insert_inf_adic(11,r_c_atendimento.nr_seq_vaga  ,283863,969291,null,r_c_atendimento.nr_atendimento,null,1, null );

	end if;



	if (r_c_atendimento.nr_seq_episodio IS NOT NULL AND r_c_atendimento.nr_seq_episodio::text <> '') then

	    CALL insert_inf_adic(28,r_c_atendimento.nr_seq_vaga  ,783146,969276,null,r_c_atendimento.nr_seq_episodio,null,null,null );

	end if;



	cd_departamento_w	:= obter_departamento_data(r_c_atendimento.nr_atendimento);

	

	if (cd_departamento_w IS NOT NULL AND cd_departamento_w::text <> '') then

	    CALL insert_inf_adic(29,r_c_atendimento.nr_seq_vaga  ,332098,969277,obter_nome_departamento_medico(cd_departamento_w),null,null,null,null );

	end if;



	if (r_c_atendimento.ds_nivel_complexidade IS NOT NULL AND r_c_atendimento.ds_nivel_complexidade::text <> '') then

	    CALL insert_inf_adic(30,r_c_atendimento.nr_seq_vaga  ,859709,996138,r_c_atendimento.ds_nivel_complexidade,null,null,null,null );

	end if;

	if (r_c_atendimento.ds_diagnostico IS NOT NULL AND r_c_atendimento.ds_diagnostico::text <> '') then

	    CALL insert_inf_adic(32,r_c_atendimento.nr_seq_vaga  ,287694,1022593,r_c_atendimento.ds_diagnostico,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_colab_resp IS NOT NULL AND r_c_atendimento.nm_colab_resp::text <> '') then

	    CALL insert_inf_adic(33,r_c_atendimento.nr_seq_vaga  ,714994,1022634,r_c_atendimento.nm_colab_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.qt_pontos IS NOT NULL AND r_c_atendimento.qt_pontos::text <> '') then

	    CALL insert_inf_adic(34,r_c_atendimento.nr_seq_vaga  ,309327,1022649,r_c_atendimento.qt_pontos,null,null,null,null );

	end if;



	if (r_c_atendimento.qt_ponto_nut IS NOT NULL AND r_c_atendimento.qt_ponto_nut::text <> '') then

	    CALL insert_inf_adic(36,r_c_atendimento.nr_seq_vaga  ,309319,1022693,r_c_atendimento.qt_ponto_nut,null,null,null,null );

	end if;

			

	if (r_c_atendimento.qt_ponto_nut2 IS NOT NULL AND r_c_atendimento.qt_ponto_nut2::text <> '') then

	    CALL insert_inf_adic(65,r_c_atendimento.nr_seq_vaga  ,854589,1053077,r_c_atendimento.qt_ponto_nut2,null,null,null,null );

	end if;

	

	if (r_c_atendimento.ds_escalas_panorama IS NOT NULL AND r_c_atendimento.ds_escalas_panorama::text <> '') then

	    CALL insert_inf_adic(64,r_c_atendimento.nr_seq_vaga  ,308877,969272,r_c_atendimento.ds_escalas_panorama,null,null,null,null );

	end if;



	if (r_c_atendimento.ds_anotacao IS NOT NULL AND r_c_atendimento.ds_anotacao::text <> '') then

	    CALL insert_inf_adic(37,r_c_atendimento.nr_seq_vaga  ,308100,1022887,r_c_atendimento.ds_anotacao,null,null,null,null );

	end if;



	if (r_c_atendimento.dt_cirurgia IS NOT NULL AND r_c_atendimento.dt_cirurgia::text <> '') then

	    CALL insert_inf_adic(38,r_c_atendimento.nr_seq_vaga  ,614821,1022890,r_c_atendimento.dt_cirurgia,null,null,null,null );

	end if;



	if (r_c_atendimento.ds_tipo_isolamento_cih IS NOT NULL AND r_c_atendimento.ds_tipo_isolamento_cih::text <> '') then

	    CALL insert_inf_adic(39,r_c_atendimento.nr_seq_vaga  ,306717,1022904,r_c_atendimento.ds_tipo_isolamento_cih,null,null,null,null );

	end if;



	if (r_c_atendimento.qt_escala_dor IS NOT NULL AND r_c_atendimento.qt_escala_dor::text <> '') then

	    CALL insert_inf_adic(42,r_c_atendimento.nr_seq_vaga  ,669692,1022924,r_c_atendimento.qt_escala_dor,null,null,null,null );

	end if;



	if (r_c_atendimento.ds_escala_dor IS NOT NULL AND r_c_atendimento.ds_escala_dor::text <> '') then

	    CALL insert_inf_adic(43,r_c_atendimento.nr_seq_vaga  ,600756,1022945,r_c_atendimento.ds_escala_dor,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_nutricionista IS NOT NULL AND r_c_atendimento.nm_nutricionista::text <> '') then

	    CALL insert_inf_adic(44,r_c_atendimento.nr_seq_vaga  ,310527,1022946,r_c_atendimento.nm_nutricionista,null,null,null,null );

	end if;



	if (r_c_atendimento.qt_dias_prev_inter IS NOT NULL AND r_c_atendimento.qt_dias_prev_inter::text <> '') then

	    CALL insert_inf_adic(45,r_c_atendimento.nr_seq_vaga  ,287749,1022953,r_c_atendimento.qt_dias_prev_inter,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_aval_nut IS NOT NULL AND r_c_atendimento.nm_aval_nut::text <> '') then

	    CALL insert_inf_adic(46,r_c_atendimento.nr_seq_vaga  ,738750,1022961,r_c_atendimento.nm_aval_nut,null,null,null,null );

	end if;



	if (r_c_atendimento.dt_escala_dor IS NOT NULL AND r_c_atendimento.dt_escala_dor::text <> '') then

	    CALL insert_inf_adic(40,r_c_atendimento.nr_seq_vaga  ,309093,1022963,r_c_atendimento.dt_escala_dor,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_medico_resp IS NOT NULL AND r_c_atendimento.nm_medico_resp::text <> '') then

	    CALL insert_inf_adic(41,r_c_atendimento.nr_seq_vaga  ,293157,1022986,r_c_atendimento.nm_medico_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_psicologo_resp IS NOT NULL AND r_c_atendimento.nm_psicologo_resp::text <> '') then

	    CALL insert_inf_adic(47,r_c_atendimento.nr_seq_vaga  ,682758,1022992,r_c_atendimento.nm_psicologo_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_farmaceutico_resp IS NOT NULL AND r_c_atendimento.nm_farmaceutico_resp::text <> '') then

	    CALL insert_inf_adic(48,r_c_atendimento.nr_seq_vaga  ,289984,1022995,r_c_atendimento.nm_farmaceutico_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_fisioterapeuta_resp IS NOT NULL AND r_c_atendimento.nm_fisioterapeuta_resp::text <> '') then

	    CALL insert_inf_adic(49,r_c_atendimento.nr_seq_vaga  ,682744,1022997,r_c_atendimento.nm_fisioterapeuta_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.nm_assistente_resp IS NOT NULL AND r_c_atendimento.nm_assistente_resp::text <> '') then

	    CALL insert_inf_adic(50,r_c_atendimento.nr_seq_vaga  ,682746,1022999,r_c_atendimento.nm_assistente_resp,null,null,null,null);

	end if;



	if (r_c_atendimento.nm_enf_resp IS NOT NULL AND r_c_atendimento.nm_enf_resp::text <> '') then

	    CALL insert_inf_adic(51,r_c_atendimento.nr_seq_vaga  ,682733,1023009,r_c_atendimento.nm_enf_resp,null,null,null,null );

	end if;



	if (r_c_atendimento.dt_entrada IS NOT NULL AND r_c_atendimento.dt_entrada::text <> '') then

	    CALL insert_inf_adic(52,r_c_atendimento.nr_seq_vaga  ,873779,1028751,r_c_atendimento.dt_entrada,null,null,null,null);

	end if;



	if (r_c_atendimento.ds_dieta_liberada IS NOT NULL AND r_c_atendimento.ds_dieta_liberada::text <> '') then

	    CALL insert_inf_adic(57,r_c_atendimento.nr_seq_vaga  ,287910,1028890,r_c_atendimento.ds_dieta_liberada,null,null,null,null );

	end if;



	if (r_c_atendimento.ds_cirurgia IS NOT NULL AND r_c_atendimento.ds_cirurgia::text <> '') then

	    CALL insert_inf_adic(58,r_c_atendimento.nr_seq_vaga  ,316812,1028959,r_c_atendimento.ds_cirurgia,null,null,null,null );

	end if;



	if (r_c_atendimento.ds_sae IS NOT NULL AND r_c_atendimento.ds_sae::text <> '') then

	    CALL insert_inf_adic(59,r_c_atendimento.nr_seq_vaga  ,297968,1033368,r_c_atendimento.ds_sae,null,null,null,null );

	end if;



	ie_pflegegrad_w := obter_pflegegrad(r_c_atendimento.cd_pessoa_fisica, r_c_atendimento.nr_atendimento);

	

	if (ie_pflegegrad_w IS NOT NULL AND ie_pflegegrad_w::text <> '') then

	    select max(v_dom.ds_valor_dominio) as ds_valor_dominio

	    into STRICT w_ds_valor_dominio

	    from dominio dom

		,valor_dominio_v v_dom

	    where dom.cd_dominio = v_dom.cd_dominio

	    and dom.cd_dominio = 8674 -- Pflegegrad
	    and v_dom.vl_dominio = ie_pflegegrad_w;



	    CALL insert_inf_adic(31, r_c_atendimento.nr_seq_vaga, 795203, 996681, w_ds_valor_dominio, null, null, null,null );

	end if;

	

	commit;

	

        end loop;

exception
  when others then
    null;

end;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_informatins_bed_request (dt_prevista_p timestamp, dt_final_p timestamp) FROM PUBLIC;

