-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_ciclos_trat_onco ( nr_seq_paciente_p bigint, cd_pessoa_fisica_p text) AS $body$
DECLARE

 
nr_prescricao_susp_w		bigint;
nr_seq_atendimento_w		bigint;
nm_usuario_w			  varchar(15);
ie_suspender_ciclo_w		varchar(1);

C01 CURSOR FOR 
	SELECT b.nr_seq_atendimento, 
		  b.nr_prescricao 
	FROM	paciente_setor a, 
		paciente_atendimento b 
	WHERE a.nr_seq_paciente 	= nr_seq_paciente_p 
	AND ((ie_suspender_ciclo_w = 'T' and coalesce(b.nr_prescricao::text, '') = '') or (ie_suspender_ciclo_w = 'S' and coalesce(b.dt_real,clock_timestamp()) >= clock_timestamp())) 
	AND	a.nr_seq_paciente = b.nr_seq_paciente 
	AND	coalesce(b.dt_cancelamento::text, '') = '' 
	AND	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
	ORDER BY b.nr_seq_atendimento;


BEGIN 
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
	ie_suspender_ciclo_w := coalesce(Obter_Valor_Param_Usuario(281,1326, Obter_perfil_Ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento), 'N');
   
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_atendimento_w, 
		nr_prescricao_susp_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	 
			CALL suspender_dia_tratamento_onco(nr_prescricao_susp_w, nr_seq_atendimento_w, nm_usuario_w);	
		end;
	end loop;
	close C01;
	commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_ciclos_trat_onco ( nr_seq_paciente_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

