-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bft_check_rules_ihi ( cd_pessoa_fisica_p person_ihi.cd_pessoa_fisica%type, nr_ihi_p person_ihi.nr_ihi%type, ie_status_p person_ihi.ie_status%type, ie_record_status_p person_ihi.ie_record_status%type, ie_data_type_p person_ihi.ie_data_type%type, ds_family_name_p person_name.ds_family_name%type, ie_sex_p pessoa_fisica.ie_sexo%type, dt_birth_p pessoa_fisica.dt_nascimento%type, ds_result_p INOUT text) AS $body$
DECLARE


/* 	Requisitos anexados na OS 1982678
	ie_data_type_p 
	I for individuals
	P for professionals
*/
nr_ihi_active_w			person_ihi.nr_ihi%type;
nr_hpi_active_w			person_ihi.nr_ihi%type;
ie_status_current_w		person_ihi.ie_status%type;


BEGIN

ds_result_p := 'SUCCESS';

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (nr_ihi_p IS NOT NULL AND nr_ihi_p::text <> '') then
	begin
	
	
	if (ie_data_type_p = 'I') then
		begin
		
			select 	max(ie_status)
			into STRICT 	ie_status_current_w
			from	person_ihi
			where	cd_pessoa_fisica = cd_pessoa_fisica_p
			and		ie_data_type = ie_data_type_p
			and		ie_situacao = 'A';
	
		-- 005839 - Alert when the same IHI is assigned to records of more than one patient.
			select	coalesce(max('005839DI'), ds_result_p)
			into STRICT	ds_result_p
			from	person_ihi
			where	nr_ihi	= nr_ihi_p
			and		cd_pessoa_fisica <> cd_pessoa_fisica_p;
		-- END


		-- 005875 - Assignment of IHIs	
			if (ie_record_status_p = 'V') then

				-- if similar patient is stored in system, then mark as conflicting
				select 	coalesce(max('005839DP'), ds_result_p)
				into STRICT	ds_result_p
				from 	pessoa_fisica a,
						person_name b
				where 	a.nr_seq_person_name = b.nr_sequencia		
				and 	upper(b.ds_family_name) = upper(ds_family_name_p)
				and 	upper(a.ie_sexo) = upper(ie_sex_p)
				and 	trunc(a.dt_nascimento) = trunc(dt_birth_p)
				and 	a.cd_pessoa_fisica <> cd_pessoa_fisica_p;

			end if;
		-- END


		-- 016815 - Rules for when the validation of an active and verified IHI returns the same IHI number and same IHI record status but with a different IHI status
			if (ie_status_current_w = 'A') and (ie_record_status_p = 'V') then

				select 	coalesce(max('016815'), ds_result_p)
				into STRICT	ds_result_p
				from 	person_ihi
				where	cd_pessoa_fisica = cd_pessoa_fisica_p
				and		ie_data_type = ie_data_type_p
				and		ie_situacao = 'A'
				and		nr_ihi = nr_ihi_p
				and 	ie_record_status = ie_record_status_p
				and		ie_status <> ie_status_p;		
			end if;
		-- END

		
		-- 016813 - Actions for when validation of a verified IHI returns a ‘resolved’ information message and a different IHI number
			if (ie_status_p = 'RS') then
			
				select 	coalesce(max(nr_ihi),0)
				into STRICT	nr_hpi_active_w
				from 	person_ihi
				where	cd_pessoa_fisica = cd_pessoa_fisica_p
				and		ie_data_type = ie_data_type_p
				and		ie_situacao = 'A'
				and 	ie_status <> 'RS';

				if (nr_hpi_active_w != 0 and nr_hpi_active_w != nr_ihi_p) then
					-- current active IHI-I is different from the IHI sent by HI Service.
					ds_result_p := '016813C';
			
				else 			
					select 	coalesce(max('016813V'), '016813N')
					into STRICT	ds_result_p
					from 	pessoa_fisica a,
							person_name b
					where 	a.nr_seq_person_name = b.nr_sequencia		
					and 	upper(b.ds_family_name) = upper(ds_family_name_p)
					and 	upper(a.ie_sexo) = upper(ie_sex_p)
					and 	trunc(a.dt_nascimento) = trunc(dt_birth_p)
					and 	a.cd_pessoa_fisica = cd_pessoa_fisica_p;
				end if;
				
			end if;
		-- END

		
		-- 017421 - Rules for when the validation of a deceased verified IHI returns the same IHI number and same IHI record status but with a different IHI status
			if (ie_status_current_w = 'D') and (ie_record_status_p = 'V') then

				select 	coalesce(max('017421'), ds_result_p)
				into STRICT	ds_result_p
				from 	person_ihi
				where	cd_pessoa_fisica = cd_pessoa_fisica_p
				and		ie_data_type = ie_data_type_p
				and		ie_situacao = 'A'
				and		nr_ihi = nr_ihi_p
				and 	ie_record_status = ie_record_status_p
				and		ie_status <> ie_status_p;		
			end if;
		-- END		

	
		-- 016814 - Rules for when the validation of an active and verified IHI returns the same IHI number but with an IHI record status of unverified / provisional
			if (ie_record_status_p = 'U') then
				ds_result_p  := '016814';
			elsif (ie_record_status_p = 'P') then
				ds_result_p  := '016814P';
			end if;
		-- END
	
		end;
	end if;

-- 023502 Popup an alert or warning when a Healthcare Provider Identifier is found to be resolved or not active

-- When HI Service indicates the identifier is resolved or not active (e.g. retired, resolved, deactivated),
	  if (ie_data_type_p = 'P') then	
	
		if (ie_status_p = 'RS') then	
		
			select 	coalesce(max(nr_ihi),0)
			into STRICT	nr_hpi_active_w
			from 	person_ihi
			where	cd_pessoa_fisica = cd_pessoa_fisica_p
			and		ie_data_type = ie_data_type_p
			and		ie_situacao = 'A'
			and 	ie_status <> 'RS';

			if (nr_hpi_active_w != 0 and nr_hpi_active_w != nr_ihi_p) then
				-- current active HPI-I is different from the HPI sent by HI Service.
				ds_result_p := '023502C';
		
			else
				select 	coalesce(max('023502V'), '023502N')
				into STRICT	ds_result_p
				from 	pessoa_fisica a,
						person_name b
				where 	a.nr_seq_person_name = b.nr_sequencia		
				and 	upper(b.ds_family_name) = upper(ds_family_name_p)
				and 	upper(a.ie_sexo) = upper(ie_sex_p)
				and 	trunc(a.dt_nascimento) = trunc(dt_birth_p)
				and 	a.cd_pessoa_fisica = cd_pessoa_fisica_p;		
			end if;
			
		elsif (ie_status_p in ('R','DA')) then
		
			ds_result_p := '023502';
			
		end if;
			
	end if;
-- END
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bft_check_rules_ihi ( cd_pessoa_fisica_p person_ihi.cd_pessoa_fisica%type, nr_ihi_p person_ihi.nr_ihi%type, ie_status_p person_ihi.ie_status%type, ie_record_status_p person_ihi.ie_record_status%type, ie_data_type_p person_ihi.ie_data_type%type, ds_family_name_p person_name.ds_family_name%type, ie_sex_p pessoa_fisica.ie_sexo%type, dt_birth_p pessoa_fisica.dt_nascimento%type, ds_result_p INOUT text) FROM PUBLIC;

