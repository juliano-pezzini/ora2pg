-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_atend_guia_senha (nr_atendimento_p bigint, cd_convenio_p bigint, nr_doc_convenio_p text, cd_senha_p text, ie_consiste_tipo_guia_p text, nr_atend_retorno_p INOUT bigint) AS $body$
DECLARE

 
nr_atendimento_w	bigint;
ie_consistir_w		varchar(1)	:= 'N';	
ie_tipo_atendimento_w	smallint;
ie_carater_inter_sus_w	varchar(2);
ie_tipo_atend_tiss_w	varchar(2);
cd_existe_convenio_w	bigint;
cd_senha_w		varchar(20) := cd_senha_p;


BEGIN 
 
cd_senha_w := Elimina_Caracteres_Especiais(cd_senha_w);
 
nr_atend_retorno_p	:= 0;
 
if (ie_consiste_tipo_guia_p	= 'S') then 
	select	coalesce(max(a.nr_atendimento),0) 
	into STRICT	nr_atendimento_w 
	from	atend_categoria_convenio a, 
		atendimento_paciente b 
	where	a.cd_convenio		= cd_convenio_p 
	and	a.nr_doc_convenio	= nr_doc_convenio_p 
	and	a.cd_senha		= cd_senha_w 
	and	a.nr_atendimento    = b.nr_atendimento 
	and	coalesce(b.dt_cancelamento::text, '') = '';
	 
elsif (ie_consiste_tipo_guia_p	= 'GN') then 
 
	select	coalesce(max(nr_atendimento),0) 
	into STRICT	nr_atendimento_w 
	from	atend_categoria_convenio 
	where	cd_convenio		= cd_convenio_p 
	and	nr_doc_convenio		= nr_doc_convenio_p 
	and	coalesce(cd_senha,'0')	= coalesce(cd_senha_w,'0');
 
elsif (ie_consiste_tipo_guia_p	= 'R') then	 
 
	select	coalesce(max(ie_tipo_atendimento),0), 
		coalesce(max(ie_carater_inter_sus),'0'), 
		coalesce(max(ie_tipo_atend_tiss),'0') 
	into STRICT	ie_tipo_atendimento_w, 
		ie_carater_inter_sus_w, 
		ie_tipo_atend_tiss_w 
	from 	atendimento_paciente 
	where	nr_atendimento 		= nr_atendimento_p;	
	 
	select	coalesce(max(ie_necessita_consistir),'N') 
	into STRICT	ie_consistir_w 
	from	regra_guia_senha_atend 
	where	coalesce(cd_convenio,cd_convenio_p) 				= cd_convenio_p 
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w 
	and	coalesce(ie_carater_inter_sus,ie_carater_inter_sus_w) 	= ie_carater_inter_sus_w 
	and	coalesce(ie_tipo_atend_tiss,ie_tipo_atend_tiss_w)		= ie_tipo_atend_tiss_w 
	and	ie_situacao = 'A';
	 
	if (ie_consistir_w = 'S') then 
		begin 
		 
		select	coalesce(max(cd_convenio),0) 
		into STRICT	cd_existe_convenio_w 
		from	regra_guia_senha_atend 
		where	coalesce(cd_convenio,cd_convenio_p) 				= cd_convenio_p 
		and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w 
		and	coalesce(ie_carater_inter_sus,ie_carater_inter_sus_w) 	= ie_carater_inter_sus_w 
		and	coalesce(ie_tipo_atend_tiss,ie_tipo_atend_tiss_w)		= ie_tipo_atend_tiss_w 
		and	ie_situacao = 'A';
		 
		if (cd_existe_convenio_w = 0) then 
			select	coalesce(max(nr_atendimento),0) 
			into STRICT	nr_atendimento_w 
			from	atend_categoria_convenio 
			where	nr_doc_convenio		= nr_doc_convenio_p 
			and	cd_senha		= cd_senha_w 
			and	nr_atendimento     <> nr_atendimento_p;	
		else 
			select	coalesce(max(nr_atendimento),0) 
			into STRICT	nr_atendimento_w 
			from	atend_categoria_convenio 
			where	cd_convenio		= cd_convenio_p 
			and	nr_doc_convenio		= nr_doc_convenio_p 
			and	cd_senha		= cd_senha_w 
			and	nr_atendimento     <> nr_atendimento_p;
		end if;
		end;
	else 
		nr_atendimento_w	:=	0;
	end if;
elsif (ie_consiste_tipo_guia_p	= 'SS') then 
 
	select	coalesce(max(a.nr_atendimento),0) 
	into STRICT	nr_atendimento_w 
	from	atend_categoria_convenio a, 
		atendimento_paciente b 
	where	a.cd_convenio		= cd_convenio_p 
	and	a.cd_senha		= cd_senha_w 
	and	a.nr_atendimento    = b.nr_atendimento 
	and	coalesce(b.dt_cancelamento::text, '') = '';
end if;
 
 
if (nr_atendimento_w > 0) and (nr_atendimento_w <> nr_atendimento_p) then 
	nr_atend_retorno_p	:= nr_atendimento_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_atend_guia_senha (nr_atendimento_p bigint, cd_convenio_p bigint, nr_doc_convenio_p text, cd_senha_p text, ie_consiste_tipo_guia_p text, nr_atend_retorno_p INOUT bigint) FROM PUBLIC;

