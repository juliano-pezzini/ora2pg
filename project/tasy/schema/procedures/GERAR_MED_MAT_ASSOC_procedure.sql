-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_med_mat_assoc ( nr_prescricao_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


-- OS 583829 // Somente ajustei a ordem das restrições nos select's
nr_agrup_acum_w				double precision;
cd_material_w				integer;
cd_unidade_medida_w			varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
qt_dose_w					double precision;
nm_usuario_w				varchar(15);
ds_observacao_w				varchar(255);
qt_conversao_w				double precision;
nr_sequencia_w				integer;
cd_intervalo_w				varchar(7);
ds_horarios_w				varchar(2000);
ds_horarios_ww				varchar(2000);
ie_se_necessario_w			varchar(20);
ds_horarios2_ww				varchar(2000);
nr_ocorrencia_w				bigint := 0;
cd_estabelecimento_w		smallint;
cd_setor_atendimento_w		bigint;
ie_tipo_atendimento_w		bigint;
qt_total_disp_w				double precision;
ie_gera_associado_w			varchar(5);
ds_erro_w					varchar(255);
VarChecarSN_w				varchar(5);
cd_pessoa_fisica_w			varchar(255);
ie_acm_w					varchar(5);
ie_sexo_w					varchar(5);
ie_via_aplicacao_w			varchar(5);
ie_duplicar_w				varchar(15);
dt_primeiro_horario_w		timestamp;
dt_prescricao_w				timestamp;
cd_motivo_baixa_w			smallint;
cont_w						bigint;
dt_baixa_w					timestamp;
ie_cobra_paciente_w			varchar(1);
qt_idade_min_w				real;
qt_idade_max_w				real;
qt_idade_pac_w				double precision;
qt_idade_pac_ww				double precision;
ie_intervalo_fixo_w			varchar(1);/* Oraci em 07/01/2007 OS75094 */
dt_prev_execucao_w			timestamp;
nr_horas_validade_w			integer;/* Oraci em 21/01/2008 */
ie_regra_disp_w				varchar(1);/* Rafael em 15/3/8 OS86206 */
qt_hora_intervalo_w			smallint;
qt_min_intervalo_w			integer;
ie_checar_adep_w			varchar(1);
ie_prescr_mat_sem_lib_w		varchar(30);
nm_usuario_ww				varchar(15);
ie_loop_w					varchar(10);
qt_itens_w					bigint;
ie_urgencia_w				varchar(1);
ie_hemocomp_w				varchar(1);
ie_permite_alterar_w		varchar(1);
cd_medico_ww				varchar(10);
ie_check_tipo_interv_w		varchar(1);
qt_peso_w					prescr_medica.qt_peso%type;

C01 CURSOR FOR
SELECT	a.nr_sequencia,
		a.cd_material,
		coalesce(obter_info_w_item_prescr(p.nr_prescricao, a.nr_sequencia, 'P', 'U'), a.cd_unidade_medida), --a.cd_unidade_medida,
		coalesce(to_number(obter_info_w_item_prescr(p.nr_prescricao, a.nr_sequencia, 'P', 'D')), a.qt_dose), --nvl(obter_dose_w_item_prescr(a.nr_sequencia, p.nr_prescricao, 'P'),a.qt_dose) qt_dose,
		p.NM_USUARIO,
		coalesce(a.cd_intervalo,p.cd_intervalo),
		a.DS_OBSERVACAO,
		a.ds_horarios,
		a.ie_via_aplicacao,
		coalesce(a.cd_motivo_baixa,0),
		CASE WHEN coalesce(a.cd_motivo_baixa::text, '') = '' THEN null  ELSE clock_timestamp() END ,
		CASE WHEN coalesce(a.cd_motivo_baixa::text, '') = '' THEN 'S'  ELSE 'N' END ,
		a.qt_idade_min,
		a.qt_idade_max,
		coalesce(a.ie_intervalo_fixo,'N'),
		p.dt_prev_execucao,
		p.qt_hora_intervalo,
		p.qt_min_intervalo,
		coalesce(a.ie_checar_adep,'N'),
		coalesce(p.ie_se_necessario,'N'),
		p.ie_acm
FROM	Procedimento_mat_prescr a,
		procedimento c,
		prescr_procedimento p,
		prescr_medica x
where	1 = 1
and		coalesce(c.ie_gera_associado,'S') = 'S'
and		a.ie_origem_proced	= c.ie_origem_proced
and		a.cd_procedimento	= c.cd_procedimento
and		not exists (	select	1
					from	w_item_prescr z
					where	coalesce(z.ie_excluido,'N') = 'S'
					and		z.nr_seq_item = a.nr_sequencia
					and		z.nr_prescricao = p.nr_prescricao)
and		not exists (	select	1
					from	prescr_material b,
							prescr_medica k
					where	1 = 1
					and		a.cd_material		= b.cd_material
					and		b.nr_sequencia_proc	= nr_sequencia_p
					and		k.nr_prescricao	= b.nr_prescricao
					and		k.nr_prescricao	= nr_prescricao_p)
and		((x.cd_setor_atendimento = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
and		(((coalesce(qt_idade_pac_ww::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
		 ((qt_idade_pac_ww IS NOT NULL AND qt_idade_pac_ww::text <> '') and (qt_idade_pac_ww between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w))))
and		a.ie_origem_proced	= p.ie_origem_proced
and		a.cd_procedimento	= p.cd_procedimento
and		p.nr_sequencia		= nr_sequencia_p
and		x.nr_prescricao		= p.nr_prescricao
and		x.nr_prescricao		= nr_prescricao_p
and		ie_gera_associado_w	= 'S';


C02 CURSOR FOR
SELECT	a.nr_sequencia,
		a.cd_material,
		coalesce(obter_info_w_item_prescr(p.nr_prescricao, a.nr_sequencia, 'PI', 'U'), a.cd_unidade_medida), --a.cd_unidade_medida,
		coalesce(to_number(obter_info_w_item_prescr(p.nr_prescricao, a.nr_sequencia, 'PI', 'D')), a.qt_dose), --nvl(Obter_dose_W_item_prescr(a.nr_sequencia, p.nr_prescricao, 'PI'),a.qt_dose) qt_dose,
		p.NM_USUARIO,
		coalesce(a.cd_intervalo,p.cd_intervalo),
		a.DS_OBSERVACAO,
		a.ds_horarios,
		a.ie_via_aplicacao,
		coalesce(a.cd_motivo_baixa,0),
		CASE WHEN coalesce(a.cd_motivo_baixa::text, '') = '' THEN null  ELSE clock_timestamp() END ,
		CASE WHEN coalesce(a.cd_motivo_baixa::text, '') = '' THEN 'S'  ELSE 'N' END ,
		a.qt_idade_min,
		a.qt_idade_max,
		coalesce(a.ie_intervalo_fixo,'N'),
		p.dt_prev_execucao,
		p.qt_hora_intervalo,
		p.qt_min_intervalo,
		coalesce(a.ie_checar_adep,'N'),
		coalesce(a.ie_duplicar,'S'),
		coalesce(p.ie_se_necessario,'N'),
		p.ie_acm,
		coalesce(ie_permite_alterar,'S')
FROM	Proc_int_mat_prescr a,
		prescr_procedimento p,
		prescr_medica x
where	1 = 1
and		coalesce(a.ie_situacao,'A')	= 'A'
and		((coalesce(a.cd_convenio_exc::text, '') = '') or (a.cd_convenio_exc <> obter_convenio_atendimento(x.nr_atendimento)))
and		((coalesce(a.cd_medico::text, '') = '') or (a.cd_medico = cd_medico_ww))
and		((coalesce(a.ie_sexo::text, '') = '') or (a.ie_sexo = ie_sexo_w))
and		Obter_se_mat_setor(a.nr_sequencia, x.cd_setor_atendimento, obter_convenio_atendimento(x.nr_atendimento), obter_tipo_atendimento(x.nr_atendimento)) = 'S'
and		((coalesce(a.ie_tipo_atendimento::text, '') = '') or (a.ie_tipo_atendimento = ie_tipo_atendimento_w))
and		((coalesce(a.cd_convenio::text, '') = '') or (a.cd_convenio = obter_convenio_atendimento(x.nr_atendimento)))
and		not exists (	select	1
					from	w_item_prescr z
					where	z.nr_seq_item = a.nr_sequencia
					and		coalesce(z.ie_excluido,'N') = 'S'
					and		z.nr_prescricao = p.nr_prescricao)
and 	not exists (	select	1
					from	prescr_material b,
							prescr_medica k
					where	1 = 1
					and		a.cd_material		= b.cd_material
					and		b.nr_sequencia_proc	= nr_sequencia_p
					and		k.nr_prescricao	= b.nr_prescricao
					and		k.nr_prescricao	= nr_prescricao_p)
and		((x.cd_setor_atendimento = a.cd_setor_atendimento) or (coalesce(a.cd_setor_atendimento::text, '') = ''))
and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
and		coalesce(qt_idade_pac_w,1) between coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MIN'),0) and coalesce(obter_idade_mat_int_prescr(a.nr_sequencia,'MAX'),9999999)
and		coalesce(qt_peso_w,0) between coalesce(a.qt_peso_min,0) and coalesce(a.qt_peso_max,999)
and		a.nr_seq_proc_interno	= p.nr_seq_proc_interno
/*and	(((qt_idade_pac_w is null) or
	  (a.qt_idade_min is null and a.qt_idade_max is null)) or
	 ((qt_idade_pac_w is not null) and
	  (qt_idade_pac_w between nvl(a.qt_idade_min,qt_idade_pac_w) and nvl(a.qt_idade_max,qt_idade_pac_w))))*/
and		p.nr_sequencia		= nr_sequencia_p
and		x.nr_prescricao		= p.nr_prescricao
and		x.nr_prescricao		= nr_prescricao_p
and		ie_gera_associado_w	= 'S'
order by	coalesce(a.cd_setor_atendimento,999);



BEGIN

if	((coalesce(nr_sequencia_p,0) > 0) and (coalesce(nr_prescricao_p,0) > 0)) then

	select	MAX(nm_usuario),
			coalesce(MAX(ie_urgencia),'N')
	into STRICT	nm_usuario_ww,
			ie_urgencia_w
	from	prescr_procedimento
	where	nr_sequencia = nr_sequencia_p
	and		nr_prescricao = nr_prescricao_p;

	select	MAX(cd_estabelecimento),
			MAX(dt_primeiro_horario),
			MAX(dt_prescricao),
			MAX(cd_pessoa_fisica),
			MAX(cd_setor_atendimento),
			MAX(obter_tipo_atendimento(nr_atendimento)),
			MAX(cd_medico),
			MAX(coalesce(qt_peso,obter_sinal_vital(nr_atendimento,'PESO')))
	into STRICT	cd_estabelecimento_w,
			dt_primeiro_horario_w,
			dt_prescricao_w,
			cd_pessoa_fisica_w,
			cd_setor_atendimento_w,
			ie_tipo_atendimento_w,
			cd_medico_ww,
			qt_peso_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(ie_gera_associado),'S')
	into STRICT	ie_gera_associado_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;

	ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, obter_perfil_ativo, nm_usuario_ww, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
	VarChecarSN_w := Obter_Param_Usuario(924, 650, obter_perfil_ativo, nm_usuario_ww, cd_estabelecimento_w, VarChecarSN_w);
	ie_check_tipo_interv_w := Obter_Param_Usuario(924, 809, obter_perfil_ativo, nm_usuario_ww, cd_estabelecimento_w, ie_check_tipo_interv_w);

	select coalesce(max(nr_agrupamento),0)
	into STRICT	nr_agrup_acum_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	select	MAX(obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A'))
	into STRICT	qt_idade_pac_ww
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	begin
	select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')),
			max(ie_sexo)
	into STRICT	qt_idade_pac_w,
			ie_sexo_w
	from	pessoa_fisica b
	where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
	exception
	when others then
		qt_idade_pac_w	:= 0;
	end;

	open C02;
	loop
	fetch C02 into
		nr_sequencia_w,
		cd_material_w,
		cd_unidade_medida_w,
		qt_dose_w,
		nm_usuario_w,
		cd_intervalo_w,
		ds_observacao_w,
		ds_horarios_w,
		ie_via_aplicacao_w,
		cd_motivo_baixa_w,
		dt_baixa_w,
		ie_cobra_paciente_w,
		qt_idade_min_w,
		qt_idade_max_w,
		ie_intervalo_fixo_w,
		dt_prev_execucao_w,
		qt_hora_intervalo_w,
		qt_min_intervalo_w,
		ie_checar_adep_w,
		ie_duplicar_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_permite_alterar_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		if (ie_duplicar_w = 'N') then
			select	count(*)
			into STRICT	cont_w
			from	prescr_material
			where	cd_material	= cd_material_w
			and		nr_prescricao	= nr_prescricao_p;

			if (cont_w = 0) then
				ie_duplicar_w	:= 'S';
			end if;
		end if;

		if (ie_duplicar_w = 'S') then

			select	coalesce(max(qt_conversao),1)
			into STRICT	qt_conversao_w
			from	material_conversao_unidade
			where	cd_material		= cd_material_w
			and	cd_unidade_medida	= cd_unidade_medida_w;

			/* Oraci em 21/01/2008 */

			/*select	MAX(nr_horas_validade)
			into	nr_horas_validade_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_p;

			select	MAX(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O'))
			into	nr_ocorrencia_w
			from	dual;*/
			nr_ocorrencia_w	:= 0;

			if (ie_intervalo_fixo_w = 'N') then
				SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), to_date(to_char(dt_prev_execucao_w,'hh24:mi'),'hh24:mi'), 24, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww;

				ds_horarios_ww	:= ds_horarios_ww || ds_horarios2_ww;
			else
				SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), coalesce(dt_primeiro_horario_w,dt_prescricao_w), 24, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww;

				ds_horarios_ww	:= ds_horarios_ww || ds_horarios2_ww;
			end if;

			if (coalesce(ie_check_tipo_interv_w,'N') = 'S') and (coalesce(ie_urgencia_w,'N') = 'N') and (coalesce(ie_se_necessario_w,'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N') then

				select	coalesce(coalesce(max(ie_agora),ie_urgencia_w),'N'),
						coalesce(coalesce(max(ie_se_necessario), ie_se_necessario_w),'N'),
						coalesce(coalesce(max(ie_acm), ie_acm_w),'N')
				into STRICT	ie_urgencia_w,
						ie_se_necessario_w,
						ie_acm_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_w;

				if (VarChecarSN_w = 'N' AND ie_se_necessario_w = 'S')then
					ie_se_necessario_w := 'N';
				end if;
			elsif (ie_se_necessario_w = 'N') and (VarChecarSN_w = 'S') then

				Select	coalesce(max(ie_se_necessario),'N')
				into STRICT	ie_se_necessario_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_w;
			end if;

			if (ie_se_necessario_w = 'S') then
				ds_horarios_ww	:= 'SN';
			end if;

			select	coalesce(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30),cd_unidade_medida_w)
			into STRICT	cd_unidade_medida_consumo_w
			from	material
			where	cd_material	= cd_material_w;

			ie_loop_w	:= 'S';
			while(ie_loop_w = 'S') loop
				select	count(*)
				into STRICT	qt_itens_w
				from	prescr_material
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_p;

				if (qt_itens_w	= 0) then
					ie_loop_w	:= 'N';
				else
					nr_sequencia_w	:= nr_sequencia_w + 1;
				end if;
			end loop;

			select	coalesce(max('S'),'N')
			into STRICT	ie_hemocomp_w
			from	prescr_procedimento
			where	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
			and		nr_sequencia = nr_sequencia_p
			and		nr_prescricao = nr_prescricao_p;

			Insert	into Prescr_material(
				nr_prescricao,
				nr_sequencia,
				ie_origem_inf,
				cd_material,
				cd_unidade_medida_dose,
				cd_unidade_medida,
				qt_dose,
				qt_unitaria,
				qt_material,
				dt_atualizacao,
				nm_usuario,
				cd_intervalo,
				ds_observacao,
				nr_sequencia_proc,
				ie_agrupador,
				ie_medicacao_paciente,
				ie_se_necessario,
				ie_urgencia,
				ie_suspenso,
				ie_utiliza_kit,
				ie_status_cirurgia,
				ie_bomba_infusao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				ie_acm,
				cd_motivo_baixa,
				dt_baixa,
				qt_conversao_dose,
				ds_horarios,
				nr_ocorrencia,
				ie_via_aplicacao,
				ie_recons_diluente_fixo,
				ie_sem_aprazamento,
				ie_cobra_paciente,
				ie_intervalo_dif,
				hr_prim_horario,
				ie_checar_adep,
				ie_permite_alterar)
			values (
				nr_prescricao_p,
				nr_sequencia_w,
				'A',
				cd_material_w,
				cd_unidade_medida_w,
				cd_unidade_medida_consumo_w,
				qt_dose_w,
				dividir(qt_dose_w,qt_conversao_w),
				qt_dose_w,
				clock_timestamp(),
				nm_usuario_w,
				cd_intervalo_w,
				ds_observacao_w,
				NR_SEQUENCIA_P,
				CASE WHEN ie_hemocomp_w='N' THEN 5  ELSE 2 END ,
				'N',
				ie_se_necessario_w,
				ie_urgencia_w,
				'N',
				'N',
				'GI',
				'N',
				'N',
				'N',
				coalesce(ie_acm_w,'N'),
				cd_motivo_baixa_w,
				dt_baixa_w,
				qt_conversao_w,
				coalesce(ds_horarios_w,ds_horarios_ww),
				nr_ocorrencia_w,
				ie_via_aplicacao_w,
				'N',
				'N',
				ie_cobra_paciente_w,
				ie_intervalo_fixo_w,
				CASE WHEN ie_intervalo_fixo_w='N' THEN to_char(dt_prev_execucao_w,'hh24:mi')  ELSE to_char(coalesce(dt_primeiro_horario_w,dt_prescricao_w),'hh24:mi') END  ,
				ie_checar_adep_w,
				ie_permite_alterar_w);

			if (ie_prescr_mat_sem_lib_w = 'S') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,obter_perfil_ativo,'N',nm_usuario_ww,null);
			end if;

			SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, NR_PRESCRICAO_P, nr_sequencia_w, cd_intervalo_w, null, dividir(qt_dose_w,qt_conversao_w), null, nr_ocorrencia_w, null, '1', cd_unidade_medida_w, 1, qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w;

			update	prescr_material
			set	qt_material		= qt_dose_w,
				qt_total_dispensar	= qt_total_disp_w,
				ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
			where	nr_sequencia		= nr_sequencia_w
			and		nr_prescricao		= nr_prescricao_p;

			CALL Gerar_Reconst_Diluicao(nr_prescricao_p, nr_sequencia_w,'A');

			--OS 874591
			CALL Ajustar_prescr_mat_proc(nr_prescricao_p, nr_sequencia_p, obter_perfil_ativo, null);
		end if;
	end loop;
	close C02;

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		cd_material_w,
		cd_unidade_medida_w,
		qt_dose_w,
		nm_usuario_w,
		cd_intervalo_w,
		ds_observacao_w,
		ds_horarios_w,
		ie_via_aplicacao_w,
		cd_motivo_baixa_w,
		dt_baixa_w,
		ie_cobra_paciente_w,
		qt_idade_min_w,
		qt_idade_max_w,
		ie_intervalo_fixo_w,
		dt_prev_execucao_w,
		qt_hora_intervalo_w,
		qt_min_intervalo_w,
		ie_checar_adep_w,
		ie_se_necessario_w,
		ie_acm_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_material_w
		and	cd_unidade_medida	= cd_unidade_medida_w;

		/* Oraci em 21/01/2008 */

		/*select	MAX(nr_horas_validade)
		into	nr_horas_validade_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		select	MAX(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O'))
		into	nr_ocorrencia_w
		from	dual;*/
		nr_ocorrencia_w	:= 0;

		if (ie_intervalo_fixo_w = 'N') then
			SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), to_date(to_char(dt_prev_execucao_w,'hh24:mi'),'hh24:mi'), 24, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww;

			ds_horarios_ww	:= ds_horarios_ww || ds_horarios2_ww;
		else
			SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w), coalesce(dt_primeiro_horario_w,dt_prescricao_w), 24, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww;

			ds_horarios_ww	:= ds_horarios_ww || ds_horarios2_ww;
		end if;

		if (ie_se_necessario_w = 'S') then
			ds_horarios_ww	:= 'SN';
		end if;

		select	coalesce(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30),cd_unidade_medida_w)
		into STRICT	cd_unidade_medida_consumo_w
		from	material
		where	cd_material	= cd_material_w;

		ie_loop_w	:= 'S';
		while(ie_loop_w = 'S') loop
			select	count(*)
			into STRICT	qt_itens_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			if (qt_itens_w	= 0) then
				ie_loop_w	:= 'N';
			else
				nr_sequencia_w	:= nr_sequencia_w + 1;
			end if;
		end loop;

		select	coalesce(max('S'),'N')
		into STRICT	ie_hemocomp_w
		from	prescr_procedimento
		where	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
		and		nr_prescricao = nr_prescricao_p
		and		nr_sequencia = nr_sequencia_p;

		Insert	into prescr_material(
			nr_prescricao,
			nr_sequencia,
			ie_origem_inf,
			cd_material,
			cd_unidade_medida_dose,
			cd_unidade_medida,
			qt_dose,
			qt_unitaria,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			ds_observacao,
			nr_sequencia_proc,
			ie_agrupador,
			ie_medicacao_paciente,
			ie_se_necessario,
			ie_urgencia,
			ie_suspenso,
			ie_utiliza_kit,
			ie_status_cirurgia,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			cd_motivo_baixa,
			dt_baixa,
			qt_conversao_dose,
			ds_horarios,
			nr_ocorrencia,
			ie_via_aplicacao,
			ie_recons_diluente_fixo,
			ie_sem_aprazamento,
			ie_cobra_paciente,
			ie_intervalo_dif,
			hr_prim_horario,
			ie_checar_adep)
		values (
			NR_PRESCRICAO_P,
			nr_sequencia_w,
			'A',
			cd_material_w,
			cd_unidade_medida_w,
			cd_unidade_medida_consumo_w,
			qt_dose_w,
			dividir(qt_dose_w,qt_conversao_w),
			qt_dose_w,
			clock_timestamp(),
			nm_usuario_w,
			cd_intervalo_w,
			ds_observacao_w,
			NR_SEQUENCIA_P,
			CASE WHEN ie_hemocomp_w='N' THEN 5  ELSE 2 END ,
			'N',
			ie_se_necessario_w,
			ie_urgencia_w,
			'N',
			'N',
			'GI',
			'N',
			'N',
			'N',
			coalesce(ie_acm_w,'N'),
			cd_motivo_baixa_w,
			dt_baixa_w,
			qt_conversao_w,
			coalesce(ds_horarios_w,ds_horarios_ww),
			nr_ocorrencia_w,
			ie_via_aplicacao_w,
			'N',
			'N',
			ie_cobra_paciente_w,
			ie_intervalo_fixo_w,
			CASE WHEN ie_intervalo_fixo_w='N' THEN to_char(dt_prev_execucao_w,'hh24:mi')  ELSE to_char(coalesce(dt_primeiro_horario_w,dt_prescricao_w),'hh24:mi') END  ,
			ie_checar_adep_w);

		if (ie_prescr_mat_sem_lib_w = 'S') then
			CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,obter_perfil_ativo,'N',nm_usuario_ww,null);
		end if;

		SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, NR_PRESCRICAO_P, nr_sequencia_w, cd_intervalo_w, null, dividir(qt_dose_w,qt_conversao_w), null, nr_ocorrencia_w, null, '1', cd_unidade_medida_w, 1, qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w;

		update	prescr_material
		set	qt_material		= qt_dose_w,
			qt_total_dispensar	= qt_total_disp_w,
			--ie_regra_disp		= ie_regra_disp_w
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
		where	nr_sequencia		= nr_sequencia_w
		and		nr_prescricao		= NR_PRESCRICAO_P;

		CALL Gerar_Reconst_Diluicao(nr_prescricao_p, nr_sequencia_w,'A');

	end loop;
	close C01;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_med_mat_assoc ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

