-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desvinc_nf_cancel_conta_prot ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


						
nr_interno_conta_w		nota_fiscal.nr_interno_conta%type;
nr_seq_protocolo_w		nota_fiscal.nr_seq_protocolo%type;
nr_seq_lote_prot_w		nota_fiscal.nr_seq_lote_prot%type;
						

BEGIN

select	coalesce(nr_interno_conta,0),
	coalesce(nr_seq_protocolo,0),
	coalesce(nr_seq_lote_prot,0)
into STRICT	nr_interno_conta_w,
	nr_seq_protocolo_w,
	nr_seq_lote_prot_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

if (nr_interno_conta_w > 0) then

	
	update	nota_fiscal
	set	nr_interno_conta	 = NULL,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_interno_conta 	= nr_interno_conta_w;
	
	delete  FROM conta_paciente_nf
	where   nr_interno_conta = nr_interno_conta_w
	and     nr_sequencia = nr_sequencia_p;
	
		
	CALL gerar_historico_nota_fiscal(nr_sequencia_p, nm_usuario_p, '57', wheb_mensagem_pck.get_Texto(311557, 'NR_INTERNO_CONTA_W='|| NR_INTERNO_CONTA_W));
									/*Desvinculado a nota da conta= #@NR_INTERNO_CONTA_W#@*/

end if;

if (nr_seq_protocolo_w > 0) then

	update	nota_fiscal
	set	nr_seq_protocolo 	 = NULL,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_seq_protocolo 	= nr_seq_protocolo_w;
		
	CALL gerar_historico_nota_fiscal(nr_sequencia_p, nm_usuario_p, '32', wheb_mensagem_pck.get_Texto(311558, 'NR_SEQ_PROTOCOLO_W='|| NR_SEQ_PROTOCOLO_W));
									/*Desvinculado a nota do protocolo= #@NR_SEQ_PROTOCOLO_W#@*/

end if;

if (nr_seq_lote_prot_w > 0) then

	update	nota_fiscal
	set	nr_seq_lote_prot 	 = NULL,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_seq_lote_prot	= nr_seq_lote_prot_w;	
		
	CALL gerar_historico_nota_fiscal(nr_sequencia_p, nm_usuario_p, '56', wheb_mensagem_pck.get_Texto(311559, 'NR_SEQ_LOTE_PROT_W='|| NR_SEQ_LOTE_PROT_W));
									/*Desvinculado a nota do lote protocolo= #@NR_SEQ_LOTE_PROT_W#@*/

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desvinc_nf_cancel_conta_prot ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

