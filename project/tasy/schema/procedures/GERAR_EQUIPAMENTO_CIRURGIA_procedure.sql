-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equipamento_cirurgia ( nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_procedimento_princ_w	bigint;
ie_origem_proced_w		bigint;
cd_equipamento_w		bigint;
nr_prescricao_w		bigint;
nr_sequencia_w		bigint;
qt_existe_w		integer;

C01 CURSOR FOR
	SELECT	cd_equipamento
	from	procedimento_equip
	where	cd_procedimento = cd_procedimento_princ_w
	and	ie_origem_proced = ie_origem_proced_w
	
union all

	SELECT	b.cd_equipamento
	from	procedimento_equip b,
		prescr_procedimento a
	where	a.cd_procedimento  = b.cd_procedimento
	and	a.ie_origem_proced = b.ie_origem_proced
	and	coalesce(a.ie_origem_inf,'3')    <> 'l'
	and	a.nr_prescricao	= nr_prescricao_w;


BEGIN
select	cd_procedimento_princ,
	ie_origem_proced,
	nr_prescricao
into STRICT	cd_procedimento_princ_w,
	ie_origem_proced_w,
	nr_prescricao_w
from	cirurgia
where	nr_cirurgia = nr_cirurgia_p;

select	count(*)
into STRICT	qt_existe_w
from	prescr_equipamento
where	nr_prescricao	= nr_prescricao_w;
if (qt_existe_w = 0) then
	begin
	open C01;
	loop
	FETCH C01 into
		cd_equipamento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		select	coalesce(max(nr_sequencia), 0) + 1
		into STRICT	nr_sequencia_w
		from	prescr_equipamento
		where	nr_prescricao = nr_prescricao_w;

		insert into prescr_equipamento(
			nr_prescricao,
			nr_sequencia,
			cd_equipamento,
			dt_atualizacao,
			nm_usuario)
		values (nr_prescricao_w,
			nr_sequencia_w,
			cd_equipamento_w,
			clock_timestamp(),
			nm_usuario_p);
		end;
	end loop;
	close C01;
	commit;
	end;
else
	begin
	/*Já existem equipamentos lançados para esta cirurgia.' || chr(13) || chr(10) ||
					' Para gerar novamente, os mesmos deve ser excluídos ');*/
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261619);
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equipamento_cirurgia ( nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

