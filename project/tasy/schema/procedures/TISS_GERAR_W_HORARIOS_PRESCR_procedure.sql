-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_w_horarios_prescr (nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_horarios_w		varchar(2000);
ds_todos_horarios_w	varchar(4000);
ds_horario_w		varchar(255);
count_w			bigint;
qt_tamanho_w		integer;
qt_intervalos_w		integer;
qt_espaco_w		integer;
i			integer;

c01 CURSOR FOR
SELECT	distinct ds_horarios
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p;


BEGIN

ds_todos_horarios_w	:= '';

select	count(*)
into STRICT	count_w
from	prescr_procedimento
where	nr_prescricao		= nr_prescricao_p
and	coalesce(ds_horarios,'X') <> 'X';

if (count_w > 0) then

	open C01;
	loop
	fetch C01 into
		ds_horarios_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_todos_horarios_w	:= ds_todos_horarios_w || ds_horarios_w;
		end;
	end loop;
	close C01;

	select	obter_quantidade_intervalos(ds_todos_horarios_w)
	into STRICT	qt_intervalos_w
	;

	qt_tamanho_w	:= length(ds_todos_horarios_w);
	ds_horario_w	:= null;
	i		:= 0;

	delete 	from w_tiss_horarios_prescr
	where 	nm_usuario = nm_usuario_p;

	while i <= qt_tamanho_w loop
		begin

		qt_espaco_w	:= position(' ' in ds_todos_horarios_w);
		ds_horario_w	:= trim(both substr(ds_todos_horarios_w,1,qt_espaco_w));

		if (coalesce(trim(both ds_horario_w)::text, '') = '') and ((trim(both ds_todos_horarios_w) IS NOT NULL AND (trim(both ds_todos_horarios_w))::text <> '')) then
			ds_horario_w	:= ds_todos_horarios_w;
		end if;

		ds_horario_w	:= substr(ds_horario_w,1,2);

		select	count(*)
		into STRICT	count_w
		from	w_tiss_horarios_prescr
		where	ds_horario	= ds_horario_w
		and	nm_usuario	= nm_usuario_p;

		if (count_w = 0) then

			insert into w_tiss_horarios_prescr(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				ds_horario)
			values (nextval('w_tiss_horarios_prescr_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				ds_horario_w);

		end if;

		ds_todos_horarios_w	:= trim(both substr(ds_todos_horarios_w,qt_espaco_w,qt_tamanho_w));
		i	:= i + 3;
		end;
	end loop;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_w_horarios_prescr (nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

