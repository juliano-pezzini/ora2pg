-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_titulo_receber_classi_mens ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type, vl_total_p titulo_receber.vl_titulo%type, ie_commit_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_classif_w	titulo_receber_classif.nr_sequencia%type;
cd_conta_financ_w	bigint;	
cd_conta_contabil_w	varchar(20);
vl_classif_total_w	double precision;
	
C01 CURSOR(	nr_seq_mensalidade_pc	pls_mensalidade.nr_sequencia%type) FOR
	SELECT	a.cd_conta_deb,
		sum(a.vl_item) vl_item,
		c.nr_seq_contrato,
		a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		a.cd_conta_financ
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b,
		pls_mensalidade			c
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_mensalidade		= c.nr_sequencia
	and	c.nr_sequencia			= nr_seq_mensalidade_pc
	and	a.ie_tipo_item not in ('6','7')
	group by	
		a.cd_conta_deb,
		c.nr_seq_contrato,
		a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		a.cd_conta_financ
	
union all

	SELECT	e.cd_conta_deb,
		sum(d.vl_item) vl_item,
		c.nr_seq_contrato,
		a.ie_tipo_item,
		a.nr_seq_tipo_lanc,
		a.cd_conta_financ
	from 	pls_mensalidade_seg_item   a,
		pls_mensalidade_segurado   b,
		pls_mensalidade            c,
		pls_mensalidade_item_conta d,
		pls_conta_pos_estabelecido e
	where 	a.nr_sequencia = d.nr_seq_item
	and 	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and 	e.nr_sequencia = d.nr_seq_conta_pos_estab
	and 	b.nr_seq_mensalidade = c.nr_sequencia
	and 	c.nr_sequencia = nr_seq_mensalidade_pc
	and 	a.ie_tipo_item in ('6', '7')
	group by
	       e.cd_conta_deb,
	       c.nr_seq_contrato,
	       a.ie_tipo_item,
	       a.nr_seq_tipo_lanc,
	       a.cd_conta_financ;

BEGIN

vl_classif_total_w	:= 0;

for r_c01_w in c01(nr_seq_mensalidade_p) loop
	begin
	if (coalesce(r_c01_w.cd_conta_financ::text, '') = '') then
		cd_conta_financ_w := pls_obter_conta_financ_regra(	'M', nr_seq_mensalidade_p, cd_estabelecimento_p, r_c01_w.ie_tipo_item, r_c01_w.nr_seq_tipo_lanc, null, null, null, null, null, null, null, null, null, null, null, null, cd_conta_financ_w);
	else
		cd_conta_financ_w	:= r_c01_w.cd_conta_financ;
	end if;

	if (r_c01_w.ie_tipo_item = '3') then
		select	max(c.cd_conta_deb)
		into STRICT	cd_conta_contabil_w
		from	pls_mensalidade_segurado a,
			pls_mensalidade_seg_item b,
			pls_conta_coparticipacao c
		where	a.nr_sequencia	= b.nr_seq_mensalidade_seg
		and	b.nr_seq_conta	= c.nr_seq_conta
		and	a.nr_seq_mensalidade = nr_seq_mensalidade_p
		and	b.ie_tipo_item	= r_c01_w.ie_tipo_item;
	else
		cd_conta_contabil_w	:= r_c01_w.cd_conta_deb;
	end if;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_classif_w
	from	titulo_receber_classif a
	where	a.nr_titulo = nr_titulo_p
	and	coalesce(a.cd_conta_financ,0)	= coalesce(cd_conta_financ_w,0)
	and	coalesce(a.cd_conta_contabil,0)	= coalesce(r_c01_w.cd_conta_deb,0);
	
	if (coalesce(nr_seq_classif_w::text, '') = '') then
		select	coalesce(max(a.nr_sequencia),0) + 1
		into STRICT	nr_seq_classif_w
		from	titulo_receber_classif a
		where	a.nr_titulo	= nr_titulo_p;

		insert into titulo_receber_classif(nr_titulo,
			nr_sequencia,
			vl_classificacao,
			dt_atualizacao,
			nm_usuario,
			cd_conta_financ,
			vl_desconto,
			vl_original,
			nr_seq_contrato,
			cd_conta_contabil)
		values (nr_titulo_p,
			nr_seq_classif_w,
			r_c01_w.vl_item,
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_financ_w,
			0,
			r_c01_w.vl_item,
			r_c01_w.nr_seq_contrato,
			cd_conta_contabil_w);
	else
		update	titulo_receber_classif
		set	vl_classificacao	= vl_classificacao + r_c01_w.vl_item,
			vl_original		= vl_original + r_c01_w.vl_item
		where	nr_titulo		= nr_titulo_p
		and	nr_sequencia		= nr_seq_classif_w;
	end if;

	vl_classif_total_w		:= r_c01_w.vl_item + vl_classif_total_w;	
	end;
end loop;

if (vl_total_p <> vl_classif_total_w) then
	update	titulo_receber_classif
	set	vl_classificacao	= vl_classificacao + vl_total_p - vl_classif_total_w,
		vl_original		= vl_original + vl_total_p - vl_classif_total_w
	where	nr_titulo		= nr_titulo_p
	and	nr_sequencia		= nr_seq_classif_w;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_titulo_receber_classi_mens ( nr_seq_mensalidade_p pls_mensalidade.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type, vl_total_p titulo_receber.vl_titulo%type, ie_commit_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

