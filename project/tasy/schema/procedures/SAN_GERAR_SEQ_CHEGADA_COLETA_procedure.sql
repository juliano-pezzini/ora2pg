-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_seq_chegada_coleta ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_chegada_coleta_w	bigint;


BEGIN
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	select	coalesce(max(nr_seq_chegada_coleta),0) +1
	into STRICT	nr_seq_chegada_coleta_w
	from	san_doacao
	where	dt_triagem between trunc(clock_timestamp(),'dd')+01/86000 and trunc(clock_timestamp(),'dd')+86399/86400
	and	ie_status = 1;
	/*and	exists	(
			select	count(*)
			from	san_doacao
			where	ie_status = 1
			and	nr_seq_chegada_coleta is not null
			);*/
	if (nr_seq_chegada_coleta_w > 0) then
		update	san_doacao
		set	dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			nr_seq_chegada_coleta 	= nr_seq_chegada_coleta_w
		where	nr_sequencia 		= nr_sequencia_p;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_seq_chegada_coleta ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

