-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_obter_venc_fatura ( nr_seq_ptu_fatura_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_vencimento_p INOUT timestamp, qt_dias_a500_p INOUT bigint) AS $body$
DECLARE


nr_seq_camara_w			bigint;
nr_seq_congenere_w		bigint;
qt_dias_venc_w			bigint;
dt_vencimento_w			timestamp;
dt_procedimento_w		timestamp;

C01 CURSOR FOR
	SELECT	a.qt_dias_venc,
		a.qt_dias_antes_a500
	from	ptu_regra_venc_fatura	a
	where	coalesce(a.nr_seq_camara, coalesce(nr_seq_camara_w,0))		= coalesce(nr_seq_camara_w,0)
	and	coalesce(a.nr_seq_congenere, coalesce(nr_seq_congenere_w,0))	= coalesce(nr_seq_congenere_w,0)
	order by
		coalesce(a.nr_seq_camara, 0),
		coalesce(a.nr_seq_congenere, 0);


BEGIN
select	max(a.nr_seq_camara),
	max(a.nr_seq_congenere)
into STRICT	nr_seq_camara_w,
	nr_seq_congenere_w
from	ptu_fatura		b,
	ptu_lote_fatura_envio	a
where	a.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= nr_seq_ptu_fatura_p;

select	coalesce(max(c.dt_procedimento), clock_timestamp())
into STRICT	dt_procedimento_w
from	ptu_nota_servico	c,
	ptu_nota_cobranca	b,
	ptu_fatura		a
where	c.nr_seq_nota_cobr	= b.nr_sequencia
and	b.nr_seq_fatura		= a.nr_sequencia
and	a.nr_sequencia		= nr_seq_ptu_fatura_p;

open C01;
loop
fetch C01 into
	qt_dias_venc_w,
	qt_dias_a500_p;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	null;
	end;
end loop;
close C01;

select	dt_procedimento_w + qt_dias_venc_w
into STRICT	dt_vencimento_w
;

select	obter_proximo_dia_util(cd_estabelecimento_p, dt_vencimento_w)
into STRICT	dt_vencimento_p
;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_obter_venc_fatura ( nr_seq_ptu_fatura_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_vencimento_p INOUT timestamp, qt_dias_a500_p INOUT bigint) FROM PUBLIC;

