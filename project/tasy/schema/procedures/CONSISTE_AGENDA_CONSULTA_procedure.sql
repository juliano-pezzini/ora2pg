-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_agenda_consulta (nr_seq_agenda_p bigint, ds_consistencia_p INOUT text) AS $body$
DECLARE


ds_consistencia_w	varchar(255)	:= '';
cd_medico_w		varchar(10);
cd_agenda_w		bigint;
dt_agenda_pac_w		timestamp;
dt_agenda_final_w	timestamp;
qt_agenda_exame_w	bigint;	
nr_seq_agenda_w		    agenda_consulta.nr_sequencia%type;
ie_consiste_agecons_w	varchar(01)	:= 'S';
cd_estabelecimento_w	bigint;
nm_usuario_w		varchar(15);


BEGIN

select	coalesce(max(a.nr_sequencia),0),
	max(b.cd_estabelecimento),
	max(a.nm_usuario)
into STRICT	nr_seq_agenda_w,
	cd_estabelecimento_w,
	nm_usuario_w
from	agenda b, agenda_consulta a
where	a.cd_agenda	= b.cd_agenda
and	a.nr_sequencia	= nr_seq_agenda_p;

select	coalesce(max(obter_valor_param_usuario(39, 97, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w)), 'S')
into STRICT	ie_consiste_agecons_w
;

if (ie_consiste_agecons_w = 'S') and (nr_seq_agenda_w > 0) then
	begin
	select	dt_agenda,
		dt_agenda + nr_minuto_duracao/1440,
		cd_agenda
	into STRICT	dt_agenda_pac_w,
		dt_agenda_final_w,
		cd_agenda_w
	from	agenda_consulta
	where	nr_sequencia	= nr_seq_agenda_p;

	select	coalesce(max(cd_pessoa_fisica),'0')
	into STRICT	cd_medico_w
	from	agenda
	where	cd_agenda	= cd_agenda_w;

	select	count(*)
	into STRICT	qt_agenda_exame_w
	from	agenda_paciente
	where 	cd_medico_exec	= cd_medico_w
	and 	ie_status_agenda	not in ('L', 'LF')
	and	hr_inicio between dt_agenda_pac_w and dt_agenda_final_w;

	if (qt_agenda_exame_w > 0) then
		ds_consistencia_w	:= Wheb_mensagem_pck.get_texto(306313, null); -- Existe uma agenda de exames marcada para este medico neste horario!
	end if;
	end;
end if;

ds_consistencia_p	:= ds_consistencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_agenda_consulta (nr_seq_agenda_p bigint, ds_consistencia_p INOUT text) FROM PUBLIC;

