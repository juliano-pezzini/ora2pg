-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_contrap_recebidas ( nr_seq_reg_auxiliar_p w_ctb_aux_contra_emit.nr_seq_reg_auxiliar%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p w_ctb_aux_contra_emit.ie_ato_cooperado%type, ie_gerar_arquivo_p w_ctb_aux_contra_emit.ie_ato_cooperado%type default 'N') AS $body$
DECLARE

					
nr_contador_w			bigint := 0;
vl_movimento_int_w		double precision := 0;
vl_parcela_w			double precision := 0;
vl_sobra_w			double precision := 0;
vl_sobra_juros_w		double precision := 0;
vl_juros_w			double precision := 0;
nr_titulo_ant_w			bigint := 0;
ds_observacao_w			varchar(255);
nr_seq_aux_cont_rec_w		pls_aux_contrap_recebidas.nr_sequencia%type;
cd_conta_contabil_w		conta_contabil.cd_conta_contabil%type;
ie_gerar_ind_classif_w		ctb_livro_auxiliar.ie_gerar_ind_classif%type;
dt_liberacao_w			ctb_livro_auxiliar.dt_liberacao%type;
dt_inicial_w			ctb_livro_auxiliar.dt_inicial%type;
dt_final_w			ctb_livro_auxiliar.dt_final%type;
ie_tipo_segurado_w		ctb_livro_auxiliar.ie_tipo_segurado%type;
ie_tipo_compartilhamento_w	pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w		pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w			pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w		pls_segurado_repasse.dt_fim_repasse%type;
nr_seq_contra_emit_w		w_ctb_aux_contra_emit.nr_sequencia%type;
vl_contraprestacao_w		double precision := 0;
vl_juros_multa_w		double precision := 0;
ie_data_tipo_segurado_w		pls_parametros.ie_data_tipo_segurado%type;

/*Variaveis de geracao do arquivo .csv*/
	
ds_erro_w					varchar(255);
ds_local_w					varchar(255);
nm_arquivo_w					varchar(255);
arq_texto_w					utl_file.file_type;
ds_nome_livro_w					varchar(255);
ds_periodo_w					varchar(255);

ds_rotulo_w 					varchar(4000) := obter_desc_expressao(962596);

type vet_pls_aux_contrap_rec is table of pls_aux_contrap_recebidas%rowtype index by integer;
pls_aux_contrap_rec_w	vet_pls_aux_contrap_rec;								

type vetor_ctb_aux_contra_emit is table of w_ctb_aux_contra_emit%rowtype index by integer;
ctb_aux_contra_emit_w	vetor_ctb_aux_contra_emit;
	
c_conta CURSOR FOR
	SELECT 	c.cd_conta_contabil
	from 	conta_contabil c
	where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
	and	c.ie_tipo = 'A';

c_registros_delphi CURSOR FOR
	SELECT	a.nr_titulo                                             				||';'||
		a.dt_emissao                                            				||';'||
		a.dt_vencimento                                         				||';'||
		a.dt_cancelamento									||';'||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,a.nr_contrato),1,255)		||';'||
		a.dt_contrato                                           				||';'||
		a.ds_tipo_documento                                     				||';'||
		a.nr_documento                                          				||';'||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,a.cd_cpf_cnpj),1,255)		||';'||
		a.nm_usuario_principal                                  				||';'||
		a.cd_beneficiario									||';'||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(a.nr_seq_segurado,
			a.dt_referencia)),1,255)							||';'||
		a.nm_usuario_evento									||';'||
		substr(obter_valor_dominio(2406,a.ie_tipo_segurado),1,255)				||';'||
		a.ds_modalidade_contrat									||';'||
		a.ds_regulamentacao									||';'||
		a.ds_tipo_contratacao									||';'||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,a.dt_contratacao),1,255)	||';'||
		a.ds_segmentacao									||';'||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			replace(a.nr_protocolo_ans,chr(039),'')),1,255)					||';'||
		a.dt_inicio_cobertura									||';'||
		a.dt_fim_cobertura									||';'||
		a.dt_rescisao                                           				||';'||
		a.vl_apropriado										||';'||
		a.vl_contrato										||';'||
		a.vl_parcela 										||';'||	
		a.vl_multa_juros 									||';'||
		a.vl_antecipado 									||';'||		
		a.nr_parcela										||';'||
		a.dt_baixa 										||';'||
		a.cd_conta_contabil 									||';'||
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, dt_final_w),1,255) 		||';'||
		a.dt_referencia 									||';'||
		substr(obter_valor_dominio(3384, a.ie_tipo_repasse), 1,255)				||';'||
		substr(obter_valor_dominio(8980, a.ie_tipo_compartilhamento), 1,255)			||';'||
		a.dt_inicio_compartilhamento								||';'||
		a.dt_fim_compartilhamento								||';'||
		a.ds_observacao										ds_linha
	from 	w_ctb_aux_contra_emit a
	where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p
	order by (nr_documento)::numeric;
	
c_titulo CURSOR FOR
	SELECT	nr_titulo,
		dt_emissao,
		dt_vencimento,
		nr_contrato,
		nr_seq_contrato,
		dt_contrato,
		ie_tipo_documento,
		nr_documento,
		cd_cpf_cnpj,	
		nm_usuario_principal,	
		cd_beneficiario,
		nm_usuario_evento,
		ie_preco,
		ie_regulamentacao,
		ie_tipo_contratacao,
		ie_segmentacao,
		nr_protocolo_ans,
		dt_inicio_cobertura,
		dt_fim_cobertura,
		dt_rescisao,
		vl_apropriado,
		nr_parcela,
		vl_multa vl_multa,
		vl_juros vl_juros,
		vl_recebido vl_recebido,
		vl_descontos vl_descontos,
		sum(vl_contrato) vl_contrato,
		sum(vl_item) vl_item,
		vl_mensalidade,
		dt_baixa,
		nr_seq_segurado,
		nr_seq_pagador,
		cd_conta_contabil,
		ie_tipo_segurado,
		dt_contratacao,
		dt_cancelamento,
		dt_ref_repasse,
		nr_seq_congenere,
		dt_recebimento
	from	(
		SELECT t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round(i.vl_item * q.vl_recebido, (	select	sum(x.vl_recebido)
										from	titulo_receber_liq	x
										where	x.nr_titulo	= t.nr_titulo
										and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
										or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			i.vl_item vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			i.cd_conta_deb cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and i.ie_tipo_item	not in ('6','3','7') and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((ie_gerar_ind_classif_w <> 'N')
		or	i.cd_conta_deb 	in (	select 	c.cd_conta_contabil
						from 	conta_contabil c
						where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
						and	c.ie_tipo = 'A')) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and not exists (	select	1
						from	pls_mensalidade_item_conta	x
						where	i.nr_sequencia	= x.nr_seq_item
						and	i.ie_tipo_item	= '13') and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			'TR',
			m.nr_sequencia,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.cd_conta_deb,
			s.ie_tipo_segurado,
			i.vl_item,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		select t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round((	select sum(j.vl_item)
							from	pls_mensalidade_item_conta	j
							where	i.nr_sequencia	= j.nr_seq_item) * q.vl_recebido, (	select	sum(x.vl_recebido)
															from	titulo_receber_liq	x
															where	x.nr_titulo	= t.nr_titulo
															and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
															or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			(select	sum(j.vl_item)
			from	pls_mensalidade_item_conta	j
			where	i.nr_sequencia	= j.nr_seq_item) vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			i.cd_conta_deb cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and i.ie_tipo_item		= '13' and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((ie_gerar_ind_classif_w <> 'N')
		or	i.cd_conta_deb 	in (	select 	c.cd_conta_contabil
						from 	conta_contabil c
						where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
						and	c.ie_tipo = 'A')) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and exists (	select	1
					from	pls_mensalidade_item_conta	j
					where	i.nr_sequencia	= j.nr_seq_item
					and	(j.nr_seq_conta_co IS NOT NULL AND j.nr_seq_conta_co::text <> '')) and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			t.nr_titulo,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.cd_conta_deb,
			s.ie_tipo_segurado,
			i.nr_sequencia,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		select 	t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round(i.vl_item * q.vl_recebido, (	select	sum(x.vl_recebido)
										from	titulo_receber_liq	x
										where	x.nr_titulo	= t.nr_titulo
										and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
										or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			i.vl_item vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			(select	max(z.cd_conta_deb)
			from	pls_conta w,
				pls_conta_coparticipacao z
			where	w.nr_sequencia = z.nr_seq_conta
			and	w.nr_sequencia = i.nr_seq_conta) cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia 		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and i.ie_tipo_item	= '3' and exists(	select	1
				from	pls_conta w,
					pls_conta_coparticipacao z
				where	w.nr_sequencia = z.nr_seq_conta
				and	w.nr_sequencia = i.nr_seq_conta
				and	((ie_gerar_ind_classif_w <> 'N')
				or	z.cd_conta_deb in (	select 	c.cd_conta_contabil
								from 	conta_contabil c
								where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
								and	c.ie_tipo = 'A'))) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and not exists (	select	1
						from	pls_mensalidade_item_conta	x
						where	i.nr_sequencia	= x.nr_seq_item) and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			'TR',
			m.nr_sequencia,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.nr_seq_conta,
			i.vl_item,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		select 	t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round((	select	sum(j.vl_item)
							from	pls_mensalidade_item_conta	j
							where	i.nr_sequencia	= j.nr_seq_item) * q.vl_recebido, (	select	sum(x.vl_recebido)
															from	titulo_receber_liq	x
															where	x.nr_titulo	= t.nr_titulo
															and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
															or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			(select	sum(j.vl_item)
			from	pls_mensalidade_item_conta	j
			where	i.nr_sequencia	= j.nr_seq_item) vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			(select	max(z.cd_conta_deb)
			from	pls_mensalidade_item_conta	j,
				pls_conta_coparticipacao 	z
			where	z.nr_sequencia	= j.nr_seq_conta_copartic
			and	i.nr_sequencia	= j.nr_seq_item) cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia 		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and i.ie_tipo_item	= '3' and exists(	select	1
				from	pls_mensalidade_item_conta		j,
					pls_conta_coparticipacao 		z
				where	z.nr_sequencia	= j.nr_seq_conta_copartic
				and	i.nr_sequencia	= j.nr_seq_item
				and	((ie_gerar_ind_classif_w <> 'N')
				or	z.cd_conta_deb in (	select 	c.cd_conta_contabil
								from 	conta_contabil c
								where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
								and	c.ie_tipo = 'A'))) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			'TR',
			m.nr_sequencia,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.nr_seq_conta,
			i.vl_item,
			i.nr_sequencia,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		select 	t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round((	select	sum(j.vl_item)
							from	pls_mensalidade_item_conta	j
							where	i.nr_sequencia	= j.nr_seq_item) * q.vl_recebido, (	select	sum(x.vl_recebido)
															from	titulo_receber_liq	x
															where	x.nr_titulo	= t.nr_titulo
															and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
															or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			(select	sum(j.vl_item)
			from	pls_mensalidade_item_conta	j
			where	i.nr_sequencia	= j.nr_seq_item) vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			(select	max(z.cd_conta_deb)
			from	pls_mensalidade_item_conta	j,
				pls_conta_pos_estabelecido 	z
			where	z.nr_sequencia	= j.nr_seq_conta_pos_estab
			and	i.nr_sequencia	= j.nr_seq_item) cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia 		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and i.ie_tipo_item	= '6' and exists(	select	1
				from	pls_mensalidade_item_conta		j,
					pls_conta_pos_estabelecido 		z
				where	z.nr_sequencia	= j.nr_seq_conta_pos_estab
				and	i.nr_sequencia	= j.nr_seq_item
				and	((ie_gerar_ind_classif_w <> 'N')
				or	z.cd_conta_deb in (	select 	c.cd_conta_contabil
								from 	conta_contabil c
								where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
								and	c.ie_tipo = 'A'))) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			'TR',
			m.nr_sequencia,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.nr_seq_conta,
			i.vl_item,
			i.nr_sequencia,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		-- novo aqui
		select 	t.nr_titulo nr_titulo,
			t.dt_emissao dt_emissao,
			t.dt_vencimento dt_vencimento,
			c.nr_contrato nr_contrato,
			c.nr_sequencia nr_seq_contrato,
			c.dt_contrato dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30) cd_beneficiario,
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255) nm_usuario_evento,
			p.ie_preco ie_preco,
			p.ie_regulamentacao ie_regulamentacao,
			p.ie_tipo_contratacao ie_tipo_contratacao,
			p.ie_segmentacao ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20) nr_protocolo_ans,
			a.dt_inicio_cobertura dt_inicio_cobertura,
			a.dt_fim_cobertura dt_fim_cobertura,
			c.dt_rescisao_contrato dt_rescisao,
			t.vl_titulo vl_apropriado,
			a.nr_parcela nr_parcela,
			sum(q.vl_multa) vl_multa,
			sum(q.vl_juros) vl_juros,
			sum(q.vl_recebido) vl_recebido,
			sum(q.vl_descontos) vl_descontos,
			sum(	dividir_sem_round(i.vl_item * q.vl_recebido, (	select	sum(x.vl_recebido)
										from	titulo_receber_liq	x
										where	x.nr_titulo	= t.nr_titulo
										and	((x.dt_recebimento >= l.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
										or (x.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w))))) vl_contrato,
			i.vl_item,
			m.vl_mensalidade,
			q.dt_recebimento dt_baixa,
			s.nr_sequencia	nr_seq_segurado,
			m.nr_seq_pagador,
			(select	max(z.cd_conta_deb)
			from	pls_conta w,
				pls_conta_pos_estabelecido z
			where	w.nr_sequencia = z.nr_seq_conta
			and	w.nr_sequencia = i.nr_seq_conta) cd_conta_contabil,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			null dt_ref_repasse,
			null nr_seq_congenere,
			(case when l.dt_mesano_referencia > q.dt_recebimento then l.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		FROM titulo_receber t, titulo_receber_liq q, pls_mensalidade m, pls_lote_mensalidade l, pls_mensalidade_seg_item i, pls_mensalidade_segurado a
LEFT OUTER JOIN pls_segurado s ON (a.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato c ON (s.nr_seq_contrato = c.nr_sequencia)
WHERE l.nr_sequencia 		= m.nr_seq_lote and t.nr_titulo 		= q.nr_titulo and m.nr_sequencia 		= a.nr_seq_mensalidade and a.nr_sequencia 		= i.nr_seq_mensalidade_seg and m.nr_sequencia 		= t.nr_seq_mensalidade    and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and ((q.dt_recebimento >= l.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < l.dt_mesano_referencia and l.dt_mesano_referencia between dt_inicial_w and dt_final_w)) and i.ie_tipo_item	= '6' and ((ie_gerar_ind_classif_w <> 'N')
		or	exists (	select	1
			from	pls_conta w,
				pls_conta_pos_estabelecido z
			where	w.nr_sequencia = z.nr_seq_conta
			and	w.nr_sequencia = i.nr_seq_conta
			and	z.cd_conta_deb in (	select 	c.cd_conta_contabil
							from 	conta_contabil c
							where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
							and	c.ie_tipo = 'A'))) and t.ie_situacao <> '3' and m.vl_mensalidade <> 0 and not exists (	select	1
					from	pls_mensalidade_item_conta		j,
						pls_conta_pos_estabelecido 		z
					where	z.nr_sequencia	= j.nr_seq_conta_pos_estab
					and	i.nr_sequencia	= j.nr_seq_item
				) and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
		or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and q.vl_recebido <> 0 group by t.nr_titulo,
			t.dt_emissao,
			t.dt_vencimento,
			c.nr_contrato,
			c.nr_sequencia,
			c.dt_contrato,
			'TR',
			m.nr_sequencia,
			coalesce(pls_obter_dados_pagador(m.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(m.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(m.nr_seq_pagador,'N'),1,255),	
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,30),
			substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
			p.ie_preco,
			p.ie_regulamentacao,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END ,1,20),
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			c.dt_rescisao_contrato,
			t.vl_titulo,
			a.nr_parcela,
			m.vl_mensalidade,
			q.dt_recebimento,
			s.nr_sequencia,
			m.nr_seq_pagador,
			i.nr_seq_conta,
			i.vl_item,
			i.nr_sequencia,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			l.dt_mesano_referencia
		
union all

		select 	t.nr_titulo nr_titulo,
			v.dt_emissao dt_emissao,
			v.dt_vencimento,
			v.nr_contrato,
			(select nr_sequencia from pls_contrato where nr_contrato = v.nr_contrato) nr_seq_contrato,
			v.dt_contrato,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			coalesce(pls_obter_dados_pagador(v.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(v.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
			substr(pls_obter_dados_pagador(v.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
			v.cd_beneficiario,
			v.nm_usuario_principal nm_usuario_evento,
			v.ie_preco,
			v.ie_regulamentacao,
			v.ie_tipo_contratacao,
			v.ie_segmentacao,
			v.nr_protocolo_ans,
			v.dt_inicio_cobertura dt_inicio_cobertura,
			v.dt_fim_cobertura dt_fim_cobertura,
			v.dt_rescisao,
			t.vl_titulo vl_apropriado,
			(v.nr_parcela)::numeric ,
			coalesce(sum(q.vl_multa),0) vl_multa,
			coalesce(sum(q.vl_juros),0) vl_juros,
			coalesce(sum(q.vl_recebido),0) vl_recebido,
			coalesce(sum(q.vl_descontos),0) vl_descontos,
			coalesce(sum(dividir_sem_round(v.vl_item * q.vl_recebido, (	select	sum(x.vl_recebido)
										from	titulo_receber_liq	x
										where	x.nr_titulo	= t.nr_titulo
										and	((x.dt_recebimento >= v.dt_mesano_referencia and x.dt_recebimento between dt_inicial_w and dt_final_w)
										or (x.dt_recebimento < v.dt_mesano_referencia and v.dt_mesano_referencia between dt_inicial_w and dt_final_w))))),0) vl_contrato,
			v.vl_item,
			v.vl_mensalidade,	
			q.dt_recebimento dt_baixa,
			v.nr_seq_segurado,
			v.nr_seq_pagador,
			v.cd_conta_debito,
			v.ie_tipo_segurado,
			v.dt_contratacao,
			v.dt_cancelamento,
			CASE WHEN ie_data_tipo_segurado_w='A' THEN  v.dt_ref_repasse  ELSE v.dt_mes_competencia END  dt_ref_repasse,
			v.nr_seq_congenere,
			(case when v.dt_mesano_referencia > q.dt_recebimento then v.dt_mesano_referencia
						else q.dt_recebimento end) dt_recebimento
		from	pls_conta_pos_estab_mens_v	v,
			titulo_receber			t,
			titulo_receber_liq		q
		where	v.nr_titulo	= t.nr_titulo
		and	t.nr_titulo	= q.nr_titulo
		and	((q.dt_recebimento >= v.dt_mesano_referencia and q.dt_recebimento between dt_inicial_w and dt_final_w)
		or (q.dt_recebimento < v.dt_mesano_referencia and v.dt_mesano_referencia between dt_inicial_w and dt_final_w))
		and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
		and	v.ie_tipo_item		in ('6','7')
		and	((ie_gerar_ind_classif_w <> 'N')
		or (substr(v.cd_classif_debito,1,5) = '1.2.3'))
		and	t.ie_situacao <> '3'
		and	v.vl_mensalidade <> 0
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(v.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		and 	q.vl_recebido <> 0
		group by v.dt_emissao,
			v.dt_vencimento,
			v.nr_contrato,
			nr_seq_contrato,
			v.dt_contrato,
			t.nr_titulo,
			coalesce(pls_obter_dados_pagador(v.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(v.nr_seq_pagador,'CGC')),	
			substr(pls_obter_dados_pagador(v.nr_seq_pagador,'N'),1,255),	
			v.cd_beneficiario,
			v.nm_usuario_principal,
			v.ie_preco,
			v.ie_regulamentacao,
			v.ie_tipo_contratacao,
			v.ie_segmentacao,
			v.nr_protocolo_ans,
			v.dt_inicio_cobertura,
			v.dt_fim_cobertura,
			v.dt_rescisao,
			t.vl_titulo,
			v.nr_parcela,
			v.vl_item,
			v.vl_mensalidade,	
			q.dt_recebimento,
			v.nr_seq_segurado,
			v.nr_seq_pagador,
			v.cd_conta_debito,
			v.ie_tipo_segurado,
			v.dt_contratacao,
			v.dt_cancelamento,
			v.dt_ref_repasse,
			v.dt_mes_competencia,
			v.nr_seq_congenere,
			v.dt_mesano_referencia)	x
	where	1 = 1
	group by nr_titulo,
		dt_emissao,
		dt_vencimento,
		nr_contrato,
		nr_seq_contrato,
		dt_contrato,
		ie_tipo_documento,
		nr_documento,
		cd_cpf_cnpj,	
		nm_usuario_principal,	
		cd_beneficiario,
		nm_usuario_evento,
		ie_preco,
		ie_regulamentacao,
		ie_tipo_contratacao,
		ie_segmentacao,
		nr_protocolo_ans,
		dt_inicio_cobertura,
		dt_fim_cobertura,
		dt_rescisao,
		vl_apropriado,
		nr_parcela,
		vl_mensalidade,
		dt_baixa,
		nr_seq_segurado,
		vl_multa,
		vl_juros,
		vl_recebido,
		vl_descontos,
		nr_seq_pagador,
		cd_conta_contabil,
		ie_tipo_segurado,
		dt_contratacao,
		dt_cancelamento,
		dt_ref_repasse,
		nr_seq_congenere,
		dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		e.cd_conta_deb_ndc cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_fatura_proc p, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = p.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = p.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = p.nr_seq_conta_pos_contab or coalesce(p.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_ndc in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(p.nr_seq_pos_taxa_contab,0) = 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		e.cd_conta_deb_ndc,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(e.vl_administracao) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(e.vl_administracao) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		e.cd_conta_deb_taxa cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_fatura_proc p, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = p.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = p.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = p.nr_seq_conta_pos_contab or coalesce(p.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_taxa in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(p.nr_seq_pos_taxa_contab,0) = 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		e.cd_conta_deb_taxa,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(coalesce(e.vl_custo_operacional,0) - coalesce(e.vl_administracao,0)) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		e.cd_conta_deb_ndc cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_fatura_mat m, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = m.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = m.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = m.nr_seq_conta_pos_contab or coalesce(m.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_ndc in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(m.nr_seq_pos_taxa_contab,0) = 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		e.cd_conta_deb_ndc,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(e.vl_administracao) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(e.vl_administracao) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		e.cd_conta_deb_taxa cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_fatura_mat m, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = m.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = m.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = m.nr_seq_conta_pos_contab or coalesce(m.nr_seq_conta_pos_contab, 0) = 0) and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	e.cd_conta_deb_taxa in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(m.nr_seq_pos_taxa_contab,0) = 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		e.cd_conta_deb_taxa,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(coalesce(z.vl_taxa,0)) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(coalesce(z.vl_taxa,0)) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		z.cd_conta_deb cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_fatura_proc p
LEFT OUTER JOIN pls_conta_pos_taxa_contab z ON (p.nr_seq_pos_taxa_contab = z.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = p.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = p.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = p.nr_seq_conta_pos_contab or coalesce(p.nr_seq_conta_pos_contab, 0) = 0)  and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	z.cd_conta_deb in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(p.nr_seq_pos_taxa_contab,0) <> 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		z.cd_conta_deb,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	
union all

	select  r.nr_titulo nr_titulo,
		r.dt_emissao dt_emissao,
		r.dt_vencimento dt_vencimento,
		t.nr_contrato nr_contrato,
		t.nr_sequencia nr_seq_contrato,
		t.dt_contrato dt_contrato,
		'TR' ie_tipo_documento,
		r.nr_titulo nr_documento,
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')) cd_cpf_cnpj,	
		substr(pls_obter_dados_pagador(f.nr_seq_pagador,'N'),1,255) nm_usuario_principal,	
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,30) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		n.ie_preco ie_preco,
		n.ie_regulamentacao ie_regulamentacao,
		n.ie_tipo_contratacao ie_tipo_contratacao,
		n.ie_segmentacao ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20) nr_protocolo_ans,
		null dt_inicio_cobertura,
		null dt_fim_cobertura,
		t.dt_rescisao_contrato dt_rescisao,
		sum(coalesce(z.vl_taxa,0)) vl_apropriado,
		null nr_parcela,
		q.vl_multa vl_multa,
		q.vl_juros vl_juros,
		q.vl_recebido vl_recebido,
		q.vl_descontos vl_descontos,
		0 vl_contrato,
		sum(coalesce(z.vl_taxa,0)) vl_item,
		r.vl_titulo vl_mensalidade,
		q.dt_recebimento dt_baixa,
		s.nr_sequencia	nr_seq_segurado,
		f.nr_seq_pagador,
		z.cd_conta_deb cd_conta_contabil,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		null dt_cancelamento,
		max(select	y.dt_procedimento
		from	pls_conta_proc y
		where	y.nr_sequencia = a.nr_seq_conta_proc
		
union

		select	y.dt_atendimento
		from	pls_conta_mat y
		where	y.nr_sequencia = a.nr_seq_conta_mat) dt_ref_repasse,
		h.nr_seq_congenere,
		q.dt_recebimento
	FROM titulo_receber r, titulo_receber_liq q, pls_protocolo_conta h, pls_fatura f, pls_conta_pos_estab_contab e, pls_fatura_evento d, pls_fatura_conta c, pls_conta_pos_estabelecido a, pls_conta b
LEFT OUTER JOIN pls_plano n ON (b.nr_seq_plano = n.nr_sequencia)
, pls_fatura_mat m
LEFT OUTER JOIN pls_conta_pos_taxa_contab z ON (m.nr_seq_pos_taxa_contab = z.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_sequencia         = m.nr_seq_conta_pos_estab and a.nr_sequencia         = e.nr_seq_conta_pos and c.nr_sequencia         = m.nr_seq_fatura_conta and d.nr_sequencia         = c.nr_seq_fatura_evento and f.nr_sequencia         = d.nr_seq_fatura and b.nr_sequencia         = a.nr_seq_conta and f.nr_titulo            = r.nr_titulo  and b.nr_seq_segurado      = s.nr_sequencia  and h.nr_sequencia         = b.nr_seq_protocolo and r.nr_titulo	       = q.nr_titulo and (e.nr_sequencia        = m.nr_seq_conta_pos_contab or coalesce(m.nr_seq_conta_pos_contab, 0) = 0)  and r.ie_situacao <> '3' and coalesce(cd_estabelecimento_p,r.cd_estabelecimento) = r.cd_estabelecimento and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or	z.cd_conta_deb in (select 	c.cd_conta_contabil
					from 	conta_contabil c
					where 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '1.2.3'
					and	c.ie_tipo = 'A')) and q.dt_recebimento between dt_inicial_w and dt_final_w and q.vl_recebido <> 0 and coalesce(m.nr_seq_pos_taxa_contab,0) <> 0 group by r.nr_titulo,
		r.dt_emissao,
		r.dt_vencimento,
		t.nr_contrato,
		t.nr_sequencia,
		t.dt_contrato,
		'TR',
		coalesce(pls_obter_dados_pagador(f.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(f.nr_seq_pagador,'CGC')),	
		f.nr_seq_pagador,
		s.nr_sequencia,
		n.ie_preco,
		n.ie_regulamentacao,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		substr(CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END ,1,20),
		t.dt_rescisao_contrato,
		r.vl_titulo,
		s.nr_sequencia,
		f.nr_seq_pagador,
		z.cd_conta_deb,
		s.ie_tipo_segurado,
		s.dt_contratacao,
		h.nr_seq_congenere,
		q.vl_multa,
		q.vl_juros,
		q.vl_recebido,
		q.vl_descontos,
		q.dt_recebimento
	order by nr_titulo;
	/*Order by importante para a logica do rateio*/

	
vet_titulo c_titulo%rowtype;
				
BEGIN

select	fim_dia(max(a.dt_final)),
	trunc(max(a.dt_inicial),'dd'),
	max(dt_liberacao),
	max(ie_tipo_segurado),
	coalesce(max(a.ie_gerar_ind_classif),'N')
into STRICT	dt_final_w,
	dt_inicial_w,
	dt_liberacao_w,
	ie_tipo_segurado_w,
	ie_gerar_ind_classif_w
from	ctb_livro_auxiliar	a
where	a.nr_sequencia	= nr_seq_reg_auxiliar_p;

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

delete
from	pls_aux_contrap_recebidas a
where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;

if (ie_origem_p = 'D' and ie_gerar_arquivo_p = 'N') then	
	delete
	from	w_ctb_aux_contra_emit a
	where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;
	
	commit;
	
end if;

if (ie_origem_p = 'H' or ie_gerar_arquivo_p = 'N') then
	open c_titulo;
	loop
	fetch c_titulo into	
		vet_titulo;
	EXIT WHEN NOT FOUND; /* apply on c_titulo */
		begin
		nr_contador_w := nr_contador_w + 1;
		
		SELECT * FROM pls_obter_dados_repasse(	vet_titulo.dt_ref_repasse, vet_titulo.nr_seq_segurado, vet_titulo.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;
		if	(nr_titulo_ant_w <> vet_titulo.nr_titulo AND nr_contador_w <> 1) then
			if (trunc(vl_sobra_w,2) > 0) then
				pls_aux_contrap_rec_w[nr_contador_w - 1].vl_contraprestacao          	:= pls_aux_contrap_rec_w[nr_contador_w - 1].vl_contraprestacao + vl_sobra_w;
				ctb_aux_contra_emit_w[nr_contador_w - 1].vl_parcela			:= ctb_aux_contra_emit_w[nr_contador_w - 1].vl_parcela + vl_sobra_w;
			end if;
			
			if (trunc(vl_sobra_juros_w,2) > 0) then
				pls_aux_contrap_rec_w[nr_contador_w - 1].vl_juros_multa         := pls_aux_contrap_rec_w[nr_contador_w - 1].vl_juros_multa + vl_sobra_juros_w;
				ctb_aux_contra_emit_w[nr_contador_w - 1].vl_multa_juros     	:= ctb_aux_contra_emit_w[nr_contador_w - 1].vl_multa_juros + vl_sobra_juros_w;
			end if;
			
			vl_sobra_w		:= 0;
			vl_sobra_juros_w	:= 0;
		end if;		
		vet_titulo.vl_descontos	:= (dividir_sem_round(vet_titulo.vl_item * vet_titulo.vl_descontos,vet_titulo.vl_mensalidade));
		
		/*Rateio Valor da Parcela*/

		
		vl_movimento_int_w	:= (vet_titulo.vl_recebido * dividir_sem_round(vet_titulo.vl_item,vet_titulo.vl_mensalidade));
		
		vl_parcela_w		:= trunc(vl_movimento_int_w,2);
		vl_sobra_w		:= vl_sobra_w + (vl_movimento_int_w - vl_parcela_w);
		
		/*Rateio Valor dos Juros*/

		vl_movimento_int_w	:= dividir_sem_round((vet_titulo.vl_multa + vet_titulo.vl_juros) * vet_titulo.vl_item,vet_titulo.vl_mensalidade);
		vl_juros_w		:= trunc(vl_movimento_int_w,2);
		vl_sobra_juros_w	:= vl_sobra_juros_w + (vl_movimento_int_w - vl_juros_w);	
		
		if (ie_origem_p = 'H') then
			select	nextval('pls_aux_contrap_recebidas_seq')
			into STRICT	nr_seq_aux_cont_rec_w
			;

			pls_aux_contrap_rec_w[nr_contador_w].nr_sequencia                   	:= nr_seq_aux_cont_rec_w;
			pls_aux_contrap_rec_w[nr_contador_w].dt_atualizacao                 	:= clock_timestamp();
			pls_aux_contrap_rec_w[nr_contador_w].nm_usuario                     	:= nm_usuario_p;
			pls_aux_contrap_rec_w[nr_contador_w].dt_atualizacao_nrec            	:= clock_timestamp();
			pls_aux_contrap_rec_w[nr_contador_w].nm_usuario_nrec                	:= nm_usuario_p;
			pls_aux_contrap_rec_w[nr_contador_w].nr_seq_reg_auxiliar            	:= nr_seq_reg_auxiliar_p;
			pls_aux_contrap_rec_w[nr_contador_w].nr_documento                   	:= vet_titulo.nr_documento;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_documento              	:= vet_titulo.ie_tipo_documento;
			pls_aux_contrap_rec_w[nr_contador_w].nr_titulo                      	:= vet_titulo.nr_titulo;
			pls_aux_contrap_rec_w[nr_contador_w].dt_emissao                     	:= vet_titulo.dt_emissao;
			pls_aux_contrap_rec_w[nr_contador_w].dt_vencimento             		:= vet_titulo.dt_vencimento;
			pls_aux_contrap_rec_w[nr_contador_w].nr_seq_contrato    		:= vet_titulo.nr_seq_contrato;
			pls_aux_contrap_rec_w[nr_contador_w].dt_inicio_contrato             	:= vet_titulo.dt_contrato;
			pls_aux_contrap_rec_w[nr_contador_w].nr_seq_pagador                 	:= vet_titulo.nr_seq_pagador;
			pls_aux_contrap_rec_w[nr_contador_w].nr_seq_segurado                	:= vet_titulo.nr_seq_segurado;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_modalidade             	:= vet_titulo.ie_preco;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_regulamentacao     	:= vet_titulo.ie_regulamentacao;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_contratacao            	:= vet_titulo.ie_tipo_contratacao;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_segmentacao   		:= vet_titulo.ie_segmentacao;
			pls_aux_contrap_rec_w[nr_contador_w].nr_registro_produto  		:= vet_titulo.nr_protocolo_ans;
			pls_aux_contrap_rec_w[nr_contador_w].dt_inicio_cobertura     		:= vet_titulo.dt_inicio_cobertura;
			pls_aux_contrap_rec_w[nr_contador_w].dt_fim_cobertura               	:= vet_titulo.dt_fim_cobertura;
			pls_aux_contrap_rec_w[nr_contador_w].dt_fim_contrato                	:= vet_titulo.dt_rescisao;
			pls_aux_contrap_rec_w[nr_contador_w].vl_apropriado                  	:= vet_titulo.vl_apropriado;
			pls_aux_contrap_rec_w[nr_contador_w].vl_contrato     			:= vet_titulo.vl_contrato;               	
			pls_aux_contrap_rec_w[nr_contador_w].vl_contraprestacao             	:= vl_parcela_w;
			pls_aux_contrap_rec_w[nr_contador_w].vl_juros_multa    			:= vl_juros_w;
			pls_aux_contrap_rec_w[nr_contador_w].vl_descontos   			:= vet_titulo.vl_descontos;
			pls_aux_contrap_rec_w[nr_contador_w].nr_parcela                     	:= vet_titulo.nr_parcela;
			pls_aux_contrap_rec_w[nr_contador_w].dt_recebimento                 	:= vet_titulo.dt_baixa;
			pls_aux_contrap_rec_w[nr_contador_w].cd_conta_contabil  		:= vet_titulo.cd_conta_contabil;
			pls_aux_contrap_rec_w[nr_contador_w].dt_contabil                    	:= vet_titulo.dt_baixa;
			pls_aux_contrap_rec_w[nr_contador_w].nr_contrato  			:= vet_titulo.nr_contrato;
			pls_aux_contrap_rec_w[nr_contador_w].dt_contratacao  			:= vet_titulo.dt_contratacao;
			pls_aux_contrap_rec_w[nr_contador_w].dt_cancelamento  			:= vet_titulo.dt_cancelamento;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_segurado			:= vet_titulo.ie_tipo_segurado;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_compartilhamento		:= ie_tipo_compartilhamento_w;
			pls_aux_contrap_rec_w[nr_contador_w].ie_tipo_repasse			:= ie_tipo_repasse_w;
			pls_aux_contrap_rec_w[nr_contador_w].dt_inicio_compartilhamento		:= dt_repasse_w;
			pls_aux_contrap_rec_w[nr_contador_w].dt_fim_compartilhamento		:= dt_fim_repasse_w;
		end if;
		
		if (ie_origem_p = 'D') then
			select	nextval('w_ctb_aux_contra_emit_seq')
			into STRICT	nr_seq_contra_emit_w
			;
			
			ctb_aux_contra_emit_w[nr_contador_w].nr_sequencia                       := nr_seq_contra_emit_w;
			ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao                     := clock_timestamp();
			ctb_aux_contra_emit_w[nr_contador_w].nm_usuario                         := nm_usuario_p;
			ctb_aux_contra_emit_w[nr_contador_w].dt_atualizacao_nrec                := clock_timestamp();
			ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_nrec                    := nm_usuario_p;
			ctb_aux_contra_emit_w[nr_contador_w].nr_titulo                          := vet_titulo.nr_titulo;			
			ctb_aux_contra_emit_w[nr_contador_w].dt_emissao                         := vet_titulo.dt_emissao;
			ctb_aux_contra_emit_w[nr_contador_w].dt_vencimento                      := vet_titulo.dt_vencimento;
			ctb_aux_contra_emit_w[nr_contador_w].nr_contrato                        := vet_titulo.nr_contrato;
			ctb_aux_contra_emit_w[nr_contador_w].dt_contrato                        := vet_titulo.dt_contrato;
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_documento                  := vet_titulo.ie_tipo_documento;
			ctb_aux_contra_emit_w[nr_contador_w].ds_tipo_documento			:= obter_valor_dominio(8372,vet_titulo.ie_tipo_documento);
			ctb_aux_contra_emit_w[nr_contador_w].nr_documento                       := vet_titulo.nr_documento;
			ctb_aux_contra_emit_w[nr_contador_w].cd_cpf_cnpj                        := vet_titulo.cd_cpf_cnpj;
			ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_principal               := vet_titulo.nm_usuario_principal;
			ctb_aux_contra_emit_w[nr_contador_w].cd_beneficiario                    := vet_titulo.cd_beneficiario;
			ctb_aux_contra_emit_w[nr_contador_w].nm_usuario_evento                  := vet_titulo.nm_usuario_evento;
			ctb_aux_contra_emit_w[nr_contador_w].ie_preco                           := vet_titulo.ie_preco;
			ctb_aux_contra_emit_w[nr_contador_w].ds_modalidade_contrat              := obter_valor_dominio(1669,vet_titulo.ie_preco);
			ctb_aux_contra_emit_w[nr_contador_w].ie_regulamentacao                  := vet_titulo.ie_regulamentacao;
			ctb_aux_contra_emit_w[nr_contador_w].ds_regulamentacao                  := obter_valor_dominio(2157,vet_titulo.ie_regulamentacao);
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_contratacao                := vet_titulo.ie_tipo_contratacao;
			ctb_aux_contra_emit_w[nr_contador_w].ds_tipo_contratacao                := obter_valor_dominio(1666,vet_titulo.ie_tipo_contratacao);
			ctb_aux_contra_emit_w[nr_contador_w].ie_segmentacao                     := vet_titulo.ie_segmentacao;
			ctb_aux_contra_emit_w[nr_contador_w].ds_segmentacao                     := obter_valor_dominio(1665,vet_titulo.ie_segmentacao);
			ctb_aux_contra_emit_w[nr_contador_w].nr_protocolo_ans                   := vet_titulo.nr_protocolo_ans;
			ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_cobertura                := vet_titulo.dt_inicio_cobertura;
			ctb_aux_contra_emit_w[nr_contador_w].dt_fim_cobertura                   := vet_titulo.dt_fim_cobertura;
			ctb_aux_contra_emit_w[nr_contador_w].dt_rescisao                        := vet_titulo.dt_rescisao;
			ctb_aux_contra_emit_w[nr_contador_w].vl_apropriado                      := vet_titulo.vl_apropriado;
			ctb_aux_contra_emit_w[nr_contador_w].vl_parcela                         := vl_parcela_w;
			ctb_aux_contra_emit_w[nr_contador_w].nr_parcela                         := vet_titulo.nr_parcela;
			ctb_aux_contra_emit_w[nr_contador_w].vl_multa_juros           		:= vl_juros_w;
			ctb_aux_contra_emit_w[nr_contador_w].dt_baixa                           := vet_titulo.dt_baixa;
			ctb_aux_contra_emit_w[nr_contador_w].dt_referencia                      := vet_titulo.dt_recebimento;
			ctb_aux_contra_emit_w[nr_contador_w].cd_conta_contabil                  := vet_titulo.cd_conta_contabil;
			ctb_aux_contra_emit_w[nr_contador_w].nr_seq_reg_auxiliar                := nr_seq_reg_auxiliar_p;
			ctb_aux_contra_emit_w[nr_contador_w].nr_seq_segurado                    := vet_titulo.nr_seq_segurado;
			ctb_aux_contra_emit_w[nr_contador_w].nr_seq_pagador			:= vet_titulo.nr_seq_pagador;
			ctb_aux_contra_emit_w[nr_contador_w].nr_linha                           := nr_contador_w;
			ctb_aux_contra_emit_w[nr_contador_w].vl_antecipado			:= vet_titulo.vl_descontos;
			ctb_aux_contra_emit_w[nr_contador_w].vl_contrato			:= vet_titulo.vl_contrato;
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_segurado			:= vet_titulo.ie_tipo_segurado;
			ctb_aux_contra_emit_w[nr_contador_w].dt_contratacao			:= vet_titulo.dt_contratacao;
			ctb_aux_contra_emit_w[nr_contador_w].dt_cancelamento			:= vet_titulo.dt_cancelamento;
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_compartilhamento		:= ie_tipo_compartilhamento_w;
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_repasse			:= ie_tipo_repasse_w;
			ctb_aux_contra_emit_w[nr_contador_w].dt_inicio_compartilhamento		:= dt_repasse_w;
			ctb_aux_contra_emit_w[nr_contador_w].dt_fim_compartilhamento		:= dt_fim_repasse_w;
			ctb_aux_contra_emit_w[nr_contador_w].ie_tipo_livro			:= 0; --Zero pois o select do WCPanel nao exibe se o valor for nulo
		end if;
		
		if (vet_titulo.ie_tipo_segurado in ('C','I','T')) then
			pls_aux_contrap_rec_w[nr_contador_w].ds_observacao	:= ds_observacao_w;
			ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= ds_observacao_w;
			
		else
			pls_aux_contrap_rec_w[nr_contador_w].ds_observacao	:= null;
			ctb_aux_contra_emit_w[nr_contador_w].ds_observacao	:= null;			
		end if;

		nr_titulo_ant_w	:= vet_titulo.nr_titulo;
		
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;
		end;
	end loop;
	close c_titulo;

	if (ie_origem_p = 'H') then
		if (pls_aux_contrap_rec_w.count > 0) then
			pls_aux_contrap_rec_w[nr_contador_w].vl_contraprestacao		:= pls_aux_contrap_rec_w[nr_contador_w].vl_contraprestacao + vl_sobra_w;
			pls_aux_contrap_rec_w[nr_contador_w].vl_juros_multa     	:= pls_aux_contrap_rec_w[nr_contador_w].vl_juros_multa + vl_sobra_juros_w;

			forall i in pls_aux_contrap_rec_w.first .. pls_aux_contrap_rec_w.last
				insert into pls_aux_contrap_recebidas values pls_aux_contrap_rec_w(i);

			commit;
		end if;
	elsif (ie_origem_p = 'D') then
		if (ctb_aux_contra_emit_w.count > 0) then
			ctb_aux_contra_emit_w[nr_contador_w].vl_parcela		:= ctb_aux_contra_emit_w[nr_contador_w].vl_parcela + vl_sobra_w;
			ctb_aux_contra_emit_w[nr_contador_w].vl_multa_juros     := ctb_aux_contra_emit_w[nr_contador_w].vl_multa_juros + vl_sobra_juros_w;
	
			forall i in ctb_aux_contra_emit_w.first .. ctb_aux_contra_emit_w.last
				insert into w_ctb_aux_contra_emit values ctb_aux_contra_emit_w(i);
	
			commit;
		end if;
	end if;
	
	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_reg_auxiliar_p;
	
elsif (ie_origem_p = 'D' and ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxContratosContrapRecebidas' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= substr(obter_desc_expressao(776817), 1, 255);
 	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1098702,'DT_INICIAL=' || dt_inicial_w || ';' ||'DT_FINAL=' || dt_final_w || ';' || 'DT_LIBERACAO=' || dt_liberacao_w);
	
	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);
	
	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, ds_rotulo_w);
	utl_file.fflush(arq_texto_w);
	for vetl in c_registros_delphi loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_contrap_recebidas ( nr_seq_reg_auxiliar_p w_ctb_aux_contra_emit.nr_seq_reg_auxiliar%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p w_ctb_aux_contra_emit.ie_ato_cooperado%type, ie_gerar_arquivo_p w_ctb_aux_contra_emit.ie_ato_cooperado%type default 'N') FROM PUBLIC;

