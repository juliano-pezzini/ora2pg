-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_tit_pagar (cd_estabelecimento_p bigint, nm_usuario_p text, dt_emissao_p timestamp, dt_vencimento_original_p timestamp, dt_vencimento_atual_p timestamp, vl_titulo_p bigint, vl_saldo_titulo_p bigint, vl_saldo_juros_p bigint, vl_saldo_multa_p bigint, cd_moeda_p bigint, tx_juros_p bigint, tx_multa_p bigint, cd_tipo_taxa_juro_p bigint, cd_tipo_taxa_multa_p bigint, tx_desc_antecipacao_p bigint, dt_limite_antecipacao_p timestamp, vl_dia_antecipacao_p bigint, cd_tipo_taxa_antecipacao_p bigint, ie_situacao_p text, ie_origem_titulo_p text, ie_tipo_titulo_p text, nr_seq_nota_fiscal_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nr_documento_p bigint, nr_bloqueto_p text, dt_liquidacao_p timestamp, nr_lote_contabil_p bigint, ds_observacao_titulo_p text, nr_bordero_p bigint, vl_bordero_p bigint, vl_juros_bordero_p bigint, vl_multa_bordero_p bigint, vl_desconto_bordero_p bigint, ie_desconto_dia_p text, nr_titulo_original_p bigint, nr_parcelas_p bigint, nr_total_parcelas_p bigint, dt_contabil_p timestamp, vl_ir_p bigint, nr_seq_trans_fin_baixa_p bigint, dt_liberacao_p timestamp, nm_usuario_lib_p text, nr_seq_rpa_p bigint, nr_repasse_terceiro_p bigint, nr_nosso_numero_p text, vl_imposto_munic_p bigint, vl_inss_p bigint, nr_seq_trans_fin_contab_p bigint, nr_seq_tributo_p bigint, vl_out_desp_bordero_p bigint, ds_compl_contab_p text, dt_inclusao_p timestamp, dt_integracao_externa_p timestamp, ie_status_tributo_p text, nr_lote_transf_trib_p bigint, nr_adiant_pago_p bigint, nr_seq_contrato_p bigint, cd_tributo_p bigint, cd_variacao_p text, ie_periodicidade_p text, cd_estab_financeiro_p bigint, nr_titulo_externo_p text, vl_bloq_associado_p bigint, vl_bloq_juros_p bigint, vl_bloq_desc_p bigint, ie_pls_p text, nr_seq_prot_conta_p bigint, cd_tipo_baixa_neg_p bigint, cd_darf_p text) AS $body$
DECLARE

/* 
	IE_ORIGEM_TITULO		1 - Nota Fiscal        
					2 - Manual           
					3 - Repasse          
					4 - Imposto          
					5 - Plano de saúde       
					6 - Reembolso / Plano de Saúde 
 
	IE_SITUACAO			A - Aberto       
					C - Cancelado     
					D - Desdobrado     
					L - Liquidado     
					T - Transferido 
 
	IE_TIPO_TITULO			0 - Nota Fiscal            
					1 - Bloqueto              
					10 - Diversos              
					11 - Recibo de Pagamento Autônomo 
					12 - Pró-Labore             
					2 - Duplicata             
					3 - Nota Promissória          
					4 - Imposto              
					5 - Adiantamento            
					6 - Folha de pagamento         
					7 - Férias 
					8 - Recisões 
					9 - Repasse 
 
	IE_STATUS_TRIBUTO		N - Não é titulo de imposto          
					NT - Imposto não transferido conta correta   
					T - Imposto transferido para conta correta 
 
	IE_PERIODICIDADE		A - Anual       
					B - Bimestral     
					D - Diário       
					E - Semestral     
					M - Mensal       
					Q - Quinzenal     
					S - Semanal      
					T - Trimestral     
					U - Quadrimestral	 
					X - Decendial     
 
*/
 
 
nr_titulo_w			bigint;
qt_ie_origem_titulo_w		bigint;
qt_ie_situacao_w		bigint;
qt_ie_tipo_titulo_w		bigint;
qt_ie_status_tributo_w		bigint;
qt_ie_periodicidade_w		bigint;
ds_erro_w			varchar(255);
			

BEGIN 
 
select	count(b.vl_dominio) 
into STRICT	qt_ie_origem_titulo_w 
from	dominio a, 
	valor_dominio b 
where	a.cd_dominio	= b.cd_dominio 
and	a.cd_dominio	= 500 
and	b.vl_dominio	= ie_origem_titulo_p;
 
select	count(b.vl_dominio) 
into STRICT	qt_ie_situacao_w 
from	dominio a, 
	valor_dominio b 
where	a.cd_dominio	= b.cd_dominio 
and	a.cd_dominio	= 501 
and	b.vl_dominio	= ie_situacao_p;
 
select	count(b.vl_dominio) 
into STRICT	qt_ie_tipo_titulo_w 
from	dominio a, 
	valor_dominio b 
where	a.cd_dominio	= b.cd_dominio 
and	a.cd_dominio	= 502 
and	b.vl_dominio	= ie_tipo_titulo_p;
 
if (ie_status_tributo_p IS NOT NULL AND ie_status_tributo_p::text <> '')	then 
	select	count(b.vl_dominio) 
	into STRICT	qt_ie_status_tributo_w 
	from	dominio a, 
		valor_dominio b 
	where	a.cd_dominio	= b.cd_dominio 
	and	a.cd_dominio	= 1532 
	and	b.vl_dominio	= ie_status_tributo_p;
else 
	qt_ie_status_tributo_w := 1;
end if;
 
if (ie_periodicidade_p IS NOT NULL AND ie_periodicidade_p::text <> '')	then 
	select	count(b.vl_dominio) 
	into STRICT	qt_ie_periodicidade_w 
	from	dominio a, 
		valor_dominio b 
	where	a.cd_dominio	= b.cd_dominio 
	and	a.cd_dominio	= 1532 
	and	b.vl_dominio	= ie_periodicidade_p;
else 
	qt_ie_periodicidade_w := 1;
end if;
 
select	max(nr_titulo) 
into STRICT	nr_titulo_w 
from	titulo_pagar 
where	nr_titulo_externo	= nr_titulo_externo_p;
	 
 
if (coalesce(nr_titulo_w::text, '') = '')	then 
	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '')	and (dt_emissao_p IS NOT NULL AND dt_emissao_p::text <> '')	and (dt_vencimento_original_p IS NOT NULL AND dt_vencimento_original_p::text <> '')	and (dt_vencimento_atual_p IS NOT NULL AND dt_vencimento_atual_p::text <> '')	and (vl_titulo_p IS NOT NULL AND vl_titulo_p::text <> '')	and (vl_saldo_titulo_p IS NOT NULL AND vl_saldo_titulo_p::text <> '')	and (vl_saldo_juros_p IS NOT NULL AND vl_saldo_juros_p::text <> '')	and (vl_saldo_multa_p IS NOT NULL AND vl_saldo_multa_p::text <> '')	and (cd_moeda_p IS NOT NULL AND cd_moeda_p::text <> '')	and (tx_juros_p IS NOT NULL AND tx_juros_p::text <> '')	and (tx_multa_p IS NOT NULL AND tx_multa_p::text <> '')	and (cd_tipo_taxa_juro_p IS NOT NULL AND cd_tipo_taxa_juro_p::text <> '')	and (cd_tipo_taxa_multa_p IS NOT NULL AND cd_tipo_taxa_multa_p::text <> '')	then 
		if (qt_ie_origem_titulo_w	= 1)	and (qt_ie_situacao_w	= 1)	and (qt_ie_tipo_titulo_w	= 1)	and (qt_ie_status_tributo_w	= 1)	and (qt_ie_periodicidade_w	= 1)	then 
			if	((cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') and (coalesce(cd_pessoa_fisica_p::text, '') = '')) 
			or ((cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (coalesce(cd_cgc_p::text, '') = ''))	then 
			 
				select	nextval('titulo_pagar_seq') 
				into STRICT	nr_titulo_w 
				;
	 
				begin 
				insert into titulo_pagar( 
					nr_titulo, 
					cd_estabelecimento, 
					dt_atualizacao, 
					nm_usuario, 
					dt_emissao, 
					dt_vencimento_original, 
					dt_vencimento_atual, 
					vl_titulo, 
					vl_saldo_titulo, 
					vl_saldo_juros,	 
					vl_saldo_multa, 
					cd_moeda, 
					tx_juros, 
					tx_multa, 
					cd_tipo_taxa_juro, 
					cd_tipo_taxa_multa, 
					tx_desc_antecipacao, 
					dt_limite_antecipacao, 
					vl_dia_antecipacao, 
					cd_tipo_taxa_antecipacao, 
					ie_situacao, 
					ie_origem_titulo, 
					ie_tipo_titulo, 
					nr_seq_nota_fiscal, 
					cd_pessoa_fisica, 
					cd_cgc, 
					nr_documento, 
					nr_bloqueto, 
					dt_liquidacao, 
					nr_lote_contabil, 
					ds_observacao_titulo, 
					nr_bordero, 
					vl_bordero, 
					vl_juros_bordero, 
					vl_multa_bordero, 
					vl_desconto_bordero, 
					ie_desconto_dia, 
					nr_titulo_original, 
					nr_parcelas, 
					nr_total_parcelas, 
					dt_contabil, 
					vl_ir, 
					nr_seq_trans_fin_baixa, 
					dt_liberacao, 
					nm_usuario_lib, 
					nr_seq_rpa, 
					nr_repasse_terceiro, 
					nr_nosso_numero, 
					vl_imposto_munic, 
					vl_inss, 
					nr_seq_trans_fin_contab, 
					nr_seq_tributo, 
					vl_out_desp_bordero, 
					ds_compl_contab, 
					dt_inclusao, 
					nm_usuario_orig, 
					dt_integracao_externa, 
					ie_status_tributo, 
					nr_lote_transf_trib, 
					nr_adiant_pago, 
					nr_seq_contrato, 
					cd_tributo, 
					cd_variacao, 
					ie_periodicidade, 
					cd_estab_financeiro, 
					nr_titulo_externo, 
					vl_bloq_associado, 
					vl_bloq_juros, 
					vl_bloq_desc, 
					ie_pls, 
					nr_seq_prot_conta, 
					cd_tipo_baixa_neg, 
					cd_darf, 
					ie_status) 
				values (	nr_titulo_w, 
					cd_estabelecimento_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					trunc(dt_emissao_p,'dd'), 
					trunc(dt_vencimento_original_p,'dd'), 
					trunc(dt_vencimento_atual_p,'dd'), 
					vl_titulo_p, 
					vl_saldo_titulo_p, 
					vl_saldo_juros_p, 
					vl_saldo_multa_p, 
					cd_moeda_p, 
					tx_juros_p, 
					tx_multa_p, 
					cd_tipo_taxa_juro_p, 
					cd_tipo_taxa_multa_p, 
					tx_desc_antecipacao_p, 
					trunc(dt_limite_antecipacao_p,'dd'), 
					vl_dia_antecipacao_p, 
					cd_tipo_taxa_antecipacao_p, 
					ie_situacao_p, 
					ie_origem_titulo_p, 
					ie_tipo_titulo_p, 
					nr_seq_nota_fiscal_p, 
					cd_pessoa_fisica_p, 
					cd_cgc_p, 
					nr_documento_p, 
					nr_bloqueto_p, 
					trunc(dt_liquidacao_p,'dd'), 
					nr_lote_contabil_p, 
					ds_observacao_titulo_p, 
					nr_bordero_p, 
					vl_bordero_p, 
					vl_juros_bordero_p, 
					vl_multa_bordero_p, 
					vl_desconto_bordero_p, 
					ie_desconto_dia_p, 
					nr_titulo_original_p, 
					nr_parcelas_p, 
					nr_total_parcelas_p, 
					trunc(dt_contabil_p,'dd'), 
					vl_ir_p, 
					nr_seq_trans_fin_baixa_p, 
					trunc(dt_liberacao_p,'dd'), 
					nm_usuario_lib_p, 
					nr_seq_rpa_p, 
					nr_repasse_terceiro_p, 
					nr_nosso_numero_p, 
					vl_imposto_munic_p, 
					vl_inss_p, 
					nr_seq_trans_fin_contab_p, 
					nr_seq_tributo_p, 
					vl_out_desp_bordero_p, 
					ds_compl_contab_p, 
					trunc(dt_inclusao_p,'dd'), 
					nm_usuario_p, 
					trunc(dt_integracao_externa_p,'dd'), 
					ie_status_tributo_p, 
					nr_lote_transf_trib_p, 
					nr_adiant_pago_p, 
					nr_seq_contrato_p, 
					cd_tributo_p, 
					cd_variacao_p, 
					ie_periodicidade_p, 
					cd_estab_financeiro_p, 
					nr_titulo_externo_p, 
					vl_bloq_associado_p, 
					vl_bloq_juros_p, 
					vl_bloq_desc_p, 
					ie_pls_p, 
					nr_seq_prot_conta_p, 
					cd_tipo_baixa_neg_p, 
					cd_darf_p, 
					'D');
				CALL ATUALIZAR_INCLUSAO_TIT_PAGAR(nr_titulo_w, nm_usuario_p);
				exception 
				when others then 
					null;
					/*ds_erro_w := SQLERRM(sqlcode); 
				 
					insert into logxxx_tasy( 
							dt_atualizacao, 
						nm_usuario, 
						cd_log, 
						ds_log) 
					values( 
						sysdate, 
						nm_usuario_p, 
						55707, 
						'nr_titulo = ' || nr_titulo_w || 
						'DS_ERRO = ' || ds_erro_w);*/
 
				end;
			end if;
		end if;
	end if;				
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_tit_pagar (cd_estabelecimento_p bigint, nm_usuario_p text, dt_emissao_p timestamp, dt_vencimento_original_p timestamp, dt_vencimento_atual_p timestamp, vl_titulo_p bigint, vl_saldo_titulo_p bigint, vl_saldo_juros_p bigint, vl_saldo_multa_p bigint, cd_moeda_p bigint, tx_juros_p bigint, tx_multa_p bigint, cd_tipo_taxa_juro_p bigint, cd_tipo_taxa_multa_p bigint, tx_desc_antecipacao_p bigint, dt_limite_antecipacao_p timestamp, vl_dia_antecipacao_p bigint, cd_tipo_taxa_antecipacao_p bigint, ie_situacao_p text, ie_origem_titulo_p text, ie_tipo_titulo_p text, nr_seq_nota_fiscal_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nr_documento_p bigint, nr_bloqueto_p text, dt_liquidacao_p timestamp, nr_lote_contabil_p bigint, ds_observacao_titulo_p text, nr_bordero_p bigint, vl_bordero_p bigint, vl_juros_bordero_p bigint, vl_multa_bordero_p bigint, vl_desconto_bordero_p bigint, ie_desconto_dia_p text, nr_titulo_original_p bigint, nr_parcelas_p bigint, nr_total_parcelas_p bigint, dt_contabil_p timestamp, vl_ir_p bigint, nr_seq_trans_fin_baixa_p bigint, dt_liberacao_p timestamp, nm_usuario_lib_p text, nr_seq_rpa_p bigint, nr_repasse_terceiro_p bigint, nr_nosso_numero_p text, vl_imposto_munic_p bigint, vl_inss_p bigint, nr_seq_trans_fin_contab_p bigint, nr_seq_tributo_p bigint, vl_out_desp_bordero_p bigint, ds_compl_contab_p text, dt_inclusao_p timestamp, dt_integracao_externa_p timestamp, ie_status_tributo_p text, nr_lote_transf_trib_p bigint, nr_adiant_pago_p bigint, nr_seq_contrato_p bigint, cd_tributo_p bigint, cd_variacao_p text, ie_periodicidade_p text, cd_estab_financeiro_p bigint, nr_titulo_externo_p text, vl_bloq_associado_p bigint, vl_bloq_juros_p bigint, vl_bloq_desc_p bigint, ie_pls_p text, nr_seq_prot_conta_p bigint, cd_tipo_baixa_neg_p bigint, cd_darf_p text) FROM PUBLIC;

