-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_sup_tempo_compras ( cd_estabelecimento_p bigint, nm_usuario_p text, dt_inicio_p timestamp, dt_final_p timestamp) AS $body$
DECLARE



cd_material_w		integer;
dt_entrega_w		timestamp;
nr_seq_nota_w		bigint;
nr_nota_fiscal_w	varchar(255);
nr_ordem_compra_w	bigint;
dt_ordem_compra_w	timestamp;
nr_item_oci_w		bigint;
qt_dias_oc_nf_w		bigint;
nr_cot_compra_w		bigint;
nr_item_cot_compra_w	bigint;
dt_cot_compra_w		timestamp;
qt_dias_cot_oc_w	bigint;
nr_solic_compra_w	bigint;
dt_solic_compra_w	timestamp;
qt_dias_solic_cot_w	bigint;
qt_dias_solic_nf_w	bigint;
cd_cgc_emitente_w	varchar(14);
cd_local_estoque_w	smallint;
cd_comprador_w		varchar(10);
ie_urgente_w		varchar(1);

c01 CURSOR FOR
SELECT	b.cd_material,
	trunc(c.dt_ordem_compra,'dd'),
	a.nr_ordem_compra,
	a.nr_item_oci,
	trunc(a.dt_prevista_entrega, 'dd'),
	b.cd_local_estoque,
	c.cd_comprador,
	c.ie_urgente
from	ordem_compra c,
	ordem_compra_item b,
	ordem_compra_item_entrega a
where	a.nr_ordem_compra	= b.nr_ordem_compra
and	a.nr_item_oci		= b.nr_item_oci
and	a.nr_ordem_compra	= c.nr_ordem_compra
and	c.cd_estabelecimento	= cd_estabelecimento_p
and	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
and	a.dt_prevista_entrega between dt_inicio_p and fim_dia(dt_final_p)

union

select	b.cd_material,
	trunc(c.dt_ordem_compra,'dd'),
	a.nr_ordem_compra,
	a.nr_item_oci,
	null,
	b.cd_local_estoque,
	c.cd_comprador,
	c.ie_urgente
from	ordem_compra c,
	ordem_compra_item b,
	ordem_compra_item_entrega a
where	a.nr_ordem_compra	= b.nr_ordem_compra
and	a.nr_item_oci		= b.nr_item_oci
and	a.nr_ordem_compra	= c.nr_ordem_compra
and	c.cd_estabelecimento	= cd_estabelecimento_p
and	coalesce(c.nr_seq_motivo_cancel::text, '') = ''
and	a.dt_prevista_entrega between dt_inicio_p and fim_dia(dt_final_p)
and	coalesce(a.dt_real_entrega::text, '') = '';

c02 CURSOR FOR
SELECT	a.nr_cot_compra,
	b.nr_item_cot_compra,
	trunc(a.dt_cot_compra),
	b.cd_material
from	cot_compra a,
	cot_compra_item b
where	a.nr_cot_compra = b.nr_cot_compra
and	a.cd_estabelecimento = cd_estabelecimento_p
and	a.dt_cot_compra between dt_inicio_p and fim_dia(dt_final_p)
and not exists (
	SELECT	1
	from	ordem_compra_item x
	where	x.nr_cot_compra = b.nr_cot_compra
	and	x.nr_item_cot_compra = b.nr_item_cot_compra);


BEGIN

delete
from	w_sup_tempo_compras
where	nm_usuario = nm_usuario_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	dt_ordem_compra_w,
	nr_ordem_compra_w,
	nr_item_oci_w,
	dt_entrega_w,
	cd_local_estoque_w,
	cd_comprador_w,
	ie_urgente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_nota_w
	from	ordem_compra_nota_fiscal
	where	nr_ordem_compra	= nr_ordem_compra_w
	and	nr_item_oci	= nr_item_oci_w
	and	cd_material	= cd_material_w
	and	dt_entrega	= dt_entrega_w;

	select	nr_nota_fiscal,
		cd_cgc_emitente
	into STRICT	nr_nota_fiscal_w,
		cd_cgc_emitente_w
	from	nota_fiscal
	where	nr_sequencia = nr_seq_nota_w;

	exception when others then
		nr_seq_nota_w		:= null;
		nr_nota_fiscal_w	:= '';
		cd_cgc_emitente_w	:= null;
	end;

	if (nr_seq_nota_w > 0) then
		qt_dias_oc_nf_w	:= obter_dias_entre_datas(dt_ordem_compra_w, dt_entrega_w);
	else
		qt_dias_oc_nf_w := null;
	end if;

	begin
	select	max(b.nr_cot_compra),
		max(b.nr_item_cot_compra),
		max(trunc(c.dt_cot_compra,'dd'))
	into STRICT	nr_cot_compra_w,
		nr_item_cot_compra_w,
		dt_cot_compra_w
	from	ordem_compra_item a,
		cot_compra_item b,
		cot_compra c
	where	a.nr_cot_compra = b.nr_cot_compra
	and	a.nr_item_cot_compra = b.nr_item_cot_compra
	and	c.nr_cot_compra = b.nr_cot_compra
	and	a.nr_ordem_compra = nr_ordem_compra_w
	and	a.nr_item_oci = nr_item_oci_w;

	if (nr_cot_compra_w > 0) then
		qt_dias_cot_oc_w	:= obter_dias_entre_datas(dt_cot_compra_w, dt_ordem_compra_w);
	else
		qt_dias_cot_oc_w	:= null;
	end if;

	exception when others then
		nr_cot_compra_w		:= null;
		nr_item_cot_compra_w	:= null;
		dt_cot_compra_w		:= null;
		qt_dias_cot_oc_w	:= null;
	end;

	begin
	select	max(nr_solic_compra),
		max(trunc(dt_solic_compra,'dd'))
	into STRICT	nr_solic_compra_w,
		dt_solic_compra_w
		from (
		SELECT	max(c.nr_solic_compra) nr_solic_compra,
			max(c.dt_solicitacao_compra) dt_solic_compra

		from	cot_compra_item a,
			solic_compra_item b,
			solic_compra c
		where	a.nr_solic_compra = b.nr_solic_compra
		and	a.nr_item_solic_compra = b.nr_item_solic_compra
		and	c.nr_solic_compra = b.nr_solic_compra
		and	a.nr_cot_compra = nr_cot_compra_w
		and	a.nr_item_cot_compra = nr_item_cot_compra_w
		and	(a.nr_solic_compra IS NOT NULL AND a.nr_solic_compra::text <> '')
		
union

		SELECT	max(c.nr_solic_compra),
			max(c.dt_solicitacao_compra)
		from	cot_compra_solic_agrup a,
			solic_compra_item b,
			solic_compra c
		where	a.nr_solic_compra = b.nr_solic_compra
		and	a.nr_item_solic_compra = b.nr_item_solic_compra
		and	c.nr_solic_compra = b.nr_solic_compra
		and	a.nr_cot_compra = nr_cot_compra_w
		and	a.nr_item_cot_compra = nr_item_cot_compra_w
		and	(a.nr_solic_compra IS NOT NULL AND a.nr_solic_compra::text <> '')) alias9;

	if (nr_solic_compra_w > 0) then
		qt_dias_solic_cot_w	:= obter_dias_entre_datas(dt_solic_compra_w, dt_cot_compra_w);
	else
		qt_dias_solic_cot_w	:= null;
	end if;

	exception
	when others then
		nr_solic_compra_w	:= null;
		dt_solic_compra_w	:= null;
		qt_dias_solic_cot_w	:= null;
	end;

	if (nr_seq_nota_w > 0) and (nr_solic_compra_w > 0) then
		qt_dias_solic_nf_w := obter_dias_entre_datas(dt_solic_compra_w, dt_entrega_w);
	else
		qt_dias_solic_nf_w := null;

	end if;

	insert into w_sup_tempo_compras(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ie_tipo_informacao,
		dt_entrega,
		nr_seq_nota,
		nr_nota_fiscal,
		dt_ordem_compra,
		nr_ordem_compra,
		qt_dias_oc_nf,
		cd_material,
		nr_cot_compra,
		dt_cot_compra,
		qt_dias_cot_oc,
		nr_solic_compra,
		dt_solic_compra,
		qt_dias_solic_cot,
		qt_dias_solic_nf,
		cd_cgc_emitente,
		cd_local_estoque,
		cd_comprador,
		ie_urgente)
	values ( nextval('w_sup_tempo_compras_seq'),
		clock_timestamp(),
		nm_usuario_p,
		'A',
		dt_entrega_w,
		nr_seq_nota_w,
		nr_nota_fiscal_w,
		dt_ordem_compra_w,
		nr_ordem_compra_w,
		qt_dias_oc_nf_w,
		cd_material_w,
		nr_cot_compra_w,
		dt_cot_compra_w,
		qt_dias_cot_oc_w,
		nr_solic_compra_w,
		dt_solic_compra_w,
		qt_dias_solic_cot_w,
		qt_dias_solic_nf_w,
		cd_cgc_emitente_w,
		cd_local_estoque_w,
		cd_comprador_w,
		ie_urgente_w);
	end;
end loop;
close c01;

open C02;
loop
fetch C02 into
	nr_cot_compra_w,
	nr_item_cot_compra_w,
	dt_cot_compra_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	begin
	select	max(nr_solic_compra),
		max(trunc(dt_solic_compra,'dd'))
	into STRICT	nr_solic_compra_w,
		dt_solic_compra_w
		from (
		SELECT	max(c.nr_solic_compra) nr_solic_compra,
			max(c.dt_solicitacao_compra) dt_solic_compra

		from	cot_compra_item a,
			solic_compra_item b,
			solic_compra c
		where	a.nr_solic_compra = b.nr_solic_compra
		and	a.nr_item_solic_compra = b.nr_item_solic_compra
		and	c.nr_solic_compra = b.nr_solic_compra
		and	a.nr_cot_compra = nr_cot_compra_w
		and	a.nr_item_cot_compra = nr_item_cot_compra_w
		and	(a.nr_solic_compra IS NOT NULL AND a.nr_solic_compra::text <> '')
		
union

		SELECT	max(c.nr_solic_compra),
			max(c.dt_solicitacao_compra)
		from	cot_compra_solic_agrup a,
			solic_compra_item b,
			solic_compra c
		where	a.nr_solic_compra = b.nr_solic_compra
		and	a.nr_item_solic_compra = b.nr_item_solic_compra
		and	c.nr_solic_compra = b.nr_solic_compra
		and	a.nr_cot_compra = nr_cot_compra_w
		and	a.nr_item_cot_compra = nr_item_cot_compra_w
		and	(a.nr_solic_compra IS NOT NULL AND a.nr_solic_compra::text <> '')) alias9;

	if (nr_solic_compra_w > 0) then
		qt_dias_solic_cot_w	:= obter_dias_entre_datas(dt_solic_compra_w, dt_cot_compra_w);
	else
		qt_dias_solic_cot_w	:= null;
	end if;

	exception
	when others then
		nr_solic_compra_w	:= null;
		dt_solic_compra_w	:= null;
		qt_dias_solic_cot_w	:= null;
	end;

	insert into w_sup_tempo_compras(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ie_tipo_informacao,
		dt_entrega,
		nr_seq_nota,
		nr_nota_fiscal,
		dt_ordem_compra,
		nr_ordem_compra,
		qt_dias_oc_nf,
		cd_material,
		nr_cot_compra,
		dt_cot_compra,
		qt_dias_cot_oc,
		nr_solic_compra,
		dt_solic_compra,
		qt_dias_solic_cot,
		qt_dias_solic_nf)
	values ( nextval('w_sup_tempo_compras_seq'),
		clock_timestamp(),
		nm_usuario_p,
		'A',
		null,
		null,
		null,
		null,
		null,
		null,
		cd_material_w,
		nr_cot_compra_w,
		dt_cot_compra_w,
		null,
		nr_solic_compra_w,
		dt_solic_compra_w,
		qt_dias_solic_cot_w,
		null);

	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_sup_tempo_compras ( cd_estabelecimento_p bigint, nm_usuario_p text, dt_inicio_p timestamp, dt_final_p timestamp) FROM PUBLIC;

