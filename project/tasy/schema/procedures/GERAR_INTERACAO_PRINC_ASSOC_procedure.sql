-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interacao_princ_assoc ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p bigint) AS $body$
DECLARE


cd_material_w				bigint;
cd_material_interacao_w			bigint;
ie_verifica_w				smallint;
ie_severidade_w				varchar(3);
ds_tipo_w				varchar(255);
nr_seq_ficha_w				bigint;
nr_seq_ficha_interacao_w		bigint;
ds_orientacao_w				varchar(2000);
cd_grupo_material_w			smallint;
cd_subgrupo_material_w			smallint;
cd_classe_material_w			integer;
ie_exibir_gravidade_w			varchar(1);
ie_mensagem_cadastrada_w		varchar(1);
ds_ref_bibliografica_w			varchar(4000);
ie_consistir_w				varchar(15);
ie_gravar_w				varchar(1);
ie_classificacao_w			varchar(15);
cd_estabelecimento_w			smallint;
nr_sequencia_nova_w			bigint;


BEGIN
select  cd_material,
	cd_material_interacao,
	ie_severidade,
	ds_tipo,
	nr_seq_ficha,
	nr_seq_ficha_interacao,
	ds_orientacao,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	ie_exibir_gravidade,
	ie_mensagem_cadastrada,
	ds_ref_bibliografica,
	ie_consistir,
	ie_gravar,
	ie_classificacao,
	cd_estabelecimento
into STRICT 	cd_material_w,
	cd_material_interacao_w,
	ie_severidade_w,
	ds_tipo_w,
	nr_seq_ficha_interacao_w,
	nr_seq_ficha_w,
	ds_orientacao_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ie_exibir_gravidade_w,
	ie_mensagem_cadastrada_w,
	ds_ref_bibliografica_w,
	ie_consistir_w,
	ie_gravar_w,
	ie_classificacao_w,
	cd_estabelecimento_w		
from	material_interacao_medic
where	nr_sequencia = nr_sequencia_p;


if	((ie_opcao_p  = 1) or (ie_opcao_p = 2)) then --- Inserindo ou alterando a interacao medicamentosa
	
	if (ie_opcao_p = 2) then
	
		select  max(1) 
		into STRICT	ie_verifica_w
		from	material_interacao_medic
		where 	nr_seq_ficha = nr_seq_ficha_interacao_w
		and 	nr_seq_ficha_interacao = nr_seq_ficha_w;
		
		if (ie_verifica_w = 1) then
			CALL apagar_int_princ_alterada(nr_seq_ficha_interacao_w,nr_seq_ficha_w);
		end if;
		
	end if;

	select	nextval('material_interacao_medic_seq')
	into STRICT	nr_sequencia_nova_w
	;

	insert into material_interacao_medic(
			cd_material,
			cd_material_interacao,
			ie_severidade,
			ds_tipo,
			nr_seq_ficha,
			nr_seq_ficha_interacao,
			ds_orientacao,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			ie_exibir_gravidade,
			ie_mensagem_cadastrada,
			ds_ref_bibliografica,
			ie_consistir,
			ie_gravar,
			ie_classificacao,
			cd_estabelecimento,
			nr_sequencia,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			ie_situacao)
	values (
			cd_material_interacao_w,
			cd_material_w,
			ie_severidade_w,
			ds_tipo_w,
			nr_seq_ficha_w,
			nr_seq_ficha_interacao_w,
			ds_orientacao_w,
			null,
			null,
			null,
			ie_exibir_gravidade_w,
			ie_mensagem_cadastrada_w,
			ds_ref_bibliografica_w,
			ie_consistir_w,
			ie_gravar_w,
			ie_classificacao_w,
			cd_estabelecimento_w,
			nr_sequencia_nova_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			'A');

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interacao_princ_assoc ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p bigint) FROM PUBLIC;

