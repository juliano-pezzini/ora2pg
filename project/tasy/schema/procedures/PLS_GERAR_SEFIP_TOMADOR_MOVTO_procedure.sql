-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_sefip_tomador_movto (nr_seq_lote_sefip_p bigint, nr_seq_prestador_p bigint, nm_usuario_p text, vl_remuneracao_p bigint, vl_remuneracao_13_p bigint, vl_descontado_p bigint, vl_base_13_p bigint, vl_base_13_movimento_p bigint, cd_cbo_saude_p text, nr_seq_conta_p bigint, nr_seq_resumo_p bigint, cd_cgc_estipulante_p text, cd_pf_estipulante_p text, nr_seq_lote_pgto_p bigint) AS $body$
DECLARE



nr_seq_tomador_movto_w	bigint;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_tomador_movto_w
from	sefip_tomador_movimento
where	nr_seq_lote		= nr_seq_lote_sefip_p
and	nr_seq_prestador		= nr_seq_prestador_p
and	cd_cgc_estipulante		= cd_cgc_estipulante_p;

if (nr_seq_tomador_movto_w IS NOT NULL AND nr_seq_tomador_movto_w::text <> '') then

	update	sefip_tomador_movimento
	set	vl_remuneracao		= coalesce(vl_remuneracao, 0) + vl_remuneracao_p,
		vl_remuneracao_13	= coalesce(vl_remuneracao_13, 0) + vl_remuneracao_13_p,
		vl_descontado		= coalesce(vl_descontado, 0) + vl_descontado_p,
		vl_base_13		= coalesce(vl_base_13, 0) + vl_base_13_p,
		vl_base_13_movimento	= coalesce(vl_base_13_movimento, 0) + vl_base_13_movimento_p,
		cd_cbo_saude		= cd_cbo_saude_p
	where	nr_sequencia		= nr_seq_tomador_movto_w;

else

	select	nextval('sefip_tomador_movimento_seq')
	into STRICT	nr_seq_tomador_movto_w
	;

	insert into sefip_tomador_movimento(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nr_seq_prestador,
				vl_remuneracao,
				vl_remuneracao_13,
				vl_descontado,
				vl_base_13,
				vl_base_13_movimento,
				nr_seq_tomador,
				cd_cbo_saude,
				cd_cgc_estipulante,
				cd_pf_estipulante,
				nr_seq_lote)
			values (nr_seq_tomador_movto_w,
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				nr_seq_prestador_p,
				coalesce(vl_remuneracao_p,0),
				coalesce(vl_remuneracao_13_p,0),
				coalesce(vl_descontado_p,0),
				coalesce(vl_base_13_p,0),
				coalesce(vl_base_13_movimento_p,0),
				null,
				cd_cbo_saude_p,
				cd_cgc_estipulante_p,
				cd_pf_estipulante_p,
				nr_seq_lote_sefip_p);
end if;

insert into sefip_tomador_movto_conta(NR_SEQUENCIA,
	DT_ATUALIZACAO,
	NM_USUARIO,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC,
	NR_SEQ_MOVTO,
	NR_SEQ_CONTA,
	VL_DESCONTADO,
	NR_SEQ_RESUMO,
	VL_LIBERADO,
	NR_SEQ_LOTE,
	CD_CGC_ESTIPULANTE,
	CD_PF_ESTIPULANTE,
	NR_SEQ_LOTE_PGTO,
	cd_cbo_saude,
	nr_seq_prestador)
values (nextval('sefip_tomador_movto_conta_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_tomador_movto_w,
	nr_seq_conta_p,
	vl_descontado_p,
	nr_seq_resumo_p,
	vl_remuneracao_p,
	nr_seq_lote_sefip_p,
	cd_cgc_estipulante_p,
	cd_pf_estipulante_p,
	nr_seq_lote_pgto_p,
	cd_cbo_saude_p,
	nr_seq_prestador_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_sefip_tomador_movto (nr_seq_lote_sefip_p bigint, nr_seq_prestador_p bigint, nm_usuario_p text, vl_remuneracao_p bigint, vl_remuneracao_13_p bigint, vl_descontado_p bigint, vl_base_13_p bigint, vl_base_13_movimento_p bigint, cd_cbo_saude_p text, nr_seq_conta_p bigint, nr_seq_resumo_p bigint, cd_cgc_estipulante_p text, cd_pf_estipulante_p text, nr_seq_lote_pgto_p bigint) FROM PUBLIC;

