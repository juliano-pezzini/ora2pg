-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_inclusao_intercambio ( nr_seq_solicitacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_segurado_p INOUT bigint) AS $body$
DECLARE

			
cd_pessoa_fisica_w		varchar(10);
nr_seq_intercambio_w		bigint;
nr_seq_pagador_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_tabela_w			bigint;
cd_matricula_est_w		varchar(30);
nr_seq_parentesco_w		bigint;
nr_seq_titular_contrato_w	bigint;
dt_contratacao_w		timestamp;
nr_seq_titular_solic_w		bigint;
nr_seq_titular_gerado_w		bigint;
nr_seq_seg_contrato_w		bigint;
ie_tipo_repasse_w		varchar(10);
ie_tipo_segurado_w		varchar(10);
ie_tipo_parentesco_w		varchar(10);
nr_seq_segurado_w		bigint;
nr_seq_congenere_w		bigint;
nr_seq_motivo_inclusao_w	pls_inclusao_beneficiario.nr_seq_motivo_inclusao%type;
dt_inclusao_operadora_w		pls_inclusao_beneficiario.dt_inclusao_operadora%type;
nr_seq_localizacao_benef_w	pls_segurado.nr_seq_localizacao_benef%type;
nr_seq_vendedor_canal_w		bigint;
nr_seq_vendedor_pf_w		bigint;


BEGIN

/* Obter dados da solicitacao */

select	coalesce(cd_pessoa_fisica,'X'),
	nr_seq_intercambio,
	cd_matricula_est,
	nr_seq_plano,
	nr_seq_parentesco,
	nr_seq_titular_contrato,
	dt_contratacao,
	nr_seq_titular_solic,
	nr_seq_motivo_inclusao,
	dt_inclusao_operadora,
	nr_seq_localizacao_benef,
	nr_seq_vendedor_canal,
	nr_seq_vendedor_pf
into STRICT	cd_pessoa_fisica_w,
	nr_seq_intercambio_w,
	cd_matricula_est_w,
	nr_seq_plano_w,
	nr_seq_parentesco_w,
	nr_seq_titular_contrato_w,
	dt_contratacao_w,
	nr_seq_titular_solic_w,
	nr_seq_motivo_inclusao_w,
	dt_inclusao_operadora_w,
	nr_seq_localizacao_benef_w,
	nr_seq_vendedor_canal_w,
	nr_seq_vendedor_pf_w
from	pls_inclusao_beneficiario
where	nr_sequencia	= nr_seq_solicitacao_p;

if (nr_seq_titular_solic_w IS NOT NULL AND nr_seq_titular_solic_w::text <> '') and (coalesce(nr_seq_titular_contrato_w::text, '') = '') then
	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_titular_gerado_w
	from	pls_segurado
	where	nr_seq_benef_inclusao	= nr_seq_titular_solic_w;
	exception
	when others then
		nr_seq_titular_gerado_w	:= null;
	end;
	
	if (coalesce(nr_seq_titular_gerado_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(190666,'NM_TITULAR='||substr(pls_obter_dados_inclusao(nr_seq_titular_solic_w,'N'),1,255)||';'||
							'NR_SEQ_TITULAR='||nr_seq_titular_solic_w);
	end if;
	
	nr_seq_titular_contrato_w	:= nr_seq_titular_gerado_w;
end if;	

if (cd_pessoa_fisica_w	= 'X') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(190667);
end if;

if (coalesce(nr_seq_vendedor_canal_w::text, '') = '') then
	nr_seq_vendedor_canal_w	:= pls_obter_regra_lanc_intercamb(nr_seq_intercambio_w, dt_contratacao_w, 'P', 'CV');
	nr_seq_vendedor_pf_w	:= pls_obter_regra_lanc_intercamb(nr_seq_intercambio_w, dt_contratacao_w, 'P', 'V');
end if;

select	coalesce(max(nr_seq_seg_contrato),0) + 1
into STRICT	nr_seq_seg_contrato_w
from	pls_segurado
where	nr_seq_intercambio	= nr_seq_intercambio_w;

ie_tipo_repasse_w	:= 'C';

begin
select	max(nr_seq_tabela)
into STRICT	nr_seq_tabela_w
from	pls_intercambio_plano
where	nr_seq_intercambio	= nr_seq_intercambio_w
and	nr_seq_plano		= nr_seq_plano_w;
exception
when others then
	nr_seq_tabela_w	:= null;
end;

if (nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then
	ie_tipo_repasse_w	:= 'P';
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_pagador_w
from	pls_contrato_pagador
where	nr_seq_pagador_intercambio	= nr_seq_intercambio_w;

select	CASE WHEN coalesce(nr_seq_congenere::text, '') = '' THEN 'C'  ELSE 'T' END ,
	CASE WHEN coalesce(nr_seq_congenere::text, '') = '' THEN nr_seq_oper_congenere  ELSE nr_seq_congenere END
into STRICT	ie_tipo_segurado_w,
	nr_seq_congenere_w
from	pls_intercambio
where	nr_sequencia	= nr_seq_intercambio_w;

if (nr_seq_parentesco_w IS NOT NULL AND nr_seq_parentesco_w::text <> '') then
	select	max(ie_tipo_parentesco)
	into STRICT	ie_tipo_parentesco_w
	from	grau_parentesco
	where	nr_sequencia	= nr_seq_parentesco_w;
end if;

select	nextval('pls_segurado_seq')
into STRICT	nr_seq_segurado_w
;

insert	into	pls_segurado(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
		cd_estabelecimento,cd_pessoa_fisica,dt_contratacao,dt_inclusao_operadora,nr_seq_plano,
		ie_taxa_inscricao,nr_seq_parentesco,nr_seq_titular,nr_seq_pagador,nr_seq_tabela,
		ie_tipo_segurado,ie_situacao_atend,nr_seq_intercambio,nr_seq_seg_contrato,nr_seq_benef_inclusao,
		ie_renovacao_carteira,ie_tipo_repasse,ie_tipo_parentesco,cd_matricula_estipulante,ie_bonific_cooperado,
		ie_nascido_plano,nr_seq_congenere,nr_seq_motivo_inclusao,nr_seq_localizacao_benef,nr_seq_vendedor_canal,
		nr_seq_vendedor_pf)
values (	nr_seq_segurado_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
		cd_estabelecimento_p,cd_pessoa_fisica_w,dt_contratacao_w,coalesce(dt_inclusao_operadora_w,dt_contratacao_w),nr_seq_plano_w,
		'S',nr_seq_parentesco_w,nr_seq_titular_contrato_w,nr_seq_pagador_w,nr_seq_tabela_w,
		ie_tipo_segurado_w,'A',nr_seq_intercambio_w,nr_seq_seg_contrato_w,nr_seq_solicitacao_p,
		'S',ie_tipo_repasse_w,ie_tipo_parentesco_w,cd_matricula_est_w,'N',
		'N',nr_seq_congenere_w,nr_seq_motivo_inclusao_w,nr_seq_localizacao_benef_w,nr_seq_vendedor_canal_w,
		nr_seq_vendedor_pf_w);
		
update	pls_inclusao_beneficiario
set	ie_status_intercambio		= 'B',
	ie_etapa_solic_intercambio	= 'IT'
where	nr_sequencia		= nr_seq_solicitacao_p;

nr_seq_segurado_p	:= nr_seq_segurado_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_inclusao_intercambio ( nr_seq_solicitacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_segurado_p INOUT bigint) FROM PUBLIC;

