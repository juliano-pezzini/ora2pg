-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_benef_lote_rem ( nr_seq_benef_lote_benef_p bigint, nr_seq_lote_remessa_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_rem_valor_det_w  	pls_ame_lote_rem_valor_det.nr_sequencia%type;
nr_seq_rem_valor_det_ww		pls_ame_lote_rem_valor_det.nr_sequencia%type;
nr_seq_segurado_w		pls_ame_lote_rem_valor.nr_seq_segurado%type;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.nr_seq_segurado
	from	pls_ame_lote_rem_valor_det a,
		pls_ame_lote_rem_valor b
	where	b.nr_sequencia = a.nr_seq_lote_rem_valor
	and	b.nr_sequencia = nr_seq_benef_lote_benef_p;

c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_ame_lote_rem_valor_det a,
		pls_ame_lote_rem_valor b
	where	b.nr_sequencia = a.nr_seq_lote_rem_valor
	and	b.nr_seq_titular = nr_seq_segurado_w;


BEGIN
open c01;
loop
fetch c01 into
	nr_seq_rem_valor_det_w,
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
begin
	delete
	from	pls_ame_lote_rem_valor_cop
	where	nr_seq_rem_valor_detalhe = nr_seq_rem_valor_det_w;

	delete
	from	pls_ame_lote_rem_valor_det
	where	nr_sequencia = nr_seq_rem_valor_det_w;

	open C02;
	loop
	fetch C02 into
		nr_seq_rem_valor_det_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			delete
			from	pls_ame_lote_rem_valor_cop
			where	nr_seq_rem_valor_detalhe = nr_seq_rem_valor_det_ww;

			delete
			from	pls_ame_lote_rem_valor_det
			where	nr_sequencia = nr_seq_rem_valor_det_ww;
		end;
	end loop;
	close C02;
end;
end loop;
close c01;

delete
from 	pls_ame_lote_rem_valor
where 	nr_sequencia = nr_seq_benef_lote_benef_p;

CALL pls_atualizar_vl_lote_remessa(nr_seq_lote_remessa_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_benef_lote_rem ( nr_seq_benef_lote_benef_p bigint, nr_seq_lote_remessa_p bigint, nm_usuario_p text ) FROM PUBLIC;

