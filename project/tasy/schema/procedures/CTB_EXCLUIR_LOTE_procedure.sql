-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_excluir_lote ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_commit_p text default 'S') AS $body$
DECLARE


dt_atualizacao_w		timestamp;
cd_tipo_lote_w			tipo_lote_contabil.cd_tipo_lote_contabil%type;
cd_tipo_lote_ww			tipo_lote_contabil.cd_tipo_lote_contabil%type;
qt_registro_w			bigint;
qt_ctb_movto_w			bigint;
nr_sequencia_w		bigint;
nr_lote_filho_w		lote_contabil.nr_lote_contabil%TYPE;
ie_status_origem_w lote_contabil.ie_status_origem%TYPE;

C01 CURSOR FOR
SELECT	nr_sequencia
from 	ctb_movimento
where	nr_lote_contabil	= nr_lote_contabil_p;

c02 CURSOR FOR
SELECT	nr_lote_contabil
from	lote_contabil
where	nr_lote_origem = nr_lote_contabil_p
and	coalesce(dt_atualizacao_saldo::text, '') = '';


BEGIN

select count(*)
into STRICT	qt_registro_w
from	movimento_contabil
where	nr_lote_contabil	= nr_lote_contabil_p;

select dt_atualizacao_saldo,
	   cd_tipo_lote_contabil,
	   ie_status_origem
into STRICT   dt_atualizacao_w,
	   cd_tipo_lote_w,
	   ie_status_origem_w
from	lote_contabil
where	nr_lote_contabil	= nr_lote_contabil_p;

if (dt_atualizacao_w IS NOT NULL AND dt_atualizacao_w::text <> '')  then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217014);
end if;

if	coalesce(ie_status_origem_w,'X') = 'SO'  then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1078711);
end if;

delete	from ctb_balancete_distr	
where	nr_lote_contabil = nr_lote_contabil_p;

delete from ctb_movto_ifrs
where nr_lote_contabil = nr_lote_contabil_p;

select	count(*)
into STRICT	qt_ctb_movto_w
from	ctb_movimento
where	nr_lote_contabil	= nr_lote_contabil_p;

open c02;
loop
fetch c02 into	
	nr_lote_filho_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	
	select	dt_atualizacao_saldo
	into STRICT	dt_atualizacao_w
	from	lote_contabil
	where	nr_lote_contabil	= nr_lote_filho_w;

	if (dt_atualizacao_w IS NOT NULL AND dt_atualizacao_w::text <> '')  then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(271509,'NR_LOTE_CONTABIL='||nr_lote_filho_w);
	end if;
	
	delete	from ctb_movimento
	where	nr_lote_contabil = nr_lote_filho_w;
	
	select	count(*)
	into STRICT 	qt_registro_w
	from 	movimento_contabil
	where 	nr_lote_contabil = nr_lote_filho_w;
	
	if (qt_registro_w = 0) then
		delete	from lote_contabil
		where 	nr_lote_contabil = nr_lote_filho_w;
	end if;
	
	end;
end loop;
close c02;

update	ctb_movimento
set	nr_seq_movto_partida	 = NULL
where	nr_lote_contabil	= nr_lote_contabil_p;


OPEN C01;
LOOP
FETCH C01 into	
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	update	ctb_movimento
	set	nm_usuario	= wheb_mensagem_pck.get_texto(298057)
	where	nr_sequencia	= nr_sequencia_w;
	delete	from ctb_movimento
	where	nr_sequencia	= nr_sequencia_w;
END LOOP;
CLOSE C01;

update	lote_contabil
set	dt_atualizacao_saldo	 = NULL,
	dt_integracao		 = NULL,
	dt_consistencia		 = NULL,
	nr_seq_mes_ref		 = NULL
where	nr_lote_contabil	= nr_lote_contabil_p;

CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
			7,
			wheb_mensagem_pck.get_texto(298056) || qt_ctb_movto_w,
			nm_usuario_p);

if (qt_registro_w = 0)  then
	delete from lote_contabil
	where nr_lote_contabil	= nr_lote_contabil_p;
	CALL gravar_log_exclusao('LOTE_CONTABIL',nm_usuario_p, 'NR_LOTE_CONTABIL='|| nr_lote_contabil_p || ' ' ||wheb_mensagem_pck.get_texto(798464),'N');
end if;
if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_excluir_lote ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_commit_p text default 'S') FROM PUBLIC;

