-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_laudo_prescr_opm ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

					   
					   
cd_cid_principal_w	varchar(4);	
cd_medico_w		varchar(10);
qt_diagnostico_w	integer;
nr_atendimento_w	bigint;
dt_prescricao_w		timestamp;
dt_diagnostico_w	timestamp;	
nr_laudo_w		smallint;
cd_procedimento_w	bigint;			
				   
				  C01 CURSOR FOR 
	SELECT	cd_cid_principal, 
		cd_procedimento 
	from	prescr_opme 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	SELECT	cd_cid_principal, 
		cd_procedimento 
	from	prescr_opm 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_protese_ms 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_protese_mi 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_ortese_ms 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_ortese_mi 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_meio_locomocao 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union
 
	select	cd_cid_principal, 
		cd_procedimento 
	from	prescr_ortese_coluna 
	where	nr_prescricao	= nr_prescricao_p 
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '');


BEGIN 
begin 
 
if (coalesce(nr_prescricao_p,0) > 0) then 
	select	dt_prescricao, 
		cd_medico, 
		nr_atendimento 
	into STRICT	dt_prescricao_w, 
		cd_medico_w, 
		nr_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao	= nr_prescricao_p;
end if;
 
 
open C01;
loop 
fetch C01 into	 
	cd_cid_principal_w, 
	cd_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
		select	coalesce(MAX(nr_laudo_sus),0) + 1 
			into STRICT	nr_laudo_w 
			from	sus_laudo_paciente 
			where	nr_atendimento	= nr_atendimento_w;
 
			 
			insert into sus_laudo_paciente( 
						nr_seq_interno, 
						nr_laudo_sus, 
						ie_classificacao, 
						ie_tipo_laudo_sus, 
						ie_diaria_acomp, 
						dt_emissao, 
						nm_usuario, 
						dt_atualizacao, 
						cd_medico_responsavel, 
						cd_medico_requisitante, 
						nr_atendimento, 
						cd_procedimento_solic, 
						cd_cid_principal) 
					values (nextval('sus_laudo_paciente_seq'), 
						nr_laudo_w, 
						15, 
						0, 
						'N', 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						cd_medico_w, 
						cd_medico_w, 
						nr_atendimento_w, 
						cd_procedimento_w, 
						cd_cid_principal_w);
			commit;
	 
	end;
end loop;
close C01;
 
exception 
when others then 
null;
	 
end;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_laudo_prescr_opm ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

