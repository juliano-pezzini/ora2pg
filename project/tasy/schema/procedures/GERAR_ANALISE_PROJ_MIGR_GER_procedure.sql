-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_analise_proj_migr_ger ( nr_seq_gerencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_grupo_w			bigint;
qt_projeto_w			bigint := 0;
qt_projeto_desenv_w		bigint := 0;
qt_projeto_desenv_tec_w		bigint := 0;
qt_projeto_teste_w			bigint := 0;
qt_projeto_concluido_w		bigint := 0;
qt_projeto_saldo_w			bigint := 0;
qt_horas_previstas_w		double precision := 0;
qt_horas_realizadas_w		double precision := 0;
qt_horas_saldo_w			double precision := 0;
pr_previsao_w			double precision := 0;
pr_realizacao_w			double precision := 0;
qt_os_projeto_w			bigint := 0;
qt_os_projeto_tec_w		bigint := 0;
qt_os_projeto_desenv_w		bigint := 0;
qt_os_projeto_teste_w		bigint := 0;
qt_os_projeto_conc_w		bigint := 0;

qt_projeto_ww			bigint := 0;
qt_projeto_desenv_ww		bigint := 0;
qt_projeto_desenv_tec_ww		bigint := 0;
qt_projeto_teste_ww		bigint := 0;
qt_projeto_concluido_ww		bigint := 0;
qt_projeto_saldo_ww		bigint := 0;
qt_horas_previstas_ww		double precision := 0;
qt_horas_realizadas_ww		double precision := 0;
qt_horas_saldo_ww			double precision := 0;
pr_previsao_ww			double precision := 0;
pr_realizacao_ww			double precision := 0;
qt_os_projeto_ww			bigint := 0;
qt_os_projeto_tec_ww		bigint := 0;
qt_os_projeto_desenv_ww		bigint := 0;
qt_os_projeto_teste_ww		bigint := 0;
qt_os_projeto_conc_ww		bigint := 0;

qt_hora_sent_proj_w		double precision := 0;
qt_hora_sent_proj_ww		double precision := 0;
qt_hora_sent_proj_www		double precision := 0;

c01 CURSOR FOR
SELECT	g.nr_sequencia
from	proj_grupo g
where	g.ie_situacao = 'A'
and	exists (
		SELECT	1
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not(1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = g.nr_sequencia);

c02 CURSOR FOR
SELECT	coalesce(obter_valor_perc(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia,0,'T','E'),0),
		CASE WHEN p.nr_seq_estagio=1 THEN  proj_obter_perc_cron(p.nr_sequencia,'R') WHEN p.nr_seq_estagio=12 THEN  proj_obter_perc_cron(p.nr_sequencia,'R')  ELSE 100 END ),0) qt_hora_sent_proj
from	proj_projeto p
where	p.nr_seq_gerencia = nr_seq_gerencia_p
and	p.nr_seq_classif = 14
and	p.nr_sequencia not in (1430,1427,1061)
and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
and	p.nr_sequencia not in (1282)
and	p.nr_seq_grupo = nr_seq_grupo_w;


BEGIN
if (nr_seq_gerencia_p IS NOT NULL AND nr_seq_gerencia_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	delete
	from	w_analise_proj_desenv
	where	nr_seq_gerencia = nr_seq_gerencia_p
	and	dt_analise = trunc(clock_timestamp());

	open c01;
	loop
	fetch c01 into nr_seq_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		select	count(*),
			sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia,0,'T','E'),0)),
			sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia,0,'R','E'),0))
		into STRICT	qt_projeto_w,
			qt_horas_previstas_w,
			qt_horas_realizadas_w
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		qt_horas_saldo_w	:= qt_horas_previstas_w - qt_horas_realizadas_w;
		pr_previsao_w		:= obter_perc_valor(qt_horas_realizadas_w,qt_horas_previstas_w);

		select	count(*)
		into STRICT	qt_projeto_desenv_w
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w
		and	p.nr_seq_estagio = 12;

		select	count(*)
		into STRICT	qt_projeto_desenv_tec_w
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w
		and	p.nr_seq_estagio = 12
		and	exists (
				SELECT	1
				from	man_ordem_servico mos
				where	mos.nr_sequencia = p.nr_seq_ordem_serv
				and	mos.nr_seq_estagio = 961);

		select	count(*)
		into STRICT	qt_projeto_teste_w
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w
		and	p.nr_seq_estagio in (13,17);

		select	count(*)
		into STRICT	qt_projeto_concluido_w
		from	proj_projeto p
		where	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w
		and	p.ie_status = 'F';

		qt_projeto_saldo_w := qt_projeto_w - qt_projeto_desenv_w - qt_projeto_teste_w - qt_projeto_concluido_w;

		select	count(*)
		into STRICT	qt_os_projeto_w
		from	proj_ordem_servico pos,
			proj_projeto p
		where	pos.nr_seq_proj = p.nr_sequencia
		and	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		select	count(*)
		into STRICT	qt_os_projeto_tec_w
		from	man_ordem_servico mos,
			proj_ordem_servico pos,
			proj_projeto p
		where	mos.nr_seq_estagio in (961,131)
		and	mos.nr_sequencia = pos.nr_seq_ordem
		and	pos.nr_seq_proj = p.nr_sequencia
		and	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		select	count(*)
		into STRICT	qt_os_projeto_desenv_w
		from	man_ordem_servico mos,
			proj_ordem_servico pos,
			proj_projeto p
		where	mos.nr_seq_estagio in (4,731,732)
		and	mos.nr_sequencia = pos.nr_seq_ordem
		and	pos.nr_seq_proj = p.nr_sequencia
		and	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		select	count(*)
		into STRICT	qt_os_projeto_teste_w
		from	man_ordem_servico mos,
			proj_ordem_servico pos,
			proj_projeto p
		where	mos.nr_seq_estagio in (2,1511)
		and	mos.nr_sequencia = pos.nr_seq_ordem
		and	pos.nr_seq_proj = p.nr_sequencia
		and	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		select	count(*)
		into STRICT	qt_os_projeto_conc_w
		from	man_ordem_servico mos,
			proj_ordem_servico pos,
			proj_projeto p
		where	mos.nr_seq_estagio = 9
		and	mos.nr_sequencia = pos.nr_seq_ordem
		and	pos.nr_seq_proj = p.nr_sequencia
		and	p.nr_seq_gerencia = nr_seq_gerencia_p
		and	p.nr_seq_classif = 14
		and	p.nr_sequencia not in (1430,1427,1061)
		and	p.nr_sequencia not in (580,581,582,583,584,656,494,654,498)
		and	p.nr_sequencia not in (1282)
		and	p.nr_seq_grupo = nr_seq_grupo_w;

		qt_hora_sent_proj_ww := 0;

		open c02;
		loop
		fetch c02 into qt_hora_sent_proj_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			qt_hora_sent_proj_ww := qt_hora_sent_proj_ww + qt_hora_sent_proj_w;
			end;
		end loop;
		close c02;

		qt_hora_sent_proj_www	:= qt_hora_sent_proj_www + qt_hora_sent_proj_ww;
		pr_realizacao_w		:= obter_perc_valor(qt_hora_sent_proj_ww,qt_horas_previstas_w);

		insert into w_analise_proj_desenv(
			nm_usuario,
			dt_analise,
			nr_seq_gerencia,
			nr_seq_grupo,
			qt_projeto,
			qt_projeto_desenv,
			qt_projeto_desenv_tec,
			qt_projeto_teste,
			qt_projeto_concluido,
			qt_projeto_saldo,
			qt_horas_previstas,
			qt_horas_realizadas,
			qt_horas_saldo,
			pr_previsao,
			pr_realizacao,
			qt_os_projeto,
			qt_os_projeto_tec,
			qt_os_projeto_desenv,
			qt_os_projeto_teste,
			qt_os_projeto_conc,
			dt_fim_previsto)
		values (
			nm_usuario_p,
			trunc(clock_timestamp()),
			nr_seq_gerencia_p,
			nr_seq_grupo_w,
			qt_projeto_w,
			qt_projeto_desenv_w,
			qt_projeto_desenv_tec_w,
			qt_projeto_teste_w,
			qt_projeto_concluido_w,
			qt_projeto_saldo_w,
			qt_horas_previstas_w,
			qt_horas_realizadas_w,
			qt_horas_saldo_w,
			pr_previsao_w,
			pr_realizacao_w,
			qt_os_projeto_w,
			qt_os_projeto_tec_w,
			qt_os_projeto_desenv_w,
			qt_os_projeto_teste_w,
			qt_os_projeto_conc_w,
			null);

		qt_projeto_ww			:= qt_projeto_ww + qt_projeto_w;
		qt_projeto_desenv_ww		:= qt_projeto_desenv_ww + qt_projeto_desenv_w;
		qt_projeto_desenv_tec_ww	:= qt_projeto_desenv_tec_ww + qt_projeto_desenv_tec_w;
		qt_projeto_teste_ww		:= qt_projeto_teste_ww + qt_projeto_teste_w;
		qt_projeto_concluido_ww		:= qt_projeto_concluido_ww + qt_projeto_concluido_w;
		qt_projeto_saldo_ww		:= qt_projeto_saldo_ww + qt_projeto_saldo_w;
		qt_horas_previstas_ww		:= qt_horas_previstas_ww + qt_horas_previstas_w;
		qt_horas_realizadas_ww		:= qt_horas_realizadas_ww + qt_horas_realizadas_w;
		qt_horas_saldo_ww		:= qt_horas_saldo_ww + qt_horas_saldo_w;
		qt_os_projeto_ww		:= qt_os_projeto_ww + qt_os_projeto_w;
		qt_os_projeto_tec_ww		:= qt_os_projeto_tec_ww + qt_os_projeto_tec_w;
		qt_os_projeto_desenv_ww		:= qt_os_projeto_desenv_ww + qt_os_projeto_desenv_w;
		qt_os_projeto_teste_ww		:= qt_os_projeto_teste_ww + qt_os_projeto_teste_w;
		qt_os_projeto_conc_ww		:= qt_os_projeto_conc_ww + qt_os_projeto_conc_w;
		end;
	end loop;
	close c01;

	pr_previsao_ww 		:= obter_perc_valor(qt_horas_realizadas_ww,qt_horas_previstas_ww);
	pr_realizacao_ww	:= obter_perc_valor(qt_hora_sent_proj_www,qt_horas_previstas_ww);

	insert into w_analise_proj_desenv(
		nm_usuario,
		dt_analise,
		nr_seq_gerencia,
		nr_seq_grupo,
		qt_projeto,
		qt_projeto_desenv,
		qt_projeto_desenv_tec,
		qt_projeto_teste,
		qt_projeto_concluido,
		qt_projeto_saldo,
		qt_horas_previstas,
		qt_horas_realizadas,
		qt_horas_saldo,
		pr_previsao,
		pr_realizacao,
		qt_os_projeto,
		qt_os_projeto_tec,
		qt_os_projeto_desenv,
		qt_os_projeto_teste,
		qt_os_projeto_conc,
		dt_fim_previsto)
	values (
		nm_usuario_p,
		trunc(clock_timestamp()),
		nr_seq_gerencia_p,
		null,
		qt_projeto_ww,
		qt_projeto_desenv_ww,
		qt_projeto_desenv_tec_ww,
		qt_projeto_teste_ww,
		qt_projeto_concluido_ww,
		qt_projeto_saldo_ww,
		qt_horas_previstas_ww,
		qt_horas_realizadas_ww,
		qt_horas_saldo_ww,
		pr_previsao_ww,
		pr_realizacao_ww,
		qt_os_projeto_ww,
		qt_os_projeto_tec_ww,
		qt_os_projeto_desenv_ww,
		qt_os_projeto_teste_ww,
		qt_os_projeto_conc_ww,
		null);
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_analise_proj_migr_ger ( nr_seq_gerencia_p bigint, nm_usuario_p text) FROM PUBLIC;

