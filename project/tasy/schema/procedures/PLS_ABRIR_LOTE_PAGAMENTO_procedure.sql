-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_abrir_lote_pagamento ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_vencimento_w			bigint	:= 0;
ie_baixar_tit_rec_w			pls_parametro_pagamento.ie_baixar_tit_rec%type;
cd_estabelecimento_w		pls_parametro_pagamento.cd_estabelecimento%type;
ie_baixar_tit_pagar_w		pls_parametro_pagamento.ie_baixar_tit_pagar%type;
ie_data_lote_prod_med_w		pls_parametro_contabil.ie_data_lote_prod_med%type;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;


BEGIN

select	count(*)
into STRICT	qt_vencimento_w
from	pls_pagamento_prestador		b,
	pls_pag_prest_vencimento	a
where	a.nr_seq_pag_prestador	= b.nr_sequencia
and	b.nr_seq_lote		= nr_seq_lote_p;

if (qt_vencimento_w	> 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267005, null); /* Não é permitido abrir lote com vencimentos gerados! */
end if;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	pls_lote_pagamento
where	nr_sequencia	= nr_seq_lote_p;

select	coalesce(max(ie_data_lote_prod_med), 'C')
into STRICT	ie_data_lote_prod_med_w
from	pls_parametro_contabil
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select	coalesce(max(ie_baixar_tit_rec), 'N'),
	coalesce(max(ie_baixar_tit_pagar), 'N')
into STRICT	ie_baixar_tit_rec_w,
	ie_baixar_tit_pagar_w
from	pls_parametro_pagamento
where	cd_estabelecimento	 = cd_estabelecimento_w;

if (ie_baixar_tit_rec_w = 'S') then
	pls_baixar_tit_rec_lote_pag(nr_seq_lote_p, null, 'A', nm_usuario_p);
end if;

if (ie_baixar_tit_pagar_w = 'S') then
	CALL pls_baixar_tit_pagar_lote_pag(nr_seq_lote_p, null, 'A', nm_usuario_p);
end if;

update	pls_lote_pagamento
set	ie_status		= 'P',
	dt_fechamento		 = NULL,
	nm_usuario_fechamento	= ''
where	nr_sequencia		= nr_seq_lote_p;

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from 	pls_visible_false;

/*Verificar se o parametro ie_data_lote_prod_med_w é igual a 'C'*/

if (ie_data_lote_prod_med_w = 'C') and (ie_concil_contab_w = 'S') then
	delete	FROM ctb_documento	b
	where	b.cd_tipo_lote_contabil = 41
	and	exists ( SELECT	1
			from 	pls_conta_medica_resumo 	a,
				pls_lote_pagamento		b
			where	a.nr_seq_lote_pgto 	= b.nr_sequencia
			and	b.nr_documento = a.nr_sequencia
			and	b.nr_sequencia	= nr_seq_lote_p);
		commit;

	delete	FROM ctb_documento	b
	where	b.cd_tipo_lote_contabil = 41
	and	exists ( SELECT	1
			from 	pls_evento_movimento	a,
				pls_lote_evento		b,
				pls_lote_pagamento 	c
			where	b.nr_sequencia		= a.nr_seq_lote
			and	c.nr_sequencia		= a.nr_seq_lote_pgto
			and	c.nr_sequencia		= nr_seq_lote_p);
		commit;

	delete	FROM ctb_documento	b
	where	b.cd_tipo_lote_contabil = 41
	and	exists ( SELECT	1
			from 	pls_pag_prest_venc_trib		a,
				pls_lote_pagamento		b,
				pls_pagamento_prestador		c,
				pls_pag_prest_vencimento	d
			where	b.nr_sequencia = c.nr_seq_lote
			and	d.nr_sequencia = a.nr_seq_vencimento
			and	c.nr_sequencia = d.nr_seq_pag_prestador
			and	b.nr_sequencia = nr_seq_lote_p);
		commit;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_abrir_lote_pagamento ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

