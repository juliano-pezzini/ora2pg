-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transfere_imagem ( ds_caminho_p text, nr_prescricao_old_p bigint, nr_seq_prescricao_old_p bigint, nr_prescricao_new_p bigint, nr_seq_prescricao_new_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_captura_w         integer;
nr_sequencia_w                 integer;
nr_seq_captura_nextVal         bigint;
nr_seq_prescr_proc_cap_nextVal bigint;

nr_seq_log_atual_w bigint;
ie_log_w           varchar(10);


BEGIN
  SELECT ci.nr_sequencia
  INTO STRICT   nr_sequencia_captura_w
  FROM   captura_imagem ci
  WHERE  ci.ds_caminho = ds_caminho_p;

  SELECT ppci.nr_sequencia
  INTO STRICT   nr_sequencia_w
  FROM   prescr_proc_captura_img ppci
  WHERE  ppci.nr_seq_captura = nr_sequencia_captura_w
  AND    ppci.nr_prescricao = nr_prescricao_old_p
  AND    ppci.nr_sequencia_prescricao = nr_seq_prescricao_old_p;

  select nextval('captura_imagem_seq') into STRICT nr_seq_captura_nextval;
  select nextval('prescr_proc_captura_img_seq') into STRICT nr_seq_prescr_proc_cap_nextVal;

  SELECT * FROM gravar_log_alteracao(nr_sequencia_captura_w, nr_seq_captura_nextVal, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_seq_captura_nextVal, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  ie_log_w := NULL;

  DELETE FROM captura_imagem
  WHERE  nr_sequencia = nr_sequencia_captura_w;

  SELECT * FROM gravar_log_alteracao(nr_sequencia_w, nr_seq_prescr_proc_cap_nextVal, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_seq_prescr_proc_cap_nextVal, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  SELECT * FROM gravar_log_alteracao(nr_prescricao_old_p, nr_prescricao_new_p, nm_usuario_p, nr_seq_log_atual_w, 'NR_PRESCRICAO', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_seq_prescr_proc_cap_nextVal, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  SELECT * FROM gravar_log_alteracao(nr_seq_prescricao_old_p, nr_seq_prescricao_new_p, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA_PRESCRICAO', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_seq_prescr_proc_cap_nextVal, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;

  DELETE FROM prescr_proc_captura_img
  WHERE  nr_sequencia = nr_sequencia_w;

  nr_sequencia_captura_w := nr_seq_captura_nextVal;
  nr_sequencia_w :=  nr_seq_prescr_proc_cap_nextVal;

  INSERT INTO captura_imagem(nr_sequencia, ds_caminho, dt_atualizacao, nm_usuario)
  VALUES (nr_sequencia_captura_w, ds_caminho_p, clock_timestamp(), nm_usuario_p);

  INSERT INTO prescr_proc_captura_img(nr_sequencia, dt_atualizacao, nm_usuario, nr_prescricao, nr_sequencia_prescricao, nr_seq_captura)
  VALUES (nr_sequencia_w, clock_timestamp(), nm_usuario_p, nr_prescricao_new_p, nr_seq_prescricao_new_p, nr_sequencia_captura_w);

  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transfere_imagem ( ds_caminho_p text, nr_prescricao_old_p bigint, nr_seq_prescricao_old_p bigint, nr_prescricao_new_p bigint, nr_seq_prescricao_new_p bigint, nm_usuario_p text) FROM PUBLIC;

