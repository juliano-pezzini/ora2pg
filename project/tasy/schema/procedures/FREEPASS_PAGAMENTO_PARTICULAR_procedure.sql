-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE freepass_pagamento_particular (nr_atendimento_p bigint, cd_pessoa_fisica_p text, vl_pago_p bigint, cd_cigla_moeda_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_moeda_w moeda.cd_moeda%type;
cd_tipo_recebimento_w adiantamento.cd_tipo_recebimento%type;


BEGIN

select max(cd_moeda)
into STRICT cd_moeda_w
from moeda
where ds_sigla_moeda = cd_cigla_moeda_p;

if coalesce(cd_moeda_w::text, '') = '' then

  select max(cd_moeda)
  into STRICT cd_moeda_w
  from moeda
  where ds_sigla_moeda = 'BRL';

end if;

-- 7 = a opcao de adiantamento
select max(cd_tipo_recebimento)
into STRICT cd_tipo_recebimento_w
from	tipo_recebimento
where	ie_tipo_consistencia = 7
and cd_estabelecimento = cd_estabelecimento_p;

insert into adiantamento(
  vl_adiantamento,
  vl_saldo,
  dt_adiantamento,
  dt_contabil,
  cd_pessoa_fisica,
  nr_atendimento,
  cd_tipo_recebimento,
  cd_moeda,
  nm_usuario,
  dt_atualizacao,
  cd_estabelecimento,
  nr_adiantamento,
  ie_situacao
) values (
  vl_pago_p,
  0,
  clock_timestamp(),
  clock_timestamp(),
  cd_pessoa_fisica_p,
  nr_atendimento_p,
  cd_tipo_recebimento_w,
  cd_moeda_w,
  nm_usuario_p,
  clock_timestamp(),
  cd_estabelecimento_p,
  nextval('adiantamento_seq'),
  'A');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE freepass_pagamento_particular (nr_atendimento_p bigint, cd_pessoa_fisica_p text, vl_pago_p bigint, cd_cigla_moeda_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

