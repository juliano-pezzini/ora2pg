-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_autogerado () AS $body$
DECLARE


/*
	Rotina que automatiza a geração do autogerado. Gera para a compatência anterior no primeiro dia de cada mês, através de JOB.
*/
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
nr_lote_auto_w		pls_lote_auto_gerado.nr_sequencia%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;


BEGIN

select  trunc(add_months(clock_timestamp(), -1), 'MONTH') inicio_mes,
	inicio_dia(last_day(add_months(clock_timestamp(), -1))) fim_mes
into STRICT	dt_inicio_w,
	dt_fim_w
;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	pls_conta;

select	max(nr_sequencia)
into STRICT	nr_lote_auto_w
from	pls_lote_auto_gerado
where	coalesce(nr_seq_prestador::text, '') = ''
and	ie_status 	= 'U'
and	dt_inicio 	= dt_inicio_w
and	dt_fim		= dt_fim_w;

if (coalesce(nr_lote_auto_w::text, '') = '') then
	insert into pls_lote_auto_gerado(	nr_sequencia, ie_status, dt_atualizacao,
						nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						dt_inicio, dt_fim, cd_estabelecimento)
					values ( nextval('pls_lote_auto_gerado_seq'), 'U', clock_timestamp(),
						'Tasy', clock_timestamp(), 'Tasy',
						dt_inicio_w, dt_fim_w, cd_estabelecimento_w) returning nr_sequencia into nr_lote_auto_w;
end if;

CALL pls_gerencia_autogerado_pck.pls_gerar_lote_autogerado(nr_lote_auto_w, cd_estabelecimento_w, 'Tasy');


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_autogerado () FROM PUBLIC;

