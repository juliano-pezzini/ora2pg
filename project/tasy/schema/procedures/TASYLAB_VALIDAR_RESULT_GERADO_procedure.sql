-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_validar_result_gerado ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint) AS $body$
DECLARE


nr_seq_resultado_w			bigint;
qt_item_w					bigint;
ie_status_receb_lote_ext_w 	smallint;
cd_estab_prescr_w			smallint;
nr_lote_ext_w				lab_lote_externo.nr_sequencia%type;
qt_exame_lote_nao_aprov_w	bigint;


BEGIN

/*select	max(nr_seq_resultado)
into	nr_seq_resultado_w
from	exame_lab_resultado
where	nr_prescricao = nr_prescricao_p;

if	(nr_seq_resultado_w is null) then
	wheb_mensagem_pck.exibir_mensagem_abort(241140);
end if;

select	count(*)
into	qt_item_w
from	exame_lab_result_item
where	nr_seq_resultado = nr_seq_resultado_w
and		nr_seq_resultado*/
select	count(*)
into STRICT	qt_item_w
from	result_laboratorio
where	nr_prescricao = nr_prescricao_p
and		nr_seq_prescricao = nr_seq_prescricao_p;

if (qt_item_w >= 2) then

	delete	FROM result_laboratorio
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_prescricao = nr_seq_prescricao_p;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(241137);

elsif (qt_item_w >= 2) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(241138);
else

	select	max(cd_estabelecimento)
	into STRICT	cd_estab_prescr_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select 	coalesce(max(ie_status_receb_lote_ext),35)
	into STRICT	ie_status_receb_lote_ext_w
	from	lab_parametro
	where	cd_estabelecimento = cd_estab_prescr_w;

	update 	prescr_procedimento
	set		ie_status_atend = ie_status_receb_lote_ext_w,
			nm_usuario = 'TasyLab', --nm_usuario_p,
			dt_atualizacao = clock_timestamp()
	where	nr_prescricao = nr_prescricao_p
	and		nr_sequencia = nr_seq_prescricao_p
	and		ie_status_atend < ie_status_receb_lote_ext_w;
end if;

select 	max(nr_seq_lote_externo)
into STRICT	nr_lote_ext_w
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia = nr_seq_prescricao_p;

if (coalesce(nr_lote_ext_w,0) > 0) then
	select 	count(*)
	into STRICT	qt_exame_lote_nao_aprov_w
	from 	prescr_procedimento
	where 	nr_seq_lote_externo = nr_lote_ext_w
	and 	ie_status_atend < 35;

	if (qt_exame_lote_nao_aprov_w = 0) then
		update 	lab_lote_externo
		set		dt_retorno = clock_timestamp()
		where	nr_sequencia = nr_lote_ext_w;
	end if;

end if;

--OS727249 - Ivan
--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_validar_result_gerado ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint) FROM PUBLIC;

