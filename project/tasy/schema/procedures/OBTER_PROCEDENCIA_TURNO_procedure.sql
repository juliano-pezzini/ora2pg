-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_procedencia_turno ( nr_seq_horario_p bigint, nr_seq_ageint_p bigint, ie_considera_proc_p INOUT text) AS $body$
DECLARE


cd_proc_agehor_w AGENDA_HORARIO.CD_PROCEDENCIA%TYPE;
cd_proc_ageint_w AGENDA_INTEGRADA.CD_PROCEDENCIA%TYPE;
cd_proc_agepro_w AGENDA_TURNO_PROCEDENCIA.CD_PROCEDENCIA%TYPE;
nr_seq_hor_sem_proced_w AGENDA_HORARIO.NR_SEQUENCIA%TYPE;
ie_exibe_proc_w varchar(1);


BEGIN

select coalesce(max(cd_procedencia),0)
  into STRICT cd_proc_ageint_w --27
  from agenda_integrada
 where nr_sequencia = nr_seq_ageint_p;

select coalesce(max(cd_procedencia),0)
  into STRICT cd_proc_agehor_w --6, 27
  from agenda_horario
 where nr_sequencia = nr_seq_horario_p;

select coalesce(max(cd_procedencia),0)
  into STRICT cd_proc_agepro_w --0, 0
  from agenda_turno_procedencia
 where nr_seq_horario = nr_seq_horario_p
   AND cd_procedencia = cd_proc_ageint_w;

if (cd_proc_ageint_w <> 0 and (cd_proc_agepro_w <> 0 or (cd_proc_agehor_w = cd_proc_ageint_w))) then
   	ie_exibe_proc_w := 'S';
else

select max(ah.nr_sequencia)
  into STRICT nr_seq_hor_sem_proced_w
  from agenda_horario ah
 where coalesce(ah.cd_procedencia::text, '') = ''
   and not exists (SELECT 1 from agenda_turno_procedencia atp where atp.nr_seq_horario = ah.nr_sequencia)
   and ah.nr_sequencia = nr_seq_horario_p;

	if ((nr_seq_hor_sem_proced_w IS NOT NULL AND nr_seq_hor_sem_proced_w::text <> '') or cd_proc_ageint_w = 0) then
		ie_exibe_proc_w := 'S';
	else
		ie_exibe_proc_w := 'N';
	end if;

end if;

ie_considera_proc_p := ie_exibe_proc_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_procedencia_turno ( nr_seq_horario_p bigint, nr_seq_ageint_p bigint, ie_considera_proc_p INOUT text) FROM PUBLIC;

