-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_reinternacao ( cd_pessoa_fisica_p text, qt_dias_reinternacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_considerada_p timestamp, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, dt_entrada_p timestamp, cd_perfil_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
dt_alta_w		timestamp;
nm_paciente_w		varchar(60);
qt_dia_w		bigint;
nr_atendimento_w	bigint;
ie_somente_internados_w	varchar(1);
qt_atend_convenio_w	integer;
qt_dia_regra_w		bigint;


BEGIN 
 
select	coalesce(obter_valor_param_usuario(916, 225, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N') 
into STRICT	ie_somente_internados_w
;
 
ds_erro_p	:= '';
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') 	and (qt_dias_reinternacao_p > 0)		then 
	begin 
   	select	trunc(max(a.dt_alta)), 
		substr(obter_nome_pf(a.cd_pessoa_fisica),1,100), 
		max(a.nr_atendimento) 
  	into STRICT	dt_alta_w, 
		nm_paciente_w, 
		nr_atendimento_w 
	from	atendimento_paciente a 
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
	and	(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
	and	((ie_somente_internados_w = 'S' and a.ie_tipo_atendimento = 1) or (ie_somente_internados_w = 'N' and a.ie_tipo_atendimento in (1,3,7,8))) 
	group by	a.cd_pessoa_fisica;
	exception 
		when others then 
		dt_alta_w	:= null;
	end;
 
	if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then 
		qt_dia_w	:= trunc(dt_considerada_p) - dt_alta_w;
		if (qt_dia_w <= qt_dias_reinternacao_p)	then 
			if (trunc(dt_considerada_p) = trunc(clock_timestamp())) then 
				ds_erro_p	:= wheb_mensagem_pck.get_texto(280502,'NM_PACIENTE='|| nm_paciente_w||';NR_ATENDIMENTO='|| nr_atendimento_w||';QT_DIA='|| qt_dia_w||';DT_ALTA='|| dt_alta_w);
			else 
				ds_erro_p	:= wheb_mensagem_pck.get_texto(280503,'NM_PACIENTE='|| nm_paciente_w||';NR_ATENDIMENTO='|| nr_atendimento_w||';QT_DIA='|| qt_dia_w||';DT_ALTA='|| dt_alta_w);
			end if;
		end if;
	end if;
	 
elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') 	and (qt_dias_reinternacao_p = 0)	then 
	 
	 
	select	max(qt_dia_reiternacao) 
	into STRICT	qt_dia_regra_w 
	from 	regra_convenio_reiternacao a 
	where  ((a.ie_tipo_atendimento = ie_tipo_atendimento_p) or (coalesce(a.ie_tipo_atendimento::text, '') = '')) 
	and	((a.cd_convenio = cd_convenio_p) or (coalesce(a.cd_convenio::text, '') = '')) 
	and   ((a.cd_perfil = cd_perfil_p) or (coalesce(a.cd_perfil::text, '') = ''));
	 
	if (qt_dia_regra_w IS NOT NULL AND qt_dia_regra_w::text <> '') then 
		begin 
		select	trunc(max(a.dt_alta)), 
			substr(obter_nome_pf(a.cd_pessoa_fisica),1,100), 
			coalesce(max(a.nr_atendimento),0) 
		into STRICT	dt_alta_w, 
			nm_paciente_w, 
			nr_atendimento_w 
		from	atendimento_paciente a, 
			atend_categoria_convenio b 
		where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
		and	(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '') 
		and   a.nr_atendimento = b.nr_atendimento 
		and	a.ie_tipo_atendimento = ie_tipo_atendimento_p 
		and 	b.cd_convenio = cd_convenio_p 
		group by	a.cd_pessoa_fisica;
		exception 
			when others then 
			dt_alta_w	:= null;
		end;
	 
		if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then 
			 
			qt_dia_w := trunc(dt_entrada_p) - dt_alta_w;
		 
		 
			if (qt_dia_w <= qt_dia_regra_w) then 
	 
				ds_erro_p	:= wheb_mensagem_pck.get_texto(280502,'NM_PACIENTE='|| nm_paciente_w||';NR_ATENDIMENTO='|| nr_atendimento_w||';QT_DIA='|| qt_dia_w||';DT_ALTA='|| dt_alta_w);
 
			end if;
		end if;
	end if;
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_reinternacao ( cd_pessoa_fisica_p text, qt_dias_reinternacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_considerada_p timestamp, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, dt_entrada_p timestamp, cd_perfil_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

