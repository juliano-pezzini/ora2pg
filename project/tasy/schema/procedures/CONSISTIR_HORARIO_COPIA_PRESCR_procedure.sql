-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_horario_copia_prescr (nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


DT_VALIDADE_PRESCR_w	timestamp;
DT_INICIO_PRESCR_w	timestamp;
dt_horario_w		timestamp;
hr_prim_horario_w	varchar(10);
ie_primeiro_horario_w	varchar(10);
hr_prim_horario_prescr_w timestamp;
dt_prim_horario_w	timestamp;
nr_seq_material_w	bigint;
nr_sequencia_w		bigint;
cd_material_w		integer;
qt_horas_intervalo_w	integer;

c01 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	TO_DATE(TO_CHAR(b.dt_prescricao,'dd/mm/yyyy') ||' '|| coalesce(a.hr_prim_horario,TO_CHAR(coalesce(b.dt_primeiro_horario,b.dt_prescricao),'hh24:mi')),'dd/mm/yyyy hh24:mi:ss'),
	obter_ocorrencia_intervalo(a.cd_intervalo, b.nr_horas_validade, 'H')
from	prescr_material a,
	prescr_medica b
where	a.nr_prescricao	= b.nr_prescricao
and	a.nr_prescricao	= nr_prescricao_p;

c02 CURSOR FOR
SELECT	dt_horario
from	prescr_horario_pre
where	nr_prescricao	= nr_prescricao_p
and	cd_material	= cd_material_w
and	nr_seq_material	= nr_seq_material_w
order by dt_horario;


BEGIN

delete	from prescr_mat_hor_copia
where	nr_prescricao	= nr_prescricao_p;

select	DT_INICIO_PRESCR,
	DT_VALIDADE_PRESCR
into STRICT	DT_INICIO_PRESCR_w,
	DT_VALIDADE_PRESCR_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

open c01;
loop
fetch c01 into
	nr_seq_material_w,
	cd_material_w,
	dt_prim_horario_w,
	qt_horas_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ie_primeiro_horario_w	:= 'N';

	open c02;
	loop
	fetch c02 into
		dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (dt_horario_w > DT_VALIDADE_PRESCR_w) then
			select	nextval('prescr_mat_hor_copia_seq')
			into STRICT	nr_sequencia_w
			;

			insert into prescr_mat_hor_copia(nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nr_prescricao,
				nr_seq_material,
				dt_horario,
				cd_material,
				ds_erro)
			values (nr_sequencia_w,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nr_prescricao_p,
				nr_seq_material_w,
				dt_horario_w,
				cd_material_w,
				obter_desc_expressao(781889)/*'Horário gerado supera a validade da prescrição'*/
);
		else
			if	((dt_prim_horario_w + qt_horas_intervalo_w/24) < dt_horario_w) and (ie_primeiro_horario_w = 'N') then

				select	nextval('prescr_mat_hor_copia_seq')
				into STRICT	nr_sequencia_w
				;

				insert into prescr_mat_hor_copia(nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_prescricao,
					nr_seq_material,
					dt_horario,
					cd_material,
					ds_erro)
				values (nr_sequencia_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_prescricao_p,
					nr_seq_material_w,
					dt_horario_w - qt_horas_intervalo_w/24,
					cd_material_w,
					obter_desc_expressao(781885)/*'Horário não foi gerado'*/
);
			else
				ie_primeiro_horario_w	:= 'S';
			end if;
		end if;

	end loop;
	close c02;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_horario_copia_prescr (nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

