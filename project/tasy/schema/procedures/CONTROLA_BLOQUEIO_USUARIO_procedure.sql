-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE controla_bloqueio_usuario () AS $body$
DECLARE


dt_inicio_vigencia_w	timestamp;
dt_fim_vigencia_w	timestamp;
nm_usuario_bloq_w	usuario_bloqueado.nm_usuario_bloqueio%type;
ie_motivo_bloqueio_w	usuario_bloqueado.ie_motivo_bloqueio%type;
ds_alteracao_w		usuario_hist.ds_alteracao%type;

c01 CURSOR FOR
	SELECT	b.nm_usuario_bloqueio,
		b.dt_inicio_vigencia,
		b.dt_fim_vigencia,
		b.ie_motivo_bloqueio
	from	usuario_bloqueado b,
		usuario a
	where	a.nm_usuario = b.nm_usuario_bloqueio
	and	a.ie_situacao = 'A'
	and	trunc(clock_timestamp()) between trunc(b.dt_inicio_vigencia) and trunc(coalesce(b.dt_fim_vigencia,clock_timestamp()));

c02 CURSOR FOR
	SELECT	b.nm_usuario_bloqueio,
		b.dt_inicio_vigencia,
		b.dt_fim_vigencia,
		b.ie_motivo_bloqueio
	from 	usuario_bloqueado b,
		usuario a
	where	a.nm_usuario = b.nm_usuario_bloqueio
	and	a.ie_situacao = 'B'
	and	trunc(b.dt_fim_vigencia)+1 = trunc(clock_timestamp());


BEGIN

open C01;
loop
fetch C01 into
	nm_usuario_bloq_w,
	dt_inicio_vigencia_w,
	dt_fim_vigencia_w,
	ie_motivo_bloqueio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_alteracao_w := substr(obter_desc_expressao(883354) || ' ' || obter_valor_dominio(4820,ie_motivo_bloqueio_w) ||  ': ' || to_char(dt_inicio_vigencia_w,'dd/mm/yyyy'),1,2000);
	if (dt_fim_vigencia_w IS NOT NULL AND dt_fim_vigencia_w::text <> '') then
		ds_alteracao_w := substr(ds_alteracao_w || ' ' || obter_desc_expressao(283845) || ' ' || to_char(dt_fim_vigencia_w,'dd/mm/yyyy'),1,2000);
	end if;

	update	usuario
	set	ie_situacao = 'B',
		dt_atualizacao = clock_timestamp(),
		nm_usuario_atual = 'JOB_USUARIO'
	where	nm_usuario = nm_usuario_bloq_w;

	insert into usuario_hist(
			nr_sequencia,
			nm_usuario,
			nm_usuario_ref,
			ds_alteracao,
			dt_atualizacao)
		values (nextval('usuario_hist_seq'),
			'JOB_USUARIO',
			nm_usuario_bloq_w,
			ds_alteracao_w,
		        clock_timestamp());
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nm_usuario_bloq_w,
	dt_inicio_vigencia_w,
	dt_fim_vigencia_w,
	ie_motivo_bloqueio_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	ds_alteracao_w := substr(obter_desc_expressao(883366) || ' ' || obter_valor_dominio(4820,ie_motivo_bloqueio_w) ||  ': ' ||
				to_char(dt_inicio_vigencia_w,'dd/mm/yyyy') || ' ' || obter_desc_expressao(283845) || ' ' || to_char(dt_fim_vigencia_w,'dd/mm/yyyy'),1,2000);

	update	usuario
	set	ie_situacao = 'A',
		dt_atualizacao = clock_timestamp(),
		nm_usuario_atual = 'JOB_USUARIO'
	where	nm_usuario = nm_usuario_bloq_w;

	insert into usuario_hist(
			nr_sequencia,
			nm_usuario,
			nm_usuario_ref,
			ds_alteracao,
			dt_atualizacao)
		values (nextval('usuario_hist_seq'),
			'JOB_USUARIO',
			nm_usuario_bloq_w,
			ds_alteracao_w,
		        clock_timestamp());
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE controla_bloqueio_usuario () FROM PUBLIC;

