-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_seq_agenda_propaci (nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_atendimento_w	bigint;
cd_procedimento_w	bigint;
dt_procedimento_w	timestamp;
nr_cirurgia_w		bigint;
CD_PESSOA_FISICA_w	varchar(10);
nr_Seq_agenda_w		agenda_paciente.nr_sequencia%type;
nr_prescricao_w		bigint;
cd_estabelecimento_w	bigint;
nm_usuario_w		varchar(15);
ie_atualiza_seq_agen_w	varchar(1);
cd_tipo_agenda_w	bigint;	


BEGIN

ie_atualiza_seq_agen_w := Obter_Param_Usuario(900, 373, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_seq_agen_w);

select	nr_atendimento,
	cd_procedimento,
	dt_procedimento,
	nr_cirurgia,
	nr_prescricao,
	coalesce(NM_USUARIO_ORIGINAL,NM_USUARIO)
into STRICT	nr_atendimento_w,
	cd_procedimento_w,
	dt_procedimento_w,
	nr_cirurgia_w,
	nr_prescricao_w,
	nm_usuario_w
from procedimento_paciente
where nr_sequencia = nr_sequencia_p;

SELECT 	CD_PESSOA_FISICA,
	cd_estabelecimento
into STRICT	CD_PESSOA_FISICA_w,
	cd_estabelecimento_w
FROM ATENDIMENTO_PACIENTE
WHERE NR_ATENDIMENTO = nr_atendimento_w;


select 	coalesce(max(nr_sequencia),0)
into STRICT	nr_Seq_agenda_w
from	agenda_paciente
where 	nr_cirurgia = nr_cirurgia_w;



IF (nr_Seq_agenda_w > 0) THEN

	select  max(a.cd_tipo_agenda)
	into STRICT	cd_tipo_agenda_w
	from    agenda a,
		agenda_paciente b
	where   a.cd_agenda = b.cd_agenda
	and     b.nr_sequencia = nr_seq_agenda_w;
	
	
	if (cd_tipo_agenda_w = 1) then
		CALL executar_evento_agenda('EPP', 'CI', nr_Seq_agenda_w, cd_estabelecimento_w, nm_usuario_w);
	else
		CALL executar_evento_agenda('EPP', 'E', nr_Seq_agenda_w, cd_estabelecimento_w, nm_usuario_w);
	end if;

END IF;

begin
if (ie_atualiza_seq_agen_w = 'S') then
	UPDATE AGENDA_PACIENTE
	SET IE_STATUS_AGENDA = 'E'
	WHERE CD_PROCEDIMENTO = cd_procedimento_w
	and ie_status_agenda not in ('C','L','B','F','I')
	AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_w
	and nr_sequencia = nr_Seq_agenda_w;
else
	UPDATE AGENDA_PACIENTE
	SET IE_STATUS_AGENDA = 'E'
	WHERE CD_PROCEDIMENTO = cd_procedimento_w
	AND ((DT_AGENDA < dt_procedimento_w) or (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(DT_AGENDA) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w)))
	and ie_status_agenda not in ('C','L','B','F','I') 
	AND CD_PESSOA_FISICA = CD_PESSOA_FISICA_w;
end if;
exception
when others then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(191165);
end;


commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_seq_agenda_propaci (nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

