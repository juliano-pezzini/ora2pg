-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_prescr_mat_lib_aut ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE




									  
nr_sequencia_w			prescr_material.nr_sequencia%type;
qt_total_dias_lib_w		prescr_material.qt_total_dias_lib%type;
									
c01 CURSOR FOR
SELECT	b.nr_sequencia,
	b.qt_total_dias_lib
from	prescr_material b,
	prescr_medica a,
	material c
where	a.nr_prescricao     = b.nr_prescricao
and		a.nr_prescricao 	= nr_prescricao_p
and		b.cd_material		= c.cd_material 
and		obter_se_lib_aut_antimic(c.cd_material, a.cd_perfil_ativo, a.cd_estabelecimento, nm_usuario_p, b.cd_intervalo, a.cd_setor_atendimento, b.ie_objetivo) = 'S'
and 	coalesce(b.nr_sequencia_diluicao::text, '') = ''
and		coalesce(b.nr_sequencia_proc::text, '') = ''
and		coalesce(b.nr_sequencia_dieta::text, '') = ''
and		coalesce(b.nr_sequencia_solucao::text, '') = ''
and		coalesce(b.nr_seq_gasoterapia::text, '') = ''
and		coalesce(b.nr_seq_leite_deriv::text, '') = ''
and		coalesce(b.nr_seq_kit::text, '') = ''
and		b.ie_suspenso 			<> 'S'
and		c.ie_dias_util_medic 	<> 'N'
and		coalesce(b.qt_total_dias_lib,0)  > 0
and		coalesce(b.qt_dias_liberado,0)   > 0
and		coalesce(b.qt_dias_solicitado,0) > 0
and		b.ie_agrupador 			= 1;


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	qt_total_dias_lib_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	insert into prescr_material_lib_cih(nr_sequencia,
				 dt_atualizacao,
				 nm_usuario,
				 dt_atualizacao_nrec,
				 nm_usuario_nrec,
				 nr_prescricao,
				 nr_seq_material,
				 ie_tipo_liberacao,
				 qt_liberacao
				)
	values (nextval('prescr_material_lib_cih_seq'),
				 clock_timestamp(),
				 nm_usuario_p,
				 clock_timestamp(),
				 nm_usuario_p,
				 nr_prescricao_p,
				 nr_sequencia_w,
				 'T',
				 qt_total_dias_lib_w
				); 		
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_prescr_mat_lib_aut ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

