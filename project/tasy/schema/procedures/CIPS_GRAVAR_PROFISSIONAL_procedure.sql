-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cips_gravar_profissional ( nm_pessoa_fisica_p text,/*nome*/
 dt_nascimento_p text,/*dtNascimento*/
 nr_cpf_p text,/*numeroCPF*/
 nr_rg_p text,/*numeroRG*/
								/**/
 cd_naturalidade_p text,/*naturalidade*/

 cd_nacionalidade_p text,/*nacionalidade*/
 ie_estado_civil_p text,/*estado_civil*/
								/**/
 ie_status_profissao_p text,/*statusProfissionalCIPS*/

								/**/
 cd_profissao_p text,/*profissao*/

 ie_tipo_conselho_p text,/*conselhoProfissional tipo*/
 nr_conselho_p text,/*conselhoProfissional numero*/
 uf_conselho_p text,/*conselhoProfissional uf*/
 cd_cep_p text,/*endereco cep*/
 cd_logradouro_p text,/*endereco logradouro*/
 nr_endereco_p text,/*endereco numero*/
 ds_complemento_p text,/*endereco complemento*/
 ds_bairro_p text,/*endereco bairro*/
 nm_cidade_p text,/*endereco cidade*/
 uf_endereco_p text,/*endereco uf*/
 nr_ddd_telefone_p text,/*contatoTelefonico ddd fisico*/
 nr_telefone_p text,/*contatoTelefonico fisico*/
 nr_ddd_telefone_celular_p text,/*contatoTelefonico ddd movel*/
 nr_telefone_celular_p text,/*contatoTelefonico movel*/
 ds_email_p text,/*emails*/
 cd_corportativo_p text/*codCorportativoUnidade*/
 ) AS $body$
DECLARE


cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
cd_medico_w					medico.cd_pessoa_fisica%type;
nr_seq_compl_pf_w			compl_pessoa_fisica.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_nacionalidade_w			nacionalidade.cd_nacionalidade%type;
nr_seq_conselho_w			CONSELHO_PROFISSIONAL.nr_sequencia%type;


BEGIN

select	max(a.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	med_integracao a
where	a.cd_externo = cd_corportativo_p
and		a.ie_cips_ativo = 'S';

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

	select	max(a.cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	pessoa_fisica a
	where	to_char(a.dt_nascimento, 'yyyy-mm-dd') = dt_nascimento_p
	and		a.nr_cpf = nr_cpf_p
	and		a.cd_estabelecimento = cd_estabelecimento_w;

	select	max(a.cd_nacionalidade)
	into STRICT	cd_nacionalidade_w
	from	nacionalidade a
	where	a.cd_externo = cd_nacionalidade_p;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_conselho_w
	from	CONSELHO_PROFISSIONAL a
	where	SG_CONSELHO = IE_TIPO_CONSELHO_P
	and		a.ie_situacao = 'A';

	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then

		select	nextval('pessoa_fisica_seq')
		into STRICT 	cd_pessoa_fisica_w
		;

		insert into pessoa_fisica(	cd_pessoa_fisica,
									nm_pessoa_fisica,
									dt_nascimento,
									nr_cpf,
									nr_identidade,
									cd_nacionalidade,
									ie_estado_civil,
									ie_tipo_pessoa,
									DT_ATUALIZACAO,
									DT_ATUALIZACAO_NREC,
									NM_USUARIO,
									NM_USUARIO_nrec,
									nr_ddd_celular,
									nr_telefone_celular,
									cd_estabelecimento,
									nr_seq_conselho
									)
						values (		cd_pessoa_fisica_w,
									nm_pessoa_fisica_p,
									to_date(dt_nascimento_p,'yyyy-mm-dd'),
									nr_cpf_p,
									nr_rg_p,
									cd_nacionalidade_w,
									CASE WHEN 	ie_estado_civil_p='SOLTEIRO' THEN  1 WHEN 	ie_estado_civil_p='CASADO' THEN  2 WHEN 	ie_estado_civil_p='SEPARADO_JUDICIALMENTE' THEN  3 WHEN 	ie_estado_civil_p='VIUVO' THEN  5 WHEN 	ie_estado_civil_p='UNIAO_CONCENSUAL' THEN 																'IGNORADO'  ELSE 9 END ,
									1,
									clock_timestamp(),
									clock_timestamp(),
									'Integracao CIPS',
									'Integracao CIPS',
									nr_ddd_telefone_celular_p,
									nr_telefone_celular_p,
									cd_estabelecimento_w,
									nr_seq_conselho_w
								);

	else


		update	pessoa_fisica
		set		nm_pessoa_fisica = nm_pessoa_fisica_p,
				nr_identidade = nr_rg_p,
				cd_nacionalidade = cd_nacionalidade_w,
				ie_estado_civil = CASE WHEN 	ie_estado_civil_p='SOLTEIRO' THEN  1 WHEN 	ie_estado_civil_p='CASADO' THEN  2 WHEN 	ie_estado_civil_p='SEPARADO_JUDICIALMENTE' THEN  3 WHEN 	ie_estado_civil_p='VIUVO' THEN  5 WHEN 	ie_estado_civil_p='UNIAO_CONCENSUAL' THEN 																'IGNORADO'  ELSE 9 END ,
				DT_ATUALIZACAO = clock_timestamp(),
				NM_USUARIO = 'Integracao CIPS',
				nr_ddd_celular = nr_ddd_telefone_celular_p,
				nr_telefone_celular = nr_telefone_celular_p/*,
				nr_seq_conselho = nr_seq_conselho_w*/
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	end if;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_compl_pf_w
	from 	compl_pessoa_fisica a
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_w
	and		a.ie_tipo_complemento = 1;

	if (coalesce(nr_seq_compl_pf_w::text, '') = '') then

		select	coalesce(max(a.nr_sequencia),0)+1
		into STRICT	nr_seq_compl_pf_w
		from 	compl_pessoa_fisica a
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

		insert into compl_pessoa_fisica(	nr_sequencia,
											cd_pessoa_fisica,
											ie_tipo_complemento,
											cd_cep,
											DS_ENDERECO,
											NR_ENDERECO,
											ds_complemento,
											ds_bairro,
											ds_municipio,
											sg_estado,
											DS_EMAIL,
											nr_ddd_telefone,
											NR_TELEFONE,
											NR_DDD_FONE_ADIC,
											DS_FONE_ADIC,
											dt_atualizacao,
											dt_atualizacao_nrec,
											nm_usuario,
											nm_usuario_nrec
										)
									values (	nr_seq_compl_pf_w,
											cd_pessoa_fisica_w,
											1,
											cd_cep_p,
											cd_logradouro_p,
											nr_endereco_p,
											ds_complemento_p,
											ds_bairro_p,
											nm_cidade_p,
											uf_endereco_p,
											ds_email_p,
											nr_ddd_telefone_p,
											nr_telefone_p,
											nr_ddd_telefone_celular_p,
											nr_telefone_celular_p,
											clock_timestamp(),
											clock_timestamp(),
											'Integracao CIPS',
											'Integracao CIPS'
									);
	else

		update	compl_pessoa_fisica
		set		cd_cep = cd_cep_p,
				DS_ENDERECO = cd_logradouro_p,
				NR_ENDERECO = nr_endereco_p,
				ds_complemento = ds_complemento_p,
				ds_bairro = ds_bairro_p,
				ds_municipio = nm_cidade_p,
				sg_estado = uf_endereco_p,
				DS_EMAIL = ds_email_p,
				nr_ddd_telefone = nr_ddd_telefone_p,
				NR_TELEFONE = nr_telefone_p,
				NR_DDD_FONE_ADIC = nr_ddd_telefone_celular_p,
				DS_FONE_ADIC = nr_telefone_celular_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = 'Integracao CIPS'
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w
		and		nr_sequencia = nr_seq_compl_pf_w;

	end if;

	select	max(a.cd_pessoa_fisica)
	into STRICT	cd_medico_w
	from	medico a,
			pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and		b.nr_seq_conselho = nr_seq_conselho_w
	and		a.nr_crm = nr_conselho_p
	and		a.uf_crm = uf_conselho_p;

	if (coalesce(cd_medico_w::text, '') = '') then

		insert into medico(	cd_pessoa_fisica,
							nm_guerra,
							nr_crm,
							uf_crm,
							ie_vinculo_medico,
							dt_atualizacao,
							dt_atualizacao_nrec,
							nm_usuario,
							nm_usuario_nrec,
							ie_situacao,
							ie_corpo_clinico,
							ie_corpo_assist,
							IE_INTEGRADO)
				values (	cd_pessoa_fisica_w,
							substr(nm_pessoa_fisica_p,1,60),
							nr_conselho_p,
							uf_conselho_p,
							14, --Externo
							clock_timestamp(),
							clock_timestamp(),
							'Integracao CIPS',
							'Integracao CIPS',
							'A',
							'S',
							'S',
							'S');

	else

		update	medico
		set		nm_guerra = substr(nm_pessoa_fisica_p,1,60),
				nr_crm = nr_conselho_p,
				uf_crm = uf_conselho_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = 'Integracao CIPS',
				IE_INTEGRADO = 'S'
		where	cd_pessoa_fisica = cd_medico_w;

	end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cips_gravar_profissional ( nm_pessoa_fisica_p text, dt_nascimento_p text, nr_cpf_p text, nr_rg_p text, cd_naturalidade_p text, cd_nacionalidade_p text, ie_estado_civil_p text, ie_status_profissao_p text, cd_profissao_p text, ie_tipo_conselho_p text, nr_conselho_p text, uf_conselho_p text, cd_cep_p text, cd_logradouro_p text, nr_endereco_p text, ds_complemento_p text, ds_bairro_p text, nm_cidade_p text, uf_endereco_p text, nr_ddd_telefone_p text, nr_telefone_p text, nr_ddd_telefone_celular_p text, nr_telefone_celular_p text, ds_email_p text, cd_corportativo_p text ) FROM PUBLIC;

