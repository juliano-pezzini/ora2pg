-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_avaliacao_precad ( nr_seq_processo_p bigint, nr_tipo_avaliacao_p bigint, nr_nivel_p bigint, nm_usuario_p text ) AS $body$
DECLARE


ds_remetente_w			varchar(255);
ds_destinatarios_w		varchar(1000);
ie_primeiro_w 			varchar(1) := 'S';
nm_usuario_w			usuario_processo_aval.nm_usuario_avaliacao%type;
ds_destinatario_w		varchar(255);	
ds_adress_w				varchar(255);
nr_seq_avaliacao_w 		pre_cad_avaliacao.nr_sequencia%type;
nr_atendimento_w		bigint;
ds_texto_w				varchar(1000);
ie_tipo_pro_w 			processo_avaliacao.ie_tipo_processo%type;
cd_tipo_pessoa_w		processo_avaliacao.cd_tipo_pessoa%type := null;
			
c_destinatarios CURSOR FOR
SELECT nm_usuario_avaliacao from usuario_processo_aval usu, processo_avaliacao pa 
where pa.nr_sequencia = usu.nr_processo_aval 
and pa.nr_tipo_avaliacao = nr_tipo_avaliacao_p
and pa.nr_nivel 		 = nr_nivel_p
and pa.ie_tipo_processo	 = ie_tipo_pro_w
and coalesce(pa.cd_tipo_pessoa, 0)	 = coalesce(cd_tipo_pessoa_w, 0);


BEGIN

	select
		pro.ie_tipo_processo
	into STRICT
		ie_tipo_pro_w
	from	
		processo_pre_cadastro pro
	where	
		pro.nr_sequencia = nr_seq_processo_p;
		
	if (ie_tipo_pro_w = 'FPF') then
		select
			pf.cd_tipo_pj
		into STRICT
			cd_tipo_pessoa_w
		from 
			pessoa_fisica_precad pf
		where pf.nr_seq_processo = nr_seq_processo_p;
			
	elsif (ie_tipo_pro_w = 'FPJ') then
		select
			pj.cd_tipo_pessoa
		into STRICT
			cd_tipo_pessoa_w
		from 
			pessoa_juridica_precad pj
		where pj.nr_seq_processo = nr_seq_processo_p;
		
	elsif (ie_tipo_pro_w = 'MAT') then
		cd_tipo_pessoa_w := 0;
		
	end if;
		

	open c_destinatarios;
	loop
	fetch c_destinatarios into	nm_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on c_destinatarios */
		begin
			select max(obter_compl_pf(usu.cd_pessoa_fisica, 1, 'M'))
			into STRICT ds_destinatario_w
			from usuario usu
			where nm_usuario = nm_usuario_w;
			
			if (ds_destinatario_w IS NOT NULL AND ds_destinatario_w::text <> '') then
				if (ie_primeiro_w = 'N') then
					ds_destinatarios_w := ds_destinatarios_w || ','  || ds_destinatario_w;
				else
					ds_destinatarios_w := ds_destinatario_w;
					ie_primeiro_w := 'N';
				end if;
			end if;
		end;
	end loop;
	close c_destinatarios;
	
	select max(obter_compl_pf(usu.cd_pessoa_fisica, 1, 'M'))
	into STRICT ds_remetente_w
	from usuario usu where nm_usuario = nm_usuario_p;

	if (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '' AND ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') then
		select max(nr_sequencia) 
		into STRICT nr_seq_avaliacao_w
		from PRE_CAD_AVALIACAO
		order by nr_sequencia desc;
		ds_texto_w	:= 'Foi gerada uma avaliação do tipo pre-cadastro para os seguintes e-mails: ' || ds_destinatarios_w;
		ds_adress_w := Wheb_assist_pck.obterParametroFuncao(0,216);

		CALL enviar_email('PRE-CAD',
				ds_texto_w || ' ' ||ds_adress_w||'/#/comcadpr/'||nr_seq_processo_p||'/'||nr_seq_avaliacao_w,
				ds_remetente_w,
				ds_destinatarios_w,
				nm_usuario_p,
				'M');

	end if;

	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_avaliacao_precad ( nr_seq_processo_p bigint, nr_tipo_avaliacao_p bigint, nr_nivel_p bigint, nm_usuario_p text ) FROM PUBLIC;

