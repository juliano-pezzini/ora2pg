-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE genrate_file_content (nr_seq_file_p bigint, ds_file_type text, nm_usuario_p text) AS $body$
DECLARE

  ds_conteudo_unb_w       varchar(255);
  ds_conteudo_unz_w       varchar(255);
  ds_dataset_conteudo_w   text := '';
  ds_content_w            text := empty_clob;
  excp_caught_in_file_gen varchar(500 );
  --fetch the data set contents  
  c_dataset_content CURSOR(
    nr_seq_arquio_pc bigint) FOR 
    SELECT a.ds_dataset_contents 
    FROM   qhapdc_dataset_content a, 
           qhapdc_dataset_send b 
    WHERE  a.nr_seq_dataset_send = b.nr_sequencia 
           AND b.nr_seq_arquivo = nr_seq_arquio_pc 
    ORDER  BY b.nr_atendimento, 
              b.nr_ordem;
BEGIN
    IF ( position('.DVA' in ds_file_type) > 0 ) THEN 
      excp_caught_in_file_gen := Rpad(' ', 5, ' ');
    ELSE 
      IF ( position('.MOR' in ds_file_type) > 0 ) THEN 
        excp_caught_in_file_gen := Rpad(' ', 66, ' ');
      ELSE 
        IF ( position('.MEN' in ds_file_type) > 0 ) THEN 
          excp_caught_in_file_gen := Rpad(' ', 2, ' ');
        ELSE 
          IF ( position('.PAT' in ds_file_type) > 0 ) THEN 
            excp_caught_in_file_gen := Rpad(' ', 238, ' ');
          ELSE 
            IF ( position('.ADM' in ds_file_type) > 0 ) THEN 
              excp_caught_in_file_gen := Rpad(' ', 139, ' ');
            ELSE 
              IF ( position('.ACT' in ds_file_type) > 0 ) THEN 
                excp_caught_in_file_gen := Rpad(' ', 25, ' ');
              ELSE 
                IF ( position('.SNP' in ds_file_type) > 0 ) THEN 
                  excp_caught_in_file_gen := Rpad(' ', 31, ' ');
                END IF;
              END IF;
            END IF;
          END IF;
        END IF;
      END IF;
    END IF;

    -- fetch the header contents  
    SELECT Lpad(a.nr_seq_file, 5, '0') 
           || To_char(a.dt_extract_start, 'yyyymmdd') 
           || To_char(a.dt_extract_end, 'yyyymmdd') 
           || a.ie_syntax 
           || Lpad(a.number_of_records, 5, '0') 
           || Rpad(a.extraction_software_id, 10, ' ') 
           || excp_caught_in_file_gen 
    --   || --CASE ds_file_type  --Rpad(' ', 5, ' ')   

    --              WHEN 'MOR' THEN  Rpad(' ', 66, ' ') 

    --              WHEN 'MEN' THEN  Rpad(' ', 2, ' ') 

    --              END 

    -- for differnt files the filler is different write logic for this 
    INTO STRICT   ds_content_w 
    FROM   qhapdc_segment_header a 
    WHERE  a.nr_seq_file = nr_seq_file_p;

    FOR r_c_conteudo_dataset IN c_dataset_content(nr_seq_file_p) LOOP 
        SELECT Concat(ds_content_w, ( r_c_conteudo_dataset.ds_dataset_contents ) 
               --                             Chr  

               -- 

               --                             (13)  

               -- 

               --              ||  

               -- 

               --        Chr(10))  
               ) 
        INTO STRICT   ds_content_w 
;
    END LOOP;

    INSERT INTO qhapdc_file_data(nr_sequencia, 
                 dt_atualizacao, 
                 nm_usuario, 
                 dt_atualizacao_nrec, 
                 nm_usuario_nrec, 
                 nr_seq_file, 
                 ds_file_content) 
    VALUES (nextval('qhapdc_file_data_seq'), 
                 clock_timestamp(), 
                 nm_usuario_p, 
                 clock_timestamp(), 
                 nm_usuario_p, 
                 nr_seq_file_p, 
                 ds_content_w);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE genrate_file_content (nr_seq_file_p bigint, ds_file_type text, nm_usuario_p text) FROM PUBLIC;

