-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_glosa_valor_mat (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	smallint;
nr_atendimento_w		bigint;
ie_tipo_atendimento_w	smallint;
dt_preco_w			timestamp;
dt_entrada_w		timestamp;
dt_alta_w			timestamp;
dt_altap_w			timestamp;
dt_conta_w			timestamp;
dt_conta_real_w		timestamp;
cd_material_w		integer;
cd_tipo_acomodacao_w	smallint;
cd_setor_atendimento_w	integer;
cd_cgc_fornecedor_w	varchar(14);
vl_preco_material_w	double precision;
dt_ult_vigencia_w		timestamp := clock_timestamp();
cd_tab_preco_mat_w	smallint;
ie_origem_preco_w		smallint;
nr_doc_convenio_w		varchar(20);
dt_acerto_conta_w		timestamp;
nr_interno_conta_w	bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
cd_convenio_calculo_w	integer;
cd_categoria_calculo_w	varchar(10);
qt_original_w		double precision;
vl_preco_original_w	double precision;
vl_unitario_original_w	double precision;
nr_sequencia_w		bigint;
nr_seq_bras_preco_w	bigint;
nr_seq_mat_bras_w	bigint;
nr_seq_conv_bras_w	bigint;
nr_seq_conv_simpro_w	bigint;
nr_seq_mat_simpro_w	bigint;
nr_seq_simpro_preco_w	bigint;
cd_tab_preco_mat_regra_w	smallint;
qt_preco_mat_w			bigint;
dt_alta_preco_w		timestamp;
nr_seq_ajuste_mat_w	bigint;
nr_seq_classif_atend_w	atendimento_paciente.nr_seq_classificacao%type;


BEGIN

select coalesce(min(nr_sequencia),0)
into STRICT nr_sequencia_w
from material_atend_paciente
where (nr_atendimento, dt_entrada_unidade, cd_material, dt_atendimento, cd_setor_atendimento) =
	(SELECT nr_atendimento, dt_entrada_unidade, cd_material, dt_atendimento, cd_setor_atendimento
	 from material_atend_paciente
	 where nr_sequencia = nr_sequencia_p)
  and nr_sequencia <> nr_sequencia_p
  and qt_material = 0;

RAISE NOTICE '%', nr_sequencia_w;
if (nr_sequencia_w = 0) then
	select	a.cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	material_atend_paciente b,
		atendimento_paciente a
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_sequencia	= nr_sequencia_p;

	SELECT * FROM obter_convenio_particular(cd_estabelecimento_w, CD_CONVENIO_W, CD_CATEGORIA_W) INTO STRICT CD_CONVENIO_W, CD_CATEGORIA_W;

	RAISE NOTICE '% %', CD_CONVENIO_W, CD_CATEGORIA_W;

	select nextval('material_atend_paciente_seq')
	into STRICT nr_sequencia_w
	;

	insert into material_atend_paciente(nr_sequencia, nr_atendimento, dt_entrada_unidade,
		 cd_material, dt_atendimento, cd_unidade_medida,
		 qt_material, dt_atualizacao, nm_usuario,
		 cd_convenio, cd_categoria, dt_prescricao,
		 cd_material_prescricao, ie_via_aplicacao, ds_observacao,
		 vl_material, cd_tab_preco_material, dt_vigencia_tabela,
		 dt_acerto_conta, dt_acerto_convenio, nr_prescricao,
		 nr_sequencia_prescricao, cd_motivo_exc_conta, ds_compl_motivo_excon,
		 cd_local_estoque, dt_atualizacao_estoque, cd_acao,
		 cd_setor_atendimento, qt_devolvida, cd_motivo_devolucao,
		 nr_cirurgia, nr_doc_convenio, qt_executada,
		 dt_conta, vl_unitario, cd_proced_referencia,
		 cd_conta_contabil, qt_ajuste_conta, nr_aih,
		 ie_valor_informado, cd_estabelecimento_custo, cd_tabela_custo,
		 cd_situacao_glosa, nr_lote_contabil, cd_material_convenio,
		 nr_seq_autorizacao, nr_interno_conta, nr_seq_proc_princ,
		 ie_guia_informada, cd_especialidade, nm_usuario_original,
		 nr_seq_proc_pacote, vl_tabela_original, ie_emite_conta,
		 cd_setor_receita, cd_cgc_fornecedor, nr_seq_lote_fornec,
		 cd_material_exec, nr_seq_atepacu, ie_tipo_guia, ie_auditoria,nr_seq_aih)
	SELECT nr_sequencia_w, nr_atendimento, dt_entrada_unidade,
		 cd_material, dt_atendimento, cd_unidade_medida,
		 0, dt_atualizacao, nm_usuario,
		 cd_convenio_w, cd_categoria_w, null,
		 null, ie_via_aplicacao, ds_observacao,
		 vl_material, cd_tab_preco_material, dt_vigencia_tabela,
		 dt_acerto_conta, dt_acerto_convenio, null,
		 null, cd_motivo_exc_conta, ds_compl_motivo_excon,
		 null, null, cd_acao,
		 cd_setor_atendimento, qt_devolvida, cd_motivo_devolucao,
		 null, nr_doc_convenio, qt_executada,
		 dt_conta, vl_unitario, null,
		 cd_conta_contabil, qt_ajuste_conta, nr_aih,
		 ie_valor_informado, null, null,
		 cd_situacao_glosa, null, cd_material_convenio,
		 nr_seq_autorizacao, null, null,
		 ie_guia_informada, cd_especialidade, nm_usuario_original,
		 null, vl_tabela_original, ie_emite_conta,
		 cd_setor_receita, cd_cgc_fornecedor, nr_seq_lote_fornec,
		 cd_material_exec, nr_seq_atepacu, ie_tipo_guia, ie_auditoria,nr_seq_aih
	from material_atend_paciente
	where nr_sequencia = nr_sequencia_p;
end if;

select b.cd_estabelecimento,
	 b.nr_atendimento,
	 b.ie_tipo_atendimento,
	 b.dt_entrada,
	 coalesce(dt_alta,pkg_date_utils.get_dateTime(1900, 1, 1)),
	 coalesce(b.dt_alta,clock_timestamp()),
	 coalesce(a.DT_CONTA, coalesce(a.DT_PRESCRICAO, a.DT_ATENDIMENTO)),
	 coalesce(a.dt_conta, a.dt_atendimento),
	 a.cd_material,
	 a.cd_setor_atendimento,
	 a.cd_cgc_fornecedor,
	 a.nr_doc_convenio,
	 a.qt_material,
	 a.vl_material,
	 a.vl_unitario,
	 b.dt_alta,
	 b.nr_seq_classificacao
into STRICT	cd_estabelecimento_w,
	nr_atendimento_w,
	ie_tipo_atendimento_w,
	dt_entrada_w,
	dt_alta_w,
	dt_altap_w,
	dt_conta_w,
	dt_conta_real_w,
	cd_material_w,
	cd_setor_atendimento_w,
	cd_cgc_fornecedor_w,
	nr_doc_convenio_w,
	qt_original_w,
	vl_preco_original_w,
	vl_unitario_original_w,
	dt_alta_preco_w,
	nr_seq_classif_atend_w
from	atendimento_paciente b,
	material_atend_paciente a
where a.nr_atendimento = b.nr_atendimento
  and a.nr_sequencia = nr_sequencia_p;

select cd_convenio,
	 cd_categoria
into STRICT	cd_convenio_w,
	cd_categoria_w
from material_atend_paciente
where nr_sequencia = nr_sequencia_w;

if (dt_conta_real_w < dt_entrada_w) then
	dt_conta_real_w := dt_entrada_w;
end if;
	
select	coalesce(max(cd_tipo_acomodacao),0)
into STRICT		cd_tipo_acomodacao_w
from		atend_categoria_convenio_v
where		nr_atendimento		= nr_atendimento_w
  and		cd_convenio			= cd_convenio_w
  and		cd_categoria		= cd_categoria_w;


select 	coalesce(max(cd_tab_preco_mat),0)
into STRICT	cd_tab_preco_mat_regra_w
from 	regra_data_preco_mat
where 	ie_situacao = 'A'
and 	cd_convenio = cd_convenio_w
and 	cd_estabelecimento = cd_estabelecimento_w;

qt_preco_mat_w:= 0;
if (cd_tab_preco_mat_regra_w > 0) then
	select 	count(*)
	into STRICT	qt_preco_mat_w
	from 	preco_material
	where 	cd_tab_preco_mat = cd_tab_preco_mat_regra_w
	and 	cd_estabelecimento    = cd_estabelecimento_w
	and 	cd_material	      = cd_material_w
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(dt_final_vigencia, dt_conta_w);
end if;

if (qt_preco_mat_w > 0) then

	dt_preco_w:= dt_conta_w;

else
  
	select obter_regra_data_preco('M',cd_convenio_w, dt_entrada_w, dt_conta_w, dt_alta_preco_w, dt_conta_w, null, null, clock_timestamp())
	into STRICT	dt_preco_w
	;
	
end if;

SELECT * FROM Define_Preco_Material(	cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, dt_preco_w, cd_material_w, cd_tipo_acomodacao_w, ie_tipo_atendimento_w, cd_setor_atendimento_w, cd_cgc_fornecedor_w, nr_sequencia_w, 0, null, null, null, null, null, nr_seq_classif_atend_w, null, null, vl_preco_material_w, dt_ult_vigencia_w, cd_tab_preco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuste_mat_w) INTO STRICT vl_preco_material_w, dt_ult_vigencia_w, cd_tab_preco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuste_mat_w;

SELECT * FROM Obter_conta_paciente(	cd_estabelecimento_w, nr_atendimento_w, cd_convenio_w, cd_categoria_w, nm_usuario_p, dt_conta_real_w, dt_entrada_w, dt_alta_w, nr_doc_convenio_w, cd_setor_atendimento_w, null, dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w) INTO STRICT dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w;

vl_preco_material_w := ((qt_original_w * vl_preco_material_w) - vl_preco_original_w);

update material_atend_paciente
set	vl_material = vl_preco_material_w,
	vl_unitario = vl_unitario_original_w,
	dt_acerto_conta = dt_acerto_conta_w,
	nr_interno_conta = nr_interno_conta_w,
	dt_vigencia_tabela = dt_ult_vigencia_w,
	cd_tab_preco_material = cd_tab_preco_mat_w,
	ie_valor_informado = 'S'
where nr_sequencia = nr_sequencia_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_glosa_valor_mat (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

