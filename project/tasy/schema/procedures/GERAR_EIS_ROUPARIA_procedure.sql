-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_rouparia ( dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE



qt_peca_origem_w			eis_rouparia.qt_peca_origem%type;
qt_peca_destino_w			eis_rouparia.qt_peca_destino%type;
qt_peso_origem_w			eis_rouparia.qt_peso_origem%type;
qt_peso_destino_w			eis_rouparia.qt_peso_destino%type;
dt_liberacao_w				eis_rouparia.dt_liberacao%type;
cd_estabelecimento_w			eis_rouparia.cd_estabelecimento%type;
ie_periodo_w				eis_rouparia.ie_periodo%type;
cd_setor_w				eis_rouparia.cd_setor%type;
nr_seq_local_w				eis_rouparia.nr_seq_local%type;
nr_seq_personalizacao_w			eis_rouparia.nr_seq_personalizacao%type;
nr_seq_tipo_w				eis_rouparia.nr_seq_tipo%type;
nr_seq_tamanho_w			eis_rouparia.nr_seq_tamanho%type;
nr_seq_operacao_w			eis_rouparia.nr_seq_operacao%type;
qt_dias_w				eis_rouparia.qt_dias_sem_movto%type;
qt_dias_sem_movto_w			eis_rouparia.qt_dias_sem_movto%type;

c01 CURSOR FOR
SELECT	1 qt_peca_origem,
 	0 qt_peca_destino,
	c.qt_peso qt_peso_origem,
	0 qt_peso_destino,
	trunc(a.dt_liberacao,'dd') dt_liberacao,
	a.cd_estabelecimento,
	'D' ie_periodo,
	rop_obter_setor_local(a.nr_seq_local) cd_setor,
	a.nr_seq_local,
	c.nr_seq_personalizacao,
	c.nr_seq_tipo,
	c.nr_seq_tamanho,
	a.nr_seq_operacao,
	rop_obter_dias_sem_movto(b.nr_seq_roupa) qt_dias
from	rop_lote_movto a,
	rop_movto_roupa b,
	rop_lote_roupa c,
	rop_roupa d
where	a.nr_sequencia = b.nr_seq_lote
and	d.nr_seq_lote_roupa = c.nr_sequencia
and	d.nr_sequencia = b.nr_seq_roupa
and	trunc(a.dt_liberacao,'mm') = trunc(dt_parametro_p,'mm')

union all

select	0 qt_peca_origem,
 	1 qt_peca_destino,
	0 qt_peso_origem,
	c.qt_peso qt_peso_destino,
	trunc(a.dt_liberacao,'dd') dt_liberacao,
	a.cd_estabelecimento,
	'D' ie_periodo,
	rop_obter_setor_local(a.nr_seq_local) cd_setor,
	a.nr_seq_local_orig_dest nr_seq_local,
	c.nr_seq_personalizacao,
	c.nr_seq_tipo,
	c.nr_seq_tamanho,
	a.nr_seq_operacao,
	rop_obter_dias_sem_movto(b.nr_seq_roupa) qt_dias
from	rop_lote_movto a,
	rop_movto_roupa b,
	rop_lote_roupa c,
	rop_roupa d
where	a.nr_sequencia = b.nr_seq_lote
and	d.nr_seq_lote_roupa = c.nr_sequencia
and	d.nr_sequencia = b.nr_seq_roupa
and	trunc(a.dt_liberacao,'mm') = trunc(dt_parametro_p,'mm');



BEGIN

delete from eis_rouparia
where dt_referencia = dt_parametro_p;

open C01;
loop
fetch C01 into
	qt_peca_origem_w,
 	qt_peca_destino_w,
	qt_peso_origem_w,
	qt_peso_destino_w,
	dt_liberacao_w,
	cd_estabelecimento_w,
	ie_periodo_w,
	cd_setor_w,
	nr_seq_local_w,
	nr_seq_personalizacao_w,
	nr_seq_tipo_w,
	nr_seq_tamanho_w,
	nr_seq_operacao_w,
	qt_dias_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	qt_dias_sem_movto_w := dividir(qt_dias_w,qt_peca_destino_w);

	insert into eis_rouparia(
		nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_referencia,
		ie_periodo,
		dt_liberacao,
		nr_seq_local,
		cd_setor,
		nr_seq_operacao,
		nr_seq_personalizacao,
		nr_seq_tipo,
		nr_seq_tamanho,
		qt_peca_destino,
		qt_peca_origem,
		qt_peso_destino,
		qt_peso_origem,
		qt_dias_sem_movto)
	values (	nextval('eis_rouparia_seq'),
		cd_estabelecimento_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_parametro_p,
		ie_periodo_w,
		dt_liberacao_w,
		nr_seq_local_w,
		cd_setor_w,
		nr_seq_operacao_w,
		nr_seq_personalizacao_w,
		nr_seq_tipo_w,
		nr_seq_tamanho_w,
		qt_peca_destino_w,
		qt_peca_origem_w,
		qt_peso_destino_w,
		qt_peso_origem_w,
		qt_dias_sem_movto_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_rouparia ( dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

