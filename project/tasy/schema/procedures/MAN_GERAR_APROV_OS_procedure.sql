-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_aprov_os ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
qt_existe_w			bigint;
ie_tipo_ordem_w			integer;
nr_seq_tipo_proj_gpi_w		integer;
cd_solicitante_w			varchar(10);
cd_pessoa_aprov_w		varchar(10);
nr_grupo_trabalho_w		bigint;
cd_funcao_w			integer;
ie_classificacao_w			varchar(1);

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	man_regra_aprov_os a
	where	clock_timestamp() between coalesce(a.dt_inicio_vigencia,clock_timestamp()) and coalesce(fim_dia(a.dt_fim_vigencia),clock_timestamp())
	and	coalesce(a.ie_tipo_ordem,coalesce(ie_tipo_ordem_w,0)) = coalesce(ie_tipo_ordem_w,0)
	and	coalesce(a.nr_seq_tipo_proj_gpi,coalesce(nr_seq_tipo_proj_gpi_w,0)) = coalesce(nr_seq_tipo_proj_gpi_w,0)
	and	coalesce(a.cd_solicitante,coalesce(cd_solicitante_w,0)) = coalesce(cd_solicitante_w,0)
	and	coalesce(a.nr_seq_grupo_trabalho,coalesce(nr_grupo_trabalho_w,0)) = coalesce(nr_grupo_trabalho_w,0)
	and	coalesce(a.cd_funcao,coalesce(cd_funcao_w,0)) = coalesce(cd_funcao_w,0)
	and	coalesce(a.ie_classificacao,coalesce(ie_classificacao_w,'X')) = coalesce(ie_classificacao_w,'X')
	and exists (	SELECT	1
			from	man_regra_aprov_os_usu x
			where	a.nr_sequencia = x.nr_seq_regra_aprov
			and	(x.cd_pessoa_aprov IS NOT NULL AND x.cd_pessoa_aprov::text <> ''));

c02 CURSOR FOR
	SELECT	a.cd_pessoa_aprov
	from	man_regra_aprov_os_usu a
	where	a.nr_seq_regra_aprov = nr_sequencia_w
	and not exists (SELECT	1
			from	man_ordem_servico_aprov x
			where	x.cd_pessoa_aprov = a.cd_pessoa_aprov
			and	x.nr_seq_ordem_serv = nr_sequencia_p);

BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin
	select	a.ie_tipo_ordem,
		a.cd_pessoa_solicitante,
		b.nr_seq_tipo,
		a.nr_grupo_trabalho,
		a.cd_funcao,
		a.ie_classificacao
	into STRICT	ie_tipo_ordem_w,
		cd_solicitante_w,
		nr_seq_tipo_proj_gpi_w,
		nr_grupo_trabalho_w,
		cd_funcao_w,
		ie_classificacao_w
	FROM man_ordem_servico a
LEFT OUTER JOIN gpi_projeto b ON (a.nr_seq_proj_gpi = b.nr_sequencia)
WHERE a.nr_sequencia = nr_sequencia_p;

	open c01;
	loop
	fetch c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		open c02;
		loop
		fetch c02 into
			cd_pessoa_aprov_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			insert into man_ordem_servico_aprov(
					nr_sequencia,
					nr_seq_ordem_serv,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_pessoa_aprov,
					dt_aprovacao)
				values (	nextval('man_ordem_servico_aprov_seq'),
					nr_sequencia_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_pessoa_aprov_w,
					null);
			end;
		end loop;
		close c02;
		end;
	end loop;
	close c01;
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_aprov_os ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

