-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_gerar_agrupamento_lote ( nr_seq_lote_fornec_p bigint, qt_agrupamento_p bigint, ie_excluir_agrup_anterior_p text, nm_usuario_p text) AS $body$
DECLARE


ie_linha_w		integer;
qt_material_w		double precision;
qt_material_ww		double precision;
qt_agrup_ativo_w		double precision;
qt_material_agrup_w	double precision;
qt_prevista_agrup_w	double precision;
qt_agrupamento_w		double precision;
nr_sequencia_w		bigint;

c01 CURSOR FOR
SELECT	row_number() OVER () AS rownum,
	a.qt_material,
	qt_agrupamento_p
from	tabela_sistema b,
	material_lote_fornec a
where	a.nr_sequencia = nr_seq_lote_fornec_p  LIMIT (qt_agrupamento_w);


BEGIN
if (ie_excluir_agrup_anterior_p = 'S') then
	delete	FROM material_lote_fornec_agrup
	where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;
end if;

select	a.qt_material
into STRICT	qt_material_agrup_w
from	material_lote_fornec a
where	a.nr_sequencia = nr_seq_lote_fornec_p;

select	coalesce(sum(qt_material),0)
into STRICT	qt_agrup_ativo_w
from	material_lote_fornec_agrup
where	coalesce(ie_situacao,'A') = 'A'
and	nr_seq_lote_fornec = nr_seq_lote_fornec_p;

qt_material_agrup_w 	:= (qt_material_agrup_w - qt_agrup_ativo_w);
qt_agrupamento_w		:= trunc(dividir(qt_material_agrup_w, qt_agrupamento_p));

if (trunc(dividir(qt_material_agrup_w,2)) < coalesce(qt_agrupamento_p,0)) then
	qt_agrupamento_w := qt_agrupamento_w + 1;
end if;

OPEN C01;
LOOP
FETCH C01 INTO
	ie_linha_w,
	qt_material_w,
	qt_prevista_agrup_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	nextval('material_lote_fornec_seq')
	into STRICT	nr_sequencia_w
	;

	insert into material_lote_fornec_agrup(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_lote_fornec,
		nr_digito_verif,
		qt_material,
		ie_situacao)
	values (	nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_lote_fornec_p,
		calcula_digito('MODULO11',nr_sequencia_w),
		qt_prevista_agrup_w,
		'A');

	if (ie_linha_w = qt_agrupamento_w) then
		begin
		select	sum(qt_material)
		into STRICT	qt_material_ww
		from	material_lote_fornec_agrup
		where	nr_seq_lote_fornec = nr_seq_lote_fornec_p
		and	coalesce(ie_situacao,'A') = 'A';

		if (qt_material_ww <> qt_material_w) then
			update	material_lote_fornec_agrup
			set	qt_material = qt_material + (qt_material_w - qt_material_ww)
			where	nr_seq_lote_fornec = nr_seq_lote_fornec_p
			and	nr_sequencia 	= nr_sequencia_w;
		end if;

		end;
	end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_gerar_agrupamento_lote ( nr_seq_lote_fornec_p bigint, qt_agrupamento_p bigint, ie_excluir_agrup_anterior_p text, nm_usuario_p text) FROM PUBLIC;

