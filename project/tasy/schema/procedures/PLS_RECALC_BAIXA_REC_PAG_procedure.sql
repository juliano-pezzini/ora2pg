-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_recalc_baixa_rec_pag ( dt_inicio_p timestamp, dt_fim_p timestamp, ie_origem_titulo_p text, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


c01 CURSOR FOR
	SELECT	t.nr_titulo,
		l.nr_sequencia nr_seq_baixa
	from	titulo_receber t,
		titulo_receber_liq l
	where	t.nr_titulo = l.nr_titulo
	and	l.dt_recebimento between dt_inicio_p and dt_fim_p
	and	t.ie_origem_titulo = coalesce(ie_origem_titulo_p, t.ie_origem_titulo)
	and	coalesce(l.nr_lote_contabil,0) = 0
	and	not exists (	SELECT	1
					from	pls_titulo_rec_liq_mens	a
					where	a.nr_titulo	= t.nr_titulo
					and		a.nr_seq_baixa	= l.nr_sequencia
					and		a.nr_lote_contabil <> 0
				);

c02 CURSOR FOR
	SELECT	t.nr_titulo,
		b.nr_sequencia nr_seq_baixa
	from	titulo_pagar t,
		titulo_pagar_baixa b
	where	t.nr_titulo = b.nr_titulo
	and	b.dt_baixa between dt_inicio_p and dt_fim_p
	and	t.ie_origem_titulo = coalesce(ie_origem_titulo_p, t.ie_origem_titulo)
	and	coalesce(b.nr_lote_contabil,0) = 0
	and	not exists (	SELECT	1
					from	titulo_pagar_baixa_ops	a
					where	a.nr_titulo	= t.nr_titulo
					and	a.nr_seq_baixa	= b.nr_sequencia
					and	a.nr_lote_contabil <> 0
				);
BEGIN

if (coalesce(ie_opcao_p, 'R') = 'R') then

	for titulo in C01
	loop
		CALL recalcular_titulo_rec_liq_cc(titulo.nr_titulo, titulo.nr_seq_baixa, nm_usuario_p);
	end loop;

elsif (ie_opcao_p = 'P') then

	for titulo in C02
	loop
		CALL gerar_titulo_pagar_baixa_cc(titulo.nr_titulo, titulo.nr_seq_baixa, 'S', nm_usuario_p);
	end loop;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recalc_baixa_rec_pag ( dt_inicio_p timestamp, dt_fim_p timestamp, ie_origem_titulo_p text, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

