-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_arquivo_ecd_job ( nm_usuario_p text, nr_seq_controle_p ctb_sped_controle.nr_sequencia%type ) AS $body$
DECLARE


ds_log_w	varchar(4000);
nr_sid_w	bigint;
nr_serial_w	bigint;
ie_forma_gerar_arquivo_w	varchar(1);


BEGIN
    begin
        select  a.sid,
                a.serial#
        into STRICT    nr_sid_w,
                nr_serial_w
        from    v$session a
        where   audsid=userenv('SESSIONID');

        update  ctb_sped_controle
        set     nr_sid = nr_sid_w,
                nr_serial = nr_serial_w,
                ie_status_arquivo = 'P', -- processando
                dt_atualizacao = clock_timestamp(),
                nm_usuario = nm_usuario_p
        where   nr_sequencia = nr_seq_controle_p;

        commit;
        /* Ler o formato de geracao do arquivo */

        ie_forma_gerar_arquivo_w := coalesce(obter_parametro_funcao_padrao(923, 88, nm_usuario_p),'S');

        /* processando o arquivo da ECD */

        CALL ctb_gerar_arquivo_ecd(nr_seq_controle_p,nr_seq_controle_p);

        update  ctb_sped_controle a
        set        ie_status_arquivo = 'G', -- gerado
            	    dt_atualizacao = clock_timestamp(),
            	    nm_usuario = nm_usuario_p
        where   nr_sequencia = nr_seq_controle_p;
        commit;

        /* Se estiver configurado para gerar pelo banco de dados, ja inicia a geracao */

        if (ie_forma_gerar_arquivo_w ='B') then
            CALL ecd_gerar_arquivo_banco(nr_seq_controle_p, nm_usuario_p);
        end if;

        update  ctb_sped_controle a
         set       ie_status_arquivo = 'F', -- finalizado
         	  	   dt_atualizacao = clock_timestamp(),
         	       nm_usuario = nm_usuario_p
        where   nr_sequencia = nr_seq_controle_p;
        commit;

    exception
    when others then
		ds_log_w := substr(ds_log_w || ' ' || sqlerrm, 0, 4000);
        update  ctb_sped_controle a
         set       ds_informacao = ds_log_w,
             	   ie_status_arquivo = 'E', -- Erro
             	   dt_atualizacao = clock_timestamp(),
             	   nm_usuario = nm_usuario_p
        where   nr_sequencia = nr_seq_controle_p;
        commit;
    end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_arquivo_ecd_job ( nm_usuario_p text, nr_seq_controle_p ctb_sped_controle.nr_sequencia%type ) FROM PUBLIC;

