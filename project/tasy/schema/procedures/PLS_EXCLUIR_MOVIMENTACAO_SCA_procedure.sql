-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_movimentacao_sca ( nr_seq_registro_p bigint, ie_tipo_movimentacao_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


qt_registros_w		bigint;
nr_seq_mov_benef_w	ptu_mov_produto_benef.nr_sequencia%type;
nr_seq_empresa_w	ptu_mov_produto_benef.nr_seq_empresa%type;
nr_seq_mov_produto_w	ptu_movimentacao_produto.nr_sequencia%type;
qt_reg_empresas_w	integer;
qt_reg_benef_w		integer;
qt_reg_compl_benf_w	integer;

C01 CURSOR FOR
	SELECT 	a.nr_sequencia,
		b.nr_seq_mov_produto
	from 	ptu_mov_produto_benef a,
		ptu_mov_produto_empresa b
	where 	b.nr_sequencia = a.nr_seq_empresa
	and	a.nr_seq_empresa = nr_seq_registro_p;


BEGIN

if (ie_tipo_movimentacao_p = 1) then	
	open C01;
	loop
	fetch C01 into
		nr_seq_mov_benef_w,
		nr_seq_mov_produto_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		delete	FROM ptu_intercambio_consist
		where 	nr_seq_mov_prod_benef 	= nr_seq_mov_benef_w;
		
		delete 	FROM ptu_movimento_benef_compl
		where 	nr_seq_beneficiario =  nr_seq_mov_benef_w;

		delete FROM ptu_mov_produto_benef
		where 	nr_sequencia =  nr_seq_mov_benef_w;
		end;
	end loop;
	close C01;
	
	delete 	FROM ptu_mov_produto_empresa
	where 	nr_sequencia = nr_seq_registro_p;
end if;

if (ie_tipo_movimentacao_p = 2) then
	delete	FROM ptu_intercambio_consist
	where 	nr_seq_mov_prod_benef 	= nr_seq_registro_p;
	
	delete 	FROM ptu_movimento_benef_compl
	where 	nr_seq_beneficiario =  nr_seq_registro_p;

	select 	a.nr_seq_empresa,
		b.nr_seq_mov_produto
	into STRICT	nr_seq_empresa_w,
		nr_seq_mov_produto_w
	from  	ptu_mov_produto_benef a,
		ptu_mov_produto_empresa b
	where 	b.nr_sequencia = a.nr_seq_empresa
	and	a.nr_sequencia = nr_seq_registro_p;
	
	delete 	FROM ptu_mov_produto_benef
	where 	nr_sequencia =  nr_seq_registro_p;
	
	select 	count(1)
	into STRICT	qt_registros_w
	from   	ptu_mov_produto_benef
	where 	nr_seq_empresa = nr_seq_empresa_w;
	
	if (qt_registros_w = 0) then
		delete 	FROM ptu_mov_produto_empresa
		where 	nr_sequencia = nr_seq_empresa_w;
	end if;	
end if;

if (nr_seq_mov_produto_w IS NOT NULL AND nr_seq_mov_produto_w::text <> '') then
	qt_reg_empresas_w	:= obter_qt_registro_ptu_a300(nr_seq_mov_produto_w,'302');
	qt_reg_benef_w		:= obter_qt_registro_ptu_a300(nr_seq_mov_produto_w,'304');
	qt_reg_compl_benf_w	:= obter_qt_registro_ptu_a300(nr_seq_mov_produto_w,'306');

	update	ptu_movimentacao_produto
	set	qt_reg_empresas		= qt_reg_empresas_w,
		qt_reg_benef		= qt_reg_benef_w,
		qt_reg_compl_benf	= qt_reg_compl_benf_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_mov_produto_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_movimentacao_sca ( nr_seq_registro_p bigint, ie_tipo_movimentacao_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

