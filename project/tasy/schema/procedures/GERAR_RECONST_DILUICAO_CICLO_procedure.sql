-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao_ciclo ( nr_seq_atendimento_p bigint, nr_seq_material_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE



  cd_material_w                     integer;
  cd_material_sem_apresent_w        integer;
  cd_material_generico_w            integer;
  cd_mat_generico_sem_apresent_w    integer;
  cd_intervalo_w                    varchar(7);
  cd_intervalo_cad_w                varchar(7);
  nr_agrupamento_w                  double precision;
  cd_unidade_medida_w               varchar(30);
  nr_ocorrencia_w                   double precision;
  nr_seq_acum_w                     bigint;
  nr_agrup_acum_w                   double precision;
  nr_sequencia_w                    bigint;
  qt_conversao_w                    double precision;
  cd_dil_w                          bigint;
  nm_usuario_w                      varchar(15);
  ie_bomba_infusao_w                varchar(15);
  ie_gerar_kit_w                    varchar(15);
  ie_gerar_reconstituicao_w         varchar(15);
  ie_tipo_material_w                varchar(15);
  nr_seq_ficha_tecnica_w            bigint;

  cd_diluente_w                     integer;
  qt_diluicao_w                     double precision;
  cd_unid_med_diluente_w            varchar(30);
  ie_reconstituicao_w               varchar(1);
  ie_gera_dil_dose_w                varchar(5);
  ie_via_aplicacao_w                varchar(5);
  ie_priorizar_min_w                varchar(5);
  ie_via_aplic_order_w              varchar(5);
  qt_minuto_aplicacao_w             smallint;
  qt_hora_aplicacao_w               smallint;
  qt_material_w                     double precision;
  qt_total_disp_w                   double precision;
  qt_unitaria_w                     double precision;
  qt_dose_w                         double precision;
  cd_unidade_medida_conv_w          varchar(30);

  ie_gera_diluicao_w                varchar(1) := 'S';
  controle_w                        smallint := 0;
  controle_ww                       smallint := 0;
  ie_regra_w                        varchar(1) := 'N';
  ie_diluente_w                     varchar(1) := 'N';
  ie_atualizar_horario_w            varchar(5);
  nr_seq_prioridade_w               smallint;
  cd_setor_atendimento_w            integer;
  cd_setor_w                        integer;
  cd_estabelecimento_w              smallint;
  qt_idade_w                        double precision;
  qt_idade_min_w                    double precision;
  qt_idade_max_w                    double precision;

  cd_motivo_baixa_w                 smallint;
  ie_cobra_paciente_w               varchar(1);
  ds_dose_diferenciada_w            varchar(50);
  qt_dispensar_w                    double precision;
  ie_regra_disp_w                   varchar(1);
  ds_erro_w                         varchar(255);
  cd_perfil_w                       integer;
  nm_usuario_original_w             varchar(15);
  ie_atualiza_reconst_w             varchar(1);
  qt_peso_w                         real;
  ie_gerar_diluicao_w               varchar(1);
  qt_vol_adic_reconst_w             double precision;
  ie_proporcao_w                    varchar(15);
  qt_referencia_w                   double precision;
  qt_referencia_aux_w               double precision;
  qt_unitaria_medic_w               double precision;
  qt_dose_medic_w                   double precision;
  qt_dose_aux_w                     double precision;
  cd_unidade_medida_dose_w          varchar(30);
  qt_dose_diluicao_w                double precision;
  nr_seq_via_acesso_w               bigint;
  nr_seq_restricao_w                bigint;
  cd_pessoa_fisica_w                varchar(30);
  ds_lista_restricao_w              varchar(255);
  qt_solucao_w                      double precision;
  nr_seq_interno_w                  bigint;
  cd_unid_med_reconst_w             varchar(30);
  qt_dose_especial_w                double precision;
  qt_dias_util_w                    smallint;
  ie_gerar_diluicao_ww              varchar(1);
  ie_prescr_mat_sem_lib_w           varchar(30);
  ie_calcula_volume_afterpost_w     varchar(1);
  ie_substitui_tempo_atual_w        varchar(1);
  ie_consistedoseconsumomedic_w     varchar(1) := 'S';
  ie_gerar_lote_w                   varchar(1);
  ds_dias_aplicacao_w               varchar(4000);
  nr_seq_mat_diluicao_w             bigint;
  qt_volume_medic_w                 double precision;
  nr_seq_agrupamento_w              bigint;
  qt_conversao_dose_w               double precision;
  qt_unitaria_medic_real_w          double precision;
  ie_param_491_w                    varchar(1);
  qt_sobra                          double precision;


  c01 CURSOR FOR
    SELECT coalesce(cd_diluente, 0),
         coalesce(qt_diluicao, 0),
         coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
         coalesce(ie_reconstituicao, 'A'),
         ie_via_aplicacao,
         coalesce(qt_minuto_aplicacao, 0),
         cd_intervalo,
         nr_seq_prioridade,
         cd_setor_atendimento,
         qt_idade_min,
         qt_idade_max,
         coalesce(cd_motivo_baixa, 0),
         coalesce(ie_cobra_paciente, 'S'),
         coalesce(ie_proporcao, 'F'),
         qt_referencia,
         nr_seq_restricao,
         nr_seq_interno,
         ie_atualizar_tempo,
         ie_diluir_inteiro,
         coalesce(ie_gerar_lote, 'S'),
         nr_seq_interno,
         qt_volume_medic
    from material_diluicao
   where ie_gera_diluicao_w = 'S'
     and ie_opcao_p in ('A', 'D')
     and ((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
     and ((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
     and obter_se_regra_diluicao_setor(nr_seq_interno,
                                       cd_setor_atendimento_w) = 'S'
     and ((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w))
     and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
     and ((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
     and ie_reconstituicao = 'N'
     and cd_material = coalesce(cd_material_sem_apresent_w, cd_material_w)
     and qt_idade_w between
         obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') and
         obter_idade_diluicao(cd_material, nr_sequencia, 'MAX')
     and qt_peso_w between coalesce(qt_peso_min, 0) and coalesce(qt_peso_max, 999999)
     and coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) =
         coalesce(obter_perfil_ativo, 0)
     and ((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida = cd_unidade_medida_dose_w))
     and coalesce(obter_conversao_unid_med_cons(cd_material_w,
                                          cd_unidade_medida_dose_w,
                                          qt_dose_medic_w),
            0) between
        coalesce(CASE WHEN coalesce(qt_dose_min::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_min) END ,
            0) and
        coalesce(CASE WHEN coalesce(qt_dose_max::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_max) END ,
            9999999)
     and ((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
     and ((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
     and coalesce(nr_seq_agrupamento, nr_seq_agrupamento_w) =
         nr_seq_agrupamento_w

union

  SELECT coalesce(cd_diluente, 0),
         coalesce(qt_diluicao, 0),
         coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
         coalesce(ie_reconstituicao, 'A'),
         ie_via_aplicacao,
         coalesce(qt_minuto_aplicacao, 0),
         cd_intervalo,
         nr_seq_prioridade,
         cd_setor_atendimento,
         qt_idade_min,
         qt_idade_max,
         coalesce(cd_motivo_baixa, 0),
         coalesce(ie_cobra_paciente, 'S'),
         coalesce(ie_proporcao, 'F'),
         qt_referencia,
         nr_seq_restricao,
         nr_seq_interno,
         ie_atualizar_tempo,
         ie_diluir_inteiro,
         coalesce(ie_gerar_lote, 'S'),
         nr_seq_interno,
         qt_volume_medic
    from material_diluicao
   where ie_gera_diluicao_w = 'S'
     and ie_opcao_p in ('A', 'D')
     and ie_reconstituicao = 'N'
     and ((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
     and ((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
     and obter_se_regra_diluicao_setor(nr_seq_interno,
                                       cd_setor_atendimento_w) = 'S'
     and ((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w))
     and ((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
     and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
     and cd_material =
         coalesce(cd_mat_generico_sem_apresent_w, cd_material_generico_w)
     and qt_idade_w between
         obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') and
         obter_idade_diluicao(cd_material, nr_sequencia, 'MAX')
     and qt_peso_w between coalesce(qt_peso_min, 0) and coalesce(qt_peso_max, 999999)
     and coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) =
         coalesce(obter_perfil_ativo, 0)
     and ((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida = cd_unidade_medida_dose_w))
    and coalesce(obter_conversao_unid_med_cons(cd_material_w,
                                          cd_unidade_medida_dose_w,
                                          qt_dose_medic_w),
            0) between
        coalesce(CASE WHEN coalesce(qt_dose_min::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_min) END ,
            0) and
        coalesce(CASE WHEN coalesce(qt_dose_max::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_max) END ,
            9999999)
     and ie_regra_w = 'G'
     and ((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
     and ((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
     and coalesce(nr_seq_agrupamento, nr_seq_agrupamento_w) =
         nr_seq_agrupamento_w
   order by ie_via_aplicacao     desc,
            cd_setor_atendimento desc,
            qt_idade_min         desc,
            qt_idade_max         desc,
            nr_seq_prioridade    desc,
            nr_seq_restricao     desc;


  c02 CURSOR FOR
    SELECT coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(qt_minuto_aplicacao, 0),
        qt_volume_adic,
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        cd_unid_med_reconst,
        ie_atualizar_tempo,
        coalesce(ie_priorizar_min, 'N'),
        coalesce(ie_gerar_lote, 'S'),
        nr_seq_interno
    from material_diluicao
  where ie_opcao_p in ('A', 'R')
    and cd_material = cd_material_w
    and ie_reconstituicao = 'S'
    and ie_gerar_reconstituicao_w = 'S'
    and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and ((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
    and qt_idade_w between
        obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') and
        obter_idade_diluicao(cd_material, nr_sequencia, 'MAX')
    and qt_peso_w between coalesce(qt_peso_min, 0) and coalesce(qt_peso_max, 999999)
    and ((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
    and ((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
    and obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
    and coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) =
        coalesce(obter_perfil_ativo, 0)
    and coalesce(obter_conversao_unid_med_cons(cd_material_w,
                                          cd_unidade_medida_dose_w,
                                          qt_dose_medic_w),
            0) between
        coalesce(CASE WHEN coalesce(qt_dose_min::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_min) END ,
            0) and
        coalesce(CASE WHEN coalesce(qt_dose_max::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_max) END ,
            9999999)
    and ((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
    and ((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
    and ((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida = cd_unidade_medida_dose_w))

union

  SELECT coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(qt_minuto_aplicacao, 0),
        qt_volume_adic,
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        cd_unid_med_reconst,
        ie_atualizar_tempo,
        coalesce(ie_priorizar_min, 'N'),
        coalesce(ie_gerar_lote, 'S'),
        nr_seq_interno
    from material_diluicao
  where ie_opcao_p in ('A', 'R')
    and cd_material = cd_material_generico_w
    and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and ((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
    and qt_idade_w between
        obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') and
        obter_idade_diluicao(cd_material, nr_sequencia, 'MAX')
    and qt_peso_w between coalesce(qt_peso_min, 0) and coalesce(qt_peso_max, 999999)
    and ie_reconstituicao = 'S'
    and ie_gerar_reconstituicao_w = 'S'
    and ie_regra_w = 'G'
    and coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) =
        coalesce(obter_perfil_ativo, 0)
    and ((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
    and ((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
    and ((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w))
    and obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
    and coalesce(obter_conversao_unid_med_cons(cd_material_w,
                                          cd_unidade_medida_dose_w,
                                          qt_dose_medic_w),
            0) between
        coalesce(CASE WHEN coalesce(qt_dose_min::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_min) END ,
            0) and
        coalesce(CASE WHEN coalesce(qt_dose_max::text, '') = '' THEN  null  ELSE obter_conversao_unid_med_cons(cd_material_w,                                          cd_unidade_medida,                                          qt_dose_max) END ,
            9999999)
    and ((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
    and ((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida = cd_unidade_medida_dose_w))
  order by ie_via_aplicacao     desc,
            cd_setor_atendimento desc,
            qt_idade_min         desc,
            qt_idade_max         desc,
            nr_seq_prioridade    desc,
            nr_seq_restricao     desc;


  c04 CURSOR FOR
    SELECT coalesce(cd_diluente, 0),
        coalesce(qt_diluicao, 0),
        coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
        coalesce(ie_reconstituicao, 'A'),
        ie_via_aplicacao,
        coalesce(qt_minuto_aplicacao, 0),
        cd_intervalo,
        nr_seq_prioridade,
        cd_setor_atendimento,
        qt_idade_min,
        qt_idade_max,
        coalesce(cd_motivo_baixa, 0),
        coalesce(ie_cobra_paciente, 'S'),
        coalesce(ie_proporcao, 'F'),
        qt_referencia,
        nr_seq_restricao,
        qt_volume,
        coalesce(ie_gerar_lote, 'S')
    from material_diluicao
  where cd_material = cd_material_w
    and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
    and qt_idade_w between
        obter_idade_diluicao(cd_material, nr_sequencia, 'MIN') and
        obter_idade_diluicao(cd_material, nr_sequencia, 'MAX')
    and qt_peso_w between coalesce(qt_peso_min, 0) and coalesce(qt_peso_max, 999)
    and ie_reconstituicao = 'R'
    and ie_gerar_rediluente = 'S'
    and ((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
    and coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) =
        coalesce(obter_perfil_ativo, 0)
    and (qt_volume IS NOT NULL AND qt_volume::text <> '')
    and ((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao = ie_via_aplicacao_w));


  c05 CURSOR FOR
    SELECT b.cd_material
      from material_estab c, material b, medic_ficha_tecnica a
     where b.nr_seq_ficha_tecnica = a.nr_sequencia
       and c.cd_material = b.cd_material
       and ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
       and a.nr_sequencia = nr_seq_ficha_tecnica_w
       and obter_se_via_adm(b.cd_material, ie_via_aplicacao_w) = 'S'
       and b.cd_material <> cd_diluente_w
       and coalesce(obter_conversao_unid_med_onc(b.cd_material,
                                             cd_unid_med_diluente_w),
               0) >= qt_dose_diluicao_w
       and b.ie_situacao = 'A'
       and c.ie_prescricao = 'S'
     order by coalesce(obter_conversao_unid_med_onc(b.cd_material,
                                               cd_unid_med_diluente_w),
                   0) desc;



BEGIN

  select max(a.cd_setor_atendimento),
         max(a.cd_estabelecimento),
         max(obter_idade(b.dt_nascimento, coalesce(b.dt_obito, clock_timestamp()), 'DIA')),
         max(a.nm_usuario),
         coalesce(max(a.qt_peso), 0),
         max(b.cd_pessoa_fisica)
    into STRICT cd_setor_atendimento_w,
         cd_estabelecimento_w,
         qt_idade_w,
         nm_usuario_original_w,
         qt_peso_w,
         cd_pessoa_fisica_w
    from pessoa_fisica b, paciente_setor a
   where a.nr_seq_paciente = (SELECT paciente_atendimento.nr_seq_paciente
                                from paciente_atendimento
                               where paciente_atendimento.nr_seq_atendimento = nr_seq_atendimento_p)
     and a.cd_pessoa_fisica = b.cd_pessoa_fisica;



  select coalesce(obter_agrupamento_setor(cd_setor_atendimento_w),0)
    into STRICT nr_seq_agrupamento_w
;


  cd_perfil_w  := obter_perfil_ativo;
  ie_regra_w := obter_param_usuario(924, 78, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_regra_w);
  ie_atualiza_reconst_w := obter_param_usuario(924, 214, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_atualiza_reconst_w);
  ie_gera_dil_dose_w := obter_param_usuario(924, 347, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gera_dil_dose_w);
  ie_prescr_mat_sem_lib_w := obter_param_usuario(924, 530, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
  ie_calcula_volume_afterpost_w := obter_param_usuario(924, 600, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_calcula_volume_afterpost_w);
  ie_gerar_kit_w := obter_param_usuario(924, 702, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gerar_kit_w);
  ie_param_491_w := obter_param_usuario(3130, 491, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_param_491_w);

  select coalesce(max(ie_gerar_diluicao), 'S'),
         coalesce(max(ie_gerar_reconstituicao), 'S')
    into STRICT ie_gerar_diluicao_ww, ie_gerar_reconstituicao_w
    from setor_atendimento
   where cd_setor_atendimento = cd_setor_atendimento_w;



  if (nr_seq_atendimento_p > 0) and (nr_seq_material_p > 0) and
    ((ie_gerar_diluicao_ww = 'S') or (ie_gerar_reconstituicao_w = 'S')) then

    select coalesce(max(nr_seq_material), 0), coalesce(max(nr_agrupamento), 0)
      into STRICT nr_seq_acum_w, nr_agrup_acum_w
      from paciente_atend_medic
     where nr_seq_atendimento = nr_seq_atendimento_p;


    select coalesce(paciente_atend_medic.cd_material, 0),
           paciente_atend_medic.cd_intervalo,
           coalesce(paciente_atend_medic.nr_agrupamento, 0),
           coalesce(paciente_atend_medic.cd_unid_med_dose, obter_unid_med_usua('ml')),
           1,
           coalesce(paciente_atend_medic.nm_usuario, 'Tasy'),
           paciente_atend_medic.ie_via_aplicacao,
           paciente_atend_medic.qt_dose_prescricao,
           paciente_atend_medic.qt_dose_prescricao,
           paciente_atend_medic.qt_dose,
           paciente_atend_medic.qt_dose_prescricao,
           null,
           'S',
           null,
           null,
           paciente_atend_medic.qt_dose_prescricao,
           paciente_atend_medic.cd_unid_med_prescr,
           null,
           paciente_atend_medic.qt_dias_util,
           paciente_atend_medic.ie_bomba_infusao
      into STRICT cd_material_w,
           cd_intervalo_w,
           nr_agrupamento_w,
           cd_unidade_medida_w,
           nr_ocorrencia_w,
           nm_usuario_w,
           ie_via_aplicacao_w,
           qt_material_w,
           qt_total_disp_w,
           qt_dose_w,
           qt_unitaria_medic_w,
           cd_material_sem_apresent_w,
           ie_gerar_diluicao_w,
           ds_dose_diferenciada_w,
           nr_seq_via_acesso_w,
           qt_dose_medic_w,
           cd_unidade_medida_dose_w,
           qt_dose_especial_w,
           qt_dias_util_w,
           ie_bomba_infusao_w
      from paciente_atend_medic
     where paciente_atend_medic.nr_seq_atendimento = nr_seq_atendimento_p
       and paciente_atend_medic.nr_seq_material = nr_seq_material_p
       and (paciente_atend_medic.cd_material IS NOT NULL AND paciente_atend_medic.cd_material::text <> '');

    begin
      select nr_seq_restricao
        into STRICT nr_seq_restricao_w
        from paciente_rep_prescricao a
       where (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
         and cd_pessoa_fisica = cd_pessoa_fisica_w
         and coalesce(dt_inativacao::text, '') = ''
         and ((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio, clock_timestamp() - interval '1 days') and
             a.dt_fim + 86399 / 86400));

      ds_lista_restricao_w  := nr_seq_restricao_w  || ',' || ds_lista_restricao_w;
    exception
      when others then
        null;
    end;



    select coalesce(max(cd_material_generico),cd_material_w)
      into STRICT cd_material_generico_w
      from material
     where cd_material  = cd_material_w;

    select coalesce(max(cd_material_generico),cd_material_sem_apresent_w)
      into STRICT cd_mat_generico_sem_apresent_w
      from material
     where cd_material  = cd_material_sem_apresent_w;

    /* inserir o reconstituinte */

    open c02;
    loop
    fetch c02 into
      cd_diluente_w,
      qt_diluicao_w,
      cd_unid_med_diluente_w,
      ie_reconstituicao_w,
      ie_via_aplic_order_w,
      cd_intervalo_cad_w,
      nr_seq_prioridade_w,
      cd_setor_w,
      qt_idade_min_w,
      qt_idade_max_w,
      cd_motivo_baixa_w,
      ie_cobra_paciente_w,
      qt_minuto_aplicacao_w,
      qt_vol_adic_reconst_w,
      ie_proporcao_w,
      qt_referencia_w,
      nr_seq_restricao_w,
      cd_unid_med_reconst_w,
      ie_substitui_tempo_atual_w,
      ie_priorizar_min_w,
      ie_gerar_lote_w,
      nr_seq_mat_diluicao_w;
    EXIT WHEN NOT FOUND; /* apply on c02 */
      ie_diluente_w  := 'S';
    end loop;
    close c02;

      if (ie_param_491_w = 'S') then
            qt_sobra := 0;

        select coalesce(max(CASE WHEN cd_unidade_medida='FA' THEN  cd_unidade_medida  ELSE CASE WHEN cd_unidade_medida='AMP' THEN  cd_unidade_medida  ELSE cd_unid_med_diluente_w END  END ), cd_unid_med_diluente_w)
          into STRICT cd_unidade_medida_conv_w
          from material_conversao_unidade
         where cd_material  = cd_material_w
           and upper(cd_unidade_medida) in ('FA', 'AMP');

        if (cd_unidade_medida_w = cd_unidade_medida_conv_w) then
          qt_referencia_w := ceil(qt_dose_w);
        else
          qt_referencia_w :=  ceil(qt_dose_w * obter_conversao_unid_med_onc(cd_material_w, cd_unidade_medida_conv_w));
              qt_sobra := mod(qt_referencia_w, qt_diluicao_w);
        end if;

        if (qt_referencia_w > 0) then
              if (qt_sobra > 0) then
                  qt_diluicao_w := (qt_referencia_w - qt_sobra) + qt_diluicao_w;
              else
                  qt_diluicao_w := qt_referencia_w;
              end if;
        end if;
      end if;

    if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then

      nr_sequencia_w  := nr_seq_acum_w + 1;

      select coalesce(max(qt_conversao), 1)
        into STRICT qt_conversao_w
        from material_conversao_unidade
       where cd_material = cd_diluente_w
         and cd_unidade_medida = cd_unid_med_diluente_w;

      if (ie_atualiza_reconst_w = 'N') then
        begin
          delete FROM paciente_atend_medic
           where nr_seq_atendimento = nr_seq_atendimento_p
             and ie_agrupador = 9
             and nr_seq_diluicao = nr_seq_material_p;
        end;
      end if;

      select count(*)
        into STRICT controle_w
        from paciente_atend_medic
       where nr_seq_atendimento = nr_seq_atendimento_p
         and ie_agrupador = 9
         and nr_seq_diluicao = nr_seq_material_p;

      qt_unitaria_w  := dividir(qt_diluicao_w,qt_conversao_w);

      if (controle_w = 0) then
        begin

          select count(*)
            into STRICT controle_ww
            from paciente_atend_medic
           where nr_seq_atendimento = nr_seq_atendimento_p
             and ie_agrupador = 3
             and nr_seq_diluicao = nr_seq_material_p;

        if (controle_ww = 0) then
          begin
          if (qt_minuto_aplicacao_w > 0) then
            if (qt_minuto_aplicacao_w < 60) then
              qt_hora_aplicacao_w  := null;
            elsif (qt_minuto_aplicacao_w = 60) then
              qt_hora_aplicacao_w  := 1;
              qt_minuto_aplicacao_w  := null;
            else
              qt_hora_aplicacao_w  := trunc(dividir(qt_minuto_aplicacao_w,60));
              qt_minuto_aplicacao_w  := (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
            end if;
          end if;

          if (qt_minuto_aplicacao_w = 0) then
            qt_minuto_aplicacao_w  := null;
          end if;

          update paciente_atend_medic
             set qt_min_aplicacao  = qt_minuto_aplicacao_w,
                 qt_hora_aplicacao = qt_hora_aplicacao_w
           where nr_seq_atendimento = nr_seq_atendimento_p
             and nr_seq_material = nr_seq_material_p
             and ie_aplic_bolus = 'N'
             and ie_aplic_lenta = 'N'
             and ((coalesce(ie_substitui_tempo_atual_w, 'N') = 'S') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''));

          end;
        end if;

        insert into paciente_atend_medic( nr_seq_diluicao,
                  nr_seq_material,
                  nr_agrupamento,
                  ds_recomendacao,
                  nr_seq_atendimento,
                  cd_material,
                  qt_dose,
                  cd_unid_med_dose,
                  ie_via_aplicacao,
                  dt_atualizacao,
                  nm_usuario,
                  qt_min_aplicacao,
                  ie_bomba_infusao,
                  qt_hora_aplicacao,
                  cd_intervalo,
                  nr_seq_interno,
                  qt_dias_util,
                  ie_se_necessario,
                  ds_observacao,
                  ie_urgencia,
                  ie_aplic_bolus,
                  ie_aplic_lenta,
                  cd_unid_med_prescr,
                  qt_dose_prescricao,
                  ie_pre_medicacao,
                  nr_seq_solucao,
                  ie_gerar_solucao,
                  pr_reducao,
                  nr_seq_reconstituinte,
                  ie_agrupador,
                  ie_aplica_reducao,
                  ie_zerado,
                  ie_regra_diluicao_cad_mat,
                  nr_seq_mat_diluicao,
                  ie_cancelada)
         values (
                  nr_seq_material_p,
                  nr_sequencia_w,
                  0,
                  null,
                  nr_seq_atendimento_p,
                  cd_diluente_w,
                  qt_diluicao_w,
                  cd_unid_med_diluente_w,
                  ie_via_aplicacao_w,
                  clock_timestamp(),
                  nm_usuario_p,
                  null,
                  ie_bomba_infusao_w,
                  null,
                  null,
                  nextval('paciente_atend_medic_seq'),
                  null,
                  null,
                  null,
                  null,
                  null,
                  null,
                  cd_unid_med_diluente_w,
                  qt_diluicao_w,
                  'N',
                  null,
                  'N',
                  null,
                  null,
                  9,
                  'N',
                  'N',
                  'N' ,
                  nr_seq_mat_diluicao_w,
                  'N');





        end;
      end if;
    end if;

    /* inserir o diluente */

    if (ie_gerar_diluicao_ww = 'S') then

      select coalesce(max(nr_seq_material), 0), coalesce(max(nr_agrupamento), 0)
        into STRICT nr_seq_acum_w, nr_agrup_acum_w
        from paciente_atend_medic
       where nr_seq_atendimento = nr_seq_atendimento_p;

      if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
        select max(ie_gera_diluicao)
          into STRICT ie_gera_diluicao_w
          from via_aplicacao
         where ie_via_aplicacao = ie_via_aplicacao_w;
      end if;

      ie_diluente_w  := 'N';

      open c01;
      loop
      fetch c01 into
        cd_diluente_w,
        qt_diluicao_w,
        cd_unid_med_diluente_w,
        ie_reconstituicao_w,
        ie_via_aplic_order_w,
        qt_minuto_aplicacao_w,
        cd_intervalo_cad_w,
        nr_seq_prioridade_w,
        cd_setor_w,
        qt_idade_min_w,
        qt_idade_max_w,
        cd_motivo_baixa_w,
        ie_cobra_paciente_w,
        ie_proporcao_w,
        qt_referencia_w,
        nr_seq_restricao_w,
        nr_seq_interno_w,
        ie_substitui_tempo_atual_w,
        ie_consistedoseconsumomedic_w,
        ie_gerar_lote_w,
        nr_seq_mat_diluicao_w,
        qt_volume_medic_w;
      EXIT WHEN NOT FOUND; /* apply on c01 */
        ie_diluente_w  := 'S';
      end loop;
      close c01;


      if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then

        select max(ie_tipo_material), max(nr_seq_ficha_tecnica)
          into STRICT ie_tipo_material_w, nr_seq_ficha_tecnica_w
          from material
         where cd_material = cd_diluente_w;

        qt_dose_diluicao_w  := qt_diluicao_w;
        qt_referencia_aux_w  := qt_referencia_w;
        if (coalesce(qt_referencia_w,0) > 0) then
          qt_referencia_w  := obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
        end if;

        if (ie_tipo_material_w  = '6')  then

          open c05;
          loop
          fetch c05 into
            cd_dil_w;
          EXIT WHEN NOT FOUND; /* apply on c05 */
            cd_dil_w  := cd_dil_w;
          end loop;
          close c05;

          if (cd_dil_w > 0) then
            cd_diluente_w  := cd_dil_w;
          end if;
        end if;

        nr_sequencia_w  := nr_seq_acum_w + 1;

        if (ie_proporcao_w = 'F') and (ie_consistedoseconsumomedic_w = 'N') and (coalesce(qt_volume_medic_w,0)  > 0) then
          qt_diluicao_w  := obter_conversao_unid_med_cons(cd_material_w,obter_unid_med_usua('ml'),qt_volume_medic_w);
        elsif (coalesce(qt_referencia_w,0) > 0) then
          if (ie_proporcao_w = 'SC') then

            begin
              qt_unitaria_medic_real_w := obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_w,qt_unitaria_medic_w);

              if (ie_consistedoseconsumomedic_w = 'S') then
                qt_diluicao_w  := ceil(qt_unitaria_medic_real_w) * qt_referencia_aux_w;
              else
                qt_diluicao_w  := ceil(qt_unitaria_medic_real_w) * qt_referencia_aux_w;
              end if;

            exception when others then
              qt_diluicao_w := 0;
            end;

          elsif (ie_proporcao_w = 'ST') then
            if (ie_consistedoseconsumomedic_w = 'S') then
              qt_diluicao_w    := ceil(qt_unitaria_medic_w) * qt_referencia_w;
            else
              qt_diluicao_w    := qt_unitaria_medic_w * qt_referencia_w;
            end if;
            qt_dose_aux_w    := obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w);
            qt_minuto_aplicacao_w  := trunc(qt_minuto_aplicacao_w * qt_dose_aux_w);
          end if;
        end if;

        select coalesce(max(qt_conversao), 1)
          into STRICT qt_conversao_w
          from material_conversao_unidade
         where cd_material = cd_diluente_w
           and cd_unidade_medida = cd_unid_med_diluente_w;

        select count(*)
          into STRICT controle_ww
          from paciente_atend_medic
         where nr_seq_atendimento = nr_seq_atendimento_p
           and ie_agrupador = 3
           and nr_seq_diluicao = nr_seq_material_p;



        if (controle_ww = 0) then

          if (qt_minuto_aplicacao_w > 0) then
            if (qt_minuto_aplicacao_w < 60) then
              qt_hora_aplicacao_w  := null;
            elsif (qt_minuto_aplicacao_w = 60) then
              qt_hora_aplicacao_w  := 1;
              qt_minuto_aplicacao_w  := null;
            else
              qt_hora_aplicacao_w  := trunc(dividir(qt_minuto_aplicacao_w,60));
              qt_minuto_aplicacao_w  := (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
            end if;
          end if;

          if (qt_minuto_aplicacao_w = 0) then
            qt_minuto_aplicacao_w  := null;
          end if;

         update paciente_atend_medic
            set qt_min_aplicacao  = qt_minuto_aplicacao_w,
                qt_hora_aplicacao = qt_hora_aplicacao_w
          where nr_seq_atendimento = nr_seq_atendimento_p
            and nr_seq_material = nr_seq_material_p
            and ie_aplic_bolus = 'N'
            and ie_aplic_lenta = 'N'
            and ((ie_priorizar_min_w = 'N') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''))
            and ((coalesce(ie_substitui_tempo_atual_w, 'N') = 'S' and
                ie_proporcao_w <> 'ST') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''));


          if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then
            update paciente_atend_medic
               set qt_min_aplicacao  = qt_minuto_aplicacao_w,
                   qt_hora_aplicacao = qt_hora_aplicacao_w
             where nr_seq_atendimento = nr_seq_atendimento_p
               and nr_seq_material = nr_seq_material_p
               and ie_aplic_bolus = 'N'
               and ie_aplic_lenta = 'N';
          end if;



        insert into paciente_atend_medic( nr_seq_diluicao,
                  nr_seq_material,
                  nr_agrupamento,
                  ds_recomendacao,
                  nr_seq_atendimento,
                  cd_material,
                  qt_dose,
                  cd_unid_med_dose,
                  ie_via_aplicacao,
                  dt_atualizacao,
                  nm_usuario,
                  qt_min_aplicacao,
                  ie_bomba_infusao,
                  qt_hora_aplicacao,
                  cd_intervalo,
                  nr_seq_interno,
                  qt_dias_util,
                  ie_se_necessario,
                  ds_observacao,
                  ie_urgencia,
                  ie_aplic_bolus,
                  ie_aplic_lenta,
                  cd_unid_med_prescr,
                  qt_dose_prescricao,
                  ie_pre_medicacao,
                  nr_seq_solucao,
                  ie_gerar_solucao,
                  pr_reducao,
                  nr_seq_reconstituinte,
                  ie_agrupador,
                  ie_aplica_reducao,
                  ie_zerado,
                  ie_regra_diluicao_cad_mat,
                  nr_seq_mat_diluicao,
                  ie_cancelada)
         values (
                  nr_seq_material_p,
                  nr_sequencia_w,
                  0,
                  null,
                  nr_seq_atendimento_p,
                  cd_diluente_w,
                  qt_diluicao_w,
                  cd_unid_med_diluente_w,
                  ie_via_aplicacao_w,
                  clock_timestamp(),
                  nm_usuario_p,
                  null,
                  ie_bomba_infusao_w,
                  null,
                  null,
                  nextval('paciente_atend_medic_seq'),
                  null,
                  null,
                  null,
                  null,
                  null,
                  null,
                  cd_unid_med_diluente_w,
                  qt_diluicao_w,
                  'N',
                  null,
                  'N',
                  null,
                  null,
                  3,
                  'N',
                  'N',
                  'N',
                  nr_seq_mat_diluicao_w,
                  'N');


        elsif (ie_gera_dil_dose_w  = 'S') then
          null;
        end if;
      end if;
    end if;
    /* inserir o rediluente*/

    /* inserir o diluente */

    if (ie_gerar_diluicao_ww = 'S') then

      select coalesce(max(nr_seq_material), 0), coalesce(max(nr_agrupamento), 0)
        into STRICT nr_seq_acum_w, nr_agrup_acum_w
        from paciente_atend_medic
       where nr_seq_atendimento = nr_seq_atendimento_p;

      if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
        select max(ie_gera_diluicao)
          into STRICT ie_gera_diluicao_w
          from via_aplicacao
         where ie_via_aplicacao = ie_via_aplicacao_w;
      end if;

      ie_diluente_w  := 'N';

      open c04;
      loop
      fetch c04 into
        cd_diluente_w,
        qt_diluicao_w,
        cd_unid_med_diluente_w,
        ie_reconstituicao_w,
        ie_via_aplic_order_w,
        qt_minuto_aplicacao_w,
        cd_intervalo_cad_w,
        nr_seq_prioridade_w,
        cd_setor_w,
        qt_idade_min_w,
        qt_idade_max_w,
        cd_motivo_baixa_w,
        ie_cobra_paciente_w,
        ie_proporcao_w,
        qt_referencia_w,
        nr_seq_restricao_w,
        qt_solucao_w,
        ie_gerar_lote_w;
      EXIT WHEN NOT FOUND; /* apply on c04 */
        ie_diluente_w  := 'S';
      end loop;
      close c04;

      if (ie_diluente_w = 'S')  and (coalesce(cd_diluente_w,0) > 0) then
          qt_dose_diluicao_w  := qt_diluicao_w;
        if (coalesce(qt_referencia_w,0) > 0) then
          qt_referencia_w  := obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
        end if;

        nr_sequencia_w  := nr_seq_acum_w + 1;

        if (coalesce(qt_referencia_w,0) > 0) then
          if (ie_proporcao_w = 'SC') then
            qt_diluicao_w  := qt_unitaria_medic_w * qt_referencia_w;
          elsif (ie_proporcao_w = 'ST') then
            qt_diluicao_w    := qt_unitaria_medic_w * qt_referencia_w;
            qt_minuto_aplicacao_w  := qt_minuto_aplicacao_w * qt_referencia_w;
          end if;
        end if;

        select coalesce(max(qt_conversao), 1)
          into STRICT qt_conversao_w
          from material_conversao_unidade
         where 1 = 1
           and cd_unidade_medida = cd_unid_med_diluente_w
           and cd_material = cd_diluente_w;

        select count(*)
          into STRICT controle_ww
          from paciente_atend_medic
         where nr_seq_atendimento = nr_seq_atendimento_p
           and ie_agrupador = 7
           and nr_seq_diluicao = nr_seq_material_p;



        if (controle_w = 0) then

          if (qt_minuto_aplicacao_w > 0) then
            if (qt_minuto_aplicacao_w < 60) then
              qt_hora_aplicacao_w  := null;
            elsif (qt_minuto_aplicacao_w = 60) then
              qt_hora_aplicacao_w  := 1;
              qt_minuto_aplicacao_w  := null;
            else
              qt_hora_aplicacao_w  := trunc(dividir(qt_minuto_aplicacao_w,60));
              qt_minuto_aplicacao_w  := (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
            end if;
          end if;

          if (qt_minuto_aplicacao_w = 0) then
            qt_minuto_aplicacao_w  := null;
          end if;

          update paciente_atend_medic
             set qt_min_aplicacao  = qt_minuto_aplicacao_w,
                 qt_hora_aplicacao = qt_hora_aplicacao_w
           where nr_seq_atendimento = nr_seq_atendimento_p
             and nr_seq_material = nr_seq_material_p
             and ie_aplic_bolus = 'N'
             and ie_aplic_lenta = 'N'
             and ((ie_priorizar_min_w = 'N') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''))
             and ((coalesce(ie_substitui_tempo_atual_w, 'N') = 'S' and
                 ie_proporcao_w <> 'ST') or (coalesce(qt_min_aplicacao::text, '') = '' and coalesce(qt_hora_aplicacao::text, '') = ''));


          if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then
            update paciente_atend_medic
               set qt_min_aplicacao  = qt_minuto_aplicacao_w,
                   qt_hora_aplicacao = qt_hora_aplicacao_w
             where nr_seq_atendimento = nr_seq_atendimento_p
               and nr_seq_material = nr_seq_material_p
               and ie_aplic_bolus = 'N'
               and ie_aplic_lenta = 'N';
          end if;


        insert into paciente_atend_medic( nr_seq_diluicao,
                  nr_seq_material,
                  nr_agrupamento,
                  ds_recomendacao,
                  nr_seq_atendimento,
                  cd_material,
                  qt_dose,
                  cd_unid_med_dose,
                  ie_via_aplicacao,
                  dt_atualizacao,
                  nm_usuario,
                  qt_min_aplicacao,
                  ie_bomba_infusao,
                  qt_hora_aplicacao,
                  cd_intervalo,
                  nr_seq_interno,
                  qt_dias_util,
                  ie_se_necessario,
                  ds_observacao,
                  ie_urgencia,
                  ie_aplic_bolus,
                  ie_aplic_lenta,
                  cd_unid_med_prescr,
                  qt_dose_prescricao,
                  ie_pre_medicacao,
                  nr_seq_solucao,
                  ie_gerar_solucao,
                  pr_reducao,
                  nr_seq_reconstituinte,
                  ie_agrupador,
                  ie_aplica_reducao,
                  ie_zerado,
                  ie_regra_diluicao_cad_mat,
                  ie_cancelada)
         values (
                  nr_seq_material_p,
                  nr_sequencia_w,
                  0,
                  null,
                  nr_seq_atendimento_p,
                  cd_diluente_w,
                  qt_diluicao_w,
                  cd_unid_med_diluente_w,
                  ie_via_aplicacao_w,
                  clock_timestamp(),
                  nm_usuario_p,
                  null,
                  ie_bomba_infusao_w,
                  null,
                  null,
                  nextval('paciente_atend_medic_seq'),
                  null,
                  null,
                  null,
                  null,
                  null,
                  null,
                  cd_unid_med_diluente_w,
                  qt_diluicao_w,
                  'N',
                  null,
                  'N',
                  null,
                  null,
                  7,
                  'N',
                  'N',
                  'N',
                  'N');

        elsif (ie_gera_dil_dose_w  = 'S') then
          null;
        end if;
      end if;
    end if;
    /* inserir o rediluente*/

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao_ciclo ( nr_seq_atendimento_p bigint, nr_seq_material_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

