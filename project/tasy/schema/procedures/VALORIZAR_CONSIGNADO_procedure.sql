-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valorizar_consignado ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_fornecedor_w		varchar(14);
cd_local_estoque_w	integer;
cd_material_w		integer;
vl_custo_w		double precision;
qt_estoque_w		double precision;
vl_estoque_w		double precision;
vl_estoque_ant_w		double precision;
vl_preco_ult_compra_w	fornecedor_mat_consignado.vl_preco_ult_compra%type;

c01 CURSOR FOR
SELECT a.cd_material,
	cd_local_estoque,
	cd_fornecedor,
	qt_estoque,
	vl_preco_ult_compra
from	fornecedor_mat_consignado a
where	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.dt_mesano_referencia	= pkg_date_utils.start_of(dt_mesano_referencia_p,'MONTH',0)
and (qt_estoque > 0 or vl_estoque > 0)
order by cd_material, cd_fornecedor, cd_local_estoque;


BEGIN

open c01;
loop
fetch c01 into
	cd_material_w,
	cd_local_estoque_w,
	cd_fornecedor_w,
	qt_estoque_w,
	vl_preco_ult_compra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	coalesce(max(dividir((a.vl_total_item_nf - a.vl_desconto -
   		vl_desconto_rateio + vl_frete +
	        a.vl_despesa_acessoria + a.vl_seguro), coalesce(a.qt_item_estoque, a.qt_item_nf))),0) /*fabio 10/05/2004*/
	into STRICT	vl_custo_w
	from 	nota_fiscal_item a
	where	a.cd_material_estoque	= cd_material_w	/*fabio 10/05/2004 - não estava buscando o material correto*/
	and	a.nr_sequencia =
		(SELECT max(i.nr_sequencia)
		from	nota_fiscal_item i,
			operacao_estoque e,
			operacao_nota o,
			nota_fiscal n
		where	i.nr_sequencia 		= n.nr_sequencia
		and	i.cd_material_estoque	= cd_material_w
		and 	n.cd_cgc			= cd_fornecedor_w
		and	n.dt_entrada_saida		> clock_timestamp() - interval '400 days'
		and	n.cd_operacao_nf		= o.cd_operacao_nf
		and	o.cd_operacao_estoque	= e.cd_operacao_estoque
		and	e.ie_consignado in ('1','3'));

	if (vl_custo_w = 0) and (coalesce(vl_preco_ult_compra_w,0) > 0) then
		vl_custo_w	:= vl_preco_ult_compra_w;
	end if;

	vl_estoque_w	:= qt_estoque_w * vl_custo_w;

	update	fornecedor_mat_consignado
	set	vl_estoque		= vl_estoque_w,
		vl_custo_medio		= vl_custo_w
	where	cd_estabelecimento		= cd_estabelecimento_p
	and	cd_local_estoque		= cd_local_estoque_w
	and	cd_fornecedor		= cd_fornecedor_w
	and	cd_material		= cd_material_w
	and	dt_mesano_referencia	= pkg_date_utils.start_of(dt_mesano_referencia_p,'MONTH',0);

	/*se naõ encontrou a ultima nota, mas tinha valor no mes passado, tambem joga o novo valor*/

	/*isto é necessário para por exemplo : importações de saldos e valores*/

	if (vl_custo_w = 0) then
		select	coalesce(max(vl_custo_medio),0)
		into STRICT	vl_estoque_ant_w
		from	fornecedor_mat_consignado
		where	cd_estabelecimento		= cd_estabelecimento_p
		and	cd_local_estoque		= cd_local_estoque_w
		and	cd_fornecedor		= cd_fornecedor_w
		and	cd_material		= cd_material_w
		and	dt_mesano_referencia	= pkg_date_utils.start_of(pkg_date_utils.add_month(dt_mesano_referencia_p,-1,0),'MONTH',0);

		if (vl_estoque_ant_w > 0) then
			update	fornecedor_mat_consignado
			set	vl_estoque		= (qt_estoque * vl_estoque_ant_w),
				vl_custo_medio		= vl_estoque_ant_w
			where	cd_estabelecimento		= cd_estabelecimento_p
			and	cd_local_estoque		= cd_local_estoque_w
			and	cd_fornecedor		= cd_fornecedor_w
			and	cd_material		= cd_material_w
			and	dt_mesano_referencia	= pkg_date_utils.start_of(dt_mesano_referencia_p,'MONTH',0);
		end if;
	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valorizar_consignado ( dt_mesano_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

