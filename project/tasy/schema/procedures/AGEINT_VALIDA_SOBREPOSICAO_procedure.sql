-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_valida_sobreposicao (hr_marcacao_p timestamp, cd_agenda_p bigint, nm_usuario_p text, nr_seq_ageint_item_p bigint, ie_consistencia_p INOUT text) AS $body$
DECLARE


ie_sobreposicao_param_w parametro_agenda.ie_consiste_duracao%type := 'N';
nr_min_dur_final_w ageint_marcacao_usuario.nr_minuto_duracao%type;
ie_sobreposicao_w varchar(1);
ie_consistencia_w varchar(255) := '';


BEGIN



select  coalesce(max(ie_consiste_duracao), 'N')
into STRICT  ie_sobreposicao_param_w
from  parametro_agenda
where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select coalesce(max(nr_minuto_duracao),0)	
  into STRICT nr_min_dur_final_w
  from ageint_marcacao_usuario
 where nm_usuario = nm_usuario_p
   AND CD_AGENDA = cd_agenda_p
   and coalesce(IE_GERADO,'N') = 'N'
   AND NR_SEQ_AGEINT_ITEM = nr_seq_ageint_item_p;
	
	if (ie_sobreposicao_param_w = 'A') then
	  if (nr_min_dur_final_w > 0) then
		ie_sobreposicao_w := obter_se_sobreposicao_horario(
														  cd_agenda_p,
														  hr_marcacao_p,
														  nr_min_dur_final_w);
		
		if (ie_sobreposicao_w = 'S') then				 
			ie_consistencia_w := ie_sobreposicao_param_w;
		end if;		
	  end if;	
	end if;
	
	ie_consistencia_p := ie_consistencia_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_valida_sobreposicao (hr_marcacao_p timestamp, cd_agenda_p bigint, nm_usuario_p text, nr_seq_ageint_item_p bigint, ie_consistencia_p INOUT text) FROM PUBLIC;

