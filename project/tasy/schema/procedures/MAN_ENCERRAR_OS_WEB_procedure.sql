-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_encerrar_os_web ( nr_seq_ordem_serv_p bigint, ds_motivo_p text, ie_grau_satisf_p text, ie_agilidade_p text, ie_conhecimento_p text, ie_cordialidade_p text, ie_solucao_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_estagio_w		bigint;
nr_seq_tipo_hist_w		bigint;
nm_user_w		varchar(50);


BEGIN
if (nr_seq_ordem_serv_p > 0) then
	select	username
	into STRICT	nm_user_w
	from	user_users;

	if (nm_user_w = 'CORP') then
		nr_seq_estagio_w	:= 511;
		nr_seq_tipo_hist_w	:= 4;
	end if;

	update	man_ordem_servico
	set	nr_seq_estagio	 	= coalesce(nr_seq_estagio_w, nr_seq_estagio),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		ie_grau_satisfacao		= ie_grau_satisf_p
	where	nr_sequencia		= nr_seq_ordem_serv_p;

	if (coalesce(ds_motivo_p,'X') <> 'X') then
		insert into man_ordem_serv_tecnico(
			nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			cd_versao_tasy,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			nm_usuario_lib,
			dt_liberacao)
		values (	nextval('man_ordem_serv_tecnico_seq'),
			nr_seq_ordem_serv_p,
			clock_timestamp(),
			nm_usuario_p,
			wheb_rtf_pck.get_texto_rtf(wheb_mensagem_pck.get_texto(305327,'DS_MOTIVO=' || ds_motivo_p)),
			'',
			clock_timestamp(),
			'E',
			nr_seq_tipo_hist_w,
			nm_usuario_p,
			clock_timestamp());

	end if;

	if (coalesce(ie_agilidade_p,'X') <> 'X') and (coalesce(ie_conhecimento_p,'X') <> 'X') and (coalesce(ie_cordialidade_p,'X') <> 'X') and (coalesce(ie_solucao_p,'X') <> 'X') then
		CALL man_informar_grau_satisfacao(	nr_seq_ordem_serv_p,
						ie_solucao_p,
						ie_agilidade_p,
						ie_conhecimento_p,
						ie_cordialidade_p,
						nm_usuario_p,
						ie_grau_satisf_p,
						'');
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_encerrar_os_web ( nr_seq_ordem_serv_p bigint, ds_motivo_p text, ie_grau_satisf_p text, ie_agilidade_p text, ie_conhecimento_p text, ie_cordialidade_p text, ie_solucao_p text, nm_usuario_p text) FROM PUBLIC;

