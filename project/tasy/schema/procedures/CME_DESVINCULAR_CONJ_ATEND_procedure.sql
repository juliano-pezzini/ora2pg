-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_desvincular_conj_atend ( cd_barras_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_paciente_w            varchar(100);
nr_atendimento_w        bigint;
ds_observacao_w        varchar(255);
nr_sequencia_w           bigint;
ie_tipo_w               	     varchar(10);
nr_interno_conta_w      bigint;
cd_motivo_exc_conta_w   bigint;
cd_estabelecimento_w      bigint;
ds_regra_bloq_conj_w      varchar(1);
nm_usuario_origem_w      usuario.nm_usuario%type;
nm_usuario_w             usuario.nm_usuario%type;
ie_lib_registro_vinc_conj_w varchar(2);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(320459, null, wheb_usuario_pck.get_nr_seq_idioma);--Desfazer Desfecho
c02 CURSOR FOR
   SELECT   'P' ie_tipo,
            a.nr_sequencia,
            a.nr_interno_conta
   from     procedimento_paciente a,
            conta_paciente b,
            regra_lanc_automatico c
   where a.nr_interno_conta   = b.nr_interno_conta
   and   b.nr_Atendimento     = nr_atendimento_p
   and   c.nr_sequencia       = a.nr_seq_regra_lanc
   and   b.ie_status_acerto   = 1
   and   c.NR_SEQ_EVENTO      = 332
   and   coalesce(a.cd_motivo_exc_conta::text, '') = ''
   and   a.ds_observacao like '%'||cd_barras_p||'%'

union all

   SELECT   'M' ie_tipo,
            a.nr_sequencia,
            a.nr_interno_conta
   from     material_Atend_paciente a,
            conta_paciente b,
            regra_lanc_automatico c
   where a.nr_interno_conta   = b.nr_interno_conta
   and   b.nr_Atendimento     = nr_atendimento_p
   and   c.nr_sequencia       = a.nr_seq_regra_lanc
   and   b.ie_status_acerto   = 1
   and   c.NR_SEQ_EVENTO      = 332
   and   coalesce(a.cd_motivo_exc_conta::text, '') = ''
   and   a.ds_observacao like '%'||cd_barras_p||'%';



BEGIN

select   substr(obter_pessoa_atendimento(nr_atendimento_p,'N'),1,100)
into STRICT     nm_paciente_w
;

ds_observacao_w   := WHEB_MENSAGEM_PCK.get_texto(300048,'NM_PACIENTE_W='|| NM_PACIENTE_W ||';NR_ATENDIMENTO_P='|| NR_ATENDIMENTO_P);
         /*Paciente: #@NM_PACIENTE_W#@ Num Atendimento: #@NR_ATENDIMENTO_P#@.*/

begin

select 	  nr_atendimento,
       	  nm_usuario_origem,
       	  nm_usuario
into STRICT   	  nr_atendimento_w,
         	nm_usuario_origem_w,
         	nm_usuario_w
from     cm_conjunto_cont
where    nr_sequencia   = cd_barras_p
and       coalesce(ie_situacao,'A') = 'A';
exception
   when others then
      -- Conjunto nao encontrado!
      CALL Wheb_mensagem_pck.exibir_mensagem_abort(153617);
end;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

   select   cd_estabelecimento
   into STRICT     cd_estabelecimento_w
   from     atendimento_paciente
   where    nr_atendimento = nr_atendimento_p;

   ds_regra_bloq_conj_w := Obter_Param_Usuario(281, 408, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_regra_bloq_conj_w);
   ie_lib_registro_vinc_conj_w := Obter_param_usuario(88, 355, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_lib_registro_vinc_conj_w);

   if (( ds_regra_bloq_conj_w  = 'S' and
         nm_usuario_p          <> nm_usuario_origem_w) or (  ds_regra_bloq_conj_w = 'U' and 
         nm_usuario_p         <> nm_usuario_w)) then
      --Somente o usuario original pode desvincular o conjunto!
      CALL Wheb_mensagem_pck.exibir_mensagem_abort(22007);
   else
      update   cm_conjunto_cont
      set   nr_atendimento     = NULL,
            ds_observacao      = NULL,
            dt_atualizacao    = clock_timestamp(),
            nm_usuario        = nm_usuario_p,
            NM_USUARIO_VINC    = NULL,
            DT_VINCULO_CONJ    = NULL,
			dt_liberacao = CASE WHEN ie_lib_registro_vinc_conj_w='S' THEN  dt_liberacao END
      where nr_sequencia      = cd_barras_p;

      select   max(cd_motivo_exc_conta)
      into STRICT     cd_motivo_exc_conta_w
      from     parametro_faturamento
      where    cd_estabelecimento   = cd_estabelecimento_w;

      open C02;
      loop
      fetch C02 into
         ie_tipo_w,
         nr_sequencia_w,
         nr_interno_conta_w;
      EXIT WHEN NOT FOUND; /* apply on C02 */
         begin
         CALL excluir_matproc_conta(nr_sequencia_w,nr_interno_conta_w,cd_motivo_exc_conta_w,expressao1_w,ie_tipo_w,nm_usuario_p);
         end;
      end loop;
      close C02;

      commit;
   end if;
else
   -- Este conjunto nao pertence ao atendimento.
   CALL Wheb_mensagem_pck.exibir_mensagem_abort(264837);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_desvincular_conj_atend ( cd_barras_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

