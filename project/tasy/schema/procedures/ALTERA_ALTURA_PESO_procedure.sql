-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_altura_peso ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, qt_peso_p text, qt_altura_p text, nr_prescricao_p bigint, dt_prevista_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
ie_recalcular_dose_prescr_p	varchar(1);
ie_altera_todos_peso_p	varchar(1);


BEGIN 
 
if (qt_altura_p IS NOT NULL AND qt_altura_p::text <> '') then 
	begin 
	update	paciente_setor 
	set	qt_altura		= qt_altura_p 
	where	nr_seq_paciente	= nr_seq_paciente_p;
 
	update	paciente_atendimento 
	set	qt_altura			= qt_altura_p 
	where	nr_seq_atendimento	= nr_seq_atendimento_p;
	end;
end if;
 
if (qt_peso_p IS NOT NULL AND qt_peso_p::text <> '') then 
	begin 
	update	paciente_setor 
	set	qt_peso		= qt_peso_p 
	where	nr_seq_paciente	= nr_seq_paciente_p;
 
	update	paciente_atendimento 
	set	qt_peso			= qt_peso_p 
	where	nr_seq_atendimento	= nr_seq_atendimento_p;
 
	commit;
 
	if (coalesce(nr_prescricao_p::text, '') = '') then 
		begin 
		/* Quimioterapia - Parâmetro [113] - Ao alterar peso e altura, caso não tenha prescrição, recalcular as doses */
 
		ie_recalcular_dose_prescr_p := obter_param_usuario(3130, 113, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_recalcular_dose_prescr_p);
 
		if (ie_recalcular_dose_prescr_p = 'S') then 
			CALL atualizar_dose_onc_ciclo(nr_seq_atendimento_p);
		end if;
		end;
	end if;
 
	/* Quimioterapia - Parâmetro [177] - Ao atualizar o peso, modificar para todos os ciclos */
 
	ie_altera_todos_peso_p := obter_param_usuario(3130, 113, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_altera_todos_peso_p);
 
	if (ie_altera_todos_peso_p = 'S') then 
		begin 
		CALL alterar_peso_ciclo( 
			obter_dados_paciente_setor(nr_seq_paciente_p, 'C'), 
			qt_peso_p, 
			dt_prevista_p, 
			nm_usuario_p);
		end;
	end if;
	end;
end if;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_altura_peso ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, qt_peso_p text, qt_altura_p text, nr_prescricao_p bigint, dt_prevista_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

