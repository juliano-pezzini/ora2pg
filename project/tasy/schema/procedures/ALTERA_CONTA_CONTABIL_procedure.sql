-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_conta_contabil ( cd_conta_contabil_p text, cd_centro_custo_p bigint, nr_seq_conta_financ_p bigint, nr_sequencia_p bigint, nr_item_nf_p bigint, ie_nota_fiscal_p text default null) AS $body$
DECLARE


nr_titulo_w		titulo_pagar.nr_titulo%type;
nr_lote_contabil_w	titulo_pagar.nr_lote_contabil%type;
ie_situacao_w		titulo_pagar.ie_situacao%type;
vl_classif_w		titulo_pagar_classif.vl_titulo%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
vl_saldo_w		titulo_pagar.vl_saldo_titulo%type;
vl_baixa_w		titulo_pagar_baixa.vl_baixa%type;
vl_adiantamento_w	titulo_pagar_adiant.vl_adiantamento%type;
ie_consiste_baixa_w	varchar(4000);
ie_conta_financ_w       varchar(4000) := 'S';
ie_centro_custo_w       varchar(4000) := 'S';
ie_conta_contabil_w     varchar(4000) := 'S';

c01 CURSOR FOR
SELECT  nr_titulo,
	coalesce(nr_lote_contabil,0),
	ie_situacao,
	(obter_dados_tit_pagar(nr_titulo, 'VT'))::numeric ,
	cd_estabelecimento,
	vl_saldo_titulo
from	titulo_pagar
where	nr_seq_nota_fiscal = nr_sequencia_p;



BEGIN

if (ie_nota_fiscal_p = 'S') then

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		nr_lote_contabil_w,
		ie_situacao_w,
		vl_classif_w,
		cd_estabelecimento_w,
		vl_saldo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	coalesce(sum(vl_baixa),0)
		into STRICT 	vl_baixa_w
		from	titulo_pagar_baixa
		where	nr_titulo = nr_titulo_w;

		select	coalesce(sum(vl_adiantamento),0)
		into STRICT	vl_adiantamento_w
		from	titulo_pagar_adiant
		where	nr_titulo	= nr_titulo_w;


		if (((ie_conta_financ_w = 'S') or (ie_centro_custo_w	= 'S' AND nr_lote_contabil_w	= 0)
			or (ie_conta_contabil_w	= 'S' AND nr_lote_contabil_w	= 0)) and (vl_baixa_w <> 0 or vl_adiantamento_w <> 0)) then
				ie_consiste_baixa_w := substr(ie_consiste_baixa_w || ' '|| nr_titulo_w,1,4000);
		end if;

	end loop;
	close c01;

		if ((ie_consiste_baixa_w IS NOT NULL AND ie_consiste_baixa_w::text <> '') or ie_consiste_baixa_w <> '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1040047,'ds_lista_titulos='||ie_consiste_baixa_w);
	end if;

end if;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin
	update	nota_fiscal_item
	set     cd_conta_contabil       = cd_conta_contabil_p,
		cd_centro_custo		= cd_centro_custo_p,
		nr_seq_conta_financ	= nr_seq_conta_financ_p
	where   nr_sequencia  		= nr_sequencia_p
	and 	nr_item_nf		= nr_item_nf_p;
	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_conta_contabil ( cd_conta_contabil_p text, cd_centro_custo_p bigint, nr_seq_conta_financ_p bigint, nr_sequencia_p bigint, nr_item_nf_p bigint, ie_nota_fiscal_p text default null) FROM PUBLIC;

