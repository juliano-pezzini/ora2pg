-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_itens_conta AS (	nr_seq_conta_item		bigint,
					nr_seq_conta_resumo		bigint,
					ie_tipo_conta			varchar(10),
					cd_conta_cred			varchar(20),
					cd_conta_deb			varchar(20),
					cd_classif_cred			varchar(255),
					cd_classif_deb			varchar(255),
					nr_seq_esquema			bigint,
					cd_historico			bigint,
					cd_conta_glosa_cred		varchar(20),
					cd_conta_glosa_deb		varchar(20),
					cd_classif_glosa_cred		varchar(255),
					cd_classif_glosa_deb		varchar(255),
					nr_seq_esquema_glosa		bigint,
					cd_historico_glosa		bigint,
					nr_seq_grupo_ans		bigint,
					cd_conta_cred_tx_inter		varchar(20),
					cd_conta_deb_tx_inter		varchar(20),
					cd_classif_tx_inter_cred	varchar(255),
					cd_classif_tx_inter_deb		varchar(255),
					nr_seq_esquema_tx_inter		bigint,
					cd_historico_tx_inter		bigint,
					cd_conta_cred_tx_inter_glosa	varchar(20),
					cd_conta_deb_tx_inter_glosa	varchar(20),
					cd_classif_tx_glosa_cred	varchar(255),
					cd_classif_tx_glosa_deb		varchar(255),
					nr_seq_esquema_tx_inter_glosa	bigint,
					cd_historico_tx_inter_glosa	bigint,
					cd_historico_vl_ajuste		bigint,
					nr_id				oid);


CREATE OR REPLACE PROCEDURE ctb_pls_atualizar_prod_med_res ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_movimento_p INOUT integer, dt_referencia_p pls_protocolo_conta.dt_mes_competencia%type) AS $body$
DECLARE

						
cd_classificacao_credito_w	varchar(255);
cd_classificacao_debito_w	varchar(255);
nr_seq_grupo_ans_w		bigint;
ie_preco_w			varchar(2);
ie_tipo_relacao_w		varchar(2);
ie_tipo_ato_w			varchar(255)	:= '1';
ie_regulamentacao_w		varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_segmentacao_w		varchar(2);
nr_seq_grupo_superior_w		bigint;
nr_seq_grupo_ans_ww		bigint;
ie_classif_grupo_w		varchar(5);
ie_classif_grupo_ww		varchar(5);
dt_referencia_w			timestamp;
nr_seq_plano_w			bigint;
nr_seq_esquema_w		bigint;
cd_conta_credito_w		varchar(20);
cd_conta_debito_w		varchar(20);
cd_historico_padrao_w		bigint;
cd_historico_estorno_w		bigint;
cd_historico_baixa_w		bigint;
ie_tipo_contrato_w		varchar(2);
ie_tipo_segurado_w		varchar(3);
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_tipo_despesa_w		pls_conta_proc.ie_tipo_despesa%type;
ds_erro_w			varchar(4000);
ie_tipo_guia_w			varchar(2);
nr_seq_tipo_atendimento_w	bigint;
cd_medico_executor_w		varchar(10);
ie_regime_internacao_w		varchar(1);
nr_seq_conselho_w		bigint;
ie_ato_cooperado_w		varchar(1);
nr_seq_prestador_w		bigint;
ie_codificacao_w		varchar(2);
vl_fixo_w			varchar(30);
cd_conta_contabil_w		varchar(20);
ie_debito_credito_w		varchar(1);
nr_seq_tipo_prestador_w		bigint;
ie_tipo_prestador_w		varchar(10);
ie_conta_glosa_w		varchar(2);
ds_mascara_w			varchar(40);
cd_conta_glosa_cred_w		varchar(20);
cd_conta_glosa_deb_w		varchar(20);
cd_conta_cred_w			varchar(20);
cd_conta_deb_w			varchar(20);
cd_classificacao_cred_w		varchar(255);
cd_classificacao_deb_w		varchar(255);
cd_classif_glosa_cred_w		varchar(255);
cd_classif_glosa_deb_w		varchar(255);
nr_seq_esquema_ww		bigint;
cd_historico_padrao_ww		bigint;
cd_historico_estorno_ww		bigint;
cd_historico_baixa_ww		bigint;
nr_seq_plano_ww			bigint;
nr_seq_prestador_ww		bigint;
ie_tipo_ptu_ww			varchar(2);
ie_tipo_segurado_ww		varchar(3);
ie_tipo_relacao_ww		varchar(2);
ie_tipo_vinculo_operadora_w	varchar(2);
ie_tipo_vinculo_operadora_ww	varchar(2);
nr_seq_contrato_w		bigint;
nr_seq_contrato_ww		bigint;
nr_seq_grupo_contrato_w		bigint;
nr_seq_grupo_contrato_ww	bigint;
nr_seq_intercambio_w		bigint;
cd_classificacao_item_w		varchar(30);
cd_cgc_prestador_w		varchar(14);
cd_pf_prestador_w		varchar(10);
ie_tipo_guia_ww			varchar(2);
nr_vetor_w			bigint;
i				bigint;
ie_grupo_despesa_ans_w		varchar(10);
nr_seq_material_w		bigint;
ie_tipo_repasse_w		varchar(1);
nr_seq_segurado_w		bigint;
nr_seq_intercambio_ww		bigint;
nr_seq_classif_sca_ww		bigint;
nr_seq_classificacao_sca_w	bigint;
qt_esquema_tx_inter_w		bigint;
ie_tipo_prestador_ww		varchar(10);
nr_seq_tipo_prestador_ww	bigint;
cd_pessoa_fisica_w		varchar(10);
cd_pessoa_fisica_titular_w	varchar(10);
nr_seq_titular_w		bigint;
cd_estabelecimento_setor_w	smallint;
cd_estab_setor_pessoa_ww	smallint;
ie_status_conta_w		varchar(1);
nr_seq_conta_resumo_w		bigint;

qt_esquema_pagamento_w		bigint;
qt_commit_w			bigint	:= 0;
qt_movimento_w			bigint	:= 0;
qt_movimento_ww			bigint	:= 0;
nr_id_w				oid;
ie_status_prov_pagto_w		pls_parametro_contabil.ie_status_prov_pagto%type;
ie_lote_ajuste_prod_w		pls_parametro_contabil.ie_lote_ajuste_prod%type;
cd_empresa_w			empresa.cd_empresa%type;
ie_tipo_compartilhamento_w	pls_esquema_contabil.ie_tipo_compartilhamento%type;
ie_benef_remido_w		pls_esquema_contabil.ie_benef_remido%type;
nr_seq_congenere_w		pls_protocolo_conta.nr_seq_congenere%type;
dt_ref_repasse_w		timestamp;
dt_repasse_w			timestamp;
dt_fim_repasse_w		timestamp;
nr_seq_tipo_conta_w		pls_conta.nr_seq_tipo_conta%type;
ie_data_tipo_segurado_w		pls_parametros.ie_data_tipo_segurado%type;
dt_mes_competencia_prot_w	pls_protocolo_conta.dt_mes_competencia%type;

/* ie_conta_glosa_w
conforme dominio 3976
11 - Conta medica - Participacao dos Beneficiarios em eventos/sinistros indenizados
12 - Conta medica - Recuperacao/Ressarcimento de Eventos
*/
type vetor_contas is table of reg_itens_conta index by integer;
vetor_contas_w			vetor_contas;

c_itens CURSOR FOR
	SELECT	oid nr_id,
		(SELECT	a.nr_sequencia
		from	pls_conta_proc		a
		where	a.nr_sequencia	= b.nr_seq_conta_proc) nr_seq_conta_proc,
		null nr_seq_conta_mat,
		b.nr_sequencia nr_seq_resumo,
		b.cd_procedimento,
		b.ie_origem_proced,
		b.ie_tipo_despesa,
		coalesce(b.nr_seq_grupo_ans,(select	a.nr_seq_grupo_ans
					from	pls_conta_proc		a
					where	a.nr_sequencia	= b.nr_seq_conta_proc)) nr_seq_grupo_ans,		
		coalesce(b.ie_ato_cooperado,(select	a.ie_ato_cooperado
					from	pls_conta_proc		a
					where	a.nr_sequencia	= b.nr_seq_conta_proc)) ie_ato_cooperado,
		null nr_seq_material,
		b.nr_seq_prestador_pgto,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  dt_mes_competencia_prot_w  ELSE (coalesce((	select	p.dt_procedimento											from    pls_conta_proc p											where   p.nr_sequencia	= b.nr_seq_conta_proc), dt_referencia_p)) END  dt_ref_repasse
	from	pls_conta_medica_resumo	b
	where	b.ie_situacao	= 'A'
	and	b.nr_seq_conta	= nr_seq_conta_p
	and	(b.nr_seq_prestador_pgto IS NOT NULL AND b.nr_seq_prestador_pgto::text <> '')
	and	(b.nr_seq_conta_proc IS NOT NULL AND b.nr_seq_conta_proc::text <> '')
	and	((b.nr_seq_conta_proc = nr_seq_conta_proc_p) or (coalesce(nr_seq_conta_proc_p::text, '') = ''))
	and	exists (	select	1
				from	pls_lote_pagamento	l
				where	l.nr_sequencia		= b.nr_seq_lote_pgto
				and	coalesce(l.nr_lote_contabil,0) = 0
				
union all

				select	1
				from	pls_pp_item_lote	p
				where	b.nr_sequencia	= p.nr_seq_resumo
				and	b.nr_seq_conta	= p.nr_seq_conta
				and	coalesce(p.nr_lote_contabil,0) = 0)
	
union all

	select	b.oid nr_id,
		null,
		(select	a.nr_sequencia
		from	pls_conta_mat		a
		where	a.nr_sequencia	= b.nr_seq_conta_mat) nr_seq_conta_mat,
		b.nr_sequencia nr_seq_resumo,
		null,
		null,
		b.ie_tipo_despesa,
		coalesce(b.nr_seq_grupo_ans,(select	a.nr_seq_grupo_ans
					from	pls_conta_mat		a
					where	a.nr_sequencia	= b.nr_seq_conta_mat)) nr_seq_grupo_ans,
		coalesce(b.ie_ato_cooperado,(select	a.ie_ato_cooperado
					from	pls_conta_mat		a
					where	a.nr_sequencia	= b.nr_seq_conta_mat)) ie_ato_cooperado,
		b.nr_seq_material,
		b.nr_seq_prestador_pgto,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  dt_mes_competencia_prot_w  ELSE (coalesce((	select  m.dt_atendimento											from    pls_conta_mat m											where   m.nr_sequencia	= b.nr_seq_conta_mat), dt_referencia_p)) END  dt_ref_repasse
	from	pls_conta_medica_resumo	b
	where	b.ie_situacao	= 'A'
	and	b.nr_seq_conta	= nr_seq_conta_p
	and	(b.nr_seq_prestador_pgto IS NOT NULL AND b.nr_seq_prestador_pgto::text <> '')
	and	(b.nr_seq_conta_mat IS NOT NULL AND b.nr_seq_conta_mat::text <> '')
	and	((b.nr_seq_conta_mat = nr_seq_conta_mat_p) or (coalesce(nr_seq_conta_mat_p::text, '') = ''))
	and	exists (select	1
				from	pls_lote_pagamento	l
				where	l.nr_sequencia		= b.nr_seq_lote_pgto
				and	coalesce(l.nr_lote_contabil,0) = 0
				
union all

				select	1
				from	pls_pp_item_lote	p
				where	b.nr_sequencia	= p.nr_seq_resumo
				and	b.nr_seq_conta	= p.nr_seq_conta
				and	coalesce(p.nr_lote_contabil,0) = 0);

c_tipo_movimento CURSOR FOR
	SELECT	11 ie_conta_glosa  --Evento
	
	
union

	SELECT	12 ie_conta_glosa  -- Glosa
	
	where	ie_status_prov_pagto_w <> 'F'
	
union

	select	18 ie_conta_glosa  -- Valor Ajuste
	
	where 	ie_lote_ajuste_prod_w = 'R';
	/*union
	select	14 ie_conta_glosa -- Taxa de intercambio
	from	dual
	where	qt_esquema_tx_inter_w > 0
	union
	select	15 ie_conta_glosa -- Taxa de intercambio (Glosa)
	from	dual
	where	qt_esquema_tx_inter_w > 0;*/
c_esquema_contabil CURSOR FOR
	/*+ CHOOSE*/
	SELECT	nr_sequencia,
		cd_historico_padrao,
		cd_historico_estorno,
		cd_historico_baixa,
		nr_seq_plano,
		nr_seq_prestador,
		ie_tipo_relacao,
		nr_seq_contrato,
		ie_tipo_vinculo_operadora,
		nr_seq_grupo_contrato,
		ie_tipo_guia,
		nr_seq_intercambio,
		nr_seq_classif_sca,
		ie_tipo_ptu,
		nr_seq_tipo_prestador,
		cd_estab_setor_pessoa
	from	pls_esquema_contabil
	where	ie_tipo_regra		= 'PM'
	and	ie_prestador_codificacao = 'P'
	and	dt_referencia_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_referencia_w)
	and	ie_tipo_movimentacao	= ie_conta_glosa_w
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	((ie_tipo_segurado	= ie_tipo_segurado_w) or (coalesce(ie_tipo_segurado::text, '') = ''))
	and	((ie_tipo_repasse	= ie_tipo_repasse_w) or (coalesce(ie_tipo_repasse::text, '') = ''))
	and	((ie_tipo_compartilhamento = ie_tipo_compartilhamento_w) or (coalesce(ie_tipo_compartilhamento::text, '') = ''))
	and	((ie_benef_remido	= ie_benef_remido_w) or (coalesce(ie_benef_remido::text, '') = ''))
	and	((nr_seq_tipo_conta 	= nr_seq_tipo_conta_w) or (coalesce(nr_seq_tipo_conta::text, '') = ''))
	order by coalesce(ie_tipo_vinculo_operadora,' '),
		coalesce(nr_seq_contrato,0),
		coalesce(nr_seq_prestador,0),
		coalesce(nr_seq_plano,0),
		coalesce(nr_seq_classif_sca,0),
		coalesce(ie_tipo_guia,' '),
		coalesce(ie_tipo_relacao,' '),
		coalesce(nr_seq_tipo_prestador,0),
		coalesce(ie_tipo_ptu,' '),
		coalesce(ie_tipo_compartilhamento,0),
		coalesce(ie_tipo_repasse,' '),
		coalesce(ie_tipo_segurado,' '),
		coalesce(ie_benef_remido,' '),
		coalesce(nr_seq_intercambio,0),
		coalesce(nr_seq_grupo_contrato,0),
		coalesce(cd_estab_setor_pessoa,0),
		coalesce(nr_seq_tipo_conta,0),
		coalesce(dt_inicio_vigencia,clock_timestamp());

c_segmentacao CURSOR FOR
	SELECT
		ie_codificacao,
		vl_fixo,
		cd_conta_contabil,
		ie_debito_credito,
		ds_mascara
	from	pls_esquema_contabil_seg
	where	nr_seq_regra_esquema = nr_seq_esquema_w
	order by	ie_debito_credito,
			nr_seq_apresentacao;


TYPE 		fetch_array IS TABLE OF c_itens%ROWTYPE;
s_array 	fetch_array;
w		integer := 1;
type Vetor is table of fetch_array index by integer;
vetor_itens_w			Vetor;

BEGIN
begin
qt_movimento_w	:= qt_movimento_p;

select	d.ie_tipo_contratacao,
	d.ie_preco,
	d.ie_segmentacao,
	d.ie_regulamentacao,
	b.dt_mes_competencia,
	coalesce(coalesce(a.ie_tipo_segurado,c.ie_tipo_segurado),'B'),
	coalesce(d.nr_sequencia,0),
	c.ie_tipo_vinculo_operadora,
	c.nr_seq_contrato,
	c.nr_seq_intercambio,
	a.ie_tipo_guia,
	a.nr_seq_tipo_atendimento,
	a.cd_medico_executor,
	a.ie_regime_internacao,
	c.nr_sequencia,
	d.nr_seq_classificacao,
	c.cd_pessoa_fisica,
	c.nr_seq_titular,
	a.ie_status,
	pls_obter_se_benef_remido(c.nr_sequencia,dt_referencia_p) ie_benef_remido,
	b.nr_seq_congenere,
	a.nr_seq_tipo_conta,
	b.dt_mes_competencia
into STRICT	ie_tipo_contratacao_w,
	ie_preco_w,
	ie_segmentacao_w,
	ie_regulamentacao_w,
	dt_referencia_w,
	ie_tipo_segurado_w,
	nr_seq_plano_w,
	ie_tipo_vinculo_operadora_w,
	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	ie_tipo_guia_w,
	nr_seq_tipo_atendimento_w,
	cd_medico_executor_w,
	ie_regime_internacao_w,
	nr_seq_segurado_w,
	nr_seq_classificacao_sca_w,
	cd_pessoa_fisica_w,
	nr_seq_titular_w,
	ie_status_conta_w,
	ie_benef_remido_w,
	nr_seq_congenere_w,
	nr_seq_tipo_conta_w,
	dt_mes_competencia_prot_w
from	pls_conta 		a,
	pls_protocolo_conta	b,
	pls_segurado		c,
	pls_plano 		d
where	a.nr_seq_protocolo	= b.nr_sequencia
and	a.nr_seq_segurado	= c.nr_sequencia
and	a.nr_seq_plano		= d.nr_sequencia
and	a.nr_sequencia		= nr_seq_conta_p
and	coalesce(b.ie_tipo_protocolo,'C') = 'C'  LIMIT 1;
exception
when others then
	ds_erro_w	:= '';
end;

select	max(coalesce(ie_status_prov_pagto,'NC')),
	max(coalesce(ie_lote_ajuste_prod,'R'))
into STRICT	ie_status_prov_pagto_w,
	ie_lote_ajuste_prod_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_p;

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

dt_referencia_w := dt_referencia_p;

select	count(1)
into STRICT	qt_esquema_pagamento_w
from	pls_esquema_contabil
where	ie_tipo_regra		= 'PM'
and	ie_prestador_codificacao = 'P'
and	dt_referencia_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_referencia_w)
and	cd_estabelecimento	= cd_estabelecimento_p  LIMIT 1;

if (qt_esquema_pagamento_w > 0) then
	if (coalesce(nr_seq_titular_w::text, '') = '') then
		cd_pessoa_fisica_titular_w	:= cd_pessoa_fisica_w;
	else
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_titular_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_titular_w;
	end if;

	select	max(cd_estabelecimento_base)
	into STRICT	cd_estabelecimento_setor_w
	from	pessoa_fisica_loc_trab	a,
		setor_atendimento	b
	where	a.cd_setor_atendimento	= b.cd_setor_atendimento
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_titular_w
	and	a.ie_local_principal	= 'S';

	select	count(1)
	into STRICT	qt_esquema_tx_inter_w
	from	pls_esquema_contabil
	where	ie_tipo_movimentacao in ('14','15');

	dt_referencia_w	:= trunc(dt_referencia_w,'Month');

	nr_seq_conselho_w	:= null;

	if (cd_medico_executor_w IS NOT NULL AND cd_medico_executor_w::text <> '') then
		select	max(nr_seq_conselho)
		into STRICT	nr_seq_conselho_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_medico_executor_w  LIMIT 1;
	end if;

	if (coalesce(nr_seq_contrato_w,0) <> 0) then
		select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN  'PJ'  ELSE 'PF' END
		into STRICT	ie_tipo_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w  LIMIT 1;

		select	max(nr_seq_grupo)
		into STRICT	nr_seq_grupo_contrato_w
		from	pls_contrato_grupo
		where	nr_seq_contrato	= nr_seq_contrato_w  LIMIT 1;
	elsif (coalesce(nr_seq_intercambio_w,0) <> 0) then
		select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN  'PJ'  ELSE 'PF' END
		into STRICT	ie_tipo_contrato_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_w  LIMIT 1;
	end if;

	if (nr_seq_tipo_prestador_w IS NOT NULL AND nr_seq_tipo_prestador_w::text <> '') then
		select	max(ie_tipo_ptu)
		into STRICT	ie_tipo_prestador_w
		from	pls_tipo_prestador
		where	nr_sequencia	= nr_seq_tipo_prestador_w  LIMIT 1;
	end if;

	open c_itens;
	loop
	FETCH c_itens BULK COLLECT INTO s_array LIMIT 400;
		Vetor_itens_w(w)	:= s_array;
		w := w + 1;
	EXIT WHEN NOT FOUND; /* apply on c_itens */
	END LOOP;
	CLOSE c_itens;

	for i in 1..Vetor_itens_w.COUNT loop
		s_array := Vetor_itens_w(i);
		for z in 1..s_array.COUNT loop
			begin
			
			nr_seq_conta_proc_w		:= s_array[z].nr_seq_conta_proc;
			nr_seq_conta_mat_w		:= s_array[z].nr_seq_conta_mat;
			nr_seq_conta_resumo_w		:= s_array[z].nr_seq_resumo;
			cd_procedimento_w		:= s_array[z].cd_procedimento;
			ie_origem_proced_w		:= s_array[z].ie_origem_proced;
			ie_tipo_despesa_w		:= s_array[z].ie_tipo_despesa;
			nr_seq_grupo_ans_w		:= s_array[z].nr_seq_grupo_ans;
			ie_ato_cooperado_w		:= s_array[z].ie_ato_cooperado;
			nr_seq_material_w		:= s_array[z].nr_seq_material;
			nr_seq_prestador_w		:= s_array[z].nr_seq_prestador_pgto;
			dt_ref_repasse_w		:= s_array[z].dt_ref_repasse;
			nr_id_w				:= s_array[z].nr_id;
			
			SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, nr_seq_segurado_w, nr_seq_congenere_w, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

			select	ie_tipo_relacao,
				nr_seq_tipo_prestador,
				cd_cgc,
				cd_pessoa_fisica
			into STRICT	ie_tipo_relacao_w,
				nr_seq_tipo_prestador_w,
				cd_cgc_prestador_w,
				cd_pf_prestador_w
			from	pls_prestador
			where	nr_sequencia	= nr_seq_prestador_w  LIMIT 1;

			if (nr_seq_tipo_prestador_w IS NOT NULL AND nr_seq_tipo_prestador_w::text <> '') then
				select	ie_tipo_ptu
				into STRICT	ie_tipo_prestador_w
				from	pls_tipo_prestador
				where	nr_sequencia	= nr_seq_tipo_prestador_w  LIMIT 1;
			end if;

			open c_tipo_movimento;
			loop
			fetch c_tipo_movimento into
				ie_conta_glosa_w;
			EXIT WHEN NOT FOUND; /* apply on c_tipo_movimento */
				begin
				nr_seq_esquema_w		:= null;
				cd_conta_credito_w		:= null;
				cd_conta_debito_w		:= null;
				cd_historico_padrao_w		:= null;
				cd_historico_estorno_w		:= null;
				cd_historico_baixa_w		:= null;
				cd_classificacao_credito_w	:= null;
				cd_classificacao_debito_w	:= null;

				open c_esquema_contabil;
				loop
				fetch c_esquema_contabil into
					nr_seq_esquema_ww,
					cd_historico_padrao_ww,
					cd_historico_estorno_ww,
					cd_historico_baixa_ww,
					nr_seq_plano_ww,
					nr_seq_prestador_ww,
					ie_tipo_relacao_ww,
					nr_seq_contrato_ww,
					ie_tipo_vinculo_operadora_ww,
					nr_seq_grupo_contrato_ww,
					ie_tipo_guia_ww,
					nr_seq_intercambio_ww,
					nr_seq_classif_sca_ww,
					ie_tipo_prestador_ww,
					nr_seq_tipo_prestador_ww,
					cd_estab_setor_pessoa_ww;
				EXIT WHEN NOT FOUND; /* apply on c_esquema_contabil */
					begin
					if	((coalesce(nr_seq_plano_ww,coalesce(nr_seq_plano_w,0)) = coalesce(nr_seq_plano_w,0)) and (coalesce(nr_seq_prestador_ww,coalesce(nr_seq_prestador_w,0)) = coalesce(nr_seq_prestador_w,0)) and (coalesce(ie_tipo_relacao_ww,coalesce(ie_tipo_relacao_w,'X')) = coalesce(ie_tipo_relacao_w,'X')) and (coalesce(ie_tipo_prestador_ww,coalesce(ie_tipo_prestador_w,'X')) = coalesce(ie_tipo_prestador_w,'X')) and (coalesce(nr_seq_tipo_prestador_ww,coalesce(nr_seq_tipo_prestador_w,0)) = coalesce(nr_seq_tipo_prestador_w,0)) and (coalesce(nr_seq_contrato_ww,coalesce(nr_seq_contrato_w,0)) = coalesce(nr_seq_contrato_w,0)) and (coalesce(ie_tipo_vinculo_operadora_ww,coalesce(ie_tipo_vinculo_operadora_w,'X')) = coalesce(ie_tipo_vinculo_operadora_w,'X')) and (coalesce(nr_seq_grupo_contrato_ww,coalesce(nr_seq_grupo_contrato_w,0)) = coalesce(nr_seq_grupo_contrato_w,0)) and (coalesce(ie_tipo_guia_ww,coalesce(ie_tipo_guia_w,'X')) = coalesce(ie_tipo_guia_w,'X')) and (coalesce(nr_seq_intercambio_ww,coalesce(nr_seq_intercambio_w,0)) = coalesce(nr_seq_intercambio_w,0)) and (coalesce(nr_seq_classif_sca_ww,coalesce(nr_seq_classificacao_sca_w,0)) = coalesce(nr_seq_classificacao_sca_w,0)) and (coalesce(cd_estab_setor_pessoa_ww,coalesce(cd_estabelecimento_setor_w,0)) = coalesce(cd_estabelecimento_setor_w,0))) then
						nr_seq_esquema_w	:= nr_seq_esquema_ww;
						cd_historico_padrao_w	:= cd_historico_padrao_ww;
						cd_historico_estorno_w	:= cd_historico_estorno_ww;
						cd_historico_baixa_w	:= cd_historico_baixa_ww;
					end if;
					end;
				end loop;
				close c_esquema_contabil;
				
				/* GRUPO ANS */


				/*
				if	(nvl(nr_seq_grupo_ans_w,0) = 0) then
					if	(nvl(nr_seq_material_w,0) > 0) then
						select	nvl(max(ie_tipo_despesa),'')
						into	ie_tipo_despesa_w
						from	pls_material
						where	nr_sequencia	= nr_seq_material_w;
					end if;

					nr_seq_grupo_ans_w	:= pls_obter_grupo_ans(	cd_procedimento_w,
											ie_origem_proced_w,
											nr_seq_conselho_w,
											nr_seq_tipo_atendimento_w,
											ie_tipo_guia_w,
											ie_regime_internacao_w,
											ie_tipo_despesa_w,
											'G',
											nvl(cd_estabelecimento_p,0));
				end if;
				*/


				/* 5 - Grupo ANS com base nos valores do ITAMED */

				if (coalesce(nr_seq_grupo_ans_w,0) > 0) then
					select	max(nr_seq_grupo_superior)
					into STRICT	nr_seq_grupo_superior_w
					from	ans_grupo_despesa
					where	nr_sequencia	= nr_seq_grupo_ans_w;
				end if;

				if (coalesce(nr_seq_grupo_superior_w,0) = 0) then
					nr_seq_grupo_ans_ww	:= nr_seq_grupo_ans_w;
				else
					nr_seq_grupo_ans_ww	:= nr_seq_grupo_superior_w;
				end if;

				select	max(ie_tipo_grupo_ans)
				into STRICT	ie_grupo_despesa_ans_w
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_ans_ww  LIMIT 1;

				if (ie_grupo_despesa_ans_w = 10) then /* 1 - Consultas */
					ie_classif_grupo_w	:= '1';
					ie_classif_grupo_ww	:= '0';
				elsif (ie_grupo_despesa_ans_w = 20) then /* 49 - Exames */
					ie_classif_grupo_w	:= '2';
					ie_classif_grupo_ww	:= '0';
				elsif (ie_grupo_despesa_ans_w = 30) then /* 51 - Terapias */
					ie_classif_grupo_w	:= '3';
					ie_classif_grupo_ww	:= '0';
				elsif (ie_grupo_despesa_ans_w = 41) then /* 7 - Internacao - Honorario medico */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '1';
				elsif (ie_grupo_despesa_ans_w = 42) then /* 8 - Internacao - Exames */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '2';
				elsif (ie_grupo_despesa_ans_w = 43) then /* 9 - Internacao - Terapias*/
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '3';
				elsif (ie_grupo_despesa_ans_w = 44) then /* 10 - Internacao - Materiais medicos */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '4';
				elsif (ie_grupo_despesa_ans_w = 45) then /* 11 - Internacao - Medicamentos */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '5';
				elsif (ie_grupo_despesa_ans_w = 46) then /* 11 - Internacao - Procedimentos com preco fixo */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '6';
				elsif (ie_grupo_despesa_ans_w = 49) then /* 12 - Internacao - Outras despesas */
					ie_classif_grupo_w	:= '4';
					ie_classif_grupo_ww	:= '9';
				elsif (ie_grupo_despesa_ans_w = 50) then /* 6 - Outros atendimentos - Ambulatoriais */
					ie_classif_grupo_w	:= '5';
					ie_classif_grupo_ww	:= '0';
				elsif (ie_grupo_despesa_ans_w = 60) then /* 16 - Demais despesas assistenciais */
					ie_classif_grupo_w	:= '6';
					ie_classif_grupo_ww	:= '0';
				elsif (ie_grupo_despesa_ans_w = 70) then /* 70 - Demais despesas assistenciais */
					ie_classif_grupo_w	:= '7';
					ie_classif_grupo_ww	:= '0';
				end if;
				/* FIM GRUPO ANS */

				open c_segmentacao;
				loop
				fetch c_segmentacao into
					ie_codificacao_w,
					vl_fixo_w,
					cd_conta_contabil_w,
					ie_debito_credito_w,
					ds_mascara_w;
				EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
					begin
					cd_classificacao_item_w	:= null;
					if (ie_debito_credito_w = 'C') then /* Classificacao CREDITO */
						if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_credito_w
							from	conta_contabil
							where	cd_conta_contabil	= cd_conta_contabil_w;

							cd_conta_credito_w	:= cd_conta_contabil_w;
						elsif (ie_codificacao_w = 'JP') then						
							if (coalesce(cd_cgc_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_jur_conta_cont a
								where	a.cd_cgc	= cd_cgc_prestador_w
								and	a.cd_empresa	= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p) 	= cd_estabelecimento_p
								and	a.ie_tipo_conta	= 'P'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							elsif (coalesce(cd_pf_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_fisica_conta_ctb	a
								where	a.cd_pessoa_fisica 	= cd_pf_prestador_w
								and	a.cd_empresa		= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
								and	a.ie_tipo_conta		= 'P'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							end if;

							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_credito_w
							from	conta_contabil
							where	cd_conta_contabil = cd_conta_contabil_w;

							cd_conta_credito_w	:= cd_conta_contabil_w;
						elsif (ie_codificacao_w = 'RP') then							
							if (coalesce(cd_cgc_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_jur_conta_cont a
								where	a.cd_cgc	= cd_cgc_prestador_w
								and	a.cd_empresa	= cd_empresa_w
								and	a.ie_tipo_conta	= 'R'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							elsif (coalesce(cd_pf_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_fisica_conta_ctb	a
								where	a.cd_pessoa_fisica 	= cd_pf_prestador_w
								and	a.cd_empresa		= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
								and	a.ie_tipo_conta	= 'R'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							end if;

							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_credito_w
							from	conta_contabil
							where	cd_conta_contabil = cd_conta_contabil_w;

							cd_conta_credito_w	:= cd_conta_contabil_w;
																		
						elsif (ie_codificacao_w = 'FX') then /* Fixo */
							cd_classificacao_item_w	:= vl_fixo_w;
						elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
							if (ie_preco_w in ('1','2','3')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
							else
								cd_classificacao_item_w	:= 'FP';
							end if;
						elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
						elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
							if (ie_tipo_contratacao_w in ('I','CE','CA')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
							else
								cd_classificacao_item_w	:= 'TC';
							end if;
						elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
							if (ie_tipo_contrato_w in ('PF','PJ')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
							else
								cd_classificacao_item_w	:= 'TP';
							end if;
						elsif (ie_codificacao_w = 'S') then /* Segmentacao */
							cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
						elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
							if (ie_ato_cooperado_w in ('1','2','3')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
							else
								cd_classificacao_item_w	:= 'TA';
							end if;
						elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
						elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
							if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
								cd_classificacao_item_w	:= ie_classif_grupo_w;
							else
								cd_classificacao_item_w	:= 'GA';
							end if;
						elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
							if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
								cd_classificacao_item_w	:= ie_classif_grupo_ww;
							else
								cd_classificacao_item_w	:= 'CG';
							end if;
						elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
                                                elsif (ie_codificacao_w = 'TD') then /* Tipo de despesa */
                                                        if (coalesce(nr_seq_material_w::text, '') = '') then
                                                                if (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
                                                                        cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_despesa(ie_tipo_despesa_w);
                                                                else
                                                                        cd_classificacao_item_w := 'TD';
                                                                end if;
                                                        else
                                                                cd_classificacao_item_w := 1;
                                                        end if;
                                                end if;

						if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
							if (ds_mascara_w = '00') then
								cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
							elsif (ds_mascara_w = '0.0') then
								cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
							elsif (ds_mascara_w = '0_') then
								cd_classificacao_item_w	:= cd_classificacao_item_w;
							else
								cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
							end if;

							cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
						end if;
					elsif (ie_debito_credito_w = 'D') then /* Classificacao DEBITO */
						if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_debito_w
							from	conta_contabil
							where	cd_conta_contabil	= cd_conta_contabil_w;

							cd_conta_debito_w	:= cd_conta_contabil_w;
						elsif (ie_codificacao_w = 'JP') then
							if (coalesce(cd_cgc_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_jur_conta_cont a
								where	a.cd_cgc	= cd_cgc_prestador_w
								and	a.cd_empresa	= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p) 	= cd_estabelecimento_p
								and	a.ie_tipo_conta	= 'P'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
								
							elsif (coalesce(cd_pf_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_fisica_conta_ctb	a
								where	a.cd_pessoa_fisica	= cd_pf_prestador_w
								and	a.cd_empresa		= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
								and	a.ie_tipo_conta		= 'P'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							end if;
							
							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_debito_w
							from	conta_contabil
							where	cd_conta_contabil	= cd_conta_contabil_w;

							cd_conta_debito_w	:= cd_conta_contabil_w;
						elsif (ie_codificacao_w = 'RP') then
							if (coalesce(cd_cgc_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_jur_conta_cont a
								where	a.cd_cgc	= cd_cgc_prestador_w
								and	a.cd_empresa	= cd_empresa_w
								and	a.ie_tipo_conta	= 'R'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							elsif (coalesce(cd_pf_prestador_w,0) <> 0) then
								select	max(cd_conta_contabil)
								into STRICT	cd_conta_contabil_w
								from	pessoa_fisica_conta_ctb	a
								where	a.cd_pessoa_fisica	= cd_pf_prestador_w
								and	a.cd_empresa		= cd_empresa_w
								and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
								and	a.ie_tipo_conta		= 'R'
								and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
							end if;

							select	max(cd_classificacao_atual)
							into STRICT	cd_classificacao_debito_w
							from	conta_contabil
							where	cd_conta_contabil	= cd_conta_contabil_w;

							cd_conta_debito_w	:= cd_conta_contabil_w;
						elsif (ie_codificacao_w = 'FX') then /* Fixo */
							cd_classificacao_item_w	:= vl_fixo_w;
						elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
							if (ie_preco_w in ('1','2','3')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
							else
								cd_classificacao_item_w	:= 'FP';
							end if;
						elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
						elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
							if (ie_tipo_contratacao_w in ('I','CE','CA')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
							else
								cd_classificacao_item_w	:= 'TC';
							end if;
						elsif (ie_codificacao_w = 'S') then /* Segmentacao */
							cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
						elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
							if (ie_tipo_contrato_w in ('PF','PJ')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
							else
								cd_classificacao_item_w	:= 'TP';
							end if;
						elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
							if (ie_ato_cooperado_w in ('1','2','3')) then
								cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
							else
								cd_classificacao_item_w	:= 'TA';
							end if;
						elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
						elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
							if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
								cd_classificacao_item_w	:= ie_classif_grupo_w;
							else
								cd_classificacao_item_w	:= 'GA';
							end if;
						elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
							if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
								cd_classificacao_item_w	:= ie_classif_grupo_ww;
							else
								cd_classificacao_item_w	:= 'CG';
							end if;
						elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
                                                elsif (ie_codificacao_w = 'TD') then /* Tipo de despesa */
                                                        if (coalesce(nr_seq_material_w::text, '') = '') then
                                                                if (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
                                                                        cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_despesa(ie_tipo_despesa_w);
                                                                else
                                                                        cd_classificacao_item_w := 'TD';
                                                                end if;
                                                        else
                                                                cd_classificacao_item_w := 1;
                                                        end if;
                                                end if;

						if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
							if (ds_mascara_w = '00') then
								cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
							elsif (ds_mascara_w = '0.0') then
								cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
							elsif (ds_mascara_w = '0_') then
								cd_classificacao_item_w	:= cd_classificacao_item_w;
							else
								cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
							end if;

							cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
						end if;
					end if;
					end;
				end loop;
				close c_segmentacao;

				/* Remover o ultimo ponto da classificacao */

				if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
					cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
				end if;

				if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
					cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
				end if;

				if (coalesce(cd_conta_credito_w::text, '') = '') then
					cd_conta_credito_w	:= ctb_obter_conta_classif(cd_classificacao_credito_w,dt_referencia_w,cd_estabelecimento_p);
				end if;

				if (coalesce(cd_conta_debito_w::text, '') = '') then
					cd_conta_debito_w	:= ctb_obter_conta_classif(cd_classificacao_debito_w,dt_referencia_w,cd_estabelecimento_p);
				end if;
				
				if (ie_conta_glosa_w = 11) or (ie_conta_glosa_w = 18) then
					if 	(cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '' AND ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') then
						if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') and (ie_status_conta_w <> 'C') then
							if (coalesce(nr_seq_esquema_w::text, '') = '') then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,1, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'C', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,2, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'C', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							end if;
						end if;

						nr_vetor_w		:= null;

						for i in 1..vetor_contas_w.count loop
							if (vetor_contas_w[i].nr_seq_conta_resumo = nr_seq_conta_resumo_w) then
								nr_vetor_w	:= i;
								exit;
							end if;
						end loop;

						if (coalesce(nr_vetor_w::text, '') = '') then
							nr_vetor_w	:= vetor_contas_w.count+1;
						end if;

						if (ie_conta_glosa_w = 11) then
							vetor_contas_w[nr_vetor_w].nr_seq_conta_item		:= coalesce(nr_seq_conta_proc_w,nr_seq_conta_mat_w);
							vetor_contas_w[nr_vetor_w].nr_seq_conta_resumo		:= nr_seq_conta_resumo_w;
							vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
							vetor_contas_w[nr_vetor_w].ie_tipo_conta		:= 'P';
							vetor_contas_w[nr_vetor_w].cd_conta_cred		:= cd_conta_credito_w;
							vetor_contas_w[nr_vetor_w].cd_conta_deb			:= cd_conta_debito_w;
							vetor_contas_w[nr_vetor_w].cd_classif_cred		:= cd_classificacao_credito_w;
							vetor_contas_w[nr_vetor_w].cd_classif_deb		:= cd_classificacao_debito_w;
							vetor_contas_w[nr_vetor_w].nr_seq_esquema		:= nr_seq_esquema_w;
							vetor_contas_w[nr_vetor_w].cd_historico			:= cd_historico_padrao_w;
							vetor_contas_w[nr_vetor_w].nr_seq_grupo_ans		:= nr_seq_grupo_ans_ww;
							
						elsif (ie_conta_glosa_w = 18) then
							vetor_contas_w[nr_vetor_w].cd_historico_vl_ajuste	:= cd_historico_padrao_w;
							vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
						end if;
						
						
					elsif (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
						if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') and (ie_status_conta_w <> 'C') then
							if (coalesce(nr_seq_esquema_w::text, '') = '') then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,1, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'C', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,2, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'C', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							end if;
						end if;

						nr_vetor_w	:= null;

						for i in 1..vetor_contas_w.count loop
							if (vetor_contas_w[i].nr_seq_conta_resumo = nr_seq_conta_resumo_w) then
								nr_vetor_w	:= i;
								exit;
							end if;
						end loop;

						if (coalesce(nr_vetor_w::text, '') = '') then
							nr_vetor_w	:= vetor_contas_w.count+1;
						end if;

						if (ie_conta_glosa_w = 11) then
							vetor_contas_w[nr_vetor_w].nr_seq_conta_item		:= coalesce(nr_seq_conta_proc_w,nr_seq_conta_mat_w);
							vetor_contas_w[nr_vetor_w].nr_seq_conta_resumo		:= nr_seq_conta_resumo_w;
							vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
							vetor_contas_w[nr_vetor_w].ie_tipo_conta		:= 'M';
							vetor_contas_w[nr_vetor_w].cd_conta_cred		:= cd_conta_credito_w;
							vetor_contas_w[nr_vetor_w].cd_conta_deb			:= cd_conta_debito_w;
							vetor_contas_w[nr_vetor_w].cd_classif_cred		:= cd_classificacao_credito_w;
							vetor_contas_w[nr_vetor_w].cd_classif_deb		:= cd_classificacao_debito_w;
							vetor_contas_w[nr_vetor_w].nr_seq_esquema		:= nr_seq_esquema_w;
							vetor_contas_w[nr_vetor_w].cd_historico			:= cd_historico_padrao_w;
							vetor_contas_w[nr_vetor_w].nr_seq_grupo_ans		:= nr_seq_grupo_ans_ww;
							
						elsif (ie_conta_glosa_w = 18) then
							vetor_contas_w[nr_vetor_w].cd_historico_vl_ajuste	:= cd_historico_padrao_w;
							vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
						end if;	
						
					end if;
				elsif (ie_conta_glosa_w = 12) then
					if 	(cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '' AND ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') then
						if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') and (ie_status_conta_w <> 'C') then
							if (coalesce(nr_seq_esquema_w::text, '') = '') then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,1, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'G', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,2, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'G', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							end if;
						end if;

						nr_vetor_w	:= null;

						for i in 1..vetor_contas_w.count loop
							if (vetor_contas_w[i].nr_seq_conta_resumo = nr_seq_conta_resumo_w) then
								nr_vetor_w	:= i;
								exit;
							end if;
						end loop;

						if (coalesce(nr_vetor_w::text, '') = '') then
							nr_vetor_w	:= vetor_contas_w.count+1;
						end if;

						/*Armazenar os valores no vetor*/

						vetor_contas_w[nr_vetor_w].nr_seq_conta_item		:= coalesce(nr_seq_conta_proc_w,nr_seq_conta_mat_w);
						vetor_contas_w[nr_vetor_w].nr_seq_conta_resumo		:= nr_seq_conta_resumo_w;
						vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
						vetor_contas_w[nr_vetor_w].ie_tipo_conta		:= 'P';
						vetor_contas_w[nr_vetor_w].cd_conta_glosa_cred		:= cd_conta_credito_w;
						vetor_contas_w[nr_vetor_w].cd_conta_glosa_deb		:= cd_conta_debito_w;
						vetor_contas_w[nr_vetor_w].cd_classif_glosa_cred	:= cd_classificacao_credito_w;
						vetor_contas_w[nr_vetor_w].cd_classif_glosa_deb		:= cd_classificacao_debito_w;
						vetor_contas_w[nr_vetor_w].nr_seq_esquema_glosa		:= nr_seq_esquema_w;
						vetor_contas_w[nr_vetor_w].cd_historico_glosa		:= cd_historico_padrao_w;
						vetor_contas_w[nr_vetor_w].nr_seq_grupo_ans		:= nr_seq_grupo_ans_ww;

					elsif (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
						if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') and (ie_status_conta_w <> 'C') then
							if (coalesce(nr_seq_esquema_w::text, '') = '') then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,1, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'G', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
								CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,2, null, nr_seq_conta_proc_w, nr_seq_conta_mat_w, 'G', null, null, null, null, null, null, null, null, null, null, nr_seq_conta_resumo_w, nm_usuario_p, nr_seq_esquema_w);
							end if;
						end if;

						nr_vetor_w	:= null;

						for i in 1..vetor_contas_w.count loop
							if (vetor_contas_w[i].nr_seq_conta_resumo = nr_seq_conta_resumo_w) then
								nr_vetor_w	:= i;
								exit;
							end if;
						end loop;

						if (coalesce(nr_vetor_w::text, '') = '') then
							nr_vetor_w	:= vetor_contas_w.count+1;
						end if;

						/*Armazenar os valores no vetor*/

						vetor_contas_w[nr_vetor_w].nr_seq_conta_item		:= coalesce(nr_seq_conta_proc_w,nr_seq_conta_mat_w);
						vetor_contas_w[nr_vetor_w].nr_seq_conta_resumo		:= nr_seq_conta_resumo_w;
						vetor_contas_w[nr_vetor_w].nr_id			:= nr_id_w;
						vetor_contas_w[nr_vetor_w].ie_tipo_conta		:= 'M';
						vetor_contas_w[nr_vetor_w].cd_conta_glosa_cred		:= cd_conta_credito_w;
						vetor_contas_w[nr_vetor_w].cd_conta_glosa_deb		:= cd_conta_debito_w;
						vetor_contas_w[nr_vetor_w].cd_classif_glosa_cred	:= cd_classificacao_credito_w;
						vetor_contas_w[nr_vetor_w].cd_classif_glosa_deb		:= cd_classificacao_debito_w;
						vetor_contas_w[nr_vetor_w].nr_seq_esquema_glosa		:= nr_seq_esquema_w;
						vetor_contas_w[nr_vetor_w].cd_historico_glosa		:= cd_historico_padrao_w;
						vetor_contas_w[nr_vetor_w].nr_seq_grupo_ans		:= nr_seq_grupo_ans_ww;
					end if;
				end if;
				end;
			end loop;
			close c_tipo_movimento;
			end;
		end loop;
	end loop;

	qt_movimento_ww	:= 0;

	for i in 1..vetor_contas_w.count loop

		if (vetor_contas_w[i].ie_tipo_conta = 'P') then
			update	pls_conta_medica_resumo
			set	cd_conta_cred			= vetor_contas_w[i].cd_conta_cred,
				cd_conta_deb			= vetor_contas_w[i].cd_conta_deb,
				cd_classif_cred			= vetor_contas_w[i].cd_classif_cred,
				cd_classif_deb			= vetor_contas_w[i].cd_classif_deb,
				nr_seq_esquema			= vetor_contas_w[i].nr_seq_esquema,
				cd_historico			= vetor_contas_w[i].cd_historico,
				cd_conta_glosa_cred		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_conta_glosa_cred  ELSE vetor_contas_w[i].cd_conta_glosa_cred END ,
				cd_conta_glosa_deb		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_conta_glosa_deb  ELSE vetor_contas_w[i].cd_conta_glosa_deb END ,
				cd_classif_glosa_cred		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_classif_glosa_cred  ELSE vetor_contas_w[i].cd_classif_glosa_cred END ,
				cd_classif_glosa_deb		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_classif_glosa_deb  ELSE vetor_contas_w[i].cd_classif_glosa_deb END ,
				nr_seq_esquema_glosa		= CASE WHEN ie_status_prov_pagto_w='F' THEN  nr_seq_esquema_glosa  ELSE vetor_contas_w[i].nr_seq_esquema_glosa END ,
				cd_historico_glosa		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_historico_glosa  ELSE vetor_contas_w[i].cd_historico_glosa END ,
				cd_historico_vl_ajuste		= CASE WHEN ie_lote_ajuste_prod_w='R' THEN  vetor_contas_w[i].cd_historico_vl_ajuste  ELSE cd_historico_vl_ajuste END
			where	rowid				= vetor_contas_w[i].nr_id;

			qt_movimento_w	:= qt_movimento_w + 1;
		elsif (vetor_contas_w[i].ie_tipo_conta = 'M') then
			update	pls_conta_medica_resumo
			set	cd_conta_cred			= vetor_contas_w[i].cd_conta_cred,
				cd_conta_deb			= vetor_contas_w[i].cd_conta_deb,
				cd_classif_cred			= vetor_contas_w[i].cd_classif_cred,
				cd_classif_deb			= vetor_contas_w[i].cd_classif_deb,
				nr_seq_esquema			= vetor_contas_w[i].nr_seq_esquema,
				cd_historico			= vetor_contas_w[i].cd_historico,
				cd_conta_glosa_cred		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_conta_glosa_cred  ELSE vetor_contas_w[i].cd_conta_glosa_cred END ,
				cd_conta_glosa_deb		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_conta_glosa_deb  ELSE vetor_contas_w[i].cd_conta_glosa_deb END ,
				cd_classif_glosa_cred		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_classif_glosa_cred  ELSE vetor_contas_w[i].cd_classif_glosa_cred END ,
				cd_classif_glosa_deb		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_classif_glosa_deb  ELSE vetor_contas_w[i].cd_classif_glosa_deb END ,
				nr_seq_esquema_glosa		= CASE WHEN ie_status_prov_pagto_w='F' THEN  nr_seq_esquema_glosa  ELSE vetor_contas_w[i].nr_seq_esquema_glosa END ,
				cd_historico_glosa		= CASE WHEN ie_status_prov_pagto_w='F' THEN  cd_historico_glosa  ELSE vetor_contas_w[i].cd_historico_glosa END ,
				cd_historico_vl_ajuste		= CASE WHEN ie_lote_ajuste_prod_w='R' THEN  vetor_contas_w[i].cd_historico_vl_ajuste  ELSE cd_historico_vl_ajuste END
			where	rowid				= vetor_contas_w[i].nr_id;

			qt_movimento_w	:= qt_movimento_w + 1;
		end if;
		
		--commit;

		
		--qt_movimento_ww	:= qt_movimento_ww + 1;
		if (mod(qt_movimento_w,300) = 0) then
			commit;
		end if;
	end loop;
end if;

commit;

qt_movimento_p	:= qt_movimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_atualizar_prod_med_res ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_movimento_p INOUT integer, dt_referencia_p pls_protocolo_conta.dt_mes_competencia%type) FROM PUBLIC;

