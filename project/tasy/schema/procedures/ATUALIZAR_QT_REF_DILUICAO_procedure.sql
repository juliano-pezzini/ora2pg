-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_qt_ref_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


cd_material_w		bigint;
cd_diluente_w		bigint;
ie_via_aplicacao_w	varchar(15);
cd_estabelecimento_w	bigint;
qt_idade_w		double precision;
qt_peso_w		prescr_medica.qt_peso%type;
qt_referencia_w		material_diluicao.qt_referencia%type;
cd_unid_med_diluente_w	material_diluicao.cd_unid_med_diluente%type;


BEGIN

select	a.cd_estabelecimento,
	obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'M'),
	coalesce(a.qt_peso,0)
into STRICT	cd_estabelecimento_w,
	qt_idade_w,
	qt_peso_w
from	pessoa_fisica b,
	prescr_medica a
where	a.nr_prescricao		= nr_prescricao_p
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;

qt_idade_w	:= dividir(qt_idade_w,12);

select	cd_material,
	ie_via_aplicacao
into STRICT	cd_material_w,
	ie_via_aplicacao_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	= nr_sequencia_p;

select	coalesce(max(cd_material),0)
into STRICT	cd_diluente_w
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and	nr_sequencia_diluicao	= nr_sequencia_p
and	ie_agrupador		= 3;

if (coalesce(ie_via_aplicacao_w::text, '') = '') then

	select	max(qt_referencia),
		coalesce(max(CD_UNID_MED_DILUENTE), obter_unid_med_usua('ml'))
	into STRICT	qt_referencia_w,
		cd_unid_med_diluente_w
	from	material_diluicao
	where	cd_material		= cd_material_w
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	qt_idade_w 		between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999)
	and	qt_peso_w  		between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
	and	cd_diluente		= cd_diluente_w
	and	ie_reconstituicao	= 'N';

else

	select	max(qt_referencia),
		coalesce(max(CD_UNID_MED_DILUENTE), obter_unid_med_usua('ml'))
	into STRICT	qt_referencia_w,
		cd_unid_med_diluente_w
	from	material_diluicao
	where	cd_material		= cd_material_w
	and	cd_estabelecimento	= cd_estabelecimento_w
	and	qt_idade_w 		between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,999)
	and	qt_peso_w  		between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
	and	cd_diluente		= cd_diluente_w
	and	((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
	and	ie_reconstituicao	= 'N';

end if;

if	coalesce(qt_referencia_w,0) > 0 then

	qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);

	if	coalesce(qt_referencia_w,0) > 0 then

		update	prescr_material
		set	qt_ref_diluente		= qt_referencia_w
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia_diluicao	= nr_sequencia_p
		and	ie_agrupador		= 3;

	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_qt_ref_diluicao ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

