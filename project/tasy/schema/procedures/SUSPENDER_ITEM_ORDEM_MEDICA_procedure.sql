-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_item_ordem_medica ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) AS $body$
DECLARE

 
ie_ordem_w				varchar(1);
ie_status_sol_w			varchar(3);
nr_etapas_erro_w		varchar(4000);
nr_etapas_suspender_w	varchar(4000);
nr_etapa_w				integer;

C01 CURSOR FOR 
	SELECT	nr_etapa_sol 
	from	prescr_mat_hor 
	where	coalesce(ie_horario_especial,'N') = 'N' 
	and		coalesce(dt_inicio_horario::text, '') = '' 
	and		coalesce(dt_suspensao::text, '') = '' 
	and		(nr_etapa_sol IS NOT NULL AND nr_etapa_sol::text <> '') 
	and		nr_seq_solucao = nr_seq_item_p 
	and		nr_prescricao = nr_prescricao_p 
	order by 1;
					

BEGIN 
 
if (ie_tipo_item_p = 'SOL') then 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_ordem_w 
	from	prescr_medica_ordem 
	where	nr_seq_solucao = nr_seq_item_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	select	coalesce(max(substr(obter_status_solucao_prescr(1, nr_prescricao, nr_seq_solucao),1,3)),'N') 
	into STRICT	ie_status_sol_w 
	from	prescr_solucao 
	where	nr_seq_solucao = nr_seq_item_p 
	and		nr_prescricao = nr_prescricao_p;
	 
	if (ie_ordem_w = 'S') and (ie_status_sol_w in ('I', 'R', 'II', 'INT')) then 
		 
		nr_etapas_suspender_w := '';
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_etapa_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			nr_etapas_suspender_w := nr_etapas_suspender_w || nr_etapa_w || ',';
			end;
		end loop;
		close C01;
		 
		nr_etapas_erro_w := suspender_etapa_solucao(1, nr_prescricao_p, nr_seq_item_p, null, 15, obter_desc_expressao(317208), nm_usuario_p, null, null, nr_etapas_suspender_w, nr_etapas_erro_w, 0, obter_perfil_ativo);
		 
		if (nr_etapas_erro_w IS NOT NULL AND nr_etapas_erro_w::text <> '') then 
			-- Não foi possível suspender as seguintes etapas desta solução: #@NR_ETAPAS_ERRO#@ 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(221531, 'NR_ETAPAS_ERRO='||nr_etapas_erro_w);
		end if;
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_item_ordem_medica ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) FROM PUBLIC;

