-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_orcamento_atend ( nr_atendimento_p bigint, nr_seq_orcamento_p bigint, nr_seq_atepacu_p bigint, cd_medico_p text, nm_usuario_p text) AS $body$
DECLARE




cd_material_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
qt_item_w			double precision;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
cd_setor_atendimento_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_seq_exame_w			bigint;
cd_estabelecimento_w		bigint;
ie_tipo_material_w		varchar(3);
ie_agrupador_w			smallint;
cd_pessoa_fisica_w		varchar(10);
cd_setor_exclusivo_w		bigint;
ie_setor_exclusivo_w		varchar(1);
cd_setor_selecionado_w		bigint;
dt_resultado_w			prescr_procedimento.dt_resultado%type;
cd_setor_proc_w			setor_atendimento.cd_setor_atendimento%type;
cd_setor_proc_princ_w		setor_atendimento.cd_setor_atendimento%type;
ds_erro_w 			varchar(255);
ie_regra_w			varchar(2);
nr_seq_regra_w			bigint;
ie_glosa_w			regra_ajuste_proc.ie_glosa%type;
nr_seq_regra_preco_w		regra_ajuste_proc.nr_sequencia%type;
ie_autorizacao_w		prescr_procedimento.ie_autorizacao%type;
ie_regra_plano_w		orcamento_paciente_proc.ie_regra_plano%type;
cd_convenio_w			orcamento_paciente.cd_convenio%type;
cd_categoria_w			orcamento_paciente.cd_categoria%type;
cd_plano_w			orcamento_paciente.cd_plano%type;
ie_tipo_atendimento_w		orcamento_paciente.ie_tipo_atendimento%type;
nr_seq_proc_princ_w		orcamento_paciente_proc.nr_seq_proc_princ%type;
cd_material_exame_w		orcamento_paciente_proc.cd_material_exame%type;
cd_material_exame_princ_w	orcamento_paciente_proc.cd_material_exame%type;
nr_seq_material_regra_w		material_exame_lab.nr_sequencia%type;
nr_seq_exame_princ_w		orcamento_paciente_proc.nr_seq_exame%type;
ie_exame_lab_dependente_w	varchar(1);
nr_seq_inf_add_w		prescr_proced_inf_adic.nr_sequencia%type;
cd_medico_w                     orcamento_paciente_proc.cd_medico%type;
vl_coparticipacao_w             orcamento_paciente_proc.vl_coparticipacao%type;
nr_crm_w                        prescr_proced_inf_adic.cd_crm_medico%type;
nr_ano_guia_w                   procedimento_guia_wint.nr_ano_guia%type;
nr_doc_guia_w                   orcamento_paciente.nr_doc_guia%type;
nr_seq_prescr_proced_inf_w      prescr_proced_inf_adic.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	cd_material,
		qt_material
	from	orcamento_paciente_mat
	where	nr_sequencia_orcamento = nr_seq_orcamento_p;

c02 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_proc_interno,
		a.nr_seq_exame,
		a.qt_procedimento,
		a.cd_setor_atendimento,
		a.ie_regra_plano,
		a.nr_seq_proc_princ,
		a.cd_material_exame,
                coalesce(a.cd_medico, b.cd_medico) cd_medico,
                coalesce(a.vl_coparticipacao, 0) vl_coparticipacao,
                obter_crm_medico(a.cd_medico) nr_crm,
                coalesce(b.nr_doc_guia, '0') nr_doc_guia,
                case coalesce(b.nr_doc_guia, '0') when '0' then '0'
                else coalesce(to_char(b.dt_orcamento, 'YYYY'), to_char(clock_timestamp(), 'YYYY'))
                end nr_ano_guia
	from	orcamento_paciente_proc a,
                orcamento_paciente b
	where	a.nr_sequencia_orcamento = b.nr_sequencia_orcamento
        and     b.nr_sequencia_orcamento = nr_seq_orcamento_p;

BEGIN

select	nextval('prescr_medica_seq')
into STRICT	nr_prescricao_w
;

select 	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from 	atend_paciente_unidade
where 	nr_seq_interno = nr_seq_atepacu_p
and 	nr_atendimento = nr_atendimento_p;


select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario = nm_usuario_p;

select	cd_convenio,
	cd_categoria,
	cd_plano,
	ie_tipo_atendimento
into STRICT	cd_convenio_w,
	cd_categoria_w,
	cd_plano_w,
	ie_tipo_atendimento_w
from	orcamento_paciente
where	nr_sequencia_orcamento	= nr_seq_orcamento_p;

insert into prescr_medica(
	cd_estabelecimento,
	nr_prescricao,
	cd_pessoa_fisica,
	nr_atendimento,
	cd_medico,
	dt_prescricao,
	dt_atualizacao,
	nm_usuario,
	cd_setor_entrega,
	cd_prescritor,
	nm_usuario_original,
	cd_setor_Atendimento,
	dt_entrega)
values (cd_estabelecimento_w,
	nr_prescricao_w,
	obter_pessoa_atendimento(nr_Atendimento_p,'C'),
	nr_Atendimento_p,
	cd_medico_p,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	cd_setor_atendimento_w,
	cd_pessoa_fisica_w,
	nm_usuario_p,
	obter_setor_atendimento(nr_atendimento_p),
	clock_timestamp());

open C01;
loop
fetch C01 into
	cd_material_w,
	qt_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_w;

	ie_agrupador_w:= null;

	select 	max(ie_tipo_material)
	into STRICT	ie_tipo_material_w
	from 	material
	where	cd_material = cd_material_w;

	if (coalesce(ie_tipo_material_w,0) in (1,5)) then
		ie_agrupador_w:= 2;
	elsif (coalesce(ie_tipo_material_w,0) in (2,3,4)) then
		ie_agrupador_w:= 1;
	end if;

	insert into prescr_material(	nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					CD_MOTIVO_BAIXA,
					ie_agrupador)
		values (	nr_prescricao_w,
					nr_sequencia_w,
					1,
					cd_material_w,
					substr(obter_dados_material(cd_material_w,'UMC'),1,50),
					qt_item_w,
					qt_item_w,
					clock_timestamp(),
					nm_usuario_p,
					0,
					ie_agrupador_w);
	end;
end loop;
close C01;


ie_setor_exclusivo_w	:= coalesce(Obter_Valor_Param_Usuario(106,143, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w),'N');
cd_setor_exclusivo_w	:= 0;
cd_setor_selecionado_w	:= cd_setor_atendimento_w;

open C02;
loop
fetch C02 into
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_proc_interno_w,
	nr_seq_exame_w,
	qt_item_w,
	cd_setor_proc_w,
	ie_regra_plano_w,
	nr_seq_proc_princ_w,
	cd_material_exame_w,
        cd_medico_w,
        vl_coparticipacao_w,
        nr_crm_w,
        nr_doc_guia_w,
        nr_ano_guia_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin	
	
	cd_setor_atendimento_w		:= cd_setor_selecionado_w;
	ie_autorizacao_w		:= 'L';
	ie_exame_lab_dependente_w	:= 'N';
	
	if (ie_setor_exclusivo_w = 'S') then

		select 	coalesce(max(cd_setor_exclusivo),0)
		into STRICT	cd_setor_exclusivo_w
		from 	procedimento
		where 	cd_procedimento = cd_procedimento_w
		and 	ie_origem_proced = ie_origem_proced_w;

		if (coalesce(cd_setor_exclusivo_w,0) = 0) then

			cd_setor_exclusivo_w:= obter_setor_atend_proc(cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, cd_setor_atendimento_w, cd_setor_atendimento_w,
									nm_usuario_p, nr_seq_proc_interno_w, nr_Atendimento_p, null);

		end if;

		if (coalesce(cd_setor_exclusivo_w,0) = 0) and (coalesce(nr_seq_exame_w,0) > 0) then
			cd_setor_exclusivo_w:= Obter_setor_Atend_proc_lab(cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, cd_setor_atendimento_w, cd_setor_atendimento_w,
									nm_usuario_p, nr_seq_exame_w, nr_Atendimento_p, null);
		end if;

		if (coalesce(cd_setor_exclusivo_w,0) > 0) then
			cd_setor_atendimento_w:= cd_setor_exclusivo_w;
		end if;
	end if;

	if (coalesce(cd_setor_atendimento_w::text, '') = '') then
		cd_setor_atendimento_w := cd_setor_proc_w;
	end if;	
	
	if (coalesce(ie_regra_plano_w::text, '') = '') then
		SELECT * FROM consiste_plano_convenio(nr_atendimento_p, cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, null, qt_item_w, ie_tipo_atendimento_w, cd_plano_w, '', ds_erro_w, cd_setor_atendimento_w, nr_seq_exame_w, ie_regra_w, null, nr_seq_regra_w, nr_seq_proc_interno_w, cd_categoria_w, cd_estabelecimento_w, null, cd_medico_p, cd_pessoa_fisica_w, ie_glosa_w, nr_seq_regra_preco_w) INTO STRICT ds_erro_w, ie_regra_w, nr_seq_regra_w, ie_glosa_w, nr_seq_regra_preco_w;
	else
		ie_regra_w	:= ie_regra_plano_w;
	end if;
	
	if (ie_regra_w in (1,2,5,8))then
		ie_autorizacao_w	:= 'B';
	end if;
	
	if (ie_regra_w in (3,6,7))then
		ie_autorizacao_w	:= 'PA';
	end if;			
	
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w;
	
	if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '' AND nr_seq_proc_princ_w IS NOT NULL AND nr_seq_proc_princ_w::text <> '') then
		
		select	max(cd_material_exame),
			max(nr_seq_exame),
			max(cd_setor_atendimento)
		into STRICT	cd_material_exame_princ_w,
			nr_seq_exame_princ_w,
			cd_setor_proc_princ_w
		from	orcamento_paciente_proc
		where	nr_sequencia = nr_seq_proc_princ_w;
		
		select 	coalesce(max(nr_sequencia), 0)
		into STRICT	nr_seq_material_regra_w
		from	material_exame_lab
		where	cd_material_exame = cd_material_exame_princ_w;
		
		select	max('S')
		into STRICT	ie_exame_lab_dependente_w
		from	exame_lab_dependente
		where	ie_geracao = 0
		and	nr_seq_exame = nr_seq_exame_princ_w
		and	nr_seq_exame_dep = nr_seq_exame_w
		and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(cd_convenio, cd_convenio_w) = cd_convenio_w
		and	coalesce(cd_categoria, cd_categoria_w) = cd_categoria_w
		and	coalesce(cd_setor_atendimento, coalesce(cd_setor_proc_princ_w, 0)) = coalesce(cd_setor_proc_princ_w, 0)
		and	coalesce(nr_seq_material_regra, nr_seq_material_regra_w) = nr_seq_material_regra_w
		and	coalesce(ie_agrupa_conta, 'S') = 'N'
		order by nr_seq_exame_dep;
		
	end if;
	
	if (coalesce(ie_exame_lab_dependente_w, 'N') = 'N') then
		
		insert into prescr_procedimento(	nr_prescricao,
							nr_sequencia,
							cd_procedimento,
							ie_origem_proced,
							qt_procedimento,
							dt_atualizacao,
							nm_usuario,
							cd_motivo_baixa,
							ie_origem_inf,
							nr_seq_interno,
							cd_setor_atendimento,
							cd_setor_entrega,
							cd_setor_coleta,
							nr_seq_proc_interno,
							nr_seq_exame,
							ie_suspenso,
							dt_prev_execucao,
							ie_urgencia,
							ie_autorizacao,
							cd_material_exame,
                                                        cd_medico_solicitante)

					values (		nr_prescricao_w,
							nr_sequencia_w,
							cd_procedimento_w,
							ie_origem_proced_w,
							qt_item_w,
							clock_timestamp(),
							nm_usuario_p,
							0,
							1,
							nextval('prescr_procedimento_seq'),
							cd_setor_atendimento_w,
							cd_setor_atendimento_w,
							cd_setor_atendimento_w,
							nr_seq_proc_interno_w,
							nr_seq_exame_w,
							'N',
							clock_timestamp(),
							'N',
							ie_autorizacao_w,
							cd_material_exame_w,
                                                        cd_medico_w);

                if (vl_coparticipacao_w > 0 and (cd_medico_w IS NOT NULL AND cd_medico_w::text <> '')) then
                        begin
                        select 	nr_sequencia
                        into STRICT	nr_seq_inf_add_w
                        from 	prescr_proced_inf_adic
                        where 	nr_prescricao		= nr_prescricao_w
                        and	nr_seq_prescricao	= nr_sequencia_w;
                        exception
                                when no_data_found then
                                        nr_seq_inf_add_w := 0;
                                when too_many_rows then
                                        nr_seq_inf_add_w := 0;
                        end;

                        if (nr_seq_inf_add_w = 0) then
                                select  nextval('prescr_proced_inf_adic_seq')
                                into STRICT    nr_seq_prescr_proced_inf_w
;

                                insert into prescr_proced_inf_adic(
                                                        nr_sequencia,
                                                        dt_atualizacao,
                                                        nm_usuario,
                                                        dt_atualizacao_nrec,
                                                        nm_usuario_nrec,
                                                        dt_registro,
                                                        nr_prescricao,
                                                        nr_seq_prescricao,
                                                        cd_pessoa_fisica, 
                                                        ie_situacao,
                                                        vl_coparticipacao,
                                                        cd_crm_medico,
                                                        nr_ano_guia)
                                                values ( nr_seq_prescr_proced_inf_w,
                                                        clock_timestamp(),
                                                        nm_usuario_p,
                                                        clock_timestamp(),
                                                        nm_usuario_p,
                                                        clock_timestamp(),
                                                        nr_prescricao_w,
                                                        nr_sequencia_w,
                                                        cd_medico_w,
                                                        'A',
                                                        vl_coparticipacao_w,
                                                        nr_crm_w, 
                                                        nr_ano_guia_w);

                        else 
                                update 	prescr_proced_inf_adic a
                                set	a.vl_coparticipacao = vl_coparticipacao_w,
                                        a.cd_crm_medico = nr_crm_w,
                                        a.nr_ano_guia = nr_ano_guia_w,
                                        a.dt_atualizacao = clock_timestamp(),
                                        a.nm_usuario = nm_usuario_p,
                                        a.cd_pessoa_fisica = cd_medico_w
                                where 	a.nr_sequencia = nr_seq_inf_add_w;
                        end if;	

                        update  prescr_medica a
                        set     a.nr_doc_conv = nr_doc_guia_w
                        where   a.nr_prescricao = nr_prescricao_w
                        and     a.nr_atendimento = nr_atendimento_p;
                end if;

		commit;
		
		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then

			dt_resultado_w := Obter_data_resultado_exame_orc(nr_sequencia_w, nr_prescricao_w, dt_resultado_w);
			
			if (dt_resultado_w IS NOT NULL AND dt_resultado_w::text <> '') then
				update	prescr_procedimento
				set	dt_resultado = dt_resultado_w
				where	nr_prescricao = nr_prescricao_w
				and	nr_sequencia = nr_sequencia_w;
			end if;	
				
			
		end if;
	
	end if;

	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_orcamento_atend ( nr_atendimento_p bigint, nr_seq_orcamento_p bigint, nr_seq_atepacu_p bigint, cd_medico_p text, nm_usuario_p text) FROM PUBLIC;

