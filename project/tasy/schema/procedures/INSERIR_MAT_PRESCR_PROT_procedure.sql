-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_prescr_prot ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_material_p bigint, ie_agrupador_p bigint, nr_seq_dieta_p bigint, nr_seq_proc_p bigint, nr_seq_solucao_p bigint, nr_seq_dieta_novo_p bigint, nr_seq_proc_novo_p bigint, nr_seq_solucao_novo_p bigint, cd_intervalo_p text, qt_protocolo_p bigint, nm_usuario_p text, ie_urgencia_p text, qt_peso_p bigint, hr_prim_horario_p text, qt_dose_p bigint, nr_seq_atendimento_p bigint, ds_justificativa_p text, cd_unidade_medida_p text, ie_gerar_composto_p text, ie_objetivo_p text, qt_dias_solicitado_p bigint, ie_indicacao_p text, cd_doenca_cid_p text, ie_via_aplicacao_p text, cd_topografia_cih_p text, ds_recomendacao_p text, ie_sem_dia_inf_p text, ie_se_necessario_p text, ie_acm_p text, ie_reordenar_medic_p text, cd_microorganismo_cih_p bigint, cd_amostra_cih_p bigint, ie_origem_infeccao_p text, ie_aplic_bolus_p text, ie_dose_espec_agora_p text, qt_dose_especial_p bigint, cd_unidade_medida_dose_edit_p text, hr_dose_especial_p text, qt_min_aplic_dose_esp_p bigint, ds_dose_diferenciada_p text default null, ie_protocolo_pre_rep_p text default null, ds_medic_nao_padrao_p text default null ) IS type campos is record (ds_dias_aplicacao varchar(6)) RETURNS bigint AS $body$
DECLARE

	qt_dose_ret_w	double precision := 0;i integer;
	
BEGIN
		for a in 1..doses_dif_w.count loop
			begin
			i := a;
			qt_dose_ret_w := qt_dose_ret_w + doses_dif_w[i].qt_dose;
			end;
		end loop;

	return qt_dose_ret_w;
	end;


BEGIN

select	cd_estabelecimento,
	nr_horas_validade,
	dt_prescricao,
	dt_primeiro_horario,
	dt_inicio_prescr,
	nr_atendimento,
	cd_setor_atendimento,
	cd_pessoa_fisica,
	coalesce(cd_perfil_ativo,obter_perfil_ativo),
	obter_classif_setor(cd_setor_atendimento),
	ie_opcao_horario
into STRICT	cd_estabelecimento_w,
	nr_horas_validade_w,
	dt_prescricao_w,
	dt_primeiro_horario_w,
	dt_inicio_prescr_w,
	nr_atendimento_w,
	cd_setor_atendimento_w,
	cd_pessoa_fisica_w,
	cd_perfil_w,
	cd_classif_setor_w,
	ie_opcao_horario_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;


ie_setor_acm_w := Obter_se_setor_acm(cd_setor_atendimento_w);

if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	select	max(nr_agrupamento)
	into STRICT	nr_agrupamento_ww
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	nr_seq_material = nr_seq_material_p;
end if;

if (hr_prim_horario_p IS NOT NULL AND hr_prim_horario_p::text <> '') and (hr_prim_horario_p <> '  :  ') then
	hr_prim_horario_w	:= hr_prim_horario_p;
end if;

if (cd_topografia_cih_p IS NOT NULL AND cd_topografia_cih_p::text <> '') then
	cd_topografia_cih_w	:= cd_topografia_cih_p;
end if;

ie_reordenar_w := Obter_Param_Usuario(3130, 292, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_reordenar_w);
ie_diluicao_recons_w := Obter_Param_Usuario(924, 195, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_diluicao_recons_w);
ie_recomendacao_via_adm_w := Obter_Param_Usuario(924, 268, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_recomendacao_via_adm_w);
ie_sem_aprazamento_param_w := Obter_Param_Usuario(924, 141, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_sem_aprazamento_param_w);
ie_utiliza_receita_w := Obter_Param_Usuario(924, 152, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_utiliza_receita_w);
ie_gerar_Dil_composto_w := Obter_Param_Usuario(924, 316, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_gerar_Dil_composto_w);
ie_excDilBolus_w := Obter_Param_Usuario(924, 327, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_excDilBolus_w);
ie_limpar_prim_hor_acm_w := Obter_Param_Usuario(924, 445, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_limpar_prim_hor_acm_w);
ie_gera_receita_w := Obter_Param_Usuario(924, 475, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_receita_w);
ie_justificativa_novo_w := Obter_Param_Usuario(924, 502, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_justificativa_novo_w); /* Thiago Oliveira 04/11/11 OS379445*/
ie_gerar_kit_w := Obter_Param_Usuario(924, 513, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_gerar_kit_w);
ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
ie_interv_agora_check_w := Obter_Param_Usuario(924, 548, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_interv_agora_check_w);
ie_interv_acm_check_w := Obter_Param_Usuario(924, 554, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_interv_acm_check_w);
ie_diluicao_recons_prot_w := Obter_Param_Usuario(924, 648, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_diluicao_recons_prot_w);
VarCheckInterSN_w := Obter_Param_Usuario(924, 650, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarCheckInterSN_w);
ie_somente_selecionado_w := Obter_Param_Usuario(924, 686, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_somente_selecionado_w);
ie_check_tipo_interv_w := Obter_Param_Usuario(924, 809, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_check_tipo_interv_w);
ie_redef_hor_medic_prot_w := Obter_Param_Usuario(924, 928, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_redef_hor_medic_prot_w);
VarChecarAgoraPA_w := Obter_Param_Usuario(924, 831, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarChecarAgoraPA_w);
VarIeRecomend_w := Obter_Param_Usuario(924, 48, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarIeRecomend_w);
ie_dose_null_medic_w := Obter_Param_Usuario(924, 802, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_dose_null_medic_w);
ie_permite_acm_w := Obter_Param_Usuario(924, 839, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_permite_acm_w);
VarAplicConformeDose_w := Obter_Param_Usuario(924, 1069, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarAplicConformeDose_w);
IeBuscaDoseCadastro_w := Obter_Param_Usuario(924, 1106, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, IeBuscaDoseCadastro_w);
VarObservacaoMedic_w := Obter_Param_Usuario(-1010, 1, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarObservacaoMedic_w);
ie_medic_ciclo_w := Obter_Param_Usuario(281, 1322, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_medic_ciclo_w);
VarPermiteMedicSN_w := Obter_param_Usuario(924, 840, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarPermiteMedicSN_w);
VarPermiteMedicACM_w := Obter_Param_Usuario(924, 839, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarPermiteMedicACM_w);
VarPermiteSolACM_w := Obter_Param_Usuario(924, 696, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarPermiteSolACM_w);
VarPermiteSolSN_w := Obter_Param_Usuario(924, 697, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, VarPermiteSolSN_w);
ie_utiliza_horarios_w := Obter_Param_Usuario(924, 116, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_utiliza_horarios_w);

select	max(ds_dia_ciclo)
into STRICT	ds_dia_ciclo_w
from	paciente_atendimento
where	nr_seq_atendimento	= nr_seq_atendimento_p;

select	coalesce(max(nr_agrupamento),0)
into STRICT		nr_seq_agrup_w
from		prescr_material
where	nr_prescricao	= nr_prescricao_p
and		ie_agrupador	= 1;

OPEN C01;
LOOP
FETCH C01 into
	cd_material_w,
	nr_seq_material_prot_w,
	cd_unidade_medida_w ,
	qt_dose_w,
	qt_dose_peso_w,
	ie_via_aplicacao_w,
	nr_agrupamento_w,
	ds_recomendacao_w,
	ie_agrupador_w,
	cd_intervalo_w,
	ds_horarios_w,
	cd_unid_med_consumo_w,
	qt_minimo_multiplo_solic_w,
	ie_se_necessario_w,
	qt_minuto_aplicacao_w,
	qt_hora_aplicacao_w,
	ie_bomba_infusao_w,
	ie_aplic_bolus_w,
	ie_aplic_lenta_w,
	ie_acm_w,
	qt_solucao_w,
	ds_dose_diferenciada_w,
	hr_prim_horario_w,
	ie_agora_medic_w,
	qt_vel_infusao_w,
	ie_dias_util_medic_w,
	ie_multiplicar_dose_w,
	ds_obs_via_aplicacao_w,
	ie_lado_w,
	ie_objetivo_w,
	qt_dias_prev_util_w,
	ds_dias_aplicacao_w,
	ie_checar_adep_w,
	ie_arredondar_w,
	ds_justificativa_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_ww,
	cd_topografia_cih_w,
	cd_microorganismo_cih_w,
	cd_amostra_cih_w,
	ie_origem_infeccao_w,
	ie_indicacao_w,
	ie_uso_antimicrobiano_w,
	ie_medicacao_paciente_w,
	cd_motivo_baixa_w,
	ie_dose_espec_agora_w,
	qt_dose_especial_w,
	hr_dose_especial_w,
	ie_aplicar_w,
	cd_kit_w,
	ie_fator_correcao_w,
	qt_dispensar_acm_sn_w,
	qt_dose_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_agrupador_w <> 1) then
		qt_dose_w	:= qt_dose_ww;
	end if;

	cd_material_generico_w := obter_regra_subst_com(nr_prescricao_p, cd_material_w);

	if	coalesce(cd_material_generico_w, 0) > 0 then
		cd_material_w := cd_material_generico_w;
	end if;

	cd_intervalo_w	:= coalesce(cd_intervalo_p,cd_intervalo_w);

    if (coalesce(hr_prim_horario_w::text, '') = '') then
		hr_prim_horario_w := obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
	end if;
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
		ie_limpar_prim_horario_w := obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_w);
	end if;

	if (ie_limpar_prim_horario_w = 'S') then
		hr_prim_horario_w := '';
	elsif (ie_opcao_horario_w IS NOT NULL AND ie_opcao_horario_w::text <> '') and
		((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then
		hr_prim_horario_w	:= Obter_primeiro_horario_prescr(nr_prescricao_p);
	end if;

	if (coalesce(nr_seq_solucao_novo_p,0) > 0) then
		ie_agrupador_w	:= 4;
	end if;

	qt_dose_cadastro_w	:= qt_dose_w;

	if (coalesce(ie_urgencia_p, 'N') = 'S') or
		((ie_agora_medic_w = 'S') and (ie_acm_w = 'N') and (ie_se_necessario_w = 'N')) then
		ie_agora_medic_w 	:= 'S';
		ie_acm_w		 	:= 'N';
		ie_se_necessario_w 	:= 'N';
	else
		ie_agora_medic_w := 'N';
	end if;

	if (coalesce(ie_acm_p, 'N') = 'S') or
		((ie_acm_w = 'S') and (ie_se_necessario_w = 'N') and (ie_agora_medic_w = 'N') and (coalesce(ie_acm_p, 'N') <> 'X')) then
		ie_acm_w 			:= 'S';
		ie_agora_medic_w 	:= 'N';
		ie_se_necessario_w 	:= 'N';
	else
		ie_acm_w := 'N';
	end if;

	if (coalesce(ie_se_necessario_p, 'N') = 'S') or
		((ie_se_necessario_w = 'S') and (ie_agora_medic_w = 'N') and (ie_acm_w = 'N')) then
		ie_se_necessario_w 	:= 'S';
		ie_agora_medic_w	:= 'N';
		ie_acm_w			:= 'N';
	else
		ie_se_necessario_w := 'N';
	end if;

	if (ie_agora_medic_w = 'N') and (coalesce(ie_se_necessario_w,'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N') then
		ie_marcar_agora_w	:= Obter_Se_marca_Agora(cd_setor_atendimento_w);

		if	((VarChecarAgoraPA_w = 'S') or
			 (VarChecarAgoraPA_w = 'D' AND ie_marcar_agora_w = 'S')) and (cd_classif_setor_w = '1') then
			if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
				ie_agora_medic_w := obter_se_intervalo_agora(cd_intervalo_p);
			else
				ie_agora_medic_w := 'S';
			end if;
		end if;
	end if;

	if (ie_agrupador_p = 2) then
		ie_opcao_w := 2;
	elsif (ie_agrupador_p = 12) then
		ie_opcao_w := 12;
	elsif (ie_agrupador_p = 8) then
		ie_opcao_w := 8;
	else
		ie_opcao_w := 1;
	end if;

	/* Junior - 10/03/11 - Validar se o intervalo que vem do protocolo e liberado para o item, se nao, inserir null no intervalo.*/

	if (ie_agora_medic_w <> 'S') and (ie_acm_w <> 'S') then
		if (ie_interv_agora_check_w = 'S') and (ie_interv_acm_check_w = 'S') then
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and 	cd_intervalo = cd_intervalo_w
			--and     nvl(ie_se_farmacia_amb,'N') = 'N'
			and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
			and	Obter_se_intervalo_material(cd_material_w, cd_intervalo) = 'S'
			and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
			and     obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, null) = 'S'
			order by coalesce(nr_seq_apresent,999),
				 ds_intervalo;
		elsif (ie_interv_agora_check_w <> 'S') and (ie_interv_acm_check_w = 'S') then
			select  max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and     ie_agora    <> 'S'
			--and     nvl(ie_se_farmacia_amb,'N') = 'N'
			and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
			and 	cd_intervalo = cd_intervalo_w
			and 	Obter_se_intervalo_material(cd_material_w, cd_intervalo) = 'S'
			and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
			and     obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
			order by coalesce(nr_seq_apresent,999),
				 ds_intervalo;
		elsif (ie_interv_agora_check_w = 'S') and (ie_interv_acm_check_w <> 'S') then
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and     ie_acm    <> 'S'
			and 	cd_intervalo = cd_intervalo_w
			--and     nvl(ie_se_farmacia_amb,'N') = 'N'
			and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
			and	Obter_se_intervalo_material(cd_material_w, cd_intervalo) = 'S'
			and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
			and     obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
			order by coalesce(nr_seq_apresent,999),
				 ds_intervalo;
		else
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and     ie_agora    <> 'S'
			and     ie_acm    <> 'S'
			and 	cd_intervalo = cd_intervalo_w
			--and     nvl(ie_se_farmacia_amb,'N') = 'N'
			and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
			and	Obter_se_intervalo_material(cd_material_w, cd_intervalo) = 'S'
			and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
			and     obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
			order by coalesce(nr_seq_apresent,999),
				 ds_intervalo;
		end if;
	elsif (ie_agora_medic_w = 'S') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from    intervalo_prescricao
		where   ie_situacao = 'A'
		and     ie_agora    = 'S'
		--and     nvl(ie_se_farmacia_amb,'N') = 'N'
		and 	cd_intervalo = cd_intervalo_w
		and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
		and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
		and     obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
		order by coalesce(nr_seq_apresent,999),
			     ds_intervalo;
	else
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from    intervalo_prescricao
		where   ie_situacao = 'A'
		and 	cd_intervalo = cd_intervalo_w
		and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w))
		and     Obter_se_intervalo(cd_intervalo, ie_opcao_w) = 'S'
		--and     nvl(ie_se_farmacia_amb,'N') = 'N'
		and     obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
		order by coalesce(nr_seq_apresent,999),
			 ds_intervalo;
	end if;



	ds_dias_aplicacao_w	:= Replace(ds_dias_aplicacao_w,' ','');
	ds_texto_w		:= '';

	FOR y IN 1..coalesce(length(ds_dias_aplicacao_w),0) LOOP
		X	:= coalesce(substr(upper(ds_dias_aplicacao_w), y, 1),0);
		if (position(x in ds_valido_w) > 0) then
			ds_texto_w	:= ds_texto_w || X;
		else
			--Erro na padronizacao dos horarios do mat/med #@CD_MATERIAL#@. Verifique o cadastro do protocolo se os dias estao cadastrados corretamente.
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(178299,'CD_MATERIAL='||cd_material_w);
		end if;
	END LOOP;
	ds_dias_aplicacao_w	:= ds_texto_w;
	ds_dias_aplicacao_w	:= Replace(ds_dias_aplicacao_w,' ','');
	dias_w.delete;
	ds_dias_aplicacao_w	:= ds_dias_aplicacao_w ||',';
	cont_w	:= 0;
	z	:= 0;
	while	(ds_dias_aplicacao_w IS NOT NULL AND ds_dias_aplicacao_w::text <> '') LOOP
		begin
		posicao_w	:= position(',' in ds_dias_aplicacao_w);
		z := z + 1;
		dias_w[z].ds_dias_aplicacao	:= substr(ds_dias_aplicacao_w,1,posicao_w - 1);
		ds_dias_aplicacao_w		:= substr(ds_dias_aplicacao_w,posicao_w + 1,length(ds_dias_aplicacao_w));
		cont_w	:= cont_w + 1;

		if (cont_w > 100) then
			exit;
		end if;
		end;
	end loop;
	ie_dia_valido_w	:= 'S';
	if (ds_dia_ciclo_w IS NOT NULL AND ds_dia_ciclo_w::text <> '') then
		ie_dia_valido_w	:= 'N';
		for i in 1..dias_w.count loop
			begin
			if (dias_w[i].ds_dias_aplicacao	= ds_dia_ciclo_w) then
				ie_dia_valido_w	:= 'S';
				exit;
			end if;
			end;
		end loop;
	end if;

	if (ie_dia_valido_w	= 'S') then
		/* Rafael em 20/07/2007 OS62068 substitui esta linha pela rotina abaixo
		ie_agora_medic_w		:= ie_urgencia_p;
		*/
		ie_ctrl_loop_w		:= 1;
		ie_loop_w		:= 0;
		doses_dif_w.delete;
		if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
			ds_dose_diferenciada_ww	:= ds_dose_diferenciada_w;
			while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') and ( ie_loop_w < 101) LOOP
				begin
				h :=  position('-' in ds_dose_diferenciada_ww);
				if (h > 0) then
					qt_dose_diferenciada_w	:= replace(substr(ds_dose_diferenciada_ww, 1, h-1),'/',',');
					ds_dose_diferenciada_ww	:= substr(ds_dose_diferenciada_ww, h+1, 50);
				else
					qt_dose_diferenciada_w	:= replace(ds_dose_diferenciada_ww,'/',',');
					ds_dose_diferenciada_ww	:= null;
				end if;
				if (coalesce(qt_dose_diferenciada_w,0) > 0) then
					doses_dif_w[ie_ctrl_loop_w].qt_dose	:= coalesce(qt_dose_diferenciada_w,0);
					ie_ctrl_loop_w				:= ie_ctrl_loop_w + 1;
				end if;
				ie_loop_w	:=  ie_loop_w + 1;
				end;
			end loop;
		end if;

		if (qt_dose_p > 0) and (nr_seq_material_p = nr_seq_material_prot_w) then /* Oraci em 05/12/2007 OS71763 */
			qt_dose_w := qt_dose_p;
		end if;

		if (qt_dose_cadastro_w 	> 0) and (coalesce(cd_unidade_medida_p::text, '') = '') and
			(IeBuscaDoseCadastro_w = 'S' AND ie_agrupador_w <> 4) then

			qt_dose_padrao_w := Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w, campo_numerico(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A')),qt_peso_p,'N','D',cd_intervalo_w);
			cd_unidade_padrao_w := Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w, campo_numerico(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A')),qt_peso_p,'N','U',cd_intervalo_w);
			if (coalesce(qt_dose_padrao_w::text, '') = '') and (cd_unidade_padrao_w IS NOT NULL AND cd_unidade_padrao_w::text <> '') then
				qt_dose_w := obter_dose_convertida(cd_material_w,qt_dose_w,cd_unidade_medida_w,cd_unidade_padrao_w);
				cd_unidade_medida_w := cd_unidade_padrao_w;
			else
				qt_dose_w := coalesce(qt_dose_padrao_w,qt_dose_w);
				cd_unidade_medida_w := coalesce(cd_unidade_padrao_w,cd_unidade_medida_w);
			end if;
		end if;

		qt_dose_espec_padrao_w := Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w, campo_numerico(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A')),qt_peso_p,'N','DT',cd_intervalo_w);

		if (qt_dose_espec_padrao_w > 0) and (IeBuscaDoseCadastro_w = 'S') then
			qt_dose_especial_w := qt_dose_espec_padrao_w;
		end if;

		begin
		select	coalesce(max(a.nr_dia_util),0)
		into STRICT	nr_dia_util_w
		from	prescr_material a,
			prescr_medica_v b
		where	cd_material		= cd_material_w
		  and	a.nr_prescricao		= b.nr_prescricao
		  and	b.nr_atendimento	= nr_atendimento_w
		  and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) = (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w) - 1);
		exception
		when others then
			nr_dia_util_w := 0;
		end;

		if (ie_dias_util_medic_w <> 'N') then
			select	CASE WHEN ie_dias_util_medic_w='O' THEN nr_dia_util_w  ELSE nr_dia_util_w + 1 END
			into STRICT	nr_dia_util_w
			;
		else
			nr_dia_util_w := null;
		end if;

		if (ie_dias_util_medic_w <> 'N') then /* Thiago Oliveira 04/11/11 OS379445*/
			SELECT * FROM Consiste_Util_Medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_w, cd_material_w, nr_dia_util_w, qt_dias_liberado_w, ie_controle_medico_w, qt_dias_lib_atend_w) INTO STRICT nr_dia_util_w, qt_dias_liberado_w, ie_controle_medico_w, qt_dias_lib_atend_w;

			if (ie_justificativa_novo_w in ('S','A')) and (ie_controle_medico_w <> '0') and (nr_dia_util_w > qt_dias_lib_atend_w) then
				ds_justificativa_w	:= substr(ds_justificativa_w || chr(13) || ' ' || wheb_mensagem_pck.get_texto(307907),1,2000); -- Novo ciclo iniciado
			end if;
		end if;

		if (coalesce(hr_prim_horario_w::text, '') = '') and (ie_limpar_prim_horario_w = 'N') then
			hr_prim_horario_w := obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
		end if;

		if (qt_dose_peso_w > 0) and (qt_peso_p > 0) then
			qt_dose_w	:= qt_dose_peso_w * qt_peso_p;

			if (ie_arredondar_w	= 'S') then
				qt_dose_w := Arredondamento(qt_dose_w, 1, 'R');
			end if;

			if (upper(cd_unidade_medida_w) = upper(obter_unid_med_usua('GTS'))) then
				qt_dose_w	:= round(qt_dose_w);
			end if;
		end if;


		cd_intervalo_w	:= coalesce(cd_intervalo_p,cd_intervalo_w);
		ie_se_necessario_ww := ie_se_necessario_w;
		/* Caso o parametro [809] - REP esteja habilitado, deve marcar o tipo do intervalo. (Novo tratamento) */

		if (ie_check_tipo_interv_w = 'S') and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (coalesce(ie_se_necessario_w,'N') = 'N') and
			((coalesce(ie_agora_medic_w,'N') = 'N') or
			 ((coalesce(ie_agora_medic_w,'N') = 'S') and (coalesce(ie_urgencia_p, 'P') = 'N'))) and (coalesce(ie_acm_w,'N') = 'N') then
			Select	coalesce(coalesce(max(ie_agora),ie_agora_medic_w),'N'),
				CASE WHEN ie_permite_acm_w='S' THEN coalesce(coalesce(max(ie_acm),ie_acm_w),'N') WHEN ie_permite_acm_w='D' THEN CASE WHEN ie_setor_acm_w='S' THEN coalesce(coalesce(max(ie_acm),ie_acm_w),'N')  ELSE 'N' END   ELSE 'N' END ,
				coalesce(coalesce(max(ie_se_necessario), ie_se_necessario_w),'N')
			into STRICT	ie_agora_medic_w,
				ie_acm_w,
				ie_se_necessario_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
		end if;

		if (coalesce(ie_check_tipo_interv_w, 'N') = 'S') and (coalesce(VarCheckInterSN_w, 'N') = 'N') and (coalesce(ie_se_necessario_p,'P') = 'N') and (coalesce(ie_se_necessario_ww,'N') = 'N')then
			ie_se_necessario_w := 'N';
		end if;

		if (coalesce(nr_seq_solucao_novo_p,0) = 0) then

			if	(VarPermiteMedicSN_w = 'N' AND ie_se_necessario_w  = 'S')then
				ie_se_necessario_w := 'N';
				var_entrou := 'S';
			end if;

			if (ie_acm_w = 'S') then

				if (VarPermiteMedicACM_w =  'N') then
					ie_acm_w := 'N';
					var_entrou := 'S';
				elsif	(VarPermiteMedicACM_w = 'D' AND ie_setor_acm_w = 'N') then
					ie_acm_w := 'N';
				end if;
			end if;

			if (ie_interv_acm_check_w = 'N') and (var_entrou = 'S') then
				cd_intervalo_w := null;
			end if;
		else
			if (VarPermiteSolACM_w = 'N')and (ie_acm_W = 'S')then
				ie_acm_w := 'N';
				var_entrou := 'S';
			end if;

			if (VarPermiteSolSN_w = 'N') and (ie_se_necessario_w  = 'S') then
				ie_se_necessario_w := 'N';
				var_entrou := 'S';
		        end if;

			if (ie_interv_acm_check_w = 'N')and (var_entrou = 'S')then
				cd_intervalo_w := null;
			end if;

		end if;


		if (ie_multiplicar_dose_w = 'S') then
			qt_dose_w	:= qt_dose_w * qt_protocolo_p;
		end if;

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_material_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p;

		if (ie_agora_medic_w = 'S') and (coalesce(cd_intervalo_w::text, '') = '') then

			dt_primeiro_horario_w := clock_timestamp();

			select	coalesce(max(cd_intervalo),cd_intervalo_w)
			into STRICT	cd_intervalo_w
			from	intervalo_prescricao
			where	ie_agora	= 'S'
			and	obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, cd_setor_atendimento_w) = 'S';
		end if;

		if (coalesce(nr_seq_proc_novo_p,0) > 0) and (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
			cd_intervalo_w	:= cd_intervalo_p;
		end if;

		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
			select	max(qt_min_intervalo)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;
		end if;

		qt_conversao_dose_w	:= obter_conversao_unid_med(cd_material_w,cd_unidade_medida_w);
		if (ie_agrupador_w = 4) and (ie_limpar_prim_horario_w = 'N') then
			begin
			if	(ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
				qt_solucao_w	:= obter_conversao_ml(cd_material_w,get_sum_qt_dose_Espec(),cd_unidade_medida_w);
			else
				qt_solucao_w	:= obter_conversao_ml(cd_material_w,qt_dose_w,cd_unidade_medida_w);
			end if;

			select	coalesce(max(nr_etapas),1)
			into STRICT	nr_ocorrencia_w
			from	protocolo_medic_solucao
			where	cd_protocolo	= cd_protocolo_p
			and	nr_sequencia 	= nr_sequencia_p
			and	nr_seq_solucao 	= nr_seq_solucao_p;

			if (coalesce(nr_seq_solucao_novo_p,0) = 0) then

				SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_inicio_prescr_w,dt_prescricao_w), dt_primeiro_horario_w, nr_horas_validade_w, cd_material_w, 0, 0, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'S', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

				ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
			else
				select	coalesce(max(nr_etapas),1)
				into STRICT	nr_ocorrencia_w
				from	prescr_solucao
				where	nr_prescricao	= nr_prescricao_p
				and	nr_seq_solucao	= nr_seq_solucao_novo_p;
				ds_horarios_w := null;
			end if;
			end;
		else
		begin
			nr_ocorrencia_w		:= 0;

			if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
				dt_primeiro_horario_w := to_date(to_char(dt_prescricao_w,'dd/mm/yyyy ') ||
							 substr(hr_prim_horario_w,1,5),'dd/mm/yyyy hh24:mi');
			end if;

			if (ie_agora_medic_w = 'S') then
				dt_primeiro_horario_w := clock_timestamp();
			end if;

			if (nr_seq_proc_novo_p IS NOT NULL AND nr_seq_proc_novo_p::text <> '') and (ie_agrupador_w = 5) then
				select	coalesce(dt_prev_execucao,dt_primeiro_horario_w)
				into STRICT	dt_primeiro_horario_w
				from	prescr_procedimento
				where	nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_seq_proc_novo_p;
			end if;

			SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_inicio_prescr_w,dt_prescricao_w), dt_primeiro_horario_w, nr_horas_validade_w, cd_material_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

			ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
			if (coalesce(ds_horarios_w::text, '') = '') and (ie_redef_hor_medic_prot_w = 'S') then
				hr_prim_horario_w := obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);

				SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, cd_intervalo_w, coalesce(dt_inicio_prescr_w,dt_prescricao_w), to_date(to_char(dt_prescricao_w,'dd/mm/yyyy ')||substr(hr_prim_horario_w,1,5),'dd/mm/yyyy hh24:mi'), nr_horas_validade_w, cd_material_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

				ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
			end if;

		end;
		end if;
		if (ie_acm_w = 'S') or (ie_se_necessario_w = 'S') then

			select	coalesce(max(b.qt_se_necessario),0),
					coalesce(max(b.ie_mesmo_zerado),'N')
			into STRICT		nr_ocorrencia_w,
					ie_mesmo_zerado_w
			from		intervalo_prescricao a,
					intervalo_setor b
			where	a.cd_intervalo 		= b.cd_intervalo
			and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
			and		coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
			and		a.cd_intervalo 		= cd_intervalo_w
			and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
			and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
			and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));

			if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
				Select	coalesce(max(qt_se_necessario),1)
				into STRICT	nr_ocorrencia_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_w;
			end if;
		end if;

		ie_intervalo_agora_w	:=  coalesce(obter_se_intervalo_agora(cd_intervalo_w),'N');

		if (ie_intervalo_agora_w = 'S') then
			nr_ocorrencia_w := 1;
		end if;

		if (ie_Agrupador_p = 4) and (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then

			qt_unitaria_w := dividir(trunc(dividir(get_sum_qt_dose_Espec() * 1000, qt_conversao_dose_w )),1000);

			qt_dose_w	  := get_sum_qt_dose_Espec();

			ie_loop_w		:= 0;
			qt_mat_dose_w	:= 0;
			qt_material_ww  := 0;
			if (coalesce(qt_conversao_dose_w,0) > 0) then

				ds_dose_diferenciada_ww	:= ds_dose_diferenciada_w;

				while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') and ( ie_loop_w < 101) LOOP
					begin

					h :=  position('-' in ds_dose_diferenciada_ww);

					if (h > 0) then
						qt_dose_diferenciada_w	:= replace(substr(ds_dose_diferenciada_ww, 1, h-1),'/',',');
						ds_dose_diferenciada_ww	:= substr(ds_dose_diferenciada_ww, h+1, 50);
					else
						qt_dose_diferenciada_w	:= replace(ds_dose_diferenciada_ww,'/',',');
						ds_dose_diferenciada_ww	:= null;
					end if;

					if (coalesce(qt_dose_diferenciada_w,0) > 0) then

						qt_mat_dose_w := dividir(trunc(dividir(qt_dose_diferenciada_w * 1000, qt_conversao_dose_w )),1000);

						if (trunc(qt_mat_dose_w) < qt_mat_dose_w) then
							qt_mat_dose_w := trunc(qt_mat_dose_w) + 1;
						end if;

						qt_material_ww := qt_material_ww + qt_mat_dose_w;

					end if;

					ie_loop_w	:=  ie_loop_w + 1;
					end;
				end loop;
			end if;

			if (qt_material_ww > 0) then
				qt_material_w := qt_material_ww;
			else
				qt_material_w := qt_unitaria_w;
			end if;

			ds_dose_diferenciada_ww := ds_dose_diferenciada_w;
		else
			qt_unitaria_w := dividir(trunc(dividir(qt_dose_w * 1000,qt_conversao_dose_w)),1000);
	--		qt_material_w := qt_unitaria_w;
			ds_dose_diferenciada_ww := null;
		end if;

		if (qt_unitaria_w = 0) then
			qt_unitaria_w :=  dividir(qt_dose_w ,qt_conversao_dose_w);
		end if;

		if (ie_dose_espec_agora_p = 'S') then
			qt_dose_especial_w					:= qt_dose_especial_p;
			ie_dose_espec_agora_w				:= ie_dose_espec_agora_p;
			cd_unid_med_dose_esp_w				:= cd_unidade_medida_dose_edit_p;
			qt_min_aplic_dose_esp_w				:= qt_min_aplic_dose_esp_p;
		end if;

		SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_seq_material_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, coalesce(qt_dose_especial_w,0), nr_ocorrencia_w, ds_dose_diferenciada_ww, ie_origem_inf_w, cd_unidade_medida_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

		if	((coalesce(hr_prim_horario_w::text, '') = '') or (ie_agora_medic_w = 'S')) and (ie_limpar_prim_horario_w = 'N') then
			hr_prim_horario_w	:= substr(to_char(dt_primeiro_horario_w,'dd/mm/yyyy hh24:mi:ss'),12,5);
		end if;

		if (ie_acm_w = 'S') then
			ds_horarios_w := 'ACM';
			if (ie_limpar_prim_hor_acm_w = 'S') then
				hr_prim_horario_w := '';
			end if;
		elsif (ie_se_necessario_w = 'S') then
			ds_horarios_w := 'SN';
			hr_prim_horario_w := '';
		end if;

		ie_sem_aprazamento_w := ie_sem_aprazamento_param_w;

		if (ie_sem_aprazamento_w <> 'R') then
			if (ie_sem_aprazamento_w = 'N') and (coalesce(ie_agora_medic_w,'N') = 'N') then
				ie_sem_aprazamento_w	:= 'S';
			else
				ie_sem_aprazamento_w	:= 'N';
			end if;
		else
			if (Obter_Se_Aprazamento_Setor(Obter_Setor_Atendimento(nr_atendimento_w)) = 'N') and (coalesce(ie_agora_medic_w,'N') = 'N') then
				ie_sem_aprazamento_w := 'S';
			else
				ie_sem_aprazamento_w := 'N';
			end if;
		end if;

		ie_sem_aprazamento_w := coalesce(obter_dados_apraz_interv(cd_intervalo_w, cd_setor_atendimento_w, '1'),ie_sem_aprazamento_w);

		if (ie_sem_aprazamento_w = 'S') or (ie_limpar_prim_horario_w = 'S') then
			ds_horarios_w		:= '';
			hr_prim_horario_w	:= '';
		end if;

		/*
		ie_via_aplicacao:
		Prioridade 1 - Vem do parametro ie_via_apliacao_p
		Prioridade 2 - Cursor dos componentes da solucao
		Prioridade 3 - Se for solucao obter a partir das Solucoes do Protocolo de Medicacao
		Prioridade 4 - Obter_Padrao_Param_Prescr
		Prioridade 5 - Cadastro do material
		Prioridade 6 - Via da solucao
		*/
		if (coalesce(ie_via_aplicacao_p::text, '') = '') then

			-- Se for solucao obter a partir das Solucoes do Protocolo de Medicacao
			if (ie_agrupador_p = 4) then
				select	max(ie_via_aplicacao)
				into STRICT	ie_via_aplicacao_ww
				from	protocolo_medic_solucao
				where	cd_protocolo	= cd_protocolo_p
				and		nr_sequencia 	= nr_sequencia_p
				and		nr_seq_solucao 	= nr_seq_solucao_p;
			end if;

			if (coalesce(ie_via_aplicacao_ww::text, '') = '') then
				ie_via_aplicacao_ww := Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w, campo_numerico(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A')),qt_peso_p,'N','V',cd_intervalo_w);
			end if;

			if (coalesce(ie_via_aplicacao_ww::text, '') = '') then

				select	max(ie_via_aplicacao)
				into STRICT	ie_via_aplicacao_ww
				from	material
				where	cd_material = cd_material_w;
			end if;

			if (coalesce(ie_via_aplicacao_ww::text, '') = '') and (nr_seq_solucao_novo_p > 0) then
				Select  coalesce(max(ie_via_aplicacao),'')
				into STRICT	ie_via_aplicacao_ww
				from	via_aplicacao
				where	ie_via_aplicacao = upper(obter_via_usuario('IV'));

				if (ie_via_aplicacao_ww = '') then
					Select  coalesce(max(ie_via_aplicacao),'')
					into STRICT	ie_via_aplicacao_ww
					from	prescr_solucao
					where	nr_prescricao  = nr_prescricao_p
					and	nr_seq_solucao = nr_seq_solucao_novo_p;
				end if;
			end if;

			if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then

				--Verifica se a via existe no cadastro
				Select  max(ie_via_aplicacao)
				into STRICT	ie_via_aplicacao_w
				from	via_aplicacao
				where	ie_via_aplicacao = ie_via_aplicacao_w;

			end if;

			--Se nao existir pega o retorno da  ie_via_aplicacao_ww
			if (coalesce(ie_via_aplicacao_w::text, '') = '') and (ie_via_aplicacao_ww IS NOT NULL AND ie_via_aplicacao_ww::text <> '') then
				ie_via_aplicacao_w := ie_via_aplicacao_ww;
			end if;

		else

			ie_via_aplicacao_w	:= ie_via_aplicacao_p;

		end if;


		if (ds_justificativa_p IS NOT NULL AND ds_justificativa_p::text <> '') then
			if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				ds_justificativa_w	:= substr(ds_justificativa_p || chr(13) || ds_justificativa_w,1,2000);
			else
				ds_justificativa_w	:= ds_justificativa_p;
			end if;
		end if;


		-- P representa "O primeiro" do agrupamento
		if (coalesce(ie_gerar_composto_p,'N') in ('S', 'P')) then
			nr_seq_agrup_w		:= 0;
			select	coalesce(max(nr_agrupamento),1)
			into STRICT	nr_agrupamento_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	ie_agrupador	= ie_agrupador_w;

			if (ie_gerar_composto_p = 'P') then
				nr_agrupamento_w := nr_agrupamento_w + 1;
			end if;

			Select 	count(nr_agrupamento)
			into STRICT	qt_composto_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and		ie_agrupador	= ie_agrupador_w
			and		nr_agrupamento  = nr_agrupamento_w
			and		ie_item_superior = 'S';

			if (coalesce(ie_item_sup_w,'S') <> 'N') and (qt_composto_w = 0)then
				ie_item_sup_w := 'S';
			else
				ie_item_sup_w := 'N';
			end if;

		end if;


		if (ie_gera_receita_w	= 'S') and (ie_utiliza_receita_w	= 'S') then
			nr_receita_w	:= nr_prescricao_p;
		end if;

		nr_seq_solucao_novo_w	:= nr_seq_solucao_novo_p;
		if (nr_seq_solucao_novo_p = 0) then
			nr_seq_solucao_novo_w	:= null;
		end if;

		if (ie_agrupador_p = 13) then
			ie_agrupador_w	:= 13;
		end if;

		if (ie_objetivo_p IS NOT NULL AND ie_objetivo_p::text <> '') then
			ie_objetivo_w	:= ie_objetivo_p;
		end if;
		if (qt_dias_solicitado_p IS NOT NULL AND qt_dias_solicitado_p::text <> '') then
			qt_dias_prev_util_w	:= qt_dias_solicitado_p;
		end if;
		if (ie_indicacao_p IS NOT NULL AND ie_indicacao_p::text <> '') then
			ie_indicacao_w	:= ie_indicacao_p;
		end if;

		ds_observacao_far_w	:= '';
		ds_observacao_w		:= '';
		ds_obs_padrao_w		:= '';

		if (coalesce(Obter_se_apres_orient_mat(cd_material_w, cd_pessoa_fisica_w),'S') = 'S') then
			if (VarIeRecomend_w  = 'G') then
				select	max(substr(Obter_orientacao_medic(cd_material_w),1,2000))
				into STRICT		ds_observacao_w
				;
			elsif (VarIeRecomend_w  = 'F') then
				select	max(substr(Obter_orientacao_medic(cd_material_w),1,2000))
				into STRICT		ds_observacao_far_w
				;
			end if;
		end if;

		ds_observacao_far_w	:= trim(both ds_observacao_far_w);
		ds_observacao_w		:= trim(both ds_observacao_w);

		if	((nr_seq_material_p = nr_seq_material_w) or (nr_seq_material_p = 0)) then
			if (VarObservacaoMedic_w = 'S') then
				ds_observacao_w	:= trim(both substr(ds_recomendacao_p,1,2000));
			else
				if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
					ds_observacao_w	:= substr(ds_observacao_w || ' - ' || coalesce(ds_recomendacao_p,ds_recomendacao_w) || ds_obs_via_aplicacao_w,1,2000);
				else
					ds_observacao_w	:= substr(coalesce(ds_recomendacao_p,ds_recomendacao_w) || ds_obs_via_aplicacao_w,1,2000);
				end if;
			end if;
		else
			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
				ds_observacao_w	:= substr(ds_observacao_w || ' - ' || coalesce(ds_recomendacao_p,ds_recomendacao_w)  ||' '|| ds_obs_via_aplicacao_w,1,2000);
			elsif ((coalesce(ds_recomendacao_p,ds_recomendacao_w) IS NOT NULL AND (coalesce(ds_recomendacao_p,ds_recomendacao_w))::text <> '')) then
					ds_observacao_w	:= substr(coalesce(ds_recomendacao_p,ds_recomendacao_w)  ||' '|| ds_obs_via_aplicacao_w,1,2000);
			elsif (ds_obs_via_aplicacao_w IS NOT NULL AND ds_obs_via_aplicacao_w::text <> '') then
					ds_observacao_w	:= substr(ds_obs_via_aplicacao_w,1,2000);
			end if;
		end if;

		qt_dose_w		:= coalesce(qt_dose_w,0);

		qt_dose_limite_w	:= obter_dose_maxima(cd_material_w,
												 cd_unidade_medida_w,
												 qt_dose_w,
												 nr_ocorrencia_w,
												 ie_via_aplicacao_w,
												 ie_agrupador_w,
												 qt_hora_aplicacao_w,
												 coalesce(qt_min_intervalo_w,qt_min_intervalo_ww),
												 ie_acm_w,
												 ie_se_necessario_w,
												 nr_prescricao_p,
												 nr_seq_material_w,
												 ie_utiliza_horarios_w,
												 ds_horarios_w,
												 ie_agora_medic_w);


		ds_obs_padrao_w := substr(Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_w,cd_setor_atendimento_w,cd_pessoa_fisica_w, campo_numerico(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A')),qt_peso_p, coalesce(ie_se_necessario_w,'N'), 'O',cd_intervalo_w),1,2000);
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') and (ds_obs_padrao_w IS NOT NULL AND ds_obs_padrao_w::text <> '') then
			ds_observacao_w := substr(ds_observacao_w ||' '||ds_obs_padrao_w,1,2000);
		elsif (ds_obs_padrao_w IS NOT NULL AND ds_obs_padrao_w::text <> '') then
			ds_observacao_w := ds_obs_padrao_w;
		end if;

		if (qt_dose_limite_w	> 0) then
			qt_dose_w	:= qt_dose_limite_w;

			qt_unitaria_w := dividir(trunc(dividir(qt_dose_w * 1000,qt_conversao_dose_w)),1000);

			if (qt_unitaria_w = 0) then
				qt_unitaria_w :=  dividir(qt_dose_w ,qt_conversao_dose_w);
			end if;

			SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_seq_material_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, coalesce(qt_dose_especial_w,0), nr_ocorrencia_w, ds_dose_diferenciada_ww, ie_origem_inf_w, cd_unidade_medida_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
		end if;

		if (ie_agrupador_p = 4) and
			((coalesce(ie_acm_w,'N') = 'S') or (coalesce(ie_se_necessario_w,'N') = 'S')) then
			qt_dispensar_w := qt_dispensar_acm_sn_w;
		end if;

	/* OS 711637
	    select substr(Obter_se_atualiza_campo(nr_prescricao_p, cd_material_w, ie_via_aplicacao_w, ie_se_necessario_w),1,1)
	    into ie_atualizar_campos_w
	    from dual;

		if  (ie_altera_dose_componentes_w = 'M')  and
			(qt_dose_w = 0 or qt_dose_w is null) then
			ie_altera_dose_componentes_w := 'N';
		end if;

        if (ie_altera_dose_componentes_w <> 'M') and ((ie_dose_null_medic_w = 'S') or
           ((ie_dose_null_medic_w = 'R') and (ie_atualizar_campos_w = 'S'))) then
           qt_dose_w := null;
           cd_unidade_medida_w := null;
        elsif (ie_dose_null_medic_w = 'D') then
           qt_dose_w := null;
		end if;*/
		select	coalesce(max(qt_casas),0)
		into STRICT	qt_casas_retorno_w
		from	rep_regra_arredond_dose
		where	qt_peso_p between qt_peso_inicial and qt_peso_final;

		if (qt_casas_retorno_w > 0) then
			qt_dose_w	:= round(qt_dose_w,qt_casas_retorno_w);
		end if;


		nr_agrupamento_w2 := (substr(coalesce(coalesce(nr_seq_agrup_w,0) + coalesce(nr_agrupamento_w,0),0),1,7))::numeric;


		--OS713338
		if	((ie_agrupador_p = 1) and (coalesce(ie_gerar_composto_p,'N') not in ('S', 'P'))) then
			--Verifica se ja existe item com o nr_agrupamento na prescr_material
			select		count(*)
			into STRICT		qt_reg_w
			from		prescr_material
			where		nr_prescricao	= nr_prescricao_p
			and		    nr_agrupamento 	= nr_agrupamento_w2
			and			ie_agrupador	= ie_agrupador_w;

			--Verificar se existe algum outro medicamento com o nr_agrupamento igual ..
			if (qt_reg_w > 0) then

				select	count(*)
				into STRICT	qt_reg_w
				from	Protocolo_medic_material a
				where	a.cd_protocolo	 			= cd_protocolo_p
				and	a.nr_sequencia				= nr_sequencia_p
				and	a.ie_agrupador				= ie_agrupador_w
				and	a.nr_agrupamento 			= nr_agrupamento_w
				and	a.cd_material				<> cd_material_w;

				--Nao e um medicamento agrupado, entao pega o proximo nr_agrupamento
				if (qt_reg_w = 0) then
					nr_agrupamento_w2 := OBter_Proximo_Agrup_Medic(nr_prescricao_p);
				end if;
			end if;
			-- Fim OS OS713338
		end if;

		if ((ie_dose_espec_agora_w = 'S') and (qt_dose_especial_w IS NOT NULL AND qt_dose_especial_w::text <> '') and (coalesce(hr_dose_especial_p::text, '') = '') and (coalesce(hr_dose_especial_w::text, '') = '')) then
			hr_dose_especial_w := to_char(clock_timestamp(),'hh24:mi');
		end if;

		Insert into Prescr_Material(
			nr_prescricao,
			nr_sequencia,
			ie_origem_inf,
			cd_material,
			cd_unidade_medida,
			qt_dose,
			qt_unitaria,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			ds_observacao,
			ie_via_aplicacao,
			nr_agrupamento,
			cd_motivo_baixa,
			ie_utiliza_kit,
			cd_unidade_medida_dose,
			qt_conversao_dose,
			ie_urgencia,
			nr_ocorrencia,
			qt_total_dispensar,
			ds_horarios,
			nr_sequencia_solucao,
			nr_sequencia_dieta,
			nr_sequencia_proc,
			hr_prim_horario,
			ie_suspenso,
			ie_agrupador,
			ie_se_necessario,
			qt_min_aplicacao,
			qt_hora_aplicacao,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			ds_dose_diferenciada,
			qt_solucao,
			ie_cultura_cih,
			ie_antibiograma,
			ie_uso_antimicrobiano,
			cd_protocolo,
			nr_seq_protocolo,
			nr_seq_mat_protocolo,
			ie_recons_diluente_fixo,
			qt_vel_infusao,
			ie_sem_aprazamento,
			nr_dia_util,
			ie_regra_disp,
			ie_lado,
			ie_objetivo,
			qt_dias_solicitado,
			qt_min_intervalo,
			ie_checar_adep,
			ie_permite_substituir,
			ds_justificativa,
			qt_hora_intervalo,
			cd_topografia_cih,
			nr_receita,
			cd_microorganismo_cih,
			cd_amostra_cih,
			ie_origem_infeccao,
			ie_indicacao,
			ie_medicacao_paciente,
			ie_dose_espec_agora,
			qt_dose_especial,
			hr_dose_especial,
			ie_aplicar,
			ds_observacao_far,
			ie_fator_correcao,
			ie_item_superior,
			qt_min_aplic_dose_esp,
			cd_unid_med_dose_esp,
			qt_total_dias_lib,
			ds_medic_nao_padrao)
		values (
			nr_prescricao_p,
	     		nr_seq_material_w,
		 	'S',
		 	cd_material_w,
		 	cd_unid_med_consumo_w,
		 	qt_dose_w,
		 	coalesce(qt_unitaria_w,0),
		 	coalesce(qt_material_w,0),
		 	clock_timestamp(),
			nm_usuario_p,
		 	cd_intervalo_w,
		 	ds_observacao_w,
		 	ie_via_aplicacao_w,

			nr_agrupamento_w2,
			cd_motivo_baixa_w,
			'N',
			cd_unidade_medida_w,
			coalesce(qt_conversao_dose_w,0),
			ie_agora_medic_w,
			nr_ocorrencia_w,
			coalesce(qt_dispensar_w,0),
			ds_horarios_w,
			nr_seq_solucao_novo_w,
			nr_seq_dieta_novo_p,
			nr_seq_proc_novo_p,
			hr_prim_horario_w,
			'N',
		      	ie_agrupador_w,
			ie_se_necessario_w,
			qt_minuto_aplicacao_w,
			qt_hora_aplicacao_w,
			ie_bomba_infusao_w,
			ie_aplic_bolus_w,
			ie_aplic_lenta_w,
			ie_acm_w,
			ds_dose_diferenciada_w,
			qt_solucao_w,
			'N',
			'N',
			coalesce(ie_uso_antimicrobiano_w,'N'),
			cd_protocolo_p,
			nr_sequencia_p,
			nr_seq_material_prot_w,
			'N',
			qt_vel_infusao_w,
			ie_sem_aprazamento_w,
			nr_dia_util_w,
			ie_regra_disp_w,
			ie_lado_w,
			ie_objetivo_w,
			qt_dias_prev_util_w,
			coalesce(qt_min_intervalo_w,qt_min_intervalo_ww),
			ie_checar_adep_w,
			'S',
			DS_JUSTIFICATIVA_w,
			qt_hora_intervalo_w,
			cd_topografia_cih_w,
			nr_receita_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			ie_indicacao_w,
			ie_medicacao_paciente_w,
			ie_dose_espec_agora_w,
			qt_dose_especial_w,
			CASE WHEN ie_dose_espec_agora_p='S' THEN  hr_dose_especial_p  ELSE hr_dose_especial_w END ,
			ie_aplicar_w,
			ds_observacao_far_w,
			ie_fator_correcao_w,
			ie_item_sup_w,
			qt_min_aplic_dose_esp_w,
			cd_unid_med_dose_esp_w,
			CASE WHEN qt_dias_lib_atend_w=0 THEN null  ELSE qt_dias_lib_atend_w END ,
			ds_medic_nao_padrao_p);

			-- OS: 695626 - Igor Rodrigues - 07-03-2014
			CALL Excluir_W_Item_Prescr(cd_protocolo_p, nr_sequencia_p, nr_prescricao_p, nr_seq_material_prot_w, 'M', nm_usuario_p);

			ie_item_sup_w := 'N';

			if (nr_seq_proc_novo_p IS NOT NULL AND nr_seq_proc_novo_p::text <> '') and (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and (ie_agrupador_p = 21) then
				CALL Ajustar_prescr_mat_proc(nr_prescricao_p, nr_seq_proc_novo_p, cd_perfil_w, nr_seq_material_w);
			end if;

			IF (ie_prescr_mat_sem_lib_w = 'S') and (coalesce(ie_protocolo_pre_rep_p,'N') = 'N') THEN
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_material_w,cd_perfil_w,'N',nm_usuario_p,null);
			END IF;

			if (ie_agrupador_w = 8) then
				CALL gerar_elemento_mat_sne( nr_prescricao_p, nr_seq_material_w, 'G', nm_usuario_p);
			end if;

		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		open C02;
		loop
		fetch C02 into
			cd_doenca_cid_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			Select	nextval('prescr_material_cid_seq')
			into STRICT	nr_seq_cid_w
			;

			insert into prescr_material_cid(nr_sequencia,
							cd_doenca_cid,
							nr_prescricao,
							nr_sequencia_medic,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec)
						values (nr_seq_cid_w,
							 cd_doenca_cid_w,
							 nr_prescricao_p,
							 nr_seq_material_w,
							 clock_timestamp(),
							 nm_usuario_p,
							 clock_timestamp(),
							 nm_usuario_p);

		end loop;
		close C02;

		Select	nextval('prescr_material_cid_seq')
		into STRICT	nr_seq_cid_w
		;

		if (cd_doenca_cid_p IS NOT NULL AND cd_doenca_cid_p::text <> '') then
			insert into prescr_material_cid(nr_sequencia,
							cd_doenca_cid,
							nr_prescricao,
							nr_sequencia_medic,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec)
						values (nr_seq_cid_w,
							 cd_doenca_cid_p,
							 nr_prescricao_p,
							 nr_seq_material_w,
							 clock_timestamp(),
							 nm_usuario_p,
							 clock_timestamp(),
							 nm_usuario_p);

		end if;

		if (ie_gerar_kit_w = 'S') then
			CALL Gerar_Kit_Prescricao(cd_estabelecimento_w, nr_prescricao_p, nr_seq_material_w, nm_usuario_p);
		end if;

		select	max(nr_ocorrencia),
			max(nr_agrupamento)
		into STRICT	nr_ocorrencia_w,
			nr_agrup_ww
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_material_w;

		if (ie_agrupador_w = 1) and
			((ie_excDilBolus_w = 'N') or (coalesce(ie_aplic_bolus_w,'N') = 'N')) then

			select	count(*)
			into STRICT	cont_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	<> nr_seq_material_w
			and	ie_agrupador	= 1
			and	nr_agrupamento	= nr_agrup_ww;

			if	((ie_gerar_Dil_composto_w = 'S') or (cont_w = 0)) and (ie_diluicao_recons_w = 'S') then

				CALL Inserir_diluentes_prot(nr_prescricao_p, cd_protocolo_p, nr_sequencia_p,
							nr_seq_material_prot_w, nr_seq_material_w, nm_usuario_p);

				if (ie_diluicao_recons_prot_w = 'S') then
					select	CASE WHEN count(*)=0 THEN 'A'  ELSE 'R' END
					into STRICT	ie_opcao_recons_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p
					and 	nr_sequencia_diluicao = nr_seq_material_w
					and 	ie_agrupador = 3;

					CALL Gerar_Reconst_Diluicao(nr_prescricao_p,nr_seq_material_w, ie_opcao_recons_w);
				end if;
			end if;
			CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_seq_material_w);
		end if;

		nr_erro_w := Consistir_Prescr_Material(nr_prescricao_p, nr_seq_material_w, nm_usuario_p, cd_perfil_w, nr_erro_w); /*Almir em 09/10/2007 OS70754 */
		select	max(nr_ocorrencia)
		into STRICT	nr_ocorrencia_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_material_w;

	end if;
	end;
END LOOP;
CLOSE C01;

if (coalesce(qt_solucao_w,0) = 0) and (VarAplicConformeDose_w = 'S') then
	update	prescr_material a
	set	qt_solucao	= coalesce(qt_solucao, qt_dose)
	where	exists (SELECT	1
		from	prescr_material x
		where	x.nr_prescricao		= a.nr_prescricao
		and	x.nr_sequencia_diluicao	= a.nr_sequencia
		and	x.ie_agrupador		in (3,7,9))
	and	a.nr_prescricao = nr_prescricao_p
	and	a.ie_agrupador = 1;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

if (coalesce(ie_reordenar_w,'S') = 'S')	and (ie_reordenar_medic_p <> 'N') then
	CALL Reordenar_Medicamento(nr_prescricao_p);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_prescr_prot ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_material_p bigint, ie_agrupador_p bigint, nr_seq_dieta_p bigint, nr_seq_proc_p bigint, nr_seq_solucao_p bigint, nr_seq_dieta_novo_p bigint, nr_seq_proc_novo_p bigint, nr_seq_solucao_novo_p bigint, cd_intervalo_p text, qt_protocolo_p bigint, nm_usuario_p text, ie_urgencia_p text, qt_peso_p bigint, hr_prim_horario_p text, qt_dose_p bigint, nr_seq_atendimento_p bigint, ds_justificativa_p text, cd_unidade_medida_p text, ie_gerar_composto_p text, ie_objetivo_p text, qt_dias_solicitado_p bigint, ie_indicacao_p text, cd_doenca_cid_p text, ie_via_aplicacao_p text, cd_topografia_cih_p text, ds_recomendacao_p text, ie_sem_dia_inf_p text, ie_se_necessario_p text, ie_acm_p text, ie_reordenar_medic_p text, cd_microorganismo_cih_p bigint, cd_amostra_cih_p bigint, ie_origem_infeccao_p text, ie_aplic_bolus_p text, ie_dose_espec_agora_p text, qt_dose_especial_p bigint, cd_unidade_medida_dose_edit_p text, hr_dose_especial_p text, qt_min_aplic_dose_esp_p bigint, ds_dose_diferenciada_p text default null, ie_protocolo_pre_rep_p text default null, ds_medic_nao_padrao_p text default null ) IS type campos is record (ds_dias_aplicacao varchar(6)) FROM PUBLIC;

