-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_nota_fiscal (nr_lote_contabil_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, ie_exclusao_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nm_agrupador_w                  varchar(255);
ie_tipo_nota_w                  varchar(1);
cd_tipo_lote_contabil_w         tipo_lote_contabil.cd_tipo_lote_contabil%type;
cd_tipo_lote_contabil_nota_w    tipo_lote_contabil.cd_tipo_lote_contabil%type;
cd_evento_w                     bigint;
cd_estabelecimento_w            estabelecimento.cd_estabelecimento%type;
cd_estab_centro_w               smallint;
nr_sequencia_w                  bigint;
nr_sequencia_movto_w            bigint;
nr_sequencia_movto_ww           bigint;
ie_acao_nf_w                    smallint;
ds_situacao_w                   varchar(80);
nm_atributo_w                   varchar(255);
cd_cgc_w                        nota_fiscal.cd_cgc%type;
ds_razao_social_w               varchar(80);
nr_nota_fiscal_w                varchar(255);
ie_debito_credito_w             varchar(1);
ie_deb_cred_transit_w           varchar(1);
ie_origem_conta_w               varchar(15);
cd_conta_contabil_w             conta_contabil.cd_conta_contabil%type;
cd_centro_custo_w               centro_custo.cd_centro_custo%type;
cd_tributo_nf_w                 integer;
cd_tributo_w                    integer;
cd_material_w                   nota_fiscal_item.cd_material%type;
cd_historico_w                  historico_padrao.cd_historico%type;
ds_compl_historico_w            varchar(255);
ds_compl_historico_ww           varchar(255);
ds_estorno_w                    varchar(80);
nr_item_nf_w                    integer;
ds_comando_w                    varchar(255);
cd_conta_contabil_nf_w          varchar(20);
ds_retorno_w                    varchar(20);
cd_centro_custo_nf_w            integer;
dt_movimento_w                  timestamp;
dt_referencia_w                 timestamp;
dt_referencia_inicial_w         timestamp;
dt_referencia_final_w           timestamp;
vl_retorno_w                    double precision;
ie_analitico_sintetico_w        varchar(1);
ie_ordem_compl_w                varchar(3);
ds_doc_agrupamento_w            varchar(50)    := '';
nr_seq_agrupamento_w            bigint    := 0;
ie_centro_custo_w               varchar(1)     := 'S';
vl_rateio_w                     double precision;
vl_total_rateio_w               double precision;
cd_local_estoque_w              smallint;
vl_documento_desp_w             nota_fiscal_desp_adic.vl_documento%type;
cd_conta_contabil_desp_w        varchar(20);
ds_historico_desp_w             varchar(255);
ds_razao_despesa_w              pessoa_juridica.ds_razao_social%type;
nr_documento_desp_w             nota_fiscal_desp_adic.nr_documento%type;
cd_pessoa_fisica_w              pessoa_fisica.cd_pessoa_fisica%type;
ie_data_contab_nf_w             varchar(03);
ie_data_contab_est_nf_w         varchar(03);
ie_compl_contab_nf_w            varchar(01);
ds_complemento_w                varchar(255);
ds_observacao_item_w            varchar(255);
nm_paciente_w                   varchar(60);
ie_contab_pac_nf_w              varchar(1);
ie_nf_consignado_w              varchar(1);
ie_nf_entrada_saida_w           varchar(1);
ds_observacao_nf_w              varchar(255);
vl_conta_nf_w                   double precision;
cd_conta_ctb_esp_w              varchar(20);
vl_contabil_esp_w               double precision;
dt_vencto_w                     varchar(255);
ie_datas_vencto_w               varchar(1);
ie_compl_hist_w                 varchar(1);
ie_estorno_w                    varchar(20);
ds_conteudo_w                   varchar(4000);
ie_regra_contab_periodo_w       varchar(1);
ie_so_sem_rateio_w              varchar(01);
cd_convenio_w                   bigint;
cd_procedimento_w               bigint;
ie_origem_proced_w              bigint;
ie_corpo_venc_w                 varchar(01);
ie_grupo_contab_nota_w          varchar(10);
ie_situacao_w                   varchar(1);
ds_titulos_pagar_nf_w           varchar(400);
dt_emissao_w                    timestamp;
cd_conta_transitoria_w          varchar(20);
ie_permite_estab_dif_w          varchar(15);
cd_historico_ct_w               bigint;
ie_contab_nf_estorno_w          varchar(1);
ie_contab_nf_estornada_w        varchar(1);
dt_referencia_lote_w            timestamp;
nr_interno_conta_w              nota_fiscal.nr_interno_conta%type;
nr_ordem_compra_w               ordem_compra.nr_ordem_compra%type;
nr_atendimento_w                bigint;
cd_empresa_w                    bigint;
ie_tipo_convenio_w              smallint;
cd_estab_financeiro_w           bigint;
ie_contab_nf_estab_w            varchar(15)    := 'EC';
cd_estab_movto_w                bigint;
ie_tipo_ordem_w                 varchar(15);
cd_estab_destino_w              bigint;
cd_cgc_desp_w                   varchar(14);
nr_nfe_imp_w                    varchar(255);
nm_estabelecimento_w            varchar(255);
cd_centro_custo_evento_w        bigint;
nr_rps_w                        varchar(20);
ie_origem_centro_w              varchar(03);
vl_transf_debito_w              double precision;
vl_transf_credito_w             double precision;
ds_param_sql_w                  varchar(2000);
ie_contab_frete_rateio_w        varchar(1);
ie_tipo_local_estoque_w         varchar(20);
cd_conta_receita_w              varchar(255);
qt_rateio_w                     bigint;
ie_contab_nf_estab_dif_w        varchar(1);
ie_data_movto_lote_nf_w         varchar(15);
ie_contabiliza_rateio_trib_w    evento_contabil_param.ie_contabiliza_rateio_trib%type;

/*gazimmermann 28/12/2011 os 398666*/

qt_item_nf_w                    double precision;
cd_unidade_medida_compra_w      varchar(30);
ds_material_w                   material.ds_material%type;
cd_unidade_medida_estoque_w     varchar(30);
qt_item_estoque_w               double precision;
ds_tributo_w                    varchar(100)   := '';
ie_nf_nfe_w                     varchar(15);
dt_movimento_ww                 timestamp;
dt_vencimento_w                 timestamp;
cd_cgc_emitente_w               pessoa_juridica.cd_cgc%type;
ds_pessoa_nota_fiscal_w         varchar(80);
qt_regra_rateio_w               bigint;
nr_seq_item_rateio_w            nota_fiscal_item_rateio.nr_sequencia%type;
nr_seq_info_ctb_w               informacao_contabil.nr_sequencia%type   := 1;
ie_gerar_w                      varchar(1);
ie_contab_trib_retido_w         parametro_estoque.ie_contab_trib_retido%type;
ds_titulos_receber_nf_w         varchar(254);
nr_solic_compra_w               nota_fiscal_item.nr_solic_compra%type;
nr_seq_motivo_solic_w           solic_compra.nr_seq_motivo_solic%type;
vl_rateio_item_trib_w           fis_rateio_trib_item.vl_rateio%type;
cd_centro_custo_item_trib_w     fis_rateio_trib_item.cd_centro_custo%type;
nr_seq_nf_ref_w                 nota_fiscal.nr_seq_nf_ref%type;
cd_nf_compl_conta_contabil_w    nota_fiscal_item.cd_conta_contabil%type;
cd_nf_compl_sequencia_param nota_fiscal_item.cd_sequencia_parametro%type;
vl_nf_compl_total_item_nf_w     nota_fiscal_item.vl_total_item_nf%type;
vl_nf_compl_mercadoria_w        nota_fiscal.vl_mercadoria%type;
vl_nf_compl_rateio_item_w       double precision;
vl_nf_compl_perc_item_w         double precision;
qt_nf_compl_itens_w             bigint;
qt_nf_compl_contar_itens_w      bigint;
vl_nf_compl_acumulado_w         double precision;
ie_contab_nf_compl_w            parametro_estoque.ie_contab_nf_compl%type;
vl_total_nota_w                 nota_fiscal.vl_mercadoria%type;
cd_historico_nf_compl_w         historico_padrao.cd_historico%type;
nr_seq_nf_ref_compl_w           nota_fiscal.nr_seq_nf_ref%type;
nr_sequencia_ref_w              nota_fiscal.nr_sequencia_ref%type;
qt_item_trib_w                  bigint;
qt_contabilizado_w              bigint;
cd_centro_custo_item_w          nota_fiscal_item.cd_centro_custo%type;
ds_consignado_w                 varchar(15);
ds_operacao_nf_w                operacao_nota.ds_operacao_nf%type;
nr_seq_proj_rec_w               nota_fiscal_item.nr_seq_proj_rec%type;
ds_projeto_recurso_w            projeto_recurso.ds_projeto%type;
ds_atributos_w                  varchar(4000);
nr_documento_w                  w_movimento_contabil.nr_documento%type;
ie_origem_documento_w           w_movimento_contabil.ie_origem_documento%type;
ie_regra_w                      varchar(1);
cd_natureza_operacao_w          nota_fiscal_item.cd_natureza_operacao%type;
ie_intercompany_w               w_movimento_contabil.ie_intercompany%type       :=      'N';
nr_seq_classif_movto_w          evento_contabil_param_estab.nr_seq_classif_movto%type;/* jjob - OS2022780 - Incluindo sequencial da classificacao de movimento */
cd_estab_intercompany_w         estabelecimento.cd_estabelecimento%type;/* jjob - OS 2024096 - Incluindo para inserir novo campo cd_estab_intercompany no movimento */
nr_seq_proc_interno_w           nota_fiscal_item.nr_seq_proc_interno%type;
ie_param_estab_rateio_w         evento_contabil_param.ie_param_estab_rateio%type;
ie_param_estab_w                evento_contabil_param.ie_param_estab%type;
cd_conta_contabil_rat_w         evento_contabil_param_estab.cd_conta_contabil%type;
cd_centro_custo_rat_w           evento_contabil_param_estab.cd_centro_custo%type;
vl_regra_w                      double precision;
cd_sequencia_parametro_w        parametros_conta_contabil.cd_sequencia_parametro%type;
nr_codigo_controle_w            w_movimento_contabil.nr_codigo_controle%type;
nr_seq_nota_orig_w              nota_fiscal.nr_sequencia%type;
nr_nota_orig_w                  nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_orig_w              nota_fiscal.cd_serie_nf%type;
nr_nfe_imp_orig_w               nota_fiscal.nr_nfe_imp%type;
cd_sequencia_parametro_nf_w		nota_fiscal_item.cd_sequencia_parametro%type;

/* cursor para ler as notas a serem contabilizadas      */

c000 CURSOR FOR
        SELECT  o.cd_tipo_lote_contabil,
                o.cd_evento,
                n.nr_sequencia,
                n.ie_acao_nf,
                n.ie_situacao,
                substr(obter_valor_dominio(1056, n.ie_situacao),1,80) ds_situacao,
                n.nr_nota_fiscal,
                n.cd_cgc,
                n.cd_cgc_emitente,
                n.cd_pessoa_fisica,
                obter_convenio_nf(n.nr_sequencia) cd_convenio,
                substr(obter_nome_pf_pj(n.cd_pessoa_fisica, CASE WHEN coalesce(n.cd_pessoa_fisica::text, '') = '' THEN  n.cd_cgc  ELSE null END ),1,80) nm_pessoa,
                CASE WHEN ie_acao_nf=1 THEN                CASE WHEN ie_data_contab_nf_w='ES' THEN    n.dt_entrada_saida WHEN ie_data_contab_nf_w='ATU' THEN   n.dt_atualizacao WHEN ie_data_contab_nf_w='EST' THEN   n.dt_atualizacao_estoque WHEN ie_data_contab_nf_w='OPE' THEN   CASE WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ES' THEN    n.dt_entrada_saida WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ATU' THEN   n.dt_atualizacao WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='EST' THEN   n.dt_atualizacao_estoque  ELSE n.dt_emissao END   ELSE n.dt_emissao END   ELSE CASE WHEN ie_data_contab_est_nf_w='ES' THEN    n.dt_entrada_saida WHEN ie_data_contab_est_nf_w='ATU' THEN   n.dt_atualizacao WHEN ie_data_contab_est_nf_w='EST' THEN   n.dt_atualizacao_estoque WHEN ie_data_contab_est_nf_w='OPE' THEN   CASE WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ES' THEN    n.dt_entrada_saida WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ATU' THEN   n.dt_atualizacao WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='EST' THEN   n.dt_atualizacao_estoque  ELSE n.dt_emissao END   ELSE n.dt_emissao END  END  dt_movimento,
                substr(obter_pessoa_conta(n.nr_interno_conta,'N'),1,60) nm_paciente,
                substr(obter_se_nota_consignada(n.nr_sequencia),1,1) ie_nf_consignado,
                substr(obter_se_nota_entrada_saida(n.nr_sequencia),1,1) ie_nf_entrada_saida,
                substr(n.ds_observacao,1,254) ds_observacao_nf,
                n.nr_interno_conta,
                n.nr_ordem_compra,
                substr('NF' || CASE WHEN coalesce(r.ie_servico,'N')='S' THEN 'S' END  || CASE WHEN coalesce(n.ie_nf_eletronica,'N')='S' THEN 'E' END ,1,15) ie_nf_nfe,
                n.nr_seq_nf_ref,
                n.vl_mercadoria,
                n.nr_sequencia_ref,
                r.ds_operacao_nf,
                r.cd_operacao_nf,
                n.cd_natureza_operacao,
                n.cd_estabelecimento
        from    operacao_estoque        o,
                operacao_nota           r,
                nota_fiscal             n,
                estabelecimento         e
        where   n.cd_operacao_nf                = r.cd_operacao_nf
        and     o.cd_operacao_estoque           = r.cd_operacao_estoque
        and     n.cd_estabelecimento            = e.cd_estabelecimento
        and     e.cd_empresa                    = cd_empresa_w
        and     o.cd_tipo_lote_contabil         = cd_tipo_lote_contabil_w
        and     coalesce(n.nr_lote_contabil,0)       = 0
        and     trunc(CASE WHEN    ie_acao_nf=1 THEN                                 CASE WHEN  ie_data_contab_nf_w='ES' THEN    n.dt_entrada_saida WHEN  ie_data_contab_nf_w='ATU' THEN   n.dt_atualizacao WHEN  ie_data_contab_nf_w='EST' THEN   n.dt_atualizacao_estoque WHEN  ie_data_contab_nf_w='OPE' THEN   CASE WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='ES' THEN    n.dt_entrada_saida WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='ATU' THEN   n.dt_atualizacao WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='EST' THEN   n.dt_atualizacao_estoque  ELSE n.dt_emissao END   ELSE n.dt_emissao END   ELSE CASE WHEN  ie_data_contab_est_nf_w='ES' THEN    n.dt_entrada_saida WHEN  ie_data_contab_est_nf_w='ATU' THEN   n.dt_atualizacao WHEN  ie_data_contab_est_nf_w='EST' THEN   n.dt_atualizacao_estoque WHEN  ie_data_contab_est_nf_w='OPE' THEN   CASE WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ES' THEN    n.dt_entrada_saida WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='ATU' THEN   n.dt_atualizacao WHEN obter_regra_contab_nf_operacao(n.nr_sequencia)='EST' THEN   n.dt_atualizacao_estoque  ELSE n.dt_emissao END   ELSE n.dt_emissao END  END , 'month') = trunc(dt_referencia_w,'month')
        and     CASE WHEN  ie_regra_contab_periodo_w='S' THEN  CASE WHEN    CASE WHEN ie_acao_nf=1 THEN  ie_data_contab_nf_w  ELSE ie_data_contab_est_nf_w END ='ES' THEN    n.dt_entrada_saida WHEN    CASE WHEN ie_acao_nf=1 THEN  ie_data_contab_nf_w  ELSE ie_data_contab_est_nf_w END ='EMI' THEN   n.dt_emissao WHEN    CASE WHEN ie_acao_nf=1 THEN  ie_data_contab_nf_w  ELSE ie_data_contab_est_nf_w END ='ATU' THEN   n.dt_atualizacao WHEN    CASE WHEN ie_acao_nf=1 THEN  ie_data_contab_nf_w  ELSE ie_data_contab_est_nf_w END ='EST' THEN   n.dt_atualizacao_estoque WHEN    CASE WHEN ie_acao_nf=1 THEN  ie_data_contab_nf_w  ELSE ie_data_contab_est_nf_w END ='OPE' THEN   CASE WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='ES' THEN    n.dt_entrada_saida WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='ATU' THEN   n.dt_atualizacao WHEN  obter_regra_contab_nf_operacao(n.nr_sequencia)='EST' THEN   n.dt_atualizacao_estoque  ELSE n.dt_emissao END   ELSE n.dt_atualizacao END   ELSE n.dt_atualizacao END  between dt_referencia_inicial_w and dt_referencia_final_w
        and     (n.dt_atualizacao_estoque IS NOT NULL AND n.dt_atualizacao_estoque::text <> '')
        and     n.ie_situacao   <> '9' /* OS 835191 evitar notas canceladas no lote */
        and     coalesce(ds_retorno_p::text, '') = ''
        and     ((ie_permite_estab_dif_w <> 'N' and ie_contab_nf_estab_dif_w <> 'N') or (n.cd_estabelecimento   = cd_estabelecimento_w))
        and     ie_exclusao_p <> 'S'
        and     ((ie_contab_nf_estornada_w in ('S','E','I')) or (n.ie_situacao <> '3'))
        and     ((ie_contab_nf_estorno_w in ('S','E','I')) or (n.ie_situacao <> '2'))
        and     ((ie_tipo_nota_w = 'A') or (obter_se_nota_entrada_saida(n.nr_sequencia) = ie_tipo_nota_w))
        and     ((ie_grupo_contab_nota_w = 'A') or (substr(obter_subgrupo_contab_nota(n.nr_sequencia),1,10) = ie_grupo_contab_nota_w))
        order by
                obter_nome_pf_pj(n.cd_pessoa_fisica, n.cd_cgc),
                nr_nota_fiscal;

type reg_nota is table of c000%rowtype;
ind             integer := 1;
i               integer := 1;
z               integer := 1;
vetor_nf        reg_nota;
type linhas is table of reg_nota index by integer;
vetor_movimentacao_w    linhas;

/* Contabiliza informacoes da NOTA_FISCAL */

c010 CURSOR FOR
        SELECT  c.nm_atributo,
                c.ie_debito_credito,
                p.ie_origem_conta,
                p.cd_conta_contabil,
                p.cd_centro_custo,
                p.cd_historico,
                e.ie_analitico_sintetico,
                p.nr_seq_classif_movto,
                coalesce(ie_ordem_compl,'NF'),
                coalesce(p.ie_origem_centro,'2') ie_origem_centro
        from    evento_contabil                 e,
                evento_contabil_param           c,
                evento_contabil_param_estab     p
        where   e.cd_tipo_lote_contabil         = cd_tipo_lote_contabil_nota_w
        and     e.cd_evento                     = cd_evento_w
        and     e.cd_tipo_lote_contabil         = c.cd_tipo_lote_contabil
        and     e.cd_evento                     = c.cd_evento
        and     c.cd_tipo_lote_contabil         = p.cd_tipo_lote_contabil
        and     c.cd_evento                     = p.cd_evento
        and     c.nr_sequencia                  = p.nr_sequencia
        and     p.cd_estabelecimento            = cd_estabelecimento_w
        and     c.nm_tabela                     = 'NOTA_FISCAL';

/* Contabiliza informacoes da NOTA_FISCAL_ITEM */

c020 CURSOR FOR
        SELECT  c.nm_atributo,
                c.ie_debito_credito,
                p.ie_origem_conta,
                p.cd_conta_contabil,
                p.cd_centro_custo,
                p.cd_historico,
                coalesce(p.ie_origem_centro,'2') ie_origem_centro,
                i.cd_material,
                i.cd_procedimento,
                i.ie_origem_proced,
                i.nr_item_nf,
                i.cd_conta_contabil,
                i.cd_centro_custo,
                i.cd_local_estoque,
                substr(i.ds_complemento,1,255) ds_complemento,
                i.qt_item_nf,
                i.cd_unidade_medida_compra,
                substr(obter_desc_material(i.cd_material),1,255) ds_material,
                i.cd_unidade_medida_estoque,
                i.qt_item_estoque,
                substr(i.ds_observacao, 1, 255) ds_observacao_item,
                i.nr_solic_compra,
                i.nr_seq_proj_rec,
                i.cd_natureza_operacao,
                p.nr_seq_classif_movto,
                i.nr_seq_proc_interno,
                c.ie_param_estab_rateio,
                coalesce(c.ie_param_estab,'N') ie_param_estab,
				i.cd_sequencia_parametro
        from    evento_contabil_param c,
                evento_contabil_param_estab p,
                nota_fiscal_item i
        where   c.cd_tipo_lote_contabil         = cd_tipo_lote_contabil_nota_w
        and     c.cd_evento                     = cd_evento_w
        and     c.cd_tipo_lote_contabil         = p.cd_tipo_lote_contabil
        and     c.cd_evento                     = p.cd_evento
        and     c.nr_sequencia                  = p.nr_sequencia
        and     p.cd_estabelecimento            = cd_estabelecimento_w
        and     c.nm_tabela                     = 'NOTA_FISCAL_ITEM'
        and     i.nr_sequencia                  = nr_sequencia_w
        and     ((coalesce(c.cd_natureza_operacao::text, '') = '') or (i.cd_natureza_operacao = c.cd_natureza_operacao))
        and     ((c.ie_so_sem_rateio = 'N') or
                not exists (SELECT 1
                                from    nota_fiscal_item_rateio r
                                where   r.nr_seq_nota   = i.nr_sequencia
                                and     r.nr_item_nf    = i.nr_item_nf))
        order by
                i.nr_item_nf,
                c.nm_atributo;

/* Contabiliza informacoes da NOTA_FISCAL_ITEM_TRIB */

c030 CURSOR FOR
        SELECT  c.nm_atributo,
                c.ie_debito_credito,
                p.ie_origem_conta,
                p.cd_conta_contabil,
                p.cd_centro_custo,
                p.cd_historico,
                coalesce(p.ie_origem_centro,'2') ie_origem_centro,
                t.nr_item_nf,
                i.cd_conta_contabil,
                i.cd_centro_custo,
                i.cd_material,
                i.cd_local_estoque,
                i.cd_procedimento,
                i.ie_origem_proced,
                t.cd_tributo,
                c.ie_contabiliza_rateio_trib,
                i.cd_natureza_operacao,
                p.nr_seq_classif_movto,
                i.nr_seq_proj_rec,
				i.cd_sequencia_parametro
        from    evento_contabil_param           c,
                evento_contabil_param_estab     p,
                nota_fiscal_item                i,
                nota_fiscal_item_trib           t
        where   c.cd_tipo_lote_contabil         = cd_tipo_lote_contabil_nota_w
        and     c.cd_evento                     = cd_evento_w
        and     c.cd_tipo_lote_contabil         = p.cd_tipo_lote_contabil
        and     c.cd_evento                     = p.cd_evento
        and     c.nr_sequencia                  = p.nr_sequencia
        and     p.cd_estabelecimento            = cd_estabelecimento_w
        and     c.nm_tabela                     = 'NOTA_FISCAL_ITEM_TRIB'
        and     t.nr_sequencia                  = nr_sequencia_w
        and     i.nr_sequencia                  = t.nr_sequencia
        and     i.nr_item_nf                    = t.nr_item_nf
        and     t.cd_tributo                    = c.cd_tributo
        and     ((c.ie_so_sem_rateio = 'N') or
                not exists (SELECT 1
                                from    nota_fiscal_item_rateio r
                                where   r.nr_seq_nota   = i.nr_sequencia
                                and     r.nr_item_nf    = i.nr_item_nf));

/* Contabiliza informacoes da NOTA_FISCAL_TRIB e/ou NOTA_FISCAL_VENC_TRIB */

c040 CURSOR FOR
        SELECT  c.nm_atributo,
                c.ie_debito_credito,
                p.ie_origem_conta,
                p.cd_conta_contabil,
                p.cd_centro_custo,
                p.cd_historico,
                t.cd_tributo,
                'C',
                coalesce(p.ie_origem_centro,'2') ie_origem_centro,
                null dt_vencimento,
                p.nr_seq_classif_movto
        from    evento_contabil_param           c,
                evento_contabil_param_estab     p,
                nota_fiscal_trib                t
        where   c.cd_tipo_lote_contabil = cd_tipo_lote_contabil_nota_w
        and     c.cd_evento             = cd_evento_w
        and     c.cd_tipo_lote_contabil = p.cd_tipo_lote_contabil
        and     c.cd_evento             = p.cd_evento
        and     c.nr_sequencia          = p.nr_sequencia
        and     p.cd_estabelecimento    = cd_estabelecimento_w
        and     c.nm_tabela             = 'NOTA_FISCAL_TRIB'
        and     t.nr_sequencia          = nr_sequencia_w
        and     t.cd_tributo            = c.cd_tributo
        and     (((ie_contab_trib_retido_w = 'S') and (coalesce(t.ie_retencao,'D')   <> 'N')) or (ie_contab_trib_retido_w = 'N'))

union all

        SELECT  c.nm_atributo,
                c.ie_debito_credito,
                p.ie_origem_conta,
                p.cd_conta_contabil,
                p.cd_centro_custo,
                p.cd_historico,
                t.cd_tributo,
                'V',
                coalesce(p.ie_origem_centro,'2') ie_origem_centro,
                t.dt_vencimento,
                p.nr_seq_classif_movto
        from    evento_contabil_param           c,
                evento_contabil_param_estab     p,
                nota_fiscal_venc_trib           t
        where   c.cd_tipo_lote_contabil = cd_tipo_lote_contabil_nota_w
        and     c.cd_evento             = cd_evento_w
        and     c.cd_tipo_lote_contabil = p.cd_tipo_lote_contabil
        and     c.cd_evento             = p.cd_evento
        and     c.nr_sequencia          = p.nr_sequencia
        and     p.cd_estabelecimento    = cd_estabelecimento_w
        and     c.nm_tabela             = 'NOTA_FISCAL_VENC_TRIB'
        and     t.nr_sequencia          = nr_sequencia_w
        and     t.cd_tributo            = c.cd_tributo;


/* cursor para ler os rateios do item da nota a ser contabilizada */

c050 CURSOR FOR
        SELECT  coalesce(cd_conta_contabil,cd_conta_contabil_w),
                coalesce(cd_centro_custo,cd_centro_custo_w),
                (coalesce(vl_rateio,0) + coalesce(vl_frete,0) + coalesce(vl_seguro,0) + coalesce(vl_despesa_acessoria,0) - coalesce(vl_desconto,0) + coalesce(vl_tributo,0))
        from    nota_fiscal_item_rateio r
        where   nr_seq_nota             = nr_sequencia_w
        and     nr_item_nf              = nr_item_nf_w
        and     ie_tipo_local_estoque_w <> '8'

union all

        SELECT  coalesce(cd_conta_contabil,cd_conta_contabil_w),
                coalesce(cd_centro_custo,cd_centro_custo_w),
                (coalesce(vl_rateio,0) + coalesce(CASE WHEN ie_contab_frete_rateio_w='S' THEN vl_frete  ELSE 0 END ,0) + coalesce(vl_seguro,0) + coalesce(vl_despesa_acessoria,0) - coalesce(vl_desconto,0) + coalesce(vl_tributo,0))
        from    nota_fiscal_item_rateio r
        where   nr_seq_nota             = nr_sequencia_w
        and     nr_item_nf              = nr_item_nf_w
        and     ie_tipo_local_estoque_w = '8';

/* fabio 05/07/2004 - cursor para buscar as despesas adicionais */

c060 CURSOR FOR
        SELECT  a.vl_documento,
                a.nr_documento,
                b.cd_conta_contabil,
                b.ds_razao_social,
                b.cd_cgc
        from    nota_fiscal             c,
                pessoa_juridica         b,
                nota_fiscal_desp_adic   a
        where   a.nr_seq_nf             = c.nr_sequencia
        and     a.nr_seq_nf             = nr_sequencia_w
        and     c.nr_lote_contabil      = nr_lote_contabil_p
        and     a.cd_cgc = b.cd_cgc;

/* marcus 27/07/2006 - cursor para buscar as contas contabeis especiais digitadas na nota fiscal */

c070 CURSOR FOR
        SELECT  cd_conta_contabil,
                vl_contabil
        from    nota_fiscal_conta
        where   nr_seq_nf       = nr_sequencia_w;

/* Cursor para buscar o rateio dos demais campos fora o VL_TOTAL_ITEM_NF */

c080 CURSOR FOR
        SELECT  a.nr_sequencia,
                coalesce(a.cd_conta_contabil, cd_conta_contabil_w) cd_conta_contabil,
                coalesce(a.cd_centro_custo, cd_centro_custo_w) cd_centro_custo,
                a.vl_rateio,
                b.nm_atributo,
                b.ie_debito_credito,
                b.ie_param_estab_rateio,
                c.ie_origem_conta,
                c.cd_conta_contabil,
                c.cd_centro_custo,
                c.cd_historico,
                coalesce(c.ie_origem_centro,'2') ie_origem_centro,
                c.nr_seq_classif_movto
        FROM nota_fiscal_item_rateio a, evento_contabil_param b
LEFT OUTER JOIN evento_contabil_param_estab c ON (b.cd_tipo_lote_contabil = c.cd_tipo_lote_contabil AND b.cd_evento = c.cd_evento AND b.nr_sequencia = c.nr_sequencia)
WHERE a.nr_seq_nota           = nr_sequencia_w and a.nr_item_nf            = nr_item_nf_w and b.cd_tipo_lote_contabil = cd_tipo_lote_contabil_nota_w and b.cd_evento             = cd_evento_w    and b.nm_tabela             = 'NOTA_FISCAL_ITEM_RATEIO' and c.cd_estabelecimento    = cd_estabelecimento_w and not exists (     SELECT  1
                                from    w_movimento_contabil y
                                where   y.nr_lote_contabil      = nr_lote_contabil_p
                                and     y.nr_seq_tab_orig       = a.nr_seq_nota
                                and     y.nr_seq_tab_compl      = a.nr_sequencia
                                and     y.nm_tabela             = 'NOTA_FISCAL_ITEM_RATEIO'
                                and     y.nm_atributo           = substr(b.nm_atributo,1,50));

c090 CURSOR FOR
        SELECT  cd_centro_custo,
                vl_rateio
        from    fis_rateio_trib_item
        where   nr_seq_nota_fiscal = nr_sequencia_w
        and     nr_item_nf = nr_item_nf_w
        and     cd_tributo = cd_tributo_w;

c100 CURSOR FOR
SELECT  a.cd_material,
        a.cd_conta_contabil,
        a.vl_total_item_nf,
        b.vl_mercadoria,
        coalesce(a.cd_centro_custo, cd_centro_custo_w) cd_centro_custo,
        a.nr_seq_proj_rec,
		a.cd_sequencia_parametro
from    nota_fiscal_item a,
                nota_fiscal b
where   a.nr_sequencia = nr_seq_nf_ref_compl_w
and     a.nr_sequencia = b.nr_sequencia;

BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w not in (51,2)) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
ds_retorno_p            := null;

/* identifica o estabelecimento do lote contabil */

select  cd_estabelecimento,
        dt_referencia,
        cd_tipo_lote_contabil
into STRICT    cd_estabelecimento_w,
        dt_referencia_lote_w,
        cd_tipo_lote_contabil_w
from    lote_contabil
where   nr_lote_contabil = nr_lote_contabil_p;


select  max(nm_fantasia_estab)
into STRICT    nm_estabelecimento_w
from    estabelecimento
where   cd_estabelecimento      = cd_estabelecimento_w;

cd_empresa_w    := obter_empresa_estab(cd_estabelecimento_w);

select  obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil_w)
into STRICT    ie_compl_hist_w
;

select  max(cd_estab_financeiro)
into STRICT    cd_estab_financeiro_w
from    estabelecimento
where   cd_estabelecimento      = cd_estabelecimento_w;

/* obter regra para definicao da data de contabilizacao */

select  ie_data_contab_nf,
        ie_data_contab_est_nf,
        ie_compl_contab_nf,
        ie_contab_pac_nf,
        ie_contab_vencto_nf,
        ie_regra_contab_periodo,
        coalesce(ie_contab_nf_estornada,'S'),
        coalesce(ie_contab_nf_estorno,'S'),
        coalesce(ie_contab_nf_estab,'EC'),
        coalesce(ie_contab_frete_rateio_dir,'S'),
        coalesce(ie_data_movto_lote_nf,''),
        coalesce(ie_contab_nf_estab_dif,'N'),
        coalesce(ie_contab_trib_retido,'N'),
        coalesce(ie_contab_nf_compl, 'N')
into STRICT    ie_data_contab_nf_w,
        ie_data_contab_est_nf_w,
        ie_compl_contab_nf_w,
        ie_contab_pac_nf_w,
        ie_datas_vencto_w,
        ie_regra_contab_periodo_w,
        ie_contab_nf_estornada_w,
        ie_contab_nf_estorno_w,
        ie_contab_nf_estab_w,
        ie_contab_frete_rateio_w,
        ie_data_movto_lote_nf_w,
        ie_contab_nf_estab_dif_w,
        ie_contab_trib_retido_w,
        ie_contab_nf_compl_w
from    parametro_estoque
where   cd_estabelecimento      = cd_estabelecimento_w;

/* identifica a data inicial a ser selecionada  */

select  max(dt_parametro)
into STRICT    dt_referencia_inicial_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 1;

/* identifica a data final a ser selecionada  */

select  max(dt_parametro)
into STRICT    dt_referencia_final_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 2;

if (dt_referencia_final_w < dt_referencia_inicial_w) then
        --'A data parametro inicial e maior que a data parametro final!'
        CALL wheb_mensagem_pck.exibir_mensagem_abort(191960);
end if;

/* identifica a data de referencia (dt_entrada_saida) a ser selecionada  */

select  max(dt_parametro)
into STRICT    dt_referencia_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 3;

/*Maicon Eduardo Prange 20/11/2017 OS 1539449*/

if      ((trunc(dt_referencia_inicial_w, 'mm') <> trunc(dt_referencia_final_w, 'mm')) and (trunc(dt_referencia_w, 'mm') <> trunc(dt_referencia_inicial_w, 'mm'))) then
        --'data inicial e  data final para a geracao do lote tem que ser iguais a dt_referencia_w'
        CALL wheb_mensagem_pck.exibir_mensagem_abort(991533);
end if;
/*//Maicon Eduardo Prange 20/11/2017 OS 1539449*/

if (trunc(dt_referencia_lote_w,'mm') <> trunc(dt_referencia_w,'mm')) then
        --'A data do lote contabil e diferente da data definida nos parametros'
        CALL wheb_mensagem_pck.exibir_mensagem_abort(191962);
end if;

/* identifica o tipo de nota a ser considerada no lote (e=entrada; s=saida; a=ambos*/

select  coalesce(max(ds_valor_parametro),'A')
into STRICT    ie_tipo_nota_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 4;

/*Lote de Notas fiscais de saida 51*/

if (cd_tipo_lote_contabil_w = 51) and (ie_tipo_nota_w <> 'S') then
        ie_tipo_nota_w  := 'S';
end if;

/* identifica o tipo do grupo de contabilizacao para as notas*/

select  coalesce(max(ds_valor_parametro),'A')
into STRICT    ie_grupo_contab_nota_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 5;

if (coalesce(dt_referencia_w::text, '') = '') or (coalesce(dt_referencia_inicial_w::text, '') = '') or (coalesce(dt_referencia_final_w::text, '') = '') then
        ds_retorno_p    := wheb_mensagem_pck.get_texto(795511);
end if;

/*obter dados para contabilizacao transitoria */

SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;

if (ie_exclusao_p = 'S') and (coalesce(ds_retorno_p::text, '') = '') then
        CALL ctb_regras_contabil.comprovante_cache_storage(nr_lote_contabil_p, nm_usuario_p);
        delete  from movimento_contabil
        where   nr_lote_contabil = nr_lote_contabil_p;

        update  nota_fiscal
        set     nr_lote_contabil = 0
        where   nr_lote_contabil = nr_lote_contabil_p;
end if;

-- Obter_Valor_Dinamico('Truncate Table W_Movimento_Contabil', vl_retorno_w);
delete  FROM w_movimento_contabil
where   nr_lote_contabil = nr_lote_contabil_p;

nr_sequencia_movto_w           := 0;

ind             := 0;
ie_gerar_w      := 'S';

open c000;
loop
fetch c000 bulk collect into vetor_nf limit 1000;
        ind                             := ind + 1;
        vetor_movimentacao_w(ind)       := vetor_nf;

EXIT WHEN NOT FOUND; /* apply on c000 */
end loop;
close c000;

for i in 1..vetor_movimentacao_w.count loop
        vetor_nf        := vetor_movimentacao_w(i);
        for z in 1..vetor_nf.count loop
                ie_gerar_w      := 'S';
                /*Nota estornada */

                if (vetor_nf[z].ie_situacao = '3') then
                        if (ie_contab_nf_estornada_w = 'E') and (vetor_nf[z].ie_nf_entrada_saida        = 'S') then
                                ie_gerar_w      := 'N';
                        elsif (ie_contab_nf_estornada_w = 'I') and (vetor_nf[z].ie_nf_entrada_saida        = 'E') then
                                ie_gerar_w      := 'N';
                        end if;
                end if;

                if (vetor_nf[z].ie_situacao = '2') then
                        if (ie_contab_nf_estorno_w = 'E') and (vetor_nf[z].ie_nf_entrada_saida        = 'S') then
                                ie_gerar_w      := 'N';
                        elsif (ie_contab_nf_estorno_w = 'I') and (vetor_nf[z].ie_nf_entrada_saida        = 'E') then
                                ie_gerar_w      := 'N';
                        end if;
                end if;

                if (ie_gerar_w = 'S') then
                        ie_nf_nfe_w                     := vetor_nf[z].ie_nf_nfe;
                        cd_tipo_lote_contabil_nota_w    := vetor_nf[z].cd_tipo_lote_contabil;
                        cd_evento_w                     := vetor_nf[z].cd_evento;
                        nr_sequencia_w                  := vetor_nf[z].nr_sequencia;
                        ie_acao_nf_w                    := vetor_nf[z].ie_acao_nf;
                        ie_situacao_w                   := vetor_nf[z].ie_situacao;
                        ds_situacao_w                   := vetor_nf[z].ds_situacao;
                        nr_nota_fiscal_w                := vetor_nf[z].nr_nota_fiscal;
                        cd_cgc_w                        := vetor_nf[z].cd_cgc;
                        cd_cgc_emitente_w               := vetor_nf[z].cd_cgc_emitente;
                        cd_pessoa_fisica_w              := vetor_nf[z].cd_pessoa_fisica;
                        cd_convenio_w                   := vetor_nf[z].cd_convenio;
                        ds_razao_social_w               := vetor_nf[z].nm_pessoa;
                        dt_movimento_w                  := vetor_nf[z].dt_movimento;
                        nm_paciente_w                   := vetor_nf[z].nm_paciente;
                        ie_nf_consignado_w              := vetor_nf[z].ie_nf_consignado;
                        ie_nf_entrada_saida_w           := vetor_nf[z].ie_nf_entrada_saida;
                        ds_observacao_nf_w              := vetor_nf[z].ds_observacao_nf;
                        nr_interno_conta_w              := vetor_nf[z].nr_interno_conta;
                        nr_ordem_compra_w               := vetor_nf[z].nr_ordem_compra;
                        nr_seq_nf_ref_w                 := vetor_nf[z].nr_seq_nf_ref;
                        vl_total_nota_w                 := vetor_nf[z].vl_mercadoria;
                        nr_sequencia_ref_w              := vetor_nf[z].nr_sequencia_ref;
                        ds_operacao_nf_w                := vetor_nf[z].ds_operacao_nf;
                        nr_seq_agrupamento_w            := nr_sequencia_w;
                        ie_intercompany_w               := holding_pck.get_se_intercompany_cnpj(vetor_nf[z].cd_estabelecimento, vetor_nf[z].cd_cgc_emitente);

                        begin
                            select a.nr_sequencia,
                                a.nr_nota_fiscal,
                                a.cd_serie_nf,
                                a.nr_nfe_imp
                            into STRICT nr_seq_nota_orig_w,
                                nr_nota_orig_w,
                                cd_serie_nf_orig_w,
                                nr_nfe_imp_orig_w
                            from nota_fiscal   a,
                                 nf_credito    b
                            where a.nr_sequencia = b.nr_seq_nf_orig
                            and b.nr_seq_nf_gerada = nr_sequencia_w;
                        exception
                            when no_data_found then
                                nr_seq_nota_orig_w := null;
                                nr_nfe_imp_orig_w := null;
                                cd_serie_nf_orig_w := null;
                                nr_nota_orig_w := null;
                            when too_many_rows then 
                                nr_seq_nota_orig_w := null;
                                nr_nfe_imp_orig_w := null;
                                cd_serie_nf_orig_w := null;
                                nr_nota_orig_w := null;
                        end;

                        if (ie_nf_entrada_saida_w = 'E') then
                                ds_pessoa_nota_fiscal_w := substr(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_emitente_w),1,80);
                        else
                                ds_pessoa_nota_fiscal_w := substr(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w),1,80);
                        end if;

                        if (ie_intercompany_w = 'S') then
                                cd_estab_intercompany_w := holding_pck.get_estab_intercompany(vetor_nf[z].cd_cgc_emitente);
                        else
                                cd_estab_intercompany_w := null;
                        end if;

                        cd_estab_destino_w              := null;
                        ie_tipo_ordem_w                 := '';
                        ie_estorno_w                    := '';
                        ds_estorno_w                    := '';
                        vl_transf_debito_w              := 0;
                        vl_transf_credito_w             := 0;
                        ds_material_w                   := '';
                        cd_unidade_medida_compra_w      := '';
                        cd_unidade_medida_estoque_w     := '';
                        qt_item_nf_w                    := null;
                        qt_item_estoque_w               := null;
                        ds_consignado_w                 := '';

                        if (ie_data_movto_lote_nf_w IS NOT NULL AND ie_data_movto_lote_nf_w::text <> '') then
                                select  max(CASE WHEN      ie_data_movto_lote_nf_w='ATU' THEN  a.dt_atualizacao WHEN      ie_data_movto_lote_nf_w='EMI' THEN  a.dt_emissao WHEN      ie_data_movto_lote_nf_w='ENS' THEN  a.dt_entrada_saida WHEN      ie_data_movto_lote_nf_w='EST' THEN  a.dt_atualizacao_estoque END )
                                into STRICT    dt_movimento_ww
                                from    nota_fiscal a
                                where   a.nr_sequencia  = nr_sequencia_w;

                                dt_movimento_w  := coalesce(dt_movimento_ww,dt_movimento_w);
                        end if;

                        dt_movimento_w  := trunc(dt_movimento_w,'dd');

                        if (ie_acao_nf_w = '2') then
                                ie_estorno_w    := wheb_mensagem_pck.get_texto(728461);
                        elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                ie_estorno_w    := wheb_mensagem_pck.get_texto(795499);
                        end if;

                        /* os 106636 matheus - descricao somente se nota nao for ativa*/

                        if (ie_situacao_w <> '1') then
                                ds_estorno_w    := ds_situacao_w;
                        end if;

                        select  coalesce(nm_paciente_w,substr(obter_pessoa_atendimento(a.nr_atendimento,'N'),1,20))
                        into STRICT    nm_paciente_w
                        from (SELECT max(nr_atendimento) nr_atendimento
                                from    nota_fiscal_item
                                where   nr_sequencia    = nr_sequencia_w) a;

                        select  max(nr_atendimento) nr_atendimento
                        into STRICT    nr_atendimento_w
                        from    nota_fiscal_item
                        where   nr_sequencia     = nr_sequencia_w;
                        begin
                        ds_titulos_pagar_nf_w   := substr(obter_titulos_pagar_nf(nr_sequencia_w, ','),1,400);
                        exception when others then
                                ds_titulos_pagar_nf_w   := '';
                        end;

                        begin
                        ds_titulos_receber_nf_w := substr(obter_titulos_nf(nr_sequencia_w, ','),1,254);
                        ds_titulos_receber_nf_w := substr(ds_titulos_receber_nf_w,1,length(ds_titulos_receber_nf_w)-1);
                        exception when others then
                                ds_titulos_receber_nf_w := '';
                        end;

                        if (coalesce(ie_nf_consignado_w, 'N') = 'S') then
                                ds_consignado_w := wheb_mensagem_pck.get_texto(795507);
                        end if;

                        select  coalesce(sum(vl_contabil),0)
                        into STRICT    vl_conta_nf_w
                        from    nota_fiscal_conta
                        where   nr_seq_nf               = nr_sequencia_w;

                        select  max(dt_emissao),
                                substr(max(nr_nfe_imp),1,255),
                                coalesce(max(nr_rps),'')
                        into STRICT    dt_emissao_w,
                                nr_nfe_imp_w,
                                nr_rps_w
                        from    nota_fiscal
                        where   nr_sequencia    = nr_sequencia_w;

                        /* os  174324 alan soares carneiro - numero do atendimento da ordem de compra da nota fiscal */

                        if (coalesce(nr_ordem_compra_w, 0) <> 0) then
                                nr_atendimento_w        := substr(obter_dados_ordem_compra(nr_ordem_compra_w, 'NA'),1,255);

                                select  coalesce(max(ie_tipo_ordem),''),
                                        max(cd_estabelecimento)
                                into STRICT    ie_tipo_ordem_w,
                                        cd_estab_destino_w
                                from    ordem_compra
                                where   nr_ordem_compra = nr_ordem_compra_w;
                        end if;

                        if (coalesce(cd_convenio_w, 0) <> 0) then
                                ie_tipo_convenio_w      := obter_tipo_convenio(cd_convenio_w);
                        end if;

                        if (ie_contab_nf_estab_dif_w = 'S') then
                                select  max(nm_fantasia_estab)
                                into STRICT    nm_estabelecimento_w
                                from    estabelecimento e,
                                        nota_fiscal     n
                                where   n.cd_estabelecimento    = e.cd_estabelecimento
                                and     n.nr_sequencia          = nr_sequencia_w;
                        end if;
                        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(2)),'NR_SEQ_NOTA');
                        qt_nf_compl_contar_itens_w := 0;

                        /* ************************************************************************************************
                        INICIO Obter numero de documento para o lote de notas fiscais
                        ************************************************************************************************ */
                        nr_documento_w := null;
                        ds_atributos_w  :=      'NR_SEQ_NOTA_FISCAL=' || nr_sequencia_w || ';' ||
                                                'NR_NFE_IMP=' || nr_nfe_imp_w;

                        /*
                        IE_ORIGEM_DOCUMENTO_W nos inserts foi mantido fixo 1
                        */
                        ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                '',
                                                'VR',
                                                dt_movimento_w,
                                                null,
                                                null,
                                                ds_atributos_w,
                                                nm_usuario_p,
                                                ie_regra_w,
                                                nr_documento_w,
                                                ie_origem_documento_w);

                        if (coalesce(nr_documento_w,'X') = 'X') then
                                nr_documento_w := nr_sequencia_w;
                        end if;
                        /* ************************************************************************************************
                        FIM Obter numero de documento para o lote de notas fiscais
                        ************************************************************************************************ */
                        if (ie_contab_nf_compl_w = 'S') then
                                select  max(b.cd_historico)
                                into STRICT    cd_historico_nf_compl_w
                                from    evento_contabil_param a,
                                        evento_contabil_param_estab b
                                where   a.nr_sequencia = b.nr_sequencia
                                and     a.cd_tipo_lote_contabil = b.cd_tipo_lote_contabil
                                and     a.cd_evento             = b.cd_evento
                                and     a.cd_evento             = cd_evento_w
                                and     a.cd_tipo_lote_contabil = cd_tipo_lote_contabil_nota_w
                                and     b.cd_estabelecimento    = cd_estabelecimento_w
                                and     a.nm_tabela             = 'NOTA_FISCAL_ITEM'
                                and     a.nm_atributo like '%VL_TOTAL_ITEM_NF%';

                                nr_seq_nf_ref_compl_w:= nr_seq_nf_ref_w;

                                if (ie_acao_nf_w = '2') then
                                        select  max(nr_seq_nf_ref)
                                        into STRICT    nr_seq_nf_ref_compl_w
                                        from    nota_fiscal
                                        where   nr_sequencia = nr_sequencia_ref_w;
                                end if;

                                select  count(a.nr_sequencia)
                                into STRICT    qt_nf_compl_itens_w
                                from    nota_fiscal_item a,
                                        nota_fiscal b
                                where   a.nr_sequencia = nr_seq_nf_ref_compl_w
                                and     a.nr_sequencia = b.nr_sequencia;

                                vl_nf_compl_acumulado_w := 0;

                                open c100;
                                loop
                                fetch c100 into
                                        cd_material_w,
                                        cd_nf_compl_conta_contabil_w,
                                        vl_nf_compl_total_item_nf_w,
                                        vl_nf_compl_mercadoria_w,
                                        cd_centro_custo_item_w,
                                        nr_seq_proj_rec_w,
										cd_nf_compl_sequencia_param;
                                EXIT WHEN NOT FOUND; /* apply on c100 */
                                        qt_nf_compl_contar_itens_w      :=  qt_nf_compl_contar_itens_w + 1;
                                        vl_nf_compl_perc_item_w         := 0;
                                        vl_nf_compl_rateio_item_w       := 0;

                                        if ( qt_nf_compl_itens_w > qt_nf_compl_contar_itens_w ) then

                                                vl_nf_compl_perc_item_w := round(( vl_nf_compl_total_item_nf_w * 100) / vl_nf_compl_mercadoria_w, 2);
                                                vl_nf_compl_rateio_item_w := round(( vl_total_nota_w * vl_nf_compl_perc_item_w ) / 100, 2);
                                                vl_nf_compl_acumulado_w := vl_nf_compl_acumulado_w + vl_nf_compl_rateio_item_w;
                                        else

                                                vl_nf_compl_rateio_item_w := vl_total_nota_w - vl_nf_compl_acumulado_w;
                                        end if;

                                        if (ie_compl_hist_w = 'S') then

                                                ds_material_w   := obter_desc_material(cd_material_w);
                                                dt_vencto_w     := null;

                                                ds_conteudo_w   := substr(      nr_nota_fiscal_w                        || '#@' ||
                                                                                ds_razao_social_w                       || '#@' ||
                                                                                to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                                nm_paciente_w                           || '#@' ||
                                                                                nr_sequencia_w                          || '#@' ||
                                                                                dt_vencto_w                             || '#@' ||
                                                                                ds_observacao_nf_w                      || '#@' ||
                                                                                                                          ' #@' ||
                                                                                ie_estorno_w                            || '#@' ||
                                                                                                                          ' #@' ||
                                                                                ds_situacao_w                           || '#@' ||
                                                                                substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                                ds_estorno_w                            || '#@' ||
                                                                                to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                                nr_atendimento_w                        || '#@' ||
                                                                                nr_interno_conta_w                      || '#@' ||
                                                                                nr_nfe_imp_w                            || '#@' ||
                                                                                nm_estabelecimento_w                    || '#@' ||
                                                                                nr_rps_w                                || '#@' ||
                                                                                ds_material_w                           || '#@' ||
                                                                                cd_unidade_medida_compra_w              || '#@' ||
                                                                                cd_unidade_medida_estoque_w             || '#@' ||
                                                                                qt_item_nf_w                            || '#@' ||
                                                                                qt_item_estoque_w                       || '#@' ||
                                                                                nr_sequencia_movto_w                    || '#@' ||
                                                                                ds_tributo_w                            || '#@' ||
                                                                                nr_ordem_compra_w                       || '#@' ||
                                                                                ie_nf_nfe_w                             || '#@' ||
                                                                                null                                    || '#@' ||
                                                                                ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                                ds_titulos_receber_nf_w                 || '#@' ||
                                                                                cd_cgc_w                                || '#@' ||
                                                                                cd_pessoa_fisica_w                      || '#@' ||
                                                                                ds_consignado_w                         || '#@' ||
                                                                                ds_operacao_nf_w                        || '#@' ||
                                                                                null                                    || '#@' ||
                                                                                null                                    || '#@' ||
                                                                                nr_seq_nota_orig_w                      || '#@' ||
                                                                                nr_nota_orig_w                          || '#@' ||
                                                                                cd_serie_nf_orig_w                      || '#@' ||
                                                                                nr_nfe_imp_orig_w,1,4000);


                                                select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_nf_compl_w, ds_conteudo_w)
                                                into STRICT    ds_compl_historico_ww
;

                                                if (ie_acao_nf_w = '2') then
                                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(728461) ||' ',1,255);

                                                        if (ie_debito_credito_w = 'D') then
                                                                ie_debito_credito_w     := 'C';
                                                        else
                                                                ie_debito_credito_w     := 'D';
                                                        end if;
                                                elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795499) || ' ',1,255);
                                                end if;
                                        end if;
                                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                        nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;

                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                nr_seq_trans_fin,
                                                cd_cgc,
                                                cd_pessoa_fisica,
                                                nr_documento,
                                                ie_transitorio,
                                                ie_origem_documento,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nm_tabela,
                                                nm_atributo,
                                                nr_seq_info,
                                                ie_intercompany,
                                                cd_estab_intercompany,
                                                cd_sequencia_parametro,
                                                nr_codigo_controle,
                                                nr_seq_proj_rec
                                                )
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_movto_w,
                                                cd_nf_compl_conta_contabil_w,
                                                CASE WHEN ie_acao_nf_w=2 THEN  'C'  ELSE 'D' END ,
                                                cd_historico_nf_compl_w,
                                                dt_movimento_w,
                                                vl_nf_compl_rateio_item_w,
                                                cd_centro_custo_item_w,
                                                ds_compl_historico_w,
                                                ds_doc_agrupamento_w,
                                                nr_seq_agrupamento_w,
                                                null,
                                                cd_cgc_w,
                                                cd_pessoa_fisica_w,
                                                nr_documento_w,
                                                'N',
                                                1,
                                                nr_sequencia_w,
                                                null,
                                                'NOTA_FISCAL_ITEM',
                                                'VL_ITEM_NF_REF',
                                                nr_seq_info_ctb_w,
                                                ie_intercompany_w,
                                                cd_estab_intercompany_w,
                                                cd_nf_compl_sequencia_param,
                                                nr_codigo_controle_w,
                                                nr_seq_proj_rec_w
                                                );

                                        ds_compl_historico_w := '';
                                end loop;
                                close c100;
                        end if;
                        open c010;
                        loop
                        fetch c010 into
                                nm_atributo_w,
                                ie_debito_credito_w,
                                ie_origem_conta_w,
                                cd_conta_contabil_w,
                                cd_centro_custo_w,
                                cd_historico_w,
                                ie_analitico_sintetico_w,
                                nr_seq_classif_movto_w,
                                ie_ordem_compl_w,
                                ie_origem_centro_w;
                        EXIT WHEN NOT FOUND; /* apply on c010 */
                                cd_centro_custo_evento_w                := null;
                                cd_sequencia_parametro_w                := null;

                                if (ie_origem_centro_w = '1') then
                                        cd_centro_custo_evento_w        := cd_centro_custo_w;
                                end if;
                                if (vl_conta_nf_w = 0) and (ie_origem_conta_w <> '10') then
                                        SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, null, null, null, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, 'NF: ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w || ' ' || wheb_mensagem_pck.get_texto(795500) || ' ' || nm_atributo_w, dt_movimento_w, null, null, vetor_nf[z].cd_operacao_nf, vetor_nf[z].cd_natureza_operacao) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();

                                elsif (ie_origem_conta_w = '10') then
                                        select  obter_conta_transf_est_pj(      cd_empresa_w,
                                                                                cd_estabelecimento_w,
                                                                                CASE WHEN ie_nf_entrada_saida_w='E' THEN cd_estab_destino_w WHEN ie_nf_entrada_saida_w='S' THEN  cd_estabelecimento_w END ,
                                                                                cd_cgc_w,
                                                                                dt_movimento_w)
                                        into STRICT    cd_conta_contabil_w
;
                                end if;


                                nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;

                                if (ie_ordem_compl_w = 'NF') then
                                        ds_compl_historico_w    := substr(nr_nota_fiscal_w || ' ' || ds_razao_social_w,1,255);
                                else
                                        ds_compl_historico_w    := substr(ds_razao_social_w || ' ' || nr_nota_fiscal_w,1,255);
                                end if;

                                if (ie_analitico_sintetico_w = 'A') then
                                        ds_doc_agrupamento_w    := nr_sequencia_w;
                                        ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' (' || nr_sequencia_w || ')',1,255);
                                end if;

                                /*anderson - 24/06/2006 - os 35685*/

                                if (ie_nf_entrada_saida_w = 'E') and (ie_contab_pac_nf_w <> 'N') then
                                        if (ie_contab_pac_nf_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'C') and (ie_nf_consignado_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'O') and (ie_nf_consignado_w = 'S') and
                                                ((ds_observacao_nf_w IS NOT NULL AND ds_observacao_nf_w::text <> '') or (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '')) then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' ||
                                                                        coalesce(nm_paciente_w,ds_observacao_nf_w),1,255);
                                        end if;
                                end if;

                                if (ie_acao_nf_w = '2') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(728461) || ' ',1,255);

                                        if (ie_debito_credito_w = 'D') then
                                                ie_debito_credito_w     := 'C';
                                        else
                                                ie_debito_credito_w     := 'D';
                                        end if;
                                elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795499) || ' ',1,255);
                                end if;

                                if (ie_datas_vencto_w = 'S') then
                                        begin
                                        select  substr(obter_select_concatenado_bv(
                                                        'select dt_vencimento from nota_fiscal_venc where nr_sequencia = :nr_sequencia',
                                                        'nr_sequencia=' || nr_sequencia_w,
                                                        '  '),1,255)
                                        into STRICT    dt_vencto_w
;

                                        if (dt_vencto_w IS NOT NULL AND dt_vencto_w::text <> '') then
                                                ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795510) || ' ' || dt_vencto_w,1,255);
                                        end if;
                                        exception when others then
                                                dt_vencto_w     := null;
                                        end;
                                end if;

                                /*ds_comando_w  :=      'select '|| nm_atributo_w ||'
                                                        vl_retorno_w From Nota_fiscal '||
                                                        'Where nr_sequencia = '||nr_sequencia_w;*/
                                ds_comando_w    :=      'select '|| nm_atributo_w || ' vl_retorno_w From Nota_fiscal '||
                                                        'Where nr_sequencia = :nr_sequencia';
                                ds_param_sql_w  :=      'nr_sequencia=' || nr_sequencia_w || ';';

                                if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      nr_nota_fiscal_w                        || '#@' ||
                                                                        ds_razao_social_w                       || '#@' ||
                                                                        to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                        nm_paciente_w                           || '#@' ||
                                                                        nr_sequencia_w                          || '#@' ||
                                                                        dt_vencto_w                             || '#@' ||
                                                                        ds_observacao_nf_w                      || '#@' ||
                                                                                                                  ' #@' ||
                                                                        ie_estorno_w                            || '#@' ||
                                                                                                                  ' #@' ||
                                                                        ds_situacao_w                           || '#@' ||
                                                                        substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                        ds_estorno_w                            || '#@' ||
                                                                        to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                        nr_atendimento_w                        || '#@' ||
                                                                        nr_interno_conta_w                      || '#@' ||
                                                                        nr_nfe_imp_w                            || '#@' ||
                                                                        nm_estabelecimento_w                    || '#@' ||
                                                                        nr_rps_w                                || '#@' ||
                                                                        ds_material_w                           || '#@' ||
                                                                        cd_unidade_medida_compra_w              || '#@' ||
                                                                        cd_unidade_medida_estoque_w             || '#@' ||
                                                                        qt_item_nf_w                            || '#@' ||
                                                                        qt_item_estoque_w                       || '#@' ||
                                                                        nr_sequencia_movto_w                    || '#@' ||
                                                                        ds_tributo_w                            || '#@' ||
                                                                        nr_ordem_compra_w                       || '#@' ||
                                                                        ie_nf_nfe_w                             || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                        ds_titulos_receber_nf_w                 || '#@' ||
                                                                        cd_cgc_w                                || '#@' ||
                                                                        cd_pessoa_fisica_w                      || '#@' ||
                                                                        ds_consignado_w                         || '#@' ||
                                                                        ds_operacao_nf_w                        || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        nr_seq_nota_orig_w                      || '#@' ||
                                                                        nr_nota_orig_w                          || '#@' ||
                                                                        cd_serie_nf_orig_w                      || '#@' ||
                                                                        nr_nfe_imp_orig_w,1,4000);


                                        select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_w, ds_conteudo_w)
                                        into STRICT    ds_compl_historico_ww
;

                                        ds_compl_historico_w            := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                end if;


                                vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, ds_param_sql_w, vl_retorno_w);

                                if (vl_conta_nf_w > 0) and (nm_atributo_w like '%VL_TOTAL_NOTA%') then
                                        vl_retorno_w            := 0;
                                        open c070;
                                        loop
                                        fetch c070 into
                                                cd_conta_ctb_esp_w,
                                                vl_contabil_esp_w;
                                        EXIT WHEN NOT FOUND; /* apply on c070 */
                                                insert into w_movimento_contabil(nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        nr_seq_trans_fin,
                                                        cd_cgc,
                                                        cd_pessoa_fisica,
                                                        nr_documento,
                                                        ie_transitorio,
                                                        ie_origem_documento,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        ie_intercompany,
                                                        cd_estab_intercompany,
                                                        cd_sequencia_parametro,
                                                        nr_codigo_controle,
                                                        nr_seq_proj_rec
                                                        )
                                                values (nr_lote_contabil_p,
                                                        nr_sequencia_movto_w,
                                                        cd_conta_ctb_esp_w,
                                                        ie_debito_credito_w,
                                                        cd_historico_w,
                                                        dt_movimento_w,
                                                        vl_contabil_esp_w,
                                                        cd_centro_custo_w,
                                                        ds_compl_historico_w,
                                                        ds_doc_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        cd_cgc_w,
                                                        cd_pessoa_fisica_w,
                                                        nr_documento_w,
                                                        'N',
                                                        1,
                                                        nr_sequencia_w,
                                                        null,
                                                        'NOTA_FISCAL',
                                                        'VL_CONTABIL',
                                                        nr_seq_info_ctb_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w,
                                                        cd_sequencia_parametro_w,
                                                        nr_codigo_controle_w,
                                                        nr_seq_proj_rec_w
                                                        );

                                                if (ie_debito_credito_w = 'D') then
                                                        vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_contabil_esp_w,0);
                                                elsif (ie_debito_credito_w = 'C') then
                                                        vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_contabil_esp_w, 0);
                                                end if;
                                        end loop;
                                        close c070;
                                end if;

                                if (vl_retorno_w IS NOT NULL AND vl_retorno_w::text <> '') and (vl_retorno_w <> 0) then
                                        cd_estab_movto_w        := cd_estabelecimento_w;

                                        if (coalesce(ie_tipo_ordem_w,'X') <> 'T') and (ie_contab_nf_estab_w = 'EF') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                                                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                                        if (ie_debito_credito_w = 'D') then
                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                        end if;
                                                else
                                                        if (ie_debito_credito_w = 'C') then
                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                        end if;

                                                end if;
                                        end if;

                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                nr_seq_trans_fin,
                                                cd_cgc,
                                                cd_pessoa_fisica,
                                                nr_documento,
                                                ie_transitorio,
                                                cd_estabelecimento,
                                                ie_origem_documento,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nm_tabela,
                                                nm_atributo,
                                                nr_seq_info,
                                                nr_seq_classif_movto,
                                                ie_intercompany,
                                                cd_estab_intercompany,
                                                cd_sequencia_parametro,
												nr_codigo_controle,
                                                nr_seq_proj_rec
                                                )
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_movto_w,
                                                cd_conta_contabil_w,
                                                ie_debito_credito_w,
                                                cd_historico_w,
                                                dt_movimento_w,
                                                vl_retorno_w,
                                                cd_centro_custo_w,
                                                ds_compl_historico_w,
                                                ds_doc_agrupamento_w,
                                                nr_seq_agrupamento_w,
                                                null,
                                                cd_cgc_w,
                                                cd_pessoa_fisica_w,
                                                nr_documento_w,
                                                'N',
                                                cd_estab_movto_w,
                                                1,
                                                nr_sequencia_w,
                                                null,
                                                'NOTA_FISCAL',
                                                nm_atributo_w,
                                                nr_seq_info_ctb_w,
                                                nr_seq_classif_movto_w,
                                                ie_intercompany_w,
                                                cd_estab_intercompany_w,
                                                cd_sequencia_parametro_w,
												nr_codigo_controle_w,
                                                nr_seq_proj_rec_w
                                                );

                                        if (ie_debito_credito_w = 'D') then
                                                vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_retorno_w,0);
                                        elsif (ie_debito_credito_w = 'C') then
                                                vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_retorno_w, 0);
                                        end if;
                                end if;

                                update nota_fiscal
                                set nr_lote_contabil    = nr_lote_contabil_p,
                                    nr_codigo_controle  = nr_codigo_controle_w
                                where nr_sequencia      = nr_sequencia_w;
                        end loop;
                        close c010;

                        /* itens da nota fiscal */

                        open c020;
                        loop
                        fetch c020 into
                                nm_atributo_w,
                                ie_debito_credito_w,
                                ie_origem_conta_w,
                                cd_conta_contabil_w,
                                cd_centro_custo_w,
                                cd_historico_w,
                                ie_origem_centro_w,
                                cd_material_w,
                                cd_procedimento_w,
                                ie_origem_proced_w,
                                nr_item_nf_w,
                                cd_conta_contabil_nf_w,
                                cd_centro_custo_nf_w,
                                cd_local_estoque_w,
                                ds_complemento_w,
                                qt_item_nf_w,
                                cd_unidade_medida_compra_w,
                                ds_material_w,
                                cd_unidade_medida_estoque_w,
                                qt_item_estoque_w,
                                ds_observacao_item_w,
                                nr_solic_compra_w,
                                nr_seq_proj_rec_w,
                                cd_natureza_operacao_w,
                                nr_seq_classif_movto_w,
                                nr_seq_proc_interno_w,
                                ie_param_estab_rateio_w,
                                ie_param_estab_w,
                                cd_sequencia_parametro_nf_w;
                        EXIT WHEN NOT FOUND; /* apply on c020 */
                                cd_centro_custo_evento_w        := null;
                                ds_projeto_recurso_w            := '';
                                cd_sequencia_parametro_w        := null;

                                select  coalesce(max(ie_tipo_local),'0')
                                into STRICT    ie_tipo_local_estoque_w
                                from    local_estoque
                                where   cd_local_estoque        = cd_local_estoque_w;

                                /* regra de centro de custo fixo no evento contabil */

                                if (ie_origem_centro_w = '1') then
                                        cd_centro_custo_evento_w        := cd_centro_custo_w;
                                end if;

                                /* regra para obtencao de conta contabil */

                                <<obter_conta_contabil_item>>
                                begin
                                        /* origem conta = 1 | fixa, obtem do evento contabil */

                                        if (ie_origem_conta_w = '1') and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
                                                cd_conta_contabil_w     := cd_conta_contabil_w;
                                        else
                                                /*
                                                Tratamento para obter a conta contabil via regra do
                                                evento contabil

                                                IE_PARAM_ESTAB
                                                        Forca a leitura das regras de conta contabil e
                                                        centro de custo por estabelecimento, sobrepondo
                                                        a conta contabil informada no item da nota

                                                CD_CONTA_CONTABIL_NF_W
                                                        Conta contabil do item da nota

                                                CD_CENTRO_CUSTO_NF_W
                                                        Centro de custo do item da nota

                                                IE_ORIGEM_CONTA_W
                                                        Origem da conta contabil
                                                        11 = Parametros Produto (Conta de Receita)
                                                */
                                                if (ie_param_estab_w = 'S') or (coalesce(cd_conta_contabil_nf_w::text, '') = '') or (coalesce(cd_centro_custo_nf_w::text, '') = '') or (ie_origem_conta_w in ('11', '16', '17', '18', '19')) then
                                                        cd_conta_contabil_w     := cd_conta_contabil_nf_w;
                                                        cd_centro_custo_w       := cd_centro_custo_nf_w;

                                                        begin
                                                                select  count(*)
                                                                into STRICT    qt_rateio_w
                                                                from (SELECT 1
                                                                        from    nota_fiscal_item_rateio r
                                                                        where   nr_seq_nota = nr_sequencia_w
                                                                        and     nr_item_nf = nr_item_nf_w) alias1;
                                                        exception
                                                        when others then
                                                                qt_rateio_w     := 0;
                                                        end;

                                                        if (qt_rateio_w = 0) or (ie_param_estab_w = 'S') then
                                                                if (nr_solic_compra_w IS NOT NULL AND nr_solic_compra_w::text <> '') then

                                                                        select  nr_seq_motivo_solic
                                                                        into STRICT    nr_seq_motivo_solic_w
                                                                        from    solic_compra
                                                                        where   nr_solic_compra = nr_solic_compra_w;
                                                                end if;

                                                                vl_regra_w := obter_valor_item_regra(nr_sequencia_w, nr_item_nf_w);
                                                                SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, wheb_mensagem_pck.get_texto(795577) || ' ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w, dt_movimento_w, 'N', nr_seq_motivo_solic_w, vetor_nf[z].cd_operacao_nf, cd_natureza_operacao_w, nr_seq_proc_interno_w, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                                                cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                                                        end if;
                                                end if;

                                                /*
                                                Tratamento para sobrepor a conta e centro de custo obtidos da regra
                                                do evento contabil com a conta e/ou centro do item da nota

                                                IE_PARAM_ESTAB_W
                                                        Sobrepor a conta e centro a contabilizar com a conta e centro
                                                        do item da nota caso nao estiver configurado para utilizar os
                                                        valores obtidos da regra

                                                IE_ORIGEM_CONTA_W
                                                        11 - Parametros Produto (Conta de Receita)
                                                        14 - Parametros conta contabil (Conta Estoque Terceiro)
                                                        16 - Conta de pagamento do projeto e recurso externo
                                                        17 - Conta de despesa do projeto e recurso externo
                                                        18 - Conta de recebimento do projeto e recurso externo
                                                        19 - Conta de receita do projeto e recurso externo
                                                */
                                                if (ie_param_estab_w = 'N') and (ie_origem_conta_w not in ('11','14','16','17','18','19')) then
														if (cd_conta_contabil_nf_w IS NOT NULL AND cd_conta_contabil_nf_w::text <> '') then
                                                                cd_conta_contabil_w     := cd_conta_contabil_nf_w;
																cd_sequencia_parametro_w:= cd_sequencia_parametro_nf_w;
                                                        end if;
                                                        if (cd_centro_custo_nf_w IS NOT NULL AND cd_centro_custo_nf_w::text <> '') then
                                                                cd_centro_custo_w       := cd_centro_custo_nf_w;
                                                        end if;
                                                end if;
                                        end if;
                                end;

                                nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;

                                if (ie_ordem_compl_w = 'NF') then
                                        ds_compl_historico_w    := substr(nr_nota_fiscal_w || ' ' || ds_razao_social_w,1,255);
                                else
                                        ds_compl_historico_w    := substr(ds_razao_social_w || ' ' || nr_nota_fiscal_w,1,255);
                                end if;

                                if (ie_analitico_sintetico_w = 'A') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' (' || nr_sequencia_w || ')',1,255);
                                end if;

                                        /*anderson - 24/06/2006 - os 35685*/

                                if (ie_nf_entrada_saida_w = 'E') and (ie_contab_pac_nf_w <> 'N') then
                                        if (ie_contab_pac_nf_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'C') and (ie_nf_consignado_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'O') and (ie_nf_consignado_w = 'S') and
                                                ((ds_observacao_nf_w IS NOT NULL AND ds_observacao_nf_w::text <> '') or (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '')) then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || coalesce(nm_paciente_w,ds_observacao_nf_w),1,255);
                                        end if;
                                end if;

                                if (ie_compl_contab_nf_w = 'S') and (ds_complemento_w IS NOT NULL AND ds_complemento_w::text <> '') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || ds_complemento_w,1,255);
                                end if;

                                if (ie_acao_nf_w = '2') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(728461) || ' ',1,255);

                                        if (ie_debito_credito_w = 'D') then
                                                ie_debito_credito_w     := 'C';
                                        else
                                                ie_debito_credito_w     := 'D';
                                        end if;
                                elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795499) ||' ',1,255);
                                end if;

                                /*ds_comando_w  :=      'select '|| nm_atributo_w ||
                                                                 ' vl_retorno_w From Nota_fiscal_item '||
                                                                 ' Where nr_sequencia = '||nr_sequencia_w||
                                                                 ' and nr_item_nf   = '||nr_item_nf_w;*/
                                ds_comando_w    :=      'select '|| nm_atributo_w || ' vl_retorno_w From Nota_fiscal_item '||
                                                                 ' Where nr_sequencia = :nr_sequencia' ||
                                                                 ' and nr_item_nf = :nr_item_nf';
                                ds_param_sql_w  := 'nr_sequencia=' || nr_sequencia_w ||
                                                   ';nr_item_nf=' || nr_item_nf_w;

                                begin
                                select  ie_centro_custo
                                into STRICT    ie_centro_custo_w
                                from    conta_contabil
                                where   cd_conta_contabil       = cd_conta_contabil_w;
                                exception
                                when others then
                                        ie_centro_custo_w       := 'N';
                                end;

                                if (ie_centro_custo_w = 'N') then
                                        cd_centro_custo_nf_w            := null;
                                        cd_centro_custo_evento_w        := null;
                                else
                                        if (coalesce(cd_centro_custo_nf_w,0) = 0) then
                                                select  max(cd_centro_custo)
                                                into STRICT    cd_centro_custo_nf_w
                                                from    local_estoque
                                                where   cd_local_estoque        = cd_local_estoque_w;
                                        end if;
                                end if;

                                vl_total_rateio_w       := 0;

                                vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, ds_param_sql_w, vl_retorno_w);

                                if (coalesce(nr_seq_proj_rec_w,0) <> 0) then
                                        select  ds_projeto
                                        into STRICT    ds_projeto_recurso_w
                                        from    projeto_recurso
                                        where   nr_sequencia = nr_seq_proj_rec_w;
                                end if;

                                if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      nr_nota_fiscal_w                        || '#@' ||
                                                                        ds_razao_social_w                       || '#@' ||
                                                                        to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                        nm_paciente_w                           || '#@' ||
                                                                        nr_sequencia_w                          || '#@' ||
                                                                        dt_vencto_w                             || '#@' ||
                                                                        ds_observacao_nf_w                      || '#@' ||
                                                                        ds_complemento_w                        || '#@' ||
                                                                        ie_estorno_w                            || '#@' ||
                                                                                                                  ' #@' ||
                                                                        ds_situacao_w                           || '#@' ||
                                                                        substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                        ds_estorno_w                            || '#@' ||
                                                                        to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                        nr_atendimento_w                        || '#@' ||
                                                                        nr_interno_conta_w                      || '#@' ||
                                                                        nr_nfe_imp_w                            || '#@' ||
                                                                        nm_estabelecimento_w                    || '#@' ||
                                                                        nr_rps_w                                || '#@' ||
                                                                        ds_material_w                           || '#@' ||
                                                                        cd_unidade_medida_compra_w              || '#@' ||
                                                                        cd_unidade_medida_estoque_w             || '#@' ||
                                                                        qt_item_nf_w                            || '#@' ||
                                                                        qt_item_estoque_w                       || '#@' ||
                                                                        nr_sequencia_movto_w                    || '#@' ||
                                                                        ds_tributo_w                            || '#@' ||
                                                                        nr_ordem_compra_w                       || '#@' ||
                                                                        ie_nf_nfe_w                             || '#@' ||
                                                                        ds_observacao_item_w                    || '#@' ||
                                                                        ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                        ds_titulos_receber_nf_w                 || '#@' ||
                                                                        cd_cgc_w                                || '#@' ||
                                                                        cd_pessoa_fisica_w                      || '#@' ||
                                                                        ds_consignado_w                         || '#@' ||
                                                                        ds_operacao_nf_w                        || '#@' ||
                                                                        nr_seq_proj_rec_w                       || '#@' ||
                                                                        ds_projeto_recurso_w                    || '#@' ||
                                                                        nr_seq_nota_orig_w                      || '#@' ||
                                                                        nr_nota_orig_w                          || '#@' ||
                                                                        cd_serie_nf_orig_w                      || '#@' ||
                                                                        nr_nfe_imp_orig_w,1,4000);

                                        select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_w, ds_conteudo_w)
                                        into STRICT    ds_compl_historico_ww
;

                                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                end if;

                                begin
                                qt_regra_rateio_w       := 0;

                                select  1
                                into STRICT    qt_regra_rateio_w
                                from    evento_contabil_param   b
                                where   b.cd_tipo_lote_contabil = cd_tipo_lote_contabil_nota_w
                                and     b.cd_evento             = cd_evento_w
                                and     b.nm_tabela             = 'NOTA_FISCAL_ITEM_RATEIO'  LIMIT 1;
                                exception
                                when others then
                                        qt_regra_rateio_w       := 0;
                                end;

                                /*      contabilizar o rateio dos valores por centro de custo e conta */


                                /*      alterado por marcus em 20/04/2006 para atender situacoes com e sem rateio */

                                if (nm_atributo_w  like '%VL_TOTAL_ITEM_NF%') and (qt_regra_rateio_w = 0) then
                                        open c050;
                                        loop
                                        fetch c050 into
                                                cd_conta_contabil_w,
                                                cd_centro_custo_w,
                                                vl_rateio_w;
                                        EXIT WHEN NOT FOUND; /* apply on c050 */
                                                nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;
                                                vl_total_rateio_w       := vl_total_rateio_w + vl_rateio_w;
                                                cd_sequencia_parametro_w := null;
                                                if (coalesce(ie_param_estab_rateio_w,'N') = 'S') then
														SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, wheb_mensagem_pck.get_texto(795577) || ' ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w, dt_movimento_w, 'N', nr_seq_motivo_solic_w, vetor_nf[z].cd_operacao_nf, cd_natureza_operacao_w, nr_seq_proc_interno_w, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                                                end if;

                                                select  coalesce(max(cd_estabelecimento),cd_estabelecimento_w)
                                                into STRICT    cd_estab_centro_w
                                                from    centro_custo
                                                where   cd_centro_custo = cd_centro_custo_w;

                                                begin
                                                select  ie_centro_custo
                                                into STRICT    ie_centro_custo_w
                                                from    conta_contabil
                                                where   cd_conta_contabil       = cd_conta_contabil_w;
                                                exception
                                                when others then
                                                        ie_centro_custo_w       := 'N';
                                                end;

                                                insert into w_movimento_contabil(nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        nr_seq_trans_fin,
                                                        cd_cgc,
                                                        cd_pessoa_fisica,
                                                        nr_documento,
                                                        cd_estabelecimento,
                                                        ie_transitorio,
                                                        ie_origem_documento,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        ie_intercompany,
                                                        cd_estab_intercompany,
                                                        cd_sequencia_parametro,
														nr_codigo_controle,
                                                        nr_seq_proj_rec
                                                        )
                                                values (nr_lote_contabil_p,
                                                        nr_sequencia_movto_w,
                                                        cd_conta_contabil_w,
                                                        ie_debito_credito_w,
                                                        cd_historico_w,
                                                        dt_movimento_w,
                                                        vl_rateio_w,
                                                        CASE WHEN ie_centro_custo_w='S' THEN cd_centro_custo_w WHEN ie_centro_custo_w='N' THEN null END ,
                                                        ds_compl_historico_w,
                                                        ds_doc_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        cd_cgc_w,
                                                        cd_pessoa_fisica_w,
                                                        nr_documento_w,
                                                        CASE WHEN ie_contab_nf_estab_w='EC' THEN  cd_estab_centro_w WHEN ie_contab_nf_estab_w='EF' THEN  cd_estabelecimento_w END ,
                                                        'N',
                                                        1,
                                                        nr_sequencia_w,
                                                        null,
                                                        'NOTA_FISCAL_ITEM_RATEIO',
                                                        'VL_RATEIO',
                                                        nr_seq_info_ctb_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w,
                                                        cd_sequencia_parametro_w,
														nr_codigo_controle_w,
                                                        nr_seq_proj_rec_w
                                                        );

                                                if (ie_debito_credito_w = 'D') then
                                                        vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_rateio_w,0);
                                                elsif (ie_debito_credito_w = 'C') then
                                                        vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_rateio_w, 0);
                                                end if;

                                                if (ie_permite_estab_dif_w = 'PCCT') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') then
                                                        if (ie_contab_nf_estab_w = 'EC') and (cd_estab_centro_w <> cd_estabelecimento_w) then
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estab_centro_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                        end if;
                                                end if;
                                        end loop;
                                        close c050;
                                end if;

                                /*           marcus - se nao teve rateio contabiliza o vl_total_item_nf do item da nota */

                                if (coalesce(vl_retorno_w,0) <> 0) and (vl_total_rateio_w = 0) and
                                        ((coalesce(nr_seq_nf_ref_compl_w::text, '') = '') or (ie_contab_nf_compl_w = 'N'))
                                        then
                                        if (ie_centro_custo_w = 'S') and (cd_centro_custo_evento_w IS NOT NULL AND cd_centro_custo_evento_w::text <> '') and (ie_origem_centro_w = '1') then
                                                cd_centro_custo_nf_w    := cd_centro_custo_evento_w;
                                        end if;

                                        select  coalesce(max(a.cd_estabelecimento), cd_estabelecimento_w)
                                        into STRICT    cd_estab_centro_w
                                        from    centro_custo a
                                        where   a.cd_centro_custo       = cd_centro_custo_nf_w;

                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                nr_seq_trans_fin,
                                                cd_cgc,
                                                cd_pessoa_fisica,
                                                nr_documento,
                                                ie_transitorio,
                                                ie_origem_documento,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nm_tabela,
                                                nm_atributo,
                                                nr_seq_info,
                                                cd_estabelecimento,
                                                ie_intercompany,
                                                nr_seq_classif_movto,
                                                cd_estab_intercompany,
                                                cd_sequencia_parametro,
												nr_codigo_controle,
                                                nr_seq_proj_rec
                                                )
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_movto_w,
                                                cd_conta_contabil_w,
                                                ie_debito_credito_w,
                                                cd_historico_w,
                                                dt_movimento_w,
                                                vl_retorno_w,
                                                cd_centro_custo_nf_w,
                                                ds_compl_historico_w,
                                                ds_doc_agrupamento_w,
                                                nr_seq_agrupamento_w,
                                                null,
                                                cd_cgc_w,
                                                cd_pessoa_fisica_w,
                                                nr_documento_w,
                                                'N',
                                                1,
                                                nr_sequencia_w,
                                                null,
                                                'NOTA_FISCAL_ITEM',
                                                nm_atributo_w,
                                                nr_seq_info_ctb_w,
                                                CASE WHEN ie_contab_nf_estab_w='EC' THEN  cd_estab_centro_w WHEN ie_contab_nf_estab_w='EF' THEN  cd_estabelecimento_w END ,
                                                ie_intercompany_w,
                                                nr_seq_classif_movto_w,
                                                cd_estab_intercompany_w,
                                                cd_sequencia_parametro_w,
												nr_codigo_controle_w,
                                                nr_seq_proj_rec_w
                                                );

                                        if (ie_debito_credito_w = 'D') then
                                                vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_retorno_w,0);
                                        elsif (ie_debito_credito_w = 'C') then
                                                vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_retorno_w, 0);
                                        end if;
                                end if;

                                if (vl_total_rateio_w = 0) and (qt_regra_rateio_w > 0) then
                                        open c080;
                                        loop
                                        fetch c080 into
                                                nr_seq_item_rateio_w,
                                                cd_conta_contabil_w,
                                                cd_centro_custo_w,
                                                vl_rateio_w,
                                                nm_atributo_w,
                                                ie_debito_credito_w,
                                                ie_param_estab_rateio_w,
                                                ie_origem_conta_w,
                                                cd_conta_contabil_rat_w,
                                                cd_centro_custo_rat_w,
                                                cd_historico_w,
                                                ie_origem_centro_w,
                                                nr_seq_classif_movto_w;
                                        EXIT WHEN NOT FOUND; /* apply on c080 */
                                                nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;

                                                cd_sequencia_parametro_w := null;
                                                if (coalesce(ie_param_estab_rateio_w,'N') = 'S') then
                                                        SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, wheb_mensagem_pck.get_texto(795577) || ' ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w, dt_movimento_w, 'N', nr_seq_motivo_solic_w, vetor_nf[z].cd_operacao_nf, cd_natureza_operacao_w, nr_seq_proc_interno_w, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();
                                                end if;

                                                if (ie_acao_nf_w = '2') then

                                                        if (ie_debito_credito_w = 'D') then
                                                                ie_debito_credito_w     := 'C';
                                                        else
                                                                ie_debito_credito_w     := 'D';
                                                        end if;
                                                end if;

                                                begin
                                                select  cd_estabelecimento
                                                into STRICT    cd_estab_centro_w
                                                from    centro_custo
                                                where   cd_centro_custo = cd_centro_custo_w;
                                                exception
                                                when others then
                                                        cd_estab_centro_w       := cd_estabelecimento_w;
                                                end;

                                                begin
                                                select  ie_centro_custo
                                                into STRICT    ie_centro_custo_w
                                                from    conta_contabil
                                                where   cd_conta_contabil       = cd_conta_contabil_w;
                                                exception
                                                when others then
                                                        ie_centro_custo_w       := 'N';
                                                end;

                                                ds_comando_w    :=      'select '|| nm_atributo_w || ' vl_retorno_w From Nota_fiscal_item_rateio '||
                                                                        ' Where nr_seq_nota = :nr_sequencia' ||
                                                                        ' and nr_item_nf = :nr_item_nf and nr_sequencia = :nr_seq_item_rateio';

                                                ds_param_sql_w  :=      'nr_sequencia=' || nr_sequencia_w ||
                                                                        ';nr_item_nf=' || nr_item_nf_w || ';nr_seq_item_rateio=' || nr_seq_item_rateio_w;

                                                vl_rateio_w := obter_valor_dinamico_bv(ds_comando_w, ds_param_sql_w, vl_rateio_w);

                                                vl_total_rateio_w       := vl_total_rateio_w + vl_rateio_w;

                                                insert into w_movimento_contabil(nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        nr_seq_trans_fin,
                                                        cd_cgc,
                                                        cd_pessoa_fisica,
                                                        nr_documento,
                                                        cd_estabelecimento,
                                                        ie_transitorio,
                                                        ie_origem_documento,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        ie_intercompany,
                                                        cd_estab_intercompany,
                                                        cd_sequencia_parametro,
														nr_codigo_controle,
                                                        nr_seq_proj_rec
                                                        )
                                                values (nr_lote_contabil_p,
                                                        nr_sequencia_movto_w,
                                                        cd_conta_contabil_w,
                                                        ie_debito_credito_w,
                                                        cd_historico_w,
                                                        dt_movimento_w,
                                                        coalesce(vl_rateio_w,0),
                                                        CASE WHEN ie_centro_custo_w='S' THEN cd_centro_custo_w WHEN ie_centro_custo_w='N' THEN null END ,
                                                        ds_compl_historico_w,
                                                        ds_doc_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        cd_cgc_w,
                                                        cd_pessoa_fisica_w,
                                                        nr_documento_w,
                                                        CASE WHEN ie_contab_nf_estab_w='EC' THEN cd_estab_centro_w WHEN ie_contab_nf_estab_w='EF' THEN cd_estabelecimento_w END ,
                                                        'N',
                                                        1,
                                                        nr_sequencia_w,
                                                        nr_seq_item_rateio_w,
                                                        'NOTA_FISCAL_ITEM_RATEIO',
                                                        substr(nm_atributo_w,1,50),
                                                        nr_seq_info_ctb_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w,
                                                        cd_sequencia_parametro_w,
														nr_codigo_controle_w,
                                                        nr_seq_proj_rec_w
                                                        );

                                                if (ie_debito_credito_w = 'D') then
                                                        vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_rateio_w,0);
                                                elsif (ie_debito_credito_w = 'C') then
                                                        vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_rateio_w, 0);
                                                end if;

                                                if (ie_permite_estab_dif_w = 'PCCT') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') then
                                                        if (ie_contab_nf_estab_w = 'EC') and (cd_estab_centro_w <> cd_estabelecimento_w) then
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estab_centro_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                        end if;
                                                end if;
                                        end loop;
                                        close c080;
                                end if;

                                update nota_fiscal
                                set nr_lote_contabil    = nr_lote_contabil_p,
                                    nr_codigo_controle  = nr_codigo_controle_w
                                where nr_sequencia          = nr_sequencia_w;
                        end loop;
                        close c020;

                        /* tributos da nota fiscal */

                        ds_tributo_w    := '';

                        open c040;
                        loop
                        fetch c040 into
                                nm_atributo_w,
                                ie_debito_credito_w,
                                ie_origem_conta_w,
                                cd_conta_contabil_w,
                                cd_centro_custo_w,
                                cd_historico_w,
                                cd_tributo_nf_w,
                                ie_corpo_venc_w,
                                ie_origem_centro_w,
                                dt_vencimento_w,
                                nr_seq_classif_movto_w;
                        EXIT WHEN NOT FOUND; /* apply on c040 */

                                cd_sequencia_parametro_w        := null;

                                /*fabio 17/09/2006 - conta por tributo da pessoa juridica*/

                                if (ie_origem_conta_w = '7') then
                                        select  coalesce(max(cd_conta_contabil), cd_conta_contabil_w)
                                        into STRICT    cd_conta_contabil_w
                                        from    tributo_conta_contabil
                                        where   cd_cgc          = cd_cgc_w
                                        and     cd_tributo      = cd_tributo_nf_w
                                        and     cd_empresa      = cd_empresa_w
                                        and (coalesce(dt_inicio_vigencia, dt_movimento_w) <= dt_movimento_w and coalesce(dt_fim_vigencia, dt_movimento_w) >= dt_movimento_w);
                                end if;

                                /* marcus em 04/04/2006 */

                                if (coalesce(cd_conta_contabil_w::text, '') = '') then
                                        SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ie_tipo_convenio_w, cd_convenio_w, null, null, null, null, cd_conta_contabil_w, cd_centro_custo_w, 'NF: ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w || ' ' || wheb_mensagem_pck.get_texto(795500) || ' ' || nm_atributo_w, dt_movimento_w, null, null, vetor_nf[z].cd_operacao_nf, vetor_nf[z].cd_natureza_operacao, null, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();

                                end if;

                                nr_sequencia_movto_w    := nr_sequencia_movto_w + 1;

                                if (ie_ordem_compl_w = 'NF') then
                                        ds_compl_historico_w    := substr(nr_nota_fiscal_w || ' ' || ds_razao_social_w,1,255);
                                else
                                        ds_compl_historico_w    := substr(ds_razao_social_w || ' ' || nr_nota_fiscal_w,1,255);
                                end if;
                                if (ie_analitico_sintetico_w = 'A') then
                                        ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' (' || nr_sequencia_w || ')',1,255);
                                end if;

                                        /*anderson - 24/06/2006 - os 35685*/

                                if (ie_nf_entrada_saida_w = 'E') and (ie_contab_pac_nf_w <> 'N') then
                                        if (ie_contab_pac_nf_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'C') and (ie_nf_consignado_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'O') and (ie_nf_consignado_w = 'S') and
                                                ((ds_observacao_nf_w IS NOT NULL AND ds_observacao_nf_w::text <> '') or (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '')) then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' ||
                                                                                                        coalesce(nm_paciente_w,ds_observacao_nf_w),1,255);
                                        end if;
                                end if;

                                select  substr(max(ds_tributo),1,100)
                                into STRICT    ds_tributo_w
                                from    tributo
                                where   cd_tributo      = cd_tributo_nf_w;

                                if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      nr_nota_fiscal_w                        || '#@' ||
                                                                        ds_razao_social_w                       || '#@' ||
                                                                        to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                        nm_paciente_w                           || '#@' ||
                                                                        nr_sequencia_w                          || '#@' ||
                                                                        dt_vencto_w                             || '#@' ||
                                                                        ds_observacao_nf_w                      || '#@' ||
                                                                                                                  ' #@' ||
                                                                        ie_estorno_w                            || '#@' ||
                                                                        nr_documento_desp_w                     || '#@' ||
                                                                        ds_situacao_w                           || '#@' ||
                                                                        substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                        ds_estorno_w                            || '#@' ||
                                                                        to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                        nr_atendimento_w                        || '#@' ||
                                                                        nr_interno_conta_w                      || '#@' ||
                                                                        nr_nfe_imp_w                            || '#@' ||
                                                                        nm_estabelecimento_w                    || '#@' ||
                                                                        nr_rps_w                                || '#@' ||
                                                                        ds_material_w                           || '#@' ||
                                                                        cd_unidade_medida_compra_w              || '#@' ||
                                                                        cd_unidade_medida_estoque_w             || '#@' ||
                                                                        qt_item_nf_w                            || '#@' ||
                                                                        qt_item_estoque_w                       || '#@' ||
                                                                        nr_sequencia_movto_w                    || '#@' ||
                                                                        ds_tributo_w                            || '#@' ||
                                                                        nr_ordem_compra_w                       || '#@' ||
                                                                        ie_nf_nfe_w                             || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                        ds_titulos_receber_nf_w                 || '#@' ||
                                                                        cd_cgc_w                                || '#@' ||
                                                                        cd_pessoa_fisica_w                      || '#@' ||
                                                                        ds_consignado_w                         || '#@' ||
                                                                        ds_operacao_nf_w                        || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        nr_seq_nota_orig_w                      || '#@' ||
                                                                        nr_nota_orig_w                          || '#@' ||
                                                                        cd_serie_nf_orig_w                      || '#@' ||
                                                                        nr_nfe_imp_orig_w,1,4000);

                                        select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_w, ds_conteudo_w)
                                        into STRICT    ds_compl_historico_ww
;

                                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                end if;

                                if (ie_acao_nf_w   = '2') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(728461) || ' ',1,255);

                                        if (ie_debito_credito_w = 'D') then
                                                ie_debito_credito_w  := 'C';
                                        else
                                                ie_debito_credito_w  := 'D';
                                        end if;
                                elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795499) || ' ',1,255);
                                end if;

                                begin
                                select  ie_centro_custo
                                into STRICT    ie_centro_custo_w
                                from    conta_contabil
                                where   cd_conta_contabil       = cd_conta_contabil_w;
                                exception
                                when others then
                                        ie_centro_custo_w       := 'N';
                                end;

                                if (ie_centro_custo_w = 'N') then
                                        cd_centro_custo_w       := null;
                                end if;

                                /*ds_comando_w    :=            'select '|| nm_atributo_w ||
                                                                ' vl_retorno_w From Nota_fiscal_Trib '||
                                                                ' Where nr_sequencia = '||nr_sequencia_w ||
                                                                ' and cd_tributo = ' || cd_tributo_nf_w;*/
                                ds_comando_w    :=      'select '|| nm_atributo_w || ' vl_retorno_w From Nota_fiscal_Trib '||
                                                        ' Where nr_sequencia = :nr_sequencia'||
                                                        ' and cd_tributo = :cd_tributo';
                                ds_param_sql_w  :=      'nr_sequencia=' || nr_sequencia_w ||
                                                        ';cd_tributo=' || cd_tributo_nf_w;

                                if (ie_corpo_venc_w = 'V') then
                                        /*ds_comando_w      :=  'select '|| nm_atributo_w ||
                                                                        ' vl_retorno_w From Nota_fiscal_venc_Trib '||
                                                                        ' Where nr_sequencia = '||nr_sequencia_w ||
                                                                        ' and cd_tributo = ' || cd_tributo_nf_w;*/
                                        ds_comando_w    :=      'select '|| nm_atributo_w ||' vl_retorno_w From Nota_fiscal_venc_Trib '||
                                                                ' Where nr_sequencia = :nr_sequencia'||
                                                                ' and cd_tributo = :cd_tributo'||
                                                                ' and dt_vencimento = :dt_vencimento';
                                        ds_param_sql_w  :=      'nr_sequencia=' || nr_sequencia_w ||
                                                                ';cd_tributo=' || cd_tributo_nf_w ||
                                                                ';dt_vencimento=' || dt_vencimento_w;
                                end if;

                                vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, ds_param_sql_w, vl_retorno_w);

                                if (vl_retorno_w IS NOT NULL AND vl_retorno_w::text <> '') and (vl_retorno_w <> 0) then
                                        cd_estab_movto_w        := cd_estabelecimento_w;

                                        if (ie_contab_nf_estab_w = 'EF') and (coalesce(ie_tipo_ordem_w,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then

                                                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                                        if (ie_debito_credito_w = 'D') then
                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                        end if;
                                                else
                                                        if (ie_debito_credito_w = 'C') then
                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                        end if;
                                                end if;
                                        end if;

                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                nr_seq_trans_fin,
                                                cd_cgc,
                                                cd_pessoa_fisica,
                                                nr_documento,
                                                ie_transitorio,
                                                cd_estabelecimento,
                                                ie_origem_documento,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nm_tabela,
                                                nm_atributo,
                                                nr_seq_info,
                                                ie_intercompany,
                                                nr_seq_classif_movto,
                                                cd_estab_intercompany,
                                                cd_sequencia_parametro,
												nr_codigo_controle,
                                                nr_seq_proj_rec
                                                )
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_movto_w,
                                                cd_conta_contabil_w,
                                                ie_debito_credito_w,
                                                cd_historico_w,
                                                dt_movimento_w,
                                                vl_retorno_w,
                                                cd_centro_custo_w,
                                                ds_compl_historico_w,
                                                ds_doc_agrupamento_w,
                                                nr_seq_agrupamento_w,
                                                null,
                                                cd_cgc_w,
                                                cd_pessoa_fisica_w,
                                                nr_documento_w,
                                                'N',
                                                cd_estab_movto_w,
                                                1,
                                                nr_sequencia_w,
                                                null,
                                                CASE WHEN ie_corpo_venc_w='C' THEN 'NOTA_FISCAL_TRIB' WHEN ie_corpo_venc_w='V' THEN 'NOTA_FISCAL_VENC_TRIB' END ,
                                                substr(nm_atributo_w,1,50),
                                                nr_seq_info_ctb_w,
                                                ie_intercompany_w,
                                                nr_seq_classif_movto_w,
                                                cd_estab_intercompany_w,
                                                cd_sequencia_parametro_w,
												nr_codigo_controle_w,
                                                nr_seq_proj_rec_w
                                                );

                                        if (ie_debito_credito_w = 'D') then
                                                vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_retorno_w,0);
                                        elsif (ie_debito_credito_w = 'C') then
                                                vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_retorno_w, 0);
                                        end if;
                                end if;
                        end loop;
                        close c040;

                        ds_tributo_w    := '';

                        /* tributos dos itens da nota */

                        ds_tributo_w    := '';
                        cd_centro_custo_evento_w := null;
                        open c030;
                        loop
                        fetch c030 into
                                nm_atributo_w,
                                ie_debito_credito_w,
                                ie_origem_conta_w,
                                cd_conta_contabil_w,
                                cd_centro_custo_w,
                                cd_historico_w,
                                ie_origem_centro_w,
                                nr_item_nf_w,
                                cd_conta_contabil_nf_w,
                                cd_centro_custo_nf_w,
                                cd_material_w,
                                cd_local_estoque_w,
                                cd_procedimento_w,
                                ie_origem_proced_w,
                                cd_tributo_w,
                                ie_contabiliza_rateio_trib_w,
                                cd_natureza_operacao_w,
                                nr_seq_classif_movto_w,
                                nr_seq_proj_rec_w,
								cd_sequencia_parametro_nf_w;
                        EXIT WHEN NOT FOUND; /* apply on c030 */
                                cd_centro_custo_evento_w := null;
                                cd_sequencia_parametro_w := null;
                                if (ie_origem_centro_w = '1') then

                                        cd_centro_custo_evento_w := cd_centro_custo_w;
                                end if;

                                ds_material_w   := substr(obter_desc_material(cd_material_w),1,255);

                                if (ie_origem_conta_w = '1' ) and (coalesce(cd_conta_contabil_w,'0') <> '0') then

                                        cd_conta_contabil_w := cd_conta_contabil_w;
                                end if;

                                if      (ie_origem_conta_w not in ('1','7')   and
                                        ((coalesce(cd_centro_custo_nf_w::text, '') = '') or (coalesce(cd_conta_contabil_nf_w::text, '') = ''))) then
                                        cd_centro_custo_w       := cd_centro_custo_nf_w;
                                        SELECT * FROM SELECT * FROM define_conta_contabil(  ie_origem_conta_w, cd_estabelecimento_w, null, null, ie_tipo_convenio_w, cd_convenio_w, cd_material_w, cd_procedimento_w, ie_origem_proced_w, cd_local_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, wheb_mensagem_pck.get_texto(795576) || ' ' || nr_nota_fiscal_w || ' ' || wheb_mensagem_pck.get_texto(795579) || ' ' || nr_sequencia_w || ' ' || wheb_mensagem_pck.get_texto(795581) || ' ' || nm_atributo_w, dt_movimento_w, null, null, vetor_nf[z].cd_operacao_nf, cd_natureza_operacao_w, null, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
                                        cd_sequencia_parametro_w := philips_contabil_pck.get_parametro_conta_contabil();

                                else
                                        if (ie_origem_conta_w <> '1') then

                                            cd_conta_contabil_w      := cd_conta_contabil_nf_w;
                                            cd_centro_custo_w        := cd_centro_custo_nf_w;
											cd_sequencia_parametro_w := cd_sequencia_parametro_nf_w;
                                        end if;
                                end if;

                                if (ie_origem_conta_w = '7') then

                                        select  coalesce(max(cd_conta_contabil), cd_conta_contabil_w)
                                        into STRICT    cd_conta_contabil_w
                                        from    tributo_conta_contabil
                                        where   cd_cgc          = cd_cgc_w
                                        and     cd_tributo      = cd_tributo_w
                                        and     cd_empresa      = cd_empresa_w
                                        and (coalesce(dt_inicio_vigencia, dt_movimento_w) <= dt_movimento_w and coalesce(dt_fim_vigencia, dt_movimento_w) >= dt_movimento_w);
                                end if;

                                ds_compl_historico_w            := substr(nr_nota_fiscal_w || ' ' || ds_razao_social_w,1,255);

                                if (ie_analitico_sintetico_w = 'A') then
                                        ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' (' || nr_sequencia_w || ')',1,255);
                                end if;

                                        /*anderson - 24/06/2006 - os 35685*/

                                if (ie_nf_entrada_saida_w = 'E') and (ie_contab_pac_nf_w <> 'N') then
                                        if (ie_contab_pac_nf_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'C') and (ie_nf_consignado_w = 'S') and (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '') then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' || nm_paciente_w,1,255);
                                        elsif (ie_contab_pac_nf_w = 'O') and (ie_nf_consignado_w = 'S') and
                                                ((ds_observacao_nf_w IS NOT NULL AND ds_observacao_nf_w::text <> '') or (nm_paciente_w IS NOT NULL AND nm_paciente_w::text <> '')) then
                                                ds_compl_historico_w    :=  substr(ds_compl_historico_w || ' Pac: ' ||
                                                                                                        coalesce(nm_paciente_w,ds_observacao_nf_w),1,255);
                                        end if;
                                end if;

                                if (ie_acao_nf_w = '2') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(728461) || ' ',1,255);

                                        if (ie_debito_credito_w = 'D') then
                                                ie_debito_credito_w     := 'C';
                                        else
                                                ie_debito_credito_w     := 'D';
                                        end if;
                                elsif (ie_acao_nf_w = '1') and (ie_situacao_w = '3') then
                                        ds_compl_historico_w    := substr(ds_compl_historico_w || ' ' || wheb_mensagem_pck.get_texto(795499) || ' ',1,255);
                                end if;

                                begin
                                select  ie_centro_custo
                                into STRICT    ie_centro_custo_w
                                from    conta_contabil
                                where   cd_conta_contabil       = cd_conta_contabil_w;
                                exception
                                when others then
                                        ie_centro_custo_w       := 'N';
                                end;

                                if (ie_centro_custo_w = 'N') then
                                        cd_centro_custo_nf_w    := null;
                                end if;

                                /*ds_comando_w    :=    'select '|| nm_atributo_w ||
                                                        ' vl_retorno_w From Nota_fiscal_item_trib '||
                                                        'Where nr_sequencia = '|| nr_sequencia_w||
                                                        '  and nr_item_nf   = '|| nr_item_nf_w ||
                                                        '  and cd_tributo   = '|| cd_tributo_w;*/
                                ds_comando_w    :=      'select '|| nm_atributo_w || ' vl_retorno_w From Nota_fiscal_item_trib '||
                                                        'Where nr_sequencia = :nr_sequencia'||
                                                        '  and nr_item_nf   = :nr_item_nf'||
                                                        '  and cd_tributo   = :cd_tributo';
                                ds_param_sql_w  :=      'nr_sequencia=' || nr_sequencia_w ||
                                                        ';nr_item_nf=' || nr_item_nf_w ||
                                                        ';cd_tributo=' || cd_tributo_w;

                                vl_retorno_w := obter_valor_dinamico_bv(ds_comando_w, ds_param_sql_w, vl_retorno_w);

                                select  substr(max(ds_tributo),1,100)
                                into STRICT    ds_tributo_w
                                from    tributo
                                where   cd_tributo      = cd_tributo_w;

                                if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      nr_nota_fiscal_w                        || '#@' ||
                                                                        ds_razao_social_w                       || '#@' ||
                                                                        to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                        nm_paciente_w                           || '#@' ||
                                                                        nr_sequencia_w                          || '#@' ||
                                                                        dt_vencto_w                             || '#@' ||
                                                                        ds_observacao_nf_w                      || '#@' ||
                                                                                                                  ' #@' ||
                                                                        ie_estorno_w                            || '#@' ||
                                                                        nr_documento_desp_w                     || '#@' ||
                                                                        ds_situacao_w                           || '#@' ||
                                                                        substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                        ds_estorno_w                            || '#@' ||
                                                                        to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                        nr_atendimento_w                        || '#@' ||
                                                                        nr_interno_conta_w                      || '#@' ||
                                                                        nr_nfe_imp_w                            || '#@' ||
                                                                        nm_estabelecimento_w                    || '#@' ||
                                                                        nr_rps_w                                || '#@' ||
                                                                        ds_material_w                           || '#@' ||
                                                                        cd_unidade_medida_compra_w              || '#@' ||
                                                                        cd_unidade_medida_estoque_w             || '#@' ||
                                                                        qt_item_nf_w                            || '#@' ||
                                                                        qt_item_estoque_w                       || '#@' ||
                                                                        nr_sequencia_movto_w                    || '#@' ||
                                                                        ds_tributo_w                            || '#@' ||
                                                                        nr_ordem_compra_w                       || '#@' ||
                                                                        ie_nf_nfe_w                             || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                        ds_titulos_receber_nf_w                 || '#@' ||
                                                                        cd_cgc_w                                || '#@' ||
                                                                        cd_pessoa_fisica_w                      || '#@' ||
                                                                        ds_consignado_w                         || '#@' ||
                                                                        ds_operacao_nf_w                        || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        null                                    || '#@' ||
                                                                        nr_seq_nota_orig_w                      || '#@' ||
                                                                        nr_nota_orig_w                          || '#@' ||
                                                                        cd_serie_nf_orig_w                      || '#@' ||
                                                                        nr_nfe_imp_orig_w,1,4000);

                                        select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_w, ds_conteudo_w)
                                        into STRICT    ds_compl_historico_ww
;

                                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                end if;

                                select  count(nr_sequencia) qt_item_trib
                                into STRICT    qt_item_trib_w
                                from    fis_rateio_trib_item
                                where   nr_seq_nota_fiscal = nr_sequencia_w
                                and     nr_item_nf = nr_item_nf_w
                                and     cd_tributo = cd_tributo_w;

                                if (coalesce(qt_item_trib_w, 0) > 0) and (ie_origem_centro_w = 2) and (coalesce(ie_contabiliza_rateio_trib_w,'X') = 'S') then
                                        open c090;
                                        loop
                                        fetch c090 into
                                                cd_centro_custo_item_trib_w,
                                                vl_rateio_item_trib_w;
                                        EXIT WHEN NOT FOUND; /* apply on c090 */

                                                if (coalesce(vl_rateio_item_trib_w, 0) <> 0) then
                                                        cd_estab_movto_w        := cd_estabelecimento_w;
                                                end if;
                                                if (ie_contab_nf_estab_w = 'EF') and (coalesce(ie_tipo_ordem_w,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                                                        if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                                                        if (ie_debito_credito_w = 'D') then
                                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                                        end if;
                                                                else
                                                                        if (ie_debito_credito_w = 'C') then
                                                                                cd_estab_movto_w        := cd_estab_financeiro_w;
                                                                        end if;
                                                                end if;
                                                end if;

                                                nr_sequencia_movto_w            := nr_sequencia_movto_w + 1;

                                                insert into w_movimento_contabil(nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        nr_seq_trans_fin,
                                                        cd_cgc,
                                                        cd_pessoa_fisica,
                                                        nr_documento,
                                                        ie_transitorio,
                                                        cd_estabelecimento,
                                                        ie_origem_documento,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        ie_intercompany,
                                                        cd_estab_intercompany,
                                                        cd_sequencia_parametro,
														nr_codigo_controle,
                                                        nr_seq_proj_rec
                                                        )
                                                values (nr_lote_contabil_p,
                                                        nr_sequencia_movto_w,
                                                        cd_conta_contabil_w,
                                                        ie_debito_credito_w,
                                                        cd_historico_w,
                                                        dt_movimento_w,
                                                        vl_rateio_item_trib_w,
                                                        cd_centro_custo_item_trib_w,
                                                        ds_compl_historico_w,
                                                        ds_doc_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        cd_cgc_w,
                                                        cd_pessoa_fisica_w,
                                                        nr_documento_w,
                                                        'N',
                                                        cd_estab_movto_w,
                                                        1,
                                                        nr_sequencia_w,
                                                        null,
                                                        'FIS_RATEIO_TRIB_ITEM',
                                                        substr(nm_atributo_w,1,50),
                                                        nr_seq_info_ctb_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w,
                                                        cd_sequencia_parametro_w,
														nr_codigo_controle_w,
                                                        nr_seq_proj_rec_w
                                                        );
                                        end loop;
                                        close c090;
                                else
                                        if (vl_retorno_w IS NOT NULL AND vl_retorno_w::text <> '') and (vl_retorno_w <> 0) then
                                                cd_estab_movto_w        := cd_estabelecimento_w;
                                                nr_sequencia_movto_w            := nr_sequencia_movto_w + 1;
                                                if (ie_contab_nf_estab_w = 'EF') and (coalesce(ie_tipo_ordem_w,'X') <> 'T') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_financeiro_w <> cd_estabelecimento_w) then
                                                        if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                                                if (ie_debito_credito_w = 'D') then
                                                                        cd_estab_movto_w        := cd_estab_financeiro_w;
                                                                end if;
                                                        else
                                                                if (ie_debito_credito_w = 'C') then
                                                                        cd_estab_movto_w        := cd_estab_financeiro_w;
                                                                end if;
                                                        end if;
                                                end if;
                                                nr_sequencia_movto_w            := nr_sequencia_movto_w + 1;

                                                insert into w_movimento_contabil(nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        nr_seq_trans_fin,
                                                        cd_cgc,
                                                        cd_pessoa_fisica,
                                                        nr_documento,
                                                        ie_transitorio,
                                                        cd_estabelecimento,
                                                        ie_origem_documento,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        ie_intercompany,
                                                        nr_seq_classif_movto,
                                                        cd_estab_intercompany,
                                                        cd_sequencia_parametro,
														nr_codigo_controle,
                                                        nr_seq_proj_rec
                                                        )
                                                values (nr_lote_contabil_p,
                                                        nr_sequencia_movto_w,
                                                        cd_conta_contabil_w,
                                                        ie_debito_credito_w,
                                                        cd_historico_w,
                                                        dt_movimento_w,
                                                        vl_retorno_w,
                                                        CASE WHEN ie_origem_centro_w='3' THEN  null WHEN ie_origem_centro_w='1' THEN cd_centro_custo_evento_w  ELSE cd_centro_custo_nf_w END ,
                                                        ds_compl_historico_w,
                                                        ds_doc_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        cd_cgc_w,
                                                        cd_pessoa_fisica_w,
                                                        nr_documento_w,
                                                        'N',
                                                        cd_estab_movto_w,
                                                        1,
                                                        nr_sequencia_w,
                                                        null,
                                                        'NOTA_FISCAL_ITEM_TRIB',
                                                        substr(nm_atributo_w,1,50),
                                                        nr_seq_info_ctb_w,
                                                        ie_intercompany_w,
                                                        nr_seq_classif_movto_w,
                                                        cd_estab_intercompany_w,
                                                        cd_sequencia_parametro_w,
														nr_codigo_controle_w,
                                                        nr_seq_proj_rec_w
                                                        );

                                        end if;
                                end if;
                                if (ie_debito_credito_w = 'D') then
                                        vl_transf_debito_w      := vl_transf_debito_w + coalesce(vl_retorno_w,0);
                                elsif (ie_debito_credito_w = 'C') then
                                        vl_transf_credito_w     := vl_transf_credito_w + coalesce(vl_retorno_w, 0);
                                end if;
                        end loop;
                        close c030;

                        cd_centro_custo_evento_w := null;
                        ds_tributo_w    := '';

                        /* fabio 06/07/2004 para gravar as despesas adicionais*/

                        open c060;
                        loop
                        fetch c060 into
                                vl_documento_desp_w,
                                nr_documento_desp_w,
                                cd_conta_contabil_desp_w,
                                ds_razao_despesa_w,
                                cd_cgc_desp_w;
                        EXIT WHEN NOT FOUND; /* apply on c060 */
                                nr_sequencia_movto_w            := nr_sequencia_movto_w + 1;
                                ie_debito_credito_w             := 'C';
                                cd_sequencia_parametro_w        := null;

                                if (ie_acao_nf_w = '2') then
                                        ie_debito_credito_w     := 'D';
                                end if;

                                ds_historico_desp_w     := substr(nr_nota_fiscal_w || ' ' || 'Desp ' || nr_documento_desp_w || ' ' || ds_razao_despesa_w,1,255);

                                ds_material_w           := '';
                                if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      nr_nota_fiscal_w                || '#@' ||
                                                                ds_razao_despesa_w                      || '#@' ||
                                                                to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                nm_paciente_w                           || '#@' ||
                                                                nr_sequencia_w                          || '#@' ||
                                                                dt_vencto_w                             || '#@' ||
                                                                ds_observacao_nf_w                      || '#@' ||
                                                                                                          ' #@' ||
                                                                ie_estorno_w                            || '#@' ||
                                                                nr_documento_desp_w                     || '#@' ||
                                                                ds_situacao_w                           || '#@' ||
                                                                substr(ds_titulos_pagar_nf_w,1,255)     || '#@' ||
                                                                ds_estorno_w                            || '#@' ||
                                                                to_char(dt_emissao_w,'dd/mm/yyyy')      || '#@' ||
                                                                nr_atendimento_w                        || '#@' ||
                                                                nr_interno_conta_w                      || '#@' ||
                                                                nr_nfe_imp_w                            || '#@' ||
                                                                nm_estabelecimento_w                    || '#@' ||
                                                                nr_rps_w                                || '#@' ||
                                                                ds_material_w                           || '#@' ||
                                                                cd_unidade_medida_compra_w              || '#@' ||
                                                                cd_unidade_medida_estoque_w             || '#@' ||
                                                                qt_item_nf_w                            || '#@' ||
                                                                qt_item_estoque_w                       || '#@' ||
                                                                nr_sequencia_movto_w                    || '#@' ||
                                                                ds_tributo_w                            || '#@' ||
                                                                nr_ordem_compra_w                       || '#@' ||
                                                                ie_nf_nfe_w                             || '#@' ||
                                                                null                                    || '#@' ||
                                                                ds_pessoa_nota_fiscal_w                 || '#@' ||
                                                                ds_titulos_receber_nf_w                 || '#@' ||
                                                                cd_cgc_w                                || '#@' ||
                                                                cd_pessoa_fisica_w                      || '#@' ||
                                                                ds_consignado_w                         || '#@' ||
                                                                ds_operacao_nf_w                        || '#@' ||
                                                                null                                    || '#@' ||
                                                                null                                    || '#@' ||
                                                                nr_seq_nota_orig_w                      || '#@' ||
                                                                nr_nota_orig_w                          || '#@' ||
                                                                cd_serie_nf_orig_w                      || '#@' ||
                                                                nr_nfe_imp_orig_w,1,4000);
                                        select  obter_compl_historico(cd_tipo_lote_contabil_nota_w, cd_historico_w, ds_conteudo_w)
                                        into STRICT    ds_compl_historico_ww
;

                                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                                end if;

                                if (coalesce(cd_conta_contabil_desp_w,'0') = '0') then
                                        cd_conta_contabil_desp_w        := obter_conta_contab_pj(cd_empresa_w, cd_estabelecimento_w, cd_cgc_desp_w, 'P',dt_movimento_w);
                                end if;

                                if (coalesce(cd_conta_contabil_desp_w,'0') <> '0') then
                                        insert into w_movimento_contabil(nr_lote_contabil,
                                                nr_sequencia,
                                                cd_conta_contabil,
                                                ie_debito_credito,
                                                cd_historico,
                                                dt_movimento,
                                                vl_movimento,
                                                cd_centro_custo,
                                                ds_compl_historico,
                                                ds_doc_agrupamento,
                                                nr_seq_agrupamento,
                                                nr_seq_trans_fin,
                                                cd_cgc,
                                                cd_pessoa_fisica,
                                                nr_documento,
                                                ie_transitorio,
                                                ie_origem_documento,
                                                nr_seq_tab_orig,
                                                nr_seq_tab_compl,
                                                nm_tabela,
                                                nm_atributo,
                                                nr_seq_info,
                                                ie_intercompany,
                                                cd_estab_intercompany,
                                                cd_sequencia_parametro,
												nr_codigo_controle,
                                                nr_seq_proj_rec
                                                )
                                        values (nr_lote_contabil_p,
                                                nr_sequencia_movto_w,
                                                cd_conta_contabil_desp_w,
                                                ie_debito_credito_w,
                                                cd_historico_w,
                                                dt_movimento_w,
                                                vl_documento_desp_w,
                                                null,
                                                ds_historico_desp_w,
                                                ds_doc_agrupamento_w,
                                                nr_seq_agrupamento_w,
                                                null,
                                                cd_cgc_w,
                                                cd_pessoa_fisica_w,
                                                nr_documento_w,
                                                'N',
                                                1,
                                                nr_sequencia_w,
                                                null,
                                                'NOTA_FISCAL_DESP_ADIC',
                                                'VL_DOCUMENTO',
                                                nr_seq_info_ctb_w,
                                                ie_intercompany_w,
                                                cd_estab_intercompany_w,
                                                null,
												nr_codigo_controle_w,
                                                null
                                                );

                                end if;
                        end loop;
                        close c060;

                        if (ie_permite_estab_dif_w = 'PCCT') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (ie_contab_nf_estab_w = 'EF') and (coalesce(ie_tipo_ordem_w,'X') <> 'T') and (cd_estab_financeiro_w <> cd_estabelecimento_w ) then
                                ie_deb_cred_transit_w   := 'C';
                                vl_retorno_w            := vl_transf_debito_w;

                                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                        ie_deb_cred_transit_w   := 'D';
                                        vl_retorno_w            := vl_transf_credito_w;
                                end if;

                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                ie_deb_cred_transit_w   := 'D';
                                vl_retorno_w            := vl_transf_credito_w;

                                if (ie_acao_nf_w = '2') or (ie_nf_entrada_saida_w = 'S') then
                                        ie_deb_cred_transit_w   := 'C';
                                        vl_retorno_w            := vl_transf_debito_w;
                                end if;

                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estab_financeiro_w, cd_conta_transitoria_w, cd_historico_ct_w);

                        end if;
                end if;
        end loop;
end loop;

IF (PKG_I18N.GET_USER_LOCALE = 'es_BO' AND ie_exclusao_p = 'N') THEN
        BEGIN
                CALL CTB_REGRAS_CONTABIL.CTB_GERAR_CD_CONTROLE_NF(nr_lote_contabil_p, nm_usuario_p);
        EXCEPTION WHEN OTHERS THEN
                CALL ctb_gravar_log_lote(nr_lote_contabil_p, 1, SQLERRM, nm_usuario_p);
        END;
END IF;

CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);

if (coalesce(ds_retorno_p::text, '') = '') then
        update  lote_contabil
        set     ie_situacao     = 'A',
                dt_geracao_lote = clock_timestamp()
        where   nr_lote_contabil        = nr_lote_contabil_p;

        if (ie_exclusao_p = 'S') then
                ds_retorno_p            := wheb_mensagem_pck.get_texto(165188);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        2,
                                        '',
                                        nm_usuario_p);
        else
                ds_retorno_p            := wheb_mensagem_pck.get_texto(165187);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        1,
                                        '',
                                        nm_usuario_p);
        end if;
  commit;
else
        rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_nota_fiscal (nr_lote_contabil_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, ie_exclusao_p text) FROM PUBLIC;

