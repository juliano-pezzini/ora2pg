-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_update_sinal_vital ( nr_atendimento_p bigint, nm_usuario_p text, qt_pa_diastolica_p bigint, qt_pa_sistolica_p bigint, ie_pressao_p text, qt_freq_cardiaca_p bigint, qt_freq_resp_p bigint, qt_temp_p bigint, cd_pessoa_fisica_p text, cd_escala_dor_p text, qt_escala_dor_p bigint, qt_pam_p bigint, ie_exige_liberacao_p text, nr_sequencia_p INOUT bigint, qt_altura_cm_p bigint default null, qt_peso_p bigint default null, qt_glicemia_capilar_p bigint default null, qt_saturacao_o2_p bigint default null, ie_membro_p text default null, ie_sitio_p bigint default null, dt_sinal_vital_p timestamp default null, qt_o2_suplementar_p bigint default null, qt_insulina_p bigint default null, qt_pvc_p bigint default null, qt_pvc_cm_p bigint default null, qt_pressao_intra_cranio_p bigint default null, ds_observacao_p text default null, ie_nivel_consciencia_p text default null, ie_unid_med_o2_suplem_p text default null, qt_bcf_p bigint default null, qt_bcf2_p bigint default null, qt_bcf3_p bigint default null, ie_rn_p text default 'N', qt_temp_incubadora_p bigint default null, ie_nivel_conf_dor_p bigint default null) AS $body$
DECLARE



dt_liberacao_w	timestamp	:= null;
nr_sequencia_w	bigint;
qt_horas_passado_sv_w	double precision;
nr_regras_atendidas_w	varchar(2000);


BEGIN

select 	coalesce(max(qt_horas_passado_sv),0)
into STRICT	qt_horas_passado_sv_w
from	parametro_medico
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (dt_sinal_vital_p > clock_timestamp()) or
	(qt_horas_passado_sv_w > 0 and dt_sinal_vital_p	< clock_timestamp() - (qt_horas_passado_sv_w/24) ) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(15222,	'QT_HR_PASSADO_SV='||qt_horas_passado_sv_w);
end if;

if (ie_exige_liberacao_p = 'S') then
	dt_liberacao_w := clock_timestamp();
end if;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	update	atendimento_sinal_vital set
		nr_atendimento    	    = nr_atendimento_p, 
		dt_atualizacao    	    = clock_timestamp(),  
		nm_usuario        	    = nm_usuario_p,
		nm_usuario_nrec         = nm_usuario_p,
		qt_pa_diastolica  	    = qt_pa_diastolica_p, 
		qt_pa_sistolica   	    = qt_pa_sistolica_p,  
		ie_pressao        	    = ie_pressao_p,  
		qt_freq_cardiaca  	    = qt_freq_cardiaca_p,  
		qt_freq_resp      	    = qt_freq_resp_p,  
		qt_temp           	    = qt_temp_p,  
		cd_pessoa_fisica  	    = cd_pessoa_fisica_p,  
		cd_escala_dor     	    = cd_escala_dor_p,  
		qt_escala_dor     	    = qt_escala_dor_p,  
		qt_pam            	    = qt_pam_p,
		dt_liberacao		    = dt_liberacao_w,
		qt_altura_cm		    = qt_altura_cm_p,
		qt_peso			        = qt_peso_p,
		qt_glicemia_capilar     = qt_glicemia_capilar_p,
		qt_saturacao_o2		    = qt_saturacao_o2_p,
		IE_MEMBRO		        = coalesce(IE_MEMBRO_p,'MSE'),
		ie_sitio		        = ie_sitio_p,
		dt_sinal_vital		    = coalesce(coalesce(dt_sinal_vital_p,dt_sinal_vital),clock_timestamp()),
		qt_o2_suplementar	    = qt_o2_suplementar_p,
		qt_insulina		        = qt_insulina_p,
		qt_pvc			        = qt_pvc_p,
		qt_pvc_h2o		        = qt_pvc_cm_p,
		qt_pressao_intra_cranio	= qt_pressao_intra_cranio_p,
		ds_observacao			= ds_observacao_p,
		ie_nivel_consciencia    = ie_nivel_consciencia_p,
		ie_unid_med_o2_suplem	= ie_unid_med_o2_suplem_p,
		qt_bcf                  = qt_bcf_p,
		qt_bcf_2                = qt_bcf2_p,
		qt_bcf_3                = qt_bcf3_p,
		ie_rn					= ie_rn_p,
		qt_temp_incubadora      = qt_temp_incubadora_p,
		ie_nivel_conf_dor       = ie_nivel_conf_dor_p
	where 	nr_sequencia		= nr_sequencia_p;
	
	if ((coalesce(nr_sequencia_p, 0) > 0) and (coalesce(nr_atendimento_p, 0) > 0) and (coalesce(ie_exige_liberacao_p, 'N') = 'S')) then
				begin
					CALL gerar_lanc_automatico_tabela(nr_atendimento_p,412,upper('ATENDIMENTO_SINAL_VITAL'),nr_sequencia_p,nm_usuario_p);
					nr_regras_atendidas_w := GQA_Liberacao_Sinal_Vital(nr_sequencia_p, nm_usuario_p);
					CALL gera_protocolo_assistencial(nr_atendimento_p, nm_usuario_p);
				exception
				when others then
					null;
				end;
	end if;
else
	select 	nextval('atendimento_sinal_vital_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into atendimento_sinal_vital(
                nr_sequencia,  
                nr_atendimento,  
                dt_sinal_vital,  
                dt_atualizacao ,  
                nm_usuario,  
				nm_usuario_nrec,
                qt_pa_diastolica,  
                qt_pa_sistolica,  
                ie_pressao,  
                qt_freq_cardiaca,  
                qt_freq_resp,  
                qt_temp,  
                cd_pessoa_fisica,  
                cd_escala_dor  ,  
                qt_escala_dor ,  
				dt_liberacao,
                qt_pam,
				ie_situacao,
				qt_glicemia_capilar,
				qt_peso,
				qt_altura_cm,
				qt_saturacao_o2,
				IE_MEMBRO,
				ie_sitio,
				qt_o2_suplementar,
				qt_insulina,
				qt_pvc,
				qt_pvc_h2o,
				qt_pressao_intra_cranio,
				ds_observacao,
				ie_nivel_consciencia,
				ie_unid_med_o2_suplem,
				qt_bcf,
				qt_bcf_2,
				qt_bcf_3,
				ie_rn,
				qt_temp_incubadora,
				ie_nivel_conf_dor,
				cd_perfil_ativo)
	values ( 
                nr_sequencia_w,
                nr_atendimento_p, 
                coalesce(dt_sinal_vital_p,clock_timestamp()), 
                clock_timestamp(), 
                nm_usuario_p,
				nm_usuario_p,				
                qt_pa_diastolica_p, 
                qt_pa_sistolica_p, 
                ie_pressao_p, 
                qt_freq_cardiaca_p,
                qt_freq_resp_p, 
                qt_temp_p, 
                cd_pessoa_fisica_p, 
                cd_escala_dor_p, 
                qt_escala_dor_p, 
				dt_liberacao_w,
                qt_pam_p,
				'A',
				qt_glicemia_capilar_p,
				qt_peso_p,
				qt_altura_cm_p,
				qt_saturacao_o2_p,
				coalesce(IE_MEMBRO_p,'MSE'),
				ie_sitio_p,
				qt_o2_suplementar_p,
				qt_insulina_p,
				qt_pvc_p,
				qt_pvc_cm_p,
				qt_pressao_intra_cranio_p,
				ds_observacao_p,
				ie_nivel_consciencia_p,
				ie_unid_med_o2_suplem_p,
				qt_bcf_p,
				qt_bcf2_p,
				qt_bcf3_p,
				ie_rn_p,
				qt_temp_incubadora_p,
				ie_nivel_conf_dor_p,
				obter_perfil_ativo);

	if ((coalesce(nr_sequencia_w, 0) > 0) and (coalesce(nr_atendimento_p, 0) > 0) and (coalesce(ie_exige_liberacao_p, 'N') = 'S')) then
				begin
					CALL gerar_lanc_automatico_tabela(nr_atendimento_p,412,upper('ATENDIMENTO_SINAL_VITAL'),nr_sequencia_w,nm_usuario_p);
					nr_regras_atendidas_w := GQA_Liberacao_Sinal_Vital(nr_sequencia_w, nm_usuario_p);
					CALL gera_protocolo_assistencial(nr_atendimento_p, nm_usuario_p);
				exception
				when others then
					null;
				end;
	end if;

end if;
		
nr_sequencia_p := nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_update_sinal_vital ( nr_atendimento_p bigint, nm_usuario_p text, qt_pa_diastolica_p bigint, qt_pa_sistolica_p bigint, ie_pressao_p text, qt_freq_cardiaca_p bigint, qt_freq_resp_p bigint, qt_temp_p bigint, cd_pessoa_fisica_p text, cd_escala_dor_p text, qt_escala_dor_p bigint, qt_pam_p bigint, ie_exige_liberacao_p text, nr_sequencia_p INOUT bigint, qt_altura_cm_p bigint default null, qt_peso_p bigint default null, qt_glicemia_capilar_p bigint default null, qt_saturacao_o2_p bigint default null, ie_membro_p text default null, ie_sitio_p bigint default null, dt_sinal_vital_p timestamp default null, qt_o2_suplementar_p bigint default null, qt_insulina_p bigint default null, qt_pvc_p bigint default null, qt_pvc_cm_p bigint default null, qt_pressao_intra_cranio_p bigint default null, ds_observacao_p text default null, ie_nivel_consciencia_p text default null, ie_unid_med_o2_suplem_p text default null, qt_bcf_p bigint default null, qt_bcf2_p bigint default null, qt_bcf3_p bigint default null, ie_rn_p text default 'N', qt_temp_incubadora_p bigint default null, ie_nivel_conf_dor_p bigint default null) FROM PUBLIC;

