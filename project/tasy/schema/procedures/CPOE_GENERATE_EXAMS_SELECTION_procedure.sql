-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_generate_exams_selection ( nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_proc_estrutura_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, cd_medico_p text, ds_procedimentos_assoc_p text, ie_gerar_associado_p char, nr_seq_item_gerado_p INOUT bigint, nr_seq_cpoe_order_unit_p bigint, ie_urgencia_p text default null, nr_seq_contraste_p bigint default null) AS $body$
DECLARE

				

ds_stack_w 					log_cpoe.ds_stack%type;
ds_log_cpoe_w 				log_cpoe.ds_log%type;
cd_procedimento_w 			procedimento.cd_procedimento%type;
ie_origem_proced_w 			procedimento.ie_origem_proced%type;
cd_intervalo_w 				intervalo_prescricao.cd_intervalo%type;
qt_hora_intervalo_w 		prescr_procedimento.qt_hora_intervalo%type;
qt_min_intervalo_w 			prescr_procedimento.qt_min_intervalo%type;
nr_seq_prot_glic_w 			pep_protocolo_glicemia.nr_sequencia%type;
ie_excluir_proc_princ_w 	proc_interno.ie_excluir_proc_princ%type;
ie_tipo_proc_interno_w 		proc_interno.ie_tipo%type;
ie_ctrl_glic_w 				proc_interno.ie_ctrl_glic%type;
ds_obs_aux_w 				proc_interno.ds_observacao%type;
ie_copiar_rep_w 			proc_interno.ie_copiar_rep%type;
nr_seq_exame_lab_w 			proc_interno.nr_seq_exame_lab%type;
nr_sequencia_w 				cpoe_procedimento.nr_sequencia%type;
nr_ocorrencia_w       		double precision;
ds_horarios_w         		varchar(4000);
ds_mat_adic_proc_w    		varchar(14);
dt_prev_execucao_w    		timestamp;
si_leave_department_w		varchar(1) := null;
ds_locale_user_w	    establishment_locale.ds_locale%type;
ie_administracao_w			exame_regra_cpoe.ie_administracao%type;
dt_inicio_p			cpoe_procedimento.dt_inicio%type;


BEGIN
SELECT 	MAX(ie_tipo),
		coalesce(MAX(ie_ctrl_glic),'NC'),
		coalesce(MAX(ie_excluir_proc_princ),'N'),
		MAX(ds_observacao),
		MAX(nr_seq_prot_glic),
		coalesce(MAX(ie_copiar_rep),'S'),
		MAX(nr_seq_exame_lab)
INTO STRICT 	ie_tipo_proc_interno_w,
		ie_ctrl_glic_w,
		ie_excluir_proc_princ_w,
		ds_obs_aux_w,
		nr_seq_prot_glic_w,
		ie_copiar_rep_w,
		nr_seq_exame_lab_w
FROM 	proc_interno
WHERE 	nr_sequencia = nr_seq_proc_interno_p;

SELECT  COALESCE(c.cd_procedimento, a.cd_procedimento, x.cd_procedimento),
		COALESCE(c.ie_origem_proced, a.ie_origem_proced, x.ie_origem_proced),
		NULL
INTO STRICT    cd_procedimento_w,
		ie_origem_proced_w,
		cd_intervalo_w
FROM proc_interno x
LEFT OUTER JOIN exame_laboratorio a ON (x.nr_seq_exame_lab = a.nr_seq_exame)
LEFT OUTER JOIN exame_lab_convenio c ON (a.nr_seq_exame = c.nr_seq_exame AND cd_convenio_p = c.cd_convenio)
WHERE clock_timestamp() BETWEEN coalesce(c.dt_inicio_vigencia, clock_timestamp()) AND coalesce(c.dt_fim_vigencia, clock_timestamp()) AND (coalesce(c.ie_tipo_atendimento::text, '') = ''
OR 		c.ie_tipo_atendimento = ie_tipo_atendimento_p)  AND x.nr_sequencia = nr_seq_proc_interno_p AND (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '');

IF (ie_urgencia_p = 'S') THEN
	cd_intervalo_w     := Obter_interv_acm_sn_agora_lib( cd_estabelecimento_p, 1, 2, 'P', cd_procedimento_w, cd_intervalo_w, 0, ie_origem_proced_w, NULL);
	dt_prev_execucao_w := clock_timestamp() + interval '1 days'/1440;
	ds_horarios_w      := TO_CHAR(clock_timestamp() + interval '1 days'/1440,'hh24:mi');
END IF;

select 	nextval('cpoe_procedimento_seq')
into STRICT 	nr_sequencia_w
;

nr_seq_item_gerado_p := nr_sequencia_w;

ds_locale_user_w := pkg_i18n.get_user_locale;
if (ds_locale_user_w = 'ja_JP') then
	select max(si_leave_department)
	into STRICT si_leave_department_w
	from proc_interno
	where nr_sequencia = nr_seq_proc_interno_p;

	ie_administracao_w := obter_campo_exame_regra_cpoe(nr_seq_proc_interno_p, cd_setor_atendimento_p, 'A');
	
end if;

select obter_procedure_rule(cd_setor_atendimento_p,  nr_atendimento_p, ie_tipo_atendimento_p, nr_seq_cpoe_order_unit_p)
into STRICT dt_inicio_p
;

if (coalesce(dt_inicio_p::text, '') = '') then
    dt_inicio_p := clock_timestamp();
end if;
			
insert into cpoe_procedimento(
		
			nr_sequencia,
			qt_procedimento,
			ds_horarios,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_urgencia,
			dt_prev_execucao,
			nr_atendimento,
			nr_ocorrencia,
			nr_seq_proc_interno,
			nr_seq_topografia,
			nr_seq_prot_glic,
			ie_duracao,
			ie_periodo,
			dt_inicio,
			ds_justificativa,
			hr_prim_horario,
			dt_liberacao,
			nr_seq_cpoe_anterior,
			cd_perfil_ativo,
			cd_pessoa_fisica,
			cd_funcao_origem,
			cd_medico,
			nr_seq_condicao,
			nr_seq_contraste,
			cd_setor_atendimento,
			nr_seq_proc_rotina,
			nr_seq_proc_estrutura,
			nr_seq_cpoe_order_unit,
			si_leave_department,
			ie_administracao)
		 	 
values (		nr_sequencia_w,
			coalesce(null, 1),
			ds_horarios_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_intervalo_w,
			clock_timestamp(),
			nm_usuario_p,
			ie_urgencia_p,
			dt_prev_execucao_w,
			nr_atendimento_p,
			nr_ocorrencia_w,
			nr_seq_proc_interno_p,
			null,
			nr_seq_prot_glic_w,
			coalesce(null, 'P'),
			null,
			dt_inicio_p,
			null,
			to_char(dt_prev_execucao_w,'hh24:mi'),
			null,
			null,
			cd_perfil_p,
			cd_paciente_p,
			2314,
			cd_medico_p,
			null,
			nr_seq_contraste_p,
			cd_setor_atendimento_p,
			null,
			CASE WHEN nr_seq_proc_estrutura_p=0 THEN  null  ELSE nr_seq_proc_estrutura_p END ,
			nr_seq_cpoe_order_unit_p,
			si_leave_department_w,
			coalesce(ie_administracao_w, 'P'));
	
CALL cpoe_copy_order_unit_fields(nr_sequencia_w,'P', nr_seq_cpoe_order_unit_p);

commit;

CALL cpoe_consis_proced_insert(nr_sequencia_w,nm_usuario_p);
if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
  CALL cpoe_gerar_proc_glic( nr_sequencia_w, nr_seq_prot_glic_w, nm_usuario_p, nr_atendimento_p, cd_paciente_p, 'S', nr_seq_proc_interno_p);
  CALL cpoe_gerar_proc_glic_assoc(nr_atendimento_p,nr_sequencia_w,nr_seq_prot_glic_w,nm_usuario_p);
end if;
if (ds_procedimentos_assoc_p IS NOT NULL AND ds_procedimentos_assoc_p::text <> '') then
	CALL insert_cpoe_proced_adicional(ds_procedimentos_assoc_p, nr_sequencia_w, nr_atendimento_p, 'S', nm_usuario_p);
end if;
if (ie_gerar_associado_p = 'S') then
  ds_mat_adic_proc_w    := 'X';
  ds_mat_adic_proc_w := cpoe_gerar_med_mat_assoc( nr_atendimento_p, nr_sequencia_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, cd_setor_atendimento_p, ie_tipo_atendimento_p, cd_convenio_p, cd_medico_p, dt_prev_execucao_w, cd_intervalo_w, ie_urgencia_p, qt_hora_intervalo_w /* qt_hora_intervalo_p */
, qt_min_intervalo_w /* qt_min_intervalo_p */
, ds_horarios_w, nr_ocorrencia_w, ds_mat_adic_proc_w, nr_seq_contraste_p);
end if;
CALL cpoe_gerar_prescr_proc_assoc(nr_sequencia_w, nm_usuario_p, cd_estabelecimento_p);
CALL cpoe_gerar_exame_lab_dep(nr_sequencia_w, nr_atendimento_p, cd_estabelecimento_p, cd_setor_atendimento_p, '10,', nm_usuario_p, null, null);

COMMIT;

EXCEPTION
WHEN OTHERS THEN
  ROLLBACK;
  ds_stack_w    := SUBSTR('Backtrace: '|| dbms_utility.format_error_backtrace || ' CallStack: '|| dbms_utility.format_call_stack,1,2000);
  ds_log_cpoe_w := SUBSTR(
    'CPOE_GENERATE_EXAMS_SELECTION '
    || chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
    || chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
    || chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
    || chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
    || chr(13) || ' - cd_setor_atendimento_p: ' || cd_setor_atendimento_p
    || chr(13) || ' - ie_tipo_atendimento_p: ' || ie_tipo_atendimento_p
    || chr(13) || ' - cd_convenio_p: ' || cd_convenio_p
    || chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
    || chr(13) || ' - qt_idade_dia_p: ' || qt_idade_dia_p
    || chr(13) || ' - qt_idade_mes_p: ' || qt_idade_mes_p
    || chr(13) || ' - qt_idade_ano_p: ' || qt_idade_ano_p
    || chr(13) || ' - cd_medico_p: ' || cd_medico_p
    || chr(13) || ' - ie_gerar_associado_p: ' || ie_gerar_associado_p
    || chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
    || chr(13) || ' - ERRO: ' || sqlerrm
    || chr(13) || ' - FUNCAO('||TO_CHAR(obter_funcao_ativa)||'); PERFIL('||TO_CHAR(obter_perfil_ativo)||')',1,2000);
  INSERT
  INTO log_cpoe(
      nr_sequencia,
      nr_atendimento,
      dt_atualizacao,
      nm_usuario,
      ds_log,
      ds_stack
    )
    VALUES (
      nextval('log_cpoe_seq'),
      nr_atendimento_p,
      clock_timestamp(),
      nm_usuario_p,
      ds_log_cpoe_w,
      ds_stack_w
    );

  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_generate_exams_selection ( nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_proc_estrutura_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, cd_medico_p text, ds_procedimentos_assoc_p text, ie_gerar_associado_p char, nr_seq_item_gerado_p INOUT bigint, nr_seq_cpoe_order_unit_p bigint, ie_urgencia_p text default null, nr_seq_contraste_p bigint default null) FROM PUBLIC;

