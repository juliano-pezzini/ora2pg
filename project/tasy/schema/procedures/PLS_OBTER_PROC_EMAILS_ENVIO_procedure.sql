-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_proc_emails_envio ( qt_emails_selecoinar_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_process_p INOUT bigint) AS $body$
DECLARE


nr_seq_process_w			pls_email.nr_seq_processamento%type;
tb_nr_seq_process_w			pls_util_cta_pck.t_number_table;
tb_nr_seq_parametro_w			pls_util_cta_pck.t_number_table;
qt_registro_w				bigint;
ip_servidor_envio_w			varchar(30);
qt_emails_selecionar_w 			bigint;

c01 CURSOR FOR
	SELECT	nr_seq_email,
		nr_seq_parametro
	from (	SELECT	a.nr_sequencia	nr_seq_email,
			pls_obter_seq_param_email(a.ie_origem, a.cd_perfil, a.nm_usuario_nrec, a.cd_estabelecimento) nr_seq_parametro
		from	pls_email		a
		where	a.ie_status		= 'P'
		and	a.cd_estabelecimento	= cd_estabelecimento_p
		order by coalesce(a.cd_prioridade,5),a.nr_sequencia asc) alias2
	where	(nr_seq_parametro IS NOT NULL AND nr_seq_parametro::text <> '')  LIMIT (qt_emails_selecionar_w);

/*
Prioridade
1               Imediata
2               Alta prioridade
3               Media prioridade
4               Baixa prioridade
5               Sem prioridade
*/
BEGIN
qt_emails_selecionar_w	:= coalesce(qt_emails_selecoinar_p,1000);

select	count(1)
into STRICT	qt_registro_w
from	pls_email		a,
	pls_email_parametros	b
where	b.ie_origem		= a.ie_origem
and	b.cd_estabelecimento	= a.cd_estabelecimento
and	b.ie_situacao		= 'A'
and	a.ie_status		= 'P'
and	a.cd_estabelecimento	= cd_estabelecimento_p;

--Verifica se tem email pendente
if (qt_registro_w > 0) then
	select	nextval('pls_email_process_seq')
	into STRICT	nr_seq_process_w
	;
	
	select	SYS_CONTEXT('USERENV','IP_ADDRESS')
	into STRICT	ip_servidor_envio_w
	;
	
	--Limpa a tabela
	tb_nr_seq_process_w.delete;
	tb_nr_seq_parametro_w.delete;
	
	open c01;
	loop
	fetch c01 bulk collect into tb_nr_seq_process_w , tb_nr_seq_parametro_w
	limit pls_util_pck.qt_registro_transacao_w;
	exit when tb_nr_seq_process_w.count = 0;
		
		forall i in tb_nr_seq_process_w.first..tb_nr_seq_process_w.last
			update	pls_email
			set	ie_status		= 'EP',
				nr_seq_processamento	= nr_seq_process_w,
				nm_usuario		= nm_usuario_p,
				nr_seq_parametros	= tb_nr_seq_parametro_w(i),
				ds_servidor_envio	= ip_servidor_envio_w
			where	nr_sequencia		= tb_nr_seq_process_w(i);
		commit;
		
	end loop;
	close c01;
end if;
--Limpa a tabela
tb_nr_seq_process_w.delete;
tb_nr_seq_parametro_w.delete;

--retorna sequencial de processamento
nr_seq_process_p := nr_seq_process_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_proc_emails_envio ( qt_emails_selecoinar_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_process_p INOUT bigint) FROM PUBLIC;

