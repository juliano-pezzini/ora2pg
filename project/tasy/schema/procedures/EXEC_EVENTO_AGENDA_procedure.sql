-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE exec_evento_agenda ( ie_evento_p text, ie_agenda_p text, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_status_p text default null, cd_agenda_p bigint default null, cd_setor_atendimento_p bigint default null, ie_classif_agenda_p text default null) AS $body$
DECLARE


ie_existe_evento_w		varchar(1);
ie_tipo_atendimento_w		smallint;
cd_convenio_w			integer;
nr_atendimento_w		agenda_paciente.nr_atendimento%type;
ie_classif_agenda_w     	agenda_consulta.ie_classif_agenda%type;
ie_status_agenda_w		agenda_consulta.ie_status_agenda%type;
cd_perfil_w			bigint;
ie_gerar_fim_consulta_w		varchar(1);


BEGIN
	ie_gerar_fim_consulta_w := obter_param_usuario(281, 817, Obter_perfil_Ativo, nm_usuario_p, 0, ie_gerar_fim_consulta_w);

	if (ie_agenda_p in ('CI','E')) then
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from	agenda_paciente
		where	nr_sequencia = nr_seq_agenda_p;
	elsif (ie_agenda_p in ('C','S')) then
		select	max(nr_atendimento),
			max(coalesce(ie_classif_agenda,'0'))
		into STRICT	nr_atendimento_w,
			ie_classif_agenda_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;
	end if;

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		ie_tipo_atendimento_w 	:= obter_tipo_atendimento(nr_atendimento_w);
		cd_convenio_w		:= Obter_Convenio_Atendimento(nr_atendimento_w);
		cd_perfil_w		:= obter_perfil_ativo;
		
	end if;

	if (ie_evento_p IS NOT NULL AND ie_evento_p::text <> '') and (ie_agenda_p IS NOT NULL AND ie_agenda_p::text <> '') then
		begin

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_existe_evento_w
			from	status_evento_agenda a
			where (a.cd_estabelecimento = cd_estabelecimento_p or exists (SELECT 1 
											from STATUS_EVENTO_AGENDA_ESTAB x 
											where x.cd_estabelecimento = cd_estabelecimento_p 
											and a.nr_sequencia 	   = x.nr_seq_status_evento_ag ))
			and	a.ie_evento = ie_evento_p
			and (coalesce(a.ie_evolucao_clinica::text, '') = '')
			and (coalesce(a.cd_perfil::text, '') = '' or a.cd_perfil = cd_perfil_w)
			and	((a.ie_agenda = ie_agenda_p) or (a.ie_agenda = 'T'))
			and (coalesce(a.cd_agenda::text, '') = '' or coalesce(cd_agenda_p::text, '') = '' or a.cd_agenda = cd_agenda_p)
			and (coalesce(a.ie_tipo_atendimento::text, '') = '' or a.ie_tipo_atendimento = ie_tipo_atendimento_w)
			and (coalesce(a.cd_setor_atendimento::text, '') = '' or a.cd_setor_atendimento = cd_setor_atendimento_p)
			and (coalesce(a.cd_convenio::text, '') = '' or a.cd_convenio = cd_convenio_w)
			and 	((coalesce(a.ie_classif_agenda::text, '') = '') or (a.ie_classif_agenda = ie_classif_agenda_w) or (a.ie_classif_agenda = ie_classif_agenda_p));

			if (ie_existe_evento_w = 'S') then
				begin
				CALL executar_evento_agenda(ie_evento_p, ie_agenda_p, nr_seq_agenda_p, cd_estabelecimento_p, nm_usuario_p, null, null, ie_status_p);

				if (ie_agenda_p = 'C') then
					select	max(ie_status_agenda)
					into STRICT	ie_status_agenda_w
					from	agenda_consulta
					where	nr_sequencia = nr_seq_agenda_p;

					if (ie_status_agenda_w = 'E' and (ie_gerar_fim_consulta_w IS NOT NULL AND ie_gerar_fim_consulta_w::text <> '') and ie_gerar_fim_consulta_w = 'S') then
						begin
						update	atendimento_paciente
						set		dt_fim_consulta = clock_timestamp()
						where	nr_atendimento = nr_atendimento_w;

						commit;
						exception when others then
							ie_status_agenda_w := null;
						end;
					end if;
				end if;
				end;
			end if;
		end;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exec_evento_agenda ( ie_evento_p text, ie_agenda_p text, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_status_p text default null, cd_agenda_p bigint default null, cd_setor_atendimento_p bigint default null, ie_classif_agenda_p text default null) FROM PUBLIC;

