-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_local_refeicao ( cd_setor_atendimento_p bigint, dt_dieta_p timestamp, cd_refeicao_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE

 
dt_dieta_w		timestamp;
nr_sequencia_w		bigint;
cd_pessoa_fisica_w		varchar(10);
ie_destino_dieta_w	varchar(1);
nr_seq_superior_w	bigint;
ie_somente_dieta_princ_w	varchar(1)	:= 'N';
nr_atendimento_w	bigint;
ie_obs_atend_atual_w	varchar(1)	:= 'N';
NR_SEQ_LOCAL_REF_W	bigint;
c01 CURSOR FOR
SELECT	nr_sequencia, 
	cd_pessoa_fisica, 
	ie_destino_dieta, 
	nr_seq_superior, 
	nr_atendimento 
FROM	mapa_dieta 
WHERE	cd_setor_atendimento	=	cd_setor_atendimento_p 
AND	dt_dieta		=	TRUNC(dt_dieta_p,'dd') 
AND	cd_refeicao		=	cd_refeicao_p;


BEGIN 
 
OPEN c01;
LOOP 
FETCH c01 INTO 
	nr_sequencia_w, 
	cd_pessoa_fisica_w, 
	ie_destino_dieta_w, 
	nr_seq_superior_w, 
	nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
	BEGIN	 
 
	BEGIN 
	SELECT	MAX(NR_SEQ_LOCAL_REF) 
	INTO STRICT	NR_SEQ_LOCAL_REF_W 
	FROM	mapa_dieta 
	WHERE	cd_pessoa_fisica	= 	cd_pessoa_fisica_w 
	AND	ie_destino_dieta	= 	ie_destino_dieta_w	 
	AND	cd_refeicao		=	cd_refeicao_p 
	AND	dt_dieta		=	(	SELECT	TRUNC(MAX(a.dt_dieta),'dd') 
							FROM	atendimento_paciente b, 
								mapa_dieta a 
							WHERE	b.nr_atendimento	= a.nr_atendimento 
							AND	a.cd_pessoa_fisica	= cd_pessoa_fisica_w 
							AND	ie_destino_dieta	= 	ie_destino_dieta_w 
							AND (dt_dieta		< dt_dieta_p) 
							AND	a.cd_refeicao		= cd_refeicao_p);
	EXCEPTION 
	WHEN OTHERS THEN 
		NR_SEQ_LOCAL_REF_W	:= NULL;
	END;
 
 
	UPDATE	mapa_dieta 
	SET	NR_SEQ_LOCAL_REF	= NR_SEQ_LOCAL_REF_W 
	WHERE	nr_sequencia		= nr_sequencia_w 
	AND	coalesce(NR_SEQ_LOCAL_REF::text, '') = '';
 
	END;
END LOOP;
CLOSE c01;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_local_refeicao ( cd_setor_atendimento_p bigint, dt_dieta_p timestamp, cd_refeicao_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

