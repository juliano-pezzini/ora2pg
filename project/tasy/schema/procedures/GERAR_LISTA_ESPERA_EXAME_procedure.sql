-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lista_espera_exame ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
dt_solicitacao_w		timestamp;
cd_pessoa_fisica_w		varchar(10);
cd_convenio_w			bigint;
cd_categoria_w			varchar(10);
cd_plano_w				varchar(10);
nr_telefone_w			varchar(10);
cd_profissional_w		varchar(10);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;

C01 CURSOR FOR
	SELECT	cd_procedimento,
			ie_origem_proced
	from	pedido_exame_externo_item
	where	nr_seq_pedido = nr_sequencia_p;


BEGIN
if (nr_sequencia_p > 0) then
	open C01;
	loop
	fetch C01 into
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	nextval('agenda_lista_espera_seq')
		into STRICT	nr_sequencia_w
		;

		select	max(dt_solicitacao),
				max(cd_pessoa_fisica),
				max(obter_convenio_atendimento(nr_atendimento)),
				max(Obter_Categoria_Atendimento(nr_atendimento)),
				max(Obter_Plano_Atendimento(nr_atendimento,'C')),
				max(cd_profissional)
		into STRICT	dt_solicitacao_w,
				cd_pessoa_fisica_w,
				cd_convenio_w,
				cd_categoria_w,
				cd_plano_w,
				cd_profissional_w
		from	pedido_exame_externo
		where	nr_sequencia = nr_sequencia_p;

		select	max(nr_telefone_celular)
		into STRICT	nr_telefone_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;

		insert into agenda_lista_espera(
								nr_sequencia,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_atualizacao,
								nm_usuario,
								dt_agendamento,
								nm_usuario_agenda,
								ie_status_espera,
								cd_pessoa_fisica,
								cd_convenio,
								cd_categoria,
								cd_plano,
								nr_telefone,
								cd_medico_exec,
								cd_procedimento,
								ie_origem_proced)
				values (			nr_sequencia_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								dt_solicitacao_w,
								nm_usuario_p,
								'A',
								cd_pessoa_fisica_w,
								cd_convenio_w,
								cd_categoria_w,
								cd_plano_w,
								nr_telefone_w,
								cd_profissional_w,
								cd_procedimento_w,
								ie_origem_proced_w);

		end;
	end loop;
	close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lista_espera_exame ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

