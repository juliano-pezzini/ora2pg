-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diverg_inspecao_oc ( nr_seq_registro_p bigint, nr_seq_inspecao_p bigint, ie_evento_p text, nm_usuario_p text) AS $body$
DECLARE



/*ie_evento_p
L - Ao liberar a inspecao
S - Ao salvar o item da inspecao*/
qt_inspecao_w			inspecao_recebimento.qt_inspecao%type;
vl_unitario_material_w		inspecao_recebimento.vl_unitario_material%type;
cd_condicao_pagamento_w		inspecao_recebimento.cd_condicao_pagamento%type;
cd_material_w			inspecao_recebimento.cd_material%type;
nr_seq_marca_w			inspecao_recebimento.nr_seq_marca%type;
dt_entrega_real_w		inspecao_recebimento.dt_entrega_real%type;
qt_item_oci_w			ordem_compra_item.qt_material%type;
vl_item_oci_w			ordem_compra_item.vl_unitario_material%type;
cd_cond_pagto_ordem_w		ordem_compra.cd_condicao_pagamento%type;
cd_material_oci_w		ordem_compra_item.cd_material%type;
nr_seq_marca_oci_w		ordem_compra_item.nr_seq_marca%type;
dt_entrega_oci_w		ordem_compra_item_entrega.dt_prevista_entrega%type;
nr_ordem_compra_w		ordem_compra.nr_ordem_compra%type;
nr_item_oci_w			ordem_compra_item.nr_item_oci%type;
nr_seq_inspecao_w		inspecao_recebimento.nr_sequencia%type;
nr_seq_regra_w			regra_diverg_ins_oc.nr_sequencia%type;
cd_local_estoque_w		regra_diverg_ins_oc.cd_local_estoque%type;
cd_grupo_material_w		regra_diverg_ins_oc.cd_grupo_material%type;
cd_subgrupo_material_w		regra_diverg_ins_oc.cd_subgrupo_material%type;
cd_classe_material_w		regra_diverg_ins_oc.cd_classe_material%type;
cd_material_regra_w		regra_diverg_ins_oc.cd_material%type;
pr_diferenca_w			regra_diverg_ins_oc.pr_diferenca%type;
qt_diferenca_w			regra_diverg_ins_oc.qt_diferenca%type;
ie_tipo_regra_w			regra_diverg_ins_oc.ie_tipo_regra%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_cnpj_w			pessoa_juridica.cd_cgc%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
	cd_local_estoque,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	pr_diferenca,
	coalesce(qt_diferenca,0),
	ie_tipo_regra
from	regra_diverg_ins_oc
where	ie_considerar_regra = 'S'
and	cd_estabelecimento = cd_estabelecimento_w
and	((coalesce(cd_cnpj_w::text, '') = '') or
	((cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') and (obter_se_restringe_div_ins_oc(nr_sequencia,cd_cnpj_w) = 'S')))
and	((ie_evento_p = 'L') or
	(ie_evento_p = 'S' AND ie_consiste_salvar_item = 'S'));

c02 CURSOR FOR
SELECT	coalesce(b.qt_inspecao,0),
	coalesce(b.vl_unitario_material,0),
	b.cd_condicao_pagamento,
	b.cd_material,
	b.nr_seq_marca,
	b.dt_entrega_real,
	coalesce(obter_qt_prev_oci_inspecao(b.nr_sequencia),0) qt_item_oci,
	coalesce(round((obter_valor_unitario_oci(b.nr_ordem_compra, b.nr_item_oci))::numeric,4),0) vl_item_oci,
	substr(obter_dados_ordem_compra(b.nr_ordem_compra,'CP'),1,80) cd_cond_pagto_ordem,
	substr(obter_dados_item_ordem(b.nr_ordem_compra, b.nr_item_oci,'MAT'),1,10) cd_material_oci,
	substr(obter_dados_item_ordem(b.nr_ordem_compra, b.nr_item_oci,'MAR'),1,10) nr_seq_marca_oci,
	obter_dt_prev_oci_inspecao(b.nr_sequencia) dt_entrega_oci,
	b.nr_ordem_compra,
	b.nr_item_oci,
	b.nr_sequencia
from	inspecao_registro a,
	inspecao_recebimento b,
	estrutura_material_v e
where	a.nr_sequencia = b.nr_seq_registro
and	b.cd_material = e.cd_material
and	a.nr_sequencia = nr_seq_registro_p
and	((e.cd_grupo_material = cd_grupo_material_w) or (coalesce(cd_grupo_material_w,0) = 0))
and	((e.cd_subgrupo_material = cd_subgrupo_material_w) or (coalesce(cd_subgrupo_material_w,0) = 0))
and	((e.cd_classe_material = cd_classe_material_w) or (coalesce(cd_classe_material_w,0) = 0))
and	((substr(obter_dados_item_ordem(b.nr_ordem_compra, b.nr_item_oci,'MAT'),1,10) = cd_material_regra_w) or (coalesce(cd_material_regra_w,0) = 0))
and	((coalesce(cd_local_estoque_w,0) = 0) or (obter_dados_item_ordem(b.nr_ordem_compra, b.nr_item_oci,'L') = cd_local_estoque_w))
and	((coalesce(nr_seq_inspecao_p,0) = 0) or
	((coalesce(nr_seq_inspecao_p,0) > 0) and (b.nr_sequencia = nr_seq_inspecao_p)))
and	b.nr_ordem_compra > 0;


BEGIN

delete from diverg_inspecao_ordem a
where a.nr_seq_registro = nr_seq_registro_p
and not exists (
	SELECT	1
	from	diverg_inspecao_oc_justif x
	where	x.nr_seq_divergencia = a.nr_sequencia);


select	wheb_usuario_pck.get_cd_estabelecimento
into STRICT	cd_estabelecimento_w
;

if (coalesce(nr_seq_registro_p,0) <> 0) then

	select	cd_cnpj
	into STRICT	cd_cnpj_w
	from	inspecao_registro
	where	nr_sequencia = nr_seq_registro_p;

elsif (coalesce(nr_seq_inspecao_p,0) <> 0) then

	select  cd_cgc
	into STRICT	cd_cnpj_w
	from	INSPECAO_RECEBIMENTO a
	where	a.nr_sequencia = nr_seq_inspecao_p;	
end if;


open C01;
loop
fetch C01 into	
	nr_seq_regra_w,
	cd_local_estoque_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_regra_w,
	pr_diferenca_w,
	qt_diferenca_w,
	ie_tipo_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	open c02;
	loop
	fetch c02 into
		qt_inspecao_w,
		vl_unitario_material_w,
		cd_condicao_pagamento_w,
		cd_material_w,
		nr_seq_marca_w,
		dt_entrega_real_w,
		qt_item_oci_w,
		vl_item_oci_w,
		cd_cond_pagto_ordem_w,
		cd_material_oci_w,
		nr_seq_marca_oci_w,
		dt_entrega_oci_w,
		nr_ordem_compra_w,
		nr_item_oci_w,
		nr_seq_inspecao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		/* --------------Especificacao do item------------------- */

		if (ie_tipo_regra_w = '1') and (cd_material_w <> cd_material_oci_w) then		
			inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
		end if;
		
		
		
		/* ----------Alteracao na condicao pagamento----- */
		
		if (ie_tipo_regra_w = '2') and (cd_condicao_pagamento_w <> cd_cond_pagto_ordem_w) then		
			inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
		end if;
		
		
		
		/* ----------- Atraso na entrega --------------- */
		
		if (ie_tipo_regra_w = '3') and (dt_entrega_real_w  > dt_entrega_oci_w) then
			inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
		end if;
		

        
		 ----------- Adiantamento na entrega --------------- 		
		if (ie_tipo_regra_w = '9') and 
			(dt_entrega_real_w  < (dt_entrega_oci_w - qt_diferenca_w)) then
			inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
		end if;

        
		
		/* --------------Alteracao na marca------------- */
		
		if (ie_tipo_regra_w = '4') and (coalesce(nr_seq_marca_w,0) <> coalesce(nr_seq_marca_oci_w,0)) then
			inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
		end if;
		
		
		
		/* ------------Alteracao na quantidade (a maior)--------- */
		
		if (ie_tipo_regra_w = '5') and (qt_inspecao_w > qt_item_oci_w) then
			
			if (pr_diferenca_w > 0) then
				qt_diferenca_w	:= round((dividir((qt_item_oci_w * pr_diferenca_w), 100))::numeric,4);
			end if;
		
			if (round((qt_diferenca_w + qt_item_oci_w)::numeric,4) < qt_inspecao_w) then			
				inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
			end if;
		end if;	

		

		/* ------------Alteracao na quantidade (a menor)--------- */
		
		if (ie_tipo_regra_w = '6') and (qt_inspecao_w < qt_item_oci_w) then
			
			if (pr_diferenca_w > 0) then
				qt_diferenca_w	:= round((dividir((qt_item_oci_w * pr_diferenca_w), 100))::numeric,4);
			end if;						
		
			if (round((abs(qt_diferenca_w - qt_item_oci_w))::numeric,4) > qt_inspecao_w) then
				inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
			end if;
		end if;
		
		
		
		/* ------------Alteracao no preco unitario (a maior)-------- */
		
		if (ie_tipo_regra_w = '7') and (vl_unitario_material_w > vl_item_oci_w) then
		
			if (pr_diferenca_w > 0) then
				qt_diferenca_w	:= round((dividir((vl_item_oci_w * pr_diferenca_w), 100))::numeric,4);
			end if;
		
			if	((round((qt_diferenca_w + vl_item_oci_w)::numeric,4) < vl_unitario_material_w) or
				((vl_unitario_material_w > vl_item_oci_w) and (abs(vl_unitario_material_w - vl_item_oci_w) > qt_diferenca_w))) then
				inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
			end if;
		end if;
		
		
		
		/* ------------Alteracao no preco unitario (a menor)-------- */
	
		if (ie_tipo_regra_w = '8') and (vl_unitario_material_w < vl_item_oci_w) then		
		
			if (pr_diferenca_w > 0) then
				qt_diferenca_w	:= round((dividir((vl_item_oci_w * pr_diferenca_w), 100))::numeric,4);
			end if;
		
			if	((round((qt_diferenca_w - vl_item_oci_w)::numeric,4) > vl_unitario_material_w) or
				((vl_unitario_material_w < vl_item_oci_w) and (abs(vl_unitario_material_w - vl_item_oci_w) > qt_diferenca_w))) then
				inserir_diverg_inspecao_ordem(cd_estabelecimento_w,nr_seq_registro_p,nr_seq_inspecao_w,nr_ordem_compra_w,nr_item_oci_w,ie_tipo_regra_w,nm_usuario_p,nr_seq_regra_w);
			end if;
		end if;		
		end;			
	end loop;
	close c02;	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diverg_inspecao_oc ( nr_seq_registro_p bigint, nr_seq_inspecao_p bigint, ie_evento_p text, nm_usuario_p text) FROM PUBLIC;

