-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_proced_laudo_ditado ( nr_seq_prescr_proc_p bigint, nm_usuario_p text ) AS $body$
DECLARE




nr_prescricao_w		bigint;
nr_seq_proc_w		bigint;
ds_arquivo_w		varchar(80);
ie_excluido_w		varchar(1);
nr_seq_laquite_w	bigint;
nr_seq_prproma_w	bigint;

ie_vincular_proced_w	varchar(10);

nr_seq_interno_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_seq_interno
	from	prescr_procedimento a
	where	a.nr_prescricao = nr_prescricao_w
	and	obter_se_contido(a.nr_seq_interno,
			Obter_Proced_Vinculados_Laudo(nr_prescricao_w,nr_seq_proc_w,ie_vincular_proced_w,nm_usuario_p)) = 'S'
	order by 1;


BEGIN

ie_vincular_proced_w := coalesce(Obter_Valor_Param_Usuario(28, 61, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

select	max(b.nr_prescricao),
	max(c.nr_sequencia),
	max(ds_arquivo),
	max(ie_excluido),
	max(nr_seq_laquite),
	max(nr_seq_prproma)
into STRICT	nr_prescricao_w,
	nr_seq_proc_w,
	ds_arquivo_w,
        ie_excluido_w,
        nr_seq_laquite_w,
	nr_seq_prproma_w
from	prescr_proc_ditado a,
	prescr_procedimento b,
	procedimento_paciente c
where	a.nr_seq_prescr_proc = b.nr_seq_interno
and	b.nr_prescricao	 = c.nr_prescricao
and	b.nr_sequencia = c.nr_sequencia_prescricao
and	nr_seq_prescr_proc = nr_seq_prescr_proc_p;


open C01;
loop
fetch C01 into
	nr_seq_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into prescr_proc_ditado(
		nr_sequencia,
		nr_seq_prescr_proc,
		dt_atualizacao,
		nm_usuario,
		ds_arquivo,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_excluido,
		nr_seq_laquite,
		nr_seq_prproma
		)
	values (	nextval('prescr_proc_ditado_seq'),
		nr_seq_interno_w,
		clock_timestamp(),
		nm_usuario_p,
		ds_arquivo_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_excluido_w,
		nr_seq_laquite_w,
		nr_seq_prproma_w );

	update	prescr_procedimento
	set	ie_status_execucao = '25',
		dt_atualizacao = clock_timestamp(),
		nm_usuario     = nm_usuario_p
	where	nr_seq_interno   = nr_seq_interno_w
	and	ie_status_execucao < '25';

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_proced_laudo_ditado ( nr_seq_prescr_proc_p bigint, nm_usuario_p text ) FROM PUBLIC;

