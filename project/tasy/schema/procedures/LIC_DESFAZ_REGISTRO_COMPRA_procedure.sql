-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_desfaz_registro_compra ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_ordem_compra_w				bigint;
qt_existe_w					bigint;
nr_seq_licitacao_w					bigint;

c01 CURSOR FOR 
SELECT	nr_ordem_compra 
from	ordem_compra 
where	nr_seq_reg_lic_compra = nr_sequencia_p;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	count(*) 
	into STRICT	qt_existe_w 
	from	ordem_compra 
	where	nr_ordem_compra = nr_ordem_compra_w 
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	 
	if (qt_existe_w > 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266183,'NR_ORDEM_COMPRA=' || nr_ordem_compra_w);
		--'A ordem de compra número ' || nr_ordem_compra_w || ' já está liberada. ' || 
		--'Portanto, não será mais possível desfazer esse registro de compras.'); 
	end if;
	 
	select	count(*) 
	into STRICT	qt_existe_w 
	from	ordem_compra_item_entrega 
	where	nr_ordem_compra = nr_ordem_compra_w 
	and	coalesce(qt_real_entrega,0) > 0;
	 
	if (qt_existe_w > 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266184,'NR_ORDEM_COMPRA=' || nr_ordem_compra_w);
		--'Já existe itens entregues na ordem de compra número ' || nr_ordem_compra_w || '. ' || 
		--'Portanto, não será mais possível desfazer esse registro de compras.'); 
	end if;
	 
	begin 
	delete from ordem_compra 
	where nr_ordem_compra = nr_ordem_compra_w;
	exception 
	when others then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266185,'DS_ERRO=' || SQLERRM(SQLSTATE));
		--'Erro ao desfazer registro de compra. ' || SQLERRM(sqlcode)); 
	end;	
	end;
end loop;
close C01;
 
update	reg_lic_compra 
set	dt_geracao_ordem_compra	= '', 
	nm_usuario_geracao_oc	= '' 
where	nr_sequencia		= nr_sequencia_p;
 
update	reg_lic_compra_item 
set	nr_ordem_compra = '' 
where	nr_seq_reg_lic_compra = nr_sequencia_p;
 
select	nr_seq_licitacao 
into STRICT	nr_seq_licitacao_w 
from	reg_lic_compra 
where	nr_sequencia		= nr_sequencia_p;
 
insert into reg_lic_historico( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	ie_tipo_historico, 
	ds_observacao, 
	nr_seq_licitacao) 
values (	nextval('reg_lic_historico_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	'DO', 
	Wheb_mensagem_pck.get_Texto(303627), /*'Desfeito a registro de compra.',*/
 
	nr_seq_licitacao_w);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_desfaz_registro_compra ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

