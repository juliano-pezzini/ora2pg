-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_pac_ext_afterpost_eup_js ( ie_novo_atend_lista_ag_p text, nr_seq_autorizacao_p bigint, ds_lista_age_serv_p text, ds_lista_age_cons_p text, ds_lista_age_exame_p text, ie_novo_atend_lista_age_p text, ie_novo_atend_cham_p text, nr_internacao_aghos_p bigint, nr_seq_atend_futuro_p bigint, ie_regra_lancto_auto_p text, ie_edicao_registro_p text, cd_pessoa_responsavel_p text, ie_carater_inter_sus_p text, nr_seq_checkup_p bigint, ie_novo_atend_checkup_p text, ie_classif_doenca_p text, ie_tipo_diagnostico_p bigint, cd_doenca_p text, nr_seq_pac_espera_p bigint, ie_tipo_convenio_p bigint, cd_pessoa_fisica_p text, ie_novo_registro_p text, ie_tipo_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, nr_seq_classificacao_p bigint, cd_tipo_agenda_p bigint, nr_seq_agenda_p bigint, cd_medico_resp_p text, nr_atendimento_p bigint, nm_usuario_p text, ie_retorno_cid_p INOUT text, ds_msg_cep_p INOUT text, ds_msg_idade_pagador_p INOUT text, ds_msg_informa_pagador_p INOUT text, ds_msg_vincula_agenda_p INOUT text, nr_seq_vincula_agenda_p INOUT bigint, ds_msg_auto_conve_perm_p INOUT text, ds_msg_auto_conve_p INOUT text, ie_perm_auto_conv_p INOUT text, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, qt_prescr_cult_positiva_p INOUT bigint, ds_msg_tempo_espera_atend_p INOUT text, ds_msg_fila_espera_p INOUT text, ie_atend_fila_espera_p INOUT text, qt_orc_pac_aprovado_p INOUT bigint, qt_cartao_fidel_p INOUT bigint, nr_prontuario_p INOUT bigint, ds_msg_laudo_preenchido_p INOUT text, cd_conv_atend_fut_p INOUT bigint, cd_categ_atend_fut_p INOUT text, cd_plano_convenio_p INOUT text, cd_usuario_convenio_p INOUT text, dt_validade_carteira_p INOUT timestamp, qt_dia_internacao_p INOUT bigint, dt_validade_cart_glosa_p INOUT timestamp, nr_doc_convenio_p INOUT text, cd_senha_p INOUT text, ds_msg_regra_carater_conv_p INOUT text, cd_carteirinha_p INOUT text, qt_prescr_pendente_p INOUT bigint, ds_msg_prescr_pendente_p INOUT text, ds_msg_exames_lab_p INOUT text, ie_permit_esp_p INOUT text, ds_msg_esp_quest_p INOUT text) AS $body$
DECLARE


ie_vincular_prescr_w		varchar(2);
qt_prescr_w			bigint;
cd_estabelecimento_w		smallint;
qt_exame_lab_w			bigint;
qt_dias_internacao_w		bigint;


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

qt_dias_internacao_w := Obter_param_Usuario(916, 99, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, qt_dias_internacao_w);
ie_vincular_prescr_w := Obter_param_Usuario(916, 722, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_vincular_prescr_w);

SELECT * FROM atend_pac_aftpost_comun_eup_js(nr_seq_autorizacao_p, ds_lista_age_serv_p, ds_lista_age_cons_p, ds_lista_age_exame_p, null, ie_novo_atend_lista_age_p, ie_novo_atend_cham_p, nr_internacao_aghos_p, nr_seq_atend_futuro_p, ie_regra_lancto_auto_p, ie_edicao_registro_p, cd_pessoa_responsavel_p, ie_carater_inter_sus_p, nr_seq_checkup_p, ie_novo_atend_checkup_p, ie_classif_doenca_p, ie_tipo_diagnostico_p, cd_medico_resp_p, cd_doenca_p, nr_seq_pac_espera_p, ie_tipo_convenio_p, cd_pessoa_fisica_p, nr_seq_classificacao_p, dt_entrada_p, ie_clinica_p, ie_tipo_atendimento_p, nr_atendimento_p, cd_tipo_agenda_p, nr_seq_agenda_p, ie_novo_registro_p, nm_usuario_p, null, ie_retorno_cid_p, ds_msg_cep_p, ds_msg_idade_pagador_p, ds_msg_informa_pagador_p, ds_msg_vincula_agenda_p, nr_seq_vincula_agenda_p, ds_msg_auto_conve_perm_p, ds_msg_auto_conve_p, ie_perm_auto_conv_p, cd_convenio_p, cd_categoria_p, qt_prescr_cult_positiva_p, ds_msg_tempo_espera_atend_p, ds_msg_fila_espera_p, ie_atend_fila_espera_p, qt_orc_pac_aprovado_p, qt_cartao_fidel_p, nr_prontuario_p, ds_msg_laudo_preenchido_p, cd_conv_atend_fut_p, cd_categ_atend_fut_p, cd_plano_convenio_p, cd_usuario_convenio_p, dt_validade_carteira_p, qt_dia_internacao_p, dt_validade_cart_glosa_p, nr_doc_convenio_p, cd_senha_p, ds_msg_regra_carater_conv_p, cd_carteirinha_p, ds_msg_esp_quest_p, ie_permit_esp_p) INTO STRICT ie_retorno_cid_p, ds_msg_cep_p, ds_msg_idade_pagador_p, ds_msg_informa_pagador_p, ds_msg_vincula_agenda_p, nr_seq_vincula_agenda_p, ds_msg_auto_conve_perm_p, ds_msg_auto_conve_p, ie_perm_auto_conv_p, cd_convenio_p, cd_categoria_p, qt_prescr_cult_positiva_p, ds_msg_tempo_espera_atend_p, ds_msg_fila_espera_p, ie_atend_fila_espera_p, qt_orc_pac_aprovado_p, qt_cartao_fidel_p, nr_prontuario_p, ds_msg_laudo_preenchido_p, cd_conv_atend_fut_p, cd_categ_atend_fut_p, cd_plano_convenio_p, cd_usuario_convenio_p, dt_validade_carteira_p, qt_dia_internacao_p, dt_validade_cart_glosa_p, nr_doc_convenio_p, cd_senha_p, ds_msg_regra_carater_conv_p, cd_carteirinha_p, ds_msg_esp_quest_p, ie_permit_esp_p;

if (ie_novo_registro_p = 'S') then

	if (ie_novo_atend_lista_ag_p = 'S') then
		CALL atualiza_atend_agexame(nr_atendimento_p, ds_lista_age_cons_p, nm_usuario_p);
		CALL atualiza_atend_agecons_Ageserv(nr_atendimento_p, ds_lista_age_cons_p, ds_lista_age_serv_p, nm_usuario_p);
	end if;

	if (ie_novo_atend_cham_p = 'S') and (coalesce(nr_seq_agenda_p,0) > 0) then
		if (cd_tipo_agenda_p = 2) then

			select	count(*)
			into STRICT	qt_prescr_pendente_p
			from	prescr_medica
			where	nr_seq_agenda = nr_seq_agenda_p
			and 	coalesce(nr_atendimento::text, '') = '';
			if (qt_prescr_pendente_p > 0) then
				if (ie_vincular_prescr_w = 'S') then
					CALL Atualiza_prescr_agendamento(nr_seq_agenda_p, nr_atendimento_p, nm_usuario_p);

				elsif (ie_vincular_prescr_w = 'Q') then
					ds_msg_prescr_pendente_p := substr(wheb_mensagem_pck.get_texto(94302, null),1,255);
				end if;
			end if;
		end if;
	end if;

	CALL enviar_comunic_atend(nr_atendimento_p, qt_dias_internacao_w, cd_pessoa_fisica_p, nm_usuario_p, cd_estabelecimento_w, ie_tipo_atendimento_p, qt_dias_internacao_w);
end if;

select	count(*)
into STRICT	qt_exame_lab_w
from	ageint_exame_lab a,
	agenda_integrada b
where	a.nr_seq_ageint = b.nr_sequencia
and	trunc(a.dt_prevista) = trunc(clock_timestamp())
and	b.cd_pessoa_fisica = cd_pessoa_fisica_p;

if (qt_exame_lab_w > 0) then
	ds_msg_exames_lab_p := substr(wheb_mensagem_pck.get_texto(286018, null),1,255);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_pac_ext_afterpost_eup_js ( ie_novo_atend_lista_ag_p text, nr_seq_autorizacao_p bigint, ds_lista_age_serv_p text, ds_lista_age_cons_p text, ds_lista_age_exame_p text, ie_novo_atend_lista_age_p text, ie_novo_atend_cham_p text, nr_internacao_aghos_p bigint, nr_seq_atend_futuro_p bigint, ie_regra_lancto_auto_p text, ie_edicao_registro_p text, cd_pessoa_responsavel_p text, ie_carater_inter_sus_p text, nr_seq_checkup_p bigint, ie_novo_atend_checkup_p text, ie_classif_doenca_p text, ie_tipo_diagnostico_p bigint, cd_doenca_p text, nr_seq_pac_espera_p bigint, ie_tipo_convenio_p bigint, cd_pessoa_fisica_p text, ie_novo_registro_p text, ie_tipo_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, nr_seq_classificacao_p bigint, cd_tipo_agenda_p bigint, nr_seq_agenda_p bigint, cd_medico_resp_p text, nr_atendimento_p bigint, nm_usuario_p text, ie_retorno_cid_p INOUT text, ds_msg_cep_p INOUT text, ds_msg_idade_pagador_p INOUT text, ds_msg_informa_pagador_p INOUT text, ds_msg_vincula_agenda_p INOUT text, nr_seq_vincula_agenda_p INOUT bigint, ds_msg_auto_conve_perm_p INOUT text, ds_msg_auto_conve_p INOUT text, ie_perm_auto_conv_p INOUT text, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, qt_prescr_cult_positiva_p INOUT bigint, ds_msg_tempo_espera_atend_p INOUT text, ds_msg_fila_espera_p INOUT text, ie_atend_fila_espera_p INOUT text, qt_orc_pac_aprovado_p INOUT bigint, qt_cartao_fidel_p INOUT bigint, nr_prontuario_p INOUT bigint, ds_msg_laudo_preenchido_p INOUT text, cd_conv_atend_fut_p INOUT bigint, cd_categ_atend_fut_p INOUT text, cd_plano_convenio_p INOUT text, cd_usuario_convenio_p INOUT text, dt_validade_carteira_p INOUT timestamp, qt_dia_internacao_p INOUT bigint, dt_validade_cart_glosa_p INOUT timestamp, nr_doc_convenio_p INOUT text, cd_senha_p INOUT text, ds_msg_regra_carater_conv_p INOUT text, cd_carteirinha_p INOUT text, qt_prescr_pendente_p INOUT bigint, ds_msg_prescr_pendente_p INOUT text, ds_msg_exames_lab_p INOUT text, ie_permit_esp_p INOUT text, ds_msg_esp_quest_p INOUT text) FROM PUBLIC;

