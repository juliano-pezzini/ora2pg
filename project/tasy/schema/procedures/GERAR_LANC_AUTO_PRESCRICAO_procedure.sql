-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lanc_auto_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_existe_regra_w			varchar(20);
ie_prescr_item_w			smallint;
nr_atendimento_w			bigint;
nr_prescricao_w				bigint;
nr_prescr_mae_w				bigint;
dt_prescricao_w				timestamp;
cd_setor_atend_w			integer;
cd_classif_setor_w			varchar(2);
nr_seq_atepacu_w			bigint;
qt_regras_w					bigint;
qt_regra_w					bigint;
qt_reg_w					bigint;
qt_regra_proc_w				bigint;
nr_seq_proc_w				bigint;
qt_regras_npt_w				bigint;
cd_recomendacao_w			bigint;
cd_dieta_w					bigint;
ie_gerar_passagem_setor_w 	varchar(1);
nr_seq_procedimento_w 		prescr_procedimento.nr_sequencia%type;
ds_alteracao_rastre_w		varchar(2000);
ie_info_rastre_prescr_w		varchar(1);

C01 CURSOR FOR
	SELECT	1,
			nr_atendimento,
			nr_prescricao,
			coalesce(nr_prescricao_mae,0),
			dt_prescricao,
			coalesce(a.cd_setor_entrega, a.cd_setor_atendimento),
			b.cd_classif_setor,
			null
	from	setor_atendimento b,
			prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p
	and		coalesce(a.cd_setor_entrega, a.cd_setor_atendimento) = b.cd_setor_atendimento
	
union

	SELECT	distinct
			2,
			a.nr_atendimento,
			a.nr_prescricao,
			coalesce(nr_prescricao_mae,0),
			a.dt_prescricao,
			b.cd_setor_atendimento,
			c.cd_classif_setor,
			b.nr_sequencia
	from	setor_atendimento c,
			prescr_procedimento b,
			prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_prescricao = b.nr_prescricao
	and		b.cd_setor_Atendimento = c.cd_setor_atendimento
	order by 1 desc;

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_procedimento
	where	nr_prescricao		= nr_prescricao_p
	and		coalesce(cd_setor_atendimento,0) = 0;

C03 CURSOR FOR
	SELECT	cd_recomendacao
	from	prescr_recomendacao
	where	nr_prescricao		= nr_prescricao_p
	order by cd_recomendacao;

C04 CURSOR FOR
	SELECT	cd_dieta
	from	prescr_dieta
	where	nr_prescricao		= nr_prescricao_p
	order by cd_dieta;


BEGIN

ie_gerar_passagem_setor_w := obter_param_usuario(924, 393, obter_perfil_ativo, nm_usuario_p, 0, ie_gerar_passagem_setor_w);
ie_info_rastre_prescr_w 	:= 'N';

select substr(obter_select_concatenado_bv('select distinct nr_seq_evento
					 from regra_lanc_automatico
					 where nr_seq_evento in (30,41,61,72,533)','',''),1,20)
into STRICT ie_existe_regra_w
;

select	count(*)
into STRICT	qt_regras_w
from	regra_lanc_automatico where		nr_seq_evento in (30,41,61,72,533)
and		ie_situacao = 'A' LIMIT 1;

RAISE NOTICE '%', ie_existe_regra_w;

ie_info_rastre_prescr_w := obter_se_info_rastre_prescr( ie_tipo_processo_p => 'RLA',
                                                        nm_usuario_p => nm_usuario_p,
                                                        cd_perfil_p => obter_perfil_ativo,
                                                        cd_estabelecimento_p => obter_estabelecimento_ativo);

if (ie_info_rastre_prescr_w = 'S') then
	ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
									' - nr_prescricao_p: ' || nr_prescricao_p || pls_util_pck.enter_w ||
									' - nm_usuario_p: ' || nm_usuario_p || pls_util_pck.enter_w ||
									' - ie_gerar_passagem_setor_w: ' || ie_gerar_passagem_setor_w || pls_util_pck.enter_w ||
									' - ie_existe_regra_w: ' || ie_existe_regra_w || pls_util_pck.enter_w ||
									' - qt_regras_w: ' || qt_regras_w, 1, 2000);
	CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                            nr_seq_item_p => null,
                            ie_agrupador_p => null,
                            nr_seq_horario_p => null,
                            ie_tipo_item_p => null,
                            ds_log_p => ds_alteracao_rastre_w,
                            nm_usuario_p => nm_usuario_p,
                            ie_commit_p => 'N');
end if;

if (qt_regras_w > 0) then

	open c01;
	loop
	fetch c01 into	ie_prescr_item_w,
			nr_atendimento_w,
			nr_prescricao_w,
			nr_prescr_mae_w,
			dt_prescricao_w,
			cd_setor_atend_w,
			cd_classif_setor_w,
			nr_seq_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

    if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
										' - ie_prescr_item_w: ' || ie_prescr_item_w || pls_util_pck.enter_w ||
										' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
										' - nr_prescricao_w: ' || nr_prescricao_w || pls_util_pck.enter_w ||
										' - nr_prescr_mae_w: ' || nr_prescr_mae_w || pls_util_pck.enter_w ||
										' - ie_existe_regra_w: ' || ie_existe_regra_w || pls_util_pck.enter_w ||
										' - cd_setor_atend_w: ' || cd_setor_atend_w || pls_util_pck.enter_w ||
										' - cd_classif_setor_w: ' || cd_classif_setor_w || pls_util_pck.enter_w ||
										' - nr_seq_procedimento_w: ' || nr_seq_procedimento_w, 1, 2000);
		CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                nr_seq_item_p => null,
                                ie_agrupador_p => null,
                                nr_seq_horario_p => null,
                                ie_tipo_item_p => null,
                                ds_log_p => ds_alteracao_rastre_w,
                                nm_usuario_p => nm_usuario_p,
                                ie_commit_p => 'N');
	end if;

		select	coalesce(max(nr_seq_interno),null)
		into STRICT	nr_seq_atepacu_w
		from	atend_paciente_unidade
		where	nr_atendimento 			= nr_atendimento_w
		and		cd_setor_atendimento		= cd_setor_atend_w;

		if	((coalesce(nr_seq_atepacu_w::text, '') = '') and (nr_atendimento_w > 0)) then

			if (ie_gerar_passagem_setor_w = 'S') then
				CALL Gerar_Passagem_Setor_Atend(nr_atendimento_w, cd_setor_atend_w, dt_prescricao_w, 'N', nm_usuario_p);
			end if;

			select	max(nr_seq_interno)
			into STRICT	nr_seq_atepacu_w
			from	atend_paciente_unidade
			where	nr_atendimento 			= nr_atendimento_w
			and		cd_setor_atendimento		= cd_setor_atend_w
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_entrada_unidade)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w);

		end if;

		if (nr_seq_atepacu_w IS NOT NULL AND nr_seq_atepacu_w::text <> '') then
			if (ie_prescr_item_w = 1) then
				if (nr_prescr_mae_w = 0) then
					begin
					select	count(*)
					into STRICT	qt_regra_w
					from	regra_lanc_automatico where		nr_seq_evento = 30 LIMIT 1;

					select	count(*)
					into STRICT	qt_regra_proc_w
					from	regra_lanc_automatico where		nr_seq_evento = 30
					and		coalesce(cd_area_procedimento::text, '') = ''
					and		coalesce(cd_especialidade_proc::text, '') = ''
					and		coalesce(cd_grupo_proc::text, '') = ''
					and		coalesce(cd_procedimento::text, '') = ''
					and		coalesce(cd_tipo_acomodacao::text, '') = ''
					and		coalesce(nr_seq_proc_interno::text, '') = ''
					and		coalesce(nr_seq_exame::text, '') = '' LIMIT 1;

					qt_reg_w	:= 1;

					if (qt_regra_proc_w = 0) then
						select	count(*)
						into STRICT	qt_reg_w
						from	prescr_procedimento where		nr_prescricao	= nr_prescricao_p LIMIT 1;
					end if;

					if (qt_regra_w > 0) and (qt_reg_w > 0) then

                        if (ie_info_rastre_prescr_w = 'S') then
							ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
															' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
															' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
															' - qt_regra_w: ' || qt_regra_w || pls_util_pck.enter_w ||
															' - qt_reg_w: ' || qt_reg_w, 1, 2000);
							CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                    nr_seq_item_p => null,
                                                    ie_agrupador_p => null,
                                                    nr_seq_horario_p => null,
                                                    ie_tipo_item_p => null,
                                                    ds_log_p => ds_alteracao_rastre_w,
                                                    nm_usuario_p => nm_usuario_p,
                                                    ie_commit_p => 'N');
						end if;

						CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 30, nm_usuario_p, nr_seq_atepacu_w,null,null,'PRESCRICAO',null,null);
					end if;

					select	count(*)
					into STRICT	qt_regra_proc_w
					from	regra_lanc_automatico where		nr_seq_evento = 30
					and ((cd_area_procedimento IS NOT NULL AND cd_area_procedimento::text <> '') or
						(cd_especialidade_proc IS NOT NULL AND cd_especialidade_proc::text <> '') or
						(cd_grupo_proc IS NOT NULL AND cd_grupo_proc::text <> '') or
						(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '') or
						(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '') or
						(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> ''))
					and	coalesce(cd_tipo_acomodacao::text, '') = '' LIMIT 1;

					if (qt_regra_proc_w > 0) then
						begin
						open C02;
						loop
						fetch C02 into nr_seq_proc_w;
						EXIT WHEN NOT FOUND; /* apply on C02 */
							begin

                            if (ie_info_rastre_prescr_w = 'S') then
								ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
																' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
																' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
																' - nr_seq_proc_w: ' || nr_seq_proc_w, 1, 2000);
								CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
							end if;

							CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 30, nm_usuario_p, nr_seq_atepacu_w,null,null, nr_prescricao_p, nr_seq_proc_w, null);
							end;
						end loop;
						close C02;


						end;
					end if;

					if (position('533' in ie_existe_regra_w) > 0) then
						begin
						select	count(*)
						into STRICT	qt_regras_npt_w
						from	nut_paciente where		nr_prescricao	= nr_prescricao_p LIMIT 1;

						if (qt_regras_npt_w = 0) then
							select	count(*)
							into STRICT	qt_regras_npt_w
							from	nut_pac where		nr_prescricao	= nr_prescricao_p LIMIT 1;
						end if;

						if (qt_regras_npt_w > 0) then

                        if (ie_info_rastre_prescr_w = 'S') then
                            ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
                                                            ' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
                                                            ' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
                                                            ' - qt_regras_npt_w: ' || qt_regras_npt_w, 1, 2000);
                            CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                    nr_seq_item_p => null,
                                                    ie_agrupador_p => null,
                                                    nr_seq_horario_p => null,
                                                    ie_tipo_item_p => null,
                                                    ds_log_p => ds_alteracao_rastre_w,
                                                    nm_usuario_p => nm_usuario_p,
                                                    ie_commit_p => 'N');
                        end if;

							CALL gerar_lancamento_automatico(nr_atendimento_w, null, 533, nm_usuario_p, nr_seq_atepacu_w,nr_prescricao_p,null,null,null,null);
						end if;
					end;
					end if;
					end;
				elsif (position('41' in ie_existe_regra_w) > 0) then

                        if (ie_info_rastre_prescr_w = 'S') then
                            ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
                                                            ' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
                                                            ' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
                                                            ' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
                            CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                    nr_seq_item_p => null,
                                                    ie_agrupador_p => null,
                                                    nr_seq_horario_p => null,
                                                    ie_tipo_item_p => null,
                                                    ds_log_p => ds_alteracao_rastre_w,
                                                    nm_usuario_p => nm_usuario_p,
                                                    ie_commit_p => 'N');
						end if;

						CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 41, nm_usuario_p, nr_seq_atepacu_w,null,null,null,null,null);
				elsif (position('533' in ie_existe_regra_w) > 0) then
					select	count(*)
						into STRICT	qt_regras_npt_w
						from	nut_paciente where		nr_prescricao	= nr_prescricao_p LIMIT 1;

						if (qt_regras_npt_w = 0) then
							select	count(*)
							into STRICT	qt_regras_npt_w
							from	nut_pac where		nr_prescricao	= nr_prescricao_p LIMIT 1;
						end if;

						if (qt_regras_npt_w > 0) then

                            if (ie_info_rastre_prescr_w = 'S') then
								ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
																' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
																' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
																' - qt_regras_npt_w: ' 	|| qt_regras_npt_w || pls_util_pck.enter_w ||
																' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
								CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
							end if;

							CALL gerar_lancamento_automatico(nr_atendimento_w, null, 533, nm_usuario_p, nr_seq_atepacu_w,nr_prescricao_p,null,null,null,null);
						end if;
				end if;
			else
				if (nr_prescr_mae_w = 0) then

					select	count(*)
					into STRICT	qt_regra_proc_w
					from	regra_lanc_automatico where		nr_seq_evento = 30
					and 	ie_situacao = 'A'
					and ((cd_area_procedimento IS NOT NULL AND cd_area_procedimento::text <> '') or
						(cd_especialidade_proc IS NOT NULL AND cd_especialidade_proc::text <> '') or
						(cd_grupo_proc IS NOT NULL AND cd_grupo_proc::text <> '') or
						(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '') or
						(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '') or
						(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> ''))
					and	coalesce(cd_tipo_acomodacao::text, '') = '' LIMIT 1;

					if (qt_regra_proc_w > 0) then
						if (cd_setor_atend_w <> 0) and (nr_seq_procedimento_w > 0) then

                            if (ie_info_rastre_prescr_w = 'S') then
								ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
																' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
																' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
																' - nr_seq_procedimento_w: ' || nr_seq_procedimento_w || pls_util_pck.enter_w ||
																' - cd_setor_atend_w: ' || cd_setor_atend_w || pls_util_pck.enter_w ||
																' - ie_existe_regra_w: ' || ie_existe_regra_w || pls_util_pck.enter_w ||
																' - qt_regra_proc_w: ' || qt_regra_proc_w, 1, 2000);
								CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
							end if;

							CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 30, nm_usuario_p, nr_seq_atepacu_w,null,null, nr_prescricao_p, nr_seq_procedimento_w, null);
						end if;
					elsif (position('61' in ie_existe_regra_w) > 0) then

                        if (ie_info_rastre_prescr_w = 'S') then
								ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
																' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
																' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
																' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
								CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
						end if;

						CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 61, nm_usuario_p, nr_seq_atepacu_w,null,null,null,null,null);
					end if;
				else
					if (position('72' in ie_existe_regra_w) > 0) then

                        if (ie_info_rastre_prescr_w = 'S') then
								ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
																' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
																' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
																' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
								CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
						end if;

						CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 72, nm_usuario_p, nr_seq_atepacu_w,null,null,null,null,null);
					elsif (position('533' in ie_existe_regra_w) > 0) then
						select	count(*)
						into STRICT	qt_regras_npt_w
						from	nut_paciente where		nr_prescricao	= nr_prescricao_p LIMIT 1;

						if (qt_regras_npt_w = 0) then
							select	count(*)
							into STRICT	qt_regras_npt_w
							from	nut_pac where		nr_prescricao	= nr_prescricao_p LIMIT 1;
						end if;

						if (qt_regras_npt_w > 0) then

                            if (ie_info_rastre_prescr_w = 'S') then
                                ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
                                                                ' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
                                                                ' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
                                                                ' - qt_regras_npt_w: ' || qt_regras_npt_w || pls_util_pck.enter_w ||
                                                                ' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
                                CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                                        nr_seq_item_p => null,
                                                        ie_agrupador_p => null,
                                                        nr_seq_horario_p => null,
                                                        ie_tipo_item_p => null,
                                                        ds_log_p => ds_alteracao_rastre_w,
                                                        nm_usuario_p => nm_usuario_p,
                                                        ie_commit_p => 'N');
                            end if;

							CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 72, nm_usuario_p, nr_seq_atepacu_w,nr_prescricao_p,null,null,null,null);
						end if;
					end if;
				end if;
			end if;
		end if;
	end loop;
	close c01;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

select	count(*)
into STRICT	qt_reg_w
from	regra_lanc_automatico where		nr_seq_evento = 30
and		(cd_tipo_recomendacao IS NOT NULL AND cd_tipo_recomendacao::text <> '') LIMIT 1;

if (qt_reg_w > 0) then
	open 	C03;
	loop
	fetch 	C03 into
		cd_recomendacao_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

        if (ie_info_rastre_prescr_w = 'S') then
			ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
											' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
											' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
											' - cd_recomendacao_w: ' || cd_recomendacao_w || pls_util_pck.enter_w ||
											' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
			CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                    nr_seq_item_p => null,
                                    ie_agrupador_p => null,
                                    nr_seq_horario_p => null,
                                    ie_tipo_item_p => null,
                                    ds_log_p => ds_alteracao_rastre_w,
                                    nm_usuario_p => nm_usuario_p,
                                    ie_commit_p => 'N');
		end if;

		CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 30, nm_usuario_p, nr_seq_atepacu_w,cd_recomendacao_w,null,'PRESCRICAO',nr_prescricao_p,null);
		end;
	end loop;
	close C03;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;


select	count(*)
into STRICT	qt_reg_w
from	regra_lanc_automatico where		nr_seq_evento = 30
and		(cd_dieta IS NOT NULL AND cd_dieta::text <> '') LIMIT 1;

if (qt_reg_w > 0) then
	open 	C04;
	loop
	fetch 	C04 into
		cd_dieta_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

        if (ie_info_rastre_prescr_w = 'S') then
			ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Lanc_Auto_Prescricao - Linha: ' || $$plsql_line||pls_util_pck.enter_w||
											' - nr_atendimento_w: ' || nr_atendimento_w || pls_util_pck.enter_w ||
											' - nr_seq_atepacu_w: ' || nr_seq_atepacu_w || pls_util_pck.enter_w ||
											' - cd_dieta_w: ' || cd_dieta_w || pls_util_pck.enter_w ||
											' - ie_existe_regra_w: ' || ie_existe_regra_w, 1, 2000);
			CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                                    nr_seq_item_p => null,
                                    ie_agrupador_p => null,
                                    nr_seq_horario_p => null,
                                    ie_tipo_item_p => null,
                                    ds_log_p => ds_alteracao_rastre_w,
                                    nm_usuario_p => nm_usuario_p,
                                    ie_commit_p => 'N');
		end if;

		CALL GERAR_LANCAMENTO_AUTOMATICO(nr_atendimento_w, null, 30, nm_usuario_p, nr_seq_atepacu_w,-1,cd_dieta_w,'PRESCRICAO',nr_prescricao_p,null);
		end;
	end loop;
	close C04;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

exception when others then
	ds_alteracao_rastre_w:= substr('Exception / Gerar_Lanc_Auto_Prescricao - Linha:'||$$plsql_line||pls_util_pck.enter_w||sqlerrm,1,2000);
	CALL gerar_log_prescr_mat(   nr_prescricao_p => nr_prescricao_p,
                            nr_seq_item_p => null,
                            ie_agrupador_p => null,
                            nr_seq_horario_p => null,
                            ie_tipo_item_p => null,
                            ds_log_p => ds_alteracao_rastre_w,
                            nm_usuario_p => nm_usuario_p,
                            ie_commit_p => 'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lanc_auto_prescricao ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

