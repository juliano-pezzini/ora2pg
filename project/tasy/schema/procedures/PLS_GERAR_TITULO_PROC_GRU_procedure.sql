-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_titulo_proc_gru ( nr_seq_proc_gru_p pls_processo_gru.nr_sequencia%type, dt_vencimento_p titulo_pagar.dt_emissao%type, dt_documento_p titulo_pagar.dt_vencimento_original%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, vl_juros_p titulo_pagar.vl_saldo_juros%type, vl_multa_p titulo_pagar.vl_saldo_multa%type, nr_seq_motivo_p motivo_alt_valor.nr_sequencia%type, nr_seq_trans_fin_p transacao_financeira.nr_sequencia%type) AS $body$
DECLARE

					
cd_moeda_w				parametros_contas_pagar.cd_moeda_padrao%type;
vl_ressarcir_w				titulo_pagar_classif.vl_titulo%type;
vl_ressarcir_tot_w			titulo_pagar.vl_titulo%type;
cd_cgc_requerente_param_w		pls_parametros.cd_cgc_ressarc%type;
nr_titulo_w				titulo_pagar.nr_titulo%type;
cd_conta_financ_w			pls_parametros.cd_conta_financ_ressarcimento%type;
nr_gru_w				pls_processo_gru.nr_gru%type;
nr_seq_processo_w			pls_processo_gru.nr_seq_processo%type;
nr_seq_trans_fin_baixa_ress_w		pls_parametros.nr_seq_trans_fin_baixa_ress%type;
ds_observacao_w				titulo_pagar.ds_observacao_titulo%type;
nr_processo_w 				pls_processo.nr_processo%type;
cd_abi_w				pls_processo.cd_abi%type;
nr_seq_classe_ressarc_w			pls_parametros.nr_seq_classe_ressarc%type;
vl_juros_w				titulo_pagar.vl_saldo_juros%type;
vl_multa_w				titulo_pagar.vl_saldo_multa%type;
nr_seq_alteracao_w			titulo_pagar_alt_valor.nr_sequencia%type;
ds_observacao_alt_w			titulo_pagar_alt_valor.ds_observacao%type;


BEGIN

vl_ressarcir_w	:= pls_obter_valor_proc_gru(nr_seq_proc_gru_p);
vl_juros_w	:= vl_juros_p;
vl_multa_w	:= vl_multa_p;

select	g.nr_gru,
	g.nr_seq_processo,
	p.cd_abi,
	p.nr_processo
into STRICT	nr_gru_w,
	nr_seq_processo_w,
	cd_abi_w,
	nr_processo_w
from	pls_processo_gru g,
	pls_processo p
where	g.nr_sequencia = nr_seq_proc_gru_p
and 	p.nr_sequencia = g.nr_seq_processo;

select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametros_contas_pagar
where	cd_estabelecimento = cd_estabelecimento_p;

select	cd_conta_financ_ressarcimento,
	cd_cgc_ressarc,
	nr_seq_trans_fin_baixa_ress,
	nr_seq_classe_ressarc
into STRICT	cd_conta_financ_w,
	cd_cgc_requerente_param_w,
	nr_seq_trans_fin_baixa_ress_w,
	nr_seq_classe_ressarc_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

ds_observacao_w := substr('ABI: ' || cd_abi_w ||  ' Processo: ' || nr_processo_w  || ' GRU: ' || nr_gru_w, 1, 4000);

vl_ressarcir_tot_w	:= vl_ressarcir_w;

if	(nr_seq_motivo_p IS NOT NULL AND nr_seq_motivo_p::text <> '' AND nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '') then
	vl_ressarcir_tot_w	:= coalesce(vl_ressarcir_w, 0) + coalesce(vl_juros_w, 0) + coalesce(vl_multa_w, 0);
	vl_juros_w		:= 0;
	vl_multa_w		:= 0;
	
	if	((coalesce(vl_juros_p, 0) > 0) or (coalesce(vl_multa_p, 0) > 0)) then
		ds_observacao_w := substr(ds_observacao_w || ' Vl ressarcir: R$ ' || campo_mascara_virgula(vl_ressarcir_w) || ' Vl juros: R$ ' || campo_mascara_virgula(vl_juros_p) || ' Vl multa: R$ ' || campo_mascara_virgula(vl_multa_p), 1, 4000);
	end if;
end if;

insert into titulo_pagar(	nr_titulo,			cd_estabelecimento,		dt_atualizacao,		nm_usuario,		dt_contabil,
				dt_emissao,			dt_vencimento_original,		dt_vencimento_atual,	vl_titulo,		vl_saldo_titulo,
				vl_saldo_juros,			vl_saldo_multa,			cd_moeda,		ie_origem_titulo,	ie_situacao,
				ie_pls,				ie_tipo_titulo,			tx_juros,		tx_multa,		cd_tipo_taxa_juro,
				cd_tipo_taxa_multa,		cd_cgc,				nr_seq_processo,	nr_documento,		ie_status,
				nr_seq_proc_gru,		nr_seq_trans_fin_baixa,		ds_observacao_titulo,	nr_seq_classe)
			values (	nextval('titulo_pagar_seq'),	cd_estabelecimento_p,		clock_timestamp(),		nm_usuario_p,		clock_timestamp(),
				dt_documento_p,			dt_vencimento_p,		dt_vencimento_p,	vl_ressarcir_w,		vl_ressarcir_tot_w,
				vl_juros_w,			vl_multa_w,			cd_moeda_w,		'9',			'A',
				'S',				'10',				0,			0,			1,
				1,				cd_cgc_requerente_param_w,	nr_seq_processo_w,	nr_gru_w,		'D',
				nr_seq_proc_gru_p,		nr_seq_trans_fin_baixa_ress_w,	ds_observacao_w,	nr_seq_classe_ressarc_w) returning nr_titulo into nr_titulo_w;
				
insert into titulo_pagar_classif(	dt_atualizacao,			nm_usuario,			nr_seq_conta_financ,	nr_sequencia,		nr_titulo,
					vl_acrescimo,			vl_desconto,			vl_original,		vl_titulo)
				values (	clock_timestamp(),			nm_usuario_p,			cd_conta_financ_w,	1,			nr_titulo_w,
					0,				0,				vl_ressarcir_w,		vl_ressarcir_w);
					
if	(nr_seq_motivo_p IS NOT NULL AND nr_seq_motivo_p::text <> '' AND nr_seq_trans_fin_p IS NOT NULL AND nr_seq_trans_fin_p::text <> '') then
	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_seq_alteracao_w
	from	titulo_pagar_alt_valor
	where	nr_titulo = nr_titulo_w;
	
	ds_observacao_alt_w	:= substr(obter_texto_dic_objeto(1197324, wheb_usuario_pck.get_nr_seq_idioma, null), 1, 255);
	
	insert into titulo_pagar_alt_valor(	nr_sequencia,			nr_titulo,			dt_alteracao,		vl_anterior,		vl_alteracao,
						cd_moeda,			dt_atualizacao,			nm_usuario,		nr_lote_contabil,	nr_seq_motivo,
						nr_seq_trans_fin,		ds_observacao)
					values (nr_seq_alteracao_w,		nr_titulo_w,			clock_timestamp(),		vl_ressarcir_w,		vl_ressarcir_tot_w,
						cd_moeda_w,			clock_timestamp(),			nm_usuario_p,		0,			nr_seq_motivo_p,
						nr_seq_trans_fin_p,		ds_observacao_alt_w);
end if;

CALL atualizar_inclusao_tit_pagar(nr_titulo_w, nm_usuario_p);

CALL atualizar_saldo_tit_pagar(nr_titulo_w, nm_usuario_p);

update	pls_processo_conta
set	ie_status_pagamento	= CASE WHEN vl_ressarcir=0 THEN 'N'  ELSE 'R' END  -- N - Nao havera pagamento - R - Ressarcimento pago
where	nr_seq_processo		= nr_seq_processo_w
and	nr_seq_proc_gru		= nr_seq_proc_gru_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_titulo_proc_gru ( nr_seq_proc_gru_p pls_processo_gru.nr_sequencia%type, dt_vencimento_p titulo_pagar.dt_emissao%type, dt_documento_p titulo_pagar.dt_vencimento_original%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, vl_juros_p titulo_pagar.vl_saldo_juros%type, vl_multa_p titulo_pagar.vl_saldo_multa%type, nr_seq_motivo_p motivo_alt_valor.nr_sequencia%type, nr_seq_trans_fin_p transacao_financeira.nr_sequencia%type) FROM PUBLIC;

