-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_diagnostico_tumor ( nr_sequencia_p bigint, nm_usuario_p text, nr_sequencia_dest_p INOUT bigint) AS $body$
DECLARE

cd_pessoa_fisica_w	varchar(15);
NR_SEQ_ATEND_CONS_PEPA_W bigint;

BEGIN


IF (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') THEN
	
	IF (wheb_usuario_pck.get_cd_funcao = 381) THEN
		select	NR_SEQ_ATEND_CONS_PEPA
		into STRICT 	NR_SEQ_ATEND_CONS_PEPA_W
		from	can_loco_regional
		where	nr_sequencia = nr_sequencia_p;
	ELSE
		NR_SEQ_ATEND_CONS_PEPA_W := null;
	END IF;
	
	select 	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from 	medico
	where 	cd_pessoa_fisica = Obter_Dados_Usuario_Opcao(nm_usuario_p,'C');
	

	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		--Usuário sem cadastro de médico. Favor verificar. 
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(281102);
	
	else
	
		begin

		select 	nextval('can_loco_regional_seq')
		into STRICT	nr_sequencia_dest_p
		;

		INSERT	INTO can_loco_regional(
			nr_sequencia,
			cd_estabelecimento,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			cd_medico,
			nr_atendimento,
			cd_morfologia,
			cd_topografia,
			cd_estadiamento,
			cd_tumor_primario,
			cd_linfonodo_regional,
			cd_metastase_distancia,
			qt_peso,
			qt_altura,
			qt_auc,
			qt_creatinina,
			ie_l_dl_creatinina,
			qt_clearance_creatinina,
			qt_mg_carboplatina,
			cd_tumor_prim_pat,
			cd_linfonodo_reg_pat,
			cd_metastase_dist_pat,
			cd_estadio_outro,
			qt_redutor_sc,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_avaliacao,
			ie_perfor_staus_zubrod,
			ie_karnofski,
			ds_exame_fisico,
			ds_loco_regional,
			ds_aparelho_ganglionar,
			cd_doenca_cid,
			ds_diag_histologico,
			ds_outro_sistema,
			ds_observacao,
			ds_proposta_terapeutica,
			dt_ptnm,
			ie_nivel_ecog,
			ie_situacao,
			cd_linfatico,
			cd_vascular,
			cd_perineural,
			cd_tumor_residual,
			ie_tipo_tnm,
			cd_dunkes,
			cd_mac,
			cd_categoria,
			cd_grau_histo,
			cd_linfatico_pat,
			cd_vascular_pat,
			cd_perineural_pat,
			cd_tumor_residual_pat,
			ie_tipo_tnm_pat,
			cd_dunkes_pat,
			cd_mac_pat,
			cd_categoria_pat,
			cd_grau_histo_pat,
			dt_diag_histopatologico,
			ds_exame_complementar,
			ds_linfonodo,
			ds_imunohistoquimica,
			ds_metastase,
			NR_SEQ_ATEND_CONS_PEPA,
      NR_SEQ_MORF_DESC_ADIC)
		SELECT	nr_sequencia_dest_p,
			cd_estabelecimento,
			cd_pessoa_fisica,
			clock_timestamp(),
			nm_usuario_p,
			Obter_Dados_Usuario_Opcao(nm_usuario_p,'C'),
			nr_atendimento,
			cd_morfologia,
			cd_topografia,
			cd_estadiamento,
			cd_tumor_primario,
			cd_linfonodo_regional,
			cd_metastase_distancia,
			qt_peso,
			qt_altura,
			qt_auc,
			qt_creatinina,
			ie_l_dl_creatinina,
			qt_clearance_creatinina,
			qt_mg_carboplatina,
			cd_tumor_prim_pat,
			cd_linfonodo_reg_pat,
			cd_metastase_dist_pat,
			cd_estadio_outro,
			qt_redutor_sc,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			ie_perfor_staus_zubrod,
			ie_karnofski,
			ds_exame_fisico,
			ds_loco_regional,
			ds_aparelho_ganglionar,
			cd_doenca_cid,
			ds_diag_histologico,
			ds_outro_sistema,
			ds_observacao,
			ds_proposta_terapeutica,
			dt_ptnm,
			ie_nivel_ecog,
			'A',
			cd_linfatico,
			cd_vascular,
			cd_perineural,
			cd_tumor_residual,
			ie_tipo_tnm,
			cd_dunkes,
			cd_mac,
			cd_categoria,
			cd_grau_histo,
			cd_linfatico_pat,
			cd_vascular_pat,
			cd_perineural_pat,
			cd_tumor_residual_pat,
			ie_tipo_tnm_pat,
			cd_dunkes_pat,
			cd_mac_pat,
			cd_categoria_pat,
			cd_grau_histo_pat,
			dt_diag_histopatologico,
			ds_exame_complementar,
			ds_linfonodo,
			ds_imunohistoquimica,
			ds_metastase,
			NR_SEQ_ATEND_CONS_PEPA_W,
      NR_SEQ_MORF_DESC_ADIC
		FROM	can_loco_regional
		WHERE	nr_sequencia = nr_sequencia_p;


		INSERT INTO can_loco_reg_diag_assoc(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_doenca_cid,
			nr_seq_loco_reg)
		SELECT  nextval('can_loco_reg_diag_assoc_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_doenca_cid,
			nr_sequencia_dest_p
		FROM	can_loco_reg_diag_assoc
		WHERE	nr_seq_loco_reg = nr_sequencia_p;
		end;
	END IF;
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_diagnostico_tumor ( nr_sequencia_p bigint, nm_usuario_p text, nr_sequencia_dest_p INOUT bigint) FROM PUBLIC;

