-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_param_exame_dep ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_proc_interno_p exame_laboratorio.nr_seq_proc_interno%type, nr_seq_rotina_p exame_lab_rotina.nr_seq_exame%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, cd_convenio_p INOUT atend_categoria_convenio.cd_convenio%type, cd_plano_convenio_p INOUT atend_categoria_convenio.cd_plano_convenio%type, cd_categoria_p INOUT atend_categoria_convenio.cd_categoria%type, nr_seq_material_prescr_p INOUT material_exame_lab.nr_sequencia%type, ie_origem_proced_cursor_p INOUT exame_laboratorio.ie_origem_proced%type, ie_origem_proced_sus_p INOUT exame_laboratorio.ie_origem_proced%type, ie_origem_proced_p INOUT exame_laboratorio.ie_origem_proced%type, nr_seq_exame_p INOUT exame_lab_dependente.nr_seq_exame_dep%type, ie_tipo_atendimento_p INOUT atendimento_Paciente.ie_tipo_atendimento%type, ie_tipo_convenio_p INOUT convenio.ie_tipo_convenio%type, cd_edicao_amb_p INOUT convenio_amb.cd_edicao_amb%type ) AS $body$
DECLARE


	ie_prioridade_edicao_w		parametro_faturamento.ie_prioridade_edicao_amb%type;
	cd_procedimento_w			bigint;
	vl_ch_honorarios_w			double precision := 1;
    vl_ch_custo_oper_w			double precision := 1;
    vl_m2_filme_w				double precision := 0;
    tx_ajuste_geral_w			double precision := 1;
    nr_seq_cbhpm_edicao_w		bigint;
    dt_inicio_vigencia_w		timestamp;
	dt_vigencia_w				timestamp;


BEGIN

	cd_convenio_p := obter_convenio_atendimento(nr_atendimento_p);
	cd_plano_convenio_p := obter_plano_conv_atend(nr_atendimento_p);
	cd_categoria_p := obter_categoria_atendimento(nr_atendimento_p);
	ie_tipo_atendimento_p := obter_tipo_atendimento(nr_atendimento_p);
	
	dt_vigencia_w := clock_timestamp();
	
	select	max(ie_tipo_convenio)
	  into STRICT	ie_tipo_convenio_p
	  from	convenio
	 where	cd_convenio = cd_convenio_p;
	
	select	coalesce(max(ie_prioridade_edicao_amb), 'N')
	  into STRICT	ie_prioridade_edicao_w
	  from	parametro_faturamento
	 where	cd_estabelecimento = cd_estabelecimento_p;
	
	ie_origem_proced_sus_p := obter_origem_proced_cat(cd_estabelecimento_p, ie_tipo_atendimento_p, ie_tipo_convenio_p, cd_convenio_p, cd_categoria_p);
	
	if (ie_prioridade_edicao_w = 'N') then
		select	coalesce(max(cd_edicao_amb), 0)
		  into STRICT	cd_edicao_amb_p
		  from	convenio_amb
		 where	cd_estabelecimento = cd_estabelecimento_p
		   and	cd_convenio 	   = cd_convenio_p
		   and	cd_categoria	   = cd_categoria_p
		   and  coalesce(ie_situacao,'A') = 'A'
		   and	(dt_inicio_vigencia = (SELECT max(dt_inicio_vigencia)
										 from convenio_amb a
										where a.cd_estabelecimento  = cd_estabelecimento_p
										  and a.cd_convenio         = cd_convenio_p
										  and a.cd_categoria        = cd_categoria_p
										  and coalesce(a.ie_situacao,'A') = 'A'
										  and a.dt_inicio_vigencia <= dt_vigencia_w));
	else
		SELECT * FROM obter_edicao_proc_conv(	cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, dt_vigencia_w, cd_procedimento_w, cd_edicao_amb_p, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w) INTO STRICT cd_edicao_amb_p, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
	end if;
	
	select	max(ie_origem_proced)
	  into STRICT	ie_origem_proced_cursor_p
	  from	edicao_amb
	 where	cd_edicao_amb = cd_edicao_amb_p;	
		
	if (coalesce(ie_origem_proced_cursor_p::text, '') = '') then
		ie_origem_proced_cursor_p := ie_origem_proced_sus_p;
	end if;
	
	select 	max(nr_seq_exame_lab),
			max(ie_origem_proced)
	  into STRICT	nr_seq_exame_p,
			ie_origem_proced_p
	  from	proc_interno
	 where	nr_sequencia = nr_seq_proc_interno_p;

	if (nr_seq_rotina_p IS NOT NULL AND nr_seq_rotina_p::text <> '') then
		select max(a.nr_seq_exame)
		  into STRICT nr_seq_exame_p
		  from exame_lab_rotina a
		 where a.nr_sequencia =  nr_seq_rotina_p;
	end if;	

	if (coalesce(nr_seq_exame_p::text, '') = '') then
		select max(a.nr_seq_exame)
		  into STRICT nr_seq_exame_p
		  from exame_laboratorio a
		 where a.cd_estabelecimento = cd_estabelecimento_p
		   and a.nr_seq_proc_interno = nr_seq_proc_interno_p;
	end if;		

	select	coalesce(max(b.nr_sequencia), 0)
	  into STRICT	nr_seq_material_prescr_p
	  from	material_exame_lab b
	 where	b.cd_material_exame = cd_material_exame_p;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_param_exame_dep ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_proc_interno_p exame_laboratorio.nr_seq_proc_interno%type, nr_seq_rotina_p exame_lab_rotina.nr_seq_exame%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, cd_convenio_p INOUT atend_categoria_convenio.cd_convenio%type, cd_plano_convenio_p INOUT atend_categoria_convenio.cd_plano_convenio%type, cd_categoria_p INOUT atend_categoria_convenio.cd_categoria%type, nr_seq_material_prescr_p INOUT material_exame_lab.nr_sequencia%type, ie_origem_proced_cursor_p INOUT exame_laboratorio.ie_origem_proced%type, ie_origem_proced_sus_p INOUT exame_laboratorio.ie_origem_proced%type, ie_origem_proced_p INOUT exame_laboratorio.ie_origem_proced%type, nr_seq_exame_p INOUT exame_lab_dependente.nr_seq_exame_dep%type, ie_tipo_atendimento_p INOUT atendimento_Paciente.ie_tipo_atendimento%type, ie_tipo_convenio_p INOUT convenio.ie_tipo_convenio%type, cd_edicao_amb_p INOUT convenio_amb.cd_edicao_amb%type ) FROM PUBLIC;

