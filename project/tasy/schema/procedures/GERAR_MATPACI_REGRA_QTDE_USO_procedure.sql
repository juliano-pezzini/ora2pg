-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_matpaci_regra_qtde_uso (nr_interno_conta_p bigint, cd_material_p bigint, ie_acao_excesso_p text, qt_ajuste_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_nova_w		bigint;
nr_sequencia_w		bigint;
dt_conta_w		timestamp;


BEGIN 
 
if (coalesce(ie_acao_excesso_p::text, '') = '') and (qt_ajuste_p <> 0) then 
 
	select	max(nr_sequencia), 
		max(dt_conta) 
	into STRICT	nr_sequencia_w, 
		dt_conta_w 
	from	material_atend_paciente 
	where	nr_interno_conta	= nr_interno_conta_p 
	and	cd_material		= cd_material_p;
 
	select	nextval('material_atend_paciente_seq') 
	into STRICT	nr_seq_nova_w 
	;
 
	insert	into material_atend_paciente( 
		NR_SEQUENCIA,		NR_ATENDIMENTO,		DT_ENTRADA_UNIDADE,	CD_MATERIAL,		DT_ATENDIMENTO, 
		CD_UNIDADE_MEDIDA,	QT_MATERIAL,		DT_ATUALIZACAO,		NM_USUARIO,		CD_CONVENIO,	 
		CD_CATEGORIA,		DT_PRESCRICAO,		CD_MATERIAL_PRESCRICAO,	IE_VIA_APLICACAO,	DS_OBSERVACAO, 
		VL_MATERIAL,		CD_TAB_PRECO_MATERIAL,	DT_VIGENCIA_TABELA,	DT_ACERTO_CONTA,	DT_ACERTO_CONVENIO, 
		NR_PRESCRICAO,		NR_SEQUENCIA_PRESCRICAO,CD_MOTIVO_EXC_CONTA,	DS_COMPL_MOTIVO_EXCON,	CD_LOCAL_ESTOQUE, 
		DT_ATUALIZACAO_ESTOQUE,	CD_ACAO,		CD_SETOR_ATENDIMENTO,	QT_DEVOLVIDA,		CD_MOTIVO_DEVOLUCAO, 
		NR_CIRURGIA,		NR_DOC_CONVENIO,	QT_EXECUTADA,		DT_CONTA,		VL_UNITARIO, 
		CD_PROCED_REFERENCIA,	CD_CONTA_CONTABIL,	QT_AJUSTE_CONTA,	NR_AIH,			IE_VALOR_INFORMADO, 
		CD_ESTABELECIMENTO_CUSTO,CD_TABELA_CUSTO,	CD_SITUACAO_GLOSA,	NR_LOTE_CONTABIL,	CD_MATERIAL_CONVENIO, 
		NR_SEQ_AUTORIZACAO,	NR_INTERNO_CONTA,	NR_SEQ_PROC_PRINC,	IE_GUIA_INFORMADA,	CD_ESPECIALIDADE, 
		NM_USUARIO_ORIGINAL,	NR_SEQ_PROC_PACOTE,	VL_TABELA_ORIGINAL,	IE_EMITE_CONTA,		CD_SETOR_RECEITA, 
		CD_CGC_FORNECEDOR,	NR_SEQ_LOTE_FORNEC,	CD_MATERIAL_EXEC,	NR_SEQ_ATEPACU,		IE_TIPO_GUIA, 
		NR_DOC_INTERNO,		IE_AUDITORIA,		NR_SEQ_GRUPO_REC,	CD_MOTIVO_AJUSTE, 			NR_SEQ_ORIGEM,nr_seq_aih) 
	SELECT	 
		NR_SEQ_NOVA_W,		NR_ATENDIMENTO,		DT_ENTRADA_UNIDADE,	CD_MATERIAL,		DT_ATENDIMENTO + 3/86400, 
		CD_UNIDADE_MEDIDA,	QT_AJUSTE_P,		clock_timestamp(),		NM_USUARIO_P,		cd_convenio, 
		cd_categoria,		DT_PRESCRICAO,		CD_MATERIAL_PRESCRICAO,	IE_VIA_APLICACAO,	DS_OBSERVACAO, 
		VL_MATERIAL,		CD_TAB_PRECO_MATERIAL,	DT_VIGENCIA_TABELA,	dt_acerto_conta,	DT_ACERTO_CONVENIO, 
		NR_PRESCRICAO,		NR_SEQUENCIA_PRESCRICAO,CD_MOTIVO_EXC_CONTA,	DS_COMPL_MOTIVO_EXCON,	null, 
		DT_ATUALIZACAO_ESTOQUE,	CD_ACAO,		CD_SETOR_ATENDIMENTO,	QT_DEVOLVIDA,		CD_MOTIVO_DEVOLUCAO, 
		NR_CIRURGIA,		NR_DOC_CONVENIO,	QT_EXECUTADA,		DT_CONTA_w,		VL_UNITARIO, 
		CD_PROCED_REFERENCIA,	CD_CONTA_CONTABIL,	QT_AJUSTE_CONTA,	NR_AIH,			IE_VALOR_INFORMADO, 
		CD_ESTABELECIMENTO_CUSTO,CD_TABELA_CUSTO,	CD_SITUACAO_GLOSA,	NR_LOTE_CONTABIL,	CD_MATERIAL_CONVENIO, 
		NR_SEQ_AUTORIZACAO,	nr_interno_conta_p,	NR_SEQ_PROC_PRINC,	IE_GUIA_INFORMADA,	CD_ESPECIALIDADE, 
		NM_USUARIO_ORIGINAL,	NR_SEQ_PROC_PACOTE,	VL_TABELA_ORIGINAL,	IE_EMITE_CONTA,		CD_SETOR_RECEITA, 
		CD_CGC_FORNECEDOR,	NR_SEQ_LOTE_FORNEC,	CD_MATERIAL_EXEC,	NR_SEQ_ATEPACU,		IE_TIPO_GUIA, 
		NR_DOC_INTERNO,		IE_AUDITORIA,		NR_SEQ_GRUPO_REC,	CD_MOTIVO_AJUSTE,	null, 
		nr_seq_aih 
	from 	material_atend_paciente 
	where 	nr_sequencia = nr_sequencia_w;
 
	CALL atualiza_preco_material(nr_seq_nova_w, nm_usuario_p);
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_matpaci_regra_qtde_uso (nr_interno_conta_p bigint, cd_material_p bigint, ie_acao_excesso_p text, qt_ajuste_p bigint, nm_usuario_p text) FROM PUBLIC;

