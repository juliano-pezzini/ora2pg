-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_oc_pacote_conv ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, ie_gerar_coorrencia_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_guia_w			varchar(20);
cd_procedimento_w		bigint;
nr_seq_pacote_w			bigint;
ie_origem_proced_w		bigint;
nr_seq_regra_w			bigint;
cd_procedimento_ww		bigint;
ie_origem_proced_ww		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_segurado_w		bigint;
ie_pacote_conv_w		varchar(1) := 'N'; --Se o pacote possui procedimentos de converão 
nr_seq_regra_preco_pac_w	bigint;
nr_seq_regra_conv_w		bigint;
nr_seq_congenere_w		bigint;
nr_seq_congenere_seq_w		bigint;
nr_seq_protocolo_w		bigint;
ie_tipo_conta_w			varchar(10);
ie_regra_preco_w		varchar(3);
nr_seq_grupo_proc_w		pls_regra_conversao_pacote.nr_sequencia%type;	
 
C00 CURSOR( nr_seq_pc	pls_pacote_cad_grupo_proc.nr_sequencia%type) FOR 
	SELECT 	b.cd_procedimento, 
		b.ie_origem_proced 
	from	pls_pacote_cad_grupo_proc a, 
		pls_pacote_grupo_proc b 
	where	a.nr_sequencia = nr_seq_pc 
	and	b.nr_seq_grupo = a.nr_sequencia 
	and	a.ie_situacao = 'A' 
	and	b.ie_situacao = 'A' 
	group by b.cd_procedimento, b.ie_origem_proced;

C01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_pacote 
	where	cd_procedimento 	= cd_procedimento_w 
	and	ie_origem_proced	= ie_origem_proced_w 
	and	cd_estabelecimento	= cd_estabelecimento_p 
	and	ie_situacao		= 'A';

C02 CURSOR FOR 
	SELECT	b.cd_procedimento, 
		b.ie_origem_proced, 
		a.nr_sequencia, 
		b.nr_seq_grupo_proc  --grupo proc pacote 
	from	pls_conversao_pacote a, 
		pls_regra_conversao_pacote b 
	where	a.nr_seq_regra = b.nr_sequencia 
	and	nr_seq_pacote = nr_seq_pacote_w 
	--and	b.ie_conta_medica	= 'S' //Diego OS - 297025 - Anexo 02_06_2011_15_24_07_zip - O analista da Unimed Litoral solicita : "O único checkbox que deve ser considerado na regra é de ¿situação ativa¿. 
	and	b.ie_situacao		= 'A';

C03 CURSOR FOR 
	SELECT	b.nr_sequencia 
	from	pls_conta a, 
		pls_conta_proc b 
	where	a.nr_sequencia = b.nr_seq_conta 
	and	((coalesce(a.cd_guia_referencia, a.cd_guia) = cd_guia_w)	--Verifica todas as contas da guia pelo procedimento 
	or	((a.nr_sequencia = nr_seq_conta_p) and (coalesce(cd_guia_w,'X') = 'X'))) --Se não existir a guia verifica somente a conta 
	and	a.nr_seq_segurado	= nr_seq_segurado_w 
	and	b.cd_procedimento	= cd_procedimento_ww 
	and	b.ie_origem_proced	= ie_origem_proced_ww;

BEGIN 
 
/*Obter a guia da conta*/
 
select	coalesce(cd_guia_referencia, cd_guia), 
	nr_seq_segurado, 
	nr_seq_protocolo, 
	ie_tipo_conta 
into STRICT	cd_guia_w, 
	nr_seq_segurado_w, 
	nr_seq_protocolo_w, 
	ie_tipo_conta_w 
from	pls_conta 
where	nr_sequencia	= nr_seq_conta_p;
 
/*Obtém o procedimento*/
 
select	cd_procedimento, 
	ie_origem_proced 
into STRICT	cd_procedimento_w, 
	ie_origem_proced_w 
from	pls_conta_proc 
where	nr_sequencia = nr_seq_conta_proc_p;
 
/*Obter dados protocolo*/
 
select	nr_seq_congenere 
into STRICT	nr_seq_congenere_w 
from	pls_protocolo_conta 
where	nr_sequencia	= nr_seq_protocolo_w;
 
 
/*obter dados segurados*/
 
nr_seq_congenere_seq_w	:= pls_obter_dados_segurado(nr_seq_segurado_w, 'NRCON');
 
/*Obtem os pacotes cadastrados com este procedimento*/
 
open C01;
loop 
fetch C01 into 
	nr_seq_pacote_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	/* Francisco - 16/05/2012 - OS 447352 */
 
	if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then 
		select	coalesce(ie_regra_preco,'N') 
		into STRICT	ie_regra_preco_w 
		from	pls_pacote a 
		where	a.nr_sequencia = nr_seq_pacote_w;
		 
		if (ie_regra_preco_w = 'S') then 
			SELECT * FROM pls_obter_regra_preco_pacote(	cd_procedimento_w, ie_origem_proced_w, 'C', nr_seq_conta_proc_p, nm_usuario_p, nr_seq_pacote_w, nr_seq_regra_preco_pac_w) INTO STRICT nr_seq_pacote_w, nr_seq_regra_preco_pac_w;
		end if;
	end if;
	 
	if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then 
		/*Obtem os pacotes de conversão*/
 
 
		open C02;
		loop 
		fetch C02 into 
			cd_procedimento_ww, /*Procedimento da regra*/
 
			ie_origem_proced_ww, 
			nr_seq_regra_conv_w, 
			nr_seq_grupo_proc_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			if (pls_obter_excecao_conv_pac(nr_seq_regra_conv_w, nr_seq_congenere_seq_w, nr_seq_congenere_w) = 'S')	and (ie_tipo_conta_w	= 'I')	then 
				ie_pacote_conv_w	:= 'N';
			else 
				ie_pacote_conv_w	:= 'S';
			end if;
 
	 
			if (cd_procedimento_ww IS NOT NULL AND cd_procedimento_ww::text <> '') then 
				/*Verifica se um destes procedimentos de conversão existem em alguma conta da guia*/
 
				open C03;
				loop 
				fetch C03 into 
					nr_seq_conta_proc_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
				end loop;
				close C03;
				 
			elsif (nr_seq_grupo_proc_w IS NOT NULL AND nr_seq_grupo_proc_w::text <> '') then 
			 
				--Se já achou então não é necessário prosseguir buscando nos grupos 
				if (coalesce(nr_seq_conta_proc_w::text, '') = '') then 
					for r_C00_w in C00(nr_seq_grupo_proc_w) loop 
						cd_procedimento_ww	:= r_c00_w.cd_procedimento;
						ie_origem_proced_ww	:= r_c00_w.ie_origem_proced;
						 
						open C03;
						loop 
						fetch C03 into 
							nr_seq_conta_proc_w;
													 
						EXIT WHEN NOT FOUND; /* apply on C03 */
						end loop;
						close C03;
								 
					end loop;
				end if;
			 
			end if;
 
			end;
		end loop;
		close C02;
	end if;
	end;
end loop;
close C01;
 
/*Diego OS 297025 - Histórico 24/05/2011 11:36:28 - No caso de não haver procedimentos de conversão lançados não é consistido o pacote*/
 
 
if (ie_pacote_conv_w = 'S') then 
	/*Se há um proc*/
 
	if (coalesce(nr_seq_conta_proc_w,0) > 0) then 
		ie_gerar_coorrencia_p	:= 'N';
	else 
		ie_gerar_coorrencia_p	:= 'S';
	end if;
else 
	ie_gerar_coorrencia_p	:= 'N';
end if;
 
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_oc_pacote_conv ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, ie_gerar_coorrencia_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

