-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pre_anest_lista_espera ( nr_seq_lista_espera bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
cd_pessoa_fisica_w	varchar(10);
cd_medico_w		varchar(10);
dt_cirurgia_w		timestamp;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_doenca_cid_w		varchar(10);
cd_template_w		bigint;
nr_seq_proc_interno_w	bigint;
nr_seq_ehr_reg_template_w	bigint;
nr_seq_ehr_registro_w		bigint;

BEGIN
 
cd_template_w := Obter_Param_Usuario(874, 40, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, cd_template_w);
 
SELECT	cd_pessoa_fisica, 
	cd_medico_exec, 
	dt_desejada, 
	cd_procedimento, 
	ie_origem_proced, 
	cd_cid 
into STRICT	cd_pessoa_fisica_w, 
	cd_medico_w, 
	dt_cirurgia_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	cd_doenca_cid_w 
from	agenda_lista_espera 
where	nr_sequencia	= nr_seq_lista_espera;
 
select	nextval('aval_pre_anestesica_seq') 
into STRICT	nr_sequencia_w
;
 
nr_sequencia_p	:= nr_sequencia_w;
 
insert into aval_pre_anestesica( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_seq_lista_espera, 
	dt_avaliacao, 
	cd_avaliador, 
	cd_pessoa_fisica, 
	cd_medico, 
	cd_procedimento, 
	ie_origem_proced, 
	cd_doenca_cid) 
values ( 
	nr_sequencia_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_lista_espera, 
	clock_timestamp(), 
	obter_pessoa_fisica_usuario(nm_usuario_p,'C'), 
	cd_pessoa_fisica_w, 
	cd_medico_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	cd_doenca_cid_w);
 
/*update	agenda_paciente 
set	nr_seq_aval_pre = nr_sequencia_w 
where 	nr_sequencia = nr_seq_agenda_p;*/
 
 
if (coalesce(cd_template_w,0) > 0) then 
 
	select 	nextval('ehr_registro_seq') 
	into STRICT	nr_seq_ehr_registro_w 
	;
	 
	select	nextval('ehr_reg_template_seq') 
	into STRICT	nr_seq_ehr_reg_template_w 
	;
 
	insert into ehr_registro( 
						nr_sequencia, 
						cd_paciente, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						dt_registro, 
						cd_profissional, 
						nr_seq_aval_pre) 
					values ( 
						nr_seq_ehr_registro_w, 
						cd_pessoa_fisica_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						cd_medico_w, 
						nr_sequencia_w);
						 
	insert into ehr_reg_template( 
						nr_sequencia, 
						nr_seq_reg, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						dt_registro, 
						nr_seq_template) 
					values ( 
						nr_seq_ehr_reg_template_w, 
						nr_seq_ehr_registro_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						cd_template_w);						
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pre_anest_lista_espera ( nr_seq_lista_espera bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

