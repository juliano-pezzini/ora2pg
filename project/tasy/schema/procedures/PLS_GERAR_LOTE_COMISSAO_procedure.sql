-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_comissao ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_referencia_w			timestamp;
ie_lote_contabil_w		varchar(1);
nr_seq_canal_venda_w		bigint;
ie_tipo_repasse_w		varchar(2);
nr_seq_classificacao_w		smallint;
nr_seq_vendedor_w		bigint;	
nr_seq_comissao_w		bigint;
nr_seq_comissao_benef_w		bigint;
qt_comissoes_w			bigint;
qt_equipe_w			bigint;
vl_lancamento_w			double precision;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_vendedor
	where (nr_sequencia = nr_seq_canal_venda_w or	coalesce(nr_seq_canal_venda_w,0) = 0)
	and (nr_seq_classif_canal = nr_seq_classificacao_w or coalesce(nr_seq_classificacao_w,0) = 0)
	and	ie_situacao = 'A'
	and	cd_estabelecimento = cd_estabelecimento_p;


BEGIN

select	trunc(dt_referencia,'month'),
	nr_seq_canal_venda,
	ie_tipo_repasse,
	nr_seq_classificacao
into STRICT	dt_referencia_w,
	nr_seq_canal_venda_w,
	ie_tipo_repasse_w,
	nr_seq_classificacao_w
from	pls_lote_comissao
where	nr_sequencia = nr_seq_lote_p;

ie_lote_contabil_w	:= obter_se_lote_contabil_gerado(24, dt_referencia_w);

if (ie_lote_contabil_w = 'S') then
	/* o e possivel concluir a acao executada pois existe um lote contabil gerado para a competencia #@DT_COMPETENCIA#@! */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(458996, 'DT_COMPETENCIA=' || to_char(dt_referencia_w,'mm/yyyy'));
end if;

select	count(*)
into STRICT	qt_comissoes_w
from	pls_comissao		b,
	pls_lote_comissao	a
where	a.nr_sequencia = b.nr_seq_lote
and	a.nr_sequencia = nr_seq_lote_p
and	a.dt_referencia = dt_referencia_w;

if (qt_comissoes_w > 0) then /*Apagar beneficiarios e canais de vendas existentes (de um lote de comissao) antes de o mesmo ser gerado -- Objetivo: nao duplicar comissoes*/
	CALL pls_desfazer_lote_comissao(nr_seq_lote_p, nm_usuario_p, cd_estabelecimento_p);									
end if;

/* ie_tipo_repasse_w:
	A 	= Atingimento de meta por equipes
	L  	= Liberacao de itens pendentes
	B               	= Movimento mensal (baseado nas movimentacoes cadastrais)
	M               	= Movimento mensal (baseado nos valores faturados)
*/
if (ie_tipo_repasse_w in ('M','L','B')) then
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_vendedor_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	nextval('pls_comissao_seq')
		into STRICT	nr_seq_comissao_w
		;
	
		insert into pls_comissao(	nr_sequencia,
						nr_seq_lote,
						nr_seq_canal_venda,
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec,
						ie_regra_parcelamento)
				values (		nr_seq_comissao_w,
			 			nr_seq_lote_p,
						nr_seq_vendedor_w,
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p,
						'S');
	
		if (ie_tipo_repasse_w = 'M') then
			CALL pls_definir_comissao_mensal(nr_seq_lote_p, nr_seq_vendedor_w, nr_seq_comissao_w, dt_referencia_w, nm_usuario_p, cd_estabelecimento_p);
		elsif (ie_tipo_repasse_w = 'B') then
			CALL pls_gerar_lote_comissao_mov(nr_seq_lote_p, nr_seq_vendedor_w, nr_seq_comissao_w, nm_usuario_p, cd_estabelecimento_p);
		elsif (ie_tipo_repasse_w = 'L') then
			CALL pls_gerar_lote_comissao_itens(nr_seq_lote_p, nr_seq_vendedor_w, nr_seq_comissao_w, nm_usuario_p, cd_estabelecimento_p);
		end if;
		CALL pls_gerar_desf_comis_lanc_adic(nr_seq_vendedor_w, nr_seq_comissao_w, dt_referencia_w, nm_usuario_p, cd_estabelecimento_p, 'G');		

		CALL pls_ajustar_valores_comissao(nr_seq_comissao_w, nm_usuario_p, cd_estabelecimento_p);		
		end;
	end loop;
	close C01;
	end;
elsif (ie_tipo_repasse_w = 'A') then
	pls_comissao_equipe_pck.gerar_lote_comissao_equipe(nr_seq_lote_p, nr_seq_canal_venda_w, dt_referencia_w, nr_seq_classificacao_w, nm_usuario_p, cd_estabelecimento_p);
end if;

update	pls_lote_comissao
set	dt_geracao = clock_timestamp(),
	ie_status = 'G'
where	nr_sequencia = nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_comissao ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

