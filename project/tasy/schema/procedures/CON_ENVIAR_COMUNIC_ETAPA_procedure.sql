-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE con_enviar_comunic_etapa ( nr_sequencia_p bigint, nr_seq_contrato_p bigint, cd_setor_adicional_p text, nm_usuario_p text, nr_seq_gerado_p INOUT text) AS $body$
DECLARE

 
nm_pessoa_resp_w		varchar(40);
ds_etapa_w		varchar(80);
ds_tipo_etapa_w		varchar(100);
ds_objeto_contrato_w	varchar(1000);
ds_titulo_w		varchar(255);
nr_seq_classif_w		bigint;
ds_aviso_w		varchar(4000);
nr_sequencia_w		bigint;
ie_comunic_interna_w	varchar(01);
ie_email_w		varchar(01);
cd_estabelecimento_w	smallint;
ds_email_origem_w		varchar(255);
ds_email_w		varchar(255);
ds_obs_etapa_w		varchar(255);
nr_seq_contrato_w		bigint;
dt_vencimento_w		timestamp;
contador_w		bigint := 0;
nr_seq_aux_w		varchar(2000);
qt_registro_w		bigint;
nr_seq_regra_w		bigint;
ds_comunicado_w		text;
ds_comunicado_email_w	text;
ds_contrato_w		varchar(255);
ds_tipo_contrato_w		varchar(255);
dt_inicio_etapa_w		timestamp;
dt_fim_etapa_w		timestamp;
ds_observacao_w		varchar(255);
nr_seq_conversao_w	varchar(20);
vl_etapa_w		varchar(30);

c01 CURSOR FOR 
SELECT	substr(obter_usuario_pessoa(cd_pessoa_resp),1,40), 
	coalesce(ie_comunic_interna,'S'), 
	coalesce(ie_email,'N'), 
	substr(obter_dados_pf_pj(cd_pessoa_resp, null,'M'),1,255) 
from	contrato_resp_etapa 
where	nr_seq_etapa 	= nr_sequencia_p 
and	nr_seq_contrato	= nr_seq_contrato_p;


BEGIN 
 
select	ds_etapa, 
	substr(Obter_Descricao_Padrao('CONTRATO_TIPO_ETAPA','DS_TIPO_ETAPA',nr_seq_tipo_etapa),1,100), 
	ds_observacao, 
	campo_mascara_virgula_casas(coalesce(vl_etapa,0),4) 
into STRICT	ds_etapa_w, 
	ds_tipo_etapa_w, 
	ds_obs_etapa_w, 
	vl_etapa_w 
from	contrato_etapa 
where	nr_sequencia	= nr_sequencia_p 
and	nr_seq_contrato	= nr_seq_contrato_p;
 
select	ds_objeto_contrato, 
	nr_sequencia, 
	dt_fim 
into STRICT	ds_objeto_contrato_w, 
	nr_seq_contrato_w, 
	dt_vencimento_w 
from	contrato 
where	nr_sequencia	= nr_seq_contrato_p;
 
ds_titulo_w	:= substr(wheb_mensagem_pck.get_texto(314894,'DS_OBJETO_CONTRATO='||ds_objeto_contrato_w),1,255);
 
select	obter_classif_comunic('F') 
into STRICT	nr_seq_classif_w
;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	contrato 
where	nr_sequencia 	= nr_seq_contrato_p;
 
select	substr(obter_dados_pf_pj('',cd_cgc,'M'),1,255) 
into STRICT	ds_email_origem_w 
from	estabelecimento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (coalesce(ds_email_origem_w::text, '') = '') then 
	select	substr(obter_dados_pf_pj_estab(cd_estabelecimento_w, '', cd_cgc, 'M'),1,255) 
	into STRICT	ds_email_origem_w 
	from	estabelecimento 
	where	cd_estabelecimento = cd_estabelecimento_w;
end if;
	 
open c01;
loop 
fetch c01 into 
	nm_pessoa_resp_w, 
	ie_comunic_interna_w, 
	ie_email_w, 
	ds_email_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	select	count(*) 
	into STRICT	qt_registro_w 
	from	padrao_comunic_contrato 
	where	ie_situacao = 'A';
	 
	if (qt_registro_w = 0) then 
	 
		ds_aviso_w	:= 	wheb_mensagem_pck.get_texto(301996) || ': ' ||chr(9) || chr(9) || nr_seq_contrato_w || chr(13) || chr(10) || 
					wheb_mensagem_pck.get_texto(309960) || ': '||chr(9) || to_char(dt_vencimento_w, 'dd/mm/yyyy') || chr(13) || chr(10) || 
					wheb_mensagem_pck.get_texto(314895) || ': ' ||chr(9) || chr(9) || ds_etapa_w || chr(13) || chr(10) || 
					wheb_mensagem_pck.get_texto(309957) || ': '||chr(9) || chr(9) || ds_tipo_etapa_w || chr(13) || chr(10);
		 
		if (ds_obs_etapa_w IS NOT NULL AND ds_obs_etapa_w::text <> '') then 
			ds_aviso_w	:= substr(ds_aviso_w || wheb_mensagem_pck.get_texto(314896) || ': ' || chr(9) ||ds_obs_etapa_w || chr(13) || chr(10),1,4000);
		end if;
		 
		ds_aviso_w	:= substr(ds_aviso_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(314897),1,4000);
		ds_comunicado_w	:= ds_aviso_w;
		ds_comunicado_email_w := ds_aviso_w;
	else 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_regra_w 
		from	padrao_comunic_contrato 
		where	ie_situacao = 'A';
		 
		BEGIN 
		SELECT	ds_comunicado 
		INTO STRICT	ds_comunicado_w 
		FROM	padrao_comunic_contrato 
		WHERE	nr_sequencia = nr_seq_regra_w;
		EXCEPTION 
		WHEN OTHERS THEN 
			CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(316400);
		END;
 
		SELECT	coalesce(ds_titulo,ds_titulo_w) 
		INTO STRICT	ds_titulo_w 
		FROM	padrao_comunic_contrato 
		WHERE	nr_sequencia = nr_seq_regra_w;
		 
		select	obter_dados_etapa_contrato(nr_sequencia_p, 'NR_CO'), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'DS_CO'),1,255), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'TC'),1,255), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'DE'),1,255), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'TE'),1,255), 
			obter_dados_etapa_contrato(nr_sequencia_p, 'DI'), 
			obter_dados_etapa_contrato(nr_sequencia_p, 'DF'), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'OBJ'),1,255), 
			substr(obter_dados_etapa_contrato(nr_sequencia_p, 'OBS'),1,255) 
		into STRICT	nr_seq_contrato_w, 
			ds_contrato_w, 
			ds_tipo_contrato_w, 
			ds_etapa_w, 
			ds_tipo_etapa_w, 
			dt_inicio_etapa_w, 
			dt_fim_etapa_w, 
			ds_objeto_contrato_w, 
			ds_observacao_w 
		;
		 
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@contrato',nr_seq_contrato_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@contratado',ds_contrato_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@tipo_contrato',ds_tipo_contrato_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@descricao_etapa',ds_etapa_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@tipo_etapa',ds_tipo_etapa_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@data_inicio',dt_inicio_etapa_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@data_fim',dt_fim_etapa_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@objeto_contrato',ds_objeto_contrato_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@observacao',ds_observacao_w);
		ds_comunicado_w	:= replace_macro(ds_comunicado_w,'@valor_etapa',vl_etapa_w);
		 
		 
		nr_seq_conversao_w := converte_rtf_string(	'select :ds_comunicado_p from dual', ds_comunicado_w, nm_usuario_p, nr_seq_conversao_w);
					 
		if ((nr_seq_conversao_w)::numeric  > 0) then 
			 
			select	ds_texto 
			into STRICT	ds_comunicado_email_w 
			from	tasy_conversao_rtf 
			where	nr_sequencia = (nr_seq_conversao_w)::numeric;
			 
		end if;
		 
	end if;
 
	if (ie_comunic_interna_w = 'S') then 
		select	nextval('comunic_interna_seq') 
		into STRICT	nr_sequencia_w 
		;
		 
		insert into comunic_interna( 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			nm_usuario, 
			dt_atualizacao, 
			ie_geral, 
			nm_usuario_destino, 
			nr_sequencia, 
			ie_gerencial, 
			nr_seq_classif, 
			dt_liberacao, 
			cd_setor_destino) 
		values (clock_timestamp(), 
			ds_titulo_w, 
			ds_comunicado_w, 
			nm_usuario_p, 
			clock_timestamp(), 
			'N', 
			nm_pessoa_resp_w, 
			nr_sequencia_w, 
			'N', 
			nr_seq_classif_w, 
			clock_timestamp(), 
			cd_setor_adicional_p);
	end if;
 
	if (ie_email_w = 'S') and ((trim(both ds_email_w) IS NOT NULL AND (trim(both ds_email_w))::text <> '')) then 
		 
		CALL enviar_email(	ds_titulo_w, 
				ds_comunicado_email_w, 
				ds_email_origem_w, 
				ds_email_w, 
				nm_usuario_p, 
				'A');
	end if;	
	 
	contador_w := contador_w + 1;
	 
	if (contador_w = 1) then 
		nr_seq_aux_w := nr_sequencia_w;
	else 
		nr_seq_aux_w := nr_seq_aux_w || ',' || nr_sequencia_w;
	end if;
		 
	end;
end loop;
close c01;
 
commit;
 
nr_seq_gerado_p := nr_seq_aux_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE con_enviar_comunic_etapa ( nr_sequencia_p bigint, nr_seq_contrato_p bigint, cd_setor_adicional_p text, nm_usuario_p text, nr_seq_gerado_p INOUT text) FROM PUBLIC;

