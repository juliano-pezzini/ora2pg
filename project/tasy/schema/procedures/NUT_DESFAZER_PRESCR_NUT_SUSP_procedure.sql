-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_desfazer_prescr_nut_susp ( nr_prescricao_p bigint, nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

						
nr_seq_serv_dia_w				bigint;
nr_seq_Serv_rep_w				bigint;
ie_tipo_w						varchar(5);
ie_existe_w						varchar(1);
ie_agrupador_w					smallint;
nr_prescricao_rep_w				bigint;
ie_npt_adulta_w					varchar(5);
ds_npt_adulta_w					varchar(2);
nr_atendimento_w				atendimento_paciente.nr_atendimento%type;
nr_seq_prescricao_w				prescr_medica.nr_prescricao%type;
ie_define_ult_presc_cond_w		varchar(2);

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	nut_atend_serv_dia a,
			prescr_medica b
	where	b.nr_prescricao = nr_prescricao_p
	and		a.dt_servico between b.dt_inicio_prescr and b.dt_validade_prescr
	and		a.nr_atendimento = b.nr_atendimento;
	

BEGIN
/*Ao suspender um item da prescrição, definir a última prescrição gerada como sendo de conduta para os serviços de nutrição dentro da vigência.*/

ie_define_ult_presc_cond_w := obter_valor_param_usuario(924, 1184, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	open c01;
	loop
	fetch c01 into nr_seq_serv_dia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin		
		
		ie_existe_w := 'N';
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_serv_rep_w
		from	nut_atend_serv_dia_rep a
		where	a.nr_seq_serv_dia = nr_seq_serv_dia_w;
		
		if (nr_seq_serv_rep_w <> 0) then
			if (nm_tabela_p = 'PRESCR_DIETA') then
				
				select	coalesce(max('S'),'N')				
				into STRICT	ie_existe_w
				from	prescr_dieta a
				where	a.nr_prescricao = nr_prescricao_p
				and	obter_se_dieta_cpoe_susp(a.nr_seq_dieta_cpoe, a.nr_prescricao, coalesce(ie_suspenso,'N')) = 'N';
				
				if (ie_existe_w = 'N') then
					ie_tipo_w := 'DO';
				end if;
				
			elsif (nm_tabela_p = 'REP_JEJUM') then
				
				begin
				
				select	'S'				
				into STRICT	ie_existe_w
				from	rep_jejum a
				where	a.nr_prescricao = nr_prescricao_p
				and	coalesce(a.ie_suspenso,'N') = 'N'  LIMIT 1;				
				exception when others then
					ie_existe_w := 'N';
				end;
				
				if (ie_existe_w = 'N') then
					ie_tipo_w := 'JE';
				end if;								
				
			elsif (nm_tabela_p = 'PRESCR_MATERIAL') then
			
				select	max(ie_agrupador)
				into STRICT	ie_agrupador_w
				from	prescr_material a
				where	a.nr_sequencia = nr_sequencia_p
				and	a.nr_prescricao = nr_prescricao_p;
				
				begin
				
				select	'S'				
				into STRICT	ie_existe_w
				from	prescr_material a
				where	a.nr_prescricao = nr_prescricao_p
				and	a.ie_agrupador = ie_agrupador_w
				and	coalesce(a.ie_suspenso,'N') = 'N'  LIMIT 1;				
				exception when others then
					ie_existe_w := 'N';
				end;
				
				if (ie_existe_w = 'N') then
					if (ie_agrupador_w = 8) then
						ie_tipo_w := 'NE';
					elsif (ie_agrupador_w = 12) then	
						ie_tipo_w := 'SO';
					end if;
				end if;
				
			elsif (nm_tabela_p = 'NUT_PAC') then
			
				begin
				
				select	max(ie_npt_adulta),
					CASE WHEN max(ie_npt_adulta)='N' THEN 'NN' WHEN max(ie_npt_adulta)='P' THEN 'NP' WHEN max(ie_npt_adulta)='S' THEN 'NA' END
				into STRICT	ie_npt_adulta_w,
					ds_npt_adulta_w
				from	nut_pac
				where	nr_prescricao = nr_prescricao_p
				and	nr_sequencia = nr_sequencia_p;
			
				select	'S'				
				into STRICT	ie_existe_w
				from	nut_pac a
				where	a.nr_prescricao = nr_prescricao_p
				and	ie_npt_adulta 	= ie_npt_adulta_w
				and	coalesce(a.ie_suspenso,'N') = 'N'  LIMIT 1;				
				exception when others then
					ie_existe_w := 'N';
				end;
				
				if (ie_existe_w = 'N') then
					ie_tipo_w := ds_npt_adulta_w;					
				end if;	
				
			elsif (nm_tabela_p = 'TODOS') then
				ie_tipo_w := 'T';
			end if;	
			
			if (ie_tipo_w IS NOT NULL AND ie_tipo_w::text <> '') and (ie_existe_w = 'N') then
				
				CALL Desfazer_Prescricao_Nutricao(nr_prescricao_p, nr_seq_Serv_rep_w, nr_seq_serv_dia_w, ie_tipo_w, nm_usuario_p);
				
				if (ie_define_ult_presc_cond_w = 'S') then
															
					select	nut_obter_prescr_conduta_susp(nr_prescricao_p, nr_atendimento_w)
					into STRICT	nr_seq_prescricao_w
					;
							
					if (nr_seq_prescricao_w IS NOT NULL AND nr_seq_prescricao_w::text <> '') then
						CALL Definir_Prescricao_Nutricao(nr_seq_prescricao_w, 0, nr_seq_serv_dia_w, 'T', nm_usuario_p);
					end if;									
				end if;
				
				select	max(coalesce(nr_prescr_oral,nr_prescr_jejum,nr_prescr_compl,nr_prescr_enteral,nr_prescr_npt_adulta,nr_prescr_npt_ped,nr_prescr_npt_neo))
				into STRICT	nr_prescricao_rep_w
				from	nut_atend_serv_dia_rep a
				where	a.nr_sequencia = nr_seq_Serv_rep_w;
				
				if (coalesce(nr_prescricao_rep_w::text, '') = '') then
					CALL Liberar_Servico_Nutricao(nr_seq_serv_dia_w, nm_usuario_p, 'D');
				end if;

			end if;	
		end if;
		
		end;
	end loop;
	close c01;

end if;


if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_desfazer_prescr_nut_susp ( nr_prescricao_p bigint, nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

