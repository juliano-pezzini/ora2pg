-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_ajustar_itens_susp ( lista_itens_p text, dt_suspensao_p timestamp, nm_usuario_p text, lista_itens_ret_p INOUT text, ie_forma_suspensao_p text default 'P', ds_lista_sol_consistir_p INOUT text DEFAULT NULL, lista_itens_ex_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


nr_sequencia_w     		cpoe_dieta.nr_sequencia%type;
ie_tipo_item_w     		cpoe_dieta.ie_tipo_dieta%type;
ie_tipo_dieta_w    		varchar(4);
nr_dose_ataque_w   		cpoe_material.nr_sequencia%type;
nr_dose_adicional_w		cpoe_material.nr_sequencia%type;
nr_atendimento_w		cpoe_material.nr_atendimento%type;
cd_pessoa_fisica_w		cpoe_material.cd_pessoa_fisica%type;
ie_controle_tempo_w		cpoe_material.ie_controle_tempo%type;

nr_sequencia_solucao_w	bigint;

nr_prescricao_w			prescr_medica.nr_prescricao%type;

ie_consiste_em_adm_w 	varchar(1);
ie_out_consistencia_w	varchar(5);
lista_itens_aux_w    	varchar(4000);
ie_control_return_ex_w	boolean;
ie_control_return_w		boolean;

dt_fim_w				timestamp;
qt_registro_w 			bigint;
ie_em_exame_w			varchar(1);
ie_consiste_BE_w		varchar(1);
ie_susp_glicemia_w		varchar(1);
ie_exame_w				varchar(1);
cd_estabelecimento_w	bigint;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
nr_seq_procedimento_w	prescr_procedimento.nr_sequencia%type;
nr_status_inicial_w		proced_patologia_status.nr_sequencia%type;
nr_status_final_w		proced_patologia_status.nr_sequencia%type;
qt_conta_def_w					bigint;
ie_perm_susp_proc_integ_w		varchar(1);
ie_tipo_npt_w        bigint;
nr_seq_item_w        bigint;

nr_seq_mat_prescr_w		prescr_material.nr_sequencia%type;
ie_modificado_w			prescr_procedimento.ie_modificado%type;
ie_cancelar_autor_prescr_w	parametro_faturamento.ie_cancelar_autor_prescr%type;
nr_count_adm_w		bigint;
ie_permite_susp_w varchar(1);


BEGIN

/*
[254658;M,  456786;N,  15648;P]
'254658' = sequencia do registro
'M' = Tipo item
*/
cd_estabelecimento_w := obter_estabelecimento_ativo();
ie_susp_glicemia_w := Obter_Param_Usuario(924, 407, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_susp_glicemia_w);
ie_consiste_BE_w := Obter_Param_Usuario(924, 660, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_BE_w);
ie_em_exame_w := Obter_Param_Usuario(924, 117, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_em_exame_w);
ie_exame_w := Obter_Param_Usuario(924, 91, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exame_w);
ie_perm_susp_proc_integ_w := Obter_Param_Usuario(924, 1100, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_perm_susp_proc_integ_w);

select		coalesce(max(ie_cancelar_autor_prescr), 'N')
into STRICT		ie_cancelar_autor_prescr_w
from		parametro_faturamento
where		cd_estabelecimento = cd_estabelecimento_w;

if (lista_itens_p IS NOT NULL AND lista_itens_p::text <> '') then
	ie_consiste_em_adm_w := Obter_Param_Usuario(924, 330, obter_perfil_ativo, nm_usuario_p, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_consiste_em_adm_w);	
	ie_control_return_w := false;
	lista_itens_aux_w :=   substr(lista_itens_p,2,length(lista_itens_p) - 2 ) ||', ';

   while(lista_itens_aux_w IS NOT NULL AND lista_itens_aux_w::text <> '') loop
    begin

	  ie_control_return_ex_w := false;
	  qt_registro_w := 0;
	  nr_sequencia_w := substr( lista_itens_aux_w,1,position(';' in lista_itens_aux_w) - 1);--254658 = sequencia do registro
	  lista_itens_aux_w := substr( lista_itens_aux_w,position(';' in lista_itens_aux_w) + 1,length( lista_itens_aux_w ) - 1);--  ;M,  456786;N,  15648;P]
	  ie_tipo_item_w := substr( lista_itens_aux_w, 1,position(',' in lista_itens_aux_w) - 1);--'M' = Tipo item
	  lista_itens_aux_w := substr( lista_itens_aux_w,position(',' in lista_itens_aux_w) + 1,length( lista_itens_aux_w ));--;S,  456786;N,  15648;P]
		if (ie_tipo_item_w = 'N') then--Dietas
            begin
                select	max(dt_fim),
                        max(nr_atendimento),
                        max(cd_pessoa_fisica),
                        CASE WHEN max(ie_tipo_dieta)='E' THEN 'SNE' WHEN max(ie_tipo_dieta)='P' THEN 'NPTA' WHEN max(ie_tipo_dieta)='I' THEN 'NPTI' END
                into STRICT	dt_fim_w,
                        nr_atendimento_w,
                        cd_pessoa_fisica_w,
                        ie_tipo_dieta_w
                from	cpoe_dieta
                where  	nr_sequencia = nr_sequencia_w;

                if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then

                    nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, ie_tipo_dieta_w, nr_atendimento_w, cd_pessoa_fisica_w);

                    if (ie_tipo_dieta_w = 'SNE') then
                        select	max(c.nr_sequencia)
                        into STRICT	nr_sequencia_solucao_w
                        from	prescr_medica a,
                                prescr_material c
                        where	a.nr_prescricao = c.nr_prescricao
                        and		a.nr_atendimento = nr_atendimento_w
                        and		a.nr_prescricao = nr_prescricao_w
                        and		c.nr_seq_dieta_cpoe = nr_sequencia_w
                        and     c.ie_agrupador = 8;

                        ie_out_consistencia_w := consistir_status_solucao_adep(2, nr_prescricao_w, nr_sequencia_solucao_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314, nr_atendimento_w, nr_sequencia_w);

                    elsif (ie_tipo_dieta_w = 'NPTA' or ie_tipo_dieta_w = 'NPTI') then

                        if (ie_tipo_dieta_w = 'NPTA') then
                            ie_tipo_npt_w := 6; -- existe duas chamadas para NPT Adulta: 4 ou 6
                        elsif (ie_tipo_dieta_w = 'NPTI') then
                            -- (N) neonatal -> 5

                            -- (I) pediatrica/infatil -> 7
                            select CASE WHEN cpoe_obter_tipo_npt(cd_pessoa_fisica_w,nr_atendimento_w)='N' THEN 5 WHEN cpoe_obter_tipo_npt(cd_pessoa_fisica_w,nr_atendimento_w)='I' THEN 7 END
                            into STRICT ie_tipo_npt_w
;
                        end if;

                        select	max(c.nr_sequencia)
                        into STRICT	nr_sequencia_solucao_w
                        from	prescr_medica a, 
                                nut_pac c 
                        where   a.nr_prescricao = c.nr_prescricao
                        and		a.nr_atendimento = nr_atendimento_w
                        and		a.nr_prescricao = nr_prescricao_w
                        and		c.nr_seq_npt_cpoe = nr_sequencia_w;

                        ie_out_consistencia_w := consistir_status_solucao_adep(ie_tipo_npt_w, nr_prescricao_w, nr_sequencia_solucao_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314, nr_atendimento_w, nr_sequencia_w);			

                    end if;



                    update 	cpoe_dieta
                    set	    nm_usuario_susp	= nm_usuario_p,
                            dt_suspensao = dt_suspensao_p,
                            dt_lib_suspensao  = NULL,
                            ie_forma_suspensao = ie_forma_suspensao_p
                    where  	nr_sequencia = nr_sequencia_w;			

                    if (coalesce(ie_out_consistencia_w,'X') in ('SSI','SSIP')) then
                        if (coalesce(ds_lista_sol_consistir_p::text, '') = '') then
                            ds_lista_sol_consistir_p := nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        else
                            ds_lista_sol_consistir_p := ds_lista_sol_consistir_p || nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        end if;
                    end if;
                else 
                    ie_control_return_w := true;
                end if;			
			end;

		elsif (ie_tipo_item_w = 'M' or ie_tipo_item_w = 'MA') then--Materiais
			begin

			select	max(coalesce(dt_fim_cih, dt_fim)),
					max(nr_atendimento),
					max(cd_pessoa_fisica),
					max(ie_controle_tempo)
			into STRICT	dt_fim_w,
					nr_atendimento_w,
					cd_pessoa_fisica_w,
					ie_controle_tempo_w
			from	cpoe_material
			where  	nr_sequencia = nr_sequencia_w;

			if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then

			    /*
				nfcunha - SO 2435209 - 14/Mai/2021

				A function obter_prescr_item_cpoe nao aceita 'MA' como um parametro valido, entao usamos 'MAT' quando eh um material.

				------------------------------------------------------------------------


				The function 'obter_prescr_item_cpoe' doesn't handles 'MA' as a valid parameter for 'ie_tipo_item_p', so we use 'MAT' when it's a medical material.

			    */
			    if ie_tipo_item_w = 'MA' then 	
				nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, 'MAT', nr_atendimento_w, cd_pessoa_fisica_w);
			    else
				nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, ie_tipo_item_w, nr_atendimento_w, cd_pessoa_fisica_w);
			    end if;

				select		max(c.nr_sequencia_solucao),
						max(c.nr_sequencia),
						max(c.ie_modificado)
				into STRICT		nr_sequencia_solucao_w,
						nr_seq_mat_prescr_w,
						ie_modificado_w
				from		prescr_medica a,
						prescr_material c
				where		a.nr_prescricao = c.nr_prescricao
				and		a.nr_atendimento = nr_atendimento_w
				and		c.nr_seq_mat_cpoe = nr_sequencia_w
				and		a.nr_prescricao = nr_prescricao_w;

				ie_out_consistencia_w := consistir_status_solucao_adep(1, nr_prescricao_w, nr_sequencia_solucao_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314);			

				if (ie_cancelar_autor_prescr_w <> 'N') and (ie_modificado_w <> 'S') then
					CALL suspender_autor_convenio(nr_prescricao_w,
						null,
						nr_seq_mat_prescr_w,
						nm_usuario_p);
				end if;

				select 	max(nr_sequencia)
				into STRICT	nr_dose_ataque_w
				from	cpoe_material
				where	nr_seq_ataque = nr_sequencia_w;

				select 	max(nr_sequencia)					
				into STRICT	nr_dose_adicional_w
				from	cpoe_material
				where	nr_seq_adicional = nr_sequencia_w;

				if (nr_dose_ataque_w IS NOT NULL AND nr_dose_ataque_w::text <> '') then

					select 	count(*)
					into STRICT	nr_count_adm_w
					from	prescr_mat_hor b,
							prescr_material c
					where	b.nr_prescricao   = c.nr_prescricao
					and		b.nr_seq_material = c.nr_sequencia
					and		c.nr_seq_mat_cpoe = nr_dose_ataque_w
					and		(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
					and		coalesce(b.dt_suspensao::text, '') = '';

					if (nr_count_adm_w = 0) then
						update 	cpoe_material
						set	    nm_usuario_susp	= nm_usuario_p,
								dt_suspensao = dt_suspensao_p,
								dt_lib_suspensao  = NULL,
								ie_forma_suspensao = ie_forma_suspensao_p
						where  	nr_sequencia = nr_dose_ataque_w;
					end if;
				end if;

				if (nr_dose_adicional_w IS NOT NULL AND nr_dose_adicional_w::text <> '') then

					select 	count(*)
					into STRICT	nr_count_adm_w
					from	prescr_mat_hor b,
						prescr_material c
					where	b.nr_prescricao   = c.nr_prescricao
					and	b.nr_seq_material = c.nr_sequencia
					and	c.nr_seq_mat_cpoe = nr_dose_adicional_w
					and	(b.dt_fim_horario IS NOT NULL AND b.dt_fim_horario::text <> '')
					and	coalesce(b.dt_suspensao::text, '') = '';

					if (nr_count_adm_w = 0) then
						update 	cpoe_material
						set	nm_usuario_susp	= nm_usuario_p,
							dt_suspensao = dt_suspensao_p,
							dt_lib_suspensao  = NULL,
							ie_forma_suspensao = ie_forma_suspensao_p
						where  	nr_sequencia = nr_dose_adicional_w;
					end if;
				end if;

				update 	cpoe_material
				set	    nm_usuario_susp	= nm_usuario_p,
						dt_suspensao = dt_suspensao_p,
						dt_lib_suspensao  = NULL,
						ie_forma_suspensao = ie_forma_suspensao_p
				where  	nr_sequencia = nr_sequencia_w;

				if (coalesce(ie_out_consistencia_w,'X') in ('SSI','SSIP')) then
					if (coalesce(ds_lista_sol_consistir_p::text, '') = '') then
						ds_lista_sol_consistir_p := nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
					else
						ds_lista_sol_consistir_p := ds_lista_sol_consistir_p || nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
					end if;

				end if;

			else
				ie_control_return_w := true;
			end if;

			end;
		elsif ( ie_tipo_item_w = 'P') then--Procedimento
			if (ie_perm_susp_proc_integ_w = 'N') then
				select	count(1)
				into STRICT	qt_conta_def_w
				from	prescr_procedimento
				where	(dt_integracao IS NOT NULL AND dt_integracao::text <> '')
				and		NR_SEQ_PROC_CPOE = nr_sequencia_w;

				if (qt_conta_def_w > 0) then
					--Nao e possivel realizar a suspensao pois a data de integracao foi informada em exame(s)/procedimento(s) desta prescricao! Parametro [1100] da REP.
					CALL wheb_mensagem_pck.exibir_mensagem_abort(226792);
				end if;
			end if;	

			ie_permite_susp_w := CPOE_PERMITE_EDIT_EXAM_EXEC(nr_sequencia_w, nm_usuario_p);

			select	max(dt_fim)
			into STRICT	dt_fim_w
			from	cpoe_procedimento
			where  	nr_sequencia = nr_sequencia_w;

			if (( coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p )) and (ie_permite_susp_w = 'S')then

                select		max(nr_atendimento),
                        max(cd_pessoa_fisica)
                into STRICT		nr_atendimento_w,
                        cd_pessoa_fisica_w
                from	cpoe_procedimento
                where  	nr_sequencia = nr_sequencia_w;

                 nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, ie_tipo_item_w, nr_atendimento_w, cd_pessoa_fisica_w);

                select	coalesce(max(a.nr_sequencia),0)	
                into STRICT	nr_seq_procedimento_w
                from	prescr_procedimento a,
                    prescr_medica b,
                    cpoe_procedimento c
                where   a.nr_prescricao = b.nr_prescricao
                and 	a.nr_seq_proc_cpoe = c.nr_sequencia
                and 	b.nr_prescricao = nr_prescricao_w
                and	nr_seq_proc_cpoe = nr_sequencia_w;		

                select	max(cd_procedimento),
                    max(ie_modificado)
                into STRICT	cd_procedimento_w,
                    ie_modificado_w
                from	prescr_procedimento
                where	nr_prescricao	= nr_prescricao_w
                and	nr_sequencia	= nr_seq_procedimento_w;


				update 	cpoe_procedimento
				set	    nm_usuario_susp	= nm_usuario_p,
						dt_suspensao = dt_suspensao_p,
						dt_lib_suspensao  = NULL,
						ie_forma_suspensao = ie_forma_suspensao_p
				where  	nr_sequencia = nr_sequencia_w;

				update 	cpoe_material
				set	    nm_usuario_susp	= nm_usuario_p,
						dt_suspensao = dt_suspensao_p,
						dt_lib_suspensao  = NULL,
						ie_forma_suspensao = ie_forma_suspensao_p
				where  	nr_seq_procedimento = nr_sequencia_w;

				if (ie_cancelar_autor_prescr_w <> 'N') and (ie_modificado_w <> 'S') then
					CALL suspender_autor_convenio(nr_prescricao_w,
						nr_seq_procedimento_w, 
						null, 
						nm_usuario_p);
				end if;


			elsif (ie_permite_susp_w = 'N') then
				ie_control_return_ex_w := true;
			else
				ie_control_return_w := true;
			end if;

		elsif (ie_tipo_item_w = 'G') then --Gasoterapia
            begin
			    select	max(dt_fim),
                        max(nr_atendimento),
                        max(cd_pessoa_fisica)
                into STRICT	dt_fim_w,
                        nr_atendimento_w,
                        cd_pessoa_fisica_w
                from	cpoe_gasoterapia
                where  	nr_sequencia = nr_sequencia_w;

                if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then

                    nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, 'O', nr_atendimento_w, cd_pessoa_fisica_w);

                    select	max(c.nr_sequencia)
                    into STRICT	nr_seq_item_w
                    from	prescr_medica a,
                            prescr_gasoterapia c
                    where	a.nr_prescricao = c.nr_prescricao
                    and		a.nr_atendimento = nr_atendimento_w
                    and		a.nr_prescricao = nr_prescricao_w
                    and		c.nr_seq_gas_cpoe = nr_sequencia_w
                    and	    (c.nr_seq_gas IS NOT NULL AND c.nr_seq_gas::text <> '');

                    ie_out_consistencia_w := consistir_status_solucao_adep(9, nr_prescricao_w, nr_seq_item_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314, nr_atendimento_w);		




					update 	cpoe_gasoterapia
                    set	    nm_usuario_susp	= nm_usuario_p,
                             dt_suspensao = dt_suspensao_p,
                             dt_lib_suspensao  = NULL,
                             ie_forma_suspensao = ie_forma_suspensao_p
                    where  	nr_sequencia = nr_sequencia_w;

                    if (coalesce(ie_out_consistencia_w,'X') in ('SSI','SSIP')) then			
                        if (coalesce(ds_lista_sol_consistir_p::text, '') = '') then
                            ds_lista_sol_consistir_p := nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        else
                            ds_lista_sol_consistir_p := ds_lista_sol_consistir_p || nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        end if;
                    end if;
                else 
                    ie_control_return_w := true;
                end if;			
			end;

        elsif (ie_tipo_item_w = 'R') then--Recomendacao
			select	max(dt_fim)
			into STRICT	dt_fim_w
			from	cpoe_recomendacao
			where  	nr_sequencia = nr_sequencia_w;

			if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then				
				update 	cpoe_recomendacao
				set	    nm_usuario_susp	= nm_usuario_p,
						dt_suspensao = dt_suspensao_p,
						dt_lib_suspensao  = NULL,
						ie_forma_suspensao = ie_forma_suspensao_p
				where  	nr_sequencia = nr_sequencia_w;
			else
				ie_control_return_w := true;
			end if;

		elsif (ie_tipo_item_w = 'AP') then--Anatomia Patologica
			select	max(nr_atendimento),
				max(cd_pessoa_fisica)
			into STRICT	nr_atendimento_w,
				cd_pessoa_fisica_w
			from	cpoe_anatomia_patologica
			where  	nr_sequencia = nr_sequencia_w;

			nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, ie_tipo_item_w, nr_atendimento_w, cd_pessoa_fisica_w);

			select	coalesce(max(a.nr_sequencia),0)	
			into STRICT	nr_seq_procedimento_w
			from	prescr_procedimento a,
				prescr_medica b,
				cpoe_anatomia_patologica c
			where   a.nr_prescricao = b.nr_prescricao
			and 	a.nr_seq_proc_cpoe = c.nr_sequencia
			and 	b.nr_prescricao = nr_prescricao_w
			and		nr_seq_proc_cpoe = nr_sequencia_w;

			select	max(cd_procedimento)
			into STRICT	cd_procedimento_w
			from	prescr_procedimento
			where	nr_prescricao	= nr_prescricao_w
			and	nr_sequencia	= nr_seq_procedimento_w;

			select 	max(nr_sequencia)
			into STRICT	nr_status_inicial_w
			from   	proced_patologia_status
			where  	ie_situacao = 'A'
			and 	ie_status_patologia = 'PL';

			select 	max(nr_sequencia)
			into STRICT	nr_status_final_w
			from   	proced_patologia_status
			where  	ie_situacao = 'A'
			and 	ie_status_patologia = 'LB';

			if (ie_exame_w in ('N','S','P')) then 	/* Nao pemite / Somente laboratoriais / Somente exames nao laboratoriais */
				select	count(*)
				into STRICT	qt_registro_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_w
				and		nr_sequencia = nr_seq_procedimento_w
				and		((coalesce(nr_seq_prot_glic::text, '') = '') or (ie_susp_glicemia_w = 'S'))
				and		((ie_status_execucao <> 'BE') or (ie_consiste_BE_w = 'S'))
				and		((cd_motivo_baixa <> 0) or (coalesce(nr_seq_status_pato,nr_status_inicial_w) = nr_status_final_w) or
						((coalesce(nr_seq_status_pato,nr_status_inicial_w) <> nr_status_inicial_w) and (ie_em_exame_w = 'N')));
			elsif (ie_exame_w = 'A') then		/* Permite ambos */
				select	count(*)
				into STRICT	qt_registro_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_w
				and		nr_sequencia = nr_seq_procedimento_w
				and		((ie_status_execucao <> 'BE') or (ie_consiste_BE_w = 'S'))
				and		((coalesce(nr_seq_status_pato,nr_status_inicial_w) <> nr_status_inicial_w) and (ie_em_exame_w = 'N'));
			elsif (ie_exame_w = 'X') and (coalesce(cd_procedimento_w,0) > 0) then		/*Somente exames que sao executados automaticamente 	*/
				select	count(*)
				into STRICT	qt_registro_w
				from	prescr_procedimento
				where	nr_prescricao	= nr_prescricao_w
				and		nr_sequencia	= nr_seq_procedimento_w
				and		((ie_status_execucao <> 'BE') or (ie_consiste_BE_w = 'S'))
				and		coalesce(ie_executado_automatico,'N') <> 'S'
				and		((cd_motivo_baixa <> 0) or (coalesce(nr_seq_status_pato,nr_status_inicial_w) = nr_status_final_w) or
							((coalesce(nr_seq_status_pato,nr_status_inicial_w) <> nr_status_inicial_w) and (ie_em_exame_w = 'N')));
			end if;

			select	max(dt_fim)
			into STRICT	dt_fim_w
			from	cpoe_anatomia_patologica
			where  	nr_sequencia = nr_sequencia_w;

			if ((coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p)) and (coalesce(qt_registro_w,0) = 0)then
				update 	cpoe_anatomia_patologica
				set	nm_usuario_susp	= nm_usuario_p,
					dt_suspensao = dt_suspensao_p,
					dt_lib_suspensao  = NULL,
					ie_forma_suspensao = ie_forma_suspensao_p
				where  	nr_sequencia = nr_sequencia_w;
			elsif (coalesce(qt_registro_w,0) > 0) then
				ie_control_return_ex_w := true;
			else
				ie_control_return_w := true;
			end if;	

		elsif (ie_tipo_item_w = 'H') then --Hemotherapy
			begin
			    select	max(dt_fim),
                        max(nr_atendimento),
                        max(cd_pessoa_fisica)
                into STRICT	dt_fim_w,
                        nr_atendimento_w,
                        cd_pessoa_fisica_w
                from	cpoe_hemoterapia
                where  	nr_sequencia = nr_sequencia_w;

                if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then

                    nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, 'HM', nr_atendimento_w, cd_pessoa_fisica_w);

                    select	max(c.nr_sequencia)
                    into STRICT	nr_sequencia_solucao_w
                    from	prescr_medica a,
                            prescr_procedimento c
                    where	a.nr_prescricao = c.nr_prescricao
                    and		a.nr_atendimento = nr_atendimento_w
                    and		a.nr_prescricao = nr_prescricao_w
                    and		c.nr_seq_proc_cpoe = nr_sequencia_w
                    and	    (c.nr_seq_solic_sangue IS NOT NULL AND c.nr_seq_solic_sangue::text <> '');

                    ie_out_consistencia_w := consistir_status_solucao_adep(3, nr_prescricao_w, nr_sequencia_solucao_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314, nr_atendimento_w, nr_sequencia_w);			



					update 	cpoe_hemoterapia
                    set	    nm_usuario_susp	= nm_usuario_p,
                            dt_suspensao = dt_suspensao_p,
                            dt_lib_suspensao  = NULL,
                            ie_forma_suspensao = ie_forma_suspensao_p
                    where  	nr_sequencia = nr_sequencia_w;

                    if (coalesce(ie_out_consistencia_w,'X') in ('SSI','SSIP')) then
                        if (coalesce(ds_lista_sol_consistir_p::text, '') = '') then
                            ds_lista_sol_consistir_p := nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        else
                            ds_lista_sol_consistir_p := ds_lista_sol_consistir_p || nr_sequencia_w ||','|| ie_out_consistencia_w ||  ';';
                        end if;
                    end if;
                else 
                    ie_control_return_w := true;
                end if;			
			end;
        elsif (ie_tipo_item_w = 'D') then --Dialysis
			begin
			    select	max(dt_fim),
                        max(nr_atendimento),
                        max(cd_pessoa_fisica)
                into STRICT	dt_fim_w,
                        nr_atendimento_w,
                        cd_pessoa_fisica_w
                from	cpoe_dialise
                where  	nr_sequencia = nr_sequencia_w;

                if (coalesce(dt_fim_w::text, '') = '') or (dt_fim_w >= dt_suspensao_p) then

                    nr_prescricao_w := obter_prescr_item_cpoe(nr_sequencia_w, 'DI', nr_atendimento_w, cd_pessoa_fisica_w);

                    select	max(c.nr_seq_solucao)
                    into STRICT	nr_sequencia_solucao_w
                    from	prescr_medica a,
                            prescr_solucao c,
                            hd_prescricao x
                    where	a.nr_prescricao = c.nr_prescricao
                    and     a.nr_prescricao = x.nr_prescricao
                    and		a.nr_atendimento = nr_atendimento_w
                    and		a.nr_prescricao = nr_prescricao_w
                    and		c.nr_seq_dialise_cpoe = nr_sequencia_w
                    and	    (c.nr_seq_dialise IS NOT NULL AND c.nr_seq_dialise::text <> '');

                    ie_out_consistencia_w := consistir_status_solucao_adep(8, nr_prescricao_w, nr_sequencia_solucao_w, ie_consiste_em_adm_w, ie_out_consistencia_w, 2314, nr_atendimento_w, nr_sequencia_w);			



					update 	cpoe_dialise
                    set	    nm_usuario_susp	= nm_usuario_p,
                            dt_suspensao = dt_suspensao_p,
                            dt_lib_suspensao  = NULL,
                            ie_forma_suspensao = ie_forma_suspensao_p
                    where  	nr_sequencia = nr_sequencia_w;

                    if (coalesce(ie_out_consistencia_w,'X')  in ('SSI','SSIP')) then			
                        if (coalesce(ds_lista_sol_consistir_p::text, '') = '') then
                            ds_lista_sol_consistir_p := nr_sequencia_w ||','|| ie_out_consistencia_w || ';';
                        else
                            ds_lista_sol_consistir_p := ds_lista_sol_consistir_p || nr_sequencia_w ||','|| ie_out_consistencia_w || ';';
                        end if;
                    end if;
                else 
                    ie_control_return_w := true;
                end if;			
			end;
		end if;		

		if (ie_control_return_w) then
			if (coalesce(lista_itens_ret_p::text, '') = '') then
				lista_itens_ret_p := nr_sequencia_w || ';';
			else
				lista_itens_ret_p := lista_itens_ret_p || nr_sequencia_w || ';';
			end if;			
		end if;	

		if (ie_control_return_ex_w) then
			if (coalesce(lista_itens_ex_p::text, '') = '') then
				lista_itens_ex_p := nr_sequencia_w || ';';
			else
				lista_itens_ex_p := lista_itens_ex_p || nr_sequencia_w || ';';
			end if;			
		end if;	

		ie_control_return_w := false;	

    end;
   end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_ajustar_itens_susp ( lista_itens_p text, dt_suspensao_p timestamp, nm_usuario_p text, lista_itens_ret_p INOUT text, ie_forma_suspensao_p text default 'P', ds_lista_sol_consistir_p INOUT text DEFAULT NULL, lista_itens_ex_p INOUT text  DEFAULT NULL) FROM PUBLIC;

