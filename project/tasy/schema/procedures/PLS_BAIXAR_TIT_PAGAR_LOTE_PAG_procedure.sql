-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baixar_tit_pagar_lote_pag (nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, nr_seq_pagamento_prest_p pls_pagamento_prestador.nr_sequencia%type, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
/* 
ie_acao_p 
	'F' - Fechamento do lote 
	'A' - Reabertura do Lote 
*/
 
 
cd_tipo_baixa_pgto_w			pls_parametro_pagamento.cd_tipo_baixa_pgto%type;
nr_seq_trans_fin_pag_pgto_w		pls_parametro_pagamento.nr_seq_trans_fin_pag_pgto%type;
cd_estabelecimento_w			pls_parametro_pagamento.cd_estabelecimento%type;
nr_seq_baixa_w				titulo_pagar_baixa.nr_sequencia%type;

C01 CURSOR(	nr_seq_lote_cp			pls_lote_pagamento.nr_sequencia%type) FOR 
SELECT	b.nr_titulo, 
	CASE WHEN ie_acao_p='F' THEN  abs(a.vl_movimento)  ELSE abs(a.vl_movimento) * -1 END  vl_saldo_titulo 
from	pls_pagamento_prestador d, 
	pls_pagamento_item c, 
	titulo_pagar	b, 
	pls_evento_movimento a 
where	a.nr_tit_pagar_vinculado	= b.nr_titulo 
and	a.nr_seq_pagamento_item		= c.nr_sequencia 
and	c.nr_seq_pagamento		= d.nr_sequencia 
and	d.nr_sequencia			= coalesce(nr_seq_pagamento_prest_p, d.nr_sequencia) 
and	coalesce(d.ie_cancelamento::text, '') = '' 
and	a.nr_seq_lote_pgto		= nr_seq_lote_cp 

union all
 
SELECT	c.nr_titulo, 
    CASE WHEN ie_acao_p='F' THEN  abs(b.vl_item)  ELSE abs(b.vl_item) * -1 END  vl_saldo_titulo 
from	pls_pagamento_prestador a, 
	pls_pagamento_item b, 
	titulo_pagar c 
where 	a.nr_sequencia 		= b.nr_seq_pagamento 
and  	c.nr_titulo 		= b.nr_tit_pagar_origem 
and  	a.nr_sequencia 		= coalesce(nr_seq_pagamento_prest_p, a.nr_sequencia) 
and  	coalesce(a.ie_cancelamento::text, '') = '' 
and not exists (	select 	1 
        from  	pls_evento_movimento x 
        where 	x.nr_seq_pagamento_item = b.nr_sequencia) 
and	a.nr_seq_lote 		= nr_seq_lote_cp;

BEGIN 
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	pls_lote_pagamento 
where	nr_sequencia		= nr_seq_lote_p;
 
select	max(cd_tipo_baixa_pgto), 
	max(nr_seq_trans_fin_pag_pgto) 
into STRICT	cd_tipo_baixa_pgto_w, 
	nr_seq_trans_fin_pag_pgto_w 
from	pls_parametro_pagamento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (coalesce(cd_tipo_baixa_pgto_w::text, '') = '') or (coalesce(nr_seq_trans_fin_pag_pgto_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(312374);
	-- Não é possível realizar este processo! 
	-- Verifique se os campos "Trans fin pagar pag produção" e "Tipo baixa pag produção" estão informados nos parâmetros do pagamento de produção (OPS - Gestão de Operadoras -> Parâmetros OPS -> Pagamento produção médica). 
end if;
 
for r_c01_w in C01(nr_seq_lote_p) loop 
 
	CALL baixa_titulo_pagar(cd_estabelecimento_w, 
		cd_tipo_baixa_pgto_w, 
		r_c01_w.nr_titulo, 
		r_c01_w.vl_saldo_titulo, 
		nm_usuario_p, 
		nr_seq_trans_fin_pag_pgto_w, 
		null, 
		null, 
		clock_timestamp(), 
		null, 
		null);
 
	-- Atualiza a observação da baixa informando o lote de pagamento que gerou a mesma 
	begin 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_baixa_w 
	from	titulo_pagar_baixa 
	where	nr_titulo	= r_c01_w.nr_titulo;
 
	update	titulo_pagar_baixa 
	set	ds_observacao		= 'Baixa gerada através do lote, ' || nr_seq_lote_p || ', de pagamento de produção médica.' 
	where	nr_sequencia		= nr_seq_baixa_w 
	and	nr_titulo		= r_c01_w.nr_titulo;
	exception 
	when others then 
		null;
	end;
 
	CALL Atualizar_Saldo_Tit_pagar(r_c01_w.nr_titulo, nm_usuario_p);
 
end loop;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baixar_tit_pagar_lote_pag (nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, nr_seq_pagamento_prest_p pls_pagamento_prestador.nr_sequencia%type, ie_acao_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

