-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_emissao_relat_auto ( nr_sequencia_p bigint, dt_emissao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_regra_repet_w		varchar(03);
ie_dia_semana_w			bigint;
qt_intervalo_min_w		bigint;
hr_fixa_w			varchar(05);
dt_proxima_emissao_w		timestamp;
nr_dia_fixo_w			smallint;
cd_dia_semana_w			smallint	:= 0;


BEGIN

select	ie_regra_repet,
	campo_numerico(ie_dia_semana),
	qt_intervalo_min,
	hr_fixa,
	nr_dia_fixo
into STRICT	ie_regra_repet_w,
	ie_dia_semana_w,
	qt_intervalo_min_w,
	hr_fixa_w,
	nr_dia_fixo_w
from 	relatorio_auto_imp
where	nr_sequencia = nr_sequencia_p;


dt_proxima_emissao_w := clock_timestamp() + interval '1 days';

if (ie_regra_repet_w = 'D') then

	dt_proxima_emissao_w := to_date(to_char(trunc(clock_timestamp(),'dd'),'dd/mm/yyyy')||hr_fixa_w,'dd/mm/yyyy hh24:mi');

	if (dt_proxima_emissao_w < dt_emissao_p) then
		dt_proxima_emissao_w := dt_proxima_emissao_w + 1;
	end if;

elsif (ie_regra_repet_w = 'DFS') then

	if (ie_dia_semana_w = 9) then

		select	obter_cod_dia_semana(clock_timestamp() + interval '2 days')
		into STRICT	cd_dia_semana_w
		;

		dt_proxima_emissao_w := to_date(to_char(trunc(clock_timestamp(),'dd'),'dd/mm/yyyy')||hr_fixa_w,'dd/mm/yyyy hh24:mi');

		if (dt_proxima_emissao_w < dt_emissao_p) and (cd_dia_semana_w in (2,3,4,5)) then
			dt_proxima_emissao_w := dt_proxima_emissao_w + 1;

		elsif (dt_proxima_emissao_w < dt_emissao_p) and (cd_dia_semana_w = 6) then
			dt_proxima_emissao_w := dt_proxima_emissao_w + 3;

		elsif (dt_proxima_emissao_w < dt_emissao_p) and (cd_dia_semana_w = 7) then
			dt_proxima_emissao_w := dt_proxima_emissao_w + 2;

		elsif (dt_proxima_emissao_w < dt_emissao_p) and (cd_dia_semana_w = 1) then
			dt_proxima_emissao_w := dt_proxima_emissao_w + 1;
		end if;
	else
		dt_proxima_emissao_w := to_date(to_char(trunc(clock_timestamp(),'d') + ie_dia_semana_w - 1 ,'dd/mm/yyyy')||hr_fixa_w,'dd/mm/yyyy hh24:mi');

		if (dt_proxima_emissao_w < dt_emissao_p) then
			dt_proxima_emissao_w := dt_proxima_emissao_w + 7;
		end if;

	end if;

elsif (ie_regra_repet_w	= 'IT') then

	dt_proxima_emissao_w := dt_emissao_p + qt_intervalo_min_w/1440;

elsif (ie_regra_repet_w = 'M') then

	if (nr_dia_fixo_w > 1) then
		nr_dia_fixo_w := nr_dia_fixo_w -1;
	else
		nr_dia_fixo_w := 0;
	end if;

	dt_proxima_emissao_w := to_date(to_char(trunc(clock_timestamp(),'mm') + nr_dia_fixo_w,'dd/mm/yyyy')||hr_fixa_w,'dd/mm/yyyy hh24:mi');

	if (dt_proxima_emissao_w < dt_emissao_p) then
		dt_proxima_emissao_w := to_date(to_char(trunc(dt_proxima_emissao_w +31,'mm') + nr_dia_fixo_w,'dd/mm/yyyy')||hr_fixa_w,'dd/mm/yyyy hh24:mi');
	end if;

end if;

update	relatorio_auto_imp
set	dt_ultima_emissao = dt_emissao_p,
	dt_proxima_emissao = dt_proxima_emissao_w,
	dt_atualizacao = clock_timestamp(),
	nm_usuario = nm_usuario_p
where	nr_sequencia = nr_sequencia_p;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_emissao_relat_auto ( nr_sequencia_p bigint, dt_emissao_p timestamp, nm_usuario_p text) FROM PUBLIC;

