-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mapa_menu_item_tab ( cd_funcao_p bigint, nr_seq_funcao_schematic_p bigint) AS $body$
DECLARE


nr_seq_funcao_schematic_w	funcao_schematic.nr_sequencia%type;
nr_seq_obj_sup_w		objeto_schematic.nr_sequencia%type;
nr_seq_obj_sup_ww		objeto_schematic.nr_sequencia%type;
ie_tipo_obj_navegador_w		objeto_schematic.ie_tipo_obj_navegador%type;
ie_tipo_componente_w		objeto_schematic.ie_tipo_componente%type;
ie_tipo_objeto_w		objeto_schematic.ie_tipo_objeto%type;
nr_seq_w_mapa_item_tab_w	w_mapa_item_tab.nr_sequencia%type;
ds_objeto_w			varchar(500);
ds_pasta_w			varchar(2000);
ds_seq_pasta_w			varchar(2000);

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_menu_item,
		obter_desc_expressao(cd_exp_texto, '') ds_menu_item,
		c.nr_sequencia nr_seq_objeto_schematic,
		coalesce(c.ie_tipo_componente, 'X') ie_tipo_componente
	from	dic_objeto a,
		objeto_schematic c
	where	a.nr_seq_obj_sup = c.nr_seq_dic_objeto
	and	c.nr_seq_funcao_schematic = nr_seq_funcao_schematic_w
	and	a.ie_tipo_objeto = 'MI'
	order by c.nr_sequencia;

c01_w	c01%rowtype;


BEGIN

nr_seq_funcao_schematic_w := nr_seq_funcao_schematic_p;

delete FROM w_mapa_item_tab
where nr_seq_funcao_schematic = nr_seq_funcao_schematic_w;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	nr_seq_obj_sup_w := 0;
	ie_tipo_obj_navegador_w := '';
	ds_pasta_w := '';
	ds_seq_pasta_w := '';



	select	max(nr_seq_obj_sup),
		max(ie_tipo_obj_navegador),
		max(substr(obter_desc_expressao(cd_exp_desc_obj, DS_OBJETO), 1, 300) || CASE WHEN coalesce(ie_tipo_componente::text, '') = '' THEN  ''  ELSE ' ('|| ie_tipo_componente ||')' END ),
		max(ie_tipo_componente),
		max(ie_tipo_objeto)
	into STRICT	nr_seq_obj_sup_w,
		ie_tipo_obj_navegador_w,
		ds_objeto_w,
		ie_tipo_componente_w,
		ie_tipo_objeto_w
	from	objeto_schematic
	where	nr_sequencia = c01_w.nr_seq_objeto_schematic;

	if (ie_tipo_obj_navegador_w IS NOT NULL AND ie_tipo_obj_navegador_w::text <> '') or (coalesce(ie_tipo_componente_w, 'X') = 'WDLG') or (coalesce(ie_tipo_objeto_w, 'X') in ('T','IT')) then
		ds_pasta_w := substr(ds_objeto_w || ' / ' || ds_pasta_w, 1, 2000);
		ds_seq_pasta_w := substr(nr_seq_obj_sup_w || ' / ' || ds_seq_pasta_w, 1, 2000);
	end if;

	while 	coalesce(nr_seq_obj_sup_w, 0) > 0 loop

		select	max(nr_seq_obj_sup),
			max(ie_tipo_obj_navegador),
			max(substr(obter_desc_expressao(cd_exp_desc_obj, DS_OBJETO), 1, 300) || CASE WHEN coalesce(ie_tipo_componente::text, '') = '' THEN  ''  ELSE ' ('|| ie_tipo_componente ||')' END ),
			max(ie_tipo_componente),
			max(ie_tipo_objeto)
		into STRICT	nr_seq_obj_sup_w,
			ie_tipo_obj_navegador_w,
			ds_objeto_w,
			ie_tipo_componente_w,
			ie_tipo_objeto_w
		from	objeto_schematic
		where	nr_sequencia = nr_seq_obj_sup_w;

		if (ie_tipo_obj_navegador_w IS NOT NULL AND ie_tipo_obj_navegador_w::text <> '') or (coalesce(ie_tipo_componente_w, 'X') = 'WDLG') or (coalesce(ie_tipo_objeto_w, 'X') in ('T','IT')) then
			ds_pasta_w := substr(ds_objeto_w || ' / ' || ds_pasta_w, 1, 2000);
			ds_seq_pasta_w := substr(nr_seq_obj_sup_w || ' / ' || ds_seq_pasta_w, 1, 2000);
		end if;

		--nr_seq_obj_sup_w := nr_seq_obj_sup_ww;
	end loop;

	select	nextval('w_mapa_item_tab_seq')
	into STRICT	nr_seq_w_mapa_item_tab_w
	;

	insert into w_mapa_item_tab(
		nr_sequencia,
		dt_atualizacao,
		ds_seq_pasta,
		ds_pasta,
		nr_seq_menu_item,
		ds_menu_item,
		nr_seq_funcao_schematic)
	values (	nr_seq_w_mapa_item_tab_w,
		clock_timestamp(),
		ds_seq_pasta_w,
		coalesce(ds_pasta_w, 'Tab principal'),
		c01_w.nr_seq_menu_item,
		c01_w.ds_menu_item,
		nr_seq_funcao_schematic_w);

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mapa_menu_item_tab ( cd_funcao_p bigint, nr_seq_funcao_schematic_p bigint) FROM PUBLIC;

