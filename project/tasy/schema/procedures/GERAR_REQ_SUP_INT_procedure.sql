-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_req_sup_int ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, dt_solicitacao_requisicao_p timestamp, dt_liberacao_p timestamp, cd_operacao_estoque_p bigint, cd_pessoa_requisitante_p text, cd_pessoa_solicitante_p text, cd_setor_atendimento_p bigint, cd_estabelecimento_destino_p bigint, cd_local_estoque_destino_p bigint, cd_setor_entrega_p bigint, cd_centro_custo_p bigint, ds_observacao_p text, nm_usuario_p text, nr_requisicao_p INOUT bigint, nr_documento_externo_p bigint default null) AS $body$
DECLARE


nr_seq_requisicao_w		bigint;
ie_de_para_unid_med_w		varchar(1);
ie_de_para_material_w		varchar(1);
nr_seq_item_w			bigint;
cd_material_w			varchar(80);
cd_material_ww			varchar(80);
qt_material_requisitada_w	double precision;
qt_material_atendida_w		double precision;
cd_unidade_medida_consumo_w	varchar(30);
qt_conv_estoque_consumo_w	double precision;
cd_unidade_medida_estoque_w	varchar(30);
qt_estoque_w			double precision;
qt_existe_material_w		bigint;

c01 CURSOR FOR
SELECT	nr_seq_item,
	cd_unidade_medida,
	cd_material,
	qt_material_requisitada,
	qt_material_atendida
from	sup_int_req_item
where	nr_sequencia = nr_sequencia_p;


BEGIN

select	nextval('requisicao_seq')
into STRICT	nr_seq_requisicao_w
;

insert into requisicao_material(
	nr_requisicao,
	cd_estabelecimento,
	cd_local_estoque,
	dt_solicitacao_requisicao,
	cd_operacao_estoque,
	cd_pessoa_requisitante,
	cd_pessoa_solicitante,
	cd_setor_atendimento,
	cd_estabelecimento_destino,
	cd_local_estoque_destino,
	cd_centro_custo,
	ds_observacao,
	ie_urgente,
	ie_geracao,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_documento_externo)
values (
	nr_seq_requisicao_w,
	cd_estabelecimento_p,
	cd_local_estoque_p,
	dt_solicitacao_requisicao_p,
	cd_operacao_estoque_p,
	cd_pessoa_requisitante_p,
	cd_pessoa_solicitante_p,
	cd_setor_atendimento_p,
	cd_estabelecimento_destino_p,
	cd_local_estoque_destino_p,
	cd_centro_custo_p,
	ds_observacao_p,
	'N',
	'I',
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_documento_externo_p);

select	obter_ie_de_para_sup_integr('RM','R','UNIDADE_MEDIDA'),
	obter_ie_de_para_sup_integr('RM','R','MATERIAL')
into STRICT	ie_de_para_unid_med_w,
	ie_de_para_material_w
;

open c01;
loop
fetch c01 into
	nr_seq_item_w,
	cd_unidade_medida_consumo_w,
	cd_material_w,
	qt_material_requisitada_w,
	qt_material_atendida_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	/*Conversao para material*/

	if (ie_de_para_material_w = 'C') then
		cd_material_ww	:= coalesce(Obter_Conversao_interna(null,'MATERIAL','CD_MATERIAL',cd_material_w),cd_material_w);
	elsif (ie_de_para_material_w = 'S') then
		begin

		select	coalesce(max(cd_material),0)
		into STRICT	cd_material_ww
		from	material_estab
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_sistema_ant = to_char(cd_material_w);

		if (cd_material_ww = 0) then
			begin

			select	coalesce(max(cd_material),0)
			into STRICT	cd_material_ww
			from	material
			where	cd_sistema_ant = to_char(cd_material_w);

			end;
		end if;

		end;
	end if;

	select	count(*)
	into STRICT	qt_existe_material_w
	from	material
	where	cd_material = cd_material_ww;

	if (qt_existe_material_w > 0) then
		begin

		select	coalesce(qt_conv_estoque_consumo,1),
			cd_unidade_medida_estoque,
			cd_unidade_medida_consumo
		into STRICT	qt_conv_estoque_consumo_w,
			cd_unidade_medida_estoque_w,
			cd_unidade_medida_consumo_w
		from	material
		where	cd_material = cd_material_ww;

		qt_estoque_w := dividir(qt_material_requisitada_w,qt_conv_estoque_consumo_w);

		insert into item_requisicao_material(
			nr_requisicao,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			qt_material_atendida,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			ie_acao,
			cd_motivo_baixa,
			qt_estoque,
			cd_unidade_medida_estoque,
			ie_geracao)
		values (
			nr_seq_requisicao_w,
			nr_seq_item_w,
			cd_estabelecimento_p,
			cd_material_ww,
			qt_material_requisitada_w,
			0,
			0,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida_consumo_w,
			'I',
			0,
			qt_estoque_w,
			cd_unidade_medida_estoque_w,
			'I');

		end;
	end if;

	end;
end loop;
close c01;

if (dt_liberacao_p IS NOT NULL AND dt_liberacao_p::text <> '') then
	begin

	update	item_requisicao_material
	set	dt_aprovacao = clock_timestamp(),
		nm_usuario_aprov = nm_usuario_p
	where	nr_requisicao = nr_seq_requisicao_w;

	update	requisicao_material
	set	dt_aprovacao = clock_timestamp(),
		nm_usuario_aprov = nm_usuario_p,
		dt_liberacao = clock_timestamp(),
		nm_usuario_lib = nm_usuario_p
	where	nr_requisicao = nr_seq_requisicao_w;

	end;
end if;

nr_requisicao_p	:= nr_seq_requisicao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_req_sup_int ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, dt_solicitacao_requisicao_p timestamp, dt_liberacao_p timestamp, cd_operacao_estoque_p bigint, cd_pessoa_requisitante_p text, cd_pessoa_solicitante_p text, cd_setor_atendimento_p bigint, cd_estabelecimento_destino_p bigint, cd_local_estoque_destino_p bigint, cd_setor_entrega_p bigint, cd_centro_custo_p bigint, ds_observacao_p text, nm_usuario_p text, nr_requisicao_p INOUT bigint, nr_documento_externo_p bigint default null) FROM PUBLIC;

