-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_item_auditoria ( nr_seq_auditoria_p bigint, cd_procedimento_p bigint, ie_origem_proced_p text, nr_seq_material_p bigint, qt_item_proc_p bigint, qt_item_mat_p bigint, vl_material_p bigint, nm_usuario_p text, ie_tipo_anexo_p text, cd_estabelecimento_p bigint, ie_pacote_ptu_p text, cd_ref_fabricante_imp_p pls_auditoria_item.cd_ref_fabricante_imp%type, nr_registro_anvisa_p pls_auditoria_item.nr_registro_anvisa%type, nr_seq_item_proc_p INOUT bigint, nr_seq_item_mat_p INOUT bigint, vl_inicial_p bigint default null) AS $body$
DECLARE

				
ie_tipo_despesa_w		varchar(10);
ie_pacote_w			varchar(1);
ie_tipo_item_w			varchar(1);

nr_seq_item_w			bigint;
nr_seq_prestador_w		bigint;
nr_seq_requisicao_w		bigint;
nr_seq_guia_w			bigint;

ie_regra_preco_w		varchar(3);
nr_seq_regra_preco_pac_w	bigint;
nr_seq_pacote_w			bigint;
ie_tipo_processo_w		varchar(2);
ie_tipo_intercambio_w		varchar(2);
ie_origem_solic_w		varchar(2);


BEGIN

begin
select	coalesce(nr_seq_requisicao,0),
	coalesce(nr_seq_guia,0)
into STRICT	nr_seq_requisicao_w,
	nr_seq_guia_w
from	pls_auditoria
where	nr_sequencia	= nr_seq_auditoria_p;
exception
when others then
	nr_seq_requisicao_w	:= 0;
	nr_seq_guia_w		:= 0;
end;

if (nr_seq_guia_w > 0) then
	begin
		select	ie_tipo_processo,
			ie_tipo_intercambio,
			ie_origem_solic
		into STRICT	ie_tipo_processo_w,
			ie_tipo_intercambio_w,
			ie_origem_solic_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	exception
	when others then
		ie_tipo_processo_w	:= null;
		ie_tipo_intercambio_w	:= null;
	end;

	if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
		-- Você não pode realizar esta ação em uma guia recebida via intercâmbio!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(271396);
	elsif (ie_origem_solic_w	= 'E') then
		-- Você não pode realizar esta ação em uma guia recebida eletronicamente!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(676204);
	end if;
elsif (nr_seq_requisicao_w > 0) then
	begin
		select	ie_tipo_processo,
			ie_tipo_intercambio,
			ie_origem_solic
		into STRICT	ie_tipo_processo_w,
			ie_tipo_intercambio_w,
			ie_origem_solic_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;
	exception
	when others then
		ie_tipo_processo_w	:= null;
		ie_tipo_intercambio_w	:= null;
	end;

	if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
		-- Você não pode realizar esta ação em uma requisição recebida via intercâmbio!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(358870);
	elsif (ie_origem_solic_w	= 'E') then
		-- Você não pode realizar esta ação em uma requisição recebida eletronicamente!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(676205);
	end if;
end if;

if (cd_procedimento_p <> 0) then
	ie_tipo_item_w	:= 'P';
	
	select	nextval('pls_auditoria_item_seq')
	into STRICT	nr_seq_item_w
	;
	
	select	coalesce(nr_seq_prestador,0)
	into STRICT	nr_seq_prestador_w
	from	pls_auditoria
	where	nr_sequencia = nr_seq_auditoria_p;
	
	select 	coalesce(max(ie_classificacao),1)
	into STRICT	ie_tipo_despesa_w
	from	procedimento
	where	cd_procedimento		= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p;

	if (nr_seq_prestador_w	> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_pacote_w
		from	pls_pacote
		where	coalesce(nr_seq_prestador,coalesce(nr_seq_prestador_w,0))	= coalesce(nr_seq_prestador_w,0)
		and	cd_procedimento		= cd_procedimento_p
		and	ie_origem_proced	= ie_origem_proced_p
		and	ie_situacao		= 'A';
		
		if (ie_pacote_w	= 'S') then			
			ie_tipo_despesa_w	:= '4';
		end if;
	end if;
	
	insert into pls_auditoria_item(nr_sequencia, nr_seq_auditoria, cd_procedimento,
		ie_origem_proced, qt_original, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
		qt_ajuste, ie_status, ie_acao_auditor,
		ie_tipo_despesa, ie_status_solicitacao, ie_tipo_anexo,
		ie_pacote_ptu)
	values (nr_seq_item_w, nr_seq_auditoria_p, cd_procedimento_p,
		ie_origem_proced_p, CASE WHEN qt_item_proc_p=0 THEN 1  ELSE qt_item_proc_p END , clock_timestamp(),
		nm_usuario_p, clock_timestamp(), nm_usuario_p,
		CASE WHEN qt_item_proc_p=0 THEN 1  ELSE qt_item_proc_p END ,'P', 'I',
		ie_tipo_despesa_w, 'P', ie_tipo_anexo_p,
		coalesce(ie_pacote_ptu_p,'N'));
		
	/* Francisco - 16/05/2012 - OS 447352 */

	if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') and (nr_seq_requisicao_w	> 0)  then
		select	coalesce(ie_regra_preco,'N')
		into STRICT	ie_regra_preco_w
		from	pls_pacote a
		where	a.nr_sequencia = nr_seq_pacote_w;
		
		if (ie_regra_preco_w = 'S') then
			SELECT * FROM pls_obter_regra_preco_pacote(cd_procedimento_p, ie_origem_proced_p, 'AR', nr_seq_item_w, nm_usuario_p, nr_seq_pacote_w, nr_seq_regra_preco_pac_w) INTO STRICT nr_seq_pacote_w, nr_seq_regra_preco_pac_w;
						
			if (coalesce(nr_seq_pacote_w::text, '') = '') and (ie_tipo_despesa_w = '4') then
				select 	coalesce(max(ie_classificacao),1)
				into STRICT	ie_tipo_despesa_w
				from	procedimento
				where	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p;
				
				update	pls_auditoria_item
				set	ie_tipo_despesa	= ie_tipo_despesa_w
				where	nr_sequencia	= nr_seq_item_w;
			end if;
		end if;
	end if;
	
	CALL pls_gerar_hist_log_req(nr_seq_item_w,1,nm_usuario_p,0,0,0,0);
	nr_seq_item_proc_p := nr_seq_item_w;
	
	CALL pls_lanc_auto_auditoria(nr_seq_auditoria_p,nr_seq_item_w,ie_tipo_item_w,nm_usuario_p,cd_estabelecimento_p);
end if;

if (nr_seq_material_p <> 0) then
	ie_tipo_item_w	:= 'M';
	
	select	nextval('pls_auditoria_item_seq')
	into STRICT	nr_seq_item_w
	;
	
	select 	max(ie_tipo_despesa)
	into STRICT	ie_tipo_despesa_w
	from	pls_material
	where	nr_sequencia = nr_seq_material_p;
	
	insert into pls_auditoria_item(nr_sequencia, nr_seq_auditoria, nr_seq_material,
		qt_original, dt_atualizacao, nm_usuario, 
		dt_atualizacao_nrec, nm_usuario_nrec, qt_ajuste,
		ie_status, ie_acao_auditor,ie_tipo_despesa,
		vl_item, ie_status_solicitacao, ie_tipo_anexo,
		ie_pacote_ptu, vl_original, cd_ref_fabricante_imp,
		nr_registro_anvisa)
	values (nr_seq_item_w, nr_seq_auditoria_p, nr_seq_material_p,
		CASE WHEN qt_item_mat_p=0 THEN 1  ELSE qt_item_mat_p END , clock_timestamp(), nm_usuario_p, 
		clock_timestamp(), nm_usuario_p, CASE WHEN qt_item_mat_p=0 THEN 1  ELSE qt_item_mat_p END ,
		'P', 'I',ie_tipo_despesa_w,
		vl_material_p, 'P', ie_tipo_anexo_p,
		'N', coalesce(vl_inicial_p,vl_material_p), cd_ref_fabricante_imp_p,
		nr_registro_anvisa_p);
		
	CALL pls_gerar_hist_log_req(nr_seq_item_w,1,nm_usuario_p,0,0,0,0);
	nr_seq_item_mat_p := nr_seq_item_w;
	
	CALL pls_lanc_auto_auditoria(nr_seq_auditoria_p,nr_seq_item_w,ie_tipo_item_w,nm_usuario_p,cd_estabelecimento_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_item_auditoria ( nr_seq_auditoria_p bigint, cd_procedimento_p bigint, ie_origem_proced_p text, nr_seq_material_p bigint, qt_item_proc_p bigint, qt_item_mat_p bigint, vl_material_p bigint, nm_usuario_p text, ie_tipo_anexo_p text, cd_estabelecimento_p bigint, ie_pacote_ptu_p text, cd_ref_fabricante_imp_p pls_auditoria_item.cd_ref_fabricante_imp%type, nr_registro_anvisa_p pls_auditoria_item.nr_registro_anvisa%type, nr_seq_item_proc_p INOUT bigint, nr_seq_item_mat_p INOUT bigint, vl_inicial_p bigint default null) FROM PUBLIC;

