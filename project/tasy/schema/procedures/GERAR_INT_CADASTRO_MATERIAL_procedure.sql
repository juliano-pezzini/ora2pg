-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_int_cadastro_material ( nr_sequencia_p bigint, nm_usuario_p text, ie_status_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE



ds_erro_w				varchar(4000);
ds_erro_sqlerrm_w			varchar(4000);
qt_registros_w				bigint;
ie_status_w				varchar(15);
cd_retorno_de_para_w			varchar(255);

/*MATERIAL*/

ie_abrigo_luz_w				w_int_cadastro_material.ie_abrigo_luz%type;
ie_baixa_estoq_pac_w			w_int_cadastro_material.ie_baixa_estoq_pac%type;
ie_baixa_inteira_w			w_int_cadastro_material.ie_baixa_inteira%type;
ie_bomba_infusao_w			w_int_cadastro_material.ie_bomba_infusao%type;
ie_cobra_paciente_w			w_int_cadastro_material.ie_cobra_paciente%type;
ie_consignado_w				w_int_cadastro_material.ie_consignado%type;
ie_controle_medico_w			w_int_cadastro_material.ie_controle_medico%type;
ie_curva_abc_w				w_int_cadastro_material.ie_curva_abc%type;
ie_diluicao_w				w_int_cadastro_material.ie_diluicao%type;
ie_disponivel_mercado_w			w_int_cadastro_material.ie_disponivel_mercado%type;
ie_gravar_obs_prescr_w			w_int_cadastro_material.ie_gravar_obs_prescr%type;
ie_inf_ultima_compra_w			w_int_cadastro_material.ie_inf_ultima_compra%type;
ie_mistura_w				w_int_cadastro_material.ie_mistura%type;
ie_obrig_via_aplicacao_w		w_int_cadastro_material.ie_obrig_via_aplicacao%type;
ie_preco_compra_w			w_int_cadastro_material.ie_preco_compra%type;
ie_receita_w				w_int_cadastro_material.ie_receita%type;
ie_situacao_w				w_int_cadastro_material.ie_situacao%type;
ie_solucao_w				w_int_cadastro_material.ie_solucao%type;
ie_umidade_controlada_w			w_int_cadastro_material.ie_umidade_controlada%type;
ds_reduzida_w				w_int_cadastro_material.ds_reduzida%type;
qt_conv_compra_estoque_w		w_int_cadastro_material.qt_conv_compra_estoque%type;
qt_conv_estoque_consumo_w		w_int_cadastro_material.qt_conv_estoque_consumo%type;
qt_minimo_multiplo_solic_w		w_int_cadastro_material.qt_minimo_multiplo_solic%type;
cd_unidade_medida_compra_w		w_int_cadastro_material.cd_unidade_medida_compra%type;
cd_unidade_medida_compra_ww		w_int_cadastro_material.cd_unidade_medida_compra%type;
cd_unidade_medida_consumo_w		w_int_cadastro_material.cd_unidade_medida_consumo%type;
cd_unidade_medida_consumo_ww		w_int_cadastro_material.cd_unidade_medida_consumo%type;
cd_unidade_medida_estoque_w		w_int_cadastro_material.cd_unidade_medida_estoque%type;
cd_unidade_medida_estoque_ww		w_int_cadastro_material.cd_unidade_medida_estoque%type;
cd_unidade_medida_solic_w		w_int_cadastro_material.cd_unidade_medida_solic%type;
cd_unidade_medida_solic_ww		w_int_cadastro_material.cd_unidade_medida_solic%type;
ie_tipo_material_w			w_int_cadastro_material.ie_tipo_material%type;
ie_via_aplicacao_w			w_int_cadastro_material.ie_via_aplicacao%type;
nr_seq_fabric_w				w_int_cadastro_material.nr_seq_fabric%type;
nr_seq_familia_w			w_int_cadastro_material.nr_seq_familia%type;
nr_seq_grupo_rec_w			w_int_cadastro_material.nr_seq_grupo_rec%type;
nr_seq_localizacao_w			w_int_cadastro_material.nr_seq_localizacao%type;
cd_classif_fiscal_w			w_int_cadastro_material.cd_classif_fiscal%type;
cd_fabricante_w				w_int_cadastro_material.cd_fabricante%type;
cd_sistema_ant_w			w_int_cadastro_material.cd_sistema_ant%type;
ds_material_w				w_int_cadastro_material.ds_material%type;
dt_val_cert_aprov_w			w_int_cadastro_material.dt_validade_certificado_aprov%type;
nr_certificado_aprovacao_w		w_int_cadastro_material.nr_certificado_aprovacao%type;
qt_dias_validade_w			w_int_cadastro_material.qt_dias_validade%type;
qt_horas_util_pac_w			w_int_cadastro_material.qt_horas_util_pac%type;
qt_max_prescricao_w			w_int_cadastro_material.qt_max_prescricao%type;
qt_prioridade_coml_w			w_int_cadastro_material.qt_prioridade_coml%type;
cd_classe_material_w			w_int_cadastro_material.cd_classe_material%type;
cd_material_estoque_w			material.cd_material_estoque%type;
cd_material_generico_w			material.cd_material_generico%type;
cd_material_w				material.cd_material%type;

/*MATERIAL ESTABELECIMENTO*/

ie_classif_custo_w			w_int_cad_material_estab.ie_classif_custo%type;
ie_controla_serie_w			w_int_cad_material_estab.ie_controla_serie%type;
ie_curva_xyz_w				w_int_cad_material_estab.ie_curva_xyz%type;
ie_estoque_lote_w			w_int_cad_material_estab.ie_estoque_lote%type;
ie_material_estoque_w			w_int_cad_material_estab.ie_material_estoque%type;
ie_padronizado_w			w_int_cad_material_estab.ie_padronizado%type;
ie_prescricao_w				w_int_cad_material_estab.ie_prescricao%type;
ie_requisicao_w				w_int_cad_material_estab.ie_requisicao%type;
ie_vigente_anvisa_w			w_int_cad_material_estab.ie_vigente_anvisa%type;
ie_ressuprimento_w			w_int_cad_material_estab.ie_ressuprimento%type;
cd_kit_material_w			w_int_cad_material_estab.cd_kit_material%type;
nr_minimo_cotacao_w			w_int_cad_material_estab.nr_minimo_cotacao%type;
cd_estabelecimento_w			w_int_cad_material_estab.cd_estabelecimento%type;
cd_sistema_ant_estab_w			w_int_cad_material_estab.cd_sistema_ant%type;
dt_validade_reg_anvisa_w		w_int_cad_material_estab.dt_validade_reg_anvisa%type;
nr_registro_anvisa_w			w_int_cad_material_estab.nr_registro_anvisa%type;
qt_dia_estoque_minimo_w			w_int_cad_material_estab.qt_dia_estoque_minimo%type;
qt_dia_interv_ressup_w			w_int_cad_material_estab.qt_dia_interv_ressup%type;
qt_dia_ressup_forn_w			w_int_cad_material_estab.qt_dia_ressup_forn%type;
qt_estoque_maximo_w			w_int_cad_material_estab.qt_estoque_maximo%type;
qt_estoque_minimo_w			w_int_cad_material_estab.qt_estoque_minimo%type;
qt_ponto_pedido_w			w_int_cad_material_estab.qt_ponto_pedido%type;
qt_peso_kg_w				w_int_cad_material_estab.qt_peso_kg%type;
cd_material_tasy_w			material.cd_material%type;


C01 CURSOR FOR
SELECT	dt_validade_reg_anvisa,
	cd_estabelecimento,
	cd_kit_material,
	coalesce(nr_minimo_cotacao,1),
	coalesce(qt_dia_estoque_minimo,3),
	coalesce(qt_dia_interv_ressup,15),
	coalesce(qt_dia_ressup_forn,7),
	qt_estoque_maximo,
	qt_estoque_minimo,
	qt_peso_kg,
	qt_ponto_pedido,
	coalesce(cd_sistema_ant,cd_sistema_ant_w),
	coalesce(ie_baixa_estoq_pac,'S'),
	coalesce(ie_classif_custo,'B'),
	coalesce(ie_controla_serie,'N'),
	ie_curva_xyz,
	coalesce(ie_estoque_lote,'N'),
	coalesce(ie_material_estoque,'S'),
	coalesce(ie_padronizado,'S'),
	coalesce(ie_prescricao,'S'),
	coalesce(ie_requisicao,'S'),
	coalesce(ie_vigente_anvisa,'N'),
	coalesce(ie_ressuprimento,'S'),
	nr_registro_anvisa
from 	w_int_cad_material_estab
where 	nr_seq_cad_material = nr_sequencia_p;


BEGIN
ie_status_w	:= 'OK';

select	count(*)
into STRICT	qt_registros_w
from	w_int_cadastro_material
where	nr_sequencia = nr_sequencia_p;


if (qt_registros_w > 0) then

	select	coalesce(ie_abrigo_luz,'N'),
		coalesce(ie_baixa_estoq_pac,'S'),
		coalesce(ie_baixa_inteira,'S'),
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_cobra_paciente,'S'),
		coalesce(ie_consignado,'0'),
		coalesce(ie_controle_medico,0),
		coalesce(ie_curva_abc,'S'),
		coalesce(ie_diluicao,'N'),
		coalesce(ie_disponivel_mercado,'S'),
		coalesce(ie_gravar_obs_prescr,'N'),
		coalesce(ie_inf_ultima_compra,'S'),
		coalesce(ie_mistura,'N'),
		coalesce(ie_obrig_via_aplicacao,'N'),
		coalesce(ie_preco_compra,'N'),
		coalesce(ie_receita,'N'),
		coalesce(ie_situacao,'A'),
		coalesce(ie_solucao,'S'),
		coalesce(ie_umidade_controlada,'N'),
		ds_reduzida,
		ds_material,
		coalesce(qt_conv_compra_estoque,1),
		coalesce(qt_conv_estoque_consumo,1),
		coalesce(qt_minimo_multiplo_solic,1),
		cd_unidade_medida_compra,
		cd_unidade_medida_consumo,
		cd_unidade_medida_estoque,
		cd_unidade_medida_solic,
		coalesce(ie_tipo_material,'1'),
		ie_via_aplicacao,
		nr_seq_fabric,
		nr_seq_familia,
		nr_seq_grupo_rec,
		nr_seq_localizacao,
		cd_classe_material,
		cd_classif_fiscal,
		cd_fabricante,
		cd_sistema_ant,
		dt_validade_certificado_aprov,
		nr_certificado_aprovacao,
		qt_dias_validade,
		qt_horas_util_pac,
		qt_max_prescricao,
		qt_minimo_multiplo_solic,
		qt_prioridade_coml
	into STRICT 	ie_abrigo_luz_w,
		ie_baixa_estoq_pac_w,
		ie_baixa_inteira_w,
		ie_bomba_infusao_w,
		ie_cobra_paciente_w,
		ie_consignado_w,
		ie_controle_medico_w,
		ie_curva_abc_w,
		ie_diluicao_w,
		ie_disponivel_mercado_w,
		ie_gravar_obs_prescr_w,
		ie_inf_ultima_compra_w,
		ie_mistura_w,
		ie_obrig_via_aplicacao_w,
		ie_preco_compra_w,
		ie_receita_w,
		ie_situacao_w,
		ie_solucao_w,
		ie_umidade_controlada_w,
		ds_reduzida_w,
		ds_material_w,
		qt_conv_compra_estoque_w,
		qt_conv_estoque_consumo_w,
		qt_minimo_multiplo_solic_w,
		cd_unidade_medida_compra_w,
		cd_unidade_medida_consumo_w,
		cd_unidade_medida_estoque_w,
		cd_unidade_medida_solic_w,
		ie_tipo_material_w,
		ie_via_aplicacao_w,
		nr_seq_fabric_w,
		nr_seq_familia_w,
		nr_seq_grupo_rec_w,
		nr_seq_localizacao_w,
		cd_classe_material_w,
		cd_classif_fiscal_w,
		cd_fabricante_w,
		cd_sistema_ant_w,
		dt_val_cert_aprov_w,
		nr_certificado_aprovacao_w,
		qt_dias_validade_w,
		qt_horas_util_pac_w,
		qt_max_prescricao_w,
		qt_minimo_multiplo_solic_w,
		qt_prioridade_coml_w
	from	W_INT_CADASTRO_MATERIAL
	where	nr_sequencia = nr_sequencia_p;
else
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_Texto(450133,'DS_TABELA_W='||'W_INT_CADASTRO_MATERIAL'||';NR_SEQUENCIA_W=' || nr_sequencia_p);
	/*Não existe nenhum registro na tabela de #@DS_TABELA_W#@ com o código #@NR_SEQUENCIA_W#@.*/

end if;

if (ie_status_w = 'OK') and (ie_situacao_w not in ('A','I')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458523); /* Favor informar um valor válido para a situação do material.(A para ativo, I para inativo). */
end if;

if (ie_status_w = 'OK') and (ie_baixa_estoq_pac_w not in ('S','N')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_BAIXA_ESTOQUE_PAC'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_abrigo_luz_w not in ('S','N')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_ABRIGO_LUZ'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_baixa_inteira_w not in ('S','N')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_BAIXA_INTEIRA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_bomba_infusao_w not in ('W','S','P','A','B','H','C','Q','U','R','E','K','Z','O','L','F','G','M','X','T','V','Y','I','D','N','J')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452278);/* Favor informar um tipo de bomba infusão válido. 'A' - Bomba de seringa 'B' - Bomba elastomérica 'C' - Cicladora peritoneal 'D' - Máquina de diálise 'E' - Equipo com bureta 'F' - Equipo fotoprotetor 'G' - Equipo gravitacional 'H' - Cateter peridural 'I' - Infusor domiciliar 'J' - Perfusor 'K' - Equipo com filtro 0,2 micra
								'L' - Equipo de PCA 'M' - Equipo macrogotas simples 'N' - Não utiliza 'O' - Equipo de microgotas 'P' - Bomba de PCA 'Q' - Equipo bomba de infusão 'R' - Equipo bureta com bomba de infusão 'S' - Bomba de infusão 'T' - Equipo para transfusão 'U' - Equipo bomba fotossensível
								'V' - Equipo PVC free (baixa adsorção)  'W' - Bolsa pressurizadora 'X' - Bolsa pressurizadora 'Y' - Equipo PVC free foto 'Z' - Equipo de diálise*/
end if;

if (ie_status_w = 'OK') and (coalesce(cd_classe_material_w::text, '') = '') then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458548,'DS_CAMPO='||'CD_CLASSE_MATERIAL'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
end if;

if (ie_status_w = 'OK') and (cd_classe_material_w IS NOT NULL AND cd_classe_material_w::text <> '') then

	select	count(*)
	into STRICT	qt_registros_w
	from	classe_material
	where	cd_classe_material = cd_classe_material_w;

	if (qt_registros_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(458549); /*A classe informada não existe no sistema Tasy.*/
	end if;
end if;

if (ie_status_w = 'OK') and (ie_cobra_paciente_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_COBRA_PACIENTE'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_consignado_w not in ('0','1','2')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458552); /*Favor informar um valor válido para o campo IE_CONSIGNADO (0 para Não consignado, 1 para Consignado e 2 para Ambos)*/
end if;

if (ie_status_w = 'OK') and (ie_controle_medico_w not in (0,1,2,3,4)) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452275); /*Favor informar um tipo de controle médico válido.
									0 - Não controla
									1 - Somente notificação do médico
									2 - Notificação e aprovação
									3 - Avaliação
									4 - Notificação com dias fixos liberados pelo sistema*/
end if;

if (ie_status_w = 'OK') and (ie_curva_abc_w not in ('S','N')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_CURVA_ABC'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_diluicao_w not in ('N','R','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452282); /* Favor informar um tipo de diluição válido.
									'N' - Não utiliza
									'R' - Equipo bureta com bomba de infusão
									'S' - Bomba de infusão*/
end if;

if (ie_status_w = 'OK') and (ie_disponivel_mercado_w not in ('N','E','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452283); /*Favor informar um tipo disponivel no mercado válido.
									'N' - Não disponível no mercado
									'E' - Disponível enquanto houver estoque
									'S' - Disponível no mercado*/
end if;

if (ie_status_w = 'OK') and (ie_gravar_obs_prescr_w not in ('E','N','R','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452285); /* Favor informar um tipo de gravação prescrição válido.
									 E - Gravar reações na prescrição
									 N - Não gravar
									 R - Gravar recomendações na prescrição
									 S - Gravar reações e recomendações na prescrição	*/
end if;

if (ie_status_w = 'OK') and (ie_inf_ultima_compra_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_INF_ULTIMA_COMPRA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_mistura_w not in ('N','I','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458558); /*Favor informar um valor válido para o campo IE_MISTURA (S para Sempre, N para Nunca e I para Só internados)	*/
end if;

if (ie_status_w = 'OK') and (ie_obrig_via_aplicacao_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_OBRIG_VIA_APLICACAO'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_preco_compra_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_PRECO_COMPRA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_receita_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_RECEITA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_solucao_w not in ('N','S','C')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458562); /*Favor informar um valor válido para o campo IE_SOLUCAO (S para Pode ser componente de uma solução, N para Não pode ser componente de uma solução, e C para Somente pode ser componente de solução).*/
end if;

if (ie_status_w = 'OK') and (ie_umidade_controlada_w not in ('N','S')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_UMIDADE_CONTROLADA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (coalesce(ds_reduzida_w::text, '') = '') then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'DS_REDUZIDA'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(ds_material_w::text, '') = '') then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'DS_MATERIAL'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(cd_sistema_ant_w::text, '') = '') then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'CD_SISTEMA_ANT'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (cd_unidade_medida_compra_w IS NOT NULL AND cd_unidade_medida_compra_w::text <> '') then

	select	count(*)
	into STRICT	qt_registros_w
	from	unidade_medida
	where	CD_SISTEMA_ANT = cd_unidade_medida_compra_w
	and	ie_situacao = 'A';

	if (qt_registros_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(482479,'CD_UNIDADE_W='||cd_unidade_medida_compra_w); /*Não existe no Tasy nenhuma unidade de medida ativa com o código do sistema anterior #@CD_UNIDADE_W#@.*/
	else
		select	max(cd_unidade_medida)
		into STRICT	cd_unidade_medida_compra_ww
		from	unidade_medida
		where	CD_SISTEMA_ANT = cd_unidade_medida_compra_w
		and	ie_situacao = 'A';
	end if;
else
	if (ie_status_w = 'OK') and (coalesce(cd_unidade_medida_compra_w::text, '') = '') then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(458548,'DS_CAMPO='||'CD_UNIDADE_MEDIDA_COMPRA'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
	end if;
end if;

if (ie_status_w = 'OK') and (cd_unidade_medida_consumo_w IS NOT NULL AND cd_unidade_medida_consumo_w::text <> '') then

	select	count(*)
	into STRICT	qt_registros_w
	from	unidade_medida
	where	CD_SISTEMA_ANT = cd_unidade_medida_consumo_w
	and	ie_situacao = 'A';

	if (qt_registros_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(482479,'CD_UNIDADE_W='||cd_unidade_medida_consumo_w); /*Não existe no Tasy nenhuma unidade de medida ativa com o código do sistema anterior #@CD_UNIDADE_W#@.*/
	else
		select	max(cd_unidade_medida)
		into STRICT	cd_unidade_medida_consumo_ww
		from	unidade_medida
		where	CD_SISTEMA_ANT = cd_unidade_medida_consumo_w
		and	ie_situacao = 'A';
	end if;
else
	if (ie_status_w = 'OK') and (coalesce(cd_unidade_medida_consumo_w::text, '') = '') then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(458548,'DS_CAMPO='||'CD_UNIDADE_MEDIDA_CONSUMO'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
	end if;
end if;

if (ie_status_w = 'OK') and (cd_unidade_medida_estoque_w IS NOT NULL AND cd_unidade_medida_estoque_w::text <> '') then

	select	count(*)
	into STRICT	qt_registros_w
	from	unidade_medida
	where	CD_SISTEMA_ANT = cd_unidade_medida_estoque_w
	and	ie_situacao = 'A';

	if (qt_registros_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(482479,'CD_UNIDADE_W='||cd_unidade_medida_estoque_w); /*Não existe no Tasy nenhuma unidade de medida ativa com o código do sistema anterior #@CD_UNIDADE_W#@.*/
	else
		select	max(cd_unidade_medida)
		into STRICT	cd_unidade_medida_estoque_ww
		from	unidade_medida
		where	CD_SISTEMA_ANT = cd_unidade_medida_estoque_w
		and	ie_situacao = 'A';
	end if;
else
	if (ie_status_w = 'OK') and (coalesce(cd_unidade_medida_estoque_w::text, '') = '') then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(458548,'DS_CAMPO='||'CD_UNIDADE_MEDIDA_ESTOQUE'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
	end if;
end if;

if (ie_status_w = 'OK') and (cd_unidade_medida_solic_w IS NOT NULL AND cd_unidade_medida_solic_w::text <> '') then

	select	count(*)
	into STRICT	qt_registros_w
	from	unidade_medida
	where	CD_SISTEMA_ANT = cd_unidade_medida_solic_w
	and	ie_situacao = 'A';

	if (qt_registros_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_texto(482479,'CD_UNIDADE_W='||cd_unidade_medida_solic_w); /*Não existe no Tasy nenhuma unidade de medida ativa com o código do sistema anterior #@CD_UNIDADE_W#@.*/
	else
		select	max(cd_unidade_medida)
		into STRICT	cd_unidade_medida_solic_ww
		from	unidade_medida
		where	CD_SISTEMA_ANT = cd_unidade_medida_solic_w
		and	ie_situacao = 'A';
	end if;
end if;

if (ie_status_w = 'OK') and (ie_tipo_material_w not in ('0','1','2','3','4','5','6','7','8','9','10')) then
	ie_status_w	:= 'E';
	ds_erro_w	:= wheb_mensagem_pck.get_texto(452273); /*Favor informar um tipo de material válido.
									0 para o tipo "Medicamento Manipulado"
									1 para o tipo "Material"
									2 para o tipo "Medicamento Comercial"
									3 para o tipo "Medicamento Genérico"
									4 para o tipo "Serviços"
									5 para o tipo "Gêneros Alimentícios"
									6 para o tipo "Medicamento sem apresentação"
									7 para o tipo "Material da bolsa de sangue"
									8 para o tipo "Medicamento exclusivo para faturamento"
									9 para o tipo "Medicamento Similar"
									10 para o tipo "Material exclusivo para faturamento"*/
end if;

if (ie_status_w = 'OK') and (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then

	select	coalesce(bkf_obter_conv_interna('','VIA_APLICACAO','IE_VIA_APLICACAO',ie_via_aplicacao_w,'BKF'),'0')
	into STRICT	cd_retorno_de_para_w
	;

	if (cd_retorno_de_para_w = '0') then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'VIA_APLICACAO'||';DS_ATRIBUTO='||'IE_VIA_APLICACAO'||';CD_CODIGO='||ie_via_aplicacao_w);
		/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

	else
		select	count(*)
		into STRICT	qt_registros_w
		from	via_aplicacao
		where	ie_via_aplicacao = cd_retorno_de_para_w;

		if (qt_registros_w = 0) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458577,'IE_VIA_APLICACAO_TASY_W='||cd_retorno_de_para_w ||';IE_VIA_APLICACAO_INT_W='|| ie_via_aplicacao_w);
			/*Não existe no Tasy a via de aplicação com o código #@IE_VIA_APLICACAO_TASY_W#@. Verifique o cadastro de conversão para o código da via aplicação #@IE_VIA_APLICACAO_INT_W#@ que veio do sistema externo.*/

		else
			ie_via_aplicacao_w := cd_retorno_de_para_w;
		end if;
	end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_fabric_w IS NOT NULL AND nr_seq_fabric_w::text <> '') then

	select	coalesce(somente_numero(bkf_obter_conv_interna('','MAT_FABRICANTE','NR_SEQUENCIA',nr_seq_fabric_w,'BKF')),0)
	into STRICT	cd_retorno_de_para_w
	;

	if (cd_retorno_de_para_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'MAT_FABRICANTE'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_fabric_w); /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/
	else
		select	count(*)
		into STRICT	qt_registros_w
		from	mat_fabricante
		where	nr_sequencia = cd_retorno_de_para_w;

		if (qt_registros_w = 0) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458580,'NR_SEQ_FABRIC_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_FABRIC_INT_W='|| nr_seq_fabric_w);
			/*Não existe no Tasy o fabricante com o código #@NR_SEQ_FABRIC_TASY_W#@. Verifique o cadastro de conversão para o código do fabricante #@NR_SEQ_FABRIC_INT_W#@ que veio do sistema externo.*/

		else
			nr_seq_fabric_w := cd_retorno_de_para_w;
		end if;
	end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_familia_w IS NOT NULL AND nr_seq_familia_w::text <> '') then

	select	coalesce(somente_numero(bkf_obter_conv_interna('','MATERIAL_FAMILIA','NR_SEQUENCIA',nr_seq_familia_w,'BKF')),0)
	into STRICT	cd_retorno_de_para_w
	;

	if (cd_retorno_de_para_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'MATERIAL_FAMILIA'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_familia_w);
		/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

	else
		select	count(*)
		into STRICT	qt_registros_w
		from	material_familia
		where	nr_sequencia = cd_retorno_de_para_w;

		if (qt_registros_w = 0) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458582,'NR_SEQ_FAMILIA_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_FAMILIA_INT_W='|| nr_seq_familia_w);
			/*Não existe no Tasy uma família de materiais com o código #@NR_SEQ_FAMILIA_TASY_W#@. Verifique o cadastro de conversão para o código da familia #@NR_SEQ_FAMILIA_INT_W#@ que veio do sistema externo.*/

		else
			nr_seq_familia_w := cd_retorno_de_para_w;
		end if;
	end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_grupo_rec_w IS NOT NULL AND nr_seq_grupo_rec_w::text <> '') then

	select	coalesce(somente_numero(bkf_obter_conv_interna('','GRUPO_RECEITA','NR_SEQUENCIA',nr_seq_grupo_rec_w,'BKF')),0)
	into STRICT	cd_retorno_de_para_w
	;

	if (cd_retorno_de_para_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'GRUPO_RECEITA'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_grupo_rec_w);
		/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

	else
		select	count(*)
		into STRICT	qt_registros_w
		from	grupo_receita
		where	nr_sequencia = cd_retorno_de_para_w;

		if (qt_registros_w = 0) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458583,'NR_SEQ_GRUPO_REC_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_GRUPO_REC_INT_W='|| nr_seq_grupo_rec_w);
			/*Não existe no Tasy um grupo de receita com o código #@NR_SEQ_GRUPO_REC_TASY_W#@. Verifique o cadastro de conversão para o código do grupo de receita #@NR_SEQ_GRUPO_REC_INT_W#@ que veio do sistema externo.*/

		else
			nr_seq_grupo_rec_w := cd_retorno_de_para_w;
		end if;
	end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then

	select	coalesce(somente_numero(bkf_obter_conv_interna('','MATERIAL_LOCAL','NR_SEQUENCIA',nr_seq_localizacao_w,'BKF')),0)
	into STRICT	cd_retorno_de_para_w
	;

	if (cd_retorno_de_para_w = 0) then
		ie_status_w	:= 'E';
		ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'MATERIAL_LOCAL'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_localizacao_w);
		/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

	else
		select	count(*)
		into STRICT	qt_registros_w
		from	material_local
		where	nr_sequencia = cd_retorno_de_para_w;

		if (qt_registros_w = 0) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458589,'NR_SEQ_LOCAL_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_LOCAL_INT_W='|| nr_seq_localizacao_w);
			/*Não existe no Tasy uma localização com o código #@NR_SEQ_LOCAL_TASY_W#@. Verifique o cadastro de conversão para o código da localização #@NR_SEQ_LOCAL_INT_W#@ que veio do sistema externo.*/

		else
			nr_seq_localizacao_w := cd_retorno_de_para_w;
		end if;
	end if;
end if;


if (ie_status_w = 'OK') then

	select	coalesce(max(cd_material),0)
	into STRICT	cd_material_tasy_w
	from	material
	where	cd_sistema_ant = cd_sistema_ant_w;


	if (cd_material_tasy_w = 0) then

		select	nextval('material_seq')
		into STRICT	cd_material_w
		;


		begin
		insert into material(
			cd_material,
			cd_classif_fiscal,
			cd_fabricante,
			cd_sistema_ant,
			cd_unidade_medida_compra,
			cd_unidade_medida_consumo,
			cd_unidade_medida_estoque,
			cd_unidade_medida_solic,
			ds_material,
			ds_reduzida,
			dt_validade_certificado_aprov,
			ie_abrigo_luz,
			ie_baixa_estoq_pac,
			ie_baixa_inteira,
			ie_bomba_infusao,
			ie_cobra_paciente,
			ie_consignado,
			ie_controle_medico,
			ie_curva_abc,
			ie_diluicao,
			ie_disponivel_mercado,
			ie_gravar_obs_prescr,
			ie_inf_ultima_compra,
			ie_mistura,
			ie_obrig_via_aplicacao,
			ie_preco_compra,
			ie_receita,
			ie_situacao,
			ie_solucao,
			ie_tipo_material,
			ie_umidade_controlada,
			ie_via_aplicacao,
			nr_certificado_aprovacao,
			nr_seq_fabric,
			nr_seq_familia,
			nr_seq_grupo_rec,
			nr_seq_localizacao,
			qt_conv_compra_estoque,
			qt_conv_estoque_consumo,
			qt_dias_validade,
			qt_horas_util_pac,
			qt_max_prescricao,
			qt_minimo_multiplo_solic,
			qt_prioridade_coml,
			cd_material_estoque,
			cd_material_generico,
			cd_classe_material,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_cadastramento,
			ie_material_estoque)
		values (	cd_material_w,
			cd_classif_fiscal_w,
			cd_fabricante_w,
			cd_sistema_ant_w,
			cd_unidade_medida_compra_ww,
			cd_unidade_medida_consumo_ww,
			cd_unidade_medida_estoque_ww,
			cd_unidade_medida_solic_ww,
			ds_material_w,
			ds_reduzida_w,
			to_date(dt_val_cert_aprov_w,'dd/mm/yyyy'),
			ie_abrigo_luz_w,
			ie_baixa_estoq_pac_w,
			ie_baixa_inteira_w,
			ie_bomba_infusao_w,
			ie_cobra_paciente_w,
			ie_consignado_w,
			ie_controle_medico_w,
			ie_curva_abc_w,
			ie_diluicao_w,
			ie_disponivel_mercado_w,
			ie_gravar_obs_prescr_w,
			ie_inf_ultima_compra_w,
			ie_mistura_w,
			ie_obrig_via_aplicacao_w,
			ie_preco_compra_w,
			ie_receita_w,
			ie_situacao_w,
			ie_solucao_w,
			ie_tipo_material_w,
			ie_umidade_controlada_w,
			ie_via_aplicacao_w,
			nr_certificado_aprovacao_w,
			nr_seq_fabric_w,
			nr_seq_familia_w,
			nr_seq_grupo_rec_w,
			nr_seq_localizacao_w,
			qt_conv_compra_estoque_w,
			qt_conv_estoque_consumo_w,
			qt_dias_validade_w,
			qt_horas_util_pac_w,
			qt_max_prescricao_w,
			qt_minimo_multiplo_solic_w,
			qt_prioridade_coml_w,
			cd_material_w,
			cd_material_w,
			cd_classe_material_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			clock_timestamp(),
			'S');

		exception
		when others then
			ie_status_w 		:= 'E';
			ds_erro_sqlerrm_w	:= substr(sqlerrm ,1,3000);
			ds_erro_w		:= substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'MATERIAL'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
			/*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

		end;
	else
		begin
		update	material
		set	cd_classif_fiscal = coalesce(cd_classif_fiscal_w,cd_classif_fiscal),
			cd_fabricante = coalesce(cd_fabricante_w,cd_fabricante),
			cd_unidade_medida_compra = coalesce(cd_unidade_medida_compra_ww,cd_unidade_medida_compra),
			cd_unidade_medida_consumo = coalesce(cd_unidade_medida_consumo_ww,cd_unidade_medida_consumo),
			cd_unidade_medida_estoque = coalesce(cd_unidade_medida_estoque_ww,cd_unidade_medida_estoque),
			cd_unidade_medida_solic = coalesce(cd_unidade_medida_solic_ww,cd_unidade_medida_solic),
			ds_material = coalesce(ds_material_w,ds_material),
			ds_reduzida = coalesce(ds_reduzida_w,ds_reduzida),
			dt_validade_certificado_aprov = coalesce(to_date(dt_val_cert_aprov_w,'dd/mm/yyyy'),dt_validade_certificado_aprov),
			ie_abrigo_luz = coalesce(ie_abrigo_luz_w,ie_abrigo_luz),
			ie_baixa_estoq_pac = coalesce(ie_baixa_estoq_pac_w,ie_baixa_estoq_pac),
			ie_baixa_inteira = coalesce(ie_baixa_inteira_w,ie_baixa_inteira),
			ie_bomba_infusao = coalesce(ie_bomba_infusao_w,ie_bomba_infusao),
			ie_cobra_paciente = coalesce(ie_cobra_paciente_w,ie_cobra_paciente),
			ie_consignado = coalesce(ie_consignado_w,ie_consignado),
			ie_controle_medico = coalesce(ie_controle_medico_w,ie_controle_medico),
			ie_curva_abc = coalesce(ie_curva_abc_w,ie_curva_abc),
			ie_diluicao = coalesce(ie_diluicao_w,ie_diluicao),
			ie_disponivel_mercado = coalesce(ie_disponivel_mercado_w,ie_disponivel_mercado),
			ie_gravar_obs_prescr = coalesce(ie_gravar_obs_prescr_w,ie_gravar_obs_prescr),
			ie_inf_ultima_compra = coalesce(ie_inf_ultima_compra_w,ie_inf_ultima_compra),
			ie_mistura = coalesce(ie_mistura_w,ie_mistura),
			ie_obrig_via_aplicacao = coalesce(ie_obrig_via_aplicacao_w,ie_obrig_via_aplicacao),
			ie_preco_compra = coalesce(ie_preco_compra_w,ie_preco_compra),
			ie_receita = coalesce(ie_receita_w,ie_receita),
			ie_situacao = coalesce(ie_situacao_w,ie_situacao),
			ie_solucao = coalesce(ie_solucao_w,ie_solucao),
			ie_tipo_material = coalesce(ie_tipo_material_w,ie_tipo_material),
			ie_umidade_controlada = coalesce(ie_umidade_controlada_w,ie_umidade_controlada),
			ie_via_aplicacao = coalesce(ie_via_aplicacao_w,ie_via_aplicacao),
			nr_certificado_aprovacao = coalesce(nr_certificado_aprovacao_w,nr_certificado_aprovacao),
			nr_seq_fabric = coalesce(nr_seq_fabric_w,nr_seq_fabric),
			nr_seq_familia = coalesce(nr_seq_familia_w,nr_seq_familia),
			nr_seq_grupo_rec = coalesce(nr_seq_grupo_rec_w,nr_seq_grupo_rec),
			nr_seq_localizacao = coalesce(nr_seq_localizacao_w,nr_seq_localizacao),
			qt_conv_compra_estoque = coalesce(qt_conv_compra_estoque_w,qt_conv_compra_estoque),
			qt_conv_estoque_consumo = coalesce(qt_conv_estoque_consumo_w,qt_conv_estoque_consumo),
			qt_dias_validade = coalesce(qt_dias_validade_w,qt_dias_validade),
			qt_horas_util_pac = coalesce(qt_horas_util_pac_w,qt_horas_util_pac),
			qt_max_prescricao = coalesce(qt_max_prescricao_w,qt_max_prescricao),
			qt_minimo_multiplo_solic = coalesce(qt_minimo_multiplo_solic_w,qt_minimo_multiplo_solic),
			qt_prioridade_coml = coalesce(qt_prioridade_coml_w,qt_prioridade_coml),
			cd_classe_material = coalesce(cd_classe_material_w,cd_classe_material),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			ie_material_estoque = 'S'
		where	cd_sistema_ant = cd_sistema_ant_w;

		exception
		when others then
			ie_status_w 		:= 'E';
			ds_erro_sqlerrm_w	:= substr(sqlerrm ,1,3000);
			ds_erro_w		:= substr(wheb_mensagem_pck.get_texto(483612,'CD_SISTEMA_ANT_W='||cd_sistema_ant_w||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
						/*Ocorreu o seguinte erro ao alterar os dados do material cujo CD_SISTEMA_ANT seja #@CD_SISTEMA_ANT_W#@. Erro: #@DS_ERRO_W#@.*/

		end;
	end if;
end if;

if (coalesce(cd_material_w,cd_material_tasy_w) > 0) and (ie_status_w = 'OK') then

	open C01;
	loop
	fetch C01 into
		dt_validade_reg_anvisa_w,
		cd_estabelecimento_w,
		cd_kit_material_w,
		nr_minimo_cotacao_w,
		qt_dia_estoque_minimo_w,
		qt_dia_interv_ressup_w,
		qt_dia_ressup_forn_w,
		qt_estoque_maximo_w,
		qt_estoque_minimo_w,
		qt_peso_kg_w,
		qt_ponto_pedido_w,
		cd_sistema_ant_estab_w,
		ie_baixa_estoq_pac_w,
		ie_classif_custo_w,
		ie_controla_serie_w,
		ie_curva_xyz_w,
		ie_estoque_lote_w,
		ie_material_estoque_w,
		ie_padronizado_w,
		ie_prescricao_w,
		ie_requisicao_w,
		ie_vigente_anvisa_w,
		ie_ressuprimento_w,
		nr_registro_anvisa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_status_w = 'OK') and (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

			select	coalesce(somente_numero(bkf_obter_conv_interna('','ESTABELECIMENTO','CD_ESTABELECIMENTO',cd_estabelecimento_w,'BKF')),0)
			into STRICT	cd_retorno_de_para_w
			;

			if (cd_retorno_de_para_w = 0) then
				ie_status_w	:= 'E';
				ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'ESTABELECIMENTO'||';DS_ATRIBUTO='||'CD_ESTABELECIMENTO'||';CD_CODIGO='||cd_estabelecimento_w);
				/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

			else
				select	count(*)
				into STRICT	qt_registros_w
				from	estabelecimento
				where	cd_estabelecimento = cd_retorno_de_para_w
				and	ie_situacao = 'A';

				if (qt_registros_w = 0) then
					ie_status_w	:= 'E';
					ds_erro_w	:= wheb_mensagem_pck.get_texto(450159,'CD_ESTAB_TASY_W='|| cd_retorno_de_para_w ||';CD_ESTABELECIMENTO_W='|| cd_estabelecimento_w);
							/*Não existe no Tasy o estabelecimento com código  #@CD_ESTAB_TASY_W#@.Verifique o cadastro de conversão para o código do estabelecimento #@CD_ESTABELECIMENTO_W#@ que veio do sistema externo.*/

				else
					cd_estabelecimento_w := cd_retorno_de_para_w;
				end if;
			end if;
		elsif (ie_status_w = 'OK') and (coalesce(cd_estabelecimento_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458548,'DS_CAMPO='||'CD_ESTABELECIMENTO'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
		end if;

		if (ie_status_w = 'OK') and (ie_curva_xyz_w not in ('X','Y','Z')) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458626);
			/*Favor informar um valor válido para o campo IE_CURVA_XYZ (X para os itens que são da curva X, Y que são da curva Y e Z para os itens que são da curva Z)*/

		end if;

		if (ie_status_w = 'OK') and (cd_kit_material_w IS NOT NULL AND cd_kit_material_w::text <> '') then

			select	coalesce(somente_numero(bkf_obter_conv_interna('','KIT_MATERIAL','CD_KIT_MATERIAL',cd_kit_material_w,'BKF')),0)
			into STRICT	cd_retorno_de_para_w
			;

			if (cd_retorno_de_para_w = 0) then
				ie_status_w	:= 'E';
				ds_erro_w	:= wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'KIT_MATERIAL'||';DS_ATRIBUTO='||'CD_KIT_MATERIAL'||';CD_CODIGO='||cd_kit_material_w);
				/*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

			else

				select	count(*)
				into STRICT	qt_registros_w
				from	kit_material
				where	cd_kit_material = cd_retorno_de_para_w;

				if (qt_registros_w = 0) then
					ie_status_w	:= 'E';
					ds_erro_w	:= substr(wheb_mensagem_pck.get_texto(458633,'CD_KIT_MATERIAL_TASY_W='||cd_retorno_de_para_w ||';CD_KIT_MATERIAL_INT_W='|| cd_kit_material_w),1,4000);
					/*Não existe no Tasy um kit de material com o código #@CD_KIT_MATERIAL_TASY_W#@. Verifique o cadastro de conversão para o código do kit material #@CD_KIT_MATERIAL_INT_W#@ que veio do sistema externo.*/

				else
					cd_kit_material_w := cd_retorno_de_para_w;
				end if;
			end if;
		end if;

		if (ie_status_w = 'OK') and (ie_baixa_estoq_pac_w not in ('S','N')) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_BAIXA_ESTOQUE_PAC'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (ie_classif_custo_w not in ('A','B','M')) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458634); /*Favor informar um valor válido para o campo IE_CLASSIF_CUSTO (A para Alto, M para Médio e B para Baixo).*/
		end if;

		if (ie_status_w = 'OK') and (ie_controla_serie_w not in ('N','O','P')) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458635); /*Favor informar um valor válido para o campo IE_CONTROLA_SERIE (N para Não controla, O para Obriga a informação e P para Permite informar).*/
		end if;

		if (ie_status_w = 'OK') and (ie_estoque_lote_w not in ('S','N')) then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_ESTOQUE_LOTE'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_material_estoque_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_MATERIAL_ESTOQUE'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_padronizado_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_PADRONIZADO'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_prescricao_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_PRESCRICAO'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_requisicao_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_REQUISICAO'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_vigente_anvisa_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_VIGENTE_ANVISA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') and (coalesce(ie_ressuprimento_w::text, '') = '') then
			ie_status_w	:= 'E';
			ds_erro_w	:= wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_RESSUPRIMENTO'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
		end if;

		if (ie_status_w = 'OK') then

			if (cd_material_tasy_w = 0) then

				begin
				insert into material_estab(
					nr_sequencia,
					cd_estabelecimento,
					cd_kit_material,
					cd_sistema_ant,
					dt_validade_reg_anvisa,
					ie_baixa_estoq_pac,
					ie_classif_custo,
					ie_controla_serie,
					ie_curva_xyz,
					ie_estoque_lote,
					ie_material_estoque,
					ie_padronizado,
					ie_prescricao,
					ie_requisicao,
					ie_ressuprimento,
					ie_vigente_anvisa,
					nr_minimo_cotacao,
					nr_registro_anvisa,
					cd_material,
					qt_dia_estoque_minimo,
					qt_dia_interv_ressup,
					qt_dia_ressup_forn,
					qt_estoque_maximo,
					qt_estoque_minimo,
					qt_peso_kg,
					qt_ponto_pedido,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao,
					dt_atualizacao_nrec)
				values (	nextval('material_estab_seq'),
					cd_estabelecimento_w,
					cd_kit_material_w,
					cd_sistema_ant_w,
					to_date(dt_validade_reg_anvisa_w,'dd/mm/yyyy'),
					ie_baixa_estoq_pac_w,
					ie_classif_custo_w,
					ie_controla_serie_w,
					ie_curva_xyz_w,
					ie_estoque_lote_w,
					ie_material_estoque_w,
					ie_padronizado_w,
					ie_prescricao_w,
					ie_requisicao_w,
					ie_ressuprimento_w,
					ie_vigente_anvisa_w,
					nr_minimo_cotacao_w,
					nr_registro_anvisa_w,
					cd_material_w,
					qt_dia_estoque_minimo_w,
					qt_dia_interv_ressup_w,
					qt_dia_ressup_forn_w,
					qt_estoque_maximo_w,
					qt_estoque_minimo_w,
					qt_peso_kg_w,
					qt_ponto_pedido_w,
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					clock_timestamp());

				update	material
				set	ie_material_estoque = ie_material_estoque_w
				where	cd_material = cd_material_w;

				exception
				when others then
					ie_status_w 		:= 'E';
					ds_erro_sqlerrm_w	:= substr(sqlerrm ,1,3000);
					ds_erro_w		:= substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'MATERIAL_ESTAB'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
					/*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

				end;
			else
				begin
				update	material_estab
				set	cd_kit_material = coalesce(cd_kit_material_w,cd_kit_material),
					dt_validade_reg_anvisa = coalesce(to_date(dt_validade_reg_anvisa_w,'dd/mm/yyyy'),dt_validade_reg_anvisa),
					ie_baixa_estoq_pac = coalesce(ie_baixa_estoq_pac_w,ie_baixa_estoq_pac),
					ie_classif_custo = coalesce(ie_classif_custo_w,ie_classif_custo),
					ie_controla_serie = coalesce(ie_controla_serie_w,ie_controla_serie),
					ie_curva_xyz = coalesce(ie_curva_xyz_w,ie_curva_xyz),
					ie_estoque_lote = coalesce(ie_estoque_lote_w,ie_estoque_lote),
					ie_material_estoque = coalesce(ie_material_estoque_w,ie_material_estoque),
					ie_padronizado = coalesce(ie_padronizado_w,ie_padronizado),
					ie_prescricao = coalesce(ie_prescricao_w,ie_prescricao),
					ie_requisicao = coalesce(ie_requisicao_w,ie_requisicao),
					ie_ressuprimento = coalesce(ie_ressuprimento_w,ie_ressuprimento),
					ie_vigente_anvisa = coalesce(ie_vigente_anvisa_w,ie_vigente_anvisa),
					nr_minimo_cotacao = coalesce(nr_minimo_cotacao_w,nr_minimo_cotacao),
					nr_registro_anvisa = coalesce(nr_registro_anvisa_w,nr_registro_anvisa),
					qt_dia_estoque_minimo = coalesce(qt_dia_estoque_minimo_w,qt_dia_estoque_minimo),
					qt_dia_interv_ressup = coalesce(qt_dia_interv_ressup_w,qt_dia_interv_ressup),
					qt_dia_ressup_forn = coalesce(qt_dia_ressup_forn_w,qt_dia_ressup_forn),
					qt_estoque_maximo = coalesce(qt_estoque_maximo_w,qt_estoque_maximo),
					qt_estoque_minimo = coalesce(qt_estoque_minimo_w,qt_estoque_minimo),
					qt_peso_kg = coalesce(qt_peso_kg_w,qt_peso_kg),
					qt_ponto_pedido = coalesce(qt_ponto_pedido_w,qt_ponto_pedido),
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where	cd_sistema_ant = cd_sistema_ant_w
				and	cd_estabelecimento = cd_estabelecimento_w;


				exception
				when others then
					ie_status_w 		:= 'E';
					ds_erro_sqlerrm_w	:= substr(sqlerrm ,1,3000);
					ds_erro_w		:= substr(wheb_mensagem_pck.get_texto(483613,'CD_SISTEMA_ANT_W='||cd_sistema_ant_w||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
								/*Ocorreu o seguinte erro ao alterar os dados do estabelecimento do material cujo CD_SISTEMA_ANT seja #@CD_SISTEMA_ANT_W#@. Erro: #@DS_ERRO_W#@.*/

				end;
			end if;
		end if;
		end;
	end loop;
	close C01;
end if;

if (ie_status_w = 'OK') then
	commit;
else
	rollback;
end if;

delete from w_int_cadastro_material
where nr_sequencia = nr_Sequencia_p;

commit;

ie_status_p 	:= ie_status_w;
ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_cadastro_material ( nr_sequencia_p bigint, nm_usuario_p text, ie_status_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

