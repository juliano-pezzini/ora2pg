-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_cid_atendimento ( nr_atendimento_p bigint, NR_INTERNO_CONTA_P bigint, cd_procedimento_p bigint, cd_cid_Doenca_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


DS_ERRO_W         		varchar(80)	:= '';
cd_cid_princ_w			varchar(10)	:= 'X';
cd_cid_sec_w			varchar(10)	:= 'X';
cd_cid_morte_w			varchar(10)	:= 'X';
qt_cid_Princ_w			smallint	:= 0;
qt_cid_Sec_w			smallint	:= 0;
qt_cid_morte_w			smallint	:= 0;
qt_cid_Obrig_w			smallint	:= 0;
qt_cid_Igual_w			smallint	:= 0;
ie_carater_inter_sus_w		varchar(2)	:= 'XX';
cd_motivo_cobranca_w		smallint	:= 0;


BEGIN
ds_erro_w				:= '';

begin
select	coalesce(b.ie_carater_inter_sus,a.ie_carater_inter_sus),
	coalesce(cd_motivo_cobranca,0)
into STRICT	ie_carater_inter_sus_w,
	cd_motivo_cobranca_w
from	atendimento_paciente	a,
	sus_aih 		b
where	b.nr_atendimento		= nr_atendimento_p
and	b.nr_interno_conta		= nr_interno_conta_p
and	b.nr_atendimento		= a.nr_atendimento;
exception
	when others then
		ie_carater_inter_sus_w	:= 'XX';
end;

Select	count(*),
	coalesce(max(cd_cid_principal),'X')
into STRICT	qt_cid_princ_w,
	cd_cid_princ_w
from	sus_aih
where	nr_atendimento		= nr_atendimento_p
and	nr_interno_conta	= nr_interno_conta_p;
if (cd_cid_princ_w	= 'X') then
	qt_cid_princ_w	:= 0;
end if;

Select	count(*),
	coalesce(max(cd_cid_secundario),'X')
into STRICT	qt_cid_Sec_w,
	cd_cid_sec_w
from	sus_aih
where	nr_atendimento		= nr_atendimento_p
and	nr_interno_conta	= nr_interno_conta_p;
if (cd_cid_sec_w	= 'X') then
	qt_cid_Sec_w	:= 0;
end if;

Select	count(*),
	coalesce(max(cd_cid_causa_morte),'X')
into STRICT	qt_cid_morte_w,
	cd_cid_morte_w
from	sus_aih
where	nr_atendimento 		= nr_atendimento_p
and	nr_interno_conta	= nr_interno_conta_p;
if (cd_cid_morte_w	= 'X') then
	qt_cid_morte_w	:= 0;
end if;


if (qt_cid_princ_w	= 0) then
	begin
	Select 	count(*),coalesce(max(cd_doenca),'X')
	into STRICT	 	qt_cid_princ_w,cd_cid_princ_w
	from		diagnostico_doenca
	where		nr_atendimento 		= nr_atendimento_p
	and		ie_classificacao_doenca	= 'P';

	Select 	count(*), coalesce(max(cd_doenca),'X')
	into STRICT	 	qt_cid_Sec_w, cd_cid_Sec_w
	from		diagnostico_doenca
	where		nr_atendimento 		= nr_atendimento_p
	and		ie_classificacao_doenca	= 'S';
	end;
end if;

if (qt_cid_princ_w = 0) then
	begin
	Select 	coalesce(cd_doenca_cid,'X'),
			coalesce(cd_cid_secundario,'X')
	into STRICT	 	cd_cid_princ_w,
			cd_cid_sec_w
	from		procedimento
	where		cd_procedimento 	= cd_procedimento_p
	and		ie_origem_proced	= 2;
	exception
			when others then
			begin
			qt_cid_princ_w		:= 0;
			qt_cid_Sec_w		:= 0;
			cd_cid_princ_w		:= 'X';
			cd_cid_sec_w	 	:= 'X';
			end;
	end;
end if;

if (cd_motivo_cobranca_w in (41,42,43,51,52,53,54,91,92,93)) and (qt_cid_morte_w = 0) and (cd_cid_morte_w = 'X') then
	ds_erro_w		:= ds_erro_w || '2237 ';
end if;

if (qt_cid_princ_w > 1) or (qt_cid_sec_w > 1) then
	ds_erro_w		:= ds_erro_w || '766 ';
else
	begin
	if (qt_cid_princ_w = 0) and (cd_cid_princ_w = 'X') then
		ds_erro_w		:= ds_erro_w || '710 ';
	end if;
	/* CID Principal exige secund√°rio */

	if (cd_cid_princ_w <> 'X') 	and (cd_cid_sec_w = 'X')	and
		((substr(cd_cid_princ_w,1,1) = 'T') or (substr(cd_cid_princ_w,1,1) = 'S')) then
		ds_erro_w		:= ds_erro_w || '711 ';
	end if;
	if (cd_cid_princ_w <> 'X') 	and (cd_cid_sec_w = 'X')	and (ie_carater_inter_sus_w in ('6','06','7','07','26','27')) then
		ds_erro_w		:= ds_erro_w || '711 ';
	end if;
	end;
end if;

select	coalesce(count(*),0),
	coalesce(sum(CASE WHEN cd_doenca_cid=cd_cid_princ_w THEN 1  ELSE 0 END ),0)
into STRICT	qt_cid_obrig_w,
	qt_cid_igual_w
from 	sus_proced_doenca
where 	cd_procedimento		= cd_procedimento_p
and 	ie_origem_proced	= 2;

if (qt_cid_obrig_w > 0) and (qt_cid_igual_w = 0) then
	ds_erro_w		:= ds_erro_w || '768 ';
end if;

select	coalesce(count(*),0),
	coalesce(sum(CASE WHEN cd_doenca_cid=cd_cid_morte_w THEN 1  ELSE 0 END ),0)
into STRICT	qt_cid_obrig_w,
	qt_cid_igual_w
from 	sus_proced_doenca
where 	cd_procedimento		= cd_procedimento_p
and 	ie_origem_proced	= 2;

if (cd_motivo_cobranca_w in (41,42,43,51,52,53,54,91,92,93)) and (qt_cid_obrig_w > 0) and (qt_cid_igual_w = 0) then
	ds_erro_w		:= ds_erro_w || '2238 ';
end if;

ds_erro_p		:= ds_erro_w;
cd_cid_doenca_p		:= cd_cid_princ_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_cid_atendimento ( nr_atendimento_p bigint, NR_INTERNO_CONTA_P bigint, cd_procedimento_p bigint, cd_cid_Doenca_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

