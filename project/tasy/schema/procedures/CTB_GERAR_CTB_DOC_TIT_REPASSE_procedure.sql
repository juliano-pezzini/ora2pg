-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_ctb_doc_tit_repasse (nr_titulo_repasse_p bigint, nm_usuario_p text) AS $body$
DECLARE


titulo_repasse_w        titulo_pagar%rowtype;
vl_movimento_w          ctb_documento.vl_movimento%type;
dt_documento_w          ctb_documento.dt_atualizacao%type;
nr_seq_trans_financ_w   ctb_documento.nr_seq_trans_financ%type;
ctb_param_lote_tit_repasse_w ctb_param_lote_tit_repasse%rowtype;
nr_seq_tab_compl_w      ctb_documento.nr_seq_doc_compl%type;
nr_tit_pag_imp_w        titulo_pagar_imposto.nr_titulo%type;
ie_ctb_online_w         varchar(1);

c01 CURSOR FOR
SELECT  a.nm_atributo
from    atributo_contab a
where   a.cd_tipo_lote_contab = 16
and     a.nm_atributo in ('VL_TITULO_REPASSE', 'VL_TRIBUTO_REPASSE', 'VL_LIBERADO');

c01_w   c01%rowtype;


BEGIN

begin
select  *
into STRICT    titulo_repasse_w
from    titulo_pagar
where   nr_titulo = nr_titulo_repasse_p;
exception when others then
        titulo_repasse_w := null;
end;

if (coalesce(titulo_repasse_w.nr_titulo, 0) <> 0) then
        ie_ctb_online_w   := ctb_online_pck.get_modo_lote(16, titulo_repasse_w.cd_estabelecimento);
end if;

if      ((coalesce(ie_ctb_online_w, 'N') = 'S') and coalesce(titulo_repasse_w.nr_repasse_terceiro, 0) <> 0) then
        begin
        select  a.*
        into STRICT    ctb_param_lote_tit_repasse_w
        from    ctb_param_lote_tit_repasse a
        where   a.cd_empresa    = obter_empresa_estab(titulo_repasse_w.cd_estabelecimento)
        and     coalesce(a.cd_estab_exclusivo, titulo_repasse_w.cd_estabelecimento)  = titulo_repasse_w.cd_estabelecimento;
        exception when others then
                ctb_param_lote_tit_repasse_w := null;
        end;

        nr_seq_trans_financ_w := coalesce(titulo_repasse_w.nr_seq_trans_fin_contab, ctb_param_lote_tit_repasse_w.nr_seq_trans_repasse);

        open c01;
        loop
        fetch c01 into
                c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
                begin

                dt_documento_w          := null;
                nr_seq_tab_compl_w      := null;
                vl_movimento_w          := 0;

                if (c01_w.nm_atributo = 'VL_TITULO_REPASSE') and (coalesce(titulo_repasse_w.nr_seq_tributo,0) = 0) then
                        begin

                        if (titulo_repasse_w.ie_situacao = 'D') then
                                vl_movimento_w := obter_valor_tit_pagar_desdob(titulo_repasse_w.nr_titulo);
                        else
                                vl_movimento_w := titulo_repasse_w.vl_titulo;
                        end if;

                        select
                                case ctb_param_lote_tit_repasse_w.ie_data_contab_tit_rep
                                when 'V'
                                    then titulo_repasse_w.dt_vencimento_atual
                                when 'C'
                                    then titulo_repasse_w.dt_contabil
                                when 'O'
                                    then titulo_repasse_w.dt_vencimento_original
                                else
                                    titulo_repasse_w.dt_emissao
                                end
                        into STRICT dt_documento_w
;
                        end;
                elsif (c01_w.nm_atributo = 'VL_TRIBUTO_REPASSE' and coalesce(titulo_repasse_w.nr_seq_tributo, 0) <> 0) then
                        begin

                        if (titulo_repasse_w.ie_situacao = 'D') then
                                vl_movimento_w := obter_valor_tit_pagar_desdob(titulo_repasse_w.nr_titulo);
                        else
                                vl_movimento_w := titulo_repasse_w.vl_titulo;
                        end if;

                        nr_seq_tab_compl_w := titulo_repasse_w.nr_seq_tributo;

                        if (coalesce(ctb_param_lote_tit_repasse_w.ie_dt_tit_trib_orig, 'N') = 'N') then
                                begin
                                select
                                case ctb_param_lote_tit_repasse_w.ie_data_contab_tit_rep
                                    when 'V'
                                    then titulo_repasse_w.dt_vencimento_atual
                                    when 'C'
                                    then titulo_repasse_w.dt_contabil
                                    when 'O'
                                    then titulo_repasse_w.dt_vencimento_original
                                    else
                                    titulo_repasse_w.dt_emissao
                                end
                                into STRICT dt_documento_w
;
                                end;
                        else
                                begin
                                begin
                                select  nr_titulo
                                into STRICT    nr_tit_pag_imp_w
                                from    titulo_pagar_imposto
                                where   nr_sequencia = titulo_repasse_w.nr_seq_tributo;
                                exception when others then
                                    nr_tit_pag_imp_w := 0;
                                end;

                                if (coalesce(nr_tit_pag_imp_w, 0) <> 0 ) then
                                        select
                                                case ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep
                                                when 'V'
                                                then to_date(obter_dados_tit_pagar(nr_tit_pag_imp_w,'VE'), 'dd/mm/yyyy')
                                                when 'C'
                                                then titulo_repasse_w.dt_contabil
                                                when 'O'
                                                then to_date(obter_dados_tit_pagar(nr_tit_pag_imp_w,'VO'), 'dd/mm/yyyy')
                                                else
                                                to_date(obter_dados_tit_pagar(nr_tit_pag_imp_w,'EM'), 'dd/mm/yyyy')
                                                end
                                        into STRICT dt_documento_w
;
                                end if;
                                end;
                        end if;
                        end;
                elsif (c01_w.nm_atributo = 'VL_LIBERADO') and (coalesce(titulo_repasse_w.nr_seq_tributo, 0) = 0) and (obter_valor_repasse(titulo_repasse_w.nr_repasse_terceiro,'L') <> 0) then
                        begin
                        vl_movimento_w := coalesce(obter_valor_repasse_titulo(titulo_repasse_w.nr_titulo,'L'),0);

                        select  case ctb_param_lote_tit_repasse_w.ie_dt_movto_contab_tit_rep
                                when 'V'
                                    then titulo_repasse_w.dt_vencimento_atual
                                when 'C'
                                    then titulo_repasse_w.dt_contabil
                                when 'O'
                                    then titulo_repasse_w.dt_vencimento_original
                                else
                                    titulo_repasse_w.dt_emissao
                                end
                        into STRICT    dt_documento_w
;
                        end;
                end if;

                if (coalesce(vl_movimento_w, 0) <> 0) then
                        begin
                        CALL ctb_concil_financeira_pck.ctb_gravar_documento( titulo_repasse_w.cd_estabelecimento,
                                                                        dt_documento_w,
                                                                        16,
                                                                        nr_seq_trans_financ_w,
                                                                        2,
                                                                        nr_titulo_repasse_p,
                                                                        nr_seq_tab_compl_w,
                                                                        null,
                                                                        vl_movimento_w,
                                                                        'TITULO_PAGAR',
                                                                        c01_w.nm_atributo,
                                                                        nm_usuario_p);
                        end;
                end if;
            end;
    end loop;
    close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_ctb_doc_tit_repasse (nr_titulo_repasse_p bigint, nm_usuario_p text) FROM PUBLIC;

