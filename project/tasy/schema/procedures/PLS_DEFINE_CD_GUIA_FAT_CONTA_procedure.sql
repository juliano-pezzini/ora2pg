-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_cd_guia_fat_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_pos_estab pls_analise_conta.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


ie_origem_protocolo_w		pls_protocolo_conta.ie_origem_protocolo%type;
nr_seq_congenere_seg_w		pls_segurado.nr_seq_congenere%type;
ie_tipo_ret_guia_w		pls_regra_guia_fat.ie_tipo_ret_guia%type	:= '';
ie_gerar_guia_refat_w		pls_regra_guia_fat.ie_gerar_guia_refat%type	:= null;
qt_ajuste_fatura_w		integer;
qt_recurso_glosa_w		integer;
cd_guia_prestador_w		pls_conta.cd_guia_prestador%type;

C01 CURSOR FOR
	SELECT	ie_tipo_ret_guia
	from	pls_regra_guia_fat
	where	((ie_origem_protocolo		= ie_origem_protocolo_w) or (coalesce(ie_origem_protocolo::text, '') = ''))
	and	((nr_seq_congenere		= nr_seq_congenere_seg_w) or (coalesce(nr_seq_congenere::text, '') = ''))
	and	(((nr_seq_grupo_operadora IS NOT NULL AND nr_seq_grupo_operadora::text <> '') and pls_se_grupo_preco_operadora(nr_seq_grupo_operadora,nr_seq_congenere_seg_w) = 'S')
		or (coalesce(nr_seq_grupo_operadora::text, '') = ''))
	and	((coalesce(ie_gerar_guia_refat, 'N') = (ie_gerar_guia_refat_w)) or  -- Se a regra for condizente com a conta de refaturamento - contestacao  ou recurso glosa
	        ((coalesce(ie_gerar_guia_refat, 'N') = 'A') and (ie_gerar_guia_refat_w IS NOT NULL AND ie_gerar_guia_refat_w::text <> '')) or  -- se a regra permitir ambos, e a conta for contestacao / recurso de golsa
		((coalesce(ie_gerar_guia_refat, 'N') = 'N') or (coalesce(ie_gerar_guia_refat_w::text, '') = ''))) -- se a regra n√£o deve considerar o refaturamento.
	order by ie_origem_protocolo,
		nr_seq_congenere,
		nr_seq_grupo_operadora;


BEGIN

select	ie_origem_protocolo,
	nr_seq_congenere_seg,
	coalesce(cd_guia_prestador,cd_guia)
into STRICT	ie_origem_protocolo_w,
	nr_seq_congenere_seg_w,
	cd_guia_prestador_w
from	pls_conta_v
where	nr_sequencia	= nr_seq_conta_p;

-- Verifica se existe regra para refaturamento -  Contestacao
select	count(1)
into STRICT	qt_ajuste_fatura_w
from	pls_ajuste_fatura_conta	a,
	pls_conta		b,
	pls_ajuste_fatura	c

where	b.nr_seq_ajuste_fat	= a.nr_sequencia
and	c.nr_sequencia		= a.nr_seq_ajuste_fatura
and	(c.nr_seq_lote_disc IS NOT NULL AND c.nr_seq_lote_disc::text <> '')
and	b.nr_sequencia		= nr_seq_conta_p;

if (qt_ajuste_fatura_w > 0) then -- possui contestacao
	ie_gerar_guia_refat_w := 'CC';
end if;

-- se nao possui contestacao, verifica o recurso de glosa
if (qt_ajuste_fatura_w <= 0) then
	select	count(1)
	into STRICT	qt_recurso_glosa_w
	from	pls_rec_glosa_conta	a
	where	a.nr_seq_conta	= nr_seq_conta_p;

	if (qt_recurso_glosa_w > 0) then -- se possuir recurso de glosa
		ie_gerar_guia_refat_w := 'RG';
	end if;
end if;


for r_c01_w in C01 loop
	ie_tipo_ret_guia_w	:= r_c01_w.ie_tipo_ret_guia;
end loop;

if (ie_tipo_ret_guia_w = '1') then
	update	pls_conta
	set	cd_guia_fat	= to_char(nr_seq_analise_pos_estab),
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_conta_p;
elsif (ie_tipo_ret_guia_w = '2') then
	update	pls_conta
	set	cd_guia_fat	= cd_guia_prestador_w,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_conta_p;
elsif (coalesce(ie_tipo_ret_guia_w::text, '') = '') then
	update	pls_conta
	set	cd_guia_fat	= '',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_conta_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_cd_guia_fat_conta ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_analise_pos_estab pls_analise_conta.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

