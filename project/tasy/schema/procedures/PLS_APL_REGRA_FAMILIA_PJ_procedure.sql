-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_apl_regra_familia_pj ( nr_seq_segurado_p bigint, nr_seq_processo_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_liminar_w 			processo_judicial_liminar.ds_liminar%type;
nr_seq_orgao_exped_w		processo_judicial_liminar.nr_seq_orgao_exped%type;
cd_juridico_liminar_w		processo_judicial_liminar.cd_juridico_liminar%type;
dt_inicio_validade_w		processo_judicial_liminar.dt_inicio_validade%type;
dt_fim_validade_w		processo_judicial_liminar.dt_fim_validade%type;
ie_impacto_autorizacao_w	processo_judicial_liminar.ie_impacto_autorizacao%type;
ie_impacto_coparticipacao_w	processo_judicial_liminar.ie_impacto_coparticipacao%type;
ie_impacto_notificacao_w	processo_judicial_liminar.ie_impacto_notificacao%type;
ie_impacto_reajuste_w		processo_judicial_liminar.ie_impacto_reajuste%type;
ie_impacto_contrato_w		processo_judicial_liminar.ie_impacto_contrato%type;
nr_seq_prestador_w		processo_judicial_prest.nr_seq_prestador%type;
cd_area_procedimento_w		processo_judicial_proc.cd_area_procedimento%type;
cd_especialidade_w		processo_judicial_proc.cd_especialidade%type;
cd_grupo_proc_w			processo_judicial_proc.cd_grupo_proc%type;
cd_procedimento_w		processo_judicial_proc.cd_procedimento%type;
ie_origem_proced_w		processo_judicial_proc.ie_origem_proced%type;
nr_seq_material_w		processo_judicial_mat.nr_seq_material%type;
nr_seq_estrut_mat_w		processo_judicial_mat.nr_seq_estrut_mat%type;
cd_material_w			processo_judicial_mat.cd_material%type;
ie_isentar_coparticipacao_w	pls_processo_jud_copartic.ie_isentar_coparticipacao%type;
nr_seq_processo_copartic_w	pls_processo_jud_copartic.nr_sequencia%type;
cd_area_proced_copartic_w 	pls_processo_jud_proc.cd_area_procedimento%type;
cd_especialidade_copartic_w 	pls_processo_jud_proc.cd_especialidade%type;
cd_grupo_proc_copartic_w 	pls_processo_jud_proc.cd_grupo_proc%type;
cd_procedimento_copartic_w    	pls_processo_jud_proc.cd_procedimento%type;
ie_tipo_despesa_copartic_w   	pls_processo_jud_mat.ie_tipo_despesa%type;
nr_seq_material_copartic_w   	pls_processo_jud_mat.nr_seq_material%type;
nr_seq_regra_notif_w		pls_processo_jud_notif.nr_seq_regra_notif%type;
ie_permite_notificacao_w	pls_processo_jud_notif.ie_permite_notificacao%type;
ie_permite_rescisao_w		pls_processo_jud_notif.ie_permite_rescisao%type;
ie_permite_susp_atend_w		pls_processo_jud_notif.ie_permite_susp_atend%type;
ie_permite_susp_mens_w		pls_processo_jud_notif.ie_permite_susp_mens%type;
dt_inicio_vigencia_w		pls_processo_judicial_reaj.dt_inicio_vigencia%type;
dt_fim_vigencia_w		pls_processo_judicial_reaj.dt_fim_vigencia%type;
ie_impedir_reaj_fx_etaria_w	pls_processo_judicial_reaj.ie_impedir_reaj_fx_etaria%type;
ie_impedir_reaj_indice_w	pls_processo_judicial_reaj.ie_impedir_reaj_indice%type;
dt_inicio_vigencia_contr_w	pls_processo_jud_contrato.dt_inicio_vigencia%type;
dt_fim_vigencia_contr_w		pls_processo_jud_contrato.dt_fim_vigencia%type;
ie_impedir_rescisao_contr_w	pls_processo_jud_contrato.ie_impedir_rescisao_seg%type;
ds_observacao_contr_w		pls_processo_jud_contrato.ds_observacao%type;
dt_prev_inicio_susp_w		pls_segurado_suspensao.dt_prev_inicio_susp%type;
dt_prev_fim_susp_w		pls_segurado_suspensao.dt_prev_fim_susp%type;
dt_inicio_suspensao_w		pls_segurado_suspensao.dt_inicio_suspensao%type;
dt_fim_suspensao_w		pls_segurado_suspensao.dt_fim_suspensao%type;
nr_seq_motivo_susp_w		pls_segurado_suspensao.nr_seq_motivo_susp%type;
nr_seq_notificacao_pag_w	pls_segurado_suspensao.nr_seq_notificacao_pag%type;
ds_observacao_w			pls_segurado_suspensao.ds_observacao%type;
ds_motivo_fim_susp_w		pls_segurado_suspensao.ds_motivo_fim_susp%type;
nr_seq_contrato_w		pls_segurado.nr_seq_contrato%type;
nr_seq_intercambio_w		pls_segurado.nr_seq_intercambio%type;
ds_historico_w			processo_judicial_hist.ds_historico%type;
dt_historico_w			processo_judicial_hist.dt_historico%type;
nr_seq_tipo_historico_w		processo_judicial_hist.nr_seq_tipo_historico%type;
dt_anexo_w			processo_judicial_anexo.dt_anexo%type;
ds_anexo_w			processo_judicial_anexo.ds_anexo%type;
ds_diretorio_w			processo_judicial_anexo.ds_diretorio%type;
nr_seq_proc_jud_depend_w	bigint;
nr_seq_process_cop_depend_w	bigint;
ie_considerar_dependente_w	pls_processo_judicial_reaj.ie_considerar_dependente%type;

--Contadores
qt_reg_prest_w		bigint;
qt_reg_proc_w		bigint;
qt_reg_mat_w		bigint;
qt_reg_copartic_w	bigint;
qt_reg_copartic_proc_w	bigint;
qt_reg_copartic_mat_w	bigint;
qt_reg_notific_w	bigint;
qt_reg_reaj_w		bigint;
qt_reg_contr_w		bigint;
qt_reg_susp_contr_w	bigint;

C01 CURSOR FOR
	SELECT  nr_seq_prestador
	from 	processo_judicial_prest
	where 	nr_seq_processo = nr_seq_processo_p;

C02 CURSOR FOR
	SELECT 	cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		ie_origem_proced
	from 	processo_judicial_proc
	where 	nr_seq_processo = nr_seq_processo_p;

C03 CURSOR FOR
	SELECT 	nr_seq_material,
		cd_material,
		nr_seq_estrut_mat
	from 	processo_judicial_mat
	where 	nr_seq_processo = nr_seq_processo_p;

C04 CURSOR FOR
	SELECT 	ie_isentar_coparticipacao,
		nr_sequencia
	from 	pls_processo_jud_copartic
	where 	nr_seq_processo = nr_seq_processo_p;

C05 CURSOR FOR
	SELECT 	cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento
	from 	pls_processo_jud_proc
	where 	nr_seq_processo_copartic = nr_seq_processo_copartic_w;

C06 CURSOR FOR
	SELECT 	ie_tipo_despesa,
		nr_seq_material
	from 	pls_processo_jud_mat
	where 	nr_seq_processo_copartic = nr_seq_processo_copartic_w;

C07 CURSOR FOR
	SELECT 	nr_seq_regra_notif,
		ie_permite_notificacao,
		ie_permite_rescisao,
		ie_permite_susp_atend,
		ie_permite_susp_mens
	from 	pls_processo_jud_notif
	where 	nr_seq_processo = nr_seq_processo_p;

C08 CURSOR FOR
	SELECT	dt_inicio_vigencia,
		dt_fim_vigencia,
		ie_impedir_reaj_fx_etaria,
		ie_impedir_reaj_indice,
		ie_considerar_dependente
	from 	pls_processo_judicial_reaj
	where 	nr_seq_processo = nr_seq_processo_p;

C09 CURSOR FOR
	SELECT 	dt_inicio_vigencia,
		dt_fim_vigencia,
		ie_impedir_rescisao_seg,
		ds_observacao
	from 	pls_processo_jud_contrato
	where 	nr_seq_processo = nr_seq_processo_p;

C10 CURSOR FOR
	SELECT 	dt_prev_inicio_susp,
		dt_prev_fim_susp,
		dt_inicio_suspensao,
		dt_fim_suspensao,
		nr_seq_motivo_susp,
		nr_seq_notificacao_pag,
		ds_observacao,
		ds_motivo_fim_susp
	from 	pls_segurado_suspensao
	where 	nr_seq_processo = nr_seq_processo_p;

C11 CURSOR FOR
	SELECT	ds_historico,
		dt_historico,
		nr_seq_tipo_historico
	from 	processo_judicial_hist
	where 	nr_seq_processo = nr_seq_processo_p;

C12 CURSOR FOR
	SELECT	dt_anexo,
		ds_anexo,
		ds_diretorio
	from 	processo_judicial_anexo
	where 	nr_seq_processo = nr_seq_processo_p;


BEGIN
select 	ds_liminar,
	nr_seq_orgao_exped,
	cd_juridico_liminar,
	dt_inicio_validade,
	dt_fim_validade,
	ie_impacto_autorizacao,
	ie_impacto_coparticipacao,
	ie_impacto_notificacao,
	ie_impacto_reajuste,
	ie_impacto_contrato
into STRICT	ds_liminar_w,
	nr_seq_orgao_exped_w,
	cd_juridico_liminar_w,
	dt_inicio_validade_w,
	dt_fim_validade_w,
	ie_impacto_autorizacao_w,
	ie_impacto_coparticipacao_w,
	ie_impacto_notificacao_w,
	ie_impacto_reajuste_w,
	ie_impacto_contrato_w
from 	processo_judicial_liminar
where 	nr_sequencia = nr_seq_processo_p;

if (coalesce(nr_seq_segurado_p,0) <> 0) then

	select 	nextval('processo_judicial_liminar_seq')
	into STRICT	nr_seq_proc_jud_depend_w
	;

	insert into processo_judicial_liminar(	nr_sequencia,dt_atualizacao,nm_usuario, ds_liminar, dt_recebimento,
			ie_estagio, nr_seq_orgao_exped, cd_juridico_liminar, dt_inicio_validade,dt_fim_validade,
			ie_impacto_autorizacao,ie_impacto_coparticipacao,ie_impacto_notificacao,ie_impacto_reajuste,
			ie_impacto_contrato, nr_seq_segurado, nm_usuario_nrec)
	values (	nr_seq_proc_jud_depend_w, clock_timestamp(), nm_usuario_p, ds_liminar_w, clock_timestamp(),
			1, nr_seq_orgao_exped_w, cd_juridico_liminar_w,dt_inicio_validade_w, dt_fim_validade_w,
			ie_impacto_autorizacao_w,ie_impacto_coparticipacao_w, ie_impacto_notificacao_w, ie_impacto_reajuste_w,
			ie_impacto_contrato_w, nr_seq_segurado_p, nm_usuario_p);

	open c11;
	loop
	fetch c11 into
		ds_historico_w,
		dt_historico_w,
		nr_seq_tipo_historico_w;
	EXIT WHEN NOT FOUND; /* apply on c11 */
		begin
		insert into processo_judicial_hist(	nr_sequencia, dt_atualizacao,nm_usuario,
				ds_historico,dt_historico,nr_seq_tipo_historico, nr_seq_processo)
		values (	nextval('processo_judicial_hist_seq'), clock_timestamp(), nm_usuario_p,
				ds_historico_w, dt_historico_w, nr_seq_tipo_historico_w, nr_seq_proc_jud_depend_w);
		end;
	end loop;
	close c11;

	open C12;
	loop
	fetch C12 into
		dt_anexo_w,
		ds_anexo_w,
		ds_diretorio_w;
	EXIT WHEN NOT FOUND; /* apply on C12 */
		begin
		insert into processo_judicial_anexo(	nr_sequencia, ds_anexo, dt_anexo,
				ds_diretorio, nr_seq_processo, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
		values (	nextval('processo_judicial_anexo_seq'), ds_anexo_w, dt_anexo_w,
				ds_diretorio_w, nr_seq_proc_jud_depend_w, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p);
		end;
	end loop;
	close C12;

	if (coalesce(ie_impacto_autorizacao_w,'N') <> 'N') then
		select 	count(1)
		into STRICT	qt_reg_prest_w
		from 	processo_judicial_prest
		where 	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_prest_w,0) > 0) then
			open c01;
			loop
			fetch c01 into
				nr_seq_prestador_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				insert into processo_judicial_prest(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_prestador,nr_seq_processo)
				values (	nextval('processo_judicial_prest_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_prestador_w, nr_seq_proc_jud_depend_w );
				end;
			end loop;
			close c01;
		end if;

		select 	count(1)
		into STRICT	qt_reg_proc_w
		from	processo_judicial_proc
		where 	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_proc_w,0) > 0) then
			open c02;
			loop
			fetch c02 into
				cd_area_procedimento_w,
				cd_especialidade_w,
				cd_grupo_proc_w,
				cd_procedimento_w,
				ie_origem_proced_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				insert into processo_judicial_proc(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, cd_area_procedimento,cd_especialidade,
						cd_grupo_proc, cd_procedimento,ie_origem_proced)
				values (	nextval('processo_judicial_proc_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w, cd_area_procedimento_w, cd_especialidade_w,
						cd_grupo_proc_w, cd_procedimento_w, ie_origem_proced_w);
				end;
			end loop;
			close c02;
		end if;

		select 	count(1)
		into STRICT	qt_reg_mat_w
		from	processo_judicial_mat
		where 	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_mat_w,0) > 0) then
			open c03;
			loop
			fetch c03 into
				nr_seq_material_w,
				cd_material_w,
				nr_seq_estrut_mat_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin
				insert into processo_judicial_mat(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, cd_material, nr_seq_material,nr_seq_estrut_mat )
				values (	nextval('processo_judicial_mat_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w,cd_material_w,nr_seq_material_w,nr_seq_estrut_mat_w);
				end;
			end loop;
			close c03;
		end if;
	end if;

	if (coalesce(ie_impacto_coparticipacao_w,'N') <> 'N') then
		select 	count(1)
		into STRICT	qt_reg_copartic_w
		from 	pls_processo_jud_copartic
		where 	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_copartic_w,0) > 0) then
			open c04;
			loop
			fetch c04 into
				ie_isentar_coparticipacao_w,
				nr_seq_processo_copartic_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin
				select	nextval('pls_processo_jud_copartic_seq')
				into STRICT	nr_seq_process_cop_depend_w
				;

				insert into pls_processo_jud_copartic(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo,ie_isentar_coparticipacao)
				values (	nr_seq_process_cop_depend_w, clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w,ie_isentar_coparticipacao_w);

				select	count(1)
				into STRICT	qt_reg_copartic_proc_w
				from 	pls_processo_jud_proc
				where 	nr_seq_processo_copartic = nr_seq_processo_copartic_w;

				if (coalesce(qt_reg_copartic_proc_w,0) > 0) then
					open c05;
					loop
					fetch c05 into
						cd_area_proced_copartic_w,
						cd_especialidade_copartic_w,
						cd_grupo_proc_copartic_w,
						cd_procedimento_copartic_w;
					EXIT WHEN NOT FOUND; /* apply on c05 */
						begin
						insert into pls_processo_jud_proc(	nr_sequencia, dt_atualizacao,nm_usuario,
								nr_seq_processo_copartic,cd_area_procedimento, cd_especialidade,
								cd_grupo_proc, cd_procedimento)
						values (	nextval('pls_processo_jud_proc_seq'), clock_timestamp(), nm_usuario_p,
								nr_seq_process_cop_depend_w, cd_area_proced_copartic_w, cd_especialidade_copartic_w,
								cd_grupo_proc_copartic_w, cd_procedimento_copartic_w );
						end;
					end loop;
					close c05;
				end if;

				select 	count(1)
				into STRICT	qt_reg_copartic_mat_w
				from 	pls_processo_jud_mat
				where 	nr_seq_processo_copartic = nr_seq_processo_copartic_w;

				if (coalesce(qt_reg_copartic_mat_w,0) > 0) then
					open c06;
					loop
					fetch c06 into
						ie_tipo_despesa_copartic_w,
						nr_seq_material_copartic_w;
					EXIT WHEN NOT FOUND; /* apply on c06 */
						begin
						insert into pls_processo_jud_mat(	nr_sequencia, dt_atualizacao,nm_usuario,
								nr_seq_processo_copartic,ie_tipo_despesa, nr_seq_material)
						values (	nextval('pls_processo_jud_mat_seq'), clock_timestamp(), nm_usuario_p,
								nr_seq_process_cop_depend_w, ie_tipo_despesa_copartic_w,nr_seq_material_copartic_w);
						end;
					end loop;
					close c06;
				end if;
				end;
			end loop;
			close c04;
		end if;
	end if;

	if (coalesce(ie_impacto_notificacao_w,'N') <> 'N') then
		select 	count(1)
		into STRICT	qt_reg_notific_w
		from 	pls_processo_jud_notif
		where	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_notific_w,0) > 0) then
			open c07;
			loop
			fetch c07 into
				nr_seq_regra_notif_w,
				ie_permite_notificacao_w,
				ie_permite_rescisao_w,
				ie_permite_susp_atend_w,
				ie_permite_susp_mens_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */
				begin
				insert into pls_processo_jud_notif(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, nr_seq_regra_notif,ie_permite_notificacao,
						ie_permite_rescisao, ie_permite_susp_atend, ie_permite_susp_mens)
				values (	nextval('pls_processo_jud_notif_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w, nr_seq_regra_notif_w, ie_permite_notificacao_w,
						ie_permite_rescisao_w, ie_permite_susp_atend_w, ie_permite_susp_mens_w);
				end;
			end loop;
			close c07;
		end if;
	end if;

	if (coalesce(ie_impacto_reajuste_w,'N') <> 'N') then
		select 	count(1)
		into STRICT	qt_reg_reaj_w
		from 	pls_processo_judicial_reaj
		where	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_reaj_w,0) > 0) then
			open c08;
			loop
			fetch c08 into
				dt_inicio_vigencia_w,
				dt_fim_vigencia_w,
				ie_impedir_reaj_fx_etaria_w,
				ie_impedir_reaj_indice_w,
				ie_considerar_dependente_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
				begin
				insert into pls_processo_judicial_reaj(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, dt_inicio_vigencia, dt_fim_vigencia,
						ie_impedir_reaj_fx_etaria, ie_impedir_reaj_indice, ie_considerar_dependente)
				values (	nextval('pls_processo_judicial_reaj_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w, dt_inicio_vigencia_w, dt_fim_vigencia_w,
						ie_impedir_reaj_fx_etaria_w, ie_impedir_reaj_indice_w, ie_considerar_dependente_w);
				end;
			end loop;
			close c08;
		end if;
	end if;

	if (coalesce(ie_impacto_contrato_w,'N') <> 'N') then
		select 	count(1)
		into STRICT	qt_reg_contr_w
		from 	pls_processo_jud_contrato
		where	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_contr_w,0) > 0) then
			open c09;
			loop
			fetch c09 into
				dt_inicio_vigencia_contr_w,
				dt_fim_vigencia_contr_w,
				ie_impedir_rescisao_contr_w,
				ds_observacao_contr_w;
			EXIT WHEN NOT FOUND; /* apply on c09 */
				begin
				insert into pls_processo_jud_contrato(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, dt_inicio_vigencia, dt_fim_vigencia,
						ie_impedir_rescisao_seg, ds_observacao)
				values (	nextval('pls_processo_jud_contrato_seq'), clock_timestamp(), nm_usuario_p,
						nr_seq_proc_jud_depend_w, dt_inicio_vigencia_contr_w, dt_fim_vigencia_contr_w,
						ie_impedir_rescisao_contr_w, ds_observacao_contr_w );
				end;
			end loop;
			close c09;
		end if;

		select	count(1)
		into STRICT	qt_reg_susp_contr_w
		from	pls_segurado_suspensao
		where	nr_seq_processo = nr_seq_processo_p;

		if (coalesce(qt_reg_susp_contr_w,0) > 0) then
			open c10;
			loop
			fetch c10 into
				dt_prev_inicio_susp_w,
				dt_prev_fim_susp_w,
				dt_inicio_suspensao_w,
				dt_fim_suspensao_w,
				nr_seq_motivo_susp_w,
				nr_seq_notificacao_pag_w,
				ds_observacao_w,
				ds_motivo_fim_susp_w;
			EXIT WHEN NOT FOUND; /* apply on c10 */
				begin
				select 	max(nr_seq_contrato),
					max(nr_seq_intercambio)
				into STRICT	nr_seq_contrato_w,
					nr_seq_intercambio_w
				from 	pls_segurado
				where 	nr_sequencia = nr_seq_segurado_p;

				insert into pls_segurado_suspensao(	nr_sequencia, dt_atualizacao,nm_usuario,
						nr_seq_processo, dt_prev_inicio_susp, dt_prev_fim_susp,
						dt_inicio_suspensao, dt_fim_suspensao, nr_seq_motivo_susp,
						nr_seq_notificacao_pag, ds_observacao, ds_motivo_fim_susp,
						nr_seq_contrato, nr_seq_intercambio)
				values (	nextval('pls_segurado_suspensao_seq'), clock_timestamp(), nm_usuario_p,
						 nr_seq_proc_jud_depend_w, dt_prev_inicio_susp_w, dt_prev_fim_susp_w,
						 dt_inicio_suspensao_w, dt_fim_suspensao_w, nr_seq_motivo_susp_w,
						nr_seq_notificacao_pag_w, ds_observacao_w, ds_motivo_fim_susp_w,
						nr_seq_contrato_w, nr_seq_intercambio_w);
				end;
			end loop;
			close c10;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apl_regra_familia_pj ( nr_seq_segurado_p bigint, nr_seq_processo_p bigint, nm_usuario_p text) FROM PUBLIC;

