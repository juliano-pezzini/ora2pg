-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_url_telemedicina ( nr_seq_agecons_p bigint default null, ds_url_p text default null, ds_url_medico_p text default null, ds_pac_cod_p text default null, ds_med_cod_p text default null, nm_usuario_p text default null, ie_acao_p text default 'I') AS $body$
DECLARE


qt_reg_w smallint;
nm_usuario_w agenda_consulta_adic.nm_usuario%type;


BEGIN

if (coalesce(nm_usuario_p::text, '') = '' or length(nm_usuario_p) = 0) then
    nm_usuario_w := obter_usuario_ativo();
else
    nm_usuario_w := nm_usuario_p;
end if;

if (coalesce(ie_acao_p, 'I') = 'I') then
  if ((ds_url_p IS NOT NULL AND ds_url_p::text <> '') and coalesce(ds_url_medico_p::text, '') = '') then
      select coalesce(max(1),0)
      into STRICT qt_reg_w
      from agenda_consulta_adic
      where nr_seq_agenda = nr_seq_agecons_p;

      if (qt_reg_w = 0) then
          insert into agenda_consulta_adic(nr_seq_agenda, ds_url_telemedicina, nm_usuario, dt_atualizacao)
          values (nr_seq_agecons_p, ds_url_p, nm_usuario_w, clock_timestamp());
      else
          update agenda_consulta_adic
          set ds_url_telemedicina = ds_url_p
          where nr_seq_agenda = nr_seq_agecons_p;
      end if;
  elsif (ds_url_p IS NOT NULL AND ds_url_p::text <> '' AND ds_url_medico_p IS NOT NULL AND ds_url_medico_p::text <> '') then
      select coalesce(max(1),0)
      into STRICT qt_reg_w
      from agenda_consulta_adic
      where nr_seq_agenda = nr_seq_agecons_p;

      if (qt_reg_w = 0) then
          insert into agenda_consulta_adic(nr_seq_agenda, ds_url_telemedicina, ds_url_tele_medico, nm_usuario, dt_atualizacao)
          values (nr_seq_agecons_p, ds_url_p, ds_url_medico_p, nm_usuario_w, clock_timestamp());
      else
          update agenda_consulta_adic set
          ds_url_telemedicina = ds_url_p,
          ds_url_tele_medico = ds_url_medico_p
          where nr_seq_agenda = nr_seq_agecons_p;
      end if;
  end if;
elsif (ie_acao_p = 'D') then
  select coalesce(max(1),0)
  into STRICT qt_reg_w
  from agenda_consulta_adic
  where nr_seq_agenda = nr_seq_agecons_p;

  if (qt_reg_w > 0) then
      update agenda_consulta_adic set
      ds_url_telemedicina  = NULL,
      ds_url_tele_medico  = NULL
      where nr_seq_agenda = nr_seq_agecons_p;
  end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_url_telemedicina ( nr_seq_agecons_p bigint default null, ds_url_p text default null, ds_url_medico_p text default null, ds_pac_cod_p text default null, ds_med_cod_p text default null, nm_usuario_p text default null, ie_acao_p text default 'I') FROM PUBLIC;

