-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dividir_reserva_hemoterapia ( nr_seq_reserva_orig_p bigint, qt_solicitada_p bigint, nr_seq_item_p bigint, nm_usuario_p text, nr_seq_reserva_dest_p INOUT bigint) AS $body$
DECLARE


cd_pessoa_fisica_w			varchar(10);
dt_cirurgia_w				timestamp;
dt_reserva_w				timestamp;
cd_pf_realizou_w				varchar(10);
cd_medico_requisitante_w			varchar(10);
cd_medico_cirurgiao_w			varchar(10);
cd_convenio_w				integer;
nr_atendimento_w				bigint;
ds_observacao_w				varchar(255);
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
ie_status_w				varchar(1);
nr_seq_entidade_w				bigint;
cd_estabelecimento_w			smallint;
nr_prescricao_w				bigint;
nr_seq_item_w				smallint;
nr_seq_derivado_w				bigint;
ie_util_hemocomponente_w			varchar(15);
qt_vol_hemocomp_w			bigint;
nr_seq_prescr_w				integer;
ie_suspenso_w				varchar(1);
dt_prevista_w				timestamp;
qt_solicitada_w				san_reserva_item.qt_solicitada%type;


BEGIN

if (nr_Seq_reserva_dest_p = 0) then

	select	cd_pessoa_fisica,
		dt_cirurgia,
		dt_reserva,
		cd_pf_realizou,
		cd_medico_requisitante,
		cd_medico_cirurgiao,
		cd_convenio,
		nr_atendimento,
		ds_observacao,
		cd_procedimento,
		ie_origem_proced,
		ie_status,
		nr_seq_entidade,
		cd_estabelecimento,
		nr_prescricao
	into STRICT	cd_pessoa_fisica_w,
		dt_cirurgia_w,
		dt_reserva_w,
		cd_pf_realizou_w,
		cd_medico_requisitante_w,
		cd_medico_cirurgiao_w,
		cd_convenio_w,
		nr_atendimento_w,
		ds_observacao_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_status_w,
		nr_seq_entidade_w,
		cd_estabelecimento_w,
		nr_prescricao_w
	from	san_reserva
	where	nr_sequencia = nr_seq_reserva_orig_p;

	select	nextval('san_reserva_seq')
	into STRICT	nr_seq_reserva_dest_p
	;

	insert into san_reserva( nr_sequencia,
				cd_pessoa_fisica,
				dt_cirurgia,
				dt_atualizacao,
				nm_usuario,
				dt_reserva,
				cd_pf_realizou,
				cd_medico_requisitante,
				cd_medico_cirurgiao,
				cd_convenio,
				nr_atendimento,
				ds_observacao,
				cd_procedimento,
				ie_origem_proced,
				ie_status,
				nr_seq_entidade,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_estabelecimento,
				nr_prescricao)
	values (nr_seq_reserva_dest_p,
		cd_pessoa_fisica_w,
		dt_cirurgia_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_reserva_w,
		cd_pf_realizou_w,
		cd_medico_requisitante_w,
		cd_medico_cirurgiao_w,
		cd_convenio_w,
		nr_atendimento_w,
		ds_observacao_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_status_w,
		nr_seq_entidade_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_w,
		nr_prescricao_w);

end if;

select	nr_seq_derivado,
	ie_util_hemocomponente,
	qt_vol_hemocomp,
	nr_prescricao,
	nr_seq_prescr,
	ie_suspenso,
	dt_prevista,
	(qt_solicitada - qt_solicitada_p)
into STRICT	nr_seq_derivado_w,
	ie_util_hemocomponente_w,
	qt_vol_hemocomp_w,
	nr_prescricao_w,
	nr_seq_prescr_w,
	ie_suspenso_w,
	dt_prevista_w,
	qt_solicitada_w
from	san_reserva_item
where	nr_seq_item = nr_seq_item_p
and	nr_seq_reserva = nr_seq_reserva_orig_p;

select (coalesce(max(nr_seq_item),0) + 1)
into STRICT	nr_seq_item_w
from	san_reserva_item
where	nr_seq_reserva = nr_seq_reserva_dest_p;

insert into san_reserva_item(  nr_seq_reserva,
				nr_seq_item,
				nr_seq_derivado,
				qt_solicitada,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_util_hemocomponente,
				qt_vol_hemocomp,
				nr_prescricao,
				nr_seq_prescr,
				ie_suspenso,
				dt_prevista)
	values (nr_seq_reserva_dest_p,
		nr_seq_item_w,
		nr_seq_derivado_w,
		CASE WHEN qt_solicitada_p=0 THEN qt_solicitada_w  ELSE qt_solicitada_p END ,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_util_hemocomponente_w,
		qt_vol_hemocomp_w,
		nr_prescricao_w,
		nr_seq_prescr_w,
		ie_suspenso_w,
		dt_prevista_w);
if (qt_solicitada_p = 0) then

	delete 	FROM san_reserva_item
	where 	nr_seq_item = nr_seq_item_p
	and 	nr_seq_Reserva = nr_seq_reserva_orig_p;


else
	update 	san_reserva_item
	set 	qt_solicitada = qt_solicitada_w
	where 	nr_seq_item = nr_seq_item_p
	and 	nr_seq_Reserva = nr_seq_reserva_orig_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dividir_reserva_hemoterapia ( nr_seq_reserva_orig_p bigint, qt_solicitada_p bigint, nr_seq_item_p bigint, nm_usuario_p text, nr_seq_reserva_dest_p INOUT bigint) FROM PUBLIC;

