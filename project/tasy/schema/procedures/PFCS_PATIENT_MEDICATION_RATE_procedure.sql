-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_patient_medication_rate ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR FOR
	SELECT	x.cd_pessoa_fisica id_patient,
		coalesce(get_formatted_person_name(x.cd_pessoa_fisica, 'list'), obter_nome_pf(x.cd_pessoa_fisica)) nm_patient,
		pfcs_obter_lista_dados_classif(x.cd_pessoa_fisica) ds_classification,
		obter_sexo_pf(x.cd_pessoa_fisica, 'D') ds_gender,
		pf.dt_nascimento dt_birthdate,
        obter_dados_pf(x.cd_pessoa_fisica, 'I') qt_idade_paciente,
		x.nr_atendimento nr_encounter,
		x.dt_entrada dt_entrance
	from	atendimento_paciente x, pessoa_fisica pf
	where	to_date(obter_dados_desfecho_pa(x.nr_atendimento, 'UP'), 'dd/mm/yyyy hh24:mi:ss') > pfcs_get_pa_period
	and (x.ie_tipo_atendimento = 3 or (x.ie_tipo_atendimento = 1 and ((x.dt_usuario_intern IS NOT NULL AND x.dt_usuario_intern::text <> '') or (x.nr_atend_origem_pa IS NOT NULL AND x.nr_atend_origem_pa::text <> ''))))
	and	coalesce(x.dt_cancelamento::text, '') = ''
	and	x.cd_estabelecimento = (cd_estabelecimento_p)::numeric
	and	x.cd_pessoa_fisica = pf.cd_pessoa_fisica;

c02 CURSOR(nr_atendimento_p bigint) FOR
	SELECT	1/*decode(nvl(count(*),0),0,'N','S') ie_hospitalized*/
	from	atendimento_alta a, parametro_medico pm
	where	a.nr_atendimento = nr_atendimento_p
	and	a.ie_desfecho <> 'I'
	and     pm.cd_estabelecimento = (cd_estabelecimento_p)::numeric
	and 	((a.ie_tipo_orientacao <> 'P')
	or (coalesce(pm.ie_liberar_desfecho,'N')  = 'N')
	or  	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')))
	and	get_if_encounter_medic(a.nr_atendimento) = 'S';

qt_total_attended_w			bigint := 0;
qt_total_medicated_w			bigint := 0;
pfcs_panel_detail_seq_w			pfcs_panel_detail.nr_sequencia%type;
nr_seq_operational_level_w		pfcs_operational_level.nr_sequencia%type;
nr_seq_panel_w				pfcs_panel.nr_sequencia%type;
BEGIN

	nr_seq_operational_level_w := pfcs_get_structure_level(
			cd_establishment_p => cd_estabelecimento_p,
			ie_level_p => 'O',
			ie_info_p => 'C');

	for c01_w in c01 loop

		begin

			qt_total_attended_w := qt_total_attended_w + 1;

			for c02_w in c02(c01_w.nr_encounter) loop

				begin

					select	nextval('pfcs_panel_detail_seq')
					into STRICT	pfcs_panel_detail_seq_w
					;

					insert into pfcs_panel_detail(
						nr_sequencia,
						nm_usuario,
						dt_atualizacao,
						nm_usuario_nrec,
						dt_atualizacao_nrec,
						ie_situation,
						nr_seq_indicator,
						nr_seq_operational_level)
					values (
						pfcs_panel_detail_seq_w,
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						'T',
						nr_seq_indicator_p,
						nr_seq_operational_level_w);

					insert into pfcs_detail_patient(
						nr_sequencia,
						nm_usuario,
						dt_atualizacao,
						nm_usuario_nrec,
						dt_atualizacao_nrec,
						nr_seq_detail,
						nr_encounter,
						dt_entrance,
						id_patient,
						nm_patient,
						ds_gender,
						ds_classification,
						dt_birthdate,
                        ds_age_range)
					values (
						nextval('pfcs_detail_patient_seq'),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						pfcs_panel_detail_seq_w,
						c01_w.nr_encounter,
						c01_w.dt_entrance,
						c01_w.id_patient,
						c01_w.nm_patient,
						c01_w.ds_gender,
						c01_w.ds_classification,
						c01_w.dt_birthdate,
                        c01_w.qt_idade_paciente);

					qt_total_medicated_w := qt_total_medicated_w + 1;

				end;

			end loop;

		end;

	end loop;

	commit;

	 := pfcs_pck.pfcs_generate_results(
					vl_indicator_p => qt_total_medicated_w, vl_indicator_aux_p => qt_total_attended_w, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

	CALL pfcs_pck.pfcs_update_detail(
					nr_seq_indicator_p => nr_seq_indicator_p,
					nr_seq_panel_p => nr_seq_panel_w,
					nr_seq_operational_level_p => nr_seq_operational_level_w,
					nm_usuario_p => nm_usuario_p);

	CALL pfcs_pck.pfcs_activate_records(
					nr_seq_indicator_p => nr_seq_indicator_p,
					nr_seq_operational_level_p => nr_seq_operational_level_w,
					nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_patient_medication_rate ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

