-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_exame_lab_res_interf ( nr_prescricao_p bigint, nr_seq_resultado_p bigint, nr_seq_item_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, qt_erro_p bigint, ds_campo_p text, vl_resultado_p text, vl_resultado_ponto_p text, cd_unidade_medida_p text, ds_referencia_p text, nm_usuario_p text, ie_gerar_log_p text, qt_erro_out_p INOUT bigint, nr_prescricao_out_p INOUT bigint) AS $body$
DECLARE


sql_dinamico_w		varchar(2000) := '';
sql_unid_med_w		varchar(200) := '';
sql_unid_med_bv_w	varchar(200) := '';
sql_refer_w		varchar(200) := '';
ds_parametros_w		varchar(2000) := '';
ds_log_w		varchar(200) := '';
sql_status		varchar(100) := '';


BEGIN

nr_prescricao_out_p := nr_prescricao_p;
qt_erro_out_p := qt_erro_p;

if (cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') then
	sql_unid_med_w := ', ds_unidade_medida = :ds_unidade_medida';
	sql_unid_med_bv_w := ';ds_unidade_medida=' || cd_unidade_medida_p;
	begin
	if (ie_gerar_log_p = 'S') then
		CALL gerar_lab_log_interf_imp( nr_prescricao_p,nr_seq_prescr_p,null,null,'',obter_desc_expressao(652436) || ' ' || sql_unid_med_w,'',nm_usuario_p,'N');
	end if;
	exception
		when others then null;
	end;
end if;

if (ds_referencia_p IS NOT NULL AND ds_referencia_p::text <> '') then
	sql_refer_w	:= ', ds_referencia = ''' || replace(ds_referencia_p,'&','#13#10') || ''' ';
	begin
	if (ie_gerar_log_p = 'S') then
		CALL gerar_lab_log_interf_imp( nr_prescricao_p,nr_seq_prescr_p,null,null,'',obter_desc_expressao(297388) || ': ' || sql_refer_w,'',nm_usuario_p,'N');
	end if;
	exception
		when others then null;
	end;
end if;

begin
if (ds_campo_p = 'qt_resultado') and (coalesce((somente_numero(vl_resultado_p))::numeric ,0) = 0) then
	sql_status := ', ie_status =  nvl(ie_status,1)';
end if;
exception
	when others then null;
end;



ds_parametros_w := 'vl_resultado=' || vl_resultado_p ||
		   ';nm_usuario=' || nm_usuario_p ||
		   ';nr_seq_resultado=' || nr_seq_resultado_p ||
		   sql_unid_med_bv_w ||
		   ';nr_seq_item=' || nr_seq_item_p ||
		   ';nr_seq_prescr=' || nr_seq_prescr_p || ';';



sql_dinamico_w :=    ' update exame_lab_result_item ' ||
                     ' set ' || ds_campo_p || ' = :vl_resultado, ' ||
                     ' 	   nm_usuario = :nm_usuario' ||
                     '	   ' || sql_unid_med_w || sql_refer_w || sql_status ||
                     ' where nr_seq_resultado = :nr_seq_resultado' ||
                     '   and nr_seq_exame = :nr_seq_item' ||
                     '   and nr_seq_prescr = :nr_seq_prescr';


begin
CALL Exec_sql_Dinamico_bv('',sql_dinamico_w,ds_parametros_w);

ds_log_w := 	'4 log: ds_campo: ' || ds_campo_p ||
		' sql_unid_med: '   || sql_unid_med_w ||
		' sql_refer: '||sql_refer_w ||
		' nr_seq_item: ' ||nr_seq_item_p ||
		' nr_seq_prescr: '  || nr_seq_prescr_p ||
		' nr_seq_resultado: '|| nr_seq_resultado_p;
begin
if (ie_gerar_log_p = 'S') then
	CALL gerar_lab_log_interf_imp( nr_prescricao_p,nr_seq_prescr_p,null,null,'',ds_log_w,'',nm_usuario_p,'N');
end if;
exception
	when others then null;
end;


begin
if (ie_gerar_log_p = 'S') then
	CALL gerar_lab_log_interf_imp( nr_prescricao_p,nr_seq_prescr_p,null,null,'',obter_desc_expressao(779445) || ' ' || nm_usuario_p,'',nm_usuario_p,'N');
end if;
exception
	when others then null;
end;

exception
when others then
	if (vl_resultado_ponto_p IS NOT NULL AND vl_resultado_ponto_p::text <> '') then
		begin
		ds_parametros_w := 'vl_resultado=' || vl_resultado_ponto_p ||
				   ';nm_usuario=' || nm_usuario_p ||
				   ';nr_seq_resultado=' || nr_seq_resultado_p ||
				   sql_unid_med_bv_w ||
				   ';nr_seq_item=' || nr_seq_item_p ||
				   ';nr_seq_prescr=' || nr_seq_prescr_p || ';';



		sql_dinamico_w :=    ' update exame_lab_result_item ' ||
				     ' set ' || ds_campo_p || ' = :vl_resultado, ' ||
				     ' 	   nm_usuario = :nm_usuario' ||
				     '	   ' || sql_unid_med_w || sql_refer_w || sql_status ||
				     ' where nr_seq_resultado = :nr_seq_resultado' ||
				     '   and nr_seq_exame = :nr_seq_item' ||
				     '   and nr_seq_prescr = :nr_seq_prescr';

		CALL Exec_sql_Dinamico_bv('',sql_dinamico_w,ds_parametros_w);
		exception
		when others then
			begin
			if (ie_gerar_log_p = 'S') then
				CALL gerar_lab_log_interf_imp(nr_prescricao_p,nr_seq_prescr_p,nr_seq_item_p,nr_seq_material_p,'','2 - '||substr(wheb_mensagem_pck.get_texto(807369,'DS_ERRO='||SQLERRM),1,2000)||' ' || SQLERRM,'',nm_usuario_p,'N');
			end if;
			exception
				when others then null;
			end;

			nr_prescricao_out_p  := '';
			qt_erro_out_p := ( qt_erro_p + 1);
		end;
	end if;
	begin
	if (ie_gerar_log_p = 'S') then
		CALL gerar_lab_log_interf_imp(nr_prescricao_p,nr_seq_prescr_p,nr_seq_item_p,nr_seq_material_p,'',substr(wheb_mensagem_pck.get_texto(807369,'DS_ERRO='||''),1,2000),'',nm_usuario_p,'N');
	end if;
	exception
		when others then null;
	end;
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_exame_lab_res_interf ( nr_prescricao_p bigint, nr_seq_resultado_p bigint, nr_seq_item_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, qt_erro_p bigint, ds_campo_p text, vl_resultado_p text, vl_resultado_ponto_p text, cd_unidade_medida_p text, ds_referencia_p text, nm_usuario_p text, ie_gerar_log_p text, qt_erro_out_p INOUT bigint, nr_prescricao_out_p INOUT bigint) FROM PUBLIC;

