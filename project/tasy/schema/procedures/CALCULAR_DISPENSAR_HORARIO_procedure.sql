-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_dispensar_horario ( nr_prescricao_p bigint, nr_seq_horario_p bigint) AS $body$
DECLARE


cd_um_consumo_w				varchar(30);
qt_dose_consumo_w			double precision;
cd_um_prescricao_w			varchar(30);
qt_dose_prescricao_w		double precision;
qt_unitaria_w				double precision;
nr_seq_material_w			integer;
nr_seq_horario_w			bigint;
dt_horario_w				timestamp;
cd_um_paciente_w			varchar(30);
qt_dose_paciente_w			double precision;
cd_um_farmacia_w			varchar(30);
qt_dose_farmacia_w			double precision;
qt_dose_total_farmacia_w	double precision;
ds_dose_diferenciada_w		varchar(2000);
nr_seq_material_ww			integer  := 0;
qt_dispensar_w				double precision;
qt_dispensar_parcial_w		double precision;
qt_dose_disponivel_w		double precision := 0;
qt_dose_total_disp_w		double precision;
ie_cursor_w					varchar(1);
qt_unitaria_horario_w		double precision;
ie_trata_dose_dif_w			varchar(2);
cd_estabelecimento_w		integer;
nm_usuario_w				varchar(15);
ie_ajustar_disp_w			varchar(15);
ie_regra_disp_w				varchar(15);
sql_w						varchar(4000);


c01 REFCURSOR;
ie_update_w				varchar(2);
qt_dispensar_update_w	double precision;
ds_erro_w				varchar(4000);
ds_parametros_w			varchar(4000);


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;

ie_ajustar_disp_w := obter_param_usuario(924, 179, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_ajustar_disp_w);
ie_trata_dose_dif_w := obter_param_usuario(924, 1003, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_trata_dose_dif_w);

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	if (ie_ajustar_disp_w = 'C') then
		open c01 for
		SELECT	d.cd_unidade_medida_consumo,
				d.qt_conv_estoque_consumo,
				b.cd_unidade_medida_dose,
				coalesce(a.qt_dose, b.qt_dose),
				b.qt_unitaria,
				a.nr_seq_material,
				a.nr_sequencia,
				a.dt_horario,
				a.cd_unidade_medida_dose,
				a.qt_dose,
				a.cd_unidade_medida,
				a.qt_dispensar_hor,
				a.qt_dispensar,
				obter_dose_convertida(d.cd_material, a.qt_dose, a.cd_unidade_medida_dose, d.cd_unidade_medida_consumo),
				b.ds_dose_diferenciada,
				CASE WHEN coalesce(b.ie_regra_disp,'S')='N' THEN 'N'  ELSE 'S' END
		from	material d,
				prescr_mat_hor a,
				prescr_material b,
				(
					SELECT distinct
							b.cd_material,
							b.nr_prescricao,
							a.nr_seq_material
					from	prescr_mat_hor a,
							prescr_material b,
							prescr_medica c,
							material d
					where	a.cd_material		= b.cd_material
					and		a.nr_prescricao		= b.nr_prescricao
					and		a.nr_seq_material	= b.nr_sequencia
					and		b.nr_prescricao		= c.nr_prescricao
					and		((coalesce(ie_ajustar_disp_w,'N') <> 'R') or (obter_regra_dispensacao(cd_estabelecimento_w, b.cd_material, b.cd_unidade_medida_dose, b.ie_via_aplicacao, b.cd_intervalo, c.nr_atendimento, 'A', c.nr_prescricao, b.nr_sequencia) <> 'M'))
					and		((b.ds_dose_diferenciada IS NOT NULL AND b.ds_dose_diferenciada::text <> '') or (b.qt_total_dispensar	> b.qt_material) or (trunc(a.qt_dispensar_hor) <> a.qt_dispensar_hor) or (b.qt_total_dispensar	>= b.qt_material and upper(d.cd_unidade_medida_consumo) = upper(obter_unid_med_usua('ml'))))
					and		c.nr_prescricao		= nr_prescricao_p
					and		((coalesce(nr_seq_horario_p,0) = 0) or (a.nr_sequencia	= nr_seq_horario_p))
					and		d.cd_material		= b.cd_material
				) e
		where	b.cd_material		= e.cd_material
		and		b.nr_prescricao		= e.nr_prescricao
		and		b.nr_sequencia		= e.nr_seq_material
		and		a.cd_material		= b.cd_material
		and		a.nr_prescricao		= b.nr_prescricao
		and		a.nr_seq_material	= b.nr_sequencia
		and		((coalesce(nr_seq_horario_p,0) = 0) or (a.nr_sequencia	= nr_seq_horario_p))
		and		d.cd_material		= b.cd_material
		order by
			a.nr_seq_material,
			a.nr_sequencia;
	else
		open c01 for
		SELECT	d.cd_unidade_medida_consumo,
				d.qt_conv_estoque_consumo,
				b.cd_unidade_medida_dose,
				coalesce(a.qt_dose, b.qt_dose),
				b.qt_unitaria,
				a.nr_seq_material,
				a.nr_sequencia,
				a.dt_horario,
				a.cd_unidade_medida_dose,
				a.qt_dose,
				a.cd_unidade_medida,
				a.qt_dispensar_hor,
				a.qt_dispensar,
				obter_dose_convertida(d.cd_material, a.qt_dose, a.cd_unidade_medida_dose, d.cd_unidade_medida_consumo),
				b.ds_dose_diferenciada,
				CASE WHEN coalesce(b.ie_regra_disp,'S')='N' THEN 'N'  ELSE 'S' END
		from	material d,
				prescr_mat_hor a,
				prescr_material b,
				prescr_medica c
		where	d.cd_material		= a.cd_material
		and 	a.cd_material		= b.cd_material
		and		a.nr_prescricao		= b.nr_prescricao
		and		a.nr_seq_material	= b.nr_sequencia
		and		b.nr_prescricao		= c.nr_prescricao
		and		((coalesce(ie_ajustar_disp_w,'N') <> 'R') or (Obter_regra_dispensacao(cd_estabelecimento_w, b.cd_material, b.cd_unidade_medida_dose, b.ie_via_aplicacao, b.cd_intervalo, c.nr_atendimento, 'A', nr_prescricao_p,nr_seq_horario_p) <> 'M'))
		and		((b.ds_dose_diferenciada IS NOT NULL AND b.ds_dose_diferenciada::text <> '') or (b.qt_total_dispensar	> b.qt_material) or (trunc(a.qt_dispensar_hor) <> a.qt_dispensar_hor) or (b.qt_total_dispensar	>= b.qt_material and upper(d.cd_unidade_medida_consumo) = upper(obter_unid_med_usua('ml')) and b.qt_unitaria <> b.qt_material))
		and		c.nr_prescricao		= nr_prescricao_p
		and		((coalesce(nr_seq_horario_p,0) = 0) or (a.nr_sequencia	= nr_seq_horario_p))
		order by
			a.nr_seq_material,
			a.nr_sequencia;
	end if;

	loop
	fetch c01 into	cd_um_consumo_w,
				qt_dose_consumo_w,
				cd_um_prescricao_w,
				qt_dose_prescricao_w,
				qt_unitaria_w,
				nr_seq_material_w,
				nr_seq_horario_w,
				dt_horario_w,
				cd_um_paciente_w,
				qt_dose_paciente_w,
				cd_um_farmacia_w,
				qt_dose_farmacia_w,
				qt_dose_total_farmacia_w,
				qt_unitaria_horario_w,
				ds_dose_diferenciada_w,
				ie_regra_disp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

			begin
				sql_w := 'call obter_qt_unitaria_md(:1, :2, :3, :4) into :qt_unitaria_w';
				EXECUTE sql_w
				using	in qt_unitaria_w,
						in qt_unitaria_horario_w,
						in ds_dose_diferenciada_w,
						in ie_regra_disp_w,
						out qt_unitaria_w;
			exception
			when others then
				ds_erro_w := sqlerrm;
				ds_parametros_w := ( 'nr_prescricao_p: ' || nr_prescricao_p ||
										' nr_seq_horario_p: ' || nr_seq_horario_p ||
										' qt_unitaria_w: ' || qt_unitaria_w ||
										' qt_unitaria_horario_w: ' || qt_unitaria_horario_w ||
										' ds_dose_diferenciada_w: ' || ds_dose_diferenciada_w ||
										' ie_regra_disp_w: ' || ie_regra_disp_w ||
										' qt_unitaria_w: ' || qt_unitaria_w);

				CALL gravar_log_medical_device('calcular_dispensar_horario',
											'obter_qt_unitaria_md',
											ds_parametros_w,
											ds_erro_w,
											wheb_usuario_pck.get_nm_usuario,
											'S');

				qt_unitaria_w := null;
			end;

			begin
				sql_w := 'begin calcular_dispensar_horario_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15, :16, :17, :18); end;';

				EXECUTE sql_w
				using	in cd_um_consumo_w,
						in cd_um_prescricao_w,
						in nr_seq_material_w,
						in nr_seq_material_ww,
						in qt_dose_total_farmacia_w,
						in ds_dose_diferenciada_w,
						in ie_trata_dose_dif_w,
						in qt_dose_prescricao_w,
						in qt_dose_consumo_w,
						in qt_unitaria_w,
						in ie_ajustar_disp_w,
						in out qt_dose_disponivel_w,
						in out qt_dose_total_disp_w,
						out qt_dispensar_w,
						out ie_cursor_w,
						out qt_dispensar_parcial_w,
						out ie_update_w,
						out qt_dispensar_update_w;
			exception
			when others then
				ds_erro_w := sqlerrm;
				ds_parametros_w := ( 'nr_prescricao_p: ' || nr_prescricao_p ||
										'nr_seq_horario_p: ' || nr_seq_horario_p ||
										'cd_um_consumo_w: ' || cd_um_consumo_w ||
										'cd_um_prescricao_w: ' || cd_um_prescricao_w ||
										'nr_seq_material_w: ' || nr_seq_material_w ||
										'nr_seq_material_ww: ' || nr_seq_material_ww ||
										'qt_dose_total_farmacia_w: ' || qt_dose_total_farmacia_w ||
										'ds_dose_diferenciada_w: ' || ds_dose_diferenciada_w ||
										'ie_trata_dose_dif_w: ' || ie_trata_dose_dif_w ||
										'qt_dose_prescricao_w: ' || qt_dose_prescricao_w ||
										'qt_dose_consumo_w: ' || qt_dose_consumo_w ||
										'qt_unitaria_w: ' || qt_unitaria_w ||
										'ie_ajustar_disp_w: ' || ie_ajustar_disp_w ||
										'qt_dose_disponivel_w: ' || qt_dose_disponivel_w ||
										'qt_dose_total_disp_w: ' || qt_dose_total_disp_w ||
										'qt_dispensar_w: ' || qt_dispensar_w ||
										'ie_cursor_w: ' || ie_cursor_w ||
										'qt_dispensar_parcial_w: ' || qt_dispensar_parcial_w ||
										'ie_update_w: ' || ie_update_w ||
										'qt_dispensar_update_w: ' || qt_dispensar_update_w);

				CALL gravar_log_medical_device('calcular_dispensar_horario',
											'calcular_dispensar_horario_md',
											 ds_parametros_w,
											 ds_erro_w,
											 wheb_usuario_pck.get_nm_usuario,
											 'S');
			
				qt_dose_disponivel_w := null;
				qt_dose_total_disp_w := null;
				qt_dispensar_w := null;
				ie_cursor_w := null;
				qt_dispensar_parcial_w := null;
				ie_update_w := null;
				qt_dispensar_update_w := null;
			end;

			sql_w := null;

			if ie_update_w = 'S' then

				if (qt_dispensar_update_w IS NOT NULL AND qt_dispensar_update_w::text <> '') then
					update  prescr_mat_hor
					set  qt_dispensar_hor  = qt_dispensar_update_w
					where  nr_sequencia    = nr_seq_horario_w
					and  coalesce(cd_motivo_baixa,0) = 0;
				else
					update prescr_mat_hor
					set qt_dispensar_hor  = NULL
					where nr_sequencia = nr_seq_horario_w;
				end if;

			end if;

			nr_seq_material_ww := nr_seq_material_w;

		end;
	end loop;
	close c01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_dispensar_horario ( nr_prescricao_p bigint, nr_seq_horario_p bigint) FROM PUBLIC;

