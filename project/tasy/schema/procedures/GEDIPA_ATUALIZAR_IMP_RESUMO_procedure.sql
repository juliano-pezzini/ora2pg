-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_atualizar_imp_resumo ( cd_local_estoque_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_status_processo_p text, nr_seq_area_prep_p bigint, ie_alta_p text, ie_processo_p bigint, cd_setor_p bigint, nm_usuario_p text) AS $body$
DECLARE

				 
v double precision;
				

BEGIN 
 
if (cd_local_estoque_p IS NOT NULL AND cd_local_estoque_p::text <> '') and (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') and (ie_status_processo_p IS NOT NULL AND ie_status_processo_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	 
	/* 
	update	prescr_mat_hor a 
	set	a.dt_emissao_farmacia	= sysdate 
	where	a.nr_sequencia in ( 
				select	y.nr_sequencia 
				from  prescr_mat_hor y, 
				    adep_processo x 
				where  y.nr_seq_processo    = x.nr_sequencia 
				and   x.cd_local_estoque   = cd_local_estoque_p 
				and   x.ie_status_processo  = ie_status_processo_p 
				and   x.dt_horario_processo	between dt_inicial_p and dt_final_p 
				and   ((nr_seq_area_prep_p	= 0) or 
				     (y.nr_seq_area_prep  = nr_seq_area_prep_p)) 
				and 	((nvl(cd_setor_p,0) = 0) or (x.cd_setor_atendimento = cd_setor_p))); 
	*/
 
	 
	update	prescr_mat_hor a 
	set		a.dt_emissao_farmacia		= clock_timestamp(), 
			nm_usuario_emissao_farmacia = nm_usuario_p, 
			a.ie_separado 				= 'S' 
	where	coalesce(a.dt_emissao_farmacia::text, '') = '' 
	and		a.nr_sequencia in ( 
				SELECT	y.nr_sequencia 
				from  prescr_mat_hor y, 
				    adep_processo x 
				where  y.nr_seq_processo   		= x.nr_sequencia 
				and   x.cd_local_estoque   		= cd_local_estoque_p 
				and   ((nr_seq_area_prep_p		= 0 AND x.ie_status_processo		= ie_status_processo_p) or 
				     ((nr_seq_area_prep_p  	> 0) and (obter_status_processo_area(x.nr_sequencia,y.nr_seq_area_prep) = ie_status_processo_p))) 
				and   coalesce(y.dt_suspensao::text, '') = '' 
				and   x.dt_horario_processo between dt_inicial_p and dt_final_p 
				and   ((nr_seq_area_prep_p  	= 0) or (y.nr_seq_area_prep  		= nr_seq_area_prep_p)) 
				and	((ie_alta_p 			= 'S') or (obter_se_atendimento_alta(x.nr_atendimento) = 'N')) 
				and   ((ie_processo_p = 2) or 
				     ((ie_processo_p = 0) and (coalesce(x.ie_gedipa,'S') = 'S')) or 
				     ((ie_processo_p = 1) and (coalesce(x.ie_gedipa,'S') = 'N'))) 
				and	coalesce(coalesce(y.ie_separado, x.ie_separado),'N')	= 'N' 
				and	Obter_se_horario_liberado(y.dt_lib_horario, y.dt_horario) = 'S' 
				and 	((coalesce(cd_setor_p,0) = 0) or (x.cd_setor_atendimento = cd_setor_p)));
				 
	/* n√£o padronizados !!! */
 
	update	prescr_mat_hor a 
	set		a.ie_separado 		= 'S' 
	where	(a.dt_emissao_farmacia IS NOT NULL AND a.dt_emissao_farmacia::text <> '') 
	and	coalesce(a.ie_separado,'N')	= 'N' 
	and	a.nr_sequencia in ( 
				SELECT	y.nr_sequencia 
				from  prescr_mat_hor y, 
				    adep_processo x 
				where  y.nr_seq_processo   		= x.nr_sequencia 
				and   x.cd_local_estoque   		= cd_local_estoque_p 
				and   ((nr_seq_area_prep_p		= 0 AND x.ie_status_processo		= ie_status_processo_p) or 
				     ((nr_seq_area_prep_p  	> 0) and (obter_status_processo_area(x.nr_sequencia,y.nr_seq_area_prep) = ie_status_processo_p))) 
				and   coalesce(y.dt_suspensao::text, '') = '' 
				and   x.dt_horario_processo between dt_inicial_p and dt_final_p 
				and   ((nr_seq_area_prep_p  	= 0) or (y.nr_seq_area_prep  		= nr_seq_area_prep_p)) 
				and	((ie_alta_p 			= 'S') or (obter_se_atendimento_alta(x.nr_atendimento) = 'N')) 
				and   ((ie_processo_p = 2) or 
				     ((ie_processo_p = 0) and (coalesce(x.ie_gedipa,'S') = 'S')) or 
				     ((ie_processo_p = 1) and (coalesce(x.ie_gedipa,'S') = 'N')))					 
				and	coalesce(coalesce(y.ie_separado, x.ie_separado),'N')	= 'N' 
				and	Obter_se_horario_liberado(y.dt_lib_horario, y.dt_horario) = 'S' 
				and 	((coalesce(cd_setor_p,0) = 0) or (x.cd_setor_atendimento = cd_setor_p)));				
				 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_atualizar_imp_resumo ( cd_local_estoque_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_status_processo_p text, nr_seq_area_prep_p bigint, ie_alta_p text, ie_processo_p bigint, cd_setor_p bigint, nm_usuario_p text) FROM PUBLIC;

