-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_cart_benef_data ( ie_opcao_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
nr_seq_contrato_w		bigint;
qt_meses_regra_w		bigint;
qt_meses_renovacao_w		bigint;
qt_dias_valid_cart_w		bigint;
qt_carteira_w			smallint;
qt_carteira_ant_w		bigint;
nr_seq_cart_ant_w		bigint;
nr_via_w			bigint;
dt_validade_w			timestamp;
dt_contratacao_w		timestamp;

/*Cursor C01 is
	select	nr_sequencia
	from	pls_segurado
	where	nr_seq_contrato	= nr_seq_contrato_p;

Cursor C02 is
	select	nr_sequencia
	from	pls_segurado_cart_ant
	where	nr_seq_segurado = nr_seq_segurado_w
	order by nr_via_anterior;*/
C00 CURSOR FOR
	SELECT	b.nr_sequencia,
		b.nr_seq_contrato,
		b.dt_contratacao
	from 	pls_segurado_carteira   a,
		pls_segurado            b,
		pls_contrato            c
	where	a.dt_validade_carteira > b.dt_contratacao + 180
	and     a.nr_seq_segurado       = b.nr_sequencia
	and     b.nr_seq_contrato       = c.nr_sequencia
	and	b.dt_contratacao	between to_date('01/05/2010') and to_date('30/06/2010')
	--and	c.nr_sequencia		= nr_seq_contrato_p
	and	not exists (SELECT 1 from pls_segurado_cart_ant x where x.nr_seq_segurado = b.nr_sequencia);


BEGIN

open C00;
loop
fetch C00 into
	nr_seq_segurado_w,
	nr_seq_contrato_w,
	dt_contratacao_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin

	select	max(coalesce(qt_meses_renovacao,0))
	into STRICT	qt_meses_renovacao_w
	from	pls_carteira_renovacao
	where	nr_seq_contrato		= nr_seq_contrato_w
	and	coalesce(ie_tipo_renovacao,'A')	= ie_opcao_p;

	select	qt_dias_valid_cart
	into STRICT	qt_dias_valid_cart_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_w;


	if (qt_meses_renovacao_w > 0) then
		update	pls_segurado_carteira
		set	dt_validade_carteira	= (coalesce(dt_contratacao_w,clock_timestamp()) + qt_meses_renovacao_w)
		where	nr_seq_segurado		= nr_seq_segurado_w;
	elsif (qt_dias_valid_cart_w > 0) then
		update	pls_segurado_carteira
		set	dt_validade_carteira	= (coalesce(dt_contratacao_w,clock_timestamp()) + qt_dias_valid_cart_w)
		where	nr_seq_segurado		= nr_seq_segurado_w;
	end if;
	end;
end loop;
close C00;

/*open C01;
loop
fetch C01 into
	nr_seq_segurado_w;
exit when C01%notfound;

	select	count(*)
	into	qt_carteira_ant_w
	from	pls_segurado_cart_ant	a,
		pls_segurado		b,
		pls_contrato		c
	where	nr_seq_segurado	= nr_seq_segurado_w
	and	b.nr_sequencia 	= nr_seq_segurado_w
	and	b.nr_seq_contrato = c.nr_sequencia;

	if	(qt_carteira_ant_w > 1) then
		if	(qt_meses_regra_w > 0) then
			open C02;
			loop
			fetch C02 into
				nr_seq_cart_ant_w;
			exit when C02%notfound;
				begin

				select	nr_via_anterior-1
				into	nr_via_w
				from	pls_segurado_cart_ant
				where	nr_sequencia	= nr_seq_cart_ant_w;

				if	(nr_via_w > 0) then
					select	nvl(dt_validade,null)
					into	dt_validade_w
					from	pls_segurado_cart_ant
					where	nr_via_anterior = nr_via_w;
				else
					dt_validade_w	:= null;
				end if;

				update	pls_segurado_cart_ant
				set	dt_validade		= (nvl(dt_validade_w,sysdate) + qt_meses_regra_w)
				where	nr_sequencia		= nr_seq_cart_ant_w;
				end;
			end loop;
			close C02;
		elsif	(qt_meses_renovacao_w > 0) then
			open C02;
			loop
			fetch C02 into
				nr_seq_cart_ant_w;
			exit when C02%notfound;
				begin
				select	nr_via_anterior-1
				into	nr_via_w
				from	pls_segurado_cart_ant
				where	nr_sequencia	= nr_seq_cart_ant_w;

				if	(nr_via_w > 0) then
					select	nvl(dt_validade,null)
					into	dt_validade_w
					from	pls_segurado_cart_ant
					where	nr_via_anterior = nr_via_w;
				else
					dt_validade_w	:= null;
				end if;

				update	pls_segurado_cart_ant
				set	dt_validade		= (nvl(dt_validade_w,sysdate) + qt_meses_renovacao_w)
				where	nr_sequencia		= nr_seq_cart_ant_w;
				end;
			end loop;
			close C02;
		elsif	(qt_dias_valid_cart_w > 0) then
			open C02;
			loop
			fetch C02 into
				nr_seq_cart_ant_w;
			exit when C02%notfound;
				begin
				select	nr_via_anterior-1
				into	nr_via_w
				from	pls_segurado_cart_ant
				where	nr_sequencia	= nr_seq_cart_ant_w;

				if	(nr_via_w > 0) then
					select	nvl(dt_validade,null)
					into	dt_validade_w
					from	pls_segurado_cart_ant
					where	nr_via_anterior = nr_via_w;
				else
					dt_validade_w	:= null;
				end if;

				update	pls_segurado_cart_ant
				set	dt_validade		= (nvl(dt_validade_w,sysdate) + qt_dias_valid_cart_w)
				where	nr_sequencia		= nr_seq_cart_ant_w;
				end;
			end loop;
			close C02;
		end if;
	end if;

	select	count(*)
	into	qt_carteira_w
	from	pls_segurado_carteira
	where	nr_seq_segurado	= nr_seq_segurado_w
	and	nr_seq_motivo_via is null;

	if	(qt_carteira_w = 1) then
		if	(qt_meses_renovacao_w > 0) then
			select	max(nr_via_anterior)
			into	nr_via_w
			from	pls_segurado_cart_ant
			where	nr_seq_segurado	= nr_seq_segurado_w;

			if	(nr_via_w > 0) then
				select	nvl(dt_validade,null)
				into	dt_validade_w
				from	pls_segurado_cart_ant
				where	nr_via_anterior = nr_via_w;
			else
				dt_validade_w	:= null;
			end if;

			update	pls_segurado_carteira
			set	dt_validade_carteira	= (nvl(dt_validade_w,sysdate) + qt_meses_renovacao_w)
			where	nr_seq_segurado		= nr_seq_segurado_w;
		elsif	(qt_dias_valid_cart_w > 0) then
			select	max(nr_via_anterior)
			into	nr_via_w
			from	pls_segurado_cart_ant
			where	nr_seq_segurado	= nr_seq_segurado_w;

			if	(nr_via_w > 0) then
				select	nvl(dt_validade,null)
				into	dt_validade_w
				from	pls_segurado_cart_ant
				where	nr_via_anterior = nr_via_w;
			else
				dt_validade_w	:= null;
			end if;

			update	pls_segurado_carteira
			set	dt_validade_carteira	= (nvl(dt_validade_w,sysdate) + qt_dias_valid_cart_w)
			where	nr_seq_segurado		= nr_seq_segurado_w;
		end if;
	end if;

end loop;
close C01;*/
commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_cart_benef_data ( ie_opcao_p text) FROM PUBLIC;

