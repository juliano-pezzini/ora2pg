-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_duplicar_negocio ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_neg_lic_w		bigint;
dt_licenca_w			timestamp;
nr_seq_mod_licenc_w		bigint;
qt_licenca_w			bigint;
vl_unitario_w			double precision;
vl_total_w			double precision;
nr_seq_canal_w		bigint;
nr_seq_politica_w		bigint;
dt_inicio_venc_w		timestamp;
vl_unit_manut_w		double precision;
vl_manut_mensal_w		double precision;
dt_inicio_venc_manut_w	timestamp;
cd_pessoa_fisica_w		varchar(10);
vl_unit_distr_w		double precision;
vl_distribuidor_w		double precision;
ds_observacao_w		varchar(4000);
vl_original_w			double precision;
vl_atual_w			double precision;
ie_origem_valor_w		varchar(15);
dt_vencimento_w		timestamp;
vl_parcela_w			double precision;
ie_vencto_fixo_w		varchar(1);
ie_valor_fixo_w		varchar(1);

C01 CURSOR FOR
	SELECT	dt_licenca,
		nr_seq_mod_licenc,
		qt_licenca,
		vl_unitario,
		vl_total,
		nr_seq_canal,
		nr_seq_politica,
		dt_inicio_venc,
		vl_unit_manut,
		vl_manut_mensal,
		dt_inicio_venc_manut,
		cd_pessoa_fisica,
		vl_unit_distr,
		vl_distribuidor,
		ds_observacao,
		vl_original,
		vl_atual
	from	com_cli_neg_lic_item
	where	nr_seq_neg_lic = nr_sequencia_p;

C02 CURSOR FOR
	SELECT	ie_origem_valor,
		dt_vencimento,
		vl_parcela,
		ie_vencto_fixo,
		ie_valor_fixo
	from	com_cli_neg_lic_parc
	where	nr_seq_negoc_lic = nr_sequencia_p;


BEGIN

select	nextval('com_cli_neg_lic_seq')
into STRICT	nr_seq_neg_lic_w
;

insert into com_cli_neg_lic(
	nr_sequencia,
	nr_seq_cliente,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	dt_assinatura,
	ds_contato_cliente,
	ds_contato_financ,
	ds_setor_nf,
	nr_seq_contrato,
	ie_limitado,
	ie_com_fin)
(SELECT	nr_seq_neg_lic_w,
	nr_seq_cliente,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	dt_assinatura,
	ds_contato_cliente,
	ds_contato_financ,
	ds_setor_nf,
	nr_seq_contrato,
	ie_limitado,
	ie_com_fin
from	com_cli_neg_lic
where	nr_sequencia = nr_sequencia_p);

open C01;
loop
fetch C01 into
	dt_licenca_w,
	nr_seq_mod_licenc_w,
	qt_licenca_w,
	vl_unitario_w,
	vl_total_w,
	nr_seq_canal_w,
	nr_seq_politica_w,
	dt_inicio_venc_w,
	vl_unit_manut_w,
	vl_manut_mensal_w,
	dt_inicio_venc_manut_w,
	cd_pessoa_fisica_w,
	vl_unit_distr_w,
	vl_distribuidor_w,
	ds_observacao_w,
	vl_original_w,
	vl_atual_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into com_cli_neg_lic_item(
			nr_sequencia,
			nr_seq_neg_lic,
			dt_licenca,
			nr_seq_mod_licenc,
			qt_licenca,
			vl_unitario,
			vl_total,
			nr_seq_canal,
			nr_seq_politica,
			dt_inicio_venc,
			vl_unit_manut,
			vl_manut_mensal,
			dt_inicio_venc_manut,
			cd_pessoa_fisica,
			vl_unit_distr,
			vl_distribuidor,
			ds_observacao,
			vl_original,
			vl_atual,
			ie_anterior,
			dt_atualizacao,
			nm_usuario)
		values (nextval('com_cli_neg_lic_item_seq'),
			nr_seq_neg_lic_w,
			dt_licenca_w,
			nr_seq_mod_licenc_w,
			qt_licenca_w,
			vl_unitario_w,
			vl_total_w,
			nr_seq_canal_w,
			nr_seq_politica_w,
			dt_inicio_venc_w,
			vl_unit_manut_w,
			vl_manut_mensal_w,
			dt_inicio_venc_manut_w,
			cd_pessoa_fisica_w,
			vl_unit_distr_w,
			vl_distribuidor_w,
			ds_observacao_w,
			vl_original_w,
			vl_atual_w,
			'S',
			clock_timestamp(),
			nm_usuario_p);
	end;
end loop;
close C01;

/*Comentado po Elton em 06/08/2010, solicitado pelo Hermes na OS 238493 para que não sejam duplicados os parcelamentos ao duplicar o negócio.*/

/*open C02;
loop
fetch C02 into
	ie_origem_valor_w,
	dt_vencimento_w,
	vl_parcela_w,
	ie_vencto_fixo_w,
	ie_valor_fixo_w;
exit when C02%notfound;
	begin
	insert into com_cli_neg_lic_parc(
			nr_sequencia,
			nr_seq_negoc_lic,
			dt_atualizacao,
			nm_usuario,
			ie_origem_valor,
			dt_vencimento,
			vl_parcela,
			ie_vencto_fixo,
			ie_valor_fixo)
		values (com_cli_neg_lic_parc_seq.nextval,
			nr_seq_neg_lic_w,
			sysdate,
			nm_usuario_p,
			ie_origem_valor_w,
			dt_vencimento_w,
			vl_parcela_w,
			ie_vencto_fixo_w,
			ie_valor_fixo_w);
	end;
end loop;
close C02;*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_duplicar_negocio ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

