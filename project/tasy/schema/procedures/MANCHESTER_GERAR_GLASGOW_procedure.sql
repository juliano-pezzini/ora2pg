-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE manchester_gerar_glasgow ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_resposta_motora_p bigint, ie_resposta_verbal_p bigint, ie_abertura_ocular_p bigint, observacao_sepse_p text, cd_perfil_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w	bigint;
ds_erro_w		varchar(2000);
qt_glasgow_w	atend_escala_indice.qt_glasgow%type;

expressao1_w	varchar(255) := obter_desc_expressao_idioma(774225, null, wheb_usuario_pck.get_nr_seq_idioma);--Erro ao inserir Glasgow no manchester
										

BEGIN
begin
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	if (ie_resposta_motora_p = 0 or ie_resposta_verbal_p = 0 or ie_abertura_ocular_p = 0) then
		qt_glasgow_w := -1;
	else
		qt_glasgow_w := ie_resposta_motora_p + ie_resposta_verbal_p + ie_abertura_ocular_p;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	triagem_pronto_atend
	where	nr_atendimento = nr_atendimento_p;
	
	select nextval('atend_escala_indice_seq')
	into STRICT   nr_sequencia_p
	;

	insert into atend_escala_indice(nr_sequencia,
			nm_usuario,
			nm_usuario_nrec,
			cd_perfil_ativo,
			nr_atendimento,
			cd_pessoa_fisica,
			dt_avaliacao,
			dt_atualizacao,
			dt_liberacao,
			ie_resposta_motora,
			ie_resposta_verbal,
			ie_abertura_ocular,
			ie_classif_etaria,
			nr_hora,
			qt_glasgow,
			cd_setor_atendimento,
			nr_seq_triagem,
			ds_observacao,
			ie_situacao)
		values (nr_sequencia_p,
			nm_usuario_p,
			nm_usuario_p,
			cd_perfil_p,
			nr_atendimento_p,
			cd_pessoa_fisica_p,
			clock_timestamp(),
			clock_timestamp(),
			clock_timestamp(),
			ie_resposta_motora_p,
			ie_resposta_verbal_p,
			ie_abertura_ocular_p,
			'A',
			(to_char(clock_timestamp(),'hh24'))::numeric ,
			qt_glasgow_w,
			obter_setor_atendimento(nr_atendimento_p),
			nr_sequencia_w,
			observacao_sepse_p,
			'A');
			
			commit;

end if;

exception
when others then
	ds_erro_w := substr(sqlerrm(SQLSTATE),2000);

	CALL gravar_log_tasy(99995,
					substr(expressao1_w || ' = ' || ds_erro_w,1,2000),
					wheb_usuario_pck.get_nm_usuario);	
end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE manchester_gerar_glasgow ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_resposta_motora_p bigint, ie_resposta_verbal_p bigint, ie_abertura_ocular_p bigint, observacao_sepse_p text, cd_perfil_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

