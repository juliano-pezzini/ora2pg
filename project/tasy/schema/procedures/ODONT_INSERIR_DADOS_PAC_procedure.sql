-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE odont_inserir_dados_pac ( nr_atendimento_p bigint, qt_procedimento_p bigint, nr_seq_proc_interno_p bigint, ds_face_p text, cd_especialidade_p bigint, ds_observacao_p text, nr_dente_p bigint, ie_tratamento_p text, cd_profissional_p text, ie_liberar_p text, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_status_p text, cd_regiao_boca_p text default null) AS $body$
DECLARE


cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_sequencia_w		bigint;
				

BEGIN
if (coalesce(cd_pessoa_fisica_p::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(198414);
elsif (coalesce(cd_profissional_p::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(198415);
elsif (coalesce(qt_procedimento_p::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(198416);
elsif (coalesce(nr_seq_proc_interno_p::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(198417);	

end if;	


if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and
	((ie_tratamento_p IS NOT NULL AND ie_tratamento_p::text <> '') or  ((nr_dente_p IS NOT NULL AND nr_dente_p::text <> '') or (cd_regiao_boca_p IS NOT NULL AND cd_regiao_boca_p::text <> ''))) then

	select	cd_procedimento,
		ie_origem_proced
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w
	from	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;
	
	select	nextval('odont_procedimento_seq')
	into STRICT	nr_sequencia_w
	;	
	
	insert into odont_procedimento(	
		nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		qt_procedimento,
		nr_seq_proc_interno,
		ie_status,
		cd_profissional,
		dt_procedimento,
		nr_atendimento,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_face,
		cd_especialidade,
		cd_procedimento,
		ie_origem_proced,
		ds_observacao,
		nr_dente,
		ie_tratamento,
		cd_pessoa_fisica,
		cd_regiao_boca)
	values (	nr_sequencia_w,
		cd_estabelecimento_p,
		clock_timestamp(),
		nm_usuario_p,
		qt_procedimento_p,
		nr_seq_proc_interno_p,
		coalesce(ie_status_p,'P'),
		cd_profissional_p,
		clock_timestamp(),
		nr_atendimento_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_face_p,
		cd_especialidade_p,
		cd_procedimento_w,
		ie_origem_proced_w,
		ds_observacao_p,
		nr_dente_p,
		ie_tratamento_p,
		cd_pessoa_fisica_p,
		cd_regiao_boca_p);
	
	CALL odont_alterar_status(nr_sequencia_w,coalesce(ie_status_p,'P'),cd_pessoa_fisica_p,nr_atendimento_p,nm_usuario_p);
	
	if (ie_liberar_p = 'S') then
		CALL liberar_odont_procedimento(nr_sequencia_w,nm_usuario_p);
	end if;

end if;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE odont_inserir_dados_pac ( nr_atendimento_p bigint, qt_procedimento_p bigint, nr_seq_proc_interno_p bigint, ds_face_p text, cd_especialidade_p bigint, ds_observacao_p text, nr_dente_p bigint, ie_tratamento_p text, cd_profissional_p text, ie_liberar_p text, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_status_p text, cd_regiao_boca_p text default null) FROM PUBLIC;

