-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_res_nao_aceit_alert (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, cd_material_exame_p text, nr_seq_exame_result_p INOUT bigint, ds_resultado_p INOUT text) AS $body$
DECLARE



nr_seq_exame_w			bigint;
nr_seq_prescr_w			bigint;
nm_exame_w			varchar(80);
nr_seq_formato_w			bigint;
ie_formato_resultado_w		varchar(5);
ds_resultado_w			varchar(4000);
qt_resultado_w			double precision;
pr_resultado_w			double precision;
nr_seq_material_w			bigint;
ie_tipo_valor_w 			smallint;
qt_dias_w			double precision	:= 0;
qt_horas_w			bigint	:= 0;
ie_sexo_w			varchar(1);
possui_result_nao_aceit_w		varchar(1);
nr_seq_exame_result_w		bigint;
nr_seq_exame_result_ww		bigint;
ds_resultado_ww				varchar(255);
qt_casas_decimais_dias_w	bigint := 2;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT 	nr_seq_exame_p,
		nr_seq_prescr_p,
		b.nm_exame,
		obter_formato_exame(nr_seq_exame_p, c.nr_sequencia, null, 'L'),
		c.nr_sequencia
	from	material_exame_lab c,
		exame_laboratorio b
	where 	b.nr_seq_exame		= nr_seq_exame_p
	and 	c.cd_material_exame	= cd_material_exame_p
	order by 2;

C02 CURSOR FOR
	SELECT 	c.nm_exame,
		c.nr_seq_exame,
		obter_formato_result_exame(b.nr_seq_exame, b.nr_seq_material),
		ds_resultado,
		coalesce(qt_resultado,0),
		coalesce(pr_resultado,0)
	from	exame_laboratorio c,
		exame_lab_result_item b,
		exame_lab_resultado a
	where a.nr_seq_resultado	= b.nr_seq_resultado
	  and b.nr_seq_exame		= c.nr_seq_exame
	  and a.nr_prescricao		= nr_prescricao_p
	  and b.nr_seq_prescr		= nr_seq_prescr_w
	order by 2;


BEGIN
possui_result_nao_aceit_w	:= 'N';

select 	obter_dias_entre_datas_lab(obter_nascimento_prescricao(nr_prescricao_p),clock_timestamp()),
	Obter_Hora_Entre_datas(obter_nascimento_prescricao(nr_prescricao_p),clock_timestamp())
into STRICT 	qt_dias_w,
	qt_horas_w
;

select	coalesce(max(cd_estabelecimento),0)
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	CASE WHEN coalesce(max(ie_idade_int_val_ref), 'N')='N' THEN  2  ELSE 0 END
into STRICT	qt_casas_decimais_dias_w
from	lab_parametro
where	cd_estabelecimento = cd_estabelecimento_w;

open C01;
loop
	fetch C01 into	nr_seq_exame_w,
				nr_seq_prescr_w,
				nm_exame_w,
				nr_seq_formato_w,
				nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	open C02;
	loop
		fetch C02 into	nm_exame_w,
				nr_seq_exame_result_w,
				ie_formato_resultado_w,
				ds_resultado_w,
				qt_resultado_w,
				pr_resultado_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

		if (ie_formato_resultado_w = 'P') then
			begin
			select ie_tipo_valor
			into STRICT	 ie_tipo_valor_w
			from exame_lab_padrao
			where ((ie_sexo = coalesce(ie_sexo_w,'0')) or (ie_sexo = '0'))
			  and coalesce(ie_gera_alerta,'N') = 'S'
			  and nr_seq_exame = nr_seq_exame_result_w
			  and coalesce(nr_seq_material,nr_seq_material_w) = nr_seq_material_w
			  and (((coalesce(trunc((qt_dias_w / 365.25),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'A')) or
			  	 ((coalesce(trunc(((qt_dias_w / 365.25) * 12),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'M')) or
			  	 (((coalesce(qt_dias_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'D')) or
				 (((coalesce(qt_horas_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'H')))
			  and pr_resultado_w between qt_percent_min and qt_percent_max
			  and coalesce(ie_situacao,'A') = 'A'
			order by nr_seq_material, ie_sexo, ie_tipo_valor;
			exception
				when others then
					ie_tipo_valor_w := 0;
			end;


			if (ie_tipo_valor_w = 2) then
				CALL gravar_log_tasy(89,'1 -'||nr_prescricao_p||' - '||nr_seq_exame_result_w||' - '||pr_resultado_w,'teste');
				nr_seq_exame_result_ww := nr_seq_exame_result_w;
				ds_resultado_ww	:=	pr_resultado_w;
				possui_result_nao_aceit_w := 'S';
			end if;

		elsif (ie_formato_resultado_w = 'V') then
			begin
			select coalesce(max(ie_tipo_valor),0)
			into STRICT	 ie_tipo_valor_w
			from exame_lab_padrao
			where ((ie_sexo = coalesce(ie_sexo_w,'0')) or (ie_sexo = '0'))
			  and nr_seq_exame = nr_seq_exame_result_w
			  and coalesce(ie_gera_alerta,'N') = 'S'
			  and coalesce(nr_seq_material,nr_seq_material_w) = nr_seq_material_w
			  and (((coalesce(trunc((qt_dias_w / 365.25),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'A')) or
			  	 ((coalesce(trunc(((qt_dias_w / 365.25) * 12),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'M')) or
			  	 (((coalesce(qt_dias_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'D')) or
				 (((coalesce(qt_horas_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'H')))
			  and qt_resultado_w between qt_minima and qt_maxima
			  and coalesce(ie_situacao,'A') = 'A'
			order by nr_seq_material, ie_sexo, ie_tipo_valor;

			exception
				when others then

					ie_tipo_valor_w := 0;
			end;

			if (ie_tipo_valor_w = 2) then
				CALL gravar_log_tasy(89,'2 -'||nr_prescricao_p||' - '||nr_seq_exame_result_w||' - '||qt_resultado_w,'teste');
				nr_seq_exame_result_ww := nr_seq_exame_result_w;
				ds_resultado_ww	:=	qt_resultado_w;
				possui_result_nao_aceit_w := 'S';
			end if;

		elsif (
                  (ie_formato_resultado_w = 'D') or (ie_formato_resultado_w = 'SM') or (ie_formato_resultado_w = 'SDM') or (ie_formato_resultado_w = 'S') or (ie_formato_resultado_w = 'DV')) then
			begin
			select ie_tipo_valor
			into STRICT	 ie_tipo_valor_w
			from exame_lab_padrao
			where ((ie_sexo = coalesce(ie_sexo_w,'0')) or (ie_sexo = '0'))
			  and nr_seq_exame = nr_seq_exame_result_w
			  and coalesce(ie_gera_alerta,'N') = 'S'
			  and coalesce(nr_seq_material,nr_seq_material_w) = nr_seq_material_w
			  and (((coalesce(trunc((qt_dias_w / 365.25),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'A')) or
			  	 ((coalesce(trunc(((qt_dias_w / 365.25) * 12),qt_casas_decimais_dias_w),0) between qt_idade_min and qt_idade_max) and (ie_periodo = 'M')) or
			  	 (((coalesce(qt_dias_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'D')) or
				 (((coalesce(qt_horas_w,0)) between qt_idade_min and qt_idade_max) and (ie_periodo = 'H')))
			  and upper(ELIMINA_ACENTOS(ds_resultado_w)) like upper(ELIMINA_ACENTOS(DS_OBSERVACAO))
			  and coalesce(ie_situacao,'A') = 'A'
			order by nr_seq_material, ie_sexo;
			exception
				when others then
					ie_tipo_valor_w := 0;
			end;

			if (ie_tipo_valor_w = 2) then
				CALL gravar_log_tasy(89,'3 -'||nr_prescricao_p||' - '||nr_seq_exame_result_w||' - '||ds_resultado_w,'teste');
				nr_seq_exame_result_ww := nr_seq_exame_result_w;
				ds_resultado_ww	:=	ds_resultado_w;
				possui_result_nao_aceit_w := 'S';
			end if;
		end if;
	end loop;
	close C02;
end loop;
close C01;

--possui_result_nao_aceit_p := possui_result_nao_aceit_w;
nr_seq_exame_result_p := nr_seq_exame_result_ww;
ds_resultado_p	:= ds_resultado_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_res_nao_aceit_alert (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, cd_material_exame_p text, nr_seq_exame_result_p INOUT bigint, ds_resultado_p INOUT text) FROM PUBLIC;

