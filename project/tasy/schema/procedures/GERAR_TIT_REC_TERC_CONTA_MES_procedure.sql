-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_rec_terc_conta_mes (dt_mes_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conta_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


nr_sequencia_w			bigint;
ds_terceiros_liberados_w		varchar(4000) 	:= null;
ds_lista_terceiros_liberados_w		varchar(4000)	:= null;
ie_somente_terc_lib_w		varchar(255);
cd_condicao_pagamento_w		bigint;
dt_vencimento_w			timestamp;
nr_seq_terceiro_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_condicao_pagamento,
	a.dt_vencimento,
	a.nr_seq_terceiro
from	terceiro_conta a
where	trunc(dt_mesano_referencia, 'month')	= trunc(dt_mes_ref_p, 'month')
and	a.cd_estabelecimento		= cd_estabelecimento_p
and	a.ie_status_conta		= 'D'
and	a.nr_sequencia			= coalesce(nr_seq_conta_p, a.nr_sequencia)
and 	((ds_lista_terceiros_liberados_w like '% ' || a.nr_seq_terceiro || ' %') or coalesce(ds_terceiros_liberados_w::text, '') = '')
and	not exists (select	x.nr_seq_terc_conta
		from	titulo_receber x
	     	where	x.nr_seq_terc_conta = a.nr_sequencia
		and	x.ie_situacao	<> '3');


BEGIN

ie_somente_terc_lib_w := obter_param_usuario(907, 53, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_somente_terc_lib_w);
if (coalesce(ie_somente_terc_lib_w,'N') = 'S') then
	ds_terceiros_liberados_w := obter_param_usuario(907, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_terceiros_liberados_w);
	ds_lista_terceiros_liberados_w	:= ' ' || replace(ds_terceiros_liberados_w,',',' ') || ' ';
end if;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	cd_condicao_pagamento_w,
	dt_vencimento_w,
	nr_seq_terceiro_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (coalesce(cd_condicao_pagamento_w,0) > 0) or (trunc(dt_vencimento_w, 'dd') >= trunc(clock_timestamp(), 'dd')) then

		CALL GERAR_TIT_REC_TERC_CONTA(nr_sequencia_w, nm_usuario_p);

	elsif	(coalesce(length(ds_erro_p) + (length(substr(obter_nome_terceiro(nr_seq_terceiro_w),1,60) || '/' ||  nr_sequencia_w)),0) <= 255) then

		ds_erro_p := substr(ds_erro_p || substr(obter_nome_terceiro(nr_seq_terceiro_w),1,60) || '/' ||  nr_sequencia_w || chr(13),1,255);

	end if;
end loop;
close c01;
ds_erro_p := substr(ds_erro_p,1,255);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_rec_terc_conta_mes (dt_mes_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conta_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

