-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_registro_pac_gv ( nr_seq_vaga_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_tipo_atual_p text) AS $body$
DECLARE


			
			
ie_status_w		varchar(1);
ie_disponivel_w		varchar(2);
cd_setor_atendimento_w	integer;
cd_setor_atendimento_atual_w	integer;
cd_unidade_basica_w	varchar(20);
cd_unidade_compl_w	varchar(20);
cd_tipo_acomodacao_w	bigint;
cd_tipo_acomodacao_atual_w	bigint;
ie_altera_data_acomodacao_w	varchar(1);
cd_unid_basica_atual_w		gestao_vaga.cd_unid_basica_atual%type;
cd_unid_compl_atual_w		gestao_vaga.cd_unid_compl_atual%type;

/*
ie_tipo_atual_p

L - Atendimento tipo Internado - Leito livre - Vaga Reservada
A - Atendimento do tipo Internado - Leito Livre - Vaga Aguardando
*/
BEGIN

ie_altera_data_acomodacao_w := obter_param_usuario(1002, 138, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_data_acomodacao_w);

if (coalesce(nr_seq_vaga_p,0) > 0) then
	begin
	select 	max(ie_status),
		max(cd_setor_desejado),
		MAX(CD_TIPO_ACOMOD_DESEJ)
	into STRICT	ie_status_w,
		cd_setor_atendimento_w,
		cd_tipo_acomodacao_w
	from	gestao_vaga
	where	nr_sequencia	=	nr_seq_vaga_p;
	
	select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UB'),1,40)
	into STRICT 	cd_unid_basica_atual_w
	;
				
	select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UC'),1,40)
	into STRICT 	cd_unid_compl_atual_w
	;
	
	
	select max(cd_setor_atendimento),
			max(cd_tipo_acomodacao)
	into STRICT	cd_setor_atendimento_atual_w,
			cd_tipo_acomodacao_atual_w
	from	atend_paciente_unidade
	where	nr_atendimento = nr_atendimento_p;
	
	if (ie_status_w = 'R') and (ie_tipo_atual_p = 'L') then
		begin	
		update	gestao_vaga
		set	nr_atendimento	=	nr_atendimento_p,
			dt_atualizacao	=	clock_timestamp(),
			nm_usuario	=	nm_usuario_p,
			ie_status	=	'F',
			dt_acomodacao 	= CASE WHEN ie_altera_data_acomodacao_w='S' THEN clock_timestamp()  ELSE dt_acomodacao END ,
			cd_setor_atual  = 	coalesce(cd_setor_atendimento_atual_w, cd_setor_atendimento_w),
			CD_TIPO_ACOMOD_ATUAL	=	coalesce(cd_tipo_acomodacao_atual_w, cd_tipo_acomodacao_w)	
		where	nr_sequencia	=	nr_seq_vaga_p;
		end;
	
	elsif (ie_status_w = 'A') and (ie_tipo_atual_p = 'A') then
		begin
		update	gestao_vaga
		set	nr_atendimento	=	nr_atendimento_p,
			dt_atualizacao	=	clock_timestamp(),
			nm_usuario	=	nm_usuario_p,
			cd_setor_atual  = 	coalesce(cd_setor_atendimento_atual_w, cd_setor_atendimento_w),
			CD_TIPO_ACOMOD_ATUAL	=	coalesce(cd_tipo_acomodacao_atual_w, cd_tipo_acomodacao_w),
			cd_unid_basica_atual	=   cd_unid_basica_atual_w,
			cd_unid_compl_atual		=	cd_unid_compl_atual_w
		where	nr_sequencia	=	nr_seq_vaga_p
		and	coalesce(nr_atendimento::text, '') = '';	
		end;
	end if;
/*
		
		end;
	elsif	(ie_status_w = 'A') then
		begin
		update	gestao_vaga
		set	nr_atendimento	=	nr_atendimento_p,
			dt_atualizacao	=	sysdate,
			nm_usuario	=	nm_usuario_p,
			cd_setor_atual  = 	obter_setor_atendimento(nr_atendimento_p)
		where	nr_sequencia	=	nr_seq_vaga_p;		
		end;		
	end if;
	*/
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_registro_pac_gv ( nr_seq_vaga_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_tipo_atual_p text) FROM PUBLIC;

