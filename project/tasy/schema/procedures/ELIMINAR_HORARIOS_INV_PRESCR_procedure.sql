-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eliminar_horarios_inv_prescr (cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, ie_laboratorio_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ds_lista_eliminados_p INOUT text) AS $body$
DECLARE


ds_lista_eliminados_w	varchar(255);
nr_seq_horario_w		bigint;
dt_horario_chr_w		varchar(20);
dt_validade_prescr_w	timestamp;
ie_data_proc_w		varchar(15);
ie_data_lib_prescr_w	varchar(15);
ie_exibe_suspenso_w	varchar(15);
ie_status_lote_w	varchar(15);
cd_setor_pac_w		integer;
qt_existe_w		bigint;
nr_seq_lote_w		bigint;
nr_seq_processo_w	bigint;
nr_seq_material_w	bigint;
dt_horario_w		timestamp;
cd_dieta_w	prescr_dieta.cd_dieta%type;

c01 CURSOR FOR
SELECT	c.nr_sequencia nr_seq_hor, /* dietas orais */
	c.dt_horario
from	prescr_dieta_hor c,
	prescr_dieta b,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and	c.nr_seq_dieta = b.nr_Sequencia
and	a.nr_prescricao = b.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
--and	nvl(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	((c.cd_refeicao = cd_item_p) or (b.cd_dieta = cd_dieta_w))
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_dieta_cpoe, 'N')))
and	ie_tipo_item_p = 'D'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* suplementos orais */
	c.dt_horario
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (12)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_dieta_cpoe, 'N')))
and	ie_tipo_item_p = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor,
	c.dt_horario
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (16)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_dieta_cpoe, 'N')))
and	ie_tipo_item_p = 'LD'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* medicamentos */
	c.dt_horario
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (1)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_mat_cpoe, 'M')))
and	ie_tipo_item_p in ('M', 'IAH')
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* materiais */
	c.dt_horario
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (2)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_mat_cpoe, 'M')))
and	ie_tipo_item_p = 'MAT'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* procedimentos e controles de glicemia */
	c.dt_horario
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S'))
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.cd_procedimento = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')))
and	ie_tipo_item_p in ('P','G','C')
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* recomendações */
	c.dt_horario
from	prescr_rec_hor c,
	prescr_recomendacao b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_recomendacao = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_prescricao = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario >= dt_validade_prescr_w) or (c.dt_horario >= cpoe_obter_termino_item(b.nr_seq_rec_cpoe, 'R')))
and	ie_tipo_item_p = 'R'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	c.nr_sequencia nr_seq_hor, /* sae */
	c.dt_horario
from	pe_prescr_proc_hor c,
	pe_prescr_proc b,
	pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.ie_adep,'N') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_horario_especial,'N') = 'N'
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''
and	a.nr_atendimento = nr_atendimento_p
and	a.nr_sequencia = nr_prescricao_p
and	a.dt_validade_prescr > clock_timestamp()
and	b.nr_sequencia = nr_seq_item_p
and	b.nr_seq_proc = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	c.dt_horario >= dt_validade_prescr_w
and	ie_tipo_item_p = 'E'
order by
	1;


BEGIN


ie_data_proc_w := obter_param_usuario(924, 223, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_proc_w);
ie_data_lib_prescr_w := obter_param_usuario(1113, 115, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_lib_prescr_w);
ie_exibe_suspenso_w := obter_param_usuario(1113, 117, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exibe_suspenso_w);
cd_setor_pac_w		:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	/* atualizar lista eliminados */

	ds_lista_eliminados_w := ds_lista_eliminados_p;

	/* obter validade prescrição */

	if (ie_tipo_item_p <> 'E') then
		select	dt_validade_prescr
		into STRICT	dt_validade_prescr_w
		from	prescr_medica
		where 	nr_prescricao = nr_prescricao_p;
	else
		select	dt_validade_prescr
		into STRICT	dt_validade_prescr_w
		from	pe_prescricao
		where	nr_sequencia = nr_prescricao_p
		and	coalesce(ie_situacao,'A') = 'A';
	end if;

	begin
		cd_dieta_w := (cd_item_p)::numeric;
	exception when others then
		cd_dieta_w := 0;
	end;
	/* eliminar horários */

	open c01;
	loop
	fetch c01 into	nr_seq_horario_w,
				dt_horario_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_tipo_item_p = 'D') then /* dietas orais*/
			update	prescr_dieta_hor
			set	ie_situacao = 'I'
			where	nr_sequencia = nr_seq_horario_w;

			dt_horario_chr_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w,'short', cd_estabelecimento_p, nm_usuario_p);

			/* inserir horário lista */

			if (coalesce(ds_lista_eliminados_w::text, '') = '') then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			elsif (coalesce(length(ds_lista_eliminados_w),0) <= 240) and (position(dt_horario_chr_w in ds_lista_eliminados_w) = 0) then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			end if;

		elsif (ie_tipo_item_p in ('S','M', 'IAH', 'MAT', 'LD')) then /* suplementos orais e medicamentos */
			update	prescr_mat_hor
			set	ie_situacao = 'I'
			where	nr_sequencia = nr_seq_horario_w;

			select	max(nr_seq_material)
			into STRICT	nr_seq_material_w
			from	prescr_mat_hor
			where	nr_sequencia	= nr_seq_horario_w;

			update	prescr_mat_hor
			set	ie_situacao = 'I'
			where	nr_seq_superior	= nr_seq_material_w
			and	dt_horario		= dt_horario_w
			and	nr_prescricao	= nr_prescricao_p;

			dt_horario_chr_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w,'short', cd_estabelecimento_p, nm_usuario_p);

			/* inserir horário lista */

			if (coalesce(ds_lista_eliminados_w::text, '') = '') then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			elsif (coalesce(length(ds_lista_eliminados_w),0) <= 240) and (position(dt_horario_chr_w in ds_lista_eliminados_w) = 0) then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			end if;

		elsif (ie_tipo_item_p in ('P','G','C')) then /* procedimentos e controles de glicemia */
			update	prescr_proc_hor
			set	ie_situacao = 'I'
			where	nr_sequencia = nr_seq_horario_w;

			dt_horario_chr_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w,'short', cd_estabelecimento_p, nm_usuario_p);

			/* inserir horário lista */

			if (coalesce(ds_lista_eliminados_w::text, '') = '') then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			elsif (coalesce(length(ds_lista_eliminados_w),0) <= 240) and (position(dt_horario_chr_w in ds_lista_eliminados_w) = 0) then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			end if;

		elsif (ie_tipo_item_p = 'R') then /* recomendações */
			update	prescr_rec_hor
			set	ie_situacao = 'I'
			where	nr_sequencia = nr_seq_horario_w;

			dt_horario_chr_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w,'short', cd_estabelecimento_p, nm_usuario_p);

			/* inserir horário lista */

			if (coalesce(ds_lista_eliminados_w::text, '') = '') then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			elsif (coalesce(length(ds_lista_eliminados_w),0) <= 240) and (position(dt_horario_chr_w in ds_lista_eliminados_w) = 0) then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			end if;

		elsif (ie_tipo_item_p = 'E') then /* sae */
			update	pe_prescr_proc_hor
			set	ie_situacao = 'I'
			where	nr_sequencia = nr_seq_horario_w;

			dt_horario_chr_w	:= PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w,'short', cd_estabelecimento_p, nm_usuario_p);

			/* inserir horário lista */

			if (coalesce(ds_lista_eliminados_w::text, '') = '') then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			elsif (coalesce(length(ds_lista_eliminados_w),0) <= 240) and (position(dt_horario_chr_w in ds_lista_eliminados_w) = 0) then
				ds_lista_eliminados_w := ds_lista_eliminados_w || dt_horario_chr_w || ',';
			end if;
		end if;
		end;
	end loop;
	close c01;
end if;

ds_lista_eliminados_p := substr(ds_lista_eliminados_w,1,length(ds_lista_eliminados_w)-1);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliminar_horarios_inv_prescr (cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, ie_laboratorio_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ds_lista_eliminados_p INOUT text) FROM PUBLIC;

