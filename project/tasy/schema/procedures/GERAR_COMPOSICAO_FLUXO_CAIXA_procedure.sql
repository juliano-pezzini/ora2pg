-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_composicao_fluxo_caixa (nr_seq_regra_p bigint, dt_referencia_p timestamp, cd_estabelecimento_p bigint, ie_restringe_estab_p text, nm_usuario_p text, ie_periodo_p text default null, cd_moeda_p bigint default null) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/


/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */


/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */


/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */


/* existam diferenças entre os fluxos de caixa.                                                                                                                */


/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

dt_referencia_w		timestamp;
dt_ref_atual_w		timestamp;
dt_inicio_dia_w		timestamp;
dt_inicio_mes_w		timestamp;
cd_empresa_w		estabelecimento.cd_empresa%type;
nr_ordem_apres_w	composicao_fluxo_caixa.nr_ordem_apres%type;
nr_ordem_apres_grupo_w	composicao_fluxo_caixa.nr_ordem_apres%type;
vl_total_w		composicao_fluxo_caixa.vl_composicao%type;
ie_gravar_total_w	varchar(1);
ie_fechamento_diario_w	varchar(1);

ds_grupo_w		regra_comp_grupo.ds_grupo%type;
nr_seq_grupo_w		regra_comp_grupo.nr_sequencia%type;
ie_banco_w		varchar(1);
ie_caixa_w		varchar(1);
ie_cartao_w		varchar(1);
ie_nenhuma_w		varchar(1);
vl_total_grupo_w	composicao_fluxo_caixa.vl_composicao%type;
ie_gravar_grupo_w	varchar(1);
ie_operacao_w		regra_comp_grupo.ie_operacao%type;

ds_caixa_w		caixa.ds_caixa%type;
nr_seq_caixa_w		caixa.nr_sequencia%type;
nr_ordem_apres_caixa_w	composicao_fluxo_caixa.nr_ordem_apres%type;
vl_total_caixa_w	composicao_fluxo_caixa.vl_composicao%type;
ie_gravar_caixa_w	varchar(1);

ds_bandeira_w		bandeira_cartao_cr.ds_bandeira%type;
nr_seq_bandeira_w	bandeira_cartao_cr.nr_sequencia%type;
nr_ordem_apres_band_w	composicao_fluxo_caixa.nr_ordem_apres%type;
vl_total_bandeira_w	composicao_fluxo_caixa.vl_composicao%type;
ie_gravar_bandeira_w	varchar(1);

ds_banco_w		banco.ds_banco%type;
cd_banco_w		banco.cd_banco%type;
nr_ordem_apres_banco_w	composicao_fluxo_caixa.nr_ordem_apres%type;
vl_total_banco_w	composicao_fluxo_caixa.vl_composicao%type;
ie_gravar_banco_w	varchar(1);

ds_conta_w		banco_estabelecimento_v.ds_conta%type;
nr_seq_conta_banco_w	banco_estabelecimento_v.nr_sequencia%type;

ie_identificacao_w	composicao_fluxo_caixa_v.ie_identificacao%type;
ds_titulo_w		composicao_fluxo_caixa_v.ds_titulo%type;
vl_item_w		composicao_fluxo_caixa.vl_composicao%type;
vl_especie_w		caixa_receb.vl_especie%type;
dt_fechamento_w		timestamp;
ie_origem_valor_w	regra_comp_item.ie_origem_valor%type;
/* Projeto Multimoeda - Variáveis */

cd_moeda_empresa_w	integer;
cd_moeda_estrang_w	integer;
vl_item_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_tot_caixa_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_composicao_w		composicao_fluxo_caixa.vl_composicao%type;
vl_tot_band_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_tot_grupo_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_tot_banco_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_total_estrang_w	composicao_fluxo_caixa.vl_composicao%type;
vl_especie_estrang_w	caixa_receb_estrang.vl_especie_estrang%type;

/* Grupos */

c01 CURSOR FOR
SELECT	a.ds_grupo,
	a.nr_sequencia,
	a.ie_operacao
from	regra_comp_grupo a
where	a.nr_seq_regra	= nr_seq_regra_p
order by	a.nr_sequencia;

/* Caixas */

c02 CURSOR FOR
SELECT	a.ds_caixa,
	a.nr_sequencia
from	caixa a
where	a.ie_fluxo		= 'S'
and	coalesce(a.ie_situacao,'A')	= 'A'
order by	a.ds_caixa;

/* Itens do caixa */

c03 CURSOR FOR
SELECT	distinct
	b.ie_identificacao,
	b.ds_titulo
from	composicao_fluxo_caixa_v b,
	regra_comp_item a
where	a.ie_identificacao	= b.ie_identificacao
and	coalesce(a.ie_origem_valor,'N')	= 'C'
and	a.nr_seq_grupo		= nr_seq_grupo_w
order by	b.ds_titulo;

/* Bandeiras de cartão */

c04 CURSOR FOR
SELECT	a.ds_bandeira,
	a.nr_sequencia
from	bandeira_cartao_cr a
where	coalesce(a.ie_situacao,'A')	= 'A'
order by	a.ds_bandeira;

/* Itens da bandeira */

c05 CURSOR FOR
SELECT	distinct
	b.ie_identificacao,
	b.ds_titulo
from	composicao_fluxo_caixa_v b,
	regra_comp_item a
where	a.ie_identificacao	= b.ie_identificacao
and	a.ie_identificacao	in ('5','6','21')
and	coalesce(a.ie_origem_valor,'N')	= ie_origem_valor_w
and	a.nr_seq_grupo		= nr_seq_grupo_w
order by	b.ds_titulo;

/* Bancos */

c06 CURSOR FOR
SELECT	a.ds_banco,
	a.cd_banco
from	banco a
where	coalesce(a.ie_situacao,'A')	= 'A'
order by	a.ds_banco;

/* Itens do banco */

c07 CURSOR FOR
SELECT	distinct
	b.ie_identificacao,
	b.ds_titulo
from	composicao_fluxo_caixa_v b,
	regra_comp_item a
where	a.ie_identificacao	= b.ie_identificacao
and	coalesce(a.ie_origem_valor,'N')	= 'B'
and	a.nr_seq_grupo		= nr_seq_grupo_w
order by	b.ds_titulo;

c08 CURSOR FOR
SELECT	a.ds_conta,
	a.nr_sequencia
from	banco_estabelecimento_v a
where	coalesce(a.ie_situacao,'A')	= 'A'
and	a.cd_banco		= cd_banco_w
order by	a.ds_conta;

/* Outros itens */

c09 CURSOR FOR
SELECT	distinct
	b.ie_identificacao,
	b.ds_titulo
from	composicao_fluxo_caixa_v b,
	regra_comp_item a
where	a.ie_identificacao	= b.ie_identificacao
and	coalesce(a.ie_origem_valor,'N')	= 'N'
and	a.nr_seq_grupo		= nr_seq_grupo_w
order by	b.ds_titulo;


BEGIN

delete	from composicao_fluxo_caixa
where	nm_usuario	= nm_usuario_p
and	nr_seq_regra	= nr_seq_regra_p;

if (coalesce(ie_periodo_p,'D')	= 'M') then

	dt_referencia_w	:= fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_referencia_p,-1,0));
	dt_ref_atual_w	:= fim_mes(dt_referencia_p);

else

	dt_referencia_w	:= fim_dia(dt_referencia_p - 1);
	dt_ref_atual_w	:= fim_dia(dt_referencia_p);

end if;

dt_inicio_dia_w		:= PKG_DATE_UTILS.start_of(dt_referencia_w,'dd', 0);
dt_inicio_mes_w		:= PKG_DATE_UTILS.start_of(dt_referencia_w,'month', 0);
nr_ordem_apres_w	:= 0;
ie_gravar_total_w	:= 'N';

select	max(a.cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento a
where	a.cd_estabelecimento	= cd_estabelecimento_p;
/* Projeto Multimoeda - Busca a moeda padrão da empresa e verifica o parâmetro cd_moeda passado na procedure. Ele será a base da busca dos dados
		em moeda estrangeira. Caso o parâmetro seja nulo, deverá ser considerada a moeda padrão da empresa nas consultas,
		caso contrário irá buscar somente os dados na moeda selecionada.*/
select obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT cd_moeda_empresa_w
;
if (coalesce(cd_moeda_p::text, '') = '') then
	cd_moeda_estrang_w := cd_moeda_empresa_w;
else
	cd_moeda_estrang_w := cd_moeda_p;
end if;

ie_fechamento_diario_w := Obter_Param_Usuario(830, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_fechamento_diario_w);

open	c01;
loop
fetch	c01 into
	ds_grupo_w,
	nr_seq_grupo_w,
	ie_operacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ie_gravar_grupo_w	:= 'N';
	vl_total_grupo_w	:= 0;
	vl_tot_grupo_estrang_w	:= 0;
	nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
	nr_ordem_apres_grupo_w	:= nr_ordem_apres_w;

	/* Conferir se existem itens relacionados à caixa, bancos ou cartão */

	select	CASE WHEN max(ie_banco)=1 THEN 'S'  ELSE 'N' END  ie_banco,
		CASE WHEN max(ie_caixa)=1 THEN 'S'  ELSE 'N' END  ie_caixa,
		CASE WHEN max(ie_nenhuma)=1 THEN 'S'  ELSE 'N' END  ie_nenhuma
	into STRICT	ie_banco_w,
		ie_caixa_w,
		ie_nenhuma_w
	from (SELECT	CASE WHEN a.ie_origem_valor='B' THEN 1  ELSE 0 END  ie_banco,
			CASE WHEN a.ie_origem_valor='C' THEN 1  ELSE 0 END  ie_caixa,
			CASE WHEN coalesce(a.ie_origem_valor,'N')='N' THEN 1  ELSE 0 END  ie_nenhuma
		from	regra_comp_item a
		where	a.nr_seq_grupo	= nr_seq_grupo_w) alias4;

	/* Percorrer os caixas */

	if (coalesce(ie_caixa_w,'N')	= 'S') then

		open	c02;
		loop
		fetch	c02 into
			ds_caixa_w,
			nr_seq_caixa_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			ie_origem_valor_w	:= 'C';
			ie_cartao_w		:= 'N';
			ie_gravar_caixa_w	:= 'N';
			vl_total_caixa_w	:= 0;
			vl_tot_caixa_estrang_w	:= 0;
			nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
			nr_ordem_apres_caixa_w	:= nr_ordem_apres_w;

			open	c03;
			loop
			fetch	c03 into
				ie_identificacao_w,
				ds_titulo_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */

				/* Valor do saldo à vista do caixa */

				if (ie_identificacao_w	= '4') then

					select	sum(vl_saldo_avista),
						sum(vl_saldo_vista_estr)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	(SELECT	coalesce(sum(a.vl_saldo_avista),0) vl_saldo_avista,
							0 vl_saldo_vista_estr
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w
						
union all

						SELECT	0 vl_saldo_avista,
							coalesce(sum(e.vl_saldo_avista),0) vl_saldo_vista_estr
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a,
							caixa_saldo_estrang e
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	e.nr_seq_caixa_saldo	= a.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w) alias20;

					if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Recebimentos em espécie */

				elsif (ie_identificacao_w	= '1') then

					select	sum(vl_especie),
						sum(vl_especie_estrang)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from (SELECT	coalesce(sum(a.vl_especie),0) vl_especie,
							0 vl_especie_estrang
						from	estabelecimento e,
							caixa d,
							caixa_saldo_diario c,
							caixa_receb a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
						and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	e.cd_empresa		= cd_empresa_w
						and	d.ie_fluxo		= 'S'
						and	d.ie_situacao		= 'A'
						and	d.cd_estabelecimento	= e.cd_estabelecimento
						and	d.nr_sequencia		= nr_seq_caixa_w
						and	c.nr_seq_caixa		= d.nr_sequencia
						and	a.nr_seq_saldo_caixa	= c.nr_sequencia
						and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_recebimento	< dt_referencia_w
						
union all

						SELECT	0 vl_especie,
							coalesce(sum(b.vl_especie_estrang),0) vl_especie_estrang
						from	estabelecimento e,
							caixa d,
							caixa_saldo_diario c,
							caixa_receb a,
							caixa_receb_estrang b
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
						and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	e.cd_empresa		= cd_empresa_w
						and	d.ie_fluxo		= 'S'
						and	d.ie_situacao		= 'A'
						and	d.cd_estabelecimento	= e.cd_estabelecimento
						and	b.nr_seq_caixa_receb	= a.nr_sequencia
						and	d.nr_sequencia		= nr_seq_caixa_w
						and	c.nr_seq_caixa		= d.nr_sequencia
						and	a.nr_seq_saldo_caixa	= c.nr_sequencia
						and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
						and	coalesce(b.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_recebimento	< dt_referencia_w) alias18;

					if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Recebimentos em cheque à vista */

				elsif (ie_identificacao_w	= '7') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						cheque_cr f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'S') or
						f.ie_forma_pagto = 'AV')
					and	a.nr_seq_cheque		= f.nr_seq_cheque
					and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Recebimentos em cheque pré */

				elsif (ie_identificacao_w	= '8') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						cheque_cr f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'N') or
						f.ie_forma_pagto = 'PD')
					and	a.nr_seq_cheque		= f.nr_seq_cheque
					and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque à vista */

				elsif (ie_identificacao_w	= '9') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	PKG_DATE_UTILS.start_of(coalesce(f.dt_emissao,clock_timestamp()),'dd', 0)	= PKG_DATE_UTILS.start_of(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd', 0)
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque pré */

				elsif (ie_identificacao_w	= '10') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	PKG_DATE_UTILS.start_of(coalesce(f.dt_emissao,clock_timestamp()),'dd', 0)	<> PKG_DATE_UTILS.start_of(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd', 0)
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Valor de outras entradas no caixa */

				elsif (ie_identificacao_w	= '12') then

					select	sum(vl_especie),
						sum(vl_especie_estrang)
					into STRICT	vl_especie_w,
						vl_especie_estrang_w
					from (SELECT	coalesce(sum(a.vl_especie),0) vl_especie,
							0 vl_especie_estrang
						from	estabelecimento e,
							caixa d,
							caixa_saldo_diario c,
							caixa_receb a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
						and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	e.cd_empresa		= cd_empresa_w
						and	d.ie_fluxo		= 'S'
						and	d.ie_situacao		= 'A'
						and	d.cd_estabelecimento	= e.cd_estabelecimento
						and	d.nr_sequencia		= nr_seq_caixa_w
						and	c.nr_seq_caixa		= d.nr_sequencia
						and	a.nr_seq_saldo_caixa	= c.nr_sequencia
						and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_recebimento	< dt_referencia_w
						
union all

						SELECT	0 vl_especie,
							coalesce(sum(b.vl_especie_estrang),0) vl_especie_estrang
						from	estabelecimento e,
							caixa d,
							caixa_saldo_diario c,
							caixa_receb a,
							caixa_receb_estrang b
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
						and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	e.cd_empresa		= cd_empresa_w
						and	d.ie_fluxo		= 'S'
						and	d.ie_situacao		= 'A'
						and	d.cd_estabelecimento	= e.cd_estabelecimento
						and	b.nr_seq_caixa_receb	= a.nr_sequencia
						and	d.nr_sequencia		= nr_seq_caixa_w
						and	c.nr_seq_caixa		= d.nr_sequencia
						and	a.nr_seq_saldo_caixa	= c.nr_sequencia
						and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
						and	coalesce(b.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_recebimento	< dt_referencia_w) alias18;

					select	coalesce(sum(a.vl_transacao),0) - coalesce(vl_especie_w,0),
						coalesce(sum(a.vl_transacao_estrang),0) - coalesce(vl_especie_estrang_w,0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	= 'E'
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
					and	coalesce(a.nr_seq_cheque::text, '') = ''
					and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Valor de outras saídas no caixa */

				elsif (ie_identificacao_w	= '13') then

					select	coalesce(sum(a.vl_transacao),0) * -1,
						coalesce(sum(a.vl_transacao_estrang),0) * -1
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	= 'S'
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
					and	coalesce(a.nr_seq_cheque::text, '') = ''
					and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque */

				elsif (ie_identificacao_w	= '19') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.nr_sequencia		= nr_seq_caixa_w
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.ie_caixa		in ('D', 'T', 'A')
					and	b.ie_saldo_caixa	in ('S','E')
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Saldo em espécie no caixa */

				elsif (ie_identificacao_w	= '22') then

					select	sum(vl_saldo_avista),
						sum(vl_saldo_vista_estrang)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	(SELECT	coalesce(sum(a.vl_especie_atual),0) vl_saldo_avista,
							0 vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w
						
union all

						SELECT	0 vl_saldo_avista,
							coalesce(sum(e.vl_especie_atual),0) vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a,
							caixa_saldo_estrang e
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	e.nr_seq_caixa_saldo	= a.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w) alias20;

					if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Saldo em cartão no caixa */

				elsif (ie_identificacao_w	= '23') then

					select	coalesce(sum(a.vl_cartao_cr_atual),0) vl_saldo_avista
					into STRICT	vl_item_w
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(SELECT	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					and	a.nr_seq_caixa		= nr_seq_caixa_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_item_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;


				/* Saldo em cheque à vista no caixa */

				elsif (ie_identificacao_w	= '24') then

					select	sum(vl_saldo_avista),
						sum(vl_saldo_vista_estrang)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	(SELECT	coalesce(sum(a.vl_cheque_vista_atual),0) vl_saldo_avista,
							0 vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w
						
union all

						SELECT	0 vl_saldo_avista,
							coalesce(sum(e.vl_cheque_vista_atual),0) vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a,
							caixa_saldo_estrang e
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	e.nr_seq_caixa_saldo	= a.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w) alias20;

					if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Saldo em cheque pré no caixa */

				elsif (ie_identificacao_w	= '25') then

					select	sum(vl_saldo_avista),
						sum(vl_saldo_vista_estrang)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	(SELECT	coalesce(sum(a.vl_cheque_pre_atual),0) vl_saldo_avista,
							0 vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w
						
union all

						SELECT	coalesce(sum(a.vl_cheque_pre_atual),0) vl_saldo_avista,
							0 vl_saldo_vista_estrang
						from	estabelecimento c,
							caixa b,
							caixa_saldo_diario a,
							caixa_saldo_estrang e
						where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
						and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	b.cd_estabelecimento	= c.cd_estabelecimento
						and	a.nr_seq_caixa		= b.nr_sequencia
						and	e.nr_seq_caixa_saldo	= a.nr_sequencia
						and	b.ie_situacao		= 'A'
						and	b.ie_fluxo 		= 'S'
						and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	a.dt_saldo		=
							(select	max(dt_saldo)
							from	caixa_saldo_diario x
							where	x.nr_seq_caixa	= a.nr_seq_caixa
							and	x.dt_saldo	<= dt_referencia_w)
						and	a.nr_seq_caixa		= nr_seq_caixa_w) alias20;

					if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

						ie_gravar_caixa_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										cd_moeda_empresa_w);

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Recebimentos em cartão de crédito | Recebimentos em cartão de débito */

				elsif (ie_identificacao_w	in ('5','6','21')) then

					ie_cartao_w	:= 'S';

				end if;

			end	loop;
			close	c03;

			/* Percorrer as bandeiras de cartão */

			if (coalesce(ie_cartao_w,'N')	= 'S') then

				open	c04;
				loop
				fetch	c04 into
					ds_bandeira_w,
					nr_seq_bandeira_w;
				EXIT WHEN NOT FOUND; /* apply on c04 */

					ie_gravar_bandeira_w	:= 'N';
					vl_total_bandeira_w	:= 0;
					vl_tot_band_estrang_w	:= 0;
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					nr_ordem_apres_band_w	:= nr_ordem_apres_w;

					open	c05;
					loop
					fetch	c05 into
						ie_identificacao_w,
						ds_titulo_w;
					EXIT WHEN NOT FOUND; /* apply on c05 */

						/* Recebimentos em cartão de crédito */

						if (ie_identificacao_w	= '5') then

							select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
								coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
							into STRICT	vl_item_w,
								vl_item_estrang_w
							from	estabelecimento e,
								caixa d,
								caixa_saldo_diario c,
								transacao_financeira b,
								movto_cartao_cr f,
								movto_trans_financ a
							where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
							and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
							and	e.cd_empresa		= cd_empresa_w
							and	d.ie_fluxo		= 'S'
							and	d.ie_situacao		= 'A'
							and	d.cd_estabelecimento	= e.cd_estabelecimento
							and	d.nr_sequencia		= nr_seq_caixa_w
							and	c.nr_seq_caixa		= d.nr_sequencia
							and	a.nr_seq_saldo_caixa	= c.nr_sequencia
							and	b.ie_caixa		in ('D', 'T', 'A')
							and	b.ie_saldo_caixa	in ('S','E')
							and	a.nr_seq_trans_financ	= b.nr_sequencia
							and	coalesce(f.ie_tipo_cartao,'C')	= 'C'
							and	f.nr_seq_bandeira	= nr_seq_bandeira_w
							and	a.nr_seq_movto_cartao	= f.nr_sequencia
							and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
							and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
							and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
							and	a.dt_transacao		< dt_referencia_w;

							if (coalesce(vl_item_w,0)	<> 0) then

								ie_gravar_bandeira_w	:= 'S';
								nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
								vl_composicao_w	:= vl_item_w;
								/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

								if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
									vl_composicao_w	:= vl_item_estrang_w;
									vl_tot_band_estrang_w := coalesce(vl_tot_band_estrang_w,0) + coalesce(vl_item_estrang_w,0);
								end if;

								CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
												'                  (+) ' || WHEB_MENSAGEM_PCK.get_texto(810609),
												vl_composicao_w,
												nr_ordem_apres_w,
												nm_usuario_p,
												'N',
												coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

								vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

							end if;

						/* Recebimentos em cartão de débito */

						elsif (ie_identificacao_w	= '6') then

							select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
								coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
							into STRICT	vl_item_w,
								vl_item_estrang_w
							from	estabelecimento e,
								caixa d,
								caixa_saldo_diario c,
								transacao_financeira b,
								movto_cartao_cr f,
								movto_trans_financ a
							where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
							and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
							and	e.cd_empresa		= cd_empresa_w
							and	d.ie_fluxo		= 'S'
							and	d.ie_situacao		= 'A'
							and	d.cd_estabelecimento	= e.cd_estabelecimento
							and	d.nr_sequencia		= nr_seq_caixa_w
							and	c.nr_seq_caixa		= d.nr_sequencia
							and	a.nr_seq_saldo_caixa	= c.nr_sequencia
							and	b.ie_caixa		in ('D', 'T', 'A')
							and	b.ie_saldo_caixa	in ('S','E')
							and	a.nr_seq_trans_financ	= b.nr_sequencia
							and	coalesce(f.ie_tipo_cartao,'C')	= 'D'
							and	f.nr_seq_bandeira	= nr_seq_bandeira_w
							and	a.nr_seq_movto_cartao	= f.nr_sequencia
							and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
							and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
							and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
							and	a.dt_transacao		< dt_referencia_w;

							if (coalesce(vl_item_w,0)	<> 0) then

								ie_gravar_bandeira_w	:= 'S';
								nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
								vl_composicao_w	:= vl_item_w;
								/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

								if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
									vl_composicao_w	:= vl_item_estrang_w;
									vl_tot_band_estrang_w := coalesce(vl_tot_band_estrang_w,0) + coalesce(vl_item_estrang_w,0);
								end if;

								CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
												'                  (+) ' || WHEB_MENSAGEM_PCK.get_texto(810608),
												vl_composicao_w,
												nr_ordem_apres_w,
												nm_usuario_p,
												'N',
												coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

								vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

							end if;

						end if;

					end	loop;
					close	c05;

					if (coalesce(ie_gravar_bandeira_w,'S')	= 'S') then

						ie_gravar_caixa_w	:= 'S';
						vl_composicao_w	:= vl_total_bandeira_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_tot_band_estrang_w;
							vl_tot_caixa_estrang_w := coalesce(vl_tot_caixa_estrang_w,0) + coalesce(vl_tot_band_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            ' || WHEB_MENSAGEM_PCK.get_texto(810610) || ds_bandeira_w,
										vl_composicao_w,
										nr_ordem_apres_band_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_caixa_w	:= coalesce(vl_total_caixa_w,0) + coalesce(vl_total_bandeira_w,0);

					end if;


				end	loop;
				close	c04;

			end if;

			if (coalesce(ie_gravar_caixa_w,'S')	= 'S') then

				ie_gravar_grupo_w	:= 'S';
				vl_composicao_w	:= vl_total_caixa_w;
				/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

				if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
					vl_composicao_w	:= vl_tot_caixa_estrang_w;
					vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_tot_caixa_estrang_w,0);
				end if;

				CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
								'      ' || WHEB_MENSAGEM_PCK.get_texto(810605) || ds_caixa_w,
								vl_composicao_w,
								nr_ordem_apres_caixa_w,
								nm_usuario_p,
								'N',
								coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

				vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_total_caixa_w,0);

			end if;

		end	loop;
		close	c02;

	end if;

	/* Percorrer os bancos */

	if (coalesce(ie_banco_w,'N')	= 'S') then

		open	c06;
		loop
		fetch	c06 into
			ds_banco_w,
			cd_banco_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */

			ie_origem_valor_w	:= 'B';
			ie_cartao_w		:= 'N';
			ie_gravar_banco_w	:= 'N';
			vl_total_banco_w	:= 0;
			vl_tot_banco_estrang_w	:= 0;
			nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
			nr_ordem_apres_banco_w	:= nr_ordem_apres_w;

			open	c07;
			loop
			fetch	c07 into
				ie_identificacao_w,
				ds_titulo_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */

				/* Valor de saldo em banco */

				if (ie_identificacao_w	= '11') then

					open	c08;
					loop
					fetch	c08 into
						ds_conta_w,
						nr_seq_conta_banco_w;
					EXIT WHEN NOT FOUND; /* apply on c08 */

						select	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, dt_referencia_w)),0) vl_saldo,
							coalesce(sum(obter_saldo_banco_diario_estr(b.nr_sequencia, dt_referencia_w)),0) vl_saldo_estrang
						into STRICT	vl_item_w,
							vl_item_estrang_w
						from	estabelecimento c,
							banco_saldo b,
							banco_estabelecimento_v a
						where	substr(obter_se_filtro_fluxo_estab(a.nr_sequencia,null,null,nm_usuario_p,null,c.cd_estabelecimento),1,255) = 'S'
						and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
						and	c.cd_empresa		= cd_empresa_w
						and	a.cd_estabelecimento	= c.cd_estabelecimento
						and	b.nr_seq_conta		= a.nr_sequencia
						and	a.ie_tipo_relacao	in ('C', 'ECC')
						and	a.ie_fluxo_caixa	= 'S'
						and	a.ie_situacao		= 'A'
						and	a.nr_sequencia		= nr_seq_conta_banco_w
						and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	b.dt_referencia		=
							(SELECT	max(dt_referencia)
							from	banco_saldo x
							where	x.nr_seq_conta	= b.nr_seq_conta
							and	x.dt_referencia	<= dt_referencia_w);

						if (coalesce(vl_item_w,0)	<> 0) then

							ie_gravar_banco_w	:= 'S';
							nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
							vl_composicao_w	:= vl_item_w;
							/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

							if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
								vl_composicao_w	:= vl_item_estrang_w;
								vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
							end if;

							CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
											'            (+) ' || ds_conta_w,
											vl_composicao_w,
											nr_ordem_apres_w,
											nm_usuario_p,
											'N',
											coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

							vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

						end if;

					end	loop;
					close	c08;

				/* Recebimentos em cheque à vista */

				elsif (ie_identificacao_w	= '7') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						banco_estabelecimento  d,
						banco_saldo c,
						transacao_financeira b,
						cheque_cr f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.cd_banco		= cd_banco_w
					and	c.nr_seq_conta		= d.nr_sequencia
					and	a.nr_seq_saldo_banco	= c.nr_sequencia
					and	coalesce(b.ie_banco,'N')	<> 'N'
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'S') or
						f.ie_forma_pagto = 'AV')
					and	a.nr_seq_cheque		= f.nr_seq_cheque
					and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
					and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Recebimentos em cheque pré */

				elsif (ie_identificacao_w	= '8') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						banco_estabelecimento  d,
						banco_saldo c,
						transacao_financeira b,
						cheque_cr f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	d.cd_banco		= cd_banco_w
					and	c.nr_seq_conta		= d.nr_sequencia
					and	a.nr_seq_saldo_banco	= c.nr_sequencia
					and	coalesce(b.ie_banco,'N')	<> 'N'
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	((coalesce(f.ie_forma_pagto::text, '') = '' and substr(obter_se_cheque_cr_avista(f.nr_seq_cheque),1,1) = 'N') or
						f.ie_forma_pagto = 'PD')
					and	a.nr_seq_cheque		= f.nr_seq_cheque
					and	(a.nr_seq_cheque IS NOT NULL AND a.nr_seq_cheque::text <> '')
					and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (+) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque à vista */

				elsif (ie_identificacao_w	= '9') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						banco_estabelecimento d,
						banco_saldo c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_conta		= d.nr_sequencia
					and	d.cd_banco		= cd_banco_w
					and	c.nr_seq_conta		= d.nr_sequencia
					and	a.nr_seq_saldo_banco	= c.nr_sequencia
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	PKG_DATE_UTILS.start_of(coalesce(f.dt_emissao,clock_timestamp()),'dd', 0)	= PKG_DATE_UTILS.start_of(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd', 0)
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque pré */

				elsif (ie_identificacao_w	= '10') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						banco_estabelecimento d,
						banco_saldo c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_conta		= d.nr_sequencia
					and	d.cd_banco		= cd_banco_w
					and	c.nr_seq_conta		= d.nr_sequencia
					and	a.nr_seq_saldo_banco	= c.nr_sequencia
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	PKG_DATE_UTILS.start_of(coalesce(f.dt_emissao,clock_timestamp()),'dd', 0)	<> PKG_DATE_UTILS.start_of(coalesce(f.dt_vencimento,coalesce(f.dt_emissao,clock_timestamp())),'dd', 0)
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Pagamentos em cheque */

				elsif (ie_identificacao_w	= '19') then

					select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
						coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	estabelecimento e,
						banco_estabelecimento d,
						banco_saldo c,
						transacao_financeira b,
						cheque f,
						movto_trans_financ a
					where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_conta		= d.nr_sequencia
					and	d.cd_banco		= cd_banco_w
					and	c.nr_seq_conta		= d.nr_sequencia
					and	a.nr_seq_saldo_banco	= c.nr_sequencia
					and	a.nr_seq_trans_financ	= b.nr_sequencia
					and	a.nr_seq_cheque_cp	= f.nr_sequencia
					and	(a.nr_seq_cheque_cp IS NOT NULL AND a.nr_seq_cheque_cp::text <> '')
					and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_transacao		< dt_referencia_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Valor à pagar em cheque */

				elsif (ie_identificacao_w	= '20') then

					select	coalesce(sum(a.vl_cheque),0),
						coalesce(sum(a.vl_cheque_estrang),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	cheque a
					where	substr(obter_se_filtro_fluxo_estab(a.nr_seq_conta_banco,null,null,nm_usuario_p,null,a.cd_estabelecimento),1,255) = 'S'
					and	a.cd_banco		= cd_banco_w
					and	coalesce(a.dt_cancelamento::text, '') = ''
					and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao > dt_referencia_w)
					and	a.dt_emissao		<= dt_referencia_w
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and (coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	substr(obter_empresa_estab(a.cd_estabelecimento),1,15) = cd_empresa_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;

				/* Cheques à pagar em trânsito */

				elsif (ie_identificacao_w	= '26') then

					select	coalesce(sum(a.vl_cheque),0),
						coalesce(sum(a.vl_cheque_estrang),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	cheque a
					where	exists (SELECT	1
						from	titulo_pagar_baixa w,
							titulo_pagar z,
							titulo_pagar_adiant y,
							adiantamento_pago_cheque x
						where	z.nr_titulo		= w.nr_titulo
						and	y.nr_titulo		= z.nr_titulo
						and	x.nr_adiantamento	= y.nr_adiantamento
						and	x.nr_seq_cheque		= a.nr_sequencia
						
union

						SELECT	1
						from	titulo_pagar_baixa z,
							titulo_pagar y,
							adiantamento_pago_cheque x
						where	y.nr_titulo		= z.nr_titulo
						and	x.nr_adiantamento	= y.nr_adiant_pago
						and	x.nr_seq_cheque		= a.nr_sequencia
						
union

						select	1
						from	cheque_bordero_titulo x
						where ((x.nr_titulo IS NOT NULL AND x.nr_titulo::text <> '') or (x.nr_bordero IS NOT NULL AND x.nr_bordero::text <> ''))
						and	x.nr_seq_cheque		= a.nr_sequencia)
					and	substr(obter_se_filtro_fluxo_estab(a.nr_seq_conta_banco,null,null,nm_usuario_p,null,a.cd_estabelecimento),1,255) = 'S'
					and	a.cd_banco		= cd_banco_w
					and	coalesce(a.dt_cancelamento::text, '') = ''
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao > dt_ref_atual_w)
					and	( (coalesce(a.dt_pagamento::text, '') = '' and not exists (	select 1
																	from 	cheque_bordero_titulo u 
																	where 	u.nr_seq_cheque = a.nr_sequencia
																	and		(u.nr_bordero IS NOT NULL AND u.nr_bordero::text <> '')) ) or (a.dt_pagamento <= dt_ref_atual_w ))
					and	a.dt_emissao		<= dt_ref_atual_w
					and (coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	substr(obter_empresa_estab(a.cd_estabelecimento),1,15) = cd_empresa_w;

					if (coalesce(vl_item_w,0)	<> 0) then

						ie_gravar_banco_w	:= 'S';
						nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
						vl_composicao_w	:= vl_item_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_item_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_item_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'            (-) ' || ds_titulo_w,
										vl_composicao_w,
										nr_ordem_apres_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_item_w,0);

					end if;


				/* Recebimentos em cartão de crédito | Recebimentos em cartão de débito */

				elsif (ie_identificacao_w	in ('5','6','21')) then

					ie_cartao_w	:= 'S';

				end if;

			end	loop;
			close	c07;

			/* Percorrer as bandeiras de cartão */

			if (coalesce(ie_cartao_w,'N')	= 'S') then

				open	c04;
				loop
				fetch	c04 into
					ds_bandeira_w,
					nr_seq_bandeira_w;
				EXIT WHEN NOT FOUND; /* apply on c04 */

					ie_gravar_bandeira_w	:= 'N';
					vl_total_bandeira_w	:= 0;
					vl_tot_band_estrang_w	:= 0;
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					nr_ordem_apres_band_w	:= nr_ordem_apres_w;

					open	c05;
					loop
					fetch	c05 into
						ie_identificacao_w,
						ds_titulo_w;
					EXIT WHEN NOT FOUND; /* apply on c05 */

						/* Recebimentos em cartão de crédito */

						if (ie_identificacao_w	= '5') then

							select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
								coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
							into STRICT	vl_item_w,
								vl_item_estrang_w
							from	estabelecimento e,
								banco_estabelecimento d,
								banco_saldo c,
								transacao_financeira b,
								movto_cartao_cr f,
								movto_trans_financ a
							where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
							and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
							and	e.cd_empresa		= cd_empresa_w
							and	d.ie_situacao		= 'A'
							and	d.cd_estabelecimento	= e.cd_estabelecimento
							and	d.cd_banco		= cd_banco_w
							and	c.nr_seq_conta		= d.nr_sequencia
							and	a.nr_seq_saldo_banco	= c.nr_sequencia
							and	coalesce(b.ie_banco,'N')	<> 'N'
							and	a.nr_seq_trans_financ	= b.nr_sequencia
							and	coalesce(f.ie_tipo_cartao,'C')	= 'C'
							and	f.nr_seq_bandeira	= nr_seq_bandeira_w
							and	a.nr_seq_movto_cartao	= f.nr_sequencia
							and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
							and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
							and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
							and	a.dt_transacao		< dt_referencia_w;

							if (coalesce(vl_item_w,0)	<> 0) then

								ie_gravar_bandeira_w	:= 'S';
								nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
								vl_composicao_w	:= vl_item_w;
								/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

								if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
									vl_composicao_w	:= vl_item_estrang_w;
									vl_tot_band_estrang_w := coalesce(vl_tot_band_estrang_w,0) + coalesce(vl_item_estrang_w,0);
								end if;

								CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
												'                  (+) ' || WHEB_MENSAGEM_PCK.get_texto(810609),
												vl_composicao_w,
												nr_ordem_apres_w,
												nm_usuario_p,
												'N',
												coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

								vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

							end if;

						/* Recebimentos em cartão de débito */

						elsif (ie_identificacao_w	= '6') then

							select	coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao,0) * -1 END ),0),
								coalesce(sum(CASE WHEN b.ie_saldo_caixa='E' THEN a.vl_transacao_estrang WHEN b.ie_saldo_caixa='S' THEN coalesce(a.vl_transacao_estrang,0) * -1 END ),0)
							into STRICT	vl_item_w,
								vl_item_estrang_w
							from	estabelecimento e,
								banco_estabelecimento d,
								banco_saldo c,
								transacao_financeira b,
								movto_cartao_cr f,
								movto_trans_financ a
							where	substr(obter_se_filtro_fluxo_estab(d.nr_sequencia,null,null,nm_usuario_p,null,e.cd_estabelecimento),1,255) = 'S'
							and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
							and	e.cd_empresa		= cd_empresa_w
							and	d.ie_situacao		= 'A'
							and	d.cd_estabelecimento	= e.cd_estabelecimento
							and	d.cd_banco		= cd_banco_w
							and	c.nr_seq_conta		= d.nr_sequencia
							and	a.nr_seq_saldo_banco	= c.nr_sequencia
							and	coalesce(b.ie_banco,'N')	<> 'N'
							and	a.nr_seq_trans_financ	= b.nr_sequencia
							and	coalesce(f.ie_tipo_cartao,'C')	= 'D'
							and	f.nr_seq_bandeira	= nr_seq_bandeira_w
							and	a.nr_seq_movto_cartao	= f.nr_sequencia
							and	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
							and	(a.nr_seq_saldo_banco IS NOT NULL AND a.nr_seq_saldo_banco::text <> '')
							and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
							and	a.dt_transacao		< dt_referencia_w;

							if (coalesce(vl_item_w,0)	<> 0) then

								ie_gravar_bandeira_w	:= 'S';
								nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
								vl_composicao_w	:= vl_item_w;
								/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

								if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
									vl_composicao_w	:= vl_item_estrang_w;
									vl_tot_band_estrang_w := coalesce(vl_tot_band_estrang_w,0) + coalesce(vl_item_estrang_w,0);
								end if;

								CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
												'                  (+) ' || WHEB_MENSAGEM_PCK.get_texto(810608),
												vl_composicao_w,
												nr_ordem_apres_w,
												nm_usuario_p,
												'N',
												coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

								vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

							end if;

						/* Valor à receber em cartão */

						elsif (ie_identificacao_w	= '21') then

							select	coalesce(sum(obter_saldo_parcela_cartao(a.nr_sequencia,dt_referencia_w)),0)
							into STRICT	vl_item_w
							from	estabelecimento d,
								banco_estabelecimento b,
								movto_cartao_cr c,
								movto_cartao_cr_parcela a
							where	substr(obter_se_filtro_fluxo_estab(b.nr_sequencia,null,null,nm_usuario_p,null,c.cd_estabelecimento),1,255) = 'S'
							and	b.cd_banco		= cd_banco_w
							and	(obter_valor_bandeira_estab(c.nr_seq_bandeira,cd_estabelecimento_p,'NR_SEQ_CONTA_BANCO'))::numeric  = b.nr_sequencia
							and	d.cd_empresa		= cd_empresa_w
							and	c.cd_estabelecimento	= d.cd_estabelecimento
							and	c.nr_seq_bandeira	= nr_seq_bandeira_w
							and	a.nr_seq_movto		= c.nr_sequencia
							and	coalesce(c.dt_cancelamento::text, '') = ''
							and	a.dt_parcela		<= dt_referencia_w
							and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
							and (coalesce(c.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N');

							if (coalesce(vl_item_w,0)	<> 0) then

								ie_gravar_bandeira_w	:= 'S';
								nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;

								CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
												'                  (+) ' || ds_titulo_w,
												vl_item_w,
												nr_ordem_apres_w,
												nm_usuario_p,
												'N',
												cd_moeda_empresa_w);

								vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

							end if;

						end if;

					end	loop;
					close	c05;

					if (coalesce(ie_gravar_bandeira_w,'S')	= 'S') then

						ie_gravar_banco_w	:= 'S';
						vl_composicao_w	:= vl_total_bandeira_w;
						/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

						if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
							vl_composicao_w	:= vl_tot_band_estrang_w;
							vl_tot_banco_estrang_w := coalesce(vl_tot_banco_estrang_w,0) + coalesce(vl_tot_band_estrang_w,0);
						end if;

						CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
										'           ' || WHEB_MENSAGEM_PCK.get_texto(810610) || ' ' || ds_bandeira_w,
										vl_composicao_w,
										nr_ordem_apres_band_w,
										nm_usuario_p,
										'N',
										coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

						vl_total_banco_w	:= coalesce(vl_total_banco_w,0) + coalesce(vl_total_bandeira_w,0);

					end if;


				end	loop;
				close	c04;

			end if;

			if (coalesce(ie_gravar_banco_w,'S')	= 'S') then

				ie_gravar_grupo_w	:= 'S';
				vl_composicao_w	:= vl_total_banco_w;
				/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

				if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
					vl_composicao_w	:= vl_tot_banco_estrang_w;
					vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_tot_banco_estrang_w,0);
				end if;

				CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
								'      ' || WHEB_MENSAGEM_PCK.get_texto(810604) || ' ' || ds_banco_w,
								vl_composicao_w,
								nr_ordem_apres_banco_w,
								nm_usuario_p,
								'N',
								coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

				vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_total_banco_w,0);

			end if;

		end	loop;
		close	c06;

	end if;

	/* Itens sem origem definida */

	if (coalesce(ie_nenhuma_w,'N')	= 'S') then

		ie_cartao_w		:= 'N';
		ie_origem_valor_w	:= 'N';

		open	c09;
		loop
		fetch	c09 into
			ie_identificacao_w,
			ds_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */

			/* Valor do projeto de recurso */

			if (ie_identificacao_w	= '2') then

				select	sum(coalesce(a.vl_saldo,0))
				into STRICT	vl_item_w
				from	projeto_recurso_saldo a
				where	a.nr_seq_projeto in (SELECT	b.nr_seq_proj_rec
					from	w_filtro_fluxo b
					where	b.nm_usuario	= nm_usuario_p)
				and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
				and	a.dt_mesano_referencia	between dt_inicio_mes_w and dt_referencia_w;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_item_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor do fechamento do fluxo de caixa */

			elsif (ie_identificacao_w	= '3') then

				select	max(x.dt_referencia)
				into STRICT	dt_fechamento_w
				from	fluxo_caixa_fechamento x
				where	x.dt_referencia		< dt_inicio_dia_w
				and	coalesce(x.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

				if (ie_fechamento_diario_w = 'S') then

					select	coalesce(max(a.vl_saldo_final),0),
						coalesce(max(a.vl_saldo_final_estrang),0)
					into STRICT	vl_item_w,
						vl_item_estrang_w
					from	fluxo_caixa_fechamento a
					where	a.cd_empresa	= cd_empresa_w
					and	a.dt_referencia	= dt_fechamento_w
					and	coalesce(ie_tipo_fluxo, 'G')		= 'G'
					and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;
				
				else

					if (dt_fechamento_w	= PKG_DATE_UTILS.start_of(dt_fechamento_w,'month', 0)) then
				
						select	coalesce(max(a.vl_saldo_final),0),
							coalesce(max(a.vl_saldo_final_estrang),0)
						into STRICT	vl_item_w,
							vl_item_estrang_w
						from	fluxo_caixa_fechamento a
						where	a.cd_empresa		= cd_empresa_w
						and	a.dt_referencia		= dt_fechamento_w
						and	coalesce(ie_tipo_fluxo, 'G')	= 'G'
						and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
						and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

					end if;

				end if;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor do saldo à vista do caixa */

			elsif (ie_identificacao_w	= '4') then

				select	sum(vl_saldo_avista),
					sum(vl_saldo_vista_estrang)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	(SELECT	coalesce(sum(a.vl_saldo_avista),0) vl_saldo_avista,
						0 vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					
union all

					SELECT	0 vl_saldo_avista,
						coalesce(sum(e.vl_saldo_avista),0) vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a,
						caixa_saldo_estrang e
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	e.nr_seq_caixa_saldo	= a.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)) alias20;

				if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Recebimentos em espécie */

			elsif (ie_identificacao_w	= '1') then

				select	sum(vl_especie),
					sum(vl_especie_estrang)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from (SELECT	coalesce(sum(a.vl_especie),0) vl_especie,
						0 vl_especie_estrang
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						caixa_receb a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_recebimento	< dt_referencia_w
					
union all

					SELECT	0 vl_especie,
						coalesce(sum(b.vl_especie_estrang),0) vl_especie_estrang
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						caixa_receb a,
						caixa_receb_estrang b
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.nr_seq_caixa_receb	= a.nr_sequencia
					and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
					and	coalesce(b.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_recebimento	< dt_referencia_w) alias18;

				if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor de outras entradas no caixa */

			elsif (ie_identificacao_w	= '12') then

				select	sum(vl_especie),
					sum(vl_especie_estrang)
				into STRICT	vl_especie_w,
					vl_especie_estrang_w
				from (SELECT	coalesce(sum(a.vl_especie),0) vl_especie,
						0 vl_especie_estrang
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						caixa_receb a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_recebimento	< dt_referencia_w
					
union all

					SELECT	0 vl_especie,
						coalesce(sum(b.vl_especie_estrang),0) vl_especie_estrang
					from	estabelecimento e,
						caixa d,
						caixa_saldo_diario c,
						caixa_receb a,
						caixa_receb_estrang b
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
					and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	e.cd_empresa		= cd_empresa_w
					and	d.ie_fluxo		= 'S'
					and	d.ie_situacao		= 'A'
					and	d.cd_estabelecimento	= e.cd_estabelecimento
					and	c.nr_seq_caixa		= d.nr_sequencia
					and	a.nr_seq_saldo_caixa	= c.nr_sequencia
					and	b.nr_seq_caixa_receb	= b.nr_sequencia
					and	(a.dt_fechamento IS NOT NULL AND a.dt_fechamento::text <> '')
					and	coalesce(b.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_recebimento	< dt_referencia_w) alias18;

				select	coalesce(sum(a.vl_transacao),0) - coalesce(vl_especie_w,0),
					coalesce(sum(a.vl_transacao_estrang),0) - coalesce(vl_especie_estrang_w,0)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	= 'E'
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
				and	coalesce(a.nr_seq_cheque::text, '') = ''
				and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
				and	a.dt_transacao		< dt_referencia_w;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor de outras saídas no caixa */

			elsif (ie_identificacao_w	= '13') then

				select	coalesce(sum(a.vl_transacao),0) * -1,
					coalesce(sum(a.vl_transacao_estrang),0) * -1
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	estabelecimento e,
					caixa d,
					caixa_saldo_diario c,
					transacao_financeira b,
					movto_trans_financ a
				where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,d.nr_sequencia,e.cd_estabelecimento),1,255) = 'S'
				and (d.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	e.cd_empresa		= cd_empresa_w
				and	d.ie_fluxo		= 'S'
				and	d.ie_situacao		= 'A'
				and	d.cd_estabelecimento	= e.cd_estabelecimento
				and	c.nr_seq_caixa		= d.nr_sequencia
				and	a.nr_seq_saldo_caixa	= c.nr_sequencia
				and	b.ie_caixa		in ('D', 'T', 'A')
				and	b.ie_saldo_caixa	= 'S'
				and	a.nr_seq_trans_financ	= b.nr_sequencia
				and	coalesce(a.nr_seq_cheque_cp::text, '') = ''
				and	coalesce(a.nr_seq_cheque::text, '') = ''
				and	coalesce(a.nr_seq_movto_cartao::text, '') = ''
				and	(a.nr_seq_saldo_caixa IS NOT NULL AND a.nr_seq_saldo_caixa::text <> '')
				and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
				and	a.dt_transacao		< dt_referencia_w;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (-) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor de saldo em banco */

			elsif (ie_identificacao_w	= '11') then

				select	coalesce(sum(obter_saldo_banco_diario(b.nr_sequencia, dt_referencia_w)),0) vl_saldo,
					coalesce(sum(obter_saldo_banco_diario_estr(b.nr_sequencia, dt_referencia_w)),0) vl_saldo_estrang
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	estabelecimento c,
					banco_saldo b,
					banco_estabelecimento_v a
				where	substr(obter_se_filtro_fluxo_estab(a.nr_sequencia,null,null,nm_usuario_p,null,c.cd_estabelecimento),1,255) = 'S'
				and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	c.cd_empresa		= cd_empresa_w
				and	a.cd_estabelecimento	= c.cd_estabelecimento
				and	b.nr_seq_conta		= a.nr_sequencia
				and	a.ie_tipo_relacao	in ('C', 'ECC')
				and	a.ie_fluxo_caixa	= 'S'
				and	a.ie_situacao		= 'A'
				and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
				and	b.dt_referencia		=
					(SELECT	max(dt_referencia)
					from	banco_saldo x
					where	x.nr_seq_conta	= b.nr_seq_conta
					and	x.dt_referencia	<= dt_referencia_w);

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor à pagar em cheque */

			elsif (ie_identificacao_w	= '20') then

				select	coalesce(sum(a.vl_cheque),0),
					coalesce(sum(a.vl_cheque_estrang),0)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	cheque a
				where	substr(obter_se_filtro_fluxo_estab(a.nr_seq_conta_banco,null,null,nm_usuario_p,null,a.cd_estabelecimento),1,255) = 'S'
				and	coalesce(a.dt_cancelamento::text, '') = ''
				and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao > dt_referencia_w)
				and	a.dt_emissao		<= dt_referencia_w
				and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
				and (coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	substr(obter_empresa_estab(a.cd_estabelecimento),1,15) = cd_empresa_w;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (-) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Cheques à pagar em trânsito */

			elsif (ie_identificacao_w	= '26') then

				select	coalesce(sum(a.vl_cheque),0),
					coalesce(sum(a.vl_cheque_estrang),0)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	cheque a
				where	exists (SELECT	1
					from	titulo_pagar_baixa w,
						titulo_pagar z,
						titulo_pagar_adiant y,
						adiantamento_pago_cheque x
					where	z.nr_titulo		= w.nr_titulo
					and	y.nr_titulo		= z.nr_titulo
					and	x.nr_adiantamento	= y.nr_adiantamento
					and	x.nr_seq_cheque		= a.nr_sequencia
					
union

					SELECT	1
					from	titulo_pagar_baixa z,
						titulo_pagar y,
						adiantamento_pago_cheque x
					where	y.nr_titulo		= z.nr_titulo
					and	x.nr_adiantamento	= y.nr_adiant_pago
					and	x.nr_seq_cheque		= a.nr_sequencia
					
union

					select	1
					from	cheque_bordero_titulo x
					where ((x.nr_titulo IS NOT NULL AND x.nr_titulo::text <> '') or (x.nr_bordero IS NOT NULL AND x.nr_bordero::text <> ''))
					and	x.nr_seq_cheque		= a.nr_sequencia)
				and	substr(obter_se_filtro_fluxo_estab(a.nr_seq_conta_banco,null,null,nm_usuario_p,null,a.cd_estabelecimento),1,255) = 'S'
				and	coalesce(a.dt_cancelamento::text, '') = ''
				and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao > dt_ref_atual_w)
				and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
				and	( (coalesce(a.dt_pagamento::text, '') = '' and not exists (	select 1
																	from 	cheque_bordero_titulo u 
																	where 	u.nr_seq_cheque = a.nr_sequencia
																	and		(u.nr_bordero IS NOT NULL AND u.nr_bordero::text <> '')) ) or (a.dt_pagamento <= dt_ref_atual_w ))
				and	a.dt_emissao		<= dt_ref_atual_w
				and (coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	substr(obter_empresa_estab(a.cd_estabelecimento),1,15) = cd_empresa_w;

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (-) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Saldo em espécie no caixa */

			elsif (ie_identificacao_w	= '22') then

				select	sum(vl_saldo_avista),
					sum(vl_saldo_vista_estrang)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	(SELECT	coalesce(sum(a.vl_especie_atual),0) vl_saldo_avista,
						0 vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					
union all

					SELECT	0 vl_saldo_avista,
						coalesce(sum(e.vl_especie_atual),0) vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a,
						caixa_saldo_estrang e
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	e.nr_seq_caixa_saldo	= a.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)) alias20;

				if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Saldo em cartão no caixa */

			elsif (ie_identificacao_w	= '23') then

				select	coalesce(sum(a.vl_cartao_cr_atual),0) vl_saldo_avista
				into STRICT	vl_item_w
				from	estabelecimento c,
					caixa b,
					caixa_saldo_diario a
				where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
				and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
				and	c.cd_empresa		= cd_empresa_w
				and	b.cd_estabelecimento	= c.cd_estabelecimento
				and	a.nr_seq_caixa		= b.nr_sequencia
				and	b.ie_situacao		= 'A'
				and	b.ie_fluxo 		= 'S'
				and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
				and	a.dt_saldo		=
					(SELECT	max(dt_saldo)
					from	caixa_saldo_diario x
					where	x.nr_seq_caixa	= a.nr_seq_caixa
					and	x.dt_saldo	<= dt_referencia_w);

				if (coalesce(vl_item_w,0)	<> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_item_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Saldo em cheque à vista no caixa */

			elsif (ie_identificacao_w	= '24') then

				select	sum(vl_saldo_avista),
					sum(vl_saldo_vista_estrang)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	(SELECT	coalesce(sum(a.vl_cheque_vista_atual),0) vl_saldo_avista,
						0 vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					
union all

					SELECT	0 vl_saldo_avista,
						coalesce(sum(e.vl_cheque_vista_atual),0) vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a,
						caixa_saldo_estrang e
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	e.nr_seq_caixa_saldo	= a.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Busca apenas os registros da moeda relacionada
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)) alias20;

				if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Saldo em cheque pré no caixa */

			elsif (ie_identificacao_w	= '25') then

				select	sum(vl_saldo_avista),
					sum(vl_saldo_vista_estrang)
				into STRICT	vl_item_w,
					vl_item_estrang_w
				from	(SELECT	coalesce(sum(a.vl_cheque_pre_atual),0) vl_saldo_avista,
						0 vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)
					
union all

					SELECT	0 vl_saldo_avista,
						coalesce(sum(a.vl_cheque_pre_atual),0) vl_saldo_vista_estrang
					from	estabelecimento c,
						caixa b,
						caixa_saldo_diario a,
						caixa_saldo_estrang e
					where	substr(obter_se_filtro_fluxo_estab(null,null,null,nm_usuario_p,b.nr_sequencia,c.cd_estabelecimento),1,255) = 'S'
					and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
					and	c.cd_empresa		= cd_empresa_w
					and	b.cd_estabelecimento	= c.cd_estabelecimento
					and	a.nr_seq_caixa		= b.nr_sequencia
					and	e.nr_seq_caixa_saldo	= a.nr_sequencia
					and	b.ie_situacao		= 'A'
					and	b.ie_fluxo 		= 'S'
					and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  -- Projeto Multimoeda - Traz somente quando for moeda nacional
					and	a.dt_saldo		=
						(select	max(dt_saldo)
						from	caixa_saldo_diario x
						where	x.nr_seq_caixa	= a.nr_seq_caixa
						and	x.dt_saldo	<= dt_referencia_w)) alias20;

				if (coalesce(vl_item_w,0) <> 0 or coalesce(vl_item_estrang_w,0) <> 0) then

					ie_gravar_grupo_w	:= 'S';
					nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
					vl_composicao_w	:= vl_item_w;
					/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

					if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
						vl_composicao_w	:= vl_item_estrang_w;
						vl_tot_grupo_estrang_w := coalesce(vl_tot_grupo_estrang_w,0) + coalesce(vl_item_estrang_w,0);
					end if;

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      (+) ' || ds_titulo_w,
									vl_composicao_w,
									nr_ordem_apres_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_item_w,0);

				end if;

			/* Valor à receber em cartão */

			elsif (ie_identificacao_w	= '21') then

				ie_cartao_w	:= 'S';

			end if;

		end	loop;
		close	c09;

		/* Percorrer as bandeiras de cartão */

		if (coalesce(ie_cartao_w,'N')	= 'S') then

			open	c04;
			loop
			fetch	c04 into
				ds_bandeira_w,
				nr_seq_bandeira_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */

				ie_gravar_bandeira_w	:= 'N';
				vl_total_bandeira_w	:= 0;
				vl_tot_band_estrang_w	:= 0;
				nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
				nr_ordem_apres_band_w	:= nr_ordem_apres_w;

				open	c05;
				loop
				fetch	c05 into
					ie_identificacao_w,
					ds_titulo_w;
				EXIT WHEN NOT FOUND; /* apply on c05 */

					/* Valor à receber em cartão */

					if (ie_identificacao_w	= '21') then

						select	coalesce(sum(obter_saldo_parcela_cartao(a.nr_sequencia,dt_referencia_w)),0)
						into STRICT	vl_item_w
						FROM estabelecimento d, movto_cartao_cr c, movto_cartao_cr_parcela a, obter_valor_bandeira_estab(c
LEFT OUTER JOIN banco_estabelecimento b ON ((obter_valor_bandeira_estab(c.nr_seq_bandeira,cd_estabelecimento_p,'NR_SEQ_CONTA_BANCO'))::numeric = b.nr_sequencia)
WHERE substr(obter_se_filtro_fluxo_estab(b.nr_sequencia,null,null,nm_usuario_p,null,c.cd_estabelecimento),1,255) = 'S'  and d.cd_empresa		= cd_empresa_w and c.cd_estabelecimento	= d.cd_estabelecimento and c.nr_seq_bandeira	= nr_seq_bandeira_w and a.nr_seq_movto		= c.nr_sequencia and coalesce(c.dt_cancelamento::text, '') = '' and a.dt_parcela		<= dt_referencia_w and cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)   -- Projeto Multimoeda - Traz somente quando for moeda nacional
  and (coalesce(c.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N');

						if (coalesce(vl_item_w,0)	<> 0) then

							ie_gravar_bandeira_w	:= 'S';
							nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;

							CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
											'            (+) ' || ds_titulo_w,
											vl_item_w,
											nr_ordem_apres_w,
											nm_usuario_p,
											'N',
											cd_moeda_empresa_w);

							vl_total_bandeira_w	:= coalesce(vl_total_bandeira_w,0) + coalesce(vl_item_w,0);

						end if;

					end if;

				end	loop;
				close	c05;

				if (coalesce(ie_gravar_bandeira_w,'S')	= 'S') then

					ie_gravar_grupo_w	:= 'S';

					CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
									'      ' || WHEB_MENSAGEM_PCK.get_texto(810610) || ' ' || ds_bandeira_w,
									vl_total_bandeira_w,
									nr_ordem_apres_band_w,
									nm_usuario_p,
									'N',
									cd_moeda_empresa_w);

					vl_total_grupo_w	:= coalesce(vl_total_grupo_w,0) + coalesce(vl_total_bandeira_w,0);

				end if;

			end	loop;
			close	c04;

		end if;

	end if;

	if (coalesce(ie_gravar_grupo_w,'S')	= 'S') then

		ie_gravar_total_w	:= 'S';
		vl_composicao_w	:= vl_total_grupo_w;
		/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_composicao_w	:= vl_tot_grupo_estrang_w;
			if (coalesce(ie_operacao_w,'N') = 'S') then
				vl_total_estrang_w := coalesce(vl_total_estrang_w,0) + coalesce(vl_tot_grupo_estrang_w,0);
			elsif (coalesce(ie_operacao_w,'N') = 'D') then
				vl_total_estrang_w := coalesce(vl_total_estrang_w,0) - coalesce(vl_tot_grupo_estrang_w,0);
			end if;
		end if;

		if (coalesce(ie_operacao_w,'N')	= 'S') then

			vl_total_w	:= coalesce(vl_total_w,0) + coalesce(vl_total_grupo_w,0);
			ds_grupo_w	:= ds_grupo_w || ' (+)';

		elsif (coalesce(ie_operacao_w,'N')	= 'D') then

			ds_grupo_w	:= ds_grupo_w || ' (-)';
			vl_total_w	:= coalesce(vl_total_w,0) - coalesce(vl_total_grupo_w,0);

		end if;

		CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
						ds_grupo_w,
						vl_composicao_w,
						nr_ordem_apres_grupo_w,
						nm_usuario_p,
						'N',
						coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

	end if;

end	loop;
close	c01;

if (coalesce(ie_gravar_total_w,'S')	= 'S') then

	nr_ordem_apres_w	:= coalesce(nr_ordem_apres_w,0) + 1;
	vl_composicao_w	:= vl_total_w;
	/* Projeto Multimoeda - Quando moeda estrangeira passar os valores em moeda estrangeira*/

	if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
		vl_composicao_w	:= vl_total_estrang_w;
	end if;

	CALL popular_composicao_fluxo_caixa(	nr_seq_regra_p,
					WHEB_MENSAGEM_PCK.get_texto(298559),
					vl_composicao_w,
					nr_ordem_apres_w,
					nm_usuario_p,
					'N',
					coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_composicao_fluxo_caixa (nr_seq_regra_p bigint, dt_referencia_p timestamp, cd_estabelecimento_p bigint, ie_restringe_estab_p text, nm_usuario_p text, ie_periodo_p text default null, cd_moeda_p bigint default null) FROM PUBLIC;

