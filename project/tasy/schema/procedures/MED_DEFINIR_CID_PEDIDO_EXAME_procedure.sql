-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_definir_cid_pedido_exame (ds_lista_cid_p text, nr_seq_pedido_p bigint) AS $body$
DECLARE


ds_lista_cid_w	varchar(4000);
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
cd_doenca_cid_w	varchar(10);
ds_doenca_cid_w	varchar(240);
ds_lista_cd_cid_w	varchar(4000);
ds_lista_ds_cid_w	varchar(4000);


BEGIN
if (ds_lista_cid_p IS NOT NULL AND ds_lista_cid_p::text <> '') then
	ds_lista_cid_w := ds_lista_cid_p;

	/* obter código cid */

	while(ds_lista_cid_w IS NOT NULL AND ds_lista_cid_w::text <> '') loop
		begin
		tam_lista_w		:= length(ds_lista_cid_w);
		ie_pos_virgula_w	:= position(',' in ds_lista_cid_w);

		if (ie_pos_virgula_w <> 0) then
			cd_doenca_cid_w	:= substr(ds_lista_cid_w,1,(ie_pos_virgula_w - 1));
			ds_lista_cid_w	:= substr(ds_lista_cid_w,(ie_pos_virgula_w + 1),tam_lista_w);
		end if;

		/* obter descrição cid */

		if (coalesce(cd_doenca_cid_w,'0') <> '0') then
			select	ds_doenca_cid
			into STRICT	ds_doenca_cid_w
			from	cid_doenca
			where	cd_doenca_cid = cd_doenca_cid_w;

			ds_lista_cd_cid_w := ds_lista_cd_cid_w || cd_doenca_cid_w || ' - ';
			ds_lista_ds_cid_w := ds_lista_ds_cid_w || ds_doenca_cid_w || ' - ';
		end if;
		end;
	end loop;

	/* gerar cid */

	update	med_pedido_exame
	set	ds_cid		   	= substr(ds_lista_cd_cid_w,1,4000),
		ds_diagnostico_cid 	= substr(ds_lista_ds_cid_w,1,4000)
	where	nr_sequencia		= nr_seq_pedido_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_definir_cid_pedido_exame (ds_lista_cid_p text, nr_seq_pedido_p bigint) FROM PUBLIC;

