-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_dieta_out_dieta_ant ( nr_sequencia_p bigint, nm_usuario_p text, qt_horas_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w			varchar(10);
dt_dieta_ref_w			timestamp;
dt_dieta_w			timestamp;
cd_refeicao_w			varchar(02);
cd_refeicao_ref_w			varchar(02);
ie_destino_dieta_w			varchar(02);
cd_setor_atendimento_w		integer;
cd_unidade_basica_w		varchar(10);
cd_unidade_compl_w		varchar(10);
cd_dieta_w			bigint;
cd_dieta_atual_w			bigint	:= '';
ds_observacao_w			varchar(2000);
nr_sequencia_w			bigint;
nr_atendimento_w			bigint;
ds_tipo_dieta_w			varchar(10);
nr_posicao_dieta_w			smallint;
ie_continua_w			varchar(01);
ie_sai_loop_w			varchar(01);
ie_copiou_w			varchar(01);
cont_w				smallint;
ds_observacao_tec_w		varchar(2000);
vl_parametro_w			varchar(3);
nr_seq_superior_w		bigint;
qt_dieta_atend_w		bigint;
nr_seq_superior_dieta_w		bigint;
total_w				bigint;
ie_tipo_dieta_w			varchar(1);
ie_recem_nato_w			varchar(1);

C011 CURSOR FOR
	SELECT 	cd_dieta,
		ie_destino_dieta,
		ds_observacao,
		ds_observacao_tec,
		nr_seq_superior,
		ie_tipo_dieta,
		ie_recem_nato
	from 	mapa_Dieta
	where 	cd_pessoa_fisica	= cd_pessoa_fisica_w
	and 	cd_refeicao		= cd_refeicao_ref_w
	and 	(cd_dieta IS NOT NULL AND cd_dieta::text <> '')
	and	dt_dieta		= dt_dieta_ref_w
	and	nr_sequencia		<> nr_sequencia_p
	and	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
	and	ie_destino_dieta	= 'P'
	group	by cd_dieta,
		ie_destino_dieta,
		ds_observacao,
		ds_observacao_tec,
		nr_seq_superior,
		ie_tipo_dieta,
		ie_recem_nato
	order by coalesce(nr_seq_superior,0);

BEGIN
select	coalesce(obter_valor_param_usuario(1000, 8, Obter_Perfil_Ativo, nm_usuario_p,1),'N')
into STRICT	vl_parametro_w
;


/*Diária, Ceia, Jantar, Lanche Tarde, Almoço, Lanche Manhã, Desjejum */

select	cd_pessoa_fisica,
		cd_refeicao,
		dt_dieta,
		cd_setor_atendimento,
		cd_unidade_basica,
		cd_unidade_compl,
		nr_atendimento,
		nr_seq_superior
into STRICT		cd_pessoa_fisica_w,
		cd_refeicao_w,
		dt_dieta_w,
		cd_setor_atendimento_w,
		cd_unidade_basica_w,
		cd_unidade_compl_w,
		nr_atendimento_w,
		nr_seq_superior_w
from 		mapa_dieta
where 	nr_sequencia	= nr_sequencia_p;

ds_tipo_dieta_w		:= 'XRCJTABLMD';
total_w			:= 8;

ie_continua_w		:= 'N';
ie_sai_loop_w		:= 'N';
dt_dieta_ref_w		:= dt_dieta_w;
ie_copiou_w		:= 'N';
cont_w			:= 1;


while(ie_copiou_w <> 'S') and (cont_w <= total_w)
loop
	for i in 1..length(ds_tipo_dieta_w)
	loop
		begin
		if (substr(ds_tipo_dieta_w,i,1) = cd_refeicao_w) then
			ie_continua_w	:= 'S';
		end if;

		if (ie_continua_w = 'S') then
			begin

			cd_refeicao_ref_w	:= substr(ds_tipo_dieta_w,i + 1,1);

			if (cd_refeicao_w = 'X') then                   --Edilson em 25/02/2004 OS 6394
				cd_refeicao_ref_w	:= 'X';
				dt_dieta_ref_w		:= dt_dieta_w - 1;
			elsif (cd_refeicao_w = 'R') then
				cd_refeicao_ref_w	:= 'R';
				dt_dieta_ref_w		:= dt_dieta_w - 1;
			end if;

			OPEN C011;
			LOOP
			FETCH C011 INTO
					cd_dieta_w,
					ie_destino_dieta_w,
					ds_observacao_w,
					ds_observacao_tec_w,
					nr_seq_superior_dieta_w,
					ie_tipo_dieta_w,
					ie_recem_nato_w;
			EXIT WHEN NOT FOUND; /* apply on C011 */
				begin
				if (cd_refeicao_ref_w = cd_refeicao_w) then

					ie_sai_loop_w		:= 'S';
					ie_copiou_w		:= 'S';

					if (vl_parametro_w = 'S') then
						ds_observacao_tec_w	:= null;
					end if;

					begin
					select nextval('mapa_dieta_seq')
					into STRICT nr_sequencia_w
					;

					Insert into Mapa_Dieta(
						CD_PESSOA_FISICA,
						NR_SEQUENCIA,
						DT_DIETA,
						CD_REFEICAO,
						DT_ATUALIZACAO,
						NM_USUARIO,
						CD_SETOR_ATENDIMENTO,
						CD_UNIDADE_BASICA,
						CD_UNIDADE_COMPL,
						IE_DESTINO_DIETA,
						CD_DIETA,
						nr_atendimento,
						ds_observacao,
						IE_STATUS,
						ds_observacao_tec,
						nm_usuario_nrec,
						dt_atualizacao_nrec,
						nr_seq_superior,
						ie_tipo_dieta,
						ie_recem_nato)
					values (
						CD_PESSOA_FISICA_W,
						NR_SEQUENCIA_W,
						DT_DIETA_W,
						CD_REFEICAO_W,
						clock_timestamp(),
						NM_USUARIO_P,
						CD_SETOR_ATENDIMENTO_W,
						CD_UNIDADE_BASICA_W,
						CD_UNIDADE_COMPL_W,
						ie_destino_dieta_w,
						cd_dieta_w,
						nr_atendimento_w,
						ds_observacao_w,
						'A',
						ds_observacao_tec_w,
						nm_usuario_p,
						clock_timestamp(),
						CASE WHEN coalesce(nr_seq_superior_dieta_w::text, '') = '' THEN null  ELSE nr_sequencia_p END ,
						ie_tipo_dieta_w,
						ie_recem_nato_w);
					commit;
					end;
				end if;
				end;
			END LOOP;
			CLOSE C011;

			if (ie_sai_loop_w	= 'S') then
				exit;
			end if;
			end;
		end if;
		if (cd_refeicao_ref_w = 'D') then
			dt_dieta_ref_w		:= dt_dieta_w - 1;
		end if;
		end;
	end loop;
	dt_dieta_ref_w		:= dt_dieta_w - 1;
	cont_w := cont_w + 1;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_dieta_out_dieta_ant ( nr_sequencia_p bigint, nm_usuario_p text, qt_horas_p bigint) FROM PUBLIC;

