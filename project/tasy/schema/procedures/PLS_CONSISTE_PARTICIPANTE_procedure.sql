-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consiste_participante (( nr_seq_procedimento_p bigint, ie_tipo_consiste_p text, nm_usuario_p text, cd_estabelecimento_p bigint) is nr_seq_prestador_w bigint) RETURNS CONSELHO_PROFISSIONAL.NR_SEQUENCIA%TYPE AS $body$
DECLARE

sg_conselho_w			tiss_conselho_profissional.sg_conselho%type;
nr_seq_conselho_ww		tiss_conselho_profissional.sg_conselho%type;


BEGIN

if (cd_versao_tiss_w >= '3.01.00') then
	select 	max(sg_conselho)
	into STRICT 	sg_conselho_w
	from 	tiss_conselho_profissional
	where 	cd_conselho = sg_conselho_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_conselho_ww
	from	conselho_profissional
	where	upper(coalesce(ie_conselho_prof_tiss, sg_conselho)) = upper(sg_conselho_w);
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_conselho_ww
	from	conselho_profissional
	where	upper(coalesce(ie_conselho_prof_tiss, sg_conselho)) = upper(sg_conselho_p);
end if;
return nr_seq_conselho_ww;
end;


begin

select	coalesce(nr_seq_prestador,''),
	b.ie_tipo_guia
into STRICT	nr_seq_prestador_w,
	ie_tipo_guia_w
from	pls_conta	b,
	pls_conta_proc	a
where	b.nr_sequencia	= a.nr_seq_conta
and	a.nr_sequencia	= nr_seq_procedimento_p;

open C01;
loop
fetch C01 into
	nr_seq_participante_w,
	cd_medico_w,
	cd_medico_imp_w,
	nr_seq_grau_partic_w,
	ie_funcao_medico_imp_w,
	nr_seq_cbo_saude_w,
	cd_cbo_saude_imp_w,
	sg_conselho_imp_w,
	nr_seq_conselho_w,
	cd_grau_partic_imp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_participante_w	:= 'S';
	if (ie_tipo_consiste_p	= 'CC') then
		if (coalesce(nr_seq_grau_partic_w::text, '') = '') then
			CALL pls_gravar_conta_glosa('2603', null, nr_seq_procedimento_p, null, 'N',
						'Grau de participação inválido', nm_usuario_p, 'A',
						ie_tipo_consiste_p, nr_seq_prestador_w, cd_estabelecimento_p, '',null);
		end if;

		if (coalesce(nr_seq_conselho_w::text, '') = '') then
			CALL pls_gravar_conta_glosa('9915', null, nr_seq_procedimento_p, null, 'N',
						'Conselho profissional não informado', nm_usuario_p, 'A',
						ie_tipo_consiste_p, nr_seq_prestador_w, cd_estabelecimento_p, '',null);
		end if;
	elsif (ie_tipo_consiste_p	= 'IA') then

		if (nr_seq_procedimento_p IS NOT NULL AND nr_seq_procedimento_p::text <> '') then
			select	max(a.cd_versao_tiss)
			into STRICT	cd_versao_tiss_w
			from	pls_protocolo_conta a,
				pls_conta b,
				pls_conta_proc c
			where	a.nr_sequencia = b.nr_seq_protocolo
			and	b.nr_sequencia = c.nr_seq_conta
			and	c.nr_sequencia = nr_seq_procedimento_p;
		end if;

		/*Restringindo pelo status do grau de participação,  Diogo OS 545478*/

		if (cd_versao_tiss_w >= '3.01.00') then
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_grau_partic_w
			from	pls_grau_participacao
			where	cd_tiss			= cd_grau_partic_imp_w
			and	cd_estabelecimento	= cd_estabelecimento_p
			and	ie_situacao		= 'A';
		else
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_grau_partic_w
			from	pls_grau_participacao
			where	cd_tiss			= ie_funcao_medico_imp_w
			and	cd_estabelecimento	= cd_estabelecimento_p
			and	ie_situacao		= 'A';
		end if;

		if (nr_seq_grau_partic_w	= 0) or (coalesce(nr_seq_grau_partic_w::text, '') = '') then
			CALL pls_gravar_conta_glosa('2603', null, nr_seq_procedimento_p, null, 'N',
						'Grau de participação inválido', nm_usuario_p, 'A',
						ie_tipo_consiste_p, nr_seq_prestador_w, cd_estabelecimento_p, '', null);
		end if;

		nr_seq_conselho_prof_w:= obter_seq_conselho(sg_conselho_imp_w);

		if (coalesce(nr_seq_conselho_prof_w,0) = 0) then
			CALL pls_gravar_conta_glosa('9915', null, nr_seq_procedimento_p, null, 'N',
						'Conselho profissional não informado ou não existente no padrão TISS.', nm_usuario_p, 'A',
						ie_tipo_consiste_p, nr_seq_prestador_w, cd_estabelecimento_p, '',null);
		end if;
	end if;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consiste_participante (( nr_seq_procedimento_p bigint, ie_tipo_consiste_p text, nm_usuario_p text, cd_estabelecimento_p bigint) is nr_seq_prestador_w bigint) FROM PUBLIC;

