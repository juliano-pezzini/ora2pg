-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_virada_estoque ( nm_usuario_p text, dt_atualizacao_p timestamp, ds_erro_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


-- Informações da regra
ds_titulo_w		varchar(80);
ds_comunicacao_w	varchar(2000);
cd_setor_atendimento_w	integer;
nm_usuarios_adic_w	varchar(255);
cd_perfil_w		integer;
ie_ci_lida_w		varchar(1);

-- Informações da virada
dt_mesano_referencia_w	timestamp;
qt_registro_w		bigint;
nm_usuario_w		varchar(15);
dt_atualizacao_w	timestamp;
ds_log_w		varchar(255);

C01 CURSOR FOR
	SELECT	a.ds_titulo,
		a.ds_comunicacao,
		a.cd_setor_destino,
		a.nm_usuarios_adic,
		a.cd_perfil,
		a.ie_ci_lida
	from	regra_envio_comunic_evento a,
		regra_envio_comunic_compra b
	where	b.nr_sequencia = a.nr_seq_regra
	and	a.cd_evento = 59
	and	b.cd_funcao = 143
	and	a.ie_situacao = 'A'
	and	b.cd_estabelecimento = cd_estabelecimento_p
	and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,0,'X',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';


BEGIN

select 	max(dt_mesano_referencia) dt_mes,
	count(*) qt_registro
into STRICT	dt_mesano_referencia_w,
	qt_registro_w
from   	saldo_estoque
where  	cd_estabelecimento = cd_estabelecimento_p;

nm_usuario_w 		:= nm_usuario_p;
dt_atualizacao_w 	:= dt_atualizacao_p;
ds_log_w		:= ds_erro_p;

open C01;
loop
fetch C01 into
	ds_titulo_w,
	ds_comunicacao_w,
	cd_setor_atendimento_w,
	nm_usuarios_adic_w,
	cd_perfil_w,
	ie_ci_lida_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@dt_mes', PKG_DATE_FORMATERS.to_varchar(dt_mesano_referencia_w, 'shortDate', cd_estabelecimento_p, nm_usuario_p)),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@qt_registro', qt_registro_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@nm_usuario', nm_usuario_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@dt_atualizacao', PKG_DATE_FORMATERS.to_varchar(dt_atualizacao_w, 'shortDate', cd_estabelecimento_p, nm_usuario_p)),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@ds_log', ds_log_w),1,80);

	ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@dt_mes', PKG_DATE_FORMATERS.to_varchar(dt_mesano_referencia_w, 'shortDate', cd_estabelecimento_p, nm_usuario_p)),1,2000);
	ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@qt_registro', qt_registro_w),1,2000);
	ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nm_usuario', nm_usuario_w),1,2000);
	ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@dt_atualizacao', PKG_DATE_FORMATERS.to_varchar(dt_atualizacao_w, 'shortDate', cd_estabelecimento_p, nm_usuario_p)),1,2000);
	ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_log', ds_log_w),1,2000);

	insert	into comunic_interna(
			cd_estab_destino,
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			nr_sequencia,
			ie_gerencial,
			dt_liberacao)
	values (		cd_estabelecimento_p,
			clock_timestamp(),
			ds_titulo_w,
			ds_comunicacao_w,
			nm_usuario_p,
			clock_timestamp(),
			'N',
			nm_usuarios_adic_w,
			nextval('comunic_interna_seq'),
			'N',
			clock_timestamp());
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_virada_estoque ( nm_usuario_p text, dt_atualizacao_p timestamp, ds_erro_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

