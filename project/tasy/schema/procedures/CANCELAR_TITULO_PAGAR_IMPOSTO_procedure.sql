-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_titulo_pagar_imposto (nr_titulo_origem_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_titulo_w					bigint;
vl_Titulo_w					double precision;
cd_moeda_w					integer;
nr_seq_baixa_w					bigint;
nr_seq_nota_w					bigint;
cd_estabelecimento_w				bigint;
cd_tipo_baixa_devolucao_w			bigint;

C01 CURSOR FOR 
SELECT 	nr_titulo, 
	vl_titulo, 
	cd_moeda, 
	nr_seq_nota_fiscal 
from 	titulo_pagar a 
where 	a.nr_titulo_original		= nr_titulo_origem_p 
-- and	a.dt_vencimento_original	<> dt_vencimento_orig_w 	Edgar 14/05/2008 OS 93014 não entendi o porquê disso ??? 
and  	coalesce(a.dt_liquidacao::text, '') = '';


BEGIN 
 
/* 
select	dt_vencimento_original 
into	dt_vencimento_orig_w 
from	titulo_pagar 
where	nr_titulo			= nr_titulo_origem_p; 
*/
 
 
select	cd_estabelecimento, 
	nr_seq_nota_fiscal 
into STRICT	cd_estabelecimento_w, 
	nr_seq_nota_w			-- Edgar 23/06/2008 OS 96336, só trazer o tipo de baixa de dev se for NF 
from	titulo_pagar 
where	nr_titulo			= nr_titulo_origem_p;
 
select	coalesce(max(cd_tipo_baixa_devolucao), 2) 
into STRICT	cd_tipo_baixa_devolucao_w 
from	parametros_contas_pagar 
where	cd_estabelecimento		= cd_estabelecimento_w 
and	(nr_seq_nota_w IS NOT NULL AND nr_seq_nota_w::text <> '');
 
open	c01;
loop 
fetch	c01 into 
	nr_titulo_w, 
	vl_titulo_w, 
	cd_moeda_w, 
	nr_seq_nota_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	begin 
	select (coalesce(max(nr_sequencia),0) + 1) 
	into STRICT nr_seq_baixa_w 
	from titulo_pagar_baixa 
	where nr_titulo	= nr_titulo_w;
	exception 
		when others then 
			nr_seq_baixa_w	:= 1;
	end;
	 
	Insert into Titulo_Pagar_Baixa( 
		NR_TITULO, 
		NR_SEQUENCIA,      
		DT_BAIXA,        
		CD_MOEDA,        
		DT_ATUALIZACAO,     
		NM_USUARIO,       
		CD_TIPO_BAIXA,      
		IE_ACAO,         
		VL_DESCONTOS, 
		VL_OUTRAS_DEDUCOES, 
		VL_JUROS, 
		VL_MULTA,        
		VL_OUTROS_ACRESCIMOS,  
		VL_PAGO,         
		VL_BAIXA,        
		VL_DEVOLUCAO,      
		NR_SEQ_DEVOLUCAO) 
	values ( 
		nr_titulo_w, 
		nr_seq_baixa_w, 
		clock_timestamp(), 
		cd_moeda_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_tipo_baixa_devolucao_w,			/* Estorno de nota Fiscal */
 
		'I',       				/* ação Baixa */
 
		0,0,0,0,0,0, 
		vl_titulo_w, 
		vl_titulo_w, 
		nr_seq_nota_w);
		 
	CALL gerar_alerta_baixa_tit_pagar(nr_titulo_w,nr_seq_baixa_w,cd_estabelecimento_w,nm_usuario_p);
 
	update 	titulo_pagar 
	set 	vl_saldo_titulo = vl_saldo_titulo - vl_titulo_w, 
		ie_situacao = 'C', 
		dt_liquidacao = clock_timestamp() 
    where nr_titulo = nr_titulo_w;
 
	end;
end loop;
close c01;
 
/*commit; - Retirado por Fabio pois esta rotina acaba sendo chamada no estorno da NF*/
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_titulo_pagar_imposto (nr_titulo_origem_p bigint, nm_usuario_p text) FROM PUBLIC;

