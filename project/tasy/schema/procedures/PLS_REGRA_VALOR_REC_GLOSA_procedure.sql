-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_regra_valor_rec_glosa ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

 
nr_seq_protocolo_w		pls_rec_glosa_protocolo.nr_sequencia%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
dt_apresent_prot_w			pls_rec_glosa_protocolo.dt_apresentacao_lote%type;
vl_liberado_w			pls_conta_proc.vl_liberado%type;
vl_calculado_w			pls_conta_proc.vl_procedimento%type;
ie_status_w			pls_analise_conta.ie_status%type;
qt_itens_pendentes_w		integer;
ie_libera_w			varchar(1);
ie_encaminha_prot_w		varchar(2);
qt_regra_glosa_w			bigint;

C01 CURSOR(	nr_seq_prestador_pc	pls_prestador.nr_sequencia%type, 
		dt_recurso_pc		pls_rec_glosa_protocolo.dt_apresentacao_lote%type, 
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR 
	SELECT	ie_valor_rec_calculado, 
		ie_acao, 
		ds_justificativa, 
		nr_sequencia, 
		nr_seq_motivo_glosa 
	from	pls_rec_regra_valor 
	where	dt_recurso_pc between dt_inicio_vigencia_ref and dt_fim_vigencia_ref 
	and	((nr_seq_prestador = nr_seq_prestador_pc) or (coalesce(nr_seq_prestador::text, '') = '')) 
	and	cd_estabelecimento = cd_estabelecimento_pc 
	order by 
		nr_seq_prestador, 
		ie_valor_rec_calculado;
		
C02 CURSOR(	nr_seq_analise_pc	pls_analise_conta.nr_sequencia%type) FOR 
	SELECT	b.nr_seq_conta_rec, 
		b.nr_sequencia nr_seq_proc_rec, 
		null nr_seq_mat_rec, 
		b.nr_seq_conta_proc, 
		null nr_seq_conta_mat 
	from	pls_rec_glosa_conta a, 
		pls_rec_glosa_proc b 
	where	a.nr_sequencia = b.nr_seq_conta_rec 
	and	a.nr_seq_analise = nr_seq_analise_pc 
	
union all
 
	SELECT	b.nr_seq_conta_rec, 
		null nr_seq_proc_rec, 
		b.nr_sequencia nr_seq_mat_rec, 
		null nr_seq_conta_proc, 
		b.nr_seq_conta_mat 
	from	pls_rec_glosa_conta a, 
		pls_rec_glosa_mat b 
	where	a.nr_sequencia = b.nr_seq_conta_rec 
	and	a.nr_seq_analise = nr_seq_analise_pc;
	
C03 CURSOR(	nr_seq_analise_pc	pls_analise_conta.nr_sequencia%type) FOR 
	SELECT	nr_sequencia 
	from	pls_rec_glosa_conta 
	where	nr_seq_analise = nr_seq_analise_pc;

BEGIN 
select	max(nr_seq_protocolo) 
into STRICT	nr_seq_protocolo_w 
from	pls_rec_glosa_conta 
where	nr_seq_analise = nr_seq_analise_p;
 
select	max(nr_seq_prestador), 
	max(dt_apresentacao_lote) 
into STRICT	nr_seq_prestador_w, 
	dt_apresent_prot_w 
from	pls_rec_glosa_protocolo 
where	nr_sequencia = nr_seq_protocolo_w;
 
for r_C01_w in C01(nr_seq_prestador_w, dt_apresent_prot_w, cd_estabelecimento_p) loop 
		 
	for r_C02_w in C02(nr_seq_analise_p) loop 
		 
		ie_libera_w := 'N';
		 
		if (r_C01_w.ie_valor_rec_calculado = 'S') then 
			if (r_C02_w.nr_seq_conta_proc IS NOT NULL AND r_C02_w.nr_seq_conta_proc::text <> '') then 
				select	vl_liberado, 
					vl_procedimento 
				into STRICT	vl_liberado_w, 
					vl_calculado_w 
				from	pls_conta_proc 
				where	nr_sequencia = r_C02_w.nr_seq_conta_proc;
				 
				if (vl_liberado_w = vl_calculado_w) then 
					ie_libera_w := 'S';
				end if;
			else 
				select	vl_liberado, 
					vl_material 
				into STRICT	vl_liberado_w, 
					vl_calculado_w 
				from	pls_conta_mat 
				where	nr_sequencia = r_C02_w.nr_seq_conta_mat;
				 
				if (vl_liberado_w = vl_calculado_w) then 
					ie_libera_w := 'S';
				end if;
			end if;
		else 
			ie_libera_w := 'S';
		end if;
		 
		if (ie_libera_w = 'S') then 
			if (r_C01_w.nr_seq_motivo_glosa IS NOT NULL AND r_C01_w.nr_seq_motivo_glosa::text <> '') then 
					ie_libera_w := 'N';
					 
					select 	count(1) 
					into STRICT	qt_regra_glosa_w 
					from	pls_rec_glosa_glosas 
					where	((nr_seq_proc_rec 	= r_C02_w.nr_seq_proc_rec AND r_C02_w.nr_seq_proc_rec IS NOT NULL AND r_C02_w.nr_seq_proc_rec::text <> '') 
					or		(nr_seq_mat_rec 	= r_C02_w.nr_seq_mat_rec AND r_C02_w.nr_seq_mat_rec IS NOT NULL AND r_C02_w.nr_seq_mat_rec::text <> '')) 
					and		nr_seq_motivo_glosa = r_C01_w.nr_seq_motivo_glosa;
					 
					if (qt_regra_glosa_w > 0) then 
						ie_libera_w := 'S';
					end if;
			end if;
		end if;
		 
		if (ie_libera_w = 'S') then 
			CALL pls_acao_item_recurso(	nr_seq_analise_p, r_C02_w.nr_seq_conta_rec, r_C02_w.nr_seq_proc_rec, 
						r_C02_w.nr_seq_mat_rec, r_C01_w.nr_sequencia, r_C01_w.ds_justificativa, 
						nm_usuario_p, r_C01_w.ie_acao);
		end if;
	end loop;
end loop;
 
select 	sum(qt_item) 
into STRICT	qt_itens_pendentes_w 
from ( 
	SELECT	count(1) qt_item 
	from	pls_rec_glosa_conta a, 
		pls_rec_glosa_proc b 
	where	a.nr_sequencia = b.nr_seq_conta_rec 
	and	a.nr_seq_analise = nr_seq_analise_p 
	and	not exists (	SELECT	1 
				from	pls_analise_parecer_rec c 
				where	c.nr_seq_proc_rec = b.nr_sequencia) 
	
union all
 
	select	count(1) qt_item 
	from	pls_rec_glosa_conta a, 
		pls_rec_glosa_mat b 
	where	a.nr_sequencia = b.nr_seq_conta_rec 
	and	a.nr_seq_analise = nr_seq_analise_p 
	and	not exists (	select	1 
				from	pls_analise_parecer_rec c 
				where	c.nr_seq_mat_rec = b.nr_sequencia)) alias5;
				 
if (qt_itens_pendentes_w = 0) then 
 
	CALL pls_alterar_status_analise_cta(nr_seq_analise_p, 'T', 'PLS_REGRA_VALOR_REC_GLOSA', nm_usuario_p, cd_estabelecimento_p);
	 
	select	ie_status 
	into STRICT	ie_status_w 
	from	pls_analise_conta 
	where	nr_sequencia = nr_seq_analise_p;
	 
	if (ie_status_w = 'T') then 
	 
		ie_encaminha_prot_w := obter_valor_param_usuario(1349, 2, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p);
	 
		for r_C03_w in C03(nr_seq_analise_p) loop 
			CALL pls_fechar_rec_glosa_conta( r_C03_w.nr_sequencia, null, nm_usuario_p, cd_estabelecimento_p, ie_encaminha_prot_w );
		end loop;
		 
		CALL pls_atualizar_grupo_penden(nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p);
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_regra_valor_rec_glosa ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

