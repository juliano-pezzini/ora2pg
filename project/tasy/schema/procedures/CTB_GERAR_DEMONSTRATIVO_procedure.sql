-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_demonstrativo ( nr_seq_demo_p bigint, ie_acumular_p text, ie_calcular_fixo_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_mes_ref_w		bigint;
nr_seq_col_w			bigint;
nr_seq_tipo_w			bigint;
nr_seq_coluna_w			smallint;
nr_seq_rubrica_w		bigint;
ie_origem_valor_w		varchar(10);
ds_origem_w			varchar(4000);
ds_divisor_w			varchar(4000);
qt_coluna_w			smallint;
qt_coluna_ww			smallint;
vl_referencia_w			double precision;
ie_valor_w			varchar(10);
cd_estabelecimento_w		bigint;
nr_seq_unid_neg_w		bigint;
qt_existe_base_w		integer;
nr_divisor_mes_w		bigint;
ie_calcular_fixo_w		varchar(15)	:= 'S';
nr_seq_apres_w			bigint;
ie_gerar_w			varchar(2);
dt_mes_inicial_w		timestamp;

c01 CURSOR FOR
SELECT	nr_sequencia,
	nr_seq_coluna,
	ie_valor,
	nr_seq_mes_ref,
	coalesce(nr_divisor_mes,0),
	ctb_obter_mes_ref(nr_seq_mes_inicial) dt_mes_inicial
from	ctb_demo_mes
where	nr_seq_demo	= nr_seq_demo_p
order by nr_seq_coluna;

c02 CURSOR FOR
SELECT	nr_sequencia,
	ie_origem_valor,
	ds_origem,
	ds_divisor,
	nr_seq_apres
from	ctb_modelo_rubrica
where	nr_seq_modelo	= nr_seq_tipo_w
and	ie_situacao	= 'A'
and	ie_origem_valor not in ('F','I')
and	ie_calcular_fixo_w = 'N'

union all

SELECT	nr_sequencia,
	ie_origem_valor,
	ds_origem,
	ds_divisor,
	nr_seq_apres
from	ctb_modelo_rubrica
where	nr_seq_modelo	= nr_seq_tipo_w
and	ie_situacao	= 'A'
and	ie_origem_valor <> 'I'
and	ie_calcular_fixo_w = 'EI'

union all

select	nr_sequencia,
	ie_origem_valor,
	ds_origem,
	ds_divisor,
	nr_seq_apres
from	ctb_modelo_rubrica
where	nr_seq_modelo	= nr_seq_tipo_w
and	ie_situacao	= 'A'
and	ie_calcular_fixo_w = 'S'
order by nr_seq_apres;


BEGIN

select	count(*),
	max(nr_seq_coluna)
into STRICT	qt_coluna_w,
	qt_coluna_ww
from	ctb_demo_mes
where	nr_seq_demo	= nr_seq_demo_p;

if (qt_coluna_w = 0) or (qt_coluna_w <> qt_coluna_ww) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(233821);
end if;

ie_calcular_fixo_w	:= coalesce(ie_calcular_fixo_p,'S');

if (ie_calcular_fixo_w = 'N') then
	begin
	delete	FROM ctb_demo_rubrica a
	where 	a.nr_seq_demo		= nr_seq_demo_p
	and	not exists (	SELECT	1
			from	ctb_modelo_rubrica y
			where	y.nr_sequencia	= a.nr_seq_rubrica
			and	y.ie_origem_valor in ('F','I'));
	commit;	
	end;
elsif (ie_calcular_fixo_w = 'S') then
	begin
	delete	FROM ctb_demo_rubrica
	where 	nr_seq_demo = nr_seq_demo_p;
	commit;	
	end;
elsif (ie_calcular_fixo_w = 'EI') then
	begin
	delete	FROM ctb_demo_rubrica a
	where 	a.nr_seq_demo		= nr_seq_demo_p
	and	not exists (	SELECT	1
			from	ctb_modelo_rubrica y
			where	y.nr_sequencia	= a.nr_seq_rubrica
			and	y.ie_origem_valor = 'I');
	commit;
	end;
end if;

select	nr_seq_tipo,
	cd_estabelecimento,
	nr_seq_unid_neg
into STRICT	nr_seq_tipo_w,
	cd_estabelecimento_w,
	nr_seq_unid_neg_w
from	ctb_demonstrativo
where	nr_sequencia	= nr_seq_demo_p;

open	c01;
loop
fetch	c01
into	nr_seq_col_w,
	nr_seq_coluna_w,
	ie_valor_w,
	nr_seq_mes_ref_w,
	nr_divisor_mes_w,
	dt_mes_inicial_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	open	c02;
	loop
	fetch	c02
	into	nr_seq_rubrica_w,
		ie_origem_valor_w,
		ds_origem_w,
		ds_divisor_w,
		nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		vl_referencia_w	:= 0;
		if (ie_valor_w = 'S')	or (ie_valor_w = 'SC')	or (ie_valor_w = 'OM')	or (ie_valor_w = 'OA')	or (ie_valor_w = 'M')	or (ie_valor_w = 'MCSE')	or (ie_valor_w = 'MA')	then

			if (ie_valor_w = 'MA') and (ie_origem_valor_w = 'MD') then
				ie_origem_valor_w := 'MAD';
			elsif (ie_valor_w = 'MA') and (ie_origem_valor_w = 'MC') then
				ie_origem_valor_w := 'MAC';
			else
				ie_origem_valor_w	:= ie_valor_w;
			end if;
		end if;

		select	nextval('ctb_demo_rubrica_seq')
		into STRICT	nr_sequencia_w
		;
		if (ie_valor_w in ('V','P')) or (ie_origem_valor_w = 'I') or
			((coalesce(nr_seq_mes_ref_w::text, '') = '') and (ie_origem_valor_w <> 'A')) then
			vl_referencia_w	:= 0;
		elsif (ie_origem_valor_w in ('IS','ISC','IM','IMA','IMD','IMC','IMAD','IMAC','IMCSE','IMASE','S','SC','M','MA','MD','MC','MAD','MAC','MCSE','MASE')) then
			select	ctb_obter_valor_conta(nr_seq_mes_ref_w, ds_origem_w, cd_estabelecimento_w, nr_seq_unid_neg_w, ie_origem_valor_w, dt_mes_inicial_w, nr_seq_demo_p)
			into STRICT	vl_referencia_w
			;
		elsif (ie_origem_valor_w in ('OM','OA')) then
			select	ctb_obter_valor_conta_orc(nr_seq_mes_ref_w, ds_origem_w, cd_estabelecimento_w, nr_seq_unid_neg_w, ie_origem_valor_w, nr_seq_demo_p)
			into STRICT	vl_referencia_w
			;
		elsif (ie_origem_valor_w in ('SV','ME')) then
			vl_referencia_w	:= null;
		elsif (ie_origem_valor_w = 'F') then
			begin
			vl_referencia_w	:= (ds_origem_w)::numeric;
			exception when others then
				vl_referencia_w	:= 0;
			end;
		end if;

		if (coalesce(nr_divisor_mes_w,0) <> 0) then
			vl_referencia_w	:= dividir(vl_referencia_w, nr_divisor_mes_w);
		end if;

		select  ctb_gerar_rubrica_excl(nr_seq_col_w,nr_seq_demo_p)
		into STRICT	ie_gerar_w
		;

		if (ie_gerar_w = 'N') then
			vl_referencia_w := 0;
		end if;

		insert into ctb_demo_rubrica(
			nr_sequencia,
			nr_seq_demo,
			nr_seq_col,
			dt_atualizacao,
			nm_usuario,
			nr_seq_rubrica,
			nr_seq_mes_ref,
			vl_referencia)
		values (nr_sequencia_w,
			nr_seq_demo_p,
			nr_seq_col_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_rubrica_w,
			nr_seq_mes_ref_w,
			vl_referencia_w);

	end loop;
	close c02;

end loop;
close c01;

if (ie_acumular_p = 'S') then
	CALL ctb_acumular_demo(nr_seq_demo_p, nm_usuario_p);
end if;

CALL ctb_calc_demo_var_per(nr_seq_demo_p, nm_usuario_p);
CALL ctb_analise_vertical(nr_seq_demo_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_demonstrativo ( nr_seq_demo_p bigint, ie_acumular_p text, ie_calcular_fixo_p text, nm_usuario_p text) FROM PUBLIC;

