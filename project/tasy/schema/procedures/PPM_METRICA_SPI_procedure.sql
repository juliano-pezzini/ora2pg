-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_metrica_spi ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE

			
dt_ref_inicio_w 		timestamp;
dt_ref_fim_w 		timestamp;
dt_referencia_w		timestamp;
resultado_w		double precision;
ev_w			double precision;
pv_w			double precision;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;
nm_usuario_grupo_w	varchar(15);

nr_seq_acumulado_w	ppm_objetivo_result.nr_sequencia%type;
vl_montante_w		double precision;
vl_individual_w		double precision;
vl_calculado_w		double precision;
dt_fim_ano_w		timestamp;


BEGIN

select	max(nr_seq_gerencia),
	max(nr_seq_grupo),
	max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta		= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

dt_ref_inicio_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');
dt_referencia_w	:= trunc(dt_referencia_p,'dd');

if (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then
	select	round((avg(pmo_obter_dados_bsc(y.nr_sequencia, 'SPI', 'PROJ')))::numeric, 2) spi
	into STRICT	resultado_w
	from	dashboard_pmo_proj_graf x,
		proj_projeto y
	where	x.nr_seq_proj = y.nr_sequencia
	and	trunc(x.dt_referencia,'dd') between dt_ref_inicio_w and dt_ref_fim_w
	and	y.nr_seq_gerencia in (SELECT	x.nr_sequencia
		from	gerencia_wheb x
		where	x.nr_seq_diretoria	= nr_seq_diretoria_w)
	and	y.nr_seq_estagio <> 44;

elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then
	select	round((avg(pmo_obter_dados_bsc(y.nr_sequencia, 'SPI', 'PROJ')))::numeric, 2) spi
	into STRICT	resultado_w
	from	dashboard_pmo_proj_graf x,
		proj_projeto y
	where	x.nr_seq_proj = y.nr_sequencia
	and	trunc(x.dt_referencia,'dd') between dt_ref_inicio_w and dt_ref_fim_w
	and	y.nr_seq_gerencia = nr_seq_gerencia_w
	and	y.nr_seq_estagio <> 44;

elsif (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
	select	round((avg(pmo_obter_dados_bsc(y.nr_sequencia, 'SPI', 'PROJ')))::numeric, 2) spi
	into STRICT	resultado_w
	from	dashboard_pmo_proj_graf x,
		proj_projeto y
	where	x.nr_seq_proj = y.nr_sequencia
	and	trunc(x.dt_referencia,'dd') between dt_ref_inicio_w and dt_ref_fim_w
	and	y.nr_seq_grupo_des = nr_seq_grupo_w
	and	y.nr_seq_estagio <> 44;

elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	nm_usuario_grupo_w	:=	substr(obter_usuario_pessoa(cd_pessoa_fisica_p),1,15);
	
	select	round((avg(pmo_obter_dados_bsc(y.nr_sequencia, 'SPI', 'PROJ')))::numeric, 2) spi
	into STRICT	resultado_w
	from	dashboard_pmo_proj_graf x,
		proj_projeto y			
	where	x.nr_seq_proj = y.nr_sequencia
	and	exists (SELECT	1
			from	proj_ordem_servico a,
				man_ordem_serv_ativ b 
			where	y.nr_sequencia = a.nr_seq_proj
			and	a.nr_seq_ordem = b.nr_seq_ordem_serv 
			and	b.nm_usuario_exec = nm_usuario_grupo_w
			and exists (	select	1
					from	proj_equipe pe,
						proj_equipe_papel pp
					where	y.nr_sequencia = pe.nr_seq_proj
					and	pe.nr_sequencia = pp.nr_seq_equipe
					and	pp.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and	trunc(x.dt_referencia,'dd') between dt_ref_inicio_w and dt_ref_fim_w       
	and	y.nr_seq_estagio <> 44;	

end if;

pv_w := 0;
ev_w := 0;

CALL ppm_gravar_resultado(nr_seq_objetivo_metrica_p,dt_referencia_p,resultado_w, pv_w, ev_w, nm_usuario_p);


/*'Recalculo do acumulado'*/

dt_fim_ano_w	:= PKG_DATE_UTILS.end_of(to_date('31/12/' || to_char(dt_referencia_w,'yyyy'),'dd/mm/yyyy'),'DAY');

select	max(nr_sequencia)
into STRICT	nr_seq_acumulado_w
from	ppm_objetivo_result a
where	a.nr_seq_metrica	= nr_seq_objetivo_metrica_p
and	dt_referencia	= dt_fim_ano_w;

if (nr_seq_acumulado_w > 0) then
	select	coalesce(sum(vl_montante),0),
		coalesce(sum(vl_individual),0)
	into STRICT	vl_montante_w,
		vl_individual_w
	from	ppm_objetivo_result a
	where	a.nr_seq_metrica = nr_seq_objetivo_metrica_p
	and	trunc(a.dt_referencia,'year') = trunc(dt_referencia_w,'year')
	and	a.nr_sequencia	<> nr_seq_acumulado_w;

	vl_calculado_w	:= dividir(vl_individual_w, vl_montante_w);

	update	ppm_objetivo_result
	set	vl_resultado_calc 	= coalesce(vl_calculado_w,0),
		vl_montante	= coalesce(vl_montante_w,0),
		vl_individual	= coalesce(vl_individual_w,0)
	where	nr_sequencia 	= nr_seq_acumulado_w;
end if;

/*'Ja tinha commit na ppm_gravar_resultado'*/

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_metrica_spi ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

