-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cota_item_licitacao (nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint, qt_cota_p bigint, qt_restante_p bigint, ds_justificativa_p text, nm_usuario_p text) AS $body$
BEGIN
if (coalesce(nr_seq_licitacao_p,0) > 0) and (coalesce(nr_seq_lic_item_p,0) > 0) then
insert into reg_lic_item(
		nr_seq_licitacao,
		nr_seq_lic_item,
		nm_usuario,
		dt_atualizacao,
		qt_item,
		cd_material,
		ds_justificativa,
		vl_percentual,
		cd_unid_medida,
		ie_cota_reservada,
		vl_maximo_edital,
		vl_total_item,
		pr_inflacao,
		nr_lote_compra,
		nr_seq_proj_rec,
		ds_adicional)
SELECT	nr_seq_licitacao,
		(select coalesce(max(nr_seq_lic_item),0)+1 from reg_lic_item where nr_seq_licitacao = nr_seq_licitacao_p),
		nm_usuario_p,
		clock_timestamp(),
		qt_cota_p,
		cd_material,
		ds_justificativa_p,
		(100/qt_item*qt_cota_p),
		cd_unid_medida,
		'S',
		vl_maximo_edital,
		(coalesce(qt_cota_p,0) * coalesce(vl_maximo_edital,0)),
		pr_inflacao,
		nr_lote_compra,
		nr_seq_proj_rec,
		ds_adicional
from	reg_lic_item
where	nr_seq_licitacao = nr_seq_licitacao_p
and		nr_seq_lic_item = nr_seq_lic_item_p;

update	reg_lic_item
set		qt_item = qt_restante_p,
		ds_justificativa = ds_justificativa_p,
		vl_percentual = (100/qt_item*qt_restante_p),
		ie_cota_reservada = 'N'
where 	nr_seq_licitacao = nr_seq_licitacao_p
and 	nr_seq_lic_item = nr_seq_lic_item_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cota_item_licitacao (nr_seq_licitacao_p bigint, nr_seq_lic_item_p bigint, qt_cota_p bigint, qt_restante_p bigint, ds_justificativa_p text, nm_usuario_p text) FROM PUBLIC;

