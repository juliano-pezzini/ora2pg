-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_historico_pagador ( ie_opcao_p bigint, nr_sequencia_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_endereco_boleto_p text, ie_tipo_pagador_p text, ie_envia_cobranca_p text, cd_sistema_anterior_p text, dt_primeira_mensalidade_p timestamp, nr_seq_destino_corresp_p bigint, ie_calc_primeira_mens_p text, ie_calculo_proporcional_p text, ie_pessoa_comprovante_p text, ie_notificacao_p text, ie_taxa_emissao_boleto_p text, ie_inadimplencia_via_adic_p text, nr_seq_classif_itens_p bigint, ds_email_p text, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, dt_dia_vencimento_p bigint, nr_seq_forma_cobranca_p text, ie_mes_vencimento_p text, cd_condicao_pagamento_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, nr_seq_conta_banco_p bigint, nr_seq_carteira_cobr_p bigint, cd_autenticidade_p text, ie_portador_exclusivo_p text, cd_banco_p bigint, cd_agencia_bancaria_p text, ie_digito_agencia_p text, cd_conta_p text, ie_digito_conta_p text, nr_seq_empresa_p bigint, cd_profissao_p bigint, nr_seq_vinculo_empresa_p bigint, cd_matricula_p text, ie_geracao_nota_titulo_p text, ie_destacar_reajuste_p text, ie_gerar_cobr_escrit_p text, ds_observacao_p text, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

/*
ie_opcao_p
1 = Pagador
2 = Informação financeira pagador
*/
ds_alteracao_w			varchar(4000);
ds_retorno_antigo_w		varchar(4000);
ds_retorno_novo_w		varchar(4000);
ds_titulo_w			varchar(255);
nr_seq_pagador_w		bigint;

cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
ie_endereco_boleto_w		varchar(4);
ie_tipo_pagador_w		varchar(1);
ie_envia_cobranca_w		varchar(1);
dt_primeira_mensalidade_w	timestamp;
ie_calc_primeira_mens_w		varchar(1);
ie_calculo_proporcional_w	varchar(1);
ie_pessoa_comprovante_w		varchar(2);
ie_notificacao_w		varchar(2);
ie_taxa_emissao_boleto_w	varchar(2);
ie_inadimplencia_via_adic_w	varchar(1);
nr_seq_classif_itens_w		bigint;
nm_pessoa_nova_w		varchar(255);
nm_pessoa_antiga_w		varchar(255);
ds_endereco_boleto_antigo_w	varchar(255);
ds_endereco_boleto_novo_w	varchar(255);

cd_sistema_anterior_w		varchar(30);
dt_inicio_vigencia_w		timestamp;
nr_seq_destino_corresp_w	bigint;
dt_fim_vigencia_w		timestamp;
dt_dia_vencimento_w		smallint;
nr_seq_forma_cobranca_w		varchar(2);
ie_mes_vencimento_w		varchar(1);
cd_condicao_pagamento_w		bigint;
cd_tipo_portador_w		integer;
cd_portador_w			bigint;
nr_seq_conta_banco_w		bigint;
nr_seq_carteira_cobr_w		bigint;
cd_autenticidade_w		varchar(10);
ie_portador_exclusivo_w		varchar(1);
cd_banco_w			integer;
cd_agencia_bancaria_w		varchar(8);
ie_digito_agencia_w		varchar(1);
cd_conta_w			varchar(20);
ie_digito_conta_w		varchar(1);
nr_seq_empresa_w		bigint;
cd_profissao_w			bigint;
nr_seq_vinculo_empresa_w	bigint;
cd_matricula_w			varchar(20);
ie_geracao_nota_titulo_w	varchar(2);
ie_destacar_reajuste_w		varchar(1);
ie_gerar_cobr_escrit_w		varchar(2);
ds_observacao_w			varchar(4000);
qt_registro_w			bigint;
ds_destino_anterior_w		varchar(255);
ds_destino_novo_w		varchar(255);
ds_classif_item_anterior_w	varchar(255);
ds_classif_item_novo_w		varchar(255);
ds_cart_bancaria_anterior_w	varchar(255);
ds_cart_bancaria_novo_w		varchar(255);
ds_email_w			pls_contrato_pagador.ds_email%type;


BEGIN

if (ie_opcao_p = 1) then
	select	count(1)
	into STRICT	qt_registro_w
	from	pls_contrato_pagador
	where	nr_sequencia	= nr_sequencia_p;

	if (qt_registro_w > 0) then
		select	cd_pessoa_fisica,
			cd_cgc,
			ie_endereco_boleto,
			ie_tipo_pagador,
			ie_envia_cobranca,
			cd_sistema_anterior,
			dt_primeira_mensalidade,
			nr_seq_destino_corresp,
			ie_calc_primeira_mens,
			ie_calculo_proporcional,
			ie_pessoa_comprovante,
			ie_notificacao,
			ie_taxa_emissao_boleto,
			ie_inadimplencia_via_adic,
			nr_seq_classif_itens,
			obter_nome_pf_pj(cd_pessoa_fisica_p, cd_cgc_p),
			obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),
			nr_sequencia,
			ds_email
		into STRICT	cd_pessoa_fisica_w,
			cd_cgc_w,
			ie_endereco_boleto_w,
			ie_tipo_pagador_w,
			ie_envia_cobranca_w,
			cd_sistema_anterior_w,
			dt_primeira_mensalidade_w,
			nr_seq_destino_corresp_w,
			ie_calc_primeira_mens_w,
			ie_calculo_proporcional_w,
			ie_pessoa_comprovante_w,
			ie_notificacao_w,
			ie_taxa_emissao_boleto_w,
			ie_inadimplencia_via_adic_w,
			nr_seq_classif_itens_w,
			nm_pessoa_nova_w,
			nm_pessoa_antiga_w,
			nr_seq_pagador_w,
			ds_email_w
		from	pls_contrato_pagador
		where	nr_sequencia	= nr_sequencia_p;

		ds_titulo_w	:= 'Alteração no cadastro do pagador';

		if (cd_pessoa_fisica_p <> cd_pessoa_fisica_w) then
			ds_alteracao_w	:= substr('Alterado a pessoa física do pagador, de "'||cd_pessoa_fisica_w||' - '||nm_pessoa_antiga_w||'" para "'||
						cd_pessoa_fisica_p||' - '||nm_pessoa_nova_w||'".'||chr(13)||chr(10),1,4000);
		elsif (cd_cgc_p <> cd_cgc_w) then
			ds_alteracao_w	:= substr('Alterado a pessoa jurídica do pagador, de "'||cd_cgc_w||' - '||nm_pessoa_antiga_w||'" para "'||cd_cgc_p||
						' - '||nm_pessoa_nova_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ds_email_p <> ds_email_w) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o e-mail do pagador, de "'||ds_email_w||'" para "'|| ds_email_p||'".'||chr(13)||chr(10),1,4000);
		elsif ((ds_email_p IS NOT NULL AND ds_email_p::text <> '') and coalesce(ds_email_w::text, '') = '') then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Informado o e-mail do pagador "' || ds_email_p||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_endereco_boleto_p <> ie_endereco_boleto_w) then
			select	obter_valor_dominio(1941,ie_endereco_boleto_w),
				obter_valor_dominio(1941,ie_endereco_boleto_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o endereço de correspondência do pagador, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_tipo_pagador_p <> ie_tipo_pagador_w) then
			select	CASE WHEN ie_tipo_pagador_w='P' THEN 'Principal'  ELSE 'Secundário' END ,
				CASE WHEN ie_tipo_pagador_p='P' THEN 'Principal'  ELSE 'Secundário' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o pagador, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||'".'||chr(13)
						||chr(10),1,4000);
		end if;

		if (coalesce(ie_envia_cobranca_p,' ') <> coalesce(ie_envia_cobranca_w,' ')) then
			select	obter_valor_dominio(2817,ie_envia_cobranca_w),
				obter_valor_dominio(2817,ie_envia_cobranca_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o tipo de envio da cobrança do pagador, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_sistema_anterior_p,' ') <> coalesce(cd_sistema_anterior_w,' ')) then
			ds_alteracao_w	:= substr(ds_alteracao_w || 'Alterado pagador anterior, de "' || cd_sistema_anterior_w || '" para "' ||
						cd_sistema_anterior_p || '".' || chr(13) || chr(10),1,4000);
		end if;

		if (dt_primeira_mensalidade_p <> dt_primeira_mensalidade_w) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a data de geração da primeira mensalidade, de "'||dt_primeira_mensalidade_w||
						'" para "'||dt_primeira_mensalidade_p||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(nr_seq_destino_corresp_p,0) <> coalesce(nr_seq_destino_corresp_w,0)) then
			begin
			select	ds_destino
			into STRICT	ds_destino_anterior_w
			from	pls_destino_corresp
			where	cd_estabelecimento	= cd_estabelecimento_p
			and	nr_sequencia		= nr_seq_destino_corresp_w;
			exception
				when others then
					ds_destino_anterior_w	:= '';
			end;

			begin
			select	ds_destino
			into STRICT	ds_destino_novo_w
			from	pls_destino_corresp
			where  cd_estabelecimento	= cd_estabelecimento_p
			and		nr_sequencia		= nr_seq_destino_corresp_p;
			exception
				when others then
					ds_destino_novo_w	:= '';
			end;
			ds_alteracao_w	:= substr(ds_alteracao_w || 'Alterado o destino de correspondência, de "'||ds_destino_anterior_w||'" para "'||
						ds_destino_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_calc_primeira_mens_p <> ie_calc_primeira_mens_w) then
			select	CASE WHEN ie_calc_primeira_mens_w='I' THEN 'Integral'  ELSE 'Proporcional' END ,
				CASE WHEN ie_calc_primeira_mens_p='I' THEN 'Integral'  ELSE 'Proporcional' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a forma de cálculo da 1° mensalidade, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_calculo_proporcional_p <> ie_calculo_proporcional_w) then
			select	CASE WHEN ie_calculo_proporcional_w='A' THEN 'Mês calendário adesão'  ELSE 'Data vencimento' END ,
				CASE WHEN ie_calculo_proporcional_p='A' THEN 'Mês calendário adesão'  ELSE 'Data vencimento' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a data de referência para o cálculo proporcional, de "'||ds_retorno_antigo_w||
						'" para "'||ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_pessoa_comprovante_p,' ') <> coalesce(ie_pessoa_comprovante_w,' ')) then
			select	obter_valor_dominio(2648,ie_pessoa_comprovante_w),
				obter_valor_dominio(2648,ie_pessoa_comprovante_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a pessoa do comprovante de pagamento, de "'||ds_retorno_antigo_w||'" para "'
						||ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_notificacao_p,' ') <> coalesce(ie_notificacao_w,' ')) then
			select	obter_valor_dominio(2883,ie_notificacao_w),
				obter_valor_dominio(2883,ie_notificacao_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a forma de notificação do pagador, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_taxa_emissao_boleto_p,' ') <> coalesce(ie_taxa_emissao_boleto_w,' ')) then
			select	obter_valor_dominio(3312,ie_taxa_emissao_boleto_w),
				obter_valor_dominio(3312,ie_taxa_emissao_boleto_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a taxa de emissão do boleto, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_inadimplencia_via_adic_p <> ie_inadimplencia_via_adic_w) then
			select	CASE WHEN ie_inadimplencia_via_adic_w='S' THEN 'Sim'  ELSE 'Não' END ,
				CASE WHEN ie_inadimplencia_via_adic_p='S' THEN 'Sim'  ELSE 'Não' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o campo consistir inadimplência ao gerar a via adicional do cartão, de "'||
						ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(nr_seq_classif_itens_p,0) <> coalesce(nr_seq_classif_itens_w,0)) then
			begin
			select	ds_classificacao
			into STRICT	ds_classif_item_anterior_w
			from	pls_classif_itens_pagador
			where	nr_sequencia	= nr_seq_classif_itens_w;
			exception
			when others then
				ds_classif_item_anterior_w	:= '';
			end;

			begin
			select	ds_classificacao
			into STRICT	ds_classif_item_novo_w
			from	pls_classif_itens_pagador
			where	nr_sequencia	= nr_seq_classif_itens_p;
			exception
			when others then
				ds_classif_item_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a situação trabalhista, de "'||ds_classif_item_anterior_w||'" para "'||
						ds_classif_item_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;
	end if;
elsif (ie_opcao_p = 2) then
	select	count(1)
	into STRICT	qt_registro_w
	from	pls_contrato_pagador_fin
	where	nr_sequencia	= nr_sequencia_p;

	if (qt_registro_w > 0) then
		select	dt_inicio_vigencia,
			dt_fim_vigencia,
			dt_dia_vencimento,
			nr_seq_forma_cobranca,
			ie_mes_vencimento,
			cd_condicao_pagamento,
			cd_tipo_portador,
			cd_portador,
			nr_seq_conta_banco,
			nr_seq_carteira_cobr,
			cd_autenticidade,
			ie_portador_exclusivo,
			cd_banco,
			cd_agencia_bancaria,
			ie_digito_agencia,
			cd_conta,
			ie_digito_conta,
			nr_seq_empresa,
			cd_profissao,
			nr_seq_vinculo_empresa,
			cd_matricula,
			nr_seq_pagador,
			ie_geracao_nota_titulo,
			ie_destacar_reajuste,
			ie_gerar_cobr_escrit,
			ds_observacao
		into STRICT	dt_inicio_vigencia_w,
			dt_fim_vigencia_w,
			dt_dia_vencimento_w,
			nr_seq_forma_cobranca_w,
			ie_mes_vencimento_w,
			cd_condicao_pagamento_w,
			cd_tipo_portador_w,
			cd_portador_w,
			nr_seq_conta_banco_w,
			nr_seq_carteira_cobr_w,
			cd_autenticidade_w,
			ie_portador_exclusivo_w,
			cd_banco_w,
			cd_agencia_bancaria_w,
			ie_digito_agencia_w,
			cd_conta_w,
			ie_digito_conta_w,
			nr_seq_empresa_w,
			cd_profissao_w,
			nr_seq_vinculo_empresa_w,
			cd_matricula_w,
			nr_seq_pagador_w,
			ie_geracao_nota_titulo_w,
			ie_destacar_reajuste_w,
			ie_gerar_cobr_escrit_w,
			ds_observacao_w
		from	pls_contrato_pagador_fin
		where	nr_sequencia	= nr_sequencia_p;

		ds_titulo_w	:= 'Alteração no cadastro de informação financeira do pagador';

		if	((dt_inicio_vigencia_p <> dt_inicio_vigencia_w) or (dt_fim_vigencia_p <> dt_fim_vigencia_w)) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a data de vigência da informação financeira, de ('||dt_inicio_vigencia_w||' à '||
						dt_fim_vigencia_w||') para ('||dt_inicio_vigencia_p||' à '||dt_fim_vigencia_p||'), na informação financeira '||
						nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (dt_dia_vencimento_p <> dt_dia_vencimento_w) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o dia de vencimento, de "'||dt_dia_vencimento_w||'" para "'||dt_dia_vencimento_p||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (nr_seq_forma_cobranca_p <> nr_seq_forma_cobranca_w) then
			select	obter_valor_dominio(1720,nr_seq_forma_cobranca_w),
				obter_valor_dominio(1720,nr_seq_forma_cobranca_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a forma de cobrança, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_mes_vencimento_p,' ') <> coalesce(ie_mes_vencimento_w,' ')) then
			select	CASE WHEN ie_mes_vencimento_w='P' THEN 'Mês posterior' WHEN ie_mes_vencimento_w='N' THEN 'Mês anterior'  ELSE 'Mês atual' END ,
				CASE WHEN ie_mes_vencimento_p='P' THEN 'Mês posterior' WHEN ie_mes_vencimento_p='N' THEN 'Mês anterior'  ELSE 'Mês atual' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o mês de vencimento, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_condicao_pagamento_p,0) <> coalesce(cd_condicao_pagamento_w,0)) then
			begin
			select	ds_condicao_pagamento
			into STRICT	ds_retorno_antigo_w
			from	condicao_pagamento
			where	cd_condicao_pagamento = cd_condicao_pagamento_w;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	ds_condicao_pagamento
			into STRICT	ds_retorno_novo_w
			from	condicao_pagamento
			where	cd_condicao_pagamento = cd_condicao_pagamento_p;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a condição de pagamento, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_tipo_portador_p,0) <> coalesce(cd_tipo_portador_w,0)) then
			select	obter_valor_dominio(703,cd_tipo_portador_w),
				obter_valor_dominio(703,cd_tipo_portador_p)
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o tipo de portador, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_portador_p,0) <> coalesce(cd_portador_w,0)) then
			begin
			select	ds_portador
			into STRICT	ds_retorno_antigo_w
			from	portador
			where	cd_portador = cd_portador_w;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	ds_portador
			into STRICT	ds_retorno_novo_w
			from	portador
			where	cd_portador = cd_portador_p;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o portador, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(nr_seq_conta_banco_p,0) <> coalesce(nr_seq_conta_banco_w,0)) then
			begin
			select	substr(ds_conta,1,255)
			into STRICT	ds_retorno_antigo_w
			from	banco_estabelecimento_v
			where	nr_sequencia	= nr_seq_conta_banco_w;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	substr(ds_conta,1,255)
			into STRICT	ds_retorno_novo_w
			from	banco_estabelecimento_v
			where	nr_sequencia	= nr_seq_conta_banco_w;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a Agência/Conta Estab. de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if	coalesce(nr_seq_carteira_cobr_p,0) <> coalesce(nr_seq_carteira_cobr_w,0) then
			begin
			select	substr(cd_carteira || ' - ' || ds_carteira,1,255) ds
			into STRICT	ds_cart_bancaria_anterior_w
			from	banco_carteira
			where	nr_sequencia = nr_seq_carteira_cobr_w;
			exception
				when others then
					ds_cart_bancaria_anterior_w	:= '';
			end;

			begin
			select	substr(cd_carteira || ' - ' || ds_carteira,1,255) ds
			into STRICT	ds_cart_bancaria_novo_w
			from	banco_carteira
			where	nr_sequencia = nr_seq_carteira_cobr_p;
			exception
			when others then
				ds_cart_bancaria_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterada a carteira bancária, de "'||ds_cart_bancaria_anterior_w||'" para "'||
						ds_cart_bancaria_novo_w||'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_autenticidade_p,' ') <> coalesce(cd_autenticidade_w,' ')) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o código de autenticidade, de "'||cd_autenticidade_w||'" para "'||cd_autenticidade_p||
						'".'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_portador_exclusivo_p,' ') <> coalesce(ie_portador_exclusivo_w,' ')) then
			select	CASE WHEN ie_portador_exclusivo_w='S' THEN 'Sim'  ELSE 'Não' END
			into STRICT	ds_retorno_antigo_w
			;

			select	CASE WHEN ie_portador_exclusivo_p='S' THEN 'Sim'  ELSE 'Não' END
			into STRICT	ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o valor do campo Permite alteração do portador (via lote), de "'||ds_retorno_antigo_w||
						'" para "'||ds_retorno_novo_w||'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_banco_p,0) <> coalesce(cd_banco_w,0)) then
			begin
			select	substr(obter_nome_banco(cd_banco_w),1,200)
			into STRICT	ds_retorno_antigo_w
			;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	substr(obter_nome_banco(cd_banco_p),1,200)
			into STRICT	ds_retorno_novo_w
			;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o banco, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if	((coalesce(cd_agencia_bancaria_w,' ') <> coalesce(cd_agencia_bancaria_p,' ')) or (coalesce(ie_digito_agencia_w,' ') <> coalesce(ie_digito_agencia_p,' '))) then
			select	cd_agencia_bancaria_w||'-'||ie_digito_agencia_w
			into STRICT	ds_retorno_antigo_w
			;

			select	cd_agencia_bancaria_p||'-'||ie_digito_agencia_p
			into STRICT	ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a Agência/Dig, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if	((coalesce(cd_conta_w,' ') <> coalesce(cd_conta_p,' ')) or (coalesce(ie_digito_conta_w,' ') <> coalesce(ie_digito_conta_p,' '))) then
			select	cd_conta_w||'-'||ie_digito_conta_w
			into STRICT	ds_retorno_antigo_w
			;

			select	cd_conta_p||'-'||ie_digito_conta_p
			into STRICT	ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a Agência/Dig, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(nr_seq_empresa_w,0) <> coalesce(nr_seq_empresa_p,0)) then
			begin
			select	substr(pls_obter_dados_empresa(nr_seq_empresa_w,'D'),1,250)
			into STRICT	ds_retorno_antigo_w
			;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	substr(pls_obter_dados_empresa(nr_seq_empresa_p,'D'),1,250)
			into STRICT	ds_retorno_novo_w
			;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a empresa, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_profissao_w,0) <> coalesce(cd_profissao_p,0)) then
			begin
			select	substr(Obter_Desc_profissao(cd_profissao_w),1,255)
			into STRICT	ds_retorno_antigo_w
			;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	substr(Obter_Desc_profissao(cd_profissao_p),1,255)
			into STRICT	ds_retorno_novo_w
			;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a empresa, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(nr_seq_vinculo_empresa_w,0) <> coalesce(nr_seq_vinculo_empresa_p,0)) then
			begin
			select	ds_vinculo
			into STRICT	ds_retorno_antigo_w
			from	pls_empresa_vinculo
			where	nr_sequencia = nr_seq_vinculo_empresa_w;
			exception
			when others then
				ds_retorno_antigo_w	:= '';
			end;

			begin
			select	ds_vinculo
			into STRICT	ds_retorno_novo_w
			from	pls_empresa_vinculo
			where	nr_sequencia = nr_seq_vinculo_empresa_p;
			exception
			when others then
				ds_retorno_novo_w	:= '';
			end;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o vínculo com a empresa, de "'||ds_retorno_antigo_w||'" para "'||ds_retorno_novo_w||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(cd_matricula_w,' ') <> coalesce(cd_matricula_p,' ')) then
			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado a matrícula, de "'||cd_matricula_w||'" para "'||cd_matricula_p||
						'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (coalesce(ie_geracao_nota_titulo_w,' ') <> coalesce(ie_geracao_nota_titulo_p,' ')) then
			select	CASE WHEN ie_geracao_nota_titulo_w='NT' THEN 'Nota fiscal e título'  ELSE 'Somente título' END ,
				CASE WHEN ie_geracao_nota_titulo_p='NT' THEN 'Nota fiscal e título'  ELSE 'Somente título' END
			into STRICT	ds_retorno_antigo_w,
				ds_retorno_novo_w
			;

			ds_alteracao_w	:= substr(ds_alteracao_w ||'Alterado o valor do campo Geração de Nota fiscal/Título, de "'||ds_retorno_antigo_w||'" para "'||
						ds_retorno_novo_w||'", na informação financeira '||nr_sequencia_p||'.'||chr(13)||chr(10),1,4000);
		end if;

		if (ie_destacar_reajuste_p <> ie_destacar_reajuste_w) then
			select	substr(ds_alteracao_w ||'Alterado o destaque de taxa de reajuste, de "'||CASE WHEN ie_destacar_reajuste_w='S' THEN 'Ativo' WHEN ie_destacar_reajuste_w='N' THEN 'Inativo'  ELSE '' END ||
					'" para "'||CASE WHEN ie_destacar_reajuste_p='S' THEN 'Ativo' WHEN ie_destacar_reajuste_p='N' THEN 'Inativo'  ELSE '' END ||'".'||chr(13)||chr(10),1,4000)
			into STRICT	ds_alteracao_w
			;
		end if;

		if (ie_gerar_cobr_escrit_p <> ie_gerar_cobr_escrit_w) then
			select	substr(ds_alteracao_w ||'Alterado a geração de cobrança escritural para o título, de "'||
				CASE WHEN ie_gerar_cobr_escrit_w='S' THEN 'Ativo' WHEN ie_gerar_cobr_escrit_w='N' THEN 'Inativo'  ELSE '' END ||'" para "'||CASE WHEN ie_gerar_cobr_escrit_p='S' THEN 'Ativo' WHEN ie_gerar_cobr_escrit_p='N' THEN 'Inativo'  ELSE '' END ||
				'".'||chr(13)||chr(10),1,4000)
			into STRICT	ds_alteracao_w
			;
		end if;

		if (coalesce(ds_observacao_p,' ') <> coalesce(ds_observacao_w,' ')) then
			ds_alteracao_w	:= substr(ds_alteracao_w || 'Alterado a observação, de "' || ds_observacao_w || '" para "' || ds_observacao_p ||
						'".' || chr(13) || chr(10),1,4000);
		end if;
	end if;
end if;

if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
	insert into pls_pagador_historico(nr_sequencia,
		dt_historico,
		nm_usuario_historico,
		ds_titulo,
		ds_historico,
		nr_seq_pagador,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo_historico)
	values (nextval('pls_pagador_historico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_titulo_w,
		ds_alteracao_w,
		nr_seq_pagador_w,
		cd_estabelecimento_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'S');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_historico_pagador ( ie_opcao_p bigint, nr_sequencia_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_endereco_boleto_p text, ie_tipo_pagador_p text, ie_envia_cobranca_p text, cd_sistema_anterior_p text, dt_primeira_mensalidade_p timestamp, nr_seq_destino_corresp_p bigint, ie_calc_primeira_mens_p text, ie_calculo_proporcional_p text, ie_pessoa_comprovante_p text, ie_notificacao_p text, ie_taxa_emissao_boleto_p text, ie_inadimplencia_via_adic_p text, nr_seq_classif_itens_p bigint, ds_email_p text, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, dt_dia_vencimento_p bigint, nr_seq_forma_cobranca_p text, ie_mes_vencimento_p text, cd_condicao_pagamento_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, nr_seq_conta_banco_p bigint, nr_seq_carteira_cobr_p bigint, cd_autenticidade_p text, ie_portador_exclusivo_p text, cd_banco_p bigint, cd_agencia_bancaria_p text, ie_digito_agencia_p text, cd_conta_p text, ie_digito_conta_p text, nr_seq_empresa_p bigint, cd_profissao_p bigint, nr_seq_vinculo_empresa_p bigint, cd_matricula_p text, ie_geracao_nota_titulo_p text, ie_destacar_reajuste_p text, ie_gerar_cobr_escrit_p text, ds_observacao_p text, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

