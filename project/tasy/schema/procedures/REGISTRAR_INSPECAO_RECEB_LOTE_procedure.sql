-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE registrar_inspecao_receb_lote ( nr_ordem_compra_p bigint, ds_barras_p text, cd_lote_fabricacao_p text, dt_validade_p timestamp, ie_indeterminada_p text, nr_seq_inspecao_p bigint, qt_material_p bigint, nr_seq_marca_p bigint, nm_usuario_p text, ds_barras_material_p text default null) AS $body$
DECLARE


count_w bigint;


BEGIN

select count(nr_sequencia)
into STRICT count_w
from ordem_item_conf_lote
where nr_seq_conferencia = nr_seq_inspecao_p
and ds_lote_fornec = cd_lote_fabricacao_p;

if count_w = 0 then
    insert into ordem_item_conf_lote(
        nr_sequencia,
        dt_atualizacao,
        dt_atualizacao_nrec,
        nm_usuario,
        nm_usuario_nrec,
        dt_validade,
        ie_indeterminada,
        cd_barra_material,
        nr_seq_conferencia,
        ds_lote_fornec,
        qt_material,
		nr_seq_marca,
        ds_barras)
    values (	nextval('ordem_item_conf_lote_seq'),
        clock_timestamp(),
        clock_timestamp(),
        nm_usuario_p,
        nm_usuario_p,
        dt_validade_p,
        ie_indeterminada_p,
        coalesce(ds_barras_material_p, substr(ds_barras_p, 3, 14)),
        nr_seq_inspecao_p,
        cd_lote_fabricacao_p,
        qt_material_p,
		nr_seq_marca_p,
        ds_barras_p);

else
    update ordem_item_conf_lote
    set qt_material = coalesce(qt_material, 0) + coalesce(qt_material_p, 0),
        cd_barra_material = coalesce(ds_barras_material_p, cd_barra_material),
        ds_barras = coalesce(ds_barras_p, ds_barras),
        nr_seq_marca = nr_seq_marca_p
    where nr_seq_conferencia = nr_seq_inspecao_p
    and ds_lote_fornec = cd_lote_fabricacao_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE registrar_inspecao_receb_lote ( nr_ordem_compra_p bigint, ds_barras_p text, cd_lote_fabricacao_p text, dt_validade_p timestamp, ie_indeterminada_p text, nr_seq_inspecao_p bigint, qt_material_p bigint, nr_seq_marca_p bigint, nm_usuario_p text, ds_barras_material_p text default null) FROM PUBLIC;

