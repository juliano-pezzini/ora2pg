-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_prescr_proc_befpost1_html ( ie_lado_p prescr_procedimento.ie_lado%type, nr_seq_proc_interno_p proc_interno.nr_sequencia%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, -- parametros.put("nr_seq_material_p", funcoes.validastring(wdbpanel.getvalorasstring("cd_material_exame"))); 
 ds_material_especial_p prescr_procedimento.ds_material_especial%type, nr_seq_exame_p exame_laboratorio.nr_seq_exame%type,     --CD_EXAME_P (wdbPanel.getValorAsString("NR_SEQ_EXAME")));//CD_EXAME_VISUAL 
 cd_guia_p prescr_procedimento.nr_doc_convenio%type, cd_senha_p prescr_procedimento.cd_senha%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%type, ie_carater_inter_sus_p atendimento_paciente.ie_carater_inter_sus%type, ie_clinica_p atendimento_paciente.ie_clinica%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_classificacao_p atendimento_paciente.nr_seq_classificacao%type, cd_categoria_p atend_categoria_convenio.cd_categoria%type, cd_plano_p atend_categoria_convenio.cd_plano_convenio%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_proced_p prescr_procedimento.nr_sequencia%type, dt_prev_execucao_p prescr_procedimento.dt_prev_execucao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, dt_coleta_p prescr_procedimento.dt_coleta%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_medico_executor_p pessoa_fisica.cd_pessoa_fisica%type, ds_sexo_paciente_p pessoa_fisica.ie_sexo%type, qt_procedimento_p prescr_procedimento.qt_procedimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_edicao_novo_p text, ie_possui_registros_p text, ie_pasta_laboratorio_p text, parametro634_p text, nm_usuario_p usuario.nm_usuario%type, ds_msg_erro_lado_p INOUT text, ds_msg_erro_mat_p INOUT text, ds_msg_erro_p INOUT text, ds_msg_aviso_p INOUT text, ds_msg_alerta_p INOUT text, ds_msg_info_p INOUT text, ie_cancelar_edicao_p INOUT text) AS $body$
DECLARE

							 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
Rotina utilizada no Angular HTML5 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: HTML5 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
CD_MATERIAL_EXAME_P é o mesmo NR_SEQ_MATERIAL_P 
NR_SEQ_EXAME_P é o mesmo CD_EXAME_P 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ie_exige_lado_w			proc_interno.ie_exige_lado%type;
ie_material_especial_w		material_exame_lab.ie_material_especial%type;

ds_msg_erro_w         	varchar(5000);
ds_msg_aviso_w         	varchar(5000);
ds_msg_alerta_w    		varchar(5000);
ds_msg_info_w     		varchar(5000);

ds_msg_erro_lado_w   		varchar(5000);
ds_msg_erro_mat_w   		varchar(5000);
ie_cancelar_edicao_w		varchar(2);


BEGIN 
 
 
if ( parametro634_p = 'S' and (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and (ie_lado_p IS NOT NULL AND ie_lado_p::text <> '') ) then 
	select	ie_exige_lado 
	into STRICT	ie_exige_lado_w 
	from 	proc_interno 
	where 	nr_sequencia = nr_seq_proc_interno_p;
		 
	if ( ie_exige_lado_w = 'L' and ie_lado_p = 'A' ) then		 
		ds_msg_erro_w 	:= obter_texto_tasy( 329488, 1);		
		ds_msg_erro_lado_w := ds_msg_erro_w;
		-- 329488 - Para esse exame não é permitido informar o lado como Bilateral (Ambos). Parâmetro [634] 
	end if;
end if;
 
 
if ( coalesce(ds_msg_erro_w::text, '') = '' ) then 
	--Pasta exames laboratoriais 
	if ( ie_pasta_laboratorio_p = 'S' ) then 
		select	max( ie_material_especial ) 
		into STRICT	ie_material_especial_w 
		from	material_exame_lab 
		where	cd_material_exame = cd_material_exame_p;	
		 
		if ( coalesce(ds_material_especial_p::text, '') = '' and ie_material_especial_w = 'S' ) then 
			ds_msg_erro_w := obter_texto_tasy( 224497, 1);
			ds_msg_erro_mat_w := ds_msg_erro_w;
			--Para este material é exigido informar o campo Material especial 
		end if;
	end if;
end if;
 
 
if ( coalesce(ds_msg_erro_w::text, '') = '' ) then	 
	SELECT * FROM consistir_dados_guia_eup_js( 
		to_char(nr_seq_exame_p), ie_pasta_laboratorio_p, cd_guia_p, cd_senha_p, cd_convenio_p, ie_tipo_atendimento_p, ie_carater_inter_sus_p, ie_clinica_p, cd_procedimento_p, ie_origem_proced_p, nr_seq_classificacao_p, nr_seq_proc_interno_p, cd_categoria_p, cd_plano_p, nr_atendimento_p, nr_prescricao_p, nr_seq_proced_p, cd_material_exame_p, dt_prev_execucao_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, ds_msg_erro_w, ds_msg_aviso_w) INTO STRICT ds_msg_erro_w, ds_msg_aviso_w;
end if;
 
if ( coalesce(ds_msg_erro_w::text, '') = '' and coalesce(ds_msg_aviso_w::text, '') = '' ) then		 
	SELECT * FROM validar_proc_paciente_eup_js( 
		ie_possui_registros_p, ie_pasta_laboratorio_p, nr_seq_exame_p, cd_material_exame_p, coalesce(dt_coleta_p, clock_timestamp()), ie_origem_proced_p, cd_convenio_p, nr_atendimento_p, cd_procedimento_p, cd_setor_atendimento_p, cd_medico_executor_p, ie_tipo_atendimento_p, nr_seq_exame_p, ds_sexo_paciente_p, qt_procedimento_p, cd_pessoa_fisica_p, nr_seq_proc_interno_p, ie_edicao_novo_p, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, ds_msg_erro_w, ds_msg_alerta_w, ie_cancelar_edicao_w, ds_msg_info_w) INTO STRICT ds_msg_erro_w, ds_msg_alerta_w, ie_cancelar_edicao_w, ds_msg_info_w;		
end if;
 
ds_msg_erro_p  	:= ds_msg_erro_w;
ds_msg_aviso_p 		:= ds_msg_aviso_w;
ds_msg_alerta_p 	:= ds_msg_alerta_w;
ds_msg_info_p 		:= ds_msg_info_w;	
ie_cancelar_edicao_p 	:= ie_cancelar_edicao_w;
 
ds_msg_erro_lado_p 	:= ds_msg_erro_lado_w;
ds_msg_erro_mat_p	:= ds_msg_erro_mat_w;
		 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_prescr_proc_befpost1_html ( ie_lado_p prescr_procedimento.ie_lado%type, nr_seq_proc_interno_p proc_interno.nr_sequencia%type, cd_material_exame_p material_exame_lab.cd_material_exame%type, ds_material_especial_p prescr_procedimento.ds_material_especial%type, nr_seq_exame_p exame_laboratorio.nr_seq_exame%type, cd_guia_p prescr_procedimento.nr_doc_convenio%type, cd_senha_p prescr_procedimento.cd_senha%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%type, ie_carater_inter_sus_p atendimento_paciente.ie_carater_inter_sus%type, ie_clinica_p atendimento_paciente.ie_clinica%type, cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_classificacao_p atendimento_paciente.nr_seq_classificacao%type, cd_categoria_p atend_categoria_convenio.cd_categoria%type, cd_plano_p atend_categoria_convenio.cd_plano_convenio%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_proced_p prescr_procedimento.nr_sequencia%type, dt_prev_execucao_p prescr_procedimento.dt_prev_execucao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, dt_coleta_p prescr_procedimento.dt_coleta%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_medico_executor_p pessoa_fisica.cd_pessoa_fisica%type, ds_sexo_paciente_p pessoa_fisica.ie_sexo%type, qt_procedimento_p prescr_procedimento.qt_procedimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_edicao_novo_p text, ie_possui_registros_p text, ie_pasta_laboratorio_p text, parametro634_p text, nm_usuario_p usuario.nm_usuario%type, ds_msg_erro_lado_p INOUT text, ds_msg_erro_mat_p INOUT text, ds_msg_erro_p INOUT text, ds_msg_aviso_p INOUT text, ds_msg_alerta_p INOUT text, ds_msg_info_p INOUT text, ie_cancelar_edicao_p INOUT text) FROM PUBLIC;

