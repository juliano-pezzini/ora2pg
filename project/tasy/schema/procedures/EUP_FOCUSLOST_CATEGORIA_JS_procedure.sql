-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_focuslost_categoria_js ( ie_tipo_atendimento_p bigint, cd_usuario_convenio_p text, cd_tipo_acomodacao_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, cd_plano_convenio_p INOUT text, ie_mostra_doc_convenio_p INOUT text, cd_tipo_acomod_ret_p INOUT bigint, ie_cod_usu_padrao_categ_p INOUT text, cd_usuario_conv_ret_p INOUT text, cd_convenio_glosa_p INOUT bigint, cd_categoria_glosa_p INOUT text) AS $body$
DECLARE


cd_plano_convenio_w	varchar(10);
ie_mostrar_obs_conv_w	varchar(5);
ie_forma_doc_conv_w	varchar(15);
ie_regra_conv_w		varchar(1);
cd_tipo_acomodacao_w	smallint;
qt_cod_usu_padrao_w	bigint;
qt_regra_digito_w	bigint;
nr_prim_digitos_w	varchar(30);
cd_convenio_glosa_w	integer;
cd_categoria_glosa_w	varchar(10);


BEGIN

ie_mostra_doc_convenio_p := 'N';
ie_cod_usu_padrao_categ_p := 'N';

ie_mostrar_obs_conv_w := Obter_param_Usuario(916, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_mostrar_obs_conv_w);

if (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') and (coalesce(cd_convenio_p,0) > 0) then

	select	max(cd_plano_padrao)
	into STRICT	cd_plano_convenio_w
	from	categoria_convenio
	where	cd_convenio = cd_convenio_p
	and 	cd_categoria = cd_categoria_p;

	if (cd_plano_convenio_w IS NOT NULL AND cd_plano_convenio_w::text <> '') then
		cd_plano_convenio_p := cd_plano_convenio_w;
	end if;

	if (ie_mostrar_obs_conv_w = 'S') then

		begin
			select	coalesce(ie_forma_doc_conv,'T')
			into STRICT	ie_forma_doc_conv_w
			from	parametro_atendimento
			where 	cd_estabelecimento = cd_estabelecimento_p;
		exception
		when others then
			ie_forma_doc_conv_w := 'T';
		end;

		ie_regra_conv_w := obter_se_reg_conv_pl_cat(cd_convenio_p,'CC', cd_categoria_p);
		if	((ie_forma_doc_conv_w <> 'C') or
			(ie_forma_doc_conv_w = 'C' AND ie_regra_conv_w = 'S')) then
			ie_mostra_doc_convenio_p := 'S';
		end if;
	end if;
	if (coalesce(cd_tipo_acomodacao_p,0) = 0) then
		begin
			select	coalesce(cd_tipo_acomodacao,0)
			into STRICT	cd_tipo_acomodacao_w
			from  	categoria_convenio
			where  	cd_convenio = cd_convenio_p
			and	cd_categoria = cd_categoria_p;

			cd_tipo_acomod_ret_p := cd_tipo_acomodacao_w;

		exception
		when others then
			cd_tipo_acomodacao_w := 0;
		end;
	end if;

	if (coalesce(cd_usuario_convenio_p::text, '') = '') then
		select	count(*)
		into STRICT	qt_cod_usu_padrao_w
		from	cat_conv_usuario_padrao
		where	cd_convenio = cd_convenio_p
		and	cd_categoria = cd_categoria_p;

		if (qt_cod_usu_padrao_w > 0) then
			ie_cod_usu_padrao_categ_p := 'S';
		end if;
	end if;

	select  count(*)
	into STRICT	qt_regra_digito_w
	from    regra_digito_convenio
	where   cd_convenio = cd_convenio_p
	and     cd_categoria = cd_categoria_p
	and     coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

	if (qt_regra_digito_w > 0) then
		select  max(nr_prim_digitos)
		into STRICT	nr_prim_digitos_w
		from    regra_digito_convenio
		where   cd_convenio = cd_convenio_p
		and     cd_categoria = cd_categoria_p
		and     coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

		if (nr_prim_digitos_w IS NOT NULL AND nr_prim_digitos_w::text <> '') then
			cd_usuario_conv_ret_p := nr_prim_digitos_w;
		end if;
	elsif (qt_regra_digito_w = 0) then
		nr_prim_digitos_w := obter_prim_digitos_convenio(cd_convenio_p);
		if (nr_prim_digitos_w IS NOT NULL AND nr_prim_digitos_w::text <> '') then
			cd_usuario_conv_ret_p := nr_prim_digitos_w;
		end if;
	end if;

	select	coalesce(max(cd_convenio_glosa),0),
		max(cd_categoria_glosa)
	into STRICT	cd_convenio_glosa_w,
		cd_categoria_glosa_w
	from	regra_conv_categ_glosa
	where	cd_convenio = cd_convenio_p
	and	cd_categoria = cd_categoria_p
	and	((coalesce(ie_tipo_atendimento::text, '') = '')
	or	(ie_tipo_atendimento IS NOT NULL AND ie_tipo_atendimento::text <> '' AND ie_tipo_atendimento = ie_tipo_atendimento_p));

	if (cd_convenio_glosa_w > 0) then
		cd_convenio_glosa_p := cd_convenio_glosa_w;
	end if;
	if (cd_categoria_glosa_w IS NOT NULL AND cd_categoria_glosa_w::text <> '') then
		cd_categoria_glosa_p := cd_categoria_glosa_w;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_focuslost_categoria_js ( ie_tipo_atendimento_p bigint, cd_usuario_convenio_p text, cd_tipo_acomodacao_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, cd_plano_convenio_p INOUT text, ie_mostra_doc_convenio_p INOUT text, cd_tipo_acomod_ret_p INOUT bigint, ie_cod_usu_padrao_categ_p INOUT text, cd_usuario_conv_ret_p INOUT text, cd_convenio_glosa_p INOUT bigint, cd_categoria_glosa_p INOUT text) FROM PUBLIC;

