-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_pag_conta_resumo ( nr_seq_conta_tb_p pls_util_cta_pck.t_number_table, nr_seq_conta_resumo_tb_p pls_util_cta_pck.t_number_table, nr_seq_conta_rec_resumo_tb_p pls_util_cta_pck.t_number_table, nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, ie_origem_p text ) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ie_analise_aud_w	varchar(10);
nr_seq_analise_w	pls_analise_conta.nr_sequencia%type;
qt_analise_aberta_w	integer;

BEGIN 
ie_analise_aud_w	:= 'N';
nr_seq_analise_w	:= null;
 
-- Conta médica resumo 
if (ie_origem_p = 'CM') then 
 
	if (nr_seq_conta_tb_p.count > 0) then 
		for i in nr_seq_conta_tb_p.first..nr_seq_conta_tb_p.last loop 
 
			begin 
			select	a.nr_seq_analise 
			into STRICT	nr_seq_analise_w 
			from	pls_conta	a 
			where	a.nr_sequencia	= nr_seq_conta_tb_p(i);
			exception 
			when others then 
				nr_seq_analise_w := null;
			end;
 
			if (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') then 
				ie_analise_aud_w	:= pls_obter_conta_item_auditoria(nr_seq_conta_tb_p(i));
 
				if (ie_analise_aud_w = 'S') then 
					select	count(1) 
					into STRICT	qt_analise_aberta_w 
					from	pls_analise_conta 
					where	nr_sequencia = nr_seq_analise_w 
					and	ie_status not in ('T','C','L');
 
					if (qt_analise_aberta_w > 0) then 
						CALL wheb_mensagem_pck.exibir_mensagem_abort(210206,'NR_SEQ_CONTA=' ||nr_seq_conta_tb_p(i));
					end if;
				end if;
			end if;
		 
		end loop;
		 
		-- Atualizar no resumo, o lote de pagamento do item 
		forall i in nr_seq_conta_resumo_tb_p.first..nr_seq_conta_resumo_tb_p.last 
			update	pls_conta_medica_resumo 
			set	nr_seq_lote_pgto	= nr_seq_lote_p 
			where	nr_seq_conta		= nr_seq_conta_tb_p(i) 
			and	nr_sequencia		= nr_seq_conta_resumo_tb_p(i) 
			and	ie_situacao = 'A';
	end if;
--Recursos de Glosas de procedimentos 
elsif (ie_origem_p = 'RGP') then 
	 
	forall i in nr_seq_conta_resumo_tb_p.first..nr_seq_conta_resumo_tb_p.last 
		update	pls_rec_glosa_proc 
		set	nr_seq_lote_pgto	= nr_seq_lote_p 
		where	nr_sequencia		= nr_seq_conta_resumo_tb_p(i);
--Recursos de Glosas de materiais 
elsif (ie_origem_p = 'RGM') then 
	 
	forall i in nr_seq_conta_resumo_tb_p.first..nr_seq_conta_resumo_tb_p.last 
		update	pls_rec_glosa_mat 
		set	nr_seq_lote_pgto	= nr_seq_lote_p 
		where	nr_sequencia		= nr_seq_conta_resumo_tb_p(i);
		 
--Recursos de Glosas 
elsif (ie_origem_p = 'RG') then 
 
	forall i in nr_seq_conta_rec_resumo_tb_p.first..nr_seq_conta_rec_resumo_tb_p.last 
		update	pls_conta_rec_resumo_item 
		set	nr_seq_lote_pgto	= nr_seq_lote_p 
		where	nr_sequencia		= nr_seq_conta_rec_resumo_tb_p(i);
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_pag_conta_resumo ( nr_seq_conta_tb_p pls_util_cta_pck.t_number_table, nr_seq_conta_resumo_tb_p pls_util_cta_pck.t_number_table, nr_seq_conta_rec_resumo_tb_p pls_util_cta_pck.t_number_table, nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, ie_origem_p text ) FROM PUBLIC;

