-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_aval_respondida_fornec ( nr_seq_avaliacao_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_cgc_w				varchar(14);
ds_razao_social_w				pessoa_juridica.ds_razao_social%type;
nm_fantasia_w				varchar(80);
ds_tipo_avaliacao_w			varchar(255);
cd_pessoa_resp_w				varchar(10);
ds_comprador_padrao_w			varchar(100);
ds_responsavel_compras_w			varchar(100);
ds_mensagem_w				varchar(2000);
ds_assunto_w				varchar(255);
nm_usuario_compras_w			varchar(15);
nr_seq_regra_w				bigint;
qt_existe_avaliacao_w			bigint;
ie_usuario_w				varchar(3);
ds_email_destino_w				varchar(255);
ds_email_adicional_w			varchar(2000);
ds_email_origem_w				varchar(255);
nr_telefone_w				varchar(15);
ie_momento_envio_w			varchar(1);
ds_email_remetente_w			varchar(255);


BEGIN

select	count(*)
into STRICT	qt_existe_avaliacao_w
from    	avf_resultado
where   	nr_sequencia = nr_seq_avaliacao_p;

select	coalesce(max(nr_sequencia),0),
	coalesce(max(ie_usuario),'U'),
	coalesce(max(ds_email_remetente),'X'),
	max(replace(ds_email_adicional,',',';')),
	coalesce(max(ie_momento_envio),'I')
into STRICT	nr_seq_regra_w,
	ie_usuario_w,
	ds_email_remetente_w,
	ds_email_adicional_w,
	ie_momento_envio_w
from	regra_envio_email_compra
where	ie_tipo_mensagem = 48
and	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_p;

begin

if (nr_seq_regra_w > 0) and (qt_existe_avaliacao_w > 0) then
	begin

	select  	cd_cnpj,
		substr(obter_nome_avf_tipo_avaliacao(nr_seq_tipo_aval),1,255) ds_tipo_aval,
		cd_pessoa_resp
	into STRICT	cd_cgc_w,
		ds_tipo_avaliacao_w,
		cd_pessoa_resp_w
	from    	avf_resultado
	where	nr_sequencia = nr_seq_avaliacao_p;
	
	select	a.ds_razao_social,
		a.nm_fantasia,
		b.ds_email ds_email_origem
	into STRICT	ds_razao_social_w,
		nm_fantasia_w,
		ds_email_origem_w
	from	pessoa_juridica a,
		pessoa_juridica_estab b
	where	a.cd_cgc = b.cd_cgc
	and     	a.cd_cgc = cd_cgc_w
	and	b.cd_estabelecimento = cd_estabelecimento_p;

	select	substr(obter_nome_pf_pj(cd_comprador_padrao,null),1,100),
		substr(obter_nome_pf_pj(cd_responsavel_compras,null),1,100),
		substr(obter_usuario_pessoa(coalesce(cd_responsavel_compras,cd_comprador_padrao)),1,15),
		coalesce(ds_email_origem_w,ds_email) ds_email_origem
	into STRICT	ds_comprador_padrao_w,
		ds_responsavel_compras_w,
		nm_usuario_compras_w,
		ds_email_origem_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;

	select  	obter_dados_usuario_opcao(obter_usuario_pf(cd_pessoa_resp_w), 'E') ds_email_pf
	into STRICT	ds_email_destino_w
	;

	if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
		ds_email_destino_w := substr(ds_email_destino_w || ';' || ds_email_adicional_w,1,255);
	end if;

	if (ds_email_remetente_w <> 'X') then
		ds_email_origem_w	:= ds_email_remetente_w;
	end if;

	ds_mensagem_w := '';
	ds_assunto_w  := '';

	if (coalesce(ds_email_destino_w,'X') <> 'X') then
		select	substr(ds_assunto,1,255),
			substr(ds_mensagem_padrao,1,2000)
		into STRICT	ds_assunto_w,
			ds_mensagem_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_seq_regra_w;
		
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@cnpj',cd_cgc_w),1,255);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@razao_pj',ds_razao_social_w),1,255);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w),1,255);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nr_avaliacao',nr_seq_avaliacao_p),1,255);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@tipo_avaliacao',ds_tipo_avaliacao_w),1,255);
		
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@cnpj',cd_cgc_w),1,2000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@razao_pj',ds_razao_social_w),1,2000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@fantasia_pj',nm_fantasia_w),1,2000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nr_avaliacao',nr_seq_avaliacao_p),1,2000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@tipo_avaliacao',ds_tipo_avaliacao_w),1,2000);

		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (nm_usuario_compras_w IS NOT NULL AND nm_usuario_compras_w::text <> '') then
			begin

			if (ie_momento_envio_w = 'A') then
				begin

				CALL sup_grava_envio_email(
					'PJ',
					'48',
					0,
					null,
					null,
					ds_email_destino_w,
					nm_usuario_compras_w,
					ds_email_origem_w,
					ds_assunto_w,
					ds_mensagem_w,
					cd_estabelecimento_p,
					nm_usuario_compras_w);

				end;
			else
				begin
				CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_email_destino_w,nm_usuario_compras_w,'M');
				exception when others then
					ds_assunto_w := '';
				end;
			end if;

			end;
		end if;
	end if;
	end;
end if;
exception when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(188118,'SQLERR=' || substr(sqlerrm,1,2000));
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_aval_respondida_fornec ( nr_seq_avaliacao_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

