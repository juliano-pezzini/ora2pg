-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_fin_obter_vl_balan_trib ( nr_seq_diops_coop_res_p bigint, nr_seq_periodo_p bigint, nr_seq_operadora_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_conta_contab_sup_w			diops_fin_trib_coop_resumo.cd_conta_contabil%type;
ie_normal_encerramento_w		diops_periodo.ie_normal_encerramento%type;
cd_classificacao_w			conta_contabil.cd_classificacao%type;
vl_total_pago_w				diops_fin_trib_coop.vl_total_pago%type;
vl_totalizar_pago_w			diops_fin_trib_coop_resumo.vl_total_pago%type;
vl_saldo_final_total_w			diops_fin_trib_coop_resumo.vl_saldo_final%type;
vl_saldo_anterior_total_w		diops_fin_trib_coop_resumo.vl_saldo_anterior%type;
dt_periodo_inicial_w			timestamp;
dt_periodo_final_w			timestamp;

c_valores CURSOR FOR 
	SELECT	a.cd_conta_contabil, 
		sum(CASE WHEN a.dt_referencia=dt_periodo_inicial_w THEN  a.vl_saldo_ant  ELSE 0 END ) vl_saldo_anterior, 
		sum(CASE WHEN trunc(a.dt_referencia, 'month')=trunc(dt_periodo_final_w, 'month') THEN  a.vl_saldo  ELSE 0 END ) vl_saldo_final, 
		a.dt_referencia 
	from	ctb_balancete_v	a 
	where	ctb_obter_se_conta_classif_sup(a.cd_conta_contabil,cd_classificacao_w) = 'S' 
	and	a.ie_normal_encerramento	= ie_normal_encerramento_w 
	and	a.dt_referencia between dt_periodo_inicial_w and dt_periodo_final_w 
	group by 
		a.cd_conta_contabil, 
		a.dt_referencia;
	
c_valores_w		c_valores%rowtype;


BEGIN 
delete	from diops_fin_trib_coop 
where	nr_seq_diops_coop_res	= nr_seq_diops_coop_res_p;
 
begin 
select	coalesce(a.dt_periodo_inicial, ''), 
	coalesce(a.dt_periodo_final, ''), 
	coalesce(a.ie_normal_encerramento, 'N') 
into STRICT	dt_periodo_inicial_w, 
	dt_periodo_final_w, 
	ie_normal_encerramento_w 
from	diops_periodo	a 
where	a.nr_sequencia	= nr_seq_periodo_p;
exception 
when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174234, 'NR_SEQ_OPERADORA=' || nr_seq_operadora_p || ';' || 
							'NR_SEQ_PERIODO=' || nr_seq_periodo_p);
end;
 
select	max(a.cd_conta_contabil) 
into STRICT	cd_conta_contab_sup_w 
from	diops_fin_trib_coop_resumo	a 
where	a.nr_sequencia	= nr_seq_diops_coop_res_p;
 
cd_classificacao_w	:= ctb_obter_classif_conta(cd_conta_contab_sup_w, null, dt_periodo_final_w);
 
vl_totalizar_pago_w		:= 0;
vl_saldo_final_total_w		:= 0;
vl_saldo_anterior_total_w	:= 0;
 
open c_valores;
loop 
fetch c_valores into	 
	c_valores_w;
EXIT WHEN NOT FOUND; /* apply on c_valores */
	begin 
	vl_total_pago_w	:= c_valores_w.vl_saldo_final - c_valores_w.vl_saldo_anterior;
	 
	insert into diops_fin_trib_coop(nr_sequencia, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_diops_coop_res, 
		cd_conta_contabil, 
		dt_referencia_trib, 
		vl_saldo_anterior, 
		vl_saldo_final, 
		vl_total_pago) 
	values (nextval('diops_fin_trib_coop_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_diops_coop_res_p, 
		c_valores_w.cd_conta_contabil, 
		c_valores_w.dt_referencia, 
		c_valores_w.vl_saldo_anterior, 
		c_valores_w.vl_saldo_final, 
		vl_total_pago_w);
		 
	vl_totalizar_pago_w		:= vl_totalizar_pago_w + vl_total_pago_w;
	vl_saldo_final_total_w		:= vl_saldo_final_total_w + c_valores_w.vl_saldo_final;
	vl_saldo_anterior_total_w	:= vl_saldo_anterior_total_w + c_valores_w.vl_saldo_anterior;
	end;
end loop;
close c_valores;
 
update	diops_fin_trib_coop_resumo 
set	vl_total_pago		= vl_totalizar_pago_w, 
	vl_saldo_final		= vl_saldo_final_total_w, 
	vl_saldo_anterior	= vl_saldo_anterior_total_w 
where	nr_sequencia		= nr_seq_diops_coop_res_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_fin_obter_vl_balan_trib ( nr_seq_diops_coop_res_p bigint, nr_seq_periodo_p bigint, nr_seq_operadora_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

