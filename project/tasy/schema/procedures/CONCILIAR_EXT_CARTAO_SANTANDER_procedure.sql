-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE conciliar_ext_cartao_santander ( nr_seq_extrato_arq_p bigint, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*	ie_opcao_p

C	Conciliar
D	Desconciliar

*/
nr_seq_parcela_w	bigint;
qt_nao_concil_w		bigint;
vl_parcela_w		double precision;

ds_comprovante_w	varchar(100);
nr_autorizacao_w	varchar(40);
nr_cartao_w		numeric(20);
nr_parcela_w		bigint;
nr_resumo_w		varchar(20);
nr_seq_bandeira_w	bigint;
nr_seq_movto_w		bigint;
nr_seq_parcela_concil_w	bigint;
nr_documento_w		varchar(100);
cd_bandeira_w		varchar(3);
vl_saldo_concil_fin_w	double precision;
nr_seq_grupo_w		bigint;
vl_min_indevido_w	double precision;
vl_max_indevido_w	double precision;
vl_ajuste_w		extrato_cartao_cr_movto.vl_ajuste%type;
ie_parcela_superior_w	varchar(1);
nr_seq_extrato_parcela_w	extrato_cartao_cr_parcela.nr_sequencia%type;
nr_seq_extrato_w	extrato_cartao_cr.nr_sequencia%type;

c01 CURSOR FOR
SELECT	b.ds_comprovante,
	b.nr_autorizacao,
	somente_numero(b.nr_cartao),
	b.nr_parcela,
	a.nr_resumo,
	a.nr_seq_bandeira,
	b.nr_seq_parcela,
	b.nr_sequencia,
	b.nr_documento,
	c.cd_bandeira,
	b.vl_saldo_concil_fin
FROM extrato_cartao_cr_movto b, extrato_cartao_cr_res a
LEFT OUTER JOIN bandeira_cartao_cr c ON (a.nr_seq_bandeira = c.nr_sequencia)
WHERE (coalesce(ds_lista_extrato_movto_fin_p::text, '') = '' or ' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || b.nr_sequencia || ' %') and coalesce(b.ie_pagto_indevido,'N')	= 'N' and a.nr_sequencia		= b.nr_seq_extrato_res and a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;


BEGIN

select	max(a.nr_seq_grupo),
	max(a.nr_sequencia)
into STRICT	nr_seq_grupo_w,
	nr_seq_extrato_w
from	extrato_cartao_cr a,
	extrato_cartao_cr_arq b
where	b.nr_seq_extrato	= a.nr_sequencia
and	b.nr_sequencia		= nr_seq_extrato_arq_p;

select	max(a.vl_min_indevido),
	max(a.vl_max_indevido)
into STRICT	vl_min_indevido_w,
	vl_max_indevido_w
from	grupo_band_cr_regra a
where	a.nr_seq_grupo	= nr_seq_grupo_w;

ie_parcela_superior_w := obter_param_usuario(3020, 40, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_parcela_superior_w);

open	c01;
loop
fetch	c01 into
	ds_comprovante_w,
	nr_autorizacao_w,
	nr_cartao_w,
	nr_parcela_w,
	nr_resumo_w,
	nr_seq_bandeira_w,
	nr_seq_parcela_concil_w,
	nr_seq_movto_w,
	nr_documento_w,
	cd_bandeira_w,
	vl_saldo_concil_fin_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_opcao_p = 'C') and (coalesce(nr_seq_parcela_concil_w::text, '') = '') then

		select	max(b.nr_sequencia)
		into STRICT	nr_seq_parcela_w
		from	bandeira_cartao_cr c,
			movto_cartao_cr_parcela b,
			movto_cartao_cr a
		where	c.cd_bandeira		= coalesce(cd_bandeira_w,c.cd_bandeira)
		and	a.nr_seq_bandeira	= c.nr_sequencia
		and (coalesce(ds_lista_extrato_movto_cred_p::text, '') = '' or ' ' || ds_lista_extrato_movto_cred_p || ' ' like '% ' || b.nr_sequencia || ' %')
		and	not exists (SELECT	1
			from	extrato_cartao_cr_movto x
			where	x.nr_seq_parcela	= b.nr_sequencia)
		and (coalesce(nr_parcela_w,0) = 0 or obter_numero_parcela_cartao(a.nr_sequencia,b.nr_sequencia) = nr_parcela_w)
		and (coalesce(b.nr_resumo::text, '') = '' or b.nr_resumo = coalesce(nr_resumo_w,b.nr_resumo))
		and	a.nr_sequencia		= b.nr_seq_movto
		and	coalesce(a.dt_cancelamento::text, '') = ''
		and 	coalesce(b.nr_seq_extrato_parcela::text, '') = '' --A parcela nao pode estar conciliada
		and (coalesce(a.nr_cartao::text, '') = '' or coalesce(somente_numero(a.nr_cartao),0) = coalesce(nr_cartao_w,coalesce(somente_numero(a.nr_cartao),0)))
		and (ltrim(trim(both a.nr_autorizacao),'0')	= ltrim(trim(both coalesce(nr_autorizacao_w,a.nr_autorizacao)),'0') or (coalesce(ds_comprovante_w::text, '') = '' and coalesce(nr_documento_w::text, '') = '') or (coalesce(a.ds_comprovante,'X') = coalesce(ds_comprovante_w,'X')) or (coalesce(a.ds_comprovante,'X') = nr_documento_w));
			
		if (nr_seq_parcela_w IS NOT NULL AND nr_seq_parcela_w::text <> '') then

			select	max(a.vl_parcela)
			into STRICT	vl_parcela_w
			from	movto_cartao_cr_parcela a
			where	a.nr_sequencia	= nr_seq_parcela_w;
			
			vl_ajuste_w	:= 0;

			if	((coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0))	>= coalesce(vl_min_indevido_w,0)) and
				((coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0))	<= coalesce(vl_max_indevido_w,0)) then

				vl_ajuste_w	:= coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0);
				vl_parcela_w	:= vl_saldo_concil_fin_w;

			end if;

			if (vl_parcela_w	> 0) and
				((vl_parcela_w	<= vl_saldo_concil_fin_w) or (coalesce(ie_parcela_superior_w,'N') = 'S')) then
				
				select	nextval('extrato_cartao_cr_parcela_seq')
				into STRICT	nr_seq_extrato_parcela_w
				;
				
				insert	into	extrato_cartao_cr_parcela(nr_sequencia,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_atualizacao,
					nm_usuario,
					nr_seq_extrato_arq,
					nr_seq_extrato)
				values (nr_seq_extrato_parcela_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_extrato_arq_p,
					nr_seq_extrato_w);

				update	extrato_cartao_cr_movto
				set	nr_seq_parcela		= nr_seq_parcela_w,
					nr_seq_extrato_parcela	= nr_seq_extrato_parcela_w,
					vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0),
					vl_ajuste		= vl_ajuste_w,
					ie_pagto_indevido	= 'N',
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	nr_sequencia		= nr_seq_movto_w;
			
			end if;

		end if;

	elsif (ie_opcao_p = 'D') and (nr_seq_parcela_concil_w IS NOT NULL AND nr_seq_parcela_concil_w::text <> '') then

		select	max(a.vl_parcela)
		into STRICT	vl_parcela_w
		from	movto_cartao_cr_parcela a
		where	a.nr_sequencia	= nr_seq_parcela_concil_w;

		update	extrato_cartao_cr_movto
		set	nr_seq_parcela		 = NULL,
			nr_seq_extrato_parcela	 = NULL,
			vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) + coalesce(vl_parcela_w,0),
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_movto_w;

	end if;

end	loop;
close	c01;

select	count(*)
into STRICT	qt_nao_concil_w
from	extrato_cartao_cr_movto b,
	extrato_cartao_cr_res a
where	coalesce(b.vl_saldo_concil_fin,0) <> 0
and	a.nr_sequencia		= b.nr_seq_extrato_res
and	a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;

update	extrato_cartao_cr_arq
set	dt_conciliacao		= CASE WHEN qt_nao_concil_w=0 THEN clock_timestamp()  ELSE null END ,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_extrato_arq_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_ext_cartao_santander ( nr_seq_extrato_arq_p bigint, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

