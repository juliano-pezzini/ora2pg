-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_setor_exec_adep ( nr_atendimento_p bigint, ie_tipo_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, ie_setor_p text) AS $body$
DECLARE


cd_setor_exec_w		setor_atendimento.cd_setor_atendimento%type;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	/* obter setor paciente */

	cd_setor_exec_w	:= obter_unidade_atendimento(nr_atendimento_p,'A','CS');

	if (ie_tipo_item_p = 'D') then /* dietas orais */
		update	prescr_dieta_hor
		set	cd_setor_exec	= cd_setor_exec_w
		where	nr_sequencia	= nr_seq_horario_p;

	elsif (ie_tipo_item_p in ('S','M', 'IAH', 'LD')) then /* suplementos orais e medicamentos */
		if (coalesce(nr_seq_horario_p,0) > 0) then
			update	prescr_mat_hor
			set	cd_setor_exec	= cd_setor_exec_w
			where	nr_sequencia	= nr_seq_horario_p;
		else
			update	prescr_mat_hor
			set	cd_setor_exec		= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_seq_material	= nr_seq_item_p;
		end if;

	elsif (ie_tipo_item_p in ('P','G','C','I')) then /* procedimentos e controles de glicemia */
		if (coalesce(nr_seq_horario_p,0) > 0) then
			update	prescr_proc_hor
			set	cd_setor_exec	= cd_setor_exec_w
			where	nr_sequencia	= nr_seq_horario_p;
		else
			update	prescr_proc_hor
			set	cd_setor_exec		= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_seq_procedimento	= nr_seq_item_p;
		end if;

	elsif (ie_tipo_item_p = 'R') then /* recomendacoes */
		if (coalesce(nr_seq_horario_p,0) > 0) then
			update	prescr_rec_hor
			set	cd_setor_exec	= cd_setor_exec_w
			where	nr_sequencia	= nr_seq_horario_p;
		else
			update	prescr_rec_hor
			set	cd_setor_exec		= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_seq_recomendacao	= nr_seq_item_p;
		end if;

	elsif (ie_tipo_item_p = 'E') then /* sae */
		if (coalesce(nr_seq_horario_p,0) > 0) then
			update	pe_prescr_proc_hor
			set	cd_setor_exec	= cd_setor_exec_w
			where	nr_sequencia	= nr_seq_horario_p;
		else
			update	pe_prescr_proc_hor
			set	cd_setor_exec		= cd_setor_exec_w
			where	nr_seq_pe_prescr	= nr_prescricao_p
			and	nr_seq_pe_proc	= nr_seq_item_p;
		end if;

	elsif (ie_tipo_item_p = '1') then /* solucoes */
		if (ie_setor_p = 'I') then
			update	prescr_solucao
			set	cd_setor_exec_inic	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_item_p;

		elsif (ie_setor_p = 'F') then
			update	prescr_solucao
			set	cd_setor_exec_fim	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_item_p;

		end if;

	elsif (ie_tipo_item_p = '2') then /* suporte nutricional enteral */
		if (ie_setor_p = 'I') then
			update	prescr_material
			set	cd_setor_exec_inic	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		elsif (ie_setor_p = 'F') then
			update	prescr_material
			set	cd_setor_exec_fim	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		end if;

	elsif (ie_tipo_item_p = '3') then /* hemocomponente */
		if (ie_setor_p = 'I') then
			update	prescr_procedimento
			set	cd_setor_exec_inic	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		elsif (ie_setor_p = 'F') then
			update	prescr_procedimento
			set	cd_setor_exec_fim	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		end if;

	elsif (ie_tipo_item_p = '4') then /* npt adulta */
		if (ie_setor_p = 'I') then
			update	nut_paciente
			set	cd_setor_exec_inic	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		elsif (ie_setor_p = 'F') then
			update	nut_paciente
			set	cd_setor_exec_fim	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		end if;

	elsif (ie_tipo_item_p = '5') then /* npt neo */
		if (ie_setor_p = 'I') then
			update	nut_pac
			set	cd_setor_exec_inic	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		elsif (ie_setor_p = 'F') then
			update	nut_pac
			set	cd_setor_exec_fim	= cd_setor_exec_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_item_p;

		end if;

	end if;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_setor_exec_adep ( nr_atendimento_p bigint, ie_tipo_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, ie_setor_p text) FROM PUBLIC;

