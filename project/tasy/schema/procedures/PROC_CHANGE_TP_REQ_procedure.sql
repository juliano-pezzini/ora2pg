-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE latam_req_rec AS (
    nr_sequencia        LATAM_REQUISITO.NR_SEQUENCIA%type,
    ie_liberar_desenv   LATAM_REQUISITO.IE_LIBERAR_DESENV%type,
    ie_type_requirement LATAM_REQUISITO.IE_TYPE_REQUIREMENT%type
);


CREATE OR REPLACE PROCEDURE proc_change_tp_req ( nr_sequencia_p text, nm_usuario_p LATAM_REQUISITO.NM_USUARIO%type ) AS $body$
DECLARE

TYPE latam_req_tab  IS TABLE OF latam_req_rec;
latam_req_tab_w     latam_req_tab;

BEGIN
    SELECT  a.NR_SEQUENCIA,
            a.IE_LIBERAR_DESENV,
            coalesce(a.IE_TYPE_REQUIREMENT, 'SR') ie_type_requirement
    BULK COLLECT INTO STRICT latam_req_tab_w
    FROM    LATAM_REQUISITO a
    WHERE   ((
                coalesce(a.NR_SEQ_SUPERIOR::text, '') = ''
                AND coalesce(a.IE_TYPE_REQUIREMENT, 'BR') = 'BR'
              ) 
              OR coalesce(a.IE_TYPE_REQUIREMENT, 'SR') = 'SR'
            )
    AND     a.NR_SEQUENCIA IN (WITH RECURSIVE cte AS (

                SELECT  REGEXP_SUBSTR(nr_sequencia_p,'[^, ]+', 1, level) 
                
                (REGEXP_SUBSTR(
                    nr_sequencia_p,
                    '[^, ]+', 
                    1,
                LEVEL) IS NOT NULL AND (REGEXP_SUBSTR(
                    nr_sequencia_p,
                    '[^, ]+', 
                    1,
                LEVEL))::text <> '')
              UNION ALL

                SELECT  REGEXP_SUBSTR(nr_sequencia_p,'[^, ]+', 1, level) JOIN cte c ON ()

) SELECT * FROM cte;
);

  FOR latam_req_id IN 1 .. latam_req_tab_w.COUNT LOOP
    UPDATE  LATAM_REQUISITO
    SET     NM_USUARIO          = nm_usuario_p,
            DT_ATUALIZACAO      = clock_timestamp(),
            IE_TYPE_REQUIREMENT = CASE WHEN                 coalesce(latam_req_tab_w[latam_req_id].ie_type_requirement, 'SR')='SR' THEN                  'BR'  ELSE 'SR' END
    WHERE   NR_SEQUENCIA        = latam_req_tab_w[latam_req_id].nr_sequencia;

    CALL GENERATE_LATAM_LOG(
        latam_req_tab_w[latam_req_id].nr_sequencia,
        latam_req_tab_w[latam_req_id].ie_liberar_desenv,
        CASE WHEN latam_req_tab_w[latam_req_id].ie_type_requirement = 'SR'
        THEN 1061331
        ELSE 1061333
        END
    );

    COMMIT;
   END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proc_change_tp_req ( nr_sequencia_p text, nm_usuario_p LATAM_REQUISITO.NM_USUARIO%type ) FROM PUBLIC;

