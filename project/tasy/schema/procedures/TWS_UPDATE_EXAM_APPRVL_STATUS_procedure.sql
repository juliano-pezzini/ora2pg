-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tws_update_exam_apprvl_status ( nr_prescricao_p wsuite_exam_approval.nr_prescricao%type, nr_seq_prescricao_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_prescr_proc_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_ext_p wsuite_exam_approval.nr_seq_ext%type, nr_seq_result_ext_p wsuite_exam_approval.nr_seq_result_ext%type, nr_seq_laudo_p wsuite_exam_approval.nr_seq_laudo%type, nm_usuario_p text, ie_approve_p text, ie_lab_p text ) AS $body$
DECLARE


/*
  ie_approve_p
    S - Approve
    N - Undo approve
  
  ie_lab_p
    S - Lab exam
    N - Non lab exam
*/
BEGIN

  if (ie_approve_p = 'S') then

    insert into wsuite_exam_approval(nr_sequencia, 
      nr_prescricao,
      nr_seq_prescricao,
      nm_usuario, 
      dt_atualizacao,
      nr_seq_laudo,
      nr_seq_result_ext,
      nr_seq_ext,
      ie_approved)
    values (nextval('wsuite_exam_approval_seq'), 
      nr_prescricao_p,
      coalesce(nr_seq_prescricao_p, coalesce(nr_seq_prescr_proc_p, 0)),
      nm_usuario_p, 
      clock_timestamp(),
      nr_seq_laudo_p,
      nr_seq_result_ext_p,
      nr_seq_ext_p,
      ie_approve_p);

    commit;
    
  elsif (ie_approve_p = 'N') then
  
    if (ie_lab_p = 'S') then
    
      update  wsuite_exam_approval
      set     nm_usuario_nrec = nm_usuario_p,
              dt_atualizacao_nrec = clock_timestamp(),
              ie_approved = ie_approve_p
      where   nr_prescricao = coalesce(nr_prescricao_p,0)
      and (nr_seq_prescricao = coalesce(nr_seq_prescricao_p,0)
      or      nr_seq_prescricao = coalesce(nr_seq_prescr_proc_p,0))
      and     CASE WHEN coalesce(nr_seq_ext_p::text, '') = '' THEN  0  ELSE coalesce(nr_seq_ext,0) END  = coalesce(nr_seq_ext_p,0)
      and     CASE WHEN coalesce(nr_seq_result_ext_p::text, '') = '' THEN  0  ELSE coalesce(nr_seq_result_ext,0) END  = coalesce(nr_seq_result_ext_p,0)
      and     ie_approved = 'S';

    else
      update  wsuite_exam_approval
      set     nm_usuario_nrec = nm_usuario_p,
              dt_atualizacao_nrec = clock_timestamp(),
              ie_approved = ie_approve_p
      where   nr_prescricao = coalesce(nr_prescricao_p, 0)
      and     nr_seq_prescricao = coalesce(nr_seq_prescricao_p, 0)
      and     ie_approved = 'S';

    end if;
    commit;

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_update_exam_apprvl_status ( nr_prescricao_p wsuite_exam_approval.nr_prescricao%type, nr_seq_prescricao_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_prescr_proc_p wsuite_exam_approval.nr_seq_prescricao%type, nr_seq_ext_p wsuite_exam_approval.nr_seq_ext%type, nr_seq_result_ext_p wsuite_exam_approval.nr_seq_result_ext%type, nr_seq_laudo_p wsuite_exam_approval.nr_seq_laudo%type, nm_usuario_p text, ie_approve_p text, ie_lab_p text ) FROM PUBLIC;

