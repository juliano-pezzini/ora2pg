-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_lote_ir ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_indice_w		integer;
tb_nr_seq_detalhe_ir_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_benef_ir_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_pagador_ir_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_envio_ir_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_valores_ir_w	pls_util_cta_pck.t_number_table;

C01 CURSOR(nr_lote_pc pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia
	from	pls_mens_detalhe_ir a,
		pls_mens_beneficiario_ir b,
		pls_mens_pagador_ir c
	where	b.nr_sequencia	= a.nr_seq_beneficiario_ir
	and	c.nr_sequencia	= b.nr_seq_pagador_ir
	and	c.nr_seq_lote	= nr_lote_pc;

C02 CURSOR(nr_lote_pc pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia
	from	pls_mens_beneficiario_ir a,
		pls_mens_pagador_ir b
	where	b.nr_sequencia	= a.nr_seq_pagador_ir
	and	b.nr_seq_lote	= nr_lote_pc;

C03 CURSOR(nr_lote_pc pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_mens_pagador_ir
	where	nr_seq_lote	= nr_lote_pc;
	
C04 CURSOR(nr_lote_pc pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia
	from	pls_mens_valores_ir a,
		pls_mens_beneficiario_ir b,
		pls_mens_pagador_ir c
	where	b.nr_sequencia	= a.nr_seq_benef_ir
	and	c.nr_sequencia	= b.nr_seq_pagador_ir
	and	c.nr_seq_lote	= nr_lote_pc;

C05 CURSOR(nr_lote_pc pls_lote_mens_ir.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_pagador,
		b.nr_sequencia nr_seq_envio
	from	pls_mens_ir_log_envio b,
		pls_mens_pagador_ir a
	where	a.nr_seq_lote	= nr_lote_pc;

BEGIN

--pls_mens_detalhe_ir
nr_indice_w	:= 0;
tb_nr_seq_detalhe_ir_w.delete;
for r_C01_w in C01(nr_seq_lote_p) loop
	begin
	tb_nr_seq_detalhe_ir_w(nr_indice_w)	:= r_C01_w.nr_sequencia;
	
	if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
		forall i in tb_nr_seq_detalhe_ir_w.first..tb_nr_seq_detalhe_ir_w.last
			delete from pls_mens_detalhe_ir where nr_sequencia = tb_nr_seq_detalhe_ir_w(i);
		commit;
		tb_nr_seq_detalhe_ir_w.delete;
		
		nr_indice_w	:= 0;
	else
		nr_indice_w	:= nr_indice_w + 1;
	end if;
	end;
end loop;

if (tb_nr_seq_detalhe_ir_w.count > 0) then
	forall i in tb_nr_seq_detalhe_ir_w.first..tb_nr_seq_detalhe_ir_w.last
		delete from pls_mens_detalhe_ir where nr_sequencia = tb_nr_seq_detalhe_ir_w(i);
	commit;
end if;

--Se existir excluir tambem pls_mens_valores_ir
nr_indice_w	:= 0;
tb_nr_seq_valores_ir_w.delete;
for r_C04_w in C04(nr_seq_lote_p) loop
	begin
	tb_nr_seq_valores_ir_w(nr_indice_w)	:= r_C04_w.nr_sequencia;
	
	if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
		forall i in tb_nr_seq_valores_ir_w.first..tb_nr_seq_valores_ir_w.last
			delete from pls_mens_valores_ir where nr_sequencia = tb_nr_seq_valores_ir_w(i);
		commit;
		tb_nr_seq_valores_ir_w.delete;
		
		nr_indice_w	:= 0;
	else
		nr_indice_w	:= nr_indice_w + 1;
	end if;
	end;
end loop;

if (tb_nr_seq_valores_ir_w.count > 0) then
	forall i in tb_nr_seq_valores_ir_w.first..tb_nr_seq_valores_ir_w.last
		delete from pls_mens_valores_ir where nr_sequencia = tb_nr_seq_valores_ir_w(i);
	commit;
end if;

--pls_mens_beneficiario_ir
nr_indice_w	:= 0;
tb_nr_seq_benef_ir_w.delete;
for r_C02_w in C02(nr_seq_lote_p) loop
	begin
	tb_nr_seq_benef_ir_w(nr_indice_w)	:= r_C02_w.nr_sequencia;
	
	if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
		forall i in tb_nr_seq_benef_ir_w.first..tb_nr_seq_benef_ir_w.last
			delete from pls_mens_beneficiario_ir where nr_sequencia = tb_nr_seq_benef_ir_w(i);
		commit;
		tb_nr_seq_benef_ir_w.delete;
		
		nr_indice_w	:= 0;
	else
		nr_indice_w	:= nr_indice_w + 1;
	end if;
	end;
end loop;

if (tb_nr_seq_benef_ir_w.count > 0) then
	forall i in tb_nr_seq_benef_ir_w.first..tb_nr_seq_benef_ir_w.last
		delete from pls_mens_beneficiario_ir where nr_sequencia = tb_nr_seq_benef_ir_w(i);
	commit;
end if;

--pls_mens_ir_log_envio
nr_indice_w	:= 0;
tb_nr_seq_envio_ir_w.delete;
for r_C05_w in C05(nr_seq_lote_p) loop
	begin
	tb_nr_seq_pagador_ir_w(nr_indice_w)	:= r_C05_w.nr_seq_pagador;
	tb_nr_seq_envio_ir_w(nr_indice_w)	:= r_C05_w.nr_seq_envio;

	if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
		forall i in tb_nr_seq_envio_ir_w.first..tb_nr_seq_envio_ir_w.last
			delete from pls_mens_ir_log_envio where nr_sequencia = tb_nr_seq_envio_ir_w(i);
		commit;
		tb_nr_seq_envio_ir_w.delete;
		
		nr_indice_w	:= 0;
	else
		nr_indice_w	:= nr_indice_w + 1;
	end if;
	end;
end loop;

if (tb_nr_seq_envio_ir_w.count > 0) then
	forall i in tb_nr_seq_envio_ir_w.first..tb_nr_seq_envio_ir_w.last
		delete from pls_mens_ir_log_envio where nr_sequencia = tb_nr_seq_envio_ir_w(i);
	commit;	
end if;

--pls_mens_pagador_ir
nr_indice_w	:= 0;
tb_nr_seq_pagador_ir_w.delete;
for r_C03_w in C03(nr_seq_lote_p) loop
	begin
	tb_nr_seq_pagador_ir_w(nr_indice_w)	:= r_C03_w.nr_sequencia;

	if (nr_indice_w >= pls_util_pck.qt_registro_transacao_w) then
		forall i in tb_nr_seq_pagador_ir_w.first..tb_nr_seq_pagador_ir_w.last
			delete from pls_mens_pagador_ir where nr_sequencia = tb_nr_seq_pagador_ir_w(i);
		commit;
		tb_nr_seq_pagador_ir_w.delete;
		
		nr_indice_w	:= 0;
	else
		nr_indice_w	:= nr_indice_w + 1;
	end if;
	end;
end loop;

if (tb_nr_seq_pagador_ir_w.count > 0) then
	forall i in tb_nr_seq_pagador_ir_w.first..tb_nr_seq_pagador_ir_w.last
		delete from pls_mens_pagador_ir where nr_sequencia = tb_nr_seq_pagador_ir_w(i);
	commit;	
end if;

update	pls_lote_mens_ir
set	dt_geracao_lote	 = NULL,
	dt_inicio_geracao  = NULL,
	dt_fim_geracao	 = NULL,
	qt_pagadores  = NULL,
	nm_usuario	= nm_usuario_p
where	nr_sequencia	= nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_lote_ir ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

