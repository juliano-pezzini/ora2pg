-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_nr_seq_ord_diag ( nr_seq_pe_prescr_p bigint, NR_SEQ_ORDENACAO_P pe_prescr_diag.NR_SEQ_ORDENACAO%TYPE) AS $body$
DECLARE

    wCursor CURSOR FOR SELECT
                            a.NR_SEQUENCIA, a.NR_SEQ_DIAG, coalesce(a.IE_DIAG_COLAB,'N')
                        FROM pe_prescr_diag a
                        WHERE 
                            a.nr_seq_prescr = nr_seq_pe_prescr_p AND coalesce(NR_SEQ_ORDENACAO::text, '') = '';

    Nr_seq_diag_w pe_prescr_diag.NR_SEQ_DIAG%TYPE := null;
    Nr_sequencia_w pe_prescr_diag.NR_SEQUENCIA%TYPE := null;
    NR_SEQ_ORDENACAO_W pe_prescr_diag.NR_SEQ_ORDENACAO%TYPE := null;
    IE_DIAG_COLAB_W pe_prescr_diag.IE_DIAG_COLAB%TYPE := null;

BEGIN
    UPDATE pe_prescr_diag SET NR_SEQ_ORDENACAO  = NULL WHERE NR_SEQ_ORDENACAO > NR_SEQ_ORDENACAO_P AND nr_seq_pe_prescr_p = nr_seq_prescr;

    open	wCursor;
    loop fetch	wCursor into Nr_sequencia_w,Nr_seq_diag_w,IE_DIAG_COLAB_W;
    EXIT WHEN NOT FOUND; /* apply on wCursor */

        NR_SEQ_ORDENACAO_W := OBTER_NUM_ORDENACAO_DIAG(nr_seq_pe_prescr_p,Nr_seq_diag_w, IE_DIAG_COLAB_W);

        UPDATE pe_prescr_diag a SET
            NR_SEQ_ORDENACAO = NR_SEQ_ORDENACAO_W
        WHERE
            a.nr_seq_prescr = nr_seq_pe_prescr_p AND
            a.NR_SEQUENCIA =  Nr_sequencia_w;

    end loop;
    close wCursor;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_nr_seq_ord_diag ( nr_seq_pe_prescr_p bigint, NR_SEQ_ORDENACAO_P pe_prescr_diag.NR_SEQ_ORDENACAO%TYPE) FROM PUBLIC;

