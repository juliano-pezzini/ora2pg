-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_medicamento_ant (nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_material.nr_sequencia%type, nm_usuario_p prescr_medica.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


  -- Duplicacao da procedure CPOE_REP_Gerar_medicamento
  nr_seq_material_w        prescr_material.nr_sequencia%type;
  cd_material_w            prescr_material.cd_material%type;
  cd_unidade_medida_dose_w prescr_material.cd_unidade_medida_dose%type;
  qt_dose_w                prescr_material.qt_dose%type;
  qt_dose_ref_w            cpoe_material.qt_dose%type;
  qt_dose_dia_w            cpoe_material.qt_dose_dia%type;
  ie_acm_w                 prescr_material.ie_acm%type;
  ie_se_necessario_w       prescr_material.ie_se_necessario%type;
  ds_horarios_w            prescr_material.ds_horarios%type;
  hr_prim_horario_w        prescr_material.hr_prim_horario%type;
  cd_intervalo_w           prescr_material.cd_intervalo%type;
  ie_lado_w                prescr_material.ie_lado%type;
  ie_via_aplicacao_w       prescr_material.ie_via_aplicacao%type;
  nr_dia_util_w            prescr_material.nr_dia_util%type;
  qt_total_dias_lib_w      prescr_material.qt_total_dias_lib%type;
  ds_diluicao_edit_w       prescr_material.ds_diluicao_edit%type;
  qt_hora_aplicacao_w      prescr_material.qt_hora_aplicacao%type;
  qt_min_aplicacao_w       prescr_material.qt_min_aplicacao%type;
  qt_solucao_w             prescr_material.qt_solucao%type;
  ie_aplic_bolus_w         prescr_material.ie_aplic_bolus%type;
  ie_aplic_lenta_w         prescr_material.ie_aplic_lenta%type;
  qt_dia_prim_hor_w        prescr_material.qt_dia_prim_hor%type;
  ds_justificativa_w       prescr_material.ds_justificativa%type;
  qt_dias_solicitado_w     prescr_material.qt_dias_solicitado%type;
  qt_dias_liberado_w       prescr_material.qt_dias_liberado%type;
  ie_objetivo_w            prescr_material.ie_objetivo%type;
  cd_microorganismo_cih_w  prescr_material.cd_microorganismo_cih%type;
  cd_amostra_cih_w         prescr_material.cd_amostra_cih%type;
  ie_origem_infeccao_w     prescr_material.ie_origem_infeccao%type;
  cd_topografia_cih_w      prescr_material.cd_topografia_cih%type;
  ie_indicacao_w           prescr_material.ie_indicacao%type;
  ie_uso_antimicrobiano_w  prescr_material.ie_uso_antimicrobiano%type;
  ie_medicacao_paciente_w  prescr_material.ie_medicacao_paciente%type;
  ie_fator_correcao_w      prescr_material.ie_fator_correcao%type;
  ie_bomba_infusao_w       prescr_material.ie_bomba_infusao%type;
  ds_observacao_w          prescr_material.ds_observacao%type;
  nr_ocorrencia_w          prescr_material.nr_ocorrencia%type;
  nr_agrupamento_w         prescr_material.nr_agrupamento%type;
  nr_agrupamento_ww        prescr_material.nr_agrupamento%type := 0;
  cd_perfil_ativo_w        prescr_material.cd_perfil_ativo%type;
  ds_dose_diferenciada_w   prescr_material.ds_dose_diferenciada%type;

  dt_fim_w           cpoe_material.dt_fim%type;
  ie_antibiotico_w   cpoe_material.ie_antibiotico%type;
  ie_administracao_w cpoe_material.ie_administracao%type;
  dt_prim_horario_w  cpoe_material.dt_inicio%type;
  ie_duracao_w       cpoe_material.ie_duracao%type;

  ie_urgencia_w     cpoe_dieta.ie_urgencia%type := '';
  ds_horarios_aux_w cpoe_material.ds_horarios%type := '';
  ie_evento_unico_w cpoe_material.ie_evento_unico%type;
  ie_dose_unica_cpoe_w	intervalo_prescricao.ie_dose_unica_cpoe%type;
  ie_interv_agora_w		intervalo_prescricao.ie_agora%type;
  ie_urgencia_item_w	varchar(1);

  qt_min_intervalo_w intervalo_prescricao.qt_min_intervalo%type;

  ie_prescr_alta_agora_w varchar(1);

  qt_composto_w bigint;

  cd_material_ret_w material.cd_material%type;

  ie_tratamento_vig_w varchar(10);

  tipo_material_w   bigint;

  ie_via_aplicacao_rp_w             cpoe_rp.ie_via_aplicacao%type := null;
  nr_seq_grupo_interval_rp_w        cpoe_rp.nr_seq_grupo_interval%type := null;
  nr_seq_subgrupo_interval_rp_w     cpoe_rp.nr_seq_subgrupo_interval%type := null;
  cd_intervalo_rp_w                 cpoe_rp.cd_intervalo%type := null;
  dt_inicio_rp_w                    cpoe_rp.dt_inicio%type := null;
  dt_fim_rp_w                       cpoe_rp.dt_fim%type := null;
  ds_horarios_rp_w                  cpoe_rp.ds_horarios%type := null;
  ie_segunda_rp_w                   cpoe_rp.ie_segunda%type := null;
  ie_terca_rp_w                     cpoe_rp.ie_terca%type := null;
  ie_quarta_rp_w                    cpoe_rp.ie_quarta%type := null;
  ie_quinta_rp_w                    cpoe_rp.ie_quinta%type := null;
  ie_sexta_rp_w                     cpoe_rp.ie_sexta%type := null;
  ie_sabado_rp_w                    cpoe_rp.ie_sabado%type := null;
  ie_domingo_rp_w                   cpoe_rp.ie_domingo%type := null;
  ie_duracao_rp_w                   protocolo_medic_material.ie_duracao%type := null;
  IE_USE_ITEM_TYPES_W               varchar(1);
  c01 CURSOR FOR
    SELECT nr_sequencia,
           cd_material,
           cd_unidade_medida_dose,
           qt_dose,
           coalesce(ie_acm, 'N'),
           coalesce(ie_se_necessario, 'N'),
           ds_horarios,
           hr_prim_horario,
           cd_intervalo,
           ie_lado,
           ie_via_aplicacao,
           nr_ocorrencia,
           qt_total_dias_lib,
           ds_diluicao_edit,
           qt_hora_aplicacao,
           qt_min_aplicacao,
           qt_solucao,
           coalesce(ie_aplic_bolus, 'N'),
           coalesce(ie_aplic_lenta, 'N'),
           ds_justificativa,
           qt_dias_solicitado,
           ie_objetivo,
           cd_microorganismo_cih,
           cd_amostra_cih,
           ie_origem_infeccao,
           cd_topografia_cih,
           ie_indicacao,
           coalesce(ie_uso_antimicrobiano, 'N'),
           coalesce(ie_medicacao_paciente, 'N'),
           coalesce(ie_fator_correcao, 'N'),
           ie_bomba_infusao,
           ds_observacao,
           nr_agrupamento,
           ds_dose_diferenciada
      from prescr_material
     where nr_prescricao = nr_prescricao_p
       and nr_sequencia = nr_sequencia_p;


BEGIN

  ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);

  open c01;
  loop
    fetch c01
      into nr_seq_material_w, cd_material_w, cd_unidade_medida_dose_w, qt_dose_w, ie_acm_w, ie_se_necessario_w, ds_horarios_w, hr_prim_horario_w, cd_intervalo_w, ie_lado_w, ie_via_aplicacao_w, nr_ocorrencia_w, qt_total_dias_lib_w, ds_diluicao_edit_w, qt_hora_aplicacao_w, qt_min_aplicacao_w, qt_solucao_w, ie_aplic_bolus_w, ie_aplic_lenta_w, ds_justificativa_w, qt_dias_solicitado_w, ie_objetivo_w, cd_microorganismo_cih_w, cd_amostra_cih_w, ie_origem_infeccao_w, cd_topografia_cih_w, ie_indicacao_w, ie_uso_antimicrobiano_w, ie_medicacao_paciente_w, ie_fator_correcao_w, ie_bomba_infusao_w, ds_observacao_w, nr_agrupamento_w, ds_dose_diferenciada_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    begin


    tipo_material_w := obter_tipo_material(cd_material_w, 'C');

    if (tipo_material_w = '3') then
      cd_material_ret_w := obter_regra_subst_gen(NULL, nr_atendimento_p, cd_material_w, wheb_usuario_pck.get_cd_estabelecimento);
    else
      cd_material_ret_w := obter_regra_subst_com(NULL,cd_material_w,nr_atendimento_p);
    end if;

    if (coalesce(cd_material_ret_w,0) = 0) then
    cd_material_ret_w := cpoe_substituir_medic_apres(cd_estabelecimento_p, obter_convenio_atendimento(nr_atendimento_p), cd_material_w);
    end if;

      IF (coalesce(cd_material_ret_w, 0) > 0) THEN
        cd_material_w := cd_material_ret_w;
      end if;

      if (nr_agrupamento_w <> nr_agrupamento_ww) then
        nr_agrupamento_ww := nr_agrupamento_w;

        qt_composto_w      := 1;
        ie_administracao_w := 'P';
        ie_duracao_w       := 'C';

        if (coalesce(ie_prescr_alta_agora_w, 'N') = 'S') and (coalesce(ie_item_alta_p, 'N') = 'S') then

          ie_urgencia_w := 0;

          select max(qt_min_intervalo)
            into STRICT qt_min_intervalo_w
            from intervalo_prescricao
           where cd_intervalo = cd_intervalo_w;

          SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, cd_material_w, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

          ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;

          hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
          dt_prim_horario_w := to_date(to_char(clock_timestamp(), 'dd/mm/yyyy ') ||
                                       hr_prim_horario_w,
                                       'dd/mm/yyyy hh24:mi');

          if (dt_prim_horario_w < clock_timestamp()) then
            dt_prim_horario_w := dt_prim_horario_w + 1;
          end if;
        else
          ie_urgencia_w := '';
          SELECT * FROM cpoe_atualizar_periodo_vig_ant(ds_horarios_w, hr_prim_horario_w, dt_prim_horario_w) INTO STRICT ds_horarios_w, hr_prim_horario_w, dt_prim_horario_w;
										
			if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
				select	max(ie_dose_unica_cpoe),
						coalesce(max(ie_agora),'N'),
						max(qt_min_intervalo)
				into STRICT	ie_dose_unica_cpoe_w,
						ie_interv_agora_w,
						qt_min_intervalo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_w;
				
				if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
				
					ie_duracao_w := 'P';
					ie_evento_unico_w 	:= 'S';
					
					ie_se_necessario_w 	:= 'N';
					ie_acm_w			:= 'N';
					
					if (ie_interv_agora_w = 'S') then
						ie_urgencia_item_w 	:= 'S';
					end if;
				end if;
			end if;
			
			SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, cd_material_w, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

			ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;

			hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
			dt_prim_horario_w := to_date(to_char(clock_timestamp(), 'dd/mm/yyyy ') ||hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
        end if;

		if (ie_urgencia_item_w = 'S') then
			ie_urgencia_w		:= '0';
			ie_se_necessario_w	:= 'N';
			ie_acm_w			:= 'N';
		else
			ie_urgencia_w := null;
			if (ie_acm_w = 'S') then
			  ie_administracao_w := 'C';
			  hr_prim_horario_w  := '';
			  ds_horarios_w      := '';
			elsif (ie_se_necessario_w = 'S') then
			  ie_administracao_w := 'N';
			  hr_prim_horario_w  := '';
			  ds_horarios_w      := '';
			end if;
		end if;

        if (coalesce(cd_unidade_medida_dose_w::text, '') = '') then
          select max(cd_unidade_medida_consumo)
            into STRICT cd_unidade_medida_dose_w
            from material
           where cd_material = cd_material_w;
        end if;

        ie_antibiotico_w := coalesce(obter_se_mat_ctrl_antibiotico(cd_material_w), 'N');

        if (coalesce(ie_antibiotico_w, 'N') = 'S') then
          ie_duracao_w := 'P';
        end if;

        if (ie_duracao_w = 'P') then
          if (coalesce(ie_antibiotico_w, 'N') = 'S') then
            dt_fim_w := (dt_prim_horario_w + coalesce(qt_dias_solicitado_w, 1)) -
                        1 / 1440;
          else
            dt_fim_w := (dt_prim_horario_w + 1) - 1 / 1440;
          end if;
        end if;

        if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then
          -- retrograde/backward item
          dt_prim_horario_w := dt_inicio_p;
          dt_fim_w          := (dt_prim_horario_w + 1) - 1 / 1440;
		  ie_duracao_w    := 'P';
		  ie_urgencia_w   := null;

		  select max(qt_min_intervalo)
		  into STRICT qt_min_intervalo_w
		  from intervalo_prescricao
		  where cd_intervalo = cd_intervalo_w;

          SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_prim_horario_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

          ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;
          hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
        end if;

        select nextval('cpoe_material_seq')
          into STRICT nr_seq_item_gerado_p
;

    if (coalesce(ie_antibiotico_w, 'N') = 'S') then
      SELECT * FROM cpoe_obter_nr_dias_util_cih(nr_seq_item_gerado_p, nr_atendimento_p, cd_pessoa_fisica_p, cd_material_w, dt_prim_horario_w, dt_fim_w, null, /*dt_fim_cih_w*/
                    null, /*dt_suspensao_w */
                    null, /*dt_lib_suspensao_w */
                    null, /*nr_seq_cpoe_anterior_w */
                    nr_dia_util_w, ie_tratamento_vig_w, qt_dias_liberado_w) INTO STRICT 
                    nr_dia_util_w, ie_tratamento_vig_w, qt_dias_liberado_w;
    end if;

    IE_USE_ITEM_TYPES_W := obter_param_usuario(2314, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, IE_USE_ITEM_TYPES_W);
    if (coalesce(IE_USE_ITEM_TYPES_W, 'N') = 'S') then

    select
      ie_via_aplicacao
      ,nr_seq_grupo_interval
      ,nr_seq_subgrupo_interval
      ,cd_intervalo
      ,dt_inicio
      ,dt_fim
      ,ds_horarios
      ,ie_segunda
      ,ie_terca
      ,ie_quarta
      ,ie_quinta
      ,ie_sexta
      ,ie_sabado
      ,ie_domingo
    into STRICT
      ie_via_aplicacao_rp_w
      ,nr_seq_grupo_interval_rp_w
      ,nr_seq_subgrupo_interval_rp_w
      ,cd_intervalo_rp_w
      ,dt_inicio_rp_w
      ,dt_fim_rp_w
      ,ds_horarios_rp_w
      ,ie_segunda_rp_w
      ,ie_terca_rp_w
      ,ie_quarta_rp_w
      ,ie_quinta_rp_w
      ,ie_sexta_rp_w
      ,ie_sabado_rp_w
      ,ie_domingo_rp_w
    from cpoe_rp
    where  nr_sequencia = nr_seq_cpoe_rp_p;

	ie_duracao_rp_w := 'P';

  end if;
    
      if (obtain_user_locale(nm_usuario_p) = 'ja_JP') then
        qt_dose_ref_w := qt_dose_w;
        SELECT * FROM cpoe_get_dose_or_daily_dose(coalesce(ie_via_aplicacao_rp_w,ie_via_aplicacao_w), coalesce(cd_intervalo_rp_w,cd_intervalo_w), qt_dose_ref_w, qt_dose_dia_w) INTO STRICT qt_dose_ref_w, qt_dose_dia_w;
      end if;

        insert into cpoe_material(nr_sequencia,
           nr_atendimento,
           cd_pessoa_fisica,
           ie_controle_tempo,
           ie_administracao,
           ie_duracao,
           dt_inicio,
           cd_material,
           cd_unidade_medida,
           qt_dose,
           qt_dose_dia,
           ie_acm,
           ie_se_necessario,
           ie_urgencia,
           ds_horarios,
           hr_prim_horario,
           cd_intervalo,
           ie_lado,
           ie_via_aplicacao,
           nr_dia_util,
           nr_ocorrencia,
           qt_total_dias_lib,
           ds_orientacao_preparo,
           qt_hora_aplicacao,
           qt_min_aplicacao,
           qt_solucao,
           ie_aplic_bolus,
           ie_aplic_lenta,
           ds_justificativa,
           qt_dias_solicitado,
           qt_dias_liberado,
           ie_objetivo,
           cd_microorganismo_cih,
           cd_amostra_cih,
           ie_origem_infeccao,
           cd_topografia_cih,
           ie_indicacao,
           ie_uso_antimicrobiano,
           ie_medicacao_paciente,
           ie_fator_correcao,
           ie_bomba_infusao,
           ds_observacao,
           nm_usuario,
           nm_usuario_nrec,
           dt_atualizacao,
           dt_atualizacao_nrec,
           cd_perfil_ativo,
           qt_tempo_aplicacao,
           ds_dose_diferenciada,
           ie_material,
           cd_funcao_origem,
           dt_fim,
           nr_seq_transcricao,
           ie_item_alta,
           ie_prescritor_aux,
           cd_medico,
           ie_retrogrado,
           nr_seq_pepo,
           nr_cirurgia,
           nr_cirurgia_patologia,
           nr_seq_agenda,
           ie_oncologia,
           nr_seq_conclusao_apae,
           ie_futuro,
           nr_seq_cpoe_rp,
           nr_seq_cpoe_order_unit
          ,nr_seq_grupo_interval
          ,nr_seq_subgrupo_interval
          ,ie_segunda
          ,ie_terca
          ,ie_quarta
          ,ie_quinta
          ,ie_sexta
          ,ie_sabado
          ,ie_domingo
		  ,ie_antibiotico
		  ,ie_evento_unico
          )
        values (nr_seq_item_gerado_p,
           nr_atendimento_p,
           obter_cd_paciente_prescricao(nr_prescricao_p),
           'N',
           ie_administracao_w,
           coalesce(ie_duracao_rp_w,ie_duracao_w),
           coalesce(dt_inicio_rp_w,dt_prim_horario_w),
           cd_material_w,
           cd_unidade_medida_dose_w,
           qt_dose_w,
           qt_dose_dia_w,
           ie_acm_w,
           ie_se_necessario_w,
           ie_urgencia_w,
           coalesce(ds_horarios_rp_w,ds_horarios_w),
           hr_prim_horario_w,
           coalesce(cd_intervalo_rp_w,cd_intervalo_w),
           ie_lado_w,
           coalesce(ie_via_aplicacao_rp_w, ie_via_aplicacao_w),
           nr_dia_util_w,
           nr_ocorrencia_w,
           qt_total_dias_lib_w,
           ds_diluicao_edit_w,
           qt_hora_aplicacao_w,
           qt_min_aplicacao_w,
           qt_solucao_w,
           ie_aplic_bolus_w,
           ie_aplic_lenta_w,
           ds_justificativa_w,
           qt_dias_solicitado_w,
           qt_dias_liberado_w,
           ie_objetivo_w,
           cd_microorganismo_cih_w,
           cd_amostra_cih_w,
           ie_origem_infeccao_w,
           cd_topografia_cih_w,
           ie_indicacao_w,
           ie_uso_antimicrobiano_w,
           ie_medicacao_paciente_w,
           ie_fator_correcao_w,
           ie_bomba_infusao_w,
           ds_observacao_w,
           nm_usuario_p,
           nm_usuario_p,
           clock_timestamp(),
           clock_timestamp(),
           cd_perfil_p,
           24,
           ds_dose_diferenciada_w,
           'N',
           2314,
           coalesce(dt_fim_rp_w,dt_fim_w),
           nr_seq_transcricao_p,
           ie_item_alta_p,
           ie_prescritor_aux_p,
           cd_medico_p,
           ie_retrogrado_p,
           nr_seq_pepo_p,
           nr_cirurgia_p,
           nr_cirurgia_patologia_p,
           nr_seq_agenda_p,
           ie_oncologia_p,
           nr_seq_conclusao_apae_p,
           ie_futuro_p,
           nr_seq_cpoe_rp_p,
           nr_seq_cpoe_order_unit_p
           ,nr_seq_grupo_interval_rp_w
           ,nr_seq_subgrupo_interval_rp_w
           ,ie_segunda_rp_w
          ,ie_terca_rp_w
          ,ie_quarta_rp_w
          ,ie_quinta_rp_w
          ,ie_sexta_rp_w
          ,ie_sabado_rp_w
          ,ie_domingo_rp_w
		  ,ie_antibiotico_w
		  ,ie_evento_unico_w
          );
          CALL cpoe_consis_med_insert(nr_seq_item_gerado_p,nm_usuario_p);

        CALL cpoe_rep_gerar_dil_redil_recon(nr_prescricao_p,
                                       nr_seq_item_gerado_p,
                                       nr_seq_material_w,
                                       'N');
      else
        if (qt_composto_w = 1) then
          update cpoe_material
             set cd_mat_comp1               = cd_material_w,
                 qt_dose_comp1              = qt_dose_w,
                 cd_unid_med_dose_comp1     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp1 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        elsif (qt_composto_w = 2) then
          update cpoe_material
             set cd_mat_comp2               = cd_material_w,
                 qt_dose_comp2              = qt_dose_w,
                 cd_unid_med_dose_comp2     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp2 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        elsif (qt_composto_w = 3) then
          update cpoe_material
             set cd_mat_comp3               = cd_material_w,
                 qt_dose_comp3              = qt_dose_w,
                 cd_unid_med_dose_comp3     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp3 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        elsif (qt_composto_w = 4) then
          update cpoe_material
             set cd_mat_comp4               = cd_material_w,
                 qt_dose_comp4              = qt_dose_w,
                 cd_unid_med_dose_comp4     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp4 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        elsif (qt_composto_w = 5) then
          update cpoe_material
             set cd_mat_comp5               = cd_material_w,
                 qt_dose_comp5              = qt_dose_w,
                 cd_unid_med_dose_comp5     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp5 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        elsif (qt_composto_w = 6) then
          update cpoe_material
             set cd_mat_comp6               = cd_material_w,
                 qt_dose_comp6              = qt_dose_w,
                 cd_unid_med_dose_comp6     = cd_unidade_medida_dose_w,
                 ds_dose_diferenciada_comp6 = ds_dose_diferenciada_w
           where nr_sequencia = nr_seq_item_gerado_p;
        end if;

        qt_composto_w := qt_composto_w + 1;
      end if;
    end;
  end loop;
  close c01;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_medicamento_ant (nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_material.nr_sequencia%type, nm_usuario_p prescr_medica.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

