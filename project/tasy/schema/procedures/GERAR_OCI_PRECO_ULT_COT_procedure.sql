-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oci_preco_ult_cot ( nr_ordem_compra_p bigint, cd_cgc_fornecedor_p text, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		integer;
vl_unitario_material_w	double precision;
nr_item_oci_w		integer;
nr_cot_compra_w		bigint;

C01 CURSOR FOR
SELECT	a.nr_item_oci,
	a.cd_material
from	ordem_compra_item a
where (a.nr_ordem_compra = nr_ordem_compra_p)
and (coalesce(a.ie_situacao,'A')	= 'A');


BEGIN

open c01;
loop
fetch c01 into
	nr_item_oci_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(b.nr_cot_compra),0)
	into STRICT	nr_cot_compra_w
	from	cot_compra a,
		cot_compra_forn b,
		cot_compra_forn_item c
	where (a.nr_cot_compra = b.nr_cot_compra)
	and (b.nr_sequencia = c.nr_seq_cot_forn)
	and (a.cd_estabelecimento = cd_estabelecimento_p)
	and	((b.cd_cgc_fornecedor = cd_cgc_fornecedor_p) or (b.cd_pessoa_fisica = cd_pessoa_fisica_p))
	and (c.cd_material = cd_material_w)
	and (c.vl_unitario_material > 0)
	and (coalesce(a.nr_seq_motivo_cancel::text, '') = '');

	if (nr_cot_compra_w > 0) then

		select	coalesce(min(b.vl_unitario_material),0)
		into STRICT	vl_unitario_material_w
		from	cot_compra_forn a,
			cot_compra_forn_item b
		where (a.nr_sequencia = b.nr_seq_cot_forn)
		and	((a.cd_cgc_fornecedor = cd_cgc_fornecedor_p) or (a.cd_pessoa_fisica = cd_pessoa_fisica_p))
		and (b.cd_material = cd_material_w)
		and (b.nr_cot_compra = nr_cot_compra_w);

		update	ordem_compra_item
		set	vl_unitario_material = vl_unitario_material_w,
			nm_usuario = nm_usuario_p,
			vl_total_item = round(( qt_material * vl_unitario_material_w)::numeric,4)
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_w;
	end if;
	end;
end loop;
close c01;

CALL gerar_oc_hist_sem_commit(
	nr_ordem_compra_p,
	'S',
	Wheb_mensagem_pck.get_Texto(301898),/* 'Alteração dos preços do item.',*/
	Wheb_mensagem_pck.get_Texto(301899), /*Foi altualizado o o preços dos itens utilizando a opção Atualizar preço do fornecedor > Gerar preço pela última cotação deste fornecedor.,*/
	nm_usuario_p);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oci_preco_ult_cot ( nr_ordem_compra_p bigint, cd_cgc_fornecedor_p text, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

