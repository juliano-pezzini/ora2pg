-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_parcela_sca_mens () AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_mens_item,
		coalesce(a.nr_parcela_sca, 0) nr_parcela_sca,
		trunc(months_between(b.dt_mesano_referencia, trunc(d.dt_inicio_vigencia, 'month'))) + 1 nr_parcela_sca_correta,
		b.nr_seq_segurado,
		d.dt_inicio_vigencia,
		b.dt_mesano_referencia
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_mensalidade c,
		pls_sca_vinculo d
	where	c.nr_sequencia = b.nr_seq_mensalidade
	and	b.nr_sequencia = a.nr_seq_mensalidade_seg
	and	d.nr_sequencia = a.nr_seq_vinculo_sca
	and	coalesce(c.ie_cancelamento::text, '') = ''
	and	(d.dt_inicio_vigencia IS NOT NULL AND d.dt_inicio_vigencia::text <> '')
	and	a.ie_tipo_item = '15';

BEGIN

for r_c01_w in c01 loop
	begin

	if (r_c01_w.nr_parcela_sca_correta <> r_c01_w.nr_parcela_sca) and (r_c01_w.nr_parcela_sca_correta > 0) then
		update	pls_mensalidade_seg_item
		set	nr_parcela_sca	= r_c01_w.nr_parcela_sca_correta
		where	nr_sequencia	= r_c01_w.nr_seq_mens_item;
	end if;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_parcela_sca_mens () FROM PUBLIC;

