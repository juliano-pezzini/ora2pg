-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_menu_diet_cycle ( nr_seq_local_p text, nr_seq_servico_p text, nr_seq_opcao_p text, nr_seq_receita_p text, nr_seq_cycle_p bigint, nr_seq_cycle_day_p bigint) AS $body$
DECLARE



nr_sequencia_w		nut_cardapio_dia.nr_sequencia%type;
nr_seq_cardapio_w	nut_cardapio.nr_sequencia%type;
nr_seq_comp_w           nut_cardapio.nr_seq_comp%type;
nr_seq_grupo_producao_w	nut_dieta_rec.nr_sequencia%type;
cd_dieta_w		nut_dieta_rec.cd_dieta%type;
dt_ini_destino_w        	timestamp;
dt_fim_destino_w        	timestamp;

-- Dietas / Grupo de dietas
c01 CURSOR FOR
	SELECT 	cd_dieta,
		nr_seq_grupo
	from   	nut_dieta_rec  
	where  	nr_seq_receita = nr_Seq_receita_p;


BEGIN

if (nr_Seq_receita_p IS NOT NULL AND nr_Seq_receita_p::text <> '') then

	open	c01;
		loop
		fetch	c01 into
			cd_dieta_w,
			nr_seq_grupo_producao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		-- verifica se já existe registro pra essa receita
		select max(nr_sequencia)
		into STRICT   nr_sequencia_w
		from   nut_cardapio_dia
		where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
		and    (((coalesce(nr_seq_grupo_producao::text, '') = '' and (cd_dieta IS NOT NULL AND cd_dieta::text <> '')) and (cd_dieta = cd_dieta_w)) or   
		       ((coalesce(cd_dieta::text, '') = '' and (nr_seq_grupo_producao IS NOT NULL AND nr_seq_grupo_producao::text <> '')) and (nr_seq_grupo_producao = nr_seq_grupo_producao_w)))
		and    nr_seq_opcao = nr_seq_opcao_p
		and    nr_seq_local = nr_seq_local_p
		and    nr_seq_servico = nr_seq_servico_p
		and    nr_seq_cycle = nr_seq_cycle_p
		and    nr_seq_cycle_day = nr_seq_cycle_day_p;
		
		
		select dt_validity_start, dt_validity_end
		into STRICT dt_ini_destino_w, dt_fim_destino_w
		from cycle_menu
		where nr_sequencia = nr_seq_cycle_p;

		if (coalesce(nr_sequencia_w::text, '') = '') then 

			select	nextval('nut_cardapio_dia_seq')
			into STRICT	nr_sequencia_w
			;
		
			insert into nut_cardapio_dia(
				nr_sequencia,
				cd_estabelecimento,
				nr_seq_grupo_producao,
				cd_dieta, 
				nr_seq_opcao,
				nr_seq_local,
				nr_seq_servico,
				qt_pessoa_atend,
				ie_cardapio_padrao,
				ie_dia_semana,
				ie_semana,
				dt_vigencia_inicial,
				dt_vigencia_final,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_seq_cycle,
				nr_seq_cycle_day)
			values (	nr_sequencia_w,
				wheb_usuario_pck.get_cd_estabelecimento,
				nr_seq_grupo_producao_w,
				cd_dieta_w,
				nr_seq_opcao_p,
				nr_seq_local_p,
				nr_seq_servico_p,
				null,
				'N',
				null,
				null,
				dt_ini_destino_w,
				dt_fim_destino_w,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				nr_seq_cycle_p,
				nr_seq_cycle_day_p);
		end if;
		

		SELECT 	nr_seq_composicao
		into STRICT 	nr_seq_comp_w
		FROM 	nut_receita 
		WHERE nr_sequencia = nr_Seq_receita_p;		

		nr_seq_cardapio_w := null;
		--Verifica se já existe
		select 	max(nr_sequencia)
		into STRICT   	nr_seq_cardapio_w		
		from 	nut_cardapio
		where	nr_seq_card_dia = nr_sequencia_w
		and	nr_seq_comp = nr_seq_comp_w
		and	nr_seq_receita = nr_Seq_receita_p;
		
		if (coalesce(nr_seq_cardapio_w::text, '') = '') then
		
			insert into nut_cardapio(nr_sequencia,
				nr_seq_card_dia,
				nr_seq_comp,
				nr_seq_receita,
				qt_refeicao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario)
			values (	nextval('nut_cardapio_seq'),
				nr_sequencia_w,
				nr_seq_comp_w,
				nr_Seq_receita_p,
				1,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario);
		end if;
	
	end loop;
	close c01;

commit;	
	
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_menu_diet_cycle ( nr_seq_local_p text, nr_seq_servico_p text, nr_seq_opcao_p text, nr_seq_receita_p text, nr_seq_cycle_p bigint, nr_seq_cycle_day_p bigint) FROM PUBLIC;

