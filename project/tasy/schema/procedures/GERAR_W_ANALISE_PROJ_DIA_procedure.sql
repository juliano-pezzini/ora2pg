-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_analise_proj_dia (dt_analise_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_seq_projeto_w			bigint;
dt_inicio_real_w			timestamp;
dt_fim_prev_w			timestamp;
qt_pessoas_equipe_w		bigint;
pr_prev_dia_w			double precision;
pr_real_dia_w			double precision;
qt_hora_prev_proj_w		double precision;
qt_hora_real_proj_w		double precision;
qt_hora_prev_por_dia_w		double precision;
qt_hora_prev_dia_w		double precision;
qt_hora_real_dia_w			double precision;
ie_status_w			varchar(10);
qt_dias_uteis_w			bigint;
qt_dias_trab_w			bigint;
pr_por_dia_w			double precision;
pr_status_dia_w			double precision;

c01 CURSOR FOR
SELECT 	a.nr_sequencia,
	b.dt_inicio_real,
	b.dt_fim,
	proj_obter_perc_cron(a.nr_sequencia, 'R', 'S'),
	proj_obter_qt_total_horas_cron(a.nr_sequencia, 0, 'T', 'E'),
	proj_obter_qt_total_horas_cron(a.nr_sequencia, 0, 'R', 'E')
from 	proj_cronograma b,
	proj_projeto a
where	b.nr_seq_proj = a.nr_sequencia
and	a.ie_status = 'E'
and 	a.ie_origem = 'D'
and	a.nr_seq_classif <> 22
and 	coalesce(a.ie_nivel_projeto,0) <> '3'
and 	a.ie_status not in ('T','F')
and	a.nr_seq_estagio not in (15,17)
and	(b.dt_aprovacao IS NOT NULL AND b.dt_aprovacao::text <> '')
and	b.ie_situacao = 'A'
and	b.IE_TIPO_CRONOGRAMA = 'E'
and	coalesce(b.ie_classificacao,'D') <> 'N'
order by	a.nr_seq_prioridade;



BEGIN

delete  from w_analise_proj_dia
where 	trunc(dt_analise) = trunc(dt_analise_p);

open c01;
loop
fetch c01 into
	nr_seq_projeto_w,
	dt_inicio_real_w,
	dt_fim_prev_w,
	pr_real_dia_w,
	qt_hora_prev_proj_w,
	qt_hora_real_proj_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (dt_inicio_real_w IS NOT NULL AND dt_inicio_real_w::text <> '') and (dt_fim_prev_w IS NOT NULL AND dt_fim_prev_w::text <> '') then

			select	OBTER_DIAS_UTEIS_PERIODO(dt_inicio_real_w, dt_fim_prev_w, 1)
			into STRICT	qt_dias_uteis_w
			;

			select	dividir(100, qt_dias_uteis_w)
			into STRICT	pr_por_dia_w
			;

			select	dividir(qt_hora_prev_proj_w, qt_dias_uteis_w)
			into STRICT	qt_hora_prev_por_dia_w
			;

			select	OBTER_DIAS_UTEIS_PERIODO(dt_inicio_real_w, dt_analise_p, 1)
			into STRICT	qt_dias_trab_w
			;

			pr_prev_dia_w		:= (pr_por_dia_w * qt_dias_trab_w);
			qt_hora_prev_dia_w	:= (qt_hora_prev_por_dia_w * qt_dias_trab_w);

			/* Obter horas reais do dia - pelas atividades realizadas

			select	dividir(sum(QT_MINUTO),60)
			into	qt_hora_real_dia_w
			from	man_ordem_serv_ativ a,
				proj_cron_etapa b,
				proj_cronograma c
			where 	a.nr_seq_proj_cron_etapa 	= b.nr_sequencia
			and	b.nr_seq_cronograma	 	= c.nr_sequencia
			and	c.nr_seq_proj	 	 	= nr_seq_projeto_w
			and	trunc(a.dt_atividade, 'dd')	= dt_analise_p;*/
			/* Calculando o status do projeto do dia */

			pr_status_dia_w	:= dividir((pr_real_dia_w * 100), pr_prev_dia_w);

			if (dt_fim_prev_w < clock_timestamp()) then
				ie_status_w		:= '3';
			elsif (pr_status_dia_w < 70) then
				ie_status_w		:= '2';
			elsif	(pr_status_dia_w >= 70 AND pr_status_dia_w <= 99) then
				ie_status_w		:= '1';
			else
				ie_status_w		:= '1';
			end if;


			if (pr_prev_dia_w > 100) then
				pr_prev_dia_w	:= 100;
			end if;



			insert	into w_analise_proj_dia(nr_seq_projeto,
				dt_analise,
				dt_inicio_real,
				dt_fim_previsto,
				qt_pessoas_equipe,
				pr_prev_dia,
				pr_real_dia,
				qt_hora_prev_dia,
				qt_hora_real_dia,
				ie_status)
			values (nr_seq_projeto_w,
				dt_analise_p,
				dt_inicio_real_w,
				dt_fim_prev_w,
				qt_dias_trab_w,
				pr_prev_dia_w,
				pr_real_dia_w,
				qt_hora_prev_proj_w,
				qt_hora_real_proj_w,
				ie_status_w);
		end if;

		end;
	end loop;
	close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_analise_proj_dia (dt_analise_p timestamp, nm_usuario_p text) FROM PUBLIC;

