-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_acomp_fornec ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_sintetico_p text, ie_quebra_p bigint, cd_fornecedor_p text, cd_grupo_material_p text, cd_subgrupo_material_p text, cd_classe_material_p text, cd_material_p text, cd_comprador_p text, ie_urgente_p text, ie_padronizado_p text) AS $body$
DECLARE

 
cd_fornecedor_w			varchar(14);
ds_quebra_w			varchar(255);
cd_material			integer;
nr_ordem_compra			bigint;
dt_ordem_compra			timestamp;
dt_entrega_limite_w		timestamp;
qt_material_w			double precision;
vl_unitario_material_w		double precision;
vl_item_liquido_w		double precision;
dt_real_entrega_w		timestamp;
qt_real_entrega_w		double precision;
qt_entrega_pontual_w		double precision;
qt_total_resumo_w		double precision;
qt_pontual_resumo_w		double precision;
ie_tipo_informacao_w		smallint;
cd_lista_fornecedor_w		varchar(4000);
cd_lista_grupo_w		varchar(4000);
cd_lista_subgrupo_w		varchar(4000);
cd_lista_classe_w		varchar(4000);
cd_lista_material_w		varchar(4000);
cd_lista_comprador_w		varchar(4000);
cd_material_w			numeric(20);

c01 CURSOR FOR 
SELECT	a.cd_cgc_fornecedor, 
	b.cd_material, 
	a.nr_ordem_compra, 
	a.dt_ordem_compra, 
	coalesce(c.dt_entrega_limite,c.dt_prevista_entrega), 
	c.qt_prevista_entrega, 
	b.vl_unitario_material, 
	b.vl_item_liquido, 
	coalesce(obter_dt_entrada_nf_item_oc(a.nr_ordem_compra, b.nr_item_oci, c.dt_prevista_entrega),c.dt_real_entrega), 
	c.qt_real_entrega 
from	ordem_compra a, 
	ordem_compra_item b, 
	ordem_compra_item_entrega c, 
	estrutura_material_v e 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	b.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_item_oci = c.nr_item_oci 
and	b.cd_material = e.cd_material 
and	coalesce(c.dt_entrega_limite,c.dt_prevista_entrega) between dt_inicio_p and fim_dia(dt_final_p) 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	obter_se_ordem_possui_nota(a.nr_ordem_compra) > 0 
and	coalesce(c.dt_cancelamento::text, '') = '' 
and	(a.cd_cgc_fornecedor IS NOT NULL AND a.cd_cgc_fornecedor::text <> '') 
and	((ie_padronizado_p = 'T') or 
	((ie_padronizado_p = 'S') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'S')) or 
	((ie_padronizado_p = 'N') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'N'))) 
and	((ie_urgente_p = 'T') or 
	(ie_urgente_p = 'S' AND a.ie_urgente = 'S') or 
	(ie_urgente_p = 'N' AND a.ie_urgente = 'N')) 
and	((coalesce(cd_fornecedor_p::text, '') = '') or 
	((cd_fornecedor_p IS NOT NULL AND cd_fornecedor_p::text <> '') and (obter_se_contido_char(a.cd_cgc_fornecedor,cd_lista_fornecedor_w) = 'S'))) 
and	((coalesce(cd_grupo_material_p::text, '') = '') or 
	((cd_grupo_material_p IS NOT NULL AND cd_grupo_material_p::text <> '') and (obter_se_contido_char(e.cd_grupo_material,cd_lista_grupo_w) = 'S'))) 
and	((coalesce(cd_subgrupo_material_p::text, '') = '') or 
	((cd_subgrupo_material_p IS NOT NULL AND cd_subgrupo_material_p::text <> '') and (obter_se_contido_char(e.cd_subgrupo_material,cd_lista_subgrupo_w) = 'S'))) 
and	((coalesce(cd_classe_material_p::text, '') = '') or 
	((cd_classe_material_p IS NOT NULL AND cd_classe_material_p::text <> '') and (obter_se_contido_char(e.cd_classe_material,cd_lista_classe_w) = 'S'))) 
and	((coalesce(cd_comprador_p::text, '') = '') or 
	((cd_comprador_p IS NOT NULL AND cd_comprador_p::text <> '') and (obter_se_contido_char(a.cd_comprador,cd_lista_comprador_w) = 'S'))) 
and	((coalesce(cd_material_p::text, '') = '') or 
	((cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (obter_se_contido_char(b.cd_material,cd_lista_material_w) = 'S')));
	
c02 CURSOR FOR			 
SELECT	1 ie_tipo, 
	CASE WHEN ie_quebra_p=0 THEN e.ds_grupo_material WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,w.cd_fornecedor),1,100) END  ds_quebra, 
	sum(w.qt_material) qt_entrega, 
	sum(w.qt_entrega_pontual) qt_pontual, 
	e.cd_material 
from	w_acomp_fornecedor w, 
	estrutura_material_v e 
where	w.cd_material = e.cd_material 
group by	CASE WHEN ie_quebra_p=0 THEN e.ds_grupo_material WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,w.cd_fornecedor),1,100) END , 
		e.cd_material 

union all
 
SELECT	2 ie_tipo, 
	CASE WHEN ie_quebra_p=0 THEN x.ds_grupo_material WHEN ie_quebra_p=1 THEN SUBSTR(obter_nome_pf_pj(NULL,w.cd_fornecedor),1,100) END  ds_quebra, 
	COUNT(*) qt_entrega, 
	MAX((	SELECT	COUNT(*) 
		FROM	w_acomp_fornecedor a, 
			estrutura_material_v e 
		WHERE	a.cd_material = e.cd_material 
		and	a.cd_material = x.cd_material 
		AND	((ie_quebra_p = 0 AND obter_estrutura_material(a.cd_material,'G') = x.cd_grupo_material) OR (ie_quebra_p = 1 AND a.cd_fornecedor = w.cd_fornecedor)) 
		AND	a.qt_entrega_pontual <> 0)) qt_pontual, 
	x.cd_material	 
FROM	w_acomp_fornecedor w, 
	estrutura_material_v x 
WHERE	w.cd_material = x.cd_material 
GROUP BY	CASE WHEN ie_quebra_p=0 THEN x.ds_grupo_material WHEN ie_quebra_p=1 THEN SUBSTR(obter_nome_pf_pj(NULL,w.cd_fornecedor),1,100) END , 
		x.cd_material 

union all
 
select	3 ie_tipo, 
	CASE WHEN ie_quebra_p=0 THEN substr(obter_desc_grupo_mat(e.cd_grupo_material),1,100) WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,100) END  ds_quebra, 
	sum(c.qt_prevista_entrega) qt_entrega, 
	sum((	select	coalesce(sum(x.qt_real_entrega),0) 
		from  	ordem_compra_item_entrega x 
		where 	c.nr_sequencia = x.nr_sequencia 
		and	trunc(coalesce(obter_dt_entrada_nf_item_oc(x.nr_ordem_compra, x.nr_item_oci, X.dt_prevista_entrega),x.dt_real_entrega),'dd') <= trunc(coalesce(x.dt_entrega_limite,x.dt_prevista_entrega),'dd'))) qt_pontual, 
	e.cd_material	 
from	ordem_compra a, 
	ordem_compra_item b, 
	ordem_compra_item_entrega c, 
	estrutura_material_v e 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	b.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_item_oci = c.nr_item_oci 
and	b.cd_material = e.cd_material 
and	coalesce(c.dt_entrega_limite,c.dt_prevista_entrega) between trunc(dt_inicio_p,'yy') and fim_dia(dt_final_p) 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	obter_se_ordem_possui_nota(a.nr_ordem_compra) > 0 
and	(a.cd_cgc_fornecedor IS NOT NULL AND a.cd_cgc_fornecedor::text <> '') 
and	coalesce(c.dt_cancelamento::text, '') = '' 
and	((ie_padronizado_p = 'T') or 
	((ie_padronizado_p = 'S') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'S')) or 
	((ie_padronizado_p = 'N') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'N'))) 
and	((ie_urgente_p = 'T') or 
	(ie_urgente_p = 'S' AND a.ie_urgente = 'S') or 
	(ie_urgente_p = 'N' AND a.ie_urgente = 'N')) 
and	((coalesce(cd_fornecedor_p::text, '') = '') or 
	((cd_fornecedor_p IS NOT NULL AND cd_fornecedor_p::text <> '') and (obter_se_contido_char(a.cd_cgc_fornecedor,cd_lista_fornecedor_w) = 'S'))) 
and	((coalesce(cd_grupo_material_p::text, '') = '') or 
	((cd_grupo_material_p IS NOT NULL AND cd_grupo_material_p::text <> '') and (obter_se_contido_char(e.cd_grupo_material,cd_lista_grupo_w) = 'S'))) 
and	((coalesce(cd_subgrupo_material_p::text, '') = '') or 
	((cd_subgrupo_material_p IS NOT NULL AND cd_subgrupo_material_p::text <> '') and (obter_se_contido_char(e.cd_subgrupo_material,cd_lista_subgrupo_w) = 'S'))) 
and	((coalesce(cd_classe_material_p::text, '') = '') or 
	((cd_classe_material_p IS NOT NULL AND cd_classe_material_p::text <> '') and (obter_se_contido_char(e.cd_classe_material,cd_lista_classe_w) = 'S'))) 
and	((coalesce(cd_comprador_p::text, '') = '') or 
	((cd_comprador_p IS NOT NULL AND cd_comprador_p::text <> '') and (obter_se_contido_char(a.cd_comprador,cd_lista_comprador_w) = 'S')))	 
and	((coalesce(cd_material_p::text, '') = '') or 
	((cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (obter_se_contido_char(b.cd_material,cd_lista_material_w) = 'S'))) 
and	(((ie_quebra_p = 1) and (exists ( 
	select	1 
	from	w_acomp_fornecedor w 
	where	a.cd_cgc_fornecedor = w.cd_fornecedor))) 
or	((ie_quebra_p = 0) and (exists ( 
	select	1 
	from	w_acomp_fornecedor w, 
		estrutura_material_v y 
	where	w.cd_material = y.cd_material 
	and	y.cd_grupo_material = e.cd_grupo_material)))) 
group by	CASE WHEN ie_quebra_p=0 THEN substr(obter_desc_grupo_mat(e.cd_grupo_material),1,100) WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,100) END , 
		e.cd_material 

union all
 
select 	4 ie_tipo, 
	CASE WHEN ie_quebra_p=0 THEN substr(obter_desc_grupo_mat(e.cd_grupo_material),1,100) WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,100) END  ds_quebra, 
	count(*) qt_entrega, 
	sum((	select	count(*) 
		from	ordem_compra_item_entrega t 
		where	t.nr_sequencia = c.nr_sequencia	 
		and	trunc(coalesce(obter_dt_entrada_nf_item_oc(t.nr_ordem_compra, t.nr_item_oci, t.dt_prevista_entrega),t.dt_real_entrega),'dd') <= trunc(coalesce(dt_entrega_limite,dt_prevista_entrega),'dd'))) qt_pontual, 
	e.cd_material	 
FROM estrutura_material_v e, ordem_compra a, ordem_compra_item b
LEFT OUTER JOIN ordem_compra_item_entrega c ON (b.nr_item_oci = c.nr_item_oci)
WHERE a.nr_ordem_compra = b.nr_ordem_compra and coalesce(a.nr_seq_motivo_cancel::text, '') = '' and b.nr_ordem_compra = c.nr_ordem_compra  and b.cd_material = e.cd_material and coalesce(dt_entrega_limite,c.dt_prevista_entrega) between trunc(dt_inicio_p,'yy') and fim_dia(dt_final_p) and a.cd_estabelecimento = cd_estabelecimento_p and obter_se_ordem_possui_nota(a.nr_ordem_compra) > 0 and coalesce(c.dt_cancelamento::text, '') = '' and (a.cd_cgc_fornecedor IS NOT NULL AND a.cd_cgc_fornecedor::text <> '') and ((ie_padronizado_p = 'T') or 
	((ie_padronizado_p = 'S') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'S')) or 
	((ie_padronizado_p = 'N') and (obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material) = 'N'))) and ((ie_urgente_p = 'T') or 
	(ie_urgente_p = 'S' AND a.ie_urgente = 'S') or 
	(ie_urgente_p = 'N' AND a.ie_urgente = 'N')) and ((coalesce(cd_fornecedor_p::text, '') = '') or 
	((cd_fornecedor_p IS NOT NULL AND cd_fornecedor_p::text <> '') and (obter_se_contido_char(a.cd_cgc_fornecedor,cd_lista_fornecedor_w) = 'S'))) and ((coalesce(cd_grupo_material_p::text, '') = '') or 
	((cd_grupo_material_p IS NOT NULL AND cd_grupo_material_p::text <> '') and (obter_se_contido_char(e.cd_grupo_material,cd_lista_grupo_w) = 'S'))) and ((coalesce(cd_subgrupo_material_p::text, '') = '') or 
	((cd_subgrupo_material_p IS NOT NULL AND cd_subgrupo_material_p::text <> '') and (obter_se_contido_char(e.cd_subgrupo_material,cd_lista_subgrupo_w) = 'S'))) and ((coalesce(cd_classe_material_p::text, '') = '') or 
	((cd_classe_material_p IS NOT NULL AND cd_classe_material_p::text <> '') and (obter_se_contido_char(e.cd_classe_material,cd_lista_classe_w) = 'S'))) and ((coalesce(cd_comprador_p::text, '') = '') or 
	((cd_comprador_p IS NOT NULL AND cd_comprador_p::text <> '') and (obter_se_contido_char(a.cd_comprador,cd_lista_comprador_w) = 'S'))) and ((coalesce(cd_material_p::text, '') = '') or 
	((cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (obter_se_contido_char(b.cd_material,cd_lista_material_w) = 'S'))) and (((ie_quebra_p = 1) and (exists ( 
	select	1 
	from	w_acomp_fornecedor w 
	where	a.cd_cgc_fornecedor = w.cd_fornecedor))) 
or	((ie_quebra_p = 0) and (exists ( 
	select	1 
	from	w_acomp_fornecedor w, 
		estrutura_material_v y 
	where	w.cd_material = y.cd_material 
	and	y.cd_grupo_material = e.cd_grupo_material)))) group by	CASE WHEN ie_quebra_p=0 THEN substr(obter_desc_grupo_mat(e.cd_grupo_material),1,100) WHEN ie_quebra_p=1 THEN substr(obter_nome_pf_pj(null,a.cd_cgc_fornecedor),1,100) END , 
		e.cd_material 
order by ie_tipo, 
	ds_quebra;
				

BEGIN 
 
cd_lista_fornecedor_w		:= replace(replace(replace(cd_fornecedor_p,'(',''),')',''),' ','');
cd_lista_grupo_w		:= replace(replace(replace(cd_grupo_material_p,'(',''),')',''),' ','');
cd_lista_subgrupo_w		:= replace(replace(replace(cd_subgrupo_material_p,'(',''),')',''),' ','');
cd_lista_classe_w		:= replace(replace(replace(cd_classe_material_p,'(',''),')',''),' ','');
cd_lista_material_w		:= replace(replace(replace(cd_material_p,'(',''),')',''),' ','');
cd_lista_comprador_w		:= replace(replace(replace(cd_comprador_p,'(',''),')',''),' ','');
 
delete from w_acomp_fornecedor;
delete from w_acomp_fornec_resumo;
 
open C01;
loop 
fetch C01 into	 
	cd_fornecedor_w, 
	cd_material, 
	nr_ordem_compra, 
	dt_ordem_compra, 
	dt_entrega_limite_w, 
	qt_material_w, 
	vl_unitario_material_w, 
	vl_item_liquido_w, 
	dt_real_entrega_w, 
	qt_real_entrega_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (trunc(dt_real_entrega_w,'dd') <= trunc(dt_entrega_limite_w,'dd')) then 
		qt_entrega_pontual_w := qt_real_entrega_w;
	else 
		qt_entrega_pontual_w := 0;
	end if;
	 
	insert into w_acomp_fornecedor( 
		cd_fornecedor, 
		cd_material, 
		nr_ordem_compra, 
		dt_ordem_compra, 
		dt_prevista_entrega, 
		qt_material, 
		vl_unitario_material, 
		vl_item_liquido, 
		dt_real_entrega, 
		qt_real_entrega, 
		qt_entrega_pontual) 
	values (	cd_fornecedor_w, 
		cd_material, 
		nr_ordem_compra, 
		dt_ordem_compra, 
		dt_entrega_limite_w, 
		qt_material_w, 
		vl_unitario_material_w, 
		vl_item_liquido_w, 
		dt_real_entrega_w, 
		qt_real_entrega_w, 
		qt_entrega_pontual_w);
	end;
end loop;
close C01;
 
if (ie_sintetico_p = 'S') then 
	 
	open C02;
	loop 
	fetch C02 into	 
		ie_tipo_informacao_w, 
		ds_quebra_w, 
		qt_total_resumo_w, 
		qt_pontual_resumo_w, 
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		insert into w_acomp_fornec_resumo( 
			ds_quebra, 
			ie_tipo_informacao, 
			qt_total, 
			qt_pontual, 
			cd_material) 
		values (	ds_quebra_w, 
			ie_tipo_informacao_w, 
			qt_total_resumo_w, 
			qt_pontual_resumo_w, 
			cd_material_w);	
		end;
	end loop;
	close C02;
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_acomp_fornec ( cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_sintetico_p text, ie_quebra_p bigint, cd_fornecedor_p text, cd_grupo_material_p text, cd_subgrupo_material_p text, cd_classe_material_p text, cd_material_p text, cd_comprador_p text, ie_urgente_p text, ie_padronizado_p text) FROM PUBLIC;

