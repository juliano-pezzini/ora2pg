-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dose_onc_insert_mat (nr_seq_paciente_p bigint, nr_seq_material_p bigint) AS $body$
DECLARE

					
nr_seq_material_w		bigint;
ie_regra_diluicao_cad_mat_w	varchar(1);	
ie_param1556_w 		varchar(1);
					
					
c01 CURSOR FOR
	SELECT	nr_seq_material,
			ie_regra_diluicao_cad_mat
	from	paciente_protocolo_medic
	where	nr_seq_paciente		= nr_seq_paciente_p
	and		nr_seq_material		= nr_seq_material_p
	and		ie_regra_diluicao_cad_mat in ('S','A',CASE WHEN ie_param1556_w='S' THEN 'N'  ELSE null END );



BEGIN
ie_param1556_w := obter_param_usuario(281, 1556, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param1556_w);
open C01;
loop
fetch C01 into	
	nr_seq_material_w,
	ie_regra_diluicao_cad_mat_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	delete from paciente_protocolo_medic
	where	nr_seq_diluicao = nr_seq_material_w
	and		nr_seq_paciente	= nr_seq_paciente_p;
	
	if (coalesce(ie_regra_diluicao_cad_mat_w,'S') = 'S') then
		CALL Gerar_Reconst_Diluicao_onc(nr_seq_paciente_p,nr_seq_material_w,'D',wheb_usuario_pck.get_nm_usuario);
	else
		CALL Gerar_Reconst_Diluicao_onc(nr_seq_paciente_p,nr_seq_material_w,'A',wheb_usuario_pck.get_nm_usuario);
	end if;
	
	exception
		when others then
		null;
	end;
end loop;
close C01;	
	
CALL Arredondar_dose_onc_protocolo(nr_seq_paciente_p);	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dose_onc_insert_mat (nr_seq_paciente_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

