-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_atualizar_procedimento (nr_seq_procedimento_p text, ie_atualizar_todos_p text, nm_usuario_p text) AS $body$
DECLARE


-- nao pode ter select da prescr_procedimento, problema de mutante.
vl_desp_tiss_w			double precision;
vl_medico_w			double precision;
vl_custo_operacional_w		double precision;
vl_materiais_w			double precision;
vl_procedimento_w		double precision;
vl_partic_w			double precision;
cd_procedimento_w		bigint;
cd_estabelecimento_w		bigint;
ie_origem_proced_w		bigint;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_especialidade_proc_w		bigint;
cd_area_procedimento_w		bigint;
ie_tipo_protocolo_w		bigint;
nr_seq_proc_pac_tiss_w		bigint;
nr_seq_partic_w			bigint;
nr_seq_regra_guia_tiss_w		bigint;
nr_seq_proc_pacote_w		bigint;
ie_regra_valor_w			varchar(20);
ie_tiss_tipo_guia_w			varchar(50);
ie_responsavel_credito_w		varchar(50);
ie_proc_princ_atend_w		varchar(50);
ie_honorario_w			varchar(50);
ie_honor_spsadt_w			varchar(10);
ie_honor_ri_w			varchar(10);
cd_procedimento_tuss_w		varchar(255);
ie_proc_tuss_w			varchar(255);
ie_guia_w			varchar(50);
ds_campo_tiss_w			varchar(50);
ds_versao_w			varchar(50);
ie_guia_regra_w			varchar(50);
ie_guia_partic_dif_w		varchar(1);
cd_edicao_amb_w			bigint;
cd_convenio_w			bigint;
ie_clinica_w			bigint;
cd_categoria_w			varchar(50);
ie_executor_w			varchar(2);
cd_medico_exec_tiss_w		varchar(50);
cd_medico_atend_w		varchar(255);
cd_regional_w			varchar(50);
ds_prestador_tiss_w		varchar(255);
ie_video_w			varchar(255);
dt_conta_w			timestamp;
ie_classificacao_w			varchar(50);
nr_seq_tiss_tabela_w		bigint;
ie_tipo_atendimento_w		bigint;
ie_entra_conta_w			varchar(20);
ie_repassa_medico_w		varchar(20);
ie_forma_apresentacao_w		smallint;
ie_tiss_tipo_guia_proc_w		varchar(20);
cd_cgc_prestador_w		varchar(20);
ie_tipo_despesa_tiss_w		varchar(3);
cd_setor_atendimento_w		bigint;
cd_cgc_prestador_tiss_w		varchar(20);
cd_cgc_estab_w			varchar(20);
cd_prestador_tiss_w		varchar(100);
nr_interno_conta_w		bigint;
nr_doc_convenio_w		varchar(255);
ie_resp_credito_proc_w		varchar(255);
cd_medico_executor_w		varchar(255);
ie_guia_honorario_w		varchar(255);
nr_doc_convenio_proc_w		varchar(255);
ie_tipo_guia_atend_w		varchar(3);
ie_tipo_guia_conta_w		varchar(3);
nr_atendimento_w			bigint;
cd_setor_entrada_w		bigint;
ie_ordem_w			bigint;
nr_seq_regra_prestador_w		bigint;
ie_funcao_medico_w		varchar(15);
cd_cbos_exec_w			varchar(255);
ie_tecnica_utilizada_w		varchar(15);
ie_guia_honor_w			varchar(10);
cd_cgc_prest_solic_w		varchar(20);
ds_campo_w			varchar(255);
ds_proc_regra_w			varchar(255);
ds_desp_regra_w			varchar(255);
cd_classif_setor_w			varchar(255);
ds_proc_tiss_w			varchar(255);
ds_procedimento_w		procedimento.ds_procedimento%TYPE;
ie_medico_solic_atend_w		varchar(255);
cd_senha_w			varchar(255);
cd_senha_prescr_w		varchar(255);
cd_senha_atendimento_w		varchar(255);
ie_tipo_atend_tiss_w		varchar(255);
ie_tipo_atend_conta_w		smallint;
ie_solicitante_w			varchar(255);
nr_prescricao_w			numeric(20);
cd_medico_req_w			varchar(255);
cd_medico_solic_tiss_w		varchar(255);
ie_medico_solic_atend_regra_w	varchar(255);
cd_medico_prof_solic_tiss_w		varchar(255);
nr_sequencia_prescricao_w		bigint;
cd_medico_solic_prescr_w		varchar(255);
cd_cgc_solic_prescr_w		varchar(255);
dt_procedimento_w		timestamp;
ie_medico_exec_w			varchar(255);
cd_funcionario_w		varchar(255);
cd_plano_convenio_w		varchar(50);
nr_primeiro_atend_w		bigint;
ie_primeiro_atend_regra_w	varchar(255);
ie_carater_inter_sus_w		varchar(255);
ie_desc_proc_interno_w		varchar(255);
cd_prestador_solic_w		varchar(255);
ds_prestador_solic_w		varchar(255);
nr_seq_procedimento_w		bigint;
ie_honorario_regra_w		varchar(50);
ie_gravar_log_conta_w		varchar(255);
ie_atualiza_senha_conta_w	varchar(255);
cd_senha_item_w			varchar(255);
ie_honor_regra_prest_w		varchar(10);
cd_medico_referido_w		varchar(10);
ie_regime_internacao_w		varchar(10);
ie_medico_conveniado_w		varchar(10) := 'N';
ie_contrat_exec_hi_w		varchar(255);
ie_regra_exec_honor_w		varchar(255);
cd_cgc_prestador_honor_w	varchar(255);
ie_aplica_regra_w		varchar(255);
cd_interno_honor_regra_w	varchar(255);
nm_exec_honor_regra_w		varchar(255);
cd_cgc_prest_honor_tiss_w	varchar(255);
cd_tipo_acomocadao_w		bigint;
cd_procedencia_w		bigint;
cd_medico_regra_solic_tiss_w	varchar(255);
nr_seq_classificacao_atend_w	bigint;
nr_seq_tiss_tabela_proc_w	bigint;
ie_lado_proc_w			varchar(255);
ds_lado_proc_w			varchar(255);
nr_sequencia_autor_w		bigint;
nr_seq_protocolo_w		bigint;
ie_atualiza_nr_guia_w		varchar(10);
ie_status_acerto_w		bigint;
nr_seq_proc_interno_w		bigint;
cd_especialidade_medica_w	integer;
ie_senha_proc_prescr_w		varchar(10);
nr_seq_exame_w			bigint;
ds_procedimento_ww		procedimento.ds_procedimento%TYPE;
nr_seq_interno_w		bigint;
cd_desp_convenio_w		procedimento_paciente.cd_procedimento_convenio%type;
cd_procedimento_convenio_w	procedimento_paciente.cd_procedimento_convenio%type;
ds_texto_w			varchar(255);
count_param_w			bigint;
dt_mesano_referencia_w		timestamp;
ie_tipo_guia_proc_w		varchar(2);
nr_seq_regra_exec_honor_w	bigint;
ie_guia_prestador_w		varchar(3);
nr_seq_pacote_proc_alt_w	procedimento_paciente.nr_seq_proc_pacote%type;
nr_seq_proc_gatilho_w		procedimento_paciente.nr_sequencia%type;
nr_prescr_gatilho_w		procedimento_paciente.nr_prescricao%type;
nr_seq_proc_prescr_gatilho_w	procedimento_paciente.nr_sequencia_prescricao%type;
cd_proc_regra_tabela_w		varchar(255);
cd_proc_tiss_w			varchar(255);
ie_classif_proced_w		procedimento.ie_classificacao%type;

c03 CURSOR FOR
SELECT	1 ie_ordem,
	'N' ie_honorario,
	a.cd_procedimento,
	a.ie_origem_proced,
	'X' ie_responsavel_credito,
	b.cd_estabelecimento,
	a.cd_edicao_amb,
	b.cd_convenio_parametro,
	b.cd_categoria_parametro,
	a.dt_conta,
	c.ie_classificacao,
	d.ie_tipo_atendimento,
	a.cd_setor_atendimento,
	a.ie_proc_princ_atend,
	(null)::numeric  nr_seq_partic,
	c.ie_forma_apresentacao,
	a.cd_cgc_prestador,
	a.nr_doc_convenio,
	a.cd_medico_executor,
	c.ie_tipo_despesa_tiss,
	b.nr_atendimento,
	a.ie_funcao_medico,
	--tiss_obter_cbos_medico(a.cd_medico_executor, a.cd_especialidade, ds_versao_w, b.cd_convenio_parametro) cd_cbos_exec,

	--substr(tiss_eliminar_caractere(nvl(OBTER_DESC_EXAME(a.nr_seq_exame), nvl(obter_desc_proc_convenio(a.nr_sequencia, null), c.ds_procedimento))), 1, 60),
	'S' ie_executor,
	a.cd_senha,
	vl_medico,
	vl_custo_operacional,
	vl_materiais,
	vl_procedimento,
	--obter_valor_participante(a.nr_sequencia),
	a.nr_prescricao,
	a.cd_medico_req,
	a.cd_pessoa_fisica,
	a.nr_sequencia,
	a.cd_especialidade,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	c.ds_procedimento,
	a.cd_procedimento_convenio,
	a.nr_seq_proc_pacote
from	procedimento c,
	atendimento_paciente d,
	conta_paciente b,
	procedimento_paciente a
where	a.nr_sequencia		= nr_seq_procedimento_p
and	a.nr_interno_conta		= b.nr_interno_conta
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	b.nr_atendimento		= d.nr_atendimento

union

SELECT	2 ie_ordem,
	'S' ie_honorario,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.ie_responsavel_credito,
	b.cd_estabelecimento,
	a.cd_edicao_amb,
	b.cd_convenio_parametro,
	b.cd_categoria_parametro,
	a.dt_conta,
	c.ie_classificacao,
	d.ie_tipo_atendimento,
	a.cd_setor_atendimento,
	a.ie_proc_princ_atend,
	(null)::numeric  nr_seq_partic,
	c.ie_forma_apresentacao,
	a.cd_cgc_prestador,
	a.nr_doc_honor_conv nr_doc_convenio,
	a.cd_medico_executor,
	c.ie_tipo_despesa_tiss,
	b.nr_atendimento,
	a.ie_funcao_medico,
	--tiss_obter_cbos_medico(a.cd_medico_executor, a.cd_especialidade, ds_versao_w, b.cd_convenio_parametro),

	--substr(tiss_eliminar_caractere(nvl(OBTER_DESC_EXAME(a.nr_seq_exame), nvl(obter_desc_proc_convenio(a.nr_sequencia, null), c.ds_procedimento))), 1, 60),
	'S' ie_executor,
	a.cd_senha,
	vl_medico,
	vl_custo_operacional,
	vl_materiais,
	vl_procedimento,
	--obter_valor_participante(a.nr_sequencia),
	a.nr_prescricao,
	a.cd_medico_req,
	a.cd_pessoa_fisica,
	a.nr_sequencia,
	a.cd_especialidade,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	c.ds_procedimento,
	a.cd_procedimento_convenio,
	a.nr_seq_proc_pacote
from	procedimento c,
	atendimento_paciente d,
	conta_paciente b,
	procedimento_paciente a
where	a.nr_sequencia		= nr_seq_procedimento_p
and	a.nr_interno_conta		= b.nr_interno_conta
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	b.nr_atendimento		= d.nr_atendimento
and	(a.ie_responsavel_credito IS NOT NULL AND a.ie_responsavel_credito::text <> '')

union

select	3 ie_ordem,
	'P' ie_honorario,
	a.cd_procedimento,
	a.ie_origem_proced,
	coalesce(e.ie_responsavel_credito, 'X'),
	b.cd_estabelecimento,
	a.cd_edicao_amb,
	b.cd_convenio_parametro,
	b.cd_categoria_parametro,
	a.dt_conta,
	c.ie_classificacao,
	d.ie_tipo_atendimento,
	a.cd_setor_atendimento,
	a.ie_proc_princ_atend,
	e.nr_seq_partic,
	c.ie_forma_apresentacao,
	e.cd_cgc,
	e.nr_doc_honor_conv nr_doc_convenio,
	e.cd_pessoa_fisica,
	c.ie_tipo_despesa_tiss,
	b.nr_atendimento,
	e.ie_funcao,
	--tiss_obter_cbos_medico(a.cd_medico_executor, a.cd_especialidade, ds_versao_w, b.cd_convenio_parametro),

	--substr(tiss_eliminar_caractere(nvl(OBTER_DESC_EXAME(a.nr_seq_exame), nvl(obter_desc_proc_convenio(a.nr_sequencia, null), c.ds_procedimento))), 1, 60),
	'N' ie_executor,
	a.cd_senha,
	vl_medico,
	vl_custo_operacional,
	vl_materiais,
	vl_procedimento,
	--obter_valor_participante(a.nr_sequencia),
	a.nr_prescricao,
	a.cd_medico_req,
	a.cd_pessoa_fisica,
	a.nr_sequencia,
	a.cd_especialidade,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	c.ds_procedimento,
	a.cd_procedimento_convenio,
	a.nr_seq_proc_pacote
from	procedimento c,
	atendimento_paciente d,
	conta_paciente b,
	procedimento_participante e,
	procedimento_paciente a
where	a.nr_sequencia		= nr_seq_procedimento_p
and	a.nr_sequencia		= e.nr_sequencia
and	a.nr_interno_conta		= b.nr_interno_conta
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced	= c.ie_origem_proced
and	b.nr_atendimento		= d.nr_atendimento
order	by 1;

c01 CURSOR FOR
SELECT * from (
SELECT	ie_tipo_guia,
	nr_sequencia,
	ie_primeiro_atend
from	tiss_regra_guia_proc
where	cd_estabelecimento				= cd_estabelecimento_w
and	coalesce(ie_responsavel_credito,ie_responsavel_credito_w)	= ie_responsavel_credito_w
and	coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and	coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and	coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
and	coalesce(cd_procedimento, cd_procedimento_w)		= cd_procedimento_w
and	coalesce(cd_convenio, cd_convenio_w)			= cd_convenio_w
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w)	= ie_tipo_atendimento_w
and	coalesce(ie_tipo_atend_conta, coalesce(ie_tipo_atend_conta_w, 0))	= coalesce(ie_tipo_atend_conta_w, 0)
and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
and	((ie_origem_proced	= ie_origem_proced_w) 	or (coalesce(ie_origem_proced::text, '') = ''))
and	((coalesce(ie_proc_princ_atend,'T')	= 'T') 		or (ie_proc_princ_atend = ie_proc_princ_atend_w))
and	coalesce(ie_tipo_guia_atend, coalesce(ie_tipo_guia_atend_w,'X')) 	= coalesce(ie_tipo_guia_atend_w,'X')
and	coalesce(ie_tipo_guia_conta, coalesce(ie_tipo_guia_conta_w,'X')) 	= coalesce(ie_tipo_guia_conta_w,'X')
and	coalesce(ie_tipo_guia_proc, coalesce(ie_tipo_guia_proc_w,'X')) 	= coalesce(ie_tipo_guia_proc_w,'X')
and	coalesce(ie_funcao_medico, coalesce(ie_funcao_medico_w, 'X'))	= coalesce(ie_funcao_medico_w, 'X')
and	coalesce(cd_categoria, coalesce(cd_categoria_w, 'X'))		= coalesce(cd_categoria_w, 'X')
and	coalesce(cd_plano, coalesce(cd_plano_convenio_w, 'X'))		= coalesce(cd_plano_convenio_w, 'X')
and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))			= coalesce(ie_clinica_w,0)
and	(((coalesce(ie_primeiro_atend,'N')					= 'S') and (nr_atendimento_w					= nr_primeiro_atend_w)) or (coalesce(ie_primeiro_atend,'N') = 'N'))
and	(((coalesce(ie_senha,'S')					= 'S') and (cd_senha_w					= cd_senha_atendimento_w)) or (coalesce(ie_senha,'N') = 'N'))
and	((coalesce(ie_pacote, 'T') = 'T') or
	 ((coalesce(ie_pacote, 'T') = 'P') and (nr_seq_proc_pacote_w = nr_seq_procedimento_p)) or
	 ((coalesce(ie_pacote, 'T') = 'I') and (nr_seq_proc_pacote_w IS NOT NULL AND nr_seq_proc_pacote_w::text <> '') and (nr_seq_proc_pacote_w <> nr_seq_procedimento_p)) or
	 ((coalesce(ie_pacote, 'T') = 'F') and (coalesce(nr_seq_proc_pacote_w::text, '') = '')))
and	coalesce(cd_cgc_prestador, coalesce(cd_cgc_prestador_w, 0))	= coalesce(cd_cgc_prestador_w, 0)
and	((coalesce(ie_video, 'A') = coalesce(ie_video_w, 'A')) or (coalesce(ie_video, 'A') = 'A'))
and	coalesce(ie_carater_inter_sus, coalesce(ie_carater_inter_sus_w, 'X')) 	= coalesce(ie_carater_inter_sus_w, 'X')
and	coalesce(ie_regime_internacao, coalesce(ie_regime_internacao_w, 'X')) 	= coalesce(ie_regime_internacao_w, 'X')
and	coalesce(cd_medico_executor, coalesce(cd_medico_executor_w,'X'))		= coalesce(cd_medico_executor_w,'X')
and	((coalesce(ie_medico_conveniado,'N') = 'S' and coalesce(ie_medico_conveniado_w,'N') = 'S') or (coalesce(ie_medico_conveniado,'N') = 'N'))
and	coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_w,0))		= coalesce(nr_seq_proc_interno_w,0)
and	coalesce(cd_especialidade_medica,coalesce(cd_especialidade_medica_w,0))	= coalesce(cd_especialidade_medica_w,0)
order	by ie_prioridade desc,
	coalesce(cd_procedimento, 0),
	coalesce(nr_seq_proc_interno,0),
	coalesce(cd_grupo_proc, 0),
	coalesce(cd_especialidade, 0),
	coalesce(cd_area_procedimento, 0),
	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento,0),
	coalesce(ie_clinica,0),
	coalesce(cd_setor_atendimento, 0),
	CASE WHEN coalesce(ie_responsavel_credito, '0')='0' THEN  0  ELSE 1 END ,
	coalesce(cd_cgc_prestador, 0),
	coalesce(ie_carater_inter_sus, '0'),
	coalesce(ie_regime_internacao,'0'),
	coalesce(cd_medico_executor,'0'),
	coalesce(ie_tipo_guia_proc,'0') ) x
where 	coalesce(TISS_OBTER_SE_PROC_CONTA(x.nr_sequencia, nr_interno_conta_w), 'S')	= 'S' --lhalves OS 216252 em 10/06/2010
and	coalesce(TISS_OBTER_SE_MAT_CONTA(x.nr_sequencia, nr_interno_conta_w), 'S')	= 'S';

c02 CURSOR FOR
SELECT	ie_regra,
	cd_medico_solic_tiss
from	tiss_regra_medico_solic
where	cd_estabelecimento				= cd_estabelecimento_w
and	coalesce(cd_convenio, cd_convenio_w)			= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))	= coalesce(ie_clinica_w,0)
and	coalesce(cd_setor_entrada, coalesce(cd_setor_entrada_w,0))	= coalesce(cd_setor_entrada_w,0)
and	coalesce(cd_medico_atend, coalesce(cd_medico_atend_w,'X'))	= coalesce(cd_medico_atend_w,'X')
--and	nvl(ie_autorizacao,'N')					= 'N'
and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0))		= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0))		= coalesce(cd_especialidade_w,0)
and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0))		= coalesce(cd_procedimento_w,0)
and (ie_origem_proced	= ie_origem_proced_w or coalesce(ie_origem_proced::text, '') = '')
and	coalesce(ie_tipo_atend_conta,coalesce(ie_tipo_atend_conta_w,0))	= coalesce(ie_tipo_atend_conta_w,0)
order by	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(cd_medico_atend,'X'),
	coalesce(cd_grupo_proc,0),
	coalesce(cd_especialidade,0),
	coalesce(cd_area_procedimento,0),
	coalesce(cd_procedimento,0),
	coalesce(ie_tipo_atend_conta,0);
	
	
  r RECORD;

BEGIN

begin
select	c.cd_cgc,
	b.nr_interno_conta,
	ie_responsavel_credito,
	b.cd_convenio_parametro,
	b.cd_estabelecimento,
	x.ie_clinica,
	x.cd_medico_resp,
	a.nr_seq_proc_pacote,
	a.cd_procedimento_tuss,
	a.nr_sequencia_prescricao,
	a.dt_procedimento,
	a.ie_video,
	x.ie_carater_inter_sus,
	x.cd_medico_referido,
	x.cd_procedencia,
	x.nr_seq_classificacao,
	b.nr_seq_protocolo,
	b.ie_status_acerto,
	a.cd_especialidade,
	b.ie_tipo_atend_conta,
	b.ie_tipo_guia,
	b.dt_mesano_referencia,
	a.ie_tipo_guia,
	a.nr_doc_convenio
into STRICT	cd_cgc_estab_w,
	nr_interno_conta_w,
	ie_resp_credito_proc_w,
	cd_convenio_w,
	cd_estabelecimento_w,
	ie_clinica_w,
	cd_medico_atend_w,
	nr_seq_proc_pacote_w,
	cd_procedimento_tuss_w,
	nr_sequencia_prescricao_w,
	dt_procedimento_w,
	ie_video_w,
	ie_carater_inter_sus_w,
	cd_medico_referido_w,
	cd_procedencia_w,
	nr_seq_classificacao_atend_w,
	nr_seq_protocolo_w,
	ie_status_acerto_w,
	cd_especialidade_medica_w,
	ie_tipo_atend_conta_w,
	ie_tipo_guia_conta_w,
	dt_mesano_referencia_w,
	ie_tipo_guia_proc_w,
	nr_doc_convenio_w
from	estabelecimento c,
	atendimento_paciente x,
	conta_paciente b,
	procedimento_paciente a
where	b.cd_estabelecimento	= c.cd_estabelecimento
and	a.nr_interno_conta	= b.nr_interno_conta
and	x.nr_atendimento	= b.nr_atendimento
and	a.nr_sequencia		= nr_seq_procedimento_p  LIMIT 1;
exception
when others then
	null;
end;

				
cd_regional_w	:= Obter_Valor_Conv_Estab(cd_convenio_w, cd_estabelecimento_w, 'CD_REGIONAL');

select	count(*),
	coalesce(max(ie_guia_honorario),'R'),
	coalesce(max(ie_medico_solic_atend), 'N'),
	coalesce(max(ie_proc_tuss), 'N'),
	coalesce(max(ie_desc_proc_interno), 'N'),
	coalesce(max(ie_gravar_log_conta),'N'),
	coalesce(max(ie_atualiza_senha_conta),'N'),
	coalesce(max(ie_contrat_exec_hi), 'M'),
	coalesce(max(ie_atualiza_nr_guia),'N'),
	coalesce(max(ie_senha_proc_prescr),'N'),
	coalesce(max(ie_guia_prestador),'N')
into STRICT	count_param_w,
	ie_guia_honorario_w,
	ie_medico_solic_atend_w,
	ie_proc_tuss_w,
	ie_desc_proc_interno_w,
	ie_gravar_log_conta_w,
	ie_atualiza_senha_conta_w,
	ie_contrat_exec_hi_w,
	ie_atualiza_nr_guia_w,
	ie_senha_proc_prescr_w,
	ie_guia_prestador_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

if (count_param_w = 1) then

	begin
	select	tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w,dt_mesano_referencia_w)
	into STRICT	ds_versao_w
	;
	exception
	when others then
		ds_versao_w	:= null;
	end;

	CALL wheb_usuario_pck.set_ie_executar_trigger('N');

	update	procedimento_paciente
	set	ie_tiss_tipo_guia_honor		 = NULL,
		ie_tiss_tipo_guia		 = NULL,
		nr_seq_tiss_tabela		 = NULL,
		cd_cgc_prestador_tiss		 = NULL,
		cd_cgc_honorario_tiss		 = NULL,
		cd_medico_exec_tiss		 = NULL,
		ds_proc_tiss			 = NULL,
		cd_prestador_tiss		 = NULL,
		cd_cgc_prest_solic_tiss		 = NULL,
		cd_cgc_prest_honor_tiss		 = NULL,
		cd_medico_solic_tiss		 = NULL,
		cd_medico_prof_solic_tiss	 = NULL,
		ie_tipo_atend_tiss		 = NULL
	where	nr_sequencia			= nr_seq_procedimento_p;

	update	procedimento_participante
	set	ie_tiss_tipo_guia	 = NULL,
		cd_medico_exec_tiss	 = NULL,
		cd_cgc_prestador_tiss	 = NULL,
		cd_cgc_prest_solic_tiss	 = NULL,
		ds_proc_tiss		 = NULL,
		ds_prestador_tiss	 = NULL,
		cd_prestador_tiss	 = NULL,
		cd_medico_honor_tiss	 = NULL,
		cd_cgc_prest_honor_tiss	 = NULL
	where	nr_sequencia		= nr_seq_procedimento_p;

	if 	((coalesce(ie_atualiza_nr_guia_w,'N') = 'S') or
		 ((coalesce(ie_atualiza_nr_guia_w,'N') = 'P') and (ie_status_acerto_w = 1)) or
		 ((coalesce(ie_atualiza_nr_guia_w,'N') = 'B') and (coalesce(nr_doc_convenio_w,wheb_mensagem_pck.get_texto(1097738)) = wheb_mensagem_pck.get_texto(1097738)))
		) and
		((coalesce(OBTER_TITULO_CONTA_PROTOCOLO(nr_seq_protocolo_w,nr_interno_conta_w)::text, '') = '') and (coalesce(OBTER_TITULO_CONTA(nr_interno_conta_w)::text, '') = '') and (coalesce(somente_numero(obter_nf_conta_protocolo(nr_seq_protocolo_w,nr_interno_conta_w)),0) = 0) ) then

		update	procedimento_paciente
		set	nr_doc_convenio		 = NULL,
			nr_doc_honor_conv	 = NULL
		where	nr_sequencia		= nr_seq_procedimento_p;		
		
	end if;		

	delete	from proc_paciente_tiss
	where	nr_seq_procedimento	= nr_seq_procedimento_p
	and	ds_campo		not in ('NR_GUIA_PRESTADOR','NR_GUIA_PRESTADOR_HONOR');

	open c03;
	loop
	fetch c03 into
		ie_ordem_w,
		ie_honorario_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_responsavel_credito_w,
		cd_estabelecimento_w,
		cd_edicao_amb_w,
		cd_convenio_w,
		cd_categoria_w,
		dt_conta_w,
		ie_classificacao_w,
		ie_tipo_atendimento_w,
		cd_setor_atendimento_w,
		ie_proc_princ_atend_w,
		nr_seq_partic_w,
		ie_forma_apresentacao_w,
		cd_cgc_prestador_w,
		nr_doc_convenio_w,
		cd_medico_executor_w,
		ie_tipo_despesa_tiss_w,
		nr_atendimento_w,
		ie_funcao_medico_w,
		--cd_cbos_exec_w,

		--ds_procedimento_w,
		ie_executor_w,
		cd_senha_w,
		vl_medico_w,
		vl_custo_operacional_w,
		vl_materiais_w,
		vl_procedimento_w,
		--vl_partic_w,
		nr_prescricao_w,
		cd_medico_req_w,
		cd_funcionario_w,
		nr_seq_procedimento_w,
		cd_especialidade_proc_w,
		ie_lado_proc_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w,
		ds_procedimento_ww,
		cd_procedimento_convenio_w,
		nr_seq_pacote_proc_alt_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		-- Edgar 07/01/2012, OS 400859, tratado tipo tabela proc abaixo
		nr_seq_tiss_tabela_proc_w	:= OBTER_PROC_TISS_TIPO_TABELA(cd_procedimento_w, ie_origem_proced_w, dt_conta_w);
		
		begin
		vl_partic_w	:= obter_valor_participante(nr_seq_procedimento_w);
		exception
		when others then
			vl_partic_w	:= 0;
		end;
		
		begin
		cd_cbos_exec_w	:= tiss_obter_cbos_medico(cd_medico_executor_w, cd_especialidade_proc_w, ds_versao_w, cd_convenio_w);
		exception
		when others then
			cd_cbos_exec_w	:= null;
		end;
		
		begin
		ds_procedimento_w	:= substr(tiss_eliminar_caractere(coalesce(OBTER_DESC_EXAME(nr_seq_exame_w), coalesce(obter_desc_proc_convenio(nr_seq_procedimento_w, null), ds_procedimento_ww))), 1, 60);
		exception
		when others then
			ds_procedimento_w	:= null;
		end;
		
		begin
		select	cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento,
			ie_classificacao_w
		into STRICT	cd_grupo_proc_w,
			cd_especialidade_w,
			cd_area_procedimento_w,
			ie_classif_proced_w
		from	estrutura_procedimento_v
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w  LIMIT 1;
		exception
		when others then
			cd_grupo_proc_w		:= null;
			cd_especialidade_w	:= null;
			cd_area_procedimento_w	:= null;
			ie_classif_proced_w	:= null;
		end;

		/*select	max(OBTER_SETOR_ATENDIMENTO(nr_atendimento_w))
		into	cd_setor_entrada_w
		from	dual;*/
		
		begin
		cd_setor_entrada_w	:= OBTER_SETOR_ATENDIMENTO(nr_atendimento_w);
		exception
		when others then
			cd_setor_entrada_w	:= null;
		end;
		
		if (coalesce(nr_seq_pacote_proc_alt_w,0) > 0) and (nr_seq_pacote_proc_alt_w = nr_seq_procedimento_w) then
		
			select	max(nr_seq_proc_origem)
			into STRICT	nr_seq_proc_gatilho_w
			from 	atendimento_pacote
			where 	nr_atendimento = nr_atendimento_w
			and	nr_seq_procedimento = nr_seq_procedimento_w;
			
			if (coalesce(nr_seq_proc_gatilho_w,0) > 0) then
				select	max(nr_prescricao),
					max(nr_sequencia_prescricao)
				into STRICT	nr_prescr_gatilho_w,
					nr_seq_proc_prescr_gatilho_w
				from	procedimento_paciente
				where	nr_sequencia = nr_seq_proc_gatilho_w;
			end if;
		
		end if;

		ie_tecnica_utilizada_w := tiss_obter_regra_tecnica_util(	cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, cd_procedimento_w, ie_origem_proced_w, cd_convenio_w, cd_estabelecimento_w, ie_video_w, nr_seq_proc_interno_w, ie_tecnica_utilizada_w);

		nr_seq_interno_w	:= obter_atecaco_atendimento(nr_atendimento_w);
		
		begin	
		select	ie_tipo_guia,
			cd_senha,
			cd_plano_convenio,
			ie_regime_internacao,
			cd_tipo_acomodacao
		into STRICT	ie_tipo_guia_atend_w,
			cd_senha_atendimento_w,
			cd_plano_convenio_w,
			ie_regime_internacao_w,
			cd_tipo_acomocadao_w
		from	atend_categoria_convenio
		where	nr_atendimento	= nr_atendimento_w
		and	nr_seq_interno	= nr_seq_interno_w;
		exception
		when others then
			ie_tipo_guia_atend_w	:= null;
			cd_senha_atendimento_w	:= null;
			cd_plano_convenio_w	:= null;
			ie_regime_internacao_w	:= null;
			cd_tipo_acomocadao_w	:= null;
		end;

		ie_tiss_tipo_guia_w		:= null;

		/*select	max(ie_tipo_atend_conta),
			max(ie_tipo_guia)
		into 	ie_tipo_atend_conta_w,
			ie_tipo_guia_conta_w
		from	conta_paciente
		where	nr_interno_conta	= nr_interno_conta_w;*/
		
		begin
		select	ie_tipo_protocolo
		into STRICT	ie_tipo_protocolo_w
		from	protocolo_convenio a,
			conta_paciente b
		where	a.nr_seq_protocolo	= b.nr_seq_protocolo
		and	b.nr_interno_conta	= nr_interno_conta_w;
		exception
		when others then
			ie_tipo_protocolo_w	:= null;
		end;

		if (ie_atualiza_senha_conta_w = 'S') then
			cd_senha_item_w	:= cd_senha_atendimento_w;
		end if;

		if (coalesce(ie_senha_proc_prescr_w,'N') = 'S') then	
			begin			
				select	coalesce(max(b.cd_senha),max(a.cd_senha))
				into STRICT	cd_senha_item_w
				from	prescr_procedimento b,
					prescr_medica a
				where	a.nr_prescricao	= b.nr_prescricao
				and	a.nr_prescricao	= coalesce(nr_prescr_gatilho_w, nr_prescricao_w)
				and	b.nr_sequencia	= coalesce(nr_seq_proc_prescr_gatilho_w, nr_sequencia_prescricao_w);
			exception
			when others then			
				cd_senha_item_w	:= null;
			end;
			
			/*if	(cd_senha_prescr_w is not null) then
			
				update	procedimento_paciente
				set	cd_senha	= nvl(cd_senha,cd_senha_prescr_w)
				where	nr_sequencia	= nr_seq_procedimento_p;
			
			end if;*/
		
		end if;	
		
		ie_medico_conveniado_w := coalesce(obter_se_medico_conveniado(cd_estabelecimento_w,
									cd_medico_executor_w,
									cd_convenio_w,
									null,
									cd_especialidade_proc_w,
									cd_categoria_w,
									cd_setor_atendimento_w,
									cd_plano_convenio_w,
									dt_conta_w,
									ie_tipo_atendimento_w,
									ie_funcao_medico_w,
									ie_carater_inter_sus_w),'N');
			
		/*lhalves OS206316 em 08/04/2010 - Identificar se o atendimento e o primeiro do paciente no estabelecimento*/

		select 	/*+ index (a ATEPACI_PESFISI_FK_I) */			min(a.nr_atendimento)
		into STRICT	nr_primeiro_atend_w
		from 	atendimento_paciente a
		where 	a.cd_estabelecimento 	= cd_estabelecimento_w
		and	a.cd_pessoa_fisica	=(SELECT	max(b.cd_pessoa_fisica)
							from	atendimento_paciente b
							where	b.nr_atendimento		= nr_atendimento_w);

		open c01;
		loop
		fetch c01 into
			ie_tiss_tipo_guia_w,
			nr_seq_regra_guia_tiss_w,
			ie_primeiro_atend_regra_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;	

		if (coalesce(ie_tiss_tipo_guia_w::text, '') = '') then

			select	max(ie_entra_conta),
				max(ie_repassa_medico)
			into STRICT	ie_entra_conta_w,
				ie_repassa_medico_w
			from	regra_honorario
			where	cd_regra	= ie_responsavel_credito_w;
		
			ie_tiss_tipo_guia_w	:= tiss_obter_guia_proc(ie_tipo_atendimento_w,
									cd_procedimento_w,
									ie_origem_proced_w,
									ie_entra_conta_w,
									ie_repassa_medico_w,
									null);

			if (ie_tipo_despesa_tiss_w IS NOT NULL AND ie_tipo_despesa_tiss_w::text <> '') then
				ie_tiss_tipo_guia_w	:= '7';
			end if;

		end if;

		if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
			select	max(cd_cgc_solic)
			into STRICT	cd_cgc_solic_prescr_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w;
		end if;

		cd_cgc_prestador_tiss_w		:= null;
		cd_cgc_prest_honor_tiss_w 	:= null;
		
		if (ie_tiss_tipo_guia_w = '5') then

			SELECT * FROM tiss_obter_regra_prestador(cd_convenio_w, cd_estabelecimento_w, ie_tipo_atendimento_w, ie_responsavel_credito_w, ie_clinica_w, cd_cgc_prestador_w, cd_setor_atendimento_w, cd_medico_executor_w, cd_medico_atend_w, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, ie_tiss_tipo_guia_w, ie_honorario_w, cd_cgc_prestador_tiss_w, cd_prestador_tiss_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_w, nr_seq_regra_prestador_w, 'P', ie_solicitante_w, cd_cgc_solic_prescr_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w, dt_procedimento_w, 'N', cd_medico_referido_w, cd_tipo_acomocadao_w, cd_procedencia_w, cd_plano_convenio_w, nr_seq_classificacao_atend_w, 'N', 'N', ie_tipo_atend_conta_w, ie_tipo_protocolo_w) INTO STRICT cd_cgc_prestador_tiss_w, cd_prestador_tiss_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_w, nr_seq_regra_prestador_w, ie_solicitante_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w;

			if (ie_gravar_log_conta_w = 'S') and (nr_seq_regra_prestador_w IS NOT NULL AND nr_seq_regra_prestador_w::text <> '') then
				ds_texto_w := substr(wheb_mensagem_pck.get_texto(310005)||' >  '||
							wheb_mensagem_pck.get_texto(299651)||': '|| cd_procedimento_w || ' ' ||
							wheb_mensagem_pck.get_texto(278192)|| ' ' || nr_seq_procedimento_p || ' ' ||
							wheb_mensagem_pck.get_texto(310005)|| ': '|| nr_seq_regra_prestador_w || ' ' ||
							wheb_mensagem_pck.get_texto(297313)|| ': '|| ie_tiss_tipo_guia_w ,1,2000);
			/* 	Regra Prestador > 
				Procedimento : || cd_procedimento_w || 
				Seq:  || nr_seq_procedimento_p ||
				Regra prestador:  || nr_seq_regra_prestador_w ||
				Guia: || ie_tiss_tipo_guia_w */
				CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_w,ds_texto_w,nm_usuario_p);
			end if;

			if (coalesce(cd_cgc_prestador_tiss_w::text, '') = '') then
				cd_cgc_prestador_tiss_w		:= cd_cgc_estab_w;
			end if;


		elsif (ie_tiss_tipo_guia_w in ('3', '4', '6', '7')) then		

			/*lhalves OS220656 em 18/08/2010 - Sempre que for guia de HI, o ie_honorario = 'S' */

			ie_honorario_regra_w 		:= ie_honorario_w;
			if (ie_tiss_tipo_guia_w = '6') then
				ie_honorario_regra_w	:= 'S';
			end if;		

			SELECT * FROM tiss_obter_regra_prestador(	cd_convenio_w, cd_estabelecimento_w, ie_tipo_atendimento_w, ie_responsavel_credito_w, ie_clinica_w, cd_cgc_prestador_w, cd_setor_atendimento_w, cd_medico_executor_w, cd_medico_atend_w, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, ie_tiss_tipo_guia_w, ie_honorario_regra_w, cd_cgc_prestador_tiss_w, cd_prestador_tiss_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_w, nr_seq_regra_prestador_w, 'P', ie_solicitante_w, cd_cgc_solic_prescr_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w, dt_procedimento_w, 'N', cd_medico_referido_w, cd_tipo_acomocadao_w, cd_procedencia_w, cd_plano_convenio_w, nr_seq_classificacao_atend_w, 'N', 'N', ie_tipo_atend_conta_w, ie_tipo_protocolo_w) INTO STRICT cd_cgc_prestador_tiss_w, cd_prestador_tiss_w, ds_prestador_tiss_w, cd_medico_exec_tiss_w, cd_cgc_prest_solic_w, nr_seq_regra_prestador_w, ie_solicitante_w, ie_medico_exec_w, cd_prestador_solic_w, ds_prestador_solic_w;

			if (ie_gravar_log_conta_w = 'S') and (nr_seq_regra_prestador_w IS NOT NULL AND nr_seq_regra_prestador_w::text <> '') then
				ds_texto_w := substr(wheb_mensagem_pck.get_texto(310005)|| ' ('|| wheb_mensagem_pck.get_texto(310015) || ') >  '||
							wheb_mensagem_pck.get_texto(299651)|| ': ' || cd_procedimento_w || ' ' ||
							wheb_mensagem_pck.get_texto(278192)|| ': ' || nr_seq_procedimento_p || ' ' ||
							wheb_mensagem_pck.get_texto(310005)|| ': ' || nr_seq_regra_prestador_w || ' ' ||
							wheb_mensagem_pck.get_texto(297313)|| ': ' || ie_tiss_tipo_guia_w || ' ' ||
							wheb_mensagem_pck.get_texto(299653)|| ': ' || ie_honorario_regra_w || ' ' ||
							wheb_mensagem_pck.get_texto(310017)|| ': ' || cd_medico_executor_w || ' ' ||
							wheb_mensagem_pck.get_texto(310018)|| ': ' || ie_executor_w ,1,2000);			
			/*	Regra Prestador (Atualizar Proc) > ||
				 Procedimento : || cd_procedimento_w || 
				 Seq:  || nr_seq_procedimento_p ||
				 Regra prestador:  || nr_seq_regra_prestador_w ||
				 Guia: || ie_tiss_tipo_guia_w ||
				 Honorario: || ie_honorario_regra_w ||
				 Medico Exec: || cd_medico_executor_w ||
				 Exec: ||ie_executor_w	*/
				CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_w,ds_texto_w,nm_usuario_p);
			end if;
			
			/*lhalves OS 362162 em 30/09/2011 - Aplicar a regra para o procedimento, conforme o setor do procedimento e nao do atendimento*/

			if (ie_tiss_tipo_guia_w = '6') and (coalesce(ie_contrat_exec_hi_w,'M') = 'R') then			
			
				SELECT * FROM tiss_obter_regra_exec_honor(	cd_estabelecimento_w, cd_convenio_w, ie_responsavel_credito_w, cd_setor_atendimento_w, cd_medico_executor_w, ie_regra_exec_honor_w, cd_cgc_prestador_honor_w, ie_aplica_regra_w, 'N', null, cd_interno_honor_regra_w, nm_exec_honor_regra_w, nr_seq_regra_exec_honor_w) INTO STRICT ie_regra_exec_honor_w, cd_cgc_prestador_honor_w, ie_aplica_regra_w, cd_interno_honor_regra_w, nm_exec_honor_regra_w, nr_seq_regra_exec_honor_w;
								
				if (coalesce(ie_regra_exec_honor_w,'M') = 'R') and (cd_cgc_prestador_honor_w IS NOT NULL AND cd_cgc_prestador_honor_w::text <> '')	then
					
					cd_cgc_prest_honor_tiss_w	:= cd_cgc_prestador_honor_w;
					ds_texto_w := substr(wheb_mensagem_pck.get_texto(310024)|| ' ('|| wheb_mensagem_pck.get_texto(310015) || ') >  '||
							wheb_mensagem_pck.get_texto(299651)|| ': ' || cd_procedimento_w || ' ' ||
							wheb_mensagem_pck.get_texto(278192)|| ': ' || nr_seq_procedimento_p || ' ' ||
							wheb_mensagem_pck.get_texto(310028)|| ': ' || ie_responsavel_credito_w || ' ' ||
							wheb_mensagem_pck.get_texto(302028)|| ' ' || cd_setor_atendimento_w || ' ' ||
							wheb_mensagem_pck.get_texto(310017)|| ': ' || cd_medico_executor_w || ' ' ||
							wheb_mensagem_pck.get_texto(310035)|| ': ' || ie_regra_exec_honor_w || ' ' ||
							wheb_mensagem_pck.get_texto(310038)|| ': ' || cd_cgc_prestador_honor_w ,1,2000);
				/*	Regra Contratado Honor (Atualizar Proc) >||
					 Procedimento : || cd_procedimento_w || 
					 Seq:  || nr_seq_procedimento_p || 
					 Resp Credito: || ie_responsavel_credito_w ||
					 Setor: || cd_setor_atendimento_w ||
					 Medico Exec: || cd_medico_executor_w ||
					 Regra Honor: || ie_regra_exec_honor_w ||
					 CGC Prestador Regra: || cd_cgc_prestador_honor_w
					*/
					CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_w,ds_texto_w,nm_usuario_p);				
				end if;
			
			end if;

			/* Edgar 01/04/2009, OS 134964, retirei este trataento para forcar a regra a ser aplicada
			if	(ie_medico_solic_atend_w = 'S') then -- Edgar 23/03/2009, se deve gerar medico do atendimento como solicitante entao nao deve ter cd_cgc_prest_solic_w
				cd_cgc_prest_solic_w		:= null;
			end if;
			*/
			if (coalesce(cd_cgc_prestador_tiss_w::text, '') = '') then
				cd_cgc_prestador_tiss_w		:= cd_cgc_prestador_w;
			end if;


		end if;

		/* dsantos em 15/09/2009 OS158199 para emitir o campo CNPJ, da prescricao na EUP, nos campos 13 e 14 na guia SADT*/

		if (coalesce(ie_solicitante_w,'N')	in ('S','PE')) then
			select	max(a.cd_cgc_solic)
			into STRICT	cd_cgc_prest_solic_w
			from	prescr_medica a
			where	a.nr_prescricao	= coalesce(nr_prescr_gatilho_w, nr_prescricao_w)
			and	a.nr_atendimento	= nr_atendimento_w;
			
			if (coalesce(cd_cgc_prest_solic_w,'X') = 'X') then
				select	max(a.cd_medico)
				into STRICT	cd_medico_solic_tiss_w
				from	prescr_medica a
				where	a.nr_prescricao	= coalesce(nr_prescr_gatilho_w, nr_prescricao_w)
				and	a.nr_atendimento	= nr_atendimento_w;
			end if;
		end if;

		/*lhalves OS412863 em 14/02/2012 - Alterado para fazer antes da TISS_OBTER_GUIA, por causa da quebra da numeracao pelo tipo de atendimento TISS do procedimento*/

		ie_tipo_atend_tiss_w		:= '';
		ie_tipo_atend_tiss_w := TISS_OBTER_TIPO_ATEND_PROC(cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_tipo_atend_tiss_w, cd_setor_atendimento_w, ie_tipo_atendimento_w);	
					
		if (coalesce(ie_tipo_atend_tiss_w,'X') <> 'X') then
			update	procedimento_paciente
			set	ie_tipo_atend_tiss	= ie_tipo_atend_tiss_w			
			where	nr_sequencia		= nr_seq_procedimento_p;
		end if;

		/*lhalves OS202585 19/03/2010 - Gerar o medico executor do proc pela regra prestador*/

		if (coalesce(ie_medico_exec_w, 'N') = 'S') then
			cd_medico_exec_tiss_w := cd_medico_executor_w;
		end if;

		ie_honor_spsadt_w	:= TISS_OBTER_SE_HONOR_SPSADT(cd_convenio_w,
							cd_estabelecimento_w,
							ie_responsavel_credito_w,
							ie_tipo_atendimento_w,
							cd_setor_entrada_w,
							ie_executor_w);
							
		ie_honor_ri_w		:= TISS_OBTER_SE_HONOR_RI(cd_convenio_w,
							cd_estabelecimento_w,
							ie_responsavel_credito_w,
							ie_tipo_atendimento_w,
							cd_setor_entrada_w,
							cd_procedimento_w,
							ie_origem_proced_w);

		if (coalesce(nr_doc_convenio_w, wheb_mensagem_pck.get_texto(1097738)) = wheb_mensagem_pck.get_texto(1097738)) then

			select	TISS_OBTER_MED_PROC_PRESC(coalesce(nr_prescr_gatilho_w, nr_prescricao_w), nr_sequencia_prescricao_w)
			into STRICT	cd_medico_solic_prescr_w
			;

			select	ie_tiss_tipo_guia,
				nr_doc_convenio
			into STRICT	ie_tiss_tipo_guia_proc_w,
				nr_doc_convenio_proc_w
			from	procedimento_paciente
			where	nr_sequencia	= nr_seq_procedimento_p;
			
			select	coalesce(max(ie_guia_partic_dif),'N')
			into STRICT	ie_guia_partic_dif_w
			from	tiss_regra_guia a
			where	cd_convenio						= cd_convenio_w
			and	cd_estabelecimento					= cd_estabelecimento_w
			and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w)		= ie_tipo_atendimento_w
			and	coalesce(ie_tiss_tipo_guia, ie_tiss_tipo_guia_w)			= ie_tiss_tipo_guia_w
			and	coalesce(ie_responsavel_credito, coalesce(ie_responsavel_credito_w, 'X')) 	= coalesce(ie_responsavel_credito_w, 'X')
			and	coalesce(ie_tiss_tipo_guia, ie_tiss_tipo_guia_w)			= ie_tiss_tipo_guia_w
			and	coalesce(ie_funcao_medico, coalesce(ie_funcao_medico_w, 'X'))	= coalesce(ie_funcao_medico_w, 'X')
			and	coalesce(a.ie_situacao,'A') = 'A'
			and	not exists (SELECT	x.ie_resp_credito_fora
					from	tiss_regra_guia_adic x
					where	x.nr_seq_regra		= a.nr_sequencia
					and	x.ie_resp_credito_fora	= ie_responsavel_credito_w)		
			order	by coalesce(ie_tipo_atendimento,0),
				CASE WHEN coalesce(ie_responsavel_credito::text, '') = '' THEN 0  ELSE 1 END;

			if (ie_guia_honorario_w = 'R') or (ie_honorario_w = 'N') or (ie_tiss_tipo_guia_proc_w <> ie_tiss_tipo_guia_w) then
						
				/*OS64865. 28/11/2007. Incluido o if e o else pois incrementava a regra guia pois ou nr_doc_conv_honor ou nr_doc_conv sempre sera nulo (um dos dois).*/

				if (ie_honorario_w		= 'N') or
					(ie_tiss_tipo_guia_proc_w <> ie_tiss_tipo_guia_w AND ie_honor_spsadt_w	='N') then

					SELECT * FROM tiss_obter_guia(	ie_tiss_tipo_guia_w, nr_interno_conta_w, nr_doc_convenio_w, ie_honorario_w, cd_medico_executor_w, cd_cgc_prestador_tiss_w, ie_resp_credito_proc_w, ie_funcao_medico_w, cd_cbos_exec_w, ie_guia_regra_w, null, null, cd_senha_w, cd_setor_atendimento_w, cd_medico_req_w, coalesce(nr_prescr_gatilho_w, nr_prescricao_w), cd_medico_solic_prescr_w, dt_procedimento_w, cd_funcionario_w, null, nr_seq_procedimento_w, null, cd_procedimento_w, ie_origem_proced_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_regra_w;

				elsif (ie_honorario_w		= 'S') and
					((ie_tiss_tipo_guia_proc_w <> ie_tiss_tipo_guia_w) or
					 (ie_tiss_tipo_guia_w	= '4' AND ie_honor_spsadt_w	= 'S')) then

					SELECT * FROM tiss_obter_guia(	ie_tiss_tipo_guia_w, nr_interno_conta_w, nr_doc_convenio_w, ie_honorario_w, cd_medico_executor_w, cd_cgc_prestador_tiss_w, ie_resp_credito_proc_w, ie_funcao_medico_w, cd_cbos_exec_w, ie_guia_regra_w, null, null, cd_senha_w, cd_setor_atendimento_w, cd_medico_req_w, coalesce(nr_prescr_gatilho_w, nr_prescricao_w), cd_medico_solic_prescr_w, dt_procedimento_w, cd_funcionario_w, null, nr_seq_procedimento_w, null, cd_procedimento_w, ie_origem_proced_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_regra_w;
				elsif (ie_honorario_w		= 'S') and
					((ie_tiss_tipo_guia_proc_w <> ie_tiss_tipo_guia_w) or
					 (ie_tiss_tipo_guia_w	= '5' AND ie_honor_ri_w	= 'S')) then

					SELECT * FROM tiss_obter_guia(	ie_tiss_tipo_guia_w, nr_interno_conta_w, nr_doc_convenio_w, ie_honorario_w, cd_medico_executor_w, cd_cgc_prestador_tiss_w, ie_resp_credito_proc_w, ie_funcao_medico_w, cd_cbos_exec_w, ie_guia_regra_w, null, null, cd_senha_w, cd_setor_atendimento_w, cd_medico_req_w, coalesce(nr_prescr_gatilho_w, nr_prescricao_w), cd_medico_solic_prescr_w, dt_procedimento_w, cd_funcionario_w, null, nr_seq_procedimento_w, null, cd_procedimento_w, ie_origem_proced_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_regra_w;

				elsif (ie_honorario_w		= 'P') and
					((ie_tiss_tipo_guia_proc_w 	<> ie_tiss_tipo_guia_w AND ie_tiss_tipo_guia_w	= '6') or (ie_guia_partic_dif_w 	= 'N')) then
		
					
					SELECT * FROM tiss_obter_guia(		ie_tiss_tipo_guia_w, nr_interno_conta_w, nr_doc_convenio_w, ie_honorario_w, cd_medico_executor_w, cd_cgc_prestador_tiss_w, ie_resp_credito_proc_w, ie_funcao_medico_w, cd_cbos_exec_w, ie_guia_regra_w, null, null, cd_senha_w, cd_setor_atendimento_w, cd_medico_req_w, coalesce(nr_prescr_gatilho_w, nr_prescricao_w), cd_medico_solic_prescr_w, dt_procedimento_w, cd_funcionario_w, null, nr_seq_procedimento_w, null, cd_procedimento_w, ie_origem_proced_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_regra_w;

				end if;

			elsif (ie_guia_honorario_w = 'P') then
				nr_doc_convenio_w	:= nr_doc_convenio_proc_w;
			end if;

		end if;
		
		begin
			open c02;
			loop
			fetch c02 into
				ie_medico_solic_atend_regra_w,
				cd_medico_regra_solic_tiss_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */		
			end loop;
			close c02;
		exception
		when others then
			ie_medico_solic_atend_w := null;
			cd_medico_regra_solic_tiss_w	:= null;
		end;

		cd_medico_prof_solic_tiss_w	:= '';
		if (coalesce(ie_medico_solic_atend_w,'N') = 'R') then
			if (coalesce(ie_medico_solic_atend_regra_w,'X') = 'MP') then
				select	max(a.cd_medico)
				into STRICT	cd_medico_prof_solic_tiss_w
				from	prescr_medica a
				where	a.nr_atendimento	= nr_atendimento_w
				and	a.nr_prescricao	= coalesce(nr_prescr_gatilho_w,nr_prescricao_w);
			
				if (coalesce(cd_medico_prof_solic_tiss_w,'X') = 'X') then
					select	max(a.cd_medico_resp)
					into STRICT	cd_medico_prof_solic_tiss_w
					from	atendimento_paciente a
					where	a.nr_atendimento	= nr_atendimento_w;
				end if;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'MSP') then
				begin --lhalves OS273144 - mutante na trigger da prescr_procedimento
				select	max(a.cd_medico_solicitante)
				into STRICT	cd_medico_prof_solic_tiss_w
				from	prescr_procedimento a
				where	a.nr_prescricao	 		= coalesce(nr_prescr_gatilho_w,nr_prescricao_w)
				and	a.nr_sequencia			= nr_sequencia_prescricao_w;

				if (coalesce(cd_medico_prof_solic_tiss_w,'X') = 'X') then
					select	max(a.cd_medico)
					into STRICT	cd_medico_prof_solic_tiss_w
					from	prescr_medica a
					where	a.nr_atendimento	= nr_atendimento_w
					and	a.nr_prescricao		= coalesce(nr_prescr_gatilho_w,nr_prescricao_w);
				end if;
				exception
				when others then
					null;
				end;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'MRP') then
				select	coalesce(max(cd_medico_req),cd_medico_executor_w)
				into STRICT	cd_medico_prof_solic_tiss_w
				from 	procedimento_paciente
				where	nr_sequencia		= nr_seq_procedimento_p;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'RMP') then				
				select	coalesce(max(cd_medico_req),cd_medico_prof_solic_tiss_w)
				into STRICT	cd_medico_prof_solic_tiss_w
				from 	procedimento_paciente
				where	nr_sequencia		= nr_seq_procedimento_p;
				
				if (coalesce(cd_medico_prof_solic_tiss_w, '0') = '0') then
					select	max(cd_medico)
					into STRICT	cd_medico_prof_solic_tiss_w
					from	prescr_medica
					where	nr_prescricao	= coalesce(nr_prescr_gatilho_w,nr_prescricao_w);
				end if;	
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'RMA') then			
				select	coalesce(max(cd_medico_req),cd_medico_atend_w)
				into STRICT	cd_medico_prof_solic_tiss_w
				from 	procedimento_paciente
				where	nr_sequencia		= nr_seq_procedimento_p;
				
				if (coalesce(cd_medico_prof_solic_tiss_w, '0') = '0') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_prof_solic_tiss_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;
				end if;	
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'IR') then /*lhalves OS 372660 em 26/10/2011*/
				cd_medico_prof_solic_tiss_w	:= cd_medico_regra_solic_tiss_w;
			elsif (coalesce(ie_medico_solic_atend_regra_w,'X') = 'PA')  then
				select	max(cd_medico)
				into STRICT	cd_medico_prof_solic_tiss_w
				from	prescr_medica
				where	nr_prescricao	= coalesce(nr_prescr_gatilho_w,nr_prescricao_w)
				and 	coalesce(dt_suspensao::text, '') = '';
				if (coalesce(cd_medico_prof_solic_tiss_w, '0') = '0') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_prof_solic_tiss_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;
				end if;				
			end if;		
			
			if (ie_gravar_log_conta_w = 'S') and (ie_medico_solic_atend_w = 'R') and (coalesce(ie_medico_solic_atend_regra_w,'X') in ('MP','MSP','MRP','IR','PA'))	then
				ds_texto_w := substr(wheb_mensagem_pck.get_texto(310040)|| ' ('|| wheb_mensagem_pck.get_texto(310015) || ') >  '||
							wheb_mensagem_pck.get_texto(299651)||': '|| cd_procedimento_w || ' ' ||
							wheb_mensagem_pck.get_texto(278192)|| ' ' || nr_seq_procedimento_p || ' ' ||
							wheb_mensagem_pck.get_texto(310041)|| ': '|| ie_medico_solic_atend_regra_w || ' ' ||
							wheb_mensagem_pck.get_texto(310043)|| ': '|| cd_medico_prof_solic_tiss_w ,1,2000);
			/*	Regra Medico Solicitante (Atualizar Proc) > ||
				 Procedimento : || cd_procedimento_w || 
				 Seq:  || nr_seq_procedimento_p ||
				 Retorno Regra: || ie_medico_solic_atend_regra_w ||
				 Medico Solic TISS: || cd_medico_prof_solic_tiss_w	*/
				CALL TISS_GERAR_LOG_CONTA(nr_interno_conta_w,ds_texto_w,nm_usuario_p);
			end if;
		end if;

		ie_guia_honor_w := TISS_OBTER_REGRA_GUIA_DESP(cd_estabelecimento_w, cd_convenio_w, ie_tipo_atendimento_w, ie_guia_honor_w);

		ds_campo_w		:= '';
		ds_proc_regra_w		:= '';
		if (ie_tiss_tipo_guia_w in ('3','4','5','6')) then
			ds_campo_w		:= 'DS_PROCEDIMENTO';
			ds_proc_regra_w		:= ds_procedimento_w;
		elsif (ie_tiss_tipo_guia_w in ('7')) then
			ds_campo_w		:= 'DS_DESPESA';
			ds_desp_regra_w		:= ds_procedimento_w;
			cd_desp_convenio_w	:= cd_procedimento_convenio_w;
		end if;

		select	max(cd_classif_setor)
		into STRICT	cd_classif_setor_w
		from	setor_atendimento
		where	cd_setor_atendimento	= cd_setor_atendimento_w;
		

		if (ie_tiss_tipo_guia_w	= '5') and (ie_honorario_w		in ('N','P')) then
			ie_guia_w	:= 'RI';
			ds_campo_tiss_w	:= 'DS_PROC_RI';
		elsif (ie_tiss_tipo_guia_w	= '5') and (ie_honorario_w		= 'S') then
			ie_guia_w	:= 'RIH';
			ds_campo_tiss_w	:= 'DS_PROC_RIH';
		elsif (ie_tiss_tipo_guia_w	= '4') and (ie_honorario_w		in ('N','P')) then
			ie_guia_w	:= 'SADT';
			ds_campo_tiss_w	:= 'DS_PROC_SPSADT';
		elsif (ie_tiss_tipo_guia_w	= '4') and (ie_honorario_w		= 'S') then
			ie_guia_w	:= 'SADTH';
			ds_campo_tiss_w	:= 'DS_PROC_SPSADTH';
		end if;

		if (ie_desc_proc_interno_w = 'T') and (cd_procedimento_tuss_w IS NOT NULL AND cd_procedimento_tuss_w::text <> '') then
			ds_procedimento_w	:= substr(tiss_eliminar_caractere(coalesce(obter_descricao_procedimento(cd_procedimento_tuss_w, '8'),ds_procedimento_w)), 1, 60);
		end if;
		
		select	substr(obter_valor_dominio(1372,ie_lado_proc_w),1,255)
		into STRICT	ds_lado_proc_w
		;

		ds_proc_tiss_w		:= tiss_obter_campo_esp(cd_convenio_w,
								cd_estabelecimento_w,
								ds_campo_w,
								ds_procedimento_w,
								ds_desp_regra_w,
								null,
								cd_classif_setor_w,
								ie_funcao_medico_w,
								null,
								null,
								ie_tipo_protocolo_w,
								ie_tipo_guia_atend_w,
								cd_regional_w,
								ie_guia_w,
								cd_procedimento_w,
								ie_origem_proced_w,
								cd_setor_atendimento_w,
								ie_tipo_atendimento_w,
								cd_cgc_prestador_w,
								ie_resp_credito_proc_w,
								cd_medico_executor_w,
								nr_interno_conta_w,
								nr_prescricao_w, 
								ds_lado_proc_w, 
								cd_procedimento_convenio_w, 
								cd_desp_convenio_w);

		if (ie_guia_w IS NOT NULL AND ie_guia_w::text <> '') and (ds_campo_tiss_w IS NOT NULL AND ds_campo_tiss_w::text <> '') and (ds_proc_tiss_w IS NOT NULL AND ds_proc_tiss_w::text <> '') then

			select	nextval('proc_paciente_tiss_seq')
			into STRICT	nr_seq_proc_pac_tiss_w
			;

			insert into proc_paciente_tiss(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_procedimento,
				nr_seq_partic,
				ds_campo,
				vl_campo)
			values (nr_seq_proc_pac_tiss_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_procedimento_p,
				nr_seq_partic_w,
				ds_campo_tiss_w,
				ds_proc_tiss_w);

		end if;
		
		vl_desp_tiss_w	:= null;
		if (ie_tiss_tipo_guia_w	= '7') then
			SELECT * FROM tiss_obter_regra_valor_proc(	cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, cd_cgc_prestador_w, ie_responsavel_credito_w, cd_procedimento_w, ie_origem_proced_w, vl_medico_w, vl_custo_operacional_w, vl_materiais_w, vl_desp_tiss_w, ie_regra_valor_w, 0, ie_funcao_medico_w, vl_partic_w, ie_honorario_w, nr_seq_procedimento_p, cd_plano_convenio_w, dt_procedimento_w, null) INTO STRICT vl_desp_tiss_w, ie_regra_valor_w;
		end if;
		
		begin
		ds_proc_tiss_w	:= coalesce(tiss_obter_tabela(cd_edicao_amb_w,
							cd_estabelecimento_w,
							cd_convenio_w,
							cd_categoria_w,
							dt_conta_w,
							'D',
							ie_classificacao_w,
							cd_procedimento_w,
							ie_origem_proced_w,
							nr_seq_procedimento_p,
							nr_seq_proc_pacote_w,
							nr_atendimento_w,
							nr_seq_proc_interno_w,
							nr_seq_exame_w,
							cd_procedimento_tuss_w),ds_proc_tiss_w);
		exception
		when others then
			ds_proc_tiss_w	:= null;
		end;	
		
		
		cd_proc_regra_tabela_w := tiss_obter_tabela( 	cd_edicao_amb_w,
								cd_estabelecimento_w,
								cd_convenio_w,
								cd_categoria_w,
								dt_conta_w,
								'C',
								ie_classificacao_w,
								cd_procedimento_w,
								ie_origem_proced_w,
								nr_seq_procedimento_p,
								nr_seq_proc_pacote_w,
								nr_atendimento_w,
								nr_seq_proc_interno_w,
								nr_seq_exame_w,
								cd_procedimento_tuss_w);
								
		if 	coalesce(cd_procedimento_tuss_w,0) <> 0 then
		
			for r in (	SELECT 	a.ie_codigo_tuss
					from 	tiss_regra_tuss a
					where	a.cd_estabelecimento	= cd_estabelecimento_w
					and 	a.cd_convenio		= cd_convenio_w
					and 	a.dt_inicio_vigencia	<= dt_procedimento_w
					and (exists (select	1
								from	tiss_regra_tuss_filtro x
								where	x.nr_seq_regra						= a.nr_sequencia
								and	coalesce(x.ie_classif_proced,coalesce(ie_classif_proced_w,'X'))	= coalesce(ie_classif_proced_w,'X')) or
						not exists (select	1
								from	tiss_regra_tuss_filtro x
								where	x.nr_seq_regra				= a.nr_sequencia))		
					order by a.dt_inicio_vigencia) loop
			
			
				ie_proc_tuss_w := r.ie_codigo_tuss;
			
			end loop;
		end if;
								
		if	coalesce(cd_proc_regra_tabela_w::text, '') = '' then
		
			
			cd_proc_tiss_w	:= obter_codigo_proced_tiss(	ie_proc_tuss_w,
									cd_procedimento_tuss_w,
									cd_procedimento_convenio_w,
									obter_se_pacote(nr_seq_procedimento_p,nr_seq_proc_pacote_w),
									cd_procedimento_w,
									null);
		
		
		
		
		else
		
			cd_proc_tiss_w	:= cd_proc_regra_tabela_w;

		end if;
		
		
		cd_proc_tiss_w	:= tiss_obter_regra_campo_proc(cd_proc_tiss_w, '3', cd_convenio_w, cd_estabelecimento_w, cd_procedimento_w, ie_origem_proced_w, null,cd_categoria_w, cd_plano_convenio_w,ie_tipo_atendimento_w,null, ie_tiss_tipo_guia_w);
		
		if (length(cd_proc_tiss_w) < 8) then
			cd_proc_tiss_w	:= lpad(cd_proc_tiss_w,8,'0');
		end if;
			

		if	(cd_proc_tiss_w IS NOT NULL AND cd_proc_tiss_w::text <> '') then
		
			
			
			DELETE 	FROM proc_paciente_tiss
			WHERE	nr_seq_procedimento = nr_seq_procedimento_p
			and	ds_campo 	= 'CD_PROC_TISS';
			
			select	nextval('proc_paciente_tiss_seq')
			into STRICT	nr_seq_proc_pac_tiss_w
			;
			
			
			insert into proc_paciente_tiss(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_procedimento,
				nr_seq_partic,
				ds_campo,
				vl_campo,
				ie_tiss_tipo_guia)
			values (nr_seq_proc_pac_tiss_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_procedimento_p,
				null,
				'CD_PROC_TISS',
				cd_proc_tiss_w,
				ie_tiss_tipo_guia_w);
			
		end if;
		
		

		if (ie_honorario_w = 'S') then
		
			-- Edgar 20/09/2007, OS 64865, so gerar o doc_conv de honor se guia de honor
			if (ie_tiss_tipo_guia_w = '7') then
				nr_doc_convenio_w	:= null;
			elsif (ie_tiss_tipo_guia_w = '5') and (coalesce(ie_honor_ri_w,'N') = 'N') then
				nr_doc_convenio_w	:= null;
			elsif (ie_tiss_tipo_guia_w = '4') then
				if (TISS_OBTER_SE_HONOR_SPSADT(cd_convenio_w,
						cd_estabelecimento_w,
						ie_responsavel_credito_w,
						ie_tipo_atendimento_w,
						cd_setor_entrada_w,
						ie_executor_w) = 'N') then
					nr_doc_convenio_w	:= null;
				end if;
			end if;

			if (ie_guia_regra_w	= 'H') then
				nr_doc_convenio_w	:= null;
			end if;
			
			

			update	procedimento_paciente
			set	ie_tiss_tipo_guia_honor	= ie_tiss_tipo_guia_w,
				cd_cgc_honorario_tiss	= coalesce(cd_cgc_prestador_tiss_w, cd_cgc_prestador_w),
				cd_prestador_tiss	= coalesce(cd_prestador_tiss, cd_prestador_tiss_w),
				cd_cgc_prest_solic_tiss	= coalesce(cd_cgc_prest_solic_tiss, cd_cgc_prest_solic_w),
				nr_doc_honor_conv	= coalesce(nr_doc_honor_conv, substr(nr_doc_convenio_w,1,20)),
				ie_tecnica_utilizada	= coalesce(ie_tecnica_utilizada_w,ie_tecnica_utilizada),
				ie_tiss_desp_honor	= ie_guia_honor_w,
				--cd_medico_exec_tiss	= decode(ie_tiss_tipo_guia_w,'6',null,cd_medico_exec_tiss_w), OS220656

				--cd_medico_exec_tiss	= decode(ie_tiss_tipo_guia_w,'7',cd_medico_exec_tiss_w,null), dsantos em 07/01/2011 - OS279740.
				ds_proc_tiss		= ds_proc_tiss_w,
				ds_prestador_tiss	= ds_prestador_tiss_w,
				nr_seq_regra_honor_tiss	= nr_seq_regra_guia_tiss_w,
				--ie_tipo_atend_tiss	= ie_tipo_atend_tiss_w,
				vl_desp_tiss		= vl_desp_tiss_w,
				cd_medico_prof_solic_tiss	= cd_medico_prof_solic_tiss_w,
				cd_prestador_solic_tiss	= cd_prestador_solic_w,
				ds_prestador_solic_tiss	= ds_prestador_solic_w,
				cd_medico_honor_tiss	= cd_medico_exec_tiss_w,
				cd_senha		= coalesce(cd_senha,cd_senha_item_w),
				cd_cgc_prest_honor_tiss	= cd_cgc_prest_honor_tiss_w
			where	nr_sequencia		= nr_seq_procedimento_p;

			if (ie_tiss_tipo_guia_w <> '4') then
				ie_honor_regra_prest_w	:= 'S';
			else
				if (TISS_OBTER_SE_HONOR_SPSADT(cd_convenio_w,cd_estabelecimento_w,ie_responsavel_credito_w,
								ie_tipo_atendimento_w,cd_setor_entrada_w,ie_executor_w) = 'S') then
					ie_honor_regra_prest_w	:= 'S';
				else
					ie_honor_regra_prest_w	:= 'N';
				end if;
			end if;
			
			if (ie_guia_prestador_w = 'R') then
				
				CALL TISS_GERAR_GUIA_PREST_PROC(	cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, nr_interno_conta_w,
								nr_seq_procedimento_p, null, ie_honorario_w, nm_usuario_p);				
			end if;

			CALL TISS_GERAR_PRESTADOR_PROC(nr_seq_procedimento_p,nm_usuario_p,ie_honor_regra_prest_w);

		elsif (ie_honorario_w = 'N') then

			nr_seq_tiss_tabela_w		:= (tiss_obter_tabela(	cd_edicao_amb_w,
												cd_estabelecimento_w,
												cd_convenio_w,
												cd_categoria_w,
												dt_conta_w,
												'T',
												ie_classificacao_w,
												cd_procedimento_w,
												ie_origem_proced_w,
												nr_seq_procedimento_p,
												nr_seq_proc_pacote_w,
												nr_atendimento_w,
												nr_seq_proc_interno_w,
												nr_seq_exame_w,
												cd_procedimento_tuss_w))::numeric;
			if (coalesce(nr_seq_tiss_tabela_w,0) = 0) then
				nr_seq_tiss_tabela_w	:= nr_seq_tiss_tabela_proc_w;
			end if;

			if (coalesce(nr_seq_tiss_tabela_w,0) = 0) then
				if	((ie_proc_tuss_w = 'S') or
					 (ie_proc_tuss_w = 'P' AND nr_seq_procedimento_p = nr_seq_proc_pacote_w) or
					 ((ie_proc_tuss_w = 'C') and (coalesce(cd_procedimento_tuss_w,'0') <> '0'))
					) and
					(coalesce(cd_procedimento_tuss_w,'0') <> '0') then --lhalves OS262579 em 29/10/2010 - Incluido nvl e <> '0' pois na conta grava com 0 se nao existe
					
					nr_seq_tiss_tabela_w		:= 23;
				end if;
			end if;

			if (ie_guia_regra_w	= 'HN') then
				nr_doc_convenio_w	:= null;
			end if;

			update	procedimento_paciente
			set	ie_tiss_tipo_guia		= ie_tiss_tipo_guia_w,
				nr_seq_tiss_tabela		= nr_seq_tiss_tabela_w,
				cd_cgc_prestador_tiss		= coalesce(cd_cgc_prestador_tiss_w, cd_cgc_prestador_w),
				cd_medico_exec_tiss		= cd_medico_exec_tiss_w,
				cd_prestador_tiss		= cd_prestador_tiss_w,
				cd_cgc_prest_solic_tiss		= coalesce(cd_cgc_prest_solic_tiss, cd_cgc_prest_solic_w),
				nr_doc_convenio			= coalesce(nr_doc_convenio, substr(nr_doc_convenio_w,1,20)),
				ie_tecnica_utilizada		= coalesce(ie_tecnica_utilizada_w,ie_tecnica_utilizada),
				ie_tiss_desp_honor		= ie_guia_honor_w,
				ds_proc_tiss			= ds_proc_tiss_w,
				ds_prestador_tiss		= ds_prestador_tiss_w,
				nr_seq_regra_guia_tiss		= nr_seq_regra_guia_tiss_w,
				--ie_tipo_atend_tiss		= ie_tipo_atend_tiss_w,
				vl_desp_tiss			= vl_desp_tiss_w,
				cd_medico_solic_tiss		= coalesce(cd_medico_solic_tiss_w, CASE WHEN coalesce(ie_solicitante_w,'N')='PE' THEN  cd_medico_executor  ELSE null END ),
				cd_medico_prof_solic_tiss	= cd_medico_prof_solic_tiss_w,
				cd_prestador_solic_tiss		= cd_prestador_solic_w,
				ds_prestador_solic_tiss		= ds_prestador_solic_w,
				cd_senha			= coalesce(cd_senha, cd_senha_item_w)			
			where	nr_sequencia			= nr_seq_procedimento_p;
			
			if (ie_guia_prestador_w = 'R') then
				
				CALL TISS_GERAR_GUIA_PREST_PROC(	cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, nr_interno_conta_w,
								nr_seq_procedimento_p, null, ie_honorario_w, nm_usuario_p);				
			end if;

			CALL TISS_GERAR_PRESTADOR_PROC(nr_seq_procedimento_p,nm_usuario_p,'N');

		elsif (ie_honorario_w = 'P') then

			if (ie_guia_regra_w	= 'H') then
				nr_doc_convenio_w	:= null;
			end if;

			update	procedimento_participante
			set	ie_tiss_tipo_guia		= ie_tiss_tipo_guia_w,
				nr_doc_honor_conv	= coalesce(nr_doc_honor_conv, substr(nr_doc_convenio_w,1,20)),
				cd_medico_exec_tiss	= cd_medico_exec_tiss_w,
				cd_cgc_prestador_tiss	= coalesce(cd_cgc_prestador_tiss_w, cd_cgc_prestador_w),
				cd_cgc_prest_solic_tiss	= coalesce(cd_cgc_prest_solic_tiss, cd_cgc_prest_solic_w),
				ds_proc_tiss		= ds_proc_tiss_w,
				ds_prestador_tiss	= ds_prestador_tiss_w,
				cd_prestador_tiss	= cd_prestador_tiss_w,
				cd_medico_honor_tiss	= cd_medico_exec_tiss_w,
				cd_cgc_prest_honor_tiss	= cd_cgc_prest_honor_tiss_w
			where	nr_sequencia		= nr_seq_procedimento_p
			and	nr_seq_partic		= nr_seq_partic_w;
			
			if (ie_guia_prestador_w = 'R') then
				
				CALL TISS_GERAR_GUIA_PREST_PROC(	cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, nr_interno_conta_w,
								nr_seq_procedimento_p, nr_seq_partic_w, ie_honorario_w, nm_usuario_p);				
			end if;

		end if;	

	end loop;
	close c03;

	CALL wheb_usuario_pck.set_ie_executar_trigger('S');

	CALL TISS_GERAR_PARTIC_ADIC(nr_seq_procedimento_p, nm_usuario_p);
	
end if;

--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if; nao dar commit pois gera erro na trigger
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_atualizar_procedimento (nr_seq_procedimento_p text, ie_atualizar_todos_p text, nm_usuario_p text) FROM PUBLIC;

