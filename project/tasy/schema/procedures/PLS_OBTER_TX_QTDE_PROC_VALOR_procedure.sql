-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_tx_qtde_proc_valor ( nr_seq_conta_proc_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, tx_procedimento_p INOUT bigint, tx_medico_p INOUT bigint, tx_custo_operacional_p INOUT bigint, tx_material_p INOUT bigint, tx_anestesista_p INOUT bigint, tx_auxiliares_p INOUT bigint, ie_via_acesso_p INOUT pls_conta_proc.ie_via_acesso%type) AS $body$
DECLARE


nr_seq_tipo_prestador_w         bigint;
nr_seq_classificacao_w          bigint;
nr_seq_prestador_exec_w         bigint;
nr_seq_segurado_w               bigint;
dt_conta_w                      timestamp;
ie_tipo_partic_prof_w           varchar(10);
ie_tipo_guia_w                  varchar(2);
cd_grupo_proc_w                 bigint;
cd_especialidade_w              bigint;
cd_area_procedimento_w          bigint;
nr_seq_proc_w                   bigint;
nr_seq_proc_ww                  bigint;
qt_procedimento_ww              double precision;
qt_procedimento_imp_w           double precision    := 0;
qt_procedimento_regra_w         double precision;
qt_proced_for_w                 double precision;
qt_procedimento_regra_ww        double precision    := 0;
vl_total_procedimento_w         double precision;
vl_proc_unit_w                  double precision;
vl_proc_copartic_unit_w         double precision;
vl_medico_unit_w                double precision;
vl_co_unit_w                    double precision;
vl_mat_unit_w                   double precision;
qt_exec_proc_w                  double precision;
nr_seq_proc_up_w                bigint      := 0;
qt_proc_regra_w                 bigint      := 0;
qt_cursor_w                     bigint      := 0;

cd_procedimento_w               bigint;
ie_origem_proced_w              bigint;
qt_procedimento_w               double precision;
vl_procedimento_w               double precision;
vl_proc_copartic_w              double precision;
vl_medico_w                     double precision;
vl_pag_medico_conta_w           double precision;
vl_custo_operacional_w          double precision;
vl_materiais_w                  double precision;
vl_anestesista_w                double precision;
vl_auxiliares_w                 double precision;
vl_proc_unitario_w              double precision;
dt_procedimento_w               timestamp;
ie_tipo_despesa_w               varchar(1);

nr_seq_regra_w                  bigint;
nr_seq_regra_ww                 bigint;
ie_regra_execucao_w             varchar(1);
ie_regra_execucao_ww            varchar(1);

qt_participante_w               bigint;
qt_participante_proc_w          bigint;
qt_participante_regra_w         bigint;
ie_abrir_execucao_w             varchar(1);
ie_abrir_execucao_ww            varchar(1);
nr_seq_grupo_prestador_w        bigint;
ie_grupo_servico_w              varchar(1);
ie_grupo_prestador_w            varchar(1);

nr_seq_regra_tx_w               bigint;
tx_procedimento_w               double precision;
tx_medico_w                     double precision;
tx_custo_operacional_w          double precision;
tx_material_w                   double precision;
nr_seq_taxa_item_w              bigint;
qt_exec_max_w                   bigint      := 0;
qt_exec_min_w                   bigint      := 0;
qt_exec_w                       double precision;
qt_loop_w                       bigint      := 1;
qt_total_proc_w                 bigint      := 0;
qt_total_proc_ww                bigint      := 1;
vl_procedimento_ww              double precision;
vl_proc_copartic_ww             double precision;
vl_medico_ww                    double precision;
vl_custo_operacional_ww         double precision;
vl_pag_medico_conta_ww          double precision;
vl_total_procedimento_ww        double precision;
vl_materiais_ww                 double precision;
nr_seq_conta_proc_w             bigint;
ie_participacao_ww              varchar(10);
ie_participacao_w               varchar(10);
ie_entra_regras_w               varchar(10);
qt_proc_participante_w          bigint;
qt_igual_w                      bigint;
ie_termina_cursor_w             varchar(10)    := 'N';
vl_procedimento_imp_w           double precision;
tx_anestesista_w                double precision;
tx_auxiliares_w                 double precision;
tx_procedimento_tot_w           double precision    := 0;
tx_medico_tot_w                 double precision    := 0;
tx_custo_operacional_tot_w      double precision    := 0;
tx_material_tot_w               double precision    := 0;
tx_anestesista_tot_w            double precision    := 0;
tx_auxiliares_tot_w             double precision    := 0;
tx_item_orig_w			double precision	:= 0;
nr_seq_regra_tx_proc_w		bigint;
qt_exec_tx_w			bigint;
qt_total_proc_tx_w		bigint;
nr_seq_regra_tx_proc_ww		bigint	:= null;
qt_intervalo_w			bigint;
ie_tipo_conta_w			pls_conta.ie_tipo_conta%type;
Ie_Alterar_Se_Maior_w		varchar(1);
cd_guia_referencia_w		pls_conta.cd_guia_ok%type;
nr_seq_grau_partic_conta_w	pls_conta.nr_seq_grau_partic%type;
ie_tipo_guia_conta_w		pls_conta.ie_tipo_guia%type;
ie_via_acesso_w			pls_conta_proc.ie_via_acesso%type;
ie_via_acesso_orig_w		pls_conta_proc.ie_via_acesso%type;
ie_considerar_glosados_w	pls_parametros.ie_considerar_glosados%type;

C01 CURSOR FOR
        SELECT  a.cd_procedimento,
                a.ie_origem_proced,
                a.qt_procedimento_imp,
                a.dt_procedimento,
                a.ie_tipo_despesa,
                a.nr_sequencia,
                a.vl_procedimento_imp vl_proc_imp,
                a.nr_seq_regra_qtde_exec,
		a.tx_item,
		( SELECT	count(1)
		  from		pls_proc_participante	z
		  where		z.nr_seq_conta_proc	= a.nr_sequencia
		  and		z.ie_status	!= 'C' ) qt_participante,
		 b.nr_seq_grau_partic,
		 b.ie_tipo_guia,
		 a.ie_via_acesso
        from    pls_conta_proc  a,
		pls_conta	b
        where   a.nr_sequencia          = nr_seq_conta_proc_p
	and	a.nr_seq_conta		= b.nr_sequencia
	and ( a.ie_glosa = 'N' or coalesce(a.ie_glosa::text, '') = '' or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
        and     a.nr_seq_regra_qtde_exec > 0
	and	a.ie_status in ('A', 'C', 'L', 'P', 'S', 'U')
        order by coalesce(a.vl_liberado,0) desc,       
		coalesce(vl_proc_imp,0) desc;

/*retirado a restrição ie_valor informado OS 418620 Diogo */

C03 CURSOR FOR
        SELECT  a.nr_sequencia,
                coalesce(a.tx_procedimento,100),
                coalesce(a.tx_medico,100),
                coalesce(a.tx_custo_operacional,100),
                coalesce(a.tx_material,100),
                nr_seq_taxa_item,
                coalesce(a.qt_exec_max,0),
                coalesce(a.qt_exec_min,0),
                coalesce(a.tx_anestesista,0),
                coalesce(a.tx_auxiliares,0),
		a.ie_via_acesso
        from    pls_regra_preco_tx_proc a
        where   a.ie_situacao   = 'A'
        and     a.nr_seq_regra  = nr_seq_regra_w
        order by coalesce(a.qt_exec_min,0);

BEGIN



select 	coalesce(max(ie_considerar_glosados),'N')
into STRICT 	ie_considerar_glosados_w
from	pls_parametros
where 	cd_estabelecimento = cd_estabelecimento_p;

/* Obter dados da conta */

select  nr_seq_prestador_exec,
        dt_atendimento,
        nr_seq_segurado,
        ie_tipo_partic_prof,
        ie_tipo_guia,
	ie_tipo_conta,
	nr_seq_clas_prest_exec,
	nr_seq_tipo_prest_exec,
	cd_guia_referencia
into STRICT    nr_seq_prestador_exec_w,
        dt_conta_w,
        nr_seq_segurado_w,
        ie_tipo_partic_prof_w,
        ie_tipo_guia_w,
	ie_tipo_conta_w,
	nr_seq_tipo_prestador_w,
        nr_seq_classificacao_w,
	cd_guia_referencia_w
from    pls_conta_v
where   nr_sequencia    = nr_seq_conta_p;

open C01;
loop
fetch C01 into
        cd_procedimento_w,
        ie_origem_proced_w,
        qt_procedimento_w,
        dt_procedimento_w,
        ie_tipo_despesa_w,
        nr_seq_conta_proc_w,
        vl_procedimento_imp_w,
        nr_seq_regra_w,
	tx_item_orig_w,
	qt_participante_w,
	nr_seq_grau_partic_conta_w,
	ie_tipo_guia_conta_w,
	ie_via_acesso_orig_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
		
		
		
	qt_total_proc_ww        := 1;
        vl_total_procedimento_w := 0;
        /* Obter a estrutura do procedimento */

        SELECT * FROM pls_obter_estrut_proc(	cd_procedimento_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;
	
	--Pesquisa por campo chave, utilizado max para não ocorrer no data found.
	select  max(a.ie_regra_execucao) ie_regra_execucao,
		coalesce(max(ie_abrir_execucao),'N'),
		max(a.ie_participacao) ie_participacao
	into STRICT    ie_regra_execucao_w,
		ie_abrir_execucao_w,
		ie_participacao_w
	from    pls_regra_preco_qtde_proc       a
	where   nr_sequencia 	= nr_seq_regra_w;

        if (dt_procedimento_w IS NOT NULL AND dt_procedimento_w::text <> '') then
                dt_conta_w      := dt_procedimento_w;
        end if;

	if (coalesce(nr_seq_regra_w,0) > 0) then
		if (ie_participacao_w = 'S') then
			if (ie_regra_execucao_w = 'C') then
				if (qt_participante_w	> 0) then
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a
					where   a.nr_seq_conta                  = nr_seq_conta_p
					and     ie_regra_qtde_execucao 		= 'S'
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	exists	(	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia	= y.nr_seq_conta_proc
								and	y.ie_status	!= 'C'
								and	exists	(	select	1 
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											and	((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = '')))));
				else
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a
					where   a.nr_seq_conta                  = nr_seq_conta_p
					and     ie_regra_qtde_execucao 		= 'S'
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');

				end if;
			elsif (ie_regra_execucao_w = 'D') then
				if (qt_participante_w	> 0) then
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a,
						pls_conta       b
					where   b.nr_sequencia                  = a.nr_seq_conta
					and     b.nr_seq_segurado               = nr_seq_segurado_w
					and     ie_regra_qtde_execucao		= 'S'
					and	((a.ie_glosa	= 'N') or (coalesce(a.ie_glosa::text, '') = '') or (b.ie_tipo_conta = 'I') or (ie_considerar_glosados_w = 'S'))
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400
					and	((exists	(	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia	= y.nr_seq_conta_proc
								and	y.ie_status	!= 'C'
								and	exists	(	select	1
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic))) or
											and	((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = '')))))) or
											
						((b.ie_tipo_guia = 6) and
						(exists	(	select	1 
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											--and	z.nr_seq_grau_partic = b.nr_seq_grau_partic))));
											and	((z.nr_seq_grau_partic = b.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(b.nr_seq_grau_partic::text, '') = '')))))));
											
				else
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a,
						pls_conta       b
					where   b.nr_sequencia                  = a.nr_seq_conta
					and     b.nr_seq_segurado               = nr_seq_segurado_w
					and     ie_regra_qtde_execucao		= 'S'
					and	((a.ie_glosa	= 'N') or (coalesce(a.ie_glosa::text, '') = '') or (b.ie_tipo_conta = 'I') or (ie_considerar_glosados_w = 'S'))
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400
					and	((nr_seq_grau_partic_conta_w	= b.nr_seq_grau_partic) or (ie_tipo_guia_conta_w 		= '3') or (exists (	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia		= y.nr_seq_conta_proc
								and	y.ie_status		!= 'C'
								and	y.nr_seq_grau_partic	= nr_seq_grau_partic_conta_w)) or (coalesce(nr_seq_grau_partic_conta_w::text, '') = '' and  coalesce(b.nr_seq_grau_partic::text, '') = ''));
				
				end if;
							
			elsif (ie_regra_execucao_w = 'M') then
				if (qt_participante_w	> 0) then
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a,
						pls_conta       b
					where   b.nr_sequencia                  = a.nr_seq_conta
					and     b.nr_seq_segurado               = nr_seq_segurado_w
					and     ie_regra_qtde_execucao		= 'S'
					and	((coalesce(a.ie_glosa,'N')	<> 'S') or (b.ie_tipo_conta = 'I') or (ie_considerar_glosados_w = 'S'))
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month')
					and	exists	(	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia	= y.nr_seq_conta_proc
								and	y.ie_status	!= 'C'
								and	exists	(	select	1 
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic));
											and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))));
											
				else
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc  a,
						pls_conta       b
					where   b.nr_sequencia                  = a.nr_seq_conta
					and     b.nr_seq_segurado               = nr_seq_segurado_w
					and     ie_regra_qtde_execucao		= 'S'
					and	((coalesce(a.ie_glosa,'N')	<> 'S') or (b.ie_tipo_conta = 'I') or (ie_considerar_glosados_w = 'S'))
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month')
					and	exists		(SELECT	1
								 from	pls_conta 	c,
									pls_conta_proc	pc	 	
								 where	((c.nr_seq_grau_partic	= b.nr_seq_grau_partic) or (b.ie_tipo_guia in (5,3)) or (coalesce(c.nr_seq_grau_partic::text, '') = '' and  coalesce(b.nr_seq_grau_partic::text, '') = ''))
								 and	pc.nr_seq_conta		= c.nr_sequencia
								 and	pc.nr_sequencia		= nr_seq_conta_proc_w);
				end if;
			elsif (ie_regra_execucao_w = 'A') then
				if (qt_participante_w	> 0) then
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc_v  a
					where   a.cd_guia_referencia		= cd_guia_referencia_w
					and	a.nr_seq_segurado		= nr_seq_segurado_w
					and     a.ie_regra_qtde_execucao 	= 'S'
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
					and	exists	(	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia	= y.nr_seq_conta_proc
								and	y.ie_status	!= 'C'
								and	exists	(	select	1
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_p
											--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic));
											and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))));
											
				else
					select  coalesce(sum(a.qt_procedimento_imp),0)
					into STRICT    qt_exec_w
					from    pls_conta_proc_v  a
					where   a.cd_guia_referencia            = cd_guia_referencia_w
					and	a.nr_seq_segurado		= nr_seq_segurado_w
					and     a.ie_regra_qtde_execucao 	= 'S'
					and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
					and	a.nr_sequencia			!= nr_seq_conta_proc_p
					and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
					and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');
				end if;
			end if;
		else
			if (ie_regra_execucao_w = 'C') then
				select  coalesce(sum(a.qt_procedimento_imp),0)
				into STRICT    qt_exec_w
				from    pls_conta_proc  a
				where   a.nr_seq_conta                  = nr_seq_conta_p
				and     ie_regra_qtde_execucao		= 'S'
				and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
				and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
				and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
				and	a.nr_sequencia			!= nr_seq_conta_proc_p;
			elsif (ie_regra_execucao_w = 'D') then
				select  coalesce(sum(a.qt_procedimento_imp),0)
				into STRICT    qt_exec_w
				from    pls_conta_proc  a,
					pls_conta       b
				where   b.nr_sequencia                  = a.nr_seq_conta
				and     b.nr_seq_segurado               = nr_seq_segurado_w
				and     ie_regra_qtde_execucao		= 'S'
				and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
				and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
				and	a.nr_sequencia			!= nr_seq_conta_proc_p
				and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
				and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400;
			elsif (ie_regra_execucao_w = 'M') then
				select  coalesce(sum(a.qt_procedimento_imp),0)
				into STRICT    qt_exec_w
				from    pls_conta_proc  a,
					pls_conta       b
				where   b.nr_sequencia                  = a.nr_seq_conta
				and     b.nr_seq_segurado               = nr_seq_segurado_w
				and     ie_regra_qtde_execucao		= 'S'
				and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
				and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
				and	a.nr_sequencia			!= nr_seq_conta_proc_p
				and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
				and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month');
			elsif (ie_regra_execucao_w = 'A') then			
				select  coalesce(sum(a.qt_procedimento_imp),0)
				into STRICT    qt_exec_w
				from    pls_conta_proc_v  a
				where   a.cd_guia_referencia            = cd_guia_referencia_w
				and	a.nr_seq_segurado		= nr_seq_segurado_w
				and     a.ie_regra_qtde_execucao 	= 'S'
				and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
				and	a.nr_sequencia			!= nr_seq_conta_proc_p
				and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
				and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');
			end if;
		end if;
	end if;
	
	qt_loop_w               := qt_exec_w + 1;
	qt_total_proc_w         := qt_procedimento_w + qt_exec_w;
	vl_procedimento_w       := 0;
	vl_proc_copartic_w      := 0;
	vl_medico_w             := 0;
	vl_custo_operacional_w  := 0;
	vl_materiais_w          := 0;
	nr_seq_regra_tx_w       := 0;

	open C03;
	loop
	fetch C03 into
		nr_seq_regra_tx_w,
		tx_procedimento_w,
		tx_medico_w,
		tx_custo_operacional_w,
		tx_material_w,
		nr_seq_taxa_item_w,
		qt_exec_max_w,
		qt_exec_min_w,
		tx_anestesista_w,
		tx_auxiliares_w,
		ie_via_acesso_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		/* SE AS TAXAS  TIVEREM VALOR ZERO , ENTAO É TRATADO PARA QUE SEJAM CONSIDERADAS 100% - PARA QUE N*/


		-------------------------------------------------------------------------------------------------
		if (tx_procedimento_w = 0) then
			tx_procedimento_w       := 100;
		end if;

		if (tx_medico_w = 0) then
			tx_medico_w     := 100;
		end if;

		if (tx_custo_operacional_w = 0) then
			tx_custo_operacional_w  := 100;
		end if;

		if (tx_material_w = 0) then
			tx_material_w   := 100;
		end if;
		if ( tx_anestesista_w = 0) then
			tx_anestesista_w := 100;
		end if;
		if ( tx_auxiliares_w = 0 ) then
			tx_auxiliares_w := 100;
		end if;

		-------------------------------------------------------------------------------------------------
		
		if ( qt_procedimento_w     <> 0) then
			if (coalesce(nr_seq_taxa_item_w,0) > 0) then
				tx_procedimento_w       := pls_obter_taxa_item(nr_seq_taxa_item_w);
				tx_medico_w             := tx_procedimento_w;
				tx_custo_operacional_w  := tx_procedimento_w;
				tx_material_w           := tx_procedimento_w;
				tx_anestesista_w        := tx_procedimento_w;
				tx_auxiliares_w         := tx_procedimento_w;
			end if;

			if (ie_abrir_execucao_w    = 'S') then
				
				if (qt_exec_max_w  = 0) then
					qt_exec_max_w   := 9999;
				end if;
				if (ie_participacao_w = 'S') then
					if (ie_regra_execucao_w = 'C') then
						if (qt_participante_w > 0) then
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a
							where   a.nr_seq_conta                  = nr_seq_conta_p
							and     ie_regra_qtde_execucao		= 'S'
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	exists	(	SELECT	1
											from	pls_proc_participante 	y
											where	a.nr_sequencia	= y.nr_seq_conta_proc
											and	y.ie_status	!= 'C'
											and	exists	(	select	1
														from	pls_conta_proc		x,
															pls_proc_participante	z
														where	x.nr_sequencia	= z.nr_seq_conta_proc
														and	z.ie_status	!= 'C'
														and	x.nr_sequencia 	= nr_seq_conta_proc_w
														--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic));
														and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
														or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))));

						else
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a
							where   a.nr_seq_conta                  = nr_seq_conta_p
							and     ie_regra_qtde_execucao		= 'S'
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');
						end if;
					elsif (ie_regra_execucao_w = 'D') then
						if (qt_participante_w	> 0) then
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a,
								pls_conta       b
							where   b.nr_sequencia                  = a.nr_seq_conta
							and     b.nr_seq_segurado               = nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400
							and	((exists	(	SELECT	1
								from	pls_proc_participante 	y
								where	a.nr_sequencia	= y.nr_seq_conta_proc
								and	y.ie_status	!= 'C'
								and	exists	(	select	1
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic))) or
											and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
											or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))))) or

								((b.ie_tipo_guia = 6) and
								(exists	(	select	1 
											from	pls_conta_proc		x,
												pls_proc_participante	z
											where	x.nr_sequencia	= z.nr_seq_conta_proc
											and	z.ie_status	!= 'C'
											and	x.nr_sequencia 	= nr_seq_conta_proc_w
											--and	z.nr_seq_grau_partic = b.nr_seq_grau_partic))));
											and	(((z.nr_seq_grau_partic = b.nr_seq_grau_partic) 
												or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(b.nr_seq_grau_partic::text, '') = ''))))))));
											
						else
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a,
								pls_conta       b
							where   b.nr_sequencia                  = a.nr_seq_conta
							and     b.nr_seq_segurado               = nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400
							and	exists		(SELECT	1
										 from	pls_conta 	c,
											pls_conta_proc	pc
										 where	((c.nr_seq_grau_partic	= b.nr_seq_grau_partic) or (b.ie_tipo_guia in (5,3)) or (coalesce(c.nr_seq_grau_partic::text, '') = '' and  coalesce(b.nr_seq_grau_partic::text, '') = ''))
										 and	pc.nr_seq_conta		= c.nr_sequencia
										 and	pc.nr_sequencia		= nr_seq_conta_proc_w);
						end if;
					elsif (ie_regra_execucao_w = 'M') then
						if (qt_participante_w	> 0) then
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a,
								pls_conta       b
							where   b.nr_sequencia                  = a.nr_seq_conta
							and     b.nr_seq_segurado               = nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_p
							and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month')
							and	exists	(	SELECT	1
											from	pls_proc_participante 	y
											where	a.nr_sequencia	= y.nr_seq_conta_proc
											and	y.ie_status	!= 'C'
											and	exists	(	select	1
														from	pls_conta_proc		x,
															pls_proc_participante	z
														where	x.nr_sequencia	= z.nr_seq_conta_proc
														and	z.ie_status	!= 'C'
														and	x.nr_sequencia 	= nr_seq_conta_proc_w
														--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic));
														and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
															or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))));
														
						else
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc  a,
								pls_conta       b
							where   b.nr_sequencia                  = a.nr_seq_conta
							and     b.nr_seq_segurado               = nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_p
							and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month')
							and	exists		(SELECT	1
											 from	pls_conta 	c,
												pls_conta_proc	pc
											 where	((c.nr_seq_grau_partic	= b.nr_seq_grau_partic) or (b.ie_tipo_guia in (5,3)) or (coalesce(c.nr_seq_grau_partic::text, '') = '' and  coalesce(b.nr_seq_grau_partic::text, '') = ''))
											 and	pc.nr_seq_conta		= c.nr_sequencia
											 and	pc.nr_sequencia		= nr_seq_conta_proc_w);
						end if;
					elsif (ie_regra_execucao_w = 'A') then
						if (qt_participante_w > 0) then
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc_v  a
							where   a.cd_guia_referencia            = cd_guia_referencia_w
							and	a.nr_seq_segurado		= nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
							and	exists	(	SELECT	1
											from	pls_proc_participante 	y
											where	a.nr_sequencia	= y.nr_seq_conta_proc
											and	y.ie_status	!= 'C'
											and	exists	(	select	1
														from	pls_conta_proc		x,
															pls_proc_participante	z
														where	x.nr_sequencia	= z.nr_seq_conta_proc
														and	z.ie_status	!= 'C'
														and	x.nr_sequencia 	= nr_seq_conta_proc_w
														--and	z.nr_seq_grau_partic = y.nr_seq_grau_partic));
														and	(((z.nr_seq_grau_partic = y.nr_seq_grau_partic) 
															or ((coalesce(z.nr_seq_grau_partic::text, '') = '') and (coalesce(y.nr_seq_grau_partic::text, '') = ''))))));
														
						else
							select  coalesce(sum(a.qt_procedimento_imp),0)
							into STRICT    qt_exec_tx_w
							from    pls_conta_proc_v  a
							where   a.cd_guia_referencia          	= cd_guia_referencia_w
							and	a.nr_seq_segurado		= nr_seq_segurado_w
							and     ie_regra_qtde_execucao		= 'S'
							and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
							and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
							and	a.nr_sequencia			!= nr_seq_conta_proc_P
							and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
							and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');
						end if;
					end if;
				else
					if (ie_regra_execucao_w = 'C') then
						select  coalesce(sum(a.qt_procedimento_imp),0)
						into STRICT    qt_exec_tx_w
						from    pls_conta_proc  a
						where   a.nr_seq_conta                  = nr_seq_conta_p
						and     ie_regra_qtde_execucao		= 'S'
						and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
						and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
						and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
						and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
						and	a.nr_sequencia			!= nr_seq_conta_proc_p;
					elsif (ie_regra_execucao_w = 'D') then
						select  coalesce(sum(a.qt_procedimento_imp),0)
						into STRICT    qt_exec_tx_w
						from    pls_conta_proc  a,
							pls_conta       b
						where   b.nr_sequencia                  = a.nr_seq_conta
						and     b.nr_seq_segurado               = nr_seq_segurado_w
						and     ie_regra_qtde_execucao		= 'S'
						and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
						and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
						and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
						and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
						and	a.nr_sequencia			!= nr_seq_conta_proc_p
						and	a.dt_procedimento between trunc(dt_conta_w, 'dd') and trunc(dt_conta_w, 'dd')  + 86399/86400;
					elsif (ie_regra_execucao_w = 'M') then
						select  coalesce(sum(a.qt_procedimento_imp),0)
						into STRICT    qt_exec_tx_w
						from    pls_conta_proc  a,
							pls_conta       b
						where   b.nr_sequencia                  = a.nr_seq_conta
						and     b.nr_seq_segurado               = nr_seq_segurado_w
						and     ie_regra_qtde_execucao		= 'S'
						and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
						and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
						and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
						and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U')
						and	a.nr_sequencia			!= nr_seq_conta_proc_p
						and	trunc(a.dt_procedimento, 'month') between trunc(dt_conta_w, 'month') and trunc(dt_conta_w, 'month');
					elsif (ie_regra_execucao_w = 'A') then
						select  coalesce(sum(a.qt_procedimento_imp),0)
						into STRICT    qt_exec_tx_w
						from    pls_conta_proc_v  a
						where   a.cd_guia_referencia          	= cd_guia_referencia_w
						and	a.nr_seq_segurado		= nr_seq_segurado_w
						and     ie_regra_qtde_execucao		= 'S'
						and     a.nr_seq_regra_qtde_exec        = nr_seq_regra_w
						and	nr_seq_regra_tx_proc		= nr_seq_regra_tx_w
						and	a.nr_sequencia			!= nr_seq_conta_proc_P
						and	((coalesce(a.ie_glosa::text, '') = '' or a.ie_glosa = 'N') or (ie_tipo_conta_w = 'I') or (ie_considerar_glosados_w = 'S'))
						and	a.ie_status 			in ('A', 'C', 'L', 'P', 'S', 'U');					
					end if;
				end if;
				qt_total_proc_tx_w := qt_exec_tx_w + qt_procedimento_w;
				qt_exec_tx_w := (qt_exec_tx_w + 1);
				qt_intervalo_w := (qt_exec_max_w - qt_exec_min_w) + 1;
			
				if      ((qt_loop_w       	>= qt_exec_min_w AND qt_total_proc_w 	<= qt_exec_max_w) or
					(qt_total_proc_tx_w 	<= qt_exec_max_w AND qt_intervalo_w 	>= qt_exec_tx_w )) and ( coalesce(nr_seq_regra_tx_proc_ww::text, '') = '' ) then
					
					tx_procedimento_p       := tx_procedimento_w;
					tx_medico_p             := tx_medico_w;
					tx_custo_operacional_p  := tx_custo_operacional_w;
					tx_material_p           := tx_material_w;
					tx_anestesista_p        := tx_anestesista_w;
					tx_auxiliares_p         := tx_auxiliares_w;
					nr_seq_regra_tx_proc_ww := nr_seq_regra_tx_w;
					ie_via_acesso_p		:= ie_via_acesso_w;

				end if;
			else

				for i in 1..(qt_procedimento_w) loop
					begin

					       if      ((qt_exec_max_w                 >= qt_loop_w) or (coalesce(qt_exec_max_w,0)                    = 0)) then
					
						if (qt_exec_min_w                  <= qt_loop_w  ) and (qt_total_proc_w                >= qt_loop_w ) then										
							
							tx_procedimento_tot_w           := coalesce(tx_procedimento_tot_w,0) + coalesce(tx_procedimento_w,0);
							tx_medico_tot_w                 := coalesce(tx_medico_tot_w,0) + coalesce(tx_medico_w,0);
							tx_custo_operacional_tot_w      := coalesce(tx_custo_operacional_tot_w,0) + coalesce(tx_custo_operacional_w,0);
							tx_material_tot_w               := coalesce(tx_material_tot_w,0) + coalesce(tx_material_w,0);
							tx_anestesista_tot_w            := coalesce(tx_anestesista_tot_w,0) + coalesce(tx_anestesista_w,0);
							tx_auxiliares_tot_w             := coalesce(tx_auxiliares_tot_w,0) + coalesce(tx_auxiliares_w,0);
							qt_loop_w := qt_loop_w + 1;
							
						end if;
					end if;
					end;
				end loop;
			end if;
		end if;
		end;
	end loop;
	close C03;

	if (coalesce(nr_seq_regra_tx_w,0) > 0) and (ie_abrir_execucao_w    <> 'S') then
		tx_procedimento_p       := dividir(tx_procedimento_tot_w,qt_procedimento_w);
		tx_medico_p             := dividir(tx_medico_tot_w,qt_procedimento_w);
		tx_custo_operacional_p  := dividir(tx_custo_operacional_tot_w,qt_procedimento_w);
		tx_material_p           := dividir(tx_material_tot_w,qt_procedimento_w);
		tx_anestesista_p        := dividir(tx_anestesista_tot_w,qt_procedimento_w);
		tx_auxiliares_p         := dividir(tx_auxiliares_tot_w,qt_procedimento_w);

	end if;
	
	/*Conf OS648009, necessário verificar se deve atualizar taxa somente quando a mesma for menor que a taxa já presente no item*/
	
	
	begin	
		select 	coalesce(ie_alterar_se_maior,'N')
		into STRICT	ie_alterar_se_maior_w
		from 	pls_regra_preco_qtde_proc a,
			pls_regra_preco_tx_proc b
		where 	a.nr_sequencia = b.nr_seq_regra
		and	b.nr_sequencia = nr_seq_regra_tx_w;	
	exception
	when others then
		ie_alterar_se_maior_w := 'N';	
	end;	
	
	if	(ie_alterar_se_maior_w = 'S' AND tx_procedimento_p > tx_item_orig_w)then
		tx_procedimento_p := tx_item_orig_w;
		
		if (coalesce(ie_via_acesso_orig_w,'U') != 'U') then
			ie_via_acesso_p := ie_via_acesso_orig_w;
		end if;
	end if;	
	
        update  pls_conta_proc
        set     ie_regra_qtde_execucao  = 'S',
		nr_seq_regra_tx_proc	= nr_seq_regra_tx_proc_ww
        where   nr_sequencia = nr_seq_conta_proc_p;
	
	nr_seq_regra_tx_proc_ww := null;
	
	<<final>>
	null;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_tx_qtde_proc_valor ( nr_seq_conta_proc_p bigint, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, tx_procedimento_p INOUT bigint, tx_medico_p INOUT bigint, tx_custo_operacional_p INOUT bigint, tx_material_p INOUT bigint, tx_anestesista_p INOUT bigint, tx_auxiliares_p INOUT bigint, ie_via_acesso_p INOUT pls_conta_proc.ie_via_acesso%type) FROM PUBLIC;

