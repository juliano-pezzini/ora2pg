-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_opme_prescr_cirurgia ( nr_seq_agenda_p bigint, ie_origem_inf_p text, nm_usuario_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE



cd_material_w			integer;
qt_material_w			double precision;
cd_unidade_medida_w		varchar(30);
nr_seq_prescr_material_w		integer;
nr_agrupamento_w			double precision;
hr_prim_horario_w			varchar(05);
ie_via_aplicacao_w			varchar(05);
cd_material_opcao_w		integer;
ds_materiais_w			varchar(255);
cd_fornecedor_w			varchar(14);
ie_tipo_material_w			varchar(3);
cd_estabelecimento_w		smallint;
cd_intervalo_w			varchar(7);
cd_funcao_w			bigint;
ie_gera_opme_w			varchar(01);
nr_atendimento_w			bigint;


c01 CURSOR FOR
	SELECT	a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
		b.ie_via_aplicacao,
		b.ie_tipo_material,
		a.cd_cgc
	from	material b,
		agenda_pac_opme a
	where	a.cd_material			=	b.cd_material
	and 	a.ie_origem_inf = 'I'
	and	a.ie_autorizado			=	'A'
	and	a.nr_seq_agenda			=	nr_seq_agenda_p
	and	((ie_gera_opme_w = 'X') or (ie_gera_opme_w = 'I' and a.ie_integracao = 'S') or (ie_gera_opme_w = 'E' and coalesce(a.ie_integracao, 'N') = 'N'));



BEGIN

cd_funcao_w := OBTER_FUNCAO_ATIVA;

select	cd_estabelecimento,
	nr_atendimento
into STRICT	cd_estabelecimento_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao	=	nr_prescricao_p;


select 	coalesce(Obter_Valor_Param_Usuario(871, 171, Obter_Perfil_ativo, nm_usuario_p, cd_estabelecimento_p), 'S')
into STRICT	ie_gera_opme_w
;


select	coalesce(max(cd_intervalo),1)
into STRICT	cd_intervalo_w
from	intervalo_prescricao
where	ie_agora = 'S';


open c01;
loop
fetch c01 into
	cd_material_w,
	qt_material_w,
	cd_unidade_medida_w,
	ie_via_aplicacao_w,
	ie_tipo_material_w,
	cd_fornecedor_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_prescr_material_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(nr_agrupamento),0) + 1
	into STRICT	nr_agrupamento_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	select	to_char(dt_primeiro_horario,'HH24:MM')
	into STRICT	hr_prim_horario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	begin
	insert into prescr_material(nr_prescricao,
			nr_sequencia,
			ie_origem_inf,
			cd_material,
			cd_unidade_medida,
			qt_dose,
			qt_unitaria,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			ds_horarios,
		 	ds_observacao,
		 	ie_via_aplicacao,
	 	 	nr_agrupamento,
		 	cd_motivo_baixa,
		 	dt_baixa,
		 	ie_utiliza_kit,
		 	cd_unidade_medida_dose,
			qt_conversao_dose,
		 	ie_urgencia,
		 	nr_ocorrencia,
		 	qt_total_dispensar,
		 	cd_fornec_consignado,
		 	nr_sequencia_solucao,
		 	nr_sequencia_proc,
		 	qt_solucao,
		 	hr_dose_especial,
		 	qt_dose_especial,
		 	ds_dose_diferenciada,
		 	ie_medicacao_paciente,
		 	nr_sequencia_diluicao,
		 	hr_prim_horario,
		 	nr_dia_util,
		 	nr_sequencia_dieta,
		 	ie_agrupador,
		 	dt_emissao_setor_atend,
		 	ie_suspenso,
		 	ds_justificativa,
		 	qt_dias_solicitado,
		 	qt_dias_liberado,
		 	nm_usuario_liberacao,
		 	dt_liberacao,
		 	ie_se_necessario,
		 	qt_min_aplicacao,
		 	nr_seq_lote_fornec,
		 	ie_status_cirurgia,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			cd_kit_material,
			ie_recons_diluente_fixo,
			nr_seq_kit_estoque,
			cd_convenio,
			cd_categoria,
			ie_sem_aprazamento,
			nr_doc_interno,
			cd_local_estoque)
		values (  nr_prescricao_p,
		 	nr_seq_prescr_material_w,
		 	ie_origem_inf_p,
		 	cd_material_w,
		 	cd_unidade_medida_w,
		 	qt_material_w,
		 	qt_material_w,
		 	qt_material_w,
		 	clock_timestamp(),
		 	nm_usuario_p,
		 	cd_intervalo_w,
		 	null,
		 	ds_materiais_w,
		 	ie_via_aplicacao_w,
		 	nr_agrupamento_w,
			0,
		 	null,
		 	'N',
		 	null,
		 	null,
		 	'N',
		 	1,
		 	qt_material_w,
		 	cd_fornecedor_w,
		 	null,
		 	null,
		 	null,
		 	null,
			null,
		 	null,
		 	'N',
		 	null,
		 	hr_prim_horario_w,
		 	null,
		 	null,
		 	ie_tipo_material_w,
		 	null,
		 	'N',
		 	null,
		 	null,
		 	null,
		 	null,
		 	null,
		 	'',
		 	null,
		 	null,
		 	null,
			'N',
			'N',
			'N',
			'N',
			null,
			'N',
			null,
			null,
			null,
			'N',
			null,
			null);
		commit;
	end;
	end;
end loop;
close c01;

commit;

CALL gerar_opme_materias_especiais(nr_seq_agenda_p, nm_usuario_p, cd_estabelecimento_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_opme_prescr_cirurgia ( nr_seq_agenda_p bigint, ie_origem_inf_p text, nm_usuario_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

