-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_preco_pacote_cta ( cd_estabelecimento_p bigint, dados_conta_proc_p pls_cta_valorizacao_pck.dados_conta_proc, dados_prestador_exec_p pls_cta_valorizacao_pck.dados_prestador_exec, nr_seq_tipo_acomod_p bigint, dt_pacote_p timestamp, ie_internado_p text, nr_seq_plano_p text, nr_contrato_p bigint, nr_seq_congenere_p bigint, nm_usuario_p text, ie_origem_conta_p text, ie_tipo_intercambio_p text, nr_seq_pacote_p INOUT bigint, nr_seq_regra_pacote_p INOUT bigint, vl_pacote_p INOUT bigint, vl_medico_p INOUT bigint, vl_anestesista_p INOUT bigint, vl_auxiliares_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_materiais_p INOUT bigint, nr_seq_intercambio_p bigint, nr_seq_segurado_p bigint, ie_conta_medica_p text, nr_seq_prest_inter_p pls_conta_v.nr_seq_prest_inter%type default null, ie_tipo_tabela_p bigint default 1, ie_faturamento_p text DEFAULT NULL, nr_seq_conrato_p pls_segurado.nr_seq_contrato%type DEFAULT NULL) AS $body$
DECLARE


nr_seq_categoria_w		bigint;
dt_pacote_w			timestamp;
ie_preco_w			varchar(10);
ie_tipo_contratacao_w		varchar(10);
ie_regulamentacao_w		varchar(10);
ie_excecao_w			varchar(1);
qt_regra_w			bigint;
nr_seq_regra_pacote_w		bigint;
ie_grupo_contrato_w		varchar(2);
ie_grupo_produto_w		varchar(2);
ie_restringe_estab_w		varchar(2);
ie_tipo_segurado_w		varchar(255);
ie_tipo_repasse_w		varchar(255)	:= 'X';
nr_seq_congenere_w  		pls_segurado.nr_seq_congenere%type;
ie_grupo_operadora_w    	varchar(1);
ie_acomodacao_valida_w		varchar(1);
nr_seq_tipo_acomod_benef_w	pls_segurado.nr_seq_tipo_acomodacao%type;
ie_tipo_acomodacao_w		pls_tipo_acomodacao.ie_tipo_acomodacao%type;
ie_acomodacao_plano_w		pls_plano.ie_acomodacao%type;
ie_tipo_acomod_cta_w		pls_tipo_acomodacao.ie_tipo_acomodacao%type;
C01 CURSOR FOR	
	SELECT	b.nr_sequencia 	nr_seq_pacote,
		a.nr_sequencia	nr_seq_regra_pacote,
		coalesce(a.vl_pacote,0) 	vl_pacote,
		coalesce(a.vl_medico,0) 	vl_medico,
		coalesce(a.vl_anestesista,0) vl_anestesista,
		coalesce(a.vl_auxiliares,0) 	vl_auxiliares,
		coalesce(a.vl_custo_operacional,0) 	vl_custo_operacional,
		coalesce(a.vl_materiais,0) 	vl_materiais,
		a.nr_seq_grupo_contrato,
		a.nr_seq_grupo_produto,
		a.nr_seq_grupo_operadora,
		coalesce(a.ie_acomodacao,'N') ie_acomodacao
	from	pls_pacote			b,
		pls_pacote_tipo_acomodacao	a
	where	a.nr_seq_pacote		= b.nr_sequencia
	and	a.ie_situacao 		= 'A'
	and	b.cd_procedimento	= dados_conta_proc_p.cd_procedimento
	and	b.ie_origem_proced	= dados_conta_proc_p.ie_origem_proced
	and	((ie_restringe_estab_w	= 'N') or (coalesce(ie_restringe_estab_w::text, '') = '')
	or	(ie_restringe_estab_w	= 'S' AND a.cd_estabelecimento = cd_estabelecimento_p))
	and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '')  or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomod_p))
	and	((coalesce(a.nr_seq_categoria_acomod::text, '') = '')  or (a.nr_seq_categoria_acomod = nr_seq_categoria_w))
	and	((coalesce(a.ie_preco::text, '') = '') or (a.ie_preco = ie_preco_w)) 
	and	((coalesce(a.ie_tipo_contratacao::text, '') = '') or (a.ie_tipo_contratacao = ie_tipo_contratacao_w))
	and	((coalesce(a.ie_internado::text, '') = '') or (a.ie_internado = 'N') or (a.ie_internado	= ie_internado_p))
	and	((coalesce(a.ie_tipo_intercambio::text, '') = '') or (a.ie_tipo_intercambio = 'A') or (a.ie_tipo_intercambio = ie_tipo_intercambio_p))
	and	((coalesce(a.nr_contrato::text, '') = '') or (a.nr_contrato  = nr_contrato_p))
	and	((coalesce(a.nr_seq_plano::text, '') = '') or (a.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(a.nr_seq_congenere::text, '') = '') or (a.nr_seq_congenere = nr_seq_congenere_p))
	and	((coalesce(a.nr_seq_intercambio::text, '') = '') or (a.nr_seq_intercambio = nr_seq_intercambio_p))
	and	((coalesce(a.ie_regulamentacao::text, '') = '') or (a.ie_regulamentacao =  ie_regulamentacao_w)) 
	and	((coalesce(a.ie_origem_conta::text, '') = '') or (a.ie_origem_conta = ie_origem_conta_p))
	and	((coalesce(a.ie_tipo_repasse::text, '') = '') or (a.ie_tipo_repasse	= ie_tipo_repasse_w))
	and	((coalesce(a.ie_tipo_segurado::text, '') = '') or (a.ie_tipo_segurado = ie_tipo_segurado_w))
	and	((coalesce(a.ie_conta_medica::text, '') = '') or (a.ie_conta_medica	= ie_conta_medica_p) or (a.ie_conta_medica = 'S'))
	and	((coalesce(a.nr_seq_prest_inter::text, '') = '') or (nr_seq_prest_inter_p = a.nr_seq_prest_inter))
	and	((((coalesce(a.ie_tipo_tabela::text, '') = '') or (a.ie_tipo_tabela = 1)) and (ie_tipo_tabela_p	= '1')) or (a.ie_tipo_tabela = ie_tipo_tabela_p))
	and	((coalesce(a.nr_seq_prestador::text, '') = '') or (a.nr_seq_prestador = dados_prestador_exec_p.nr_seq_prestador))
	and	((coalesce(a.cd_prestador::text, '') = '') or (a.cd_prestador = dados_prestador_exec_p.cd_prestador))
	and	(coalesce(a.nr_seq_grupo_prestador::text, '') = '' 	or
		exists	(SELECT	1
			from	pls_preco_prestador x
			where	x.nr_seq_grupo	= a.nr_seq_grupo_prestador
			and	((coalesce(x.nr_seq_prestador::text, '') = '')	  or (x.nr_seq_prestador	= dados_prestador_exec_p.nr_seq_prestador))
			and	((coalesce(x.nr_seq_classificacao::text, '') = '') or (x.nr_seq_classificacao	= dados_prestador_exec_p.nr_seq_classificacao))
			)
		)
	and	trunc(dt_pacote_w) 	between a.dt_inicio_vigencia and fim_dia(a.dt_fim_vigencia_ref)
	and	(((a.ie_abrir_pacote_fat = 'S' or coalesce(a.ie_abrir_itens_intercambio,'N') = 'S') and (ie_faturamento_p	= 'S')) or (((coalesce(a.ie_abrir_pacote_fat::text, '') = '') or (a.ie_abrir_pacote_fat = 'N')) and (ie_faturamento_p = 'N')))
	order by coalesce(a.nr_seq_prestador,0),
		coalesce(a.cd_prestador,'0'),
		coalesce(a.cd_procedimento,0),
		coalesce(a.nr_seq_plano,0),        
		coalesce(a.nr_seq_grupo_produto,0),
		coalesce(a.ie_tipo_intercambio,'A'),
		coalesce(a.nr_seq_grupo_prestador,0), 
		coalesce(a.nr_seq_grupo_contrato,0),
		coalesce(a.nr_seq_categoria_acomod,0),
		coalesce(a.nr_seq_tipo_acomodacao,0),
		coalesce(a.nr_contrato,0),         
		coalesce(a.ie_tipo_contratacao,'Z') desc,  
		coalesce(a.ie_tipo_segurado,'A'),
		coalesce(a.ie_preco,'0'),          
		coalesce(a.ie_internado,'N'),
		coalesce(a.nr_seq_intercambio,0),  
		coalesce(a.nr_seq_congenere,0),
		a.dt_inicio_vigencia,
		coalesce(a.ie_acomodacao,'N');
		
BEGIN
dt_pacote_w	:= coalesce(dt_pacote_p, clock_timestamp());

select	max(ie_tipo_segurado),
	max(nr_seq_congenere)
into STRICT	ie_tipo_segurado_w,
	nr_seq_congenere_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

select	max(ie_tipo_contratacao),
	max(ie_regulamentacao),
	max(ie_acomodacao),
	max(ie_preco)
into STRICT	ie_tipo_contratacao_w,
	ie_regulamentacao_w,
	ie_acomodacao_plano_w,
	ie_preco_w
from	pls_plano
where	nr_sequencia	= nr_seq_plano_p;

select	max(ie_tipo_acomodacao)
into STRICT	ie_tipo_acomod_cta_w
from	pls_tipo_acomodacao a
where 	nr_sequencia = nr_seq_tipo_acomod_p;
select	max(nr_seq_categoria)
into STRICT	nr_seq_categoria_w
from	pls_regra_categoria
where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomod_p;

ie_restringe_estab_w	:= pls_obter_se_controle_estab('GP');


for r_c01_w in C01() loop
	begin
				
	ie_acomodacao_valida_w := 'S';
	if (r_c01_w.ie_acomodacao <> 'N') then
			
		if (r_c01_w.ie_acomodacao <> ie_acomodacao_plano_w or coalesce(ie_acomodacao_plano_w::text, '') = '') and (r_c01_w.ie_acomodacao <> ie_tipo_acomod_cta_w or coalesce(ie_tipo_acomod_cta_w::text, '') = '')then
			ie_acomodacao_valida_w := 'N';
		end if;	
	end if;
	
	if (ie_acomodacao_valida_w = 'S') then
	
		ie_excecao_w		:= 'N';
		ie_grupo_produto_w	:= 'S';
		ie_grupo_contrato_w	:= 'S';
		ie_grupo_operadora_w    := 'S';
		
		if (r_c01_w.nr_seq_grupo_contrato IS NOT NULL AND r_c01_w.nr_seq_grupo_contrato::text <> '') then
			if	((coalesce(nr_seq_conrato_p,0)	> 0) or (coalesce(nr_seq_intercambio_p,0) > 0)) then
				ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(r_c01_w.nr_seq_grupo_contrato, nr_seq_conrato_p, nr_seq_intercambio_p);
			else
				ie_grupo_contrato_w	:= 'N';
			end if;
		end if;
	
		/* Grupo de produtos */

		if (r_c01_w.nr_seq_grupo_produto IS NOT NULL AND r_c01_w.nr_seq_grupo_produto::text <> '') then
			ie_grupo_produto_w	:= pls_se_grupo_preco_produto(r_c01_w.nr_seq_grupo_produto, nr_seq_plano_p);
		end if;
	
		if (r_c01_w.nr_seq_grupo_operadora IS NOT NULL AND r_c01_w.nr_seq_grupo_operadora::text <> '') then
			ie_grupo_operadora_w := pls_se_grupo_preco_operadora(r_c01_w.nr_seq_grupo_operadora,coalesce(nr_seq_congenere_w,nr_seq_congenere_p));
		end if;
		
		if (coalesce(ie_grupo_produto_w,'N') = 'S') and (coalesce(ie_grupo_contrato_w,'N') = 'S') and (coalesce(ie_grupo_operadora_w,'N') = 'S') then	
			
			select 	count(1)	
			into STRICT 	qt_regra_w
			from	pls_pacote_preco_excecao
			where	nr_seq_regra_preco	= r_c01_w.nr_seq_regra_pacote;

			if (qt_regra_w > 0)	then
				ie_excecao_w := pls_excecao_preco_pacote_cta(r_c01_w.nr_seq_regra_pacote, nr_seq_congenere_p, '', nr_seq_intercambio_p, dados_prestador_exec_p, ie_excecao_w, nr_seq_congenere_w);
			end if;
		
			if (ie_excecao_w = 'N') then
				nr_seq_regra_pacote_p	:= r_c01_w.nr_seq_regra_pacote;
				nr_seq_pacote_p		:= r_c01_w.nr_seq_pacote;
				vl_pacote_p		:= r_c01_w.vl_pacote;
				vl_medico_p		:= r_c01_w.vl_medico;
				vl_anestesista_p	:= r_c01_w.vl_anestesista;
				vl_auxiliares_p		:= r_c01_w.vl_auxiliares;
				vl_custo_operacional_p	:= r_c01_w.vl_custo_operacional;
				vl_materiais_p		:= r_c01_w.vl_materiais;
			end if;
		end if;	
	
	end if;
	end;
		
	commit;
	
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_preco_pacote_cta ( cd_estabelecimento_p bigint, dados_conta_proc_p pls_cta_valorizacao_pck.dados_conta_proc, dados_prestador_exec_p pls_cta_valorizacao_pck.dados_prestador_exec, nr_seq_tipo_acomod_p bigint, dt_pacote_p timestamp, ie_internado_p text, nr_seq_plano_p text, nr_contrato_p bigint, nr_seq_congenere_p bigint, nm_usuario_p text, ie_origem_conta_p text, ie_tipo_intercambio_p text, nr_seq_pacote_p INOUT bigint, nr_seq_regra_pacote_p INOUT bigint, vl_pacote_p INOUT bigint, vl_medico_p INOUT bigint, vl_anestesista_p INOUT bigint, vl_auxiliares_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_materiais_p INOUT bigint, nr_seq_intercambio_p bigint, nr_seq_segurado_p bigint, ie_conta_medica_p text, nr_seq_prest_inter_p pls_conta_v.nr_seq_prest_inter%type default null, ie_tipo_tabela_p bigint default 1, ie_faturamento_p text DEFAULT NULL, nr_seq_conrato_p pls_segurado.nr_seq_contrato%type DEFAULT NULL) FROM PUBLIC;

