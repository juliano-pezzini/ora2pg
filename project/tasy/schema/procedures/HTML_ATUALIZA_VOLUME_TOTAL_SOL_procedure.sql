-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_atualiza_volume_total_sol ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, nm_usuario_p text) AS $body$
DECLARE

							
							
nr_seq_solucao_w		prescr_solucao.nr_seq_solucao%type;
ie_tipo_dosagem_w		prescr_solucao.ie_tipo_dosagem%type;
qt_tempo_aplicacao_w	prescr_solucao.qt_tempo_aplicacao%type;
qt_solucao_total_w		prescr_solucao.qt_solucao_total%type;
qt_dosagem_w			prescr_solucao.qt_dosagem%type;
nr_etapas_w				prescr_solucao.nr_etapas%type;
qt_hora_fase_w			prescr_solucao.qt_hora_fase%type;
qt_retorno_w			prescr_solucao.qt_solucao_total%type;
qt_dose_ataque_w		prescr_solucao.qt_dose_ataque%type;
qt_volume_final_w		prescr_solucao.qt_volume_final%type;
qt_volume_solucao_w		prescr_solucao.qt_solucao_total%type;
nr_etapas_solucao_w		prescr_solucao.nr_etapas%type;
qt_tempo_total_w		prescr_solucao.qt_tempo_aplicacao%type;

ie_vel_conforme_etapa_w	 	varchar(1);

qt_campo_w				smallint;
cd_estabelecimento_w	smallint;
							

BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_vel_conforme_etapa_w := obter_param_usuario(924, 855, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_vel_conforme_etapa_w);

select	max(nr_sequencia_solucao)
into STRICT	nr_seq_solucao_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N'
and		nr_seq_mat_cpoe = nr_seq_cpoe_p;

select	upper(max(ie_tipo_dosagem)),
		max(qt_tempo_aplicacao),
		max(qt_solucao_total),
		max(qt_dosagem),
		max(nr_etapas),
		max(qt_hora_fase),
		coalesce(max(qt_dose_ataque),0)
into STRICT	ie_tipo_dosagem_w,
		qt_tempo_aplicacao_w,
		qt_solucao_total_w,
		qt_dosagem_w,
		nr_etapas_w,
		qt_hora_fase_w,
		qt_dose_ataque_w
from 	prescr_solucao
where	nr_prescricao = nr_prescricao_p
and		coalesce(ie_suspenso,'N') = 'N'
and		nr_seq_solucao = nr_seq_solucao_w;
		
qt_campo_w := 0;
if (coalesce(qt_dosagem_w::text, '') = '') and (qt_solucao_total_w IS NOT NULL AND qt_solucao_total_w::text <> '') then
	qt_campo_w := 1;
elsif (qt_dosagem_w IS NOT NULL AND qt_dosagem_w::text <> '') and (coalesce(qt_solucao_total_w::text, '') = '') then
	qt_campo_w := 2;
end if;

if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (ie_tipo_dosagem_w  <> 'ACM') and
	((coalesce(qt_dosagem_w::text, '') = '') or (coalesce(qt_solucao_total_w::text, '') = '') or (qt_solucao_total_w = 0))	then
	qt_retorno_w := calcular_volume_total_solucao(
		ie_tipo_dosagem_w, qt_tempo_aplicacao_w, qt_solucao_total_w, qt_dosagem_w, nr_prescricao_p, nr_seq_solucao_w, qt_campo_w, qt_retorno_w, 'N', nr_etapas_w, ie_vel_conforme_etapa_w, qt_hora_fase_w);

	qt_volume_final_w := (qt_retorno_w - qt_dose_ataque_w);
									
	update	prescr_solucao
	set		qt_solucao_total	= qt_retorno_w,
			qt_volume_final		= qt_volume_final_w,
			nm_usuario 			= nm_usuario_p,
			dt_atualizacao 		= clock_timestamp()
	where	nr_prescricao 		= nr_prescricao_p
	and		coalesce(ie_suspenso,'N') = 'N'
	and		nr_seq_solucao 		= nr_seq_solucao_w;
else
	SELECT * FROM calcular_valores_solucao(
		nr_prescricao_p, nr_seq_solucao_w, qt_dosagem_w, ie_tipo_dosagem_w, 'S', 'N', 'N', 'N', nm_usuario_p, qt_tempo_aplicacao_w, qt_volume_solucao_w, nr_etapas_solucao_w, qt_tempo_total_w, 'N') INTO STRICT qt_volume_solucao_w, nr_etapas_solucao_w, qt_tempo_total_w;

	if (qt_volume_solucao_w IS NOT NULL AND qt_volume_solucao_w::text <> '') then
		qt_volume_final_w := (qt_volume_solucao_w - qt_dose_ataque_w);
	
		update  prescr_solucao
		set		qt_solucao_total 	= qt_volume_solucao_w,
				qt_volume_final		= qt_volume_final_w,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 		= clock_timestamp()
		where	nr_prescricao 		= nr_prescricao_p
		and 	nr_seq_solucao 		= nr_seq_solucao_w;

	elsif (nr_etapas_solucao_w IS NOT NULL AND nr_etapas_solucao_w::text <> '') then
		update  prescr_solucao
		set		nr_etapas 	 	= nr_etapas_solucao_w,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 		= clock_timestamp(),
				cd_intervalo 	= (SELECT max(cd_intervalo) from intervalo_prescricao
									where nr_etapas = nr_etapas_solucao_w
									and   ie_situacao = 'A'
									and   Obter_se_intervalo(cd_intervalo, 15) = 'S'
									and   ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w)))
		where	nr_prescricao 	= nr_prescricao_p
		and 	nr_seq_solucao 	= nr_seq_solucao_w;
	end if;

	if (qt_tempo_total_w IS NOT NULL AND qt_tempo_total_w::text <> '') then
		update  prescr_solucao
		set		qt_tempo_aplicacao 	= qt_tempo_total_w,
				nm_usuario 			= nm_usuario_p,
				dt_atualizacao 		= clock_timestamp()
		where	nr_prescricao 		= nr_prescricao_p
		and 	nr_seq_solucao 		= nr_seq_solucao_w;
	end if;

end if;

commit;
								
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_atualiza_volume_total_sol ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, nm_usuario_p text) FROM PUBLIC;

