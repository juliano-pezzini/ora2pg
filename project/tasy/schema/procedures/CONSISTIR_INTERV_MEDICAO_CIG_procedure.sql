-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_interv_medicao_cig (nr_atendimento_p bigint, dt_medicao_p timestamp) AS $body$
DECLARE


nr_seq_cig_ant_w	bigint;
dt_medicao_w		timestamp;
dt_suspensao_w		timestamp;
qt_hora_intervalo_w	double precision;
nr_seq_horario_w	bigint;
nr_seq_proc_w		bigint;
nr_prescricao_w		bigint;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (dt_medicao_p IS NOT NULL AND dt_medicao_p::text <> '') then
	/* obter medicao anterior */

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_cig_ant_w
	from	atendimento_cig a,
			atend_glicemia b
	where	a.nr_seq_glicemia = b.nr_sequencia
	and		a.nr_atendimento = nr_atendimento_p
	and		a.ie_status_cig not in ('T', 'V', 'S')
	and		b.ie_status_glic <> 'S';

	/* validar intervalo medicao */

	if (nr_seq_cig_ant_w > 0) then
		/* obter dados medicao */

		select	dt_controle,
			nr_seq_horario
		into STRICT	dt_medicao_w,
			nr_seq_horario_w
		from	atendimento_cig
		where	nr_sequencia = nr_seq_cig_ant_w;
		
		select	max(nr_seq_procedimento),
			max(nr_prescricao)
		into STRICT	nr_seq_proc_w,
			nr_prescricao_w
		from	prescr_proc_hor
		where	nr_sequencia	= nr_seq_horario_w;
		
		select	max(dt_suspensao)
		into STRICT	dt_suspensao_w
		from	prescr_procedimento
		where	nr_prescricao	= nr_prescricao_w
		and	nr_sequencia	= nr_seq_proc_w;

		/* obter diferenca medicoes */

		select	trunc(((dt_medicao_p - dt_medicao_w) * 24),1)
		into STRICT	qt_hora_intervalo_w
		;

		/* consistir diferenca */

		if (qt_hora_intervalo_w > 4) and (coalesce(dt_suspensao_w::text, '') = '') then
			---O CIG esteve ha mais de quatro horas sem registro de medicoes de glicemia.O calculo de variacao horaria, conforme o protocolo, e limitado em ate quatro horas.E recomendavel terminar este CIG e dar inicio a um novo!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(261426);
			
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_interv_medicao_cig (nr_atendimento_p bigint, dt_medicao_p timestamp) FROM PUBLIC;

