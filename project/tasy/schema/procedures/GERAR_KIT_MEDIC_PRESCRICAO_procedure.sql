-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_medic_prescricao (( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_diluicao_p text default 'N', ie_manual_p text default 'N', ie_subst_medicamento_p text default 'N') IS cd_tipo_item_w smallint) RETURNS varchar AS $body$
DECLARE

		ie_alterou_horario_w varchar(1);
	
BEGIN
		ie_alterou_horario_w := 'N';

		if (ie_agrupador_ww in (1, 4)) then
			select 	coalesce(max(a.ie_alterou_horario), 'N')
			into STRICT 	ie_alterou_horario_w
			from 	cpoe_material a
			where 	a.nr_sequencia in ( SELECT max(x.nr_seq_mat_cpoe)
										  from prescr_material x
										  where x.nr_prescricao = nr_prescricao_p
										  and x.nr_sequencia = nr_seq_mat_med_w);
		end if;

		return ie_alterou_horario_w;
	end;

	function obterSeHorarioContinuoEnteral return varchar2 is
		ds_retorno_w varchar2(1 char);
	begin
		ds_retorno_w := 'N';
		
		if (param_CPOE_24_w = 'S') then
			select 	max(ie_continuo),
					max(dt_fim),
					max(dt_inicio_pausa),
					max(coalesce(CASE WHEN coalesce(qt_tempo_aplic,'__:__')='__:__' THEN null  ELSE dividir(coalesce(obter_minutos_hora(qt_tempo_aplic),0),60) END ,24))
			into STRICT 	ie_continuo_w,
					dt_fim_w,
					hr_inicio_pausa_w,
					qt_tempo_aplic_w
			from 	cpoe_dieta
			where 	nr_sequencia in ( SELECT max(nr_seq_dieta_cpoe)
									  from prescr_material a
									  where a.nr_prescricao = nr_prescricao_p
									  and a.nr_sequencia = nr_seq_mat_med_w);

			select	max(qt_operacao),
					max(ie_operacao)
			into STRICT 	qt_operacao_w,
					ie_operacao_w
			from 	intervalo_prescricao
			where 	cd_intervalo = cd_intervalo_kit_w;

			if ((ie_continuo_w = 'C') and (nr_ocorrencia_w > 1) and (ie_agrupador_ww = 8)) or
			   ((ie_operacao_w = 'H' and qt_operacao_w = 24) or (ie_operacao_w = 'X' and qt_operacao_w = 1)) then
				ds_retorno_w := 'S';
			end if;
		end if;
		
		return ds_retorno_w;
	end;

	procedure calcularHorarioContinuoEnteral is
	begin
		SELECT * FROM CPOE_Calcula_horarios_enteral(nm_usuario_p, trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_primeiro_horario_w, hr_prim_horario_kit_w), 'mi'), 'S', nr_ocorrencia_w, cd_intervalo_kit_w, qt_tempo_aplic_w, qt_tempo_aplic_w, to_char(hr_inicio_pausa_w, 'hh24:mi'), 'N', null, dt_fim_w, 'N', nr_atendimento_w, cd_estabelecimento_p, obter_perfil_ativo) INTO STRICT nr_ocorrencia_w, ds_horarios_kit_w;
	end;

	procedure calcularHorarioPrescricao is
	begin
		SELECT * FROM calcular_horario_prescricao(nr_prescricao_p, cd_intervalo_kit_w, dt_primeiro_horario_w, trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_primeiro_horario_w, hr_prim_horario_kit_w), 'mi'), nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww, 'N', null) INTO STRICT nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww;

		ds_horarios_kit_w := ds_horarios_kit_w || ds_horarios_kit_ww;
	end;

BEGIN

select 	coalesce(max('S'),'N')
into STRICT	ie_prescr_quimio_w
from	prescr_medica
where 	nr_prescricao = nr_Prescricao_p
and 	(nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '');

select	coalesce(max(IE_COBRA_KIT_PRESCR), 'N')
into STRICT	ie_utiliza_cobra_kit_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;

ds_nao_gera_kit_w				:= obter_valor_param_usuario(924, 149, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p); --Ivan em 10/05/2007 OS54814
cd_motivo_baixa_ww				:= obter_valor_param_usuario(924, 194, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_prescr_mat_sem_lib_w			:= obter_valor_param_usuario(924, 530, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_apresenta_invervalo_sol_w	:= obter_valor_param_usuario(924, 590, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_check_sn_w					:= obter_valor_param_usuario(924, 650, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_gerar_kit_diluicao_w			:= obter_valor_param_usuario(924, 702, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_check_tipo_interv_w			:= obter_valor_param_usuario(924, 809, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
ie_param191_w					:= obter_valor_param_usuario(1113, 191, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);
param_CPOE_24_w					:= obter_valor_param_usuario(2314, 24, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_p);

ie_info_rastre_prescr_w := 'N';

select	max(nr_agrupamento)
into STRICT	nr_agrup_prescr_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(cd_setor_atendimento), 0),
	coalesce(max(obter_convenio_atendimento(nr_atendimento)),0),
	max(obter_tipo_atendimento(nr_atendimento)),
	max(dt_liberacao_farmacia),
	coalesce(max(ie_gerou_kit),'N'),
	max(cd_recem_nato),
	coalesce(max(ie_recem_nato),'N'),
	coalesce(max(ie_recem_nato), 'A'),
	max(qt_peso),
	max(cd_medico),
	max(cd_funcao_origem)
into STRICT	cd_setor_atendimento_w,
	cd_convenio_w,
	ie_tipo_atendimento_w,
	dt_liberacao_farmacia_w,
	ie_gerou_kit_w,
	cd_recem_nato_w,
	ie_recem_nato_w,
	ie_recem_nato_ww,
	qt_peso_w,
	cd_medico_w,
	cd_funcao_origem_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(ie_gerar_kit),'S'),
		max(nr_seq_agrupamento)
into STRICT	ie_gerar_kit_setor_w,
		nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;

if (coalesce(nr_seq_item_p,0)	> 0) then
	select	max(dt_lib_farmacia)
	into STRICT	dt_liberacao_farmacia_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
end if;

/* Rafael em 08/11/2007 OS73502 x kit */

select	max(cd_estabelecimento),
	max(dt_prescricao),
	max(dt_primeiro_horario),
	max(nr_horas_validade),
	coalesce(max(obter_idade_pf(cd_pessoa_fisica,clock_timestamp(),'A')),0),
	max(substr(obter_sexo_pf(cd_pessoa_fisica, 'C'),1,1)),
	max(nr_atendimento)
into STRICT	cd_estabelecimento_w,
	dt_prescricao_w,
	dt_primeiro_horario_w,
	nr_horas_validade_w,
	qt_idade_paciente_w,
	ie_sexo_paciente_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_gerar_kit),'N')
into STRICT	ie_gerar_todos_kits_w
from	parametro_atendimento
where 	cd_estabelecimento = cd_estabelecimento_p;

ie_info_rastre_prescr_w := obter_se_info_rastre_prescr('K', nm_usuario_p, obter_perfil_ativo, cd_estabelecimento_w);

if (ie_info_rastre_prescr_w = 'S') then
	ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 614 linha - KIT = nr_prescricao_p: ' || nr_prescricao_p || pls_util_pck.enter_w ||
		' - nr_seq_item_p: ' || nr_seq_item_p || pls_util_pck.enter_w ||
		' - ds_nao_gera_kit_w: ' || ds_nao_gera_kit_w || pls_util_pck.enter_w ||
		' - ie_param191_w: ' || ie_param191_w || pls_util_pck.enter_w ||
		' - nr_agrup_prescr_w: ' || nr_agrup_prescr_w || pls_util_pck.enter_w ||
		' - ie_subst_medicamento_p: ' || ie_subst_medicamento_p || pls_util_pck.enter_w ||
		' - ie_gerar_todos_kits_w: ' || ie_gerar_todos_kits_w, 1, 2000);
	CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
end if;
OPEN C01;
LOOP
FETCH C01 into
	cd_tipo_item_w,
	nr_agrupamento_w,
	ie_urgencia_w,
	cd_material_w,
	nr_ocorrencia_w,
	cd_intervalo_w,
	ie_se_necessario_w,
	qt_unitaria_w,
	qt_dose_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_w,
	cd_unid_med_dose_w,
	nr_seq_mat_med_w,
	ds_horarios_w,
	ie_agrupador_ww,
	nr_sequencia_solucao_w,
	ie_acm_w,
	qt_dose_especial_w,
	hr_dose_especial_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	qt_idade_w,
	cd_mat_sem_apresent_w,
	nr_seq_via_acesso_w,
	qt_hora_aplicacao_w,
	qt_min_aplicacao_w,
	nr_agrup_w,
	nr_seq_atend_medic_w,
	ie_item_superior_w,
	cd_recomendacao_w,
	nr_seq_sol_w,
	ie_bomba_infusao_w,
	cd_kit_rec_w,
	ie_necessita_disp_kit_w,
	hr_prim_horario_w,
	NR_SEQ_PE_PROC_w,
	dt_lib_farmacia_mat_w,
	cd_protocolo_w,
	nr_seq_protocolo_w,
	nr_seq_mat_protocolo_w,
	nr_prescricao_anterior_w,
	ie_kit_w,
	ie_dose_espec_agora_w,
	nr_sequencia_proc_w,
	nr_seq_rec_cpoe_w,
	nr_seq_mat_cpoe_w;
	
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 674 linha - KIT = ' || pls_util_pck.enter_w ||
		'   cd_tipo_item_w: ' || cd_tipo_item_w || pls_util_pck.enter_w ||
		' - nr_agrupamento_w: ' || nr_agrupamento_w || pls_util_pck.enter_w ||
		' - ie_urgencia_w: ' || ie_urgencia_w || pls_util_pck.enter_w ||
		' - cd_material_w: ' || cd_material_w || pls_util_pck.enter_w ||
		' - nr_ocorrencia_w: ' || nr_ocorrencia_w || pls_util_pck.enter_w ||
		' - cd_intervalo_w: ' || cd_intervalo_w || pls_util_pck.enter_w ||
		' - ie_se_necessario_w: ' || ie_se_necessario_w || pls_util_pck.enter_w ||
		' - qt_unitaria_w: ' || qt_unitaria_w || pls_util_pck.enter_w ||
		' - qt_dose_w: ' || qt_dose_w || pls_util_pck.enter_w ||
		' - ie_via_aplicacao_w: ' || ie_via_aplicacao_w || pls_util_pck.enter_w ||
		' - cd_unidade_medida_w: ' || cd_unidade_medida_w || pls_util_pck.enter_w ||
		' - cd_unid_med_dose_w: ' || cd_unid_med_dose_w || pls_util_pck.enter_w ||
		' - nr_seq_mat_med_w: ' || nr_seq_mat_med_w || pls_util_pck.enter_w ||
		' - ds_horarios_w: ' || ds_horarios_w || pls_util_pck.enter_w ||
		' - ie_agrupador_ww: ' || ie_agrupador_ww || pls_util_pck.enter_w ||
		' - nr_sequencia_solucao_w: ' || nr_sequencia_solucao_w || pls_util_pck.enter_w ||
		' - ie_acm_w: ' || ie_acm_w || pls_util_pck.enter_w ||
		' - qt_dose_especial_w: ' || qt_dose_especial_w || pls_util_pck.enter_w ||
		' - hr_dose_especial_w: ' || hr_dose_especial_w || pls_util_pck.enter_w ||
		' - qt_hora_intervalo_w: ' || qt_hora_intervalo_w || pls_util_pck.enter_w ||
		' - qt_min_intervalo_w: ' || qt_min_intervalo_w || pls_util_pck.enter_w ||
		' - qt_idade_w: ' || qt_idade_w || pls_util_pck.enter_w ||
		' - cd_mat_sem_apresent_w: ' || cd_mat_sem_apresent_w || pls_util_pck.enter_w ||
		' - nr_seq_via_acesso_w: ' || nr_seq_via_acesso_w || pls_util_pck.enter_w ||
		' - qt_hora_aplicacao_w: ' || qt_hora_aplicacao_w || pls_util_pck.enter_w ||
		' - qt_min_aplicacao_w: ' || qt_min_aplicacao_w || pls_util_pck.enter_w ||
		' - nr_agrup_w: ' || nr_agrup_w || pls_util_pck.enter_w ||
		' - nr_seq_atend_medic_w: ' || nr_seq_atend_medic_w || pls_util_pck.enter_w ||
		' - ie_item_superior_w: ' || ie_item_superior_w || pls_util_pck.enter_w ||
		' - cd_recomendacao_w: ' || cd_recomendacao_w || pls_util_pck.enter_w ||
		' - nr_seq_sol_w: ' || nr_seq_sol_w || pls_util_pck.enter_w ||
		' - ie_bomba_infusao_w: ' || ie_bomba_infusao_w || pls_util_pck.enter_w ||
		' - cd_kit_rec_w: ' || cd_kit_rec_w || pls_util_pck.enter_w ||
		' - ie_necessita_disp_kit_w: ' || ie_necessita_disp_kit_w || pls_util_pck.enter_w ||
		' - hr_prim_horario_w: ' || hr_prim_horario_w || pls_util_pck.enter_w ||
		' - NR_SEQ_PE_PROC_w: ' || NR_SEQ_PE_PROC_w || pls_util_pck.enter_w ||
		' - dt_lib_farmacia_mat_w: ' ||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_lib_farmacia_mat_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| pls_util_pck.enter_w ||
		' - cd_protocolo_w: ' || cd_protocolo_w || pls_util_pck.enter_w ||
		' - nr_seq_protocolo_w: ' || nr_seq_protocolo_w || pls_util_pck.enter_w ||
		' - nr_seq_mat_protocolo_w: ' || nr_seq_mat_protocolo_w || pls_util_pck.enter_w ||
		' - nr_prescricao_anterior_w: ' || nr_prescricao_anterior_w || pls_util_pck.enter_w ||
		' - ie_kit_w: ' || ie_kit_w || pls_util_pck.enter_w ||
		' - ie_dose_espec_agora_w: ' || ie_dose_espec_agora_w || pls_util_pck.enter_w ||
		' - nr_sequencia_proc_w: ' || nr_sequencia_proc_w || pls_util_pck.enter_w ||
		' - nr_seq_rec_cpoe_w: ' || nr_seq_rec_cpoe_w,1, 2000);
		CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
	end if;

	if	((ie_prescr_quimio_w = 'S') and (coalesce(nr_seq_mat_protocolo_w::text, '') = '') and (cd_protocolo_w IS NOT NULL AND cd_protocolo_w::text <> '')) then
		begin
		select  coalesce(max(ie_kit),'S')
		into STRICT	ie_kit_w
		from	protocolo_medic_material
		where	cd_protocolo = cd_protocolo_w
		and		nr_sequencia = nr_seq_protocolo_w
		and		cd_material = cd_material_w;
		
		end;
	end if;

	ie_gerou_kit_mat_w	:= 'N';

	if (cd_recem_nato_w IS NOT NULL AND cd_recem_nato_w::text <> '') and (ie_recem_nato_w = 'S') then
		select	max(obter_idade_pf(cd_recem_nato_w, clock_timestamp(), 'DIA'))
		into STRICT	qt_idade_w
		;
	end if;

	if (ie_agrupador_ww in (4,13)) and (nr_sequencia_solucao_w IS NOT NULL AND nr_sequencia_solucao_w::text <> '') then
		begin
		select	max(elimina_acentuacao(ds_horarios)),/* Rafael em 03/03/2007 OS49577 inclui tratamento referente ao elimina acentuacao */
				coalesce(hr_prim_horario_w,max(hr_prim_horario))
		into STRICT	ds_horarios_w,
				hr_prim_horario_w
		from	prescr_solucao
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_solucao	= nr_sequencia_solucao_w;

		while	position(' as' in ds_horarios_w) > 0 loop
			k	:= position(' as' in ds_horarios_w);
			y	:= position(';' in ds_horarios_w);
			if (y > 0) then
				ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1) ||substr(ds_horarios_w,y+1,length(ds_horarios_w)),1,2000);
			else
				ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1),1,2000);
			end if;
		end loop;

		select	replace(padroniza_horario(ds_horarios_w),'A','')
		into STRICT	ds_horarios_w
		;
		end;
	end if;

	-- Ira gerar os kits para os novos itens "reorganizados", pois estes podem ser medicamentos distintos ou iguais com proporsoes diferentes
	if (coalesce(cd_mat_sem_apresent_w::text, '') = '') or (cd_mat_sem_apresent_w <> coalesce(cd_mat_sem_apresent_ant_w,0)) then

		cd_mat_sem_apresent_ant_w	:= cd_mat_sem_apresent_w;
		cd_material_w			:= coalesce(cd_mat_sem_apresent_w, cd_material_w);

		if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
			qt_volume_w	:= obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w);
		end if;

		ie_considera_w			:= 'N';
		ie_maior_volume_w		:= 'N';
		qt_volume_reconstituinte_w	:= 0;
		qt_volume_diluente_w		:= 0;

		OPEN C04;
		LOOP
		FETCH C04 into
			cd_material_dil_w,
			qt_dose_dil_w,
			cd_unidade_medida_dose_dil_w,
			qt_unitaria_dil_w,
			cd_classe_material_w,
			cd_grupo_material_w,
			cd_subgrupo_w,
			ie_agrupador_dil_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */

			ie_considera_w	:= 'N';
			OPEN C05;
			LOOP
			FETCH C05 into
				ie_considera_w,
				ie_maior_volume_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
			begin
			ie_considera_w	:= ie_considera_w;
			end;
			END LOOP;
			CLOSE C05;

			if (ie_agrupador_dil_w = 9) then
				qt_volume_reconstituinte_w	:= obter_conversao_ml(cd_material_dil_w,qt_dose_dil_w,cd_unidade_medida_dose_dil_w);
			else
				qt_volume_diluente_w		:= qt_volume_diluente_w + obter_conversao_ml(cd_material_dil_w,qt_dose_dil_w,cd_unidade_medida_dose_dil_w);
			end if;

		END LOOP;
		CLOSE C04;

		if (cd_mat_sem_apresent_w IS NOT NULL AND cd_mat_sem_apresent_w::text <> '') then
			select	sum(qt_dose)
			into STRICT	qt_dose_medic_w
			from	prescr_material
			where	nr_prescricao		= nr_prescricao_p
			and	cd_mat_sem_apresent	= cd_mat_sem_apresent_w;
		end if;

    BEGIN
        sql_w := 'CALL calc_vol_kit_med_presc_md(:1, :2, :3, :4, :5)INTO :qt_volume_aux_ww';
        EXECUTE sql_w
            USING IN ie_maior_volume_w, IN qt_volume_w, IN qt_volume_reconstituinte_w, IN ie_considera_w, IN qt_volume_diluente_w,
            OUT qt_volume_aux_ww;

    EXCEPTION
        WHEN OTHERS THEN
            qt_volume_aux_ww := NULL;
    END;

    qt_volume_w := qt_volume_aux_ww;
					
		if (ie_gerar_todos_kits_w = 'N') then
			cd_kit_w		:= null;
			
			open c02;
			loop
			fetch c02 into
				cd_kit_w,
				qt_volume_aux_w,
				ie_via_aplicacao_aux_w,
				cd_unidade_medida_aux_w,
				cd_setor_atendimento_aux_w,
				cd_setor_excluir_aux_w,
				nr_horas_validade_kit_w,
				qt_dose_min_w,
				qt_dose_max_w,
				ie_bomba_infusaoc02_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
						
				cd_kit_w	:= cd_kit_w;
			

				if (nr_horas_validade_kit_w	> 0) then
					select	max(a.dt_prescricao)
					into STRICT	dt_prescr_w
					from	prescr_medica a,
						prescr_material b
					where	a.nr_prescricao	= b.nr_prescricao
					and	a.nr_atendimento = nr_atendimento_w
					and	coalesce(a.dt_suspensao::text, '') = ''
					and	coalesce(b.dt_suspensao::text, '') = ''
					and	b.cd_kit_material = cd_kit_w;
					
					
          BEGIN
              sql_w := 'CALL obter_cd_kit_med_presc_md(:1, :2, :3)INTO :cd_kit_w';
              EXECUTE sql_w
                  USING IN dt_prescr_w, IN dt_prescricao_w, IN nr_horas_validade_kit_w, OUT cd_kit_w;
          EXCEPTION
              WHEN OTHERS THEN
                  cd_kit_w := NULL;
          END;
				end if;
				
			end loop;
			close c02;

			if (ie_info_rastre_prescr_w = 'S') then
				ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 885 linha - KIT =  cd_kit_w: ' || cd_kit_w ||
				' - cd_kit_rec_w: ' || cd_kit_rec_w || pls_util_pck.enter_w ||
				' - nr_seq_mat_med_w: ' || nr_seq_mat_med_w || pls_util_pck.enter_w ||
				' - cd_recomendacao_w: ' || cd_recomendacao_w || pls_util_pck.enter_w ||
				' - nr_seq_rec_cpoe_w: ' || nr_seq_rec_cpoe_w || pls_util_pck.enter_w ||
				' - cd_estabelecimento_p: ' || cd_estabelecimento_p || pls_util_pck.enter_w ||
				' - cd_medico_w: ' || cd_medico_w || pls_util_pck.enter_w ||
				' - ie_via_aplicacao_w: ' || ie_via_aplicacao_w || pls_util_pck.enter_w ||
				' - ie_agrupador_ww: ' || ie_agrupador_ww || pls_util_pck.enter_w ||
				' - cd_convenio_w: ' || cd_convenio_w || pls_util_pck.enter_w ||
				' - ie_sexo_paciente_w: ' || ie_sexo_paciente_w || pls_util_pck.enter_w ||
				' - ie_recem_nato_ww: ' || ie_recem_nato_ww || pls_util_pck.enter_w ||
				' - qt_idade_paciente_w: ' || qt_idade_paciente_w || pls_util_pck.enter_w ||
				' - qt_peso_w: ' || qt_peso_w || pls_util_pck.enter_w ||
				' - cd_setor_atendimento_w: ' || cd_setor_atendimento_w, 1, 2000);
				CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
			end if;

			OPEN C03;
			LOOP
			FETCH C03 into
				cd_material_kit_w,
				qt_material_kit_w,
				cd_unidade_medida_w,
				ie_agrupador_w,
				cd_intervalo_kit_w,
				ie_entra_conta_w,
				ie_duplica_prescr_w,
				cd_motivo_baixa_w,
				cd_kit_material_w,
				ie_permite_alterar_w,
				ie_via_aplicacao_ww;
			EXIT WHEN NOT FOUND; /* apply on c03 */

				if (ie_info_rastre_prescr_w = 'S') then
					ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 920 linha - KIT =  cd_kit_w: ' || cd_kit_w || pls_util_pck.enter_w ||
					' - cd_material_kit_w: ' || cd_material_kit_w || pls_util_pck.enter_w ||
					' - qt_material_kit_w: ' || qt_material_kit_w || pls_util_pck.enter_w ||
					' - cd_unidade_medida_w: ' || cd_unidade_medida_w || pls_util_pck.enter_w ||
					' - ie_agrupador_w: ' || ie_agrupador_w || pls_util_pck.enter_w ||
					' - cd_intervalo_kit_w: ' || cd_intervalo_kit_w || pls_util_pck.enter_w ||
					' - ie_entra_conta_w: ' || ie_entra_conta_w || pls_util_pck.enter_w ||
					' - ie_duplica_prescr_w: ' || ie_duplica_prescr_w || pls_util_pck.enter_w ||
					' - cd_motivo_baixa_w: ' || cd_motivo_baixa_w || pls_util_pck.enter_w ||
					' - cd_kit_material_w: ' || cd_kit_material_w || pls_util_pck.enter_w ||
					' - ie_permite_alterar_w: ' || ie_permite_alterar_w || pls_util_pck.enter_w ||
					' - ie_via_aplicacao_ww: ' || ie_via_aplicacao_ww, 1, 2000);
					CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
				end if;

				hr_prim_horario_kit_w := null;
				nr_intervalo_w		  := null;
				ds_horarios_kit_w	  := null;
			
				if (ie_duplica_prescr_w	= 'N') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material	= cd_material_kit_w
					and	nr_prescricao	= nr_prescricao_p
					and	coalesce(ie_duplica_prescr_w,'S') = 'N';

				elsif (ie_duplica_prescr_w	= 'C') then
					if (ie_item_superior_w	= 'S') then
						ie_registra_w	:= 'S';
					else
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'C'
						and	nr_seq_kit in ( SELECT	nr_sequencia
									  from		prescr_material
									  where		nr_prescricao	= nr_prescricao_p
									  and		ie_agrupador	= ie_agrupador_ww
									  and		nr_agrupamento	= nr_agrup_w);
					end if;
				elsif (ie_duplica_prescr_w	= 'D') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material	= cd_material_kit_w
					and	nr_prescricao	= nr_prescricao_p
					and	coalesce(ie_duplica_prescr_w,'S') = 'D'
					and	cd_kit_material	= cd_kit_material_w
					and	nr_seq_kit in ( SELECT	nr_sequencia
								  from		prescr_material
								  where		nr_prescricao	= nr_prescricao_p
								  and		ie_agrupador	= ie_agrupador_ww
								  and		nr_agrupamento	= nr_agrup_w);
				elsif (ie_duplica_prescr_w	= 'E') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material		= cd_material_kit_w
					and		nr_prescricao	= nr_prescricao_p
					and		coalesce(ie_duplica_prescr_w,'S') = 'E'
					and		cd_kit_material	= cd_kit_material_w;
				elsif (ie_duplica_prescr_w	= 'L') then
					if (ie_agrupador_ww not in (4,13)) then
						ie_registra_w	:= 'S';
					else
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material			= cd_material_kit_w
						and	nr_prescricao			= nr_prescricao_p
						and	nr_seq_kit 			in (	SELECT	nr_sequencia
												from	prescr_material
												where	nr_prescricao		= nr_prescricao_p
												and	ie_agrupador		in (4,13)
												and	nr_sequencia_solucao	= nr_sequencia_solucao_w);
					end if;
				else
					ie_registra_w	:= 'S';
				end if;

				
				if (coalesce(cd_intervalo_kit_w::text, '') = '') or (cd_intervalo_kit_w = '') then
					cd_intervalo_kit_w := cd_intervalo_w;
				end if;
				
				select /*+ INDEX(a PRESMAT_I5) */	
					coalesce(max('S'),'N')
				into STRICT	ie_ja_existe_w
				from	prescr_material a
				where	((cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '' AND nr_seq_recomendacao = nr_seq_mat_med_w) or (nr_seq_kit = nr_seq_mat_med_w))
				and	nr_prescricao = nr_prescricao_p
				and	cd_kit_material	= cd_kit_w
				and	cd_material	= cd_material_kit_w
				and	cd_unidade_medida_dose = cd_unidade_medida_w
				and	cd_intervalo in (cd_intervalo_kit_w,cd_intervalo_w)
				and	qt_dose	= qt_material_kit_w;

				if (ie_info_rastre_prescr_w = 'S') then
					ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1023 linha - KIT =  ie_registra_w: ' || ie_registra_w || pls_util_pck.enter_w ||
					' - ie_ja_existe_w: ' || ie_ja_existe_w, 1, 2000);
					CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
				end if;

				if (ie_registra_w	= 'S') and (ie_ja_existe_w = 'N') then

					select	coalesce(max(nr_sequencia),0) + 1,
						coalesce(max(nr_agrupamento),0) + 1
					into STRICT	nr_sequencia_w,
						nr_agrupamento_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p;

					/*
					--> Rafael em 08/11/2007 OS73502 x kit

					qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
					*/


					/* Alguem estude e veja por que tem essa atribuicao maluca | Nov/2019 */

					if (ie_agrupador_w <> 1) then
						ie_agrupador_w := 1;
					else
						ie_agrupador_w := 2;
					end if;

					ie_acm_check_w := ie_acm_w;
					ie_sn_check_w  := ie_se_necessario_w;
				
					if (coalesce(nr_prescricao_anterior_w, 0) = 0) then	 				
						 if (ie_agrupador_w in (1,4)) then
							
							 select max(nr_seq_mat_cpoe)
							 into STRICT 	nr_seq_mat_cpoe_w
							 from 	prescr_material 
							 where 	ie_agrupador in (1,4)
							 and    nr_prescricao = nr_prescricao_p
							 and 	nr_sequencia =  nr_sequencia_w;
							
							if (nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '') then						
							 
								select coalesce(min(nr_prescricao),0)
								into STRICT 	nr_prescricao_anterior_w
								from 	prescr_material 
								where 	ie_agrupador in (1,4)
								and	nr_prescricao < nr_prescricao_p
								and 	nr_seq_mat_cpoe =  nr_seq_mat_cpoe_w;
						
							 end if;
						 end if;
						
					 elsif (ie_agrupador_w in (8,12,16)) then							
							 select max(nr_seq_dieta_cpoe)
							 into STRICT 	nr_seq_dieta_cpoe_w
							 from 	prescr_material 
							 where 	ie_agrupador in (8,12,16)
							 and    nr_prescricao = nr_prescricao_p
							 and 	nr_sequencia =  nr_sequencia_w;
							
						 if (nr_seq_dieta_cpoe_w IS NOT NULL AND nr_seq_dieta_cpoe_w::text <> '') then
							
							 select coalesce(min(nr_prescricao),0)
							 into STRICT 	nr_prescricao_anterior_w		
							 from 	prescr_material 
							 where  ie_agrupador in (8,12,16)
							 and	nr_prescricao < nr_prescricao_p
							 and    nr_seq_dieta_cpoe = nr_seq_dieta_cpoe_w;
						
						end if;          	
					end if;	 		

	
					if (ie_check_tipo_interv_w = 'S') and ((coalesce(cd_intervalo_kit_w,cd_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_kit_w,cd_intervalo_w))::text <> '')) and (coalesce(nr_prescricao_anterior_w,0) = 0) then
						
						if (coalesce(ie_urgencia_w,'N') = 'N') then
							Select	coalesce(coalesce(max(ie_agora),ie_urgencia_w),'N')
							into STRICT	ie_urgencia_w
							from	intervalo_prescricao
							where	cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
						end if;
						
						if (ie_acm_w = 'N') then
							select  coalesce(max('S'),'N')
							into STRICT 	ie_acm_check_w
							from    intervalo_prescricao
							where   ie_acm     = 'S'
							and     cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
						end if;
						
						if (ie_sn_check_w = 'N') and (ie_check_sn_w = 'S') then
							select  coalesce(max('S'),'N')
							into STRICT 	ie_sn_check_w
							from    intervalo_prescricao
							where   ie_se_necessario     = 'S'
							and     cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
						end if;
				
					end if;	

					/*
					--> Rafael em 08/11/2007 OS73502 x kit <--

					calcular horarios cfe intervalo componente */
					if (cd_intervalo_kit_w IS NOT NULL AND cd_intervalo_kit_w::text <> '') then
						qt_material_w := qt_material_kit_w;
						if (cd_intervalo_kit_w <> cd_intervalo_w) then
							if (cd_funcao_origem_w <> 2314) then								
								select	obter_primeiro_horario(cd_intervalo_kit_w, nr_prescricao_p,cd_material_kit_w,ie_via_aplicacao_ww)
								into STRICT	hr_prim_horario_kit_w
								;							
							else
								select	obter_primeiro_horario_prin(cd_intervalo_kit_w, nr_prescricao_p,cd_material_kit_w,ie_via_aplicacao_ww, hr_prim_horario_w)
								into STRICT	hr_prim_horario_kit_w
								;									
							end if;							
						else
							hr_prim_horario_kit_w := hr_prim_horario_w;							
						end if;
						
						if hr_prim_horario_kit_w = '  :  ' then
							hr_prim_horario_kit_w := null;
						end if;

						if ((hr_prim_horario_kit_w IS NOT NULL AND hr_prim_horario_kit_w::text <> '') or hr_prim_horario_kit_w <> '') then
							if (cd_funcao_origem_w = 2314) then
								if (obterSeHorarioContinuoEnteral = 'S') then
									calcularHorarioContinuoEnteral;
								elsif (alterouHorarioItemPrincipal = 'S') then
									ds_horarios_kit_w := ds_horarios_w;
									nr_intervalo_w := nr_ocorrencia_w;
								else
									calcularHorarioPrescricao;
								end if;
							else
								calcularHorarioPrescricao;
							end if;
						end if;

            BEGIN
                IF (cd_funcao_origem_w = 2314) THEN
                    ie_chamada_cpoe_w := 'S';
                END IF;
                    
                sql_w := 'begin obter_hor_kit_med_presc_md (:1, :2, :3, :4, :5, :6, :7, :8); end;';
                EXECUTE sql_w
                    USING IN ie_urgencia_w, IN ie_chamada_cpoe_w, IN ds_horarios_w, IN hr_prim_horario_w, IN ie_sn_check_w,
                    IN ie_acm_check_w, OUT ds_horarios_kit_w, OUT hr_prim_horario_kit_w;
            EXCEPTION
                WHEN OTHERS THEN
                    ds_horarios_kit_w := NULL;
                    hr_prim_horario_kit_w := NULL;
            END;
					else
            BEGIN
                sql_w := 'begin obter_qt_material_kit_med_md(:1, :2, :3, :4, :5); end;';
                EXECUTE sql_w
                    USING IN qt_material_kit_w, IN nr_ocorrencia_w, OUT ds_horarios_kit_w, OUT qt_material_w, OUT
                    nr_intervalo_w;
            EXCEPTION
                WHEN OTHERS THEN
                    ds_horarios_kit_w := NULL;
                    qt_material_w := NULL;
                    nr_intervalo_w := NULL;
            END;
					end if;

					nr_seq_recomendacao_w	:= null;
					if (cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '') then
						nr_seq_recomendacao_w	:= nr_seq_mat_med_w;
						qt_dose_especial_w :=  null;
						ie_dose_espec_agora_w := null;
					end if;

					if (cd_funcao_origem_w = 2314) then
						SELECT * FROM cpoe_recalc_horarios_kit(nr_atendimento_w, nr_prescricao_p, nr_seq_mat_med_w, nr_seq_recomendacao_w, coalesce(ds_horarios_kit_w, ds_horarios_w), coalesce(nr_intervalo_w, nr_ocorrencia_w), ie_acm_check_w, ie_sn_check_w, coalesce(cd_intervalo_kit_w, cd_intervalo_w), ds_horarios_final_w, nr_ocorrencia_final_w) INTO STRICT ds_horarios_final_w, nr_ocorrencia_final_w;
					else
						ds_horarios_final_w := coalesce(ds_horarios_kit_w, ds_horarios_w);
						nr_ocorrencia_final_w := coalesce(nr_intervalo_w, nr_ocorrencia_w);
					end if;

					begin
					insert into prescr_material(
						nr_prescricao,
						nr_sequencia,
						ie_origem_inf,
						cd_material,
						cd_unidade_medida,
						qt_dose,
						qt_unitaria,
						qt_material,
						dt_atualizacao,
						nm_usuario,
						cd_intervalo,
						nr_agrupamento,
						ie_urgencia,
						nr_ocorrencia,
						qt_total_dispensar,
						ie_suspenso,
						cd_unidade_medida_dose,
						ie_se_necessario,
						ie_medicacao_paciente,
						nr_sequencia_proc,
						cd_motivo_baixa,
						ie_agrupador,
						ie_bomba_infusao,
						ie_aplic_bolus,
						ie_aplic_lenta,
						ie_acm,
						ds_horarios,
						nr_seq_kit,
						ie_recons_diluente_fixo,
						cd_kit_material,
						ie_sem_aprazamento,
						qt_dose_especial,
						hr_dose_especial,
						IE_COBRA_PACIENTE,
						nr_seq_recomendacao,
						ie_permite_alterar,
						hr_prim_horario,
						ie_via_aplicacao,
						nr_seq_pe_proc,
						ie_dose_espec_agora)
					Values (
						nr_prescricao_p,
						nr_sequencia_w,
						ie_origem_inf_w,
						cd_material_kit_w,
						cd_unidade_medida_w,
						coalesce(qt_material_kit_w,0),
						coalesce(qt_material_kit_w,1),
						coalesce(qt_material_w,1),
						clock_timestamp(),
						nm_usuario_p,
						coalesce(cd_intervalo_kit_w,cd_intervalo_w),
						nr_agrupamento_w,
						ie_urgencia_w,
						nr_ocorrencia_final_w,
						coalesce(qt_material_w,1),
						ie_suspenso_w,
						cd_unidade_medida_w,
						ie_sn_check_w,
						ie_medicacao_paciente_w,
						nr_sequencia_proc_w,
						cd_motivo_baixa_w,
						ie_agrupador_w,
						'N',
						'N',
						'N',
						ie_acm_check_w,
						ds_horarios_final_w,
						CASE WHEN coalesce(nr_seq_recomendacao_w::text, '') = '' THEN nr_seq_mat_med_w  ELSE nr_seq_recomendacao_w END ,
						'N',
						cd_kit_w,
						'N',
						CASE WHEN coalesce(qt_dose_especial_w::text, '') = '' THEN null  ELSE coalesce(qt_material_kit_w,1) END ,
						hr_dose_especial_w,
						CASE WHEN ie_utiliza_cobra_kit_w='S' THEN  ie_entra_conta_w  ELSE null END ,
						nr_seq_recomendacao_w,
						ie_permite_alterar_w,
						coalesce(hr_prim_horario_kit_w,hr_prim_horario_w),
						ie_via_aplicacao_ww,
						nr_seq_pe_proc_w,
						ie_dose_espec_agora_w);
						
						ie_gerou_kit_mat_w	:= 'S';
						

						select	cd_material,
								cd_intervalo,
								ie_via_aplicacao,
								qt_unitaria,
								qt_material,
								qt_dose_especial,
								nr_ocorrencia,
								ds_dose_diferenciada,
								ie_origem_inf,
								cd_unidade_medida_dose,
								qt_dias_util,
								coalesce(ie_se_necessario,'N'),
								coalesce(ie_acm,'N')
						into STRICT	cd_material_disp_w,
								cd_intervalo_disp_w,
								ie_via_aplicacao_disp_w,
								qt_unitaria_disp_w,
								qt_material_disp_w,
								qt_dose_especial_disp_w,
								nr_ocorrencia_disp_w,
								ds_dose_diferenciada_disp_w,
								ie_origem_inf_disp_w,
								cd_unidade_medida_dose_disp_w,
								qt_dias_util_disp_w,
								ie_se_necessario_w,
								ie_acm_w
						from	prescr_material
						where	nr_prescricao		= nr_prescricao_p
						and		nr_sequencia		= nr_sequencia_w;

						if (ie_agrupador_ww = 4) and (nr_seq_sol_w IS NOT NULL AND nr_seq_sol_w::text <> '') then
							select	max(cd_intervalo)
							into STRICT	cd_intervalo_disp_w
							from	prescr_solucao
							where	nr_prescricao	= nr_prescricao_p
							and	nr_seq_solucao		= nr_seq_sol_w;
						end if;
						
						if (obter_funcao_ativa in (924,950) and (ie_agrupador_ww <> 4 or ie_apresenta_invervalo_sol_w = 'S')) then
							if (ie_se_necessario_w = 'S') then
								select	coalesce(max(b.qt_se_necessario),0),
										coalesce(max(b.ie_mesmo_zerado),'N')
								into STRICT	qt_se_necessario_w,
										ie_mesmo_zerado_w
								from	intervalo_prescricao a,
										intervalo_setor b
								where	a.cd_intervalo = b.cd_intervalo
								and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
								and		coalesce(b.cd_estab, cd_estabelecimento_p) = cd_estabelecimento_p
								and		a.cd_intervalo = cd_intervalo_disp_w
								and		((b.cd_material = cd_material_disp_w) or (coalesce(b.cd_material::text, '') = ''))
								and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_disp_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
								and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
									
								if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
								
									select	coalesce(max(qt_se_necessario),1)
									into STRICT	qt_se_necessario_w
									from	intervalo_prescricao
									where	cd_intervalo	= cd_intervalo_disp_w  LIMIT 1;
								end if;
								nr_ocorrencia_disp_w	:= qt_se_necessario_w;
							elsif (ie_acm_w = 'S') then
								select	coalesce(max(b.qt_se_necessario),0),
										coalesce(max(b.ie_mesmo_zerado),'N')
								into STRICT	qt_se_necessario_w,
										ie_mesmo_zerado_w
								from	intervalo_prescricao a,
										intervalo_setor b
								where	a.cd_intervalo = b.cd_intervalo
								and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
								and		coalesce(b.cd_estab, cd_estabelecimento_p) = cd_estabelecimento_p
								and		a.cd_intervalo = cd_intervalo_disp_w
								and		((b.cd_material = cd_material_disp_w) or (coalesce(b.cd_material::text, '') = ''))
								and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_disp_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
								and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
									
								if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
							
									select	coalesce(max(qt_se_necessario),1)
									into STRICT	qt_se_necessario_w
									from	intervalo_prescricao
									where	cd_intervalo	= cd_intervalo_disp_w  LIMIT 1;
								end if;
								nr_ocorrencia_disp_w	:= qt_se_necessario_w;
							end if;
						end if;						
						
						SELECT * FROM obter_quant_dispensar(
							cd_estabelecimento_p, cd_material_disp_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_disp_w, ie_via_aplicacao_disp_w, qt_unitaria_disp_w, qt_dose_especial_disp_w, nr_ocorrencia_disp_w, ds_dose_diferenciada_disp_w, ie_origem_inf_disp_w, cd_unidade_medida_dose_disp_w, qt_dias_util_disp_w, qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w;

						update	prescr_material
						set		qt_material		= coalesce(qt_material_disp_w,1),
								qt_total_dispensar	= qt_total_dispensar_w,
								nr_ocorrencia = nr_ocorrencia_disp_w,
								ie_regra_disp		= CASE WHEN ie_necessita_disp_kit_w='N' THEN 'N'  ELSE CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END  END ,
								dt_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  clock_timestamp()  ELSE dt_baixa END ,
								cd_motivo_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  cd_motivo_baixa_ww  ELSE cd_motivo_baixa END
						where	nr_prescricao		= nr_prescricao_p
						and		nr_sequencia		= nr_sequencia_w;

						if (ie_prescr_mat_sem_lib_w = 'S') then
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, 'N', nm_usuario_p, null);
						end if;

					exception when others then
						ds_erro_w	:= SQLERRM(SQLSTATE);
					end;
				end if;

			END LOOP;
			CLOSE C03;
		else
			cd_kit_w		:= null;
			if (ie_info_rastre_prescr_w = 'S') then
				ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1342 linha - KIT =  cd_estabelecimento_p: ' || cd_estabelecimento_p || pls_util_pck.enter_w ||
				' - cd_material_w: ' || cd_material_w || pls_util_pck.enter_w ||
				' - cd_setor_atendimento_w: ' || cd_setor_atendimento_w || pls_util_pck.enter_w ||
				' - ie_via_aplicacao_w: ' || ie_via_aplicacao_w || pls_util_pck.enter_w ||
				' - nr_seq_agrupamento_w: ' || nr_seq_agrupamento_w || pls_util_pck.enter_w ||
				' - ie_bomba_infusao_w: ' || ie_bomba_infusao_w || pls_util_pck.enter_w ||
				' - nr_seq_via_acesso_w: ' || nr_seq_via_acesso_w || pls_util_pck.enter_w ||
				' - cd_unid_med_dose_w: ' || cd_unid_med_dose_w || pls_util_pck.enter_w ||
				' - cd_convenio_w: ' || cd_convenio_w || pls_util_pck.enter_w ||
				' - qt_volume_w: ' || qt_volume_w || pls_util_pck.enter_w ||
				' - qt_idade_w: ' || qt_idade_w || pls_util_pck.enter_w ||
				' - ie_tipo_atendimento_w: ' || ie_tipo_atendimento_w || pls_util_pck.enter_w ||
				' - nr_prescricao_p: ' || nr_prescricao_p || pls_util_pck.enter_w ||
				' - cd_mat_sem_apresent_w: ' || cd_mat_sem_apresent_w || pls_util_pck.enter_w ||
				' - nr_seq_mat_med_w: ' || nr_seq_mat_med_w || pls_util_pck.enter_w ||
				' - nr_seq_atend_medic_w: ' || nr_seq_atend_medic_w || pls_util_pck.enter_w ||
				' - qt_hora_aplicacao_w: ' || qt_hora_aplicacao_w || pls_util_pck.enter_w ||
				' - qt_min_aplicacao_w: ' || qt_min_aplicacao_w || pls_util_pck.enter_w ||
				' - dt_liberacao_farmacia_w: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_liberacao_farmacia_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| pls_util_pck.enter_w ||
				' - dt_lib_farmacia_mat_w: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_lib_farmacia_mat_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)|| pls_util_pck.enter_w ||
				' - ie_gerou_kit_w: ' || ie_gerou_kit_w || pls_util_pck.enter_w ||
				' - ie_subst_medicamento_p: ' || ie_subst_medicamento_p || pls_util_pck.enter_w ||
				' - ie_agrupador_ww: ' || ie_agrupador_ww || pls_util_pck.enter_w ||
				' - ie_gerar_kit_setor_w: ' || ie_gerar_kit_setor_w || pls_util_pck.enter_w ||
				' - ie_kit_w: ' || ie_kit_w || pls_util_pck.enter_w ||
				' - nr_seq_mat_protocolo_w: ' || nr_seq_mat_protocolo_w || pls_util_pck.enter_w ||
				' - nr_seq_protocolo_w: ' || nr_seq_protocolo_w || pls_util_pck.enter_w ||
				' - cd_protocolo_w: ' || cd_protocolo_w || pls_util_pck.enter_w ||
				' - cd_kit_rec_w: ' || cd_kit_rec_w || pls_util_pck.enter_w ||
				' - cd_recomendacao_w: ' || cd_recomendacao_w, 1, 2000);
				CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
			end if;

			OPEN C02;	
			LOOP
			FETCH C02 into
				cd_kit_w,
				qt_volume_aux_w,
				ie_via_aplicacao_aux_w,
				cd_unidade_medida_aux_w,
				cd_setor_atendimento_aux_w,
				cd_setor_excluir_aux_w,
				nr_horas_validade_kit_w,
				qt_dose_min_W,
				qt_dose_max_W,
				ie_bomba_infusaoc02_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

				if (ie_info_rastre_prescr_w = 'S') then
					ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1392 linha - KIT =  cd_kit_w: ' || cd_kit_w || pls_util_pck.enter_w ||
					' - qt_volume_aux_w: ' || qt_volume_aux_w || pls_util_pck.enter_w ||
					' - ie_via_aplicacao_aux_w: ' || ie_via_aplicacao_aux_w || pls_util_pck.enter_w ||
					' - cd_unidade_medida_aux_w: ' || cd_unidade_medida_aux_w || pls_util_pck.enter_w ||
					' - cd_setor_atendimento_aux_w: ' || cd_setor_atendimento_aux_w || pls_util_pck.enter_w ||
					' - cd_setor_excluir_aux_w: ' || cd_setor_excluir_aux_w || pls_util_pck.enter_w ||
					' - nr_horas_validade_kit_w: ' || nr_horas_validade_kit_w || pls_util_pck.enter_w ||
					' - qt_dose_min_W: ' || qt_dose_min_W || pls_util_pck.enter_w ||
					' - qt_dose_max_W: ' || qt_dose_max_W || pls_util_pck.enter_w ||
					' - ie_bomba_infusaoc02_w: ' || ie_bomba_infusaoc02_w || pls_util_pck.enter_w, 1, 2000);
					CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
				end if;
				cd_kit_w	:= cd_kit_w;

				if (nr_horas_validade_kit_w	> 0) then
					select	max(a.dt_prescricao)
					into STRICT	dt_prescr_w
					from	prescr_medica a,
						prescr_material b
					where	a.nr_prescricao	= b.nr_prescricao
					and	a.nr_atendimento = nr_atendimento_w
					and	coalesce(a.dt_suspensao::text, '') = ''
					and	coalesce(b.dt_suspensao::text, '') = ''
					and	b.cd_kit_material = cd_kit_w;

          BEGIN
              sql_w := 'CALL obter_cd_kit_med_presc_md(:1, :2, :3, :4)INTO :cd_kit_w';
              EXECUTE sql_w
                  USING IN cd_kit_w, IN dt_prescr_w, IN dt_prescricao_w, IN nr_horas_validade_kit_w, OUT cd_kit_w;
          EXCEPTION
              WHEN OTHERS THEN
                  cd_kit_w := NULL;
          END;
				end if;
				
				if (ie_info_rastre_prescr_w = 'S') then
					ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1426 linha - KIT =  cd_kit_w: ' || cd_kit_w ||
					' - cd_kit_rec_w: ' || cd_kit_rec_w || pls_util_pck.enter_w ||
					' - nr_seq_mat_med_w: ' || nr_seq_mat_med_w || pls_util_pck.enter_w ||
					' - cd_recomendacao_w: ' || cd_recomendacao_w || pls_util_pck.enter_w ||
					' - nr_seq_rec_cpoe_w: ' || nr_seq_rec_cpoe_w || pls_util_pck.enter_w ||
					' - cd_estabelecimento_p: ' || cd_estabelecimento_p || pls_util_pck.enter_w ||
					' - cd_medico_w: ' || cd_medico_w || pls_util_pck.enter_w ||
					' - ie_via_aplicacao_w: ' || ie_via_aplicacao_w || pls_util_pck.enter_w ||
					' - ie_agrupador_ww: ' || ie_agrupador_ww || pls_util_pck.enter_w ||
					' - cd_convenio_w: ' || cd_convenio_w || pls_util_pck.enter_w ||
					' - ie_sexo_paciente_w: ' || ie_sexo_paciente_w || pls_util_pck.enter_w ||
					' - ie_recem_nato_ww: ' || ie_recem_nato_ww || pls_util_pck.enter_w ||
					' - qt_idade_paciente_w: ' || qt_idade_paciente_w || pls_util_pck.enter_w ||
					' - qt_peso_w: ' || qt_peso_w || pls_util_pck.enter_w ||
					' - cd_setor_atendimento_w: ' || cd_setor_atendimento_w, 1, 2000);
					CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
				end if;

				OPEN C03;
				LOOP
				FETCH C03 into
					cd_material_kit_w,
					qt_material_kit_w,
					cd_unidade_medida_w,
					ie_agrupador_w,
					cd_intervalo_kit_w,
					ie_entra_conta_w,
					ie_duplica_prescr_w,
					cd_motivo_baixa_w,
					cd_kit_material_w,
					ie_permite_alterar_w,
					ie_via_aplicacao_ww;
				EXIT WHEN NOT FOUND; /* apply on c03 */

					if (ie_info_rastre_prescr_w = 'S') then
						ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1461 linha - KIT =  cd_kit_w: ' || cd_kit_w || pls_util_pck.enter_w ||
						' - cd_material_kit_w: ' || cd_material_kit_w || pls_util_pck.enter_w ||
						' - qt_material_kit_w: ' || qt_material_kit_w || pls_util_pck.enter_w ||
						' - cd_unidade_medida_w: ' || cd_unidade_medida_w || pls_util_pck.enter_w ||
						' - ie_agrupador_w: ' || ie_agrupador_w || pls_util_pck.enter_w ||
						' - cd_intervalo_kit_w: ' || cd_intervalo_kit_w || pls_util_pck.enter_w ||
						' - ie_entra_conta_w: ' || ie_entra_conta_w || pls_util_pck.enter_w ||
						' - ie_duplica_prescr_w: ' || ie_duplica_prescr_w || pls_util_pck.enter_w ||
						' - cd_motivo_baixa_w: ' || cd_motivo_baixa_w || pls_util_pck.enter_w ||
						' - cd_kit_material_w: ' || cd_kit_material_w || pls_util_pck.enter_w ||
						' - ie_permite_alterar_w: ' || ie_permite_alterar_w || pls_util_pck.enter_w ||
						' - ie_via_aplicacao_ww: ' || ie_via_aplicacao_ww, 1, 2000);
						CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
					end if;

					hr_prim_horario_kit_w := null;
					nr_intervalo_w		  := null;
					ds_horarios_kit_w	  := null;
				
					if (ie_duplica_prescr_w	= 'N') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'N';
					elsif (ie_duplica_prescr_w	= 'C') then

						if (cd_material_ant_w	= cd_material_w)  or (ie_item_superior_w	= 'S') then
							ie_registra_w	:= 'S';
						else
							select	coalesce(max('N'),'S')
							into STRICT	ie_registra_w
							from	prescr_material
							where	cd_material	= cd_material_kit_w
							and	nr_prescricao	= nr_prescricao_p
							and	coalesce(ie_duplica_prescr_w,'S') = 'C'
							and	nr_seq_kit in ( SELECT	nr_sequencia
										  from		prescr_material
										  where		nr_prescricao	= nr_prescricao_p
										  and		ie_agrupador	= ie_agrupador_ww
										  and		nr_agrupamento	= nr_agrup_w);
						end if;
					elsif (ie_duplica_prescr_w	= 'D') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'D'
						and	cd_kit_material	= cd_kit_material_w
						and	nr_seq_kit in ( SELECT	nr_sequencia
									 from		prescr_material
									 where		nr_prescricao	= nr_prescricao_p
									 and		ie_agrupador	= ie_agrupador_ww
									 and		nr_agrupamento	= nr_agrup_w);
					elsif (ie_duplica_prescr_w	= 'E') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material		= cd_material_kit_w
						and		nr_prescricao	= nr_prescricao_p
						and		coalesce(ie_duplica_prescr_w,'S') = 'E'
						and		cd_kit_material	= cd_kit_material_w;
					elsif (ie_duplica_prescr_w	= 'L') then
						if (ie_agrupador_ww not in (4,13)) then
							ie_registra_w	:= 'S';
						else
							select	coalesce(max('N'),'S')
							into STRICT	ie_registra_w
							from	prescr_material
							where	cd_material			= cd_material_kit_w
							and	nr_prescricao			= nr_prescricao_p
							and	nr_seq_kit 			in (	SELECT	nr_sequencia
													from	prescr_material
													where	nr_prescricao		= nr_prescricao_p
													and	ie_agrupador		in (4,13)
													and	nr_sequencia_solucao	= nr_sequencia_solucao_w);
						end if;
					else
						ie_registra_w	:= 'S';
					end if;

					
					if (coalesce(cd_intervalo_kit_w::text, '') = '') or (cd_intervalo_kit_w = '') then
						cd_intervalo_kit_w := cd_intervalo_w;
					end if;
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_ja_existe_w
					from	prescr_material
					where	((cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '' AND nr_seq_recomendacao = nr_seq_mat_med_w) or (nr_seq_kit = nr_seq_mat_med_w))
					and		nr_prescricao = nr_prescricao_p
					and		cd_kit_material	= cd_kit_w
					and		cd_material	= cd_material_kit_w
					and		cd_unidade_medida_dose = cd_unidade_medida_w
					and		cd_intervalo in (cd_intervalo_kit_w,cd_intervalo_w)
					and		qt_dose	= qt_material_kit_w;
					
					if (ie_info_rastre_prescr_w = 'S') then
						ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Gerar_Kit_Medic_Prescricao 1565 linha - KIT =  ie_registra_w: ' || ie_registra_w || pls_util_pck.enter_w ||
						' - ie_ja_existe_w: ' || ie_ja_existe_w, 1, 2000);
						CALL gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
					end if;

					if (ie_registra_w	= 'S') and (ie_ja_existe_w = 'N') then

						select	coalesce(max(nr_sequencia),0) + 1,
							coalesce(max(nr_agrupamento),0) + 1
						into STRICT	nr_sequencia_w,
							nr_agrupamento_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_p;

						/*
						--> Rafael em 08/11/2007 OS73502 x kit

						qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
						*/
						if (ie_agrupador_w <> 1) then
							ie_agrupador_w := 1;
						else
							ie_agrupador_w := 2;
						end if;
						
						ie_acm_check_w := ie_acm_w;
						if (ie_check_tipo_interv_w = 'S') and ((coalesce(cd_intervalo_kit_w,cd_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_kit_w,cd_intervalo_w))::text <> '')) then
							
							if (coalesce(ie_urgencia_w,'N') = 'N') then
								Select	coalesce(coalesce(max(ie_agora),ie_urgencia_w),'N')
								into STRICT	ie_urgencia_w
								from	intervalo_prescricao
								where	cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
							end if;

							if (ie_acm_w = 'N') then
								select  coalesce(max('S'),'N')
								into STRICT 	ie_acm_check_w
								from    intervalo_prescricao
								where   ie_acm     = 'S'
								and     cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
							end if;
							
						end if;	

						/*
						--> Rafael em 08/11/2007 OS73502 x kit <--

						calcular horarios cfe intervalo componente */
						begin
						if (cd_intervalo_kit_w IS NOT NULL AND cd_intervalo_kit_w::text <> '') then
							qt_material_w := qt_material_kit_w;
							
							if (cd_intervalo_kit_w <> cd_intervalo_w) then								
								if (cd_funcao_origem_w <> 2314) then
									select	obter_primeiro_horario(cd_intervalo_kit_w, nr_prescricao_p,cd_material_kit_w,ie_via_aplicacao_ww)
									into STRICT	hr_prim_horario_kit_w
									;
								else
									select	obter_primeiro_horario_prin(cd_intervalo_kit_w, nr_prescricao_p,cd_material_kit_w,ie_via_aplicacao_ww, hr_prim_horario_w)
									into STRICT	hr_prim_horario_kit_w
									;									
								end if;
							else
								hr_prim_horario_kit_w := hr_prim_horario_w;
							end if;
						
							if hr_prim_horario_kit_w = '  :  ' then
								hr_prim_horario_kit_w := null;
							end if;
						
							if ((hr_prim_horario_kit_w IS NOT NULL AND hr_prim_horario_kit_w::text <> '') or hr_prim_horario_kit_w <> '') then
								if (cd_funcao_origem_w = 2314) then
									if (obterSeHorarioContinuoEnteral = 'S') then
										calcularHorarioContinuoEnteral;
									elsif (alterouHorarioItemPrincipal = 'S') then
										ds_horarios_kit_w := ds_horarios_w;
										nr_intervalo_w := nr_ocorrencia_w;
									else
										calcularHorarioPrescricao;
									end if;
								else
									calcularHorarioPrescricao;
								end if;
							end if;

							if (ie_urgencia_w = 'S') then
								ds_horarios_kit_w := to_char(clock_timestamp(),'hh24:mi');
								
								if (cd_funcao_origem_w = 2314) then
									ds_horarios_kit_w := 	ds_horarios_w;
									hr_prim_horario_kit_w := hr_prim_horario_w;
								end if;	
							elsif (coalesce(ie_se_necessario_w,'N') = 'S') then
								ds_horarios_kit_w := 'SN';
								nr_intervalo_w := null;
							elsif (coalesce(ie_acm_check_w,'N') = 'S') then
								ds_horarios_kit_w := 'ACM';	
							end if;
						else
              BEGIN
                  sql_w := 'begin obter_qt_material_kit_med_md  (:1, :2, :3, :4, :5); end;';
                  EXECUTE sql_w
                      USING IN qt_material_kit_w, IN nr_ocorrencia_w, OUT ds_horarios_kit_w, OUT qt_material_w,
                      OUT nr_intervalo_w;

              EXCEPTION
                  WHEN OTHERS THEN
                      ds_horarios_kit_w := NULL;
                      qt_material_w := NULL;
                      nr_intervalo_w := NULL;
              END;
						end if;
						exception when others then
							null;
						end;
						
						nr_seq_recomendacao_w	:= null;
						if (cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '') then
							nr_seq_recomendacao_w	:= nr_seq_mat_med_w;
						end if;
						
						nr_seq_mat_med_ww := null;

						if (cd_funcao_origem_w = 2314) then
							
							if (coalesce(cd_recomendacao_w::text, '') = '') then
								nr_seq_mat_med_ww := nr_seq_mat_med_w;
							end if;
						
							SELECT * FROM cpoe_recalc_horarios_kit(nr_atendimento_w, nr_prescricao_p, nr_seq_mat_med_ww, nr_seq_recomendacao_w, coalesce(ds_horarios_kit_w, ds_horarios_w), coalesce(nr_intervalo_w, nr_ocorrencia_w), ie_acm_check_w, ie_se_necessario_w, coalesce(cd_intervalo_kit_w, cd_intervalo_w), ds_horarios_final_w, nr_ocorrencia_final_w) INTO STRICT ds_horarios_final_w, nr_ocorrencia_final_w;

							if (coalesce(cd_recomendacao_w::text, '') = '') and (nr_seq_mat_med_ww IS NOT NULL AND nr_seq_mat_med_ww::text <> '') then
								select	max(nr_seq_mat_cpoe)
								into STRICT 	nr_seq_mat_cpoe_w
								from 	prescr_material a
								where 	a.nr_prescricao = nr_prescricao_p
								and 	a.nr_sequencia = nr_seq_mat_med_ww;

								/* Tratamento para medicamentos da CPOE que estao em urgencia, se for a copia ira remover a urgencia */

								if (nr_seq_mat_cpoe_w IS NOT NULL AND nr_seq_mat_cpoe_w::text <> '' AND ie_urgencia_w = 'S') then

									select	coalesce(min(nr_prescricao), 0)
									into STRICT 	nr_prescricao_anterior_w
									from 	prescr_material
									where 	nr_prescricao < nr_prescricao_p
									and 	nr_seq_mat_cpoe = nr_seq_mat_cpoe_w;

									if (nr_prescricao_anterior_w > 0) then
										/* Prescricoes de copia nao devem gerar com urgencia */

										ie_urgencia_w := 'N';
									end if;
								end if;
							end if;
						else
							ds_horarios_final_w := coalesce(ds_horarios_kit_w, ds_horarios_w);
							nr_ocorrencia_final_w := coalesce(nr_intervalo_w, nr_ocorrencia_w);
						end if;

							insert into prescr_material(
								nr_prescricao,
								nr_sequencia,
								ie_origem_inf,
								cd_material,
								cd_unidade_medida,
								qt_dose,
								qt_unitaria,
								qt_material,
								dt_atualizacao,
								nm_usuario,
								cd_intervalo,
								nr_agrupamento,
								ie_urgencia,
								nr_ocorrencia,
								qt_total_dispensar,
								ie_suspenso,
								cd_unidade_medida_dose,
								ie_se_necessario,
								ie_medicacao_paciente,
								nr_sequencia_proc,
								cd_motivo_baixa,
								ie_agrupador,
								ie_bomba_infusao,
								ie_aplic_bolus,
								ie_aplic_lenta,
								ie_acm,
								ds_horarios,
								nr_seq_kit,
								ie_recons_diluente_fixo,
								cd_kit_material,
								ie_sem_aprazamento,
								qt_dose_especial,
								hr_dose_especial,
								IE_COBRA_PACIENTE,
								nr_seq_recomendacao,
								ie_permite_alterar,
								hr_prim_horario,
								ie_via_aplicacao,
								NR_SEQ_PE_PROC,
								ie_dose_espec_agora)
							Values (
								nr_prescricao_p,
								nr_sequencia_w,
								ie_origem_inf_w,
								cd_material_kit_w,
								cd_unidade_medida_w,
								qt_material_kit_w,
								coalesce(qt_material_kit_w,0),
								coalesce(qt_material_w,1),
								clock_timestamp(),
								nm_usuario_p,
								coalesce(cd_intervalo_kit_w,cd_intervalo_w),
								nr_agrupamento_w,
								ie_urgencia_w,
								nr_ocorrencia_final_w,
								qt_material_w,
								ie_suspenso_w,
								cd_unidade_medida_w,
								ie_se_necessario_w,
								ie_medicacao_paciente_w,
								nr_sequencia_proc_w,
								cd_motivo_baixa_w,
								ie_agrupador_w,
								'N',
								'N',
								'N',
								ie_acm_check_w,
								ds_horarios_final_w,
								CASE WHEN coalesce(nr_seq_recomendacao_w::text, '') = '' THEN nr_seq_mat_med_w  ELSE nr_seq_recomendacao_w END ,
								'N',
								cd_kit_w,'N',
								CASE WHEN coalesce(qt_dose_especial_w::text, '') = '' THEN null  ELSE qt_material_kit_w END ,
								hr_dose_especial_w,
								CASE WHEN ie_utiliza_cobra_kit_w='S' THEN  ie_entra_conta_w  ELSE null END ,
								nr_seq_recomendacao_w,
								ie_permite_alterar_w,
								coalesce(hr_prim_horario_kit_w,hr_prim_horario_w),
								ie_via_aplicacao_ww,
								NR_SEQ_PE_PROC_w,
								ie_dose_espec_agora_w);	
								
						ie_gerou_kit_mat_w := 'S';

						select	cd_material,
							cd_intervalo,
							ie_via_aplicacao,
							qt_unitaria,
							qt_material,
							qt_dose_especial,
							nr_ocorrencia,
							ds_dose_diferenciada,
							ie_origem_inf,
							cd_unidade_medida_dose,
							qt_dias_util,
							coalesce(ie_se_necessario,'N'),
							coalesce(ie_acm,'N')
						into STRICT	cd_material_disp_w,
							cd_intervalo_disp_w,
							ie_via_aplicacao_disp_w,
							qt_unitaria_disp_w,
							qt_material_disp_w,
							qt_dose_especial_disp_w,
							nr_ocorrencia_disp_w,
							ds_dose_diferenciada_disp_w,
							ie_origem_inf_disp_w,
							cd_unidade_medida_dose_disp_w,
							qt_dias_util_disp_w,
							ie_se_necessario_w,
							ie_acm_w
						from	prescr_material
						where	nr_prescricao		= nr_prescricao_p
						and	nr_sequencia		    = nr_sequencia_w;
						
						if (ie_agrupador_ww = 4) and (nr_seq_sol_w IS NOT NULL AND nr_seq_sol_w::text <> '') then
							select	max(cd_intervalo)
							into STRICT	cd_intervalo_disp_w
							from	prescr_solucao
							where	nr_prescricao	= nr_prescricao_p
							and	nr_seq_solucao		= nr_seq_sol_w;
						end if;
						
						if (obter_funcao_ativa in (924,950) and (ie_agrupador_ww <> 4 or ie_apresenta_invervalo_sol_w = 'S')) then
							if (ie_se_necessario_w = 'S') then
								select	coalesce(max(b.qt_se_necessario),0),
										coalesce(max(b.ie_mesmo_zerado),'N')
								into STRICT	qt_se_necessario_w,
										ie_mesmo_zerado_w
								from	intervalo_prescricao a,
										intervalo_setor b
								where	a.cd_intervalo = b.cd_intervalo
								and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
								and		coalesce(b.cd_estab, cd_estabelecimento_p) = cd_estabelecimento_p
								and		a.cd_intervalo = cd_intervalo_disp_w
								and		((b.cd_material = cd_material_disp_w) or (coalesce(b.cd_material::text, '') = ''))
								and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_disp_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
								and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
									
								if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
								
									select	coalesce(max(qt_se_necessario),1)
									into STRICT	qt_se_necessario_w
									from	intervalo_prescricao
									where	cd_intervalo	= cd_intervalo_disp_w  LIMIT 1;
								end if;
								nr_ocorrencia_disp_w	:= qt_se_necessario_w;
							elsif (ie_acm_w = 'S') then
								select	coalesce(max(b.qt_se_necessario),0),
										coalesce(max(b.ie_mesmo_zerado),'N')
								into STRICT	qt_se_necessario_w,
										ie_mesmo_zerado_w
								from	intervalo_prescricao a,
										intervalo_setor b
								where	a.cd_intervalo = b.cd_intervalo
								and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
								and		coalesce(b.cd_estab, cd_estabelecimento_p) = cd_estabelecimento_p
								and		a.cd_intervalo = cd_intervalo_disp_w
								and		((b.cd_material = cd_material_disp_w) or (coalesce(b.cd_material::text, '') = ''))
								and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_disp_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
								and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''))  LIMIT 1;
									
								if (coalesce(qt_se_necessario_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
							
									select	coalesce(max(qt_se_necessario),1)
									into STRICT	qt_se_necessario_w
									from	intervalo_prescricao
									where	cd_intervalo	= cd_intervalo_disp_w  LIMIT 1;
								end if;
								nr_ocorrencia_disp_w	:= qt_se_necessario_w;
							end if;
						end if;						

						SELECT * FROM obter_quant_dispensar(
							cd_estabelecimento_p, cd_material_disp_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_disp_w, ie_via_aplicacao_disp_w, qt_unitaria_disp_w, qt_dose_especial_disp_w, nr_ocorrencia_disp_w, ds_dose_diferenciada_disp_w, ie_origem_inf_disp_w, cd_unidade_medida_dose_disp_w, qt_dias_util_disp_w, qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w;

						update	prescr_material
						set	qt_material		= coalesce(qt_material_disp_w,coalesce(qt_material,1)),
							qt_total_dispensar	= qt_total_dispensar_w,
							nr_ocorrencia = nr_ocorrencia_disp_w,
							ie_regra_disp		= CASE WHEN ie_necessita_disp_kit_w='N' THEN 'N'  ELSE CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END  END ,
							dt_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  clock_timestamp()  ELSE dt_baixa END ,
							cd_motivo_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  cd_motivo_baixa_ww  ELSE cd_motivo_baixa END
						where	nr_prescricao		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;

						if (ie_prescr_mat_sem_lib_w = 'S') then
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, 'N', nm_usuario_p, null);
						end if;
					end if;

					if (coalesce(cd_material_ant_w::text, '') = '') then
						cd_material_ant_w	:= cd_material_w;
					end if;

				END LOOP;
				CLOSE C03;

			END LOOP;
			CLOSE C02;
		end if;
	end if;

	if (coalesce(cd_recomendacao_w::text, '') = '') then
		CALL Atualizar_ie_kit_gerado(ie_gerou_kit_mat_w,nr_prescricao_p,nr_seq_mat_med_w,'PRESCR_MATERIAL');
	end if;
	
END LOOP;
CLOSE C01;

open C06;
loop
fetch C06 into
	nr_seq_rec_cpoe_w;
EXIT WHEN NOT FOUND; /* apply on C06 */

	delete from w_kit_modificado
	where nr_seq_rec_cpoe = nr_seq_rec_cpoe_w;
end loop;
close C06;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_medic_prescricao (( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_diluicao_p text default 'N', ie_manual_p text default 'N', ie_subst_medicamento_p text default 'N') IS cd_tipo_item_w smallint) FROM PUBLIC;

