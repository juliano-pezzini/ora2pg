-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_sms_gv ( ds_remetente_p text, ds_destinatario_p text, ds_mensagem_p text, nr_seq_gv_p bigint, nr_atendimento_p text, cd_pessoa_fisica_p text) AS $body$
DECLARE

				
nr_sequencia_w	bigint;
id_sms_w		bigint;
nr_celular_w	varchar(50);
nr_pos_ddd0_w	bigint := 0;
nm_usuario_w 	varchar(255);


BEGIN
nr_celular_w := trim(both ds_destinatario_p);
nm_usuario_w := obter_usuario_ativo;


if (OBTER_VALOR_PARAM_USUARIO(0,214,0,nm_usuario_w,wheb_usuario_pck.get_cd_estabelecimento) = 'S')then
	if (substr(nr_celular_w,1,2) <> '55') then
		nr_celular_w :=  '55'||nr_celular_w;
	end if;

	nr_pos_ddd0_w	:= position('550' in nr_celular_w);

	if (substr(nr_celular_w,1,3) = '550')then
		nr_celular_w := '55'||substr(nr_celular_w,4,50);	
	end if;
end if;	
	
if (ds_remetente_p IS NOT NULL AND ds_remetente_p::text <> '') and (nr_celular_w IS NOT NULL AND nr_celular_w::text <> '') and (ds_mensagem_p IS NOT NULL AND ds_mensagem_p::text <> '') and (nr_seq_gv_p IS NOT NULL AND nr_seq_gv_p::text <> '') and (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then
	
	/* enviar sms */

	id_sms_w := wheb_sms.enviar_sms(ds_remetente_p, nr_celular_w, ds_mensagem_p, nm_usuario_w, id_sms_w);

	/* gravar log */

	select	nextval('log_envio_sms_seq')
	into STRICT	nr_sequencia_w
	;

	insert into log_envio_sms(
		nr_sequencia,
		dt_atualizacao_nrec,
		nm_usuario_nrec,	
		dt_atualizacao,
		nm_usuario,
		dt_envio,
		nr_seq_gv,
		nr_telefone,
		ds_mensagem,
		id_sms,
		nr_atendimento,
		cd_pessoa_fisica)
	values (
		nr_sequencia_w,
		clock_timestamp(), 
		nm_usuario_w,
		clock_timestamp(),
		nm_usuario_w,
		clock_timestamp(),
		nr_seq_gv_p,
		ds_destinatario_p,
		ds_mensagem_p,
		id_sms_w,
		nr_atendimento_p,
		cd_pessoa_fisica_p);
		
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_sms_gv ( ds_remetente_p text, ds_destinatario_p text, ds_mensagem_p text, nr_seq_gv_p bigint, nr_atendimento_p text, cd_pessoa_fisica_p text) FROM PUBLIC;

