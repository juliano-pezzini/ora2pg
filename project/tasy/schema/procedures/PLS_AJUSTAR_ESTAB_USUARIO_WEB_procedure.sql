-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_estab_usuario_web ( nm_usuario_p text) AS $body$
DECLARE



qt_reg_prest_w		bigint;
qt_reg_estip_w		bigint;
qt_reg_benef_w		bigint;
nr_seq_contrato_w	bigint;
nr_seq_estip_w		bigint;
nr_seq_seg_w		bigint;
nr_seq_segurado_w	bigint;
cd_estabelecimento_w	smallint;
nr_seq_prestador_w	bigint;
nr_seq_user_prest_w	bigint;


C01 CURSOR FOR
	SELECT 	nr_sequencia,
		nr_seq_prestador
	from 	pls_usuario_web;

C02 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_contrato
	from	pls_estipulante_web;

C03 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_segurado
	from	pls_segurado_web;


BEGIN

select 	count(nr_sequencia)
into STRICT	qt_reg_prest_w
from 	pls_usuario_web;


select	count(nr_sequencia)
into STRICT	qt_reg_estip_w
from	pls_estipulante_web;

select	count(nr_sequencia)
into STRICT	qt_reg_benef_w
from	pls_segurado_web;


/* Adicionar estabelecimento aos usuários prestadores do portal do plano de saúde */

if (qt_reg_prest_w > 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_user_prest_w,
		nr_seq_prestador_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			select	coalesce(cd_estabelecimento,1)
			into STRICT	cd_estabelecimento_w
			from	pls_prestador
			where	nr_sequencia	= nr_seq_prestador_w;

			if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
				update 	pls_usuario_web
				set 	cd_estabelecimento = cd_estabelecimento_w
				where	nr_sequencia = nr_seq_user_prest_w;
			end if;
		end;
	end loop;
	close C01;
end if;

/* Adicionar estabelecimento aos usuários estipulantes do portal do plano de saúde */

if (qt_reg_estip_w > 0) then
	open C02;
	loop
	fetch C02 into
		nr_seq_estip_w,
		nr_seq_contrato_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			select	coalesce(cd_estabelecimento,1)
			into STRICT	cd_estabelecimento_w
			from	pls_contrato
			where	nr_sequencia	= nr_seq_contrato_w;

			if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
				update 	pls_estipulante_web
				set 	cd_estabelecimento = cd_estabelecimento_w
				where	nr_sequencia = nr_seq_estip_w;
			end if;
		end;
	end loop;
	close C02;
end if;

/* Adicionar estabelecimento aos usuários beneficiários do portal do plano de saúde */

if (qt_reg_benef_w > 0) then
	open C03;
	loop
	fetch C03 into
		nr_seq_seg_w,
		nr_seq_segurado_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
			select	max(b.cd_estabelecimento)
			into STRICT	cd_estabelecimento_w
			from	pls_segurado a,
				pls_contrato b
			where	a.nr_seq_contrato	= b.nr_sequencia
			and	a.nr_sequencia		= nr_seq_segurado_w;

			if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
				update 	pls_segurado_web
				set 	cd_estabelecimento = cd_estabelecimento_w
				where	nr_sequencia = nr_seq_seg_w;
			end if;
		end;
	end loop;
	close C03;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_estab_usuario_web ( nm_usuario_p text) FROM PUBLIC;

