-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rateio_nf_ordem_compra ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nr_ordem_compra_p ordem_compra.nr_ordem_compra%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_commit_p text default 'N') AS $body$
DECLARE


nr_seq_nf_oc_rateio_w		nota_fiscal_oc_rateio.nr_sequencia%type;
nr_seq_regra_entrada_w		regra_nf_rateio_compra.nr_sequencia%type;
nr_seq_regra_saida_w		regra_nf_rateio_compra.nr_sequencia%type;
cd_operacao_nf_w		regra_nf_rateio_compra.cd_operacao_nf%type;
cd_natureza_operacao_w		regra_nf_rateio_compra.cd_natureza_operacao%type;
nr_seq_classif_fiscal_w		regra_nf_rateio_compra.nr_seq_classif_fiscal%type;
cd_serie_nf_w			regra_nf_rateio_compra.cd_serie_nf%type;
cd_condicao_pagamento_w		regra_nf_rateio_compra.cd_condicao_pagamento%type;
nr_seq_nota_nova_w		nota_fiscal.nr_sequencia%type;
nr_nota_fiscal_e_w		nota_fiscal_transferencia.nr_nota_fiscal_e%type;
nr_nota_fiscal_s_w		nota_fiscal_transferencia.nr_nota_fiscal_s%type;
vl_unitario_material_w		ordem_compra_item.vl_unitario_material%type;
ie_atualiza_conta_cont_oc_w	varchar(5);
cd_conta_contabil_e_w		nota_fiscal_transf_item.cd_conta_contabil_e%type;
cd_conta_contabil_s_w		nota_fiscal_transf_item.cd_conta_contabil_s%type;
ie_tipo_local_w			local_estoque.ie_tipo_local%type;
ie_tipo_conta_e_w		integer;
ie_tipo_conta_s_w		integer;
cd_centro_custo_e_w		nota_fiscal_transf_item.cd_centro_custo_e%type;
cd_centro_custo_s_w		nota_fiscal_transf_item.cd_centro_custo_s%type;
cd_local_estoque_e_w		nota_fiscal_transf_item.cd_local_estoque_e%type;
cd_local_estoque_s_w		nota_fiscal_transf_item.cd_local_estoque_s%type;

cd_conta_contabil_cc_e_w	nota_fiscal_transf_item.cd_conta_contabil_e%type;
cd_conta_contabil_cc_s_w	nota_fiscal_transf_item.cd_conta_contabil_s%type;
cd_centro_custo_cc_e_w		nota_fiscal_transf_item.cd_centro_custo_e%type;
cd_centro_custo_cc_s_w		nota_fiscal_transf_item.cd_centro_custo_s%type;

nr_reg_oc_rateio_w		integer;
nr_reg_fis_tran_w		integer;
nr_reg_fis_item_w		integer;

type reg_nota_fiscal_oc_rateio is table of nota_fiscal_oc_rateio%rowtype index by integer;
nota_fiscal_oc_rateio_w		reg_nota_fiscal_oc_rateio;

type reg_nota_fiscal_transferencia is table of nota_fiscal_transferencia%rowtype index by integer;
nota_fiscal_transferencia_w	reg_nota_fiscal_transferencia;

type reg_nota_fiscal_transf_item is table of nota_fiscal_transf_item%rowtype index by integer;
nota_fiscal_transf_item_w	reg_nota_fiscal_transf_item;

tb_nr_seq_nota_transf_w		dbms_sql.number_table;
tb_nr_seq_rateio_e_w		dbms_sql.number_table;
tb_nr_seq_rateio_s_w		dbms_sql.number_table;


-- Cursor para varrer o rateio da ordem de compra
c01 CURSOR(	nr_ordem_compra_pc	 ordem_compra_nf_rateio.nr_ordem_compra%type) FOR
	SELECT  r.nr_sequencia,
		r.nr_item_oci,
		r.nr_ordem_compra,
		r.vl_parcela,
		r.pr_parcela,
		r.cd_estab_rateio,
		r.cd_empresa_rateio,
		i.cd_material
	from	ordem_compra_nf_rateio r,
		ordem_compra_item i
	where	r.nr_ordem_compra = i.nr_ordem_compra
	and	r.nr_item_oci = i.nr_item_oci
	and	r.nr_ordem_compra = nr_ordem_compra_pc;

-- Puxar regra de entrada
c02 CURSOR(	cd_estab_logado_pc	 estabelecimento.cd_estabelecimento%type,
		cd_material_pc		 material.cd_material%type,
		cd_estab_rateio_pc	 estabelecimento.cd_estabelecimento%type,
		cd_empresa_rateio_pc	 empresa.cd_empresa%type ) FOR
	SELECT	rd.nr_sequencia
	from	regra_nf_rateio_compra rd,
		regra_nf_rat_compra_rest rr
	where	rd.nr_sequencia    = rr.nr_seq_regra
	and	rd.cd_estabelecimento  = cd_estab_logado_pc
	and (rr.cd_material    = cd_material_pc or coalesce(rr.cd_material::text, '') = '')
	and (rr.cd_estab_rateio  = cd_estab_rateio_pc or coalesce(rr.cd_estab_rateio::text, '') = '')
	and (rr.cd_empresa_rateio  = cd_empresa_rateio_pc or coalesce(rr.cd_empresa_rateio::text, '') = '')
	and	rd.ie_entrada_saida in ('A','E')
	order by coalesce(rr.cd_material,0),
		coalesce(rr.cd_estab_rateio,0),
		coalesce(rr.cd_empresa_rateio,0);

-- Puxar regra de saida
c03 CURSOR(	cd_estab_logado_pc	 estabelecimento.cd_estabelecimento%type,
		cd_material_pc		 material.cd_material%type,
		cd_estab_rateio_pc	 estabelecimento.cd_estabelecimento%type,
		cd_empresa_rateio_pc	 empresa.cd_empresa%type ) FOR
	SELECT	rd.nr_sequencia
	from	regra_nf_rateio_compra rd,
		regra_nf_rat_compra_rest rr
	where	rd.nr_sequencia    = rr.nr_seq_regra
	and	rd.cd_estabelecimento  = cd_estab_logado_pc
	and (rr.cd_material    = cd_material_pc or coalesce(rr.cd_material::text, '') = '')
	and (rr.cd_estab_rateio  = cd_estab_rateio_pc or coalesce(rr.cd_estab_rateio::text, '') = '')
	and (rr.cd_empresa_rateio  = cd_empresa_rateio_pc or coalesce(rr.cd_empresa_rateio::text, '') = '')
	and	rd.ie_entrada_saida in ('A','S')
	order by coalesce(rr.cd_material,0),
		coalesce(rr.cd_estab_rateio,0),
		coalesce(rr.cd_empresa_rateio,0);

--Cursor para buscar as notas de rateio de entrada
c04 CURSOR(	nr_seq_nota_pc		 nota_fiscal.nr_sequencia%type,
		cd_estabelecimento_pc	 nota_fiscal.cd_estabelecimento%type) FOR
	SELECT	en.nr_sequencia nr_seq_rateio_e,
		s.nr_sequencia nr_seq_rateio_s,
		en.nr_seq_nota nr_seq_nota_e,
		s.nr_seq_nota nr_seq_nota_s,
		en.nr_ordem_compra nr_ordem_compra_e,
		s.nr_ordem_compra nr_ordem_compra_s,
		en.nr_item_oci nr_item_oci_e,
		s.nr_item_oci nr_item_oci_s,
		en.nr_seq_oc_nf_rateio nr_seq_oc_nf_rateio_e,
		s.nr_seq_oc_nf_rateio nr_seq_oc_nf_rateio_s,
		en.cd_estab_rateio,
		en.cd_empresa_rateio cd_empresa_rateio_e,
		s.cd_empresa_rateio cd_empresa_rateio_s,
		en.vl_parcela,
		en.cd_condicao_pagamento cd_condicao_pagamento_e,
		s.cd_condicao_pagamento cd_condicao_pagamento_s,
		en.cd_natureza_operacao cd_natureza_operacao_e,
		s.cd_natureza_operacao cd_natureza_operacao_s,
		en.cd_operacao_nf cd_operacao_nf_e,
		s.cd_operacao_nf cd_operacao_nf_s,
		en.cd_serie_nf cd_serie_nf_e,
		s.cd_serie_nf cd_serie_nf_s,
		e.cd_cgc,
		(SELECT max(e.cd_cgc)
		from estabelecimento e 
		where cd_estabelecimento = cd_estabelecimento_pc) cd_cgc_emitente,
		i.cd_material,
		i.qt_material,
		i.vl_unitario_material,
		i.cd_local_estoque cd_local_estoque_s,
		i.cd_centro_custo,
		i.cd_conta_contabil,
		(select	min(l.cd_local_estoque)
		from	local_estoque l
		where	l.ie_tipo_local = 8
		and	l.cd_estabelecimento = en.cd_estab_rateio) cd_local_estoque_e,
		(select	max(b.cd_operacao_estoque)
		from	operacao_estoque b,
			operacao_nota a
		where	a.cd_operacao_estoque = b.cd_operacao_estoque
		and	a.cd_operacao_nf = en.cd_operacao_nf) cd_operacao_estoque_e,
		(select	max(b.cd_operacao_estoque)
		from	operacao_estoque b,
			operacao_nota a
		where	a.cd_operacao_estoque = b.cd_operacao_estoque
		and	a.cd_operacao_nf = s.cd_operacao_nf) cd_operacao_estoque_s
	from	nota_fiscal_oc_rateio en,
		nota_fiscal_oc_rateio s,
		estabelecimento e,
		ordem_compra_item i
	where	en.nr_seq_nota = s.nr_seq_nota
	and	en.cd_estab_rateio = s.cd_estab_rateio
	and	en.nr_ordem_compra = s.nr_ordem_compra
	and	en.nr_item_oci = s.nr_item_oci
	and	en.cd_estab_rateio = e.cd_estabelecimento
	and	en.nr_ordem_compra = i.nr_ordem_compra
	and	en.nr_item_oci = i.nr_item_oci
	and	en.nr_seq_nota = nr_seq_nota_pc
	and	en.ie_entrada_saida = 'E'
	and	s.ie_entrada_saida = 'S'
	and	en.cd_estab_rateio != cd_estabelecimento_pc;
	
c05 CURSOR FOR
	SELECT	t.nr_sequencia nr_seq_nota_transf,
		t.nr_seq_rateio_e,
		t.nr_seq_rateio_s
	from	nota_fiscal_transferencia t
	where	t.nr_seq_nota_fiscal_origem = nr_seq_nota_p;
BEGIN
if (nr_seq_nota_p IS NOT NULL AND nr_seq_nota_p::text <> '') and (nr_ordem_compra_p IS NOT NULL AND nr_ordem_compra_p::text <> '') then
	-- Obter ordem de compra vinculada na nota fiscal
	select	max(nr_sequencia)
	into STRICT	nr_seq_nf_oc_rateio_w
	from	nota_fiscal_oc_rateio
	where	nr_seq_nota  = nr_seq_nota_p;

	if (coalesce(nr_seq_nf_oc_rateio_w::text, '') = '') then
		ie_atualiza_conta_cont_oc_w := coalesce(obter_valor_param_usuario(	cd_funcao_p => 40, nr_sequencia_p => 41,
										cd_perfil_p => obter_perfil_ativo, nm_usuario_p => nm_usuario_p,
										cd_estabelecimento_p => cd_estabelecimento_p),'S');
		
		nr_reg_oc_rateio_w := 0;
		for r_C01_w in C01( nr_ordem_compra_p ) loop

			-- Puxar regra de entrada
			nr_seq_regra_entrada_w := null;
			for r_C02_w in c02(	coalesce(wheb_usuario_pck.get_cd_estabelecimento,cd_estabelecimento_p),
						r_C01_w.cd_material,
						r_C01_w.cd_estab_rateio,
						r_C01_w.cd_empresa_rateio) loop
				-- vai percorrer as regras e fazer o insert pra cada uma
				nr_seq_regra_entrada_w := r_C02_w.nr_sequencia;
			end loop;

			-- Puxar regra de saida
			nr_seq_regra_saida_w := null;
			for r_C03_w in c03(	coalesce(wheb_usuario_pck.get_cd_estabelecimento,cd_estabelecimento_p),
						r_C01_w.cd_material,
						r_C01_w.cd_estab_rateio,
						r_C01_w.cd_empresa_rateio) loop
				-- vai percorrer as regras e fazer o insert pra cada uma
				nr_seq_regra_saida_w := r_C03_w.nr_sequencia;
			end loop;

			-- Inserir entrada
			if (nr_seq_regra_entrada_w IS NOT NULL AND nr_seq_regra_entrada_w::text <> '') then
				nr_reg_oc_rateio_w := nr_reg_oc_rateio_w + 1;
				
				select	rd.cd_operacao_nf,
					rd.cd_natureza_operacao,
					rd.nr_seq_classif_fiscal,
					rd.cd_serie_nf,
					rd.cd_condicao_pagamento
				into STRICT	cd_operacao_nf_w,
					cd_natureza_operacao_w,
					nr_seq_classif_fiscal_w,
					cd_serie_nf_w,
					cd_condicao_pagamento_w
				from	regra_nf_rateio_compra rd
				where	rd.nr_sequencia = nr_seq_regra_entrada_w;
				
				select	nextval('nota_fiscal_oc_rateio_seq')
				into STRICT	nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_sequencia
				;
				
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].dt_atualizacao := clock_timestamp();
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nm_usuario := nm_usuario_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].dt_atualizacao_nrec := clock_timestamp();
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nm_usuario_nrec := nm_usuario_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nota := nr_seq_nota_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_ordem_compra := r_C01_w.nr_ordem_compra;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_item_oci := r_C01_w.nr_item_oci;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nota_rateio := null;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_oc_nf_rateio := r_C01_w.nr_sequencia;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_estab_rateio := r_C01_w.cd_estab_rateio;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_empresa_rateio := r_C01_w.cd_empresa_rateio;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].vl_parcela := r_C01_w.vl_parcela;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].pr_parcela := r_C01_w.pr_parcela;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_condicao_pagamento := cd_condicao_pagamento_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_natureza_operacao := cd_natureza_operacao_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_operacao_nf := cd_operacao_nf_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_serie_nf := cd_serie_nf_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_classif_fiscal := nr_seq_classif_fiscal_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].ie_entrada_saida := 'E';
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].ie_situacao := 'A';
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nf_oc_rateio := null;
			end if;

			-- Inserir saida
			if (nr_seq_regra_saida_w IS NOT NULL AND nr_seq_regra_saida_w::text <> '') then
				nr_reg_oc_rateio_w := nr_reg_oc_rateio_w + 1;
			
				select	rd.cd_operacao_nf,
					rd.cd_natureza_operacao,
					rd.nr_seq_classif_fiscal,
					rd.cd_serie_nf,
					rd.cd_condicao_pagamento
				into STRICT	cd_operacao_nf_w,
					cd_natureza_operacao_w,
					nr_seq_classif_fiscal_w,
					cd_serie_nf_w,
					cd_condicao_pagamento_w
				from	regra_nf_rateio_compra rd
				where  	rd.nr_sequencia = nr_seq_regra_saida_w;
				
				select	nextval('nota_fiscal_oc_rateio_seq')
				into STRICT	nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_sequencia
				;
				
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].dt_atualizacao := clock_timestamp();
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nm_usuario := nm_usuario_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].dt_atualizacao_nrec := clock_timestamp();
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nm_usuario_nrec := nm_usuario_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nota := nr_seq_nota_p;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_ordem_compra := r_C01_w.nr_ordem_compra;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_item_oci := r_C01_w.nr_item_oci;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nota_rateio := null;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_oc_nf_rateio := r_C01_w.nr_sequencia;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_estab_rateio := r_C01_w.cd_estab_rateio;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_empresa_rateio := r_C01_w.cd_empresa_rateio;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].vl_parcela := r_C01_w.vl_parcela;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].pr_parcela := r_C01_w.pr_parcela;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_condicao_pagamento := cd_condicao_pagamento_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_natureza_operacao := cd_natureza_operacao_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_operacao_nf := cd_operacao_nf_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].cd_serie_nf := cd_serie_nf_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_classif_fiscal := nr_seq_classif_fiscal_w;
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].ie_entrada_saida := 'S';
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].ie_situacao := 'A';
				nota_fiscal_oc_rateio_w[nr_reg_oc_rateio_w].nr_seq_nf_oc_rateio := null;
			end if;
		end loop;
		
		if (nota_fiscal_oc_rateio_w.count > 0) then
			forall i in nota_fiscal_oc_rateio_w.first .. nota_fiscal_oc_rateio_w.last
				insert into nota_fiscal_oc_rateio values nota_fiscal_oc_rateio_w(i);
		end if;
		
		nr_reg_fis_tran_w := 0;
		nr_reg_fis_item_w := 0;
		for r_C04_w in c04(nr_seq_nota_p, cd_estabelecimento_p) loop
			nr_seq_nota_nova_w := nr_seq_nota_nova_w + 1;
		
			select	nextval('nota_fiscal_transferencia_seq')
			into STRICT	nr_seq_nota_nova_w
			;

			vl_unitario_material_w := r_C04_w.vl_parcela / r_C04_w.qt_material;

			nr_nota_fiscal_e_w := nr_seq_nota_nova_w + 800001;
			nr_nota_fiscal_s_w := nr_seq_nota_nova_w + 900001;
			
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_sequencia := nr_seq_nota_nova_w;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_estabelecimento_e := r_C04_w.cd_estab_rateio;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_estabelecimento_s := cd_estabelecimento_p;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_cgc_e := r_C04_w.cd_cgc;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_cgc_s := r_C04_w.cd_cgc_emitente;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_serie_nf_e := r_C04_w.cd_serie_nf_e;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_serie_nf_s := r_C04_w.cd_serie_nf_s;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_nota_fiscal_e := nr_nota_fiscal_e_w;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_nota_fiscal_s := nr_nota_fiscal_s_w;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_operacao_nf_e := r_C04_w.cd_operacao_nf_e;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_operacao_nf_s := r_C04_w.cd_operacao_nf_s;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_emissao_e := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_emissao_s := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_entrada_saida_e := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_entrada_saida_s := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_atualizacao := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nm_usuario := nm_usuario_p;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].dt_atualizacao_nrec := clock_timestamp();
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nm_usuario_nrec := nm_usuario_p;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_condicao_pagamento_e := r_C04_w.cd_condicao_pagamento_e;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_condicao_pagamento_s := r_C04_w.cd_condicao_pagamento_s;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_natureza_operacao_e := r_C04_w.cd_natureza_operacao_e;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].cd_natureza_operacao_s := r_C04_w.cd_natureza_operacao_s;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_seq_nota_fiscal_origem := nr_seq_nota_p;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_seq_rateio_e := r_C04_w.nr_seq_rateio_e;
			nota_fiscal_transferencia_w[nr_reg_fis_tran_w].nr_seq_rateio_s := r_C04_w.nr_seq_rateio_s;
			
			-- Se ie_atualiza_conta_cont_oc_w for "O" ou "N"
			-- N - Nao atualiza conta contabil
			-- O - Atualiza com conta da Ordem de Compra somente
			cd_conta_contabil_e_w := r_C04_w.cd_conta_contabil;
			cd_conta_contabil_s_w := r_C04_w.cd_conta_contabil;
			
			cd_centro_custo_e_w := r_C04_w.cd_centro_custo;
			cd_centro_custo_s_w := r_C04_w.cd_centro_custo;
			
			cd_local_estoque_e_w := coalesce(r_C04_w.cd_local_estoque_e,r_C04_w.cd_local_estoque_s);
			cd_local_estoque_s_w := r_C04_w.cd_local_estoque_s;
			
			if (ie_atualiza_conta_cont_oc_w not in ('O','N')) then
			
				select	coalesce(max(ie_tipo_local),'0')
				into STRICT	ie_tipo_local_w
				from	local_estoque
				where	cd_local_estoque = cd_local_estoque_e_w;
			
				ie_tipo_conta_e_w := 3;
				if (coalesce(cd_centro_custo_cc_e_w::text, '') = '') and (ie_tipo_local_w <> '8') then
					ie_tipo_conta_e_w := 2;
				end if;
			
				-- Entrada
				SELECT * FROM define_conta_material(	cd_estabelecimento_p => r_C04_w.cd_estab_rateio, cd_material_p => r_c04_w.cd_material, ie_tipo_conta_p => ie_tipo_conta_e_w, ie_clinica_p => 0, cd_setor_atendimento_p => 0, ie_classif_convenio_p => 0, ie_tipo_atendimento_p => 0, ie_tipo_convenio_p => 0, cd_convenio_p => 0, cd_categoria_convenio_p => 0, cd_local_estoque_p => cd_local_estoque_e_w, cd_operacao_estoque_p => r_C04_w.cd_operacao_estoque_e, dt_vigencia_p => trunc(clock_timestamp()), cd_conta_contabil_p => cd_conta_contabil_cc_e_w, cd_centro_custo_p => cd_centro_custo_cc_e_w, cd_plano_p => 0) INTO STRICT cd_conta_contabil_p => cd_conta_contabil_cc_e_w, cd_centro_custo_p => cd_centro_custo_cc_e_w;
						
				select	coalesce(max(ie_tipo_local),'0')
				into STRICT	ie_tipo_local_w
				from	local_estoque
				where	cd_local_estoque = cd_local_estoque_s_w;
						
				ie_tipo_conta_s_w := 3;
				if (coalesce(cd_centro_custo_cc_s_w::text, '') = '') and (ie_tipo_local_w <> '8') then
					ie_tipo_conta_s_w := 2;
				end if;
						
				-- Saida
				SELECT * FROM define_conta_material(	cd_estabelecimento_p => cd_estabelecimento_p, cd_material_p => r_c04_w.cd_material, ie_tipo_conta_p => ie_tipo_conta_s_w, ie_clinica_p => 0, cd_setor_atendimento_p => 0, ie_classif_convenio_p => 0, ie_tipo_atendimento_p => 0, ie_tipo_convenio_p => 0, cd_convenio_p => 0, cd_categoria_convenio_p => 0, cd_local_estoque_p => cd_local_estoque_s_w, cd_operacao_estoque_p => r_C04_w.cd_operacao_estoque_s, dt_vigencia_p => trunc(clock_timestamp()), cd_conta_contabil_p => cd_conta_contabil_cc_s_w, cd_centro_custo_p => cd_centro_custo_cc_s_w, cd_plano_p => 0) INTO STRICT cd_conta_contabil_p => cd_conta_contabil_cc_s_w, cd_centro_custo_p => cd_centro_custo_cc_s_w;
			end if;
			
			-- Atualiza com conta da OC, se nao tiver busca dos parametros contabil
			if (ie_atualiza_conta_cont_oc_w = 'OP') then
				cd_conta_contabil_e_w := coalesce(cd_conta_contabil_e_w,cd_conta_contabil_cc_e_w);
				cd_centro_custo_e_w := coalesce(cd_centro_custo_e_w,cd_centro_custo_cc_e_w);
				
				cd_conta_contabil_s_w := coalesce(cd_conta_contabil_s_w,cd_conta_contabil_cc_s_w);
				cd_centro_custo_s_w := coalesce(cd_centro_custo_s_w,cd_centro_custo_cc_s_w);
			
			-- Atualiza com conta dos Parametros Contabil somente
			elsif (ie_atualiza_conta_cont_oc_w = 'P') then
				cd_conta_contabil_e_w := cd_conta_contabil_cc_e_w;
				cd_centro_custo_e_w := cd_centro_custo_cc_e_w;
				
				cd_conta_contabil_s_w := cd_conta_contabil_cc_s_w;
				cd_centro_custo_s_w := cd_centro_custo_cc_s_w;
			
			-- Atualiza com conta dos parametros contabil, se nao tiver busca da OC
			elsif (ie_atualiza_conta_cont_oc_w = 'S') then
				cd_conta_contabil_e_w := coalesce(cd_conta_contabil_cc_e_w,cd_conta_contabil_e_w);
				cd_centro_custo_e_w := coalesce(cd_centro_custo_cc_e_w,cd_centro_custo_e_w);
				
				cd_conta_contabil_s_w := coalesce(cd_conta_contabil_cc_s_w,cd_conta_contabil_s_w);
				cd_centro_custo_s_w := coalesce(cd_centro_custo_cc_s_w,cd_centro_custo_s_w);
			end if;
			
			select	nextval('nota_fiscal_transf_item_seq')
			into STRICT	nota_fiscal_transf_item_w[nr_reg_fis_item_w].nr_sequencia
			;
			
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_natureza_operacao_e := r_C04_w.cd_natureza_operacao_e;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_natureza_operacao_s := r_C04_w.cd_natureza_operacao_s;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].vl_unitario_item_nf := vl_unitario_material_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].vl_total_item_nf := r_C04_w.vl_parcela;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_material := r_C04_w.cd_material;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].vl_liquido := r_C04_w.vl_parcela;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].dt_atualizacao := clock_timestamp();
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].nm_usuario := nm_usuario_p;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].dt_atualizacao_nrec := clock_timestamp();
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].nm_usuario_nrec := nm_usuario_p;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].qt_item_trans := r_C04_w.qt_material;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].vl_desconto := 0;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].pr_desconto := 0;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].nr_seq_nota_fiscal_trans := nr_seq_nota_nova_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_local_estoque_e := cd_local_estoque_e_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_local_estoque_s := cd_local_estoque_s_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_centro_custo_e := cd_centro_custo_e_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_centro_custo_s := cd_centro_custo_s_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_conta_contabil_e := cd_conta_contabil_e_w;
			nota_fiscal_transf_item_w[nr_reg_fis_item_w].cd_conta_contabil_s := cd_conta_contabil_s_w;
		end loop;
		
		if (nota_fiscal_transferencia_w.count > 0) then
			forall i in nota_fiscal_transferencia_w.first .. nota_fiscal_transferencia_w.last
				insert into nota_fiscal_transferencia values nota_fiscal_transferencia_w(i);
		end if;
		
		if (nota_fiscal_transf_item_w.count > 0) then
			forall i in nota_fiscal_transf_item_w.first .. nota_fiscal_transf_item_w.last
				insert into nota_fiscal_transf_item values nota_fiscal_transf_item_w(i);
		end if;
		
		-- Gravar a nova nota fiscal gerada
		open c05;
		loop
		fetch c05 bulk collect into
			tb_nr_seq_nota_transf_w, tb_nr_seq_rateio_e_w, tb_nr_seq_rateio_s_w limit 5000;

			forall i in tb_nr_seq_nota_transf_w.first..tb_nr_seq_nota_transf_w.last
				update	nota_fiscal_oc_rateio
				set	nr_seq_nota_transf	= tb_nr_seq_nota_transf_w(i),
					ie_situacao		= 'N'
				where	nr_sequencia 		in (tb_nr_seq_rateio_e_w(i),tb_nr_seq_rateio_s_w(i));
				
			tb_nr_seq_nota_transf_w.delete;
			tb_nr_seq_rateio_e_w.delete;
			tb_nr_seq_rateio_s_w.delete;
				
		EXIT WHEN NOT FOUND; /* apply on c05 */
		end loop;
		close c05;
	end if;
end if;

if (coalesce(ie_commit_p,'N') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rateio_nf_ordem_compra ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nr_ordem_compra_p ordem_compra.nr_ordem_compra%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_commit_p text default 'N') FROM PUBLIC;

