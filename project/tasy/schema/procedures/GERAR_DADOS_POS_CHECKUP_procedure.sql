-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dados_pos_checkup ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w	bigint;
qt_w		bigint;


BEGIN

select	count(*)
into STRICT	qt_w
from	checkup_dado_estat
where	nr_atendimento	= nr_atendimento_p
and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_p);

if (coalesce(qt_w,0) > 0) then
	-- Nao e possivel inserir dois pos checkup para um mesmo dia!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264456);
end if;

insert into checkup_dado_estat(
	nr_sequencia,
	nr_atendimento,
	dt_atualizacao,
	nm_usuario,
	nr_seq_tipo_dado,
	cd_pessoa_fisica,
	dt_registro,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_apres,
	ie_pos_checkup,
	qt_dado,
	ds_dado,
	dt_referencia)
SELECT	nextval('checkup_dado_estat_seq'),
	nr_atendimento_p,
	clock_timestamp(),
	nm_usuario_p,
	a.nr_seq_tipo_dado,
	obter_Dados_Usuario_Opcao(nm_usuario_p,'C'),
	dt_referencia_p,
	clock_timestamp(),
	nm_usuario_p,
	a.nr_seq_apres,
	'S',
	null qt_dado,
	null ds_dado,
	dt_referencia_p
from	checkup_dado_estat a
where	nr_atendimento	= nr_atendimento_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dados_pos_checkup ( nr_atendimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

