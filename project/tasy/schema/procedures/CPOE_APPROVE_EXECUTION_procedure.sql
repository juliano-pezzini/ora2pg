-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_approve_execution (nr_sequencia_p bigint, ie_tipo_item_cpoe_p text, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type;

c01 CURSOR FOR
  SELECT distinct
    b.nr_atendimento,
    a.nr_prescricao,
    a.nr_sequencia
  from prescr_procedimento a,
    prescr_medica b
  where a.nr_seq_proc_cpoe = nr_sequencia_p
  and a.nr_prescricao = b.nr_prescricao;

BEGIN

  if (ie_tipo_item_cpoe_p = 'P' and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')) then

    cd_pessoa_fisica_w := obter_dados_usuario_opcao(nm_usuario_p, 'C');

    update cpoe_procedimento
    set dt_special_approval = clock_timestamp(),
    nm_usuario_approval = nm_usuario_p
    where nr_sequencia = nr_sequencia_p;

    if (obter_se_medico(cd_pessoa_fisica_w, 'M') = 'S') then

      update cpoe_procedimento
      set dt_ciencia_medico = clock_timestamp(),
      nm_usuario_ciencia = nm_usuario_p
      where nr_sequencia = nr_sequencia_p
      and ie_exige_ciencia = 'S';

    end if;

    update prescr_procedimento
    set ie_status_execucao = 10
    where nr_seq_proc_cpoe = nr_sequencia_p;

    for c01_w in c01 loop

      CALL wl_gerar_finalizar_tarefa(
          cd_categoria_p => 'SA',
          ie_acao_p => 'F',
          nr_atendimento_p => c01_w.nr_atendimento,
          cd_pessoa_fisica_p => cd_pessoa_fisica_w,
          nm_usuario_p => nm_usuario_p,
          dt_final_previsto_p => clock_timestamp(),
          nr_prescricao_p => c01_w.nr_prescricao,
          nr_seq_prescr_proc_p => c01_w.nr_sequencia);

    end loop;

    commit;

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_approve_execution (nr_sequencia_p bigint, ie_tipo_item_cpoe_p text, nm_usuario_p text) FROM PUBLIC;

