-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gravar_preventivas ( nr_seq_planej_prev_p bigint, nr_seq_equipamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_prev_w1		timestamp;
dt_prev_w2		timestamp;
dt_prev_w3		timestamp;
dt_prev_w4		timestamp;
dt_prev_w5		timestamp;
dt_prev_w6		timestamp;
dt_prev_w7		timestamp;
dt_prev_w8		timestamp;
dt_prev_w9		timestamp;
dt_prev_w10		timestamp;
dt_prev_w11		timestamp;
dt_prev_w12		timestamp;
dt_prev_w13		timestamp;
dt_prev_w14		timestamp;
dt_prev_w15		timestamp;
dt_prev_w16		timestamp;
dt_prev_w17		timestamp;
dt_prev_w18		timestamp;
dt_prev_w19		timestamp;
dt_prev_w20		timestamp;
dt_prev_w21		timestamp;
dt_prev_w22		timestamp;
dt_prev_w23		timestamp;
dt_prev_w24		timestamp;
dt_aux_w		timestamp;
dt_aux_desejado_w	timestamp;
nr_seq_regra_data_w	bigint;
qt_insere_w		bigint := 0;


BEGIN

begin
select	trunc(a.dt_prevista1),
	trunc(a.dt_prevista2),
	trunc(a.dt_prevista3),
	trunc(a.dt_prevista4),
	trunc(a.dt_prevista5),
	trunc(a.dt_prevista6),
	trunc(a.dt_prevista7),
	trunc(a.dt_prevista8),
	trunc(a.dt_prevista9),
	trunc(a.dt_prevista10),
	trunc(a.dt_prevista11),
	trunc(a.dt_prevista12),
	trunc(a.dt_prevista13),
	trunc(a.dt_prevista14),
	trunc(a.dt_prevista15),
	trunc(a.dt_prevista16),
	trunc(a.dt_prevista17),
	trunc(a.dt_prevista18),
	trunc(a.dt_prevista19),
	trunc(a.dt_prevista20),
	trunc(a.dt_prevista21),
	trunc(a.dt_prevista22),
	trunc(a.dt_prevista23),
	trunc(a.dt_prevista24)
into STRICT	dt_prev_w1,
	dt_prev_w2,
	dt_prev_w3,
	dt_prev_w4,
	dt_prev_w5,
	dt_prev_w6,
	dt_prev_w7,
	dt_prev_w8,
	dt_prev_w9,
	dt_prev_w10,
	dt_prev_w11,
	dt_prev_w12,
	dt_prev_w13,
	dt_prev_w14,
	dt_prev_w15,
	dt_prev_w16,
	dt_prev_w17,
	dt_prev_w18,
	dt_prev_w19,
	dt_prev_w20,
	dt_prev_w21,
	dt_prev_w22,
	dt_prev_w23,
	dt_prev_w24
from	man_planej_data_prev a
where	a.nr_seq_planej_prev = nr_seq_planej_prev_p
and	a.nr_seq_equipamento = nr_seq_equipamento_p
and	a.nm_usuario = nm_usuario_p
and	not exists (	SELECT	1
			from	man_regra_data_frequencia x
			where	x.nr_seq_equipamento = a.nr_seq_equipamento
			and	x.nr_seq_planej_prev = a.nr_seq_planej_prev
			and	x.dt_geracao in (	a.dt_prevista1,a.dt_prevista3,a.dt_prevista5,
							a.dt_prevista7,a.dt_prevista9, a.dt_prevista11,
							a.dt_prevista13,a.dt_prevista15,a.dt_prevista17,
							a.dt_prevista19,a.dt_prevista21,a.dt_prevista23));
exception
when others then
	/*(-20011,'JÃ¡ existem datas geradas para este equipamento. Verifique a pasta de regra de data fixa.')*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(263138);
end;

while(qt_insere_w <= 11)  loop
	begin
	qt_insere_w	:= qt_insere_w + 1;

	if (qt_insere_w = 1) then
		dt_aux_w		:= dt_prev_w1;
		dt_aux_desejado_w	:= dt_prev_w2;
	elsif (qt_insere_w = 2) then
		dt_aux_w		:= dt_prev_w3;
		dt_aux_desejado_w	:= dt_prev_w4;
	elsif (qt_insere_w = 3) then
		dt_aux_w		:= dt_prev_w5;
		dt_aux_desejado_w	:= dt_prev_w6;
	elsif (qt_insere_w = 4) then
		dt_aux_w		:= dt_prev_w7;
		dt_aux_desejado_w	:= dt_prev_w8;
	elsif (qt_insere_w = 5) then
		dt_aux_w		:= dt_prev_w9;
		dt_aux_desejado_w	:= dt_prev_w10;
	elsif (qt_insere_w = 6) then
		dt_aux_w		:= dt_prev_w11;
		dt_aux_desejado_w	:= dt_prev_w12;
	elsif (qt_insere_w = 7) then
		dt_aux_w		:= dt_prev_w13;
		dt_aux_desejado_w	:= dt_prev_w14;
	elsif (qt_insere_w = 8) then
		dt_aux_w		:= dt_prev_w15;
		dt_aux_desejado_w	:= dt_prev_w16;
	elsif (qt_insere_w = 9) then
		dt_aux_w		:= dt_prev_w17;
		dt_aux_desejado_w	:= dt_prev_w18;
	elsif (qt_insere_w = 10) then
		dt_aux_w		:= dt_prev_w19;
		dt_aux_desejado_w	:= dt_prev_w20;
	elsif (qt_insere_w = 11) then
		dt_aux_w		:= dt_prev_w21;
		dt_aux_desejado_w	:= dt_prev_w22;
	elsif (qt_insere_w = 12) then
		dt_aux_w		:= dt_prev_w23;
		dt_aux_desejado_w	:= dt_prev_w24;
	end if;

	select	nextval('man_regra_data_frequencia_seq')
	into STRICT	nr_seq_regra_data_w
	;

	insert	into man_regra_data_frequencia(
			nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_geracao,
			dt_inicio_desejado,
			ie_data_hora,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_equipamento,
			nr_seq_planej_prev)
		values (nr_seq_regra_data_w,
			clock_timestamp(),
			clock_timestamp(),
			dt_aux_w,
			dt_aux_desejado_w,
			'D',
			nm_usuario_p,
			nm_usuario_p,
			nr_seq_equipamento_p,
			nr_seq_planej_prev_p);
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gravar_preventivas ( nr_seq_planej_prev_p bigint, nr_seq_equipamento_p bigint, nm_usuario_p text) FROM PUBLIC;

