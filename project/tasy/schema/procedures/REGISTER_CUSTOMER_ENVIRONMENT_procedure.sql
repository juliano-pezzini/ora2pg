-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE register_customer_environment (ie_production_p text, ds_environment_p text, nm_usuario_p text) AS $body$
DECLARE

  nm_database_w varchar(255);
  ds_server_host_w varchar(255);
  ds_log_w varchar(4000);
  MAX_LOG_LENGTH_W CONSTANT integer := 4000;

BEGIN	
  begin
    select sys_context('USERENV', 'DB_NAME'),
           sys_context('USERENV', 'SERVER_HOST')
    into STRICT   nm_database_w,
           ds_server_host_w
;

    insert into tasy_customer_environment(
      nr_sequencia,
      nm_database,
      ds_server_host,
      ds_environment,
      ie_production,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      dt_atualizacao,
      nm_usuario)
    values (
      nextval('tasy_customer_environment_seq'),
      nm_database_w,
      ds_server_host_w,
      substr(ds_environment_p, 1, 50),
      ie_production_p,
      clock_timestamp(),
      coalesce(nm_usuario_p, 'Tasy'),
      clock_timestamp(),
      coalesce(nm_usuario_p, 'Tasy')			
    );
    commit;	
  exception
    when others then
      ds_log_w := substr('Database: ' || nm_database_w || '; Server host: ' || ds_server_host_w || 'Environment: ' || ds_environment_p ||
                         '; Production: ' || ie_production_p || '; Exception: ' || SQLERRM, 1, MAX_LOG_LENGTH_W);
      CALL register_version_track_log(1, ds_log_w, nm_usuario_p);
      RAISE EXCEPTION '%', ds_log_w USING ERRCODE = '45011';
  end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE register_customer_environment (ie_production_p text, ds_environment_p text, nm_usuario_p text) FROM PUBLIC;

