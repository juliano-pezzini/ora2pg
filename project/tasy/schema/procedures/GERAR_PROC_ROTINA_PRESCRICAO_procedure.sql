-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proc_rotina_prescricao ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text, dt_prevista_exec_p timestamp, ds_dado_clinico_p text, ds_exame_fisico_p text, cd_funcao_p bigint, qt_procedimento_p bigint, ie_sel_hor_rotina_p text, ie_urgencia_p text, ie_dia_seguinte_p text, ds_justificativa_fim_p text, nr_seq_condicao_exame_p bigint, hr_prescricao_p text, dt_prescricao_p timestamp, cd_medico_exec_p text, ie_acm_p text default 'N', nr_seq_prescr_p INOUT text DEFAULT NULL) AS $body$
DECLARE

									 
cd_doenca_cid_w				varchar(10);
ds_exame_dia_w				varchar(4000);
nr_seq_prescr_w				varchar(4000);
nr_seq_prescr_ww			varchar(4000);
cd_especialidade_w			bigint;
cd_grupo_proc_w				bigint;
cd_intervalo_w				varchar(7);
cd_material_exame_w			varchar(4000);
cd_medico_exec_w			varchar(10);
cd_procedimento_w			bigint;
ds_cor_w					varchar(15);
ds_forma_w					varchar(2000);
ds_frase_w					varchar(2000);
ds_indicacao_w				varchar(2000);
ds_inf_adicional_w			varchar(2000);
ds_justificativa_w			varchar(2000);
ds_lista_kit_w				varchar(4000);
ds_dado_clinico_w			varchar(2000);
ds_lista_mat_exame_w		varchar(2000);
ds_material_especial_w		varchar(2000);
ds_observacao_w				varchar(2000);
ie_anestesia_w				varchar(1);
ie_lado_w					varchar(1);
ie_forma_exame_w			varchar(15);
ie_origem_proced_w			bigint;
ie_tipo_w					bigint;
ie_urgencia_w				varchar(1);
nr_seq_apres_w				integer;
nr_seq_condicao_exame_w		bigint;
nr_seq_contraste_w     bigint;
nr_seq_exame_w       bigint;
nr_seq_material_w      bigint;
nr_seq_ordem_w       bigint;
nr_seq_proc_interno_w    bigint;
nr_seq_proc_rotina_w    bigint;
nr_seq_prot_glic_w     bigint;
nr_seq_topografia_w     bigint;
cd_setor_atendimento_w		integer;
ie_beira_leito_w			varchar(1);
ds_lista_proced_w			varchar(4000);
cd_cgc_externo_w			varchar(20);
ds_lista_mat_proced_w		varchar(4000);
cd_material_w				varchar(15);
ie_pos_virgula_w			bigint;
nr_seq_subtipo_w			bigint;
cd_protocolo_w				bigint;
nr_seq_proc_w				bigint;
nr_sequencia_w				bigint;

c01 CURSOR FOR 
SELECT	cd_doenca_cid, 
		cd_especialidade, 
		cd_grupo_proc, 
		cd_intervalo, 
		cd_material_exame, 
		cd_medico_exec, 
		cd_procedimento, 
		ds_forma, 
		ds_frase, 
		ds_indicacao, 
		ds_inf_adicional, 
		ds_justificativa, 
		ds_lista_kit, 
		ds_lista_mat_exame, 
		ds_material_especial, 
		ds_observacao, 
		ie_anestesia, 
		ie_lado, 
		ie_forma_exame, 
		ie_origem_proced, 
		ie_tipo, 
		coalesce(ie_urgencia,'N'), 
		nr_seq_condicao_exame, 
		nr_seq_contraste, 
		nr_seq_exame, 
		nr_seq_material, 
		nr_seq_ordem, 
		nr_seq_proc_interno, 
		nr_seq_proc_rotina, 
		nr_seq_prot_glic, 
		nr_seq_topografia, 
		cd_setor_atendimento, 
		coalesce(ie_beira_leito,'N'), 
		ds_lista_proced, 
		ds_lista_material, 
		cd_protocolo, 
		nr_seq_subtipo, 
		nr_seq_proc, 
		cd_cgc_externo, 
		nr_sequencia 
from	w_proc_rotina_esp_t 
where	nm_usuario = nm_usuario_p 
and		coalesce(ie_marcado,'N') = 'S';


BEGIN 
 
open c01;
loop 
fetch c01 into	cd_doenca_cid_w, 
				cd_especialidade_w, 
				cd_grupo_proc_w, 
				cd_intervalo_w, 
				cd_material_exame_w, 
				cd_medico_exec_w, 
				cd_procedimento_w, 
				ds_forma_w, 
				ds_frase_w, 
				ds_indicacao_w, 
				ds_inf_adicional_w, 
				ds_justificativa_w, 
				ds_lista_kit_w, 
				ds_lista_mat_exame_w, 
				ds_material_especial_w, 
				ds_observacao_w, 
				ie_anestesia_w, 
				ie_lado_w, 
				ie_forma_exame_w, 
				ie_origem_proced_w, 
				ie_tipo_w, 
				ie_urgencia_w, 
				nr_seq_condicao_exame_w, 
				nr_seq_contraste_w, 
				nr_seq_exame_w, 
				nr_seq_material_w, 
				nr_seq_ordem_w, 
				nr_seq_proc_interno_w, 
				nr_seq_proc_rotina_w, 
				nr_seq_prot_glic_w, 
				nr_seq_topografia_w, 
				cd_setor_atendimento_w, 
				ie_beira_leito_w, 
				ds_lista_proced_w, 
				ds_lista_mat_proced_w, 
				cd_protocolo_w, 
				nr_seq_subtipo_w, 
				nr_seq_proc_w, 
				cd_cgc_externo_w, 
				nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_dado_clinico_w := '';
	if (nr_seq_proc_interno_w = 0) then 
		nr_seq_proc_interno_w := null;
	end if;
	 
	if (ie_tipo_w = 7) then 
	CALL copiar_exame_med_protocolo( 
				nr_atendimento_p, 
				cd_protocolo_w, 
				nr_seq_subtipo_w, 
				nr_seq_proc_w, 
				24, 
				nr_prescricao_p, 
				to_date(to_char(coalesce(dt_prescricao_p,clock_timestamp()),'dd/mm/yyyy')||' '||hr_prescricao_p,'dd/mm/yyyy hh24:mi:ss'), 
				dt_prescricao_p, 
				dt_prevista_exec_p, 
				nm_usuario_p,	 
				ie_lado_w, 
				ds_dado_clinico_p, 
				cd_cgc_externo_w, 
				ds_material_especial_w, 
				cd_medico_exec_p);	
	else 
		if (ds_frase_w IS NOT NULL AND ds_frase_w::text <> '') and (ds_frase_w <> '0') then 
			ds_dado_clinico_w := ds_frase_w||chr(13);
		end if;
		 
		ds_dado_clinico_w := ds_dado_clinico_w||ds_dado_clinico_p;
		 
		if (ds_indicacao_w IS NOT NULL AND ds_indicacao_w::text <> '') then 
			ds_dado_clinico_w := ds_dado_clinico_w||ds_indicacao_w;
		end if;
		 
		if (ie_urgencia_p = 'S') then 
			ie_urgencia_w := ie_urgencia_p;
		else 
			ie_urgencia_w := ie_urgencia_p;
		end if;
		 
		 
		if (ds_justificativa_fim_p IS NOT NULL AND ds_justificativa_fim_p::text <> '') then 
			ds_justificativa_w := ds_justificativa_fim_p;
		end if;
		 
		if (nr_seq_condicao_exame_p IS NOT NULL AND nr_seq_condicao_exame_p::text <> '') and (nr_seq_condicao_exame_p > 0) then 
			nr_seq_condicao_exame_w := nr_seq_condicao_exame_p;
		end if;
		 
		if (coalesce(ds_lista_mat_exame_w::text, '') = '') and (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then 
			ds_lista_mat_exame_w := cd_material_exame_w;
		elsif (coalesce(ds_lista_mat_exame_w::text, '') = '') and (coalesce(cd_material_exame_w::text, '') = '') then 
			 ds_lista_mat_exame_w := '0';
			 cd_material_exame_w := '0';
		end if;
		 
		while(ds_lista_mat_exame_w IS NOT NULL AND ds_lista_mat_exame_w::text <> '') or (ds_lista_mat_exame_w <> '') loop 
			ie_pos_virgula_w	:= position(',' in ds_lista_mat_exame_w);
			if (ie_pos_virgula_w > 0) then 
				cd_material_exame_w   := substr(ds_lista_mat_exame_w,1,(ie_pos_virgula_w - 1));
			else 
				cd_material_exame_w   := ds_lista_mat_exame_w;
			end if;		
			SELECT * FROM gerar_Exame_Rotina_Prescricao(	nr_prescricao_p, nr_seq_proc_rotina_w, ie_tipo_w, dt_prevista_exec_p, cd_intervalo_w, ds_dado_clinico_w, ds_forma_w, ds_exame_fisico_p, cd_doenca_cid_w, nm_usuario_p, cd_material_exame_w, coalesce(cd_medico_exec_w,cd_medico_exec_p), qt_procedimento_p, ie_lado_w, nr_seq_topografia_w, nr_seq_prot_glic_w, cd_funcao_p, cd_setor_atendimento_w, ds_observacao_w, ie_beira_leito_w, ie_sel_hor_rotina_p, ds_lista_proced_w, nr_seq_prescr_ww, ie_dia_seguinte_p, ds_justificativa_w, ie_urgencia_w, nr_seq_condicao_exame_w, cd_cgc_externo_w, ds_material_especial_w, ds_lista_mat_proced_w, ie_anestesia_w, ie_forma_exame_w, cd_procedimento_w, nr_seq_proc_interno_w, ie_origem_proced_w, ds_lista_kit_w, nr_seq_exame_w, ds_exame_dia_w, nr_seq_contraste_w, null, null, ie_acm_p, null) INTO STRICT nr_seq_prescr_ww, ds_exame_dia_w;
											 
			if (ds_exame_dia_w IS NOT NULL AND ds_exame_dia_w::text <> '') then 
				--- O exame #@DS_EXAME_DIA#@ n√£o pode ser prescrito neste dia. 
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(268289,'DS_EXAME_DIA='||ds_exame_dia_w);
			end if;
			 
			if (nr_seq_prescr_ww IS NOT NULL AND nr_seq_prescr_ww::text <> '') then 
				if (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') then 
					nr_seq_prescr_w := substr(nr_seq_prescr_w||','||nr_seq_prescr_ww,1,4000);
				else 
					nr_seq_prescr_w := nr_seq_prescr_ww;
				end if;
			end if;
			if (ie_pos_virgula_w > 0) then 
				ds_lista_mat_exame_w := substr(ds_lista_mat_exame_w,(ie_pos_virgula_w + 1),2000);
			else 
				ds_lista_mat_exame_w := null;
			end if;
		end loop;
	end if;
	update	w_proc_rotina_esp_t 
	set		ie_marcado = 'N' 
	where	nr_sequencia = nr_sequencia_w;
	commit;
end loop;
close c01;
nr_seq_prescr_p := substr(nr_seq_prescr_w,1,255);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proc_rotina_prescricao ( nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text, dt_prevista_exec_p timestamp, ds_dado_clinico_p text, ds_exame_fisico_p text, cd_funcao_p bigint, qt_procedimento_p bigint, ie_sel_hor_rotina_p text, ie_urgencia_p text, ie_dia_seguinte_p text, ds_justificativa_fim_p text, nr_seq_condicao_exame_p bigint, hr_prescricao_p text, dt_prescricao_p timestamp, cd_medico_exec_p text, ie_acm_p text default 'N', nr_seq_prescr_p INOUT text DEFAULT NULL) FROM PUBLIC;

