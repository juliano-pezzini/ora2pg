-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_administrar_item_dialise ( cd_material_p bigint, nr_seq_dialise_p bigint, qt_material_p bigint, qt_saldo_p bigint, nr_seq_lote_fornec_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_horario_w	bigint;
nr_seq_map_w		bigint;
nr_seq_lote_fornec_w	bigint;
dt_horario_adm_w	timestamp;

C01 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		a.nr_seq_lote_fornec 
	FROM	prescr_material a, 
	    prescr_mat_hor b 
	WHERE	a.nr_prescricao   	= b.nr_prescricao 
	AND   a.nr_sequencia   	= b.nr_seq_material 
	AND   b.nr_seq_dialise  	= nr_seq_dialise_p 
	AND	b.cd_material		= cd_material_p 
	AND	qt_saldo_p		< qt_material_p 
	AND   coalesce(b.dt_fim_horario::text, '') = '' 
	AND 	((a.ie_agrupador = 13) OR 
		 ((a.ie_agrupador in (1,2,14)) AND (coalesce(nr_sequencia_solucao::text, '') = '') 
					AND (coalesce(nr_sequencia_proc::text, '') = '') 
					AND (coalesce(nr_sequencia_dieta::text, '') = '') 
					AND (coalesce(nr_sequencia_diluicao::text, '') = ''))) 
	AND	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';


BEGIN 
 
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	nr_seq_horario_w, 
	nr_seq_lote_fornec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
 
	UPDATE	prescr_mat_hor 
	SET	dt_fim_horario	= clock_timestamp(), 
		nm_usuario_adm	= nm_usuario_p, 
		nr_seq_lote_fornec = coalesce(nr_seq_lote_fornec_p, nr_seq_lote_fornec_w) 
	WHERE	nr_sequencia	= nr_seq_horario_w 
	AND	coalesce(dt_fim_horario::text, '') = '' 
	AND	coalesce(dt_suspensao::text, '') = '';
 
	nr_seq_map_w := gerar_estornar_adep_map(NULL, nr_seq_horario_w, NULL, 'G', clock_timestamp(), nm_usuario_p, nr_seq_map_w, null, null, null);
 
	END;
END LOOP;
CLOSE C01;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_administrar_item_dialise ( cd_material_p bigint, nr_seq_dialise_p bigint, qt_material_p bigint, qt_saldo_p bigint, nr_seq_lote_fornec_p bigint, nm_usuario_p text) FROM PUBLIC;

