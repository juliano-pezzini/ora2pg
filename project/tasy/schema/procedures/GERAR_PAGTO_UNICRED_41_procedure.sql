-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_unicred_41 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w		varchar(500);
cd_estabelecimento_w	banco_escritural.cd_estabelecimento%type;

/* Header de arquivo */

dt_remessa_retorno_w	timestamp;
qt_registro_w		bigint;
vl_total_remessa_w	double precision;

/* Registro */

nr_conta_w		titulo_pagar_escrit.nr_conta%type;
vl_escritural_w		titulo_pagar_escrit.vl_escritural%type;
dt_vencimento_atual_w	titulo_pagar.dt_vencimento_atual%type;

c01 CURSOR FOR
SELECT	substr(a.nr_conta,1,5) ||'-'|| substr(a.ie_digito_conta,1,1),
	a.vl_escritural,
	b.dt_vencimento_atual
from	titulo_pagar b,
	titulo_pagar_escrit a
where	a.nr_titulo		= b.nr_titulo
and	a.nr_seq_escrit		= nr_seq_envio_p;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* Header do arquivo */

select	coalesce(max(a.dt_remessa_retorno),clock_timestamp()),
	max(a.cd_estabelecimento)
into STRICT	dt_remessa_retorno_w,
	cd_estabelecimento_w
from	banco_escritural a
where	a.nr_sequencia		= nr_seq_envio_p;

select	count(*),
	sum(a.vl_escritural)
into STRICT	qt_registro_w,
	vl_total_remessa_w
from	titulo_pagar_escrit a
where	a.nr_seq_escrit		= nr_seq_envio_p;

ds_conteudo_w	:=	to_char(dt_remessa_retorno_w,'yymmdd') ||
			lpad(qt_registro_w,4,'0') ||
			lpad('0',9,'0') ||
			lpad(somente_numero(to_char(coalesce(vl_total_remessa_w,0),'99999999999990.00')),16,'0');

insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nextval('w_envio_banco_seq'));

/* Registro */

open	c01;
loop
fetch	c01 into
	nr_conta_w,
	vl_escritural_w,
	dt_vencimento_atual_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_conteudo_w	:=	lpad(nr_conta_w,7,'0') ||
				'865' ||
				lpad('0',9,'0') ||
				lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'99999999999990.00')),16,'0') ||
				to_char(dt_vencimento_atual_w ,'yymmdd');

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nextval('w_envio_banco_seq'));

end	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_unicred_41 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

