-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_rest_receive_standard ( ds_message_p text, ie_evento_p text, nr_seq_sistema_p bigint, ie_method_p text, NR_SEQUENCIA_P INOUT bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_evento_sistema_w	intpd_eventos_sistema.nr_sequencia%type;
ds_procedure_w			intpd_eventos_sistema.ds_procedure%type;


BEGIN
/*Necessário para um to_char não retirar a hora da data nas rotinas que recebem valores desse tipo de dado*/

EXECUTE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY HH24:MI:SS''';


begin
	select	b.nr_sequencia
	into STRICT	nr_seq_evento_sistema_w
	from	intpd_eventos a,
			intpd_eventos_sistema b
	where	b.nr_seq_evento = a.nr_sequencia
	and		exists (SELECT	1
					from	intpd_config_eventos x
					where	x.ie_evento = a.ie_evento
					and		x.ie_envia_recebe = 'R')
	and		a.ie_situacao = 'A'
	and		b.ie_situacao = 'A'
	and		a.ie_evento = ie_evento_p
	and		b.nr_seq_sistema = nr_seq_sistema_p
	and		b.ie_protocolo_integracao = 'REST'  LIMIT 1;
exception
when others then
	nr_seq_evento_sistema_w	:=	0;
end;


if (nr_seq_evento_sistema_w > 0) then
	select	nextval('intpd_fila_transmissao_seq')
	into STRICT	nr_sequencia_w
	;

	insert into intpd_fila_transmissao(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_evento,
		nr_seq_documento,
		ie_status,
		nr_seq_evento_sistema,
		ds_message,
		ie_envio_recebe)
	values (	nr_sequencia_w,
		clock_timestamp(),
		'INTPDTASY',
		clock_timestamp(),
		'INTPDTASY',
		ie_evento_p,
		0,
		'P',
		nr_seq_evento_sistema_w,
		ds_message_p,
		'R');
	commit;

	/*wheb_usuario_pck.set_ie_executar_trigger('N');

	begin

		select	ds_procedure
		into	ds_procedure_w
		from	intpd_eventos_sistema
		where	nr_sequencia = nr_seq_evento_sistema_w;

		if	(nvl(ds_procedure_w,'NULL') <> 'NULL') then
			exec_sql_dinamico('INTPDTASY', 'declare begin ' || ds_procedure_w || '(' || nr_sequencia_w || '); end;');
		else
			update	intpd_fila_transmissao
			set		ie_status_http = '200'
			where	nr_sequencia = nr_sequencia_w;
		end if;

	exception
	when others then
		wheb_usuario_pck.set_ie_executar_trigger('S');
		wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);
	end;*/
end if;


--wheb_usuario_pck.set_ie_executar_trigger('S');
--commit;
nr_sequencia_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_rest_receive_standard ( ds_message_p text, ie_evento_p text, nr_seq_sistema_p bigint, ie_method_p text, NR_SEQUENCIA_P INOUT bigint) FROM PUBLIC;

