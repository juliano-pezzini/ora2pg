-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_sv_pepo ( nr_cirurgia_p bigint, dt_sinal_vital_p timestamp, ds_erro_p INOUT text) AS $body$
DECLARE


                              
cd_perfil_w             perfil.cd_perfil%type   := wheb_usuario_pck.get_cd_perfil;
nm_usuario_w            usuario.nm_usuario%type := wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w    estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
qt_horas_passado_sv_w   parametro_medico.qt_horas_passado_sv%type := 12;
ie_consiste_periodo_w   varchar(15);
qt_min_antes_w          bigint := 10;
				

BEGIN

ie_consiste_periodo_w := obter_param_usuario(872, 167, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_consiste_periodo_w);
qt_min_antes_w := obter_param_usuario(872, 118, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, qt_min_antes_w);

select   coalesce(max(qt_horas_passado_sv),12)
into STRICT     qt_horas_passado_sv_w
from     parametro_medico
where    cd_estabelecimento = cd_estabelecimento_w;

if (coalesce(nr_cirurgia_p,0) > 0) then
   if (ie_consiste_periodo_w = 'S') then
      if (consiste_data_sinal_vital(nr_cirurgia_p,dt_sinal_vital_p,coalesce(qt_min_antes_w,10)) = 'N') then
         ds_erro_p := wheb_mensagem_pck.get_texto(91044,null);
      end if;
   end if;
end if;

if (dt_sinal_vital_p > clock_timestamp()) or (dt_sinal_vital_p < (clock_timestamp() - (qt_horas_passado_sv_w/24)   )) then
   ds_erro_p := wheb_mensagem_pck.get_texto(91048,'QT_HORAS='||qt_horas_passado_sv_w);
end if;
   
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_sv_pepo ( nr_cirurgia_p bigint, dt_sinal_vital_p timestamp, ds_erro_p INOUT text) FROM PUBLIC;

