-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_cih (nr_atendimento_p bigint, dt_alta_p timestamp, cd_medico_p text, cd_cid_primario_p text, cd_cid_secundario_p text, ie_tipo_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w	bigint;
dt_diagnostico_w	timestamp;
ie_ignora_tipo_diag_w	varchar(1);
ie_liberar_auto_cih_w	varchar(1);
cd_estab_w		bigint;
dt_diagnostico_ww	timestamp;	

BEGIN
cd_estab_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento, 0);
ie_ignora_tipo_diag_w := coalesce(Obter_Valor_Param_Usuario(916, 711, Obter_perfil_Ativo, nm_usuario_p, cd_estab_w),'N');
ie_liberar_auto_cih_w := Obter_Valor_Param_Usuario(916, 1150, Obter_perfil_Ativo, nm_usuario_p, cd_estab_w);

dt_diagnostico_w	:= clock_timestamp();

select	coalesce(max(nr_atendimento),0)
into STRICT	nr_atendimento_w
from	diagnostico_medico
where 	nr_atendimento = nr_atendimento_p
and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_p) = ie_tipo_atendimento_p
and 	ie_tipo_diagnostico IN (2, 3);

if (nr_atendimento_w <> 0)
and (ie_ignora_tipo_diag_w = 'S') then
	dt_diagnostico_ww := dt_diagnostico_w;
else	
	dt_diagnostico_ww := coalesce(dt_alta_p,dt_diagnostico_w);
end if;

if (nr_atendimento_w = 0)
or (ie_ignora_tipo_diag_w = 'S') then	
	begin
	insert into diagnostico_medico(nr_atendimento, dt_diagnostico, ie_tipo_diagnostico, cd_medico,
					dt_atualizacao, nm_usuario, ds_diagnostico)
	values (nr_atendimento_p, dt_diagnostico_ww, 2, cd_medico_p,
		clock_timestamp(), nm_usuario_p, null);

	if (length(cd_cid_primario_p) > 0) then
		insert into diagnostico_doenca(nr_atendimento, dt_diagnostico, cd_doenca,
						dt_atualizacao, nm_usuario, ds_diagnostico,
						ie_classificacao_doenca, dt_liberacao, ie_situacao)
		values (nr_atendimento_p, dt_diagnostico_ww, cd_cid_primario_p, 
			clock_timestamp(), nm_usuario_p, null, 'P', CASE WHEN ie_liberar_auto_cih_w='S' THEN clock_timestamp()  ELSE null END , 'A');
	end if;

	if (length(cd_cid_secundario_p) > 0) and (cd_cid_secundario_p <> cd_cid_primario_p) then /* Rafael em 30/05/2007 OS58180 */
		insert into diagnostico_doenca(nr_atendimento, dt_diagnostico, cd_doenca,
						dt_atualizacao, nm_usuario, ds_diagnostico,
						ie_classificacao_doenca, dt_liberacao, ie_situacao)
		values (nr_atendimento_p, dt_diagnostico_ww, cd_cid_secundario_p, 
			clock_timestamp(), nm_usuario_p, null, 'S', CASE WHEN ie_liberar_auto_cih_w='S' THEN clock_timestamp()  ELSE null END , 'A');
	end if;
	commit;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_cih (nr_atendimento_p bigint, dt_alta_p timestamp, cd_medico_p text, cd_cid_primario_p text, cd_cid_secundario_p text, ie_tipo_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

