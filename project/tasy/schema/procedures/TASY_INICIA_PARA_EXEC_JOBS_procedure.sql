-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_inicia_para_exec_jobs ( job_queue_processes_p bigint, ie_salvar_qtd_process_p text, ie_exec_comado_jobs_p text, qt_processes_p INOUT bigint) AS $body$
DECLARE


nr_seq_atualizacao_w	bigint;
vl_job_queue_process_w	bigint;
ie_exec_job_w			varchar(1);
job_w					bigint;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_atualizacao_w
from	atualizacao_versao;

select	coalesce(ie_exec_job, 'N'),
		coalesce(vl_job_queue_process,-1)
into STRICT	ie_exec_job_w,
		vl_job_queue_process_w
from	atualizacao_versao
where	nr_sequencia = nr_seq_atualizacao_w;

if (ie_exec_comado_jobs_p = 'N') then
	begin

		if (ie_salvar_qtd_process_p = 'S') then
			begin
					begin
						EXECUTE ' select	nvl(value,-1) from	v$parameter  where	name = :bind_job' INTO STRICT qt_processes_p USING 'job_queue_processes';
					exception
						when others then
							qt_processes_p := -1;
					end;
			end;
		end if;

		if (qt_processes_p > 0) then
			begin
				if (vl_job_queue_process_w < qt_processes_p) then
					begin
						vl_job_queue_process_w := qt_processes_p;
					end;
				end if;

				if (vl_job_queue_process_w >0) then
					begin
						qt_processes_p := vl_job_queue_process_w;
							begin
								EXECUTE ' alter system set job_queue_processes='||job_queue_processes_p;
							exception
								when others then
									qt_processes_p := vl_job_queue_process_w;
							end;
					end;
			end if;

			end;
		end if;

	end;
else
	begin

	begin

		CALL tasy_verifica_job_exec('Tasy');

		select	distinct(job)
		into STRICT	job_w
		from	job_v
		where	comando	like '%Tasy_executar_jobs_versao%';

		--DBMS_JOB.run(job_w);
		if (job_queue_processes_p > 0) then
			begin
			EXECUTE ' alter system set job_queue_processes='||job_queue_processes_p;
			end;
		end if;

		exception
			when others then
				--Não foi possível executar os comandos das jobs que ficaram pendendtes durante a atualização!
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(282689);
		end;

		if (ie_exec_job_w = 'S') then
			begin

			update	atualizacao_versao
			set		ie_exec_job = 'N'
			where	nr_sequencia = nr_seq_atualizacao_w;

			commit;

			end;
		end if;


	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_inicia_para_exec_jobs ( job_queue_processes_p bigint, ie_salvar_qtd_process_p text, ie_exec_comado_jobs_p text, qt_processes_p INOUT bigint) FROM PUBLIC;

