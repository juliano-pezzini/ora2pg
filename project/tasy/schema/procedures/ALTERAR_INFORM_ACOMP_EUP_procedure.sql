-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_inform_acomp_eup (nr_acompanhante_p bigint, qt_dieta_acomp_p bigint, nr_seq_regra_p bigint, nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_excluir_nao_lib_p text ) AS $body$
DECLARE

 
cd_setor_Atendimento_w		integer;
nr_seq_servico_w		bigint;
dt_servico_w			timestamp;
nm_pessoa_fisica_w		varchar(255);
nr_Seq_acompanhante_w		bigint;
nr_seq_serv_dia_w		bigint;
qt_acompanhantes_w		integer;
qt_dieta_acomp_w		bigint;
ds_consistencia_w		varchar(4000);
ie_servico_liberado_w		varchar(1);
i				bigint;
nr_seq_atend_acomp_w		bigint;				
 
C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.nr_seq_servico, 
		a.dt_servico		 
	from	nut_atend_serv_dia a 
	where	a.nr_atendimento = nr_atendimento_p 
	and	a.cd_setor_atendimento = cd_setor_atendimento_w 
	and	coalesce(a.dt_liberacao::text, '') = '' 
	and	a.dt_servico between dt_inicial_p and fim_dia(dt_final_p);
	
C02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	nut_atend_acompanhante 
	where	nr_seq_atend_serv_dia = nr_seq_serv_dia_w;
	

BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	  
	update	atend_categoria_convenio 
	set	nr_acompanhante = nr_acompanhante_p, 
		qt_dieta_acomp 	= qt_dieta_acomp_p, 
		nr_seq_regra_acomp = nr_seq_regra_p, 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where 	nr_atendimento 	= nr_atendimento_p;
	 
	nm_pessoa_fisica_w := Obter_Dados_Atendimento(nr_atendimento_p,'NP');
	--cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p); 
	 
	select	max(a.cd_setor_atendimento) 
	into STRICT	cd_setor_atendimento_w 
	FROM	unidade_atendimento a, 
		setor_atendimento s 
	WHERE	a.cd_setor_atendimento = s.cd_setor_atendimento 
	AND	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
	AND	a.nr_atendimento = nr_atendimento_p 
	AND	a.ie_status_unidade IN ('R','L','H', 'G', 'A','O','E','C','P','M','I','S');
	 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_serv_dia_w, 
		nr_seq_servico_w, 
		dt_servico_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		ds_consistencia_w := Consiste_acomp_dieta_categoria(nr_seq_serv_dia_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_consistencia_w);
		ie_servico_liberado_w := Obter_se_servico_liberado(nr_atendimento_p,nr_seq_servico_w);
		 
		select 	count(*) 
		into STRICT	qt_acompanhantes_w 
		from	nut_atend_acompanhante 
		where	nr_seq_atend_serv_dia = nr_seq_serv_dia_w;
		 
		if (qt_acompanhantes_w < qt_dieta_acomp_p) and (coalesce(ds_consistencia_w::text, '') = '') then 
			 
			qt_dieta_acomp_w := qt_dieta_acomp_p - qt_acompanhantes_w;
			i := 0;
							 
			for i in 1..qt_dieta_acomp_w loop 
				begin 
				 
				nr_seq_acompanhante_w := inserir_acompanhante_nutricao(	nr_seq_servico_w, dt_servico_w, nr_atendimento_p, cd_setor_atendimento_w, null, wheb_mensagem_pck.get_texto(795752) || ' ' || nm_pessoa_fisica_w, nm_usuario_p, nr_seq_acompanhante_w);
				end;
			end loop;
		 
		elsif (ie_excluir_nao_lib_p = 'S') and (ie_servico_liberado_w = 'N') then 
		 
			open C02;
			loop 
			fetch C02 into	 
				nr_seq_atend_acomp_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				 
				delete 	from nut_atend_acomp_dieta 
				where	nr_seq_atend_acomp = nr_seq_atend_acomp_w;
				 
				end;
			end loop;
			close C02;
			 
			delete 	from nut_atend_acompanhante 
			where	nr_seq_atend_serv_dia = nr_seq_serv_dia_w;
			 
			update	nut_atend_serv_dia 
			set	ie_acompanhante = 'N' 
			where	nr_sequencia = nr_seq_serv_dia_w;
		 
		end if;		
		end;
	end loop;
	close C01;	
	 
end if;	
	 
commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_inform_acomp_eup (nr_acompanhante_p bigint, qt_dieta_acomp_p bigint, nr_seq_regra_p bigint, nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_excluir_nao_lib_p text ) FROM PUBLIC;

