-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_ocupacao_hora (cd_estabelecimento_p bigint) AS $body$
DECLARE

 
ie_relatorio_w		varchar(1);
dt_hora_w		timestamp;
cd_setor_atendimento_w	bigint;
qt_ocupado_w		bigint;
qt_temporario_w		bigint;
qt_total_leitos_w	bigint;
qt_interditados_w	bigint;
qt_ocup_w		double precision;
qt_ohr_w		double precision;
qt_olf_w		double precision;
qt_uti_w		bigint;
qt_pronto_socorro_w	bigint;
qt_ambulatorial_w	bigint;
qt_internado_w		bigint;
cd_classif_setor_w	smallint;

qt_ohr_ps_w		double precision;
qt_ohr_cc_w		double precision;
qt_ohr_uti_w		double precision;
qt_ohr_unid_w		double precision;
qt_ohr_se_w		double precision;
qt_ohr_same_w		double precision;
qt_ohr_adm_w		double precision;
qt_ohr_hmcare_w		double precision;
qt_ohr_rn_w		double precision;
qt_ohr_le_w		double precision;

/* Create da tabela 
create table w_ocupacao_hora (	cd_classif_setor 		number(10), 
				dt_hora			date, 
				cd_setor_atendimento	number(10), 
				qt_ocupado		number(10), 
				qt_temporario		number(10), 
				qt_total_leitos		number(10), 
				qt_interditados		number(10), 
				qt_ocup			number(10,2), 
				qt_ohr			number(10,2), 
				qt_olf			number(10,2)); */
 
				 
/* Create da tabela 
create table w_ocupacao_hora_classif (	dt_hora			date, 
				qt_ohr_ps		number(10,2), 
				qt_ohr_cc		number(10,2), 
				qt_ohr_uti		number(10,2), 
				qt_ohr_unid		number(10,2), 
				qt_ohr_se		number(10,2), 
				qt_ohr_same		number(10,2), 
				qt_ohr_adm		number(10,2), 
				qt_ohr_hmcare		number(10,2), 
				qt_ohr_rn		number(10,2), 
				qt_ohr_le			number(10,2)); */
 
				 
 
C01 CURSOR FOR 
	SELECT	cd_setor_atendimento, 
		cd_classif_setor, 
		(nr_unidades_setor - nr_unidades_temporarias) nr_unidades_normais, 
		nr_unidades_temporarias, 
		nr_unidades_setor, 
		nr_unidades_interditadas, 
		Obter_percetual_ocupacao( 
			nr_unidades_setor, 
			nr_unidades_temporarias, 
			nr_unidades_ocupadas,    
			qt_unidade_acomp, 
			nr_unidades_interditadas, 
			nr_unidades_livres, 
			nr_unidades_higienizacao, 
			nr_unidades_reservadas, 
			qt_unidades_isolamento, 
			qt_unidades_alta, 
			nr_unid_temp_ocup, 
			nr_unid_temp_ocupadas, 
			qt_unid_temp_acomp, 
			nr_unid_temp_interditadas, 
			nr_unid_temp_livres, 
			nr_unid_temp_higienizacao, 
			nr_unid_temp_reservadas, 
			qt_unid_temp_isolamento, 
			qt_unid_temp_alta, 
			qt_unidade_manutencao,	 
			'X') pr_ocupacao, 
		dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
			(nr_unidades_setor - nr_unidades_interditadas)) pr_ohr, 
		dividir(nr_unidades_ocupadas * 100, (nr_unidades_setor - nr_unidades_temporarias)) pr_olf	 
	from	ocupacao_setores_v2 
	where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
	and	cd_estabelecimento_base = coalesce(cd_estabelecimento_p, coalesce(wheb_usuario_pck.get_cd_estabelecimento,1));
				

BEGIN 
 
delete FROM w_ocupacao_hora where dt_hora = trunc(clock_timestamp(), 'hh');
commit;
delete FROM w_ocupacao_hora_classif where dt_hora = trunc(clock_timestamp(), 'hh');
commit;
 
open C01;
loop 
fetch C01 into	 
	cd_setor_atendimento_w, 
	cd_classif_setor_w, 
	qt_ocupado_w, 
	qt_temporario_w, 
	qt_total_leitos_w, 
	qt_interditados_w, 
	qt_ocup_w, 
	qt_ohr_w, 
	qt_olf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	 
	insert 
	into	w_ocupacao_hora( 
		cd_classif_setor, 
		dt_hora, 
		cd_setor_atendimento, 
		qt_ocupado, 
		qt_temporario, 
		qt_total_leitos, 
		qt_interditados, 
		qt_ocup, 
		qt_ohr, 
		qt_olf) 
	values (cd_classif_setor_w, 
		trunc(clock_timestamp(), 'hh'), 
		cd_setor_atendimento_w, 
		qt_ocupado_w, 
		qt_temporario_w, 
		qt_total_leitos_w, 
		qt_interditados_w, 
		qt_ocup_w, 
		qt_ohr_w, 
		qt_olf_w);
	 
end loop;
close C01;
 
commit;
 
-- Classificação: Pronto Socorro 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_ps_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 1;
 
-- Classificação: Centro Cirúrgico 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_cc_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 2;
 
-- Classificação: UTI 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_uti_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 3;
 
-- Classificação: Unidades de Internação 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_unid_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 4;
 
-- Classificação: Serviços Especiais 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_se_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 5;
 
-- Classificação: SAME 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_same_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 6;
 
-- Classificação: Administrativo 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_adm_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 7;
 
-- Classificação: Home Care 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_hmcare_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 8;
 
-- Classificação: Recém-nascido 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_rn_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 9;
 
-- Classificação: Laboratórios Externos 
select	avg(dividir((nr_unidades_ocupadas + nr_unid_temp_ocup) * 100, 
		(nr_unidades_setor - nr_unidades_interditadas))) 
into STRICT	qt_ohr_le_w 
from	ocupacao_setores_v2 
where	ie_ocup_hospitalar in ('S','M','T') and ie_situacao = 'A' 
and	cd_classif_setor = 10;
 
insert 
into	w_ocupacao_hora_classif( 
	dt_hora, 
	qt_ohr_ps, 
	qt_ohr_cc, 
	qt_ohr_uti, 
	qt_ohr_unid, 
	qt_ohr_se, 
	qt_ohr_same, 
	qt_ohr_adm, 
	qt_ohr_hmcare, 
	qt_ohr_rn, 
	qt_ohr_le) 
values (trunc(clock_timestamp(),'hh'), 
	qt_ohr_ps_w, 
	qt_ohr_cc_w, 
	qt_ohr_uti_w, 
	qt_ohr_unid_w, 
	qt_ohr_se_w, 
	qt_ohr_same_w, 
	qt_ohr_adm_w, 
	qt_ohr_hmcare_w, 
	qt_ohr_rn_w, 
	qt_ohr_le_w);
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_ocupacao_hora (cd_estabelecimento_p bigint) FROM PUBLIC;

