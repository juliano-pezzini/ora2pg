-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_ageint_protocolo ( NR_SEQ_AGENDA_P bigint, DT_AGENDA_P timestamp, CD_PESSOA_FISICA_P bigint, CD_CONVENIO_P bigint, CD_ESTABELECIMENTO_P bigint, NR_SEQ_GRUPO_PROC_P bigint, DT_PREVISTA_P timestamp default null, NR_SEQ_AGENDA_INT INOUT bigint DEFAULT NULL, IE_STATUS INOUT bigint DEFAULT NULL, NM_PACIENTE_P text DEFAULT NULL) AS $body$
DECLARE


  NR_SEQ_AGENDA_INT_W  bigint;
  NR_SEQ_ITEM_AGENDA_W bigint;
  NR_SEQ_STATUS_W AGENDA_INTEGRADA_STATUS.nr_sequencia%type;
  IE_TIPO_AGENDAMENTO_W    varchar(1);
  NR_SEQ_PROC_INTERNO_W    bigint;
  CD_MEDICO_W              bigint;
  CD_ESPECIALIDADE_W       bigint;
  NR_MINUTO_DURACAO_W      bigint;
  IE_CLASSIF_AGENDA_W      varchar(5);
  NR_SEQ_PROC_ITEM_GRUPO_W bigint;
  IE_FORMA_AGEND_PADRAO_W  varchar(1);

   nr_telefone_w   agenda_integrada.nr_telefone%type;
   ie_sexo_w       agenda_integrada.ie_sexo%type;
   qt_idade_pac_w  agenda_integrada.qt_idade_pac%type;
   dt_nascimento_w agenda_integrada.dt_nascimento%type;
   qt_peso_w       agenda_integrada.qt_peso%type;
   qt_altura_cm_w  agenda_integrada.qt_altura_cm%type;

  C01 CURSOR FOR
    SELECT IE_TIPO_AGENDAMENTO,
      NR_SEQ_PROC_INTERNO,
      CD_MEDICO,
      CD_ESPECIALIDADE,
      NR_MINUTO_DURACAO,
      IE_CLASSIF_AGENDA,
      NR_SEQUENCIA
    FROM AGEINT_GRUPO_PROC_ITEM
    WHERE NR_SEQ_GRUPO_PROC = NR_SEQ_GRUPO_PROC_P
    AND ie_situacao         = 'A'
    ORDER BY NR_SEQ_APRES;


BEGIN

  ie_forma_agend_padrao_w  := Obter_Param_Usuario(869, 204, obter_perfil_ativo, Obter_Usuario_Ativo, cd_estabelecimento_p, ie_forma_agend_padrao_w );

  SELECT MIN(a.nr_sequencia)
  INTO STRICT NR_SEQ_STATUS_W
  FROM AGENDA_INTEGRADA_STATUS a
  WHERE coalesce(a.ie_situacao,'A') = 'A'
  AND IE_STATUS_TASY           = 'EA';

  IE_STATUS := NR_SEQ_STATUS_W;

  SELECT nextval('agenda_integrada_seq') INTO STRICT NR_SEQ_AGENDA_INT_W;

  NR_SEQ_AGENDA_INT := NR_SEQ_AGENDA_INT_W;

  nr_telefone_w   := obter_fone_pac_agenda(CD_PESSOA_FISICA_P);
  ie_sexo_w       := obter_sexo_PF(CD_PESSOA_FISICA_P, 'C');
  qt_idade_pac_w  := obter_idade_pf(CD_PESSOA_FISICA_P, clock_timestamp(), 'A');
  dt_nascimento_w := obter_data_nascto_pf(CD_PESSOA_FISICA_P);
  qt_peso_w       := obter_peso_pf(CD_PESSOA_FISICA_P);
  qt_altura_cm_w  := obter_dados_pf(CD_PESSOA_FISICA_P,'AL');

  INSERT
  INTO AGENDA_INTEGRADA(
      NR_SEQUENCIA ,
      DT_ATUALIZACAO ,
      NM_USUARIO ,
      DT_ATUALIZACAO_NREC ,
      NM_USUARIO_NREC ,
      DT_INICIO_AGENDAMENTO ,
      DT_FIM_AGENDAMENTO ,
      CD_PESSOA_FISICA ,
      CD_ESTABELECIMENTO,
      NR_SEQ_STATUS,
      CD_CONVENIO,
      DT_PREVISTA,
      cd_profissional,
      NM_PACIENTE,
      NR_TELEFONE,
      IE_SEXO,
      QT_IDADE_PAC,
      DT_NASCIMENTO,
      QT_PESO,
      QT_ALTURA_CM
    )
    VALUES (
      NR_SEQ_AGENDA_INT_W,
      clock_timestamp(),
      OBTER_USUARIO_ATIVO,
      clock_timestamp(),
      OBTER_USUARIO_ATIVO,
      clock_timestamp(),
      NULL,
      CD_PESSOA_FISICA_P,
      CD_ESTABELECIMENTO_P,
      NR_SEQ_STATUS_W,
      CD_CONVENIO_P,
      CASE WHEN DT_PREVISTA_P < clock_timestamp() THEN clock_timestamp() ELSE DT_PREVISTA_P END,
      obter_pf_usuario(obter_usuario_ativo, 'C'),
      NM_PACIENTE_P,
      nr_telefone_w,
      ie_sexo_w,
      qt_idade_pac_w,
      dt_nascimento_w,
      qt_peso_w,
      qt_altura_cm_w
    );

  OPEN C01;
  LOOP
    FETCH C01
    INTO IE_TIPO_AGENDAMENTO_W,
      NR_SEQ_PROC_INTERNO_W,
      CD_MEDICO_W,
      CD_ESPECIALIDADE_W,
      NR_MINUTO_DURACAO_W,
      IE_CLASSIF_AGENDA_W,
      NR_SEQ_PROC_ITEM_GRUPO_W;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    BEGIN

      SELECT nextval('agenda_integrada_item_seq') INTO STRICT NR_SEQ_ITEM_AGENDA_W;

      INSERT
        INTO AGENDA_INTEGRADA_ITEM(
          NR_SEQUENCIA,
          NR_SEQ_AGENDA_INT,
          DT_ATUALIZACAO,
          NM_USUARIO,
          DT_ATUALIZACAO_NREC,
          NM_USUARIO_NREC,
          NR_SEQ_PROC_INTERNO,
          IE_TIPO_AGENDAMENTO,
          CD_MEDICO,
          CD_ESPECIALIDADE,
          NR_MINUTO_DURACAO,
          IE_CLASSIF_AGENDA,
          NR_SEQ_GRUPO_PROC,
          NR_SEQ_REGRA_EX_ADIC,
          NR_SEQ_PROC_ITEM_GRUPO,
          IE_FORMA_AGENDAMENTO,
          NR_SEQ_GRUPO_SELEC,
          NR_SEQ_AGRUPAMENTO,
          NR_SEQ_AREA_ATUACAO,
          NR_SEQ_CIRURGIA
        )
        VALUES (
          NR_SEQ_ITEM_AGENDA_W,
          NR_SEQ_AGENDA_INT_W,
          clock_timestamp(),
          OBTER_USUARIO_ATIVO,
          clock_timestamp(),
          OBTER_USUARIO_ATIVO,
          NR_SEQ_PROC_INTERNO_W,
          IE_TIPO_AGENDAMENTO_W,
          CD_MEDICO_W,
          CD_ESPECIALIDADE_W,
          NR_MINUTO_DURACAO_W,
          IE_CLASSIF_AGENDA_W,
          NULL,
          NULL,
          NR_SEQ_PROC_ITEM_GRUPO_W,
          CASE WHEN IE_TIPO_AGENDAMENTO_W='Q' THEN  NULL  ELSE CASE WHEN IE_FORMA_AGEND_PADRAO_W='' THEN  NULL  ELSE IE_FORMA_AGEND_PADRAO_W END  END ,
          NULL,
          NULL,
          NULL,
          NR_SEQ_AGENDA_P
        );

    END;
  END LOOP;
  CLOSE C01;

  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_ageint_protocolo ( NR_SEQ_AGENDA_P bigint, DT_AGENDA_P timestamp, CD_PESSOA_FISICA_P bigint, CD_CONVENIO_P bigint, CD_ESTABELECIMENTO_P bigint, NR_SEQ_GRUPO_PROC_P bigint, DT_PREVISTA_P timestamp default null, NR_SEQ_AGENDA_INT INOUT bigint DEFAULT NULL, IE_STATUS INOUT bigint DEFAULT NULL, NM_PACIENTE_P text DEFAULT NULL) FROM PUBLIC;

