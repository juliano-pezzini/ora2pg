-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_aprovar_duplic (nr_seq_cliente_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_email_w		varchar(255);
nr_seq_canal_w		bigint;
cd_pessoa_fisica_w	bigint;
	
C01 CURSOR FOR 
	SELECT	max(cd_pessoa_fisica) 
	from	com_cliente_gestor 
	where	nr_seq_cliente = nr_seq_cliente_p 
	and	coalesce(dt_final::text, '') = '' 
	order by 1;

C02 CURSOR FOR 
	SELECT 	substr(obter_dados_pf_pj(cd_pessoa_fisica_w, null, 'M'),1,255) 
	;
	

BEGIN 
 
if (nr_seq_cliente_p IS NOT NULL AND nr_seq_cliente_p::text <> '') then 
 
	update 	com_cliente 
	set 	dt_aprov_duplic = clock_timestamp(), 
		ie_classificacao = 'L', 
		ie_fase_venda = 'Q', 
		ie_status_neg = 'F', 
		nm_usuario = nm_usuario_p 
	where 	nr_sequencia = nr_seq_cliente_p;
	 
	select	a.nr_sequencia 
	into STRICT	nr_seq_canal_w 
	from	com_canal_cliente a 
	where	a.nr_seq_cliente = nr_seq_cliente_p 
	and	coalesce(a.dt_fim_atuacao::text, '') = '' 
	and	a.ie_situacao = 'A' 
	order by 1;
	 
	open C01;
	loop 
	fetch C01 into	 
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		open C02;
		loop 
		fetch C02 into	 
			ds_email_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			CALL enviar_email(wheb_mensagem_pck.get_texto(802687), wheb_mensagem_pck.get_texto(802688,'nr_seq_cliente_p=' || nr_seq_cliente_p), 'comercial@wheb.com.br', 'comercial@wheb.com.br;' || ds_email_w, nm_usuario_p, 'A');
			end;
		end loop;
		close C02;
		end;
	end loop;
	close C01;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_aprovar_duplic (nr_seq_cliente_p bigint, nm_usuario_p text) FROM PUBLIC;

