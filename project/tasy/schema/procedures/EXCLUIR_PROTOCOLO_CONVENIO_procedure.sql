-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_protocolo_convenio ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE

dt_atualizacao_w	timestamp := clock_timestamp();
ds_chave_w	varchar(255);
nr_nota_fiscal_w	varchar(255);
quebra_w		varchar(10)	:= chr(13)||chr(10);


BEGIN 
 
update	conta_paciente 
set	nr_protocolo  = '0', 
	nr_seq_protocolo  = NULL 
where	nr_seq_protocolo = nr_seq_protocolo_p;
commit;
 
/*insert into log_exclusao 
	(nm_tabela, dt_atualizacao, nm_usuario, ds_chave) 
select 	'PROTOCOLO_CONVENIO ', sysdate, nm_usuario_p, 
	'Seq= ' || nr_seq_protocolo || ' Prot= ' || nr_protocolo || ' Conv= ' || cd_convenio 
from 	protocolo_convenio 
where 	nr_seq_protocolo = nr_seq_protocolo_p;*/
 
 
select 	'Seq= ' || nr_seq_protocolo || ' Prot= ' || nr_protocolo || ' Conv= ' || cd_convenio 
into STRICT	ds_chave_w 
from 	protocolo_convenio 
where 	nr_seq_protocolo = nr_seq_protocolo_p;
 
select	coalesce(max(nr_nota_fiscal),'0') 
into STRICT	nr_nota_fiscal_w 
from	 nota_fiscal 
where	nr_seq_protocolo	= nr_seq_protocolo_p 
and 	ie_situacao 		= 1; -- Somente as Notas Ativas (Fabrício em 16/10/2009 OS 172760) 
if (coalesce(nr_nota_fiscal_w,'0') <> '0') then 
	/*r.aise_application_error(-20011,'Não é possivel excluir este protocolo pois existe a nota fiscal '|| 
					nr_nota_fiscal_w ||' vinculada ao mesmo.'||quebra_w|| 
					'É necessário a exclusão da nota fiscal para poder efetuar este processo. #@#@');*/
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263318,'NR_NOTA_FISCAL_W='||NR_NOTA_FISCAL_W);
end if;
 
CALL gravar_log_exclusao('PROTOCOLO_CONVENIO',nm_usuario_p,ds_chave_w,'N');
 
delete	from protocolo_convenio 
where	nr_seq_protocolo  = nr_seq_protocolo_p;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_protocolo_convenio ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

