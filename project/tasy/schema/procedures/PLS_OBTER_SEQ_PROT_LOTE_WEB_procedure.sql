-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_seq_prot_lote_web ( ds_hash_p text, nr_seq_prestador_p bigint, nr_protocolo_prestador_p text, nr_seq_usu_prestador_p bigint, nr_seq_perfil_web_p bigint, cd_estabelecimento_p bigint, ie_permite_duplicidade_p text, nr_seq_protocolo_p bigint, nr_seq_protocolo_saida_p INOUT bigint, nr_seq_lote_p INOUT bigint, ds_mensagem_erro_p INOUT text, ie_permite_importar_p INOUT text) AS $body$
DECLARE

 
nr_seq_prot_integrado_w		bigint := null;
nr_seq_lote_w			bigint := null;
ie_permite_duplicidade_w	varchar(1) := 'N';
ie_permite_importar_w		varchar(1) := 'S';
ie_tipo_guia_prot_w		varchar(255);
nr_seq_prot_importado_w		bigint;
nr_seq_conta_w			bigint;

c01 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	pls_conta a 
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p;


BEGIN 
 
if (ie_permite_duplicidade_p IS NOT NULL AND ie_permite_duplicidade_p::text <> '') then 
	ie_permite_duplicidade_w := ie_permite_duplicidade_p;
else 
	if (nr_seq_usu_prestador_p IS NOT NULL AND nr_seq_usu_prestador_p::text <> '') then 
		ie_permite_duplicidade_w :=  pls_obter_param_web(1249, 15, cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, null, 
								  null,'P',null, null);
	else 
		ie_permite_duplicidade_w := pls_obter_param_padrao_funcao(15,1249);
	end if;
end if;
 
 
if (ie_permite_duplicidade_w = 'N') then 
 
	select 	max(nr_sequencia) 
	into STRICT	nr_seq_prot_integrado_w 
	from  pls_protocolo_conta 
	where  ds_hash = ds_hash_p 
	and   nr_protocolo_prestador = nr_protocolo_prestador_p 
	and   ie_situacao not in ('I', 'A', 'RE') 
	and	ie_status <> '4';
	 
	if (coalesce(nr_seq_prot_integrado_w::text, '') = '' and (nr_seq_usu_prestador_p IS NOT NULL AND nr_seq_usu_prestador_p::text <> '') and (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '')) then 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_lote_w 
		from	pls_lote_protocolo_conta 
		where	nr_seq_prestador = nr_seq_prestador_p 
		and	ie_tipo_lote = 'P' 
		and	coalesce(dt_confirmacao::text, '') = '';
 
		if (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then 
			select 	max(nr_sequencia) 
			into STRICT	nr_seq_prot_integrado_w 
			from  pls_protocolo_conta 
			where  ds_hash = ds_hash_p 
			and   nr_protocolo_prestador = nr_protocolo_prestador_p 
			and	nr_seq_lote_conta = nr_seq_lote_w;
		end if;
	elsif (nr_seq_prot_integrado_w IS NOT NULL AND nr_seq_prot_integrado_w::text <> '') then 
		select	max(nr_seq_lote_conta) 
		into STRICT	nr_seq_lote_w 
		from	pls_protocolo_conta 
		where	nr_sequencia = nr_seq_prot_integrado_w;
	end if;
	 
	if (nr_seq_prot_integrado_w IS NOT NULL AND nr_seq_prot_integrado_w::text <> '') then 
		ds_mensagem_erro_p := 'Este arquivo já foi importado no protocolo '||nr_seq_prot_integrado_w;
		 
		if (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then 
			ds_mensagem_erro_p := ds_mensagem_erro_p||' do lote '||nr_seq_lote_w||'.';
		else	 
			ds_mensagem_erro_p := ds_mensagem_erro_p||'.';
		end if;
		 
		ie_permite_importar_w := 'N';
		 
		/* Francisco - 17/08/2012 - OS 468213 - Verificar por número do lote e gravar glosa em todas as contas*/
 
		begin 
		select	a.ie_tipo_guia 
		into STRICT	ie_tipo_guia_prot_w 
		from	pls_protocolo_conta a 
		where	a.nr_sequencia	= nr_seq_protocolo_p;
		exception 
			when others then 
			ie_tipo_guia_prot_w	:= null;
		end;
		 
		if (ie_tipo_guia_prot_w IS NOT NULL AND ie_tipo_guia_prot_w::text <> '') then 
			select	max(nr_sequencia) 
			into STRICT	nr_seq_prot_importado_w 
			from	pls_protocolo_conta 
			where	nr_protocolo_prestador	= nr_protocolo_prestador_p 
			and	nr_seq_prestador	= nr_seq_prestador_p 
			and	ie_tipo_guia		= ie_tipo_guia_prot_w 
			and	nr_sequencia		<> nr_seq_protocolo_p 
			and	ie_situacao not in ('I', 'A', 'RE') 
			and	ie_status <> '4';
			 
			if (nr_seq_prot_importado_w IS NOT NULL AND nr_seq_prot_importado_w::text <> '') then 
				open c01;
				loop 
				fetch c01 into	 
					nr_seq_conta_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					begin 
					CALL pls_gravar_conta_glosa('1199', nr_seq_conta_w, null, 
						null, 'N', 'Esse arquivo já foi integrado no protocolo ' || nr_seq_protocolo_p || ' (mesmo número de lote)', 
						'Tasy','A','IA', nr_seq_prestador_p, cd_estabelecimento_p, '',null);
					end;
				end loop;
				close c01;
			end if;
		end if;
		/* Fim Francisco - 17/08/2012 - OS 468213 */
 
	end if;
	 
end if;
 
nr_seq_protocolo_saida_p := nr_seq_prot_integrado_w;
nr_seq_lote_p		 := nr_seq_lote_w;
ie_permite_importar_p 	 := ie_permite_importar_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_seq_prot_lote_web ( ds_hash_p text, nr_seq_prestador_p bigint, nr_protocolo_prestador_p text, nr_seq_usu_prestador_p bigint, nr_seq_perfil_web_p bigint, cd_estabelecimento_p bigint, ie_permite_duplicidade_p text, nr_seq_protocolo_p bigint, nr_seq_protocolo_saida_p INOUT bigint, nr_seq_lote_p INOUT bigint, ds_mensagem_erro_p INOUT text, ie_permite_importar_p INOUT text) FROM PUBLIC;

