-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_classif_titulo (ds_lista_titulo_p text, ie_pagar_receber_p text, cd_conta_contabil_p text, cd_centro_custo_p bigint, cd_conta_financ_p bigint, ie_sobrepor_p text, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w	bigint;
vl_titulo_w	double precision;
cont_w		integer;

c01 CURSOR FOR
SELECT	nr_titulo,
	vl_titulo
from	titulo_receber
where	' ' || ds_lista_titulo_p || ' ' like '% ' || nr_titulo || ' %'
and	(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '')
and	ie_pagar_receber_p	= 'R'
and	ie_situacao		= '1';

c02 CURSOR FOR
SELECT	nr_titulo,
	vl_titulo
from	titulo_pagar
where	' ' || ds_lista_titulo_p || ' ' like '% ' || nr_titulo || ' %'
and	(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '')
and	ie_pagar_receber_p 	= 'P'
and	ie_situacao		= 'A';


BEGIN

if (coalesce(ds_lista_titulo_p::text, '') = '') then
	--Nenhum tÃ­tulo foi selecionado!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(211552);
end if;

open c01;
loop
fetch c01 into
	nr_titulo_w,
	vl_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select	count(*)
	into STRICT	cont_w
	from	titulo_receber_classif
	where	nr_titulo	= nr_titulo_w;

	if (cont_w > 0 and ie_sobrepor_p = 'S') then
		delete	from titulo_receber_classif
		where	nr_titulo	= nr_titulo_w;
	end if;

	if	((cont_w = 0) or (cont_w > 0 and ie_sobrepor_p = 'S')) then
		insert	into	titulo_receber_classif(	nr_titulo,
							nr_sequencia,
							vl_classificacao,
							cd_centro_custo,
							cd_conta_financ,
							cd_conta_contabil,
							dt_atualizacao,
							nm_usuario)
						values (	nr_titulo_w,
							1,
							vl_titulo_w,
							cd_centro_custo_p,
							cd_conta_financ_p,
							cd_conta_contabil_p,
							clock_timestamp(),
							nm_usuario_p);
	end if;
end loop;
close c01;

open c02;
loop
fetch c02 into
	nr_titulo_w,
	vl_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	select	count(*)
	into STRICT	cont_w
	from	titulo_pagar_classif
	where	nr_titulo	= nr_titulo_w;

	if (cont_w > 0 and ie_sobrepor_p = 'S') then
		delete	from titulo_pagar_classif
		where	nr_titulo	= nr_titulo_w;
	end if;

	if	((cont_w = 0) or (cont_w > 0 and ie_sobrepor_p = 'S')) then
		insert	into	titulo_pagar_classif(	nr_titulo,
							nr_sequencia,
							vl_titulo,
							cd_conta_contabil,
							cd_centro_custo,
							nr_seq_conta_financ,
							dt_atualizacao,
							nm_usuario)
						values (	nr_titulo_w,
							1,
							vl_titulo_w,
							cd_conta_contabil_p,
							cd_centro_custo_p,
							cd_conta_financ_p,
							clock_timestamp(),
							nm_usuario_p);
	end if;
end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_classif_titulo (ds_lista_titulo_p text, ie_pagar_receber_p text, cd_conta_contabil_p text, cd_centro_custo_p bigint, cd_conta_financ_p bigint, ie_sobrepor_p text, nm_usuario_p text) FROM PUBLIC;

