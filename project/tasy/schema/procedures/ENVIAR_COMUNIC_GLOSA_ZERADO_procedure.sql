-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_glosa_zerado ( nr_seq_procedimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_atendimento_w		bigint;
nm_paciente_w			varchar(80);
ds_perfis_w			varchar(4000);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ds_procedimento_w		varchar(255);
quebra_w			varchar(20) := chr(13)||chr(10);
ds_mensagem_w			varchar(1000);
cd_perfil_w			bigint;
qt_registro_w			bigint;
C01 CURSOR FOR
	SELECT	cd_perfil
	from	regra_comunicado_glosa
	where	ie_situacao = 'A';

BEGIN

select	count(*)
into STRICT	qt_registro_w
from	regra_comunicado_glosa
where	ie_situacao = 'A';

if (qt_registro_w	> 0) then

	select	nr_atendimento,
		cd_procedimento,
		ie_origem_proced
	into STRICT	nr_atendimento_w,
		cd_procedimento_w,
		ie_origem_proced_w
	from	procedimento_paciente
	where	nr_sequencia	= nr_seq_procedimento_p;

	nm_paciente_w		:= obter_pessoa_Atendimento(nr_atendimento_w,'N');
	ds_procedimento_w	:= substr(Obter_Descricao_Procedimento(cd_procedimento_w,ie_origem_proced_w),1,255);



	ds_mensagem_w	:= WHEB_MENSAGEM_PCK.get_texto(298803,'CD_PROCEDIMENTO_W='||CD_PROCEDIMENTO_W||';DS_PROCEDIMENTO_W='||DS_PROCEDIMENTO_W);
			/*Aberta conta particular referente a procedimento não coberto pelo convênio.
			Código: #@CD_PROCEDIMENTO_W#@ - #@DS_PROCEDIMENTO_W#@.*/
	open C01;
	loop
	fetch C01 into
		cd_perfil_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_perfis_w	:= cd_perfil_w ||','||ds_perfis_w;
		end;
	end loop;
	close C01;

	insert  into 	comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			nr_sequencia,
			ie_gerencial,
			nr_seq_classif,
			cd_perfil,
			cd_setor_destino,
			cd_estab_destino,
			ds_setor_adicional,
			dt_liberacao,
			ds_perfil_adicional)
		values (clock_timestamp(),
			WHEB_MENSAGEM_PCK.get_texto(298804,'NR_ATENDIMENTO_W='||NR_ATENDIMENTO_W||';NM_PACIENTE_W='||NM_PACIENTE_W),
			ds_mensagem_w,
			nm_usuario_p,
			clock_timestamp(),
			'N',
			null,
			nextval('comunic_interna_seq'),
			'N',
			7,
			null,
			null,
			null,
			null,
			clock_timestamp(),
			ds_perfis_w);
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_glosa_zerado ( nr_seq_procedimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

