-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_lista_agecons ( ds_lista_agenda_cons_p text, ie_status_agenda_p text, cd_motivo_canc_p text, ds_motivo_canc_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nr_atendimento_w	bigint;
ds_lista_w		varchar(1000);
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
cd_agenda_w		bigint;
cd_motivo_canc_w	varchar(255);
cd_motivo_ww		varchar(255);
ds_motivo_canc_w	varchar(255);


BEGIN 
 
ds_lista_w := ds_lista_agenda_cons_p;	
 
if (substr(ds_lista_w,length(ds_lista_w) - 1, length(ds_lista_w))	<> ',') then 
	ds_lista_w	:= ds_lista_w ||',';
end if;
 
while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop 
	begin 
	 
	tam_lista_w		:= length(ds_lista_w);
	ie_pos_virgula_w	:= position(',' in ds_lista_w);
	 
	if (ie_pos_virgula_w <> 0) then 
		nr_sequencia_w		:= (substr(ds_lista_w,1,(ie_pos_virgula_w - 1)))::numeric;
		ds_lista_w		:= substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);
	end if;
	 
	select	max(a.cd_agenda)		 
	into STRICT	cd_agenda_w 
	from	agenda_consulta a 
	where	a.nr_sequencia	= nr_sequencia_w;
	 
	if (ie_status_agenda_p	= 'C') then 
		cd_motivo_canc_w	:= cd_motivo_canc_p;
		ds_motivo_canc_w	:= coalesce(ds_motivo_canc_p,obter_desc_expressao(774863));
	end if;
	 
	if (coalesce(cd_motivo_canc_w::text, '') = '') then 
		select max(cd_motivo)     
		into STRICT	cd_motivo_canc_w 
		from  agenda_motivo_cancelamento 
		where  ((cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento) or (coalesce(cd_estabelecimento::text, '') = '')) 
		and   ie_agenda in ('C','T','S') 
		and   ie_situacao = 'A';		
	end if;
	 
	select	max(CASE WHEN ie_status_agenda_p='F' THEN  cd_motivo_canc_p WHEN ie_status_agenda_p='I' THEN  cd_motivo_canc_p  ELSE cd_motivo_canc_w END ) 
	into STRICT	cd_motivo_ww 
	;
	 
	CALL alterar_status_agecons(	cd_agenda_w, 
				nr_sequencia_w, 
				ie_status_agenda_p, 
				cd_motivo_ww, 
				ds_motivo_canc_w, 
				'', 
				nm_usuario_p, 
				null);
				 
	end;
end loop;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_lista_agecons ( ds_lista_agenda_cons_p text, ie_status_agenda_p text, cd_motivo_canc_p text, ds_motivo_canc_p text, nm_usuario_p text) FROM PUBLIC;

