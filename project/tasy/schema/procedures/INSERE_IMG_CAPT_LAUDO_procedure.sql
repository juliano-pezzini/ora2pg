-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_img_capt_laudo (nr_laudo_p bigint, ie_orientacao_p text, ds_dimensao_p text, nr_seq_imagens_p text, nm_usuario_p text) AS $body$
DECLARE

ds_lista_w             varchar(2000);
tam_lista_w             bigint;
nr_sequencia_w             bigint;
ie_pos_virgula_w             smallint;
qt_existe_virgula_w                     bigint;
nr_seq_imagem_w                     bigint;


BEGIN

update LAUDO_PACIENTE
set IE_ORIENTACAO_IMAGEM = ie_orientacao_p,
  DS_DIMENSAO_IMAGEM = ds_dimensao_p,
  NM_USUARIO = nm_usuario_p,
  DT_ATUALIZACAO = clock_timestamp()
where nr_sequencia = nr_laudo_p;

ds_lista_w := nr_seq_imagens_p;

select  position(',' in ds_lista_w)
into STRICT  qt_existe_virgula_w
;

if (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
  begin
  while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '')  loop
    begin
    tam_lista_w  := length(ds_lista_w);
    ie_pos_virgula_w  := position(',' in ds_lista_w);

    if (ie_pos_virgula_w <> 0) then
      nr_seq_imagem_w  := (substr(ds_lista_w,1,(ie_pos_virgula_w - 1)))::numeric;
      ds_lista_w  := substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);
    end if;

    select  nextval('laudo_paciente_captura_img_seq')
    into STRICT  nr_sequencia_w
;

    if (nr_seq_imagem_w > 0) then
      begin
      INSERT INTO LAUDO_PACIENTE_CAPTURA_IMG(NR_SEQUENCIA,
                          DT_ATUALIZACAO,
                          NM_USUARIO,
                          DT_ATUALIZACAO_NREC,
                          NM_USUARIO_NREC,
                          NR_SEQ_LAUDO,
                          NR_SEQ_CAPTURA)
                          values (nr_sequencia_w,
                          clock_timestamp(),
                          nm_usuario_p,
                          clock_timestamp(),
                          nm_usuario_p,
                          nr_laudo_p,
                          nr_seq_imagem_w);

      end;
    end if;

    end;
  end loop;
  end;

end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_img_capt_laudo (nr_laudo_p bigint, ie_orientacao_p text, ds_dimensao_p text, nr_seq_imagens_p text, nm_usuario_p text) FROM PUBLIC;

