-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alteracao_sol_prescr ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_alteracao_p bigint, dt_alteracao_p timestamp, ie_forma_infusao_p text, nr_seq_dispositivo_p bigint, ie_tipo_dosagem_p text, qt_vol_fase_p bigint, qt_vel_infusao_p bigint, qt_vol_infundido_p bigint, qt_vol_desprezado_p bigint, qt_vol_parcial_p bigint, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text, nr_etapa_evento_p bigint, ie_exige_aprazamento_p text, ie_consiste_inicio_p text, ie_fator_consiste_p text, ds_retorno_p INOUT text, nr_seq_assinatura_p bigint default null, nr_seq_motivo_adm_p bigint default null, nr_seq_reserva_p bigint default null, nr_seq_item_reserva_p bigint default null, nr_seq_prod_reserva_p bigint default null, ie_tipo_analgesia_p text default null, ie_pca_modo_prog_p text default null, qt_vol_infusao_pca_p bigint default null, ie_um_fluxo_pca_p text default null, qt_bolus_pca_p bigint default null, ie_um_bolus_pca_p text default null, qt_intervalo_bloqueio_p bigint default null, qt_dose_inicial_pca_p bigint default null, ie_um_dose_inicio_pca_p text default null, qt_limite_quatro_hora_p bigint default null, ie_um_limite_pca_p text default null, qt_limite_uma_hora_p bigint default null, ie_um_limite_hora_pca_p text default null, nm_usuario_conf_p text default null, ie_bomba_infusao_p text default null, nr_seq_equipamento_p bigint default null, nr_bolsa_p text default null, nr_seq_equipamento_channel_p text default null, qt_dose_nais_p bigint default null, qt_unid_medida_nais_p text default null, IE_STERILE_PREPARATION_P prescr_solucao_evento.ie_sterile_preparation%type default null, seq_bomba_infusao_p prescr_solucao_evento.nr_seq_bomba_event%type default null) AS $body$
DECLARE

		
ie_solucao_pendente_w	varchar(1) := 'N';
ie_acm_sn_w		varchar(1) := 'N';
ie_solucao_aprazada_w	varchar(1) := 'N';
ds_msg_w		varchar(255);
ds_retorno_w		varchar(255);


BEGIN

if (ie_alteracao_p = 1) then
	begin
	if (ie_exige_aprazamento_p = 'N') then
		begin
		if (ie_tipo_solucao_p = 1) then
			begin
			ie_acm_sn_w := obter_se_sol_acm_sn(nr_prescricao_p, nr_seq_solucao_p);
				if (ie_acm_sn_w = 'S')then
				begin
				 select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				 into STRICT	ie_solucao_aprazada_w
				 from	prescr_mat_hor
				 where	nr_prescricao = nr_prescricao_p
				 and	nr_seq_solucao = nr_seq_solucao_p
				 and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
				
				 if (ie_solucao_aprazada_w = 'N') then
				 begin
					---No time has been set for this solution, it is not possible to start it!
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(261448);
				 end;
				 end if;	
				end;
				end if;
			end;
		end if;
		if (ie_tipo_solucao_p = 6) then
			begin
			ie_acm_sn_w := obter_se_npt_acm(nr_prescricao_p, nr_seq_solucao_p);
				if (ie_acm_sn_w = 'S')then
				begin
				 select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				 into STRICT	ie_solucao_aprazada_w
				 from  nut_paciente_hor a, 
					   nut_pac b where  a.nr_seq_nut_protocolo = b.nr_sequencia
				 and  a.ie_horario_especial <> 'S'
				 and  b.nr_prescricao = nr_prescricao_p
				 and  a.nr_seq_nut_protocolo = nr_seq_solucao_p LIMIT 1;
				
				if (ie_solucao_aprazada_w = 'N') then
				begin
					---No time has been set for this solution, it is not possible to start it!
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(261448);
				end;
				end if;
			end;
		end if;
		end;
	end if;
	end;
end if;
	
	if (ie_consiste_inicio_p <> 'N') then
		begin
		ie_solucao_pendente_w := adep_consistir_inicio_sol(
			nr_atendimento_p, nr_prescricao_p, nr_seq_solucao_p, ie_tipo_solucao_p, ie_fator_consiste_p, ie_solucao_pendente_w);
			
		if (ie_solucao_pendente_w = 'S') then
			begin
			if (ie_consiste_inicio_p = 'I') then
				begin
				---There are previous pending solutions! It is necessary to check the pending solutions before starting new solutions. Parameter [59].
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(261449);				
				
				end;
			elsif (ie_consiste_inicio_p = 'A') then
				begin
				--ds_retorno_p := 'There are previous pending solutions! Parameter [59].';
				ds_retorno_w	:= Wheb_mensagem_pck.get_texto(297011,null) ||' ';
				end;
			end if;			
			end;
		end if;
		end;
	end if;
	end;
end if;

ds_msg_w := gerar_alteracao_solucao_prescr(
	cd_estabelecimento_p, nr_atendimento_p, ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, ie_alteracao_p, dt_alteracao_p, ie_forma_infusao_p, nr_seq_dispositivo_p, ie_tipo_dosagem_p, qt_vol_fase_p, qt_vel_infusao_p, qt_vol_infundido_p, qt_vol_desprezado_p, qt_vol_parcial_p, nr_seq_motivo_p, ds_observacao_p, nm_usuario_p, nr_etapa_evento_p, null, ie_bomba_infusao_p, ie_tipo_analgesia_p, ie_pca_modo_prog_p, qt_vol_infusao_pca_p, ie_um_fluxo_pca_p, qt_bolus_pca_p, ie_um_bolus_pca_p, qt_intervalo_bloqueio_p, qt_dose_inicial_pca_p, ie_um_dose_inicio_pca_p, qt_limite_quatro_hora_p, ie_um_limite_pca_p, qt_limite_uma_hora_p, ie_um_limite_hora_pca_p, null, null, null, nr_seq_reserva_p, nr_seq_item_reserva_p, nr_seq_prod_reserva_p, null, null, nr_seq_assinatura_p, null, null, null, nr_seq_motivo_adm_p, ds_msg_w, null, nm_usuario_conf_p, nr_bolsa_p, null, qt_dose_nais_p, qt_unid_medida_nais_p, null, IE_STERILE_PREPARATION_P, seq_bomba_infusao_p);

	select (CASE WHEN (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') THEN ds_retorno_w || chr(13) || ds_msg_w ELSE ds_msg_w END)
	into STRICT ds_retorno_p
	;
	
	CALL gqa_atualiza_etapas_mentor(nr_atendimento_p);
	
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alteracao_sol_prescr ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_alteracao_p bigint, dt_alteracao_p timestamp, ie_forma_infusao_p text, nr_seq_dispositivo_p bigint, ie_tipo_dosagem_p text, qt_vol_fase_p bigint, qt_vel_infusao_p bigint, qt_vol_infundido_p bigint, qt_vol_desprezado_p bigint, qt_vol_parcial_p bigint, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text, nr_etapa_evento_p bigint, ie_exige_aprazamento_p text, ie_consiste_inicio_p text, ie_fator_consiste_p text, ds_retorno_p INOUT text, nr_seq_assinatura_p bigint default null, nr_seq_motivo_adm_p bigint default null, nr_seq_reserva_p bigint default null, nr_seq_item_reserva_p bigint default null, nr_seq_prod_reserva_p bigint default null, ie_tipo_analgesia_p text default null, ie_pca_modo_prog_p text default null, qt_vol_infusao_pca_p bigint default null, ie_um_fluxo_pca_p text default null, qt_bolus_pca_p bigint default null, ie_um_bolus_pca_p text default null, qt_intervalo_bloqueio_p bigint default null, qt_dose_inicial_pca_p bigint default null, ie_um_dose_inicio_pca_p text default null, qt_limite_quatro_hora_p bigint default null, ie_um_limite_pca_p text default null, qt_limite_uma_hora_p bigint default null, ie_um_limite_hora_pca_p text default null, nm_usuario_conf_p text default null, ie_bomba_infusao_p text default null, nr_seq_equipamento_p bigint default null, nr_bolsa_p text default null, nr_seq_equipamento_channel_p text default null, qt_dose_nais_p bigint default null, qt_unid_medida_nais_p text default null, IE_STERILE_PREPARATION_P prescr_solucao_evento.ie_sterile_preparation%type default null, seq_bomba_infusao_p prescr_solucao_evento.nr_seq_bomba_event%type default null) FROM PUBLIC;

