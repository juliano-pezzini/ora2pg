-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_censo_mensal ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_tipo_operacao_p text, ie_informacao_p text, cd_estabelecimento_p bigint, ds_meses_p INOUT text) AS $body$
DECLARE


dt_mes_w			timestamp;
ie_acao_w			varchar(1);
nr_seq_segurado_w		bigint;
nr_seq_censo_w			bigint;
cd_estabelecimento_w		bigint;
nr_seq_plano_w			bigint;
ie_segmentacao_w		varchar(3);
ie_tipo_contratacao_w		varchar(2);
nr_seq_faixa_etaria_w		bigint;
ie_regulamentacao_w		varchar(2);
nr_seq_vendedor_canal_w		bigint;
nr_seq_contrato_w		bigint;
qt_ativos_w			bigint;
ds_meses_w			varchar(255);
dt_contratacao_w		timestamp;
dt_rescisao_w			timestamp;

C01 CURSOR FOR
	SELECT	dt_mes
	from	mes_v
	where	trunc(dt_mes,'month') between dt_inicial_p and dt_final_p
	order by	dt_mes;

C02 CURSOR FOR
	SELECT	a.nr_sequencia,	/* ativos no mês de referencia */
		'A',
		c.cd_estabelecimento,
		a.nr_seq_plano,
		b.ie_segmentacao,
		b.ie_tipo_contratacao,
		b.ie_regulamentacao,
		a.nr_seq_vendedor_canal,
		a.nr_seq_contrato,
		a.dt_contratacao,
		a.dt_rescisao
	from	pls_segurado a,
		pls_plano b,
		pls_contrato c
	where	a.nr_seq_plano	= b.nr_sequencia
	and	a.nr_seq_contrato	= c.nr_sequencia
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	((a.ie_tipo_segurado = ie_tipo_operacao_p) or (coalesce(ie_tipo_operacao_p::text, '') = ''));

C03 CURSOR FOR
	SELECT	a.nr_sequencia,	/* inclusões no mês */
		'I',
		c.cd_estabelecimento,
		a.nr_seq_plano,
		b.ie_segmentacao,
		b.ie_tipo_contratacao,
		b.ie_regulamentacao,
		a.nr_seq_vendedor_canal,
		a.nr_seq_contrato,
		a.dt_contratacao,
		a.dt_rescisao
	from	pls_segurado a,
		pls_plano b,
		pls_contrato c
	where	a.nr_seq_plano	= b.nr_sequencia
	and	a.nr_seq_contrato	= c.nr_sequencia
	and	dt_mes_w = trunc(a.dt_contratacao,'month')
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	((a.ie_tipo_segurado = ie_tipo_operacao_p) or (coalesce(ie_tipo_operacao_p::text, '') = ''));

C04 CURSOR FOR
	SELECT	a.nr_sequencia,	/* exclusões no mês */
		'E',
		c.cd_estabelecimento,
		a.nr_seq_plano,
		b.ie_segmentacao,
		b.ie_tipo_contratacao,
		b.ie_regulamentacao,
		a.nr_seq_vendedor_canal,
		a.nr_seq_contrato,
		a.dt_contratacao,
		a.dt_rescisao
	from	pls_segurado a,
		pls_plano b,
		pls_contrato c
	where	a.nr_seq_plano	= b.nr_sequencia
	and	a.nr_seq_contrato	= c.nr_sequencia
	and	dt_mes_w = trunc(a.dt_rescisao,'month')
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	((a.ie_tipo_segurado = ie_tipo_operacao_p) or (coalesce(ie_tipo_operacao_p::text, '') = ''));


BEGIN

delete from w_pls_censo;

ds_meses_w	:= '';

open C01;
loop
fetch C01 into
	dt_mes_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_meses_w := ds_meses_w || to_char(dt_mes_w,'mm/yyyy') || ',';
	if (ie_informacao_p	= 'A') then
		open C02;
		loop
		fetch C02 into
			nr_seq_segurado_w,
			ie_acao_w,
			cd_estabelecimento_w,
			nr_seq_plano_w,
			ie_segmentacao_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w,
			nr_seq_vendedor_canal_w,
			nr_seq_contrato_w,
			dt_contratacao_w,
			dt_rescisao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			if (dt_mes_w between trunc(dt_contratacao_w,'month') and coalesce(last_day(add_months(dt_rescisao_w,-1)),dt_mes_w)) then
				select	substr(pls_obter_faixa_etaria_padrao(nr_seq_segurado_w,'S','IG', cd_estabelecimento_p),1,10) nr_seq_faixa_etaria
				into STRICT	nr_seq_faixa_etaria_w
				;

				select	nextval('w_pls_censo_seq')
				into STRICT	nr_seq_censo_w
				;

				insert into	w_pls_censo(	nr_sequencia,
								dt_mes_referencia,
								cd_estabelecimento,
								dt_atualizacao,
								nm_usuario,
								nr_seq_operadora,
								nr_seq_plano,
								nr_seq_segurado,
								ie_segmentacao,
								ie_tipo_contratacao,
								nr_seq_faixa_etaria,
								ie_regulamentacao,
								nr_seq_vendedor_canal,
								nr_seq_contrato,
								ie_situacao_beneficiario)
							values (	nr_seq_censo_w,
								dt_mes_w,
								cd_estabelecimento_w,
								clock_timestamp(),
								nm_usuario_p,
								cd_estabelecimento_w,
								nr_seq_plano_w,
								nr_seq_segurado_w,
								ie_segmentacao_w,
								ie_tipo_contratacao_w,
								nr_seq_faixa_etaria_w,
								ie_regulamentacao_w,
								nr_seq_vendedor_canal_w,
								nr_seq_contrato_w,
								ie_acao_w);
			end if;
		end loop;
		close C02;
	elsif (ie_informacao_p	= 'I') then
		open C03;
		loop
		fetch C03 into
			nr_seq_segurado_w,
			ie_acao_w,
			cd_estabelecimento_w,
			nr_seq_plano_w,
			ie_segmentacao_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w,
			nr_seq_vendedor_canal_w,
			nr_seq_contrato_w,
			dt_contratacao_w,
			dt_rescisao_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			select	substr(pls_obter_faixa_etaria_padrao(nr_seq_segurado_w,'S','IG', cd_estabelecimento_p),1,10) nr_seq_faixa_etaria
			into STRICT	nr_seq_faixa_etaria_w
			;

			select	nextval('w_pls_censo_seq')
			into STRICT	nr_seq_censo_w
			;

			insert into	w_pls_censo(	nr_sequencia,
							dt_mes_referencia,
							cd_estabelecimento,
							dt_atualizacao,
							nm_usuario,
							nr_seq_operadora,
							nr_seq_plano,
							nr_seq_segurado,
							ie_segmentacao,
							ie_tipo_contratacao,
							nr_seq_faixa_etaria,
							ie_regulamentacao,
							nr_seq_vendedor_canal,
							nr_seq_contrato,
							ie_situacao_beneficiario)
						values (	nr_seq_censo_w,
							dt_mes_w,
							cd_estabelecimento_w,
							clock_timestamp(),
							nm_usuario_p,
							cd_estabelecimento_w,
							nr_seq_plano_w,
							nr_seq_segurado_w,
							ie_segmentacao_w,
							ie_tipo_contratacao_w,
							nr_seq_faixa_etaria_w,
							ie_regulamentacao_w,
							nr_seq_vendedor_canal_w,
							nr_seq_contrato_w,
							ie_acao_w);
			end;
		end loop;
		close C03;
	elsif (ie_informacao_p	= 'E') then
		open C04;
		loop
		fetch C04 into
			nr_seq_segurado_w,
			ie_acao_w,
			cd_estabelecimento_w,
			nr_seq_plano_w,
			ie_segmentacao_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w,
			nr_seq_vendedor_canal_w,
			nr_seq_contrato_w,
			dt_contratacao_w,
			dt_rescisao_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			select	substr(pls_obter_faixa_etaria_padrao(nr_seq_segurado_w,'S','IG', cd_estabelecimento_p),1,10) nr_seq_faixa_etaria
			into STRICT	nr_seq_faixa_etaria_w
			;

			select	nextval('w_pls_censo_seq')
			into STRICT	nr_seq_censo_w
			;

			insert into	w_pls_censo(	nr_sequencia,
							dt_mes_referencia,
							cd_estabelecimento,
							dt_atualizacao,
							nm_usuario,
							nr_seq_operadora,
							nr_seq_plano,
							nr_seq_segurado,
							ie_segmentacao,
							ie_tipo_contratacao,
							nr_seq_faixa_etaria,
							ie_regulamentacao,
							nr_seq_vendedor_canal,
							nr_seq_contrato,
							ie_situacao_beneficiario)
						values (	nr_seq_censo_w,
							dt_mes_w,
							cd_estabelecimento_w,
							clock_timestamp(),
							nm_usuario_p,
							cd_estabelecimento_w,
							nr_seq_plano_w,
							nr_seq_segurado_w,
							ie_segmentacao_w,
							ie_tipo_contratacao_w,
							nr_seq_faixa_etaria_w,
							ie_regulamentacao_w,
							nr_seq_vendedor_canal_w,
							nr_seq_contrato_w,
							ie_acao_w);
			end;
		end loop;
		close C04;
	end if;
end loop;
close C01;

ds_meses_p	:= ds_meses_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_censo_mensal ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_tipo_operacao_p text, ie_informacao_p text, cd_estabelecimento_p bigint, ds_meses_p INOUT text) FROM PUBLIC;

