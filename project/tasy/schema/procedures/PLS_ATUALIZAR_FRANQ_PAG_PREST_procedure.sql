-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_franq_pag_prest (nr_seq_franq_pag_prest_p pls_franq_pag_prest.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text) AS $body$
DECLARE


nr_seq_regra_w	 		pls_regra_franq_pag_prest.nr_seq_regra%type;
vl_incidente_w			pls_franq_pag_conta_res.vl_liberado%type;
vl_nao_incidente_w		pls_franq_pag_conta_res.vl_liberado%type;
nr_seq_franq_pag_w		pls_franq_pag_prest.nr_seq_franq_pag%type;

vl_franquia_w			pls_regra_franq_pag.vl_franquia%type;
vl_producao_w			pls_franq_pag_prest_prod.vl_producao%type;
vl_prod_incidente_w		pls_franq_pag_prest_prod.vl_prod_incidente%type;
vl_prod_nao_incidente_w		pls_franq_pag_prest_prod.vl_prod_nao_incidente%type;
vl_item_w			pls_franq_pag_prest_item.vl_item%type;
nr_seq_prestador_w		pls_pagamento_prestador.nr_seq_prestador%type;
nr_seq_lote_pgto_w		pls_pagamento_prestador.nr_seq_lote%type;
vl_prod_pag_w			pls_pagamento_prestador.vl_pagamento%type;

c01 CURSOR(nr_seq_franq_pag_prest_w	pls_franq_pag_prest_prod.nr_seq_franq_pag_prest%type) FOR
	SELECT	nr_sequencia
	from	pls_franq_pag_prest_prod
	where	nr_seq_franq_pag_prest	= nr_seq_franq_pag_prest_w;

BEGIN

select	max(nr_seq_franq_pag),
	max(nr_seq_regra)
into STRICT	nr_seq_franq_pag_w,
	nr_seq_regra_w
from	pls_franq_pag_prest
where	nr_sequencia = nr_seq_franq_pag_prest_p;

select	max(vl_franquia)
into STRICT	vl_franquia_w
from	pls_regra_franq_pag
where	nr_sequencia = nr_seq_regra_w;

for r_c01_w in c01(nr_seq_franq_pag_prest_p) loop
	select	coalesce(sum(CASE WHEN a.ie_incidente='S' THEN  a.vl_liberado  ELSE 0 END ),0) vl_incidente,
		coalesce(sum(CASE WHEN a.ie_incidente='N' THEN  a.vl_liberado  ELSE 0 END ),0) vl_nao_incidente
	into STRICT	vl_incidente_w,
		vl_nao_incidente_w
	from	pls_franq_pag_conta_res a
	where	a.nr_seq_franq_pag_prod	= r_c01_w.nr_sequencia;

	update	pls_franq_pag_prest_prod a
	set	a.vl_producao		= vl_incidente_w + vl_nao_incidente_w,
		a.vl_prod_incidente	= vl_incidente_w,
		a.vl_prod_nao_incidente	= vl_nao_incidente_w
	where	a.nr_sequencia		= r_c01_w.nr_sequencia;
end loop;

if (coalesce(ie_opcao_p::text, '') = '') then
	select	max(nr_seq_lote_pgto)
	into STRICT	nr_seq_lote_pgto_w
	from	pls_franq_pag
	where	nr_sequencia = nr_seq_franq_pag_w;

	select	max(nr_seq_prestador),
		max(coalesce(vl_ajuste,0))
	into STRICT	nr_seq_prestador_w,
		vl_prod_pag_w
	from	pls_franq_pag_prest
	where	nr_sequencia = nr_seq_franq_pag_prest_p;

	update	pls_pagamento_prestador
	set	vl_pagamento 		= coalesce(vl_pagamento, 0) - vl_prod_pag_w
	where	nr_seq_lote		= nr_seq_lote_pgto_w
	and	nr_seq_prestador 	= nr_seq_prestador_w;
end if;

select	coalesce(sum(a.vl_producao),0),
	coalesce(sum(a.vl_prod_incidente),0),
	coalesce(sum(a.vl_prod_nao_incidente),0)
into STRICT	vl_producao_w,
	vl_prod_incidente_w,
	vl_prod_nao_incidente_w
from	pls_franq_pag_prest_prod a
where	a.nr_seq_franq_pag_prest= nr_seq_franq_pag_prest_p;

select	coalesce(sum(vl_item),0)
into STRICT	vl_item_w
from	pls_franq_pag_prest_item
where	nr_seq_franq_pag_prest	= nr_seq_franq_pag_prest_p;

update	pls_franq_pag_prest a
set	a.vl_producao		= vl_producao_w,
	a.vl_prod_incidente	= vl_prod_incidente_w,
	a.vl_prod_nao_incidente	= vl_prod_nao_incidente_w,
	a.vl_item		= vl_item_w,
	a.vl_base_franquia	= vl_prod_incidente_w + vl_item_w,
	a.vl_ajuste		= vl_franquia_w - (vl_prod_incidente_w + vl_item_w)
where	a.nr_sequencia		= nr_seq_franq_pag_prest_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_franq_pag_prest (nr_seq_franq_pag_prest_p pls_franq_pag_prest.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text) FROM PUBLIC;

