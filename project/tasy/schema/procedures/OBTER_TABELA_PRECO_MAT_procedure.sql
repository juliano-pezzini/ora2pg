-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_tabela_preco_mat ( nr_seq_mat_autor_p bigint, nm_usuario_p text, cd_tab_preco_mat_p INOUT bigint, ie_origem_preco_p INOUT bigint, dt_referencia_p timestamp default null) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
nr_atendimento_w		bigint;
nr_seq_agenda_w			agenda_paciente.nr_sequencia%type;
nr_seq_agenda_consulta_w	agenda_consulta.nr_sequencia%type;
nr_seq_gestao_w			bigint;
nr_seq_paciente_w		bigint;
cd_convenio_w			bigint;
cd_material_w			bigint;
cd_tipo_acomodacao_w		bigint;
ie_tipo_atendimento_w		smallint;
vl_preco_w			double precision;
dt_ult_vigencia_w		timestamp;
cd_tab_preco_mat_w		bigint;
ie_origem_preco_w		bigint;
cd_categoria_w			bigint;
cd_cgc_fornec_w			varchar(14);
nr_seq_bras_preco_w		bigint;
nr_seq_mat_bras_w		bigint;
nr_seq_conv_bras_w		bigint;
nr_seq_conv_simpro_w		bigint;
nr_seq_mat_simpro_w		bigint;
nr_seq_simpro_preco_w		bigint;
nr_seq_ajuste_mat_w		bigint;
nr_seq_classif_atend_w		atendimento_paciente.nr_seq_classificacao%type;
dt_referencia_w			timestamp;


BEGIN

dt_referencia_w		:= dt_referencia_p;

select	a.cd_estabelecimento,
	a.nr_atendimento,
	a.nr_seq_agenda,
	a.nr_seq_agenda_consulta,
	a.nr_seq_gestao,
	a.nr_seq_paciente_setor,
	a.cd_convenio,
	b.cd_material,
	a.cd_tipo_acomodacao,
	b.cd_cgc_fabricante
into STRICT	cd_estabelecimento_w,
	nr_atendimento_w,
	nr_seq_agenda_w,
	nr_seq_agenda_consulta_w,
	nr_seq_gestao_w,
	nr_seq_paciente_w,
	cd_convenio_w,
	cd_material_w,
	cd_tipo_acomodacao_w,
	cd_cgc_fornec_w
from	autorizacao_convenio a,
	material_autorizado b
where	a.nr_sequencia = b.nr_sequencia_autor
and	b.nr_sequencia = nr_seq_mat_autor_p;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

	select	b.cd_categoria,
		a.ie_tipo_atendimento,
		a.nr_seq_classificacao
	into STRICT	cd_categoria_w,
		ie_tipo_atendimento_w,
		nr_seq_classif_atend_w
	from	atendimento_paciente a,
		atend_categoria_convenio b
	where	a.nr_atendimento = nr_atendimento_w
	and	a.nr_atendimento = b.nr_atendimento
	and	b.nr_seq_interno = obter_atecaco_atendimento(a.nr_atendimento);
	
elsif (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then

	select	cd_categoria,
		ie_tipo_atendimento
	into STRICT	cd_categoria_w,
		ie_tipo_atendimento_w
	from 	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_w;
	
elsif (nr_seq_agenda_consulta_w IS NOT NULL AND nr_seq_agenda_consulta_w::text <> '') then
	
	select	cd_categoria,
		ie_tipo_atendimento
	into STRICT	cd_categoria_w,
		ie_tipo_atendimento_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agenda_consulta_w;
	
elsif (nr_seq_gestao_w IS NOT NULL AND nr_seq_gestao_w::text <> '') then

	select	cd_categoria
	into STRICT	cd_categoria_w
	from	gestao_vaga
	where 	nr_sequencia = nr_seq_gestao_w;
	
elsif (nr_seq_paciente_w IS NOT NULL AND nr_seq_paciente_w::text <> '') then
	
	select	b.cd_categoria,
		b.ie_tipo_atendimento
	into STRICT	cd_categoria_w,
		ie_tipo_atendimento_w
	from	paciente_setor a,
		paciente_setor_convenio b
	where	a.nr_seq_paciente = nr_seq_paciente_w
	and	a.nr_seq_paciente = b.nr_seq_paciente;
	
end if;

if (coalesce(cd_estabelecimento_w::text, '') = '') then
	cd_estabelecimento_w := wheb_usuario_pck.Get_cd_estabelecimento;
end if;

SELECT * FROM Define_Preco_Material(	cd_estabelecimento_w, 		-- cd_estabelecimento_p		number,
			cd_convenio_w,                   -- cd_convenio_p          	number,
			cd_categoria_w,                  -- cd_categoria_p         	varchar2,
			coalesce(dt_referencia_w, clock_timestamp()),   -- dt_vigencia_p          	date,
			cd_material_w,                   -- cd_material_p          	number,
			coalesce(cd_tipo_acomodacao_w,0),     -- cd_tipo_acomodacao_p   	number,
			coalesce(ie_tipo_atendimento_w,0), 	-- ie_tipo_atendimento_p  	number,
			0,                               -- cd_setor_atendimento_p 	number,
			cd_cgc_fornec_w,                 -- cd_cgc_fornecedor_p		varchar2,
			null,                            -- qt_idade_p			number,
			null,                            -- nr_sequencia_p		number,
			null,                            -- cd_plano_p			varchar2,
			null,                            -- cd_proc_referencia_p		number,
			null,                            -- ie_origem_proc_p		number,
			null,                            -- nr_seq_marca_p		number,
			null,                            -- ie_clinica_p			number,
			nr_seq_classif_atend_w,          -- nr_seq_classif_atend_p	number,
			nr_atendimento_w, 		-- nr_atendimento_p		number,
			null,                            -- ie_vago_4_p			varchar2,
			vl_preco_w,                      -- vl_material_p      	 out 	number,
			dt_ult_vigencia_w,               -- dt_ult_vigencia_p  	 out 	date,
			cd_tab_preco_mat_w,              -- cd_tab_preco_mat_p 	 out 	number,
			ie_origem_preco_w,               -- ie_origem_preco_p  	 out 	number,
			nr_seq_bras_preco_w,             -- nr_seq_bras_preco_p	 out	number,
			nr_seq_mat_bras_w,               -- nr_seq_mat_bras_p	 out	number,
			nr_seq_conv_bras_w,              -- nr_seq_conv_bras_p	 out	number,
			nr_seq_conv_simpro_w,            -- nr_seq_conv_simpro_p	 out	number,
			nr_seq_mat_simpro_w,             -- nr_seq_mat_simpro_p	 out	number,
			nr_seq_simpro_preco_w,           -- nr_seq_simpro_preco_p out	number,
			nr_seq_ajuste_mat_w) INTO STRICT 
			vl_preco_w, 
			dt_ult_vigencia_w, 
			cd_tab_preco_mat_w, 
			ie_origem_preco_w, 
			nr_seq_bras_preco_w, 
			nr_seq_mat_bras_w, 
			nr_seq_conv_bras_w, 
			nr_seq_conv_simpro_w, 
			nr_seq_mat_simpro_w, 
			nr_seq_simpro_preco_w, 
			nr_seq_ajuste_mat_w;           -- nr_seq_ajuste_mat_p	 out	number
	
cd_tab_preco_mat_p := cd_tab_preco_mat_w;
ie_origem_preco_w  := ie_origem_preco_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_tabela_preco_mat ( nr_seq_mat_autor_p bigint, nm_usuario_p text, cd_tab_preco_mat_p INOUT bigint, ie_origem_preco_p INOUT bigint, dt_referencia_p timestamp default null) FROM PUBLIC;

