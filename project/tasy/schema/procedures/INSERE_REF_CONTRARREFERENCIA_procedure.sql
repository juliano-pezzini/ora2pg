-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_ref_contrarreferencia ( nr_seq_parecer_p text, nm_usuario_p text default null) AS $body$
DECLARE



dt_nascimento_w		varchar(255);
ie_sexo_w		varchar(1);
cd_pessoa_fisica_w	varchar(10);
ds_crm_retorno_w	varchar(255);
ds_profissional_ret_w	varchar(255);
cd_prestador_w	bigint;
ds_especialidade_ret_w	varchar(255);
cd_prof_solicitante_w	varchar(10);
cd_profissional_ret_w 	varchar(10);
dt_solicitacao_w	timestamp;
dt_retorno_w	timestamp;
ds_solicitacao_w	text;
ds_retorno_w	text;
ds_pessoa_fisica_sol_w	varchar(255);
ds_profissional_sol_w	varchar(255);
ds_idade_w	varchar(255);
ds_sexo_w	varchar(255);
dt_liberacao_w	timestamp;
nm_usuario_w	varchar(15);
cd_cgc_w		varchar(14);


BEGIN


if (nr_seq_parecer_p IS NOT NULL AND nr_seq_parecer_p::text <> '')then

Select  max(coalesce(nm_usuario_p, 'T.I.E')) -- Integração Bifrost
into STRICT	nm_usuario_w
;

select	max(obter_sexo_pf(cd_pessoa_fisica, 'D')) ds_sexo,
		max(obter_sexo_pf(cd_pessoa_fisica, 'C')) ie_sexo,
		max(cd_pessoa_fisica) cd_pessoa_fisica,
		max(dt_liberacao) dt_liberacao,
		max(obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A')) idade,
		max(substr(obter_dados_pf(cd_pessoa_fisica, 'DN'),1,255)) dt_nascimento,
		max(cd_medico) cd_medico,
		max(obter_nome_pf(cd_medico)) nm_medico,
		max(cd_cgc)
into STRICT	ds_sexo_w,
		ie_sexo_w,
		cd_pessoa_fisica_w,
		dt_liberacao_w,
		ds_idade_w,
		dt_nascimento_w,
		ds_pessoa_fisica_sol_w,
		ds_profissional_sol_w,
		cd_cgc_w 
from	parecer_medico_req
where   nr_parecer = nr_seq_parecer_p;



insert into ref_contrarreferencia(nr_sequencia,
		ds_pessoa_fisica_sol,
		ds_idade,
		ds_sexo,                         
		dt_liberacao,   
		nr_seq_parecer,                    
		ie_sexo,                           
		cd_pessoa_fisica,
		cd_cgc,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec, 
		nm_usuario_nrec)
values (nextval('ref_contrarreferencia_seq'),
		ds_pessoa_fisica_sol_w,
		ds_idade_w,
		ds_sexo_w,
		dt_liberacao_w,
		nr_seq_parecer_p,
		ie_sexo_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		clock_timestamp(), 
		nm_usuario_w,
		clock_timestamp(),
		nm_usuario_w);
commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_ref_contrarreferencia ( nr_seq_parecer_p text, nm_usuario_p text default null) FROM PUBLIC;

