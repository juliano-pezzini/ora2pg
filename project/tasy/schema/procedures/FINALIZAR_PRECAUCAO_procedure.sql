-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_precaucao ( nr_seq_precaucao_p bigint, nr_atendimento_p bigint, ie_opcao_p text, nr_seq_motivo_isol_p bigint, nm_usuario_p text, nr_seq_atend_precaucao_p bigint default 0, ds_observacao_p text default null, ie_termino_p text default null, cd_responsavel_p text default null) AS $body$
DECLARE

 
				 
qt_atendimento_precaucao_w		bigint;
dt_final_isolamento_w			timestamp;


BEGIN 
CALL gerar_atendimento_precaucao(0,nr_atendimento_p,'T',0,nm_usuario_p,nr_seq_precaucao_p,null,null,null);
CALL gerar_motivo_isolamento(nr_atendimento_p,0,nm_usuario_p,'T',null,null,null,null,clock_timestamp(),null,nr_seq_precaucao_p);
 
update	atendimento_precaucao 
set	dt_final_precaucao = clock_timestamp() 
where	nr_sequencia = nr_seq_precaucao_p;
 
select count(*)  
into STRICT 	qt_atendimento_precaucao_w 
from  atendimento_precaucao a, 
    cih_precaucao b 
where  a.nr_seq_precaucao = b.nr_sequencia 
 and  a.nr_atendimento = nr_atendimento_p 
 and  coalesce(a.dt_final_precaucao::text, '') = '' 
 and  coalesce(a.dt_inativacao::text, '') = '' 
 and  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
 and  coalesce(b.ie_isolamento,'N') = 'S';
 
if (qt_atendimento_precaucao_w = 0) then 	 
	update	atendimento_paciente 
	set	ie_paciente_isolado = 'N', 
		dt_atualizacao	  = clock_timestamp(), 
		nm_usuario	  = nm_usuario_p 
	where	nr_atendimento   = nr_atendimento_p;
	commit;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_precaucao ( nr_seq_precaucao_p bigint, nr_atendimento_p bigint, ie_opcao_p text, nr_seq_motivo_isol_p bigint, nm_usuario_p text, nr_seq_atend_precaucao_p bigint default 0, ds_observacao_p text default null, ie_termino_p text default null, cd_responsavel_p text default null) FROM PUBLIC;

