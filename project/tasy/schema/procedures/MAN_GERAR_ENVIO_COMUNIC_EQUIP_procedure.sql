-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_envio_comunic_equip ( nr_sequencia_p bigint, ie_evento_p text, ds_valor_ant_p text, ds_valor_atual_p text, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar comunicação interna de ação sobre o equipamento da ordem de serviço
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/*campos regra*/

nr_seq_regra_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicacao_w			varchar(32000);
ie_comunic_interna_w		varchar(01);
ie_email_w			varchar(01);
ds_valor_ant_w			varchar(20);
ds_valor_atual_w			varchar(20);
nr_seq_equip_os_w			bigint;
nr_seq_equip_regra_w		bigint;
ds_equipamento_w			varchar(80);
qt_existe_w			bigint;
nr_seq_classif_w			bigint;
ie_usuario_w			varchar(15);
ds_usuario_destino_w		varchar(2000);
ds_lista_email_destino_w		varchar(2000);
ds_lista_email_oculta_w		varchar(2000);
ds_email_origem_w			varchar(255);
cd_perfil_w			integer	:= obter_perfil_ativo;
ds_usuario_desconsid_regra_w	varchar(2000);
ie_fora_horario_manut_w		varchar(15);
dt_hr_inicio_w			timestamp;
dt_hr_fim_w			timestamp;
ds_usuario_email_w			varchar(15);

/*Campos Equipamento*/

ds_equip_w			varchar(80);
ds_tipo_equip_w			varchar(50);
ds_localizacao_w			varchar(50);
ds_justif_grau_satisf_w		varchar(255);
ds_propriedade_w			varchar(254);
ds_situacao_equip_w		varchar(255);
ds_grupo_planej_equip_w		varchar(80);
ds_grupo_trab_equip_w		varchar(80);
nr_seq_grupo_planej_w		bigint;
nr_seq_grupo_trabalho_w		bigint;
ds_local_setor_atual_w		varchar(255);
ds_local_setor_ant_w		varchar(255);

/*Campos CI*/

nm_usuario_w			varchar(2000);

/*Campos EMAIL*/

lista_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w			smallint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);

ie_gerar_w			varchar(01) := 'S';

ie_marcar_ci_lida_remetente_w	man_regra_envio_comunic.ie_marcar_ci_lida_remetente%type;
nr_seq_comunic_w			comunic_interna.nr_sequencia%type;
ie_lista_destino_oculta_w		man_regra_envio_comunic.ie_lista_destino_oculta%type;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_titulo,
		ds_comunicacao,
		ie_comunicacao_interna,
		ie_email,
		ds_valor_ant,
		ds_valor_atual,
		nr_seq_equipamento,
		ds_lista_email_destino,
		ds_email_origem,
		ds_usuario_desconsid_regra,
		ie_fora_horario_manut,
		CASE WHEN coalesce(ie_param_cliente_email_origem,'N')='S' THEN null  ELSE nm_usuario_p END ,
		coalesce(ie_marcar_ci_lida_remetente, 'N'),
		coalesce(ie_lista_destino_oculta,'N')
	from	man_regra_envio_comunic
	where	ie_evento = ie_evento_p
	and	coalesce(ie_situacao,'A') = 'A';

c02 CURSOR FOR
	SELECT	ie_usuario,
		ds_usuario_destino
	from	man_usuarios_comunicacao
	where	nr_seq_regra = nr_seq_regra_w;


BEGIN

select	count(*)
into STRICT	qt_existe_w
from	man_regra_envio_comunic
where	ie_evento = ie_evento_p
and	coalesce(ie_situacao,'A') = 'A';

select	nr_seq_planej,
	nr_seq_trab
into STRICT	nr_seq_grupo_planej_w,
	nr_seq_grupo_trabalho_w
from	man_equipamento
where	nr_sequencia = nr_sequencia_p;

if (qt_existe_w > 0) then
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_regra_w,
		ds_titulo_w,
		ds_comunicacao_w,
		ie_comunic_interna_w,
		ie_email_w,
		ds_valor_ant_w,
		ds_valor_atual_w,
		nr_seq_equip_regra_w,
		ds_lista_email_destino_w,
		ds_email_origem_w,
		ds_usuario_desconsid_regra_w,
		ie_fora_horario_manut_w,
		ds_usuario_email_w,
		ie_marcar_ci_lida_remetente_w,
		ie_lista_destino_oculta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_gerar_w := 'S';

		select	count(*)
		into STRICT	qt_existe_w
		from	man_regra_envio_comun_lib
		where	nr_seq_regra = nr_seq_regra_w;

		if (qt_existe_w > 0) then
			begin
			select	count(*)
			into STRICT	qt_existe_w
			from	man_regra_envio_comun_lib
			where	nr_seq_regra = nr_seq_regra_w
			and	((coalesce(cd_perfil::text, '') = '') and (coalesce(nr_seq_grupo_planej::text, '') = '') and (coalesce(nr_seq_grupo_trabalho::text, '') = ''));

			if (qt_existe_w = 0) then
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_gerar_w
				from	man_regra_envio_comun_lib
				where	nr_seq_regra = nr_seq_regra_w
				and	((cd_perfil = cd_perfil_w) or (nr_seq_grupo_planej = coalesce(nr_seq_grupo_planej_w,0)) or (nr_seq_grupo_trabalho = coalesce(nr_seq_grupo_trabalho_w,0)));
			end if;
			end;
		end if;

		if (coalesce(ds_valor_ant_w,'0') <> '0') and (coalesce(ds_valor_ant_p,'0') <> '0') and (coalesce(ds_valor_ant_w,'0') <> coalesce(ds_valor_ant_p,'0')) then
			ie_gerar_w := 'N';
		end if;

		if (coalesce(ds_valor_atual_w,'0') <> '0') and (coalesce(ds_valor_atual_p,'0') <> '0') and (coalesce(ds_valor_atual_w,'0') <> coalesce(ds_valor_atual_p,'0')) then
			ie_gerar_w := 'N';
		end if;

		if (coalesce(nr_seq_equip_regra_w,'0') <> '0') and (coalesce(nr_seq_equip_os_w,'0') <> '0') and (coalesce(nr_seq_equip_regra_w,'0') <> coalesce(nr_seq_equip_os_w,'0')) then
			ie_gerar_w := 'N';
		end if;

		if (coalesce(ie_fora_horario_manut_w,'N') = 'S') then
			begin
			select	max(to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || substr(hr_inicio,1,2) || ':' ||substr(hr_inicio,3,4),'dd/mm/yy hh24:mi')),
				max(to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || substr(hr_fim,1,2) || ':' ||substr(hr_fim,3,4),'dd/mm/yy hh24:mi'))
			into STRICT	dt_hr_inicio_w,
				dt_hr_fim_w
			from	man_horario_trabalho
			where	ie_dia_semana = pkg_date_utils.get_WeekDay(clock_timestamp())
			and	man_obter_se_hor_trab_lib(nr_sequencia,nr_seq_grupo_planej_w,nr_seq_grupo_trabalho_w,nm_usuario_p) = 'S';

			if (clock_timestamp() >= coalesce(dt_hr_inicio_w,clock_timestamp() + interval '1 days'/1440)) and (clock_timestamp() <= coalesce(dt_hr_fim_w,clock_timestamp() - interval '1 days'/1440)) then
				ie_gerar_w := 'N';
			end if;
			end;
		end if;

		if (coalesce(ie_gerar_w,'S') = 'S') then
			begin
			select	substr(ds_equipamento,1,80) ds_equipamento,
				substr(man_obter_desc_tipo_equip(nr_seq_tipo_equip),1,50) ds_tipo_equip,
				substr(obter_desc_man_localizacao(nr_seq_local),1,80) ds_localizacao,

				substr(obter_valor_dominio(1632,ie_propriedade),1,254) ds_propriedade,
				substr(CASE WHEN ie_situacao='A' THEN wheb_mensagem_pck.get_texto(304365)  ELSE wheb_mensagem_pck.get_texto(304366) END ,1,255) ds_situacao,
				substr(obter_desc_grupo_planej(nr_seq_planej),1,80) ds_grupo_planej,
				substr(obter_desc_grupo_trab(nr_seq_trab),1,80) ds_grupo_trab,
				substr(man_obter_dados_localizacao(nr_seq_local,'LS'),1,255)
			into STRICT	ds_equip_w,
				ds_tipo_equip_w,
				ds_localizacao_w,
				ds_propriedade_w,
				ds_situacao_equip_w,
				ds_grupo_planej_equip_w,
				ds_grupo_trab_equip_w,
				ds_local_setor_atual_w
			from	man_equipamento
			where	nr_sequencia = nr_sequencia_p;

			open C02;
			loop
			fetch C02 into
				ie_usuario_w,
				ds_usuario_destino_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (ie_usuario_w = 'U') and (coalesce(ds_usuario_destino_w,'X') <> 'X') then
					nm_usuario_w	:= substr(ds_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
				end if;
				end;
			end loop;
			close C02;

			/*Macros*/

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@nr_equipamento', nr_sequencia_p),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_equipamento', nr_sequencia_p),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_equipamento', ds_equip_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_equipamento', ds_equip_w),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_tipo_equip', ds_tipo_equip_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_tipo_equip', ds_tipo_equip_w),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_localizacao', ds_localizacao_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_localizacao', ds_localizacao_w),1,32000);

			ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,32000);
			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,255);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_propriedade', ds_propriedade_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_propriedade', ds_propriedade_w),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_situacao_atual', ds_situacao_equip_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_situacao_atual', ds_situacao_equip_w),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_planej_atual', ds_grupo_planej_equip_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_planej_atual', ds_grupo_planej_equip_w),1,32000);

			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_trab_atual', ds_grupo_trab_equip_w),1,255);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_trab_atual', ds_grupo_trab_equip_w),1,32000);

			if (ie_evento_p <> '15') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_local_setor_atual', ds_local_setor_atual_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_local_setor_atual', ds_local_setor_atual_w),1,32000);
				end;
			end if;

			if (ie_evento_p = '15') then /* Equipamento - Alteração de localização */
				begin
				select	substr(man_obter_dados_localizacao(ds_valor_ant_p,'LS'),1,255),
					substr(man_obter_dados_localizacao(ds_valor_atual_p,'LS'),1,255)
				into STRICT	ds_local_setor_ant_w,
					ds_local_setor_atual_w
				;

				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,255);

				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_local_setor_ant', ds_local_setor_ant_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_local_setor_ant', ds_local_setor_ant_w),1,32000);

				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_local_setor_atual', ds_local_setor_atual_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_local_setor_atual', ds_local_setor_atual_w),1,32000);
				end;
			end if;

			if (ie_comunic_interna_w = 'S') then
				begin
				if (coalesce(nm_usuario_w,'X') <> 'X') then
					begin
					select	obter_classif_comunic('F')
					into STRICT	nr_seq_classif_w
					;

					select	nextval('comunic_interna_seq')
					into STRICT	nr_seq_comunic_w
					;

					insert into comunic_interna(dt_comunicado,
						ds_titulo,
						ds_comunicado,
						nm_usuario,
						dt_atualizacao,
						ie_geral,
						nm_usuario_destino,
						cd_perfil,
						nr_sequencia,
						ie_gerencial,
						nr_seq_classif,
						ds_perfil_adicional,
						cd_setor_destino,
						cd_estab_destino,
						ds_setor_adicional,
						dt_liberacao,
						ds_grupo,
						nm_usuario_oculto)
					values (clock_timestamp(),
						ds_titulo_w,
						ds_comunicacao_w,
						nm_usuario_p,
						clock_timestamp(),
						'N',
						nm_usuario_w,
						null,
						nr_seq_comunic_w,
						'N',
						nr_seq_classif_w,
						'',
						null,
						'',
						'',
						clock_timestamp(),
						'',
						'');

					if (ie_marcar_ci_lida_remetente_w = 'S') then
						insert into comunic_interna_lida(nr_sequencia,
							nm_usuario,
							dt_atualizacao)
						values (nr_seq_comunic_w,
							nm_usuario_p,
							clock_timestamp());
					end if;
					end;
				end if;
				end;
			end if;

			if (ie_email_w = 'S') then
				begin
				if (coalesce(ds_usuario_email_w,'X') = 'X') and (coalesce(ds_email_origem_w,'X') = 'X') then
					begin
					CALL wheb_mensagem_pck.exibir_mensagem_abort(249815,'DS_REGRA=' || substr('(' || nr_seq_regra_w || ') - ' || obter_valor_dominio(3420,ie_evento_p),1,255));
					end;
				end if;

				lista_usuario_w := substr(nm_usuario_w,1,2000);
				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop
					tam_lista_w	:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);

					if (ie_pos_virgula_w <> 0) then
						nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));

						select	max(ds_email)
						into STRICT	ds_email_usuario_w
						from	usuario
						where	nm_usuario = nm_usuario_w;

						if (coalesce(ds_email_usuario_w,'X') <> 'X') then
							begin
							ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
							end;
						end if;
					else
						lista_usuario_w	:= null;
					end if;
				end loop;

				if (coalesce(ds_lista_email_destino_w,'X') <> 'X') then
					begin
					if (coalesce(ie_lista_destino_oculta_w,'N') = 'N') then
						ds_lista_email_usuario_w	:= substr(ds_lista_email_destino_w || ',' || ds_lista_email_usuario_w,1,2000);
					else
						ds_lista_email_oculta_w		:= substr(ds_lista_email_destino_w,1,2000);
					end if;
					end;
				end if;

				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
					ds_lista_email_usuario_w	:= replace(ds_lista_email_usuario_w,',',';');
					ds_lista_email_oculta_w 	:= replace(ds_lista_email_oculta_w,',',';');

					CALL enviar_email(	ds_titulo_w,
							ds_comunicacao_w,
							ds_email_origem_w,
							ds_lista_email_usuario_w,
							ds_usuario_email_w,
							'M',
							ds_lista_email_oculta_w);
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_envio_comunic_equip ( nr_sequencia_p bigint, ie_evento_p text, ds_valor_ant_p text, ds_valor_atual_p text, nm_usuario_p text) FROM PUBLIC;

