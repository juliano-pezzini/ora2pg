-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_aprovar_oc_repasse ( nr_titulo_p bigint, nr_seq_nf_p bigint, vl_titulo_p bigint, vl_saldo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
	 
nr_ordem_compra_w		bigint;
nm_user_w			varchar(50);
ie_gerar_ordem_titulo_w		varchar(1);
ie_possui_titulo_ordem_W	varchar(1);

C01 CURSOR FOR 
	SELECT nr_ordem_compra 
	from	nota_fiscal_item_rep a 
	where	a.nr_seq_nf	= nr_seq_nf_p 
	and	(a.nr_ordem_compra IS NOT NULL AND a.nr_ordem_compra::text <> '') 
	and	vl_saldo_p		= 0 
	and (nm_user_w = 'CORP');
	
C02 CURSOR FOR 
	SELECT	nr_ordem_compra 
	from	ordem_compra 
	where	nr_titulo_receber = nr_titulo_p 
	and	nr_seq_nf_repasse = nr_seq_nf_p 
	and (nm_user_w = 'CORP');


BEGIN 
 
ie_gerar_ordem_titulo_w := Obter_Valor_Param_Usuario(1005,8, Obter_perfil_Ativo, nm_usuario_p, 0);
 
select	username 
into STRICT	nm_user_w 
from	user_users;
 
if (ie_gerar_ordem_titulo_w = 'S') then 
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_possui_titulo_ordem_W 
	from	ordem_compra 
	where	nr_titulo_receber = nr_titulo_p 
	and	nr_seq_nf_repasse = nr_seq_nf_p 
	and (nm_user_w = 'CORP');
	 
	if (ie_possui_titulo_ordem_W = 'S') then 
	 
		open C02;
		loop 
		fetch C02 into	 
			nr_ordem_compra_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			Gerar_Aprov_Ordem_Compra(nr_ordem_compra_w, null, 'S', nm_usuario_p);
			end;
		end loop;
		close C02;
	else 
		OPEN C01;
		LOOP 
		FETCH C01 into 
			nr_ordem_compra_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			CALL Gerar_Aprov_Ordem_Compra(nr_ordem_compra_w, null, 'S', nm_usuario_p);
		END LOOP;
		CLOSE C01;	
	end if;	
else		 
	OPEN C01;
	LOOP 
	FETCH C01 into 
		nr_ordem_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		CALL Gerar_Aprov_Ordem_Compra(nr_ordem_compra_w, null, 'S', nm_usuario_p);
	END LOOP;
	CLOSE C01;	
end if;
 
 
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_aprovar_oc_repasse ( nr_titulo_p bigint, nr_seq_nf_p bigint, vl_titulo_p bigint, vl_saldo_p bigint, nm_usuario_p text) FROM PUBLIC;

