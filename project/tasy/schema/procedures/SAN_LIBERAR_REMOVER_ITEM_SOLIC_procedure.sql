-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_liberar_remover_item_solic ( nr_seq_reserva_p bigint, nr_seq_item_p bigint, ie_opcao_p text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/*
L - Liberar
D - Desfazer liberação
*/
nr_prescricao_w                  bigint;
nr_seq_horario_w		 bigint;
nr_seq_prescr_w     		 integer;
ie_atualiza_hor_hemoterap_w	 varchar(1);
ie_exige_lib_reserva_w		 varchar(1);
ie_reserva_prescr_w		 varchar(1);
dt_lib_reserva_w		 timestamp;


BEGIN

ie_atualiza_hor_hemoterap_w := obter_param_usuario(1113, 597, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_hor_hemoterap_w);

if (nr_seq_reserva_p IS NOT NULL AND nr_seq_reserva_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '')  then

	if (ie_opcao_p = 'L') then

		select  max(nr_prescricao),
			max(nr_seq_prescr)
		into STRICT	nr_prescricao_w,
			nr_seq_prescr_w
		from	san_reserva_item
		where	nr_seq_reserva	= nr_seq_reserva_p
		and	nr_seq_item	= nr_seq_item_p;

		select  san_obter_se_reserva(nr_prescricao_w)
		into STRICT	ie_reserva_prescr_w
		;

		select  max(IE_EXIGE_LIB_RESERVA)
		into STRICT    ie_exige_lib_reserva_w
		from    san_parametro
		where   cd_estabelecimento = cd_estabelecimento_p;

		select  max(dt_lib_reserva)
		into STRICT	dt_lib_reserva_w
		from    san_reserva
		where 	nr_sequencia = nr_seq_reserva_p;

		if (ie_exige_lib_reserva_w = 'S') and (coalesce(dt_lib_reserva_w::text, '') = '') and (ie_reserva_prescr_w = 'S') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(558205);
		else
			update	san_reserva_item
			set	dt_liberacao 	= clock_timestamp(),
				nm_usuario_lib 	= nm_usuario_p
			where	nr_seq_reserva	= nr_seq_reserva_p
			and	nr_seq_item	= nr_seq_item_p;

		end if;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

		update	prescr_procedimento
		set	dt_liberacao_hemoterapia = clock_timestamp(),
			dt_status = clock_timestamp(),
			nm_usuario_lib_hemoterapia = nm_usuario_p
		where	nr_prescricao	= nr_prescricao_w
		and	nr_sequencia	= nr_seq_prescr_w;

		select	max(nr_sequencia)
		into STRICT	nr_seq_horario_w
		from	prescr_proc_hor
		where	nr_prescricao = nr_prescricao_w
		and	nr_seq_procedimento = nr_seq_prescr_w;

		if (ie_atualiza_hor_hemoterap_w = 'S') and (nr_seq_horario_w IS NOT NULL AND nr_seq_horario_w::text <> '') and (nr_seq_horario_w > 0) then
			update	prescr_proc_hor
			set	dt_horario = clock_timestamp()
			where	nr_sequencia = nr_seq_horario_w;
		end if;

	end if;

	elsif (ie_opcao_p = 'D') then
		update	san_reserva_item
		set	dt_liberacao 	 = NULL,
			nm_usuario_lib 	 = NULL
		where	nr_seq_reserva	= nr_seq_reserva_p
		and	nr_seq_item	= nr_seq_item_p;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_liberar_remover_item_solic ( nr_seq_reserva_p bigint, nr_seq_item_p bigint, ie_opcao_p text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

