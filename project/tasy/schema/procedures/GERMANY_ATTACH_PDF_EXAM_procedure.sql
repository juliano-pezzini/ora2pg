-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_attach_pdf_exam ( nr_atendimento_p text, nr_prescr_ext_p text, cd_exame_p text, ds_arquivo_imagem_p text, nr_seq_sistema_p bigint) AS $body$
DECLARE

			
nr_seq_result_lab_w	bigint;
nm_usuario_w		usuario.nm_usuario%type;
ds_pasta_exp_xml_w	varchar(2000);
nr_seq_prescr_w		bigint;
nr_prescr_w		bigint;
nr_prescricao_w		prescr_medica.nr_prescricao%type;
nr_seq_empresa_w	bigint;


BEGIN
begin
if (nr_seq_sistema_p = 148) then
	nr_seq_empresa_w	:= 84;
end if;

select	max(ds_caminho_entrada)
into STRICT	ds_pasta_exp_xml_w
from    empresa_integr_dados a,
	empresa_integracao b,
	sistema_integracao c
where	a.nr_seq_empresa_integr = b.nr_sequencia
and	b.nr_sequencia = c.nr_seq_empresa
and	c.nr_sequencia = nr_seq_sistema_p
and     b.nr_sequencia = nr_seq_empresa_w;

if (coalesce(ds_pasta_exp_xml_w::text, '') = '') then
	select	max(ds_caminho_entrada)
	into STRICT	ds_pasta_exp_xml_w
	from    empresa_integr_dados a,
		empresa_integracao b,
		sistema_integracao c
	where	a.nr_seq_empresa_integr = b.nr_sequencia
	and	b.nr_sequencia = c.nr_seq_empresa
	and     b.nr_sequencia = nr_seq_empresa_w;
end if;

if (nr_seq_sistema_p = 148) then
	nm_usuario_w	:= 'SwissLab';
end if;

select 	max(nr_prescricao)
into STRICT	nr_prescricao_w
from	prescr_medica
where	nr_controle_int_lab	= (nr_prescr_ext_p)::numeric
and	nr_atendimento		= (nr_atendimento_p)::numeric 
and	coalesce(dt_suspensao::text, '') = '';

select 	max(a.nr_sequencia)
into STRICT	nr_seq_prescr_w
from	prescr_procedimento 	a,
	exame_laboratorio	b
where	a.nr_prescricao	= nr_prescricao_w
and	b.nr_seq_exame	= a.nr_seq_exame
and	b.cd_exame_integracao	= cd_exame_p;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_result_lab_w
from	result_laboratorio
where	nr_prescricao		= nr_prescricao_w
and	nr_seq_prescricao	= nr_seq_prescr_w;

insert into result_laboratorio(	nr_sequencia,
		ds_resultado,
		nr_prescricao,
		nr_seq_prescricao,
		nm_usuario,
		dt_atualizacao,
		ie_formato_texto,
		ie_cobranca)
values (	nextval('result_laboratorio_seq'),
		ds_pasta_exp_xml_w||ds_arquivo_imagem_p,
		nr_prescricao_w,
		nr_seq_prescr_w,
		nm_usuario_w,
		clock_timestamp(),
		3,
		'N');

commit;
exception
when others then
	CALL gravar_log_lab(7000,
			substr(dbms_utility.format_error_backtrace,1,4000),
			'GERMANY');
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_attach_pdf_exam ( nr_atendimento_p text, nr_prescr_ext_p text, cd_exame_p text, ds_arquivo_imagem_p text, nr_seq_sistema_p bigint) FROM PUBLIC;

