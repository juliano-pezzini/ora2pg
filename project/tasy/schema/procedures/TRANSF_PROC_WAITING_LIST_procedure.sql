-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transf_proc_waiting_list ( schedule_sequence_p bigint, waiting_list_sequence_p bigint, ie_source_p text) AS $body$
DECLARE


									
nr_sequencia_w agenda_lista_espera_proc.nr_sequencia%type;						

add_procedures_schedule CURSOR FOR
SELECT 	*
from 	agenda_paciente_proc
where 	nr_sequencia = schedule_sequence_p;

add_procedures_waiting_list CURSOR FOR
SELECT 	*
from 	agenda_lista_espera_proc
where 	nr_seq_lista = waiting_list_sequence_p;

BEGIN

if (schedule_sequence_p IS NOT NULL AND schedule_sequence_p::text <> '' AND waiting_list_sequence_p IS NOT NULL AND waiting_list_sequence_p::text <> '') then
	if (ie_source_p = 'S') then
		for aditional_procedure in add_procedures_schedule loop
			insert into agenda_lista_espera_proc(
				nr_sequencia,
				nr_seq_lista,
				dt_atualizacao,
				nm_usuario,
				cd_procedimento,
				ie_origem_proced,
				nr_seq_proc_interno,
				ie_lado,
				cd_medico,
				cd_convenio,
				cd_categoria,
				qt_min_proc,
				cd_plano,
				ie_autorizacao,
				cd_autorizacao,
				cd_medico_req,
				cd_pessoa_indicacao,
				ds_indicacao_clinica,
				cd_procedimento_tuss,
				ds_observacao,
				qt_procedimento,
				dt_cancelamento,
				nm_usuario_cancel,
				ie_cobertura_conv,
				cd_topografia_proced,
				cd_externo,
				dt_agenda_externa,
				dt_agenda_fim_externa
			) values (
				nextval('agenda_lista_espera_proc_seq'),
				waiting_list_sequence_p,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				aditional_procedure.cd_procedimento,
				aditional_procedure.ie_origem_proced,
				aditional_procedure.nr_seq_proc_interno,
				aditional_procedure.ie_lado,
				aditional_procedure.cd_medico,
				aditional_procedure.cd_convenio,
				aditional_procedure.cd_categoria,
				aditional_procedure.qt_min_proc,
				aditional_procedure.cd_plano,
				aditional_procedure.ie_autorizacao,
				aditional_procedure.cd_autorizacao,
				aditional_procedure.cd_medico_req,
				aditional_procedure.cd_pessoa_indicacao,
				aditional_procedure.ds_indicacao_clinica,
				aditional_procedure.cd_procedimento_tuss,
				aditional_procedure.ds_observacao,
				aditional_procedure.qt_procedimento,
				aditional_procedure.dt_cancelamento,
				aditional_procedure.nm_usuario_cancel,
				aditional_procedure.ie_cobertura_conv,
				aditional_procedure.cd_topografia_proced,
				aditional_procedure.cd_externo,
				aditional_procedure.dt_agenda_externa,
				aditional_procedure.dt_agenda_fim_externa
			);
			
			commit;
		end loop;
	elsif (ie_source_p = 'W') then
		for aditional_procedure in add_procedures_waiting_list loop
		
			select coalesce(max(nr_seq_agenda), 0) + 1
			into STRICT nr_sequencia_w
			from agenda_paciente_proc
			where nr_sequencia = schedule_sequence_p;
		
			insert into agenda_paciente_proc(
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				cd_procedimento,
				ie_origem_proced,
				nr_seq_proc_interno,
				ie_lado,
				cd_medico,
				cd_convenio,
				cd_categoria,
				qt_min_proc,
				cd_plano,
				ie_autorizacao,
				cd_autorizacao,
				cd_medico_req,
				cd_pessoa_indicacao,
				ds_indicacao_clinica,
				cd_procedimento_tuss,
				ds_observacao,
				qt_procedimento,
				dt_cancelamento,
				nm_usuario_cancel,
				ie_cobertura_conv,
				cd_topografia_proced,
				cd_externo,
				dt_agenda_externa,
				dt_agenda_fim_externa
			) values (
				schedule_sequence_p,
				nr_sequencia_w,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				aditional_procedure.cd_procedimento,
				aditional_procedure.ie_origem_proced,
				aditional_procedure.nr_seq_proc_interno,
				aditional_procedure.ie_lado,
				aditional_procedure.cd_medico,
				aditional_procedure.cd_convenio,
				aditional_procedure.cd_categoria,
				aditional_procedure.qt_min_proc,
				aditional_procedure.cd_plano,
				aditional_procedure.ie_autorizacao,
				aditional_procedure.cd_autorizacao,
				aditional_procedure.cd_medico_req,
				aditional_procedure.cd_pessoa_indicacao,
				aditional_procedure.ds_indicacao_clinica,
				aditional_procedure.cd_procedimento_tuss,
				aditional_procedure.ds_observacao,
				aditional_procedure.qt_procedimento,
				aditional_procedure.dt_cancelamento,
				aditional_procedure.nm_usuario_cancel,
				aditional_procedure.ie_cobertura_conv,
				aditional_procedure.cd_topografia_proced,
				aditional_procedure.cd_externo,
				aditional_procedure.dt_agenda_externa,
				aditional_procedure.dt_agenda_fim_externa
			);
			
			commit;
		end loop;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transf_proc_waiting_list ( schedule_sequence_p bigint, waiting_list_sequence_p bigint, ie_source_p text) FROM PUBLIC;

