-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_insert_image_report ( nr_seq_dicom_p text, ds_arquivo_imagem_p text, nr_seq_empresa_p bigint, nr_atendimento_p bigint default null) AS $body$
DECLARE


ie_existe_w	varchar(1);
nr_seq_imagem_w	laudo_paciente_imagem.nr_seq_imagem%TYPE;
nr_seq_laudo_w		bigint;
nr_seq_prescr_w		bigint;
nr_prescr_w		bigint;
nm_repository_w varchar(50);
ie_existe_file_repository_w varchar(1);
ds_pasta_exp_xml_w	varchar(2000);
nm_usuario_w		varchar(255);
nm_medico_w         varchar(255);
cd_medico_resp_w   atendimento_paciente.cd_medico_resp%type;
nr_laudo_w			laudo_paciente.nr_laudo%type;
nr_laudo_ww			laudo_paciente.nr_laudo%type;



BEGIN
if (nr_seq_empresa_p = 165) then
	nm_usuario_w	:= 'CUSTODIAG';
elsif (nr_seq_empresa_p = 149) then
	nm_usuario_w	:= 'CWD';
elsif (nr_seq_empresa_p = 150) then
	nm_usuario_w	:= 'RADCENTRE';
elsif (nr_seq_empresa_p = 166) then
	nm_usuario_w	:= 'CARDIOBASE';
elsif (nr_seq_empresa_p = 4) then
	nm_usuario_w	:= 'XCELERA';
end if;
begin

SELECT 	coalesce(max('S'),'N')
INTO STRICT 	ie_existe_file_repository_w
FROM 	FILE_REPOSITORY
WHERE 	NM_REPOSITORY = nm_usuario_w;

if (ie_existe_file_repository_w = 'S') then
	SELECT 	MAX(NM_PATH),
			MAX(NM_REPOSITORY)
	INTO STRICT 	ds_pasta_exp_xml_w,
			nm_repository_w
	FROM 	FILE_REPOSITORY
	WHERE 	NM_REPOSITORY = nm_usuario_w;
else
	select	max(ds_caminho_entrada)
	into STRICT	ds_pasta_exp_xml_w
	from    empresa_integr_dados a,
	empresa_integracao b,
	sistema_integracao c
	where	a.nr_seq_empresa_integr = b.nr_sequencia
	and	b.nr_sequencia = c.nr_seq_empresa
	and     b.nr_sequencia = nr_seq_empresa_p;
end if;

select	max(a.nr_prescricao),
	max(a.nr_sequencia)
into STRICT	nr_prescr_w,
	nr_seq_prescr_w
from	prescr_procedimento	a
where	a.nr_acesso_dicom	= nr_seq_dicom_p;

select	max(a.nr_sequencia)
into STRICT	nr_seq_laudo_w
from	laudo_paciente	a
where	a.nr_prescricao	= nr_prescr_w
and	a.nr_seq_prescricao	= nr_seq_prescr_w;

if (coalesce(nr_seq_laudo_w::text, '') = '') then
    select	max(a.nr_sequencia)
    into STRICT	nr_seq_laudo_w
    from	laudo_paciente	a
    where	nr_controle_ext = nr_seq_dicom_p;
end if;


if (nr_seq_laudo_w IS NOT NULL AND nr_seq_laudo_w::text <> '') then

    SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
    INTO STRICT 	ie_existe_w
    FROM 	laudo_paciente_imagem a
    WHERE 	a.nr_sequencia = nr_seq_laudo_w
    AND  	a.ds_arquivo_imagem = ds_arquivo_imagem_p;

    
    IF (ie_existe_w = 'N') THEN
        SELECT	coalesce(MAX(a.nr_seq_imagem),0)+1
        INTO STRICT 	nr_seq_imagem_w
        FROM 	laudo_paciente_imagem a
        WHERE 	a.nr_sequencia = nr_seq_laudo_w;

        INSERT INTO laudo_paciente_imagem(
            nr_sequencia,
            nr_seq_imagem,
            ds_arquivo_imagem,
            nm_usuario,
            dt_atualizacao,
            nr_controle_ext)
        VALUES ( nr_seq_laudo_w,
            nr_seq_imagem_w,
            CASE WHEN ie_existe_file_repository_w='S' THEN 'tasy-file://'||nm_repository_w||'/'||ds_arquivo_imagem_p  ELSE ds_pasta_exp_xml_w||ds_arquivo_imagem_p END ,
            nm_usuario_w,
            clock_timestamp(),
            nr_seq_dicom_p);
    END IF;

else

    SELECT	coalesce(MAX(nr_laudo),0) + 1
    INTO STRICT	nr_laudo_w
    FROM	laudo_paciente
    WHERE	nr_atendimento = nr_atendimento_p;

    SELECT 	MAX(SUBSTR(obter_nome_pf(cd_medico_resp),1,255)) nm_medico,
            MAX(cd_medico_resp)    
    INTO STRICT 	nm_medico_w,
            cd_medico_resp_w    
    FROM 	atendimento_paciente    
    WHERE 	nr_atendimento = nr_atendimento_p;

    select  nextval('laudo_paciente_seq')
    into STRICT    nr_laudo_ww
;

    INSERT INTO laudo_paciente(nr_sequencia,
        nr_prescricao,
        nr_seq_prescricao,
        nr_seq_proc,
        nm_usuario_digitacao,
        nr_atendimento,
        nr_laudo,
        nm_usuario,
        dt_atualizacao,
        cd_medico_resp,
        qt_imagem,
        ds_titulo_laudo,
        ds_laudo,
        dt_laudo,
        dt_entrada_unidade,
        dt_liberacao,
        dt_exame,
        dt_aprovacao,
        nm_medico_solicitante)
    VALUES (nr_laudo_ww,
        NULL,
        NULL,
        NULL,
        nm_usuario_w,
        nr_atendimento_p,
        nr_laudo_w,
        nm_usuario_w,
        clock_timestamp(),
        cd_medico_resp_w,
        1,
        CASE WHEN nr_seq_empresa_p=165 THEN  'Custo Diagnostic' WHEN nr_seq_empresa_p=149 THEN  'ClinicWinData' WHEN nr_seq_empresa_p=150 THEN  'RadCentre' WHEN nr_seq_empresa_p=166 THEN  'CardioBase' WHEN nr_seq_empresa_p=4 THEN  'XCelera' END  || ' report',
        obter_desc_expressao(953403),
        clock_timestamp(),
        clock_timestamp(),
        clock_timestamp(),
        clock_timestamp(),
        clock_timestamp(),
        nm_medico_w);

        SELECT	coalesce(MAX(a.nr_seq_imagem),0)+1
        INTO STRICT 	nr_seq_imagem_w
        FROM 	laudo_paciente_imagem a
        WHERE 	a.nr_sequencia = nr_seq_laudo_w;

        INSERT INTO laudo_paciente_imagem(
            nr_sequencia,
            nr_seq_imagem,
            ds_arquivo_imagem,
            nm_usuario,
            dt_atualizacao,
            nr_controle_ext)
        VALUES ( nr_laudo_ww,
            nr_seq_imagem_w,
            CASE WHEN ie_existe_file_repository_w='S' THEN 'tasy-file://'||nm_repository_w||'/'||ds_arquivo_imagem_p  ELSE ds_pasta_exp_xml_w||ds_arquivo_imagem_p END ,
            nm_usuario_w,
            clock_timestamp(),
            nr_seq_dicom_p);

end if;
COMMIT;
exception
when others then
	CALL gravar_log_cdi(7000,
			substr(nr_seq_dicom_p || '#@#@' || sqlerrm,1,4000),
			'GERMANY');
end;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_insert_image_report ( nr_seq_dicom_p text, ds_arquivo_imagem_p text, nr_seq_empresa_p bigint, nr_atendimento_p bigint default null) FROM PUBLIC;

