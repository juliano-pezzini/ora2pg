-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_baixa_lote_receb ( cd_estabelecimento_p bigint, dt_recebimento_p timestamp) AS $body$
DECLARE


ie_baixa_lote_receb_w		varchar(2)	:= 'S';
qt_registro_w			bigint;
cd_empresa_w			smallint;
nr_lote_contabil_w		bigint;
ds_tipo_lote_contabil_w		varchar(255);


BEGIN

if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then

	select	coalesce(max(ie_baixa_lote_receb),'S')
	into STRICT	ie_baixa_lote_receb_w
	from	parametro_contas_receber
	where 	cd_estabelecimento	= cd_estabelecimento_p;

	select	max(cd_empresa)
	into STRICT	cd_empresa_w
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_p;

	ds_tipo_lote_contabil_w := Obter_Param_Usuario(27, 250, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, ds_tipo_lote_contabil_w);

	if (cd_empresa_w IS NOT NULL AND cd_empresa_w::text <> '') then
		if (ie_baixa_lote_receb_w = 'N') then

			select	count(*)
			into STRICT	qt_registro_w
			from 	ctb_mes_ref
			where	cd_empresa = cd_empresa_w
			and	substr(ctb_obter_se_mes_fechado(nr_sequencia,cd_estabelecimento_p),1,1) = 'F'
                		and	trunc(dt_referencia,'month') = trunc(dt_recebimento_p,'month');

			if (qt_registro_w > 0) then
				--o mês de referência na contabilidade para esta data de baixa (dt_recebimento_p) já foi fechado!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(213537, 'DT_RECEBIMENTO_P='||dt_recebimento_p);
			end if;

		elsif (ie_baixa_lote_receb_w = 'L') then

			if (coalesce(ds_tipo_lote_contabil_w,'X') <> 'X') then
				select	count(*)
				into STRICT	qt_registro_w
				from 	lote_contabil a
				where	obter_empresa_estab(a.cd_estabelecimento) 				= cd_empresa_w
				and	a.cd_estabelecimento							= cd_estabelecimento_p
				and	trunc(a.dt_referencia,'dd')						= trunc(dt_recebimento_p,'dd')
				and	obter_se_contido(a.cd_tipo_lote_contabil,ds_tipo_lote_contabil_w) 	= 'S' /*lhalves OS 556839 em 02/04/2013 - Considerar lotes contábeis definidos no parâmetro*/
				and	exists (	SELECT	1
							from	movimento_contabil z
							where	z.nr_lote_contabil	= a.nr_lote_contabil);
			else
				select	count(*)
				into STRICT	qt_registro_w
				from 	lote_contabil a
				where	obter_empresa_estab(a.cd_estabelecimento) 	= cd_empresa_w
				and	a.cd_estabelecimento				= cd_estabelecimento_p
				and	trunc(a.dt_referencia,'dd')	= trunc(dt_recebimento_p,'dd')
				and	a.cd_tipo_lote_contabil		in (11) /* elton em 10/03/2010 os 200332 - alterado para 11 ------ francisco - os 174526 - 23/10/2009 - faltava restringir tipo do lote contas a receber */
				and	exists (	SELECT	1
							from	movimento_contabil z
							where	z.nr_lote_contabil	= a.nr_lote_contabil);
			end if;

			if (qt_registro_w > 0) then
				--já foi gerado lote contábil para esta data de baixa.
				CALL wheb_mensagem_pck.exibir_mensagem_abort(213538);
			end if;

		elsif (ie_baixa_lote_receb_w = 'F') then

			select	count(*)
			into STRICT	qt_registro_w
			from 	ctb_mes_ref
			where	cd_empresa = cd_empresa_w
                		and	trunc(dt_referencia,'month') = trunc(dt_recebimento_p,'month');

			if (qt_registro_w > 0) then
				--já existe mês de referência na contabilidade para esta data de baixa (dt_recebimento_p).
				CALL wheb_mensagem_pck.exibir_mensagem_abort(213539, 'DT_RECEBIMENTO_P='||dt_recebimento_p);
			end if;
		elsif (ie_baixa_lote_receb_w = 'M') then

			select	coalesce(max(nr_lote_contabil), 0)
			into STRICT	nr_lote_contabil_w
			from 	lote_contabil a
			where	obter_empresa_estab(a.cd_estabelecimento) = cd_empresa_w
			and	trunc(a.dt_referencia,'dd')	>= trunc(dt_recebimento_p,'dd')
			and	trunc(a.dt_referencia,'month')	= trunc(dt_recebimento_p,'month')
			and	a.cd_estabelecimento		= cd_estabelecimento_p
			and	a.cd_tipo_lote_contabil	in ( 5 ,10)
			and	exists (	SELECT	1
						from	movimento_contabil z
						where	z.nr_lote_contabil	= a.nr_lote_contabil);

			if (nr_lote_contabil_w > 0) then
				/* já foi gerado lote contábil para esta data de baixa!
				lote contábil: nr_lote_contabil_w
				título: :new.nr_titulo
				dt recebimento: to_char(:new.dt_recebimento, 'dd/mm/yyyy') */
				CALL wheb_mensagem_pck.exibir_mensagem_abort(213359,	'NR_LOTE_CONTABIL_W=' || nr_lote_contabil_w ||
										';DT_RECEBIMENTO_W=' || to_char(dt_recebimento_p, 'dd/mm/yyyy'));
			end if;
		end if;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_baixa_lote_receb ( cd_estabelecimento_p bigint, dt_recebimento_p timestamp) FROM PUBLIC;

