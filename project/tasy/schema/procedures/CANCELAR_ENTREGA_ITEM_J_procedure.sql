-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_entrega_item_j (qt_dias_p bigint, ie_considera_passado_p text, nr_seq_motivo_cancel_p motivo_cancel_sc_oc.nr_sequencia%type, ie_cancela_ordem_p text, lista_grupo_mat_p text, nm_usuario_p text) AS $body$
DECLARE


nr_solic_compra_w numeric(20);
nr_cot_compra_w   numeric(20);

c01 CURSOR(qt_dias_c              bigint,
			ie_considera_passado_c text,
			lista_grupo_mat_c      text) FOR
SELECT a.nr_ordem_compra,
       b.nr_item_oci,
       c.nr_sequencia nr_seq_entrega,
       b.cd_material
  from ordem_compra a,
       ordem_compra_item b,
       ordem_compra_item_entrega c,
	   estrutura_material_v d
 where a.nr_ordem_compra = b.nr_ordem_compra
   and a.nr_ordem_compra = c.nr_ordem_compra
   and b.nr_item_oci     = c.nr_item_oci
   and d.cd_material = b.cd_material
   and coalesce(a.nr_seq_motivo_cancel::text, '') = ''
   and coalesce(c.dt_baixa::text, '') = ''
   and coalesce(c.dt_cancelamento::text, '') = ''
   and (coalesce(c.dt_real_entrega::text, '') = '' or c.qt_prevista_entrega > c.qt_real_entrega)
   and (coalesce(lista_grupo_mat_c::text, '') = '' or obter_se_contido(d.cd_grupo_material, lista_grupo_mat_c) = 'S')
   and ((ie_considera_passado_c = 'S' and trunc(c.dt_prevista_entrega) < trunc(clock_timestamp()-qt_dias_c)) or (ie_considera_passado_c = 'N' and trunc(c.dt_prevista_entrega) = trunc(clock_timestamp()-qt_dias_c)));

BEGIN
nr_solic_compra_w := 0;
nr_cot_compra_w   := 0;

	For r01 in c01(qt_dias_p, ie_considera_passado_p, lista_grupo_mat_p) loop
		begin
			SELECT * FROM cancelar_entrega_item(r01.nr_ordem_compra, r01.nr_item_oci, r01.nr_seq_entrega, 'N', /* ie_nova_solic_p         */
								  'N', /* ie_nova_cotacao_p       */
								  'N', /* ie_mantem_forn_cot_p    */
								  nm_usuario_p, null, /* ds_observacao_p	     */
								  nr_seq_motivo_cancel_p, ie_cancela_ordem_p, /* ie_cancela_ordem_p	     */
								  'N', /* ie_cancela_processo_p   */
								  r01.cd_material, null, /* ie_cancela_item_solic_p */
								  nr_solic_compra_w, nr_cot_compra_w) INTO STRICT 
								  nr_solic_compra_w, nr_cot_compra_w;
		exception
			when others then
			CALL inserir_historico_ordem_compra(r01.nr_ordem_compra,
										  'S',
										   Wheb_mensagem_pck.get_Texto(84871),         /* "Erro" */
											substr(WHEB_MENSAGEM_PCK.get_texto(306247) || /* "Erro ao processar a JOB. Favor verificar a tela de processos." */
												 '. ' ||SQLERRM,1,4000), 
									       nm_usuario_p);
		end;
	end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_entrega_item_j (qt_dias_p bigint, ie_considera_passado_p text, nr_seq_motivo_cancel_p motivo_cancel_sc_oc.nr_sequencia%type, ie_cancela_ordem_p text, lista_grupo_mat_p text, nm_usuario_p text) FROM PUBLIC;

