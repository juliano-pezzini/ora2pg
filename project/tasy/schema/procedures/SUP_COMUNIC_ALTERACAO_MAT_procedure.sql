-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_comunic_alteracao_mat ( cd_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_grupo_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
ds_grupo_material_w		varchar(255);
ds_subgrupo_material_w 		varchar(255);
ds_classe_material_w		varchar(255);
nr_seq_classif_w			bigint;
cd_setor_dest_w			bigint;
nm_usuario_regra_w		varchar(255);
qt_regras_w			bigint;
ds_setor_w			varchar(255);
ds_perfil_w			varchar(255);
nm_usuario_dest_w			varchar(4000);
ds_titulo_w			varchar(255);
ds_historico_w			varchar(4000);
ds_comunic_w			varchar(4000);
cd_perfil_w			integer;
ds_setor_atend_w			varchar(100);
nr_sequencia_w			bigint;
nr_sequencia_s_w			bigint;
cd_estabelecimento_w		smallint;
ds_estab_w			varchar(255);
nr_seq_comunic_w			bigint;
ie_ci_lida_w			varchar(1);
cd_setor_w			bigint;
ie_regra_w			varchar(1);

c01 CURSOR FOR
SELECT	cd_setor_atendimento,
	cd_perfil,
	ds_usuario_destino,
	coalesce(ie_ci_lida,'N')
from 	regra_aviso_exec_mat
where	coalesce(cd_estabelecimento, cd_estabelecimento_p)		= cd_estabelecimento_p
and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
and	coalesce(cd_material, cd_material_p)			= cd_material_p
and	coalesce(ie_alteracao_cadastro,'N')				= 'S'
and 	coalesce(cd_funcao, coalesce(obter_funcao_ativa,0)) = coalesce(obter_funcao_ativa,0)
order by
	coalesce(cd_grupo_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_material, 0),
	coalesce(cd_funcao,0);


BEGIN

select	count(*)
into STRICT	qt_regras_w
from 	regra_aviso_exec_mat
where	coalesce(ie_alteracao_cadastro,'N') = 'S';

if (qt_regras_w > 0) then
	begin
	ie_regra_w	:=	'N';

	select	max(cd_grupo_material),
		max(cd_subgrupo_material),
		max(cd_classe_material),
		substr(max(ds_grupo_material),1,255),
		substr(max(ds_subgrupo_material),1,255),
		substr(max(ds_classe_material),1,255)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ds_grupo_material_w,
		ds_subgrupo_material_w,
		ds_classe_material_w
	from	estrutura_material_v
	where 	cd_material = cd_material_p;

	open c01;
	loop
	fetch c01 into
		cd_setor_dest_w,
		cd_perfil_w,
		nm_usuario_regra_w,
		ie_ci_lida_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (cd_setor_dest_w IS NOT NULL AND cd_setor_dest_w::text <> '') then
			ds_setor_w := substr(ds_setor_w || to_char(cd_setor_dest_w) || ',',1,255);
		end if;

		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
			ds_perfil_w := substr(ds_perfil_w || to_char(cd_perfil_w) || ',',1,255);
		end if;

		if (nm_usuario_regra_w IS NOT NULL AND nm_usuario_regra_w::text <> '') then
			nm_usuario_dest_w := substr(nm_usuario_dest_w || nm_usuario_regra_w || ',',1,4000);
		end if;
		ie_regra_w	:=	'S';
		end;
	end loop;
	close 	c01;

	if (ie_regra_w = 'S') then
		begin
		--ds_titulo_w	:= 'Alteração de material';
		ds_titulo_w	:= wheb_mensagem_pck.get_texto(314873);

		/*ds_comunic_w	:= substr(	'Foi alterado o material: ' || chr(13) || chr(10) ||
					'Código: ' || cd_material_p || chr(13) || chr(10) ||
					'Descrição: ' || substr(obter_desc_material(cd_material_p),1,80) || chr(13) || chr(10) ||
					'Grupo: ' || ds_grupo_material_w || chr(13) || chr(10) ||
					'Subgrupo: ' || ds_subgrupo_material_w || chr(13) || chr(10) ||
					'Classe: ' || ds_classe_material_w,1,255);*/
		ds_comunic_w	:= substr(wheb_mensagem_pck.get_texto(314874) || ': ' || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(314208, 'CD_MATERIAL=' || cd_material_p) || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(314209, 'DS_MATERIAL=' || substr(obter_desc_material(cd_material_p),1,80)) || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(314210, 'DS_GRUPO_MATERIAL=' || ds_grupo_material_w) || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(314211, 'DS_SUBGRUPO_MATERIAL=' || ds_subgrupo_material_w) || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(314212, 'DS_CLASSE_MATERIAL=' || ds_classe_material_w) ,1,255);

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	material_historico
		where	cd_material = cd_material_p;

		if (nr_sequencia_w > 0) then
			select	ds_historico
			into STRICT	ds_historico_w
			from	material_historico
			where	cd_material = cd_material_p
			and	nr_sequencia = nr_sequencia_w;
			ds_comunic_w	:= substr(ds_comunic_w || chr(13) || chr(10) || chr(13) || chr(10) || ds_historico_w,1,4000);
		end if;

		cd_estabelecimento_w	:= cd_estabelecimento_p;

		if (cd_estabelecimento_p = 0) then
			cd_estabelecimento_w	:= null;
		end if;

		if (coalesce(cd_estabelecimento_w, 0) > 0) then
			ds_estab_w	:= substr(obter_nome_estabelecimento(cd_estabelecimento_w),1,255);
			--ds_titulo_w	:= substr('Alteração de material no estabelecimento - ' || ds_estab_w,1,255);
			ds_titulo_w	:= substr(wheb_mensagem_pck.get_texto(314875, 'DS_ESTAB=' || ds_estab_w),1,255);
		end if;

		select	max(obter_classif_comunic('F'))
		into STRICT	nr_seq_classif_w
		;

		select	nextval('comunic_interna_seq')
		into STRICT	nr_seq_comunic_w
		;


		insert into comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			cd_perfil,
			nr_sequencia,
			ie_gerencial,
			nr_seq_classif,
			ds_perfil_adicional,
			cd_setor_destino,
			cd_estab_destino,
			ds_setor_adicional,
			dt_liberacao,
			ds_grupo,
			nm_usuario_oculto)
		values (	clock_timestamp(),
			ds_titulo_w,
			wheb_rtf_pck.get_texto_rtf(ds_comunic_w),
			nm_usuario_p,
			clock_timestamp(),
			'N',
			nm_usuario_dest_w,
			null,
			nr_seq_comunic_w,
			'N',
			nr_seq_classif_w,
			ds_perfil_w,
			null,
			cd_estabelecimento_w,
			ds_setor_w,  --tirado o ds_setor_atend_w, e colocado o cd_setor_w, pois o campo é function. mhbarth.
			clock_timestamp(),
			'',
			'');

		if (ie_ci_lida_w = 'S') then
			insert into comunic_interna_lida(
				nr_sequencia,
				nm_usuario,
				dt_atualizacao)
			values (	nr_seq_comunic_w,
				nm_usuario_p,
				clock_timestamp());

		end if;
		end;
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_comunic_alteracao_mat ( cd_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

