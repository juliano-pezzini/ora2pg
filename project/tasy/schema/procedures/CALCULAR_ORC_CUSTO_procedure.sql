-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_orc_custo ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_nat_gasto_origem_w		numeric(20);
cd_nat_gasto_destino_w		numeric(20);
cd_centro_controle_w		integer;
cd_centro_controle_orig_w		integer;
cd_centro_controle_dest_w		integer;
cd_empresa_w			bigint;
cd_estabelecimento_w		bigint;
cd_estab_tabela_w		bigint;
ie_sobrepor_w			varchar(01);
ie_tipo_gasto_w			varchar(02);
pr_calcular_w			double precision;
cd_grupo_nat_gasto_w		integer;
vl_orcado_w			double precision;
vl_orcado_ww			double precision;
qt_dias_prazo_w			double precision;
qt_registro_w			integer;
nr_seq_gng_w			bigint;
nr_seq_ng_origem_w		bigint;
nr_seq_ng_destino_w		bigint;
dt_mes_referencia_w		timestamp;


c01 CURSOR FOR
SELECT	a.cd_estabelecimento,
	a.cd_nat_gasto_origem,
	a.cd_nat_gasto_destino,
	a.cd_centro_controle_orig,
	a.cd_centro_controle_dest,
	a.ie_sobrepor,
	a.pr_calcular,
	a.cd_grupo_nat_gasto,
	a.nr_seq_gng,
	a.nr_seq_ng_origem,
	a.nr_seq_ng_destino
from	estabelecimento b,
	regra_calc_orc_custo a
where	b.cd_estabelecimento	= a.cd_estabelecimento
and	b.cd_empresa		= cd_empresa_w
and	b.cd_estabelecimento	= coalesce(cd_estab_tabela_w, b.cd_estabelecimento)
and	b.cd_estabelecimento	= cd_estabelecimento_p
and	substr(obter_se_periodo_vigente(dt_inicio_vigencia, dt_fim_vigencia, dt_mes_referencia_w),1,1) = 'S'
order by	nr_seq_calculo;

c02 CURSOR FOR
SELECT	coalesce(cd_centro_controle_dest_w, a.cd_centro_controle),
	sum(a.vl_orcado),
	avg(a.qt_dias_prazo)
from	natureza_gasto b,
	orcamento_custo a
where	a.cd_natureza_gasto	= b.cd_natureza_gasto
and	a.cd_estabelecimento	= coalesce(b.cd_estabelecimento, a.cd_estabelecimento)
and	a.nr_seq_tabela		= nr_seq_tabela_p
and	a.cd_natureza_gasto	= coalesce(cd_nat_gasto_origem_w, a.cd_natureza_gasto)
and	a.nr_seq_ng		= coalesce(nr_seq_ng_origem_w, a.nr_seq_ng)
and	a.cd_centro_controle	= coalesce(cd_centro_controle_orig_w, a.cd_centro_controle)
and	b.nr_seq_gng		= coalesce(nr_seq_gng_w, b.nr_seq_gng)
and	a.cd_estabelecimento	= cd_estabelecimento_w
and	b.cd_empresa		= cd_empresa_w
group by	a.cd_centro_controle;


BEGIN

cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

select	max(cd_empresa),
	max(cd_estabelecimento),
	max(dt_mes_referencia)
into STRICT	cd_empresa_w,
	cd_estab_tabela_w,
	dt_mes_referencia_w
from	tabela_custo
where	nr_sequencia	= nr_seq_tabela_p;

open c01;
loop
fetch c01 into
	cd_estabelecimento_w,
	cd_nat_gasto_origem_w,
	cd_nat_gasto_destino_w,
	cd_centro_controle_orig_w,
	cd_centro_controle_dest_w,
	ie_sobrepor_w,
	pr_calcular_w,
	cd_grupo_nat_gasto_w,
	nr_seq_gng_w,
	nr_seq_ng_origem_w,
	nr_seq_ng_destino_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	open c02;
	loop
	fetch c02 into
		cd_centro_controle_w,
		vl_orcado_w,
		qt_dias_prazo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	vl_orcado_w		:= vl_orcado_w * pr_calcular_w / 100;

	select	coalesce(max(vl_orcado),0),
		count(*)
	into STRICT	vl_orcado_ww,
		qt_registro_w
	from	orcamento_custo
	where	nr_seq_tabela	= nr_seq_tabela_p
	and	nr_seq_ng	= nr_seq_ng_destino_w
	and	cd_centro_controle	= cd_centro_controle_w;

	if (nr_seq_ng_destino_W IS NOT NULL AND nr_seq_ng_destino_W::text <> '') then
		select	cd_natureza_gasto
		into STRICT	cd_nat_gasto_destino_w
		from	natureza_gasto
		where	nr_sequencia	= nr_seq_ng_destino_w;

	end if;

	if (ie_sobrepor_w	= 'S') then
		vl_orcado_ww	:= vl_orcado_w;
	else
		vl_orcado_ww	:= vl_orcado_ww + vl_orcado_w;
	end if;

	if (qt_registro_w = 0) then

		ie_tipo_gasto_w	:= substr(cus_obter_tipo_gasto_centro(cd_estabelecimento_w, cd_centro_controle_w, nr_seq_gng_w, cd_nat_gasto_destino_w, nr_seq_ng_destino_w),1,1);

		if (ie_tipo_gasto_w in ('V','F','R')) then

			insert into orcamento_custo(
				nr_sequencia,
				cd_estabelecimento,
				cd_tabela_custo,
				cd_centro_controle,
				cd_natureza_gasto,
				ie_tipo_gasto,
				dt_atualizacao,
				nm_usuario,
				vl_orcado,
				vl_avista,
				vl_distribuido,
				vl_receb_distrib,
				qt_dias_prazo,
				vl_a_distribuir,
				nr_seq_ng,
				nr_seq_tabela)
			values (	nextval('orcamento_custo_seq'),
				cd_estabelecimento_w,
				cd_tabela_custo_p,
				cd_centro_controle_w,
				cd_nat_gasto_destino_w,
				ie_tipo_gasto_w,
				clock_timestamp(),
				nm_usuario_p,
				vl_orcado_ww,
				0,
				0,
				0,
				qt_dias_prazo_w,
				0,
				nr_seq_ng_destino_w,
				nr_seq_tabela_p);
		elsif (ie_tipo_gasto_w = 'M') then
			cus_ratear_orcamento_tipo(cd_estabelecimento_w,cd_tabela_custo_p,cd_centro_controle_w,cd_nat_gasto_destino_w,
						vl_orcado_ww,qt_dias_prazo_w,46,nm_usuario_p, nr_seq_tabela_p);
		end if;
	else
		update orcamento_custo
		set	vl_orcado		= vl_orcado_ww,
			vl_avista		= 0,
			vl_distribuido	= 0,
			vl_receb_distrib	= 0
		where	nr_seq_tabela	= nr_seq_tabela_p
		and	nr_seq_ng	= nr_seq_ng_destino_w
		and	cd_centro_controle	= cd_centro_controle_w
		and	cd_estabelecimento	= cd_estabelecimento_w;
	end if;
	end loop;
	close c02;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_orc_custo ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;

