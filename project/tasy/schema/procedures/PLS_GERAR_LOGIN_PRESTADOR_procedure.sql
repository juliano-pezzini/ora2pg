-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_login_prestador ( nr_seq_usuario_p bigint, nr_seq_local_atend_p bigint, nm_usuario_p text, ds_email_p INOUT text, ds_responsavel_p INOUT text, nr_crm_p INOUT text, cd_pessoa_fisica_resp_p INOUT text, cd_estabelecimento_p INOUT bigint, cd_cooperativa_p INOUT text, ie_exige_biometria_p INOUT text, nr_seq_perfil_web_p INOUT bigint, ie_tipo_prestador_p INOUT text, qt_dias_protocolo_p INOUT bigint, ie_forma_autenticacao_p INOUT text, nm_prestador_p INOUT text, nr_seq_prestador_p INOUT bigint, cd_pessoa_fisica_p INOUT text, qt_prestadores_login_p INOUT bigint, ie_origem_prestador_p INOUT text, cd_prestador_p INOUT text, nm_local_atend_p INOUT text, uf_crm_p INOUT text, qt_max_caract_cart_p INOUT bigint, ie_forma_val_cart_benef_p INOUT pls_web_param_geral.ie_forma_val_cart_benef%type, cd_versao_tiss_p INOUT pls_versao_tiss.cd_versao_tiss%type, ie_nova_importacao_p INOUT text, ip_socket_scs_p INOUT pls_end_webservice_scs.ds_webservice_envio%type, dt_ultimo_acesso_p INOUT text, ie_prestador_excluido_p INOUT text) AS $body$
DECLARE

				

nr_seq_local_atend_w		bigint;
qt_prestadores_login_w		integer := 0;
qt_prestadores_excluidos_w	integer := 0;
qt_dias_prest_excluido_w	integer := 0;
ds_mensagem_log_w			varchar(255);
cd_versao_w					pls_versao_tiss.cd_versao_tiss%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
				

BEGIN

select	coalesce(max(cd_estabelecimento), 1)
into STRICT	cd_estabelecimento_w
from	pls_usuario_web
where	nr_sequencia = nr_seq_usuario_p;

select 	coalesce(max(qt_dias_prest_excluido), 0)
into STRICT	qt_dias_prest_excluido_w
from	pls_web_param_geral
where	cd_estabelecimento = cd_estabelecimento_w;

if (qt_dias_prest_excluido_w > 0) then
	select	count(1)
	into STRICT	qt_prestadores_excluidos_w
	from    pls_prestador 				a,
			pls_prestador_usuario_web 	b
	where   a.nr_sequencia 				= b.nr_seq_prestador
	and     b.nr_seq_usuario 			= nr_seq_usuario_p
	and		fim_dia(a.dt_exclusao) + qt_dias_prest_excluido_w >= clock_timestamp();
end if;

if (qt_prestadores_excluidos_w = 0) then
	select	count(1)
	into STRICT	qt_prestadores_login_w
	from    pls_prestador a,
			pls_prestador_usuario_web b
	where   a.nr_sequencia 		= b.nr_seq_prestador
	and		a.ie_situacao 		= 'A'
	and     b.ie_situacao 		= 'A'
	and     b.nr_seq_usuario 	= nr_seq_usuario_p
	order   by a.nr_sequencia asc;
end if;

select 	coalesce((	select	max(pls_imp_xml_cta_pck.usar_nova_imp_xml(obter_estabelecimento_ativo))
		),'N')
into STRICT	ie_nova_importacao_p
;

--Caso necessitar de alteracao verificar se precisa ser alterado o script 379351
select	max(ds_webservice_envio) ds_webservice_envio
into STRICT	ip_socket_scs_p
from	pls_end_webservice_scs
where	ie_situacao = 'A';

if (qt_prestadores_login_w > 0) or (qt_prestadores_excluidos_w > 0) then
	ie_origem_prestador_p := 'LOGIN';

	select  coalesce(a.ds_email, wheb_mensagem_pck.get_texto(1046667)) ds_email,
		a.cd_pessoa_fisica_resp,
		coalesce(obter_nome_pf(a.cd_pessoa_fisica_resp), wheb_mensagem_pck.get_texto(1046667)) ds_resp,
		obter_crm_medico(a.cd_pessoa_fisica_resp) nr_crm ,
		coalesce(a.cd_estabelecimento, 1) cd_estabelecimento,
		a.ie_exige_biometria,
		coalesce(pls_obter_unimed_estab(a.cd_estabelecimento), '0') cd_cooperativa, 
		pls_obter_dados_prestador_web(a.nr_sequencia, 'PW') nr_seq_perfil_web,                         
		a.nr_seq_local_atend,
		pls_obter_local_atend_medico(a.nr_seq_local_atend),
		pls_obter_uf_crm_medico(a.cd_pessoa_fisica_resp),
		coalesce(pls_obter_versao_tiss, '3.02.00')
	into STRICT	ds_email_p,
		cd_pessoa_fisica_resp_p,
		ds_responsavel_p,
		nr_crm_p,
		cd_estabelecimento_p,
		ie_exige_biometria_p,
		cd_cooperativa_p,
		nr_seq_perfil_web_p,
		nr_seq_local_atend_w,
		nm_local_atend_p,
		uf_crm_p,
		cd_versao_w
	from    pls_usuario_web a
	where   a.nr_sequencia = nr_seq_usuario_p;
		
	select 	*	
	into STRICT	nm_prestador_p,
			cd_pessoa_fisica_p,
			nr_crm_p,
			nr_seq_prestador_p,
			ie_tipo_prestador_p,
			qt_dias_protocolo_p,
			ie_forma_autenticacao_p	,
			cd_prestador_p,
			uf_crm_p,
			ie_forma_val_cart_benef_p,
			qt_max_caract_cart_p,
			ie_prestador_excluido_p
	from	(SELECT initcap(substr(pls_obter_nm_prest_web(a.nr_sequencia),1,255)) nm_prestador,
					a.cd_pessoa_fisica cd_pessoa_fisica,
					obter_crm_medico(a.cd_pessoa_fisica) nr_crm ,
					a.nr_sequencia nr_seq_prestador,
					substr(pls_obter_dados_prestador(a.nr_sequencia,'TP'),1,255) tipo_prestador,
					pls_obter_dados_prestador(a.nr_sequencia, 'DP') qt_dias_protocolo,
					pls_obter_dados_prestador(a.nr_sequencia, 'FAB') ie_forma_autenticacao,
					pls_obter_cod_prestador(a.nr_sequencia,null) cd_prestador,
					pls_obter_uf_crm_medico(a.cd_pessoa_fisica) uf_crm,
					pls_parametro_operadora_web('FVC', a.cd_estabelecimento),
					(select coalesce(max(x.qt_caracteres_carteira),0)
					from	pls_web_param_geral x
					where	x.cd_estabelecimento = a.cd_estabelecimento),
					'N'
			from    pls_prestador a,
					pls_prestador_usuario_web b
			where   a.ie_situacao = 'A'
			and     b.ie_situacao = 'A'
			and     a.nr_sequencia = b.nr_seq_prestador
			and     b.nr_seq_usuario = nr_seq_usuario_p	
			
union all

			SELECT 	initcap(substr(pls_obter_nm_prest_web(a.nr_sequencia),1,255)) nm_prestador,
					a.cd_pessoa_fisica cd_pessoa_fisica,
					obter_crm_medico(a.cd_pessoa_fisica) nr_crm ,
					a.nr_sequencia nr_seq_prestador,
					substr(pls_obter_dados_prestador(a.nr_sequencia,'TP'),1,255) tipo_prestador,
					pls_obter_dados_prestador(a.nr_sequencia, 'DP') qt_dias_protocolo, 
					pls_obter_dados_prestador(a.nr_sequencia, 'FAB') ie_forma_autenticacao,
					pls_obter_cod_prestador(a.nr_sequencia,null) cd_prestador,
					pls_obter_uf_crm_medico(a.cd_pessoa_fisica) uf_crm,
					pls_parametro_operadora_web('FVC', a.cd_estabelecimento),
					(select coalesce(max(x.qt_caracteres_carteira),0)
					from	pls_web_param_geral x
					where	x.cd_estabelecimento = a.cd_estabelecimento),
					'S'
			from    pls_prestador a,
					pls_prestador_usuario_web b
			where   a.nr_sequencia = b.nr_seq_prestador
			and		fim_dia(a.dt_exclusao) + qt_dias_prest_excluido_w >= clock_timestamp()
			and     b.nr_seq_usuario = nr_seq_usuario_p) alias30 ORDER by nm_prestador asc LIMIT 1;
	
elsif (nr_seq_local_atend_p IS NOT NULL AND nr_seq_local_atend_p::text <> '') then
	ie_origem_prestador_p := 'LOCAL';
	
	select  distinct a.ds_email,
			a.cd_pessoa_fisica_resp,
			obter_nome_pf(a.cd_pessoa_fisica_resp) ds_resp,
			obter_crm_medico(a.cd_pessoa_fisica_resp) nr_crm ,
			coalesce(a.cd_estabelecimento, 1) cd_estabelecimento,
			a.ie_exige_biometria,
			coalesce(pls_obter_unimed_estab(a.cd_estabelecimento), '0') cd_cooperativa, 
			pls_obter_dados_prestador_web(a.nr_sequencia, 'PW') nr_seq_perfil_web,                         
			a.nr_seq_local_atend,
			pls_obter_local_atend_medico(a.nr_seq_local_atend),
			pls_obter_uf_crm_medico(a.cd_pessoa_fisica_resp)
	into STRICT	ds_email_p,
			cd_pessoa_fisica_resp_p,
			ds_responsavel_p,
			nr_crm_p,
			cd_estabelecimento_p,
			ie_exige_biometria_p,
			cd_cooperativa_p,
			nr_seq_perfil_web_p,
			nr_seq_local_atend_w,
			nm_local_atend_p,
			uf_crm_p
	from    pls_usuario_web a
	where   a.nr_sequencia = nr_seq_usuario_p;
	
	if (qt_dias_prest_excluido_w > 0) then
		select	count(1)
		into STRICT	qt_prestadores_excluidos_w
		from	pls_prestador 			a,
				local_atend_med_prest 	b
		where   a.nr_sequencia 			= b.nr_seq_prestador
		and		b.nr_seq_local_atend 	= nr_seq_local_atend_p
		and		fim_dia(a.dt_exclusao) + qt_dias_prest_excluido_w >= clock_timestamp();
	end if;

	if (qt_prestadores_excluidos_w = 0) then
	
		select	count(1)
		into STRICT	qt_prestadores_login_w
		from	pls_prestador a,
				local_atend_med_prest b
		where   a.nr_sequencia = b.nr_seq_prestador
		and		b.nr_seq_local_atend = nr_seq_local_atend_p
		and		a.ie_situacao = 'A'
		and (coalesce(b.dt_fim_vigencia::text, '') = '' or to_date(b.dt_fim_vigencia, 'dd/mm/yyyy') >= to_Date(clock_timestamp(),'dd/mm/yyyy'));

	end if;
	
	if (qt_prestadores_login_w > 0) or (qt_prestadores_excluidos_w > 0) then
	
		select 	*	
		into STRICT	nm_prestador_p,
				cd_pessoa_fisica_p,
				nr_crm_p,
				nr_seq_prestador_p,
				ie_tipo_prestador_p,
				qt_dias_protocolo_p,
				ie_forma_autenticacao_p,
				cd_prestador_p,
				uf_crm_p,
				ie_forma_val_cart_benef_p,
				qt_max_caract_cart_p,
				ie_prestador_excluido_p
		from	(SELECT	initcap(substr(pls_obter_nm_prest_web(a.nr_sequencia),1,255)) nm_prestador,
						a.cd_pessoa_fisica cd_pessoa_fisica,
						obter_crm_medico(a.cd_pessoa_fisica) nr_crm ,
						a.nr_sequencia nr_seq_prestador,
						substr(pls_obter_dados_prestador(a.nr_sequencia,'TP'),1,255) tipo_prestador,
						pls_obter_dados_prestador(a.nr_sequencia, 'DP') qt_dias_protocolo,
						pls_obter_dados_prestador(a.nr_sequencia, 'FAB') ie_forma_autenticacao,
						pls_obter_cod_prestador(a.nr_sequencia,null) cd_prestador,
						pls_obter_uf_crm_medico(a.cd_pessoa_fisica) uf_crm,
						pls_parametro_operadora_web('FVC', a.cd_estabelecimento),
						(select coalesce(max(x.qt_caracteres_carteira),0)
						from	pls_web_param_geral x
						where	x.cd_estabelecimento = a.cd_estabelecimento),
						'N'
				from    pls_prestador 			a,
						local_atend_med_prest 	b
				where   a.nr_sequencia 			= b.nr_seq_prestador
				and		b.nr_seq_local_atend 	= nr_seq_local_atend_p
				and		a.ie_situacao 			= 'A'
				and (coalesce(b.dt_fim_vigencia::text, '') = '' or to_date(b.dt_fim_vigencia, 'dd/mm/yyyy') >= to_Date(clock_timestamp(),'dd/mm/yyyy'))
				
union all

				SELECT	initcap(substr(pls_obter_nm_prest_web(a.nr_sequencia),1,255)) nm_prestador,
						a.cd_pessoa_fisica cd_pessoa_fisica,
						obter_crm_medico(a.cd_pessoa_fisica) nr_crm ,
						a.nr_sequencia nr_seq_prestador,
						substr(pls_obter_dados_prestador(a.nr_sequencia,'TP'),1,255) tipo_prestador,
						pls_obter_dados_prestador(a.nr_sequencia, 'DP') qt_dias_protocolo, 
						pls_obter_dados_prestador(a.nr_sequencia, 'FAB') ie_forma_autenticacao,
						pls_obter_cod_prestador(a.nr_sequencia,null) cd_prestador,
						pls_obter_uf_crm_medico(a.cd_pessoa_fisica) uf_crm,
						pls_parametro_operadora_web('FVC', a.cd_estabelecimento),
						(select coalesce(max(x.qt_caracteres_carteira),0)
						from	pls_web_param_geral x
						where	x.cd_estabelecimento = a.cd_estabelecimento),
						'S'
				from    pls_prestador 			a,
						local_atend_med_prest 	b
				where   a.nr_sequencia 			= b.nr_seq_prestador
				and		b.nr_seq_local_atend 	= nr_seq_local_atend_p
				and		fim_dia(a.dt_exclusao) + qt_dias_prest_excluido_w >= clock_timestamp()
				and (coalesce(b.dt_fim_vigencia::text, '') = '' or to_date(b.dt_fim_vigencia, 'dd/mm/yyyy') >= to_Date(clock_timestamp(),'dd/mm/yyyy'))) alias42 ORDER by nm_prestador asc LIMIT 1;
	end if;
		
end if;		

begin
select	to_char(dt_atualizacao, 'dd/MM/yyyy hh24:mi:ss')
into STRICT	dt_ultimo_acesso_p
from	pls_acesso_portal_log
where	nr_sequencia = (SELECT	max(nr_sequencia)
			from	pls_acesso_portal_log
			where	nr_seq_usu_prestador 	= nr_seq_usuario_p
			and	ie_tipo_acesso		= 'P'
			and	ie_tipo_historico 	= '1');
exception
when others then
	dt_ultimo_acesso_p	:= null;
end;

ds_mensagem_log_w := 'O prestador '|| nm_usuario_p ||' logou no portal.';
CALL pls_gravar_log_acesso_portal(null, null, nr_seq_usuario_p, null, null, null, null, null, '1', ds_mensagem_log_w, 'Function - pls_obter_parametros_funcao', 'S');

qt_prestadores_login_p 		:= qt_prestadores_login_w + qt_prestadores_excluidos_w;
ds_responsavel_p 			:= substr(ds_responsavel_p, 0, 31);
cd_versao_tiss_p			:= pls_obter_versao_tiss;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_login_prestador ( nr_seq_usuario_p bigint, nr_seq_local_atend_p bigint, nm_usuario_p text, ds_email_p INOUT text, ds_responsavel_p INOUT text, nr_crm_p INOUT text, cd_pessoa_fisica_resp_p INOUT text, cd_estabelecimento_p INOUT bigint, cd_cooperativa_p INOUT text, ie_exige_biometria_p INOUT text, nr_seq_perfil_web_p INOUT bigint, ie_tipo_prestador_p INOUT text, qt_dias_protocolo_p INOUT bigint, ie_forma_autenticacao_p INOUT text, nm_prestador_p INOUT text, nr_seq_prestador_p INOUT bigint, cd_pessoa_fisica_p INOUT text, qt_prestadores_login_p INOUT bigint, ie_origem_prestador_p INOUT text, cd_prestador_p INOUT text, nm_local_atend_p INOUT text, uf_crm_p INOUT text, qt_max_caract_cart_p INOUT bigint, ie_forma_val_cart_benef_p INOUT pls_web_param_geral.ie_forma_val_cart_benef%type, cd_versao_tiss_p INOUT pls_versao_tiss.cd_versao_tiss%type, ie_nova_importacao_p INOUT text, ip_socket_scs_p INOUT pls_end_webservice_scs.ds_webservice_envio%type, dt_ultimo_acesso_p INOUT text, ie_prestador_excluido_p INOUT text) FROM PUBLIC;

