-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_prest_munic_grup () AS $body$
DECLARE


ie_insert_w		pls_prestador.ie_proc_grupo_prest%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_prestador,
		pls_obter_cd_ibge_prestador(a.nr_sequencia, a.cd_estabelecimento) cd_municipio_ibge,
		a.cd_estabelecimento
	from	pls_prestador a
	where	coalesce(a.ie_proc_grupo_prest,'N') = 'P' -- Pendente
	and	a.ie_tipo_relacao <> 'F'; -- Fornecedor
	
C02 CURSOR(	cd_municipio_ibge_pc			pls_regra_prest_munic.cd_municipio_ibge%type,
		cd_estabelecimento_pc			estabelecimento.cd_estabelecimento%type) FOR
	SELECT	b.nr_seq_grupo_prest nr_seq_grupo
	from	pls_reg_prest_munic_grupo	b,
		pls_regra_prest_munic		a
	where	a.nr_sequencia			= b.nr_seq_prest_munic
	and	a.ie_situacao			= 'A'
	and	b.ie_situacao			= 'A'
	and	a.cd_municipio_ibge		= cd_municipio_ibge_pc
	and	a.cd_estabelecimento		= cd_estabelecimento_pc;
	
BEGIN

for r_c01_w in c01 loop
	ie_insert_w	:= 'N';
	
	for r_c02_w in c02( r_c01_w.cd_municipio_ibge, r_c01_w.cd_estabelecimento ) loop
		ie_insert_w	:= 'S';
		
		insert into pls_preco_prestador(	nr_sequencia,				dt_atualizacao,				nm_usuario,
							dt_atualizacao_nrec,			nm_usuario_nrec,			nr_seq_prestador,
							nr_seq_grupo,				nr_seq_classificacao)
					values (	nextval('pls_preco_prestador_seq'),	clock_timestamp(),				'Tasy',
							clock_timestamp(),				'Tasy',					r_c01_w.nr_seq_prestador,
							r_c02_w.nr_seq_grupo,			null);
	end loop;
	
	
	if (r_c01_w.cd_municipio_ibge IS NOT NULL AND r_c01_w.cd_municipio_ibge::text <> '') then
		update	pls_prestador
		set	ie_proc_grupo_prest = ie_insert_w
		where	nr_sequencia = r_c01_w.nr_seq_prestador
		and	cd_estabelecimento = r_c01_w.cd_estabelecimento;
	end if;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_prest_munic_grup () FROM PUBLIC;

