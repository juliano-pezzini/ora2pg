-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_texto_paciente_exame_lab (nr_prescricao_p text, nr_sequencia_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

                                      
 
                                      
nm_pessoa_fisica_w		varchar(60);
ds_idade_w				smallint;
ie_sexo_w				varchar(1);
dt_mestruacao_w			timestamp;
ds_orientacao_w			varchar(255);


BEGIN 
ds_retorno_p := '';
 
SELECT DISTINCT  
	  max(SUBSTR(OBTER_NOME_PRESCRICAO(B.NR_PRESCRICAO, 'RND'), 1, 255)) NM_PESSOA_FISICA, 
    max(SUBSTR(OBTER_IDADE(C.DT_NASCIMENTO, clock_timestamp(),'A'),1,10)) DS_IDADE, 
    max(C.IE_SEXO), 
    max(A.DT_MESTRUACAO), 
    max(SUBSTR(OBTER_ORIENTACAO_EXAME_JS(A.NR_PRESCRICAO,B.NR_SEQ_EXAME,B.CD_MATERIAL_EXAME,D.NR_SEQ_MATERIAL,2,0,A.CD_ESTABELECIMENTO),1,255)) DS_ORIENTACAO 
into STRICT  nm_pessoa_fisica_w, 
	  ds_idade_w, 
	  ie_sexo_w, 
    dt_mestruacao_w, 
    ds_orientacao_w 
FROM  PRESCR_MEDICA A, 
	  PRESCR_PROCEDIMENTO B, 
	  PESSOA_FISICA C, 
	  EXAME_LAB_MATERIAL D 
WHERE A.NR_PRESCRICAO = B.NR_PRESCRICAO 
AND  C.CD_PESSOA_FISICA = A.CD_PESSOA_FISICA	 
AND  D.NR_SEQ_EXAME = B.NR_SEQ_EXAME 
AND  A.NR_PRESCRICAO = nr_prescricao_p 
AND	  b.nr_sequencia = nr_sequencia_p;	
 
if (nm_pessoa_fisica_w IS NOT NULL AND nm_pessoa_fisica_w::text <> '')then 
 ds_retorno_p := wheb_mensagem_pck.get_texto(340400,'DS_PACIENTE='||nm_pessoa_fisica_w);
end if;
 
if (ds_idade_w IS NOT NULL AND ds_idade_w::text <> '')then 
 ds_retorno_p := ds_retorno_p || ', ' || wheb_mensagem_pck.get_texto(340395,'DS_IDADE='||ds_idade_w);
end if;
 
if (ie_sexo_w IS NOT NULL AND ie_sexo_w::text <> '')then 
 ds_retorno_p := ds_retorno_p || ', ' || wheb_mensagem_pck.get_texto(340397,'IE_SEXO='||ie_sexo_w);
end if;
 
if (dt_mestruacao_w IS NOT NULL AND dt_mestruacao_w::text <> '')then 
 ds_retorno_p := ds_retorno_p || ', ' || wheb_mensagem_pck.get_texto(340398,'DT_MESTRUACAO='||to_char(dt_mestruacao_w,'dd/MM/yyyy'));
end if;
 
 
if (ds_orientacao_w IS NOT NULL AND ds_orientacao_w::text <> '')then 
 ds_retorno_p := ds_retorno_p || ', ' || CHR(10) || substr(wheb_mensagem_pck.get_texto(340399,'DS_ORIENTACAO='||ds_orientacao_w),1,255);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_texto_paciente_exame_lab (nr_prescricao_p text, nr_sequencia_p text, ds_retorno_p INOUT text) FROM PUBLIC;

