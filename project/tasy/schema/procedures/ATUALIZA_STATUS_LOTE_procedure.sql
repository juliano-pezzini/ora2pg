-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_lote ( nr_lote_p bigint, cd_estabelecimento_p bigint, nr_seq_embalagem_p bigint, nm_usuario_lote_p text, ie_opcao_p text, nm_maquina_p text default null, cd_tubo_pneumatico_p text default null) AS $body$
DECLARE


ie_status_atual_w			ap_lote.ie_status_lote%type;
ds_maquina_w				varchar(80);
cd_perfil_ativo_w			integer;
ie_embalagem_w				varchar(1) := 'N';
ie_registra_entrega_w		varchar(1) := 'N';
ie_registra_recebimento_w	varchar(1) := 'N';
qt_existe_w					smallint;
qt_existe_lote_agrup_w		bigint;
ie_gerar_transf_lote_w		parametros_farmacia.ie_gerar_transf_lote%type;
ie_conta_paciente_w			ap_lote.ie_conta_paciente%type;
ie_status_transferencia_w	varchar(5);
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
ie_transf_atend_lote_w		setor_atendimento.ie_transf_atend_lote%type;
nm_usuario_w				usuario.nm_usuario%type;
reg_integracao_p			gerar_int_padrao.reg_integracao;
cd_local_estoque_w			ap_lote.cd_local_estoque%type;


BEGIN

nm_usuario_w := coalesce(nm_usuario_lote_p, wheb_usuario_pck.get_nm_usuario);

select	max(ie_status_lote),
		max(cd_local_estoque)
into STRICT	ie_status_atual_w,
		cd_local_estoque_w
from	ap_lote
where	nr_sequencia = nr_lote_p;

select	substr(obter_inf_sessao(0)||' - '||obter_inf_sessao(1),1,80)
into STRICT	ds_maquina_w
;

if (nm_maquina_p IS NOT NULL AND nm_maquina_p::text <> '') then
	ds_maquina_w := substr(nm_maquina_p ||' - ' || nm_usuario_w,1,80);
end if;

select CASE WHEN obter_perfil_ativo=0 THEN null  ELSE obter_perfil_ativo END
into STRICT cd_perfil_ativo_w 
;

select	coalesce(max(ie_gerar_transf_lote),'N')
into STRICT	ie_gerar_transf_lote_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_p;

ie_status_transferencia_w := obter_param_usuario(7030, 82, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_p, ie_status_transferencia_w);

if (ie_opcao_p = 'X') then /* Desfazer dispensacao */
	begin
	if (ie_status_atual_w = 'D') then
		update	ap_lote
		set		dt_disp_farmacia	 = NULL,
				nm_usuario_disp		 = NULL,
				ds_maquina_disp		 = NULL,
				cd_perfil_disp		= cd_perfil_ativo_w,
				ie_status_lote		= CASE WHEN dt_atend_farmacia = NULL THEN 'CO'  ELSE 'A' END
		where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p));
	end if;
	end;
elsif (ie_opcao_p = 'D') then /* Dispensar */
	if (ie_status_atual_w = 'C') then
		-- O lote '||to_char(nr_lote_p)||' esta cancelado.#@#@'
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264579,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'G') then
		-- O lote '||to_char(nr_lote_p)||' nao foi gerado.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264580,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'D') then
		-- O lote '||to_char(nr_lote_p)||' ja esta dispensado pela farmacia.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264581,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'E') then
		-- O lote '||to_char(nr_lote_p)||' ja esta entregue no setor.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264582,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'R') then
		--O lote '||to_char(nr_lote_p)||' ja foi recebido no setor.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264583,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	end if;
	
	ie_embalagem_w := obter_param_usuario(7030, 53, Obter_perfil_Ativo, nm_usuario_w, cd_estabelecimento_p, ie_embalagem_w);
	
	if (ie_embalagem_w <> 'S') then
	
		update	ap_lote
		set		dt_disp_farmacia	= clock_timestamp(),
				nm_usuario_disp		= nm_usuario_w,
				ds_maquina_disp		= ds_maquina_w,
				cd_perfil_disp		= cd_perfil_ativo_w,
				ie_status_lote		= 'D',
				cd_tubo_pneumatico	= cd_tubo_pneumatico_p
		where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
		and 	ie_status_lote not in ('C','S');
		
	elsif (ie_embalagem_w = 'S') then
	
		update	ap_lote
		set		dt_disp_farmacia	= clock_timestamp(),
				nm_usuario_disp		= nm_usuario_w,
				ds_maquina_disp		= ds_maquina_w,
				cd_perfil_disp		= cd_perfil_ativo_w,
				ie_status_lote		= 'D',
				nr_seq_embalagem	= nr_seq_embalagem_p,
				cd_tubo_pneumatico	= cd_tubo_pneumatico_p
		where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
		and 	ie_status_lote not in ('C','S');
	end if;
	
	select	max(a.ie_conta_paciente),
		max(b.cd_setor_atendimento)
	into STRICT	ie_conta_paciente_w,
		cd_setor_atendimento_w
	from	prescr_medica b,
		ap_lote a
	where	a.nr_prescricao = b.nr_prescricao
	and	nr_sequencia = nr_lote_p;

	update	ap_lote_agrup_item
	set	ie_status 		= 'C'
	where 	nr_seq_lote		= nr_lote_p;
	
	select	coalesce(max(ie_transf_atend_lote),'N')
	into STRICT	ie_transf_atend_lote_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_w;
	
	if (ie_gerar_transf_lote_w = 'S') and (coalesce(ie_conta_paciente_w, 'N') = 'N') and (ie_status_transferencia_w = 'D') and (ie_transf_atend_lote_w = 'S') then
		CALL gerar_transf_lote_dispensacao(nr_lote_p, cd_estabelecimento_p, nm_usuario_w);
	end if;
	
elsif (ie_opcao_p = 'E') then /* Entregar */
	
	ie_registra_entrega_w := obter_param_usuario(7030, 21, Obter_perfil_Ativo, nm_usuario_w, cd_estabelecimento_p, ie_registra_entrega_w);
	
	if (ie_status_atual_w = 'C') then
		-- O lote '||to_char(nr_lote_p)||' esta cancelado.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264584,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'G') then
		-- O lote '||to_char(nr_lote_p)||' nao foi atendido pela farmacia.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264585,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'E') then
		-- O lote '||to_char(nr_lote_p)||' ja esta entregue no setor.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264582,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w = 'R') then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264583,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	end if;
	
	update	ap_lote
	set		dt_entrega_setor	= clock_timestamp(),
			nm_usuario_entrega	= nm_usuario_w,
			ds_maquina_entrega	= ds_maquina_w,
			cd_perfil_entrega	= cd_perfil_ativo_w,
			ie_status_lote		= 'E',
			cd_tubo_pneumatico	= cd_tubo_pneumatico_p
	where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
	and 	ie_status_lote not in ('C','S');
	
	if (ie_registra_entrega_w = 'S') then
	
		update	ap_lote
		set		dt_disp_farmacia	= clock_timestamp(),
				nm_usuario_disp		= nm_usuario_w,
				ds_maquina_disp		= ds_maquina_w,
				cd_perfil_disp		= cd_perfil_ativo_w
		where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
		and 	ie_status_lote not in ('C','S');
		
		select 	count(*)
		into STRICT	qt_existe_lote_agrup_w
		from	ap_lote_agrup_item
		where	ie_status 		= 'P'
		and 	nr_seq_lote		= nr_lote_p;
		
		if (qt_existe_lote_agrup_w > 0) then
			
			update	ap_lote_agrup_item	
			set	ie_status 		= 'C'
			where 	nr_seq_lote		= nr_lote_p;
			
		end if;
	end if;
	
	select	max(a.ie_conta_paciente),
		max(b.cd_setor_atendimento)
	into STRICT	ie_conta_paciente_w,
		cd_setor_atendimento_w
	from	prescr_medica b,
		ap_lote a
	where	a.nr_prescricao = b.nr_prescricao
	and	nr_sequencia = nr_lote_p;

	select	coalesce(max(ie_transf_atend_lote),'N')
	into STRICT	ie_transf_atend_lote_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_w;

	if (ie_gerar_transf_lote_w = 'S') and (coalesce(ie_conta_paciente_w, 'N') = 'N') and (ie_status_transferencia_w = 'E') and (ie_transf_atend_lote_w = 'S') then
		CALL gerar_transf_lote_dispensacao(nr_lote_p, cd_estabelecimento_p, nm_usuario_w);
	end if;
	
elsif (ie_opcao_p = 'R') then /* Receber */
	ie_registra_recebimento_w := obter_param_usuario(7030, 63, Obter_perfil_Ativo, nm_usuario_w, cd_estabelecimento_p, ie_registra_recebimento_w);
	
	if (ie_status_atual_w = 'C') then
		-- O lote '||to_char(nr_lote_p)||' esta cancelado.#@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264584,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	elsif (ie_status_atual_w <> 'E') and (ie_registra_recebimento_w = 'N') then
		-- O lote '||to_char(nr_lote_p)||' nao foi entregue no setor.#@#@' 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264589,	'NR_LOTE_P='||to_char(NR_LOTE_P));
	end if;

	update	ap_lote
	set		dt_recebimento_setor	= clock_timestamp(),
			nm_usuario_receb	= nm_usuario_w,
			ds_maquina_receb	= ds_maquina_w,
			cd_perfil_receb		= cd_perfil_ativo_w,
			ie_status_lote		= 'R'
	where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
	and 	ie_status_lote not in ('C','S');
	
	if (ie_registra_recebimento_w = 'S') then
		
		select	count(*)
		into STRICT	qt_existe_w
		from	ap_lote
		where	nr_sequencia = nr_lote_p
		and	coalesce(dt_entrega_setor::text, '') = '';
	
		if (qt_existe_w > 0) then
		
			update	ap_lote
			set		dt_entrega_setor	= clock_timestamp(),
					nm_usuario_entrega	= nm_usuario_w,
					ds_maquina_entrega	= ds_maquina_w,
					cd_perfil_entrega	= cd_perfil_ativo_w
			where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
			and 	ie_status_lote not in ('C','S');
		
		end if;
	end if;
	
	select	max(a.ie_conta_paciente),
		max(b.cd_setor_atendimento)
	into STRICT	ie_conta_paciente_w,
		cd_setor_atendimento_w
	from	prescr_medica b,
		ap_lote a
	where	a.nr_prescricao = b.nr_prescricao
	and	nr_sequencia = nr_lote_p;

	select	coalesce(max(ie_transf_atend_lote),'N')
	into STRICT	ie_transf_atend_lote_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_w;
	
	if (ie_gerar_transf_lote_w = 'S') and (coalesce(ie_conta_paciente_w, 'N') = 'N') and (ie_status_transferencia_w = 'R') and (ie_transf_atend_lote_w = 'S') then
		CALL gerar_transf_lote_dispensacao(nr_lote_p, cd_estabelecimento_p, nm_usuario_w);
	end if;
	
	reg_integracao_p.cd_estab_documento		:= cd_estabelecimento_p;
	reg_integracao_p.cd_local_estoque		:= cd_local_estoque_w;
	reg_integracao_p.cd_setor_atendimento	:= cd_setor_atendimento_w;
	reg_integracao_p.nr_seq_agrupador		:= nr_lote_p;
	reg_integracao_p := gerar_int_padrao.gravar_integracao('421', nr_lote_p, nm_usuario_w, reg_integracao_p);
	
elsif (ie_opcao_p = 'A') then /* Atendido */
	update	ap_lote
	set		dt_atend_farmacia	= clock_timestamp(),
			nm_usuario_atend	= nm_usuario_w,
			ds_maquina_atend	= ds_maquina_w,
			cd_perfil_atend		= cd_perfil_ativo_w,
			ie_status_lote		= 'A'
	where	((nr_sequencia		= nr_lote_p) or (nr_lote_agrupamento	= nr_lote_p))
	and 	ie_status_lote not in ('C','S');
	
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_lote ( nr_lote_p bigint, cd_estabelecimento_p bigint, nr_seq_embalagem_p bigint, nm_usuario_lote_p text, ie_opcao_p text, nm_maquina_p text default null, cd_tubo_pneumatico_p text default null) FROM PUBLIC;

