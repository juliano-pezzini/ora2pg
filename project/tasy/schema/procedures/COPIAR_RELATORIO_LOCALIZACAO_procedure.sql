-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_relatorio_localizacao ( nr_seq_relatorio_p bigint, cd_pais_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_novo_relat_p INOUT bigint) AS $body$
DECLARE

nr_seq_novo_relat_w		bigint;
cd_relatorio_wheb_w		integer := null;
cd_classif_relat_wheb_w		varchar(4);
cd_relatorio_pais_w		integer;
CD_CLASSIF_RELAT_PAIS_w		varchar(4);
cd_relatorio_old_w		integer;
cd_classif_old_w		varchar(10);


C01 CURSOR FOR
	SELECT	*
	from	RELATORIO_FUNCAO
	where	NR_SEQ_RELATORIO	= nr_seq_relatorio_p;
	
	
c01_w	c01%rowtype;


BEGIN



select	cd_relatorio_wheb,
	cd_classif_relat_wheb,
	cd_relatorio_pais,
	cd_classif_relat_pais,
	cd_relatorio,
	CD_CLASSIF_RELAT
into STRICT	cd_relatorio_wheb_w,
	cd_classif_relat_wheb_w,
	cd_relatorio_pais_w,
	cd_classif_relat_pais_w,
	cd_relatorio_old_w,
	cd_classif_old_w
from	relatorio
where	nr_sequencia = nr_seq_relatorio_p;

if (coalesce(cd_relatorio_pais_w::text, '') = '') and ( substr(cd_classif_old_w,1,1) = 'W') then
	cd_relatorio_pais_w	:= cd_relatorio_old_w;
	cd_classif_relat_pais_w	:= cd_classif_old_w;
end if;
	
	
if (coalesce(cd_relatorio_wheb_w::text, '') = '') and ( substr(cd_classif_old_w,1,1) = 'W') then
	cd_relatorio_wheb_w	:= cd_relatorio_old_w;
	cd_classif_relat_wheb_w	:= cd_classif_old_w;
end if;



nr_seq_novo_relat_w := copiar_relatorio(	cd_estabelecimento_p, nr_seq_relatorio_p, '@WHEB', nm_usuario_p, nr_seq_novo_relat_w, 'N');

			
update	relatorio
set	cd_pais = cd_pais_p,
	cd_relatorio_wheb	= cd_relatorio_wheb_w,
	cd_classif_relat_wheb	= cd_classif_relat_wheb_w,
	cd_relatorio_pais	= cd_relatorio_pais_w,
	cd_classif_relat_pais	= cd_classif_relat_pais_w
where	nr_sequencia = nr_seq_novo_relat_w;


open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	c01_w.NR_SEQ_RELATORIO	:= nr_seq_novo_relat_w;
	c01_w.dt_atualizacao	:= clock_timestamp();
	c01_w.nm_usuario	:= nm_usuario_p;
	
	insert into RELATORIO_FUNCAO values (c01_w.*);
	end;
end loop;
close C01;


nr_seq_novo_relat_p	:= nr_seq_novo_relat_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_relatorio_localizacao ( nr_seq_relatorio_p bigint, cd_pais_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_novo_relat_p INOUT bigint) FROM PUBLIC;

