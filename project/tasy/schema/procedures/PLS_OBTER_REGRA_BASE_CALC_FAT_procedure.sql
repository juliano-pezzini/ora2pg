-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_base_calc_fat ( cd_tributo_p tributo.cd_tributo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_regra_fat_p pls_regra_faturamento.nr_sequencia%type, nr_seq_evento_p pls_evento_faturamento.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_ato_cooperado_p pls_conta_medica_resumo.ie_ato_cooperado%type, ie_tipo_pessoa_prest_solic_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_solic%type, ie_tipo_pessoa_prest_atend_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_atend%type, ie_tipo_pessoa_prest_pag_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_pag%type, ie_tipo_pessoa_prest_exec_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_exec%type, ie_tipo_pessoa_prest_ptu_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_ptu%type, vl_faturado_p pls_fatura_conta.vl_faturado%type, vl_faturado_ndc_p pls_fatura_conta.vl_faturado_ndc%type, ie_tipo_cobranca_p pls_regra_base_trib_fat.ie_tipo_cobranca%type, vl_base_calculo_p INOUT pls_fatura_trib.vl_base_calculo%type, ie_tipo_valor_p INOUT pls_regra_base_trib_fat.ie_tipo_valor%type, nr_seq_regra_base_calc_p INOUT pls_regra_base_trib_fat.nr_sequencia%type, ie_reducao_base_nf_p INOUT pls_regra_base_trib_fat.ie_reducao_base_nf%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter a base de calculo para a geração dos tributos do faturamento
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 

C01 CURSOR(	cd_tributo_pc			tributo.cd_tributo%type,
		cd_estabelecimento_pc		estabelecimento.cd_estabelecimento%type,
		nr_seq_regra_fat_pc		pls_regra_faturamento.nr_sequencia%type,
		nr_seq_evento_pc		pls_evento_faturamento.nr_sequencia%type,
		cd_cgc_pc			pessoa_juridica.cd_cgc%type,
		cd_pessoa_fisica_pc		pessoa_fisica.cd_pessoa_fisica%type,
		ie_ato_cooperado_pc		pls_conta_medica_resumo.ie_ato_cooperado%type,
		ie_tipo_pessoa_prest_solic_pc	pls_regra_base_trib_fat.ie_tipo_pessoa_prest_solic%type,
		ie_tipo_pessoa_prest_atend_pc	pls_regra_base_trib_fat.ie_tipo_pessoa_prest_atend%type,
		ie_tipo_pessoa_prest_pag_pc	pls_regra_base_trib_fat.ie_tipo_pessoa_prest_pag%type,
		ie_tipo_pessoa_prest_exec_pc	pls_regra_base_trib_fat.ie_tipo_pessoa_prest_exec%type,
		ie_tipo_pessoa_prest_ptu_pc	pls_regra_base_trib_fat.ie_tipo_pessoa_prest_ptu%type,
		ie_tipo_cobranca_pc		pls_regra_base_trib_fat.ie_tipo_cobranca%type) FOR
	SELECT	ie_tipo_valor,
		nr_sequencia,
		ie_reducao_base_nf
	from	pls_regra_base_trib_fat
	where	cd_tributo							= cd_tributo_pc
	and	cd_estabelecimento						= cd_estabelecimento_pc
	and	coalesce(nr_seq_regra_fat,nr_seq_regra_fat_pc)			= nr_seq_regra_fat_pc
	and	coalesce(nr_seq_evento_fat,nr_seq_evento_pc)				= nr_seq_evento_pc
	and (cd_cgc				= cd_cgc_pc 			or coalesce(cd_cgc::text, '') = '')
	and (cd_pessoa_fisica		= cd_pessoa_fisica_pc		or coalesce(cd_pessoa_fisica::text, '') = '')
	and (ie_ato_cooperado		= ie_ato_cooperado_pc		or coalesce(ie_ato_cooperado::text, '') = '')
	and (ie_tipo_pessoa_prest_solic	= ie_tipo_pessoa_prest_solic_pc	or ie_tipo_pessoa_prest_solic = 'A')
	and (ie_tipo_pessoa_prest_atend	= ie_tipo_pessoa_prest_atend_pc	or ie_tipo_pessoa_prest_atend = 'A')
	and (ie_tipo_pessoa_prest_pag	= ie_tipo_pessoa_prest_pag_pc	or ie_tipo_pessoa_prest_pag = 'A')
	and (ie_tipo_pessoa_prest_exec	= ie_tipo_pessoa_prest_exec_pc	or ie_tipo_pessoa_prest_exec = 'A')
	and (ie_tipo_pessoa_prest_ptu	= ie_tipo_pessoa_prest_ptu_pc	or ie_tipo_pessoa_prest_ptu = 'A')
	and (ie_tipo_cobranca		= ie_tipo_cobranca_pc		or coalesce(ie_tipo_cobranca::text, '') = '')
	order by
		coalesce(cd_cgc,' '),
		coalesce(cd_pessoa_fisica,' '),
		coalesce(ie_ato_cooperado,' '),
		coalesce(ie_tipo_pessoa_prest_exec,' '),
		coalesce(ie_tipo_pessoa_prest_pag,' '),
		coalesce(ie_tipo_pessoa_prest_atend,' '),
		coalesce(ie_tipo_pessoa_prest_solic,' '),
		coalesce(ie_tipo_pessoa_prest_ptu,' '),
		coalesce(ie_tipo_cobranca,' ');

BEGIN
ie_tipo_valor_p := 'T';
vl_base_calculo_p := 0;
nr_seq_regra_base_calc_p := null;

for r_C01_w in C01(	cd_tributo_p, cd_estabelecimento_p, nr_seq_regra_fat_p, nr_seq_evento_p, cd_cgc_p, cd_pessoa_fisica_p, ie_ato_cooperado_p, ie_tipo_pessoa_prest_solic_p,
			ie_tipo_pessoa_prest_atend_p, ie_tipo_pessoa_prest_pag_p, ie_tipo_pessoa_prest_exec_p, ie_tipo_pessoa_prest_ptu_p, ie_tipo_cobranca_p) loop
			
	ie_tipo_valor_p			:= r_C01_w.ie_tipo_valor;
	nr_seq_regra_base_calc_p	:= r_C01_w.nr_sequencia;
	ie_reducao_base_nf_p		:= r_C01_w.ie_reducao_base_nf;

end loop;

-- (VT,VS,VA)(Valor total,Valor do serviço,Valor da taxa)
if (nr_seq_regra_base_calc_p IS NOT NULL AND nr_seq_regra_base_calc_p::text <> '') then
	if (coalesce(ie_tipo_valor_p,'T') = 'VT') then
		vl_base_calculo_p := coalesce(vl_faturado_p,0) + coalesce(vl_faturado_ndc_p,0);

	elsif (coalesce(ie_tipo_valor_p,'T') = 'VS') then
		vl_base_calculo_p := coalesce(vl_faturado_ndc_p,0);

	elsif (coalesce(ie_tipo_valor_p,'T') = 'VA') then
		vl_base_calculo_p := coalesce(vl_faturado_p,0);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_base_calc_fat ( cd_tributo_p tributo.cd_tributo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_regra_fat_p pls_regra_faturamento.nr_sequencia%type, nr_seq_evento_p pls_evento_faturamento.nr_sequencia%type, cd_cgc_p pessoa_juridica.cd_cgc%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_ato_cooperado_p pls_conta_medica_resumo.ie_ato_cooperado%type, ie_tipo_pessoa_prest_solic_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_solic%type, ie_tipo_pessoa_prest_atend_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_atend%type, ie_tipo_pessoa_prest_pag_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_pag%type, ie_tipo_pessoa_prest_exec_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_exec%type, ie_tipo_pessoa_prest_ptu_p pls_regra_base_trib_fat.ie_tipo_pessoa_prest_ptu%type, vl_faturado_p pls_fatura_conta.vl_faturado%type, vl_faturado_ndc_p pls_fatura_conta.vl_faturado_ndc%type, ie_tipo_cobranca_p pls_regra_base_trib_fat.ie_tipo_cobranca%type, vl_base_calculo_p INOUT pls_fatura_trib.vl_base_calculo%type, ie_tipo_valor_p INOUT pls_regra_base_trib_fat.ie_tipo_valor%type, nr_seq_regra_base_calc_p INOUT pls_regra_base_trib_fat.nr_sequencia%type, ie_reducao_base_nf_p INOUT pls_regra_base_trib_fat.ie_reducao_base_nf%type) FROM PUBLIC;

