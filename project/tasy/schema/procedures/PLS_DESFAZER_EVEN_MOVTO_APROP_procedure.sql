-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_even_movto_aprop ( nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
nr_lote_contabil_w		pls_lote_evento.nr_lote_contabil%type;
nr_seq_lote_pagamento_w		pls_lote_evento.nr_seq_lote_pagamento%type;


BEGIN 
 
select	max(nr_lote_contabil) 
into STRICT	nr_lote_contabil_w 
from	pls_lote_evento 
where	coalesce(nr_lote_contabil, 0)	> 0 
and	nr_seq_lote_pgto_apropr		= nr_seq_lote_pgto_p;
 
if (coalesce(nr_lote_contabil_w, 0) > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(329886, 'NR_LOTE_CONTABIL=' || to_char(nr_lote_contabil_w));
	-- Não é possível desfazer a geração dos vencimentos deste lote! 
	-- O lote de movimentação de ocorrências financeiras deste lote já está contabilizado no lote contábiL :NR_LOTE_CONTABIL 
end if;
 
select	max(nr_lote_contabil) 
into STRICT	nr_lote_contabil_w 
from	pls_evento_movimento 
where	coalesce(nr_lote_contabil, 0)	> 0 
and	nr_seq_lote in (SELECT	nr_sequencia 
		from	pls_lote_evento 
		where	nr_seq_lote_pgto_apropr	= nr_seq_lote_pgto_p);
 
if (coalesce(nr_lote_contabil_w, 0) > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(329886, 'NR_LOTE_CONTABIL=' || to_char(nr_lote_contabil_w));
	-- Não é possível desfazer a geração dos vencimentos deste lote! 
	-- O lote de movimentação de ocorrências financeiras deste lote já está contabilizado no lote contábiL :NR_LOTE_CONTABIL 
end if;
 
select	max(nr_seq_lote_pagamento) 
into STRICT	nr_seq_lote_pagamento_w 
from	pls_lote_evento 
where	coalesce(nr_seq_lote_pagamento, 0)	> 0 
and	nr_seq_lote_pgto_apropr		= nr_seq_lote_pgto_p;
 
if (coalesce(nr_seq_lote_pagamento_w, 0) > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(329887, 'NR_SEQ_LOTE_PGTO=' || to_char(nr_seq_lote_pagamento_w));
	-- Não é possível desfazer a geração dos vencimentos deste lote! 
	-- O lote de movimentação de ocorrências financeiras deste lote já foi apropriado no lote de pagamento :nr_seq_lote_pagamento_w 
end if;
 
select	max(nr_seq_lote_pgto) 
into STRICT	nr_seq_lote_pagamento_w 
from	pls_evento_movimento 
where	coalesce(nr_seq_lote_pgto, 0)	> 0 
and	nr_seq_lote in (SELECT	nr_sequencia 
		from	pls_lote_evento 
		where	nr_seq_lote_pgto_apropr	= nr_seq_lote_pgto_p);
		 
if (coalesce(nr_seq_lote_pagamento_w, 0) > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(329887, 'NR_SEQ_LOTE_PGTO=' || to_char(nr_seq_lote_pagamento_w));
	-- Não é possível desfazer a geração dos vencimentos deste lote! 
	-- O lote de movimentação de ocorrências financeiras deste lote já foi apropriado no lote de pagamento :nr_seq_lote_pgto_w 
end if;
 
update	pls_pag_prest_vencimento 
set	ie_proximo_pgto		= 'S', 
	nr_seq_evento_movto	 = NULL 
where	nr_seq_evento_movto	in (SELECT	nr_sequencia 
	from	pls_evento_movimento 
	where	nr_seq_lote in (select	nr_sequencia 
		from	pls_lote_evento 
		where	nr_seq_lote_pgto_apropr	= nr_seq_lote_pgto_p));
 
delete	from pls_evento_movimento 
where	nr_seq_lote in (SELECT	nr_sequencia 
	from	pls_lote_evento 
	where	nr_seq_lote_pgto_apropr	= nr_seq_lote_pgto_p);
 
delete	from pls_lote_evento 
where	nr_seq_lote_pgto_apropr	= nr_seq_lote_pgto_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_even_movto_aprop ( nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

