-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_estornar_copart_protocolo ( ds_contas_p text, --Aqui podem ser passadas várias contas de uma única vez, elas serão obtidas individualmenete depois.
 ds_motivo_p text, ie_estornou_registro_p INOUT text , nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ie_contas_com_copartic_w	varchar(1);
nr_seq_conta_w			pls_conta.nr_sequencia%type;

--Cursor utilizado para separar a lista de valores em sequencias de contas
C01 CURSOR(	ds_lista_p	text,
		ds_separador_p	text) FOR
	SELECT	nr_valor_number
	from	table(pls_util_pck.converter_lista_valores(ds_lista_p, ds_separador_p));

C02 CURSOR(nr_seq_conta_pw	pls_conta.nr_sequencia%type) FOR
	SELECT  a.nr_sequencia,
		coalesce(a.ie_estorno_custo, 'N') ie_estorno_custo
	from  	pls_conta_coparticipacao a,
		pls_conta b,
		pls_protocolo_conta c
	where   a.nr_seq_conta = nr_seq_conta_pw
	and     a.nr_seq_conta = b.nr_sequencia
	and     b.nr_seq_protocolo = c.nr_sequencia
	and     coalesce(a.nr_seq_mensalidade_seg::text, '') = ''
	and     ((c.ie_status in (3,5)) or (b.ie_status = 'F'));
BEGIN

	ie_contas_com_copartic_w := 'N';
	--Percorre a lista de valores, considerando a vírgula como separador de valores
	for r_C01_w in C01(ds_contas_p, ',') loop

		nr_seq_conta_w := r_C01_w.nr_valor_number;
		--Percorre individualmente os registros de coparticipação
		for r_C02_w in C02(nr_seq_conta_w) loop

			if (coalesce(r_C02_w.ie_estorno_custo::text, '') = '' or r_C02_w.ie_estorno_custo = 'N') then
				CALL pls_estornar_custo_copartic( r_C02_w.nr_sequencia, ds_motivo_p, 'T', nm_usuario_p, 'C');
				ie_contas_com_copartic_w := 'S';
			end if;

		end loop;
	end loop;

	ie_estornou_registro_p := ie_contas_com_copartic_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_estornar_copart_protocolo ( ds_contas_p text, ds_motivo_p text, ie_estornou_registro_p INOUT text , nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

