-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_doc_devolucao ( nr_atendimento_p bigint, nr_devolucao_p bigint, nr_doc_interno_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_motivo_devolucao_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint;
cd_material_w			integer;
dt_atendimento_w		timestamp;
cd_unidade_medida_w		varchar(30);
qt_material_w			double precision;
nr_sequencia_prescricao_w	integer;
dt_entrada_unidade_w		timestamp;
nr_seq_atendimento_w		bigint;
cd_local_estoque_w		smallint;
nr_prescricao_w			bigint;

C01 CURSOR FOR 
	SELECT	a.cd_material, 
		a.dt_atendimento, 
		a.cd_unidade_medida, 
		a.nr_sequencia_prescricao, 
		a.dt_entrada_unidade, 
		a.nr_sequencia, 
		a.cd_local_estoque, 
		sum(a.qt_material), 
		a.nr_prescricao 
	FROM material b, material_em_devolucao_v a
LEFT OUTER JOIN tipo_baixa_prescricao c ON (a.cd_motivo_baixa = c.cd_tipo_baixa AND a.ie_prescr_dev = c.ie_prescricao_devolucao)
WHERE a.cd_material = b.cd_material and a.nr_atendimento = nr_atendimento_p and a.nr_doc_interno = nr_doc_interno_P and a.cd_setor_atendimento = coalesce(cd_setor_atendimento_p, a.cd_setor_atendimento) and not exists ( SELECT 1 from item_devolucao_material_pac where nr_seq_atendimento = a.nr_sequencia)   and ((a.qt_material < 0) or (a.cd_local_estoque IS NOT NULL AND a.cd_local_estoque::text <> '') or (c.ie_atualiza_estoque = 'N' AND c.ie_conta_paciente = 'S')) GROUP BY a.cd_material, 
		a.dt_atendimento, 
		a.cd_unidade_medida, 
		a.nr_sequencia_prescricao, 
		a.dt_entrada_unidade, 
		a.nr_sequencia, 
		a.cd_local_estoque, 
		a.nr_doc_interno, 
		a.nr_prescricao;


BEGIN 
ds_erro_p := '';
 
open C01;
loop 
fetch C01  HAVING	sum(a.qt_material) > 0 
	into 
	cd_material_w, 
	dt_atendimento_w, 
	cd_unidade_medida_w, 
	nr_sequencia_prescricao_w, 
	dt_entrada_unidade_w, 
	nr_seq_atendimento_w, 
	cd_local_estoque_w, 
	qt_material_w, 
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from	item_devolucao_material_pac 
	where	nr_devolucao = nr_devolucao_p;
 
	insert into ITEM_DEVOLUCAO_MATERIAL_PAC( 
		nr_devolucao, 
		nr_sequencia, 
		cd_material, 
		dt_atendimento, 
		cd_local_estoque, 
		cd_unidade_medida, 
		cd_motivo_devolucao, 
		dt_atualizacao, 
		nm_usuario_devol, 
		qt_material, 
		nr_prescricao, 
		nr_sequencia_prescricao, 
		ie_tipo_baixa_estoque, 
		dt_entrada_unidade, 
		nr_seq_atendimento, 
		nm_usuario) 
	values ( 
		nr_devolucao_p, 
		nr_sequencia_w, 
		cd_material_w, 
		dt_atendimento_w, 
		CASE WHEN cd_local_estoque_p=0 THEN  coalesce(cd_local_estoque_w,0)   ELSE cd_local_estoque_p END , 
		cd_unidade_medida_w, 
		cd_motivo_devolucao_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		qt_material_w, 
		nr_prescricao_w, 
		nr_sequencia_prescricao_w, 
		0, 
		dt_entrada_unidade_w, 
		nr_seq_atendimento_w, 
		nm_usuario_p);
	end;
end loop;
close c01;
 
if (coalesce(nr_sequencia_w,0) = 0) then 
	ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(281162);
end if;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_doc_devolucao ( nr_atendimento_p bigint, nr_devolucao_p bigint, nr_doc_interno_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_motivo_devolucao_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

