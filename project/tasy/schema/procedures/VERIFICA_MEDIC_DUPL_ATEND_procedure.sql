-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_medic_dupl_atend (nr_seq_atendimento_p paciente_atend_medic.nr_seq_atendimento%type, nr_sequencia_p paciente_atend_medic.nr_seq_material%type, ds_erro_w INOUT text, cd_material_p paciente_atend_medic.cd_material%type) AS $body$
DECLARE


  nr_seq_ficha_tecnica_w       material.nr_seq_ficha_tecnica%type;
  i RECORD;

BEGIN
  if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
    begin
      select material.nr_seq_ficha_tecnica
        into STRICT nr_seq_ficha_tecnica_w
        from material
       where material.cd_material = cd_material_p;
    exception
      when no_data_found then
        nr_seq_ficha_tecnica_w := null;
    end;
  end if;

  for i in (SELECT material.nr_seq_ficha_tecnica, 
                   material.cd_material, 
                   paciente_atend_medic.nr_seq_material
              from paciente_atend_medic
             inner join material ON (material.cd_material = paciente_atend_medic.cd_material)
             where coalesce(paciente_atend_medic.nr_seq_mat_diluicao::text, '') = ''
               and nr_seq_atendimento = nr_seq_atendimento_p) LOOP
               
    if (coalesce(i.nr_seq_ficha_tecnica,0) = coalesce(nr_seq_ficha_tecnica_w,-1) and coalesce(i.nr_seq_material,0) <> coalesce(nr_sequencia_p,0)) then
      ds_erro_w := Wheb_mensagem_pck.get_texto(1175707, null);
      return;
    end if;
  end LOOP;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_medic_dupl_atend (nr_seq_atendimento_p paciente_atend_medic.nr_seq_atendimento%type, nr_sequencia_p paciente_atend_medic.nr_seq_material%type, ds_erro_w INOUT text, cd_material_p paciente_atend_medic.cd_material%type) FROM PUBLIC;

