-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE int_inserir_medicamento ( cd_intervalo_p text, cd_material_p bigint, cd_motivo_baixa_p bigint, cd_perfil_ativo_p bigint, cd_unidade_medida_p text, cd_unidade_medida_dose_p text, ds_horarios_p text, ds_horarios_medico_p text, ds_justificativa_p text, ds_justif_troca_disp_p text, ds_lote_p text, ds_motivo_disp_p text, ds_motivo_susp_p text, ds_observacao_p text, dt_atualizacao_p timestamp, dt_atualizacao_nrec_p timestamp, dt_liberacao_p timestamp, dt_suspensao_p timestamp, ie_acm_p text, ie_agrupador_p text, ie_aplicar_p text, ie_aplic_bolus_p text, ie_aplic_lenta_p text, ie_regra_disp_p text, ie_sem_aprazamento_p text, ie_se_necessario_p text, ie_status_p text, ie_suspenso_p text, ie_urgencia_p text, ie_via_aplicacao_p text, nm_usuario_alt_local_p text, nm_usuario_consist_p text, nm_usuario_disp_p text, nm_usuario_liberacao_p text, nm_usuario_nao_disp_p text, nm_usuario_original_p text, nm_usuario_susp_p text, nr_agrupamento_p bigint, nr_dia_util_p bigint, nr_doc_interno_p bigint, nr_doc_interno_aux_p bigint, nr_motivo_disp_p bigint, nr_ocorrencia_p bigint, nr_prescricao_p bigint, nr_prescricao_anterior_p bigint, nr_prescricao_original_p bigint, nr_receita_p bigint, nr_seq_anterior_p bigint, nr_seq_assin_apraza_p bigint, nr_seq_assinatura_p bigint, nr_seq_assinatura_susp_p bigint, nr_seq_assin_prim_hor_p bigint, nr_seq_atendimento_p bigint, nr_seq_atend_medic_p bigint, nr_seq_avaliacao_p bigint, nr_seq_classif_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_inconsistencia_p bigint, nr_seq_interf_farm_p bigint, nr_seq_interno_p bigint, nr_seq_justificativa_p bigint, nr_seq_kit_p bigint, nr_seq_kit_estoque_p bigint, nr_seq_leite_deriv_p bigint, nr_seq_lote_fornec_p bigint, nr_seq_marca_p bigint, nr_seq_mat_diluicao_p bigint, nr_seq_mat_disp_p bigint, nr_seq_material_p bigint, nr_seq_material_autor_p bigint, nr_seq_mat_protocolo_p bigint, nr_seq_medic_material_p bigint, nr_sequencia_diluicao_p bigint, nr_sequencia_proc_p bigint, nr_sequencia_solucao_p bigint, nr_seq_via_acesso_p bigint, qt_conversao_dose_p bigint, qt_dia_prim_hor_p bigint, qt_dias_liberado_p bigint, qt_dias_solicitado_p bigint, qt_dias_util_p bigint, qt_dose_p bigint, qt_hora_aplicacao_p bigint, qt_hora_intervalo_p bigint, qt_material_p bigint, qt_min_aplicacao_p bigint, qt_min_intervalo_p bigint, qt_original_p bigint, qt_porcentagem_p bigint, qt_qsp_diluente_p bigint, qt_ref_diluente_p bigint, qt_solucao_p bigint, qt_total_dias_lib_p bigint, qt_total_dispensar_p bigint, qt_unitaria_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_sequencia_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
ie_gerar_kit_w		varchar(10);
ie_prescr_mat_sem_lib_w	varchar(10);
ie_calcula_volume_afterpost_w		varchar(1);


BEGIN 
 
begin 
 
select	coalesce(max(nr_sequencia),0) + 1 
into STRICT	nr_sequencia_w 
from	prescr_material 
where	nr_prescricao	= nr_prescricao_p;
 
insert into prescr_material( 
		cd_intervalo, 
		cd_material, 
		cd_motivo_baixa, 
		cd_perfil_ativo, 
		cd_unidade_medida, 
		cd_unidade_medida_dose, 
		ds_horarios, 
		ds_horarios_medico, 
		ds_justificativa, 
		ds_justif_troca_disp, 
		ds_lote, 
		ds_motivo_disp, 
		ds_motivo_susp, 
		ds_observacao	, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		dt_liberacao, 
		dt_suspensao, 
		ie_acm, 
		ie_agrupador, 
		ie_aplicar, 
		ie_aplic_bolus, 
		ie_aplic_lenta, 
		ie_regra_disp, 
		ie_sem_aprazamento, 
		ie_se_necessario, 
		ie_status, 
		ie_suspenso, 
		ie_urgencia, 
		ie_via_aplicacao, 
		nm_usuario_alt_local, 
		nm_usuario_consist, 
		nm_usuario_disp, 
		nm_usuario_liberacao, 
		nm_usuario_nao_disp, 
		nm_usuario_original, 
		nm_usuario_susp, 
		nr_agrupamento, 
		nr_dia_util, 
		nr_doc_interno, 
		nr_doc_interno_aux, 
		nr_motivo_disp, 
		nr_ocorrencia, 
		nr_prescricao, 
		nr_prescricao_anterior, 
		nr_prescricao_original, 
		nr_receita, 
		nr_seq_anterior, 
		nr_seq_assin_apraza, 
		nr_seq_assinatura, 
		nr_seq_assinatura_susp, 
		nr_seq_assin_prim_hor, 
		nr_seq_atendimento, 
		nr_seq_atend_medic, 
		nr_seq_avaliacao, 
		nr_seq_classif, 
		nr_seq_gasoterapia, 
		nr_seq_inconsistencia, 
		nr_seq_interf_farm, 
		nr_seq_interno, 
		nr_seq_justificativa, 
		nr_seq_kit, 
		nr_seq_kit_estoque, 
		nr_seq_leite_deriv, 
		nr_seq_lote_fornec, 
		nr_seq_marca, 
		nr_seq_mat_diluicao, 
		nr_seq_mat_disp, 
		nr_seq_material, 
		nr_seq_material_autor, 
		nr_seq_mat_protocolo, 
		nr_seq_medic_material, 
		nr_sequencia, 
		nr_sequencia_diluicao, 
		nr_sequencia_proc, 
		nr_sequencia_solucao, 
		nr_seq_via_acesso, 
		qt_conversao_dose, 
		qt_dia_prim_hor, 
		qt_dias_liberado, 
		qt_dias_solicitado, 
		qt_dias_util, 
		qt_dose, 
		qt_hora_aplicacao, 
		qt_hora_intervalo, 
		qt_material, 
		qt_min_aplicacao, 
		qt_min_intervalo, 
		qt_original, 
		qt_porcentagem, 
		qt_qsp_diluente, 
		qt_ref_diluente, 
		qt_solucao, 
		qt_total_dias_lib, 
		qt_total_dispensar, 
		qt_unitaria, 
		nm_usuario, 
		ie_origem_inf) 
		values ( 
		cd_intervalo_p, 
		cd_material_p, 
		cd_motivo_baixa_p, 
		cd_perfil_ativo_p, 
		cd_unidade_medida_p, 
		cd_unidade_medida_dose_p, 
		ds_horarios_p, 
		ds_horarios_medico_p, 
		ds_justificativa_p, 
		ds_justif_troca_disp_p, 
		ds_lote_p, 
		ds_motivo_disp_p, 
		ds_motivo_susp_p, 
		ds_observacao_p	, 
		dt_atualizacao_p, 
		dt_atualizacao_nrec_p, 
		dt_liberacao_p, 
		dt_suspensao_p, 
		ie_acm_p, 
		ie_agrupador_p, 
		ie_aplicar_p, 
		ie_aplic_bolus_p, 
		ie_aplic_lenta_p, 
		ie_regra_disp_p, 
		ie_sem_aprazamento_p, 
		ie_se_necessario_p, 
		ie_status_p, 
		ie_suspenso_p, 
		ie_urgencia_p, 
		ie_via_aplicacao_p, 
		nm_usuario_alt_local_p, 
		nm_usuario_consist_p, 
		nm_usuario_disp_p, 
		nm_usuario_liberacao_p, 
		nm_usuario_nao_disp_p, 
		nm_usuario_original_p, 
		nm_usuario_susp_p, 
		nr_agrupamento_p, 
		nr_dia_util_p, 
		nr_doc_interno_p, 
		nr_doc_interno_aux_p, 
		nr_motivo_disp_p, 
		nr_ocorrencia_p, 
		nr_prescricao_p, 
		nr_prescricao_anterior_p, 
		nr_prescricao_original_p, 
		nr_receita_p, 
		nr_seq_anterior_p, 
		nr_seq_assin_apraza_p, 
		nr_seq_assinatura_p, 
		nr_seq_assinatura_susp_p, 
		nr_seq_assin_prim_hor_p, 
		nr_seq_atendimento_p, 
		nr_seq_atend_medic_p, 
		nr_seq_avaliacao_p, 
		nr_seq_classif_p, 
		nr_seq_gasoterapia_p, 
		nr_seq_inconsistencia_p, 
		nr_seq_interf_farm_p, 
		nr_seq_interno_p, 
		nr_seq_justificativa_p, 
		nr_seq_kit_p, 
		nr_seq_kit_estoque_p, 
		nr_seq_leite_deriv_p, 
		nr_seq_lote_fornec_p, 
		nr_seq_marca_p, 
		nr_seq_mat_diluicao_p, 
		nr_seq_mat_disp_p, 
		nr_seq_material_p, 
		nr_seq_material_autor_p, 
		nr_seq_mat_protocolo_p, 
		nr_seq_medic_material_p, 
		nr_sequencia_w, 
		nr_sequencia_diluicao_p, 
		nr_sequencia_proc_p, 
		nr_sequencia_solucao_p, 
		nr_seq_via_acesso_p, 
		qt_conversao_dose_p, 
		qt_dia_prim_hor_p, 
		qt_dias_liberado_p, 
		qt_dias_solicitado_p, 
		qt_dias_util_p, 
		qt_dose_p, 
		qt_hora_aplicacao_p, 
		qt_hora_intervalo_p, 
		qt_material_p, 
		qt_min_aplicacao_p, 
		qt_min_intervalo_p, 
		qt_original_p, 
		qt_porcentagem_p, 
		qt_qsp_diluente_p, 
		qt_ref_diluente_p, 
		qt_solucao_p, 
		qt_total_dias_lib_p, 
		qt_total_dispensar_p, 
		qt_unitaria_p, 
		nm_usuario_p, 
		'E');
 
	commit;
	 
	if (ie_agrupador_p in (3,7,9)) and (nr_sequencia_diluicao_p IS NOT NULL AND nr_sequencia_diluicao_p::text <> '') then 
		ie_gerar_kit_w := Obter_Param_Usuario(924, 702, cd_perfil_ativo_p, nm_usuario_p, cd_estabelecimento_p, ie_gerar_kit_w);
		ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_ativo_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_mat_sem_lib_w);
		ie_calcula_volume_afterpost_w := Obter_Param_Usuario(924, 600, cd_perfil_ativo_p, nm_usuario_p, cd_estabelecimento_p, ie_calcula_volume_afterpost_w);
		 
		if (ie_gerar_kit_w = 'S') then 
			CALL Gerar_Kit_Medic_Prescricao(cd_estabelecimento_p, nr_prescricao_p, nr_sequencia_w, nm_usuario_p, 'S');
		end if;
		IF (ie_prescr_mat_sem_lib_w = 'S') THEN 
			CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_ativo_p,'N',nm_usuario_p,null);
		END IF;				
		CALL define_local_disp_prescr(nr_prescricao_p, NULL, cd_perfil_ativo_p, nm_usuario_p);
		CALL Ajustar_Dose_Diluente(nr_prescricao_p, nr_sequencia_p);
 
		if (ie_calcula_volume_afterpost_w = 'S') then 
			CALL calcular_vol_dil_Prescr_mat(nr_prescricao_p, nr_agrupamento_p, nm_usuario_p);
		end if;	
	end if;
 
nr_sequencia_p		:= 	nr_sequencia_w;
 
exception 
when others then 
	ds_erro_p	:= substr(SQLERRM,1,255);
end;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE int_inserir_medicamento ( cd_intervalo_p text, cd_material_p bigint, cd_motivo_baixa_p bigint, cd_perfil_ativo_p bigint, cd_unidade_medida_p text, cd_unidade_medida_dose_p text, ds_horarios_p text, ds_horarios_medico_p text, ds_justificativa_p text, ds_justif_troca_disp_p text, ds_lote_p text, ds_motivo_disp_p text, ds_motivo_susp_p text, ds_observacao_p text, dt_atualizacao_p timestamp, dt_atualizacao_nrec_p timestamp, dt_liberacao_p timestamp, dt_suspensao_p timestamp, ie_acm_p text, ie_agrupador_p text, ie_aplicar_p text, ie_aplic_bolus_p text, ie_aplic_lenta_p text, ie_regra_disp_p text, ie_sem_aprazamento_p text, ie_se_necessario_p text, ie_status_p text, ie_suspenso_p text, ie_urgencia_p text, ie_via_aplicacao_p text, nm_usuario_alt_local_p text, nm_usuario_consist_p text, nm_usuario_disp_p text, nm_usuario_liberacao_p text, nm_usuario_nao_disp_p text, nm_usuario_original_p text, nm_usuario_susp_p text, nr_agrupamento_p bigint, nr_dia_util_p bigint, nr_doc_interno_p bigint, nr_doc_interno_aux_p bigint, nr_motivo_disp_p bigint, nr_ocorrencia_p bigint, nr_prescricao_p bigint, nr_prescricao_anterior_p bigint, nr_prescricao_original_p bigint, nr_receita_p bigint, nr_seq_anterior_p bigint, nr_seq_assin_apraza_p bigint, nr_seq_assinatura_p bigint, nr_seq_assinatura_susp_p bigint, nr_seq_assin_prim_hor_p bigint, nr_seq_atendimento_p bigint, nr_seq_atend_medic_p bigint, nr_seq_avaliacao_p bigint, nr_seq_classif_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_inconsistencia_p bigint, nr_seq_interf_farm_p bigint, nr_seq_interno_p bigint, nr_seq_justificativa_p bigint, nr_seq_kit_p bigint, nr_seq_kit_estoque_p bigint, nr_seq_leite_deriv_p bigint, nr_seq_lote_fornec_p bigint, nr_seq_marca_p bigint, nr_seq_mat_diluicao_p bigint, nr_seq_mat_disp_p bigint, nr_seq_material_p bigint, nr_seq_material_autor_p bigint, nr_seq_mat_protocolo_p bigint, nr_seq_medic_material_p bigint, nr_sequencia_diluicao_p bigint, nr_sequencia_proc_p bigint, nr_sequencia_solucao_p bigint, nr_seq_via_acesso_p bigint, qt_conversao_dose_p bigint, qt_dia_prim_hor_p bigint, qt_dias_liberado_p bigint, qt_dias_solicitado_p bigint, qt_dias_util_p bigint, qt_dose_p bigint, qt_hora_aplicacao_p bigint, qt_hora_intervalo_p bigint, qt_material_p bigint, qt_min_aplicacao_p bigint, qt_min_intervalo_p bigint, qt_original_p bigint, qt_porcentagem_p bigint, qt_qsp_diluente_p bigint, qt_ref_diluente_p bigint, qt_solucao_p bigint, qt_total_dias_lib_p bigint, qt_total_dispensar_p bigint, qt_unitaria_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_sequencia_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

