-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_conta_ded_conv ( nr_interno_conta_cancel_p bigint, nr_seq_propaci_cancel_p bigint, nr_seq_matpaci_cancel_p bigint, nr_seq_propaci_orig_p bigint, nr_seq_matpaci_orig_p bigint, nr_seq_propaci_dest_p bigint, nr_seq_matpaci_dest_p bigint, qt_acao_p bigint, ie_cancel_conta_orig_p text, nm_usuario_p text) AS $body$
DECLARE

									
nr_seq_deducao_conv_orig_w	conta_pac_deducao_conv.nr_sequencia%type	:= null;
nr_seq_deducao_conv_dest_w	conta_pac_deducao_conv.nr_sequencia%type	:= null;
nr_seq_deducao_conv_w		conta_pac_deducao_conv.nr_sequencia%type	:= null;
nr_seq_valor_proc_w		proc_paciente_valor.nr_sequencia%type;
nr_seq_valor_mat_w		mat_atend_paciente_valor.nr_sequencia%type;
nr_seq_conta_orig_w		conta_paciente.nr_interno_conta%type		:= null;
nr_seq_conta_des_w		conta_paciente.nr_interno_conta%type		:= null;
nr_seq_deducao_estorno_w	conta_pac_deducao_conv.nr_sequencia%type	:= null;
nr_seq_conta_ded_original_w	conta_paciente.nr_interno_conta%type		:= null;
nr_seq_ded_item_orig_w		conta_pac_ded_conv_item.nr_sequencia%type	:= null;
nr_seq_proc_ded_orig_w		procedimento_paciente.nr_sequencia%type;
nr_seq_mat_ded_orig_w		material_atend_paciente.nr_sequencia%type;
nr_seq_ded_conv_item_w		conta_pac_ded_conv_item.nr_sequencia%type	:= null;

c_deducao CURSOR FOR
	SELECT	'O' ie_tipo,
		a.ie_tipo_calculo,
		a.nr_sequencia
	from	conta_pac_deducao_conv a
	where	a.nr_seq_conta_orig	= nr_interno_conta_cancel_p
	
union all

	SELECT	'D' ie_tipo,
		a.ie_tipo_calculo,
		a.nr_sequencia
	from	conta_pac_deducao_conv a
	where	a.nr_seq_conta_des	= nr_interno_conta_cancel_p;

BEGIN

for	r_c_deducao in c_deducao loop

	if (nr_seq_propaci_orig_p IS NOT NULL AND nr_seq_propaci_orig_p::text <> '') then
		select	a.nr_interno_conta
		into STRICT	nr_seq_conta_orig_w
		from	procedimento_paciente a
		where	a.nr_sequencia	= nr_seq_propaci_orig_p;
	end if;
	if (nr_seq_matpaci_orig_p IS NOT NULL AND nr_seq_matpaci_orig_p::text <> '') then
		select	a.nr_interno_conta
		into STRICT	nr_seq_conta_orig_w
		from	material_atend_paciente a
		where	a.nr_sequencia	= nr_seq_matpaci_orig_p;
	end if;
	if (nr_seq_propaci_dest_p IS NOT NULL AND nr_seq_propaci_dest_p::text <> '') then
		select	a.nr_interno_conta
		into STRICT	nr_seq_conta_des_w
		from	procedimento_paciente a
		where	a.nr_sequencia	= nr_seq_propaci_dest_p;
	end if;
	if (nr_seq_matpaci_dest_p IS NOT NULL AND nr_seq_matpaci_dest_p::text <> '') then
		select	a.nr_interno_conta
		into STRICT	nr_seq_conta_des_w
		from	material_atend_paciente a
		where	a.nr_sequencia	= nr_seq_matpaci_dest_p;
	end if;
	
	/* Buscar deducoes originais */

	if (nr_seq_conta_orig_w IS NOT NULL AND nr_seq_conta_orig_w::text <> '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_deducao_conv_orig_w
		from	conta_pac_deducao_conv a
		where	a.nr_seq_conta_orig = nr_seq_conta_orig_w
		and	a.ie_tipo_calculo = r_c_deducao.ie_tipo_calculo;
	else
		nr_seq_deducao_conv_orig_w	:= null;
	end if;

	if (nr_seq_deducao_conv_dest_w IS NOT NULL AND nr_seq_deducao_conv_dest_w::text <> '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_deducao_conv_dest_w
		from	conta_pac_deducao_conv a
		where	a.nr_seq_conta_des = nr_seq_conta_des_w
		and	a.ie_tipo_calculo = r_c_deducao.ie_tipo_calculo;
	else
		nr_seq_deducao_conv_dest_w	:= null;
	end if;

	if (coalesce(nr_seq_deducao_conv_orig_w::text, '') = '') and (coalesce(nr_seq_deducao_conv_dest_w::text, '') = '') then

		if (ie_cancel_conta_orig_p = 'S') and (nr_seq_conta_des_w IS NOT NULL AND nr_seq_conta_des_w::text <> '') then
			select	max(b.nr_seq_conta_orig)
			into STRICT	nr_seq_conta_ded_original_w
			from	conta_pac_deducao_conv b
			where	b.ie_tipo_calculo = r_c_deducao.ie_tipo_calculo
			and	b.nr_seq_conta_des = nr_interno_conta_cancel_p;
			
			if (nr_seq_conta_ded_original_w IS NOT NULL AND nr_seq_conta_ded_original_w::text <> '') then
				select	max(b.nr_sequencia)
				into STRICT	nr_seq_deducao_estorno_w
				from	conta_pac_deducao_conv b,
					conta_paciente a
				where	b.nr_seq_conta_orig = a.nr_interno_conta
				and	b.ie_tipo_calculo = r_c_deducao.ie_tipo_calculo
				and	a.nr_seq_conta_origem = nr_seq_conta_ded_original_w;
				
				if (nr_seq_deducao_estorno_w IS NOT NULL AND nr_seq_deducao_estorno_w::text <> '') then
					update	conta_pac_deducao_conv
					set	nr_seq_conta_des = nr_seq_conta_des_w
					where	nr_sequencia	= nr_seq_deducao_estorno_w;
					
					nr_seq_deducao_conv_w	:= nr_seq_deducao_estorno_w;
				end if;
			end if;
		elsif (r_c_deducao.ie_tipo = 'O') then
			select	nextval('conta_pac_deducao_conv_seq')
			into STRICT	nr_seq_deducao_conv_w
			;

			insert into conta_pac_deducao_conv(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conta_orig,
				nr_seq_conta_des,
				ie_tipo_calculo,
				pr_informado_calculo,
				vl_informado_calculo,
				vl_informado_desconto,
				vl_informado_base_conta,
				vl_informado_maximo,
				vl_calculado,
				dt_processamento,
				vl_calculado_com_imp,
				vl_calculado_sem_imp
				)
			SELECT	nr_seq_deducao_conv_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conta_orig_w,
				nr_seq_conta_des_w,
				ie_tipo_calculo,
				pr_informado_calculo * qt_acao_p,
				vl_informado_calculo * qt_acao_p,
				vl_informado_desconto * qt_acao_p,
				vl_informado_base_conta * qt_acao_p,
				vl_informado_maximo * qt_acao_p,
				vl_calculado * qt_acao_p,
				dt_processamento,
				vl_calculado_com_imp * qt_acao_p,
				vl_calculado_sem_imp * qt_acao_p
			from	conta_pac_deducao_conv a
			where	a.nr_sequencia	= r_c_deducao.nr_sequencia;
		end if;
	else
		nr_seq_deducao_conv_w	:= coalesce(nr_seq_deducao_conv_orig_w,nr_seq_deducao_conv_dest_w);
	end if;
		
	if (nr_seq_propaci_orig_p IS NOT NULL AND nr_seq_propaci_orig_p::text <> '') or (nr_seq_propaci_dest_p IS NOT NULL AND nr_seq_propaci_dest_p::text <> '') then
		if (ie_cancel_conta_orig_p = 'S') and (nr_seq_conta_des_w IS NOT NULL AND nr_seq_conta_des_w::text <> '') then
			
			select	max(b.nr_seq_propaci_origem)
			into STRICT	nr_seq_proc_ded_orig_w
			from	conta_pac_ded_conv_item b
			where	b.nr_seq_propaci_dest = nr_seq_propaci_cancel_p
			and	b.nr_seq_deducao_conv	= r_c_deducao.nr_sequencia;
			
			if (nr_seq_proc_ded_orig_w IS NOT NULL AND nr_seq_proc_ded_orig_w::text <> '') then
				select	max(b.nr_sequencia)
				into STRICT	nr_seq_ded_item_orig_w
				from	conta_pac_ded_conv_item b,
					procedimento_paciente a,
					conta_pac_deducao_conv c
				where	a.nr_sequencia = b.nr_seq_propaci_origem
				and	b.nr_seq_deducao_conv	= c.nr_sequencia
				and	c.nr_seq_conta_des	= nr_seq_conta_des_w
				and	c.ie_tipo_calculo	= r_c_deducao.ie_tipo_calculo
				and	a.nr_seq_proc_est 	= nr_seq_proc_ded_orig_w;
			
				if (nr_seq_ded_item_orig_w IS NOT NULL AND nr_seq_ded_item_orig_w::text <> '') then
					update	conta_pac_ded_conv_item
					set	nr_seq_propaci_dest	= nr_seq_propaci_dest_p
					where	nr_sequencia	= nr_seq_ded_item_orig_w;
				end if;
			end if;
		elsif (nr_seq_deducao_conv_w IS NOT NULL AND nr_seq_deducao_conv_w::text <> '') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_valor_proc_w
			from	proc_paciente_valor
			where	nr_seq_procedimento = nr_seq_propaci_orig_p
			and	ie_tipo_valor in (94,95);
			
			select	nextval('conta_pac_ded_conv_item_seq')
			into STRICT	nr_seq_ded_conv_item_w
			;
			
			insert into conta_pac_ded_conv_item(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_deducao_conv,
				nr_seq_propaci_origem,
				nr_seq_matpaci_origem,
				nr_seq_propaci_dest,
				nr_seq_matpaci_dest,
				vl_rateio,
				nr_seq_propaci_valor_ant,
				nr_seq_mat_atend_pac_valor,
				nr_lote_contabil,
				vl_rateio_com_imp,
				vl_rateio_sem_imp)
			SELECT	nr_seq_ded_conv_item_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_deducao_conv_w,
				nr_seq_propaci_orig_p,
				nr_seq_matpaci_orig_p,
				nr_seq_propaci_dest_p,
				nr_seq_matpaci_dest_p,
				vl_rateio * qt_acao_p,
				nr_seq_valor_proc_w,
				null,
				0,
				vl_rateio_com_imp * qt_acao_p,
				vl_rateio_sem_imp * qt_acao_p
			from	conta_pac_ded_conv_item
			where	nr_seq_propaci_origem	= nr_seq_propaci_cancel_p
			and	nr_seq_deducao_conv	= r_c_deducao.nr_sequencia;
		end if;
	end if;

	if (nr_seq_matpaci_orig_p IS NOT NULL AND nr_seq_matpaci_orig_p::text <> '') or (nr_seq_matpaci_dest_p IS NOT NULL AND nr_seq_matpaci_dest_p::text <> '') then
		if (ie_cancel_conta_orig_p = 'S') and (nr_seq_conta_des_w IS NOT NULL AND nr_seq_conta_des_w::text <> '') then
			
			select	max(b.nr_seq_matpaci_origem)
			into STRICT	nr_seq_mat_ded_orig_w
			from	conta_pac_ded_conv_item b
			where	b.nr_seq_matpaci_dest = nr_seq_matpaci_cancel_p
			and	b.nr_seq_deducao_conv	= r_c_deducao.nr_sequencia;
			
			if (nr_seq_mat_ded_orig_w IS NOT NULL AND nr_seq_mat_ded_orig_w::text <> '') then
				
				select	max(b.nr_sequencia)
				into STRICT	nr_seq_ded_item_orig_w
				from	conta_pac_ded_conv_item b,
					material_atend_paciente a,
					conta_pac_deducao_conv c
				where	a.nr_sequencia = b.nr_seq_matpaci_origem
				and	b.nr_seq_deducao_conv	= c.nr_sequencia
				and	c.nr_seq_conta_des	= nr_seq_conta_des_w
				and	c.ie_tipo_calculo	= r_c_deducao.ie_tipo_calculo
				and	a.nr_seq_mat_est	= nr_seq_mat_ded_orig_w;
			
				if (nr_seq_ded_item_orig_w IS NOT NULL AND nr_seq_ded_item_orig_w::text <> '') then
					update	conta_pac_ded_conv_item
					set	nr_seq_matpaci_dest	= nr_seq_matpaci_dest_p
					where	nr_sequencia	= nr_seq_ded_item_orig_w;
				end if;
			end if;
		elsif (nr_seq_deducao_conv_w IS NOT NULL AND nr_seq_deducao_conv_w::text <> '') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_valor_mat_w
			from	mat_atend_paciente_valor
			where	nr_seq_material = nr_seq_matpaci_orig_p
			and	ie_tipo_valor in (94,95);
			
			select	nextval('conta_pac_ded_conv_item_seq')
			into STRICT	nr_seq_ded_conv_item_w
			;
			
			insert into conta_pac_ded_conv_item(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_deducao_conv,
				nr_seq_propaci_origem,
				nr_seq_matpaci_origem,
				nr_seq_propaci_dest,
				nr_seq_matpaci_dest,
				vl_rateio,
				nr_seq_propaci_valor_ant,
				nr_seq_mat_atend_pac_valor,
				nr_lote_contabil,
				vl_rateio_com_imp,
				vl_rateio_sem_imp)
			SELECT	nr_seq_ded_conv_item_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_deducao_conv_w,
				nr_seq_propaci_orig_p,
				nr_seq_matpaci_orig_p,
				nr_seq_propaci_dest_p,
				nr_seq_matpaci_dest_p,
				vl_rateio * -1,
				null,
				nr_seq_valor_mat_w,
				0,
				vl_rateio_com_imp * -1,
				vl_rateio_sem_imp * -1
			from	conta_pac_ded_conv_item
			where	nr_seq_matpaci_origem	= nr_seq_matpaci_cancel_p
			and	nr_seq_deducao_conv	= r_c_deducao.nr_sequencia;
		end if;
	end if;
end loop;

/* sem commit */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_conta_ded_conv ( nr_interno_conta_cancel_p bigint, nr_seq_propaci_cancel_p bigint, nr_seq_matpaci_cancel_p bigint, nr_seq_propaci_orig_p bigint, nr_seq_matpaci_orig_p bigint, nr_seq_propaci_dest_p bigint, nr_seq_matpaci_dest_p bigint, qt_acao_p bigint, ie_cancel_conta_orig_p text, nm_usuario_p text) FROM PUBLIC;

