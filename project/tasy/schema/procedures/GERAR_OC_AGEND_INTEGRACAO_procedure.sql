-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_agend_integracao ( nr_cot_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_desfaz_agrupamento_w		varchar(10);			
cd_estabelecimento_w		integer;
cd_estabelecimento_w2		integer;
cd_estabelecimento_ww		integer;
cd_material_w			integer		:= 0;
nr_item_cot_compra_w		integer		:= 0;
nr_ordem_compra_w		bigint	:= 0;
nr_seq_fornecedor_w		bigint	:= 0;
nr_seq_fornecedor_w2		bigint	:= 0;
qt_conv_unid_fornec_w		double precision;
qt_material_w			double precision	:= 0;
vl_unitario_w			double precision	:= 0;
pr_desconto_w			double precision	:= 0;
vl_desconto_w			double precision	:= 0;
cd_unidade_w			varchar(30)	:= '0';
ds_material_direto_w		varchar(255)	:= '0';
ds_observacao_w			varchar(255)	:= '0';
ds_marca_w			varchar(30)	:= '';
ds_marca2_w			varchar(30)	:= '';
ie_situacao_w			varchar(1)	:= '0';
dt_entrega_w			timestamp;
dt_validade_w			timestamp;
dt_aprovacao_ordem_w		timestamp;
ie_ajusta_unid_fornec_w		varchar(1)	:= 'S';
ie_gerado_bionexo_w		varchar(1);
ie_liberar_ordem_cotacao_w		varchar(1);
cd_cgc_fornecedor_w		varchar(14);
nr_contrato_w			bigint;
cd_centro_custo_w			bigint;
cd_centro_custo_w2		bigint;
dt_entrega_ww			timestamp;
ie_forma_calc_entrega_w		varchar(1);
nr_solic_compra_w			bigint;
nr_solic_compra_w2		bigint;
ie_liberar_ordem_calc_cot_w		varchar(1);
ie_gerar_oc_itens_confirm_w	varchar(1);
nr_documento_externo_w		varchar(10);
nr_cot_compra_w			cot_compra.nr_cot_compra%type;
nr_solic_compra_ww		solic_compra.nr_solic_compra%type;
nr_seq_motivo_solic_w		solic_compra.nr_solic_compra%type := 0;


c01 CURSOR FOR
SELECT	null cd_centro_custo,
	c.cd_estabelecimento,
	c.nr_seq_fornecedor,
	c.nr_item_cot_compra,
	null nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.qt_material,
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato
from	cot_compra_forn_item_tr_v c
where	c.nr_cot_compra		= nr_cot_compra_p
and	c.nr_seq_item_fornec	= obter_venc_cot_fornec_item(c.nr_cot_compra, c.nr_item_cot_compra)
and (substr(obter_se_material_ativo(c.cd_material),1,1) = 'A')
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'N')
and	coalesce(nr_ordem_compra,0) = 0

union

SELECT	null cd_centro_custo,
	c.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	null nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.qt_material,
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato
from	cot_compra_resumo_v c
where	c.nr_cot_compra      	= nr_cot_compra_p
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
and	ie_desfaz_agrupamento_w	 = 'S'
and	coalesce(nr_ordem_compra,0) = 0
and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(nr_id_integracao::text, '') = '')) or
	((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (cd_cgc_fornecedor_venc_alt IS NOT NULL AND cd_cgc_fornecedor_venc_alt::text <> '')))

union all

select	null cd_centro_custo,
	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	null nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	sum(c.qt_material),
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato
from	cot_compra a,
	cot_compra_resumo_v c
where	c.nr_cot_compra      = nr_cot_compra_p
and	c.nr_cot_compra      = a.nr_cot_compra
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
and	ie_desfaz_agrupamento_w = 'N'
and	coalesce(nr_ordem_compra,0) = 0
and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(nr_id_integracao::text, '') = '')) or
	((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (cd_cgc_fornecedor_venc_alt IS NOT NULL AND cd_cgc_fornecedor_venc_alt::text <> '')))
group by
	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.ds_observacao,
	coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
	CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato

union all

select	null cd_centro_custo,
	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	sum(c.qt_material),
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato
from	cot_compra a,
	cot_compra_resumo_v c
where	c.nr_cot_compra      = nr_cot_compra_p
and	c.nr_cot_compra      = a.nr_cot_compra
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
and	ie_desfaz_agrupamento_w = 'SC'
and	coalesce(nr_ordem_compra,0) = 0
and	(((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(c.nr_id_integracao::text, '') = '')) or
	((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (c.cd_cgc_fornecedor_venc_alt IS NOT NULL AND c.cd_cgc_fornecedor_venc_alt::text <> '')))
group by
	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.ds_observacao,
	coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
	CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato

union all

select	obter_dados_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra),7) cd_centro_custo,
	obter_estab_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra)) cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	null nr_solic_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	sum(c.qt_material),
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato		
FROM cot_compra_resumo_v c, cot_compra_item b
LEFT OUTER JOIN cot_compra_solic_agrup a ON (b.nr_cot_compra = a.nr_cot_compra AND b.nr_item_cot_compra = a.nr_item_cot_compra)
WHERE c.nr_cot_compra 		= b.nr_cot_compra and c.nr_item_cot_compra 	= b.nr_item_cot_compra   and c.nr_cot_compra      	= nr_cot_compra_p and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S') and ie_desfaz_agrupamento_w = 'C' and coalesce(c.nr_ordem_compra,0) = 0 and (((ie_gerar_oc_itens_confirm_w = 'N') or (coalesce(nr_documento_externo_w::text, '') = '') or (coalesce(c.nr_id_integracao::text, '') = '')) or
	((ie_gerar_oc_itens_confirm_w = 'S') and (nr_documento_externo_w IS NOT NULL AND nr_documento_externo_w::text <> '') and (c.cd_cgc_fornecedor_venc_alt IS NOT NULL AND c.cd_cgc_fornecedor_venc_alt::text <> ''))) group by
	obter_dados_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra),7),
	obter_estab_solic_compra(coalesce(a.nr_solic_compra,b.nr_solic_compra)),
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.ds_observacao,
	coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
	CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0),
	c.cd_cgc_fornecedor,
	c.nr_contrato
order by
	cd_centro_custo,
	cd_estabelecimento,
	nr_solic_compra,
	cd_cgc_fornecedor,
	dt_limite_entrega,
	nr_item_cot_compra;
	
c02 CURSOR FOR
SELECT	distinct nr_ordem_compra
from	ordem_compra_item
where	nr_cot_compra = nr_cot_compra_p;

c07 CURSOR FOR
SELECT	nr_solic_compra
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_w
and	(nr_solic_compra IS NOT NULL AND nr_solic_compra::text <> '')
order by nr_item_oci asc;
	

BEGIN

select 	max(cd_estabelecimento),
	max(nr_documento_externo)
into STRICT	cd_estabelecimento_ww,
	nr_documento_externo_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;
	
select	substr(coalesce(obter_valor_param_usuario(915, 67, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_ww),'L'),1,1),
	substr(coalesce(obter_valor_param_usuario(915, 9, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_ww),'N'),1,1)
into STRICT	ie_forma_calc_entrega_w,
	ie_desfaz_agrupamento_w
;	
	
select	coalesce(max(ie_ajusta_unid_fornec),'N'),
	coalesce(max(ie_liberar_ordem_cotacao),'N'),
	coalesce(max(ie_liberar_ordem_calc_cot),'N'),
	coalesce(max(ie_gerar_oc_itens_confirm),'N')
into STRICT	ie_ajusta_unid_fornec_w,
	ie_liberar_ordem_cotacao_w,
	ie_liberar_ordem_calc_cot_w,
	ie_gerar_oc_itens_confirm_w
from	parametro_compras b,
	cot_compra a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_cot_compra		= nr_cot_compra_p;

select	nr_cot_compra
into STRICT	nr_cot_compra_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p
for update;

open c01;
loop
fetch c01
into	cd_centro_custo_w,
	cd_estabelecimento_w,
	nr_seq_fornecedor_w,
	nr_item_cot_compra_w,
	nr_solic_compra_w,
	cd_material_w,
	cd_unidade_w,
	ie_situacao_w,
	qt_material_w,
	ds_observacao_w,
	ds_marca_w,
	ds_marca2_w,
	dt_entrega_w,
	vl_unitario_w,
	pr_desconto_w,
	qt_conv_unid_fornec_w,
	dt_validade_w,
	vl_desconto_w,
	cd_cgc_fornecedor_w,
	nr_contrato_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/*ie_desfaz_agrupamento_w
	A opcao com SC nao existe no dominio porque eh uma opcao fixa que eh passada no programa.
	Na cotacao existe o parametro 105 para permitir desdobrar por solicitacao, e existe mais uma opcao (MD) no programa.
	Desta forma pode estar parametrizado de uma forma, mas em determinada situacao desdobrar pela solicitacao.
	*/
	if	((nr_seq_fornecedor_w2 <> nr_seq_fornecedor_w) or
		 ((ie_desfaz_agrupamento_w in ('S','N')) and (cd_estabelecimento_w2	<> cd_estabelecimento_w)) or
		 (ie_desfaz_agrupamento_w = 'SC' AND nr_solic_compra_w2 	<> nr_solic_compra_w) or
		 (ie_desfaz_agrupamento_w = 'C' AND cd_centro_custo_w2 	<> cd_centro_custo_w)) then

		nr_seq_fornecedor_w2 	:= nr_seq_fornecedor_w;
		cd_estabelecimento_w2	:= cd_estabelecimento_w;
		cd_centro_custo_w2	:= cd_centro_custo_w;
		nr_solic_compra_w2	:= nr_solic_compra_w;
					
		nr_ordem_compra_w := grava_ordem_compra(
			nr_cot_compra_p, cd_estabelecimento_w, nr_seq_fornecedor_w, nm_usuario_p, nr_ordem_compra_w);

		if (ie_forma_calc_entrega_w = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		elsif (ie_forma_calc_entrega_w = 'F') then		
			dt_entrega_ww	:= dt_entrega_w;
		else
			dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		end if;
			
		CALL grava_item_ordem_compra(
			nr_ordem_compra_w,
			cd_material_w,
			cd_unidade_w,
			vl_unitario_w,
			qt_material_w,
			ds_observacao_w,
			ds_marca_w,
			ds_marca2_w,
			nm_usuario_p,
			ie_situacao_w,
			dt_entrega_ww,
			pr_desconto_w,
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			nr_seq_fornecedor_w,
			qt_conv_unid_fornec_w,
			ie_ajusta_unid_fornec_w,
			dt_validade_w,
			ie_desfaz_agrupamento_w,
			coalesce(vl_desconto_w,0),
			nr_contrato_w,
			cd_centro_custo_w,
			null,
			null);
	else
		
		if (ie_forma_calc_entrega_w = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		elsif (ie_forma_calc_entrega_w = 'F') then		
			dt_entrega_ww	:= dt_entrega_w;		
		else
			dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p,nr_seq_fornecedor_w,'DE'), 0);
		end if;

		CALL grava_item_ordem_compra(
			nr_ordem_compra_w,
			cd_material_w,
			cd_unidade_w,
			vl_unitario_w,
			qt_material_w,
			ds_observacao_w,
			ds_marca_w,
			ds_marca2_w,
			nm_usuario_p,
			ie_situacao_w,
			dt_entrega_ww,
			pr_desconto_w,
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			nr_seq_fornecedor_w,
			qt_conv_unid_fornec_w,
			ie_ajusta_unid_fornec_w,
			dt_validade_w,
			ie_desfaz_agrupamento_w,
			coalesce(vl_desconto_w,0),
			nr_contrato_w,
			cd_centro_custo_w,
			null,
			null);
	end if;

	CALL gerar_ordem_compra_venc( nr_ordem_compra_w, nm_usuario_p);
	calcular_liquido_ordem_compra( nr_ordem_compra_w, nm_usuario_p);

end loop;
close c01;

open C02;
loop
fetch C02 into	
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	select	coalesce(max(ie_gerado_bionexo),'N')
	into STRICT	ie_gerado_bionexo_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p;

	/*Se eh de Bionexo, verifica o parametro especifico para Bionexo*/

	if (ie_gerado_bionexo_w in ('S','X')) and (ie_liberar_ordem_cotacao_w <> 'N') then		
		CALL liberar_cotacao_oc_importada(nr_cot_compra_p, nr_ordem_compra_w, ie_liberar_ordem_cotacao_w, 'N', nm_usuario_p);
	end if;
	/*Se nao eh de Bionexo, verifica o parametro especifico para geracao normal*/

	if (ie_gerado_bionexo_w = 'N') and (ie_liberar_ordem_calc_cot_w <> 'N') then		
		CALL liberar_cotacao_oc_importada(nr_cot_compra_p, nr_ordem_compra_w, ie_liberar_ordem_calc_cot_w, 'N', nm_usuario_p);
	end if;
	
	end;
end loop;
close C02;

open c07;
loop
fetch c07 into
	nr_solic_compra_ww;
EXIT WHEN NOT FOUND; /* apply on c07 */
	begin	
	select	coalesce(max(nr_seq_motivo_solic),0)
	into STRICT	nr_seq_motivo_solic_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_ww;
		
	if (nr_seq_motivo_solic_w > 0) then	
		update	ordem_compra
		set	nr_seq_motivo_solic	= nr_seq_motivo_solic_w
		where	nr_ordem_compra		= nr_ordem_compra_w;
	end if;
	end;
end loop;
close c07;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_agend_integracao ( nr_cot_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

