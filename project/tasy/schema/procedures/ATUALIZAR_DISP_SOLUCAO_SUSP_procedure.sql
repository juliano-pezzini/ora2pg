-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_disp_solucao_susp ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, ie_acao_p bigint, nm_usuario_p text, ie_erro_p INOUT text) AS $body$
DECLARE


nr_seq_processo_w	bigint;
ie_status_processo_w	varchar(15);
dt_cancelamento_w	timestamp;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (nr_etapa_p IS NOT NULL AND nr_etapa_p::text <> '') and (ie_acao_p IS NOT NULL AND ie_acao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	if (ie_acao_p in (12,15)) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_processo_w
		from	adep_processo
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_solucao	= nr_seq_solucao_p
		and	nr_etapa	= nr_etapa_p;

		if (nr_seq_processo_w > 0) then
			begin
			select	ie_status_processo,
				dt_cancelamento
			into STRICT	ie_status_processo_w,
				dt_cancelamento_w
			from	adep_processo
			where	nr_sequencia = nr_seq_processo_w;

			if (ie_status_processo_w not in ('G','D')) and (coalesce(dt_cancelamento_w::text, '') = '') then
				begin
				ie_erro_p	:= 'S';
				end;
			else
				begin
				update	adep_processo
				set	dt_cancelamento		= clock_timestamp(),
					nm_usuario_cancelamento	= nm_usuario_p
				where	nr_sequencia		= nr_seq_processo_w
				and	coalesce(dt_cancelamento::text, '') = ''
				and	coalesce(nm_usuario_cancelamento::text, '') = '';

				update	prescr_mat_hor
				set	dt_suspensao	= clock_timestamp(),
					nm_usuario_susp	= nm_usuario_p
				where	nr_prescricao	= nr_prescricao_p
				and	nr_seq_solucao	= nr_seq_solucao_p
				and	nr_etapa_sol	= nr_etapa_p
				and	nr_seq_processo	= nr_seq_processo_w
				and	coalesce(dt_suspensao::text, '') = ''
				and	coalesce(nm_usuario_susp::text, '') = '';

				update	ap_lote_item
				set	dt_supensao	= clock_timestamp(),
					nm_usuario_susp	= nm_usuario_p
				where	coalesce(dt_supensao::text, '') = ''
				and	coalesce(nm_usuario_susp::text, '') = ''
				and	nr_seq_mat_hor in (	SELECT	nr_sequencia
								from	prescr_mat_hor
								where	nr_prescricao	= nr_prescricao_p
								and	nr_seq_solucao	= nr_seq_solucao_p
								and	nr_etapa_sol	= nr_etapa_p
								and	nr_seq_processo	= nr_seq_processo_w
								and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
								and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> ''));
				end;
			end if;
			end;
		else
			begin
			update	prescr_mat_hor
			set	dt_suspensao	= clock_timestamp(),
				nm_usuario_susp	= nm_usuario_p
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_solucao_p
			and	nr_etapa_sol	= nr_etapa_p
			and	coalesce(dt_suspensao::text, '') = ''
			and	coalesce(nm_usuario_susp::text, '') = '';

			update	ap_lote_item
			set	dt_supensao	= clock_timestamp(),
				nm_usuario_susp	= nm_usuario_p
			where	coalesce(dt_supensao::text, '') = ''
			and	coalesce(nm_usuario_susp::text, '') = ''
			and	nr_seq_mat_hor in (	SELECT	nr_sequencia
							from	prescr_mat_hor
							where	nr_prescricao	= nr_prescricao_p
							and	nr_seq_solucao	= nr_seq_solucao_p
							and	nr_etapa_sol	= nr_etapa_p
							and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
							and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> ''));
			end;
		end if;
		end;
	elsif (ie_acao_p = 6) then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_processo_w
		from	adep_processo
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_solucao	= nr_seq_solucao_p
		and	nr_etapa	= nr_etapa_p;

		if (nr_seq_processo_w > 0) then
			begin
			update	adep_processo
			set	dt_cancelamento		 = NULL,
				nm_usuario_cancelamento	 = NULL
			where	nr_sequencia		= nr_seq_processo_w
			and	(dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '')
			and	(nm_usuario_cancelamento IS NOT NULL AND nm_usuario_cancelamento::text <> '');

			update	prescr_mat_hor
			set	dt_suspensao	 = NULL,
				nm_usuario_susp	 = NULL
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_solucao_p
			and	nr_etapa_sol	= nr_etapa_p
			and	nr_seq_processo	= nr_seq_processo_w
			and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '');

			update	ap_lote_item
			set	dt_supensao	 = NULL,
				nm_usuario_susp	 = NULL
			where	(dt_supensao IS NOT NULL AND dt_supensao::text <> '')
			and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '')
			and	nr_seq_mat_hor in (	SELECT	nr_sequencia
							from	prescr_mat_hor
							where	nr_prescricao	= nr_prescricao_p
							and	nr_seq_solucao	= nr_seq_solucao_p
							and	nr_etapa_sol	= nr_etapa_p
							and	nr_seq_processo	= nr_seq_processo_w
							and	coalesce(dt_suspensao::text, '') = ''
							and	coalesce(nm_usuario_susp::text, '') = ''
							and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S');
			end;
		else
			begin
			update	prescr_mat_hor
			set	dt_suspensao	 = NULL,
				nm_usuario_susp	 = NULL
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_solucao	= nr_seq_solucao_p
			and	nr_etapa_sol	= nr_etapa_p
			and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '');

			update	ap_lote_item
			set	dt_supensao	 = NULL,
				nm_usuario_susp	 = NULL
			where	(dt_supensao IS NOT NULL AND dt_supensao::text <> '')
			and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '')
			and	nr_seq_mat_hor in (	SELECT	nr_sequencia
							from	prescr_mat_hor
							where	nr_prescricao	= nr_prescricao_p
							and	nr_seq_solucao	= nr_seq_solucao_p
							and	nr_etapa_sol	= nr_etapa_p
							and	coalesce(dt_suspensao::text, '') = ''
							and	coalesce(nm_usuario_susp::text, '') = ''
							and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S');
			end;
		end if;
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_disp_solucao_susp ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, ie_acao_p bigint, nm_usuario_p text, ie_erro_p INOUT text) FROM PUBLIC;

