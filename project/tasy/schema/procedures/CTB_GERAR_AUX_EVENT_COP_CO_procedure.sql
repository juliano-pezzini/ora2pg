-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_aux_event_cop_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type, ie_tipo_segurado_p pls_conta.ie_tipo_segurado%type, ie_tipo_protocolo_p pls_protocolo_conta.ie_tipo_protocolo%type, ie_gerar_ind_classif_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, ie_copartic_faturar_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type) AS $body$
DECLARE


nr_contador_w 				bigint := 0;
cd_conta_contabil_w			conta_contabil.cd_conta_contabil%type;
dt_pagamento_w				timestamp;
dt_vencimento_w				timestamp;
dt_contabil_w				timestamp;
nr_titulo_w				bigint;
nr_nota_fiscal_w			nota_fiscal.nr_nota_fiscal%type;
ie_tipo_relacao_w			pls_prestador.ie_tipo_relacao%type;
ds_erro_w				varchar(255);
ds_local_w				varchar(255);
arq_texto_w				utl_file.file_type;
nm_arquivo_w				varchar(255);
cd_classif_w				varchar(5) := '4.1.1';
dt_inicial_w				timestamp;
dt_final_w				timestamp;
ds_nome_livro_w				varchar(255);
ds_periodo_w				varchar(255);
ie_copartic_faturar_w			varchar(1);
nr_sequencia_w				w_ctb_livro_aux_event_liq.nr_sequencia%type;
ie_tipo_segurado_w			ctb_livro_auxiliar.ie_tipo_segurado%type;
ie_tipo_compartilhamento_w		pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w			pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w				pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w			pls_segurado_repasse.dt_fim_repasse%type;
ds_observacao_w				varchar(255);
ds_observacao_item_w			varchar(255);
ie_data_tipo_segurado_w			pls_parametros.ie_data_tipo_segurado%type;
dt_ref_repasse_w			pls_conta_proc.dt_procedimento%type;

c_linha CURSOR FOR
	SELECT	nr_documento										|| ';' ||
		nr_seq_protocolo									|| ';' ||
		ds_tipo_documento									|| ';' ||
		ds_tipo_protocolo									|| ';' ||
		coalesce(cd_procedimento,cd_material_ops)							|| ';' ||
		ds_item_mat_proc									|| ';' ||
		dt_ocorrencia										|| ';' ||
		dt_conhecimento										|| ';' ||
		cd_beneficiario										|| ';' ||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(nr_seq_segurado,
			dt_ocorrencia)),1,255)								|| ';' ||
		nm_usuario_evento									|| ';' ||
		ds_tipo_segurado									|| ';' ||
		nm_prestador										|| ';' ||
		nr_cpf_cnpj										|| ';' ||
		ie_tipo_operacao									|| ';' ||
		ds_grupo_ans										|| ';' ||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,
			nr_protocolo_ans),1,255)							|| ';' ||
		ds_tipo_vinculo_operadora								|| ';' ||
		ds_ato_cooperado									|| ';' ||
		ds_modalidade_contrat									|| ';' ||
		ds_tipo_regulamentacao									|| ';' ||
		ds_tipo_contratacao									|| ';' ||
		ds_segmentacao										|| ';' ||
		vl_coparticipacao									|| ';' ||
		vl_evento										|| ';' ||
		dt_contabilizacao									|| ';' ||
		nr_titulo										|| ';' ||
		cd_conta_contrapartida									|| ';' ||
		substr(ctb_obter_classif_conta(cd_conta_contrapartida, null, dt_final_w),1,255)		|| ';' ||
		cd_conta_contabil									|| ';' ||
		substr(ctb_obter_classif_conta(cd_conta_contabil, null, dt_final_w),1,255)		|| ';' ||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,
			nr_contrato),1,255)								|| ';' ||
		dt_emissao										|| ';' ||
		dt_pagamento										|| ';' ||
		dt_vencimento										|| ';' ||
		dt_ressarcimento									|| ';' ||
		nm_usuario_princ									|| ';' ||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,
			nr_cpf_cnpj_adic),1,255)							|| ';' ||
		substr(obter_valor_dominio(3579,ie_tipo_evento),1,255)					|| ';' ||
		substr(obter_valor_dominio(3384, ie_tipo_repasse), 1,255)				|| ';' ||
		substr(obter_valor_dominio(8980, ie_tipo_compartilhamento), 1,255)			|| ';' ||
		dt_inicio_compartilhamento								|| ';' ||
		dt_fim_compartilhamento									|| ';' ||
		ds_observacao ds_linha
	from	w_ctb_livro_aux_event_liq
	where	nr_seq_reg_auxiliar = nr_seq_regra_p
	order by (nr_documento)::numeric;

c_medica CURSOR FOR
	SELECT	w.nr_seq_copart_contab,
		c.nr_sequencia nr_documento,
		t.nr_sequencia nr_seq_contrato,
		t.nr_contrato,
		c.dt_emissao,
		s.dt_rescisao dt_rescisao,
		w.ie_ato_cooperado,
		p.ie_preco ie_modalidade_contrat,
		p.ie_regulamentacao ie_regulamentacao,
		p.ie_tipo_contratacao ie_tipo_contratacao,
		p.ie_segmentacao,
		substr(pls_obter_nomes_contrato(s.nr_seq_pagador,'P'),1,255) nm_usuario_princ,
		coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')) nr_cpf_cnpj_adic,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
		w.dt_ocorrencia,
		w.dt_conhecimento,
		substr(CASE WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='C' THEN  pls_obter_dados_prestador(w.nr_seq_prestador_pgto,'N') WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='I' THEN  pls_obter_nome_congenere(r.nr_seq_congenere) WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='R' THEN  obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc) END ,1,255) nm_prestador,
		substr(CASE WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='C' THEN  coalesce(pls_obter_dados_prestador(w.nr_seq_prestador_pgto,'CPF'),pls_obter_dados_prestador(w.nr_seq_prestador_pgto,'CGC')) WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='I' THEN  pls_obter_cnpj_congenere(r.nr_seq_congenere) WHEN coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo)='R' THEN  coalesce(Obter_Cpf_Pessoa_Fisica(c.cd_pessoa_fisica), c.cd_cgc) END ,1,255) nr_cpf_cnpj,
		substr(pls_obter_dados_protocolo(c.nr_seq_protocolo,'M'),1,20) dt_pagamento,
		r.nr_sequencia nr_seq_protocolo,
		r.ie_tipo_protocolo,
		w.cd_material_ops,
		w.cd_procedimento,
		w.ie_origem_proced,
		w.ds_item_mat_proc,
		(SELECT	max(cd_usuario_plano) from pls_segurado_carteira x where x.nr_seq_segurado = s.nr_sequencia) cd_beneficiario,
		'C' ie_tipo_operacao,
		w.ds_grupo_ans,
		substr(pls_obter_dados_prestador(w.nr_seq_prestador_pgto,'TR'),1,255) ds_tipo_vinculo_operadora,
		w.cd_conta_contrapartida,
		w.cd_conta_contabil,
		coalesce(w.vl_provisao, 0) vl_evento,
		coalesce(w.vl_coparticipacao, 0) vl_coparticipacao,
		s.nr_sequencia	nr_seq_segurado,
		w.nr_seq_prestador_pgto nr_seq_prestador,
		w.nr_seq_grupo_ans,
		w.nr_seq_copart nr_seq_coparticipacao,
		c.nr_sequencia nr_evento,
		CASE WHEN p.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(p.nr_protocolo_ans, p.cd_scpa) END  nr_protocolo_ans,
		c.ie_tipo_segurado,
		'CM' ie_tipo_documento,
		s.nr_seq_pagador,
		w.ie_tipo_grupo_ans,
		r.nr_seq_congenere
	FROM pls_protocolo_conta r, (
		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia between dt_inicial_w and dt_final_w
		and 	ie_copartic_faturar_w	= 'N' -- Nao e copart a faturar
		and	v.ie_copartic_faturar	= 'N'
		and 	ie_gerar_ind_classif_p	= 'S' -- Gerar independente classificacao
		
union all

		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia	< dt_final_w
		and	v.dt_mesano_referencia	> dt_final_w
		and 	ie_copartic_faturar_w	= 'S' -- Eh copart a faturar
		and	v.ie_copartic_faturar	= 'S'
		and	v.ie_mens_item_conta	= 'N'
		and 	ie_gerar_ind_classif_p	= 'S' -- Gerar independente classificacao
		
union all

		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao - (	select	coalesce(sum(ic.vl_item),0)
						from	pls_mensalidade_item_conta ic
						where	ic.nr_seq_conta_copartic	= v.nr_seq_copart
						and	ic.dt_atualizacao		< dt_final_w) vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia	< dt_final_w
		and 	ie_copartic_faturar_w	= 'S' -- Eh copart a faturar
		and	v.ie_copartic_faturar	= 'S'
		and	v.ie_mens_item_conta	= 'S'
		and 	ie_gerar_ind_classif_p	= 'S' -- Gerar independente classificacao
		
union all

		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia between dt_inicial_w and dt_final_w
		and 	ie_copartic_faturar_w	= 'N' -- Nao eh copart a faturar
		and	v.ie_copartic_faturar	= 'N'
		and 	ie_gerar_ind_classif_p	= 'N' -- Nao gerar independente classificacao
		and	v.cd_conta_cred_provisao in (	select 	cd_conta_contabil
							from	conta_contabil
							where	ie_tipo = 'A'
							and	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = cd_classif_w)
		
union all

		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia	< dt_final_w
		and	v.dt_mesano_referencia	> dt_final_w
		and 	ie_copartic_faturar_w	= 'S' -- Eh copart a faturar
		and	v.ie_copartic_faturar	= 'S'
		and	v.ie_mens_item_conta	= 'N'
		and 	ie_gerar_ind_classif_p	= 'N' -- Nao gerar independente classificacao
		and	v.cd_conta_cred_provisao in (	select 	cd_conta_contabil
							from	conta_contabil
							where	ie_tipo = 'A'
							and	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = cd_classif_w)
		
union all

		select	v.nr_seq_conta,
			v.nr_seq_conta_resumo,
			v.nr_seq_conta_proc,
			v.nr_seq_copart,
			v.nr_seq_copart_contab,
			v.nr_seq_mensalidade_seg,
			v.nr_seq_item_mens,
			v.nr_seq_mens_seg,
			v.nr_seq_mensalidade,
			v.nr_seq_lote_mens,
			v.dt_mes_competencia dt_conhecimento,
			v.nr_seq_prestador_pgto,
			v.ie_ato_cooperado,
			v.cd_conta_deb_provisao cd_conta_contrapartida,
			v.cd_conta_cred_provisao cd_conta_contabil,
			v.vl_coparticipacao - (	select	coalesce(sum(ic.vl_item),0)
						from	pls_mensalidade_item_conta ic
						where	ic.nr_seq_conta_copartic	= v.nr_seq_copart
						and	ic.dt_atualizacao		< dt_final_w) vl_coparticipacao,
			v.nr_seq_conta_proc_mat,
			v.dt_ocorrencia,
			v.cd_material_ops,
			v.cd_procedimento,
			v.ie_origem_proced,
			v.ds_item_mat_proc,
			v.nr_seq_grupo_ans,
			v.ds_grupo_ans,
			v.vl_provisao,
			v.ie_status_coparticipacao,
			v.dt_atualizacao,
			v.ie_tipo_grupo_ans
		from	pls_aux_event_cop_co_v	v
		where	v.dt_mes_competencia	< dt_final_w
		and 	ie_copartic_faturar_w	= 'S' -- Eh copart a faturar
		and	v.ie_copartic_faturar	= 'S'
		and	v.ie_mens_item_conta	= 'S'
		and 	ie_gerar_ind_classif_p	= 'N' -- Nao gerar independente classificacao
		and	v.cd_conta_cred_provisao in (	select 	cd_conta_contabil
							from	conta_contabil
							where	ie_tipo = 'A'
							and	substr(ctb_obter_classif_conta(cd_conta_contabil, cd_classificacao, dt_inicio_vigencia),1,5) = cd_classif_w)
		) w
LEFT OUTER JOIN pls_prestador d ON (w.nr_seq_prestador_pgto = d.nr_sequencia)
, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano p ON (c.nr_seq_plano = p.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE c.nr_sequencia		= w.nr_seq_conta    and w.nr_seq_conta_proc_mat	= c.nr_sequencia and c.nr_seq_protocolo	= r.nr_sequencia  and coalesce(ie_tipo_segurado_p,c.ie_tipo_segurado) = c.ie_tipo_segurado and coalesce(ie_tipo_protocolo_p,r.ie_tipo_protocolo) = r.ie_tipo_protocolo and r.ie_tipo_protocolo in ('C','I','R') and c.ie_status = 'F' and w.vl_coparticipacao		<> 0 and (w.ie_status_coparticipacao	in ('D','S')
	or (r.ie_tipo_protocolo		= 'R'
	and	w.ie_status_coparticipacao	<> 'N')) and coalesce(w.dt_atualizacao,dt_final_w) between dt_inicial_w and dt_final_w;

type		fetch_array2 is table of c_medica%ROWTYPE;
s_array2	fetch_array2;
	
nr_vetor_w			bigint	:= 0;
type registro is table of w_ctb_livro_aux_event_liq%RowType index by integer;
w_ctb_livro_aux_event_liq_w		registro;
	
BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

dt_inicial_w		:= trunc(dt_inicial_p,'dd');
dt_final_w		:= fim_dia(dt_final_p);
ie_copartic_faturar_w	:= coalesce(ie_copartic_faturar_p,'N');

select	max(ie_tipo_segurado)
into STRICT	ie_tipo_segurado_w
from	ctb_livro_auxiliar
where	nr_sequencia = nr_seq_regra_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

if (ie_gerar_arquivo_p = 'N') then

	open c_medica;
	loop
	fetch c_medica bulk collect into s_array2 limit 1000;
		for z in 1..s_array2.count loop
			begin
			nr_contador_w		:= nr_contador_w + 1;
			nr_vetor_w		:= nr_vetor_w + 1;
			
			if (ie_data_tipo_segurado_w = 'A') then
				dt_ref_repasse_w	:= s_array2[z].dt_ocorrencia;
			else
				dt_ref_repasse_w	:= s_array2[z].dt_conhecimento;
			end if;
			
			SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, s_array2[z].nr_seq_segurado, s_array2[z].nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

			select	nextval('w_ctb_livro_aux_event_liq_seq')
			into STRICT	nr_sequencia_w
			;
						
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_sequencia		:= nr_sequencia_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_atualizacao		:= clock_timestamp();
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nm_usuario		:= nm_usuario_p;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_atualizacao_nrec	:= clock_timestamp();
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nm_usuario_nrec		:= nm_usuario_p;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nm_prestador		:= s_array2[z].nm_prestador;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_cpf_cnpj		:= s_array2[z].nr_cpf_cnpj;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_documento		:= s_array2[z].nr_documento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_contrato		:= s_array2[z].nr_contrato;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_emissao		:= s_array2[z].dt_emissao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_rescisao		:= s_array2[z].dt_rescisao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nm_usuario_princ	:= s_array2[z].nm_usuario_princ;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_cpf_cnpj_adic	:= s_array2[z].nr_cpf_cnpj_adic;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nm_usuario_evento	:= s_array2[z].nm_usuario_evento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_ocorrencia		:= s_array2[z].dt_ocorrencia;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_conhecimento		:= s_array2[z].dt_conhecimento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_contabilizacao	:= s_array2[z].dt_conhecimento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_ressarcimento	:= s_array2[z].dt_conhecimento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_grupo_ans		:= s_array2[z].ds_grupo_ans;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].cd_material_ops		:= s_array2[z].cd_material_ops;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].cd_procedimento		:= s_array2[z].cd_procedimento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_origem_proced	:= s_array2[z].ie_origem_proced;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_item_mat_proc	:= s_array2[z].ds_item_mat_proc;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].cd_beneficiario		:= s_array2[z].cd_beneficiario;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_operacao	:= s_array2[z].ie_tipo_operacao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_relacao		:= ie_tipo_relacao_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_vinculo_operadora	:= s_array2[z].ds_tipo_vinculo_operadora;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_ato_cooperado	:= s_array2[z].ie_ato_cooperado;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_ato_cooperado	:= obter_valor_dominio(3418,s_array2[z].ie_ato_cooperado);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_preco		:= s_array2[z].ie_modalidade_contrat;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_modalidade_contrat	:= obter_valor_dominio(1669,s_array2[z].ie_modalidade_contrat);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_regulamentacao	:= s_array2[z].ie_regulamentacao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_regulamentacao	:= obter_valor_dominio(2157,s_array2[z].ie_regulamentacao);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_contratacao	:= s_array2[z].ie_tipo_contratacao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_contratacao	:= obter_valor_dominio(1666,s_array2[z].ie_tipo_contratacao);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_segmentacao		:= s_array2[z].ie_segmentacao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_segmentacao		:= obter_valor_dominio(1665,s_array2[z].ie_segmentacao);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].vl_evento		:= s_array2[z].vl_evento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].vl_coparticipacao	:= s_array2[z].vl_coparticipacao;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_livro		:= 5;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_referencia		:= dt_final_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].cd_conta_contrapartida	:= s_array2[z].cd_conta_contrapartida;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].cd_conta_contabil	:= s_array2[z].cd_conta_contabil;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_reg_auxiliar	:= nr_seq_regra_p;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_segurado		:= s_array2[z].nr_seq_segurado;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_prestador	:= s_array2[z].nr_seq_prestador;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_grupo_ans	:= s_array2[z].nr_seq_grupo_ans;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_linha		:= nr_contador_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_evento		:= s_array2[z].nr_evento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_protocolo_ans	:= s_array2[z].nr_protocolo_ans;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_protocolo	:= s_array2[z].ie_tipo_protocolo;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_protocolo	:= obter_valor_dominio(3648,s_array2[z].ie_tipo_protocolo);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_documento	:= s_array2[z].ie_tipo_documento;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_documento	:= obter_valor_dominio(8372,s_array2[z].ie_tipo_documento);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_segurado	:= s_array2[z].ie_tipo_segurado;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_tipo_segurado	:= obter_valor_dominio(2406,s_array2[z].ie_tipo_segurado);
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_protocolo	:= s_array2[z].nr_seq_protocolo;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].nr_seq_pagador		:= s_array2[z].nr_seq_pagador;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_evento		:= s_array2[z].ie_tipo_grupo_ans;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_compartilhamento := ie_tipo_compartilhamento_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].ie_tipo_repasse		:= ie_tipo_repasse_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_inicio_compartilhamento := dt_repasse_w;
			w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_fim_compartilhamento	:= dt_fim_repasse_w;

			SELECT * FROM pls_obter_titulos_copartic(	s_array2[z].nr_seq_copart_contab, w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_classif_pel, w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_vencimento, w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_pagamento) INTO STRICT w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_classif_pel, w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_vencimento, w_ctb_livro_aux_event_liq_w[nr_vetor_w].dt_pagamento;

			if (s_array2[z].ie_tipo_segurado in ('C','I','T')) then
				w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_observacao		:= ds_observacao_w;
			else	
				w_ctb_livro_aux_event_liq_w[nr_vetor_w].ds_observacao		:= null;
			end if;
			
			if (nr_vetor_w >= 1000) then
				forall m in w_ctb_livro_aux_event_liq_w.first..w_ctb_livro_aux_event_liq_w.last
					insert into w_ctb_livro_aux_event_liq values w_ctb_livro_aux_event_liq_w(m);
				
				nr_vetor_w	:= 0;
				w_ctb_livro_aux_event_liq_w.delete;
				
				commit;
			end if;
			
			end;
		end loop;
	
	EXIT WHEN NOT FOUND; /* apply on c_medica */
	end loop;
	close c_medica;
	
	if (w_ctb_livro_aux_event_liq_w.count > 0) then
		forall m in w_ctb_livro_aux_event_liq_w.first..w_ctb_livro_aux_event_liq_w.last
			insert into w_ctb_livro_aux_event_liq values w_ctb_livro_aux_event_liq_w(m);
		commit;
		w_ctb_livro_aux_event_liq_w.delete;
	end if;

	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_regra_p;

	commit;

end if;

if (ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxEventRessarcRecCoparticipacao' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= substr(obter_desc_expressao(776807), 1, 255);
	ds_periodo_w	:= substr(wheb_mensagem_pck.get_texto(1098702,'DT_INICIAL='|| dt_inicial_w ||';'||'DT_FINAL='|| dt_final_w ||';'||'DT_LIBERACAO='|| dt_liberacao_p), 1, 255);

	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);

	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, obter_desc_expressao(1030000)); --Cabecalho
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_aux_event_cop_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type, ie_tipo_segurado_p pls_conta.ie_tipo_segurado%type, ie_tipo_protocolo_p pls_protocolo_conta.ie_tipo_protocolo%type, ie_gerar_ind_classif_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, ie_copartic_faturar_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type) FROM PUBLIC;

