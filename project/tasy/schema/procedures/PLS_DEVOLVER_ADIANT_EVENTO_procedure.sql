-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_devolver_adiant_evento ( nr_seq_pag_item_p bigint, nr_adiant_pago_p bigint, vl_movimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_baixa_w		bigint;
nr_seq_lote_w		bigint;
nr_seq_adiant_dev_w	bigint;
cd_moeda_w		integer;
cd_tipo_baixa_enc_tit_w	integer;
cd_tipo_receb_enc_tit_w	integer;


BEGIN

select	max(a.nr_seq_lote)
into STRICT	nr_seq_lote_w
from	pls_pagamento_item b,
	pls_pagamento_prestador a
where	a.nr_sequencia = b.nr_seq_pagamento
and	b.nr_sequencia = nr_seq_pag_item_p;

select	max(cd_moeda)
into STRICT	cd_moeda_w
from	adiantamento_pago
where	nr_adiantamento = nr_adiant_pago_p;

select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_seq_adiant_dev_w
from	adiant_pago_dev;

insert into adiant_pago_dev(nr_adiantamento,
	nr_sequencia,
	dt_devolucao,
	vl_devolucao,
	cd_moeda,
	dt_atualizacao,
	nm_usuario,
	ds_motivo_dev)
values (nr_adiant_pago_p,
	nr_seq_adiant_dev_w,
	clock_timestamp(),
	vl_movimento_p,
	cd_moeda_w,
	clock_timestamp(),
	nm_usuario_p,
	'Devolução gerada através do lote de pagamento de produção médica, '|| nr_seq_lote_w ||'.');

CALL atualizar_saldo_adiant_pago(nr_adiant_pago_p, nm_usuario_p);

/* Não pode ter commit */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_devolver_adiant_evento ( nr_seq_pag_item_p bigint, nr_adiant_pago_p bigint, vl_movimento_p bigint, nm_usuario_p text) FROM PUBLIC;

