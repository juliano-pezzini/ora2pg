-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_enc_os_nec_rev_migr () AS $body$
DECLARE


nr_seq_os_migr_w	bigint;
nr_seq_os_des_w		bigint;
nr_seq_complex_w	bigint;
qt_min_prev_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_origem,
	b.nr_seq_complex,
	c.qt_min_prev
from	w_migracao_ordem_servico w,
	man_ordem_servico_exec c,
	man_ordem_servico b,
	man_ordem_servico a
where 	a.nr_sequencia in (
		263962,265314,264875,265298,265299,265300,265301,265302,265303,265304,
		265305,265306,265307,265308,265309,265310,265311,265312,265313,264867)
and	w.nr_seq_os = c.nr_seq_ordem
and	w.nm_usuario_nrec = c.nm_usuario_exec
and	exists (
		SELECT	1
		from	man_ordem_serv_estagio x
		where	x.nr_seq_estagio = 2
		and	x.nr_seq_ordem = w.nr_seq_os
		and	x.nm_usuario = w.nm_usuario_nrec)
and	c.nr_seq_ordem = b.nr_sequencia
and	b.nr_sequencia = a.nr_seq_origem
group by
	a.nr_sequencia,
	a.nr_seq_origem,
	b.nr_seq_complex,
	c.qt_min_prev
order by
	a.nr_seq_origem,
	a.nr_sequencia;


BEGIN
open c01;
loop
fetch c01 into 	nr_seq_os_migr_w,
		nr_seq_os_des_w,
		nr_seq_complex_w,
		qt_min_prev_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	update	man_ordem_servico
	set	nr_seq_complex = nr_seq_complex_w,
		nr_seq_estagio = 732
	where	nr_sequencia = nr_seq_os_migr_w;

	delete
	from	man_ordem_servico_exec a
	where	a.nr_seq_ordem = nr_seq_os_migr_w
	and	a.nm_usuario_exec = 'Rafael'
	and	a.nr_seq_tipo_exec = 1
	and	exists (
			SELECT	1
			from	man_ordem_servico_exec x
			where	x.nr_seq_ordem = a.nr_seq_ordem
			and	x.nr_seq_tipo_exec = 5
			and	x.nm_usuario_exec <> 'Rafael');

	update	man_ordem_servico_exec
	set	qt_min_prev = 20,
		nr_seq_tipo_exec = 2
	where	nr_seq_ordem = nr_seq_os_migr_w
	and	nr_seq_tipo_exec = 5
	and	nm_usuario_exec <> 'Rafael';
	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_enc_os_nec_rev_migr () FROM PUBLIC;

