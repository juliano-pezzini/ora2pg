-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_arquivo_ecd ( nr_seq_controle_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dt_ref_final_w			timestamp;
dt_ref_inicial_w		timestamp;
dt_ano_w			timestamp;
qt_contador_w			bigint;
nr_seq_regra_sped_w		bigint;
cd_estabelecimento_w		integer;
cd_empresa_w			smallint;
qt_linha_w			bigint := 0;
nr_sequencia_w			bigint;
qt_linhas_w			bigint;
qt_total_w			bigint;
ds_arquivo_w			varchar(4000);
ds_arquivo_ww			varchar(4000);
ie_forma_escrituracao_w		varchar(15);
cd_registro_w			varchar(15);
sep_w				varchar(1)	:= '|';
ds_status_proc_longo_w		varchar(100);

cd_emp_controladora_w	empresa.cd_empresa%type;

c_registro CURSOR FOR
	SELECT	cd_registro
	from	ctb_regra_sped_registro
	where	nr_seq_regra_sped	= nr_seq_regra_sped_w
	and	ie_gerar		= 'S'
	order by nr_sequencia;


BEGIN
select	dt_ref_inicial,
	dt_ref_final,
	nr_seq_regra_sped,
	cd_estabelecimento,
	cd_empresa
into STRICT	dt_ref_inicial_w,
	dt_ref_final_w,
	nr_seq_regra_sped_w,
	cd_estabelecimento_w,
	cd_empresa_w
from	ctb_sped_controle
where	nr_sequencia	= nr_seq_controle_p;

cd_emp_controladora_w := coalesce(holding_pck.get_emp_controladora_grupo(NULL, cd_empresa_w),0);

select	coalesce(max(ie_forma_escrituracao),'G'),
	max(dt_ano)
into STRICT	ie_forma_escrituracao_w,
	dt_ano_w
from	ctb_regra_sped
where	nr_sequencia 	= nr_seq_regra_sped_w;
/*
if	(trunc(dt_ano_w,'yyyy') >= to_date('01/01/2014','dd/mm/yyyy')) then
	update	ctb_regra_sped
	set	cd_versao	= '3.0'
	where	nr_sequencia	= nr_seq_regra_sped_w
	and	cd_versao	<> '3.0';
end if;*/
select	count(*)
into STRICT	qt_total_w
from	ctb_regra_sped_registro
where	nr_seq_regra_sped	= nr_seq_regra_sped_w;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_sequencia_w
from	ctb_sped_registro;

delete	FROM ctb_sped_registro
where	nr_seq_controle_sped	= nr_seq_controle_p;

commit;

qt_contador_w		:= 0;

/*ds_status_proc_longo_w = Carregando informacoes */

ds_status_proc_longo_w	:= wheb_mensagem_pck.get_texto(299429);
CALL gravar_processo_longo(ds_status_proc_longo_w ,'CTB_GERAR_ARQUIVO_ECD',qt_contador_w);

/*ds_status_proc_longo_w = Carregando registros: */

ds_status_proc_longo_w	:= wheb_mensagem_pck.get_texto(299438);
ds_status_proc_longo_w	:= ds_status_proc_longo_w || ': ';

open c_registro;
loop
fetch c_registro into
	cd_registro_w;
EXIT WHEN NOT FOUND; /* apply on c_registro */
	begin
	
	nr_sequencia_w	:= nr_sequencia_w;
	qt_linha_w	:= qt_linha_w;
	qt_contador_w 	:= qt_contador_w + 1;
	
	CALL gravar_processo_longo(ds_status_proc_longo_w || cd_registro_w || ' ('|| qt_contador_w ||'/' ||qt_total_w ||')','CTB_GERAR_ARQUIVO_ECD',qt_contador_w);
	if (cd_registro_w = '0000') then
		SELECT * FROM ctb_gerar_interf_0000_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w in ('0001','I001','J001','9001') or ((cd_emp_controladora_w > 0) and (cd_emp_controladora_w = cd_empresa_w) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_registro_w = 'K001'))) then
		SELECT * FROM ctb_gerar_reg_abertura_ecd(	nr_seq_controle_p, nm_usuario_p, sep_w, cd_registro_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = '0007') then
		SELECT * FROM ctb_gerar_interf_0007_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = '0020') then
		SELECT * FROM ctb_gerar_interf_0020_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = '0035') then
		SELECT * FROM ctb_gerar_interf_0035_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I010') then
		SELECT * FROM ctb_gerar_interf_I010_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I012') then
		SELECT * FROM ctb_gerar_interf_i012_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I030') then
		SELECT * FROM ctb_gerar_interf_I030_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I050') then
		SELECT * FROM ctb_gerar_interf_I050_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I075') then
		SELECT * FROM ctb_gerar_interf_I075_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I100') then
		ctb_gerar_interf_I100_ecd(	nr_seq_controle_p,
						nm_usuario_p,
						cd_estabelecimento_w,
						dt_ref_inicial_w,
						dt_ref_final_w,
						cd_empresa_w,
						qt_linha_w,
						nr_sequencia_w);
	elsif (cd_registro_w = 'I150') then
		SELECT * FROM ctb_gerar_interf_I150_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I200') then
        SELECT * FROM ctb_gerar_interf_I200_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I300') then
		SELECT * FROM ctb_gerar_interf_I300_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I350') then
		SELECT * FROM ctb_gerar_interf_I350_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'I500') then
		SELECT * FROM ctb_gerar_interf_I500_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J005') then
		SELECT * FROM ctb_gerar_interf_J005_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J100') then
		SELECT * FROM ctb_gerar_interf_J100_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J150') then
		SELECT * FROM ctb_gerar_interf_J150_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = ('J200')) then
		SELECT * FROM ctb_gerar_interf_J200_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w = ('J210')) then
		SELECT * FROM ctb_gerar_interf_J210_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J800') then
		SELECT * FROM ctb_gerar_interf_J800_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J900') then
		SELECT * FROM ctb_gerar_interf_J900_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J930') then
		SELECT * FROM ctb_gerar_interf_J930_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = 'J935') then
		SELECT * FROM ctb_gerar_interf_J935_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, sep_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif ((cd_registro_w = 'K030') and (cd_emp_controladora_w > 0) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_emp_controladora_w = cd_empresa_w)) then
		SELECT * FROM ctb_gerar_interf_K030_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif ((cd_registro_w = 'K100') and (cd_emp_controladora_w > 0) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_emp_controladora_w = cd_empresa_w)) then
		SELECT * FROM ctb_gerar_interf_K100_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif ((cd_registro_w = 'K200') and (cd_emp_controladora_w > 0) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_emp_controladora_w = cd_empresa_w)) then
		SELECT * FROM ctb_gerar_interf_K200_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif ((cd_registro_w = 'K300') and (cd_emp_controladora_w > 0) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_emp_controladora_w = cd_empresa_w)) then
		SELECT * FROM ctb_gerar_interf_K300_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif (cd_registro_w = '9900') then
		SELECT * FROM ctb_gerar_interf_9900_ecd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_w, dt_ref_inicial_w, dt_ref_final_w, cd_empresa_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	elsif	(cd_registro_w in ('9990','J990','I990','0990','9999') or ((cd_emp_controladora_w > 0) and (cd_emp_controladora_w = cd_empresa_w) and (to_char(dt_ref_final_w,'mm') = '12') and (cd_registro_w = 'K990'))) then
		SELECT * FROM ctb_gerar_reg_fim_bloco_ecd(	nr_seq_controle_p, nm_usuario_p, sep_w, cd_registro_w, qt_linha_w, nr_sequencia_w) INTO STRICT qt_linha_w, nr_sequencia_w;
	end if;
	end;
end loop;
close c_registro;

select	count(1)
into STRICT	qt_linhas_w
from	ctb_sped_registro
where	nr_seq_controle_sped	= nr_seq_controle_p;

begin
select	replace(ds_arquivo,'#QT_LINHAS',qt_linhas_w)
into STRICT	ds_arquivo_w
from	ctb_sped_registro
where	cd_registro		= 'I030'
and	nr_seq_controle_sped	= nr_seq_controle_p;

update	ctb_sped_registro
set	ds_arquivo = ds_arquivo_w
where	nr_seq_controle_sped	= nr_seq_controle_p
and	cd_registro		= 'I030';

commit;

exception when others then
	ds_arquivo_w	:= '';
end;

commit;

begin
select	replace(ds_arquivo,'#QT_LINHAS',qt_linhas_w)
into STRICT	ds_arquivo_ww
from	ctb_sped_registro
where	cd_registro		= 'J900'
and	nr_seq_controle_sped	= nr_seq_controle_p;
exception when others then
	ds_arquivo_ww	:= '';
end;

commit;

update	ctb_sped_registro
set	ds_arquivo = ds_arquivo_ww
where	nr_seq_controle_sped	= nr_seq_controle_p
and	cd_registro		= 'J900';

commit;

update	ctb_sped_controle
set	dt_geracao	=	clock_timestamp()
where	nr_sequencia	=	nr_seq_controle_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_arquivo_ecd ( nr_seq_controle_p bigint, nm_usuario_p text) FROM PUBLIC;

