-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_responsavel_etapa ( nr_seq_etapa_checkup_p text, nm_usuario_p text) AS $body$
DECLARE

 
ie_resp_permitido	bigint;
ds_etapa_w		varchar(255);
cd_pf_responsavel_w	varchar(20);
qt_reg_w			bigint;
					

BEGIN 
 
if (nr_seq_etapa_checkup_p IS NOT NULL AND nr_seq_etapa_checkup_p::text <> '') then 
	begin 
	 
	select 	count(*) 
	into STRICT	qt_reg_w 
	from 	etapa_checkup a, 
			etapa_checkup_lib b, 
			checkup_etapa c 
	where 	a.nr_sequencia 		= b.nr_seq_etapa 
	and  	a.nr_sequencia 		= c.nr_seq_etapa 
	and  	c.nr_sequencia 		= nr_seq_etapa_checkup_p;
	 
	if (qt_reg_w > 0) then 
	 
		cd_pf_responsavel_w := 	Obter_Dados_Usuario_Opcao( nm_usuario_p,'C');
 
		select 	coalesce(max(a.nr_sequencia),0) 
		into STRICT	ie_resp_permitido 
		from 	etapa_checkup a, 
			etapa_checkup_lib b, 
			checkup_etapa c 
		where 	a.nr_sequencia 		= b.nr_seq_etapa 
		and  	a.nr_sequencia 		= c.nr_seq_etapa 
		and  	c.nr_sequencia 		= nr_seq_etapa_checkup_p 
		and  	coalesce(b.cd_pessoa_fisica,cd_pf_responsavel_w) = cd_pf_responsavel_w 
		and  	coalesce(b.cd_perfil,Obter_perfil_Ativo) = Obter_perfil_Ativo;
 
		if (ie_resp_permitido = 0) then 
			begin 
			select 	coalesce(a.ds_etapa_abrev,a.ds_etapa) 
			into STRICT	ds_etapa_w 
			from 	etapa_checkup a, 
				checkup_etapa b 
			where	a.nr_sequencia = b.nr_seq_etapa 
			and	b.nr_sequencia = nr_seq_etapa_checkup_p;
			-- Você não tem permissão para alterar o status da etapa: '|| ds_etapa_w ||'#@#@ 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(264567,'DS_ETAPA_W=' || DS_ETAPA_W);
			end;
		end if;
	end if;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_responsavel_etapa ( nr_seq_etapa_checkup_p text, nm_usuario_p text) FROM PUBLIC;

