-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixa_titulo_receber_cob (cd_estabelecimento_p bigint, cd_tipo_recebimento_p bigint, nr_titulo_p bigint, nr_seq_trans_financ_p bigint, vl_baixa_p bigint, dt_recebimento_p timestamp, nm_usuario_p text, vl_glosa_p bigint, nr_bordero_p bigint, nr_seq_cobranca_p bigint, nr_seq_conta_banco_p bigint, vl_juros_p bigint) AS $body$
DECLARE

 
cd_moeda_padrao_w		integer	:= 0;
nr_seq_baixa_w			integer	:= 0;
nr_seq_conta_banco_w		bigint;
vl_juros_w			double precision	:= 0;
vl_desconto_w			double precision	:= 0;
vl_multa_w			double precision	:= 0;
cd_centro_custo_desc_w		bigint;
nr_seq_motivo_desc_w		bigint;
vl_rec_maior_w			double precision	:= 0;
ie_movto_bco_cobr_escrit_w	varchar(1);
dt_real_recebimento_w		titulo_receber_liq.dt_real_recebimento%type;


BEGIN 
 
nr_seq_conta_banco_w	:= nr_seq_conta_banco_p;
vl_juros_w		:= vl_juros_p;
	 
begin 
select	cd_moeda_padrao, 
	coalesce(ie_movto_bco_cobr_escrit,'N') 
into STRICT	cd_moeda_padrao_w, 
	ie_movto_bco_cobr_escrit_w 
from	parametro_contas_receber 
where	cd_estabelecimento	= cd_estabelecimento_p;
exception when no_data_found then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(181572);
end;
 
select	coalesce(max(nr_sequencia),0) + 1 
into STRICT	nr_seq_baixa_w 
from	titulo_receber_liq 
where	nr_titulo	= nr_titulo_p;
 
if (coalesce(nr_bordero_p,0) <> 0) then 
 
	select	coalesce(vl_juros,0), 
		coalesce(vl_desconto,0), 
		coalesce(vl_multa,0), 
		coalesce(vl_rec_maior,0), 
		cd_centro_custo_desc, 
		nr_seq_motivo_desc 
	into STRICT	vl_juros_w, 
		vl_desconto_w, 
		vl_multa_w, 
		vl_rec_maior_w, 
		cd_centro_custo_desc_w, 
		nr_seq_motivo_desc_w 
	from	bordero_tit_rec 
	where	nr_titulo	= nr_titulo_p 
	and	nr_bordero	= nr_bordero_p;
 
	begin 
	select	nr_seq_conta_banco, 
			max(dt_recebimento) 
	into STRICT	nr_seq_conta_banco_w, 
			dt_real_recebimento_w 
	from	bordero_recebimento 
	where	nr_bordero = nr_bordero_p;
	exception 
		when others then 
			nr_seq_conta_banco_w := null;
	end;
end if;
 
insert	into titulo_receber_liq(nr_titulo, 
	nr_sequencia, 
	dt_recebimento, 
	vl_recebido, 
	vl_descontos, 
	vl_juros, 
	vl_multa, 
	vl_rec_maior, 
	cd_moeda, 
	dt_atualizacao, 
	nm_usuario, 
	cd_tipo_recebimento, 
	ie_acao, 
	cd_serie_nf_devol, 
	nr_nota_fiscal_devol, 
	cd_banco, 
	cd_agencia_bancaria, 
	nr_documento, 
	nr_lote_banco, 
	cd_cgc_emp_cred, 
	nr_cartao_cred, 
	nr_adiantamento, 
	nr_lote_contabil, 
	nr_seq_trans_fin, 
	vl_glosa, 
	ie_lib_caixa, 
	nr_bordero, 
	nr_seq_conta_banco, 
	cd_centro_custo_desc, 
	nr_seq_motivo_desc, 
	NR_SEQ_COBRANCA, 
	nr_lote_contab_antecip, 
	nr_lote_contab_pro_rata, 
	dt_real_recebimento) 
values (nr_titulo_p, 
	nr_seq_baixa_w, 
	coalesce(dt_recebimento_p, trunc(clock_timestamp(),'dd')), 
	vl_baixa_p, 
	vl_desconto_w, 
	vl_juros_w, 
	vl_multa_w, 
	vl_rec_maior_w, 
	cd_moeda_padrao_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_tipo_recebimento_p, 
	'I', 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	null, 
	0, 
	nr_seq_trans_financ_p, 
	coalesce(vl_glosa_p,0), 
	'S', 
	nr_bordero_p, 
	nr_seq_conta_banco_w, 
	cd_centro_custo_desc_w, 
	nr_seq_motivo_desc_w, 
	NR_SEQ_COBRANCA_p, 
	0, 
	0, 
	dt_real_recebimento_w);
 
CALL Atualizar_Saldo_Tit_Rec(nr_titulo_p, nm_usuario_p);
 
if (ie_movto_bco_cobr_escrit_w = 'S') then 
	CALL gerar_movto_tit_baixa(nr_titulo_p,nr_seq_baixa_w,'R',nm_usuario_p,'N');
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixa_titulo_receber_cob (cd_estabelecimento_p bigint, cd_tipo_recebimento_p bigint, nr_titulo_p bigint, nr_seq_trans_financ_p bigint, vl_baixa_p bigint, dt_recebimento_p timestamp, nm_usuario_p text, vl_glosa_p bigint, nr_bordero_p bigint, nr_seq_cobranca_p bigint, nr_seq_conta_banco_p bigint, vl_juros_p bigint) FROM PUBLIC;

