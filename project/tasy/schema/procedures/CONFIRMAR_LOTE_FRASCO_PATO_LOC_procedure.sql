-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirmar_lote_frasco_pato_loc ( nm_usuario_p text, ie_itens_p text, cd_pessoa_recebimento_p text, ds_dados_entrega_p text) AS $body$
DECLARE



nr_seq_lote_w			bigint;


C01 CURSOR FOR
SELECT	b.nr_sequencia
from	pato_lote_rastreabilidade b
where  	obter_se_contido(b.nr_sequencia,ie_itens_p) = 'S'
order 	by 1;



BEGIN


open C01;
loop
fetch C01 into
	nr_seq_lote_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin


	update	pato_lote_rastreabilidade
	set	nm_usuario			=	nm_usuario_p,
		dt_atualizacao			=	clock_timestamp(),
		dt_recebimento			=	clock_timestamp(),
		cd_pessoa_recebimento		=	CASE WHEN cd_pessoa_recebimento_p='' THEN null  ELSE cd_pessoa_recebimento_p END ,
		ds_dados_entrega		=	ds_dados_entrega_p,
		nm_usuario_recebimento		=	nm_usuario_p
	where	nr_sequencia			=	nr_seq_lote_w;


	update	pato_lote_atend_rastreabi
	set	nm_usuario	=	nm_usuario_p,
		dt_atualizacao	=	clock_timestamp(),
		ie_status	=	'R'
	where	nr_seq_lote 	=	nr_seq_lote_w
	and	ie_status 	= 	'G';


	update	amost_lote_atend_rastreabi x
	set	x.nm_usuario		=	nm_usuario_p,
		x.dt_atualizacao	=	clock_timestamp(),
		x.ie_status		=	'R'
	where	exists (SELECT 1
			from	pato_lote_atend_rastreabi y
			where	y.nr_sequencia 	= x.nr_seq_lote_atend
			and	y.nr_seq_lote	= nr_seq_lote_w)
	and	ie_status 	= 	'G';



	insert into frasco_pato_loc_status(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_status,
		nr_seq_frasco_pato_loc,
		cd_setor_atendimento)
	SELECT	nextval('frasco_pato_loc_status_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		70,
		a.nr_seq_amostra,
		null
	from	amost_lote_atend_rastreabi a
	where	exists (SELECT 1
			from	pato_lote_atend_rastreabi y
			where	y.nr_sequencia 	= a.nr_seq_lote_atend
			and	y.nr_seq_lote	= nr_seq_lote_w
			and	ie_status 	= 	'R')
	and	ie_status 	= 	'R';


	update	frasco_pato_loc a
	set	a.ie_status 		= 	70,
		a.nm_usuario		=	nm_usuario_p,
		a.dt_atualizacao	=	clock_timestamp()
	where	exists (SELECT	1
			from 	amost_lote_atend_rastreabi x,
				pato_lote_atend_rastreabi y
			where	x.nr_seq_amostra 	= a.nr_sequencia
			and	x.nr_seq_lote_atend	= y.nr_sequencia
			and	y.nr_seq_lote		= nr_seq_lote_w
			and	x.ie_status		= 'R');


	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirmar_lote_frasco_pato_loc ( nm_usuario_p text, ie_itens_p text, cd_pessoa_recebimento_p text, ds_dados_entrega_p text) FROM PUBLIC;

