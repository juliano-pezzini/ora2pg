-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_proc_seq_lab ( nr_prescricao_p bigint, nm_usuario_p text, ie_origem_p text, nr_seq_prescr_p bigint default null) AS $body$
DECLARE


ie_gerar_sequencia_w	varchar(1);
cd_pessoa_fisica_w	varchar(10);
nr_seq_grupo_imp_w	bigint;
ie_regra_w		varchar(5);
ie_regra_ww		varchar(5);
cd_material_exame_w	varchar(20);
nr_seq_grupo_w		bigint;

nr_prescricao_w		bigint := 0;
dt_prescricao_w		timestamp;
nr_seq_lab_w		varchar(20);
nr_sequencia_w		bigint;
nr_seq_imp_w		bigint;
dt_prev_execucao_w	timestamp;
nr_seq_origem_w		integer;
nr_Seq_prescr_hor_w	integer;
cd_estabelecimento_w	smallint;
dt_prev_execucao_aux_w	timestamp;
dt_prev_execucao_aux2_w varchar(50);
ie_urgencia_w		varchar(1);

ie_regra_sequencia_w		varchar(2);
dt_sequencia_w			timestamp;
nr_seq_inicial_w		bigint;
nr_seq_lab_seq_grupo_imp_w	bigint;
nr_seq_grupo_imp_vig_w		bigint;

ie_gerar_padrao_amostra_w	varchar(1) := 'N';
nr_seq_grupo_exame_w		bigint;
nr_seq_tipo_peca_w		bigint;
nr_seq_lab_pato_w		varchar(20);
nr_seq_lab_aux_w		bigint;
qt_registros_aux_w		bigint;
cd_amostra_w			varchar(10);
nr_ano_atual_w			varchar(2);
nr_seq_inic_w			lab_grupo_impressao.nr_seq_inic%type;
cd_convenio_w			convenio.cd_convenio%type;
ie_agrupa_amostra_horario_w		varchar(1);
cd_funcao_origem_w		prescr_medica.cd_funcao_origem%type;
nr_seq_motivo_recoleta_w	prescr_procedimento.nr_seq_recoleta%type;







C01 CURSOR FOR
	SELECT	distinct
		a.cd_pessoa_fisica,
		coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp),
		d.ie_regra_sequencia,
		b.cd_material_exame,
		c.nr_seq_grupo,
		PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'hh',0),
		coalesce(nr_seq_origem,0),
		CASE WHEN coalesce(nr_seq_origem::text, '') = '' THEN null  ELSE b.nr_sequencia END ,
		a.cd_estabelecimento,
		b.dt_prev_execucao,
		coalesce(b.ie_urgencia,'N'),
		to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss'),
		b.nr_seq_recoleta
	from	lab_grupo_impressao d,
		exame_laboratorio c,
		prescr_procedimento b,
		prescr_medica a
	where 	a.nr_prescricao		= nr_prescricao_p
	  and 	a.nr_prescricao		= b.nr_prescricao
	  and 	b.nr_seq_exame 		= c.nr_seq_exame
	  and	((coalesce(nr_seq_prescr_p::text, '') = '') or (nr_seq_prescr_p = b.nr_sequencia))
	  and 	coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= d.nr_sequencia
	  and 	coalesce(b.nr_seq_lab::text, '') = ''
	  and 	(d.ie_regra_sequencia IS NOT NULL AND d.ie_regra_sequencia::text <> '')
	  and 	ie_gerar_sequencia_w	= ie_origem_p
	  and	((ie_gerar_padrao_amostra_w  <> 'S') or (coalesce(obter_amostra_peca_proced_pato(b.cd_procedimento, b.ie_origem_proced)::text, '') = ''))
	  and (ie_origem_p <> 'C' or (b.dt_coleta IS NOT NULL AND b.dt_coleta::text <> ''))
	  order by 10;

C02 CURSOR FOR
	SELECT  distinct
		c.nr_seq_grupo,
		obter_amostra_peca_proced_pato(a.cd_procedimento, a.ie_origem_proced),
		coalesce(lab_obter_grupo_imp_estab(b.cd_estabelecimento,a.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)
	from    exame_laboratorio c,
			prescr_procedimento a,
			prescr_medica b
	where   a.nr_seq_exame = c.nr_seq_exame
	and		coalesce(a.nr_seq_lab::text, '') = ''
	and		a.nr_prescricao = b.nr_prescricao
	and		a.nr_prescricao = nr_prescricao_p
	and		(obter_amostra_peca_proced_pato(a.cd_procedimento, a.ie_origem_proced) IS NOT NULL AND (obter_amostra_peca_proced_pato(a.cd_procedimento, a.ie_origem_proced))::text <> '')
	order by 1;


BEGIN

select	coalesce(max(ie_gerar_sequencia),'N'),
	coalesce(max(ie_gerar_padrao_amostra),'N'),
	coalesce(max(IE_AGRUPA_AMOSTRA_HORARIO),'N')
into STRICT	ie_gerar_sequencia_w,
	ie_gerar_padrao_amostra_w,
	ie_agrupa_amostra_horario_w
from	lab_parametro;

select  Obter_Convenio_Atendimento(max(nr_atendimento)),
		coalesce(max(cd_funcao_origem),924)
into STRICT	cd_convenio_w,
		cd_funcao_origem_w
from	prescr_medica a
where	a.nr_prescricao = nr_prescricao_p;

open C01;
loop
fetch C01 into
	cd_pessoa_fisica_w,
	nr_seq_grupo_imp_w,
	ie_regra_w,
	cd_material_exame_w,
	nr_seq_grupo_w,
	dt_prev_execucao_w,
	nr_seq_origem_w,
	nr_Seq_prescr_hor_w,
	cd_estabelecimento_w,
	dt_prev_execucao_aux_w,
	ie_urgencia_w,
	dt_prev_execucao_aux2_w,
	nr_seq_motivo_recoleta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	nr_seq_lab_w	:= '0';
	nr_prescricao_w	:= 0;

	if ((substr(ie_regra_w,1,1) = 'G') or (substr(ie_regra_w,2,1) = 'G')) then
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.nr_prescricao		= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and c.nr_seq_grupo		= nr_seq_grupo_w
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao		= nr_prescricao_p;
	elsif (substr(ie_regra_w,2,1) = 'M') then
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.nr_prescricao	= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and b.cd_material_exame	= cd_material_exame_w
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao	= nr_prescricao_p;
	elsif (substr(ie_regra_w,2,1) = 'P') then
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.nr_prescricao	= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and b.cd_material_exame	= cd_material_exame_w
		  and pkg_date_utils.get_time(b.dt_prev_execucao,0,0,0) 	= pkg_date_utils.get_time(dt_prev_execucao_w,0,0,0)
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao	= nr_prescricao_p;
	elsif (substr(ie_regra_w,2,1) = 'H') then
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.nr_prescricao	= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and b.cd_material_exame	= cd_material_exame_w
		  and ((PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'hh',0) 	= PKG_DATE_UTILS.start_of(dt_prev_execucao_w,'hh',0)) or (ie_urgencia_w = 'S' and b.ie_urgencia = ie_urgencia_w))
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao	= nr_prescricao_p;
	elsif (substr(ie_regra_w,2,1) = 'R') then
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.nr_prescricao		= nr_prescricao_p
		  and a.nr_prescricao		= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao	<= nr_prescricao_p;

	else
		select	coalesce(max(a.nr_prescricao),0)
		into STRICT	nr_prescricao_w
		from	exame_laboratorio c,
			prescr_procedimento b,
			prescr_medica a
		where a.cd_pessoa_fisica	= cd_pessoa_fisica_w
		  and a.nr_prescricao		= b.nr_prescricao
		  and b.nr_seq_exame		= c.nr_seq_exame
		  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
		  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
		  and a.nr_prescricao	<= nr_prescricao_p;
	end if;

	ie_regra_ww	:= substr(ie_regra_w,1,1);

	if (nr_prescricao_w > 0) then
		if (ie_gerar_sequencia_w = 'C') then
			select	coalesce(max(dt_coleta), max(dt_prescricao))
			into STRICT	dt_prescricao_w
			from	exame_laboratorio c,
				prescr_procedimento b,
				prescr_medica a
			where a.cd_pessoa_fisica	= cd_pessoa_fisica_w
			  and a.nr_prescricao	= b.nr_prescricao
			  and b.nr_seq_exame		= c.nr_seq_exame
 			  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
			  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
			  and a.nr_prescricao		= nr_prescricao_w;
		else
			select	dt_prescricao
			into STRICT	dt_prescricao_w
			from prescr_medica
			where nr_prescricao = nr_prescricao_w;
		end if;


		if	((ie_regra_ww = 'D') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()))) or
			((ie_regra_ww = 'S') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()))) or
			((ie_regra_ww = 'M') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_prescricao_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp()))) or
			((ie_regra_ww = 'A') and (ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_prescricao_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(clock_timestamp()))) or (ie_regra_ww = 'G') or (nr_seq_motivo_recoleta_w IS NOT NULL AND nr_seq_motivo_recoleta_w::text <> '') then


			if ((substr(ie_regra_w,1,1) = 'G') or (substr(ie_regra_w,2,1) = 'G')) then
				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao		= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and c.nr_seq_grupo		= nr_seq_grupo_w
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao		= nr_prescricao_w
				  and ((ie_agrupa_amostra_horario_w = 'U' AND b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				  and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));

				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao		= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and c.nr_seq_grupo		= nr_seq_grupo_w
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao		= nr_prescricao_w
					  and to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);


				end if;

			elsif (substr(ie_regra_w,2,1) = 'M') then
				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao		= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and b.cd_material_exame	= cd_material_exame_w
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao		= nr_prescricao_w
				  and ((ie_agrupa_amostra_horario_w = 'U' AND ie_urgencia_w = 'S' and b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				  and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));


				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao		= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao		= nr_prescricao_w
					  and b.cd_material_exame	= cd_material_exame_w
					  and to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);

				end if;

			elsif (substr(ie_regra_w,2,1) = 'P') then
				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao		= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and b.cd_material_exame	= cd_material_exame_w
				  and pkg_date_utils.get_time(b.dt_prev_execucao,0,0,0)	= pkg_date_utils.get_time(dt_prev_execucao_w,0,0,0)
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao		= nr_prescricao_w
				  and ((ie_agrupa_amostra_horario_w = 'U' AND b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				  and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));

				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao		= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and b.cd_material_exame	= cd_material_exame_w
					  and to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao		= nr_prescricao_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);

				end if;
			elsif (substr(ie_regra_w,2,1) = 'H') then
				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao	= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and b.cd_material_exame	= cd_material_exame_w
				  and ((PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'hh',0) 	= PKG_DATE_UTILS.start_of(dt_prev_execucao_w,'hh',0)) or (ie_urgencia_w = 'S' and b.ie_urgencia = ie_urgencia_w))
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao	= nr_prescricao_w
				 and ((ie_agrupa_amostra_horario_w = 'U' AND b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));

				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao	= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and b.cd_material_exame	= cd_material_exame_w
					  and ((to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w) or (ie_urgencia_w = 'S' and b.ie_urgencia = ie_urgencia_w))
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao	= nr_prescricao_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);



				end if;

			elsif (substr(ie_regra_w,2,1) = 'R') then

				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao		= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao		= nr_prescricao_w
				  and ((ie_agrupa_amostra_horario_w = 'U' AND b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				  and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));

				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao		= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao		= nr_prescricao_w
					  and to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);


				end if;


			else
				select	coalesce(max(nr_seq_lab),'0')
				into STRICT	nr_seq_lab_w
				from	exame_laboratorio c,
					prescr_procedimento b,
					prescr_medica a
				where a.nr_prescricao		= b.nr_prescricao
				  and b.nr_seq_exame		= c.nr_seq_exame
				  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
				  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
				  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
				  and a.nr_prescricao		= nr_prescricao_w
				  and ((ie_agrupa_amostra_horario_w = 'U' AND b.ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
				  and ( ((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
					(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w));

				if (ie_agrupa_amostra_horario_w = 'S') and (nr_seq_lab_w = 0) then

					select	coalesce(max(nr_seq_lab),'0')
					into STRICT	nr_seq_lab_w
					from	exame_laboratorio c,
						prescr_procedimento b,
						prescr_medica a
					where a.nr_prescricao		= b.nr_prescricao
					  and b.nr_seq_exame		= c.nr_seq_exame
					  and coalesce(lab_obter_grupo_imp_estab(a.cd_estabelecimento,b.nr_seq_exame, cd_convenio_w),c.nr_seq_grupo_imp)	= nr_seq_grupo_imp_w
					  and (b.nr_seq_lab IS NOT NULL AND b.nr_seq_lab::text <> '')
					  and ((coalesce(nr_seq_motivo_recoleta_w::text, '') = '') or (nr_seq_motivo_recoleta_w = nr_seq_recoleta))
					  and a.nr_prescricao		= nr_prescricao_w
					  and to_char(PKG_DATE_UTILS.start_of(b.dt_prev_execucao,'mi',0),'dd/mm/yyyy hh24:mi:ss') 	= dt_prev_execucao_aux2_w
					  and (nr_seq_origem IS NOT NULL AND nr_seq_origem::text <> '' AND nr_seq_origem_w <> 0);



				end if;

			end if;
		end if;
	end if;


	select	max(nr_sequencia)
	into STRICT	nr_seq_grupo_imp_vig_w
	from	lab_grupo_imp_vig
        where	nr_seq_grupo_impressao = nr_seq_grupo_imp_w
	and	clock_timestamp() between dt_inicio and dt_final;


	if (nr_seq_grupo_imp_vig_w IS NOT NULL AND nr_seq_grupo_imp_vig_w::text <> '') then

		select	coalesce(max(nr_sequencia), -1)
		into STRICT	nr_seq_imp_w
		from 	lab_seq_grupo_imp
		where 	nr_seq_grupo_imp 	= nr_seq_grupo_imp_w
		and	nr_seq_grupo_imp_vig	= nr_seq_grupo_imp_vig_w;

		if	not(nr_seq_imp_w  > 0) then

			select	max(nr_seq_inicial)
			into STRICT	nr_seq_inicial_w
			from	lab_grupo_imp_vig
			where	nr_sequencia = nr_seq_grupo_imp_vig_w;

            if ( coalesce(nr_seq_inicial_w::text, '') = '' ) then
                select	coalesce(max(nr_seq_inic),'0')
                into STRICT	nr_seq_inicial_w
                from	lab_grupo_impressao
                where	nr_sequencia = nr_seq_grupo_imp_w;
            end if;

			select	max(ie_regra_sequencia)
			into STRICT	ie_regra_sequencia_w
			from	lab_grupo_impressao
			where	nr_sequencia = nr_seq_grupo_imp_w;


			if (substr(ie_regra_sequencia_w,1,1) = 'D') then
				dt_sequencia_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
			elsif (substr(ie_regra_sequencia_w,1,1) = 'S') then
				dt_sequencia_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
			elsif (substr(ie_regra_sequencia_w,1,1) = 'M') then
				dt_sequencia_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(clock_timestamp());
			elsif (substr(ie_regra_sequencia_w,1,1) = 'A') then
				dt_sequencia_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(clock_timestamp());
			elsif (substr(ie_regra_sequencia_w,1,1) = 'G') then
				dt_sequencia_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(clock_timestamp());
			end if;


			select	nextval('lab_seq_grupo_imp_seq')
			into STRICT	nr_seq_lab_seq_grupo_imp_w
			;

			insert into lab_seq_grupo_imp(
				nr_sequencia,
				nr_seq_grupo_imp,
				dt_sequencia,
				nr_valor_seq,
				dt_atualizacao,
				nm_usuario,
				nr_seq_grupo_imp_vig
				)
			values (
				nr_seq_lab_seq_grupo_imp_w,
				nr_seq_grupo_imp_w,
				dt_sequencia_w,
				nr_seq_inicial_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_grupo_imp_vig_w
				);

			nr_seq_imp_w := nr_seq_inicial_w;

		end if;

	else

		select	coalesce(max(nr_sequencia), -1)
		into STRICT	nr_seq_imp_w
		from 	lab_seq_grupo_imp
		where 	nr_seq_grupo_imp = nr_seq_grupo_imp_w;

	end if;


	nr_seq_lab_w		:= coalesce(nr_seq_lab_w,'0');

	if (nr_seq_lab_w = '0') and (nr_seq_imp_w > 0) then
		lock table lab_seq_grupo_imp in exclusive mode;
		select	coalesce(nr_valor_seq,0) + 1,
			nr_sequencia
		into STRICT	nr_seq_lab_w,
			nr_sequencia_w
		from lab_seq_grupo_imp
		where nr_sequencia = (SELECT max(nr_sequencia)
					from lab_seq_grupo_imp
					where nr_seq_grupo_imp = nr_seq_grupo_imp_w);
		update	lab_seq_grupo_imp
		set	nr_valor_seq = nr_seq_lab_w
		where nr_sequencia = nr_sequencia_w;
	end if;

	begin

		update prescr_procedimento
		set nr_seq_lab = nr_seq_lab_w
		where nr_prescricao	= nr_prescricao_p
		  and	((coalesce(nr_seq_prescr_p::text, '') = '') or (nr_seq_prescr_p = nr_sequencia))
		  and  ((ie_agrupa_amostra_horario_w = 'U' AND ie_urgencia = ie_urgencia_w) or (ie_agrupa_amostra_horario_w <> 'U'))
		  and coalesce(cd_material_exame,'XPTO')	= coalesce(cd_material_exame_w,'XPTO')
		  and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prev_execucao)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prev_execucao_w)
		  and ((substr(ie_regra_w,2,1) <> 'H') or ((trunc(dt_prev_execucao,'hh') 	= trunc(dt_prev_execucao_w,'hh')) or (ie_urgencia_w = 'S' and ie_urgencia = ie_urgencia_w)))
		  and obter_grupo_exame_lab(nr_seq_exame) = nr_seq_grupo_w
		  and (	((coalesce(nr_seq_origem::text, '') = '') and (nr_seq_origem_w = 0)) or
			(nr_seq_origem	= nr_seq_origem_w AND nr_Sequencia = nr_Seq_prescr_hor_w))
		  and nr_seq_exame	in (	SELECT nr_seq_exame
						from exame_laboratorio
						where coalesce(lab_obter_grupo_imp_estab(cd_estabelecimento_w,nr_seq_exame, cd_convenio_w),nr_seq_grupo_imp) = nr_seq_grupo_imp_w
						  and (cd_procedimento IS NOT NULL AND cd_procedimento::text <> ''));
	exception
	when SQLSTATE '50002' then
		CALL gravar_log_lab(74812,obter_desc_expressao(325814)||' '||nr_prescricao_p||obter_desc_expressao(517942),'Tasy',nr_prescricao_p);
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		--Formato de data invalido (ORA-01830). Favor verificar com o setor de TI as configuracoes de idiomas da maquina/servidor e do banco de dados Oracle (parametro NLS_DATE_FORMAT=dd.mm.yyyy hh24:mi:ss e NLS_LANG=BRAZILIAN PORTUGUESE_BRAZIL.WE8ISO8859P1.
		if (cd_funcao_origem_w	<> 2314) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(232641);
		end if;
	when SQLSTATE '50003' then
		CALL gravar_log_lab(74812,obter_desc_expressao(325814)||' '||nr_prescricao_p||obter_desc_expressao(517943),'Tasy',nr_prescricao_p);
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		--Formato de data invalido (ORA-01861). Favor verificar com o setor de TI as configuracoes de idiomas da maquina/servidor e do banco de dados Oracle (parametro NLS_DATE_FORMAT=dd.mm.yyyy hh24:mi:ss e NLS_LANG=BRAZILIAN PORTUGUESE_BRAZIL.WE8ISO8859P1.
		if (cd_funcao_origem_w	<> 2314) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(232642);
		end if;
	end;

end loop;
close c01;


if (ie_gerar_padrao_amostra_w = 'S') then
	open C02;
	loop
	fetch C02 into
		nr_seq_grupo_exame_w,
		nr_seq_tipo_peca_w,
		nr_seq_grupo_imp_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		nr_seq_lab_pato_w := '';

		select	coalesce(max(a.nr_seq_inic),0)
		into STRICT	nr_seq_inic_w
		from 	lab_grupo_impressao a
		where	a.nr_sequencia = nr_seq_grupo_imp_w;

		select	coalesce(obter_valor_maior(max(nr_seq_lab),nr_seq_inic_w),0) + 1
		into STRICT	nr_seq_lab_aux_w
		from	w_aux_seq_lab
		where	nr_seq_grupo_imp = nr_seq_grupo_imp_w;

		select	count(*)
		into STRICT	qt_registros_aux_w
		from	w_aux_seq_lab
		where	nr_seq_grupo_imp = nr_seq_grupo_imp_w;

		if (qt_registros_aux_w > 0) then

			update  w_aux_seq_lab
			set		nr_seq_lab = nr_seq_lab_aux_w
			where	nr_seq_grupo_imp = nr_seq_grupo_imp_w;

		else
			insert into w_aux_seq_lab(
					nr_seq_lab,
					nr_seq_grupo_imp)
			values (	nr_seq_lab_aux_w,
					nr_seq_grupo_imp_w);
		end if;


		select  coalesce(max(cd_amostra),''),
			CASE WHEN max(ie_utiliza_controle_ano)='S' THEN to_char(clock_timestamp(),'YY')  ELSE '' END
		into STRICT	cd_amostra_w,
		        nr_ano_atual_w
		from	tipo_amostra
		where	nr_sequencia = nr_seq_tipo_peca_w;

		nr_seq_lab_pato_w := cd_amostra_w  ||  nr_ano_atual_w;

		if (nr_seq_lab_pato_w IS NOT NULL AND nr_seq_lab_pato_w::text <> '') then

			nr_seq_lab_pato_w := nr_seq_lab_pato_w || '-';
		end if;

		nr_seq_lab_pato_w := substr(nr_seq_lab_pato_w || lpad(nr_seq_lab_aux_w,obter_valor_maior(6,length(nr_seq_lab_aux_w)),'0'),1,20);

		update	prescr_procedimento
		set	nr_seq_lab = nr_seq_lab_pato_w
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_exame in (SELECT nr_seq_exame from exame_laboratorio b where nr_seq_grupo = nr_seq_grupo_exame_w)
		and	obter_amostra_peca_proced_pato(cd_procedimento, ie_origem_proced) = nr_seq_tipo_peca_w;

		end;
	end loop;
	close C02;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_proc_seq_lab ( nr_prescricao_p bigint, nm_usuario_p text, ie_origem_p text, nr_seq_prescr_p bigint default null) FROM PUBLIC;

