-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_altera_data_comp_lote_rec ( nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, dt_competencia_p timestamp, ie_tipo_data_p text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Alterar a data de competência do protocolo de recurso de glosa 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
------------------------------------------------------------------------------------------------------------------- 
Pontos de atenção: 
Depende de parâmetro [] da função OPS - Produção Recurso de Glosa 
Alterações: 
------------------------------------------------------------------------------------------------------------------- 
 
------------------------------------------------------------------------------------------------------------------- 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
dt_apresentacao_lote_w		pls_rec_glosa_protocolo.dt_apresentacao_lote%type;
qt_lote_contabil_w		integer;

C01 CURSOR FOR 
	SELECT	b.nr_sequencia 
	from	pls_rec_glosa_conta a, 
		pls_conta_rec_resumo_item b, 
		pls_rec_glosa_protocolo c 
	where	c.nr_sequencia 		= a.nr_seq_protocolo 
	and	a.nr_sequencia 		= b.NR_SEQ_CONTA_REC	 
	and	a.nr_seq_protocolo 	= nr_seq_prot_rec_p 
	and	a.ie_status 		= '1' 
	and	c.ie_status		not in ('3','4','6');

 
BEGIN 
if (dt_competencia_p IS NOT NULL AND dt_competencia_p::text <> '') then 
	 
	if (ie_tipo_data_p = 'A') then 
		select	count(1) 
		into STRICT	qt_lote_contabil_w 
		from	pls_conta_rec_resumo_item a, 
			pls_rec_glosa_conta b 
		where	b.nr_sequencia = a.nr_seq_conta_rec 
		and	b.nr_seq_protocolo = nr_seq_prot_rec_p 
		and	coalesce(a.nr_lote_contabil,0) > 0 
		and	coalesce(a.nr_lote_contabil_apres,0) > 0;
		 
		if (qt_lote_contabil_w > 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(445038);
		end if;
		 
		if (trunc(dt_competencia_p) > trunc(clock_timestamp())) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(445044);
		end if;
		 
		update	pls_rec_glosa_protocolo 
		set	dt_apresentacao_lote = dt_competencia_p 
		where	nr_sequencia = nr_seq_prot_rec_p;
	else 
		for r_C01_w in C01 loop 
			begin 
			update	pls_conta_rec_resumo_item 
			set	dt_competencia_pgto 	= dt_competencia_p 
			where	nr_sequencia 		= r_C01_w.nr_sequencia;
			end;
		end loop;
		 
		update	pls_rec_glosa_protocolo 
		set	dt_competencia_lote 	= dt_competencia_p 
		where	nr_sequencia 		= nr_seq_prot_rec_p 
		and	ie_status		not in ('3','4','6');
	end if;
else 
	if (ie_tipo_data_p = 'C') then 
	 
		select	dt_apresentacao_lote 
		into STRICT	dt_apresentacao_lote_w 
		from	pls_rec_glosa_protocolo 
		where	nr_sequencia = nr_seq_prot_rec_p;
		 
		for r_C01_w in C01 loop 
			begin 
			update	pls_conta_rec_resumo_item 
			set	dt_competencia_pgto 	= dt_apresentacao_lote_w 
			where	nr_sequencia 		= r_C01_w.nr_sequencia;
			end;
		end loop;
	 
		update	pls_rec_glosa_protocolo 
		set	dt_competencia_lote 	= dt_apresentacao_lote_w 
		where	nr_sequencia 		= nr_seq_prot_rec_p 
		and	ie_status		not in ('3','4','6');
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_altera_data_comp_lote_rec ( nr_seq_prot_rec_p pls_rec_glosa_protocolo.nr_sequencia%type, dt_competencia_p timestamp, ie_tipo_data_p text) FROM PUBLIC;

