-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_controle_equip ( nr_seq_equipamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_regra_w		bigint;
nr_inicial_w		bigint;
nr_final_w		bigint;
nr_atual_w		bigint;
nr_atual_ww		bigint;
ie_forma_geracao_w	varchar(15);
ds_valor_w		varchar(15);
cd_controle_w		man_equipamento.cd_controle%type;
cd_controle_equip_w	man_equipamento.cd_controle%type;
i			smallint;
ds_mascara_w		varchar(05);

/*
ie_forma_geracao_w = dom 5404

1 - Intervalo de numeração
2 - Intervalo de numeração + Valor
3 - Não gerar
4 - Valor + Intervalo de numeração
5 - Somente valor
*/
BEGIN

if (nr_seq_equipamento_p > 0) then
	begin
	select	cd_controle
	into STRICT	cd_controle_equip_w
	from	man_equipamento
	where	nr_sequencia = nr_seq_equipamento_p;
	
	if (coalesce(cd_controle_equip_w,'X') = 'X') then
		select	man_obter_regra_controle_equip(nr_seq_equipamento_p)
		into STRICT	nr_seq_regra_w
		;
		
		if (nr_seq_regra_w > 0) then
			select	nr_inicial,
				nr_final,
				ie_forma_geracao,
				ds_valor,
				coalesce(nr_atual,0),
				ds_mascara
			into STRICT	nr_inicial_w,
				nr_final_w,
				ie_forma_geracao_w,
				ds_valor_w,
				nr_atual_w,
				ds_mascara_w
			from	man_regra_controle_equip
			where	nr_sequencia = nr_seq_regra_w;
			
			if (nr_inicial_w > nr_atual_w) then
				nr_atual_w := nr_inicial_w;
			end if;
			
			if (ie_forma_geracao_w <> '3') then
				begin
				select	1
				into STRICT	i
				from	man_regra_controle_equip
				where	nr_sequencia = nr_seq_regra_w
				for update;
			
				if (ie_forma_geracao_w = '1') then
					nr_atual_ww	:= nr_atual_w + 1;
					cd_controle_w	:= substr(to_char(nr_atual_ww, ds_mascara_w),2,10);
				elsif (ie_forma_geracao_w = '2') then
					nr_atual_ww	:= nr_atual_w + 1;
					cd_controle_w	:= substr(substr(to_char(nr_atual_ww, ds_mascara_w),2,10) || ds_valor_w,1,30);
				elsif (ie_forma_geracao_w = '4') then
					nr_atual_ww	:= nr_atual_w + 1;
					cd_controle_w	:= substr(ds_valor_w || substr(to_char(nr_atual_ww, ds_mascara_w),2,10),1,30);
				elsif (ie_forma_geracao_w = '5') then
					cd_controle_w	:= substr(ds_valor_w,1,30);
				end if;
				
				if (nr_atual_ww < nr_final_w) then
					update	man_regra_controle_equip
					set	nr_atual		= nr_atual_ww
					where	nr_sequencia	= nr_seq_regra_w;
				
					update	man_equipamento
					set	cd_controle	= cd_controle_w
					where	nr_sequencia	= nr_seq_equipamento_p;
				end if;
				end;
			end if;
		end if;
	end if;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_controle_equip ( nr_seq_equipamento_p bigint, nm_usuario_p text) FROM PUBLIC;

