-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_medic_prescr_manual ( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_mat_med_w			bigint;
nr_ocorrencia_w			bigint;
nr_agrupamento_w			double precision;
nr_agrup_prescr_w			double precision;
cd_material_w			bigint;
cd_material_kit_w			bigint;
qt_material_kit_w			double precision;
qt_material_w			double precision;
ie_origem_inf_w			varchar(1)   	:= 'K';
cd_unidade_medida_w		varchar(30);
cd_unid_med_dose_w		varchar(30);
ie_registra_w			varchar(7);
cd_intervalo_w			varchar(7);
ie_urgencia_w			varchar(1);
ie_duplica_prescr_w		varchar(5);
ie_suspenso_w			varchar(1)	:= 'N';
ie_se_necessario_w		varchar(1)	:= 'N';
ie_medicacao_paciente_w		varchar(1)	:= 'N';
ie_gerou_kit_mat_w		varchar(1)	:= 'N';
nr_seq_proc_w			integer;
cd_kit_material_w		bigint;
ie_agrupador_w			smallint;
cd_classe_material_w		integer;
nr_seq_agrupamento_w		bigint;
cd_grupo_material_w		smallint;
cd_subgrupo_w			smallint;
ie_permite_alterar_w		varchar(1);
ie_considera_w			varchar(1);
ie_item_superior_w		varchar(1);

qt_unitaria_w			double precision;
qt_unitaria_dil_w			double precision;
qt_dose_w			double precision;
cd_kit_w				bigint;
ie_via_aplicacao_w			varchar(05);
qt_volume_w			double precision;
qt_conv_dose_ml_w		double precision;

cd_material_dil_w			bigint;
qt_dose_dil_w			double precision;
cd_unidade_medida_dose_dil_w	varchar(30);
ds_horarios_w			varchar(2000);
cd_setor_atendimento_w		integer;
ie_tipo_atendimento_w		smallint;
ie_recem_nato_w			varchar(1);
ie_agrupador_ww			smallint;
nr_sequencia_solucao_w		bigint;
nr_agrup_w			double precision;
qt_peso_w			real;

C01 CURSOR FOR
	SELECT	nr_agrup_prescr_w + 1,
		a.ie_urgencia,
		a.cd_material,
		a.nr_ocorrencia,
		a.cd_intervalo,
		a.ie_se_necessario,
		a.qt_unitaria,
		a.qt_dose,
		a.ie_via_aplicacao,
		a.cd_unidade_medida,
		a.cd_unidade_medida_dose,
		a.nr_sequencia,
		a.ds_horarios,
		CASE WHEN coalesce(a.ie_item_superior,'N')='N' THEN null  ELSE 'S' END  ie_item_superior,
		a.ie_agrupador,
		a.nr_agrupamento,
		a.nr_sequencia_solucao
	from	material b,
		prescr_material a
	where	a.nr_prescricao	= nr_prescricao_p
	and	a.nr_sequencia	= nr_sequencia_p
	and	a.cd_material   = b.cd_material
	and	(a.ie_via_aplicacao IS NOT NULL AND a.ie_via_aplicacao::text <> '')
	and	coalesce(a.ie_kit_gerado,'N')	= 'N';

C04 CURSOR FOR
	SELECT	a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida_dose,
		a.qt_unitaria,
		Obter_estrutura_material(a.cd_material,'C'),
		Obter_estrutura_material(a.cd_material,'G'),
		Obter_estrutura_material(a.cd_material,'S')
	from	material b,
		prescr_material a
	where	a.nr_prescricao	= nr_prescricao_p
	and	a.cd_material   = b.cd_material
	and	a.nr_sequencia_diluicao = nr_seq_mat_med_w
	and	a.ie_agrupador in (3,7,9);

C02 CURSOR FOR
	SELECT	cd_kit
	from	kit_mat_prescricao
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_material		= cd_material_w
	and	((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao_w	= ie_via_aplicacao))
	and	((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento	= nr_seq_agrupamento_w))
	and	((coalesce(cd_setor_atendimento::text, '') = '') or (CASE WHEN cd_setor_atendimento_w=0 THEN  cd_setor_atendimento  ELSE cd_setor_atendimento_w END  = cd_setor_atendimento))
	and	qt_volume_w 		<= coalesce(qt_volume, qt_volume_w)
	and	((coalesce(ie_tipo_atendimento,0) = coalesce(ie_tipo_atendimento_w, coalesce(ie_tipo_atendimento,0))) or (coalesce(ie_tipo_atendimento::text, '') = ''))
	order	by 	qt_dose_min desc,
			qt_dose_max desc,
			coalesce(qt_volume,0) desc,
			coalesce(ie_via_aplicacao,'zzz'),
			cd_unidade_medida desc,
			cd_setor_atendimento,
			cd_setor_excluir;

C03 CURSOR FOR
	SELECT	c.cd_material,
		c.qt_material,
		substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
		OBTER_CLASSIF_MATERIAL_PROCED(c.cd_material,null,null) ie_agrupador,
		c.ie_permite_alterar,
		coalesce(c.ie_duplica_prescr,'S'),
		a.cd_kit_material
	from	material d,
		componente_kit c,
		kit_material a
	where	a.cd_kit_material	= cd_kit_w
	and	a.cd_kit_material	= c.cd_kit_material
	and	a.ie_situacao		= 'A'
	and	c.ie_situacao		= 'A'
	and	c.cd_material     	= d.cd_material
	and	((c.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(c.ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao_w, c.ie_via_aplicacao) = c.ie_via_aplicacao))
	and	(cd_kit_w IS NOT NULL AND cd_kit_w::text <> '')
	and	((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p))
	and	((coalesce(c.qt_peso_min::text, '') = '' and coalesce(c.qt_peso_max::text, '') = '') or (qt_peso_w between coalesce(c.qt_peso_min,-1) and coalesce(c.qt_peso_max,999)))
	and	coalesce(c.cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w;


C05 CURSOR FOR
	SELECT	coalesce(ie_considera,'N')
	from	regra_vol_diluente
	where (cd_grupo_material	= cd_grupo_material_w	or coalesce(cd_grupo_material::text, '') = '')
	and (cd_subgrupo_material	= cd_subgrupo_w		or coalesce(cd_subgrupo_material::text, '') = '')
	and (cd_classe_material	= cd_classe_material_w	or coalesce(cd_classe_material::text, '') = '')
	and (cd_material		= cd_material_dil_w	or coalesce(cd_material::text, '') = '')
	order by cd_material,
		cd_classe_material,
		cd_subgrupo_material,
		cd_grupo_material;


BEGIN

select	max(nr_agrupamento)
into STRICT	nr_agrup_prescr_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(cd_setor_atendimento), 0),
	max(obter_tipo_atendimento(nr_atendimento)),
	coalesce(max(ie_recem_nato), 'A'),
	max(qt_peso)
into STRICT	cd_setor_atendimento_w,
	ie_tipo_atendimento_w,
	ie_recem_nato_w,
	qt_peso_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(nr_seq_agrupamento)
into STRICT	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;

OPEN C01;
LOOP
FETCH C01 into
	nr_agrupamento_w,
	ie_urgencia_w,
	cd_material_w,
	nr_ocorrencia_w,
	cd_intervalo_w,
	ie_se_necessario_w,
	qt_unitaria_w,
	qt_dose_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_w,
	cd_unid_med_dose_w,
	nr_seq_mat_med_w,
	ds_horarios_w,
	ie_item_superior_w,
	ie_agrupador_ww,
	nr_agrup_w,
	nr_sequencia_solucao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (upper(cd_unid_med_dose_w) = upper(obter_unid_med_usua('ML'))) then
		qt_volume_w		:= qt_dose_w;
	elsif (upper(cd_unidade_medida_w) = upper(obter_unid_med_usua('ML'))) then
		qt_volume_w		:= qt_unitaria_w;
	else
		Select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conv_dose_ml_w
		from	material_conversao_unidade
		where	cd_material = cd_material_w
		and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('ML'));
		qt_volume_w		:= qt_unitaria_w * qt_conv_dose_ml_w;
	end if;

	OPEN C04;
	LOOP
	FETCH C04 into
		cd_material_dil_w,
		qt_dose_dil_w,
		cd_unidade_medida_dose_dil_w,
		qt_unitaria_dil_w,
		cd_classe_material_w,
		cd_grupo_material_w,
		cd_subgrupo_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */

		ie_considera_w	:= 'N';
		OPEN C05;
		LOOP
		FETCH C05 into
			ie_considera_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		ie_considera_w	:= ie_considera_w;
		end;
		END LOOP;
		CLOSE C05;

		if (ie_considera_w = 'S') then
			if (upper(cd_unidade_medida_dose_dil_w) = upper(obter_unid_med_usua('ML'))) then
				qt_volume_w		:= qt_volume_w + qt_dose_dil_w;
			else
				Select	coalesce(max(qt_conversao),1)
				into STRICT	qt_conv_dose_ml_w
				from	material_conversao_unidade
				where	cd_material = cd_material_dil_w
				and	upper(cd_unidade_medida) = upper(obter_unid_med_usua('ML'));
				qt_volume_w		:= qt_volume_w + qt_unitaria_dil_w * qt_conv_dose_ml_w;
			end if;
		end if;

	END LOOP;
	CLOSE C04;

	cd_kit_w		:= null;

	OPEN C02;
	LOOP
	FETCH C02 into 	cd_kit_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		cd_kit_w	:= cd_kit_w;
	END LOOP;
	CLOSE C02;

	OPEN C03;
	LOOP
	FETCH C03 into
		cd_material_kit_w,
		qt_material_kit_w,
		cd_unidade_medida_w,
		ie_agrupador_w,
		ie_permite_alterar_w,
		ie_duplica_prescr_w,
		cd_kit_material_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		if (ie_duplica_prescr_w	= 'N') then
			select	coalesce(max('N'),'S')
			into STRICT	ie_registra_w
			from	prescr_material
			where	cd_material	= cd_material_kit_w
			and	nr_prescricao	= nr_prescricao_p
			and	coalesce(ie_duplica_prescr_w,'S') = 'N';

		elsif (ie_duplica_prescr_w	= 'C') then
			if (ie_item_superior_w	= 'S') then
				ie_registra_w	:= 'S';
			else
				select	coalesce(max('N'),'S')
				into STRICT	ie_registra_w
				from	prescr_material
				where	cd_material	= cd_material_kit_w
				and	nr_prescricao	= nr_prescricao_p
				and	coalesce(ie_duplica_prescr_w,'S') = 'C'
				and	nr_seq_kit in ( SELECT	nr_sequencia
							  from		prescr_material
							  where		nr_prescricao	= nr_prescricao_p
							  and		ie_agrupador	= ie_agrupador_ww
							  and		nr_agrupamento	= nr_agrup_w);
			end if;
		elsif (ie_duplica_prescr_w	= 'D') then
			select	coalesce(max('N'),'S')
			into STRICT	ie_registra_w
			from	prescr_material
			where	cd_material	= cd_material_kit_w
			and	nr_prescricao	= nr_prescricao_p
			and	coalesce(ie_duplica_prescr_w,'S') = 'D'
			and	cd_kit_material	= cd_kit_material_w
			and	nr_seq_kit in ( SELECT	nr_sequencia
						  from		prescr_material
						  where		nr_prescricao	= nr_prescricao_p
						  and		ie_agrupador	= ie_agrupador_ww
						  and		nr_agrupamento	= nr_agrup_w);
		elsif (ie_duplica_prescr_w	= 'E') then
			select	coalesce(max('N'),'S')
			into STRICT	ie_registra_w
			from	prescr_material
			where	cd_material	= cd_material_kit_w
			and		nr_prescricao	= nr_prescricao_p
			and		coalesce(ie_duplica_prescr_w,'S') = 'E'
			and		cd_kit_material	= cd_kit_material_w;
		elsif (ie_duplica_prescr_w	= 'L') then
			if (ie_agrupador_ww		<> 4) then
				ie_registra_w	:= 'S';
			else
				select	coalesce(max('N'),'S')
				into STRICT	ie_registra_w
				from	prescr_material
				where	cd_material			= cd_material_kit_w
				and	nr_prescricao			= nr_prescricao_p
				and	nr_seq_kit 			in (	SELECT	nr_sequencia
										from	prescr_material
										where	nr_prescricao		= nr_prescricao_p
										and	ie_agrupador		= 4
										and	nr_sequencia_solucao	= nr_sequencia_solucao_w);
			end if;
		else
			ie_registra_w	:= 'S';
		end if;

		if (ie_registra_w	= 'S') then

			select coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	prescr_material
			where nr_prescricao = nr_prescricao_p;

			qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
			if (ie_agrupador_w <> 1) then
				ie_agrupador_w := 1;
			else
				ie_agrupador_w := 2;
			end if;

			ie_gerou_kit_mat_w := 'S';

			insert into prescr_material(
				nr_prescricao, nr_sequencia, ie_origem_inf,
				cd_material, cd_unidade_medida, qt_dose,
				qt_unitaria, qt_material, dt_atualizacao,
				nm_usuario, cd_intervalo, nr_agrupamento,
				ie_urgencia, nr_ocorrencia, qt_total_dispensar,
				ie_suspenso, cd_unidade_medida_dose,
				ie_se_necessario, ie_medicacao_paciente,
				nr_sequencia_proc,cd_motivo_baixa, ie_agrupador,
				ie_bomba_infusao, ie_aplic_bolus, ie_aplic_lenta,
				ie_acm, ds_horarios, nr_seq_kit, ie_recons_diluente_fixo,
				cd_kit_material, ie_sem_aprazamento, ie_permite_alterar)
			Values (
				nr_prescricao_p, nr_sequencia_w, ie_origem_inf_w,
				cd_material_kit_w, cd_unidade_medida_w, qt_material_kit_w,
				qt_material_kit_w, qt_material_w, clock_timestamp(),
				nm_usuario_p,  cd_intervalo_w, nr_agrupamento_w,
				ie_urgencia_w, nr_ocorrencia_w, qt_material_w,
				ie_suspenso_w, cd_unidade_medida_w,
				ie_se_necessario_w, ie_medicacao_paciente_w,
				nr_seq_proc_w,0, ie_agrupador_w,
				'N','N','N','N',ds_horarios_w, nr_seq_mat_med_w,'N',
				cd_kit_w, 'N', ie_permite_alterar_w);

		end if;
	END LOOP;
	CLOSE C03;

	update	prescr_material
	set	ie_kit_gerado	= ie_gerou_kit_mat_w
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_mat_med_w;

END LOOP;
CLOSE C01;

CALL reordenar_medicamento(nr_prescricao_p);

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_medic_prescr_manual ( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

