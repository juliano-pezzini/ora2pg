-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_trans_financ_emp ( cd_empresa_origem_p bigint, cd_empresa_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estab_matriz_origem_w  estabelecimento.cd_estabelecimento%type;
cd_estab_matriz_destino_w estabelecimento.cd_estabelecimento%type;
qt_reg_orig_w   bigint;
qt_reg_dest_w   bigint;

c01 CURSOR FOR
    SELECT  nr_sequencia,
            cd_estabelecimento
    from    transacao_financeira
    where   cd_empresa = cd_empresa_origem_p
    and     cd_estabelecimento = cd_estab_matriz_origem_w or coalesce(cd_estabelecimento::text, '') = '';

c01_w       c01%rowtype;


BEGIN
    begin
        select  cd_estabelecimento
            into STRICT    cd_estab_matriz_origem_w
        from    estabelecimento
            where   ie_tipo_estab = 'M'
            and cd_empresa = cd_empresa_origem_p;
    exception
        when no_data_found then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(1099799);
        when too_many_rows THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(956422);
    end;

    begin
        select  cd_estabelecimento
        into STRICT    cd_estab_matriz_destino_w
        from    estabelecimento
            where   ie_tipo_estab = 'M'
            and     cd_empresa = cd_empresa_destino_p;
    exception
    when no_data_found then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1099800);
    when too_many_rows THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(956422);
    end;

        open c01;
        loop
        fetch c01 into
            c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
            CALL copiar_transacao_empresa(   c01_w.nr_sequencia,
                                                    cd_empresa_destino_p,
                                                    cd_estab_matriz_destino_w,
                                                    cd_estab_matriz_origem_w,
                                                    nm_usuario_p,
                                                    'S',
                                                    null,
                                                    'N');
        end loop;
        close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_trans_financ_emp ( cd_empresa_origem_p bigint, cd_empresa_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

