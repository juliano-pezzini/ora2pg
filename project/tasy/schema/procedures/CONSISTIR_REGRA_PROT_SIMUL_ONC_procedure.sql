-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_prot_simul_onc ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, cd_protocolo_p bigint, nr_seq_medicacao_p bigint, ds_mensagem_p INOUT text, ds_mensagem_regra_p INOUT text, nr_ciclo_p INOUT bigint ) AS $body$
DECLARE


nm_usuario_w			varchar(15);
nr_seq_atendimento_w		bigint;
nr_ciclo_ult_w			smallint := 0;
nr_ciclo_w			smallint;
ds_dia_ciclo_w			varchar(5);
nr_seq_medicacao_w		integer;
ds_mensagem_w			varchar(32000) := '';
ds_mensagem_regra_w		varchar(32000) := '';
cd_perfil_w			integer;
cd_protocolo_w			bigint;
ie_regra_w			varchar(2) := 'N';



BEGIN

nm_usuario_w 	:= wheb_usuario_pck.get_nm_usuario;

if (cd_protocolo_p IS NOT NULL AND cd_protocolo_p::text <> '') then

	select 	obter_se_regra_prot_simul_onc(cd_protocolo_p)
	into STRICT	ie_regra_w
	;

	if ( ie_regra_w = 'N') then


		select  coalesce(max(y.nr_seq_atendimento),0)
		into STRICT	nr_seq_atendimento_w
		from	paciente_setor x,
			paciente_atendimento y
		where	x.cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	x.nr_seq_paciente 	<> nr_seq_paciente_p
		and	coalesce(y.dt_real,y.dt_prevista) >= clock_timestamp()
		and	x.nr_seq_paciente = y.nr_seq_paciente
		and	x.cd_protocolo = cd_protocolo_p
		and	Obter_se_ciclo_gerado(x.nr_seq_paciente) = 'S'
		and	x.ie_status = 'A'
		and	coalesce(y.dt_cancelamento::text, '') = ''
		and	obter_se_regra_prot_simul_onc(x.cd_protocolo) = 'N';

		if (nr_seq_atendimento_w = 0) then

			select  coalesce(max(y.nr_seq_atendimento),0)
			into STRICT	nr_seq_atendimento_w
			from	paciente_setor x,
				paciente_atendimento y
			where	x.cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	x.nr_seq_paciente 	<> nr_seq_paciente_p
			and	coalesce(y.dt_real,y.dt_prevista) >= clock_timestamp()
			and	x.nr_seq_paciente = y.nr_seq_paciente
			and	Obter_se_ciclo_gerado(x.nr_seq_paciente) = 'S'
			and	x.ie_status = 'A'
			and	coalesce(y.dt_cancelamento::text, '') = ''
			and	obter_se_regra_prot_simul_onc(x.cd_protocolo) = 'N';

		end if;

		if ( nr_seq_atendimento_w > 0 ) then

			select	a.nr_seq_medicacao,
				b.nr_ciclo,
				a.cd_protocolo
			into STRICT	nr_seq_medicacao_w,
				nr_ciclo_w,
				cd_protocolo_w
			from	paciente_setor a,
				paciente_atendimento b
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	a.nr_seq_paciente 	<> nr_seq_paciente_p
			and	a.nr_seq_paciente	 = b.nr_seq_paciente
			and	b.nr_seq_atendimento = nr_seq_atendimento_w;

			if (cd_protocolo_w IS NOT NULL AND cd_protocolo_w::text <> '') then

				ds_mensagem_regra_w := obter_texto_dic_objeto(210180,wheb_usuario_pck.get_nr_seq_idioma, null);

				ds_mensagem_w := obter_param_usuario(281, 1260, cd_perfil_w, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, ds_mensagem_w);

				ds_mensagem_regra_p 	:= substr(ds_mensagem_regra_w,1,255);

				if (nr_seq_medicacao_w = nr_seq_medicacao_p) then
					nr_ciclo_ult_w := nr_ciclo_w;
				end if;

				ds_mensagem_p 	:= substr(ds_mensagem_w,1,225);
				nr_ciclo_p 	:= nr_ciclo_ult_w;


			end if;

		end if;

	end if;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_prot_simul_onc ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, cd_protocolo_p bigint, nr_seq_medicacao_p bigint, ds_mensagem_p INOUT text, ds_mensagem_regra_p INOUT text, nr_ciclo_p INOUT bigint ) FROM PUBLIC;

