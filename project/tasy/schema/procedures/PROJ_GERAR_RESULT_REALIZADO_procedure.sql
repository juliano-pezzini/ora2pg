-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_result_realizado ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proj_w			bigint;
cd_executor_w			varchar(10);
qt_hora_w			double precision	:= 0;
vl_hora_cobrar_w		double precision	:= 0;
vl_hora_pagar_w			double precision	:= 0;
vl_pagar_w			double precision	:= 0;
vl_cobrar_cliente_w		double precision	:= 0;
vl_imposto_w			double precision	:= 0;
vl_adicional_clt_w		double precision	:= 0;
vl_custo_inst_w			double precision	:= 0;
vl_margem_w			double precision	:= 0;
vl_fixo_consultor_w		double precision	:= 0;

C01 CURSOR FOR
	SELECT	cd_executor,
		sum(coalesce(qt_total_hora,0)) qt_total_hora,
		dividir(sum(coalesce(vl_cobrar_cliente,0)),sum(coalesce(qt_total_hora,0))) vl_hora_cobrar,
		sum(coalesce(vl_cobrar_cliente,0)) vl_cobrar_cliente,
		dividir(sum(coalesce(vl_pagar,0)),sum(coalesce(qt_total_hora,0))) vl_hora_pagar,
		sum(coalesce(vl_pagar,0)) vl_pagar,
		sum(coalesce(vl_imposto,0)),
		sum(coalesce(vl_adicional_clt,0)),
		sum(coalesce(vl_custo_inst,0)),
		sum(coalesce(vl_fixo_consultor,0))
	from	proj_rat
	where	nr_seq_proj	= nr_seq_proj_w
	and 	(nr_ordem_compra IS NOT NULL AND nr_ordem_compra::text <> '')
	group by cd_executor;


BEGIN

delete	FROM proj_orc_prof
where	nr_seq_orc	= nr_sequencia_p
and	ie_tipo_valor	= 'R';

select	nr_seq_proj
into STRICT	nr_seq_proj_w
from	proj_orcamento
where	nr_sequencia	= nr_sequencia_p;

open C01;
loop
fetch C01 into
	cd_executor_w,
	qt_hora_w,
	vl_hora_cobrar_w,
	vl_cobrar_cliente_w,
	vl_hora_pagar_w,
	vl_pagar_w,
	vl_imposto_w,
	vl_adicional_clt_w,
	vl_custo_inst_w,
	vl_fixo_consultor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	vl_margem_w	:= vl_cobrar_cliente_w - (vl_pagar_w + vl_imposto_w + vl_adicional_clt_w + vl_custo_inst_w);
	insert into proj_orc_prof(nr_sequencia, nr_seq_orc, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
		nr_seq_nivel_cons, ie_coordenador, qt_semana,
		qt_hora_sem, vl_hora_rec, qt_profissional,
		vl_custo_hora, vl_custo_total, vl_receita_total,
		vl_imposto, vl_margem, cd_executor,
		vl_adicional_clt, vl_custo_inst, ie_tipo_valor,
		qt_horas, vl_fixo)
	values (	nextval('proj_orc_prof_seq'), nr_sequencia_p, clock_timestamp(),
		nm_usuario_p, clock_timestamp(), nm_usuario_p,
		null, 'N', 0,
		0, vl_hora_cobrar_w, 1,
		vl_hora_pagar_w, vl_pagar_w, vl_cobrar_cliente_w,
		vl_imposto_w, vl_margem_w, cd_executor_w,
		vl_adicional_clt_w, vl_custo_inst_w, 'R',
		qt_hora_w, vl_fixo_consultor_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_result_realizado ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

