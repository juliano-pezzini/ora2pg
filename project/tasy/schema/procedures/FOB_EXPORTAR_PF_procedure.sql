-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fob_exportar_pf ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE


contador_w	bigint;
ds_arquivo_w	varchar(4000);
ds_linha_w	varchar(4000);
nr_linha_w	bigint := 0;
sep_w		varchar(1) := '';

c01 CURSOR FOR

		SELECT 	a.cd_pessoa_fisica							cd_pessoa_fisica,
			LPAD(coalesce(a.NR_CPF,' '),14,' ')  					nr_cpf,
			LPAD(coalesce(cd_pessoa_dependente,' '),10,' ') 				cd_dependente ,
			RPAD(coalesce(a.nm_dependente,' '),60,' ') 					nm_dependente,
			'1' 									ie_dep,
			LPAD(coalesce(to_char(a.dt_nascimento, 'ddmmyyyy'),' '),8,' ') 		DT_vini,
			LPAD(coalesce(to_char(a.dt_fim_vigencia, 'ddmmyyyy'),' '),8,' ')  		dt_vfi,
			LPAD(coalesce(to_char(a.dt_atualizacao_nrec, 'ddmmyyyy'),' '),8,' ')  	dt_atualizacao,
			LPAD(coalesce(to_char(a.dt_atualizacao, 'ddmmyyyy'),' '),8,' ')  		dt_uatualizacao,
			LPAD(coalesce(to_char(a.dt_nascimento, 'ddmmyyyy'),' '),8,' ')  		dt_nasc_depen
		FROM 	pessoa_fisica_dependente a,
			pessoa_fisica b
		WHERE 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		AND	coalesce(a.dt_exportacao::text, '') = '';

vet01	c01%rowtype;


BEGIN
delete 	from w_dacon
where	nm_usuario = nm_usuario_p;
commit;

open c01;
loop
fetch c01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	-- Montagem das linhas do arquivo
	ds_linha_w :=	substr(	sep_w 	|| 	vet01.nr_cpf				|| sep_w ||
						vet01.cd_dependente			|| sep_w ||
						vet01.nm_dependente			|| sep_w ||
						vet01.ie_dep				|| sep_w ||
						vet01.DT_vini				|| sep_w ||
						vet01.dt_vfi				|| sep_w ||
						vet01.dt_atualizacao			|| sep_w ||
						vet01.dt_uatualizacao			|| sep_w ||
						vet01.dt_nasc_depen			|| sep_w,1,4000);

	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	nr_linha_w		:= nr_linha_w + 1;

	update pessoa_fisica_dependente
	set dt_exportacao = clock_timestamp()
	where cd_pessoa_fisica = vet01.cd_pessoa_fisica;

	insert into 	w_dacon(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_linha,
					ds_arquivo,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
			values (	nextval('w_dacon_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_linha_w,
					ds_arquivo_w,
					clock_timestamp(),
					nm_usuario_p);

	contador_w := contador_w + 1;

	if (mod(contador_w,100) = 0) then
		commit;
	end if;

	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fob_exportar_pf ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

