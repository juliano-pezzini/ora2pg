-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_atualizar_mercado () AS $body$
DECLARE



nr_sequencia_w		bigint;
sg_estado_w		pessoa_juridica.sg_estado%type;
nr_seq_mercado_w	bigint;
qt_cliente_w		bigint;

c01 CURSOR FOR
SELECT a.sg_estado,
	Count(*)
FROM	pessoa_juridica a
WHERE	1 = 1
and	EXISTS (SELECT 1
		FROM  com_cliente x
		WHERE x.cd_cnpj = a.cd_cgc
		and IE_CLASSIFICACAO = 'C'
		and ie_situacao = 'A'
		and ie_produto = 'P')
GROUP BY a.sg_estado;


BEGIN

open c01;
loop
fetch c01 into
	sg_estado_w,
	qt_cliente_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	max(nr_sequencia)
	into STRICT	nr_seq_mercado_w
	from	com_mercado
	where	sg_estado		= sg_estado_w;

	update	com_mercado_empresa
	set	qt_cliente		= qt_cliente_w
	where	cd_cnpj			= '01950338000177'
	and	nr_seq_mercado	= nr_seq_mercado_w;

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_atualizar_mercado () FROM PUBLIC;

