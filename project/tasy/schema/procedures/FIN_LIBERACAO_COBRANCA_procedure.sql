-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_liberacao_cobranca ( nr_sequencia_p bigint, nr_seq_cliente_p bigint default 0, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

 
rodape_w				varchar(4000);
cabecalho_w			varchar(4000);
ds_mensagem_w			varchar(30000) := '';
ds_titulo_w			varchar(4000);
nr_seq_cliente_w			bigint;
nm_fantasia_w			varchar(255);
ds_mail_w			varchar(255);
ds_mail_receb_w			varchar(255);

nr_nfe_imp_w			varchar(255);
nr_titulo_w			bigint;
dt_emissao_w			timestamp;
dt_pagamento_previsto_w		timestamp;
vl_saldo_titulo_w			double precision;

ieenviar_w			boolean := false;

c01 CURSOR FOR 
SELECT	distinct 
	a.nr_sequencia, 
	substr(obter_dados_pf_pj(null,a.cd_cnpj, 'N'),1,254), 
	substr(wheb_obter_email_estab_pj(a.cd_cnpj),1,254) 
from	com_cliente a, 
	fin_titulo_lote_clie b 
where	b.nr_seq_cliente = a.nr_sequencia 
and	b.nr_lote_cliente = nr_sequencia_p 
and	(b.nr_lote_ref IS NOT NULL AND b.nr_lote_ref::text <> '');

c02 CURSOR FOR 
SELECT	distinct 
	a.nr_titulo 
from	fin_titulo_lote_clie a 
where	a.nr_seq_cliente = nr_seq_cliente_w 
and	nr_lote_cliente = nr_sequencia_p;


BEGIN 
if (ie_opcao_p = 'LC') then --liberar cobrança 
	begin 
	update	fin_lote_cobranca 
	set	dt_liberacao = clock_timestamp(), 
		nm_usuario_libera = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
	delete 
	from	fin_titulo_lote_clie 
	where	coalesce(nr_lote_cliente::text, '') = '';
	end;
elsif (ie_opcao_p = 'EL') then -- Estornar liberação cobrança 
	begin 
	update	fin_lote_cobranca 
	set	dt_liberacao  = NULL, 
		nm_usuario_libera  = NULL 
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (ie_opcao_p = 'AC') then -- Aprovar cobrança 
	begin 
	update	fin_lote_cobranca 
	set	dt_aprovacao = clock_timestamp(), 
		nm_usuario_aprov = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (ie_opcao_p = 'EA') then -- Estornar aprovação 
	begin 
	update	fin_lote_cobranca 
	set	dt_aprovacao  = NULL, 
		nm_usuario_aprov  = NULL 
	where	nr_sequencia = nr_sequencia_p;
	end;
elsif (ie_opcao_p = 'AD') then -- adicionar cliente 
	begin 
	update	fin_titulo_lote_clie 
	set	nr_lote_ref	= nr_sequencia_p 
	where	nr_seq_cliente 	= nr_seq_cliente_p 
	and	nr_lote_cliente	= nr_sequencia_p;
	end;
elsif (ie_opcao_p = 'RC') then -- Retirar Cliente 
	begin 
	update	fin_titulo_lote_clie 
	set	nr_lote_ref  = NULL 
	where	nr_lote_cliente = nr_sequencia_p 
	and	nr_seq_cliente	= nr_seq_cliente_p;
	end;
elsif (ie_opcao_p = 'EC') then -- Enviar cobranca cliente 
	begin 
	ieenviar_w := false;
	cabecalho_w := 
	'Olá, constam em aberto na empresa Philips Clinical Informatics' || chr(13) || chr(10) || 
	'CNPJ 01.950.338/0001-77 os valores abaixo: ';
 
	rodape_w := 
	'Caso estes valores estejam quitados, pedimos a gentileza de nos enviar os comprovantes. ' || chr(13) || chr(10) || 
	'Cassiana L. Simchak / Jéssica K. Silva' ||chr(13)||chr(10)|| 
	'PHILIPS CLINICAL INFORMATICS ' ||chr(13)||chr(10)|| 
	'E-mail financeiropci@philips.com' ||chr(13)||chr(10)|| 
	'Telefone (47) 3144-4000 ';
 
	open c01;
	loop 
	fetch c01 into 
		nr_seq_cliente_w, 
		nm_fantasia_w, 
		ds_mail_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		ds_titulo_w := 'NFe     Título     Emissão     Vencimento     Saldo' || chr(13) ||chr(10);
		ds_mensagem_w := '';
		open c02;
		loop 
		fetch c02 into 
			nr_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin 
			select	b.nr_nfe_imp nr_nfe_imp, 
				a.dt_emissao, 
				a.dt_pagamento_previsto, 
				coalesce(a.vl_saldo_titulo,0) vl_saldo_titulo 
			into STRICT	nr_nfe_imp_w, 
				dt_emissao_w, 
				dt_pagamento_previsto_w, 
				vl_saldo_titulo_w 
			FROM titulo_receber a
LEFT OUTER JOIN nota_fiscal b ON (a.nr_seq_nf_saida = b.nr_sequencia)
WHERE a.nr_titulo = nr_titulo_w;
 
			ieenviar_w := true;
			ds_mensagem_w := substr(ds_mensagem_w || to_char(nr_nfe_imp_w)||'     '||to_char(nr_titulo_w)||'     '||to_char(dt_emissao_w,'dd/mm/yyyy')||'     '||to_char(dt_pagamento_previsto_w,'dd/mm/yyyy')||'     '||to_char(vl_saldo_titulo_w)||chr(13)||chr(10),1,30000);
			end;
		end loop;
		close c02;
		if (ieenviar_w) then 
			begin 
			ds_mail_receb_w := 'cassiana.simchak@wheb.com.br;'||ds_mail_w;
			CALL enviar_email(	nm_fantasia_w||' Títulos em aberto Philips', 
					cabecalho_w||chr(13)||chr(10)||chr(13)||chr(10)||ds_titulo_w||ds_mensagem_w||chr(13)||chr(10)||chr(13)||chr(10)||rodape_w, 
					'financeiropci@philips.com', 
					ds_mail_receb_w, 
					nm_usuario_p, 
					'M',null);
			end;
		end if;
		end;
	end loop;
	close c01;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_liberacao_cobranca ( nr_sequencia_p bigint, nr_seq_cliente_p bigint default 0, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

