-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_resumo_diario_os_cli () AS $body$
DECLARE



nr_seq_grupo_des_w		bigint;
nr_seq_gerencia_w			bigint;
nr_sequencia_w			bigint;
nr_seq_posicao_w			bigint;
qt_60_dia_w			bigint;
qt_45_dia_w			bigint;
qt_30_dia_w			bigint;
qt_15_dia_w			bigint;
qt_07_dia_w			bigint;
qt_semana_w			bigint;
qt_os_projeto_w			bigint;
qt_total_w			bigint;
qt_os_antiga_w			bigint;
pr_os_antiga_w			double precision;
nr_seq_localizacao_w		bigint;
ie_controle_diario_w		varchar(1);
ie_tipo_registro_w			smallint;


c01 CURSOR FOR
SELECT	a.nr_seq_grupo_des,
	c.nr_sequencia,
	count(*),
	coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(a.nr_sequencia)='S' THEN 1  ELSE 0 END ),0) qt_projeto,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_60_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_45_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_30_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_15_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_tot_os_antiga,
	(dividir(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ), count(*)) *100) pr_antiga,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_07_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_da_semana
from	gerencia_wheb c,
	grupo_desenvolvimento b,
	man_ordem_servico  a
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and (substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'S')
and (substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'N')
and	a.ie_status_ordem		<> 3
and	a.nr_seq_estagio		in (2,1511)
and	trunc(clock_timestamp(),'dd') = (	select	trunc(max(x.dt_atualizacao),'dd')
				from 	man_ordem_serv_estagio x
				where 	x.nr_seq_ordem = a.nr_sequencia
				and 	x.nr_seq_estagio = a.nr_seq_estagio)
group by c.nr_sequencia,
	a.nr_seq_grupo_des;

c02 CURSOR FOR
SELECT	distinct a.nr_seq_localizacao
from	gerencia_wheb c,
	grupo_desenvolvimento b,
	man_ordem_servico  a
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and (substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'S')
and (substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'N')
and	a.nr_seq_estagio		in (2,1511)
and	a.ie_status_ordem		<> 3
and	trunc(clock_timestamp(),'dd') = (	select	trunc(max(x.dt_atualizacao),'dd')
				from 	man_ordem_serv_estagio x
				where 	x.nr_seq_ordem = a.nr_sequencia
				and 	x.nr_seq_estagio = a.nr_seq_estagio);

c03 CURSOR FOR
SELECT	a.nr_seq_grupo_des,
	c.nr_sequencia,
	count(*),
	coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(a.nr_sequencia)='S' THEN 1  ELSE 0 END ),0) qt_projeto,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_60_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_45_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_30_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_15_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_tot_os_antiga,
	(dividir(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END  END ), count(*)) *100) pr_antiga,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_07_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_da_semana
from	gerencia_wheb c,
	grupo_desenvolvimento b,
	man_ordem_servico  a
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and (substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'S')
and (substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'N')
and	a.ie_status_ordem		<> 3
and	a.nr_seq_localizacao	= nr_seq_localizacao_w
and	a.nr_seq_estagio		in (2,1511)
and	trunc(clock_timestamp(),'dd') = (	select	trunc(max(x.dt_atualizacao),'dd')
				from 	man_ordem_serv_estagio x
				where 	x.nr_seq_ordem = a.nr_sequencia
				and 	x.nr_seq_estagio = a.nr_seq_estagio)
group by c.nr_sequencia,
	a.nr_seq_grupo_des;


BEGIN

/*Gravar posição geral de todas as OS para Wheb
Conforme conversado entre Anderson e Edilson, esta job foi eliminada da base corp pois
a job man_gerar_resumo_diario_os limpa os registros e gera novamente sem restrição de tipo.
*/
BEGIN
delete	FROM man_posicao_diaria
where	trunc(dt_atualizacao) = trunc(clock_timestamp())
and	ie_tipo		      = 'C';

EXCEPTION
	WHEN OTHERS THEN
	nr_seq_posicao_w	:= null;
END;

select	nextval('man_posicao_diaria_seq')
into STRICT	nr_seq_posicao_w
;

insert into man_posicao_diaria(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_localizacao,
	dt_posicao,
	ie_tipo_registro,
	ie_tipo)
values (nr_seq_posicao_w,
	clock_timestamp(),
	'Tasy',
	clock_timestamp(),
	'Tasy',
	null,
	trunc(clock_timestamp()),
	1,
	'C');

open C01;
loop
fetch C01 into
	nr_seq_grupo_des_w,
	nr_seq_gerencia_w,
	qt_total_w,
	qt_os_projeto_w,
	qt_60_dia_w,
	qt_45_dia_w,
	qt_30_dia_w,
	qt_15_dia_w,
	qt_os_antiga_w,
	pr_os_antiga_w,
	qt_07_dia_w,
	qt_semana_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('man_posicao_diaria_resumo_seq')
	into STRICT	nr_sequencia_w
	;

	insert into man_posicao_diaria_resumo(
		nr_sequencia,
		nr_seq_posicao,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_gerencia,
		nr_seq_grupo_des,
		qt_60_dia,
		qt_45_dia,
		qt_30_dia,
		qt_15_dia,
		qt_07_dia,
		qt_semana,
		qt_os_projeto,
		qt_total,
		qt_os_antiga,
		pr_os_antiga,
		ie_tipo)
	values (	nr_sequencia_w,
		nr_seq_posicao_w,
		clock_timestamp(),
		'Tasy',
		clock_timestamp(),
		'Tasy',
		nr_seq_gerencia_w,
		nr_seq_grupo_des_w,
		qt_60_dia_w,
		qt_45_dia_w,
		qt_30_dia_w,
		qt_15_dia_w,
		qt_07_dia_w,
		qt_semana_w,
		qt_os_projeto_w,
		qt_total_w,
		qt_os_antiga_w,
		pr_os_antiga_w,
		'C');
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nr_seq_localizacao_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	select	coalesce(max(ie_controle_diario),'N')
	into STRICT	ie_controle_diario_w
	from	man_localizacao
	where	nr_sequencia	= nr_seq_localizacao_w;

	ie_tipo_registro_w	:= 3;
	if (ie_controle_diario_w = 'S') then
		ie_tipo_registro_w	:= 2;
	end if;

	select	nextval('man_posicao_diaria_seq')
	into STRICT	nr_seq_posicao_w
	;

	insert into man_posicao_diaria(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_localizacao,
		dt_posicao,
		ie_tipo_registro,
		ie_tipo)
	values (nr_seq_posicao_w,
		clock_timestamp(),
		'Tasy',
		clock_timestamp(),
		'Tasy',
		nr_seq_localizacao_w,
		trunc(clock_timestamp()),
		ie_tipo_registro_w,
		'C');

	open C03;
	loop
	fetch C03 into
		nr_seq_grupo_des_w,
		nr_seq_gerencia_w,
		qt_total_w,
		qt_os_projeto_w,
		qt_60_dia_w,
		qt_45_dia_w,
		qt_30_dia_w,
		qt_15_dia_w,
		qt_os_antiga_w,
		pr_os_antiga_w,
		qt_07_dia_w,
		qt_semana_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		select	nextval('man_posicao_diaria_resumo_seq')
		into STRICT	nr_sequencia_w
		;

		insert into man_posicao_diaria_resumo(
			nr_sequencia,
			nr_seq_posicao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_gerencia,
			nr_seq_grupo_des,
			qt_60_dia,
			qt_45_dia,
			qt_30_dia,
			qt_15_dia,
			qt_07_dia,
			qt_semana,
			qt_os_projeto,
			qt_total,
			qt_os_antiga,
			pr_os_antiga,
			ie_tipo)
		values (	nr_sequencia_w,
			nr_seq_posicao_w,
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			'Tasy',
			nr_seq_gerencia_w,
			nr_seq_grupo_des_w,
			qt_60_dia_w,
			qt_45_dia_w,
			qt_30_dia_w,
			qt_15_dia_w,
			qt_07_dia_w,
			qt_semana_w,
			qt_os_projeto_w,
			qt_total_w,
			qt_os_antiga_w,
			pr_os_antiga_w,
			'C');
		end;
	end loop;
	close C03;
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_resumo_diario_os_cli () FROM PUBLIC;

