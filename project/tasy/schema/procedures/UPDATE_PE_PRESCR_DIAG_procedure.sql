-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_pe_prescr_diag ( NR_SEQUENCIA_P bigint) AS $body$
DECLARE


DT_PRESCRICAO_W PE_PRESCRICAO.DT_PRESCRICAO%TYPE;
DT_INICIO_PRESCR_W PE_PRESCRICAO.DT_INICIO_PRESCR%TYPE;
nr_sequencia_w PE_PRESCR_DIAG.NR_SEQUENCIA%TYPE;
NR_SEQ_PAT_CP_GOAL_W patient_cp_indicator.NR_SEQ_PAT_CP_GOAL%TYPE;
NR_SEQ_PAT_CP_INTERV_PLAN_W PATIENT_CP_INTERVENTION.NR_SEQ_PAT_CP_INTERV_PLAN%TYPE;

c01 CURSOR FOR
SELECT 	nr_sequencia
from	PE_PRESCR_DIAG
where	NR_SEQUENCIA = NR_SEQUENCIA_P;


BEGIN

    SELECT DT_PRESCRICAO, DT_INICIO_PRESCR
    INTO STRICT DT_PRESCRICAO_W, DT_INICIO_PRESCR_W
    FROM PE_PRESCRICAO
    WHERE NR_SEQUENCIA = NR_SEQUENCIA_P;

    UPDATE PE_PRESCR_DIAG
    SET    DT_START = DT_INICIO_PRESCR_W
    WHERE  NR_SEQ_PRESCR = NR_SEQUENCIA_P;
	
	  UPDATE PE_PRESCR_PROC
    SET    DT_INICIO = DT_PRESCRICAO_W
    WHERE  NR_SEQ_PRESCR = NR_SEQUENCIA_P;

    UPDATE patient_cp_goal a
    SET    DT_START = DT_PRESCRICAO_W
    WHERE  nr_seq_prescr_diag IN (
      SELECT NR_SEQUENCIA FROM PE_PRESCR_DIAG b
      WHERE b.NR_SEQ_PRESCR = NR_SEQUENCIA_P
    );

    UPDATE patient_cp_interv_plan
    SET    DT_START = DT_PRESCRICAO_W
    WHERE  nr_seq_prescr_diag IN (
        SELECT NR_SEQUENCIA FROM PE_PRESCR_DIAG b 
        WHERE b.NR_SEQ_PRESCR = NR_SEQUENCIA_P
    );

    UPDATE patient_cp_indicator
    SET    DT_START = DT_PRESCRICAO_W
    WHERE  NR_SEQ_PAT_CP_GOAL IN (SELECT b.NR_SEQUENCIA 
                                  FROM PATIENT_CP_GOAL b 
                                  INNER JOIN PE_PRESCR_DIAG c on
                                  C.NR_SEQUENCIA = B.NR_SEQ_PRESCR_DIAG
                                  WHERE c.NR_SEQ_PRESCR = NR_SEQUENCIA_P);

    UPDATE PATIENT_CP_INTERVENTION
    SET    DT_START = DT_PRESCRICAO_W
    WHERE  NR_SEQ_PAT_CP_INTERV_PLAN in (SELECT b.NR_SEQUENCIA 
                                  FROM patient_cp_interv_plan b 
                                  INNER JOIN PE_PRESCR_DIAG c on
                                  C.NR_SEQUENCIA = B.NR_SEQ_PRESCR_DIAG
                                  WHERE c.NR_SEQ_PRESCR = NR_SEQUENCIA_P);
	
    COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_pe_prescr_diag ( NR_SEQUENCIA_P bigint) FROM PUBLIC;

