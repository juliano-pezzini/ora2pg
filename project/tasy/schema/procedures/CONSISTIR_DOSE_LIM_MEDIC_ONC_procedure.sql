-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_dose_lim_medic_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, nr_seq_atendimento_p bigint, ie_opcao_p text, ds_erro_p INOUT text, qt_dose_prescr_p bigint default null, cd_unid_med_prescr_p text default null, ie_via_aplicacao_p text default null, cd_material_p bigint default null, is_paciente_medic_update_p text default 'N') AS $body$
DECLARE


qt_limite_pessoa_w			    double precision;
ie_dose_limite_w			    varchar(15);	
qt_dose_w			    double precision;
ds_erro_w			    varchar(255) := '';
qt_regra_w			    bigint;
cd_unidade_med_prescr_w		    varchar(30);
ie_via_aplicacao_w			    varchar(5);
qt_conversao_dose_limite_w		     double precision;
qt_max_prescricao_w		     double precision;
cd_unidade_medida_consumo_w	     varchar(30);
qt_conversao_dose_w		     double precision;
qt_dose_ww			     double precision;
nr_ocorrencias_w			      bigint;
cd_unid_med_limite_w		     varchar(30);
qt_dose_limite_w			     double precision;
cd_material_w			     integer;

/*
	PPM - Paciente_Protocolo_Medic
	PAM - Paciente_Atend_Medic
*/
										

BEGIN

begin

if (ie_opcao_p = 'PPM') then

select	qt_dose_prescr,
     	cd_unid_med_prescr,
      	ie_via_aplicacao,
      	cd_material
into STRICT	qt_dose_ww,
      	cd_unidade_med_prescr_w,
      	ie_via_aplicacao_w,
      	cd_material_w	
from	paciente_protocolo_medic
	where	nr_seq_paciente = nr_seq_paciente_p
	and	  nr_seq_material	= nr_seq_material_p;

	select	count(*)
	into STRICT	nr_ocorrencias_w
	from	paciente_protocolo_medic
	where	nr_seq_paciente	= nr_seq_paciente_p
	and	cd_material	= cd_material_w;

elsif (ie_opcao_p = 'PAM') then

		select	qt_dose_prescricao,
			cd_unid_med_prescr,
			ie_via_aplicacao,
			cd_material
		into STRICT	qt_dose_ww,
			cd_unidade_med_prescr_w,
			ie_via_aplicacao_w,
			cd_material_w			
		from	paciente_atend_medic
		where	nr_seq_atendimento = nr_seq_atendimento_p
		and	nr_seq_material	= nr_seq_material_p;

		select	count(*)
		into STRICT	nr_ocorrencias_w
		from	paciente_atend_medic
		where	nr_seq_atendimento = nr_seq_atendimento_p
		and 	cd_material = cd_material_w;

    

end if;

	if (is_paciente_medic_update_p = 'S') then
		qt_dose_ww := qt_dose_prescr_p;
		cd_unidade_med_prescr_w := cd_unid_med_prescr_p;
		ie_via_aplicacao_w := ie_via_aplicacao_p;
		cd_material_w := cd_material_p;
	end if;


select	count(*)
into STRICT	qt_regra_w
from	material
where	cd_material	= cd_material_w
and		(qt_limite_pessoa IS NOT NULL AND qt_limite_pessoa::text <> '');	
	
if (qt_regra_w > 0) then

	select 	coalesce(qt_limite_pessoa,0),
		coalesce(ie_dose_limite,'DOSE'),
		cd_unidade_medida_consumo,
		cd_unid_med_limite,
		coalesce(qt_max_prescricao,0),
		coalesce(qt_limite_pessoa,0)
	into STRICT 	qt_limite_pessoa_w,		
		ie_dose_limite_w,
		cd_unidade_medida_consumo_w,
		cd_unid_med_limite_w,
		qt_max_prescricao_w,
		qt_limite_pessoa_w				
	from	material
	where	cd_material = cd_material_w;

	if (cd_unidade_medida_consumo_w = cd_unidade_med_prescr_w) then
		qt_conversao_dose_w := 1;

	else

		begin

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_dose_w
		from	material_conversao_unidade
		where	cd_material = cd_material_w
		and	cd_unidade_medida = cd_unidade_med_prescr_w;

		exception
			when others then
				qt_conversao_dose_w := 1;
		end;

	end if;

	qt_dose_w := (trunc(qt_dose_ww * 1000 / qt_conversao_dose_w)/ 1000);

	if (qt_max_prescricao_w > 0) and (qt_max_prescricao_w < coalesce(qt_dose_w,0)) then
		ds_erro_w := wheb_mensagem_pck.get_texto(277286, 'QT_MAX_PRESCRICAO_P=' || qt_max_prescricao_w || ';CD_UNIDADE_MEDIDA_CONSUMO_P=' || cd_unidade_medida_consumo_w);
	end if;

	if (cd_unidade_medida_consumo_w = cd_unid_med_limite_w) then
		qt_conversao_dose_limite_w	:= 1;
	else
		begin
		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_dose_limite_w
		from	material_conversao_unidade
		where	cd_material = cd_material_w
		and	cd_unidade_medida = cd_unid_med_limite_w;
		exception
			when others then
				qt_conversao_dose_limite_w	:= 1;
		end;
	end if;

	qt_dose_w := (trunc(qt_dose_ww * 1000 / qt_conversao_dose_w)/ 1000);
	qt_dose_limite_w := (trunc(qt_limite_pessoa_w * 1000 / qt_conversao_dose_limite_w)/ 1000);

	if (qt_dose_w > qt_limite_pessoa_w) and (ie_dose_limite_w = 'DIA') then
		qt_dose_w := qt_dose_w * coalesce(nr_ocorrencias_w,1);

	end if;

	if (qt_dose_limite_w > 0) and (qt_dose_limite_w < coalesce(qt_dose_w,0)) then
		ds_erro_w:= wheb_mensagem_pck.get_texto(277256, 'QT_LIMITE_PESSOA_P=' || qt_limite_pessoa_w ||
								';CD_UNID_MED_LIMITE_P=' || cd_unid_med_limite_w ||
								';DS_DOSE_LIMITE_P=' || lower(ie_dose_limite_w));
	end if;

end if;

exception
	when  others then
		null;
end;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_dose_lim_medic_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, nr_seq_atendimento_p bigint, ie_opcao_p text, ds_erro_p INOUT text, qt_dose_prescr_p bigint default null, cd_unid_med_prescr_p text default null, ie_via_aplicacao_p text default null, cd_material_p bigint default null, is_paciente_medic_update_p text default 'N') FROM PUBLIC;

