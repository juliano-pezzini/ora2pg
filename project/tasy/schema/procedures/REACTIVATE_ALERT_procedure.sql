-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reactivate_alert ( nr_atendimento_p bigint, ie_tipo_alerta_p text, nr_tempo_reativacao_p bigint) AS $body$
DECLARE


ie_reativacao_existe_w  integer;
dt_reativacao_w     smart_alert_reativacao.dt_reativacao%type;


BEGIN

dt_reativacao_w := clock_timestamp() + (1 / 1440 * nr_tempo_reativacao_p);

/*  UPDATE REACTIVATE SMART_ALERT */

UPDATE SMART_ALERT_REATIVACAO
SET DT_REATIVACAO = dt_reativacao_w
WHERE nr_atendimento = nr_atendimento_p
AND ie_tipo_alerta = ie_tipo_alerta_p
AND clock_timestamp() < dt_reativacao;

SELECT COUNT(*)
INTO STRICT ie_reativacao_existe_w
FROM SMART_ALERT_REATIVACAO
WHERE nr_atendimento = nr_atendimento_p
AND ie_tipo_alerta = ie_tipo_alerta_p;

if (ie_reativacao_existe_w > 0) then
  UPDATE SMART_ALERT_REATIVACAO
  SET DT_REATIVACAO = dt_reativacao_w,
    NM_USUARIO_NREC = wheb_usuario_pck.get_nm_usuario(),
    DT_ATUALIZACAO_NREC = clock_timestamp()
  WHERE nr_atendimento = nr_atendimento_p
  AND ie_tipo_alerta = ie_tipo_alerta_p;
else
  INSERT INTO SMART_ALERT_REATIVACAO(nr_sequencia,
    nr_atendimento,
    cd_pessoa_fisica,
    ie_tipo_alerta,
    dt_reativacao,
    nm_usuario,
    dt_atualizacao)
  VALUES (nextval('smart_alert_reativacao_seq'),
    nr_atendimento_p,
    (SELECT cd_pessoa_fisica FROM ATENDIMENTO_PACIENTE WHERE nr_atendimento = nr_atendimento_p),
    ie_tipo_alerta_p,
    dt_reativacao_w,
    wheb_usuario_pck.get_nm_usuario(),
    clock_timestamp());
end if;

UPDATE SMART_ALERT
SET ie_status  = 'I'
WHERE ie_status  = 'A'
AND nr_atendimento = nr_atendimento_p
AND ie_tipo_alerta = ie_tipo_alerta_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reactivate_alert ( nr_atendimento_p bigint, ie_tipo_alerta_p text, nr_tempo_reativacao_p bigint) FROM PUBLIC;

