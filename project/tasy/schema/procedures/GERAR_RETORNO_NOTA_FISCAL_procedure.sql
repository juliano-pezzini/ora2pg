-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_retorno_nota_fiscal (nr_seq_nota_fiscal_p bigint, nr_nota_fiscal_p text, nr_nfe_imp_p text, nr_seq_retorno_p bigint, nm_usuario_p text, qt_resultado_p INOUT bigint) AS $body$
DECLARE

 
nr_interno_conta_w	bigint;
cd_autorizacao_w	varchar(20);
vl_saldo_w		double precision;
ie_libera_repasse_w	varchar(5);
cd_convenio_w		integer;
nr_titulo_w		bigint;
vl_guia_w		double precision;
qt_resultado_w		bigint	:= 0;
vl_pago_grg_w		double precision;
vl_glosa_grg_w		double precision;
vl_retorno_w		double precision;
cd_estabelecimento_w	smallint;
ie_somente_com_saldo_w	varchar(10);
ie_retorno_param_w	varchar(15) := 'N';
ie_permitecontasoutroretorno_w	varchar(1);

c01 CURSOR FOR 
 
SELECT	w.nr_interno_conta, 
	w.cd_autorizacao, 
	w.nr_titulo, 
	w.vl_guia 
from ( 
	SELECT	c.nr_interno_conta, 
		c.cd_autorizacao, 
		(obter_titulo_conta_guia(c.nr_interno_conta,c.cd_autorizacao,b.nr_seq_protocolo,null))::numeric  nr_titulo, 
		c.vl_guia 
	from	conta_paciente_guia c, 
		conta_paciente b, 
		nota_fiscal a 
	where	b.nr_interno_conta	= c.nr_interno_conta 
	and	coalesce(b.dt_cancelamento::text, '') = '' 
	and	a.nr_interno_conta	= b.nr_interno_conta 
	and	b.cd_estabelecimento	= cd_estabelecimento_w 
	and	a.nr_nota_fiscal	= coalesce(nr_nota_fiscal_p,a.nr_nota_fiscal) 
	and	coalesce(a.nr_nfe_imp,'0')	= coalesce(nr_nfe_imp_p, coalesce(a.nr_nfe_imp,'0')) 
	and (a.nr_sequencia	= coalesce(nr_seq_nota_fiscal_p,a.nr_sequencia) or nr_seq_nota_fiscal_p = 0) 
	
union
 
	select	d.nr_interno_conta, 
		d.cd_autorizacao, 
		(obter_titulo_conta_guia(d.nr_interno_conta,d.cd_autorizacao,b.nr_seq_protocolo,null))::numeric  nr_titulo, 
		d.vl_guia 
	from	conta_paciente_guia d, 
		conta_paciente c, 
		protocolo_convenio b, 
		nota_fiscal a 
	where	c.nr_interno_conta	= d.nr_interno_conta 
	and	coalesce(c.dt_cancelamento::text, '') = '' 
	and	b.nr_seq_protocolo	= c.nr_seq_protocolo 
	and	a.nr_seq_protocolo	= b.nr_seq_protocolo 
	and	a.nr_nota_fiscal	= coalesce(nr_nota_fiscal_p,a.nr_nota_fiscal) 
	and	c.cd_estabelecimento	= cd_estabelecimento_w 
	and	coalesce(a.nr_nfe_imp,'0')	= coalesce(nr_nfe_imp_p, coalesce(a.nr_nfe_imp,'0')) 
	and (a.nr_sequencia	= coalesce(nr_seq_nota_fiscal_p,a.nr_sequencia) or nr_seq_nota_fiscal_p = 0)	 
	
union
 
	select	d.nr_interno_conta, 
		d.cd_autorizacao, 
		(obter_titulo_conta_guia(d.nr_interno_conta,d.cd_autorizacao,b.nr_seq_protocolo,null))::numeric  nr_titulo, 
		d.vl_guia 
	from	conta_paciente_guia d, 
		conta_paciente c, 
		protocolo_convenio b, 
		nota_fiscal a 
	where	c.nr_interno_conta	= d.nr_interno_conta 
	and	coalesce(c.dt_cancelamento::text, '') = '' 
	and	b.nr_seq_protocolo	= c.nr_seq_protocolo 
	and	a.nr_seq_lote_prot	= b.nr_seq_lote_protocolo 
	and	a.nr_nota_fiscal	= coalesce(nr_nota_fiscal_p,a.nr_nota_fiscal) 
	and	c.cd_estabelecimento	= cd_estabelecimento_w 
	and	coalesce(a.nr_nfe_imp,'0')	= coalesce(nr_nfe_imp_p, coalesce(a.nr_nfe_imp,'0')) 
	and (a.nr_sequencia	= coalesce(nr_seq_nota_fiscal_p,a.nr_sequencia) or nr_seq_nota_fiscal_p = 0) 
	) w 
where	not exists (select	1 
	from	convenio_retorno_item x 
	where	x.cd_autorizacao	= w.cd_autorizacao 
	and	x.nr_interno_conta	= w.nr_interno_conta 
	and	x.nr_seq_retorno	= nr_seq_retorno_p);

	 

BEGIN 
 
select	max(a.cd_convenio), 
	max(a.cd_estabelecimento) 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w 
from	convenio_retorno a 
where	a.nr_sequencia	= nr_seq_retorno_p;
 
ie_somente_com_saldo_w := obter_param_usuario(27, 208, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_somente_com_saldo_w);
ie_retorno_param_w := obter_param_usuario(27, 245, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_retorno_param_w);
ie_permitecontasoutroretorno_w := obter_param_usuario(27, 100, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permitecontasoutroretorno_w);
 
 
select	coalesce(max(a.ie_libera_repasse),'S') 
into STRICT	ie_libera_repasse_w 
from	regra_campo_lib_rep a 
where	coalesce(a.cd_convenio,cd_convenio_w)	= cd_convenio_w 
and	a.ie_regra			= 1;
 
open	c01;
loop 
fetch	c01 into 
	nr_interno_conta_w, 
	cd_autorizacao_w, 
	nr_titulo_w, 
	vl_guia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	if ( ie_retorno_param_w = 'S') and (coalesce(nr_titulo_w::text, '') = '') then 
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(225420,'NR_TITULO_W='|| nr_titulo_w );
	end if;
	 
	select	coalesce(sum(a.vl_pago),0) + coalesce(sum(a.vl_desconto),0) + coalesce(sum(a.vl_perdas),0) + coalesce(sum(a.vl_nota_credito),0) + coalesce(sum(a.vl_glosado),0) 
	into STRICT	vl_retorno_w 
	from	convenio_retorno b, 
		convenio_retorno_item a 
	where	a.nr_interno_conta		= nr_interno_conta_w 
	and	coalesce(a.cd_autorizacao,'0')	= coalesce(coalesce(cd_autorizacao_w,a.cd_autorizacao),'0') 
	and	a.nr_seq_retorno		= b.nr_sequencia 
	and	b.ie_status_retorno		= 'F';
 
	select	obter_valor_guia_grg(nr_interno_conta_w,cd_autorizacao_w,'VG') vl_glosa, 
		obter_valor_guia_grg(nr_interno_conta_w,cd_autorizacao_w,'VP') vl_pago 
	into STRICT	vl_glosa_grg_w, 
		vl_pago_grg_w 
	;
 
	vl_saldo_w	:= coalesce(vl_guia_w,0) - coalesce(vl_retorno_w,0) - coalesce(vl_glosa_grg_w,0) - coalesce(vl_pago_grg_w,0);
	 
	if (coalesce(ie_permitecontasoutroretorno_w,'S') = 'N')	and (obter_conta_outro_retorno(nr_seq_retorno_p,nr_interno_conta_w,cd_autorizacao_w) <> 0) then 
		/* Esta conta já está vinculada a outro retorno em aberto. Parâmetro [100] */
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(255816);
	end if;
		 
	if (coalesce(ie_somente_com_saldo_w,'N') = 'N') or (vl_saldo_w > 0) then		 
		 
		insert	into convenio_retorno_item(cd_autorizacao, 
			dt_atualizacao, 
			ie_analisada, 
			ie_glosa, 
			ie_libera_repasse, 
			nm_usuario, 
			nr_interno_conta, 
			nr_seq_retorno, 
			nr_sequencia, 
			nr_titulo, 
			vl_adicional, 
			vl_amenor, 
			vl_glosado, 
			vl_guia, 
			vl_pago) 
		values (cd_autorizacao_w, 
			clock_timestamp(), 
			'N', 
			'N', 
			ie_libera_repasse_w, 
			nm_usuario_p, 
			nr_interno_conta_w, 
			nr_seq_retorno_p, 
			nextval('convenio_retorno_item_seq'), 
			nr_titulo_w, 
			0, 
			0, 
			0, 
			vl_guia_w, 
			vl_saldo_w);
 
		qt_resultado_w	:= qt_resultado_w + 1;
	end if;
 
end	loop;
close	c01;
 
qt_resultado_p	:= qt_resultado_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_retorno_nota_fiscal (nr_seq_nota_fiscal_p bigint, nr_nota_fiscal_p text, nr_nfe_imp_p text, nr_seq_retorno_p bigint, nm_usuario_p text, qt_resultado_p INOUT bigint) FROM PUBLIC;

