-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_adic_defesa_ressarcimento ( nr_seq_conta_p pls_processo_conta.nr_sequencia%type, ie_tipo_peticao_p pls_formulario.ie_tipo_peticao%type, ie_tipo_pedido_p pls_formulario.ie_tipo_pedido%type, ie_tipo_defesa_p pls_formulario_defesa.ie_tipo_defesa%type, nr_seq_motivo_impugnacao_p pls_formulario_motivo.nr_seq_motivo_impugnacao%type, nr_seq_texto_mot_impug_p pls_formulario_motivo.nr_seq_texto_mot_impug%type, ds_desc_mot_impugnacao_p pls_formulario_motivo.ds_desc_mot_impugnacao%type, nr_seq_texto_mem_calc_p pls_formulario_motivo.nr_seq_texto_mem_calc%type, ds_memoria_calc_p pls_formulario_motivo.ds_memoria_calc%type, nr_seq_texto_doc_comp_p pls_formulario_motivo.nr_seq_texto_doc_comp%type, ds_desc_doc_comp_p pls_formulario_motivo.ds_desc_doc_comp%type, ie_gerar_ret_defesa_p text default 'N', ie_deferimento_p bigint DEFAULT NULL, nr_seq_oficio_p pls_decisao_processual.nr_sequencia%type DEFAULT NULL, ds_motivo_deferimento_p text DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL) AS $body$
DECLARE

						
ie_status_w			pls_processo.ie_status%type;
ie_status_conta_w		pls_processo_conta.ie_status_conta%type;
qt_impugnacao_w			integer;
vl_pedido_w			pls_formulario.vl_pedido%type;
ie_tipo_peticao_imp_w		integer;
ie_tipo_peticao_rec_w		integer;
qt_impug_aguar_elabor_recur_w	integer;
nr_seq_texto_mot_impug_w	pls_formulario_motivo.nr_seq_texto_mot_impug%type;
nr_seq_texto_mem_calc_w		pls_formulario_motivo.nr_seq_texto_mem_calc%type;
nr_seq_texto_doc_comp_w		pls_formulario_motivo.nr_seq_texto_doc_comp%type;
nr_seq_formulario_w		pls_formulario.nr_sequencia%type;
nr_seq_defesa_w			pls_formulario_defesa.nr_sequencia%type;
ie_deferimento_w		varchar(1);
vl_ressarcir_w			double precision;
vl_deferido_w			double precision;


BEGIN

select	max(a.ie_status),
	max(b.ie_status_conta)
into STRICT	ie_status_w,
	ie_status_conta_w
from	pls_processo_conta	b,
	pls_processo		a
where	a.nr_sequencia		= b.nr_seq_processo
and	b.nr_sequencia		= nr_seq_conta_p;

select	count(1)
into STRICT	qt_impugnacao_w
from	pls_impugnacao
where	nr_seq_conta = nr_seq_conta_p;

if (ie_status_w = 'A') and (ie_status_conta_w = 'R') and (qt_impugnacao_w = 0) then
	if (ie_tipo_peticao_p = '1') and (ie_tipo_pedido_p in ('R','RA')) then
		vl_pedido_w := pls_conta_processo_obter_valor(nr_seq_conta_p);
	end if;
	
	select	coalesce(sum(CASE WHEN ie_tipo_peticao=1 THEN  1  ELSE 0 END ), 0),
		coalesce(sum(CASE WHEN ie_tipo_peticao=2 THEN  1  ELSE 0 END ), 0),
		coalesce(sum(CASE WHEN ie_tipo_peticao=1 THEN  CASE WHEN ie_status_impugnacao='R' THEN  1  ELSE 0 END   ELSE 0 END ), 0)
	into STRICT	ie_tipo_peticao_imp_w,
		ie_tipo_peticao_rec_w,
		qt_impug_aguar_elabor_recur_w
	from	pls_formulario
	where	nr_seq_conta = nr_seq_conta_p;
	
	if	((ie_tipo_peticao_p = 1 AND ie_tipo_peticao_imp_w = 0) or
		((ie_tipo_peticao_p = 2) and (ie_tipo_peticao_imp_w > 0) and (ie_tipo_peticao_rec_w = 0) and (qt_impug_aguar_elabor_recur_w > 0))) then
		select	CASE WHEN nr_seq_texto_mot_impug_p=0 THEN  null  ELSE nr_seq_texto_mot_impug_p END ,
			CASE WHEN nr_seq_texto_mem_calc_p=0 THEN  null  ELSE nr_seq_texto_mem_calc_p END ,
			CASE WHEN nr_seq_texto_doc_comp_p=0 THEN  null  ELSE nr_seq_texto_doc_comp_p END 
		into STRICT	nr_seq_texto_mot_impug_w,
			nr_seq_texto_mem_calc_w,
			nr_seq_texto_doc_comp_w
		;
		
		insert into pls_formulario(	nr_sequencia,				nr_seq_conta,			ie_tipo_peticao,
				ie_tipo_pedido,				ie_status_impugnacao,		dt_atualizacao,
				dt_atualizacao_nrec,			nm_usuario,			nm_usuario_nrec,
				vl_pedido)
		values (		nextval('pls_formulario_seq'),		nr_seq_conta_p,			ie_tipo_peticao_p,
				ie_tipo_pedido_p,			'A',				clock_timestamp(),
				clock_timestamp(),				nm_usuario_p,			nm_usuario_p,
				vl_pedido_w) returning nr_sequencia into nr_seq_formulario_w;
				
		insert into pls_formulario_defesa(	nr_sequencia,				nr_seq_formulario,		ie_tipo_defesa,
				ie_status,				dt_defesa,			dt_atualizacao,
				dt_atualizacao_nrec,			nm_usuario,			nm_usuario_nrec)
		values (	nextval('pls_formulario_defesa_seq'),	nr_seq_formulario_w,		ie_tipo_defesa_p,
				'E',					clock_timestamp(),			clock_timestamp(),
				clock_timestamp(),				nm_usuario_p,			nm_usuario_p) returning nr_sequencia into nr_seq_defesa_w;
				
		insert into pls_formulario_motivo(	nr_sequencia,				nr_seq_formulario,		nr_seq_motivo_impugnacao,
				nr_seq_texto_mot_impug,			ds_desc_mot_impugnacao,		nr_seq_texto_mem_calc,
				ds_memoria_calc,			nr_seq_texto_doc_comp,		ds_desc_doc_comp,
				dt_atualizacao,				dt_atualizacao_nrec,		nm_usuario,
				nm_usuario_nrec)
		values (	nextval('pls_formulario_motivo_seq'),	nr_seq_formulario_w,		nr_seq_motivo_impugnacao_p,
				nr_seq_texto_mot_impug_w,		ds_desc_mot_impugnacao_p,	nr_seq_texto_mem_calc_w,
				ds_memoria_calc_p,			nr_seq_texto_doc_comp_w,	ds_desc_doc_comp_p,
				clock_timestamp(),				clock_timestamp(),			nm_usuario_p,
				nm_usuario_p);
				
		-- Liberar a defesa criada
		CALL pls_liberar_defesa(nr_seq_defesa_w,'S',nm_usuario_p);
		
		-- Retorno da defesa
		if (ie_gerar_ret_defesa_p = 'S') then
		
			select	CASE WHEN ie_deferimento_p=0 THEN  'D' WHEN ie_deferimento_p=1 THEN  'I'  ELSE ie_deferimento_p END
			into STRICT	ie_deferimento_w
			;
			
			SELECT * FROM pls_obter_valores_form(nr_seq_formulario_w, ie_tipo_pedido_p, nm_usuario_p, 'N', ie_deferimento_w, vl_ressarcir_w, vl_deferido_w) INTO STRICT vl_ressarcir_w, vl_deferido_w;
			
			CALL pls_gravar_def_defesa_nova(nr_seq_defesa_w, ie_deferimento_p, nr_seq_oficio_p, ds_motivo_deferimento_p, nm_usuario_p, cd_estabelecimento_p, vl_ressarcir_w, vl_deferido_w);
		
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_adic_defesa_ressarcimento ( nr_seq_conta_p pls_processo_conta.nr_sequencia%type, ie_tipo_peticao_p pls_formulario.ie_tipo_peticao%type, ie_tipo_pedido_p pls_formulario.ie_tipo_pedido%type, ie_tipo_defesa_p pls_formulario_defesa.ie_tipo_defesa%type, nr_seq_motivo_impugnacao_p pls_formulario_motivo.nr_seq_motivo_impugnacao%type, nr_seq_texto_mot_impug_p pls_formulario_motivo.nr_seq_texto_mot_impug%type, ds_desc_mot_impugnacao_p pls_formulario_motivo.ds_desc_mot_impugnacao%type, nr_seq_texto_mem_calc_p pls_formulario_motivo.nr_seq_texto_mem_calc%type, ds_memoria_calc_p pls_formulario_motivo.ds_memoria_calc%type, nr_seq_texto_doc_comp_p pls_formulario_motivo.nr_seq_texto_doc_comp%type, ds_desc_doc_comp_p pls_formulario_motivo.ds_desc_doc_comp%type, ie_gerar_ret_defesa_p text default 'N', ie_deferimento_p bigint DEFAULT NULL, nr_seq_oficio_p pls_decisao_processual.nr_sequencia%type DEFAULT NULL, ds_motivo_deferimento_p text DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL) FROM PUBLIC;

