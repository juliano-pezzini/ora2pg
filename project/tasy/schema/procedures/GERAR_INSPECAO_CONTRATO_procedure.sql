-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_inspecao_contrato ( nr_seq_contrato_p bigint, nr_seq_regra_nf_p bigint, nr_seq_registro_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_pessoa_responsavel_w		varchar(10);
cd_cgc_fornecedor_w		varchar(14);
cd_pessoa_fisica_w		varchar(10);
nr_seq_contrato_w			bigint;
cd_material_w			integer;
vl_unitario_material_w		double precision;
vl_desconto_w			contrato_regra_nf.vl_desconto%type;
pr_desconto_w			contrato_regra_nf.pr_desconto%type;

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.cd_cgc_contratado, 
	a.cd_pessoa_contratada, 
	b.cd_material, 
	coalesce(coalesce(b.vl_pagto, ( SELECT	max(x.vl_pagto) 
  			from 	contrato_regra_pagto x 
  			where 	x.nr_seq_contrato = b.nr_seq_contrato)),0) vl_pagto, 
	b.vl_desconto, 
	b.pr_desconto 
from	contrato a, 
	contrato_regra_nf b 
where 	a.nr_sequencia = b.nr_seq_contrato 
and	a.nr_sequencia = nr_seq_contrato_p 
and	b.nr_sequencia = nr_seq_regra_nf_p;


BEGIN 
 
open C01;
loop 
fetch C01 into 
	nr_seq_contrato_w, 
	cd_cgc_fornecedor_w, 
	cd_pessoa_fisica_w, 
	cd_material_w, 
	vl_unitario_material_w, 
	vl_desconto_w, 
	pr_desconto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	select	coalesce(max(substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10)),'X') 
	into STRICT	cd_pessoa_responsavel_w 
	;
 
	if (cd_pessoa_responsavel_w = 'X') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265995);
		--'Usuário deve estar vinculado com uma pessoa física.' 
	end if;
 
	insert into inspecao_recebimento( 
		nr_sequencia, 
		cd_cgc, 
		cd_pessoa_fisica, 
		cd_material, 
		dt_recebimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_lote_fornec, 
		dt_validade, 
		qt_inspecao, 
		ie_externo, 
		ie_interno, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_pessoa_responsavel, 
		ie_temperatura, 
		ie_laudo, 
		nr_seq_contrato, 
		nr_seq_regra_contrato, 
		ie_motivo_devolucao, 
		vl_unitario_material, 
		dt_entrega_real, 
		nr_seq_registro, 
		vl_desconto, 
		pr_desconto) 
	values (nextval('inspecao_recebimento_seq'), 
		cd_cgc_fornecedor_w, 
		cd_pessoa_fisica_w, 
		cd_material_w, 
		trunc(clock_timestamp()), 
		clock_timestamp(), 
		nm_usuario_p, 
		'', 
		null, 
		1, 
		'N', 
		'N', 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_pessoa_responsavel_w, 
		'', 
		'N', 
		nr_seq_contrato_w, 
		nr_seq_regra_nf_p, 
		'', 
		vl_unitario_material_w, 
		trunc(clock_timestamp()), 
		CASE WHEN coalesce(nr_seq_registro_p,0)=0 THEN ''  ELSE nr_seq_registro_p END , 
		vl_desconto_w, 
		pr_desconto_w);
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_inspecao_contrato ( nr_seq_contrato_p bigint, nr_seq_regra_nf_p bigint, nr_seq_registro_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

