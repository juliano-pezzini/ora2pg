-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_consiste_periodo_receita ( nr_seq_entrega_p bigint, nr_receita_p bigint, cd_material_p bigint, qt_dispensar_p INOUT bigint, nr_receita_ant_p INOUT text) AS $body$
DECLARE


nr_seq_receita_amb_w	bigint;
cd_pessoa_fisica_w	varchar(10);
cd_medico_w		varchar(10);
nr_seq_receita_w	bigint;
dt_periodo_inicial_w	timestamp;
dt_perido_final_w	timestamp;
ie_possui_medic_igual_w	varchar(1);
nr_seq_entrega_item_1_w bigint;
nr_dias_util_1_w	smallint;
dt_periodo_inicial_1_w	timestamp;
qt_disp_dia_1_w		double precision;
qt_consumida_1_w	double precision;
qt_sobra_1_w		double precision;
qt_gerado_1_w		double precision;
qt_dispensar_w		double precision;
qt_saldo_1_w		double precision;
nr_receita_anterior_w	varchar(50);
qt_saldo_atual_w	double precision;


C01 CURSOR FOR
	SELECT 	cd_medico,
		nr_sequencia,
		nr_receita
	FROM  	fa_receita_farmacia
	WHERE 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	AND	coalesce(dt_cancelamento::text, '') = ''
	AND 	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	nr_sequencia <> nr_receita_p;


BEGIN

qt_dispensar_w := qt_dispensar_p;
--buscar a  receita
select	b.cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from   	fa_entrega_medicacao a,
	fa_receita_farmacia b
where  	a.nr_seq_receita_amb 	= b.nr_sequencia
and	a.nr_sequencia 		= nr_seq_entrega_p;

select 	dt_periodo_inicial,
	dt_periodo_final
into STRICT	dt_periodo_inicial_w,
	dt_perido_final_w
from	fa_entrega_medicacao
where	nr_sequencia = 	nr_seq_entrega_p;

open C01;
loop
fetch C01 into
	cd_medico_w,
	nr_seq_receita_w,
	nr_receita_anterior_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	begin
	--Verificar se tem receita no período
	SELECT	a.nr_sequencia,
		a.nr_dias_util,
		a.dt_periodo_inicial,
		CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	nr_seq_entrega_item_1_w,
		nr_dias_util_1_w,
		dt_periodo_inicial_1_w,
		ie_possui_medic_igual_w
	FROM   	fa_entrega_medicacao a
	WHERE  	a.nr_seq_receita_amb = nr_seq_receita_w
	AND    	coalesce(a.dt_cancelamento::text, '') = ''
	AND	a.ie_status_medicacao = 'EM'
	AND (trunc(dt_periodo_inicial_w) BETWEEN TRUNC(a.dt_periodo_inicial) AND TRUNC(a.dt_periodo_final))
	AND	EXISTS ( SELECT 1
	   	 	FROM   fa_entrega_medicacao_item x
		 	WHERE  x.nr_seq_fa_entrega  	 = a.nr_sequencia
			AND	   x.cd_material	 = cd_material_p
			AND	   x.ie_status_medicacao = 'EM'
			AND	   coalesce(x.dt_cancelamento::text, '') = '')
	GROUP BY 	a.nr_sequencia,
	   		a.nr_dias_util,
			a.dt_periodo_inicial;

	if (ie_possui_medic_igual_w = 'S') then

		--Verificar a quantidade consumida por dia  (qt_gerada_1 /qtd_dias
		SELECT	a.qt_gerado/nr_dias_util_1_w,
			qt_gerado,
			coalesce(qt_saldo_atual,0)
		into STRICT	qt_disp_dia_1_w,
			qt_gerado_1_w,
			qt_saldo_atual_w
		FROM   	fa_entrega_medicacao_item a,
			fa_entrega_medicacao b
		WHERE  	b.nr_sequencia		 	= a.nr_seq_fa_entrega
		AND    	a.nr_seq_fa_entrega 		= nr_seq_entrega_item_1_w
		AND	a.cd_material		 	= cd_material_p
		AND	a.ie_status_medicacao 	= 'EM'
		AND	coalesce(a.dt_cancelamento::text, '') = '';

		--Verificar a quantidade o paciente consumiu até esta entrega
		qt_consumida_1_w := (trunc(dt_periodo_inicial_w) - trunc(dt_periodo_inicial_1_w))  * qt_disp_dia_1_w;

		--Verifica quanto o paciente já tem em casa
		qt_sobra_1_w 	:= qt_gerado_1_w - qt_consumida_1_w;

		-- Dispensar a quantidade a dispensar - o que o paciente já possui em casa
		qt_dispensar_w	:= qt_dispensar_p - qt_sobra_1_w - qt_saldo_atual_w;
	end if;

	exception
	when others then
		qt_dispensar_w 	 := qt_dispensar_p;
		nr_receita_anterior_w := null;
	end;
	end;
end loop;
close C01;

if (qt_dispensar_w < 0) then
	qt_dispensar_w := 0;
end if;

qt_dispensar_p   := qt_dispensar_w;
nr_receita_ant_p := nr_receita_anterior_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_consiste_periodo_receita ( nr_seq_entrega_p bigint, nr_receita_p bigint, cd_material_p bigint, qt_dispensar_p INOUT bigint, nr_receita_ant_p INOUT text) FROM PUBLIC;

