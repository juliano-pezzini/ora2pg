-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tm_tmeplate_data_recording ( nm_template_title_p text, dt_creation_p timestamp, nm_usuario_p text, ds_template_p text, nr_sequencia_list_p text ) AS $body$
DECLARE


    dt_atualizacao_w      dm_recording_templates.dt_atualizacao%TYPE;
    nm_usuario_w          dm_recording_templates.nm_usuario%TYPE;
    cd_function_w         dm_recording_templates.cd_function%TYPE;
    cd_tab_expression_w   dm_recording_templates.cd_tab_expression%TYPE;
    nm_table_w            dm_recording_templates.nm_table%TYPE;
    ds_tab_path_w         dm_recording_templates.ds_tab_path%TYPE;
    nr_sequencia_w        dm_export_templates.nr_sequencia%TYPE;
    nr_seq_rec_w          dm_recording_templates.nr_sequencia%TYPE;

    c01 CURSOR(nr_sequencia_list_p  text) FOR
    SELECT nr_registro from  table(lista_pck.obter_lista(nr_sequencia_list_p,','));

BEGIN
    SELECT
        nextval('dm_export_templates_seq')
    INTO STRICT nr_sequencia_w
;

    INSERT INTO dm_export_templates(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        nm_template,
        ds_template,
        ie_status,
        ie_active
    ) VALUES (
        nr_sequencia_w,
        dt_creation_p,
        nm_usuario_p,
        nm_template_title_p,
        ds_template_p,
        'C',
        'S'
    );

    for r1 in c01(nr_sequencia_list_p) loop
		begin
            if (r1.nr_registro IS NOT NULL AND r1.nr_registro::text <> '') then
                SELECT
                    dt_atualizacao,
                    nm_usuario,
                    cd_function,
                    cd_tab_expression,
                    nm_table,
                    ds_tab_path
                INTO STRICT
                    dt_atualizacao_w,
                    nm_usuario_w,
                    cd_function_w,
                    cd_tab_expression_w,
                    nm_table_w,
                    ds_tab_path_w
                FROM dm_recording_templates WHERE nr_sequencia = r1.nr_registro;

                INSERT INTO dm_exp_template_contents(
                    nr_sequencia,
                    dt_atualizacao,
                    nm_usuario,
                    cd_function,
                    nm_table,
                    cd_tab_expression,
                    ds_tab_path,
                    ie_active,
                    nr_seq_template
                ) VALUES (
                    nextval('dm_exp_template_contents_seq'),
                    dt_atualizacao_w,
                    nm_usuario_w,
                    cd_function_w,
                    nm_table_w,
                    cd_tab_expression_w,
                    ds_tab_path_w,
                    'S',
                    nr_sequencia_w
                );
            end if;

        end;
    end loop;

    DELETE FROM DM_RECORDING_TEMPLATES;
    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tm_tmeplate_data_recording ( nm_template_title_p text, dt_creation_p timestamp, nm_usuario_p text, ds_template_p text, nr_sequencia_list_p text ) FROM PUBLIC;

