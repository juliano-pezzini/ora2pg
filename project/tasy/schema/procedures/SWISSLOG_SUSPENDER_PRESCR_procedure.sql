-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function swisslog_suspender_prescr as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE swisslog_suspender_prescr ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, nr_opcao_p bigint) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL swisslog_suspender_prescr_atx ( ' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(nr_seq_material_p) || ',' || quote_nullable(nr_seq_horario_p) || ',' || quote_nullable(nm_usuario_p) || ',' || quote_nullable(nr_opcao_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE swisslog_suspender_prescr_atx ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, nr_opcao_p bigint) AS $body$
DECLARE


/*
nr_opcao_p
1 - Suspender prescrição completa
2 - Suspender item prescrição
3 - Suspender horário prescrição
*/
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
nr_seq_empresa_w		empresa_integracao.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_estrut_int_w		mat_estrutura.nr_sequencia%type;
ie_estrutura_w			varchar(1) := 'N';
ie_setor_swisslog_w		varchar(1) := 'N';
ds_param_integ_hl7_w		varchar(4000);
qt_existe_w				bigint;
BEGIN

begin
select	cd_setor_atendimento,
	cd_estabelecimento
into STRICT	cd_setor_atendimento_w,
	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	nr_sequencia
into STRICT	nr_seq_empresa_w
from	empresa_integracao
where	upper(nm_empresa) = 'SWISSLOG';

select	'S'
into STRICT	ie_setor_swisslog_w
from	far_setores_integracao
where	nr_seq_empresa_int = nr_seq_empresa_w
and	cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
	null;
end;

select	count(1)
into STRICT	qt_existe_w
from	prescr_mat_hor a,
	prescr_medica b,
	(SELECT	coalesce(nr_seq_estrut_int,0) nr_seq_estrut_int,
		cd_estabelecimento,
		cd_local_estoque_req
	from	parametros_farmacia) c
where	(a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
and	a.qt_dispensar_hor > 0
and	consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,a.cd_material) = 'S'
and	exists ( select 1 from ap_lote x where x.nr_sequencia = a.nr_seq_lote and coalesce(x.dt_atend_farmacia::text, '') = '')
and	a.cd_local_estoque = c.cd_local_estoque_req
and	b.cd_estabelecimento = c.cd_estabelecimento
and	a.nr_prescricao = b.nr_prescricao
and	b.nr_prescricao = nr_prescricao_p
and	a.nr_sequencia = nr_seq_horario_p;

if (ie_setor_swisslog_w = 'S') and (qt_existe_w > 0) then
	begin
	select	coalesce(max(nr_seq_estrut_int),0)
	into STRICT	nr_seq_estrut_int_w
	from	parametros_farmacia
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	select	'S'
	into STRICT	ie_estrutura_w
	from	prescr_mat_hor
	where	nr_sequencia = nr_seq_horario_p
	and	nr_prescricao = nr_prescricao_p
	and	consistir_se_mat_contr_estrut(nr_seq_estrut_int_w,cd_material) = 'S';
	exception
	when others then
		ie_estrutura_w := 'N';
	end;
	
	if (ie_estrutura_w = 'S') then
		ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
								'nr_seq_horario=' || nr_seq_horario_p || obter_separador_bv ||
								'ie_origem=' || 'CANHOR' || obter_separador_bv || 
								'dt_horario=' || null || obter_separador_bv;
		
		-- Suspender item prescrição completa
		CALL swisslog_gerar_integracao(437, ds_param_integ_hl7_w);
	end if;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE swisslog_suspender_prescr ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, nr_opcao_p bigint) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE swisslog_suspender_prescr_atx ( nr_prescricao_p bigint, nr_seq_material_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, nr_opcao_p bigint) FROM PUBLIC;

