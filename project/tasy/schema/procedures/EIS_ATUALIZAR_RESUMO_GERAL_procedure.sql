-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_atualizar_resumo_geral ( dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_ww	integer;
cd_estabelecimento_w	integer;
nr_seq_indicador_w		bigint;
vl_indicador_w		double precision;
dt_referencia_w		timestamp;
nr_sequencia_w		bigint;
nr_dias_w		bigint;
nr_dias_ww		bigint;
nr_pac_dia_w		bigint;
nr_total_w		bigint;

c01 CURSOR FOR
/* ocupacao centro cirurgico*/

SELECT	cd_estabelecimento,
	703,
	(dividir(sum(qt_min_cirurgia),sum(qt_min_disp)) * 100) pr_ocupacao
from	eis_centro_cirurgico_v
where	dt_referencia between dt_referencia_w and last_day(dt_referencia_w)
group by cd_estabelecimento

union all

/* ocupacao geral */

SELECT	cd_estabelecimento,
	362,
	dividir((sum(nr_leitos_ocupados) * 100), (sum(nr_leitos_ocupados + nr_leitos_livres - (CASE WHEN obter_se_conta_temp_ocup='S' THEN  0  ELSE nr_unidades_temporarias END  ) ))) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	ie_ocup_hospitalar = 'S'
group by cd_estabelecimento

union all

/* ocupacao geral 312*/

select	cd_estabelecimento,
	2185,
	((DIVIDIR(SUM(QT_PACIENTE_DIA),(SUM(QT_LEITO_DIA)+SUM(QT_BLOQ))-SUM(QT_EX_OCUP))*100)) pr_ocupacao
from	EIS_OCUPACAO_HOSPITALAR_P312_V
where	trunc(dt_referencia,'mm')		between dt_referencia_w and last_day(dt_referencia_w)
group by cd_estabelecimento,trunc(dt_referencia,'mm')

union all

select	cd_estabelecimento,
	1208,
	dividir((sum(nr_leitos_ocupados) * 100), (sum((nr_leitos_ocupados + nr_leitos_livres - (CASE WHEN obter_se_conta_temp_ocup='S' THEN  0  ELSE nr_unidades_temporarias END  ))-nr_unidades_interditadas))) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	ie_ocup_hospitalar = 'S'
group by cd_estabelecimento

union all

/* ocupacao geral  - leitos dia*/

select	cd_estabelecimento,
	669,
 	dividir((sum(nr_leitos_ocupados + qt_admitido_alta_dia) * 100), (sum(nr_leitos_ocupados + nr_leitos_livres))) pr_ocupacao
from	hub_eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	ie_ocup_hospitalar = 'S'
group by cd_estabelecimento

union all

/* ocupacao geral  - dias uteis*/

select	cd_estabelecimento,
	634,
 	dividir((sum(nr_leitos_ocupados) * 100), (sum(nr_leitos_ocupados + nr_leitos_livres))) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	obter_se_dia_util(dt_referencia, cd_estabelecimento) = 'S'
and	ie_ocup_hospitalar = 'S'
group by cd_estabelecimento

union all

/* ocupacao internacao */

select	cd_estabelecimento,
	364,
 	dividir(sum(nr_leitos_ocupados) * 100 , (sum(nr_leitos_ocupados + nr_leitos_livres))) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	ie_ocup_hospitalar = 'S'
and	cd_classif_setor	= 3
group by cd_estabelecimento

union all

/* ocupacao uti */

select	cd_estabelecimento,
	365,
 	dividir(sum(nr_leitos_ocupados) * 100 , (sum(nr_leitos_ocupados + nr_leitos_livres))) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	ie_ocup_hospitalar = 'S'
and	cd_classif_setor	= 4
group by cd_estabelecimento

union all

/* taxa de mortalidade geral */

select	cd_estabelecimento,
	341,
	dividir(sum(nr_obitos * 100) , sum(nr_altas + nr_obitos)) tx_obito
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
group by cd_estabelecimento

union all

/* numero de Obitos */

select	cd_estabelecimento,
	375,
	sum(nr_obitos)
from	eis_ocupacao_setor_v
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* resumo de saidas (Obitos + altas) */

select	cd_estabelecimento,
	629,
	sum(nr_obitos + nr_altas)
from	eis_ocupacao_setor_v
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* taxa media de permanencia errado 06/03 ricardo rim
select	cd_estabelecimento,
	383,
	dividir(sum(nr_leitos_ocupados), sum(nr_altas + nr_obitos))
from	eis_ocupacao_setor_v
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
and 	ie_ocup_hospitalar	= 'S'
group by cd_estabelecimento */
select	cd_estabelecimento,
	383,
	dividir(sum(nr_pac_dia), sum(nr_altas + nr_obitos))
from	eis_censo_diario_v2
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* numero internacoes (admissoes) errado ricardo 06/03 rim
select	cd_estabelecimento,
	380,
	sum(nr_admissoes)
from	eis_ocupacao_setor_v
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento */
select	cd_estabelecimento,
	380,
	dividir(sum(nr_pacientes), obter_qt_dias_mes(dt_referencia_w))
from 	eis_censo_diario_v2
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* numero admissoes */

select	cd_estabelecimento,
	461,
	sum(nr_admissoes)
from	eis_ocupacao_hospitalar
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* numero admissoes internados */

select	cd_estabelecimento,
	462,
	sum(nr_admissoes)
from	eis_ocupacao_hospitalar
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
and	ie_tipo_atendimento	= 1
group by  cd_estabelecimento

union all

/* numero pacientes dia errado = ricardo 06/03 rim
select	cd_estabelecimento,
	393,
	sum(nr_leitos_ocupados)
from	eis_ocupacao_setor_v
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento */
select	cd_estabelecimento,
	393,
	sum(nr_pac_dia)
from 	eis_censo_diario_v2
where 	nr_pac_dia 	> 0
and 	ie_periodo 		= 'D'
and 	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
group by cd_estabelecimento

union all

/* numero pacientes dia sus */

select	cd_estabelecimento,
	394,
	sum(nr_pac_dia)
from 	eis_censo_diario_v2
where 	nr_pac_dia 	> 0
and 	ie_periodo 		= 'D'
and 	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_tipo_convenio	= 3
group by cd_estabelecimento

union all

/* taxa ocupacao sus */

select	a.cd_estabelecimento,
	395,
	dividir(sum(CASE WHEN b.ie_tipo_convenio=3 THEN  CASE WHEN a.ie_situacao='P' THEN nr_pacientes * 100  ELSE 0 END   ELSE 0 END ),
		sum(CASE WHEN a.ie_situacao='P' THEN nr_pacientes  ELSE 0 END ))
from	convenio b,
	eis_ocupacao_hospitalar a
where	a.dt_referencia	= dt_referencia_w
and	a.ie_periodo		= 'M'
and	a.cd_convenio		= b.cd_convenio
group by cd_estabelecimento

union all

/* taxa ocupacao sus */

select	a.cd_estabelecimento,
	396,
	dividir(sum(CASE WHEN b.ie_tipo_convenio=3 THEN  0  ELSE CASE WHEN a.ie_situacao='P' THEN nr_pacientes * 100  ELSE 0 END  END ),
		sum(CASE WHEN a.ie_situacao='P' THEN nr_pacientes  ELSE 0 END ))
from	convenio b,
	eis_ocupacao_hospitalar a
where	a.dt_referencia	= dt_referencia_w
and	a.ie_periodo		= 'M'
and	a.cd_convenio		= b.cd_convenio
group by cd_estabelecimento

union all

/* numero cirurgias */

select	cd_estabelecimento,
	378,
	sum(qt_ocorrencia)
from	eis_cirurgia
where	dt_referencia		= dt_referencia_w
and	ie_status_cirurgia	= '2'
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* numero atendimentos pa */

select	cd_estabelecimento,
	387,
	sum(nr_pacientes)
from	eis_pronto_socorro_v
where	dt_referencia	between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
group by cd_estabelecimento

union all

/* valor das compras  */

select	cd_estabelecimento,
	374,
	sum(round((dividir(vl_compra, 1000))::numeric, 4))
from	eis_compras
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

/* saldo em estoque */

select	cd_estabelecimento,
	368,
	round((dividir(sum(vl_estoque),1000))::numeric, 4)
from	eis_estoque
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'M'
group by cd_estabelecimento  

union all

/* titulos a receber */

select	cd_estabelecimento,
	371,
	sum(dividir(vl_vencimento,1000))
from	eis_titulo_vencimento
where	dt_referencia		= dt_referencia_w
group by cd_estabelecimento

union all

/* titulos a pagar */

select	cd_estabelecimento,
	370,
	sum(dividir(vl_titulo,1000))
from	eis_contas_pagar
where	dt_emissao		= dt_referencia_w
group by cd_estabelecimento

union all

/* faturamento sem repasse*/

select	cd_estabelecimento,
	399,
	sum(dividir(coalesce(vl_material,0) + coalesce(vl_procedimento,0),1000))
from	eis_resultado
where	dt_referencia		= dt_referencia_w
group by cd_estabelecimento

union all

/* faturamento com repasse*/

select	cd_estabelecimento,
	403,
	sum(dividir(coalesce(vl_material,0) + coalesce(vl_terceiro,0) + coalesce(vl_procedimento,0),1000))
from	eis_resultado
where	dt_referencia		= dt_referencia_w
group by cd_estabelecimento

union all

/* media dos leitos disponiveis */

select	cd_estabelecimento,
	410,
	(dividir(sum(nr_leitos_ocupados + nr_leitos_livres), avg(nr_dias_w)))
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
and 	ie_ocup_hospitalar	= 'S'
and	ie_periodo		= 'D'
group by cd_estabelecimento

union all

/* media dos leitos disponiveis ate data atual*/

select	cd_estabelecimento,
	1217,
	(dividir(sum(nr_leitos_ocupados + nr_leitos_livres), avg(nr_dias_ww)))
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
and 	ie_ocup_hospitalar	= 'S'
and	ie_periodo		= 'D'
group by cd_estabelecimento

union all

/* giro de leitos */

select	cd_estabelecimento,
	411,
       	CASE WHEN sum(nr_leitos_ocupados + nr_leitos_livres)=0 THEN  0  ELSE dividir(sum(nr_altas + nr_obitos), dividir(sum(nr_leitos_ocupados + nr_leitos_livres), avg(nr_dias_w))) END 
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
and 	ie_ocup_hospitalar	= 'S'
and	ie_periodo		= 'D'
group by cd_estabelecimento

union all

/* leitos livres */

select	cd_estabelecimento,
	412,
       	sum(nr_leitos_ocupados + nr_leitos_livres)
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
and 	ie_ocup_hospitalar	= 'S'
and	ie_periodo		= 'D'
group by cd_estabelecimento

union all

/* intervalo de substituicao */

select	cd_estabelecimento,
	413,
	sum(nr_altas + nr_obitos)
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400
and 	ie_ocup_hospitalar	= 'S'
and	ie_periodo		= 'M'
group by cd_estabelecimento

union all

select	cd_estabelecimento,
	543,
	--((dividir((count(*) - sum(qt_disponiveis)), count(*)) * 100))qt_ind
	((dividir((sum(nr_leitos_ocupados + nr_leitos_livres) - sum(qt_disponiveis)), count(*)) * 100))qt_ind
from	eis_ocupacao_setor_v a
where	dt_referencia between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo = 'D'
and	a.ie_ocup_hospitalar='S'
group by cd_estabelecimento
having(sum(nr_leitos_ocupados + nr_leitos_livres) > 0)

union all

/*dietas entregues*/

select	b.cd_estabelecimento,
		1300,
	count(a.cd_dieta) qt_dietas
from	prescr_dieta a,
		prescr_medica b
where	a.dt_atualizacao between dt_referencia_w and last_day(dt_referencia_w)
and		a.nr_prescricao = b.nr_prescricao
group by b.cd_estabelecimento;


BEGIN

dt_referencia_w		:= trunc(dt_parametro_p,'month');

if (trunc(last_day(dt_parametro_p)) > trunc(clock_timestamp())) then
	select	obter_dias_entre_datas(dt_referencia_w, clock_timestamp())+1
	into STRICT	nr_dias_ww
	;
else
	nr_dias_ww	:= round(last_day(dt_referencia_w) - dt_referencia_w) + 1;
end if;

nr_dias_w	:= round(last_day(dt_referencia_w) - dt_referencia_w) + 1;

delete	FROM eis_indicador_gestao
where	dt_referencia between dt_referencia_w and last_day(dt_referencia_w) + 86399/86400;

commit;


open c01;
loop
fetch c01 into
		cd_estabelecimento_w,
		nr_seq_indicador_w,
		vl_indicador_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select	nextval('eis_indicador_gestao_seq')
	into STRICT	nr_sequencia_w
	;

	select	coalesce(max(cd_estabelecimento),0)
	into STRICT	cd_estabelecimento_ww
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_w;

	if (cd_estabelecimento_ww > 0) then
		begin

		if (nr_seq_indicador_w	= 413) then

			select  sum(CASE WHEN nr_seq_indicador=393 THEN  vl_indicador  ELSE 0 END ),
				round(sum(CASE WHEN nr_seq_indicador=412 THEN  vl_indicador  ELSE 0 END ))
			into STRICT	nr_pac_dia_w,
				nr_total_w
			from 	eis_indicador_gestao
			where 	cd_estabelecimento 	= cd_estabelecimento_w
			and 	dt_referencia 		= dt_referencia_w;

			select	dividir_sem_round((nr_total_w - nr_pac_dia_w), vl_indicador_w)
			into STRICT	vl_indicador_w
			;

		end if;


		insert into eis_indicador_gestao(
			nr_sequencia,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			dt_referencia,
			nr_seq_indicador,
			ie_prev_real,
			ie_periodo,
			vl_indicador)
		values (	nr_sequencia_w,
			cd_estabelecimento_w,
			clock_timestamp(),
			nm_usuario_p,
			dt_referencia_w,
			nr_seq_indicador_w,
			'R',
			'M',
			vl_indicador_w);

		end;
	end if;
end loop;
close c01;

commit;

CALL eis_gerar_resumo_anual(dt_parametro_p, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_atualizar_resumo_geral ( dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

