-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_tipo_valor_pos_estab ( dados_conta_pos_p pls_cta_valorizacao_pck.dados_conta_pos, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dados_regra_preco_pos_estab_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_pos_estab) AS $body$
DECLARE


cd_usuario_plano_w		varchar(30);
ie_tipo_valor_w			dados_regra_preco_pos_estab_p.ie_tipo_valor%type;
ie_benef_rescindido_w		varchar(2);
ie_devolucao_carteira_w		varchar(2);
nr_seq_contrato_w		bigint;
nr_seq_regra_w			dados_regra_preco_pos_estab_p.nr_sequencia%type;
qt_devolucao_carteira_w		integer;
dt_rescisao_w			timestamp	:= null;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
ie_preco_w			pls_plano.ie_preco%type;
vl_retificador_w		dados_regra_preco_pos_estab_p.vl_retificador%type;
ie_tipo_relacao_w		pls_prestador.ie_tipo_relacao%type;
nr_seq_estrutura_mat_w		pls_estrutura_material.nr_sequencia%type;
ie_estrut_mat_w			varchar(1);
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
nr_seq_grupo_servico_w		pls_regra_tp_part_ptu_proc.nr_seq_grupo_servico%type;
ie_estrut_grupo_serv_w		varchar(1);
qt_registro_w			integer;
ie_nao_gera_tx_inter_w		pls_regra_preco_pos_estab.ie_nao_gera_tx_inter%type;
ie_retificador_vl_sem_preco_w	pls_regra_preco_pos_estab.ie_retificador_vl_sem_preco%type;
ie_grupo_mat_w			varchar(1);
ie_excecao_w			varchar(1) := 'N';
ie_retificador_vl_prestador_w	pls_regra_preco_pos_estab.ie_retificador_vl_prestador%type;
ie_benef_remido_w		varchar(1);
ie_gerar_pos_remido_w		pls_parametro_faturamento.ie_gerar_pos_remido%type;

C01 CURSOR FOR
	SELECT	/* +USE_CONCAT */
		a.nr_sequencia,
		a.ie_tipo_valor,
		coalesce(a.vl_retificador,1) vl_retificador,
		a.nr_seq_estrutura_mat,
		a.nr_seq_grupo_servico,
		a.ie_nao_gera_tx_inter,
		a.nr_seq_grupo_material,
		coalesce(a.ie_retificador_vl_prestador,'N') ie_retificador_vl_prestador,
		coalesce(ie_retificador_vl_sem_preco, 'N') ie_retificador_vl_sem_preco
	from	pls_regra_preco_pos_estab a
	where	a.ie_situacao = 'A'
	and	((coalesce(a.nr_seq_contrato::text, '') = '') or (a.nr_seq_contrato = nr_seq_contrato_w))
	and	((coalesce(a.ie_origem_conta::text, '') = '') or ( a.ie_origem_conta = dados_conta_pos_p.ie_origem_conta))
	and	((coalesce(a.ie_benef_rescindido::text, '') = '') or ( a.ie_benef_rescindido = 'N') or (a.ie_benef_rescindido = ie_benef_rescindido_w))
	and	((coalesce(a.ie_benef_remido::text, '') = '') or (a.ie_benef_remido in (ie_benef_remido_w, 'A')) or (ie_gerar_pos_remido_w = 'N'))	
	and	((coalesce(a.ie_preco::text, '') = '') or (a.ie_preco = ie_preco_w))
	and	((coalesce(a.cd_especialidade::text, '') = '') or (a.cd_especialidade = dados_conta_pos_p.cd_especialidade))
	and	((coalesce(a.cd_grupo_proc::text, '') = '') or (a.cd_grupo_proc = dados_conta_pos_p.cd_grupo_proc))
	and	((coalesce(a.ie_tipo_desp_mat::text, '') = '') or (a.ie_tipo_desp_mat = dados_conta_pos_p.ie_tipo_desp_mat))
	and	((coalesce(a.nr_seq_grupo_rec::text, '') = '') or (a.nr_seq_grupo_rec	= dados_conta_pos_p.nr_seq_grupo_rec))
	and	((coalesce(a.nr_seq_congenere::text, '') = '') or (a.nr_seq_congenere	= dados_conta_pos_p.nr_seq_congenere))
	and	((a.ie_devolucao_carteira = 'N') or (ie_devolucao_carteira = ie_devolucao_carteira_w))
	and	dados_conta_pos_p.dt_referencia	 between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dados_conta_pos_p.dt_referencia)
	and (a.ie_apresentacao_prot = 'T' or  coalesce(a.ie_apresentacao_prot::text, '') = '' or a.ie_apresentacao_prot = dados_conta_pos_p.ie_apresentacao_prot)
	and (a.cd_estabelecimento 	= cd_estabelecimento_p)
	and	((coalesce(a.cd_area_procedimento::text, '') = '') or (a.cd_area_procedimento = dados_conta_pos_p.cd_area_procedimento))
	and	((coalesce(a.ie_tipo_relacao_prest_prot::text, '') = '') or (a.ie_tipo_relacao_prest_prot = ie_tipo_relacao_w))
	-- CAMPOS OS 873000
	and	((coalesce(a.nr_seq_intercambio::text, '') = '') or (a.nr_seq_intercambio 	= nr_seq_intercambio_w))
	and	((coalesce(a.cd_procedimento::text, '') = '') or (a.cd_procedimento		= dados_conta_pos_p.cd_procedimento AND ie_origem_proced = dados_conta_pos_p.ie_origem_proced))
	and	((coalesce(a.nr_seq_prestador_exec::text, '') = '') or (a.nr_seq_prestador_exec 	= dados_conta_pos_p.nr_seq_prestador_exec))
	and	((coalesce(a.nr_seq_prestador_prot::text, '') = '') or (a.nr_seq_prestador_prot 	= dados_conta_pos_p.nr_seq_prestador_prot))
	and	((a.ie_tipo_intercambio		=   'A') or (a.ie_tipo_intercambio	= dados_conta_pos_p.ie_tipo_intercambio))
	and	((coalesce(a.ie_origem_protocolo::text, '') = '') or (a.ie_origem_protocolo	= dados_conta_pos_p.ie_origem_protocolo))
	and	((coalesce(a.ie_tipo_protocolo::text, '') = '') or (a.ie_tipo_protocolo	= dados_conta_pos_p.ie_tipo_protocolo))
	and	((a.ie_tipo_congenere		=   'A') or (coalesce(a.ie_tipo_congenere::text, '') = '') or (a.ie_tipo_congenere	= dados_conta_pos_p.ie_tipo_congenere))
	and	((coalesce(a.nr_seq_prest_inter::text, '') = '') or (a.nr_seq_prest_inter = dados_conta_pos_p.nr_seq_prest_inter))
	and 	((coalesce(a.nr_seq_grupo_prest_int::text, '') = '') or (pls_obter_se_grupo_prest_int(a.nr_seq_grupo_prest_int, dados_conta_pos_p.nr_seq_prest_inter) = 'S'))
	and	((coalesce(a.nr_seq_grupo_contrato::text, '') = '') or ((SELECT	count(1)
		from	table(pls_grupos_pck.obter_contrato_grupo(a.nr_seq_grupo_contrato, nr_seq_contrato_w, nr_seq_intercambio_w, 'VALIDAR_FILTROS'))) > 0))
	and	((coalesce(a.nr_seq_material::text, '') = '') or (a.nr_seq_material = dados_conta_pos_p.nr_seq_material))
	order by coalesce(a.ie_origem_conta,'O'),
		coalesce(a.nr_seq_contrato,0) desc,
		coalesce(a.ie_benef_rescindido,'A') desc,
		coalesce(a.ie_devolucao_carteira,'A') desc,
		coalesce(a.ie_preco,'A') desc,
		coalesce(a.ie_tipo_desp_mat,'0') desc,
		coalesce(a.nr_seq_estrutura_mat,0) desc,
		CASE WHEN a.ie_apresentacao_prot='T' THEN 0  ELSE 1 END  desc,
		coalesce(a.nr_seq_intercambio,0) desc,
		coalesce(a.cd_procedimento,0) desc,
		coalesce(a.nr_seq_prestador_exec,0) desc,
		coalesce(a.nr_seq_prestador_prot,0) desc,
		CASE WHEN coalesce(a.ie_tipo_relacao_prest_prot::text, '') = '' THEN 0  ELSE 1 END  desc,
		coalesce(a.ie_tipo_intercambio,'A') desc,
		coalesce(a.ie_origem_protocolo,'A') desc,
		coalesce(a.ie_tipo_protocolo,'A') desc,
		coalesce(a.ie_tipo_congenere,'A') desc,
		coalesce(a.cd_area_procedimento,0) desc,
		coalesce(a.cd_especialidade,0) desc,
		coalesce(a.nr_seq_grupo_rec,0) desc,
		coalesce(a.cd_grupo_proc,0) desc,
		coalesce(a.nr_seq_grupo_contrato, 0) desc,
		coalesce(a.nr_seq_congenere, 0) desc,
		coalesce(a.nr_seq_grupo_material,0) desc,
		coalesce(a.nr_seq_material,0) desc,
		coalesce(a.ie_glosa_parc_valor, 'A') desc,
		coalesce(a.nr_seq_prest_inter, 0) desc,
		coalesce(a.nr_seq_grupo_prest_int, 0) desc;

c02 CURSOR(nr_seq_regra_pc	pls_excecao_preco_pos.nr_seq_regra%type) FOR
	SELECT	nr_seq_grupo_servico
	from	pls_excecao_preco_pos
	where	nr_seq_regra = nr_seq_regra_pc;

BEGIN

ie_benef_rescindido_w := 'N';
qt_devolucao_carteira_w := 0;
ie_devolucao_carteira_w :='ND';
cd_usuario_plano_w := pls_obter_carteira_segurado(dados_conta_pos_p.nr_seq_segurado);
ie_retificador_vl_sem_preco_w := 'N';

begin
	select 	nr_seq_contrato,
		coalesce(dt_rescisao,''),
		pls_obter_produto_benef(nr_sequencia,dt_rescisao), --nr_seq_plano,
		nr_seq_intercambio
	into STRICT	nr_seq_contrato_w,
		dt_rescisao_w,
		nr_seq_plano_w,
		nr_seq_intercambio_w
	from	pls_segurado
	where	nr_sequencia	= dados_conta_pos_p.nr_seq_segurado;
exception
when others then
	nr_seq_contrato_w	:= null;
	dt_rescisao_w		:= null;
	nr_seq_plano_w		:= null;
end;


--- carrega parametrizacoes do faturamento
select	coalesce(max(a.ie_gerar_pos_remido), 'N') ie_gerar_pos_remido
into STRICT	ie_gerar_pos_remido_w
from	pls_parametro_Faturamento	a
where	a.cd_estabelecimento		= cd_estabelecimento_p;

select	max(ie_tipo_relacao)
into STRICT	ie_tipo_relacao_w
from	pls_prestador
where	nr_sequencia	= dados_conta_pos_p.nr_seq_prestador_prot;
	
select	max(ie_preco)
into STRICT	ie_preco_w
from	pls_plano
where	nr_sequencia = nr_seq_plano_w;

if (dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') and (dt_rescisao_w <= dados_conta_pos_p.dt_referencia ) then
	begin
	ie_benef_rescindido_w := 'S';
	
	select	count(1)
	into STRICT	qt_devolucao_carteira_w
	from	pls_carteira_devolucao
	where	cd_usuario_plano = cd_usuario_plano_w  LIMIT 1;
	end;
end if;

if (qt_devolucao_carteira_w > 0) then
	ie_devolucao_carteira_w	:= 'D';
end if;


select	pls_obter_se_benef_remido(dados_conta_pos_p.nr_seq_segurado, dados_conta_pos_p.dt_referencia)
into STRICT	ie_benef_remido_w
;

for r_c01_w in C01 loop
	ie_estrut_mat_w := 'S';
	ie_estrut_grupo_serv_w	:= 'S';
	ie_grupo_mat_w := 'S';

	if (r_c01_w.nr_seq_estrutura_mat IS NOT NULL AND r_c01_w.nr_seq_estrutura_mat::text <> '') then
		ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(dados_conta_pos_p.nr_seq_material, r_c01_w.nr_seq_estrutura_mat);
	end if;

	if (r_c01_w.nr_seq_grupo_servico IS NOT NULL AND r_c01_w.nr_seq_grupo_servico::text <> '') then
		ie_estrut_grupo_serv_w := pls_se_grupo_preco_servico( r_c01_w.nr_seq_grupo_servico, dados_conta_pos_p.cd_procedimento,
									dados_conta_pos_p.ie_origem_proced);
	end if;
	
	if (r_c01_w.nr_seq_grupo_material IS NOT NULL AND r_c01_w.nr_seq_grupo_material::text <> '') then
		ie_grupo_mat_w := pls_se_grupo_preco_material(r_c01_w.nr_seq_grupo_material, dados_conta_pos_p.nr_seq_material);
	end if;

	if (ie_estrut_grupo_serv_w= 'S') then

		select	count(1)
		into STRICT	qt_registro_w
		from	pls_excecao_preco_pos
		where	nr_seq_regra = r_c01_w.nr_sequencia
		and	(nr_seq_grupo_servico IS NOT NULL AND nr_seq_grupo_servico::text <> '');

		if (qt_registro_w > 0) then
			for r_C02_w in C02(r_c01_w.nr_sequencia) loop
				if (r_c01_w.nr_seq_grupo_servico IS NOT NULL AND r_c01_w.nr_seq_grupo_servico::text <> '') and (pls_se_grupo_preco_servico( r_C02_w.nr_seq_grupo_servico, dados_conta_pos_p.cd_procedimento,
									dados_conta_pos_p.ie_origem_proced) = 'S') then
					ie_estrut_grupo_serv_w := 'N';
				end if;
			end loop;
		end if;
	end if;
	
	-- Verificado a excecao a partir de uma procedure, alem de mais performatico 

	-- ira tornar a verificacao de futuros novos campos mais facil
	
	ie_excecao_w := pls_obter_exce_tipo_valor_pos(r_c01_w.nr_sequencia, dados_conta_pos_p, ie_excecao_w);
	
	if (ie_estrut_mat_w = 'S') and (ie_estrut_grupo_serv_w = 'S') and (ie_grupo_mat_w = 'S') and (ie_excecao_w = 'N') then

		nr_seq_regra_w			:= r_c01_w.nr_sequencia;
		ie_tipo_valor_w			:= r_c01_w.ie_tipo_valor;
		vl_retificador_w		:= r_c01_w.vl_retificador;
		ie_nao_gera_tx_inter_w		:= r_c01_w.ie_nao_gera_tx_inter;
		ie_retificador_vl_prestador_w	:= r_c01_w.ie_retificador_vl_prestador;
		ie_retificador_vl_sem_preco_w	:= r_c01_w.ie_retificador_vl_sem_preco;
		-- o primeiro registro que retornar e o valido entao sai do cursor
		exit;
	end if;
end loop;

dados_regra_preco_pos_estab_p.nr_sequencia		:= nr_seq_regra_w;
dados_regra_preco_pos_estab_p.ie_tipo_valor		:= ie_tipo_valor_w;
dados_regra_preco_pos_estab_p.vl_retificador		:= vl_retificador_w;
dados_regra_preco_pos_estab_p.ie_nao_gera_tx_inter 	:= ie_nao_gera_tx_inter_w;
dados_regra_preco_pos_estab_p.ie_retificador_vl_prestador := ie_retificador_vl_prestador_w;
dados_regra_preco_pos_estab_p.ie_retificador_vl_sem_preco := ie_retificador_vl_sem_preco_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_tipo_valor_pos_estab ( dados_conta_pos_p pls_cta_valorizacao_pck.dados_conta_pos, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dados_regra_preco_pos_estab_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_pos_estab) FROM PUBLIC;

