-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_reschedule (NR_SEQUENCIA_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

NR_SEQUENCIA_W bigint;
NR_SEQ_SUITE_W bigint;
NR_SEQ_PRESET_W bigint;
NR_SEQ_URL_W bigint;
NR_SEQ_BROWSER_W bigint;
NR_SEQ_SERVICE_W bigint;
NR_SEQ_ROBOT_W bigint;
NR_SEQ_GRID_W bigint;
NR_SEQ_PACKAGE_W bigint;
IE_RUNTYPE_W smallint;
NM_USUARIO_NREC_W varchar(15);
QTD_W bigint;
QTD_W2 bigint;
DS_VERSION_W varchar(255);


BEGIN
  --procedure that duplicate schedule  
  INSERT INTO SCHEM_TEST_BEHOLDER(nr_sequencia, nm_usuario, dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec, ds_interaction, ds_param_a)
	VALUES (nextval('schem_test_beholder_seq'), NM_USUARIO_P, clock_timestamp(), 'Robot', clock_timestamp(), 'SCHEMATIC4TEST_RESCHEDULE',
	'NR_SEQUENCIA_P as '||NR_SEQUENCIA_P);

  SELECT schedule.NR_SEQUENCIA NR_SEQUENCIA, schedule.NR_SEQ_SUITE NR_SEQ_SUITE, suite.NR_SEQ_PRESET NR_SEQ_PRESET, schedule.NR_SEQ_URL NR_SEQ_URL, schedule.NR_SEQ_SERVICE NR_SEQ_SERVICE, schedule.NR_SEQ_BROWSER NR_SEQ_BROWSER, schedule.NR_SEQ_PACKAGE NR_SEQ_PACKAGE, schedule.NM_USUARIO_NREC, schedule.DS_VERSION
      INTO STRICT NR_SEQUENCIA_W, NR_SEQ_SUITE_W, NR_SEQ_PRESET_W, NR_SEQ_URL_W, NR_SEQ_SERVICE_W, NR_SEQ_BROWSER_W, NR_SEQ_PACKAGE_W, NM_USUARIO_NREC_W, DS_VERSION_W
  FROM SCHEM_TEST_SCHEDULE schedule 
  INNER JOIN SCHEM_TEST_SUITE suite ON (schedule.NR_SEQ_SUITE = suite.NR_SEQUENCIA) 
  INNER JOIN SCHEM_TEST_PRESET preset ON (suite.NR_SEQ_PRESET = preset.NR_SEQUENCIA) 
  INNER JOIN SCHEM_TEST_GRID grid ON (preset.NR_SEQ_GRID = grid.NR_SEQUENCIA) 
  WHERE schedule.NR_SEQUENCIA = NR_SEQUENCIA_P;
                        
  IF (NR_SEQUENCIA_W IS NOT NULL AND NR_SEQUENCIA_W::text <> '') THEN       
    INSERT INTO SCHEM_TEST_SCHEDULE(nr_sequencia, dt_schedule, ie_status, nm_owner, nr_seq_suite, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_url, nr_seq_service, nr_seq_browser, ie_jobs, nr_seq_package, ds_version)
					VALUES (nextval('schem_test_schedule_seq'), clock_timestamp(), '1', NM_USUARIO_P, NR_SEQ_SUITE_W, clock_timestamp(), NM_USUARIO_P, clock_timestamp(), NM_USUARIO_P, NR_SEQ_URL_W, NR_SEQ_SERVICE_W, NR_SEQ_BROWSER_W, '0', NR_SEQ_PACKAGE_W, DS_VERSION_W);
    COMMIT;

    SELECT COUNT(NR_SEQUENCIA)
        INTO STRICT QTD_W
    FROM SCHEM_TEST_SCHEDULE
    WHERE NR_SEQ_PACKAGE = NR_SEQ_PACKAGE_W
    AND IE_STATUS NOT IN ('2','3','4','5','6','7')
    AND IE_JOBS NOT IN ('1','2');

    IF (QTD_W = 1) THEN
        SELECT COUNT(NR_SEQUENCIA)
            INTO STRICT QTD_W2
        FROM SCHEM_TEST_PACKAGE_SCHED
        WHERE NR_SEQUENCIA = NR_SEQ_PACKAGE_W
        AND IE_STATUS = '2';

        IF (QTD_W2 = 0) THEN
           UPDATE SCHEM_TEST_PACKAGE_SCHED SET IE_STATUS = '1' WHERE NR_SEQUENCIA = NR_SEQ_PACKAGE_W;
           COMMIT;
        END IF;
    END IF;
  END IF;
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_reschedule (NR_SEQUENCIA_P bigint, NM_USUARIO_P text) FROM PUBLIC;

