-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_planej_orc_gpi ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


nr_seq_gpi_orc_w        gpi_orcamento.nr_sequencia%type;
nr_seq_proj_gpi_ww      gpi_projeto.nr_sequencia%type;
nr_seq_gpi_orc_item_w   gpi_orc_item.nr_sequencia%type;
ex_continue             exception;

c_planej_orc_material CURSOR FOR
SELECT  a.nr_seq_proj_gpi,
        a.dt_referencia,
        a.cd_conta_contabil,
        a.cd_material,
        a.cd_centro_custo,
        a.cd_conta_financ,
        a.cd_cnpj,
        coalesce(gpi_obter_conta(a.cd_empresa,clock_timestamp(),a.cd_material), 0) nr_seq_plano,
        a.cd_empresa,
        sum(a.vl_planej) vl_planej,
        sum(a.qt_planej) qt_planej
from    ctb_planej_orc_material_v a
where   a.nr_seq_planej = nr_seq_planej_p
and     (a.nr_seq_proj_gpi IS NOT NULL AND a.nr_seq_proj_gpi::text <> '')
group by a.nr_seq_proj_gpi,
         a.dt_referencia,
         a.cd_conta_contabil,
         a.cd_material,
         a.cd_centro_custo,
         a.cd_cnpj,
         a.cd_conta_financ,
         a.cd_empresa
order by 1 desc;

type t_planej_orc_material is table of c_planej_orc_material%rowtype index by integer;
v_planej_orc_material_w t_planej_orc_material;

BEGIN

delete
from    gpi_orc_item a
where   a.nr_seq_orcamento in (
    SELECT  nr_sequencia
    from    gpi_orcamento b
    where   b.nr_seq_planej_orc = nr_seq_planej_p
);

open c_planej_orc_material;
loop fetch c_planej_orc_material bulk collect into v_planej_orc_material_w limit 1000;
    for i in 1 .. v_planej_orc_material_w.count loop
    begin

        if (coalesce(v_planej_orc_material_w[i].nr_seq_plano,0) = 0) then
            select  max(a.nr_sequencia)
            into STRICT    v_planej_orc_material_w[i].nr_seq_plano
            from    gpi_plano a
            where   a.cd_conta_contabil = v_planej_orc_material_w[i].cd_conta_contabil
            and     a.cd_empresa = v_planej_orc_material_w[i].cd_empresa
            and     a.ie_situacao = 'A';

            if (coalesce(v_planej_orc_material_w[i].nr_seq_plano,0) = 0) then
                raise ex_continue;
            end if;

        end if;

        if ((v_planej_orc_material_w[i].nr_seq_proj_gpi <> nr_seq_proj_gpi_ww) or (coalesce(nr_seq_proj_gpi_ww::text, '') = '')) then
            begin
            nr_seq_proj_gpi_ww := v_planej_orc_material_w[i].nr_seq_proj_gpi;

            begin
            select  a.nr_sequencia
            into STRICT    nr_seq_gpi_orc_w
            from    gpi_orcamento a
            where   a.nr_seq_planej_orc     = nr_seq_planej_p
            and     a.nr_seq_projeto        = nr_seq_proj_gpi_ww;
            exception
                when others then
                    nr_seq_gpi_orc_w := null;
            end;

            if (coalesce(nr_seq_gpi_orc_w::text, '') = '') then

                select  nextval('gpi_orcamento_seq')
                into STRICT    nr_seq_gpi_orc_w
;

                insert into gpi_orcamento(
                    nr_sequencia,
                    nr_seq_projeto,
                    nr_seq_planej_orc,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    ds_orcamento,
                    dt_orcamento,
                    ie_preliminar_definitivo,
                    ie_situacao,
                    ie_prioridade
                ) values (
                    nr_seq_gpi_orc_w,
                    nr_seq_proj_gpi_ww,
                    nr_seq_planej_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    wheb_mensagem_pck.get_texto(1116051), -- Planejamento Orcamentario
                    clock_timestamp(),
                    'P',
                    'A',
                    'N'
                );
            end if;
            end;
        end if;

        update  gpi_orc_item a
        set     a.vl_orcado         = a.vl_orcado + v_planej_orc_material_w[i].vl_planej,
                a.qt_item           = a.qt_item + v_planej_orc_material_w[i].qt_planej,
                a.vl_unitario       = dividir((a.vl_orcado + v_planej_orc_material_w[i].vl_planej), (a.qt_item + v_planej_orc_material_w[i].qt_planej)),
                a.dt_atualizacao    = clock_timestamp(),
                a.nm_usuario        = nm_usuario_p
        where   a.nr_seq_orcamento  = nr_seq_gpi_orc_w
        and     a.nr_seq_plano      = v_planej_orc_material_w[i].nr_seq_plano
        and     a.cd_material       = v_planej_orc_material_w[i].cd_material
        and     a.cd_centro_custo   = v_planej_orc_material_w[i].cd_centro_custo
        and     a.dt_mes_referencia = v_planej_orc_material_w[i].dt_referencia
        and     coalesce(a.cd_conta_financ,0) = coalesce(v_planej_orc_material_w[i].cd_conta_financ,0);

        if (NOT FOUND and v_planej_orc_material_w[i].vl_planej > 0) then

            select  nextval('gpi_orc_item_seq')
            into STRICT    nr_seq_gpi_orc_item_w
;

            insert into gpi_orc_item(
                nr_sequencia,
                nr_seq_orcamento,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_plano,
                vl_orcado,
                vl_realizado,
                cd_material,
                qt_item,
                vl_unitario,
                cd_centro_custo,
                ds_fornecedor,
                dt_mes_referencia,
                ie_situacao,
                cd_conta_financ
            ) values (
                nr_seq_gpi_orc_item_w,
                nr_seq_gpi_orc_w,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                v_planej_orc_material_w[i].nr_seq_plano,
                v_planej_orc_material_w[i].vl_planej,
                0,
                v_planej_orc_material_w[i].cd_material,
                v_planej_orc_material_w[i].qt_planej,
                dividir(v_planej_orc_material_w[i].vl_planej, v_planej_orc_material_w[i].qt_planej),
                v_planej_orc_material_w[i].cd_centro_custo,
                obter_nome_pj(v_planej_orc_material_w[i].cd_cnpj),
                v_planej_orc_material_w[i].dt_referencia,
                'A',
                v_planej_orc_material_w[i].cd_conta_financ
            );

        end if;
    exception
      when ex_continue then
        null;
    end;
    end loop;
EXIT WHEN NOT FOUND; /* apply on c_planej_orc_material */
end loop;
close c_planej_orc_material;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_planej_orc_gpi ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

