-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_consistir_fenotipagem ( sql_item_p text, nr_seq_reserva_p bigint, ie_opcao_p text, ds_mensagem_p INOUT text, ie_bloqueia_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


/*
ie_opcao_p
 1 - GERAR TRANSFUSÃO
 2 - INSERIR HEMOCOMPONENTE NA RESERVA
*/
DS_D_w			varchar(10);
DS_C_w			varchar(10);
DS_E_w			varchar(10);
DS_C_MIN_w		varchar(10);
DS_E_MIN_w		varchar(10);
DS_F_MIN_w		varchar(10);
DS_CW_w			varchar(10);
DS_K_w			varchar(10);
DS_K_MIN_w		varchar(10);
DS_KPA_w		varchar(10);
DS_KPB_w		varchar(10);
DS_JSA_w		varchar(10);
DS_JSB_w		varchar(10);
DS_FYA_w		varchar(10);
DS_FYB_w		varchar(10);
DS_JKA_w		varchar(10);
DS_JKB_w		varchar(10);
DS_LEA_w		varchar(10);
DS_LEB_w		varchar(10);
DS_S_w			varchar(10);
DS_S_MIN_w		varchar(10);
DS_M_w			varchar(10);
DS_N_w			varchar(10);
DS_P1_w			varchar(10);
DS_LUA_w		varchar(10);
DS_LUB_w		varchar(10);
DS_DIA_w		varchar(10);

lista_producao_w	dbms_sql.varchar2_table;
nr_seq_producao_w	bigint;
ie_bloqueia_w		varchar(1);
ie_existe_fenotipo_w	varchar(1);
nr_Seq_fenotipo_w	bigint;
ds_mensagem_w		varchar(32767);
ds_derivado_w		varchar(250);

c01 CURSOR FOR
	SELECT	ds_d,
		DS_C,
		DS_E, 
		DS_C_MIN, 
		DS_E_MIN, 
		DS_F_MIN, 
		DS_CW, 
		DS_K, 
		DS_K_MIN, 
		DS_KPA, 
		DS_KPB, 
		DS_JSA, 
		DS_JSB, 
		DS_FYA, 
		DS_FYB, 
		DS_JKA, 
		DS_JKB, 
		DS_LEA, 
		DS_LEB, 
		DS_S, 
		DS_S_MIN, 
		DS_M, 
		DS_N, 
		DS_P1, 
		DS_LUA, 
		DS_LUB, 
		DS_DIA,
		c.ds_derivado
	FROM	san_producao a,
		san_result_fenotipagem b,
		san_derivado c
	WHERE	a.nr_Seq_doacao = b.nr_Seq_doacao
	AND	c.nr_sequencia	= a.nr_seq_derivado
	AND	a.nr_Sequencia 	= nr_seq_producao_w
    AND (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
    AND coalesce(b.dt_inativacao::text, '') = '';

c02 CURSOR FOR
	SELECT	distinct
		d.ie_fenotipo
	from  	san_exame_lote a,
		san_exame_realizado b,
		san_exame_anticorpos c,
		san_anticorpos d
	where	a.nr_Seq_Reserva	= nr_seq_reserva_p
	and	a.nr_sequencia 		= b.nr_seq_exame_lote
	and	b.nr_seq_exame_lote 	= c.nr_seq_exame_lote
	and	c.nr_seq_anticorpo 	= d.nr_sequencia
	and	c.ie_resultado 		= 'S'
	and	coalesce(c.ie_anti_nao_identificado,'N') = 'N';

BEGIN

lista_producao_w := obter_lista_string(sql_item_p, ',');

for	i in lista_producao_w.first..lista_producao_w.last loop
	nr_seq_producao_w := (lista_producao_w(i))::numeric;

	if (coalesce(nr_seq_producao_w,0) > 0) then
		open c02;
		loop
		fetch c02 into nr_Seq_fenotipo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			open C01;
			loop
			fetch C01 into	
				DS_D_W,DS_C_w, DS_E_w, DS_C_MIN_w, DS_E_MIN_w, DS_F_MIN_w, DS_CW_w, DS_K_w, DS_K_MIN_w, DS_KPA_w, DS_KPB_w, DS_JSA_w, DS_JSB_w, DS_FYA_w, DS_FYB_w, DS_JKA_w, DS_JKB_w, DS_LEA_w, DS_LEB_w, DS_S_w, DS_S_MIN_w, DS_M_w,
				DS_N_w, DS_P1_w, DS_LUA_w, DS_LUB_w, DS_DIA_w,ds_derivado_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				ie_existe_fenotipo_w := 'N';
				if (nr_Seq_fenotipo_w = 0) and (ds_d_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 1) and (ds_c_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 2) and (ds_e_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 3) and (ds_c_min_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 4) and (ds_e_min_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 5) and (ds_f_min_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 6) and (ds_cw_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 7) and (ds_k_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 8) and (ds_k_min_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 9) and (ds_kpa_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 10) and (ds_kpb_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 11) and (ds_jsa_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 12) and (ds_jsb_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 13) and (ds_fya_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 14) and (ds_fyb_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 15) and (ds_jka_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 16) and (ds_jkb_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 17) and (ds_lea_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 18) and (ds_leb_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 19) and (ds_s_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 20) and (ds_s_min_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 21) and (ds_m_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 22) and (ds_n_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 23) and (ds_p1_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 24) and (ds_lua_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 25) and (ds_lub_w = '1') then
					ie_existe_fenotipo_w := 'S';
				elsif (nr_Seq_fenotipo_w = 26) and (ds_dia_w = '1') then
					ie_existe_fenotipo_w := 'S';
				end if;					

				if (ie_existe_fenotipo_w = 'S') then
					if (ie_opcao_p = '1') then -- GERAR TRANSFUSÃO
						ds_mensagem_w := Wheb_mensagem_pck.get_texto(353338, 'DS_DERIVADO_W='||ds_derivado_w); -- Existem fenótipos positivos na bolsa #@DS_DERIVADO_W#@ que não são compatíveis com o PAI do receptor. Favor verificar!;
						ie_bloqueia_w := 'S';
					elsif (ie_opcao_p = '2') then -- INSERIR HEMOCOMPONENTE NA RESERVA
						ds_mensagem_w := Wheb_mensagem_pck.get_texto(353444, 'DS_DERIVADO_W='||ds_derivado_w); -- Existem fenótipos positivos na bolsa #@DS_DERIVADO_W#@ que não são compatíveis com o PAI do receptor. Deseja continuar?
						ie_bloqueia_w := 'N';
					end if;

				else
					ie_bloqueia_w := 'N';
				end if;
				end;
			end loop;
			close C01;
		end loop;
		close c02;
	end if;
end loop;

ds_mensagem_p	:= ds_mensagem_w;
ie_bloqueia_p	:= ie_bloqueia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_consistir_fenotipagem ( sql_item_p text, nr_seq_reserva_p bigint, ie_opcao_p text, ds_mensagem_p INOUT text, ie_bloqueia_p INOUT text, nm_usuario_p text) FROM PUBLIC;

