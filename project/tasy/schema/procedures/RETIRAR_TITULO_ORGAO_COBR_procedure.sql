-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE retirar_titulo_orgao_cobr ( nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
ds_historico_w		varchar(255);
qt_w			bigint;

c01 CURSOR FOR
	SELECT	nr_titulo,
		nr_seq_orgao_cobr,
		nr_seq_cobranca
	from	titulo_receber_orgao_cobr
	where	ie_selecionado = 'S'
	and 	coalesce(dt_liberacao_exclusao::text, '') = ''
	and 	coalesce(nr_seq_lote::text, '') = '';

vet01	c01%RowType;


BEGIN

select	count(*)
into STRICT	qt_w
from	titulo_receber_orgao_cobr
where	ie_selecionado = 'S';

if (qt_w = 0)then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(682121);
end if;

select	count(*)
into STRICT	qt_w
from	titulo_receber_orgao_cobr
where	ie_selecionado = 'S'
and ((dt_liberacao_exclusao IS NOT NULL AND dt_liberacao_exclusao::text <> '')
or 	(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> ''));

if (qt_w > 0)then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(338753);
end if;

open c01;
loop
fetch c01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	update	cobranca_orgao
	set	dt_retirada = clock_timestamp()
	where	nr_seq_cobranca = vet01.nr_seq_cobranca
	and 	nr_seq_orgao = vet01.nr_seq_orgao_cobr;

	ds_historico_w := wheb_mensagem_pck.get_texto(337773, 'NM_USUARIO=' || nm_usuario_p || ';NR_TITULO=' || vet01.nr_titulo || ';DT_ATUALIZACAO=' || to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss'));
	CALL gerar_historico_cobr_orgao(vet01.nr_titulo,null,null,ds_historico_w,nm_usuario_p,'P');

	end;
end loop;
close c01;

delete
from 	titulo_receber_orgao_cobr a
where 	a.ie_selecionado = 'S'
and 	coalesce(dt_liberacao_exclusao::text, '') = ''
and 	coalesce(nr_seq_lote::text, '') = '';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE retirar_titulo_orgao_cobr ( nm_usuario_p text) FROM PUBLIC;

