-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tasy_gerar_solicitacao ( cd_pessoa_fisica_p bigint, ie_processo_p text) AS $body$
DECLARE


nm_campo_w		varchar(255);
vl_campo_ant_w		varchar(255);
vl_campo_novo_w		varchar(255);
nm_usuario_w		varchar(15);
i_w			bigint;
nr_seq_tasy_solic_alt_w	bigint;

C01 CURSOR FOR
	SELECT	nm_campo,
		vl_campo_ant,
		vl_campo_novo,
		nm_usuario
	from	pessoa_fisica_solic_alt
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;


BEGIN

i_w	:= 0;
open C01;
loop
fetch C01 into
	nm_campo_w,
	vl_campo_ant_w,
	vl_campo_novo_w,
	nm_usuario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (i_w = 0) then
		select	nextval('tasy_solic_alteracao_seq')
		into STRICT	nr_seq_tasy_solic_alt_w
		;

		insert into tasy_solic_alteracao(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec, ie_processo, ie_tipo_solicitacao,
				cd_funcao, cd_estabelecimento, ie_status)
		values (	nr_seq_tasy_solic_alt_w,clock_timestamp(),nm_usuario_w,clock_timestamp(),nm_usuario_w, ie_processo_p, 'B',
				wheb_usuario_pck.get_cd_funcao, wheb_usuario_pck.get_cd_estabelecimento, 'A');
	end if;

	insert into tasy_solic_alt_campo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_solicitacao,nm_tabela,nm_atributo,ie_status,ds_valor_old,ds_valor_new,ds_observacao,ds_chave_simples)
	values (	nextval('tasy_solic_alt_campo_seq'),clock_timestamp(),nm_usuario_w,clock_timestamp(),nm_usuario_w,
			nr_seq_tasy_solic_alt_w,'PESSOA_FISICA',nm_campo_w,'P',vl_campo_ant_w,vl_campo_novo_w,'PESSOA_FISICA_UPDATE',cd_pessoa_fisica_p);

	i_w	:= i_w + 1;
	end;
end loop;
close C01;

delete	FROM pessoa_fisica_solic_alt
where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tasy_gerar_solicitacao ( cd_pessoa_fisica_p bigint, ie_processo_p text) FROM PUBLIC;

