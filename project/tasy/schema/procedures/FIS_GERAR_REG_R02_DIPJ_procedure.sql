-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_reg_r02_dipj ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
 
cd_cnpj_w		varchar(14);
ds_fantasia_w		varchar(255);
ds_logradouro_w		varchar(255);
nr_endereco_w		varchar(255);
ds_complemento_w	varchar(255);
ds_bairro_w		varchar(255);
sg_estado_w		varchar(2);
cd_municipio_w		varchar(80);
cd_cep_w		varchar(255);
nr_ddd_telefone_w	varchar(255);
nr_telefone_w		varchar(255);
nr_ddd_fax_w		varchar(255);
nr_fax_w		varchar(255);
nr_caixa_postal_w	varchar(255);
uf_caixa_postal_w	varchar(255);
nr_cep_caixa_postal_w	varchar(255);
ds_email_w		varchar(255);

nr_linha_w		bigint	:= qt_linha_p;
nr_seq_registro_w	bigint	:= nr_sequencia_p;
ds_arquivo_w		varchar(4000);
ds_arquivo_compl_w	varchar(4000);
ds_linha_w		varchar(8000);
sep_w			varchar(1)	:= '|';
ie_arquivo_w		varchar(15);
cd_atividade_federal_w	estabelecimento.cd_atividade_federal%TYPE;

c01 CURSOR FOR 
	SELECT a.cd_cgc cd_cnpj, 
		substr(obter_nome_empresa(a.cd_empresa),1,80) ds_fantasia, 
		--substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,80) ds_fantasia, 
		substr(obter_dados_pf_pj(null,a.cd_cgc,'R'),1,255) ds_logradouro, 
		substr(obter_dados_pf_pj(null,a.cd_cgc,'NR'),1,255) nr_endereco, 
		substr(obter_dados_pf_pj(null,a.cd_cgc,'CO'),1,255) ds_complemento, 
		substr(obter_dados_pf_pj(null,a.cd_cgc,'B'),1,255) ds_bairro, 
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'UF'),1,2) sg_estado, 
		obter_tom_municipio_ibge(substr(obter_dados_pf_pj(null, a.cd_cgc, 'CDM'),1,6)) cd_municipio, 
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'CEP'),1,8) cd_cep, 
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'DDT'),1,4) nr_ddd_telefone, 
		substr(replace(obter_dados_pf_pj(null, a.cd_cgc, 'T'),'-',''),1,9) nr_telefone, 
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'DDF'),1,4) nr_ddd_fax, 
		substr(obter_dados_pf_pj(null, a.cd_cgc, 'FAX'),1,9) nr_fax, 
		' ' nr_caixa_postal, 
		' ' uf_caixa_postal, 
		' ' nr_cep_caixa_postal, 
		substr(coalesce(obter_dados_pf_pj(null, a.cd_cgc, 'M'),obter_dados_pf_pj_estab(a.cd_estabelecimento,null, a.cd_cgc, 'M')),1,115) ds_email, 
		substr(somente_numero(cd_atividade_federal),1,7) 
	from	estabelecimento a 
	where	a.cd_estabelecimento = cd_estabelecimento_p;


BEGIN 
open c01;
loop 
fetch c01 into	 
	cd_cnpj_w, 
	ds_fantasia_w, 
	ds_logradouro_w, 
	nr_endereco_w, 
	ds_complemento_w, 
	ds_bairro_w, 
	sg_estado_w, 
	cd_municipio_w, 
	cd_cep_w, 
	nr_ddd_telefone_w, 
	nr_telefone_w, 
	nr_ddd_fax_w, 
	nr_fax_w, 
	nr_caixa_postal_w, 
	uf_caixa_postal_w, 
	nr_cep_caixa_postal_w, 
	ds_email_w, 
	cd_atividade_federal_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	 
	ds_linha_w	:= substr(	'R02' 						|| 
					' '						|| 
					rpad('0',4,'0')					|| 
					cd_cnpj_w 					|| 
					'0'						|| 
					'0'		 				|| 
					rpad(coalesce(ds_fantasia_w,' '),150,' ')		|| 
					'2062'						|| 
					lpad(coalesce(cd_atividade_federal_w, '0'),7,'0')	|| 
					'33'						|| 
					rpad(coalesce(ds_logradouro_w,' '),150,' ') 		|| 
					rpad(coalesce(nr_endereco_w,' '),6,' ')		|| 
					rpad(coalesce(ds_complemento_w,' '),50,' ')		|| 
					rpad(coalesce(ds_bairro_w,' '),50,' ')		|| 
					rpad(coalesce(sg_estado_w,' '),2,' ') 		|| 
					lpad(coalesce(cd_municipio_w, '0'),4,'0')		|| 
					lpad(coalesce(cd_cep_w,'0'),8,'0')			|| 
					rpad(coalesce(nr_ddd_telefone_w,' '),4,' ')		|| 
					rpad(coalesce(nr_telefone_w,' ') ,9,' ')		|| 
					rpad(coalesce(nr_ddd_fax_w,' '),4,' ')		|| 
					rpad(coalesce(nr_fax_w,' '),9,' ')			|| 
					rpad(coalesce(nr_caixa_postal_w,' '),6,' ')		|| 
					rpad(coalesce(uf_caixa_postal_w,' '),2,' ')		|| 
					rpad(coalesce(nr_cep_caixa_postal_w,' '),8,' ')	|| 
					rpad(coalesce(ds_email_w,' '),115,' ')		|| 
					rpad(' ',10,' '),1,8000);
	 
	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w 			:= nr_linha_w + 1;
	 
	insert into fis_dipj_registro(nr_sequencia, 
		nm_usuario, 
		dt_atualizacao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec, 
		nr_seq_controle_dipj, 
		nr_linha, 
		cd_registro, 
		ds_arquivo, 
		ds_arquivo_compl) 
	values (nr_seq_registro_w, 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_controle_p, 
		nr_linha_w, 
		'R02', 
		ds_arquivo_w, 
		ds_arquivo_compl_w);
	end;
end loop;
close c01;
 
commit;
 
qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_reg_r02_dipj ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

