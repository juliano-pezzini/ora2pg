-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dose_um_horario_pmh ( cd_material_p bigint, qt_dose_prescr_p bigint, cd_unid_med_dose_prescr_p text, qt_dose_hor_p INOUT bigint, cd_unid_med_dose_hor_p INOUT text) AS $body$
DECLARE


cd_unidade_medida_consumo_w	varchar(30);
cd_unidade_medida_processo_w	varchar(30);
qt_dose_unid_med_consumo_w	double precision;
qt_conversao_processo_w		double precision;

qt_dose_hor_ml_w		double precision;
qt_dose_hor_consumo_w	double precision;
cd_unid_med_consumo_w	varchar(30);
qt_dose_hor_w		double precision;
cd_unid_med_dose_hor_w	varchar(30);

cd_estabelecimento_w	smallint := wheb_usuario_pck.get_cd_estabelecimento;
sql_w                   varchar(200);

BEGIN
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	select	max(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30))
	into STRICT	cd_unidade_medida_consumo_w
	from	material
	where	cd_material	=  cd_material_p;

	select	max(cd_unid_med_processo)
	into STRICT	cd_unidade_medida_processo_w
	from	unidade_medida
	where	cd_unidade_medida	= cd_unidade_medida_consumo_w;

	select	max(obter_conversao_unid_med_cons(cd_material_p, cd_unid_med_dose_prescr_p, qt_dose_prescr_p))
	into STRICT	qt_dose_unid_med_consumo_w
	;

	select	coalesce(max(qt_conversao),0)
	into STRICT	qt_conversao_processo_w
	from	material_conversao_unidade
	where	cd_material		= cd_material_p
	and	cd_unidade_medida	= cd_unidade_medida_processo_w;

    

    BEGIN

    sql_w := 'begin obter_unid_med_dose_hor_md (:1, :2, :3, :4, :5, :6); end;';

    EXECUTE sql_w  USING IN qt_conversao_processo_w, 
                                   IN qt_dose_unid_med_consumo_w, 
                                   IN cd_unidade_medida_processo_w,
                                   IN cd_unidade_medida_consumo_w, 
                                   OUT qt_dose_hor_w,
                                   OUT cd_unid_med_dose_hor_w;

    EXCEPTION
    WHEN OTHERS THEN
       qt_dose_hor_w := null;
       cd_unid_med_dose_hor_w := null;
    END;

    


end if;

qt_dose_hor_p		:= qt_dose_hor_w;
cd_unid_med_dose_hor_p	:= cd_unid_med_dose_hor_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dose_um_horario_pmh ( cd_material_p bigint, qt_dose_prescr_p bigint, cd_unid_med_dose_prescr_p text, qt_dose_hor_p INOUT bigint, cd_unid_med_dose_hor_p INOUT text) FROM PUBLIC;

