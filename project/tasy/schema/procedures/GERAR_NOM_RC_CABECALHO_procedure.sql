-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_cabecalho ( nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_oid_sistema_w		nom_rc_cabecalho.ds_oid%type;
nm_oid_doc_w	nom_rc_cabecalho.ds_oid%type;
ds_oid_doc_w	nom_rc_cabecalho.ds_oid%type;
nr_identificador_w		nom_rc_cabecalho.nr_identificador%type;
nm_sistema_w			nom_rc_cabecalho.nm_sistema%type;
ds_titulo_w				nom_rc_cabecalho.ds_titulo%type;
dt_criacao_documento_w	nom_rc_cabecalho.dt_criacao_documento%type;
ds_oid_doc_base_w		nom_rc_cabecalho.ds_oid_doc_base%type;
nr_ident_doc_base_w		nom_rc_cabecalho.nr_ident_doc_base%type;
nm_sistema_doc_base_w	nom_rc_cabecalho.nm_sistema_doc_base%type;
nr_versao_doc_w			nom_rc_cabecalho.nr_versao_doc%type;
nr_atendimento_w		nom_rc_cabecalho.nr_atendimento%type;
nr_seq_episodio_w		nom_rc_cabecalho.nr_seq_episodio%type;
ds_solic_trans_externa_w	solic_transf_externa.ds_observacao%type;
cd_estabelecimento_W nom_rc_cabecalho.cd_estabelecimento%type;


BEGIN

select	'Resumen Cl√≠nico',
		clock_timestamp(),
		nr_atendimento,
		nr_seq_episodio,
		nr_sequencia,
		cd_estabelecimento
into STRICT	ds_titulo_w,
		dt_criacao_documento_w,
		nr_atendimento_w,
		nr_seq_episodio_w,
		nr_identificador_w,
		cd_estabelecimento_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	min(a.nr_sequencia)
	into STRICT	nr_ident_doc_base_w
	from	nom_rc_cabecalho a
	where	a.nr_atendimento = nr_atendimento_w;
	
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	min(a.nr_sequencia)
	into STRICT	nr_ident_doc_base_w
	from	nom_rc_cabecalho a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;

if (nr_ident_doc_base_w IS NOT NULL AND nr_ident_doc_base_w::text <> '') then
	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
		select	count(1)
		into STRICT	nr_versao_doc_w
		from	nom_rc_cabecalho a
		where	a.nr_atendimento	= nr_atendimento_w;
	elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
		select	count(1)
		into STRICT	nr_versao_doc_w
		from	nom_rc_cabecalho a
		where	a.nr_seq_episodio	= nr_seq_episodio_w;
	end if;
end if;

select	max(ds_observacao)
into STRICT	ds_solic_trans_externa_w
from	solic_transf_externa
where	nr_atendimento = nr_atendimento_w
and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

ds_oid_doc_w			:= get_oid_details(9,'OID_NUMBER', 'NOM', cd_estabelecimento_w);
nm_sistema_w			:= get_oid_details(5,'OID_SHORTNAME','NOM', cd_estabelecimento_w);
ds_oid_doc_base_w		:= get_oid_details(9,'OID_NUMBER', 'NOM', cd_estabelecimento_w);
nm_sistema_doc_base_w	:= get_oid_details(5,'OID_SHORTNAME','NOM', cd_estabelecimento_w);

update	nom_rc_cabecalho
set		ds_oid					=	ds_oid_doc_w,
		nr_identificador		=	nr_identificador_w,
		nm_sistema				=	nm_sistema_w,
		ds_titulo				=	ds_titulo_w,
		dt_criacao_documento	=	dt_criacao_documento_w,
		ds_oid_doc_base			=	ds_oid_doc_base_w,
		nr_ident_doc_base		=	nr_ident_doc_base_w,
		nm_sistema_doc_base		=	nm_sistema_doc_base_w,
		nr_versao_doc			=	nr_versao_doc_w,
		ds_motivo				=	coalesce(ds_motivo,ds_solic_trans_externa_w),
		nm_usuario				=	nm_usuario_p,
		dt_atualizacao			=	clock_timestamp()
where	nr_sequencia			=	nr_seq_cabecalho_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_cabecalho ( nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

