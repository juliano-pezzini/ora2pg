-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_compra_orcamento ( nr_ordem_compra_p bigint, nm_usuario_p text, ie_mensal_p text default 'S', ie_anual_p text default 'N') AS $body$
DECLARE


nr_seq_mes_ref_w			bigint;
cd_estabelecimento_w		bigint;
vl_empenhado_w			double precision;
vl_orcado_w			double precision;
vl_liquido_w			double precision;
vl_diferenca_w			double precision;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w			integer;
ds_conta_contabil_w		varchar(255);
ds_centro_custo_w			varchar(255);
ds_observacao_w			varchar(4000);
nr_seq_texto_w			dic_objeto.nr_sequencia%type;
ie_mensal_w         varchar(5);
ie_anual_w          varchar(5);
					
c01 CURSOR FOR
SELECT	b.cd_centro_custo,
	b.cd_conta_contabil,
	substr(obter_desc_centro_custo(b.cd_centro_custo),1,255),
	substr(obter_desc_conta_contabil(b.cd_conta_contabil),1,255),
	coalesce(sum(b.vl_item_liquido),0)
from	ordem_compra_item b
where	b.nr_ordem_compra = nr_ordem_compra_p
group by b.cd_centro_custo,
	b.cd_conta_contabil;

BEGIN

delete from w_consist_orcamento_compra
where	ie_funcao = 'OC'
and	nr_documento = nr_ordem_compra_p;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_mes_ref_w
from	ctb_mes_ref
where	trunc(dt_referencia,'month') = trunc(clock_timestamp(),'month');

if (coalesce(ie_mensal_p::text, '') = '' and coalesce(ie_anual_p::text, '') = '') then
  ie_mensal_w := 'S';
  ie_anual_w := 'N';
else
  ie_mensal_w := ie_mensal_p;
  ie_anual_w := ie_anual_p;
end if;

if (nr_seq_mes_ref_w > 0) then
	begin
	
	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_p;
	
	open C01;
	loop
	fetch C01 into	
		cd_centro_custo_w,
		cd_conta_contabil_w,
		ds_centro_custo_w,
		ds_conta_contabil_w,
		vl_liquido_w;		
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		select	coalesce(ctb_obter_empenho_orcamento(nr_seq_mes_ref_w, cd_conta_contabil_w, cd_centro_custo_w, cd_estabelecimento_w),0)  vl_empenhado
		  into STRICT	vl_empenhado_w
		;
		
		For aux in 1..2 loop 
		
			vl_orcado_w := 0;
			vl_diferenca_w := 0;
		
			if (ie_mensal_w = 'S' and aux = 1) then
				
				select	coalesce(ctb_obter_valor_orcado(trunc(clock_timestamp(),'month'), cd_conta_contabil_w, cd_centro_custo_w, cd_estabelecimento_w),0) vl_orcado
				  into STRICT vl_orcado_w
				;
			
				nr_seq_texto_w := 298766;
			end if;
			
			if (ie_anual_w = 'S' and aux = 2) then
			
				select sum(coalesce(ctb_obter_valor_orcado(trunc(which_month,'month'), cd_conta_contabil_w, cd_centro_custo_w, cd_estabelecimento_w),0))
				  into STRICT vl_orcado_w
				  from (SELECT add_months(trunc(clock_timestamp(), 'YEAR'), rownum-1) which_month
						  from dic_objeto ORDER by which_month LIMIT (months_between(pkg_date_utils.end_of(clock_timestamp(), 'YEAR',0), add_months(pkg_date_utils.start_of(clock_timestamp(), 'YEAR',0), -1)))) alias14;
						
				nr_seq_texto_w := 1114712;
			
			end if;
			
			if (vl_orcado_w > 0) then
				vl_diferenca_w	:= vl_orcado_w - vl_empenhado_w - vl_liquido_w;
			else
				vl_diferenca_w := 0;
			end if;

			if (vl_diferenca_w < 0) then
			
				ds_observacao_w	:=	substr(	WHEB_MENSAGEM_PCK.get_texto(nr_seq_texto_w,
							'DS_CONTA_CONTABIL_W='||DS_CONTA_CONTABIL_W||
							';DS_CENTRO_CUSTO_W='||DS_CENTRO_CUSTO_W||
							';VL_ORCADO_W='||campo_mascara_virgula_casas(vl_orcado_w,4)||
							';VL_EMPENHADO_W='||campo_mascara_virgula_casas(vl_empenhado_w,4)||
							';VL_LIQUIDO_W='||campo_mascara_virgula_casas(vl_liquido_w,4)),1,4000);
								
							/*Atingiu o valor maximo orcado para essa conta contabil e para esse centro de custo.
							Conta contabil: #@DS_CONTA_CONTABIL_W#@
							Centro custo: #@DS_CENTRO_CUSTO_W#@
							Valor orcado: #@VL_ORCADO_W#@
							Valor empenhado: #@VL_EMPENHADO_W#@
							Valor compra: #@VL_LIQUIDO_W#@*/
				
				insert into w_consist_orcamento_compra(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ie_funcao,
					nr_documento,
					ds_consistencia,
					ds_observacao)
				values (	nextval('w_consist_orcamento_compra_seq'),
					clock_timestamp(),
					nm_usuario_p,
					'OC',
					nr_ordem_compra_p,
					Wheb_mensagem_pck.get_Texto(298767),
					ds_observacao_w);
			end if;
		end loop;
		end;
	end loop;
	close C01;	
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_compra_orcamento ( nr_ordem_compra_p bigint, nm_usuario_p text, ie_mensal_p text default 'S', ie_anual_p text default 'N') FROM PUBLIC;

