-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_visao_para_gwt ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_criado_p INOUT bigint, nm_tabela_p text default null) AS $body$
DECLARE

ie_componente_w	varchar(10);
nm_tabela_w		varchar(255);
nm_atributo_w	varchar(255);
nr_seq_visao_w	bigint;
qt_reg_w	bigint;

C01 CURSOR FOR
	SELECT	*
	from	tabela_visao
	where	nr_sequencia = nr_sequencia_p;


C02 CURSOR FOR
	SELECT	*
	from	TABELA_VISAO_ATRIBUTO
	where	nr_sequencia = nr_sequencia_p;

C03 CURSOR FOR
	SELECT	a.nm_atributo
	from	TABELA_VISAO_ATRIBUTO a,
			tabela_visao b,
			tabela_atributo c
	where	a.nr_sequencia = nr_seq_visao_w
	and		a.nr_sequencia = b.nr_sequencia
	and		c.nm_tabela = b.nm_tabela
	and		c.nm_atributo = a.nm_atributo
	and		c.IE_TIPO_ATRIBUTO = 'DATE';

c01_w c01%rowtype;
c02_w c02%rowtype;






BEGIN


if (coalesce(nr_sequencia_p,0) > 0) then




	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin


		select	nextval('tabela_visao_seq')
		into STRICT	nr_seq_visao_w
		;




		insert into TABELA_VISAO(
					 NR_SEQUENCIA,
					 NM_TABELA,
					 DT_ATUALIZACAO,
					 NM_USUARIO,
					 NM_VISAO,
					 DS_UTILIZACAO,
					 QT_POS_ESQUERDA,
					 QT_POS_TOPO,
					 QT_INTERVALO_CAMPO,
					 QT_MAX_CAMPO,
					 QT_ALTURA_PANEL,
					 QT_LARGURA_PANEL,
					 DT_ATUALIZACAO_NREC,
					 NM_USUARIO_NREC,
					 DS_TITULO,
					 DS_SQL_ATIVACAO,
					 CD_FUNCAO,
					 NR_SEQ_DIC_OBJ,
					 IE_UTILIZA_CAMPOS_VISAO,
					 DS_SQL_TOTALIZADOR,
					 IE_UTILIZACAO,
					 DS_CLASSE_JAVA_VALIDACAO,
					 NR_SEQ_OBJETO_WCPANEL,
					 DS_SQL_CUSTOMIZADO,
					 DS_TITULO_DETALHE,
					 CD_EXP_TITULO)
				values (
					 nr_seq_visao_w,
					 c01_w.NM_TABELA,
					 clock_timestamp(),
					 nm_usuario_p,
					 --HTML5 = 697701
           substr(obter_desc_expressao(697701) ||' - '||c01_w.NM_VISAO,1,50),
					 c01_w.DS_UTILIZACAO,
					 c01_w.QT_POS_ESQUERDA,
					 c01_w.QT_POS_TOPO,
					 c01_w.QT_INTERVALO_CAMPO,
					 c01_w.QT_MAX_CAMPO,
					 c01_w.QT_ALTURA_PANEL,
					 c01_w.QT_LARGURA_PANEL,
					 clock_timestamp(),
					 nm_usuario_p,
					 c01_w.DS_TITULO,
					 c01_w.DS_SQL_ATIVACAO,
					 c01_w.CD_FUNCAO,
					 c01_w.NR_SEQ_DIC_OBJ,
					 c01_w.IE_UTILIZA_CAMPOS_VISAO,
					 c01_w.DS_SQL_TOTALIZADOR,
					 'H',
					 c01_w.DS_CLASSE_JAVA_VALIDACAO,
					 c01_w.NR_SEQ_OBJETO_WCPANEL,
					 c01_w.DS_SQL_CUSTOMIZADO,
					 c01_w.DS_TITULO_DETALHE,
					 c01_w.CD_EXP_TITULO);
					nm_tabela_w	:= c01_w.NM_TABELA;


		open C02;
		loop
		fetch C02 into
			c02_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin


			select	max(ie_componente)
			into STRICT	ie_componente_w
			from	tabela_atributo
			where	nm_tabela	= nm_tabela_w
			and		nm_atributo = c02_w.nm_atributo;


			insert into TABELA_VISAO_ATRIBUTO(
				 NR_SEQUENCIA,
				 NM_ATRIBUTO,
				 DT_ATUALIZACAO,
				 NM_USUARIO,
				 NR_SEQ_APRESENT,
				 QT_TAM_DELPHI,
				 QT_TAM_GRID,
				 QT_DESLOC_DIREITA,
				 NR_SEQ_GRID,
				 NR_SEQ_TABSTOP,
				 DS_LABEL,
				 DS_LABEL_GRID,
				 VL_PADRAO,
				 DS_MASCARA,
				 IE_READONLY,
				 IE_TABSTOP,
				 QT_ALTURA,
				 CD_DOMINIO,
				 NR_SEQ_LOCALIZADOR,
				 DS_VALORES,
				 NR_SEQ_ORDEM,
				 QT_COLUNA,
				 DS_FILTER,
				 DS_LABEL_LONGO,
				 IE_CRIAR_DESCRICAO,
				 IE_OBRIGATORIO,
				 DS_COR,
				 IE_COMPONENTE,
				 NM_ATRIBUTO_PAI,
				 QT_TAM_FONTE,
				 DS_ESTILO_FONTE,
				 IE_APLICABILIDADE_ESTILO,
				 IE_DBL_CLICK_READONLY,
				 IE_TIPO_BOTAO,
				 IE_TOTALIZAR,
				 DS_COMANDO,
				 NR_LINHA,
				 NR_SEQ_VISAO_GRUPO,
				 CD_EXP_DESC,
				 CD_EXP_LABEL_GRID,
				 CD_EXP_VALORES,
				 CD_EXP_LABEL,
				 CD_EXP_LABEL_LONGO,
				 IE_UNIT_COL_WIDTH,
				 CD_MASCARA)
			values (
				 nr_seq_visao_w,
				 c02_w.NM_ATRIBUTO,
				 clock_timestamp(),
				 nm_usuario_p,
				 c02_w.NR_SEQ_APRESENT,
				 c02_w.QT_TAM_DELPHI,
				 c02_w.QT_TAM_GRID,
				 c02_w.QT_DESLOC_DIREITA,
				 c02_w.NR_SEQ_GRID,
				 c02_w.NR_SEQ_TABSTOP,
				 c02_w.DS_LABEL,
				 c02_w.DS_LABEL_GRID,
				 c02_w.VL_PADRAO,
				 c02_w.DS_MASCARA,
				 c02_w.IE_READONLY,
				 c02_w.IE_TABSTOP,
				 c02_w.QT_ALTURA,
				 c02_w.CD_DOMINIO,
				 c02_w.NR_SEQ_LOCALIZADOR,
				 c02_w.DS_VALORES,
				 c02_w.NR_SEQ_ORDEM,
				 c02_w.QT_COLUNA,
				 c02_w.DS_FILTER,
				 c02_w.DS_LABEL_LONGO,
				 c02_w.IE_CRIAR_DESCRICAO,
				 c02_w.IE_OBRIGATORIO,
				 c02_w.DS_COR,
				 coalesce(c02_w.IE_COMPONENTE,ie_componente_w),
				 c02_w.NM_ATRIBUTO_PAI,
				 c02_w.QT_TAM_FONTE,
				 c02_w.DS_ESTILO_FONTE,
				 c02_w.IE_APLICABILIDADE_ESTILO,
				 c02_w.IE_DBL_CLICK_READONLY,
				 c02_w.IE_TIPO_BOTAO,
				 c02_w.IE_TOTALIZAR,
				 c02_w.DS_COMANDO,
				 c02_w.NR_LINHA,
				 c02_w.NR_SEQ_VISAO_GRUPO,
				 c02_w.CD_EXP_DESC,
				 c02_w.CD_EXP_LABEL_GRID,
				 c02_w.CD_EXP_VALORES,
				 c02_w.CD_EXP_LABEL,
				 c02_w.CD_EXP_LABEL_LONGO,
				 'PX',
				 c02_w.CD_MASCARA);

			end;
		end loop;
		close C02;

		end;
	end loop;
	close C01;

elsif (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') then

	select	nextval('tabela_visao_seq')
	into STRICT	nr_seq_visao_w
	;

	insert into TABELA_VISAO(
		 nr_sequencia,
		 NM_TABELA,
		 DT_ATUALIZACAO,
		 NM_USUARIO,
		 NM_VISAO,
		 DS_UTILIZACAO,
		 QT_POS_ESQUERDA,
		 QT_POS_TOPO,
		 QT_INTERVALO_CAMPO,
		 QT_MAX_CAMPO,
		 QT_ALTURA_PANEL,
		 QT_LARGURA_PANEL,
		 DT_ATUALIZACAO_NREC,
		 NM_USUARIO_NREC,
		 IE_UTILIZACAO)
	values (
		 nr_seq_visao_w,
		 nm_tabela_p,
		 clock_timestamp(),
		 nm_usuario_p,
     --697701 = HTML5
        substr(obter_desc_expressao(697701),1,50),
		 null,
		 0,
		 0,
		 0,
		 350,
		 0,
		 0,
		 clock_timestamp(),
		 nm_usuario_p,
		 'H');

	insert into tabela_visao_atributo(nr_sequencia,
		nm_atributo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apresent,
		qt_tam_delphi,
		qt_tam_grid,
		qt_desloc_direita,
		nr_seq_grid,
		nr_seq_tabstop,
		ds_label,
		cd_exp_label,
		ds_label_grid,
		cd_exp_label_grid,
		vl_padrao,
		ds_mascara,
		ie_readonly,
		ie_tabstop,
		qt_altura,
		cd_dominio,
		nr_seq_localizador,
		ds_valores,
		cd_exp_valores,
		nr_seq_ordem,
		qt_coluna,
		ie_criar_descricao,
		ie_componente,
		nm_atributo_pai,
		ds_label_longo,
		cd_exp_label_longo,
		ds_cor,
		qt_tam_fonte,
		ds_estilo_fonte,
		ie_aplicabilidade_estilo,
		ie_tipo_botao,IE_UNIT_COL_WIDTH)
	(SELECT	nr_seq_visao_w,
		c.nm_atributo,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apresent,
		qt_tam_delphi,
		qt_tam_grid,
		qt_desloc_direita,
		nr_seq_grid,
		nr_seq_tabstop,
		ds_label,
		cd_exp_label,
		ds_label_grid,
		cd_exp_label_grid,
		vl_default,
		ds_mascara,
		ie_readonly,
		ie_tabstop,
		qt_altura,
		cd_dominio,
		nr_seq_localizador,
		ds_valores,
		cd_exp_valores,
		nr_seq_ordem,
		qt_coluna,
		ie_criar_descricao,
		ie_componente,
		nm_atributo_pai,
		ds_label_longo,
		cd_exp_label_longo,
		ds_cor,
		qt_tam_fonte,
		ds_estilo_fonte,
		ie_aplicabilidade_estilo,
		ie_tipo_botao,
		'PX'
	from	tabela_atributo c
	where	c.nm_tabela = nm_tabela_p);

end if;


insert into TABELA_SISTEMA_ATIVACAO(
			 NR_SEQUENCIA,
			 NM_USUARIO_NREC,
			 DT_ATUALIZACAO_NREC,
			 NM_USUARIO,
			 DT_ATUALIZACAO,
			 NM_TABELA,
			 NR_SEQ_VISAO,
			 DS_SQL)
SELECT	nextval('tabela_sistema_ativacao_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_tabela,
		nr_seq_visao_w,
		DS_SQL_ATIVACAO
from	tabela_visao
where	nr_sequencia	= nr_sequencia_p
and		(DS_SQL_ATIVACAO IS NOT NULL AND DS_SQL_ATIVACAO::text <> '');


insert into TABELA_SISTEMA_ATIVACAO(
			 NR_SEQUENCIA,
			 NM_USUARIO_NREC,
			 DT_ATUALIZACAO_NREC,
			 NM_USUARIO,
			 DT_ATUALIZACAO,
			 NM_TABELA,
			 NR_SEQ_VISAO,
			 DS_SQL)
SELECT	nextval('tabela_sistema_ativacao_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_tabela,
		nr_seq_visao_w,
		ds_sql
from	TABELA_SISTEMA_ATIVACAO
where	nr_seq_visao	= nr_sequencia_p;


open C03;
loop
fetch C03 into
	nm_atributo_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	update	tabela_visao_atributo
	set		IE_COMPONENTE = 'dtp'
	where	nr_sequencia = nr_seq_visao_w
	and		nm_atributo = nm_atributo_w;

	end;
end loop;
close C03;



select	count(*)
into STRICT	qt_reg_w
from	tabela_visao_atributo
where	nr_sequencia	= nr_seq_visao_w
and	nm_atributo	in ('DT_LIBERACAO','DT_INATIVACAO');


if (qt_reg_w	= 2) then

	update	TABELA_VISAO
	set	IE_LIBERA = 'S'
	where	nr_sequencia	= nr_seq_visao_w;

end if;


CALL Ajustar_Visao_GWT(nr_seq_visao_w,nm_usuario_p);
nr_seq_criado_p	:= nr_seq_visao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_visao_para_gwt ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_criado_p INOUT bigint, nm_tabela_p text default null) FROM PUBLIC;

