-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_protocolo_repasse (nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_interno_conta_w		bigint;
ie_repasse_mat_w		varchar(2);
ie_repasse_proc_w		varchar(2);
ie_tipo_convenio_w		integer;
cd_estabelecimento_w		integer;
nr_titulo_w			varchar(255);
nr_nota_fiscal_w		varchar(255);
cd_convenio_w			convenio.cd_convenio%type;
ie_repasse_proc_conv_w		convenio_estabelecimento.ie_repasse_proc%type;
ie_repasse_mat_conv_w		convenio_estabelecimento.ie_repasse_mat%type;
ie_ctb_online_w         varchar(1);
ie_geracao_w            ctb_regra_geracao_lote_rec.ie_geracao%type;

c01 CURSOR FOR
	SELECT	a.nr_interno_conta
	from	conta_paciente a
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p
	and (ie_repasse_mat_w	= 'P' or ie_repasse_proc_w		= 'P');


BEGIN

select	coalesce(c.ie_repasse_mat,'N'),
	coalesce(c.ie_repasse_proc,'N'),
	OBTER_TIPO_CONVENIO(a.cd_convenio),
	a.cd_estabelecimento,
	a.cd_convenio
into STRICT	ie_repasse_mat_w,
	ie_repasse_proc_w,
	ie_tipo_convenio_w,
	cd_estabelecimento_w,
	cd_convenio_w
from	parametro_faturamento c,
	protocolo_convenio a
where	a.cd_estabelecimento	= c.cd_estabelecimento
and	a.nr_seq_protocolo	= nr_seq_protocolo_p;

select	Obter_Valor_Conv_Estab(cd_convenio_w,cd_estabelecimento_w,'IE_REPASSE_PROC'),
	Obter_Valor_Conv_Estab(cd_convenio_w,cd_estabelecimento_w,'IE_REPASSE_MAT')
into STRICT	ie_repasse_proc_conv_w,
	ie_repasse_mat_conv_w
;

if (ie_repasse_proc_conv_w IS NOT NULL AND ie_repasse_proc_conv_w::text <> '') then
	ie_repasse_proc_w := ie_repasse_proc_conv_w;
end if;

if (ie_repasse_mat_conv_w IS NOT NULL AND ie_repasse_mat_conv_w::text <> '') then
	ie_repasse_mat_w := ie_repasse_mat_conv_w;
end if;

select	max(substr(obter_titulo_conta_protocolo(a.nr_seq_protocolo,0),1,254)),
	max(substr(obter_nota_conta_protocolo(a.nr_seq_protocolo,0),1,254))
into STRICT	nr_nota_fiscal_w,
	nr_titulo_w
from	protocolo_convenio a
where	a.nr_seq_protocolo	= nr_seq_protocolo_p;

-- Edgar 16/11/2006 OS 42066, utilizar regra de repasse de procedimentos do SUS
if (ie_tipo_convenio_w = 3) then
	select	coalesce(max(ie_repasse_proc), ie_repasse_proc_w)
	into STRICT	ie_repasse_proc_w
	from	sus_parametros
	where	cd_estabelecimento	= cd_estabelecimento_w;
end if;

/*Contabilizacao online repasse */

ie_geracao_w    := ctb_online_pck.get_geracao_lote_receita(cd_convenio_w, cd_estabelecimento_w, nm_usuario_p, ie_tipo_convenio_w);
ie_ctb_online_w := ctb_online_pck.get_modo_lote( 14, cd_estabelecimento_w);

if (ie_ctb_online_w = 'S' and ie_geracao_w = 'FPR') then
    CALL ctb_contab_onl_repasse( nr_seq_protocolo_p,null, null,nm_usuario_p, 2);
end if;

open	c01;
loop
fetch	c01 into
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_repasse_mat_w = 'P') or
		(ie_repasse_mat_w	= 'T' AND nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '' AND nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
		CALL DESFAZER_CONTA_PAC_REPASSE(nr_interno_conta_w, 'M', nm_usuario_p);
	end if;

	if (ie_repasse_proc_w = 'P') or
		(ie_repasse_proc_w  = 'T' AND nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '' AND nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
		CALL DESFAZER_CONTA_PAC_REPASSE(nr_interno_conta_w, 'P', nm_usuario_p);
	end if;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_protocolo_repasse (nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

