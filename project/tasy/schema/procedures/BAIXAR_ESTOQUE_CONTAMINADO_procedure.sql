-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_estoque_contaminado ( nr_cirurgia_p bigint, nm_usuario_p text, cd_local_estoque_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_material_w		   integer;
qt_dispensacao_w		  double precision;
cd_unidade_medida_w	  varchar(30);
nr_seq_lote_fornec_w	  bigint;
nr_atendimento_w		  bigint;
cd_setor_atendimento_w	  integer;
dt_entrada_unidade_w	  timestamp;
nr_sequencia_w		   bigint;
cd_local_estoque_w   	  bigint;
					
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
      cd_material, 
      qt_dispensacao, 
      cd_unidade_medida, 
      nr_seq_lote_fornec, 
      coalesce(cd_local_estoque,cd_local_estoque_p) 
	from	  cirurgia_agente_disp 
	where	  nr_cirurgia	=	nr_cirurgia_p 
	and	  ie_operacao	=	'P' 
	and	  obter_se_mat_baixa_estoque_cir(cd_material, coalesce(cd_local_estoque,cd_local_estoque_p), nr_cirurgia,0,0,0) is null 
	and	  coalesce(dt_baixa::text, '') = '';
					

BEGIN 
 
select	nr_atendimento, 
     campo_numerico(obter_unid_setor_cirurgia(nr_cirurgia,'C')), 
     dt_entrada_unidade 
into STRICT	nr_atendimento_w, 
   cd_setor_atendimento_w, 
   dt_entrada_unidade_w 
from	cirurgia 
where	nr_cirurgia = nr_cirurgia_p;
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	cd_material_w, 
	qt_dispensacao_w, 
	cd_unidade_medida_w, 
	nr_seq_lote_fornec_w, 
  cd_local_estoque_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	CALL Gerar_Prescricao_Estoque(	cd_estabelecimento_p,nr_atendimento_w,dt_entrada_unidade_w, cd_material_w,clock_timestamp(),1,cd_local_estoque_w, 
					qt_dispensacao_w,cd_setor_atendimento_w,cd_unidade_medida_w,nm_usuario_p,'I',null,null,null,null,null,null, 
					nr_seq_lote_fornec_w, null, null, null, 'S', null, null);
				 
	update	cirurgia_agente_disp 
	set	  dt_baixa	   = clock_timestamp() 
	where	  nr_sequencia	= nr_sequencia_w;
	commit;
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_estoque_contaminado ( nr_cirurgia_p bigint, nm_usuario_p text, cd_local_estoque_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

