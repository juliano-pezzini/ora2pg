-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_gravar_just_interacao ( nr_seq_alerta_p alerta_api.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_material_p prescr_material.nr_sequencia%type, ds_justificativa_p prescr_material.ds_justificativa%type ) AS $body$
DECLARE


	ds_justificativa_atual_w	prescr_material.ds_justificativa%type;
	ds_nova_justificativa_w		prescr_material.ds_justificativa%type;
	cd_api_w					alerta_api.cd_api%type;
	nr_gravidade_w				alerta_api.nr_gravidade%type;
	ds_itens_interacao_w       	alerta_api.ds_itens_interacao%type;


BEGIN
	ds_nova_justificativa_w := '';

	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND ds_justificativa_p IS NOT NULL AND ds_justificativa_p::text <> '') then
	
		select max(a.ds_justificativa)
		  into STRICT ds_justificativa_atual_w
		  from prescr_material a
		 where a.nr_prescricao = nr_prescricao_p
		   and a.nr_sequencia = nr_seq_material_p;

		select max(a.cd_api),
			   max(a.nr_gravidade),
			   max(a.ds_itens_interacao)
		  into STRICT cd_api_w,
			   nr_gravidade_w,
			   ds_itens_interacao_w
		  from alerta_api a
		 where a.nr_sequencia = nr_seq_alerta_p;

		ds_nova_justificativa_w := substr(wheb_mensagem_pck.get_texto(
			1128882,
			'API='||obter_nome_api_lexicomp(cd_api_w)||
			';SEVERIDADE='||obter_desc_sever_integracao(obter_nome_severidade_lexicomp(nr_gravidade_w))||
			';DS_MATERIAL_1='||ds_itens_interacao_w||
			';DS_JUSTIFICATIVA='||ds_justificativa_p
		), 1, 2000);

		if (coalesce(ds_justificativa_atual_w, 'XPTO') = 'XPTO') then
			ds_nova_justificativa_w := substr(ds_nova_justificativa_w, 1, 2000);
		else
			ds_nova_justificativa_w := substr(ds_justificativa_atual_w || ' ' || chr(13) || chr(13) || ds_nova_justificativa_w, 1, 2000);
		end if;

		update prescr_material
		   set ds_justificativa = ds_nova_justificativa_w
		 where nr_prescricao = nr_prescricao_p
		   and nr_sequencia = nr_seq_material_p;
		
		update alerta_api
		   set ie_justificado = 'S'
		 where nr_sequencia = nr_seq_alerta_p;

		commit;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_gravar_just_interacao ( nr_seq_alerta_p alerta_api.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_material_p prescr_material.nr_sequencia%type, ds_justificativa_p prescr_material.ds_justificativa%type ) FROM PUBLIC;

