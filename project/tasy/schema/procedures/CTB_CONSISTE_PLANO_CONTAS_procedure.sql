-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_consiste_plano_contas ( dt_referencia_p timestamp, cd_empresa_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_conta_contabil_w	varchar(20);

cd_conta_contabil_sup_w	varchar(20);

cd_classificacao_w		varchar(40);
cd_classif_superior_w	varchar(40);

ie_gravar_w		varchar(1);

ie_tipo_w			varchar(1);
ie_tipo_sup_w		varchar(1);

ie_situacao_w		varchar(1);
ie_situacao_sup_w		varchar(1);

cd_grupo_w		bigint;

char_ant			varchar(1);
char_atual		varchar(1);

i			integer;
dt_referencia_w		timestamp;
ie_separador_conta_w	empresa.ie_sep_classif_conta_ctb%type;

c01 CURSOR FOR
SELECT	cd_conta_contabil,
	cd_classificacao,
	cd_classif_superior,
	ie_tipo,
	ie_situacao,
	cd_grupo
from	conta_contabil
where	cd_empresa = cd_empresa_p;


BEGIN

ie_separador_conta_w	:= philips_contabil_pck.get_separador_conta;

dt_referencia_w	:= trunc(coalesce(dt_referencia_p, clock_timestamp()),'mm');

delete	FROM w_ctb_consiste_plano_conta
where	nm_usuario = nm_usuario_p;

commit;

open c01;
loop
fetch c01 into	
	cd_conta_contabil_w,
	cd_classificacao_w,
	cd_classif_superior_w,
	ie_tipo_w,
	ie_situacao_w,
	cd_grupo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	
	cd_classificacao_w		:= substr(ctb_obter_classif_conta(cd_conta_contabil_w, cd_classificacao_w, dt_referencia_w),1,40);
	cd_classif_superior_w	:= substr(ctb_obter_classif_conta_sup(cd_classificacao_w, dt_referencia_w, cd_empresa_p),1,40);
	
	select	max(cd_conta_contabil)
	into STRICT	cd_conta_contabil_sup_w
	from	conta_contabil a
	where	cd_classificacao = cd_classif_superior_w
	and	a.cd_empresa = cd_empresa_p
	and	not exists (	SELECT	1
			from	conta_contabil_classif x
			where	x.cd_conta_contabil = a.cd_conta_contabil);
		
	if (coalesce(cd_conta_contabil_sup_w::text, '') = '') then
		select	max(a.cd_conta_contabil)
		into STRICT	cd_conta_contabil_sup_w
		from	conta_contabil_classif a
		where	a.cd_classificacao	= cd_classif_superior_w
		and	a.dt_inicio_vigencia <= dt_referencia_w
		and	coalesce(a.dt_fim_vigencia, dt_referencia_w) >= dt_referencia_w
		and exists (	SELECT	1
					from	conta_contabil x
					where	x.cd_conta_contabil = a.cd_conta_contabil
					and 	x.cd_empresa = cd_empresa_p);
	end if;
	
	begin
	select	ie_tipo,
		ie_situacao
	into STRICT	ie_tipo_sup_w,
		ie_situacao_sup_w
	from	conta_contabil
	where	cd_conta_contabil = cd_conta_contabil_sup_w;
	exception
	when others then
		ie_tipo_sup_w	:= null;
		ie_situacao_w	:= null;
	end;
	
	if (ie_situacao_w <> 'A') then
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_gravar_w
		from	conta_contabil
		where	cd_conta_contabil = cd_conta_contabil_sup_w
		and	ie_situacao = 'A'
		and	cd_classif_superior_atual = cd_classificacao_w;
		
		if (ie_gravar_w = 'S') then
			CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'7',
			nm_usuario_p);
		end if;
		end;
	end if;
	
	if (coalesce(cd_conta_contabil_sup_w::text, '') = '') and (cd_classif_superior_w IS NOT NULL AND cd_classif_superior_w::text <> '') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'0',
			nm_usuario_p);
	elsif (ie_tipo_w = 'A') and (coalesce(cd_classif_superior_w::text, '') = '') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'1',
			nm_usuario_p);
	elsif (ie_tipo_w = 'A') and (coalesce(ie_tipo_sup_w,'X') <> 'T') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'2',
			nm_usuario_p);
	elsif (cd_classif_superior_w IS NOT NULL AND cd_classif_superior_w::text <> '') and (coalesce(ie_tipo_sup_w,'X') <> 'T') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'3',
			nm_usuario_p);
	elsif (ie_tipo_w = 'T') and (coalesce(ie_tipo_sup_w,'X') = 'A') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'4',
			nm_usuario_p);
	end if;
	
	
	ie_gravar_w	:= 'N';
	char_ant	:= null;
	char_atual	:= null;
	
	for i in 1..length(cd_classificacao_w) loop
		begin
		char_ant		:= char_atual;
		char_atual	:= substr(cd_classificacao_w, i, 1);
		
		if (char_atual not in (ie_separador_conta_w,'1','2','3','4','5','6','7','8','9','0')) then
			ie_gravar_w := 'S';
		end if;
		
		if (char_ant = ie_separador_conta_w) and (char_atual = ie_separador_conta_w) then
			ie_gravar_w := 'S';
		end if;
		end;
	end loop;
	
	if (char_atual IS NOT NULL AND char_atual::text <> '') and (char_atual not in ('1','2','3','4','5','6','7','8','9','0')) then	
		ie_gravar_w := 'S';
	end if;
	
	if (ie_gravar_w = 'S') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'5',
			nm_usuario_p);
	end if;
		
	if (cd_classif_superior_w IS NOT NULL AND cd_classif_superior_w::text <> '') then
		begin
		ie_gravar_w	:= 'N';
		char_ant	:= null;
		char_atual	:= null;
	
		for i in 1..length(cd_classif_superior_w) loop
			begin
			char_ant		:= char_atual;
			char_atual	:= substr(cd_classif_superior_w, i, 1);
			
			if (char_atual not in (ie_separador_conta_w,'1','2','3','4','5','6','7','8','9','0')) then
				ie_gravar_w := 'S';
			end if;
			
			if (char_ant = ie_separador_conta_w) and (char_atual = ie_separador_conta_w) then
				ie_gravar_w := 'S';
			end if;
			end;
		end loop;
		
		if (char_atual IS NOT NULL AND char_atual::text <> '') and (char_atual not in ('1','2','3','4','5','6','7','8','9','0')) then	
			ie_gravar_w := 'S';
		end if;
		
		if (ie_gravar_w = 'S') then
			CALL ctb_gravar_consistencia_plano(
				cd_conta_contabil_w,
				cd_classificacao_w, 
				cd_classif_superior_w, 
				cd_conta_contabil_sup_w, 
				ie_situacao_w, 
				'6',
				nm_usuario_p);
		end if;
		end;
	end if;	
	
	if (coalesce(cd_grupo_w::text, '') = '') then
		CALL ctb_gravar_consistencia_plano(
			cd_conta_contabil_w,
			cd_classificacao_w, 
			cd_classif_superior_w, 
			cd_conta_contabil_sup_w, 
			ie_situacao_w, 
			'8',
			nm_usuario_p);
	end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_consiste_plano_contas ( dt_referencia_p timestamp, cd_empresa_p bigint, nm_usuario_p text) FROM PUBLIC;

