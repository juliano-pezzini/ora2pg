-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE converte_material_convenio ( cd_convenio_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_tipo_acomodacao_p bigint, cd_cgc_p text, cd_estabelecimento_p bigint, dt_execucao_p timestamp, cd_categoria_p text, cd_material_convenio_p INOUT text, cd_grupo_p INOUT text, nr_sequencia_p INOUT bigint, ie_tipo_atendimento_p bigint, ie_origem_preco_p bigint, cd_empresa_ref_p bigint, nr_seq_proc_pacote_p bigint, ie_carater_inter_sus_p text, nr_seq_marca_p bigint, ie_tipo_atend_tiss_p text, ie_clinica_p bigint, ie_tipo_prec_especial_p text) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Obter o codigo, grupo e sequencia do material conforme cadastrado no convenio.
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatorios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
 - Rotina executada atraves dos objetos ATUALIZA_COD_CONV_MAT_PROC, ATUALIZA_CODIGO_CONVENIO, GERAR_CONSULTA_PRECO, MATERIAL_AUTOR_CIR_BEFORINSERT,
MATERIAL_AUTORIZADO_INSERT,  OBTER_CONVERSAO_MAT_CONV,  TISS_ATUALIZAR_AUTORIZACAO, TISS_GERAR_CONTA_MAT
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/cd_material_convenio_w    		varchar(20)	:= '0';
cd_grupo_w			integer		:= 0;
cd_subgrupo_w			integer		:= 0;
cd_classe_w			integer		:= 0;
nr_sequencia_w			bigint		:= 0;
cd_grupo_conversao_w		varchar(10);
ie_conversao_mat_w		varchar(01);
cd_setor_atendimento_w		integer;
cd_cgc_w			varchar(14);
ie_classificacao_w			varchar(05);
cd_estabelecimento_w		bigint;
cd_categoria_w			varchar(10);

dia_semana_w			smallint		:= 0;
dia_feriado_w			smallint		:= 0;
ie_feriado_w			varchar(1)		:= 'N';
ie_tipo_atendimento_w		smallint 		:= 0;
cd_classif_setor_w		varchar(2);
nr_seq_familia_w		bigint;
ie_origem_preco_w		smallint;
ie_pacote_w			varchar(1)		:= 'N';
ie_tipo_mat_w			varchar(3) := Obter_Tipo_Material(cd_material_p,'C');

--Obtem os dados da conversao material convenio
c_conv_mat_convenio CURSOR(	cd_material_pc		material.cd_material%type,
				cd_categoria_pc		conversao_material_convenio.cd_categoria%type,
				cd_grupo_pc		conversao_material_convenio.cd_grupo_material%type,
				cd_subgrupo_pc		conversao_material_convenio.cd_subgrupo_material%type,
				cd_classe_pc		conversao_material_convenio.cd_classe_material%type,
				nr_seq_familia_pc	conversao_material_convenio.nr_seq_familia%type,
				cd_setor_atendimento_pc	setor_atendimento.cd_setor_atendimento%type,
				cd_cgc_pc		pessoa_juridica.cd_cgc%type,
				ie_classificacao_pc	conversao_material_convenio.ie_classif_acomod%type,
				cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type,
				dt_execucao_pc		timestamp,
				cd_convenio_pc		convenio.cd_convenio%type,
				ie_feriado_pc		conversao_material_convenio.ie_feriado%type,
				ie_tipo_atendimento_pc	conversao_material_convenio.ie_tipo_atendimento%type,
				ie_origem_preco_pc	conversao_material_convenio.ie_origem_preco%type,
				dia_semana_pc		conversao_material_convenio.dt_dia_semana%type,
				cd_classif_setor_pc	conversao_material_convenio.cd_classif_setor%type,
				cd_empresa_ref_pc	conversao_material_convenio.cd_empresa_ref%type,
				ie_pacote_pc		conversao_material_convenio.ie_pacote%type,
				ie_carater_inter_sus_pc	conversao_material_convenio.ie_carater_inter_sus%type,
				nr_seq_marca_pc		conversao_material_convenio.nr_seq_marca%type,
				ie_tipo_atend_tiss_pc	conversao_material_convenio.ie_tipo_atend_tiss%type,
				ie_clinica_pc		conversao_material_convenio.ie_clinica%type,
				ie_tipo_mat_pc		conversao_material_convenio.ie_tipo_material%type,
				ie_tipo_prec_especial_pc	material_autorizado.ie_tipo_prec_especial%type) FOR
	SELECT	cd_material_convenio,
		nr_sequencia,
		cd_grupo
	from	conversao_material_convenio
	where	coalesce(cd_material, cd_material_pc) 		= cd_material_pc
	and (coalesce(cd_categoria, cd_categoria_pc)		= cd_categoria_pc or cd_categoria_pc = '0')
	and	coalesce(cd_grupo_material, cd_grupo_pc)		= cd_grupo_pc
	and	coalesce(cd_subgrupo_material, cd_subgrupo_pc)	= cd_subgrupo_pc
	and	coalesce(cd_classe_material, cd_classe_pc)	= cd_classe_pc
	and	coalesce(ie_tipo_material, ie_tipo_mat_pc)	= ie_tipo_mat_pc
	and	coalesce(nr_seq_familia, coalesce(nr_seq_familia_pc,0))	= coalesce(nr_seq_familia_pc,0)
	and (coalesce(cd_setor_atendimento, cd_setor_atendimento_pc)	= cd_setor_atendimento_pc)
	and (coalesce(cd_cgc, cd_cgc_pc)		= cd_cgc_pc)
	and (coalesce(ie_classif_acomod, coalesce(ie_classificacao_pc, 0))	= coalesce(ie_classificacao_pc, 0))
	and (coalesce(cd_estabelecimento, cd_estabelecimento_pc)		= cd_estabelecimento_pc)
	and	((coalesce(dt_execucao_pc::text, '') = '') or (dt_execucao_pc between coalesce(dt_inicio_vigencia, dt_execucao_pc) and coalesce(dt_final_vigencia, dt_execucao_pc) + 86399/86400))
	and	cd_convenio = cd_convenio_pc
	and	ie_situacao = 'A'
	and	((coalesce(ie_feriado,'A')	= ie_feriado_pc ) or (coalesce(ie_feriado,'A')	='A'))
	and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_pc,0)) = coalesce(ie_tipo_atendimento_pc,0)
	and	coalesce(ie_origem_preco, ie_origem_preco_pc) = ie_origem_preco_pc
	and	((coalesce(dt_dia_semana, coalesce(dia_semana_pc,0)) = coalesce(dia_semana_pc,0)) or (dt_dia_semana = 9))
	and 	(((coalesce(hr_final::text, '') = '') or (coalesce(hr_inicial::text, '') = '')) or (dt_execucao_pc between 
				to_date(to_char(dt_execucao_p,'dd/mm/yyyy') || ' ' ||
					coalesce(to_char(hr_inicial,'hh24:mi:ss'), '00:00:01'), 
					'dd/mm/yyyy hh24:mi:ss')
						and
				to_date(to_char(dt_execucao_p,'dd/mm/yyyy') || ' ' ||
					coalesce(to_char(hr_final,'hh24:mi:ss'), '23:59:59'), 
					'dd/mm/yyyy hh24:mi:ss')))
	and (coalesce(cd_classif_setor, coalesce(cd_classif_setor_pc,'0'))	= coalesce(cd_classif_setor_pc,'0'))
	and	coalesce(cd_empresa_ref, coalesce(cd_empresa_ref_pc,0)) = coalesce(cd_empresa_ref_pc,0)
	and	((coalesce(ie_pacote, ie_pacote_pc) = ie_pacote_pc) or (coalesce(ie_pacote,'A') = 'A'))
	and	coalesce(ie_carater_inter_sus, coalesce(ie_carater_inter_sus_pc,'0')) = coalesce(ie_carater_inter_sus_pc,'0')
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_pc) = 'S'))
	and	coalesce(nr_seq_marca, coalesce(nr_seq_marca_pc, 0)) = coalesce(nr_seq_marca_pc, 0)
	and	coalesce(ie_tipo_atend_tiss, coalesce(ie_tipo_atend_tiss_pc, '0')) = coalesce(ie_tipo_atend_tiss_pc, '0')
	and	coalesce(ie_clinica, coalesce(ie_clinica_pc,0)) = coalesce(ie_clinica_pc,0)
	and	coalesce(ie_tipo_prec_especial_pc,'N') = coalesce(ie_tipo_preco_autor,'N')
	order by
		coalesce(cd_material,0),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(nr_seq_familia,0),
		coalesce(cd_cgc, '0'),
		coalesce(cd_setor_atendimento,0),
		coalesce(cd_classif_setor,'0'),
		coalesce(cd_estabelecimento,0),
		coalesce(cd_empresa_ref,0),
		coalesce(ie_pacote,'A'),
		coalesce(cd_categoria,'0'),
		coalesce(ie_carater_inter_sus,'0'),
		coalesce(nr_seq_marca, 0),
		coalesce(ie_tipo_atend_tiss, '0'),
		coalesce(ie_clinica,0);

BEGIN
cd_setor_atendimento_w		:= coalesce(cd_setor_atendimento_p, 0);
cd_classif_setor_w		:= obter_classif_setor(cd_setor_atendimento_w);
cd_cgc_w			:= coalesce(cd_cgc_p, '0');
cd_material_convenio_w    	:= '0';
cd_estabelecimento_w		:= coalesce(cd_estabelecimento_p, 0);
cd_categoria_w			:= coalesce(cd_categoria_p, '0');
nr_sequencia_w			:= 0;
ie_tipo_atendimento_w		:= coalesce(ie_tipo_atendimento_p,0);
ie_origem_preco_w		:= coalesce(ie_origem_preco_p,0);

dia_semana_w := pkg_date_utils.get_WeekDay(dt_execucao_p);

/* obter feriado */

select 	count(1)
into STRICT 	dia_feriado_w
from 	feriado
where 	cd_estabelecimento = coalesce(cd_estabelecimento_p, cd_estabelecimento)
and		to_char(dt_feriado,'dd/mm/yyyy')  	= to_char(dt_execucao_p,'dd/mm/yyyy')  LIMIT 1;
	
if (dia_feriado_w > 0) then
	ie_feriado_w:= 'S';
else
	ie_feriado_w:= 'N';
end if;

ie_conversao_mat_w	:= coalesce(obter_valor_conv_estab(cd_convenio_p, cd_estabelecimento_p, 'IE_CONVERSAO_MAT'),'R');

if (coalesce(nr_seq_proc_pacote_p,0) = 0) then
	ie_pacote_w := 'N';
else
	ie_pacote_w := 'S';
end if;	

begin
select	max(ie_classificacao)
into STRICT	ie_classificacao_w
from	tipo_acomodacao
where	cd_tipo_acomodacao	= cd_tipo_acomodacao_p;
exception
	when others then
		ie_classificacao_w	:= null;
end;

if (ie_conversao_mat_w	= 'C') then
	cd_material_convenio_w := substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'CSA'),1,20);
	
end if;

if (ie_conversao_mat_w	= 'R') or (coalesce(cd_material_convenio_w::text, '') = '') then
	begin
	begin
	select	cd_classe_material,
		cd_subgrupo_material,
		cd_grupo_material,
		nr_seq_familia
	into STRICT	cd_classe_w,
		cd_subgrupo_w,
		cd_grupo_w,
		nr_seq_familia_w
	from	estrutura_material_v
	where	cd_material		= cd_material_p;
	exception
		when others then
			cd_classe_w		:= 0;
			cd_subgrupo_w	:= 0;
			cd_grupo_w		:= 0;
			nr_seq_familia_w	:= 0;
	end;

	cd_grupo_p				:= null;
		
	--Retorna valores obtidos no cursor de conversao de materiais de convenio
	for r_c_conv_mat_convenio in c_conv_mat_convenio(cd_material_p, cd_categoria_w, cd_grupo_w,
							cd_subgrupo_w, cd_classe_w, nr_seq_familia_w,
							cd_setor_atendimento_w, cd_cgc_w, ie_classificacao_w,
							cd_estabelecimento_w, dt_execucao_p, cd_convenio_p,
							ie_feriado_w, ie_tipo_atendimento_w, ie_origem_preco_w,
							dia_semana_w, cd_classif_setor_w,
							cd_empresa_ref_p, ie_pacote_w, ie_carater_inter_sus_p,
							nr_seq_marca_p, ie_tipo_atend_tiss_p, ie_clinica_p,
							ie_tipo_mat_w, ie_tipo_prec_especial_p) loop
		
		cd_material_convenio_w := r_c_conv_mat_convenio.cd_material_convenio;
		nr_sequencia_w := r_c_conv_mat_convenio.nr_sequencia;
		cd_grupo_conversao_w := r_c_conv_mat_convenio.cd_grupo;
	
		if (cd_grupo_conversao_w IS NOT NULL AND cd_grupo_conversao_w::text <> '') then
			cd_grupo_p		:= cd_grupo_conversao_w;
		end if;
	end loop;
	
	nr_sequencia_p		:= nr_sequencia_w;
	end;
end if;

if (ie_conversao_mat_w	= 'O') then
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	pls_material a
	where	cd_material	= cd_material_p
	and (coalesce(a.dt_exclusao::text, '') = '' or a.dt_exclusao > dt_execucao_p);
	
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
		select	cd_material_ops
		into STRICT	cd_material_convenio_w
		from	pls_material a
		where	a.nr_sequencia	= nr_sequencia_w;
	end if;
	
	nr_sequencia_p		:= nr_sequencia_w;
	
end if;

cd_material_convenio_p 		:= cd_material_convenio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE converte_material_convenio ( cd_convenio_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_tipo_acomodacao_p bigint, cd_cgc_p text, cd_estabelecimento_p bigint, dt_execucao_p timestamp, cd_categoria_p text, cd_material_convenio_p INOUT text, cd_grupo_p INOUT text, nr_sequencia_p INOUT bigint, ie_tipo_atendimento_p bigint, ie_origem_preco_p bigint, cd_empresa_ref_p bigint, nr_seq_proc_pacote_p bigint, ie_carater_inter_sus_p text, nr_seq_marca_p bigint, ie_tipo_atend_tiss_p text, ie_clinica_p bigint, ie_tipo_prec_especial_p text) FROM PUBLIC;

