-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_enviar_email_autorizacao ( nr_seq_guia_p bigint, ie_tipo_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, nr_seq_solic_mat_p bigint) AS $body$
DECLARE

				 
/* ie_TIPO_P 
	1 - SubEstipulante 
	2 - Prestador e Fornecedor 
	3 - Prestrador da Solicitação mat/med 
*/
 
			 
ds_email_dest_w			varchar(150);
ds_email_remetente_w		varchar(150) := '';
ds_email_remetente_ww		varchar(150) := '';
cd_cgc_estipulante_w		varchar(15);
cd_pf_estipulante_w		varchar(15);
ds_texto_email_w		varchar(4000);
cd_estabelecimento_w		bigint;
nm_segurado_w			varchar(150);
nr_carteirinha_w		numeric(30);
ds_nome_abrev_w			varchar(200);
ds_permite_email_w		varchar(1);
nr_seq_contrato_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_prest_fornec_w		bigint;
nr_seq_regra_email_w		bigint;
ie_prestador_w			varchar(15);
ie_fornecedor_w 		varchar(15);
ds_assunto_w			varchar(255);
nr_seq_segurado_w		bigint;
ie_tipo_segurado_w		varchar(10);
ie_solic_mat_med_w		varchar(1);
ds_texto_material_w		varchar(1000);
ie_status_w			integer;
ds_material_w			varchar(255);
cd_mat_unimed_w			varchar(255);
ds_material_origem_w		varchar(255);
nr_seq_intercambio_w		bigint;
qt_prestador_email_w		bigint;

C01 CURSOR FOR 
	SELECT	b.nr_seq_prest_fornec 
	from	pls_guia_plano_mat b, 
		pls_guia_plano a 
	where	b.nr_seq_guia		= a.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_guia_p 
	and	(b.nr_seq_prest_fornec IS NOT NULL AND b.nr_seq_prest_fornec::text <> '') 
	group by b.nr_seq_prest_fornec;


BEGIN 
 
/* Obter dados da guia */
 
begin 
select	a.nr_seq_segurado, 
	a.cd_estabelecimento, 
	substr(pls_obter_carteira_segurado(a.nr_seq_segurado),1,255), 
	a.nr_seq_prestador 
into STRICT	nr_seq_segurado_w, 
	cd_estabelecimento_w, 
	nr_carteirinha_w, 
	nr_seq_prestador_w 
from	pls_guia_plano	a 
where	nr_sequencia	= nr_seq_guia_p;
exception 
when others then 
	nr_seq_segurado_w	:= 0;
end;
 
/* Obter dados do segurado */
 
begin 
select	ie_tipo_segurado, 
	substr(obter_nome_pf(cd_pessoa_fisica),1,100), 
	nr_seq_contrato, 
	nr_seq_intercambio 
into STRICT	ie_tipo_segurado_w, 
	nm_segurado_w, 
	nr_seq_contrato_w, 
	nr_seq_intercambio_w 
from	pls_segurado 
where	nr_sequencia	= nr_seq_segurado_w;
exception 
when others then 
	ie_tipo_segurado_w	:= 'P';
end;
 
/* Obter o valor do parâmetro 52 - E-mail utilizado para o envio das mensagens pela autorização */
 
ds_email_remetente_w	:= coalesce(obter_valor_param_usuario(1204, 52, Obter_Perfil_Ativo, nm_usuario_p, 0), 'X');
 
/* Somente se for beneficiário DIFERENTE de beneficiario de perícia médica */
 
if (ie_tipo_p = 1) then 
	if (ie_tipo_segurado_w <> 'P') then 
		ds_permite_email_w := obter_valor_param_usuario(1204, 25, Obter_Perfil_Ativo, nm_usuario_p, 0);
 
		if (ds_permite_email_w = 'S') then 
			begin 
			if (coalesce(nr_seq_contrato_w,0) > 0) then 
				select	cd_cgc_estipulante, 
					cd_pf_estipulante 
				into STRICT	cd_cgc_estipulante_w, 
					cd_pf_estipulante_w 
				from	pls_contrato 
				where	nr_sequencia		= nr_seq_contrato_w;
			elsif (coalesce(nr_seq_intercambio_w,0) > 0) then 
				select	cd_cgc, 
					cd_pessoa_fisica 
				into STRICT	cd_cgc_estipulante_w, 
					cd_pf_estipulante_w 
				from	pls_intercambio 
				where	nr_sequencia		= nr_seq_intercambio_w;
			end if;
			exception 
			when others then 
				cd_cgc_estipulante_w := '';
				cd_pf_estipulante_w := '';
			end;
			 
			begin 
			select	max(ds_email) 
			into STRICT	ds_email_dest_w 
			from	pls_contrato_contato 
			where	nr_seq_contrato = nr_seq_contrato_w;
			exception 
			when others then 
				ds_email_dest_w := '';	
			end;
 
			if (coalesce(ds_email_dest_w,'0') = '0') then		 
				if (coalesce(cd_cgc_estipulante_w,'0') <> '0') then 
					ds_email_dest_w := pls_obter_email_pessoa(cd_estabelecimento_w,null, cd_cgc_estipulante_w,nm_usuario_p);	
				elsif (coalesce(cd_pf_estipulante_w,'0') <> '0') then 
					select	ds_email 
					into STRICT	ds_email_dest_w 
					from	compl_pessoa_fisica 
					where	cd_pessoa_fisica = cd_pf_estipulante_w 
					and	ie_tipo_complemento = 1;
				end if;
			end if;
 
			begin 
			select 	coalesce(c.ds_email, ''), 
				b.ds_nome_abrev 
			into STRICT	ds_email_remetente_ww, 
				ds_nome_abrev_w 
			from 	pessoa_juridica_estab	c, 
				pessoa_juridica 	b, 
				estabelecimento 	a 
			where 	a.cd_cgc 		= b.cd_cgc 
			and	b.cd_cgc		= c.cd_cgc 
			and 	a.cd_estabelecimento 	= cd_estabelecimento_w 
			and	c.cd_estabelecimento	= cd_estabelecimento_w;
			exception 
			when others then 
				ds_email_remetente_ww 	:= '';
				ds_nome_abrev_w		:= '';
			end;
			 
			/* Se não possuir e-mail nos parâmetros da OPS então busca da PJ */
 
			if (coalesce(ds_email_remetente_w,'X') = 'X') then 
				ds_email_remetente_w	:= ds_email_remetente_ww;
			end if;
 
			if (coalesce(ds_email_dest_w,'0') <> '0') and (coalesce(ds_email_remetente_w,'0') <> '0') then	 
				begin 
				select	ds_assunto, 
					ds_email     
				into STRICT	ds_assunto_w, 
					ds_texto_email_w 
				from	pls_tipo_pos_estabelecido 
				where	nr_sequencia	= nr_seq_regra_p;
				exception 
				when others then 
					ds_assunto_w	 := 'X';
					ds_texto_email_w := 'X';
				end;
				 
				if (coalesce(ds_assunto_w,'X') = 'X') then 
					ds_assunto_w	:= 'Comunicado de liberação de guia de autorização.';
				end if;
				 
				if (coalesce(ds_texto_email_w,'X') = 'X') then 
					ds_texto_email_w := 'Sr(a). Contratante.' ||chr(13)||chr(10)|| 
						'Comunicamos que esta disponivel em nosso Site ( '|| pls_obter_param_padrao_funcao(2, 1246) ||' ) ' || 
						'a Guia de solicitação para realização de serviços em nossa rede credenciada para o beneficiário abaixo:' ||chr(13)||chr(10)|| 
						'Beneficiário: '|| nm_segurado_w || '      Carteirinha: '||nr_carteirinha_w || '      Nrº Guia: '||nr_seq_guia_p ||chr(13)||chr(10)|| 
						'Salientamos, que conforme nossas condições contratuais previamente estabelecidas, é de suma importância que vossa senhoria realize a ' || 
						'referida liberação para a continuidade do processo de autorização para realização dos serviços requisitados pela nossa rede de atendimento.' 
						||chr(13)||chr(10)|| 
						'A disposição para maiores esclarecimentos.' ||chr(13)||chr(10)|| ds_nome_abrev_w;
				end if;
 
				CALL enviar_email(	ds_assunto_w, 
						ds_texto_email_w, 
						ds_email_remetente_w, 
						ds_email_dest_w, 
						nm_usuario_p, 
						'M');
			end if;
		end if;
	end if;
elsif (ie_tipo_p in (2,3)) then 
	SELECT * FROM pls_obter_regra_aut_email(nr_seq_guia_p, ie_tipo_p, ie_prestador_w, ie_fornecedor_w, nr_seq_regra_email_w, ie_solic_mat_med_w) INTO STRICT ie_prestador_w, ie_fornecedor_w, nr_seq_regra_email_w, ie_solic_mat_med_w;
	if (ie_tipo_p = 2) then 
		select	count(1) 
		into STRICT	qt_prestador_email_w 
		from	pls_prestador_email 
		where	nr_seq_prestador	= nr_seq_prestador_w 
		and	ie_utiliza_autorizacao	= 'S';
		if (coalesce(nr_seq_regra_email_w,0) <> 0) and (qt_prestador_email_w = 0) then 
			begin 
			begin 
				select	ds_assunto, 
					ds_email, 
					ds_email_remetente 
				into STRICT	ds_assunto_w, 
					ds_texto_email_w, 
					ds_email_remetente_ww 
				from	pls_autorizacao_email 
				where	nr_sequencia	= nr_seq_regra_email_w;
			exception 
			when others then 
				ds_assunto_w		:= '';
				ds_texto_email_w	:= '';
				ds_email_remetente_ww	:= '';
			end;
			 
			if (ds_email_remetente_w	= 'X') then 
				ds_email_remetente_w	:=	ds_email_remetente_ww;
			end if;
			 
			if (ie_prestador_w = 'S') then 
				begin	 
				if (coalesce(nr_seq_prestador_w,0) > 0) then 
					ds_email_dest_w := pls_obter_dados_prestador(nr_seq_prestador_w,'M');
				end if;
								 
				if (coalesce(ds_email_dest_w,'X') <> 'X') and (coalesce(ds_email_remetente_w,'X') <> 'X') then 
					begin						 
					CALL enviar_email(	ds_assunto_w, 
							ds_texto_email_w, 
							ds_email_remetente_w, 
							ds_email_dest_w, 
							nm_usuario_p, 
							'M');
					end;
				end if;			
				end;
			end if;
			 
			if (ie_fornecedor_w = 'S') then 
				begin			 
				open C01;
				loop 
				fetch C01 into	 
					nr_seq_prest_fornec_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin				 
					ds_email_dest_w := pls_obter_dados_prestador(nr_seq_prest_fornec_w,'M');
					 
					if (coalesce(ds_email_dest_w,'X') <> 'X') then 
						begin 
						CALL enviar_email(	ds_assunto_w, 
								ds_texto_email_w, 
								ds_email_remetente_w, 
								ds_email_dest_w, 
								nm_usuario_p, 
								'M');
						end;
					end if;				
					end;
				end loop;
				close C01;			
				end;
			end if;		
			end;
		end if;
	elsif (ie_tipo_p = 3) then 
		if (coalesce(nr_seq_regra_email_w,0) <> 0) then					 
			begin 
				select	ds_assunto, 
					ds_email, 
					ds_email_remetente 
				into STRICT	ds_assunto_w, 
					ds_texto_email_w, 
					ds_email_remetente_w 
				from	pls_autorizacao_email 
				where	nr_sequencia	= nr_seq_regra_email_w;
				 
				select	ds_material, 
					ie_status, 
					substr(pls_obter_seq_codigo_material(nr_seq_material,''),1,255), 
					substr(pls_obter_desc_material(nr_seq_material),1,255), 
					ds_email 
				into STRICT	ds_material_w, 
					ie_status_w, 
					cd_mat_unimed_w, 
					ds_material_origem_w, 
					ds_email_dest_w 
				from	pls_solic_lib_mat_med 
				where	nr_sequencia	= nr_seq_solic_mat_p;
				 
				if (ie_status_w = 4) then 
					ds_texto_material_w :=	'O medicamento/material '||ds_material_w||', da solicitação '||nr_seq_solic_mat_p||', foi negado.';
				elsif (ie_status_w = 3) then 
					ds_texto_material_w :=	'O medicamento/material '||ds_material_w||', da solicitação '||nr_seq_solic_mat_p||', foi aprovado com a utilização do material '||cd_mat_unimed_w|| 
								' - '||ds_material_origem_w||'.';								
				elsif (ie_status_w = 2) then 
					ds_texto_material_w :=	'O medicamento/material '||ds_material_w||', da solicitação '||nr_seq_solic_mat_p||', está aguardando justificativa.';
				end if;
					 
			exception 
			when others then 
				ds_assunto_w		:= '';
				ds_texto_email_w	:= '';
				nr_seq_prestador_w	:= '';
			end;			
			 
			if (ie_solic_mat_med_w = 'S') then				 
				if (coalesce(ds_email_dest_w,'X') <> 'X') and (coalesce(ds_email_remetente_w,'X') <> 'X') then 
					ds_texto_email_w := ds_texto_email_w ||chr(10)||chr(13)||ds_texto_material_w;
					 
					CALL enviar_email(	ds_assunto_w, 
							ds_texto_email_w, 
							ds_email_remetente_w, 
							ds_email_dest_w, 
							nm_usuario_p, 
							'M');
				end if;
			end if;
		end if;
	end if;
end if;
 
--commit; 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_enviar_email_autorizacao ( nr_seq_guia_p bigint, ie_tipo_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, nr_seq_solic_mat_p bigint) FROM PUBLIC;

