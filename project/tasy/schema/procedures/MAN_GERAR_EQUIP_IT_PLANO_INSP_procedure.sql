-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_equip_it_plano_insp ( nr_seq_item_p bigint, ie_consid_rota_p text, nm_usuario_p text) AS $body$
DECLARE


qt_existe_w				bigint;
nr_seq_tipo_equip_w		bigint;
nr_seq_equipamento_w	bigint;
nr_seq_plano_inspecao_w	bigint;
cd_setor_atendimento_w	integer;
nr_seq_bloco_w			bigint;
nr_seq_andar_w			bigint;
nr_seq_localizacao_w	bigint;
nr_seq_modelo_w			bigint;
ie_gerar_w				varchar(01) := 'S';
ie_gerar_equip_estab_w  varchar(01);
cd_estab_atual_w		smallint;

c01 CURSOR FOR
SELECT	nr_sequencia
from	man_equipamento
where	ie_situacao = 'A'
and (nr_seq_tipo_equip 	= nr_seq_tipo_equip_w or coalesce(nr_seq_tipo_equip_w,0) = 0)
and (nr_seq_modelo 		= nr_seq_modelo_w or coalesce(nr_seq_modelo_w,0) = 0)
and	ie_gerar_equip_estab_w = 'N'

UNION

select	nr_sequencia
from	man_equipamento
where	ie_situacao = 'A'
and (nr_seq_tipo_equip 	= nr_seq_tipo_equip_w or coalesce(nr_seq_tipo_equip_w,0) = 0)
and (nr_seq_modelo 		= nr_seq_modelo_w or coalesce(nr_seq_modelo_w,0) = 0)
and (cd_estab_contabil = cd_estab_atual_w or coalesce(cd_estab_contabil::text, '') = '')
and	ie_gerar_equip_estab_w = 'S';

c02 CURSOR FOR		/*Regra de tipo por local*/
SELECT	b.nr_sequencia,
	z.cd_setor,
	z.nr_seq_bloco,
	z.nr_seq_andar,
	z.nr_sequencia nr_seq_localizacao
from	man_localizacao z,
	man_equipamento b,
	man_plano_insp_item a
where	a.nr_seq_tipo_equip 	= b.nr_seq_tipo_equip
and	a.nr_sequencia		= nr_seq_item_p
and	z.nr_sequencia		= b.nr_seq_local
and	b.ie_situacao 		= 'A';

c03 CURSOR FOR		/*Locais*/
SELECT	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
from	man_plano_insp_item_local
where	nr_seq_item = nr_seq_item_p
and (coalesce(cd_setor_atendimento, cd_setor_atendimento_w) 	= cd_setor_atendimento_w)
and (coalesce(nr_seq_bloco, coalesce(nr_seq_bloco_w,0)) 		= coalesce(nr_seq_bloco_w,0))
and (coalesce(nr_seq_andar, coalesce(nr_seq_andar_w,0))		= coalesce(nr_seq_andar_w,0))
and (coalesce(nr_seq_localizacao, nr_seq_localizacao_w) 		= nr_seq_localizacao_w)
order by	coalesce(nr_seq_bloco,0),
	coalesce(nr_seq_andar,0),
	coalesce(nr_seq_localizacao,0);


BEGIN
cd_estab_atual_w		:=	wheb_usuario_pck.get_cd_estabelecimento;
ie_gerar_equip_estab_w	:=  substr(coalesce(obter_valor_param_usuario(294,30, obter_perfil_ativo, nm_usuario_p, cd_estab_atual_w),'MP'),1,1); --[30]Gerar apenas equipamentos do estabelecimento logado ao utilizar a opção 'Gerar equipamentos do tipo/regra local'
select	nr_seq_tipo_equip,
	nr_seq_plano_inspecao,
	nr_seq_modelo
into STRICT	nr_seq_tipo_equip_w,
	nr_seq_plano_inspecao_w,
	nr_seq_modelo_w
from	man_plano_insp_item
where	nr_sequencia = nr_seq_item_p;

select	count(*)
into STRICT	qt_existe_w
from	man_plano_insp_item_local
where	nr_seq_item  = nr_seq_item_p;

if (qt_existe_w = 0) then
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_equipamento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	count(*)
		into STRICT	qt_existe_w
		from	man_plano_insp_item
		where	nr_seq_equipamento 	= nr_seq_equipamento_w
		and	nr_seq_plano_inspecao  	= nr_seq_plano_inspecao_w;

		if (ie_consid_rota_p = 'N') and (qt_existe_w = 0) then
			insert into man_plano_insp_item(nr_sequencia,
						nr_seq_plano_inspecao,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_equipamento,
						nr_seq_tipo_equip,
						ie_participa,
						ie_origem)
					values (	nextval('man_plano_insp_item_seq'),
						nr_seq_plano_inspecao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_equipamento_w,
						null,
						'S',
						'S');
		elsif (ie_consid_rota_p = 'S') and (qt_existe_w = 0) then
			begin
			begin
			select	1
			into STRICT	qt_existe_w
			from	man_rota_inspecao b,
				man_rota_inspecao_item a
			where	a.nr_seq_equipamento 	= nr_seq_equipamento_w
			and	a.nr_seq_rota_inspecao	= b.nr_sequencia
			and	b.dt_atualizacao_nrec between trunc(clock_timestamp() - interval '1 days') and fim_dia(clock_timestamp())  LIMIT 1;
			exception
			when others then
				qt_existe_w := 0;
			end;

			if (qt_existe_w = 0) then
				insert into man_plano_insp_item(nr_sequencia,
							nr_seq_plano_inspecao,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_equipamento,
							nr_seq_tipo_equip,
							ie_participa,
							ie_origem)
						values (	nextval('man_plano_insp_item_seq'),
							nr_seq_plano_inspecao_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_equipamento_w,
							null,
							'S',
							'S');
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
elsif (qt_existe_w > 0) then
	begin
	open C02;
	loop
	fetch C02 into
		nr_seq_equipamento_w,
		cd_setor_atendimento_w,
		nr_seq_bloco_w,
		nr_seq_andar_w,
		nr_seq_localizacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		open C03;
		loop
		fetch C03 into
			ie_gerar_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ie_gerar_w	:= ie_gerar_w;
			end;
		end loop;
		close C03;

		if (ie_gerar_w = 'S') then
			select	count(*)
			into STRICT	qt_existe_w
			from	man_plano_insp_item
			where	nr_seq_equipamento 	= nr_seq_equipamento_w
			and	nr_seq_plano_inspecao	= nr_seq_plano_inspecao_w;

			if (ie_consid_rota_p = 'N') and (qt_existe_w = 0) then
				insert into man_plano_insp_item(nr_sequencia,
							nr_seq_plano_inspecao,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_equipamento,
							nr_seq_tipo_equip,
							ie_participa,
							ie_origem)
						values (	nextval('man_plano_insp_item_seq'),
							nr_seq_plano_inspecao_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_equipamento_w,
							null,
							'S',
							'S');
			elsif (ie_consid_rota_p = 'S') and (qt_existe_w = 0) then
				begin
				begin
				select	1
				into STRICT	qt_existe_w
				from	man_rota_inspecao b,
					man_rota_inspecao_item a
				where	a.nr_seq_equipamento 	= nr_seq_equipamento_w
				and	a.nr_seq_rota_inspecao	= b.nr_sequencia
				and	b.dt_atualizacao_nrec between trunc(clock_timestamp() - interval '1 days') and fim_dia(clock_timestamp())  LIMIT 1;
				exception
				when others then
					qt_existe_w := 0;
				end;

				if (qt_existe_w = 0) then
					insert into man_plano_insp_item(nr_sequencia,
								nr_seq_plano_inspecao,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_seq_equipamento,
								nr_seq_tipo_equip,
								ie_participa,
								ie_origem)
							values (	nextval('man_plano_insp_item_seq'),
								nr_seq_plano_inspecao_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_equipamento_w,
								null,
								'S',
								'S');
				end if;
				end;
			end if;
		end if;
		end;
	end loop;
	close C02;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_equip_it_plano_insp ( nr_seq_item_p bigint, ie_consid_rota_p text, nm_usuario_p text) FROM PUBLIC;

