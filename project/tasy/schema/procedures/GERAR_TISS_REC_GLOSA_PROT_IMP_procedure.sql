-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tiss_rec_glosa_prot_imp (nr_seq_lote_hist_p bigint, nm_usuario_p text, nr_guia_prest_p text, nr_guia_oper_p text, nr_lote_p text, nr_protocolo_p text, dt_recurso_p timestamp, vl_total_recursado_p text, vl_total_acatado_p text, nr_prot_status_p text, dt_envio_rec_p timestamp, dt_receb_rec_p timestamp, nr_protocolo_sit_p text, dt_situacao_p timestamp, ie_status_situacao_proc_p text, ds_just_ops_n_acata_prot_p text, nr_seq_lote_p INOUT bigint, ds_nome_arquivo text, cd_convenio_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
vl_total_recursado_w	double precision;
vl_total_acatado_w	double precision;
nr_seq_lote_hist_w	bigint;


BEGIN
nr_seq_lote_hist_w := nr_seq_lote_hist_p;
vl_total_recursado_w	:= vl_total_recursado_p;
vl_total_acatado_w	:= vl_total_acatado_p;

select	nextval('tiss_rec_glosa_prot_imp_seq')
into STRICT	nr_sequencia_w
;

if (coalesce(nr_seq_lote_hist_w::text, '') = '' or nr_seq_lote_hist_w = 0) then
	select max(c.nr_sequencia) nr_analise
	into STRICT nr_seq_lote_hist_w
	from lote_auditoria d,
	lote_audit_hist c,	
	tiss_recurso_glosa_prot  a 
	where   d.cd_convenio = cd_convenio_p
	and	a.nr_seq_lote_hist	= c.nr_sequencia 
	and	c.nr_seq_lote_audit	= d.nr_sequencia 
	and coalesce(substr(tiss_obter_lote_recurso_glosa(a.nr_sequencia, d.cd_convenio,d.cd_estabelecimento),1,12),a.nr_lote) = nr_lote_p 
	and a.nr_protocolo = nr_protocolo_p;
end if;

IF ( (nr_seq_lote_hist_w IS NOT NULL AND nr_seq_lote_hist_w::text <> '') AND nr_seq_lote_hist_w <> 0) THEN
  INSERT
  INTO TISS_REC_GLOSA_PROT_IMP(
      nr_sequencia,
      dt_atualizacao,
      nm_usuario,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      nr_seq_lote_hist,
      nr_guia_prestador,
      nr_guia_operadora,
      nr_lote,
      nr_protocolo,
      dt_recurso,
      vl_total_recurso,
      vl_total_acatado,
      ds_erro,
      nr_protocolo_rec_glosa,
      dt_envio_recurso,
      dt_recebimento_rec,
      nr_protocolo_sit_glosa,
      dt_situacao_rec_glosa,
      ie_status_prot_sit,
      ds_just_ops_nao_acato_prot
    )
    VALUES (
      nr_sequencia_w,
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,
      nr_seq_lote_hist_w,
      nr_guia_prest_p,
      nr_guia_oper_p,
      nr_lote_p,
      nr_protocolo_p,
      dt_recurso_p,
      vl_total_recursado_w,
      vl_total_acatado_w,
      NULL,
      nr_prot_status_p,
      dt_envio_rec_p,
      dt_receb_rec_p,
      nr_protocolo_sit_p,
      dt_situacao_p,
      ie_status_situacao_proc_p,
      ds_just_ops_n_acata_prot_p
    );
  nr_seq_lote_p := nr_sequencia_w;
  COMMIT;
ELSE
  insert into TISS_LOG_IMPORT_RECURSOS(
    nr_guia_prestador,
    nr_guia_operadora,
    nr_lote,
    nr_protocolo,
    dt_recurso,
    vl_total_recurso,
    vl_total_acatado,
    dt_atualizacao,
    nm_usuario,
    ds_nome_arquivo 
  )
  VALUES (
    nr_guia_prest_p,
    nr_guia_oper_p,
    nr_lote_p,
    nr_protocolo_p,
    dt_recurso_p,
    vl_total_recursado_p,
    vl_total_acatado_p,
    clock_timestamp(),
    nm_usuario_p,
    ds_nome_arquivo
  );

END IF;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tiss_rec_glosa_prot_imp (nr_seq_lote_hist_p bigint, nm_usuario_p text, nr_guia_prest_p text, nr_guia_oper_p text, nr_lote_p text, nr_protocolo_p text, dt_recurso_p timestamp, vl_total_recursado_p text, vl_total_acatado_p text, nr_prot_status_p text, dt_envio_rec_p timestamp, dt_receb_rec_p timestamp, nr_protocolo_sit_p text, dt_situacao_p timestamp, ie_status_situacao_proc_p text, ds_just_ops_n_acata_prot_p text, nr_seq_lote_p INOUT bigint, ds_nome_arquivo text, cd_convenio_p bigint) FROM PUBLIC;

