-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_pacote ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, ie_define_Pacote_p text, ie_Atualiza_Procedimento_p text, ie_Atualiza_material_p text, ie_ratear_valores_p text, ie_lista_pacote_p text) AS $body$
DECLARE


cd_estabelecimento_w		bigint;
IE_CALCULO_TAXA_REGRA_w		varchar(01);
nr_interno_conta_w		bigint;
nr_seq_item_w			bigint;
ie_proc_mat_w			bigint;
nr_seq_regra_preco_w		bigint;


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

select	coalesce(max(IE_CALCULO_TAXA_REGRA), 'C')
into STRICT	IE_CALCULO_TAXA_REGRA_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_lista_pacote_p = 'S') then
	CALL Define_Pacote_Procedimento(nr_atendimento_p,
						nr_interno_conta_p,
						cd_convenio_p,
						cd_categoria_p,
						nm_usuario_p,
						'N', null, null);
end if;

if (ie_define_pacote_p = 'S') then
	CALL Define_Pacote_Procedimento(nr_atendimento_p,
						nr_interno_conta_p,
						cd_convenio_p,
						cd_categoria_p,
						nm_usuario_p,
						'S', null, null);
end if;

CALL ajustar_valores_pacote(nr_atendimento_p,
					cd_convenio_p,
					nm_usuario_p);


if (ie_Atualiza_Procedimento_p = 'S') then
	CALL Atualizar_Procedimento_pacote(nr_atendimento_p,
					nr_interno_conta_p,
						cd_convenio_p,
						nm_usuario_p);
end if;
if (ie_atualiza_Material_p = 'S') then
	CALL Atualizar_material_pacote(nr_atendimento_p,
					nr_interno_conta_p,
						cd_convenio_p,
						nm_usuario_p);
end if;

if (ie_ratear_valores_p = 'S') then
	CALL Ratear_Valores_pacote(nr_atendimento_p, 'S',
						cd_convenio_p,
						nm_usuario_p);

	if (IE_CALCULO_TAXA_REGRA_w	= 'L') then
		begin

		select  max(a.nr_sequencia)
		into STRICT	nr_seq_regra_preco_w
		from  	procedimento_paciente a,
			procedimento b,
			conta_paciente x
		where 	a.cd_procedimento  = b.cd_procedimento
		and 	a.ie_origem_proced = b.ie_origem_proced
		and 	x.nr_interno_conta = a.nr_interno_conta
		and	x.nr_interno_conta = nr_interno_conta_p
		and 	coalesce(a.nr_seq_proc_pacote::text, '') = ''
		and 	b.ie_classificacao <> 1
		and	coalesce(a.ie_valor_informado,'N') = 'N'
		and 	coalesce(a.nr_seq_regra_preco,0) > 0;

		if (coalesce(nr_seq_regra_preco_w,0) > 0) then
			CALL calcular_regra_preco_taxa(nr_interno_conta_p, nr_seq_regra_preco_w, 1, nm_usuario_p);
		end if;

		end;
	end if;

	if (2 = philips_param_pck.get_cd_pais) and -- 2 = MÃ©xico
		(nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
		CALL gerar_tributo_conta_pac(nr_interno_conta_p, 0, 'P', nm_usuario_p);
	end if;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_pacote ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, ie_define_Pacote_p text, ie_Atualiza_Procedimento_p text, ie_Atualiza_material_p text, ie_ratear_valores_p text, ie_lista_pacote_p text) FROM PUBLIC;

