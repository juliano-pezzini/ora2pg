-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_apropriacao_mens_nc ( nr_seq_nota_credito_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE


ie_acao_w		varchar(3);
vl_saldo_nota_w		double precision;
vl_item_w		double precision;
vl_preco_pre_segurado_w	double precision;
vl_total_preco_pre_w	double precision;
vl_inserido_w		double precision	:= 0;
nr_seq_pagador_w	bigint;
qt_registro_w		bigint;
nr_seq_segurado_w	bigint;
ie_segurado_w		bigint	:= 0;
qt_segurado_mens_w	bigint;
nr_seq_regra_w		bigint;
cd_estabelecimento_w	smallint;
dt_nota_credito_w	timestamp;
dt_rescisao_w		timestamp;
ie_origem_w		nota_credito.ie_origem%type;


BEGIN

if (nr_seq_nota_credito_p IS NOT NULL AND nr_seq_nota_credito_p::text <> '') then
	select	dt_nota_credito,
		ie_origem
	into STRICT	dt_nota_credito_w,
		ie_origem_w
	from	nota_credito
	where	nr_sequencia	= nr_seq_nota_credito_p;

	if (ie_origem_w = 'RC') then --Rescis√£o de contrato
		select	max(b.nr_seq_pagador)
		into STRICT	nr_seq_pagador_w
		from	pls_solic_resc_fin_venc a,
			pls_solic_rescisao_fin b
		where	b.nr_sequencia	= a.nr_seq_solic_resc_fin
		and	a.nr_seq_nota_credito = nr_seq_nota_credito_p;
	else
		select	max(d.nr_seq_pagador)
		into STRICT	nr_seq_pagador_w
		from	pls_mensalidade		d,
			titulo_receber		c,
			titulo_receber_cobr	b,
			nota_credito		a
		where	b.nr_sequencia	= a.nr_seq_tit_rec_cobr
		and	b.nr_titulo	= c.nr_titulo
		and	d.nr_sequencia	= c.nr_seq_mensalidade
		and	a.nr_sequencia	= nr_seq_nota_credito_p;

		if (coalesce(nr_seq_pagador_w::text, '') = '') then
			select	max(d.nr_seq_pagador)
			into STRICT	nr_seq_pagador_w
			from	pls_mensalidade	d,
				titulo_receber	c,
				nota_credito	a
			where	c.nr_titulo	= a.nr_titulo_receber
			and	d.nr_sequencia	= c.nr_seq_mensalidade
			and	a.nr_sequencia	= nr_seq_nota_credito_p;

			if (coalesce(nr_seq_pagador_w::text, '') = '') then
				select	max(c.nr_seq_pagador)
				into STRICT	nr_seq_pagador_w
				from	titulo_receber	c,
					nota_credito	a
				where	c.nr_titulo	= a.nr_titulo_receber
				and	a.nr_sequencia	= nr_seq_nota_credito_p;
			end if;
		end if;
	end if;

	if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
		select	max(a.dt_rescisao)
		into STRICT	dt_rescisao_w
		from	pls_contrato_pagador	a
		where	a.nr_sequencia	= nr_seq_pagador_w;

		if (dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') then
			if (coalesce(obter_valor_param_usuario(9051, 7, Obter_Perfil_Ativo, nm_usuario_p, 0), 'N') = 'A') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(333635);
			else
				ds_mensagem_p	:= expressao_pck.obter_desc_expressao(892111);
			end if;
		end if;

		SELECT * FROM obter_regra_acao_pag_duplic(dt_nota_credito_w, cd_estabelecimento_p, nm_usuario_p, nr_seq_regra_w, ie_acao_w) INTO STRICT nr_seq_regra_w, ie_acao_w;

		update	nota_credito
		set	nr_seq_pagador_aprop	= nr_seq_pagador_w,
			nr_seq_regra_pag_duplic	= nr_seq_regra_w
		where	nr_sequencia		= nr_seq_nota_credito_p;
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(225330);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_apropriacao_mens_nc ( nr_seq_nota_credito_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

