-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE converte_codigo_barras_tipo3 ( cd_mat_barra_p text, cd_estabelecimento_p bigint, cd_material_p INOUT bigint, nr_seq_lote_p INOUT bigint, dt_validade_p INOUT timestamp) AS $body$
DECLARE



nr_sequencia_w		bigint;
cd_material_w		integer;
nr_seq_lote_w		bigint;
dt_validade_w		timestamp;
cd_cod_barra_w		varchar(255);
ie_consiste_estab_lote_w	varchar(1);


BEGIN

cd_material_w 		:= 0;
ie_consiste_estab_lote_w	:= coalesce(WHEB_ADM_PCK.get_ie_consiste_estab_lote, 'N');

if (cd_material_w = 0) then
	begin
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_w
	from	material_lote_fornec
	where	ds_barras = cd_mat_barra_p
	and	cd_estabelecimento = cd_estabelecimento_p;

	if (nr_sequencia_w = 0) and (ie_consiste_estab_lote_w = 'N') then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	material_lote_fornec
		where	ds_barras = cd_mat_barra_p;
	end if;

	if (nr_sequencia_w > 0) then
		select	nr_sequencia,
			cd_material,
			dt_validade
		into STRICT	nr_seq_lote_w,
			cd_material_w,
			dt_validade_w
		from	material_lote_fornec
		where	nr_sequencia = nr_sequencia_w;
	end if;
	end;
end if;

if (cd_material_w = 0) then
	begin
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_w
	from	material_lote_fornec
	where	cd_barra_material	= cd_mat_barra_p
	and	cd_estabelecimento = cd_estabelecimento_p;

	if (nr_sequencia_w = 0) and (ie_consiste_estab_lote_w = 'N') then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	material_lote_fornec
		where	cd_barra_material = cd_mat_barra_p;
	end if;

	if (nr_sequencia_w > 0) then
		select	nr_sequencia,
			cd_material,
			dt_validade
		into STRICT	nr_seq_lote_w,
			cd_material_w,
			dt_validade_w
		from	material_lote_fornec
		where	nr_sequencia	= nr_sequencia_w;
	end if;
	end;
end if;


if (cd_material_w = 0) then
	begin
	if (Length(cd_mat_barra_p) in (11,12)) then
          	begin
		if (Length(cd_mat_barra_p) = 11) then
			cd_cod_barra_w	:= elimina_caracteres_barras(cd_mat_barra_p);
		else
			cd_cod_barra_w	:= substr(cd_mat_barra_p,2,12);
		end if;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	material_Lote_Fornec
		where	to_char(nr_sequencia)	= substr(cd_cod_barra_w,1,10);


		if (nr_sequencia_w > 0) then
			select	nr_sequencia,
				cd_material,
				dt_validade
			into STRICT	nr_seq_lote_w,
				cd_material_w,
				dt_validade_w
			from	material_lote_fornec
			where	nr_sequencia	= nr_sequencia_w;
		end if;

		end;
	end if;
	end;
end if;


if (cd_material_w = 0) then
	begin
	select	coalesce(max(cd_material),0)
	into STRICT	cd_material_w
	from	material_cod_barra
	where	cd_barra_material = cd_mat_barra_p;
	end;
end if;

cd_material_p		:= coalesce(cd_material_w, 0);
nr_seq_lote_p		:= coalesce(nr_seq_Lote_w, 0);
dt_validade_p		:= dt_validade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE converte_codigo_barras_tipo3 ( cd_mat_barra_p text, cd_estabelecimento_p bigint, cd_material_p INOUT bigint, nr_seq_lote_p INOUT bigint, dt_validade_p INOUT timestamp) FROM PUBLIC;

