-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_immuni_dose_patient (nr_sequencia_p bigint , nr_sequencia_vacina_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_material_w		bigint;
qt_material_w		double precision;
cd_unidade_medida_w	varchar(35);
ie_retornar_estoque_w	varchar(1);

nr_seq_vacina_w bigint;

  
 C01 CURSOR FOR 
	SELECT 	a.cd_material, 
		a.qt_material, 
		a.cd_unidade_medida 
	from  	vacina_paciente_material a, 
		paciente_vacina b 
	where 	b.nr_sequencia = nr_sequencia_vacina_p 
	and	a.nr_seq_vacina = b.nr_sequencia;


BEGIN 
ie_retornar_estoque_w := coalesce(obter_valor_param_usuario(903,25,Obter_Perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo),'N');
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then 
 
 select nr_seq_vacina into STRICT nr_seq_vacina_w from paciente_vacina where nr_sequencia = nr_sequencia_p;
  
 if ('S' = ie_retornar_estoque_w) then 
		open C01;
		loop 
		fetch C01 into 
			cd_material_w, 
			qt_material_w, 
			cd_unidade_medida_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			CALL Inserir_Mat_Med_Vacina(nr_seq_vacina_w, cd_material_w, qt_material_w, cd_unidade_medida_w, obter_estabelecimento_ativo, nm_usuario_p, 'D',null);
			end;
		end loop;
		close C01;
	end if;
  
 Delete 	FROM paciente_vacina 
 where 	nr_sequencia = nr_sequencia_p;
 
	end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_immuni_dose_patient (nr_sequencia_p bigint , nr_sequencia_vacina_p bigint, nm_usuario_p text) FROM PUBLIC;

