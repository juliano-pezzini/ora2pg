-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_metrica_defeitos ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE

			
dt_ref_inicio_w 	timestamp;
dt_ref_fim_w 		timestamp;
dt_referencia_w		timestamp;
qt_defeito_w		bigint;
qt_os_w			bigint;
vl_resultado_w		double precision;
nm_usuario_exec_w	usuario.nm_usuario%type;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;
vl_acumulado_w		double precision;
dt_fim_ano_w		timestamp;
nr_seq_acumulado_w	bigint;


BEGIN

select	max(c.nr_seq_gerencia),
	max(c.nr_seq_grupo),
	max(c.nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta		= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

dt_ref_inicio_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');
dt_referencia_w	:= trunc(dt_referencia_p);
dt_fim_ano_w	:= trunc(PKG_DATE_UTILS.end_of(to_date('31/12/' || to_char(dt_referencia_p,'yyyy'),'dd/mm/yyyy'),'DAY'));

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
	begin
	select	max(a.pr_defeito_cliente_mes),
		max(a.pr_defeito_cliente_ano)
	into STRICT	vl_resultado_w,
		vl_acumulado_w
	from	grupo_desenvolvimento b,
		w_indicador_desenv_apres a 
	where	b.nr_sequencia	= a.nr_seq_grupo 
	and	a.dt_referencia =  trunc(dt_referencia_p)
	and	a.nr_seq_grupo	= nr_seq_grupo_w
	and	a.ie_abrangencia = 'GRU';

	CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_resultado_w, 0, 0, nm_usuario_p);

	select	max(nr_sequencia)
	into STRICT	nr_seq_acumulado_w
	from	ppm_objetivo_result a
	where	a.nr_seq_metrica	= nr_seq_objetivo_metrica_p
	and	trunc(dt_referencia)	= dt_fim_ano_w;
	
	update	ppm_objetivo_result
	set	vl_resultado_calc	= vl_acumulado_w
	where	nr_sequencia		= nr_seq_acumulado_w;
	end;
elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then
	begin
	select	max(a.pr_defeito_cliente_mes),
		max(a.pr_defeito_cliente_ano)
	into STRICT	vl_resultado_w,
		vl_acumulado_w
	FROM w_indicador_desenv_apres a
LEFT OUTER JOIN gerencia_wheb b ON (a.nr_seq_gerencia = b.nr_sequencia)
WHERE a.dt_referencia = trunc(dt_referencia_p) and a.ie_abrangencia in ('GER') and b.nr_sequencia	= nr_seq_gerencia_w;

	CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_resultado_w, 0, 0, nm_usuario_p);

	select	max(nr_sequencia)
	into STRICT	nr_seq_acumulado_w
	from	ppm_objetivo_result a
	where	a.nr_seq_metrica	= nr_seq_objetivo_metrica_p
	and	trunc(dt_referencia)	= dt_fim_ano_w;
	
	update	ppm_objetivo_result
	set	vl_resultado_calc	= vl_acumulado_w
	where	nr_sequencia		= nr_seq_acumulado_w;
	end;
elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then
	begin
	select	max(a.pr_defeito_cliente_mes),
		max(a.pr_defeito_cliente_ano)
	into STRICT	vl_resultado_w,
		vl_acumulado_w
	from	w_indicador_desenv_apres a
	where	a.dt_referencia 	= trunc(dt_referencia_p)	
	and 	a.nr_seq_diretoria	= nr_seq_diretoria_w;

	CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_resultado_w, 0, 0, nm_usuario_p);

	select	max(nr_sequencia)
	into STRICT	nr_seq_acumulado_w
	from	ppm_objetivo_result a
	where	a.nr_seq_metrica	= nr_seq_objetivo_metrica_p
	and	trunc(dt_referencia)	= dt_fim_ano_w;

	update	ppm_objetivo_result
	set	vl_resultado_calc	= vl_acumulado_w
	where	nr_sequencia		= nr_seq_acumulado_w;
	end;
else
	begin
	select	max(nm_usuario)
	into STRICT	nm_usuario_exec_w
	from	usuario x
	where	x.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	x.ie_situacao	= 'A';

	--Quantidade de OS's de defeito por pessoa
	select	count(distinct a.nr_sequencia)
	into STRICT	qt_defeito_w
	from	os_erro_gerencia_v a
	where	a.dt_ordem_servico between dt_ref_inicio_w and dt_ref_fim_w
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	a.ie_ident_erro	<> 'W'
	and (exists (SELECT	1
			from	proj_projeto x
			where	x.nr_sequencia = a.nr_seq_proj_def 
			and	(x.dt_fim_real IS NOT NULL AND x.dt_fim_real::text <> '')
			and	obter_dias_entre_datas(x.dt_fim_real,a.dt_ordem_servico) > 120) or coalesce(a.nr_seq_proj_def::text, '') = '')
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_p;

	--Busca as OSs encerradas com base no indicador ja utilizado
	select	sum(a.qt_ordem)
	into STRICT	qt_os_w
	from	w_avaliacao_usuario a
	where	a.dt_referencia between dt_ref_inicio_w and dt_ref_fim_w
	and	a.ie_referencia = 'E'
	and	a.nm_usuario 	= nm_usuario_exec_w;	

	vl_resultado_w := dividir( qt_defeito_w, qt_os_w ) * 100;

	CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_resultado_w, qt_os_w, qt_defeito_w, nm_usuario_p);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_metrica_defeitos ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

