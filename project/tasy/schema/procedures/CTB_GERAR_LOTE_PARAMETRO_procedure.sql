-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_lote_parametro ( cd_tipo_lote_contabil_p bigint, nr_lote_contabil_p bigint, nm_usuario_p text) AS $body$
DECLARE




nr_seq_parametro_w		smallint;
ie_tipo_parametro_w		varchar(2);
dt_parametro_w			timestamp;
ds_valor_parametro_w		varchar(40);
ds_hora_mascara_w		varchar(10);
ds_data_mascara_w		varchar(10);
dt_referencia_w			timestamp;


C01 CURSOR FOR
SELECT	nr_seq_parametro,
	ie_tipo_parametro,
	dt_parametro,
	ds_valor_parametro
from	tipo_lote_contabil_param
where 	cd_tipo_lote_contabil	= cd_tipo_lote_contabil_p
and 	((cd_tipo_lote_contabil <> 6) or (nr_seq_parametro in (3,9,10)))
and	ie_situacao = 'A';


BEGIN

select	max(dt_referencia)
into STRICT	dt_referencia_w
from	lote_contabil
where	nr_lote_contabil	= nr_lote_contabil_p;

open C01;
loop
fetch C01 into
	nr_seq_parametro_w,
	ie_tipo_parametro_w,
	dt_parametro_w,
	ds_valor_parametro_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (ie_tipo_parametro_w = '3') then
		ds_data_mascara_w := substr(ds_valor_parametro_w,1,10);
		ds_hora_mascara_w := substr(ds_valor_parametro_w,12,length(ds_valor_parametro_w));
		if (upper(ds_data_mascara_w) = '01/MM/YYYY') then
			dt_parametro_w	:= to_date(to_char(trunc(clock_timestamp(),'mm'),'dd/mm/yyyy') || ds_hora_mascara_w,'dd/mm/yyyy hh24:mi:ss');
		elsif (upper(ds_data_mascara_w) = 'DD/MM/YYYY') then
			dt_parametro_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy')|| ds_hora_mascara_w,'dd/mm/yyyy hh24:mi:ss');
		elsif (upper(ds_data_mascara_w) = 'DL/MM/YYYY') then
			dt_parametro_w	:= to_date(to_char(dt_referencia_w,'dd/mm/yyyy')|| ds_hora_mascara_w,'dd/mm/yyyy hh24:mi:ss');
		end if;
		ds_valor_parametro_w	:= '';
	end if;

	insert into lote_contabil_parametro(
		nr_lote_contabil,
		cd_tipo_lote_contabil,
		nr_seq_parametro,
		dt_atualizacao,
		nm_usuario,
		dt_parametro,
		ds_valor_parametro)
	values (nr_lote_contabil_p,
		cd_tipo_lote_contabil_p,
		nr_seq_parametro_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_parametro_w,
		ds_valor_parametro_w);
end loop;
close C01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_lote_parametro ( cd_tipo_lote_contabil_p bigint, nr_lote_contabil_p bigint, nm_usuario_p text) FROM PUBLIC;

