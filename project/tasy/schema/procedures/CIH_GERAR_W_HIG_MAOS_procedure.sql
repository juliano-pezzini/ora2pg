-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cih_gerar_w_hig_maos ( nr_dimensao_p bigint, nr_informacao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ds_filtros_p text, ds_comando_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


ds_base_w			varchar(4000);
nr_acum_w			varchar(4000);
cd_base_w			varchar(4000);
cd_estabelecimento_w		varchar(10);
ds_sql_w			varchar(4000);
ds_periodo_w			varchar(4000);
ds_filtros_w			varchar(4000);
ds_filt_subsql_w		varchar(4000);
nao_informado_w			varchar(255);
sim_w				varchar(10);
nao_w				varchar(10);
nm_atributo_w			varchar(4000);
nm_atributo_inf_w		varchar(4000);


BEGIN
select 	max(a.nm_atributo)
into STRICT	nm_atributo_w
from  	indicador_gestao_atrib a,
	indicador_gestao b
where 	a.nr_seq_ind_gestao	= b.nr_sequencia
and	b.nr_seq_wheb		= 1547
and   	(ds_dimensao IS NOT NULL AND ds_dimensao::text <> '')
and   	coalesce(a.ie_situacao,'A')	= 'A'
and	a.nr_sequencia		= nr_dimensao_p;

select	max(a.nm_atributo)
into STRICT	nm_atributo_inf_w
from	indicador_gestao_atrib a,
	indicador_gestao b
where	a.nr_seq_ind_gestao	= b.nr_sequencia
and	b.nr_seq_wheb 		= 1547
and	a.nr_sequencia		= nr_informacao_p;

/* INICIALIZAÇÃO DE VARIÁVEIS */

ds_sql_w		:= '';
cd_estabelecimento_w	:= to_char(wheb_usuario_pck.get_cd_estabelecimento);
ds_filtros_w		:= ds_filtros_p;
	
select 	wheb_mensagem_pck.get_texto(793967),	
	wheb_mensagem_pck.get_texto(793968),
	wheb_mensagem_pck.get_texto(793969)
into STRICT	nao_informado_w,
	sim_w,
	nao_w
;

------------------------------------------


/* LIMPA A TABELA W_HIG_MAOS_IND PARA O USUÁRIO */

delete	FROM w_hig_maos_ind
where	nm_usuario = nm_usuario_p;

commit;
------------------------------------------


/* AJUSTA OS FILTROS */

ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_CATEGORIA_PROFISSIONAL','a.ie_tipo_evolucao');
ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_MOMENTO','b.ie_momento');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_OBSERVADOR_PF','a.cd_observador_pf');
ds_filtros_w	:= replace(upper(ds_filtros_w),'NR_SEQUENCIA_MATERIAL','b.nr_seq_material');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_PROFISSIONAL','a.cd_profissional');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_SETOR_ATENDIMENTO','a.cd_setor_atendimento');
ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_SEXO','a.ie_sexo');
ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_TURNO','a.ie_turno');
ds_filtros_w	:= replace(upper(ds_filtros_w),'NR_SEQ_PROFISSIONAL','a.nr_seq_profissional');

ds_filt_subsql_w	:= replace(upper(ds_filtros_w),'A.','X.');
ds_filt_subsql_w	:= replace(upper(ds_filt_subsql_w),'B.','Y.');
------------------------------------------


/* PERÍODOS */

ds_periodo_w	:= ' and dt_observacao between to_date('''||to_char(trunc(dt_inicial_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') and to_date('''||to_char(trunc(dt_final_p),'dd/mm/yyyy')||' 23:59:59'',''dd/mm/yyyy hh24:mi:ss'') ';
if (nm_atributo_w = 'DS_MATERIAL') then
	ds_periodo_w	:= ds_periodo_w || ' and ie_higienizou = ''S'' ';
end if;
------------------------------------------


/* TIPO DE INFORMAÇÃO */

if (nm_atributo_inf_w = 'COUNT(*)') then -- TOTAL
	nr_acum_w	:= 'SUM(DECODE(b.ie_higienizou,''S'',1,1))';
else	-- PERCENTUAL
	if	((nm_atributo_w = 'IE_HIGIENIZOU') or (nm_atributo_w = 'DS_MATERIAL') or (nm_atributo_w = 'IE_TECNICA')) then
		nr_acum_w	:= 'ROUND((SUM(DECODE(b.ie_higienizou,''S'',1,1))/
				(	select	decode(count(1),0,1,count(1))
					from	cih_higienizacao_maos	 x
					left  join cih_dados_hig_maos	 y
						ON  y.nr_seq_hig_mao = x.nr_sequencia
					where	x.dt_liberacao is not null and x.dt_inativacao is null
					'||ds_periodo_w||'
					and	(x.nr_seq_classificacao is null or x.nr_seq_classificacao = 9999)
					and	NVL(cd_estabelecimento,'||cd_estabelecimento_w||') = '||cd_estabelecimento_w||' '||ds_filt_subsql_w|| '))*100,2)';
	else
		nr_acum_w	:= 'ROUND((SUM(DECODE(IE_HIGIENIZOU,''S'',1,0)) / COUNT(*)) * 100,2)';
	end if;
end if;
-------------------------------------------


/* SETA OS ATRIBUTOS DE ACORDO COM A DIMENSÃO */

if (nm_atributo_w = 'DS_MATERIAL') then -- PRODUTO 45301
	ds_base_w	:= 'NVL(SUBSTR(obter_material_higienizacao(b.nr_seq_material),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'b.nr_seq_material';
end if;
if (nm_atributo_w = 'DS_IE_TURNO') then  -- TURNO 45298
	ds_base_w	:= 'nvl(SUBSTR(obter_valor_dominio(5874, a.ie_turno),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.ie_turno';
end if;
if (nm_atributo_w = 'DS_IE_SEXO') then  -- SEXO 45292
	ds_base_w	:= 'nvl(SUBSTR(obter_valor_dominio(4, a.ie_sexo),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.ie_sexo';
end if;
if (nm_atributo_w = 'DS_IE_MOMENTO') then  -- MOMENTO 45296
	ds_base_w	:= 'nvl(SUBSTR(obter_valor_dominio(7445, b.ie_momento),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'b.ie_momento';
end if;
if (nm_atributo_w = 'DS_CATEGORIA_PROFISSIONAL') then  -- CATEGORIA 45299
	ds_base_w	:= 'nvl(SUBSTR(obter_valor_dominio(72, a.ie_tipo_evolucao),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.ie_tipo_evolucao';
end if;
if (nm_atributo_w = 'DS_SETOR_ATENDIMENTO') then  -- SETOR ATENDIMENTO 45291
	ds_base_w	:= 'nvl(SUBSTR(obter_nome_setor(a.cd_setor_atendimento),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.cd_setor_atendimento';
end if;
if (nm_atributo_w = 'IE_HIGIENIZOU') then  -- HIGIENIZOU AS MÃOS 37892
	ds_base_w	:= 'decode(b.ie_higienizou,''S'','''||sim_w||''',''N'','''||nao_w||''','''||nao_informado_w||''')';
	cd_base_w	:= 'b.ie_higienizou';
end if;
if (nm_atributo_w = 'IE_TECNICA') then  -- TÉCNICA 37895
	ds_base_w	:= 'decode(SUBSTR(cih_obter_se_tecnica(b.nr_sequencia),1,255),''S'','''||sim_w||''',''N'','''||nao_w||''','''||nao_informado_w||''')';
	cd_base_w	:= 'nvl(SUBSTR(cih_obter_se_tecnica(b.nr_sequencia),1,255),'''||nao_informado_w||''')';
end if;
if (nm_atributo_w = 'NM_OBSERVADOR') then  -- OBSERVADOR 37893
	ds_base_w	:= 'nvl(SUBSTR(obter_nome_pf(a.cd_observador_pf),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.cd_observador_pf';
end if;
if (nm_atributo_w = 'NM_PROFISSIONAL') then  -- PROFISSIONAL 37890
	ds_base_w	:= 'nvl(SUBSTR(obter_nome_pf(a.cd_profissional),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.cd_profissional';
end if;
if (nm_atributo_w = 'DS_PROFISSIONAL') then  -- CATEGORIA PROFISSIONAL
	ds_base_w	:= 'nvl(SUBSTR(obter_desc_cih_profissional(a.nr_seq_profissional),1,255), '''||nao_informado_w||''')';
	cd_base_w	:= 'a.nr_seq_profissional';
end if;
------------------------------------------


/* MONTA A QUERY QUE SERÁ UTILIZADA NA INSERÇÃO NA TABELA W_HIG_MAOS_IND */

ds_sql_w	:=
'	select	'||ds_base_w||' ds_base,
		'||nr_acum_w||' nr_acum,
		'||cd_base_w||' cd_base
	from	cih_higienizacao_maos	a
	left  join cih_dados_hig_maos	b
	ON	b.nr_seq_hig_mao = a.nr_sequencia
	where	a.dt_liberacao is not null
	AND	a.dt_inativacao is null
	'||ds_periodo_w||'
	and	(a.nr_seq_classificacao is null or a.nr_seq_classificacao = 9999)
	AND	NVL(cd_estabelecimento,'||cd_estabelecimento_w||') = '||cd_estabelecimento_w||' '||ds_filtros_w ||' GROUP BY '||ds_base_w||','||cd_base_w;
------------------------------------------
cd_base_w	:= replace(upper(cd_base_w),'IE_TIPO_EVOLUCAO','ie_categoria_profissional');
if (nm_atributo_w = 'IE_TECNICA') then  -- TÉCNICA 37895
	cd_base_w	:= 'a.ie_tecnica';
end if;

/* FAZ O INSERT NA TABELA W_HIG_MAOS_IND */

CALL exec_sql_dinamico('TASY',
'	INSERT INTO w_hig_maos_ind (
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		'||substr(cd_base_w,3,255)||',
		qt_informacao,
		ds_momento
	) (	select w_hig_maos_ind_seq.NEXTVAL nr_sequencia,
			sysdate,
			'''||nm_usuario_p||''',
			sysdate,
			'''||nm_usuario_p||''',
			r.cd_base,
			r.nr_acum,
			r.ds_base
	from ( '||ds_sql_w||' ORDER BY 1 DESC) r ) ');
------------------------------------------
COMMIT;

/* RETORNA A QUERY COM A RESTRIÇÃO POR USUÁRIO */

ds_comando_p	:= ' select '||substr(cd_base_w,3,255)||' cd_base, qt_informacao nr_acum, ds_momento ds_base from  w_hig_maos_ind where nm_usuario = '''||nm_usuario_p||''' ORDER BY ds_base ';
------------------------------------------
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cih_gerar_w_hig_maos ( nr_dimensao_p bigint, nr_informacao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ds_filtros_p text, ds_comando_p INOUT text, nm_usuario_p text) FROM PUBLIC;

