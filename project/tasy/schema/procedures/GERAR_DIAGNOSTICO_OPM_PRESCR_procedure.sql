-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_opm_prescr ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cid_principal_w	varchar(4);
cd_medico_w		varchar(10);
qt_diagnostico_w	integer;
nr_atendimento_w	bigint;
dt_prescricao_w		timestamp;
dt_diagnostico_w	timestamp;
nr_seq_grupo_diag_w	bigint;					
					 
C01 CURSOR FOR
	SELECT	cd_cid_principal
	from	prescr_opme
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	SELECT	cd_cid_principal
	from	prescr_opm
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_protese_ms
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_protese_mi
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_ortese_ms
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_ortese_mi
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_meio_locomocao
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '') 
	
union

	select	cd_cid_principal 
	from	prescr_ortese_coluna
	where	nr_prescricao	= nr_prescricao_p
	and	(cd_cid_principal IS NOT NULL AND cd_cid_principal::text <> '');					
					 

BEGIN

nr_seq_grupo_diag_w := obter_param_usuario(924, 1137, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_grupo_diag_w);

select	max(dt_prescricao),
	max(cd_medico),
	max(nr_atendimento)
into STRICT	dt_prescricao_w,
	cd_medico_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (coalesce(nr_atendimento_w,0) > 0) then
	begin
		select	count(*)
		into STRICT	qt_diagnostico_w
		from	diagnostico_medico
		where	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_diagnostico)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w)
		and	cd_medico	= cd_medico_w
		and	nr_atendimento	= nr_atendimento_w;

		if (qt_diagnostico_w = 0) then
			insert into diagnostico_medico(nr_atendimento,
							cd_medico,
							dt_diagnostico,
							ie_tipo_diagnostico,
							dt_atualizacao,
							nm_usuario)
			values (nr_atendimento_w,
							cd_medico_w,
							dt_prescricao_w,
							2,
							clock_timestamp(),
							nm_usuario_p);
					
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;	
		end if;

		select	max(dt_diagnostico)
		into STRICT	dt_diagnostico_w	
		from	diagnostico_medico
		where	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_diagnostico)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w)
		and	cd_medico	= cd_medico_w
		and	nr_atendimento	= nr_atendimento_w;
			
		open C01;
		loop
		fetch C01 into
			cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			insert into diagnostico_doenca(nr_atendimento,
							cd_doenca,
							dt_diagnostico,
							cd_medico,
							dt_atualizacao,
							nm_usuario,
							nr_seq_grupo_diag)
			values (nr_atendimento_w,
							cd_cid_principal_w,
							dt_diagnostico_w,
							cd_medico_w,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_grupo_diag_w);

			end;
			
		end loop;
		close C01;

		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_opm_prescr ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

