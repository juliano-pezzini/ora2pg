-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_unicred_850 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


subtype varchar_10 is varchar(10);
subtype varchar_15 is varchar(15);
subtype varchar_20 is varchar(20);
subtype varchar_30 is varchar(30);
subtype varchar_50 is varchar(50);
subtype varchar_255 is varchar(255);
subtype varchar_852 is varchar(852);
subtype varchar_4000 is varchar(4000);

/* Header */

cd_conta_corrente_w			banco_estabelecimento.cd_conta%type;
nm_banco_w					banco.ds_banco%type;
nm_empresa_w				pessoa_juridica.ds_razao_social%type;

/*Registro Tipo 2 - Informacoes do Titulo*/

nr_nosso_numero_w			titulo_receber.nr_nosso_numero%type;
nr_documento_w				titulo_receber.nr_titulo%type;
vl_multa_w					varchar_15;
vl_juros_diario_w			varchar_15;
vl_titulo_w					varchar_15;
dt_vencimento_w				varchar_10;
dt_emissao_w				varchar_10;
nm_pagador_w				pessoa_juridica.ds_razao_social%type;
ds_cpf_cnpj_pagador_w		varchar_20;
ds_endereco_pagador_w		varchar_50;
cd_cep_pagador_w			varchar_10;
ds_bairro_pagador_w			varchar_50;
ds_cidade_uf_pagador_w		varchar_30;
nr_seq_reg_arquivo_w		integer := 1;
qt_reg_2_w					integer := 0;
nm_segurado_w				varchar_255;
cd_usuario_plano_w			varchar_255;
ds_plano_w					varchar_255;
dt_contratacao_w			timestamp;
vl_mensalidade_w			pls_mensalidade_segurado.vl_mensalidade%type;
nr_protocolo_ans_w			pls_plano.nr_protocolo_ans%type;
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
ds_tipo_contratacao_w		varchar_15;
cd_convenio_banco_w			varchar_20;
ds_observacao_titulo_w		varchar_4000;


/*Contador*/

nr_seq_apres_w					w_envio_banco.nr_seq_apres%type := 1;
nr_seq_registro_w				w_envio_banco.nr_sequencia%type;
ds_conteudo_w					varchar_852;
ie_gerar_cob_esc_prim_mens_w	pls_parametros_cr.ie_gerar_cob_esc_prim_mens%type;

C01 CURSOR FOR
SELECT	distinct to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'dd/mm/yyyy') dt_vencimento,
	to_char(b.dt_emissao,'dd/mm/yyyy') dt_emissao,
	lpad(substr(coalesce(b.nr_nosso_numero,'0'), 1, 17), 17,'0') nr_nosso_numero,
	lpad(coalesce(b.nr_titulo,'0'),10,'0') nr_documento,
	replace(to_char(b.vl_saldo_titulo, 'fm00000000000.00'),'.',null) vl_titulo,
	rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),40, ' ') nm_pagador,
	rpad(upper(elimina_acentuacao(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 				obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'EN') END ,1,50))),50, ' ') ds_endereco_pagador,
	coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 				obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,25),' ')
	|| ' - ' || coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 				obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),' ') ds_cidade_uf_pagador,
	lpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 				obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),'0'),8,'0') cd_cep,
	rpad(coalesce(b.ds_cgc_cpf,' '),18, ' ') ds_cpf_cnpj_pagador_w,
	lpad(somente_numero(to_char(b.tx_multa,'09.99')),13,'0') vl_multa,
	replace(to_char(coalesce(obter_vl_juros_diario_tit(null,b.nr_titulo),0), 'fm0000000000000.00'),'.', null) vl_juros_diario,
	rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 				obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,40),' '),40,' ') ds_bairro,
	b.ds_observacao_titulo ds_observacao_titulo
	FROM banco_estabelecimento x, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
LEFT OUTER JOIN pls_lote_mensalidade z ON (d.nr_seq_lote = z.nr_sequencia)
, titulo_receber_cobr c
LEFT OUTER JOIN titulo_receber_mensagem g ON (c.nr_titulo = g.nr_titulo)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia      and ((coalesce(z.ie_primeira_mensalidade::text, '') = '' or z.ie_primeira_mensalidade = 'N')
	or	ie_gerar_cob_esc_prim_mens_w = 'S') and a.nr_sequencia		= nr_seq_cobr_escrit_p;

/*cursor c02 is
select	c.ie_tipo_contratacao
from	pls_mensalidade_segurado 	a,
		titulo_receber b,
		pls_plano c
where	a.nr_seq_mensalidade 	= b.nr_seq_mensalidade
and		c.nr_sequencia = a.nr_seq_plano
and		b.nr_titulo in (select d.nr_titulo
				from titulo_receber_cobr d
				where d.nr_seq_cobranca = nr_seq_cobr_escrit_p)
group by c.ie_tipo_contratacao;*/
ds_servico_w			varchar_30;
dt_utilizacao_w			timestamp;
dt_utilizacao_ds_w		varchar_10;
qt_utilizado_w			pls_conta_coparticipacao.qt_liberada_copartic%type;
vl_total_w				pls_conta_coparticipacao.vl_coparticipacao%type;
nm_usuario_w			pessoa_fisica.nm_pessoa_fisica%type;
ds_prestador_w			pessoa_juridica.ds_razao_social%type;

C04 CURSOR FOR
SELECT	rpad(coalesce(substr(obter_descricao_procedimento(f.cd_procedimento,f.ie_origem_proced),1,30),' '),30,' ') ds_servico,
		rpad(coalesce(to_char(e.dt_atendimento,'dd/mm/RRRR'),' '),10,' ') dt_utilizacao,
		lpad(coalesce(substr(h.qt_liberada_copartic,1,4),'0'),4,'0') qt_utilizado,
		lpad(coalesce(substr(h.vl_coparticipacao,1,16),'0'),16,'0')  vl_total,
		rpad(coalesce(substr(pls_obter_dados_segurado(e.nr_seq_segurado, 'N'),1,52),' '),52,' ')  nm_usuario,
		rpad(coalesce(substr(pls_obter_dados_prestador(e.nr_seq_prestador_exec, 'N'),1,40),' '),40,' ') ds_prestador
	from	pls_conta_coparticipacao	h,
		pls_conta_proc					f,
		pls_conta						e,
		pls_mensalidade_seg_item		a,
		pls_mensalidade_segurado		b,
		pls_mensalidade					c,
		titulo_receber					d
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and		b.nr_seq_mensalidade		= c.nr_sequencia
	and		d.nr_seq_mensalidade		= c.nr_sequencia
	and		a.nr_seq_conta				= e.nr_sequencia
	and		e.nr_sequencia				= f.nr_seq_conta
	and		h.nr_seq_conta_proc			= f.nr_sequencia
	and		d.nr_titulo					= nr_documento_w
	and		(a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')
	order by e.nr_sequencia;

C05 CURSOR FOR
	SELECT substr(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'C'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'P'),1,255),
		substr(pls_obter_dados_segurado(a.nr_seq_segurado,'D'),1,255),
		a.vl_mensalidade,
		c.nr_protocolo_ans
	from	pls_mensalidade_segurado	a,
			titulo_receber				b,
			pls_plano					c
	where	a.nr_seq_mensalidade 	= b.nr_seq_mensalidade
	and c.nr_sequencia = a.nr_seq_plano
	and b.nr_titulo = nr_documento_w;


BEGIN

delete from w_envio_banco where nm_usuario = nm_usuario_p;

/* Pega o parametro para ver se considera os titulos gerados por lotes de primera mensalidade */

select	coalesce(max(ie_gerar_cob_esc_prim_mens),'S')
into STRICT	ie_gerar_cob_esc_prim_mens_w
from	pls_parametros_cr
where	cd_estabelecimento = cd_estabelecimento_p;

/* Header */

begin
  select	lpad(coalesce(c.cd_conta,'0'),8,'0'),
    rpad(upper(elimina_acentuacao(substr(Obter_Nome_Banco(c.cd_banco),1,40))),40, ' '),
    rpad(upper(elimina_acentuacao(substr(obter_nome_pf_pj(null, b.cd_cgc),1,200))),200, ' '),
    rpad(coalesce(substr(c.cd_convenio_banco,1,19),' '),19,' ')
  into STRICT	cd_conta_corrente_w,
    nm_banco_w,
    nm_empresa_w,
    cd_convenio_banco_w
  from	estabelecimento		b,
    cobranca_escritural	a,
    banco_estabelecimento	c
  where	a.cd_estabelecimento	= b.cd_estabelecimento
  and	a.nr_seq_conta_banco	= c.nr_sequencia
  and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
exception
  when too_many_rows then raise;
  when no_data_found then raise;
end;


/*open C02;
loop
fetch C02 into
ie_tipo_contratacao_w;
exit when C02%notfound;*/
select	nextval('w_envio_banco_seq') --NOSONAR
into STRICT	nr_seq_registro_w
;

/*select decode(ie_tipo_contratacao_w,'I','PARTICULAR','CE','EMPRESARIAL','CA','EMPRESARIAL')
into ds_tipo_contratacao_w
from dual;*/
ds_tipo_contratacao_w := 'EMPRESARIAL';

ds_conteudo_w	:= 	'0' ||
			rpad(ds_tipo_contratacao_w,12, ' ') || 	/*2-13*/
			cd_conta_corrente_w || 	/*14-21*/
			rpad('UNICRED DO BRASIL',40, ' ') || 		/*22-61*/
			nm_empresa_w || 	/*62-261*/
			lpad(' ',583,' ') ||
			'000001'; 	/*262-850*/
insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nr_seq_registro_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_apres_w,
	0);
/* Fim Header */

/*Registro Tipo 2 - Informacoes do Titulo*/

open C01;
loop
fetch C01 into --NOSONAR
	dt_vencimento_w,
	dt_emissao_w,
	nr_nosso_numero_w,
	nr_documento_w,
	vl_titulo_w,
	nm_pagador_w,
	ds_endereco_pagador_w,
	ds_cidade_uf_pagador_w,
	cd_cep_pagador_w,
	ds_cpf_cnpj_pagador_w,
	vl_multa_w,
	vl_juros_diario_w,
	ds_bairro_pagador_w,
	ds_observacao_titulo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

begin

--Registro tipo 1 - Dados fixos
select	nextval('w_envio_banco_seq') --NOSONAR
into STRICT	nr_seq_registro_w
;

nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;


ds_conteudo_w	:=	'1' || 			/*1-1*/
					rpad(coalesce(OBTER_INSTRUCAO_BOLETO_TAM(nr_documento_w,756,1,'F',null,null,null),' '),93,' ') || /*2-94*/
					rpad(coalesce(OBTER_INSTRUCAO_BOLETO_TAM(nr_documento_w,756,2,'F',null,null,null),' '),93,' ') || /*95-187*/
					rpad(coalesce(OBTER_INSTRUCAO_BOLETO_TAM(nr_documento_w,756,3,'F',null,null,null),' '),93,' ') || /*188-280*/
					rpad(coalesce(OBTER_INSTRUCAO_BOLETO_TAM(nr_documento_w,756,4,'F',null,null,null),' '),93,' ') || /*281-373*/
					rpad(coalesce(OBTER_INSTRUCAO_BOLETO_TAM(nr_documento_w,756,5,'F',null,null,null),' '),93,' ') || /*374-466*/
					rpad(coalesce(substr(ds_observacao_titulo_w,1,93),' '),93,' ')	|| /*467-559*/
					rpad(coalesce(substr(ds_observacao_titulo_w,94,186),' '),93,' ')	 || /*560-652*/
					rpad(coalesce(substr(ds_observacao_titulo_w,187,279),' '),93,' ')	 || /*653-745*/
					'136-8 ' || /*746-751*/
					'DM' || /*752-753*/
					'N' || /*754-754*/
					substr(cd_conta_corrente_w || ' / ' || cd_convenio_banco_w,1,19) || /*755-773*/
					rpad(' ',12,' ') || /*774-785*/
					'  ' || /*786-787*/
					'R$' ||  /*788-789*/
					lpad(' ',55,' ') || /*790-844*/
					'000002'; 	/*845-850*/
nr_seq_apres_w := nr_seq_apres_w + 1;

insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nr_seq_registro_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_apres_w,
	0);
/*Fim Registro tipo 1*/

	select	nextval('w_envio_banco_seq') --NOSONAR
	into STRICT	nr_seq_registro_w
	;

	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	qt_reg_2_w := qt_reg_2_w + 1;

	ds_conteudo_w	:=	'2' || 			/*1-1*/
				lpad(nr_seq_reg_arquivo_w,6,'0') ||	/*2-7*/
				dt_vencimento_w || 	/*8-17*/
				dt_emissao_w ||		/*18-27*/
				rpad(nr_nosso_numero_w,17,' ') ||	/*28-44*/
				to_char(clock_timestamp(),'dd/mm/yyyy') || /*45-54*/
				rpad(nr_documento_w,10,' ')	||	/*55-64*/
				vl_titulo_w	||	/*65-77*/
				rpad(nm_pagador_w,40,' ')	||	/*78-117*/
				rpad(ds_endereco_pagador_w,50,' ') ||	/*118-167*/
				RPAD(ds_cidade_uf_pagador_w,28,' ') || /*168-195*/
				RPAD(substr(cd_cep_pagador_w,1,5) || '-' || substr(cd_cep_pagador_w,6,8),9,' ')  ||	/*196-204*/
				RPAD(ds_cpf_cnpj_pagador_w,18,' ')  || 		/*205-222*/
				vl_multa_w || 		/*223-237*/
				vl_juros_diario_w ||	/*238-252*/
				lpad(' ',482,' ') || 	/*253-732*/
				ds_bairro_pagador_w ||		/*733-772*/
				' ' || /*773 - 774*/
				lpad(' ',71,' ') || /*775-844*/
				lpad(nr_seq_reg_arquivo_w,6,'0') /*845 - 850*/
;

	nr_seq_apres_w := nr_seq_apres_w + 1;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_titulo)
	values (nr_seq_registro_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w,
		0,
		somente_numero(nr_documento_w));


/*Fim Registro Tipo 2 - Informacoes do Titulo*/

/* Registro Tipo 3 - Dados de Utilizacao de servicos */

open C04;
loop
fetch C04 into --NOSONAR
	ds_servico_w,
	dt_utilizacao_w,
	qt_utilizado_w,
	vl_total_w,
	nm_usuario_w,
	ds_prestador_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin

	select	nextval('w_envio_banco_seq') --NOSONAR
	into STRICT	nr_seq_registro_w
	;
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	qt_reg_2_w := qt_reg_2_w + 1;

	dt_utilizacao_ds_w := substr(to_char(dt_utilizacao_w,'dd/mm/yyyy'),1,10);

	ds_conteudo_w	:=	'3' || 	/*1-1*/
						rpad(nm_usuario_w,52,' ') || /*2-53*/
						rpad(ds_prestador_w,40,' ') ||  /*54-93*/
						dt_utilizacao_ds_w || /*94-103*/
						rpad(ds_servico_w,30,' ') || /*104-133*/
						lpad(qt_utilizado_w,4,'0') ||  /*134-137*/
						lpad(replace(to_char(vl_total_w, 'fm0000000000000.00'),'.', null),16,'0') || /*138-153*/
						lpad(' ',691,' ') || /*154-844*/
						lpad(nr_seq_reg_arquivo_w,6,'0') /*845 - 850*/
;



	nr_seq_apres_w := nr_seq_apres_w + 1;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_titulo)
	values (nr_seq_registro_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w,
		0,
		somente_numero(nr_documento_w));


	end;
end loop;
close C04;


/*Fim  Registro Tipo 3 - Dados de Utilizacao de servicos */

--Registro Tipo 4 - Dados de Utilizacao de servicos
open C05;
loop
fetch C05 into --NOSONAR
		nm_segurado_w,
		cd_usuario_plano_w,
		ds_plano_w,
		dt_contratacao_w,
		vl_mensalidade_w,
		nr_protocolo_ans_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin

	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

	ds_conteudo_w	:=	'4' || 				/*1-1*/
				rpad(substr('BENEFICI'||chr(193)||'RIO............' || upper(nm_segurado_w),1,60),60, ' ') || /*2-61*/
				rpad(substr('C'||chr(211)||'DIGO CLIENTE..........' || upper(cd_usuario_plano_w),1,60),60, ' ') || /*62-121*/
				rpad(substr('PLANO...................' || upper(ds_plano_w),1,60),60, ' ') || --122-181
				rpad(substr('N'||chr(186)||' REGISTRO.............' || upper(nr_protocolo_ans_w),1,60),60, ' ') || /*182-241*/
				rpad(substr('DATA DE INCLUS'||chr(195)||'O........' || upper(dt_contratacao_w),1,60),60, ' ') || /*242-301*/
				rpad(substr('VALOR DO PLANO..........' || upper(trim(both to_char(vl_mensalidade_w * 100,'9999999999990,00'))),1,60),60, ' ') || /*302-361*/
				lpad(' ',300,' ') || /*362-611*/
				lpad(' ',183,' ') || /*612-844*/
				lpad(nr_seq_reg_arquivo_w,6,'0'); /*845-850*/
	nr_seq_apres_w := nr_seq_apres_w + 1;

	select	nextval('w_envio_banco_seq') --NOSONAR
	into STRICT	nr_seq_registro_w
	;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres,
		nr_seq_apres_2)
	values (nr_seq_registro_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w,
		0);

	end;
end loop;
close C05;

--Fim Registro Tipo 4 - Dados Beneficiario
end;
end loop;
close C01;

/* Trailler */

nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

ds_conteudo_w	:=	'9' ||
					lpad(' ',837,' ') ||
					lpad(qt_reg_2_w,6,'0')  ||
					lpad(nr_seq_reg_arquivo_w,6,'0');

select	nextval('w_envio_banco_seq') --NOSONAR
into STRICT	nr_seq_registro_w
;

nr_seq_apres_w := nr_seq_apres_w + 1;

insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres,
	nr_seq_apres_2)
values (nr_seq_registro_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_apres_w,
	0);

/* Fim Trailler
end loop;
close C02;*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_unicred_850 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

