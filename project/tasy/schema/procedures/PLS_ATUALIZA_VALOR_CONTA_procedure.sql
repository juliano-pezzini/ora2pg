-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_valor_conta ( nr_seq_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_procedimentos_w		double precision	:= 0;
vl_diarias_w			double precision	:= 0;
vl_pacotes_w			double precision	:= 0;
vl_taxas_w			double precision	:= 0;
vl_materiais_w			double precision	:= 0;
vl_medicamentos_w		double precision	:= 0;
vl_gases_w			double precision	:= 0;
vl_opm_w			double precision	:= 0;
vl_cobrado_w			double precision	:= 0;
vl_total_w			double precision	:= 0;
vl_glosa_w			double precision	:= 0;
vl_saldo_w			double precision	:= 0;
vl_cobrado_proc_w		double precision	:= 0;
vl_cobrado_mat_w		double precision	:= 0;
vl_total_proc_w			double precision	:= 0;
vl_total_mat_w			double precision	:= 0;
vl_proc_apres_w			double precision	:= 0;
vl_taxas_apres_w		double precision	:= 0;
vl_diarias_apres_w		double precision	:= 0;
vl_pacotes_apres_w		double precision	:= 0;
vl_gases_apres_w		double precision	:= 0;
vl_medic_apres_w		double precision	:= 0;
vl_mat_apres_w			double precision	:= 0;
vl_opm_apres_w			double precision	:= 0;
vl_glosa_proc_w			double precision	:= 0;
vl_glosa_taxa_w			double precision	:= 0;
vl_glosa_diaria_w		double precision	:= 0;
vl_glosa_pacote_w		double precision	:= 0;
vl_glosa_medic_w		double precision	:= 0;
vl_glosa_gases_w		double precision	:= 0;
vl_glosa_mat_w			double precision	:= 0;
vl_glosa_opm_w			double precision	:= 0;
vl_saldo_proc_w			double precision	:= 0;
vl_saldo_taxa_w			double precision	:= 0;
vl_saldo_diaria_w		double precision	:= 0;
vl_saldo_pacote_w		double precision	:= 0;
vl_saldo_medic_w		double precision	:= 0;
vl_saldo_gases_w		double precision	:= 0;
vl_saldo_mat_w			double precision	:= 0;
vl_saldo_opm_w			double precision	:= 0;
vl_proc_beneciciario_w		double precision	:= 0;
vl_mat_beneciciario_w		double precision	:= 0;
vl_total_beneciciario_w		double precision	:= 0;
/*ie_preco_plano_w		Varchar2(2); */

ie_calcula_preco_benef_w	varchar(1);
vl_adic_materiais_w		double precision;
vl_adic_co_w			double precision;
vl_adic_materiais_ww		double precision;
vl_adic_procedimento_w		double precision;
vl_co_ptu_w			double precision	:= 0;
vl_procedimento_ptu_w		double precision	:= 0;
vl_material_ptu_w		double precision	:= 0;
vl_material_ptu_ww		double precision	:= 0;
vl_liberado_ptu_w		double precision	:= 0;
qt_item_w			bigint;
ie_tipo_protocolo_w		pls_protocolo_conta.ie_tipo_protocolo%type;
nr_seq_protocolo_w		pls_protocolo_conta.nr_sequencia%type;


BEGIN

select	count(1)
into STRICT	qt_item_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '1'
and	ie_status != 'D'  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_procedimento_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_procedimentos_w,
		vl_proc_apres_w,
		vl_glosa_proc_w,
		vl_saldo_proc_w
	from	pls_conta_proc
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '1'
	and	ie_status 	not in ('M','D');
else
	vl_procedimentos_w	:= 0;
	vl_proc_apres_w		:= 0;
	vl_glosa_proc_w		:= 0;
	vl_saldo_proc_w		:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '2'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_procedimento_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_taxas_w,
		vl_taxas_apres_w,
		vl_glosa_taxa_w,
		vl_saldo_taxa_w
	from	pls_conta_proc
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '2'
	and	ie_status 	not in ('M','D');
else
	vl_taxas_w	 := 0;
	vl_taxas_apres_w := 0;
	vl_glosa_taxa_w	 := 0;
	vl_saldo_taxa_w	 := 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '3'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_procedimento_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_diarias_w,
		vl_diarias_apres_w,
		vl_glosa_diaria_w,
		vl_saldo_diaria_w
	from	pls_conta_proc
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '3'
	and	ie_status 	not in ('M','D');
else
	vl_diarias_w		:= 0;
	vl_diarias_apres_w	:= 0;
	vl_glosa_diaria_w	:= 0;
	vl_saldo_diaria_w	:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '4'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then

	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_procedimento_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_pacotes_w,
		vl_pacotes_apres_w,
		vl_glosa_pacote_w,
		vl_saldo_pacote_w
	from	pls_conta_proc
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '4'
	and	ie_status 	not in ('M','D');
else
	vl_pacotes_w		:= 0;
	vl_pacotes_apres_w	:= 0;
	vl_glosa_pacote_w	:= 0;
	vl_saldo_pacote_w	:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '1'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_material_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_gases_w,
		vl_gases_apres_w,
		vl_glosa_gases_w,
		vl_saldo_gases_w
	from	pls_conta_mat
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '1'
	and	ie_status 	not in ('M','D');
else
	vl_gases_w		:= 0;
	vl_gases_apres_w	:= 0;
	vl_glosa_gases_w	:= 0;
	vl_saldo_gases_w	:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '2'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_material_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_medicamentos_w,
		vl_medic_apres_w,
		vl_glosa_medic_w,
		vl_saldo_medic_w
	from	pls_conta_mat
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '2'
	and	ie_status 	not in ('M','D');
else
	vl_medicamentos_w	:= 0;
	vl_medic_apres_w	:= 0;
	vl_glosa_medic_w	:= 0;
	vl_saldo_medic_w	:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '3'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_material_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_materiais_w,
		vl_mat_apres_w,
		vl_glosa_mat_w,
		vl_saldo_mat_w
	from	pls_conta_mat
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '3'
	and	ie_status 	not in ('M','D');
else
	vl_materiais_w	:= 0;
	vl_mat_apres_w	:= 0;
	vl_glosa_mat_w	:= 0;
	vl_saldo_mat_w	:= 0;
end if;

select	count(1)
into STRICT	qt_item_w
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_tipo_despesa	= '7'
and	ie_status 	not in ('M','D')  LIMIT 1;

if (qt_item_w > 0)then
	select	coalesce(sum(vl_liberado),0),
		coalesce(sum(vl_material_imp),0),
		coalesce(sum(vl_glosa),0),
		coalesce(sum(vl_saldo),0)
	into STRICT	vl_opm_w,
		vl_opm_apres_w,
		vl_glosa_opm_w,
		vl_saldo_opm_w
	from	pls_conta_mat
	where	nr_seq_conta	= nr_seq_conta_p
	and	ie_tipo_despesa	= '7'
	and	ie_status 	not in ('M','D');
else
	vl_opm_w	:= 0;
	vl_opm_apres_w	:= 0;
	vl_glosa_opm_w	:= 0;
	vl_saldo_opm_w	:= 0;
end if;

vl_cobrado_w	:=	coalesce(vl_proc_apres_w,0) + coalesce(vl_taxas_apres_w,0) + coalesce(vl_diarias_apres_w,0) +
			coalesce(vl_pacotes_apres_w,0) + coalesce(vl_gases_apres_w,0) + coalesce(vl_medic_apres_w,0) +
			coalesce(vl_mat_apres_w,0) + coalesce(vl_opm_apres_w,0);

vl_glosa_w	:=	coalesce(vl_glosa_proc_w,0) + coalesce(vl_glosa_taxa_w,0) + coalesce(vl_glosa_diaria_w,0) +
			coalesce(vl_glosa_pacote_w,0) + coalesce(vl_glosa_gases_w,0) + coalesce(vl_glosa_medic_w,0) +
			coalesce(vl_glosa_mat_w,0) + coalesce(vl_glosa_opm_w,0);

vl_saldo_w	:=	coalesce(vl_saldo_proc_w,0) + coalesce(vl_saldo_taxa_w,0) + coalesce(vl_saldo_diaria_w,0) +
			coalesce(vl_saldo_pacote_w,0) + coalesce(vl_saldo_gases_w,0) + coalesce(vl_saldo_medic_w,0) +
			coalesce(vl_saldo_mat_w,0) + coalesce(vl_saldo_opm_w,0);

/* Obter os valores a serem pagos pelo beneficiario nos casos de produto pós estabelecido por custo operacional */

select	coalesce(sum(vl_beneficiario),0)
into STRICT	vl_proc_beneciciario_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_status 	!= 'D';

select	coalesce(sum(vl_beneficiario),0)
into STRICT	vl_mat_beneciciario_w
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_status 	!= 'D';

select	nr_seq_protocolo
into STRICT	nr_seq_protocolo_w
from 	pls_conta
where	nr_sequencia = nr_seq_conta_p;

select	ie_tipo_protocolo
into STRICT	ie_tipo_protocolo_w
from	pls_protocolo_conta
where 	nr_sequencia = nr_seq_protocolo_w;

/* Quando for protocolo de Reembolso não pode pegar o vl_original pois pode se alterar o valor */

if (ie_tipo_protocolo_w <> 'R')then

	select	coalesce(sum(vl_lib_original),0)
	into STRICT	vl_total_w
	from	pls_conta_medica_resumo
	where	nr_seq_conta = nr_seq_conta_p
	and	((ie_tipo_item <> 'I') or (coalesce(ie_tipo_item::text, '') = ''))
	and	ie_situacao 	= 'A';

end if;

if (coalesce(vl_total_w,0) = 0) then
	vl_total_w	:=	coalesce(vl_procedimentos_w,0) + coalesce(vl_taxas_w,0) + coalesce(vl_diarias_w,0) +
				coalesce(vl_pacotes_w,0) + coalesce(vl_gases_w,0) + coalesce(vl_medicamentos_w,0) +
				coalesce(vl_materiais_w,0) + coalesce(vl_opm_w,0);
end if;
vl_total_beneciciario_w	:= vl_proc_beneciciario_w + vl_mat_beneciciario_w;

select	coalesce(sum(vl_adic_procedimento),0),
	coalesce(sum(vl_adic_co),0),
	coalesce(sum(vl_adic_materiais),0),
	coalesce(sum(vl_co_ptu),0),
	coalesce(sum(vl_procedimento_ptu),0),
	coalesce(sum(vl_material_ptu),0)
into STRICT	vl_adic_procedimento_w,
	vl_adic_co_w,
	vl_adic_materiais_w,
	vl_co_ptu_w,
	vl_procedimento_ptu_w,
	vl_material_ptu_w
from	pls_conta_proc
where	nr_seq_conta	= nr_seq_conta_p
and	ie_status 	not in ('M','D');

select	coalesce(sum(vl_adic_material),0),
	coalesce(sum(vl_material_ptu),0)
into STRICT	vl_adic_materiais_ww,
	vl_material_ptu_ww
from	pls_conta_mat
where	nr_seq_conta	= nr_seq_conta_p
and	ie_status 	not in ('M','D');

vl_adic_procedimento_w	:= (vl_adic_procedimento_w + vl_adic_materiais_ww);
vl_liberado_ptu_w	:= vl_material_ptu_ww + vl_co_ptu_w + vl_procedimento_ptu_w + vl_material_ptu_w;

update	pls_conta
set	vl_procedimentos	= coalesce(vl_procedimentos_w,0),
	vl_diarias		= coalesce(vl_diarias_w,0),
	vl_pacotes		= coalesce(vl_pacotes_w,0),
	vl_taxas		= coalesce(vl_taxas_w,0),
	vl_materiais		= coalesce(vl_materiais_w,0),
	vl_medicamentos		= coalesce(vl_medicamentos_w,0),
	vl_gases		= coalesce(vl_gases_w,0),
	vl_opm			= coalesce(vl_opm_w,0),
	vl_cobrado		= coalesce(vl_cobrado_w,0),
	vl_total		= coalesce(vl_total_w,0),
	vl_glosa		= coalesce(vl_glosa_w,0),
	vl_saldo		= coalesce(vl_saldo_w,0),
	vl_total_beneficiario	= coalesce(vl_total_beneciciario_w,0),
	vl_adic_procedimento	= coalesce(vl_adic_procedimento_w,0),
	vl_adic_co		= coalesce(vl_adic_co_w,0),
	vl_adic_materiais	= coalesce(vl_adic_materiais_w,0),
	vl_liberado_ptu		= coalesce(vl_liberado_ptu_w,0)
where	nr_sequencia		= nr_seq_conta_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_valor_conta ( nr_seq_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

