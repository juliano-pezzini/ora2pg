-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_comunic_ativacao_material ( cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_grupo_material_w		bigint;
cd_subgrupo_material_w 		bigint;
cd_classe_material_w		bigint;
ds_grupo_material_w		varchar(255);
ds_subgrupo_material_w 		varchar(255);
ds_classe_material_w		varchar(255);
ds_comunic_w			varchar(500);
nr_seq_classif_w			bigint;
cd_setor_dest_w			bigint;
nm_usuario_regra_w		varchar(255);
qt_regras_w			bigint;
ds_setor_w			varchar(255);
nm_usuario_dest_w			varchar(4000);
ds_titulo_w			varchar(255);
cd_perfil_w			integer;
ie_ci_lida_w			varchar(1);
nr_seq_comunic_w			bigint;
ie_regra_w			varchar(1);

c01 CURSOR FOR
	SELECT	cd_setor_atendimento,
		cd_perfil,
		ds_usuario_destino,
		coalesce(ie_ci_lida,'N')
	from 	regra_aviso_exec_mat
	where	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
	and	coalesce(cd_material, cd_material_p)			= cd_material_p
	and	coalesce(ie_ativa_cadastro,'N')				= 'S'
	and 	coalesce(cd_funcao, coalesce(obter_funcao_ativa,0)) = coalesce(obter_funcao_ativa,0)
	order by
		coalesce(cd_grupo_material, 0),
		coalesce(cd_subgrupo_material, 0),
		coalesce(cd_classe_material, 0),
		coalesce(cd_material, 0),
		coalesce(cd_funcao,0);

BEGIN

select	max(cd_grupo_material),
	max(cd_subgrupo_material),
	max(cd_classe_material),
	substr(max(ds_grupo_material),1,255),
	substr(max(ds_subgrupo_material),1,255),
	substr(max(ds_classe_material),1,255)
into STRICT	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ds_grupo_material_w,
	ds_subgrupo_material_w,
	ds_classe_material_w
from	estrutura_material_v
where 	cd_material = cd_material_p;

/*select	substr('O material código: ' || cd_material_p || ' - '  || substr(obter_desc_material(cd_material_p),1,120) || ' foi ativado pelo usuário ' || nm_usuario_p || chr(13) || chr(10) ||
	'Grupo: ' || ds_grupo_material_w || chr(13) || chr(10) ||
	'Subgrupo: ' || ds_subgrupo_material_w || chr(13) || chr(10) ||
	'Classe: ' || ds_classe_material_w,1,255),
	'Aviso de material ativo.'
into	ds_comunic_w,
		ds_titulo_w
from 	dual;*/
select	substr(wheb_mensagem_pck.get_texto(314876, 'CD_MATERIAL=' || cd_material_p || ';' ||
						   'DS_MATERIAL=' || substr(obter_desc_material(cd_material_p),1,120) || ';' ||
						   'NM_USUARIO='  || nm_usuario_p) || chr(13) || chr(10) ||
	wheb_mensagem_pck.get_texto(314210, 'DS_GRUPO_MATERIAL=' || ds_grupo_material_w) || chr(13) || chr(10) ||
	wheb_mensagem_pck.get_texto(314211, 'DS_SUBGRUPO_MATERIAL=' || ds_subgrupo_material_w) || chr(13) || chr(10) ||
	wheb_mensagem_pck.get_texto(314212, 'DS_CLASSE_MATERIAL=' || ds_classe_material_w),1,255),
	wheb_mensagem_pck.get_texto(314877)
into STRICT	ds_comunic_w,
	ds_titulo_w
;

select	max(obter_classif_comunic('F'))
into STRICT	nr_seq_classif_w
;

select	count(*)
into STRICT	qt_regras_w
from 	regra_aviso_exec_mat
where	coalesce(ie_ativa_cadastro,'N') = 'S'
and 	coalesce(cd_funcao, coalesce(obter_funcao_ativa,0)) = coalesce(obter_funcao_ativa,0);

ie_regra_w	:=	'N';

if (qt_regras_w > 0) then
	begin
	open c01;
	loop
	fetch c01 into
		cd_setor_dest_w,
		cd_perfil_w,
		nm_usuario_regra_w,
		ie_ci_lida_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (cd_setor_dest_w IS NOT NULL AND cd_setor_dest_w::text <> '') then
			ds_setor_w := ds_setor_w || substr(to_char(cd_setor_dest_w) || ',',1,255);
		end if;

		if (nm_usuario_regra_w IS NOT NULL AND nm_usuario_regra_w::text <> '') then
			nm_usuario_dest_w := substr(nm_usuario_dest_w || nm_usuario_regra_w || ',',1,4000);
		end if;

		ie_regra_w	:=	'S';
		end;
	end loop;
	close 	c01;
	end;
end if;

if (qt_regras_w > 0) and (ie_regra_w = 'S') then
	begin
	select	nextval('comunic_interna_seq')
	into STRICT	nr_seq_comunic_w
	;

	insert into comunic_interna(dt_comunicado,
		ds_titulo,
		ds_comunicado,
		nm_usuario,
		dt_atualizacao,
		ie_geral,
		nm_usuario_destino,
		cd_perfil,
		nr_sequencia,
		ie_gerencial,
		nr_seq_classif,
		ds_perfil_adicional,
		cd_setor_destino,
		cd_estab_destino,
		ds_setor_adicional,
		dt_liberacao,
		ds_grupo,
		nm_usuario_oculto) values (clock_timestamp(),
			ds_titulo_w,
			wheb_rtf_pck.get_texto_rtf(ds_comunic_w),
			nm_usuario_p,
			clock_timestamp(),
			'N',
			nm_usuario_dest_w,
			null,
			nr_seq_comunic_w,
			'N',
			nr_seq_classif_w,
			cd_perfil_w || ',',
			null,
			'',
			ds_setor_w,
			clock_timestamp(),
			'',
			'');

	if (ie_ci_lida_w = 'S') then

		insert into comunic_interna_lida(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao) values (
				nr_seq_comunic_w,
				nm_usuario_p,
				clock_timestamp());

	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_comunic_ativacao_material ( cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

