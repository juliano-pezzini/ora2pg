-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cih_importar_cirurgia_aut ( nr_ficha_ocorrencia_p bigint, nm_usuario_p text, ie_importar_medic_p text, ie_importar_propaci_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

				 
nr_atendimento_w		bigint;
nr_seq_unidade_w		bigint;
nr_seq_cirurgia_cih_w		bigint;
dt_inicio_w			timestamp;
ds_procedimento_w		varchar(255);
cd_medico_cirurgiao_w		bigint;
cd_tipo_cirurgia_w		bigint;
cd_tipo_anestesia_w		varchar(10);
ie_asa_estado_paciente_w 	varchar(3);
ie_carater_cirurgia_w		varchar(1);
nr_min_duracao_real_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
dt_inicio_real_w		timestamp;
dt_fim_cirurgia_w		timestamp;
nr_seq_cirurgia_w		bigint;
nr_seq_interno_w		bigint;
dt_entrada_unidade_w		timestamp;
ie_duracao_cirurgia_w		varchar(10);
cd_clinica_w			bigint;
cd_medicamento_w		bigint;
dt_inicial_utilizacao_w		timestamp;
nr_seq_medic_cirur_w		bigint;
nr_ficha_ocorr_ant_w		bigint;
nr_ficha_ocorr_w		bigint;
ds_aux_w			varchar(70);
ds_erro_w			varchar(4000);
ie_video_w			varchar(1);
ie_tipo_inf_medic_w		varchar(1);
nr_seq_proc_interno_w		bigint;

C01 CURSOR FOR 
	SELECT	a.nr_cirurgia, 
		coalesce(dt_inicio_real, dt_inicio_prevista), 
		b.ds_procedimento, 
		cd_medico_cirurgiao, 
		coalesce(cd_tipo_cirurgia,1), 
		cd_tipo_anestesia, 
		ie_asa_estado_paciente, 
		ie_carater_cirurgia, 
		coalesce(a.nr_min_duracao_real,0), 
		b.cd_procedimento, 
		a.ie_origem_proced, 
		a.dt_inicio_real, 
		CASE WHEN coalesce(a.dt_fim_cirurgia::text, '') = '' THEN coalesce(a.dt_termino,clock_timestamp())  ELSE a.dt_fim_cirurgia END , 
		coalesce(a.dt_entrada_unidade,clock_timestamp()), 
		null ie_video, 
		a.nr_seq_proc_interno 
	from	procedimento b, 
		cirurgia a 
	where	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and	a.cd_procedimento_princ	= b.cd_procedimento 
	and	a.nr_cirurgia		= nr_cirurgia_p 
	and	a.ie_origem_proced	= b.ie_origem_proced 
	and 	(a.dt_entrada_unidade IS NOT NULL AND a.dt_entrada_unidade::text <> '') 
	and	not exists (	SELECT 	1 
				from 	cih_cirurgia c  
				where 	c.nr_seq_cirurgia_pac = a.nr_cirurgia) 
	and (cih_importar_procedimento(b.cd_procedimento,b.ie_origem_proced) = 'S') 
	and	ie_importar_propaci_p	= 'N' 
	
union
 
	select	a.nr_cirurgia, 
		coalesce(a.dt_inicio_real, a.dt_inicio_prevista), 
		b.ds_procedimento, 
		coalesce(c.cd_medico_executor, a.cd_medico_cirurgiao), 
		coalesce(a.cd_tipo_cirurgia,1), 
		a.cd_tipo_anestesia, 
		a.ie_asa_estado_paciente, 
		a.ie_carater_cirurgia, 
		coalesce(a.nr_min_duracao_real,0), 
		b.cd_procedimento, 
		b.ie_origem_proced, 
		a.dt_inicio_real, 
		CASE WHEN coalesce(a.dt_fim_cirurgia::text, '') = '' THEN coalesce(a.dt_termino,clock_timestamp())  ELSE a.dt_fim_cirurgia END , 
		coalesce(a.dt_entrada_unidade,clock_timestamp()), 
		c.ie_video, 
		a.nr_seq_proc_interno 
	from	procedimento b, 
		procedimento_paciente c, 
		cirurgia a 
	where	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and	a.nr_cirurgia		= nr_cirurgia_p 
	and	a.nr_atendimento	= c.nr_atendimento 
	and	a.nr_cirurgia		= c.nr_cirurgia 
	and	c.cd_procedimento	= b.cd_procedimento 
	and	c.ie_origem_proced	= b.ie_origem_proced 
	and 	(a.dt_entrada_unidade IS NOT NULL AND a.dt_entrada_unidade::text <> '') 
	and	not exists (	select	1 
				from 	cih_cirurgia c 
				where	c.nr_seq_cirurgia_pac = a.nr_cirurgia) 
	and (cih_importar_procedimento(b.cd_procedimento,b.ie_origem_proced) = 'S') 
	and	obter_classif_material_proced(null, c.cd_procedimento, c.ie_origem_proced) = '1' 
	and	ie_importar_propaci_p	= 'S';

C02 CURSOR FOR 
	SELECT	c.cd_medicamento, 
		min(a.dt_atendimento) dt_inicial_utilizacao 
	from	material_atend_paciente a, 
		material c 
	where	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and	a.cd_material		= c.cd_material 
	and	a.nr_cirurgia		= nr_seq_cirurgia_w 
	and	ie_tipo_inf_medic_w 	= 'C' 
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '') 
	group	by c.cd_medicamento, 
		c.qt_dia_profilatico, 
		c.qt_dia_terapeutico 
	
union
 
	SELECT	c.cd_medicamento, 
		min(b.dt_inicio_adm) dt_inicial_utilizacao 
	from	cirurgia_agente_anestesico a, 
		cirurgia_agente_anest_ocor b, 
		material c 
	where	b.nr_seq_cirur_agente 	= a.nr_sequencia 
	and	a.cd_material		= c.cd_material 
	and	a.nr_cirurgia		= nr_seq_cirurgia_w 
	and	ie_tipo_inf_medic_w 	= 'A' 
	and	coalesce(a.ie_situacao,'A') = 'A' 
	and	coalesce(b.ie_situacao,'A') = 'A' 
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '') 
	group	by c.cd_medicamento, 
		c.qt_dia_profilatico, 
		c.qt_dia_terapeutico 
	
union
 
	select	max(c.cd_medicamento), 
		min(e.dt_alteracao) dt_inicial_utilizacao 
	from	prescr_mat_alteracao e, 
		prescr_medica a, 
		prescr_material b, 
		material c 
	where 	e.nr_prescricao   	= b.nr_prescricao 
	and 	e.nr_seq_prescricao	= b.nr_sequencia 
	and	a.nr_prescricao		= b.nr_prescricao 
	and	b.cd_material	 	= c.cd_material 
	and 	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and	ie_tipo_inf_medic_w	= 'A' 
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '') 
	and	obter_classif_setor(a.cd_setor_atendimento) = 2 
	and	a.dt_prescricao between to_date(obter_dados_cirurgia(nr_seq_cirurgia_w,'dt'),'dd/mm/yyyy hh24:mi:ss') and to_date(obter_dados_cirurgia(nr_seq_cirurgia_w,'dt'),'dd/mm/yyyy hh24:mi:ss') + 1 
	and	e.ie_alteracao = 3 
	and exists (	select 	1 
			from	prescr_mat_alteracao x 
			where	x.nr_sequencia = (select max(y.nr_sequencia) 
						from	prescr_mat_alteracao y 
						where	y.nr_prescricao = e.nr_prescricao 
						and	y.nr_seq_prescricao = e.nr_seq_prescricao 
						and	y.ie_alteracao = 3 
						and	coalesce(to_char(y.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(y.nr_seq_horario, y.nr_seq_horario_proc), y.nr_seq_horario_rec),y.nr_seq_horario_dieta),y.nr_seq_horario_sae),y.ie_tipo_item,'h'),1,19)) = 
							coalesce(to_char(x.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(x.nr_seq_horario, x.nr_seq_horario_proc), x.nr_seq_horario_rec),x.nr_seq_horario_dieta),x.nr_seq_horario_sae),x.ie_tipo_item,'h'),1,19))) 
			and	x.nr_sequencia = e.nr_sequencia) 
	group	by c.cd_medicamento, 
		e.cd_um_dose_adm, 
		c.qt_dia_profilatico, 
		c.qt_dia_terapeutico;

c03 CURSOR FOR 
	SELECT	a.nr_cirurgia, 
		d.nr_ficha_ocorrencia 
	from	procedimento b, 
		cirurgia a, 
		cih_cirurgia d 
	where	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and 	(a.dt_entrada_unidade IS NOT NULL AND a.dt_entrada_unidade::text <> '') 
	and	a.cd_procedimento_princ	= b.cd_procedimento 
	and	a.ie_origem_proced	= b.ie_origem_proced 
	and	d.nr_seq_cirurgia_pac 	= a.nr_cirurgia 
	and	d.nr_ficha_ocorrencia 	<> nr_ficha_ocorrencia_p 
	and (cih_importar_procedimento(b.cd_procedimento,b.ie_origem_proced) = 'S') 
	
union
 
	SELECT	a.nr_cirurgia, 
		d.nr_ficha_ocorrencia 
	from	procedimento b, 
		procedimento_paciente c, 
		cirurgia a, 
		cih_cirurgia d 
	where	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and 	(a.dt_entrada_unidade IS NOT NULL AND a.dt_entrada_unidade::text <> '') 
	and	a.nr_atendimento	= c.nr_atendimento 
	and	a.nr_cirurgia		= c.nr_cirurgia 
	and	c.cd_procedimento	= b.cd_procedimento 
	and	c.ie_origem_proced	= b.ie_origem_proced 
	and	d.nr_seq_cirurgia_pac 	= a.nr_cirurgia 
	and	d.nr_ficha_ocorrencia 	<> nr_ficha_ocorrencia_p 
	and	ie_importar_propaci_p	= 'S' 
	and (cih_importar_procedimento(b.cd_procedimento,b.ie_origem_proced) = 'S') 
	order by nr_ficha_ocorrencia;
	

BEGIN 
if (nr_ficha_ocorrencia_p <> 0) and (nr_ficha_ocorrencia_p IS NOT NULL AND nr_ficha_ocorrencia_p::text <> '') then 
 
	select	nr_atendimento, 
		cd_clinica 
	into STRICT	nr_atendimento_w, 
		cd_clinica_w 
	from	cih_ficha_ocorrencia 
	where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;
 
	select 	coalesce(max(ie_tipo_inf_medic),'C') 
	into STRICT	ie_tipo_inf_medic_w 
	from	cih_parametros 
	where (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento 
	or (coalesce(cd_estabelecimento::text, '') = '' 
	and not exists (SELECT	1 
			from	cih_parametros 
			where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento)));
			 
			 
open C01;
loop 
fetch C01 into	 
	nr_seq_cirurgia_w, 
	dt_inicio_w, 
	ds_procedimento_w, 
	cd_medico_cirurgiao_w, 
	cd_tipo_cirurgia_w, 
	cd_tipo_anestesia_w, 
	ie_asa_estado_paciente_w, 
	ie_carater_cirurgia_w, 
	nr_min_duracao_real_w, 
	cd_procedimento_W, 
	ie_origem_proced_w, 
	dt_inicio_real_w, 
	dt_fim_cirurgia_w, 
	dt_entrada_unidade_w, 
	ie_video_w, 
	nr_seq_proc_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (coalesce(ie_video_w::text, '') = '') then 
		select 	max(ie_video) 
		into STRICT	ie_video_w 
		from	procedimento_paciente 
		where	nr_cirurgia = nr_seq_cirurgia_w 
		and	cd_procedimento = cd_procedimento_w 
		and	ie_origem_proced = ie_origem_proced_w;
	end if;
	 
	select	coalesce(max(nr_seq_cirurgia),0) + 1 
	into STRICT	nr_seq_cirurgia_cih_w 
	from	cih_cirurgia 
	where	nr_ficha_ocorrencia 	= nr_ficha_ocorrencia_p;
 
	select	coalesce(max(b.nr_seq_interno),0) 
	into STRICT	nr_seq_interno_w 
	from	atend_paciente_unidade a, 
		unidade_atendimento b 
	where	a.cd_unidade_basica	= b.cd_unidade_basica 
	and	a.cd_setor_atendimento 	= b.cd_setor_atendimento 
	and	a.cd_unidade_compl 	= b.cd_unidade_compl 
	and	a.nr_atendimento	= coalesce(nr_atendimento_p, nr_atendimento_w) 
	and	a.dt_entrada_unidade	= dt_entrada_unidade_w;
	 
	ie_duracao_cirurgia_w := 1;
 
	if (nr_min_duracao_real_w > 0) then 
 
		if (nr_min_duracao_real_w < 120) then 
			ie_duracao_cirurgia_w := 2;
		elsif (nr_min_duracao_real_w > 600) then 
			ie_duracao_cirurgia_w := 7;
		elsif (nr_min_duracao_real_w > 480) then 
			ie_duracao_cirurgia_w := 6;
		elsif (nr_min_duracao_real_w > 360) then 
			ie_duracao_cirurgia_w := 5;
		elsif (nr_min_duracao_real_w > 240) then 
			ie_duracao_cirurgia_w := 4;
		elsif (nr_min_duracao_real_w > 120) then 
			ie_duracao_cirurgia_w := 3;
		end if;
 
	end if;	
	 
	insert into cih_cirurgia(nr_ficha_ocorrencia, 
		nr_seq_cirurgia, 
		dt_cirurgia, 
		ds_cirurgia, 
		cd_medico_cirurgiao, 
		ie_duracao_cirurgia, 
		cd_tipo_cirurgia, 
		dt_atualizacao, 
		nm_usuario, 
		cd_tipo_anestesia, 
		ie_asa_estado_paciente, 
		ie_carater_cirurgia, 
		nr_min_duracao_real, 
		cd_procedimento, 
		ie_origem_proced, 
		dt_inicio_real, 
		dt_fim_cirurgia, 
		nr_seq_unidade, 
		nr_seq_cirurgia_pac, 
		ie_video, 
		nr_seq_proc_interno) 
	values (nr_ficha_ocorrencia_p, 
		nr_seq_cirurgia_cih_w, 
		dt_inicio_w, 
		ds_procedimento_w, 
		cd_medico_cirurgiao_w, 
		ie_duracao_cirurgia_w, 
		cd_tipo_cirurgia_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_tipo_anestesia_w, 
		ie_asa_estado_paciente_w, 
		ie_carater_cirurgia_w, 
		nr_min_duracao_real_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		dt_inicio_real_w, 
		dt_fim_cirurgia_w, 
		nr_seq_interno_w, 
		nr_seq_cirurgia_w, 
		ie_video_w, 
		nr_seq_proc_interno_w);
 
		if ( ie_importar_medic_p = 'S') then 
 
			open c02;
			loop 
			fetch c02 into 
				cd_medicamento_w, 
				dt_inicial_utilizacao_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
 
				select coalesce(max(nr_sequencia),0) + 1 
				into STRICT nr_seq_medic_cirur_w 
				from cih_cirurgia_medic;
 
				insert into cih_cirurgia_medic(nr_sequencia, 
					nr_seq_cirurgia, 
					nr_ficha_ocorrencia, 
					cd_medicamento, 
					dt_atendimento, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec) 
				values ( nextval('cih_cirurgia_medic_seq'), --nr_seq_medic_cirur_w, 
					nr_seq_cirurgia_cih_w, 
					nr_ficha_ocorrencia_p, 
					cd_medicamento_w, 
					dt_inicial_utilizacao_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p);
 
			end loop;
			close c02;
		end if;		
	 
	 
	end;
end loop;
close C01;
 
nr_ficha_ocorr_ant_w	:= null;
open c03;
loop 
fetch c03 into 
	nr_seq_cirurgia_w, 
	nr_ficha_ocorr_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
		ds_aux_w	:= null;
		if (nr_ficha_ocorr_w <> nr_ficha_ocorr_ant_w) or (coalesce(nr_ficha_ocorr_ant_w::text, '') = '') then 
			ds_aux_w := WHEB_MENSAGEM_PCK.get_texto(277379,'NR_FICHA_OCORR='||nr_ficha_ocorr_w);
		 
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
			ds_aux_w	:= chr(10) || ds_aux_w;
		end if;
		 
	end if;
	 
	ds_erro_w		:= ds_erro_w || ds_aux_w || nr_seq_cirurgia_w || ' ';
	nr_ficha_ocorr_ant_w	:= nr_ficha_ocorr_w;
	end loop;
close c03;
	ds_erro_p	:= substr(ds_erro_w,1,255);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cih_importar_cirurgia_aut ( nr_ficha_ocorrencia_p bigint, nm_usuario_p text, ie_importar_medic_p text, ie_importar_propaci_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

