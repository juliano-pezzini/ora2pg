-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_patients_by_classif ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR FOR
SELECT	a.nr_sequencia nr_seq_classif,
	a.ds_classificacao ds_classification
from	classif_pessoa a
where	coalesce(a.ie_exibe_pfcs, 'N') = 'S'
and	a.ie_situacao = 'A';

c02 CURSOR(nr_seq_classif_p bigint) FOR
SELECT	obter_nome_pf(a.cd_pessoa_fisica) nm_patient,
	a.cd_pessoa_fisica id_patient,
	a.dt_solicitacao dt_time_request,
	substr(obter_desc_status_gv(a.ie_status,'D'),1,100) ds_status,
	obter_valor_dominio(1410, a.ie_tipo_vaga) ds_type,
	a.nr_atendimento nr_encounter
from	gestao_vaga	a,
	pessoa_classif	b
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	clock_timestamp() between b.dt_inicio_vigencia and coalesce(b.dt_final_vigencia, clock_timestamp())
and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
and	a.ie_status in ('A','H','I','L')
and	b.nr_seq_classif	= nr_seq_classif_p
and	a.cd_estabelecimento	= (cd_estabelecimento_p)::numeric;

qt_total_w				bigint := 0;
pfcs_panel_detail_seq_w			pfcs_panel_detail.nr_sequencia%type;
pfcs_panel_seq_w			pfcs_panel.nr_sequencia%type;
nr_seq_operational_level_w		pfcs_operational_level.nr_sequencia%type;
BEGIN

nr_seq_operational_level_w := pfcs_get_structure_level(
		cd_establishment_p => cd_estabelecimento_p,
		ie_level_p => 'O',
		ie_info_p => 'C');

for c01_w in c01 loop
	begin

	for c02_w in c02(c01_w.nr_seq_classif) loop
		begin

		qt_total_w := qt_total_w + 1;

		select	nextval('pfcs_panel_detail_seq')
		into STRICT	pfcs_panel_detail_seq_w
		;

		insert into pfcs_panel_detail(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			ie_situation,
			nr_seq_indicator,
			nr_seq_operational_level)
		values (
			pfcs_panel_detail_seq_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			'T',
			nr_seq_indicator_p,
			nr_seq_operational_level_w);

		insert into pfcs_detail_patient(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_detail,
			id_patient,
			nm_patient,
			ds_classification,
			nr_encounter)
		values (
			nextval('pfcs_detail_patient_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			pfcs_panel_detail_seq_w,
			c02_w.id_patient,
			c02_w.nm_patient,
			c01_w.ds_classification,
			c02_w.nr_encounter);

		insert into pfcs_detail_bed_request(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_detail,
			dt_time_request,
			ds_status,
			ds_type)
		values (
			nextval('pfcs_detail_bed_request_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			pfcs_panel_detail_seq_w,
			c02_w.dt_time_request,
			c02_w.ds_status,
			c02_w.ds_type);

		end;
	end loop;

	commit;

	 := pfcs_pck.pfcs_generate_results(
			vl_indicator_p => qt_total_w, ds_reference_value_p => c01_w.ds_classification, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => pfcs_panel_seq_w);

	CALL pfcs_pck.pfcs_update_detail(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_panel_p => pfcs_panel_seq_w,
			nr_seq_operational_level_p => nr_seq_operational_level_w,
			nm_usuario_p => nm_usuario_p);

	qt_total_w := 0;

	end;
end loop;

CALL pfcs_pck.pfcs_activate_records(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_patients_by_classif ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

