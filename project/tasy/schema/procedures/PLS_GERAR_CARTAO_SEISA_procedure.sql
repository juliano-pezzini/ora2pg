-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cartao_seisa ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
cd_usuario_plano_w		varchar(255);
qt_caracter_cartao_w		bigint;
nm_beneficiario_w		varchar(255);
dt_contratacao_w		varchar(255);
dt_nascimento_w			varchar(255);
nm_fantasia_w			varchar(255);
ds_acomodacao_w			varchar(255);
nr_identidade_w			varchar(255);
dt_validade_carteira_w		varchar(20);
nr_seq_titular_w		bigint;
nm_titular_w			varchar(255);
cd_usuario_titular_w		varchar(255);
cd_cep_w			varchar(255);
ds_logradouro_w			varchar(255);
ds_bairro_w			varchar(255);
ds_municipio_w			varchar(255);
sg_uf_w				pessoa_juridica.sg_estado%type;
cd_cgc_estipulate_w		varchar(14);
cd_pf_estipulante_w		varchar(10);
ds_observacao_w			varchar(255);
ds_observacao_2_w		varchar(255);
ie_titularidade_w		varchar(10);
ds_estipulante_w		varchar(255);
nr_contrato_w			bigint;
ie_tipo_contratacao_w		varchar(10);
ds_tipo_contratacao_w		varchar(255);
qt_possui_cpt_w			bigint;
ds_possui_cpt_w			varchar(255);
ds_carencia_w			varchar(255);
ds_carencia_ww			varchar(4000);
ie_w				bigint;
nr_seq_plano_w			bigint;
ds_header_w			varchar(1);
nr_seq_contrato_w		bigint;
nr_seq_intercambio_w		bigint;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		b.nr_seq_titular
	from	pls_segurado_carteira	a,
		pls_segurado		b,
		pls_carteira_emissao	c,
		pls_lote_carteira	d
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	c.nr_seq_seg_carteira	= a.nr_sequencia
	and	c.nr_seq_lote		= d.nr_sequencia
	and	d.nr_sequencia		= nr_seq_lote_p;


BEGIN

delete	FROM w_pls_interface_carteira
where	nr_seq_lote	= nr_seq_lote_p;

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	nr_seq_titular_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_w		:= 0;
	ds_carencia_ww	:= '';

	select	c.cd_usuario_plano,
		substr(a.nm_pessoa_fisica,1,50),
		to_char(b.dt_contratacao,'dd/mm/yyyy'),
		to_char(a.dt_nascimento,'dd/mm/yyyy'),
		d.nm_fantasia,
		substr(pls_obter_dados_cart_unimed(b.nr_sequencia,d.nr_sequencia,'DA',1),1,255),
		a.nr_identidade,
		to_char(c.dt_validade_carteira,'dd/mm/yyyy'),
		b.ie_titularidade,
		d.ie_tipo_contratacao,
		d.nr_sequencia,
		b.nr_seq_contrato,
		b.nr_seq_intercambio
	into STRICT	cd_usuario_plano_w,
		nm_beneficiario_w,
		dt_contratacao_w,
		dt_nascimento_w,
		nm_fantasia_w,
		ds_acomodacao_w,
		nr_identidade_w,
		dt_validade_carteira_w,
		ie_titularidade_w,
		ie_tipo_contratacao_w,
		nr_seq_plano_w,
		nr_seq_contrato_w,
		nr_seq_intercambio_w
	from	pessoa_fisica		a,
		pls_segurado		b,
		pls_segurado_carteira	c,
		pls_plano		d
	where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
	and	c.nr_seq_segurado	= b.nr_sequencia
	and	b.nr_seq_plano		= d.nr_sequencia
	and	b.nr_sequencia		= nr_seq_segurado_w;

	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	cd_cgc_estipulante,
			cd_pf_estipulante,
			nr_contrato
		into STRICT	cd_cgc_estipulate_w,
			cd_pf_estipulante_w,
			nr_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
	elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
		select	cd_cgc,
			cd_pessoa_fisica,
			null
		into STRICT	cd_cgc_estipulate_w,
			cd_pf_estipulante_w,
			nr_contrato_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_w;
	end if;

	if (coalesce(dt_validade_carteira_w::text, '') = '') then
		dt_validade_carteira_w	:= 'INDETER';
	end if;

	if (coalesce(nr_seq_titular_w::text, '') = '') then
		begin
		select	c.cd_cep,
			c.ds_endereco || ' ' || coalesce(c.nr_endereco, c.ds_compl_end) || ' ' || c.ds_complemento,
			c.ds_bairro,
			substr(obter_desc_municipio_ibge(c.cd_municipio_ibge),1,255),
			c.sg_estado
		into STRICT	cd_cep_w,
			ds_logradouro_w,
			ds_bairro_w,
			ds_municipio_w,
			sg_uf_w
		from	compl_pessoa_fisica	c,
			pls_segurado		b,
			pessoa_fisica		a
		where	c.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	b.nr_sequencia		= nr_seq_segurado_w;
		exception
		when others then
			cd_cep_w		:= '';
			ds_logradouro_w		:= '';
			ds_bairro_w		:= '';
			ds_municipio_w		:= '';
			sg_uf_w			:= '';
		end;
	else
		begin
		select	c.cd_cep,
			c.ds_endereco || ' ' || coalesce(c.nr_endereco, c.ds_compl_end) || ' ' || c.ds_complemento,
			c.ds_bairro,
			substr(obter_desc_municipio_ibge(c.cd_municipio_ibge),1,255),
			c.sg_estado
		into STRICT	cd_cep_w,
			ds_logradouro_w,
			ds_bairro_w,
			ds_municipio_w,
			sg_uf_w
		from	compl_pessoa_fisica	c,
			pls_segurado		b,
			pessoa_fisica		a
		where	c.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	c.ie_tipo_complemento	= 1
		and	b.nr_sequencia		= nr_seq_titular_w;
		exception
		when others then
			cd_cep_w		:= '';
			ds_logradouro_w		:= '';
			ds_bairro_w		:= '';
			ds_municipio_w		:= '';
			sg_uf_w			:= '';
		end;
	end if;

	select	count(*)
	into STRICT	qt_possui_cpt_w
	from	pls_carencia
	where	nr_seq_segurado	= nr_seq_segurado_w
	and	ie_cpt		= 'S';

	if (qt_possui_cpt_w = 0) then
		ds_possui_cpt_w	:= 'Não';
	else
		select	max(coalesce(dt_inicio_vigencia,dt_contratacao_w) + qt_dias)
		into STRICT	ds_possui_cpt_w
		from	pls_carencia
		where	nr_seq_segurado	= nr_seq_segurado_w
		and	ie_cpt		= 'S';
	end if;

	if (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') then
		select	a.nm_pessoa_fisica,
			c.cd_usuario_plano
		into STRICT	nm_titular_w,
			cd_usuario_titular_w
		from	pls_segurado_carteira	c,
			pls_segurado		b,
			pessoa_fisica		a
		where	c.nr_seq_segurado	= b.nr_sequencia
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
		and	b.nr_sequencia		= nr_seq_titular_w;
		ds_header_w	:= 'D';
	else
		nm_titular_w		:= nm_beneficiario_w;
		cd_usuario_titular_w	:= cd_usuario_plano_w;
		ds_header_w	:= 'T';
	end if;

	if (cd_cgc_estipulate_w IS NOT NULL AND cd_cgc_estipulate_w::text <> '') then
		ds_observacao_w		:= 'VALIDO SOMENTE COM DOC IDENTIDADE';
		ds_estipulante_w	:= 'EMPRESA: ' || nr_contrato_w|| ' ' || substr(obter_nome_pf_pj(null,cd_cgc_estipulate_w),1,52);
		ds_observacao_2_w	:= substr(obter_nome_pf_pj(null,cd_cgc_estipulate_w),1,52);
	elsif (cd_pf_estipulante_w IS NOT NULL AND cd_pf_estipulante_w::text <> '') then
		ds_observacao_w		:= 'VALIDO SOMENTE COM RG E O ULTIMO COMPROVANTE PAGAMENTO';
		ds_estipulante_w	:= 'PESSOA FÍSICA ';
		ds_observacao_2_w	:= 'X';
	end if;
	qt_caracter_cartao_w	:= length(cd_usuario_plano_w);
	if (qt_caracter_cartao_w <= 8) then
		cd_usuario_plano_w	:= 'CÓDIGO: '|| cd_usuario_plano_w || ' DV ';
	elsif (qt_caracter_cartao_w = 10) then
		cd_usuario_plano_w	:= 'CÓDIGO: '|| substr(cd_usuario_plano_w,1,qt_caracter_cartao_w-1) || ' DV: ' || substr(cd_usuario_plano_w,qt_caracter_cartao_w,qt_caracter_cartao_w);
	end if;
	nm_titular_w		:= 'TITULAR: ' || upper(nm_titular_w);
	nm_beneficiario_w	:= 'BENEFICIÁRIO: ' || upper(nm_beneficiario_w);
	nm_fantasia_w		:= substr(nm_fantasia_w,1,27) || ' ' || ie_tipo_contratacao_w;
	ds_tipo_contratacao_w	:= substr(obter_valor_dominio(1666,ie_tipo_contratacao_w),1,255);

	while(ie_w < 7) loop
		ie_w	:= ie_w + 1;
		ds_carencia_w	:= substr(pls_obter_dados_cart_unimed(nr_seq_segurado_w,nr_seq_plano_w,'CA',ie_w),1,255);
		IF (coalesce(ds_carencia_w::text, '') = '') then
			ds_carencia_w	:= ';';
		end if;
		if (ie_w = 7) then
			ds_carencia_ww	:= ds_carencia_ww ||ds_carencia_w;
		else
			ds_carencia_ww	:= ds_carencia_ww ||ds_carencia_w||';';
		end if;
	end loop;

	insert	into	w_pls_interface_carteira(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_lote,nr_seq_segurado,cd_usuario_plano,ds_estipulante,nm_titular,
			nm_beneficiario,nm_plano,ds_acomodacao,ds_tipo_contratacao,cd_identidade,
			dt_nascimento,dt_adesao,dt_validade_carteira,ds_carencia,ie_dlp,ie_tipo_dlp,
			ds_branco,ds_observacao,cd_usuario_titular,cd_cep,ds_logradouro,
			ds_bairro,ds_municipio,sg_uf,ie_titularidade,ds_observacao_2,ds_header)
	values (	nextval('w_pls_interface_carteira_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_lote_p,nr_seq_segurado_w,cd_usuario_plano_w,ds_estipulante_w,nm_titular_w,
			nm_beneficiario_w,nm_fantasia_w,ds_acomodacao_w,ds_tipo_contratacao_w,nr_identidade_w,
			dt_nascimento_w,dt_contratacao_w,dt_validade_carteira_w,ds_carencia_ww,'CPT',ds_possui_cpt_w,
			'',ds_observacao_w,cd_usuario_titular_w,cd_cep_w,ds_logradouro_w,
			ds_bairro_w,ds_municipio_w,sg_uf_w,ie_titularidade_w,ds_observacao_2_w,ds_header_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cartao_seisa ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

