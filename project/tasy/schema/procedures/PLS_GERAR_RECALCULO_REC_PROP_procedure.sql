-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_recalculo_rec_prop (( nr_seq_lote_p pls_lote_recalculo.nr_sequencia%type, ie_apenas_fins_contabeis_p text, nm_usuario_p usuario.nm_usuario%type)is cd_estabelecimento_w estabelecimento.cd_estabelecimento%type) RETURNS bigint AS $body$
DECLARE


valor_base_w	pls_conta_recalculo.vl_base%type := 0;

BEGIN

t_prest_rec_proprio_w.delete;

if (t_prest_rec_proprio_w.count > 0) then
	for i in t_prest_rec_proprio_w.first .. t_prest_rec_proprio_w.last loop

		if (t_prest_rec_proprio_w(i) = nr_seq_prestador_p) then
			valor_base_w := t_val_rec_proprio_w(i);
		end if;

	end loop;
end if;

if (valor_base_w = 0) then
	valor_base_w := pls_obter_valor_rec_proprio(nr_seq_prestador_p, dt_mes_competencia_w);
	t_prest_rec_proprio_w(index_w) := nr_seq_prestador_p;
	t_val_rec_proprio_w(index_w) := valor_base_w;
	index_w := index_w + 1;
end if;

return valor_base_w;

end;
			
begin
	/* Obter dados do lote */

	select	nr_seq_regra,
			trunc(dt_mes_competencia, 'month'),
			coalesce(nr_seq_prestador_exec,0),
			coalesce(ie_tipo_data_periodo,'A'),
			dt_inicio_periodo,
			dt_fim_periodo,
			cd_estabelecimento,
			coalesce(ie_recalcular_pos,'N'),
			coalesce(ie_recalcular_copartic,'N'),
			coalesce(ie_protocolo,'N'),
			coalesce(vl_desc_proprio, 0),
			coalesce(ie_tipo_valor_base, 'I')
	into STRICT	nr_seq_regra_w,
			dt_mes_competencia_w,
			nr_seq_prest_exec_lote_w,
			ie_tipo_data_periodo_w,
			dt_inicio_periodo_w,
			dt_fim_periodo_w,
			cd_estabelecimento_w,
			ie_recalcular_pos_w,
			ie_recalcular_copartic_w,
			ie_selecionar_protocolo_w,
			vl_desconto_rec_proprias_w,
			ie_tipo_valor_base_w
	from	pls_lote_recalculo
	where	nr_sequencia = nr_seq_lote_p;



	for r_c01_w in c01 loop
	
		ie_tipo_item_w := r_c01_w.ie_tipo_item;
		cd_procedimento_w := r_c01_w.cd_procedimento;
		ie_origem_proced_w := r_c01_w.ie_origem_proced;
		nr_seq_cod_material_w := r_c01_w.nr_seq_material;
		nr_seq_item_w := r_c01_w.nr_sequencia;
		nr_seq_conta_w := r_c01_w.nr_seq_conta;
		vl_liberado_w := r_c01_w.vl_liberado;
		nr_seq_prestador_partic_w := r_c01_w.nr_seq_prestador_partic;
		nr_seq_prestador_exec_w := r_c01_w.nr_seq_prestador_exec;
		nr_seq_protocolo_w := r_c01_w.nr_seq_protocolo;
		vl_total_conta_w := r_c01_w.vl_total;
		cd_medico_executor_w := r_c01_w.cd_medico_executor;
		nr_seq_segurado_w := r_c01_w.nr_seq_segurado;
		ie_status_w := r_c01_w.ie_status;
		ie_origem_conta_w := r_c01_w.ie_origem_conta;
		nr_seq_prestador_prot_w := r_c01_w.nr_seq_prestador;
		ie_status_protocolo_w := r_c01_w.ie_status_protocolo;
		dt_atendimento_w := r_c01_w.dt_atendimento;
		nr_lote_contabil_w := r_c01_w.nr_lote_contabil;
		ie_tipo_despesa_proc_w :=  r_c01_w.ie_tipo_despesa_proc;
		ie_tipo_despesa_mat_w := r_c01_w.ie_tipo_despesa_mat;
		dt_mes_competencia_prot_w := r_c01_w.dt_mes_competencia;
		ie_tipo_conta_w := r_c01_w.ie_tipo_conta;
		nr_seq_conta_resumo_w := r_c01_w.nr_seq_conta_resumo;
		ie_tipo_protocolo_w := r_c01_w.ie_tipo_protocolo;
		ie_preco_w := r_c01_w.ie_preco;
		
		ie_carater_internacao_w := r_c01_w.ie_carater_internacao;
		nr_seq_tipo_atendimento_w :=   r_c01_w.nr_seq_tipo_atendimento;
		ie_carater_internacao_princ_w := r_c01_w.ie_carater_internacao_princ;
		nr_tipo_atendimento_princ_w := r_c01_w.nr_tipo_atendimento_princ;
		ie_tipo_guia_princ_w := r_c01_w.ie_tipo_guia_princ;	
		ie_tipo_guia_w := r_c01_w.ie_tipo_guia;
		ie_regime_atendimento_w := r_c01_w.ie_regime_atendimento;
		ie_saude_ocupacional_w := r_c01_w.ie_saude_ocupacional;
		ie_regime_atendimento_princ_w := r_c01_w.ie_regime_atendimento_princ;
		
	
		nr_seq_procedimento_w	:= '';
		nr_seq_material_w	:= '';

		if (ie_tipo_item_w = 'P') then
			nr_seq_procedimento_w	:= nr_seq_item_w;

			select	max(nr_seq_grupo_rec)
			into STRICT	nr_seq_grupo_rec_w
			from	procedimento
			where	cd_procedimento		= cd_procedimento_w
			and		ie_origem_proced	= ie_origem_proced_w;

		else
			nr_seq_material_w	:= nr_seq_item_w;
		end if;

		/*A regra de criterio e zerada para que ao entrar em um novo procedimento que nao entra ne curosr 2 o novo procedimento nao pegue a ultima regra utilizada.
		Assim cada procedimento so recebe  a regra destinada a ele */
		nr_seq_criterio_w  := 0;
		select	count(1)
		into STRICT	qt_prot_conta_titulo_w
		from	pls_prot_conta_titulo
		where	nr_seq_protocolo	= r_c01_w.nr_seq_protocolo
		and		(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '');
			
		if (coalesce(cd_procedimento_w,0) > 0) then
			SELECT * FROM pls_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;
			nr_seq_estrut_mat_w := 0; -- tratamento realizado par alimpar a variavel ou e material ou e procedimento
		elsif (coalesce(nr_seq_cod_material_w,0) > 0) then
			-- tratamento realizado par alimpar a variavel ou e material ou e procedimento
			cd_area_procedimento_w	:= 0;
			cd_especialidade_w	:= 0;
			cd_grupo_proc_w		:= 0;
		end if;
					
		/* Obter dados do beneficiario */

		select	max(a.nr_seq_contrato),
				max(a.nr_seq_congenere),
				max(a.nr_seq_intercambio)
		into STRICT	nr_seq_contrato_w,
				nr_seq_congenere_w,
				nr_seq_intercambio_w
		from	pls_segurado a
		where	a.nr_sequencia = nr_seq_segurado_w;

		/* Obter dados do prestador */

		if (nr_seq_prestador_exec_w IS NOT NULL AND nr_seq_prestador_exec_w::text <> '') then
			select	max(nr_seq_tipo_prestador),
					max(nr_seq_classificacao),
					max(cd_cgc),
					max(cd_pessoa_fisica)
			into STRICT	nr_seq_tipo_prestador_w,
					nr_seq_classificacao_w,
					cd_cgc_w,
					cd_pessoa_fisica_w
			from	pls_prestador
			where	nr_sequencia = nr_seq_prestador_exec_w;
		else
			nr_seq_tipo_prestador_w	:= null;
		end if;

		ie_cooperado_w := pls_obter_se_cooperado_ativo(cd_medico_executor_w, dt_atendimento_w, null );
		if (ie_cooperado_w = 'N' and ie_tipo_item_w = 'P') then
			select	count(1)
			into STRICT	qt_registos_partic
			from	pls_proc_participante a
			where	a.nr_seq_conta_proc = nr_seq_procedimento_w
			and	pls_obter_se_cooperado_ativo(a.cd_medico, dt_atendimento_w, null ) = 'S';

			if (qt_registos_partic > 0) then
				ie_cooperado_w := 'S';
			end if;
		end if;

		for r_c02_w in C02 loop

			ie_excecao_w := pls_obter_se_crit_valor_exc(r_c02_w.nr_sequencia, ie_carater_internacao_w, ie_carater_internacao_princ_w,
																	ie_origem_conta_w, ie_tipo_guia_w, ie_tipo_guia_princ_w,
																	nr_seq_tipo_atendimento_w, nr_tipo_atendimento_princ_w, nr_seq_prestador_exec_w,
																	nr_seq_classificacao_w, ie_regime_atendimento_w, ie_regime_atendimento_princ_w,
																	ie_saude_ocupacional_w, nr_seq_contrato_w, nr_seq_intercambio_w);
					
			if ( ie_excecao_w = 'N') then
				nr_seq_criterio_ww	 	:= r_c02_w.nr_sequencia;
				nr_seq_grupo_prestador_w := r_c02_w.nr_seq_grupo_prestador;
				ie_estrutura_ww		 	:= r_c02_w.ie_estrutura;
				nr_seq_estrut_mat_w	 	:= r_c02_w.nr_seq_estrut_mat;
				nr_seq_prestador_pgto_w	 := r_c02_w.nr_seq_prestador_pag;
				ie_exclui_ajuste_valor_w := r_c02_w.ie_exclui_ajuste_valor;
				nr_seq_regra_fixo_pgto_w := null;
				ie_estrut_mat_w			:= 'S';
				ie_grupo_prestador_w 	:= 'S';
				qt_prestador_pag_w 		:= 0;
				ie_grupo_contrato_w 	:= 'S';

				if (nr_seq_estrut_mat_w IS NOT NULL AND nr_seq_estrut_mat_w::text <> '') then
					ie_estrut_mat_w	:= pls_obter_se_estruturas_mat(	nr_seq_estrut_mat_w,nr_seq_material_w);
				end if;

				/* Grupo de prestadores */

				if (coalesce(nr_seq_grupo_prestador_w,0) > 0) and (ie_estrut_mat_w = 'S') then
					ie_grupo_prestador_w := pls_se_grupo_preco_prestador(	nr_seq_grupo_prestador_w, nr_seq_prestador_exec_w, nr_seq_classificacao_w);
				end if;

				if (r_c02_w.nr_seq_grupo_contrato IS NOT NULL AND r_c02_w.nr_seq_grupo_contrato::text <> '') then
					ie_grupo_contrato_w := pls_se_grupo_preco_contrato(	r_c02_w.nr_seq_grupo_contrato, nr_seq_contrato_w, nr_seq_intercambio_w);
				end if;

				if (nr_seq_prestador_pgto_w IS NOT NULL AND nr_seq_prestador_pgto_w::text <> '') and (ie_grupo_prestador_w = 'S') and (ie_estrut_mat_w = 'S') and (ie_grupo_contrato_w = 'S') then

					if (nr_seq_prestador_pgto_w = r_c01_w.nr_seq_prestador_pgto) then
						qt_prestador_pag_w := 1;
					end if;

				end if;

				if (r_c02_w.nr_seq_prestador_partic IS NOT NULL AND r_c02_w.nr_seq_prestador_partic::text <> '') and (nr_seq_regra_fixo_partic_w > 0) then

					nr_seq_regra_fixo_w := nr_seq_regra_fixo_partic_w;

				elsif (nr_seq_regra_fixo_pgto_w IS NOT NULL AND nr_seq_regra_fixo_pgto_w::text <> '') then
					nr_seq_regra_fixo_w := nr_seq_regra_fixo_pgto_w;
				end if;

				if (ie_grupo_prestador_w	= 'S') and
					((coalesce(nr_seq_prestador_pgto_w::text, '') = '')or
					(nr_seq_prestador_pgto_w IS NOT NULL AND nr_seq_prestador_pgto_w::text <> '' AND qt_prestador_pag_w > 0 )) and (ie_estrut_mat_w	= 'S') and (ie_grupo_contrato_w = 'S') then
					nr_seq_criterio_w	:= nr_seq_criterio_ww;
					ie_estrutura_w		:= ie_estrutura_ww;
				end if;

				if (ie_exclui_ajuste_valor_w = 'S') and (nr_seq_procedimento_w IS NOT NULL AND nr_seq_procedimento_w::text <> '') then
					select	max(ie_tipo_liberacao)
					into STRICT	ie_tipo_liberacao_w
					from	pls_conta_proc
					where	nr_sequencia = nr_seq_item_w;

					if (ie_tipo_liberacao_w = 'AV') then
						nr_seq_criterio_w := null;
					end if;
				end if;
			end if;
			
		end loop;

		if (ie_estrutura_w = 'N') then
			nr_seq_criterio_w := null;
		end if;

		if (coalesce(nr_seq_criterio_w, 0) > 0) then

			select	max(nr_seq_prestador_pag)
			into STRICT	nr_seq_prestador_pgto_w
			from	pls_criterio_recalculo
			where	nr_sequencia	= nr_seq_criterio_w;

			select	count(1)
			into STRICT	aux_w
			from	sip_nv_dados a
			where	a.ie_conta_enviada_ans = 'S'
			and		a.nr_seq_conta = nr_seq_conta_w
			and	exists (	SELECT	1
						from	pls_lote_sip b
						where	b.nr_sequencia = a.nr_seq_lote_sip
						and		(b.dt_envio IS NOT NULL AND b.dt_envio::text <> ''));

			if (aux_w > 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(338028);
			end if;

			select	max(nr_sequencia)
			into STRICT	nr_seq_conta_recalculo_w
			from	pls_conta_recalculo
			where	nr_seq_conta	= nr_seq_conta_w
			and	nr_seq_lote	= nr_seq_lote_p;

			if (coalesce(nr_seq_conta_recalculo_w,0) = 0) then
				select	nextval('pls_conta_recalculo_seq')
				into STRICT	nr_seq_conta_recalculo_w
				;

				vl_base_w := recuperar_val_recurso_proprio(coalesce(nr_seq_prestador_pgto_w,nr_seq_prestador_exec_w));
				vl_base_com_desconto_w 	:= vl_base_w - vl_desconto_rec_proprias_w;

				if	((vl_desconto_rec_proprias_w > vl_base_w) and (coalesce(ie_tipo_valor_base_w, 'I') <> 'C')) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(335051);

				end if;

				ie_gerou_recalculo_w := 'S';
				insert into pls_conta_recalculo(nr_sequencia, nr_seq_lote, nr_seq_conta,
					dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
					nm_usuario_nrec, vl_conta_atual, vl_conta,
					nr_seq_prestador, nr_seq_protocolo, cd_pessoa_fisica,
					cd_cgc, cd_medico_executor, vl_base, vl_base_orig,
					nr_seq_regra_fixo, dt_mes_competencia)
				values (	nr_seq_conta_recalculo_w, nr_seq_lote_p, nr_seq_conta_w,
					clock_timestamp(), nm_usuario_p, clock_timestamp(),
					nm_usuario_p, vl_total_conta_w, 0,
					coalesce(nr_seq_prestador_pgto_w,nr_seq_prestador_exec_w), nr_seq_protocolo_w, cd_pessoa_fisica_w,
					cd_cgc_w, cd_medico_executor_w, vl_base_com_desconto_w, vl_base_w,
					nr_seq_regra_fixo_w, dt_mes_competencia_prot_w);
			end if;

			if (coalesce(nr_seq_procedimento_w,0) > 0) then
				cd_item_w	:= cd_procedimento_w;
				ds_item_w	:= substr(obter_descricao_procedimento(cd_procedimento_w, ie_origem_proced_w),1,255);
				ie_tipo_item_w	:= 'P';
			elsif (coalesce(nr_seq_material_w,0) > 0) then
				cd_item_w	:= nr_seq_cod_material_w;
				ds_item_w	:= substr(pls_obter_desc_material(nr_seq_cod_material_w),1,255);
				ie_tipo_item_w	:= 'M';
			end if;

			insert into pls_item_recalculo(nr_sequencia, nr_seq_conta, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nr_seq_procedimento, nr_seq_material, vl_item_atual,
				vl_item, cd_item, ds_item,
				ie_tipo_item, nr_regra_recalculo, nr_seq_cta_conta,
				nr_seq_conta_resumo)
			values (	nextval('pls_item_recalculo_seq'), nr_seq_conta_recalculo_w, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				nr_seq_procedimento_w, nr_seq_material_w, vl_liberado_w,
				0, cd_item_w, ds_item_w,
				ie_tipo_item_w, nr_seq_criterio_w, nr_seq_conta_w,
				nr_seq_conta_resumo_w);
		end if;

	end loop; --Fim loop cursor C01
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_recalculo_rec_prop (( nr_seq_lote_p pls_lote_recalculo.nr_sequencia%type, ie_apenas_fins_contabeis_p text, nm_usuario_p usuario.nm_usuario%type)is cd_estabelecimento_w estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

