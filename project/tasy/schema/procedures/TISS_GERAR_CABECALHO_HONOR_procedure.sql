-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_cabecalho_honor ( nr_seq_conta_guia_p bigint, nr_seq_guia_nova_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


cd_ans_w		varchar(100);
nr_atendimento_w		bigint;
nr_interno_conta_w	bigint;
nr_seq_procedimento_w	bigint;
cd_autorizacao_w		varchar(100);
cd_senha_w		varchar(100);
cd_medico_executor_w	varchar(10);
dt_inicio_vigencia_w	timestamp;
dt_final_vigencia_w	timestamp;
nr_seq_guia_w		bigint;
nr_cpf_w			varchar(15);
nm_medico_executor_w	varchar(255);
sg_conselho_w		varchar(15);
nr_crm_w		varchar(20);
cd_categoria_conv_w	varchar(20);
uf_crm_w		varchar(2);
cd_cbo_saude_w		varchar(20);
ie_tipo_atendimento_w	varchar(20);
ie_tipo_saida_w		varchar(20);
nr_seq_conta_guia_w	bigint;
dt_entrada_w		timestamp;
dt_alta_w			timestamp;
cd_estabelecimento_w	bigint := 0;
cd_cnes_w		varchar(20);
ds_funcao_medico_w	varchar(25);
cd_especialidade_w	integer;
cd_cgc_honorario_w	varchar(200);
cd_cgc_estab_w		varchar(200);
cd_convenio_w		integer;
cd_interno_w		varchar(30);
nr_seq_apresent_w	bigint;
vl_total_w		double precision;
nm_contratado_w		varchar(255);
cd_autorizacao_princ_w	varchar(255);
cd_tipo_acomodacao_w	varchar(40);
cd_prestador_convenio_w	varchar(255) := '';
cd_pessoa_fisica_w	varchar(10);
nm_pessoa_fisica_w	varchar(100);
nr_cartao_nac_sus_w	numeric(20);
ds_plano_w		varchar(100);
dt_validade_carteira_w	timestamp;
cd_usuario_convenio_w	varchar(30);
cd_interno_honor_w	varchar(30);
cd_cgc_honor_w		varchar(20);
nr_cpf_honor_w		varchar(30);
nm_contratado_honor_w	varchar(255);
cd_cnes_honor_w		varchar(50);
ds_observacao_w		varchar(255);
nr_cpf_prof_w		varchar(255);
cd_medico_prof_w	varchar(255);
ie_clinica_w		bigint;
nr_seq_classif_atend_w	bigint;
nr_guia_prestador_w	varchar(60);
ie_cd_autorizacao_relat_w	varchar(255);
cd_setor_entrada_w	bigint;
ie_tipo_atend_tiss_w	varchar(10);
ds_assinatura_resp_w	varchar(255)	:= null;
ds_assinatura_exec_w	varchar(255)	:= null;
ie_atendimento_rn_w	varchar(2);
dt_inicio_faturamento_w	timestamp;
dt_fim_faturamento_w	timestamp;
ds_versao_w		varchar(20);
dt_mesano_referencia_w	timestamp;
c01 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.cd_medico_executor,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	a.cd_cgc_prestador,
	a.cd_autorizacao_princ,
	b.ie_tipo_acomodacao,
	b.dt_entrada,
	b.dt_alta,
	a.cd_convenio,
	a.cd_ans,
	a.vl_total,
	b.cd_pessoa_fisica,
	b.nm_pessoa_fisica,
	b.nr_cartao_nac_sus,
	b.ds_plano,
	b.dt_validade_carteira,
	b.cd_usuario_convenio,
	a.cd_senha,
	a.dt_emissao_guia,
	a.dt_fim_vigencia,
	c.cd_estabelecimento,
	a.ds_observacao,
	a.nr_guia_prestador,
	b.ie_atendimento_rn,
	a.dt_inicio_faturamento,
	a.dt_fim_faturamento,
	c.dt_mesano_referencia
FROM tiss_conta_atend b, tiss_conta_guia a
LEFT OUTER JOIN conta_paciente c ON (a.nr_interno_conta = c.nr_interno_conta)
WHERE a.nr_interno_conta	= b.nr_interno_conta and a.nr_sequencia		= nr_seq_conta_guia_p and a.ie_tiss_tipo_guia	= '6';


BEGIN

if (coalesce(nr_seq_conta_guia_p, 0) > 0) then

	open c01;
	loop
	fetch c01 into
		nr_seq_conta_guia_w,
		nr_atendimento_w,
		nr_interno_conta_w,
		cd_autorizacao_w,
		cd_medico_executor_w,
		ie_tipo_atendimento_w,
		ie_tipo_saida_w,
		cd_cgc_honorario_w,
		cd_autorizacao_princ_w,
		cd_tipo_acomodacao_w,
		dt_entrada_w,
		dt_alta_w,
		cd_convenio_w,
		cd_ans_w,
		vl_total_w,
		cd_pessoa_fisica_w,
		nm_pessoa_fisica_w,
		nr_cartao_nac_sus_w,
		ds_plano_w,
		dt_validade_carteira_w,
		cd_usuario_convenio_w,
		cd_senha_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		cd_estabelecimento_w,
		ds_observacao_w,
		nr_guia_prestador_w,
		ie_atendimento_rn_w,
		dt_inicio_faturamento_w,
		dt_fim_faturamento_w,
		dt_mesano_referencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	coalesce(max(ie_cd_autorizacao_relat),'O')
		into STRICT	ie_cd_autorizacao_relat_w
		from	tiss_parametros_convenio
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_convenio		= cd_convenio_w;
		
		select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w, dt_mesano_referencia_w)
		into STRICT	ds_versao_w
		;

		select	max((obter_clinica_atend(nr_atendimento_w, 'C'))::numeric ),
			max((Obter_Classificacao_Atend(nr_atendimento_w,'C'))::numeric ),
			max(Obter_Setor_Atendimento(nr_atendimento_w))
		into STRICT	ie_clinica_w,
			nr_seq_classif_atend_w,
			cd_setor_entrada_w
		;
		
		select	max(nr_atendimento)
		into STRICT	ie_tipo_atend_tiss_w
		from	atendimento_paciente
		where	nr_atendimento	= nr_atendimento_w;

		select	max(nr_seq_apresent),
			max(cd_categoria_parametro)
		into STRICT	nr_seq_apresent_w,
			cd_categoria_conv_w
		from	conta_paciente
		where	nr_interno_conta	= nr_interno_conta_w;

		select	max(cd_cgc)
		into STRICT	cd_cgc_estab_w
		from	estabelecimento
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (coalesce(ie_cd_autorizacao_relat_w,'O') = 'P') then
			cd_autorizacao_w	:= coalesce(nr_guia_prestador_w,cd_autorizacao_w);
		end if;

		select	nextval('w_tiss_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		insert	into w_tiss_guia(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_ans,
			cd_autorizacao,
			dt_autorizacao,
			cd_senha,
			dt_validade_senha,
			dt_emissao_guia,
			nr_interno_conta,
			nr_seq_protocolo,
			cd_autorizacao_princ,
			nr_seq_apresentacao,
			nr_atendimento,
			ie_tiss_tipo_guia,
			ds_observacao,
			ds_assinatura_resp,
			ds_assinatura_exec,
			nr_guia_prestador,
			ie_atendimento_rn,
			dt_inicio_faturamento,
			dt_fim_faturamento,
			ds_versao)
		values (nr_seq_guia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_ans_w,
			cd_autorizacao_w,
			dt_inicio_vigencia_w,
			cd_senha_w,
			dt_final_vigencia_w,
			dt_inicio_vigencia_w,
			nr_interno_conta_w,
			null,
			cd_autorizacao_princ_w,
			nr_seq_apresent_w,
			nr_atendimento_w,
			'6',
			tiss_obter_regra_campo(6, 'DS_OBSERVACAO', cd_convenio_w, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(6, 'DS_ASSINATURA_RESP', cd_convenio_w, ds_assinatura_resp_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			tiss_obter_regra_campo(6, 'DS_ASSINATURA_EXEC', cd_convenio_w, ds_assinatura_exec_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			nr_guia_prestador_w,
			ie_atendimento_rn_w,
			dt_inicio_faturamento_w,
			dt_fim_faturamento_w,
			ds_versao_w);

		insert	into w_tiss_beneficiario(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_pessoa_fisica,
			nm_pessoa_fisica,
			nr_cartao_nac_sus,
			ds_plano,
			dt_validade_carteira,
			cd_usuario_convenio)
		SELECT	nextval('w_tiss_beneficiario_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_pessoa_fisica_w,
			nm_pessoa_fisica_w,
			nr_cartao_nac_sus_w,
			ds_plano_w,
			dt_validade_carteira_w,
			cd_usuario_convenio_w
		;

		-- SETAR CONTRATADO
		cd_interno_w			:= null;

		select	max(a.cd_cgc),
			max(a.cd_interno),
			max(a.nr_cpf),
			max(a.nm_contratado),
			max(a.cd_cnes)
		into STRICT	cd_cgc_honorario_w,
			cd_interno_w,
			nr_cpf_w,
			nm_contratado_w,
			cd_cnes_w
		from	tiss_conta_contrat_exec a
		where	a.nr_seq_guia	= nr_seq_conta_guia_p;

		if (coalesce(cd_cgc_honorario_w::text, '') = '') and (coalesce(nr_cpf_w::text, '') = '') and (coalesce(cd_interno_w::text, '') = '') then

			select	cd_cnes,
				substr(ds_razao_social,1,255)
			into STRICT	cd_cnes_w,
				nm_contratado_w
			from	pessoa_juridica
			where	cd_cgc			= cd_cgc_estab_w;

			select	coalesce(max(obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_w, 'CD_INTERNO')), 0)
			into STRICT	cd_interno_w
			from	convenio
			where	cd_convenio	= cd_convenio_w;

		elsif (cd_cgc_honorario_w IS NOT NULL AND cd_cgc_honorario_w::text <> '') then

			select	cd_cnes,
				substr(ds_razao_social,1,255)
			into STRICT	cd_cnes_w,
				nm_contratado_w
			from	pessoa_juridica
			where	cd_cgc		= cd_cgc_honorario_w;

			if (cd_cgc_honorario_w = cd_cgc_estab_w) then
				select	max(cd_interno)
				into STRICT	cd_interno_w
				from	convenio_estabelecimento
				where	cd_convenio		= cd_convenio_w
				and	cd_estabelecimento	= cd_estabelecimento_w;
			else
				cd_interno_w	:= obter_prestador_convenio(cd_cgc_honorario_w, cd_convenio_W,cd_categoria_conv_w);
			end if;
		end if;

		select	max(cd_prestador_convenio)
		into STRICT	cd_prestador_convenio_w
		from	protocolo_convenio a,
			conta_paciente b
		where	a.nr_seq_protocolo	= b.nr_seq_protocolo
		and	b.nr_interno_conta	= nr_interno_conta_w;

		insert	into w_tiss_contratado(nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 nr_seq_guia,
			 cd_cgc,
			 cd_interno,
			 nm_contratado,
			 cd_cnes)
		SELECT	 nextval('w_tiss_contratado_seq'),
			 clock_timestamp(),
			 nm_usuario_p,
			 nr_seq_guia_w,
			 coalesce(cd_cgc_honorario_w, cd_cgc_estab_w),
			 tiss_obter_regra_campo(6, 'CD_INTERNO_EXEC', cd_convenio_w, substr(coalesce(cd_prestador_convenio_w, coalesce(cd_interno_w,nr_cpf_w)),1,255), ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			 tiss_obter_regra_campo(6, 'NM_CONTRATADO', cd_convenio_w, nm_contratado_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
			 cd_cnes_w
		;
		-- FIM **** SETAR CONTRATADO


		-- SETAR CONTRATADO EXECUTANTE
		select	max(cd_especialidade),
			max(ie_funcao_medico)
		into STRICT	cd_especialidade_w,
			ds_funcao_medico_w
		from	tiss_conta_proc
		where	nr_seq_guia	= nr_seq_conta_guia_w;

		select	max(nr_cpf_compl),
			max(nm_exec_compl),
			max(sg_conselho_compl),
			max(nr_crm_compl),
			max(uf_conselho_compl),
			max(cd_cbos_compl) cd_cbo_saude,
			max(cd_cnes_compl),
			max(cd_interno_honor),
			max(cd_cgc_honor),
			max(nr_cpf_honor),
			max(nm_contratado_honor),
			max(cd_cnes_honor),
			max(cd_pessoa_fisica)
		into STRICT	nr_cpf_w,
			nm_medico_executor_w,
			sg_conselho_w,
			nr_crm_w,
			uf_crm_w,
			cd_cbo_saude_w,
			cd_cnes_w,
			cd_interno_honor_w,
			cd_cgc_honor_w,
			nr_cpf_honor_w,
			nm_contratado_honor_w,
			cd_cnes_honor_w,
			cd_medico_prof_w
		from	tiss_conta_contrat_exec
		where	nr_seq_guia	= nr_seq_conta_guia_w;

--		cd_interno_w	:= obter_medico_convenio(cd_estabelecimento_w, cd_medico_executor_w, cd_convenio_w);

--		nm_contratado_w	:= nm_medico_executor_w;
		if (cd_medico_prof_w IS NOT NULL AND cd_medico_prof_w::text <> '') then
			select	substr(obter_cpf_pessoa_fisica(cd_medico_prof_w),1,254)
			into STRICT	nr_cpf_prof_w
			;
		end if;

		insert	into w_tiss_contratado_exec(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			cd_cgc,
			cd_interno,
			nr_cpf,
			nm_contratado,
			cd_cnes,
			nm_medico_executor,
			sg_conselho,
			nr_crm,
			uf_crm,
			cd_cbo_saude,
			ds_funcao_medico,
			ds_tipo_logradouro,
			nr_cpf_prof)
		SELECT	nextval('w_tiss_contratado_exec_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_cgc_honor_w,
			cd_interno_honor_w,
			nr_cpf_honor_w,
			nm_contratado_honor_w,
			cd_cnes_honor_w,
			nm_medico_executor_w,
			sg_conselho_w,
			nr_crm_w,
			uf_crm_w,
			cd_cbo_saude_w,
			ds_funcao_medico_w,
			cd_tipo_acomodacao_w,
			nr_cpf_prof_w
		;
		-- FIM ****** SETAR CONTRATADO EXECUTANTE
		insert	into w_tiss_dados_atendimento(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			ie_tipo_atendimento,
			ie_tipo_saida)
		values (nextval('w_tiss_dados_atendimento_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			ie_tipo_atendimento_w,
			ie_tipo_saida_w);

		vl_total_w		:= (tiss_obter_regra_campo(6, 'VL_TOTAL', cd_convenio_w, vl_total_W, ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'))::numeric;

		insert	into w_tiss_totais(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			vl_procedimentos,
			vl_total_geral)
		values (nextval('w_tiss_totais_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			vl_total_w,
			vl_total_w);

		vl_total_w		:= 0;
		nr_seq_guia_nova_p	:= nr_seq_guia_w;

	end loop;
	close c01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_cabecalho_honor ( nr_seq_conta_guia_p bigint, nr_seq_guia_nova_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

