-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_anexo_autor_vaga (nr_seq_anexo_gestao_p bigint, nr_seq_gestao_p bigint, ds_arquivo_p text, nm_usuario_p text) AS $body$
DECLARE


				
nr_sequencia_autor_w	bigint;
ds_texto_w		varchar(255);				
nr_seq_agenda_w		gestao_vaga.nr_seq_agenda%type;		
				
C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	autorizacao_convenio a
	where	a.nr_seq_gestao = nr_seq_gestao_p
	and	not exists (	SELECT 1
				from	autorizacao_convenio_arq x
				where	x.nr_sequencia_autor = a.nr_sequencia
				and	x.ds_arquivo	     = ds_arquivo_p)
	
union

	select	a.nr_sequencia
	from	autorizacao_convenio a
	where	a.nr_seq_agenda = nr_seq_agenda_w
	and	pkg_i18n.get_user_locale() = 'en_AU'
	and	not exists (	select 1
				from	autorizacao_convenio_arq x
				where	x.nr_sequencia_autor = a.nr_sequencia
				and	x.ds_arquivo	     = ds_arquivo_p);			
				

BEGIN

ds_texto_w := substr(wheb_mensagem_pck.get_texto(311198),1,255); --Registro gerado pelo gestao de vagas, parametro[139]
select	max(nr_seq_agenda)
into STRICT	nr_seq_agenda_w
from	gestao_vaga
where	nr_sequencia = nr_seq_gestao_p;

open C01;
loop
fetch C01 into	
	nr_sequencia_autor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	insert	into autorizacao_convenio_arq(
		ds_arquivo,
		ds_observacao,            
		dt_atualizacao,           
		dt_atualizacao_nrec,      
		ie_anexar_email,          
		nm_usuario,               
		nm_usuario_nrec,                      
		nr_sequencia,             
		nr_sequencia_autor) 
	values (
		substr(ds_arquivo_p,1,254),
		ds_texto_w,            
		clock_timestamp(),
		clock_timestamp(),      
		'N',          
		nm_usuario_p,
		nm_usuario_p,          
		nextval('autorizacao_convenio_arq_seq'),             
		nr_sequencia_autor_w);
	
	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_anexo_autor_vaga (nr_seq_anexo_gestao_p bigint, nr_seq_gestao_p bigint, ds_arquivo_p text, nm_usuario_p text) FROM PUBLIC;

