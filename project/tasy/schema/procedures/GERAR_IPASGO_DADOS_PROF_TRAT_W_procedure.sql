-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE lista AS (
		dt_procedimento timestamp,
		ato bigint);


CREATE OR REPLACE PROCEDURE gerar_ipasgo_dados_prof_trat_w ( nr_interno_conta_p bigint, dt_mesano_referencia_p timestamp, nm_usuario_p text, nr_seq_tipo_fatura_p bigint, qt_linha_arq_p INOUT bigint, qt_linha_atend_p INOUT bigint) AS $body$
DECLARE


nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ie_funcao_medico_w		procedimento_paciente.ie_funcao_medico%type;
ds_funcao_medico_w		varchar(10);
nr_conselho_w			varchar(20);
cd_medico_executor_w		procedimento_paciente.cd_medico_executor%type;
nr_seq_conselho_w		pessoa_fisica.nr_seq_conselho%type;
nr_crm_w			medico.nr_crm%type;
vl_procedimento_w		double precision;--Nao alterar as casas decimais
cd_convenio_parametro_w		conta_paciente.cd_convenio_parametro%type;
cd_cnpj_w			convenio.cd_cgc%type;
qt_procedimento_w		procedimento_paciente.qt_procedimento%type;
qt_ato_w			bigint := 0;
qt_ato_aux_w			bigint := 0;
qt_ato_ww			bigint := 0;
dt_procedimento_w		procedimento_paciente.dt_procedimento%type;
dt_procedimento_ww		procedimento_paciente.dt_procedimento%type;
ie_w				smallint;
nr_matricula_prestador_w	varchar(08) := '00000000';
cd_cgc_prestador_w		procedimento_paciente.cd_cgc_prestador%type;
cd_cnpj_estab_w			varchar(14);
cd_tipo_fatura_w		fatur_tipo_fatura.cd_tipo_fatura%type;
cd_estabelecimento_w		conta_paciente.cd_estabelecimento%type;
cd_tipo_procedimento_w		smallint;
cd_tipo_procedimento_ww		smallint;
qt_reg_w			bigint := 1;
ie_controle_w			varchar(15) := 'N';
ie_ordem_w			smallint;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
ie_somente_vl_medico_w		varchar(15) := 'N';
ie_gerar_anestesista_w		varchar(15) := 'S';
ie_gerar_ato_guia_sec_w		varchar(15) := 'N';
nr_ato_ipasgo_w			procedimento_paciente.nr_ato_ipasgo%type;
qt_ato_informado_w		bigint := 0;
qt_ato_parecer_w		bigint := 0;
ie_responsavel_credito_w	procedimento_paciente.ie_responsavel_credito%type;
cd_tipo_prestador_w		w_ipasgo_dados_prof_trat.cd_tipo_prestador%type;
cd_medico_convenio_w		procedimento_participante.cd_medico_convenio%type;
nr_doc_convenio_w		varchar(20);
ie_resp_cred_pres_pf_w		varchar(15) := 'M';
nr_seq_ult_linha_w		w_ipasgo_dados_guia_sec.nr_sequencia%type;
nr_linha_ult_linha_w		w_ipasgo_dados_guia_sec.nr_linha%type;
ds_linha_ult_linha_w		w_ipasgo_dados_guia_sec.ds_linha%type;
nr_guia_ult_linha_w		w_ipasgo_dados_guia_sec.nr_guia%type;
nr_linha_ato_ult_linha_w	w_ipasgo_dados_guia_sec.nr_linha_ato%type;
nr_linha_atend_ult_linha_w	w_ipasgo_dados_guia_sec.nr_linha_atend%type;
nr_seq_alteracao_w		w_ipasgo_dados_guia_sec.nr_sequencia%type;
nr_linha_alteracao_w		w_ipasgo_dados_guia_sec.nr_linha%type;
nr_guia_alteracao_w		w_ipasgo_dados_guia_sec.nr_guia%type;
nr_linha_ato_alteracao_w	w_ipasgo_dados_guia_sec.nr_linha_ato%type;
nr_linha_atend_alteracao_w	w_ipasgo_dados_guia_sec.nr_linha_atend%type;
type myArray is table of lista index by integer;

ds_controle_ato_w myArray;

c01 CURSOR FOR
SELECT	sum(CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) *				(b.tx_procedimento/100)),0) END ) vl_procedimento,
	b.ie_funcao_medico,
	b.cd_medico_executor,
	sum(b.qt_procedimento) qt_procedimento,
	b.dt_procedimento,
	1 ie,
	b.cd_cgc_prestador,
	--a.cd_tipo_procedimento,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	b.ie_responsavel_credito,
	null cd_medico_convenio,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END  nr_doc_convenio
from	procedimento a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(b.cd_medico_executor IS NOT NULL AND b.cd_medico_executor::text <> '')
and	a.cd_procedimento	= b.cd_procedimento
and	a.ie_origem_proced	= b.ie_origem_proced
and	coalesce(b.nr_seq_proc_pacote,0) <> b.nr_sequencia
and	a.cd_tipo_procedimento not in (1,2,3,4,5,12,13,14,15,16,20,25,26,30,31,34,39,74,75,80,91,92,94,96,97)
and	cd_tipo_fatura_w not in (3,4)
and	somente_numero(b.cd_procedimento_convenio) not in (70033)
--and	qt_ato_informado_w = 0
GROUP BY b.ie_funcao_medico,
	 b.cd_medico_executor,
	 b.cd_cgc_prestador,
	 b.dt_procedimento,
	 --a.cd_tipo_procedimento,0,
	 coalesce(b.nr_ato_ipasgo,0),
	b.ie_responsavel_credito,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END
 HAVING	sum(CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) *				(b.tx_procedimento/100)),0) END ) > 0

union all

select	sum(CASE WHEN ie_somente_vl_medico_w='S' THEN 		CASE WHEN somente_numero(a.ie_funcao)=5 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'A')) * 				(coalesce(a.pr_faturar,100)/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(coalesce(a.pr_faturar,100)/100) *				(coalesce(a.pr_procedimento,100)/100)),0) END   ELSE CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(coalesce(a.pr_faturar,100)/100) *				(coalesce(a.pr_procedimento,100)/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) * 				(coalesce(a.pr_faturar,100)/100) *				(coalesce(a.pr_procedimento,100)/100)),0) END  END ) vl_procedimento,
	a.ie_funcao,
	a.cd_pessoa_fisica,
	sum(b.qt_procedimento),
	b.dt_procedimento,
	2 ie,
	a.cd_cgc,
	--c.cd_tipo_procedimento,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	a.ie_responsavel_credito,
	a.cd_medico_convenio,
	a.nr_doc_honor_conv nr_doc_convenio
from	procedimento c,
	procedimento_participante a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	b.nr_sequencia	= a.nr_sequencia
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
and	c.cd_procedimento	= b.cd_procedimento
and	c.ie_origem_proced	= b.ie_origem_proced
and	c.cd_tipo_procedimento not in (1,2,3,4,5,8,12,13,14,15,16,20,25,26,30,31,33,34,39,74,75,80,91,92,93,94,96,97,103)
and	cd_tipo_fatura_w	<> 3
and	somente_numero(b.cd_procedimento_convenio) not in (70033)
and	obter_se_exp_funcao_ipasgo(a.ie_funcao,nr_seq_tipo_fatura_p) = 'N'
and	coalesce(ie_gerar_anestesista_w,'S') = 'S'
--and	qt_ato_informado_w = 0
group by	a.ie_funcao,
	a.cd_pessoa_fisica,
	b.dt_procedimento,
	a.cd_cgc,
	--c.cd_tipo_procedimento,0,
	coalesce(b.nr_ato_ipasgo,0),
	a.ie_responsavel_credito,
	a.cd_medico_convenio,
	a.nr_doc_honor_conv

union all

/*93 e especifico pra gerar uma linha so - OS416225*/

select	sum(CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) *				(b.tx_procedimento/100)),0) END ) vl_procedimento,
	b.ie_funcao_medico,
	b.cd_medico_executor,
	sum(b.qt_procedimento),
	max(b.dt_procedimento) dt_procedimento,
	3 ie,
	b.cd_cgc_prestador,
	--a.cd_tipo_procedimento,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	b.ie_responsavel_credito,
	null cd_medico_convenio,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END  nr_doc_convenio
from	procedimento a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(b.cd_medico_executor IS NOT NULL AND b.cd_medico_executor::text <> '')
and	a.cd_procedimento	= b.cd_procedimento
and	a.ie_origem_proced	= b.ie_origem_proced
and	coalesce(b.nr_seq_proc_pacote,0) <> b.nr_sequencia
and	((a.cd_tipo_procedimento = 93) or (b.cd_procedimento = 91020010))
and	somente_numero(b.cd_procedimento_convenio) not in (70033)
and	cd_tipo_fatura_w	= 3
--and	qt_ato_informado_w = 0
GROUP BY b.ie_funcao_medico,
	 b.cd_medico_executor,
	 b.cd_cgc_prestador,
	 --a.cd_tipo_procedimento,0,
	 coalesce(b.nr_ato_ipasgo,0),
	b.ie_responsavel_credito,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END 
 HAVING	sum(CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) *				(b.tx_procedimento/100)),0) END ) > 0

union all

select	sum(CASE WHEN ie_somente_vl_medico_w='S' THEN 		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0) END  END ) vl_procedimento,
	b.ie_funcao_medico,
	b.cd_medico_executor,
	sum(b.qt_procedimento),
	min(b.dt_procedimento) dt_procedimento,
	4 ie,
	b.cd_cgc_prestador,
	--a.cd_tipo_procedimento,
	--a.cd_tipo_procedimento ie_ordem,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	b.ie_responsavel_credito,
	null cd_medico_convenio,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END  nr_doc_convenio
from	procedimento a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(b.cd_medico_executor IS NOT NULL AND b.cd_medico_executor::text <> '')
and	a.cd_procedimento	= b.cd_procedimento
and	a.ie_origem_proced	= b.ie_origem_proced
and	coalesce(b.nr_seq_proc_pacote,0) <> b.nr_sequencia
and	a.cd_tipo_procedimento not in (1,2,3,4,5,8,12,13,14,15,16,20,25,26,30,31,33,34,39,74,75,80,91,92,94,96,97,103)
and	cd_tipo_fatura_w	= 4
and	somente_numero(b.cd_procedimento_convenio) not in (70033)
and	obter_se_gera_ato_ipasgo(b.cd_procedimento,b.ie_origem_proced,cd_estabelecimento_w,cd_tipo_fatura_w,ie_tipo_atendimento_w,b.cd_setor_atendimento) = 'N'
--and	qt_ato_informado_w = 0
GROUP BY b.ie_funcao_medico,
	 b.cd_medico_executor,
	 b.cd_cgc_prestador,
	 a.cd_tipo_procedimento,
	 coalesce(b.nr_ato_ipasgo,0),
	b.ie_responsavel_credito,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END 
 HAVING	sum(CASE WHEN ie_somente_vl_medico_w='S' THEN 		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0) END  END ) > 0

union all

select	sum(CASE WHEN ie_somente_vl_medico_w='S' THEN 		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0) END  END ) vl_procedimento,
	b.ie_funcao_medico,
	b.cd_medico_executor,
	sum(b.qt_procedimento),
	b.dt_procedimento dt_procedimento,
	5 ie,
	b.cd_cgc_prestador,
	--a.cd_tipo_procedimento,
	--a.cd_tipo_procedimento ie_ordem,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	b.ie_responsavel_credito,
	null cd_medico_convenio,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END  nr_doc_convenio
from	procedimento a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(b.cd_medico_executor IS NOT NULL AND b.cd_medico_executor::text <> '')
and	a.cd_procedimento	= b.cd_procedimento
and	a.ie_origem_proced	= b.ie_origem_proced
and	coalesce(b.nr_seq_proc_pacote,0) <> b.nr_sequencia
and	obter_se_gera_ato_ipasgo(b.cd_procedimento,b.ie_origem_proced,cd_estabelecimento_w,cd_tipo_fatura_w,ie_tipo_atendimento_w,b.cd_setor_atendimento) = 'S'
--and	qt_ato_informado_w = 0
GROUP BY b.ie_funcao_medico,
	 b.cd_medico_executor,
	 b.cd_cgc_prestador,
	 --a.cd_tipo_procedimento,
	 coalesce(b.nr_ato_ipasgo,0),
	b.ie_responsavel_credito,
	b.dt_procedimento,
	CASE WHEN ie_gerar_ato_guia_sec_w='S' THEN b.cd_senha  ELSE null END 
 HAVING	sum(CASE WHEN ie_somente_vl_medico_w='S' THEN 		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE CASE WHEN somente_numero(b.cd_procedimento_convenio)=70025 THEN  		coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0)  ELSE coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,b.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0) END  END ) > 0

union all
	 
SELECT	sum(CASE WHEN Obter_Conversao_Externa(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao)=6 THEN 0 WHEN Obter_Conversao_Externa(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao)=3 THEN     	CASE WHEN ie_somente_vl_medico_w='S' THEN  (coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,a.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0) *0.3)  ELSE (coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0)*0.3) END  WHEN Obter_Conversao_Externa(cd_cnpj_w,'W_IPASGO_DADOS_PROF_TRAT','CD_FUNCAO',a.ie_funcao)=9 THEN         (coalesce(round((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,a.ie_responsavel_credito,'M')) * 				(a.pr_procedimento),2),0))  ELSE CASE WHEN ie_somente_vl_medico_w='S' THEN  (coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,a.ie_responsavel_credito,'M')) * 				(b.tx_procedimento/100)),0) *0.2)  ELSE (coalesce(((b.qt_procedimento * 			Obter_preco_proc_ipasgo_atend(b.nr_atendimento,b.dt_conta,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno,a.ie_responsavel_credito,'IPDE')) * 				(b.tx_procedimento/100)),0)*0.2) END  END ) vl_procedimento,	
	a.ie_funcao,
	a.cd_pessoa_fisica,
	sum(b.qt_procedimento),
	b.dt_procedimento,
	6 ie,
	a.cd_cgc,
	--c.cd_tipo_procedimento,
	0 ie_ordem,
	coalesce(b.nr_ato_ipasgo,0) nr_ato_ipasgo,
	a.ie_responsavel_credito,
	a.cd_medico_convenio,
	a.nr_doc_honor_conv nr_doc_convenio
from	procedimento c,
	procedimento_participante a,
	procedimento_paciente b
where	b.nr_atendimento 	= nr_atendimento_w
and	b.nr_interno_conta	= nr_interno_conta_p
and	b.nr_sequencia	= a.nr_sequencia
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	obter_classif_material_proced(null, b.cd_procedimento, b.ie_origem_proced) <> 2
and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
and	c.cd_procedimento	= b.cd_procedimento
and	c.ie_origem_proced	= b.ie_origem_proced
and	c.cd_tipo_procedimento not in (1,2,3,4,5,8,12,13,14,15,16,20,25,26,30,31,33,34,39,74,75,80,91,92,93,94,96,97,103)
and	somente_numero(b.cd_procedimento_convenio) not in (70033)
and	obter_se_exp_funcao_ipasgo(a.ie_funcao,nr_seq_tipo_fatura_p) = 'S'
group by	a.ie_funcao,
	a.cd_pessoa_fisica,
	b.dt_procedimento,
	a.cd_cgc,
	--c.cd_tipo_procedimento,0,
	coalesce(b.nr_ato_ipasgo,0),
	a.ie_responsavel_credito,
	a.cd_medico_convenio,
	a.nr_doc_honor_conv
order by 	nr_ato_ipasgo, dt_procedimento, ie_ordem desc, ie;

BEGIN

/*Declaracao de parametros*/

ie_somente_vl_medico_w := obter_param_usuario(999, 80, obter_perfil_Ativo, nm_usuario_p, Wheb_Usuario_pck.get_cd_estabelecimento, ie_somente_vl_medico_w);
ie_gerar_anestesista_w := obter_param_usuario(999, 81, obter_perfil_Ativo, nm_usuario_p, Wheb_Usuario_pck.get_cd_estabelecimento, ie_gerar_anestesista_w);
ie_resp_cred_pres_pf_w := obter_param_usuario(999, 99, obter_perfil_Ativo, nm_usuario_p, Wheb_Usuario_pck.get_cd_estabelecimento, ie_resp_cred_pres_pf_w);
ie_gerar_ato_guia_sec_w := obter_param_usuario(999, 102, obter_perfil_Ativo, nm_usuario_p, Wheb_Usuario_pck.get_cd_estabelecimento, ie_gerar_ato_guia_sec_w);

begin
select	a.nr_atendimento,
	a.cd_convenio_parametro,
	a.cd_estabelecimento,
	b.ie_tipo_atendimento
into STRICT	nr_atendimento_w,
	cd_convenio_parametro_w,
	cd_estabelecimento_w,
	ie_tipo_atendimento_w
from	conta_paciente a,
	atendimento_paciente b
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_interno_conta = nr_interno_conta_p;
exception
when others then
	nr_atendimento_w		:= 0;
	cd_convenio_parametro_w		:= 0;
	cd_estabelecimento_w		:= 0;
	ie_tipo_atendimento_w		:= 0;
end;

begin
select	cd_cgc
into STRICT	cd_cnpj_w
from	convenio
where	cd_convenio = cd_convenio_parametro_w;
exception
when others then
	cd_cnpj_w := '0';
end;

select	cd_cgc
into STRICT	cd_cnpj_estab_w
from	estabelecimento
where	cd_estabelecimento 	= cd_estabelecimento_w;

begin
select	cd_tipo_fatura
into STRICT	cd_tipo_fatura_w
from	fatur_tipo_fatura
where	nr_sequencia = nr_seq_tipo_fatura_p;
exception
when others then
	cd_tipo_fatura_w := 0;
end;

begin
select	count(*)
into STRICT	qt_ato_informado_w
from	procedimento_paciente
where	nr_atendimento = nr_atendimento_w
and	nr_interno_conta = nr_interno_conta_p
and	coalesce(nr_ato_ipasgo,0) > 0;
exception
when others then
	qt_ato_informado_w := 0;
end;

open C01;
loop
fetch C01 into	
	vl_procedimento_w,
	ie_funcao_medico_w,
	cd_medico_executor_w,
	qt_procedimento_w,
	dt_procedimento_w,
	ie_w,
	cd_cgc_prestador_w,
	ie_ordem_w,
	nr_ato_ipasgo_w,
	ie_responsavel_credito_w,
	cd_medico_convenio_w,
	nr_doc_convenio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	nr_matricula_prestador_w	:= '';
	cd_tipo_prestador_w		:= 1;
	
	if (ie_responsavel_credito_w = coalesce(ie_resp_cred_pres_pf_w,'M')) then
		cd_tipo_prestador_w := 1;
	else
		cd_tipo_prestador_w := 2;

		select	coalesce(max(cd_prestador_convenio),'00000000')
		into STRICT	nr_matricula_prestador_w
		from	convenio_prestador
		where	cd_convenio 	= cd_convenio_parametro_w
		and	cd_cgc 		= cd_cgc_prestador_w;

		if (nr_matricula_prestador_w = '00000000') then
			if (cd_medico_executor_w <> cd_medico_convenio_w) then
				nr_matricula_prestador_w := cd_medico_convenio_w;
			end if;
		end if;
	end if;	
	
	if (cd_tipo_fatura_w <> 4) and
		((dt_procedimento_w <> dt_procedimento_ww) or (coalesce(dt_procedimento_ww::text, '') = '')) then
		qt_ato_w	:= qt_ato_w + 1;
		qt_ato_aux_w	:= qt_ato_w;		
	elsif (cd_tipo_fatura_w = 4) then	
		if	((dt_procedimento_ww <> dt_procedimento_w) or (coalesce(dt_procedimento_ww::text, '') = '')) then
			qt_ato_w	:= qt_ato_w + 1;
			qt_ato_aux_w	:= qt_ato_w;
		end if;	

		if (coalesce(dt_procedimento_ww::text, '') = '') then
			ds_controle_ato_w[qt_reg_w].dt_procedimento	:= dt_procedimento_w;
			ds_controle_ato_w[qt_reg_w].ato		:= qt_ato_w;
		else
			for i in 1..ds_controle_ato_w.count loop
			begin
				if (ds_controle_ato_w[i].dt_procedimento = dt_procedimento_w) then
					qt_ato_aux_w := qt_ato_w;-- - 1;
					qt_ato_w := ds_controle_ato_w[i].ato;
					ie_controle_w := 'S';
				end if;
			end;
			end loop;
			if (ie_controle_w = 'N') then
				ds_controle_ato_w[qt_reg_w].dt_procedimento	:= dt_procedimento_w;
				ds_controle_ato_w[qt_reg_w].ato		:= qt_ato_w;
				qt_reg_w := qt_reg_w + 1;
			end if;	
		end if;	
	end if;
	
	select	coalesce(max(nr_seq_conselho),0)
	into STRICT	nr_seq_conselho_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_medico_executor_w;
	
	select	max(substr(obter_crm_medico(cd_pessoa_fisica), 1, 255))
	into STRICT	nr_crm_w
	from	medico
	where	cd_pessoa_fisica	= cd_medico_executor_w;	
	
	if (cd_cnpj_estab_w = '00418954000119') and (cd_tipo_fatura_w = 4) and (ie_funcao_medico_w = '2') then
		qt_ato_w	:= 2;			
	end if;
	/*Buscar as conversoes meio externo*/

	begin
	select	coalesce(max(cd_externo), to_char(nr_seq_conselho_w))
	into STRICT	nr_seq_conselho_w
	from	conversao_meio_externo
	where	cd_cgc 		= cd_cnpj_w
	and	upper(nm_tabela) 	= 'W_IPASGO_DADOS_PROF_TRAT'
	and	upper(nm_atributo)	= 'CD_CONSELHO'
	and	cd_interno	= to_char(nr_seq_conselho_w);
	exception
	when others then
		nr_seq_conselho_w := 0;
	end;

	begin
	select	coalesce(max(cd_externo), ie_funcao_medico_w)
	into STRICT	ie_funcao_medico_w
	from	conversao_meio_externo
	where	cd_cgc = cd_cnpj_w
	and	upper(nm_tabela) 	= 'W_IPASGO_DADOS_PROF_TRAT'
	and	upper(nm_atributo)	= 'CD_FUNCAO'
	and	cd_interno	= ie_funcao_medico_w;
	exception
	when others then
		ie_funcao_medico_w := 0;
	end;	
	
	qt_linha_arq_p := qt_linha_arq_p + 1;
	
	if (nr_ato_ipasgo_w > 0) then
		qt_ato_w := nr_ato_ipasgo_w;
	end if;
	
	if (qt_ato_w < 0) then
		qt_ato_w := 1;
	end if;
	
	if (ie_funcao_medico_w = '8') then 	
		qt_ato_w := 1;
		qt_ato_aux_w := qt_ato_aux_w - 1;
	end if;
	
	insert into w_ipasgo_dados_prof_trat(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_linha,
		tp_registro,
		nr_linha_atend,
		nr_linha_ato,
		cd_tipo_prestador,
		cd_conselho,
		nr_conselho,
		cd_funcao,
		cd_pediatria,
		qt_parecer,
		vl_honorario,
		nr_matricula_prestador,
		dt_mesano_referencia,
		nr_interno_conta,
		ds_linha,
		nr_seq_tipo_fatura)
	values (	nextval('w_ipasgo_dados_prof_trat_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		qt_linha_arq_p,
		7,
		qt_linha_atend_p,
		qt_ato_w,
		cd_tipo_prestador_w,
		nr_seq_conselho_w,
		somente_numero(nr_crm_w),
		ie_funcao_medico_w,
		0,
		qt_procedimento_w,
		vl_procedimento_w,
		nr_matricula_prestador_w,
		dt_mesano_referencia_p,
		nr_interno_conta_p,
		qt_linha_arq_p || '|' ||
		'7' || '|' ||
		qt_linha_atend_p || '|' ||
		qt_ato_w || '|' ||
		cd_tipo_prestador_w || '|' ||
		nr_seq_conselho_w || '|' ||
		nr_crm_w || '|' ||
		ie_funcao_medico_w || '|' ||
		CASE WHEN ie_funcao_medico_w='9' THEN  '2' END  || '|' ||
		CASE WHEN ie_funcao_medico_w='7' THEN  qt_procedimento_w WHEN ie_funcao_medico_w='8' THEN  qt_procedimento_w  ELSE '' END  || '|' ||
		replace(replace(Campo_Mascara_virgula_casas(vl_procedimento_w,4),'.',''),',','.') || '|' ||
		nr_matricula_prestador_w || '|' ||
		'|',
		nr_seq_tipo_fatura_p);

	dt_procedimento_ww 	:= dt_procedimento_w;
	cd_tipo_procedimento_ww	:= cd_tipo_procedimento_w;
	
	if	((coalesce(nr_doc_convenio_w,'X') <> 'X') and (ie_gerar_ato_guia_sec_w = 'S')) then
		begin
		
		begin
                select  max(nr_sequencia)
                into STRICT	nr_seq_ult_linha_w
                from    w_ipasgo_dados_guia_sec
                where	nr_interno_conta = nr_interno_conta_p
                and	dt_mesano_referencia = dt_mesano_referencia_p
                and	nm_usuario = nm_usuario_p
                and	nr_linha_ato > qt_ato_w;
		exception
                when others then
                        nr_seq_ult_linha_w := null;
                end;

		--linha pra alterar o ato
                begin
		select	nr_sequencia,
			nr_linha,
			nr_guia,
			nr_linha_ato,
			nr_linha_atend
		into STRICT	nr_seq_alteracao_w,
			nr_linha_alteracao_w,
			nr_guia_alteracao_w,
			nr_linha_ato_alteracao_w,
			nr_linha_atend_alteracao_w
		from    w_ipasgo_dados_guia_sec
		where	nr_interno_conta = nr_interno_conta_p
		and	dt_mesano_referencia = dt_mesano_referencia_p
		and	nr_guia = nr_doc_convenio_w
		and	nr_linha_ato <> qt_ato_w;
                exception
                when others then
                        nr_seq_alteracao_w := 0;
                end;


		if (coalesce(nr_seq_ult_linha_w::text, '') = '') and (coalesce(nr_seq_alteracao_w,0) > 0) then
			update	w_ipasgo_dados_guia_sec
			set	nr_linha_ato = qt_ato_w,
				ds_linha = nr_linha || '|3|' ||
				nr_linha_atend || '|' ||
				nr_guia || '|' ||
				qt_ato_w ||'|||||||||'
			where	nr_sequencia = nr_seq_alteracao_w;
		else
			--caso exista guia para um ato menor do que o que sera atualizado
			--ultima guia do ato
                        Begin
			select  nr_linha,
				ds_linha,
				nr_guia,
				nr_linha_ato,
				nr_linha_atend
			into STRICT	nr_linha_ult_linha_w,
				ds_linha_ult_linha_w,
				nr_guia_ult_linha_w,
				nr_linha_ato_ult_linha_w,
				nr_linha_atend_ult_linha_w
			from    w_ipasgo_dados_guia_sec
			where	nr_sequencia = nr_seq_ult_linha_w;
                        exception
                        when others then
                                nr_linha_ult_linha_w := null;
                        end;

                        if (coalesce(nr_linha_ult_linha_w,0) > 0) then
                                begin
                                --atualiza a ultima linha com os dados da guia que tem que atualizar o ato
                                update	w_ipasgo_dados_guia_sec
                                set	nr_linha_ato = qt_ato_w,
                                        ds_linha = nr_linha_ult_linha_w || '|3|' || 
                                        nr_linha_atend_ult_linha_w || '|' ||
                                        nr_guia_alteracao_w || '|' ||
                                        qt_ato_w || '|||||||||',
                                        nr_linha_atend = nr_linha_atend_ult_linha_w,
                                        nr_guia = nr_guia_alteracao_w
                                where	nr_sequencia = nr_seq_ult_linha_w;
                                end;
                        end if;

			--caso a linha alterada antes nao seja a ultima, atualiza a linha que seria alterada com as informacoes da ultima
			if (nr_linha_alteracao_w <> nr_seq_ult_linha_w) then
				update	w_ipasgo_dados_guia_sec
				set	ds_linha = nr_linha_alteracao_w || '|3|' ||
					nr_linha_atend_alteracao_w || '|' ||
					nr_guia_ult_linha_w || '|' ||
					nr_linha_ato_ult_linha_w || '|||||||||',
					nr_guia = nr_guia_ult_linha_w,
					nr_linha_ato = nr_linha_ato_ult_linha_w,
					nr_linha_atend = nr_linha_atend_alteracao_w
				where	nr_sequencia = nr_seq_alteracao_w;
			end if;

		end if;		
		
		end;
	end if;
	
	qt_ato_w 		:= qt_ato_aux_w;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ipasgo_dados_prof_trat_w ( nr_interno_conta_p bigint, dt_mesano_referencia_p timestamp, nm_usuario_p text, nr_seq_tipo_fatura_p bigint, qt_linha_arq_p INOUT bigint, qt_linha_atend_p INOUT bigint) FROM PUBLIC;

