-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_lote_dirf ( nr_sequencia_p bigint, lote_cancelado_p INOUT text) AS $body$
DECLARE


cd_estabelecimento_w	dirf_lote_mensal.cd_estabelecimento%type;
qt_registros_w		bigint;
qt_resgistro_dirf_w	bigint;
dt_mes_referencia_w	timestamp;


BEGIN
select	dt_mes_referencia,
	cd_estabelecimento
into STRICT	dt_mes_referencia_w,
	cd_estabelecimento_w
from	dirf_lote_mensal
where	nr_sequencia	= nr_sequencia_p;

select	count(1)
into STRICT	qt_registros_w
from	dirf_lote_mensal
where	dt_mes_referencia > dt_mes_referencia_w
and	(dt_geracao IS NOT NULL AND dt_geracao::text <> '')
and	cd_estabelecimento	= cd_estabelecimento_w  LIMIT 1;

select	count(1)
into STRICT	qt_resgistro_dirf_w
from	dirf_lote_mensal	d,
	dirf_agrupar_lote	a,
	dirf_lote		l
where	d.nr_sequencia	= a.nr_seq_lote_mensal
and	l.nr_sequencia	= a.nr_seq_lote_anual
and	l.ie_status	= 'G'
and     d.nr_sequencia	= nr_sequencia_p  LIMIT 1;

if (qt_resgistro_dirf_w = 0) and (qt_registros_w = 0) then

	begin
	delete	from dirf_titulo_pagar
	where	nr_seq_lote_dirf	= nr_sequencia_p;

	delete	from dirf_log_exclusao
	where	nr_seq_lote_dirf	= nr_sequencia_p;

	delete
	from	DIRF_LOTE_MENSAL_COMANDO
	where	nr_seq_lote_dirf	= nr_sequencia_p;

	lote_cancelado_p	:= 'S';

	update	dirf_lote_mensal
	set	dt_geracao	 = NULL
	where	nr_sequencia	= nr_sequencia_p;
	end;
else
	lote_cancelado_p	:= 'N';
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_lote_dirf ( nr_sequencia_p bigint, lote_cancelado_p INOUT text) FROM PUBLIC;

