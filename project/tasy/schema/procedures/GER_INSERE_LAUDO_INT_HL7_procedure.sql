-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ger_insere_laudo_int_hl7 ( nr_sequencia_p bigint, nr_acc_number_p text, cd_crm_uf_p text, ie_status_p text, cd_laudo_externo_p bigint, ds_laudo_p text, dt_liberacao_laudo_p text, cd_procedimento_p text default null, nm_usuario_p text default null) AS $body$
DECLARE



dt_liberacao_laudo_w	timestamp;		
ie_tipo_ordem_w		varchar(2) := null;			
cd_medico_laudante_w	varchar(10);
nr_crm_w		varchar(20);
uf_crm_w		varchar(2);
pos_inicio_uf_w		bigint;

qt_reg_w		bigint;
					

BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (nr_acc_number_p IS NOT NULL AND nr_acc_number_p::text <> '') then
		
	dt_liberacao_laudo_w := to_date(dt_liberacao_laudo_p, 'yyyymmddhh24miss');

	if (upper(ie_status_p) = 'CM') then
		ie_tipo_ordem_w := 'I';
	elsif (upper(ie_status_p) = 'A') then
		ie_tipo_ordem_w := 'A';
	end if;

	pos_inicio_uf_w := length(cd_crm_uf_p) - 2;
	nr_crm_w := substr(cd_crm_uf_p,1,pos_inicio_uf_w);
	uf_crm_w := substr(cd_crm_uf_p,pos_inicio_uf_w + 1,2);

	select	max(cd_pessoa_fisica)
	into STRICT	cd_medico_laudante_w
	from	medico
	where	nr_crm = nr_crm_w
	and	uf_crm = uf_crm_w;

	
	select	count(*)
	into STRICT	qt_reg_w
	from	w_integracao_laudo_hl7
	where	nr_sequencia = nr_sequencia_p;

	if (qt_reg_w > 0) then
	
		update	w_integracao_laudo_hl7
		set	cd_medico_laudante = cd_medico_laudante_w,
			dt_liberacao_laudo = dt_liberacao_laudo_w,
			uf_crm = uf_crm_w,
			nr_crm = nr_crm_w,
			dt_integracao = clock_timestamp(),
			ie_tipo_ordem = ie_tipo_ordem_w,
			cd_laudo_externo = cd_laudo_externo_p
		where	nr_sequencia = nr_sequencia_p;
			
	else
	
		insert into w_integracao_laudo_hl7(
			nr_sequencia,
			nr_acc_number,
			cd_medico_laudante,
			ie_tipo_ordem,
			cd_laudo_externo, 
			ds_laudo, 
			dt_liberacao_laudo,
			uf_crm,
			nr_crm,
			dt_integracao
			) 
		values (
			nr_sequencia_p, 
			nr_acc_number_p,
			cd_medico_laudante_w,
			ie_tipo_ordem_w,
			cd_laudo_externo_p, 
			ds_laudo_p, 
			dt_liberacao_laudo_w,
			uf_crm_w,
			nr_crm_w,
			clock_timestamp()
			);
	
	end if;

    if (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then
        CALL substituir_proc_integracao(nr_acc_number_p, cd_procedimento_p, nm_usuario_p);
    end if;
	
	commit;	
	
end if;		


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_insere_laudo_int_hl7 ( nr_sequencia_p bigint, nr_acc_number_p text, cd_crm_uf_p text, ie_status_p text, cd_laudo_externo_p bigint, ds_laudo_p text, dt_liberacao_laudo_p text, cd_procedimento_p text default null, nm_usuario_p text default null) FROM PUBLIC;

