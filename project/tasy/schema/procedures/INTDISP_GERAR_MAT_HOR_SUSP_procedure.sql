-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function intdisp_gerar_mat_hor_susp as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE intdisp_gerar_mat_hor_susp ( nr_prescricao_p bigint, nr_seq_mat_hor_p bigint, ie_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL intdisp_gerar_mat_hor_susp_atx ( ' || quote_nullable(nr_prescricao_p) || ',' || quote_nullable(nr_seq_mat_hor_p) || ',' || quote_nullable(ie_opcao_p) || ',' || quote_nullable(nm_usuario_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE intdisp_gerar_mat_hor_susp_atx ( nr_prescricao_p bigint, nr_seq_mat_hor_p bigint, ie_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_linha_arquivo_w	varchar(2000);
nr_seq_lote_w		bigint;
nm_arquivo_w        	varchar(100);
ds_diretorio_w        	varchar(255);
ds_diretorio_adep_w    	varchar(255);
nm_usuario_w        	varchar(15);
cd_estabelecimento_w    smallint;
nr_seq_regra_disp_w    	bigint;
ie_gera_arquivo_w    	varchar(1);
ie_imprime_lote_w    	varchar(1);
ie_gerou_arq_w        	varchar(1) := 'N';
dt_horario_w        	timestamp;
dt_inicio_prescr_w    	timestamp;
dt_validade_prescr_w    timestamp;
nr_atendimento_w    	bigint;
qt_dispensar_hor_w    	double precision;
qt_dose_w        	double precision;
cd_unidade_medida_w    	varchar(30);
ds_justificativa_w    	varchar(2000);
ie_forma_integracao_w   varchar(1);
nr_sequencia_lote_w    	bigint;
cd_material_w        	integer;
nr_seq_turno_w        	bigint;
ds_turno_w        	varchar(80);
ds_classif_urgente_w    varchar(80);
dt_dispensacao_w    	timestamp;
hr_dispensacao_w    	timestamp;
cd_setor_atendimento_w  bigint;
ds_setor_atendimento_w  varchar(100);
nm_paciente_w        	varchar(255);
cd_pessoa_fisica_w    	varchar(10);
ds_observacao_w        	varchar(400);
dt_liberacao_w        	timestamp;
ds_leito_w        	varchar(100);
nr_prescricao_w        	bigint;
dt_inicio_w       	timestamp;
dt_validade_w        	timestamp;
cd_medico_w        	varchar(10);
ie_classif_urgente_w    varchar(3);
ds_intrucao_w        	varchar(255);
cd_material_generico_w  integer;
ds_via_aplicacao_w    	varchar(255);
dt_lib_horario_w    	timestamp;
cd_crm_w        	varchar(20);
ds_material_w        	varchar(255);
ie_dispensar_farm_w    	varchar(1);
cd_prescritor_w        	varchar(10);
nr_seq_lote_ind_w    	varchar(15);
ds_local_estoque_w	varchar(255);
cd_local_estoque_w	integer;
nr_seq_estrut_w		bigint;
nr_seq_estrut_int_w	bigint;
ie_mat_estrutura_w	varchar(1);
cd_local_est_regra_w	integer;
nr_seq_mat_hor_w	bigint;
cd_intervalo_w		intervalo_prescricao.cd_intervalo%type;
ds_intervalo_w		intervalo_prescricao.ds_intervalo%type;
nr_seq_empresa_w	empresa_integracao.nr_sequencia%type;
ie_existe_w			varchar(1);
ie_swisslog_w		varchar(1);
qt_count_eoa_w bigint;


C01 CURSOR FOR
	SELECT	nr_prescricao,
		dt_inicio_prescr,
		dt_validade_prescr,
		nr_atendimento,
		cd_material,
		cd_medico,
		ds_classif_urgente,
		cd_material_generico,
		cd_estabelecimento,
		qt_dispensar_hor,
		qt_dose,
		cd_unidade_medida_dose,
		ds_via_adm,
		crm_medico,
		dt_lib_horario,
		ds_material,
		nr_seq_lote,
		ie_dispensar_farm,
		nm_prescritor,
		nm_paciente,
		dt_horario,
		nr_seq_lote_ind,
		cd_local_estoque,
		ds_local_estoque
	from    int_disp_mat_hor
	where   nr_prescricao = nr_prescricao_p
	and	nr_seq_mat_hor	= nr_seq_mat_hor_p;
BEGIN

if (ie_opcao_p = 2) then
	begin
	
	begin

	select	nr_sequencia
	into STRICT	nr_seq_empresa_w
	from	empresa_integracao
	where	upper(nm_empresa) = 'SWISSLOG';
	
	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	select	'S'
	into STRICT	ie_existe_w
	from	far_setores_integracao
	where	nr_seq_empresa_int = nr_seq_empresa_w
	and	cd_setor_atendimento = cd_setor_atendimento_w;
	exception
	when others then
		nr_seq_empresa_w := 0;
		ie_existe_w := 'N';
	end;
	
	ie_swisslog_w := 'N';
	if (ie_existe_w = 'S') then
		select	coalesce(max('S'), 'N')
		into STRICT	ie_swisslog_w
		from	prescr_mat_hor a,
				prescr_medica b,
				(SELECT	coalesce(nr_seq_estrut_int,0) nr_seq_estrut_int,
						cd_estabelecimento,
						cd_local_estoque_req
				from	parametros_farmacia) c
		where	(a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
		and		a.qt_dispensar_hor > 0
		and		consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,a.cd_material) = 'S'
		and 	exists ( select 1 from ap_lote x where x.nr_sequencia = a.nr_seq_lote and coalesce(x.dt_atend_farmacia::text, '') = '')
		and		a.cd_local_estoque = c.cd_local_estoque_req
		and		b.cd_estabelecimento = c.cd_estabelecimento
		and		a.nr_prescricao = b.nr_prescricao
		and		a.nr_sequencia = nr_seq_mat_hor_p;
	end if;
	
	if (ie_swisslog_w = 'N') then
    qt_count_eoa_w := 0;

    select count(*)
    into STRICT qt_count_eoa_w
		from    int_disp_mat_hor
		where   nr_prescricao = nr_prescricao_p
		and	nr_seq_mat_hor	= nr_seq_mat_hor_p
		and	ie_tipo_movimentacao = 'EOA';

    if (qt_count_eoa_w > 0) then

      select	max(nr_prescricao),
        max(dt_inicio_prescr),
        max(dt_validade_prescr),
        max(nr_atendimento),
        max(cd_material),
        max(cd_medico),
        max(ds_classif_urgente),
        max(cd_material_generico),
        max(cd_estabelecimento),
        max(qt_dispensar_hor),
        max(qt_dose),
        max(cd_unidade_medida_dose),
        max(ds_via_adm),
        max(crm_medico),
        max(dt_lib_horario),
        max(ds_material),
        max(nr_seq_lote),
        max(ie_dispensar_farm),
        max(nm_prescritor),
        max(nm_paciente),
        max(dt_horario),
        max(nr_seq_lote_ind),
        max(cd_local_estoque),
        max(ds_local_estoque),
        max(cd_intervalo),
        max(ds_intervalo)
      into STRICT	nr_prescricao_w,
        dt_inicio_w,
        dt_validade_w,
        nr_atendimento_w,
        cd_material_w,
        cd_medico_w,
        ie_classif_urgente_w,
        cd_material_generico_w,
        cd_estabelecimento_w,
        qt_dispensar_hor_w,
        qt_dose_w,
        cd_unidade_medida_w,
        ds_via_aplicacao_w,
        cd_crm_w,
        dt_lib_horario_w,
        ds_material_w,
        nr_seq_lote_w,
        ie_dispensar_farm_w,
        cd_prescritor_w,
        nm_paciente_w,
        dt_horario_w,
        nr_seq_lote_ind_w,
        cd_local_estoque_w,
        ds_local_estoque_w,
        cd_intervalo_w,
        ds_intervalo_w
      from    int_disp_mat_hor
      where   nr_prescricao = nr_prescricao_p
      and	nr_seq_mat_hor	= nr_seq_mat_hor_p
      and	ie_tipo_movimentacao = 'EOA';

      
      insert into int_disp_mat_hor(
        nr_sequencia,
        nr_prescricao,
        dt_inicio_prescr,
        dt_validade_prescr,
        nr_atendimento,
        cd_material,
        cd_medico,
        ds_classif_urgente,
        cd_material_generico,
        cd_estabelecimento,
        qt_dispensar_hor,
        qt_dose,
        cd_unidade_medida_dose,
        ds_via_adm,
        crm_medico,
        dt_lib_horario,
        ds_material,
        nr_seq_lote,
        ie_dispensar_farm,
        nm_prescritor,
        nm_paciente,
        dt_horario,
        ie_tipo_movimentacao,
        nr_seq_lote_ind,
        cd_local_estoque,
        ds_local_estoque,
        nr_seq_mat_hor,
        cd_intervalo,
        ds_intervalo,
        dt_atualizacao)
      values (	nextval('int_disp_mat_hor_seq'),
        nr_prescricao_w,
        dt_inicio_w,
        dt_validade_w,
        nr_atendimento_w,
        cd_material_w,
        cd_medico_w,
        ie_classif_urgente_w,
        cd_material_generico_w,
        cd_estabelecimento_w,
        qt_dispensar_hor_w,
        qt_dose_w,
        cd_unidade_medida_w,
        ds_via_aplicacao_w,
        cd_crm_w,
        dt_lib_horario_w,
        ds_material_w,
        nr_seq_lote_w,
        ie_dispensar_farm_w,
        cd_prescritor_w,
        nm_paciente_w,
        dt_horario_w,
        'EOD',
        nr_seq_lote_ind_w,
        cd_local_estoque_w,
        ds_local_estoque_w,
        nr_seq_mat_hor_p,
        cd_intervalo_w,
        ds_intervalo_w,	
        clock_timestamp());

    end if;

	end if;
	end;
end if;

commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intdisp_gerar_mat_hor_susp ( nr_prescricao_p bigint, nr_seq_mat_hor_p bigint, ie_opcao_p bigint, nm_usuario_p text) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE intdisp_gerar_mat_hor_susp_atx ( nr_prescricao_p bigint, nr_seq_mat_hor_p bigint, ie_opcao_p bigint, nm_usuario_p text) FROM PUBLIC;

