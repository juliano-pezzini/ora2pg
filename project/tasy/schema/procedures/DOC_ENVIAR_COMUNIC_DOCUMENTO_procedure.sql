-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE doc_enviar_comunic_documento ( nr_sequencia_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE



cd_setor_responsavel_w		varchar(255);
cd_cgc_w			varchar(14);
ds_assunto_w			varchar(255);
ds_comunicado_w			varchar(2000);
ds_comprador_padrao_w		varchar(100);
ds_email_destino_w			varchar(4000);
ds_email_w			varchar(255);
ds_email_origem_w			varchar(255);
ds_mensagem_w			varchar(2000);
ds_razao_social_w			pessoa_juridica.ds_razao_social%type;
ds_responsavel_compras_w		varchar(100);
ds_setor_w			varchar(255);
ds_setor_responsavel_w		varchar(255);
ds_tipo_documento_w		varchar(255);
ie_comunic_comprador_w		varchar(1);
ie_comunic_resp_documento_w	varchar(1);
ie_comunic_setor_w		varchar(1) := 'N';
ie_comunic_todos_comprador_w	varchar(1);
ie_comunic_regra_envio_w		varchar(15);
ie_enviar_email_w			varchar(1);
nm_usuario_destino_w		varchar(2000);
nm_usuario_compras_w		varchar(15);
nm_usuario_comprador_w		varchar(80);
nm_usuario_resp_w			varchar(80);
nr_seq_classif_w			bigint;
nr_seq_regra_w			bigint;
nr_seq_tipo_docto_w		bigint;
nr_sequencia_w			bigint;
nr_telefone_w			varchar(15);
qt_dias_w			bigint;
cd_perfil_w			integer;
ds_perfil_destino_w			varchar(2000);
ds_usuario_destino_w		varchar(2000);
cd_estabelecimento_w		smallint;
cd_pessoa_responsavel_w		varchar(10);
cd_estabelecimento_ww		estabelecimento.cd_estabelecimento%type;
ds_email_adicional_w		regra_envio_email_compra.ds_email_adicional%type;
ds_email_estab_w		pessoa_juridica_estab.ds_email%type;
ie_qualificado_w		mat_lib_estrut_fornec.ie_qualificado%type;

c01 CURSOR FOR
	SELECT	b.nr_sequencia,
		a.cd_cgc,
		a.ds_razao_social,
		b.nr_seq_tipo_docto,
		(trunc(b.dt_revisao,'dd') - trunc(clock_timestamp(),'dd')) qt_dias,
		coalesce(b.ie_comunic_resp_documento,'N'),
		coalesce(b.ie_comunic_comprador,'N'),
		coalesce(b.cd_setor_responsavel, 0),
		coalesce(b.ie_comunic_todos_comprador,'N'),
		coalesce(b.ie_comunic_setor,'N'),
		coalesce(b.ie_comunic_regra_envio,'N'),
		b.cd_estabelecimento,
		b.cd_pessoa_responsavel
	from	pessoa_juridica_doc	b,
		pessoa_juridica		a
	where	a.cd_cgc = b.cd_cgc
	and	(((coalesce(cd_estabelecimento_ww::text, '') = '') and (coalesce(b.cd_estabelecimento::text, '') = '')) or (b.cd_estabelecimento = cd_estabelecimento_ww))
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	((nr_sequencia_p = 0) or (nr_sequencia_p > 0) and (b.nr_sequencia = nr_sequencia_p))
	and	trunc(b.dt_revisao,'dd') - b.qt_dias_aviso_vencto <= trunc(clock_timestamp(),'dd');

C02 CURSOR FOR
	SELECT	obter_usuario_pf(cd_pessoa_fisica)
	from	comprador
	where	ie_situacao		= 'A'
	and	cd_estabelecimento	= cd_estabelecimento_w;

C03 CURSOR FOR
	SELECT	cd_perfil,
		ds_usuario_destino
	from	pessoa_juridica_doc_envio
	where	nr_seq_doc	= nr_sequencia_w;
	
c04 CURSOR FOR
	SELECT	cd_estabelecimento
	from	estabelecimento
	where	obter_se_contido_char(cd_estabelecimento,cd_estabelecimento_p) = 'S'
	
union all

	SELECT	null
	
	where   cd_estabelecimento_p = 0;


BEGIN	

open c04;
loop
fetch c04 into	
	cd_estabelecimento_ww;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	open C01;
	loop
	fetch C01 into	
		nr_sequencia_w,
		cd_cgc_w,
		ds_razao_social_w,
		nr_seq_tipo_docto_w,
		qt_dias_w,
		ie_comunic_resp_documento_w,
		ie_comunic_comprador_w,
		cd_setor_responsavel_w,
		ie_comunic_todos_comprador_w,
		ie_comunic_setor_w,
		ie_comunic_regra_envio_w,
		cd_estabelecimento_w,
		cd_pessoa_responsavel_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		/*if (cd_estabelecimento_w is null) then
		    select min(cd_estabelecimento) 
		    into   cd_estabelecimento_w
		    from   estabelecimento;	   	   
		end if;*/
		
		nm_usuario_destino_w	:= '';
		ds_email_w		:= null;
		ds_perfil_destino_w	:= null;
		
		if (ie_comunic_resp_documento_w = 'S') then
			select	coalesce(substr(obter_usuario_pessoa(cd_pessoa_responsavel),1,100),'') ds_pessoa_responsavel
			into STRICT	nm_usuario_resp_w
			from	pessoa_juridica_doc
			where	nr_sequencia	= nr_sequencia_w;
			
			if (nm_usuario_resp_w IS NOT NULL AND nm_usuario_resp_w::text <> '') then
				nm_usuario_destino_w	:= nm_usuario_resp_w || ',';
			end if;
			
			if (cd_pessoa_responsavel_w IS NOT NULL AND cd_pessoa_responsavel_w::text <> '') then
				begin
				select	max(ds_email)
				into STRICT	ds_email_w
				from	usuario
				where	cd_pessoa_fisica	= cd_pessoa_responsavel_w;			
				exception
				when others then
					ds_email_w	:= null;
				end;
			end if;
		end if;
		
		if (ie_comunic_comprador_w = 'S') then
			select	coalesce(substr(obter_usuario_pessoa(cd_comprador_padrao),1,100),'') ds_comprador_padrao,
				substr(obter_nome_pf_pj(cd_responsavel_compras,null),1,100) ds_responsavel_compras,
				substr(obter_usuario_pessoa(coalesce(cd_responsavel_compras,cd_comprador_padrao)),1,15),
				nr_telefone,
				ds_email
			into STRICT	ds_comprador_padrao_w,
				ds_responsavel_compras_w,
				nm_usuario_compras_w,
				nr_telefone_w,
				ds_email_origem_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_ww;
		
			if (nm_usuario_comprador_w IS NOT NULL AND nm_usuario_comprador_w::text <> '') then
				nm_usuario_destino_w	:= nm_usuario_destino_w || nm_usuario_comprador_w || ',';
			end if;	
		end if;
		
		select	ds_tipo_documento
		into STRICT	ds_tipo_documento_w
		from	tipo_documento_fornec
		where	nr_sequencia = nr_seq_tipo_docto_w;
		
		if (qt_dias_w > 0) then
			ds_comunicado_w := 	wheb_mensagem_pck.get_texto(311694,
							'QT_DIAS_W='|| QT_DIAS_W ||
							';DS_TIPO_DOCUMENTO_W='|| DS_TIPO_DOCUMENTO_W ||
							';DS_RAZAO_SOCIAL_W='|| DS_RAZAO_SOCIAL_W ||
							';DS_TIPO_DOCUMENTO_W='|| DS_TIPO_DOCUMENTO_W ||
							';DS_RAZAO_SOCIAL_W='|| DS_RAZAO_SOCIAL_W ||
							';CD_CGC_W='|| CD_CGC_W);
						/*Faltam #@QT_DIAS_W#@ dias para o vencimento do documento #@DS_TIPO_DOCUMENTO_W#@ do fornecedor #@DS_RAZAO_SOCIAL_W#@
						Documento: #@DS_TIPO_DOCUMENTO_W#@
						Pessoa Juridica: #@DS_RAZAO_SOCIAL_W#@
						CNPJ: #@CD_CGC_W#@*/
						
		else
			ds_comunicado_w :=	wheb_mensagem_pck.get_texto(311696,
							'DS_TIPO_DOCUMENTO_W='|| DS_TIPO_DOCUMENTO_W ||
							';DS_TIPO_DOCUMENTO_W='|| DS_TIPO_DOCUMENTO_W ||
							';DS_RAZAO_SOCIAL_W='|| DS_RAZAO_SOCIAL_W ||
							';CD_CGC_W='|| CD_CGC_W);
							
						/*O documento #@DS_TIPO_DOCUMENTO_W#@ venceu o prazo de validade
						Documento: #@DS_TIPO_DOCUMENTO_W#@
						Pessoa Juridica: #@DS_RAZAO_SOCIAL_W#@
						CNPJ: #@CD_CGC_W#@*/
		end if;
		
		if (ie_comunic_todos_comprador_w = 'S') then
			open C02;
			loop
			fetch C02 into	
				nm_usuario_comprador_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (obter_se_contido_char(nm_usuario_comprador_w,nm_usuario_destino_w) = 'N') then
					nm_usuario_destino_w	:= substr(nm_usuario_destino_w || nm_usuario_comprador_w || ',',1,2000);
				end if;
				end;
			end loop;
			close C02;
		
		end if;
		
		if (ie_comunic_regra_envio_w = 'S') then
			open C03;
			loop
			fetch C03 into	
				cd_perfil_w,
				ds_usuario_destino_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				if (coalesce(cd_perfil_w,0) > 0) then
					ds_perfil_destino_w	:= substr(cd_perfil_w || ', ' || ds_perfil_destino_w,1,2000);
				end if;
				
				if (coalesce(ds_usuario_destino_w,'X') <> 'X') then
					begin
					ds_usuario_destino_w	:= replace(ds_usuario_destino_w,';',',');
					nm_usuario_destino_w	:= substr(ds_usuario_destino_w || ', ' || nm_usuario_destino_w,1,2000);
					end;
				end if;
				end;
			end loop;
			close C03;
		end if;
		
		if (coalesce(ie_comunic_setor_w,'N') = 'S') and (cd_setor_responsavel_w IS NOT NULL AND cd_setor_responsavel_w::text <> '') then
			ds_setor_w	:= cd_setor_responsavel_w || ',';
		end if;
		
		if	((nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') or (ds_perfil_destino_w IS NOT NULL AND ds_perfil_destino_w::text <> '') or (ds_setor_w IS NOT NULL AND ds_setor_w::text <> '')) then
			
			select	obter_classif_comunic('F')
			into STRICT	nr_seq_classif_w
			;

			CALL gerar_comunic_padrao(
					clock_timestamp(),
					wheb_mensagem_pck.get_Texto(311697), /*'Vencimento da documentacao',*/
					ds_comunicado_w,
					nm_usuario_p,
					'N',
					nm_usuario_destino_w,
					'N',
					nr_seq_classif_w,
					ds_perfil_destino_w,
					'',
					ds_setor_w,
					clock_timestamp(),
					'',
					'');
		end if;
	
		ie_enviar_email_w := obter_param_usuario(6, 68, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_ww, ie_enviar_email_w);
		
		select	coalesce(max(ie_qualificado),'N')
		into STRICT	ie_qualificado_w
		from	mat_lib_estrut_fornec
		where	cd_cnpj_fornec = cd_cgc_w
		and	cd_estabelecimento = cd_estabelecimento_ww
		and 	ie_qualificado = 'S';
		
		if (ie_enviar_email_w = 'S') and (ie_qualificado_w = 'S') then
			select	max(substr(obter_usuario_pessoa(coalesce(cd_responsavel_compras,cd_comprador_padrao)),1,15)),
				max(ds_email)
			into STRICT	nm_usuario_compras_w,
				ds_email_origem_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_ww;
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_regra_w
			from	regra_envio_email_compra
			where	ie_tipo_mensagem = 29
			and	ie_situacao = 'A'
			and	cd_estabelecimento = cd_estabelecimento_ww;
			
			select	coalesce(max(ds_email),'')
			into STRICT	ds_email_estab_w
			from	pessoa_juridica_estab
			where	cd_cgc = cd_cgc_w
			and	cd_estabelecimento = cd_estabelecimento_ww;
			
			begin
			select	ds_assunto,
				ds_mensagem_padrao,				
				ds_email_adicional
			into STRICT	ds_assunto_w,
				ds_mensagem_w,
				ds_email_adicional_w
			from	regra_envio_email_compra
			where	nr_sequencia	= nr_seq_regra_w;
			exception
			when others then
				ds_assunto_w	:= '';
				ds_mensagem_w	:= '';
			end;
			
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@cnpj', cd_cgc_w), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@razao_pj', ds_razao_social_w), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@fantasia_pj', obter_nome_fantasia_pj(cd_cgc_w)), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@lista_doc', ds_tipo_documento_w), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@comprador', ds_comprador_padrao_w), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@resp_compras', ds_responsavel_compras_w), 1, 255);
			ds_assunto_w := SUBSTR(replace_macro(ds_assunto_w, '@fone', nr_telefone_w), 1, 255);
			ds_assunto_w := SUBSTR(ds_assunto_w, 1, 255);
			
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@cnpj', cd_cgc_w), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@razao_pj', ds_razao_social_w), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@fantasia_pj', obter_nome_fantasia_pj(cd_cgc_w)), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@lista_doc', ds_tipo_documento_w), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@comprador', ds_comprador_padrao_w), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@resp_compras', ds_responsavel_compras_w), 1, 2000);
			ds_mensagem_w := SUBSTR(replace_macro(ds_mensagem_w, '@fone', nr_telefone_w), 1, 2000);	
			ds_mensagem_w := SUBSTR(ds_mensagem_w, 1, 2000);
			
			if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
				ds_email_destino_w	:= ds_email_w;
			end if;
			
			if (ds_email_estab_w IS NOT NULL AND ds_email_estab_w::text <> '') then
				if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
					ds_email_destino_w	:= ds_email_destino_w || ';' || ds_email_estab_w;
				else
					ds_email_destino_w	:= ds_email_estab_w;
				end if;
			end if;
			
			if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
				if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
					ds_email_destino_w	:= ds_email_destino_w || ';' || ds_email_adicional_w;
				else
					ds_email_destino_w	:= ds_email_estab_w;
				end if;
			end if;

			if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') and (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (nm_usuario_compras_w IS NOT NULL AND nm_usuario_compras_w::text <> '') then	
				begin	
				CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_email_destino_w,nm_usuario_compras_w,'M');
				ds_email_destino_w := null;
				exception when others then
					ds_email_destino_w	:= null;
					ds_assunto_w		:= '';
				end;
			end if;			
		end if;
		
		end;
			
	end loop;
	close C01;
	ds_perfil_destino_w	:= null;
	end;
end loop;
close c04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE doc_enviar_comunic_documento ( nr_sequencia_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

