-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_item_recurso ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_prestador_p bigint, ie_acao_p text, ds_justificativa_p text, ie_origem_acao_p text, nm_usuario_p text, ie_item_p text default null, vl_recursado_p w_pls_recurso_glosa.vl_recursado%type DEFAULT NULL) AS $body$
DECLARE

/* ie_acao_p
	I= Incluir conta para novo recurso
	E= Excluir conta do novo recurso
	EI= Incluir item para novo recurso
	EE= excluir conta do novo recurso
	
ie_origem_acao_p
	T = Tasy
	P = Portal */
nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
cont_proc_w			integer;
cont_mat_w			integer;
cont_w				integer := 0;
vl_glosa_w			double precision;
nr_seq_item_tiss_w	pls_conta_proc_regra.nr_seq_item_tiss%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.vl_glosa,
			(	SELECT 	max(b.nr_seq_item_tiss)
				from 	pls_conta_proc_regra b 
				where 	nr_sequencia = a.nr_sequencia) nr_seq_item_tiss
	from	pls_conta_proc a
	where	a.nr_seq_conta	= nr_seq_conta_p
	and	not exists (	select	1 
				from	w_pls_recurso_glosa x 
				where	x.nr_seq_conta_proc = a.nr_sequencia
				and	x.ie_tipo_inclusao = 'P')
	and	a.vl_glosa	> 0
	and	pls_obter_recursa_item_regra(a.nr_sequencia,a.nr_seq_conta,nr_seq_prestador_p,'P') = 'S';
	
C02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.vl_glosa,
			(	SELECT 	max(b.nr_seq_item_tiss)
				from 	pls_conta_mat_regra b 
				where 	nr_sequencia = a.nr_sequencia) nr_seq_item_tiss
	from	pls_conta_mat a
	where	a.nr_seq_conta	= nr_seq_conta_p
	and	not exists (	select	1 
				from	w_pls_recurso_glosa x 
				where	x.nr_seq_conta_mat = a.nr_sequencia
				and	x.ie_tipo_inclusao = 'M')
	and	a.vl_glosa	> 0
	and	pls_obter_recursa_item_regra(a.nr_sequencia,a.nr_seq_conta,nr_seq_prestador_p,'M') = 'S';


BEGIN

if (ie_acao_p = 'I') then
	if (coalesce(nr_seq_conta_proc_p,0) <> 0) then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_proc
			where	nr_sequencia = nr_seq_conta_proc_p;
		end if;
		
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_proc_regra a
		where	a.nr_sequencia = nr_seq_conta_proc_p;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
						 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta,
						 nr_seq_conta_proc, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
						 nr_seq_item_tiss)
					values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
						 clock_timestamp(), nm_usuario_p, nr_seq_conta_p, 
						 nr_seq_conta_proc_p, 'P', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
						 nr_seq_item_tiss_w);
	end if;

	if (coalesce(nr_seq_conta_mat_p,0) <> 0) then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_mat
			where	nr_sequencia = nr_seq_conta_mat_p;
		end if;
	
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_mat_regra a
		where	a.nr_sequencia = nr_seq_conta_mat_p;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
						 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta, 
						 nr_seq_conta_mat, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
						 nr_seq_item_tiss)
					values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
						 clock_timestamp(), nm_usuario_p, nr_seq_conta_p,
						 nr_seq_conta_mat_p, 'M', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
						 nr_seq_item_tiss_w);
	end if;

	if (coalesce(nr_seq_conta_p,0) <> 0) and (coalesce(nr_seq_conta_proc_p,0) = 0) and (coalesce(nr_seq_conta_mat_p,0) = 0) then
		
		cont_w := 0;
		
		if (ie_origem_acao_p = 'T') then	
			select	count(1)
			into STRICT	cont_w
			from	w_pls_recurso_glosa
			where	nr_seq_conta		= nr_seq_conta_p
			and	nm_usuario		= nm_usuario_p
			and	coalesce(nr_seq_conta_proc::text, '') = ''
			and	coalesce(nr_seq_conta_mat::text, '') = '';
		end if;
		
		if (cont_w = 0) then
			insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
							 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta, 
							 ie_tipo_inclusao, ds_justificativa_prest)
						values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
							 clock_timestamp(), nm_usuario_p, nr_seq_conta_p, 
							 'C', ds_justificativa_p);
		end if;
		
		if (ie_origem_acao_p = 'T') then
			open C01;
			loop
			fetch C01 into	
				nr_seq_conta_proc_w,
				vl_glosa_w,
				nr_seq_item_tiss_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin				
				insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario, dt_atualizacao_nrec,
								nm_usuario_nrec, nr_seq_conta, nr_seq_conta_proc, ie_tipo_inclusao,
								vl_recursado, nr_seq_item_tiss)
							values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(),
								nm_usuario_p, nr_seq_conta_p, nr_seq_conta_proc_w, 'P',
								vl_glosa_w, nr_seq_item_tiss_w);
				end;
			end loop;
			close C01;
			
			open C02;
			loop
			fetch C02 into	
				nr_seq_conta_mat_w,
				vl_glosa_w,
				nr_seq_item_tiss_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario, dt_atualizacao_nrec,
								 nm_usuario_nrec, nr_seq_conta, nr_seq_conta_mat, ie_tipo_inclusao,
								 vl_recursado, nr_seq_item_tiss)
							values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(),
								 nm_usuario_p, nr_seq_conta_p, nr_seq_conta_mat_w, 'M',
								 vl_glosa_w, nr_seq_item_tiss_w);
				end;
			end loop;
			close C02;
		end if;
	end if;
	
elsif (ie_acao_p = 'II') then
	cont_w := 0;
	if (ie_origem_acao_p = 'T') and (coalesce(nr_seq_conta_p,0) <> 0) then
		select	count(1)
		into STRICT	cont_w
		from	w_pls_recurso_glosa
		where	nr_seq_conta		= nr_seq_conta_p
		and	nm_usuario		= nm_usuario_p
		and	coalesce(nr_seq_conta_proc::text, '') = ''
		and	coalesce(nr_seq_conta_mat::text, '') = '';
	end if;

	if (cont_w = 0) or
		((coalesce(nr_seq_conta_p,0) <> 0) and (coalesce(nr_seq_conta_proc_p,0) = 0) and (coalesce(nr_seq_conta_mat_p,0) = 0)) then
		
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario, 
						 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta, 
						 ie_tipo_inclusao, ds_justificativa_prest)
					values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
						 clock_timestamp(), nm_usuario_p, nr_seq_conta_p, 
						 'C', ds_justificativa_p);
	end if;

	if (coalesce(nr_seq_conta_proc_p,0) <> 0) then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_proc
			where	nr_sequencia = nr_seq_conta_proc_p;
		end if;
		
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_proc_regra a
		where	a.nr_sequencia = nr_seq_conta_proc_p;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
						 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta,
						 nr_seq_conta_proc, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
						 nr_seq_item_tiss)
					values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
						 clock_timestamp(), nm_usuario_p, nr_seq_conta_p, 
						 nr_seq_conta_proc_p, 'P', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
						 nr_seq_item_tiss_w);
	end if;

	if (coalesce(nr_seq_conta_mat_p,0) <> 0) then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_mat
			where	nr_sequencia = nr_seq_conta_mat_p;
		end if;
		
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_mat_regra a
		where	a.nr_sequencia = nr_seq_conta_mat_p;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
						 dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta, 
						 nr_seq_conta_mat, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
						 nr_seq_item_tiss)
					values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
						 clock_timestamp(), nm_usuario_p, nr_seq_conta_p,
						 nr_seq_conta_mat_p, 'M', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
						 nr_seq_item_tiss_w);
	end if;
	
elsif (ie_acao_p = 'IH') then -- Inclus√£o de itens pelo HTML5
	if (ie_item_p = 'P') then
		nr_seq_conta_proc_w := nr_seq_conta_proc_p;
	elsif (ie_item_p = 'M') then
		nr_seq_conta_mat_w := nr_seq_conta_mat_p;
	end if;
	
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_proc
			where	nr_sequencia = nr_seq_conta_proc_w;
		end if;
	
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_proc_regra a
		where	a.nr_sequencia = nr_seq_conta_proc_w;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
			dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta,
			nr_seq_conta_proc, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
			nr_seq_item_tiss)
		values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, nr_seq_conta_p, 
			nr_seq_conta_proc_w, 'P', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
			nr_seq_item_tiss_w);
	
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		vl_glosa_w := null;
		if (coalesce(vl_recursado_p::text, '') = '') then
			select	max(vl_glosa)
			into STRICT	vl_glosa_w
			from	pls_conta_mat
			where	nr_sequencia = nr_seq_conta_mat_w;
		end if;
	
		select 	max(nr_seq_item_tiss)
		into STRICT	nr_seq_item_tiss_w
		from 	pls_conta_mat_regra a
		where	a.nr_sequencia = nr_seq_conta_mat_w;
	
		insert into w_pls_recurso_glosa(nr_sequencia, dt_atualizacao,  nm_usuario,
			dt_atualizacao_nrec,  nm_usuario_nrec, nr_seq_conta, 
			nr_seq_conta_mat, ie_tipo_inclusao, ds_justificativa_prest, vl_recursado,
			nr_seq_item_tiss)
		values (nextval('w_pls_recurso_glosa_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, nr_seq_conta_p,
			nr_seq_conta_mat_w, 'M', ds_justificativa_p, coalesce(vl_recursado_p,vl_glosa_w),
			nr_seq_item_tiss_w);
	end if;
	
elsif (ie_acao_p = 'E') then
	if (coalesce(nr_seq_conta_proc_p,0) <> 0) then
		delete	from w_pls_recurso_glosa
		where	nr_seq_conta_proc	= nr_seq_conta_proc_p;
	end if;
	
	select	count(1)
	into STRICT	cont_proc_w
	from	pls_conta_proc a,
		w_pls_recurso_glosa b
	where	a.nr_sequencia	= b.nr_seq_conta_proc
	and	a.nr_seq_conta	= nr_seq_conta_p
	and	b.nm_usuario	= nm_usuario_p
	and	b.vl_recursado > 0;


	if (coalesce(nr_seq_conta_mat_p,0) <> 0) then
		delete	from w_pls_recurso_glosa
		where	nr_seq_conta_mat	= nr_seq_conta_mat_p;
	end if;
	
	select	count(1)
	into STRICT	cont_mat_w
	from	pls_conta_mat a,
		w_pls_recurso_glosa b
	where	a.nr_sequencia	= b.nr_seq_conta_mat
	and	a.nr_seq_conta	= nr_seq_conta_p
	and	b.nm_usuario	= nm_usuario_p
	and	b.vl_recursado > 0;

	
	if (coalesce(nr_seq_conta_p,0) <> 0) and (ie_origem_acao_p = 'T' or (coalesce(cont_proc_w,0) = 0 and coalesce(cont_mat_w,0) = 0)) then
		delete	from w_pls_recurso_glosa
		where	nr_seq_conta	= nr_seq_conta_p;
	end if;
	
elsif (ie_acao_p = 'EI') then

	if (coalesce(nr_seq_conta_proc_p,0) <> 0) then
		delete	from w_pls_recurso_glosa
		where	nr_seq_conta_proc	= nr_seq_conta_proc_p;
	end if;

	if (coalesce(nr_seq_conta_mat_p,0) <> 0) then
		delete	from w_pls_recurso_glosa
		where	nr_seq_conta_mat	= nr_seq_conta_mat_p;
	end if;
	
	if (coalesce(nr_seq_conta_p,0) <> 0) then
		select	count(1)
		into STRICT	cont_proc_w
		from	w_pls_recurso_glosa
		where	nr_seq_conta	= nr_seq_conta_p
		and	nm_usuario	= nm_usuario_p
		and	(nr_seq_conta_proc IS NOT NULL AND nr_seq_conta_proc::text <> '');
		
		select	count(1)
		into STRICT	cont_mat_w
		from	w_pls_recurso_glosa
		where	nr_seq_conta	= nr_seq_conta_p
		and	nm_usuario	= nm_usuario_p
		and	(nr_seq_conta_mat IS NOT NULL AND nr_seq_conta_mat::text <> '');
		
		if (cont_proc_w = 0) and (cont_mat_w = 0) then
			delete	from w_pls_recurso_glosa
			where	nr_seq_conta	= nr_seq_conta_p
			and	nm_usuario	= nm_usuario_p;
		end if;
	end if;	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_item_recurso ( nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_prestador_p bigint, ie_acao_p text, ds_justificativa_p text, ie_origem_acao_p text, nm_usuario_p text, ie_item_p text default null, vl_recursado_p w_pls_recurso_glosa.vl_recursado%type DEFAULT NULL) FROM PUBLIC;

