-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_service_pack_hotfix ( nr_service_order_p service_pack_hotfix.nr_service_order%type, cd_version_p service_pack_hotfix.cd_version%type, nr_service_pack_p service_pack_hotfix.nr_service_pack%type, nm_usuario_p service_pack_hotfix.nm_usuario%type) AS $body$
DECLARE


nr_old_build_w man_service_pack_versao.nr_old_build%type;
ds_hotfix_w service_pack_hotfix.ds_hotfix%type;
nr_sequencia_w service_pack_hotfix.nr_sequencia%type;

separator_const CONSTANT varchar(1) := '-';


BEGIN

  select coalesce(min(nr_old_build), -1)
  into STRICT nr_old_build_w
  from man_service_pack_versao
  where cd_versao = cd_version_p
  and nr_service_pack = nr_service_pack_p;

  ds_hotfix_w := to_char(nr_old_build_w) || separator_const || nr_service_order_p;

  select max(nr_sequencia)
  into STRICT nr_sequencia_w
  from service_pack_hotfix
  where cd_version = cd_version_p
  and ds_hotfix = ds_hotfix_w;

------- OS-2530622 --------  
  insert into REGRA_VERSAO_SP(
	nr_sequencia,
	CD_VERSAO,
	DS_HOTFIX,
	DT_ATUALIZACAO,
	NM_USUARIO,
	DT_INICIO_REGRA,
	dt_termino_regra,
	IE_NOTURNO,
	TX_OBSERVACAO
	) values (
	nextval('regra_versao_sp_seq'),
	cd_version_p,
	ds_hotfix_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	clock_timestamp() + interval '90 days',
	'A',
	'Regra gerada automaticamente'
  );
  commit;
	---- ENVIO DE E-MAIL ----
	CALL enviar_email('Nova branch criada: ' || cd_version_p || '.' || ds_hotfix_w, --ds_assunto_p
		'Foi criada uma nova branch especifica: '||chr(13)||chr(13)|| cd_version_p || '.' || ds_hotfix_w, --ds_mensagem_p
		'support.informatics@philips.com', --ds_email_origem_p
		'grp_build_html5_ci@Philips.onmicrosoft.com',
		'Tasy', --nm_usuario_p
		null); --ie_prioridade_p
		
	---- /ENVIO DE E-MAIL ----

  
------- /OS-2530622 -------
  if (coalesce(nr_sequencia_w::text, '') = '') then
    insert into service_pack_hotfix(
      nr_sequencia,
      dt_atualizacao,
      nm_usuario,
      nr_service_order,
      cd_version,
      nr_service_pack,
      ds_hotfix,
      ie_branch_generated)
    values (
      nextval('service_pack_hotfix_seq'),
      clock_timestamp(),
      nm_usuario_p,
      nr_service_order_p,
      cd_version_p,
      nr_service_pack_p,
      ds_hotfix_w,
      'N');
    commit;
  else
    CALL insert_service_order_sp_hotfix(nr_service_order_p, nr_sequencia_w, nm_usuario_p);
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_service_pack_hotfix ( nr_service_order_p service_pack_hotfix.nr_service_order%type, cd_version_p service_pack_hotfix.cd_version%type, nr_service_pack_p service_pack_hotfix.nr_service_pack%type, nm_usuario_p service_pack_hotfix.nm_usuario%type) FROM PUBLIC;

