-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_salvar_solic_compra ( nr_seq_forma_compra_p bigint, cd_estabelecimento_p bigint, cd_material_regra_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ie_consistir_avisar_p INOUT text) AS $body$
DECLARE



ds_material_w 			varchar(255);
ie_consistir_itens_w			varchar(15);
nr_seq_forma_compra_regra_w  	regra_consist_pend_compra.nr_seq_forma_compra%type;
ie_consiste_solic_pend_regra_w  	regra_consist_pend_compra.ie_consiste_solic_pend%type;
ie_consiste_cot_pend_regra_w  	regra_consist_pend_compra.ie_consiste_cot_pend%type;
ie_consiste_oc_pend_regra_w  	regra_consist_pend_compra.ie_consiste_oc_pend%type;
ie_consiste_lic_pend_regra_w 	regra_consist_pend_compra.ie_consiste_lic_pend%type;
ie_acao_salvar_regra_w  		regra_consist_pend_compra.ie_acao_salvar%type;
ie_acao_liberar_regra_w  		regra_consist_pend_compra.ie_acao_liberar%type;
cd_perfil_w			bigint;
nr_seq_regra_w			regra_consist_pend_compra.nr_sequencia%type;


BEGIN

cd_perfil_w	:= obter_perfil_ativo;

select	coalesce(max(obter_valor_param_usuario(913, 16, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p)), 'N')
into STRICT	ie_consistir_itens_w
;

select	obter_regra_consist_pend_com(cd_estabelecimento_p, nr_seq_forma_compra_p)
into STRICT	nr_seq_regra_w
;

if (nr_seq_regra_w > 0) then

	select	max(nr_seq_forma_compra),
		max(coalesce(ie_consiste_solic_pend,'N')),
		max(coalesce(ie_consiste_cot_pend,'N')),
		max(coalesce(ie_consiste_oc_pend,'N')),
		max(coalesce(ie_consiste_lic_pend,'N')),
		max(coalesce(ie_acao_liberar,'N')),
		max(coalesce(ie_acao_salvar,'N'))
	into STRICT	nr_seq_forma_compra_regra_w,
		ie_consiste_solic_pend_regra_w,
		ie_consiste_cot_pend_regra_w,
		ie_consiste_oc_pend_regra_w,
		ie_consiste_lic_pend_regra_w,
		ie_acao_liberar_regra_w,
		ie_acao_salvar_regra_w
	from 	regra_consist_pend_compra
	where 	nr_sequencia = nr_seq_regra_w;

	ie_consistir_avisar_p := ie_acao_salvar_regra_w;

	if (ie_consistir_itens_w = 'P') and (ie_acao_salvar_regra_w <> 'N') then

		if (ie_consiste_solic_pend_regra_w = 'S') then --SOLICITACAO		
			
			select	max(substr(cd_material || ' - ' || obter_desc_material(cd_material),1,200))
			into STRICT	ds_material_w
			from	compra_pendente_v
			where	ie_informacao		= 2
			and 	cd_material			= cd_material_regra_p
			and 	cd_estabelecimento 	= cd_estabelecimento_p;

			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
				ds_mensagem_p := Wheb_mensagem_pck.get_Texto(388355,'DS_MATERIAL='||ds_material_w); /*#@DS_MATERIAL#@. Existem solicitacoes pendentes para esse item.*/
	
			end if;
		end if;

		if (ie_consiste_cot_pend_regra_w = 'S' and coalesce(ds_mensagem_p::text, '') = '') then --COTACAO		
			
				select	max(substr(cd_material || ' - ' || obter_desc_material(cd_material),1,200))
				into STRICT	ds_material_w
				from	compra_pendente_v
				where	ie_informacao		= 3
				and 	cd_material			= cd_material_regra_p
				and 	cd_estabelecimento 	= cd_estabelecimento_p;

				if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
					ds_mensagem_p := Wheb_mensagem_pck.get_Texto(388361,'DS_MATERIAL='||ds_material_w); /*#@DS_MATERIAL#@. Existem cotacoes pendentes para esse item.*/
		
				end if;
		end if;

		if (ie_consiste_oc_pend_regra_w = 'S' and coalesce(ds_mensagem_p::text, '') = '') then --ORDENS		
			
				select	max(substr(cd_material || ' - ' || obter_desc_material(cd_material),1,200))
				into STRICT	ds_material_w
				from	compra_pendente_v
				where	ie_informacao		= 1
				and 	cd_material		= cd_material_regra_p
				and 	cd_estabelecimento 	= cd_estabelecimento_p;

				if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
					ds_mensagem_p := Wheb_mensagem_pck.get_Texto(388363,'DS_MATERIAL='||ds_material_w); /*#@DS_MATERIAL#@. Existem ordens pendentes para esse item.*/
	
				end if;
		end if;
		
		if (ie_consiste_lic_pend_regra_w = 'S' and coalesce(ds_mensagem_p::text, '') = '') then --LICITACAO
			
			select max(substr(d.cd_material || ' - ' || obter_desc_material(d.cd_material),1,200))
            into STRICT ds_material_w
            from material d
            where d.cd_material = cd_material_regra_p
            and exists (SELECT	1
                        from 	reg_licitacao a,
                                reg_lic_item b
                        where 	a.nr_sequencia 			= b.nr_seq_licitacao
                        and 	a.cd_estabelecimento 	= cd_estabelecimento_p
                        and 	b.cd_material 			= d.cd_material
                        and 	not exists (select	1
                                            from	reg_compra z,
                                                reg_compra_item x
                                            where 	z.nr_sequencia = x.nr_seq_reg_compra
                                            and		z.nr_seq_licitacao = a.nr_sequencia
                                            and		x.cd_material = b.cd_material)

union
					
                        SELECT 	1
                        from	lic_item a,
                                lic_licitacao b,
                                lic_estagio c
                        where	a.nr_seq_licitacao 	= b.nr_sequencia
                        and		b.nr_seq_estagio 	= c.nr_sequencia
                        and		c.ie_permite_oc 	= 'S' 
                        and		a.cd_material 		= d.cd_material);
			
			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
				ds_mensagem_p := Wheb_mensagem_pck.get_Texto(388365,'DS_MATERIAL='||ds_material_w); /*#@DS_MATERIAL#@. Existem licitacoes pendentes para esse item.*/
		
			end if;								
		
		end if;
		
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_salvar_solic_compra ( nr_seq_forma_compra_p bigint, cd_estabelecimento_p bigint, cd_material_regra_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ie_consistir_avisar_p INOUT text) FROM PUBLIC;

