-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gen_diff_date_routine (nr_seq_order_unit_p bigint, nr_seq_rotina_p text, nm_usuario_p text) AS $body$
DECLARE

									
ds_interv_diff_default_w	procedimento_rotina.ds_interv_diff_default%type;
qt_lista_w					bigint;
ie_final_w					varchar(1);
cont_w						bigint;
ie_pos_w					smallint;
qt_exists_w					bigint;
nr_seq_w					bigint;
exam_list_w					bigint;
nr_seq_exam_cont_w  		bigint;
ds_seq_proc_list_w			varchar(1000);
ie_final_ww					varchar(1);
ie_pos_ww					smallint;
nr_seq_exam_proc_w  		bigint;


BEGIN

if ((nr_seq_rotina_p IS NOT NULL AND nr_seq_rotina_p::text <> '') and nr_seq_rotina_p <> '#') then
	ds_seq_proc_list_w  := nr_seq_rotina_p;
	exam_list_w := length(ds_seq_proc_list_w);
	if (substr(ds_seq_proc_list_w, exam_list_w-1, exam_list_w) = ',') then
        ds_seq_proc_list_w := substr(ds_seq_proc_list_w, 1, length(ds_seq_proc_list_w)-1);
    end if;
	
	ie_final_ww          := 'N';
	while (exam_list_w IS NOT NULL AND exam_list_w::text <> '') loop
		begin
			nr_seq_exam_cont_w := 0;
			exam_list_w := length(ds_seq_proc_list_w);
			ie_pos_ww := position(',' in ds_seq_proc_list_w);
			if (ie_pos_ww = 0) then
				ie_final_w := 'S';
				nr_seq_exam_cont_w := (ds_seq_proc_list_w)::numeric;
				ds_seq_proc_list_w := null;
			elsif (ie_pos_ww = 1) then
				ds_seq_proc_list_w	:= substr(ds_seq_proc_list_w, (ie_pos_ww + 1), exam_list_w);
			else
				nr_seq_exam_cont_w	:= (substr(ds_seq_proc_list_w, 1, (ie_pos_ww - 1)))::numeric;
                ds_seq_proc_list_w	:= substr(ds_seq_proc_list_w, (ie_pos_ww + 1), exam_list_w);
			end if;
			if ((nr_seq_exam_cont_w IS NOT NULL AND nr_seq_exam_cont_w::text <> '') and nr_seq_exam_cont_w > 0) then
			select	max(a.ds_interv_diff_default),
					max(a.nr_proc_interno)
			into STRICT	ds_interv_diff_default_w,
					nr_seq_exam_proc_w
			from	procedimento_rotina a
			where	a.nr_sequencia = nr_seq_exam_cont_w;

			if (ds_interv_diff_default_w IS NOT NULL AND ds_interv_diff_default_w::text <> '') then

				qt_lista_w := length(ds_interv_diff_default_w);
				
				if (substr(ds_interv_diff_default_w, qt_lista_w -1, qt_lista_w) = ',') then
					ds_interv_diff_default_w := substr(ds_interv_diff_default_w, 1, length(ds_interv_diff_default_w)-1);
				end if;
				
				ie_final_w          := 'N';
				
				while (qt_lista_w IS NOT NULL AND qt_lista_w::text <> '') loop
					begin
					
					cont_w := 0;
					qt_lista_w := length(ds_interv_diff_default_w);
					ie_pos_w := position(',' in ds_interv_diff_default_w);
					if (ie_pos_w = 0) then
						ie_final_w := 'S';
						cont_w := (ds_interv_diff_default_w)::numeric;
						ds_interv_diff_default_w := null;
					elsif (ie_pos_w = 1) then
						ds_interv_diff_default_w	:= substr(ds_interv_diff_default_w, (ie_pos_w + 1), qt_lista_w);
					else
						cont_w	:= (substr(ds_interv_diff_default_w, 1, (ie_pos_w - 1)))::numeric;
						ds_interv_diff_default_w	:= substr(ds_interv_diff_default_w, (ie_pos_w + 1), qt_lista_w);
					end if;
					
					if ((cont_w IS NOT NULL AND cont_w::text <> '') and cont_w > 0) then

						select	count(*)
						into STRICT	qt_exists_w
						from	cpoe_dias_proc_order_unit
						where	nr_seq_cpoe_order_unit = nr_seq_order_unit_p
						and		trunc(dt_procedimento, 'dd') = trunc(clock_timestamp() + (cont_w)::numeric , 'dd');

						if (qt_exists_w = 0) then

							select 	nextval('cpoe_dias_proc_order_unit_seq')
							into STRICT 	nr_seq_w
							;
							
							insert into cpoe_dias_proc_order_unit(
								nr_sequencia,
								dt_atualizacao,
								dt_atualizacao_nrec,
								nm_usuario,
								nm_usuario_nrec,
								dt_procedimento,
								nr_seq_cpoe_order_unit)
							values (
								nr_seq_w,
								clock_timestamp(),
								clock_timestamp(),
								nm_usuario_p,
								nm_usuario_p,
								trunc(clock_timestamp() + (cont_w)::numeric , 'dd'),
								nr_seq_order_unit_p);
								
							INSERT INTO cpoe_proc_diff_order_unit(	
								nr_sequencia,
								nr_seq_cpoe_dias_proc, 
								nr_seq_proc_interno,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec,
								ie_selected) 
							VALUES (	nextval('cpoe_proc_diff_order_unit_seq'),
								nr_seq_w,
								nr_seq_exam_proc_w,
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp(),
								'S');	

						end if;
							
					end if;
						
					end;
					
				end loop;

				end if;
			end if;
		end;
	end loop;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gen_diff_date_routine (nr_seq_order_unit_p bigint, nr_seq_rotina_p text, nm_usuario_p text) FROM PUBLIC;

