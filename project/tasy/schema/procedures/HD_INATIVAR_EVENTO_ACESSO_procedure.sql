-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_inativar_evento_acesso (nr_seq_p bigint) AS $body$
DECLARE

    usuario_ativo_w       varchar(255);
    nr_seq_evento_w       bigint;
    nr_seq_proc_interno_w bigint;
    nr_seq_proc_gerada_w  bigint;
    cd_convenio_w         bigint;
    nr_seq_propaci_w      bigint;

BEGIN

    -- select * from hd_evento_acesso

    -- select * from hd_evento_acesso_pac

    -- select * from hd_acesso

    -- select * from procedimento_paciente where nr_sequencia = 
    usuario_ativo_w := obter_usuario_ativo;
    --usuario_ativo_w := 'gmllessa';
    SELECT nr_seq_evento,
           nr_seq_propaci
      INTO STRICT nr_seq_evento_w,
           nr_seq_propaci_w
      FROM hd_evento_acesso_pac
     WHERE nr_sequencia = nr_seq_p;

    BEGIN
        SELECT nr_seq_proc_interno
          INTO STRICT nr_seq_proc_interno_w
          FROM hd_evento_acesso
         WHERE nr_sequencia = nr_seq_evento_w;
    EXCEPTION
        WHEN no_data_found THEN
            nr_seq_proc_interno_w := NULL;
    END;

    IF (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') THEN
        BEGIN

            SELECT cd_convenio INTO STRICT cd_convenio_w FROM procedimento_paciente WHERE nr_sequencia = nr_seq_propaci_w;

            nr_seq_proc_gerada_w := duplicar_proc_paciente(nr_seq_propaci_w, usuario_ativo_w, nr_seq_proc_gerada_w);

            IF (nr_seq_proc_gerada_w IS NOT NULL AND nr_seq_proc_gerada_w::text <> '') THEN
                UPDATE procedimento_paciente
                   SET nr_interno_conta      = NULL,
                       qt_procedimento      = qt_procedimento * -1,
                       vl_procedimento      = vl_procedimento * -1,
                       vl_medico            = vl_medico * -1,
                       vl_anestesista       = vl_anestesista * -1,
                       vl_materiais         = vl_materiais * -1,
                       vl_auxiliares        = vl_auxiliares * -1,
                       vl_custo_operacional = vl_custo_operacional * -1,
                       vl_adic_plant        = vl_adic_plant * -1,
                       ds_observacao        = wheb_mensagem_pck.get_texto(370110, 'DS_OBSERVACAO_W=' || ds_observacao),
                       dt_procedimento      = clock_timestamp()
                 WHERE nr_sequencia = nr_seq_proc_gerada_w;

                UPDATE procedimento_paciente
                   SET nr_seq_proc_est = nr_seq_proc_gerada_w
                 WHERE nr_sequencia = nr_seq_propaci_w;

                CALL atualiza_preco_procedimento(nr_seq_proc_gerada_w, cd_convenio_w, usuario_ativo_w);
            END IF;

        END;
    END IF;

    UPDATE hd_evento_acesso_pac
       SET dt_inativacao         = clock_timestamp(),
           nm_usuario_inativacao = usuario_ativo_w
     WHERE nr_sequencia = nr_seq_p;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_inativar_evento_acesso (nr_seq_p bigint) FROM PUBLIC;

