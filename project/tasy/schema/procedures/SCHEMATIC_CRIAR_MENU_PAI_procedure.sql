-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic_criar_menu_pai ( nr_seq_obj_schematic_p objeto_schematic.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE



/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Criar no Schematic todas os menus que são pais do menu criado
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ x] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
Procedure recursiva, é necessário tomar cuidado com qualquer alteração na mesma
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_obj_schematic_w		objeto_schematic.nr_sequencia%type;

C01 CURSOR( 	nr_seq_obj_schematic_pc	objeto_schematic.nr_sequencia%type ) FOR

	SELECT	s.cd_funcao,
		s.nr_seq_funcao_schematic,
		s.nr_seq_obj_sup,
		s.nr_seq_dic_objeto,
		a.nr_seq_menu_sup,
		coalesce(s.nr_seq_apres,0) nr_seq_apres,
		(SELECT initcap(c.nm_objeto)
		from 	dic_objeto c
		where	c.nr_sequencia = a.nr_seq_menu_sup) nm_objeto,
		(select c.nr_seq_menu_sup
		from 	dic_objeto c
		where	c.nr_sequencia = a.nr_seq_menu_sup) nr_seq_menu_sup_p
	from	objeto_schematic s,
		dic_objeto a
	where	s.nr_seq_dic_objeto 	= a.nr_sequencia
	and	s.nr_sequencia 		= nr_seq_obj_schematic_pc
	and	(a.nr_seq_menu_sup IS NOT NULL AND a.nr_seq_menu_sup::text <> '')
	and	not exists (	select 	1
				from	objeto_schematic b
				where	b.nr_seq_dic_objeto 	  = a.nr_seq_menu_sup
				and	b.nr_seq_funcao_schematic = s.nr_seq_funcao_schematic);

BEGIN


--Carrega os dados importados no XML para as tabelas quentes
for c01_w in C01( nr_seq_obj_schematic_p ) loop

	insert into objeto_schematic(
		nr_sequencia, dt_atualizacao_nrec, nm_usuario_nrec,
		dt_atualizacao, nm_usuario, cd_funcao,
		ds_objeto, ie_tipo_objeto, nr_seq_obj_sup,
		nr_seq_funcao_schematic, nr_seq_apres,ie_tipo_componente,
		nr_seq_dic_objeto, nr_seq_tipo_schematic)
	values (	nextval('objeto_schematic_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, c01_w.cd_funcao,
		c01_w.nm_objeto, 'C', c01_w.nr_seq_obj_sup,
		c01_w.nr_seq_funcao_schematic, (c01_w.nr_seq_apres+1), 'WPOPUP',
		c01_w.nr_seq_menu_sup, 92) returning nr_sequencia into nr_seq_obj_schematic_w;

	commit;

	--É necessário fazer  a chamada recursiva, devido aos POPUPs possuirem menu superior
	if (c01_w.nr_seq_menu_sup_p IS NOT NULL AND c01_w.nr_seq_menu_sup_p::text <> '') then
		CALL schematic_criar_menu_pai( nr_seq_obj_schematic_w, nm_usuario_p);
	end if;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic_criar_menu_pai ( nr_seq_obj_schematic_p objeto_schematic.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

