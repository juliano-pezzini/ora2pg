-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_alteracao_benef AS (ds_campo_old varchar(255), ds_campo_new varchar(255), ds_campo varchar(255));


CREATE OR REPLACE PROCEDURE pls_gravar_alt_solic_alteracao ( nr_seq_inclusao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_pessoa_fisica_old_w		pessoa_fisica.nm_pessoa_fisica%type;
ie_sexo_old_w			pessoa_fisica.ie_sexo%type;
ie_estado_civil_old_w		pessoa_fisica.ie_estado_civil%type;
nr_identidade_old_w		pessoa_fisica.nr_identidade%type;
nr_cpf_old_w			pessoa_fisica.nr_cpf%type;
nr_pis_pasep_old_w		pessoa_fisica.nr_pis_pasep%type;
dt_nascimento_old_w		pessoa_fisica.dt_nascimento%type;
nr_ddd_celular_old_w		pessoa_fisica.nr_ddd_celular%type;
ds_endereco_old_w		compl_pessoa_fisica.ds_endereco%type;
ds_bairro_old_w			compl_pessoa_fisica.ds_bairro%type;
ds_municipio_old_w		compl_pessoa_fisica.ds_municipio%type;
sg_estado_old_w			compl_pessoa_fisica.sg_estado%type;
cd_cep_old_w			compl_pessoa_fisica.cd_cep%type;
ds_email_old_w			compl_pessoa_fisica.ds_email%type;
nr_ddd_telefone_old_w		compl_pessoa_fisica.nr_ddd_telefone%type;
nr_telefone_old_w		compl_pessoa_fisica.nr_telefone%type;
nr_telefone_celular_old_w	compl_pessoa_fisica.nr_telefone_celular%type;
cd_municipio_ibge_old_w		compl_pessoa_fisica.cd_municipio_ibge%type;
nm_pai_old_w			varchar(255);
nm_mae_old_w			varchar(255);
cd_declaracao_nasc_vivo_old_w	pessoa_fisica.cd_declaracao_nasc_vivo%type;
nr_cartao_nac_sus_old_w		pessoa_fisica.nr_cartao_nac_sus%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nm_pessoa_fisica_w		pls_inclusao_beneficiario.nm_pessoa_fisica%type;
ie_sexo_w			pls_inclusao_beneficiario.ie_sexo%type;
ie_estado_civil_w		pls_inclusao_beneficiario.ie_estado_civil%type;
nr_identidade_w			pls_inclusao_beneficiario.nr_identidade%type;
nr_cpf_w			pls_inclusao_beneficiario.nr_cpf%type;
dt_nascimento_w			pls_inclusao_beneficiario.dt_nascimento%type;
nm_mae_w			pls_inclusao_beneficiario.nm_mae%type;
nr_seq_segurado_w		pls_inclusao_beneficiario.nr_seq_segurado%type;
ds_endereco_w			pls_inclusao_beneficiario.ds_endereco%type;
ds_bairro_w			pls_inclusao_beneficiario.ds_bairro%type;
ds_municipio_w			pls_inclusao_beneficiario.ds_municipio%type;
sg_estado_w			pls_inclusao_beneficiario.sg_estado%type;
cd_cep_w			pls_inclusao_beneficiario.cd_cep%type;
ds_email_w			pls_inclusao_beneficiario.ds_email%type;
nr_ddd_telefone_w		pls_inclusao_beneficiario.nr_ddd_telefone%type;
nr_telefone_w			pls_inclusao_beneficiario.nr_telefone%type;
nr_ddd_celular_w		pls_inclusao_beneficiario.nr_ddd_celular%type;
nr_telefone_celular_w		pls_inclusao_beneficiario.nr_telefone_celular%type;
cd_municipio_ibge_w		pls_inclusao_beneficiario.cd_municipio_ibge%type;
nr_pis_pasep_w			pls_inclusao_beneficiario.nr_pis_pasep%type;
ie_alterou_w			varchar(10);
nm_pai_w			pls_inclusao_beneficiario.nm_pai%type;
cd_declaracao_nasc_vivo_w	pls_inclusao_beneficiario.cd_declaracao_nasc_vivo%type;
nr_cartao_nac_sus_w		pls_inclusao_beneficiario.nr_cartao_nac_sus%type;
nr_vetor_w			bigint;
qt_reg_complemto_w		bigint;
type vetor is table of reg_alteracao_benef index by integer;
vetor_w				vetor;

BEGIN

select	nm_pessoa_fisica,
	ie_sexo,
	ie_estado_civil,
	nr_identidade,
	CASE WHEN ie_cpf_proprio='N' THEN null  ELSE nr_cpf END ,
	dt_nascimento,
	nm_mae,
	ds_endereco,
	ds_bairro,
	ds_municipio,
	sg_estado,
	cd_cep,
	ds_email,
	nr_ddd_telefone,
	nr_telefone,
	nr_ddd_celular,
	nr_telefone_celular,
	nr_pis_pasep,
	nr_seq_segurado,
	cd_municipio_ibge,
	nm_pai,
	cd_declaracao_nasc_vivo,
	nr_cartao_nac_sus
into STRICT	nm_pessoa_fisica_w,
	ie_sexo_w,
	ie_estado_civil_w,
	nr_identidade_w,
	nr_cpf_w,
	dt_nascimento_w,
	nm_mae_w,
	ds_endereco_w,
	ds_bairro_w,
	ds_municipio_w,
	sg_estado_w,
	cd_cep_w,
	ds_email_w,
	nr_ddd_telefone_w,
	nr_telefone_w,
	nr_ddd_celular_w,
	nr_telefone_celular_w,
	nr_pis_pasep_w,
	nr_seq_segurado_w,
	cd_municipio_ibge_w,
	nm_pai_w,
	cd_declaracao_nasc_vivo_w,
	nr_cartao_nac_sus_w
from	pls_inclusao_beneficiario
where	nr_sequencia	= nr_seq_inclusao_p;

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_w;

select	nm_pessoa_fisica,
	ie_sexo,
	ie_estado_civil,
	nr_identidade,
	nr_cpf,
	nr_pis_pasep,
	dt_nascimento,
	nr_ddd_celular,
	nr_telefone_celular,
	cd_declaracao_nasc_vivo,
	nr_cartao_nac_sus
into STRICT	nm_pessoa_fisica_old_w,
	ie_sexo_old_w,
	ie_estado_civil_old_w,
	nr_identidade_old_w,
	nr_cpf_old_w,
	nr_pis_pasep_old_w,
	dt_nascimento_old_w,
	nr_ddd_celular_old_w,
	nr_telefone_celular_old_w,
	cd_declaracao_nasc_vivo_old_w,
	nr_cartao_nac_sus_old_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

nm_mae_old_w	:= substr(obter_nome_pai_mae(cd_pessoa_fisica_w,'M'),1,255);
nm_pai_old_w	:= substr(obter_nome_pai_mae(cd_pessoa_fisica_w,'P'),1,255);

select	count(1)
into STRICT	qt_reg_complemto_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_w
and	ie_tipo_complemento	= 1;

if (qt_reg_complemto_w > 0) then
	select	ds_endereco,
		ds_bairro,
		ds_municipio,
		sg_estado,
		cd_cep,
		ds_email,
		nr_ddd_telefone,
		nr_telefone,
		cd_municipio_ibge
	into STRICT	ds_endereco_old_w,
		ds_bairro_old_w,
		ds_municipio_old_w,
		sg_estado_old_w,
		cd_cep_old_w,
		ds_email_old_w,
		nr_ddd_telefone_old_w,
		nr_telefone_old_w,
		cd_municipio_ibge_old_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	ie_tipo_complemento	= 1;
end if;

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nm_pessoa_fisica_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nm_pessoa_fisica_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Nome';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ie_sexo_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ie_sexo_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Sexo';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ie_estado_civil_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ie_estado_civil_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Estado civil';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_identidade_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_identidade_w;
vetor_w[nr_vetor_w].ds_campo		:= 'RG';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_cpf_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_cpf_old_w;
vetor_w[nr_vetor_w].ds_campo		:= 'CPF';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= to_char(dt_nascimento_old_w,'dd/mm/yyyy');
vetor_w[nr_vetor_w].ds_CAMPO_new	:= to_char(dt_nascimento_w,'dd/mm/yyyy');
vetor_w[nr_vetor_w].ds_campo		:= 'Data de nascimento';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_pis_pasep_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_pis_pasep_w;
vetor_w[nr_vetor_w].ds_campo		:= 'PIS/PASEP';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_ddd_celular_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_ddd_celular_w;
vetor_w[nr_vetor_w].ds_campo		:= 'DDD Celuar';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_telefone_celular_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_telefone_celular_old_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Telefone celuar';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ds_endereco_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ds_endereco_w;
vetor_w[nr_vetor_w].ds_campo		:= wheb_mensagem_pck.get_texto(1108638);

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ds_bairro_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ds_bairro_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Bairro';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ds_municipio_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ds_municipio_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Municipio';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= sg_estado_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= sg_estado_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Estado';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nm_pessoa_fisica_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nm_pessoa_fisica_w;
vetor_w[nr_vetor_w].ds_campo		:= 'CEP';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= ds_email_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= ds_email_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Email';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_telefone_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_ddd_telefone_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Telefone';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_ddd_telefone_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_ddd_telefone_w;
vetor_w[nr_vetor_w].ds_campo		:= 'DDD Telefone';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= cd_municipio_ibge_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= cd_municipio_ibge_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Municipio IBGE';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nm_pai_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nm_pai_w;
vetor_w[nr_vetor_w].ds_campo		:= 'Nome do pai';

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nm_mae_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nm_mae_w;
vetor_w[nr_vetor_w].ds_campo		:= wheb_mensagem_pck.get_texto(1108639);

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= nr_cartao_nac_sus_old_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= nr_cartao_nac_sus_w;
vetor_w[nr_vetor_w].ds_campo		:= wheb_mensagem_pck.get_texto(1108641);

nr_vetor_w				:= vetor_w.count+1;
vetor_w[nr_vetor_w].ds_campo_old	:= cd_declaracao_nasc_vivo_w;
vetor_w[nr_vetor_w].ds_CAMPO_new	:= cd_declaracao_nasc_vivo_old_w;
vetor_w[nr_vetor_w].ds_campo		:= wheb_mensagem_pck.get_texto(1108642);

for i in 1..vetor_w.count loop
	ie_alterou_w	:= 'N';
	if (vetor_w[i].ds_campo = 'Data de nascimento') then
		if (vetor_w[i].ds_campo_old <> vetor_w[i].ds_CAMPO_new) then
			ie_alterou_w	:= 'S';
		end if;
	else
		if (coalesce(vetor_w[i].ds_campo_old,'0') <> coalesce(vetor_w[i].ds_CAMPO_new,'0')) then
			ie_alterou_w	:= 'S';
		end if;
	end if;
	
	if (ie_alterou_w = 'S') then
		insert into pls_inclusao_benef_alt(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_inclusao_benef,ds_alteracao)
		values (	nextval('pls_inclusao_benef_alt_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_inclusao_p, wheb_mensagem_pck.get_texto(1108643, 'DS_CAMPO='||vetor_w[i].ds_campo||';'||'DS_CAMPO_OLD='||vetor_w[i].ds_campo_old||';'||'DS_CAMPO_NEW='||vetor_w[i].ds_CAMPO_new));
	end if;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_alt_solic_alteracao ( nr_seq_inclusao_p bigint, nm_usuario_p text) FROM PUBLIC;

