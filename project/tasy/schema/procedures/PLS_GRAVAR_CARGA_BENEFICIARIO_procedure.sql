-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_carga_beneficiario ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
cd_pessoa_titular_w		varchar(10);
nr_seq_contrato_w		bigint;
nr_seq_pagador_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_tabela_w			bigint;
dt_contratacao_w		timestamp;
nr_seq_parentesco_w		bigint;
dt_rescisao_w			timestamp;
dt_inclusao_operadora_w		timestamp;
cd_cod_anterior_w		varchar(20);
ie_tipo_segurado_w		varchar(3);
nr_seq_seg_contrato_w		bigint;
nr_seq_titular_w		bigint;
qt_registro_w			integer	:= 0;
cd_usuario_plano_w		varchar(30);
nr_seq_emissor_w		bigint;
nr_seq_segurado_w		bigint;
dt_contrato_w			timestamp;
cd_estabelecimento_w		smallint;
nr_cco_w			bigint;
ie_digito_cco_w			smallint;
dt_validade_cart_w		timestamp;
nr_via_cart_w			integer;

C01 CURSOR FOR
	SELECT	cd_pessoa_fisica,
		cd_pessoa_titular,
		nr_seq_contrato,
		nr_seq_pagador,
		nr_seq_plano,
		nr_seq_tabela,
		dt_contratacao,
		nr_seq_parentesco,
		dt_rescisao,
		dt_inclusao_operadora,
		cd_cod_anterior,
		ie_tipo_segurado,
		cd_usuario_plano,
		nr_cco,
		ie_digito_cco,
		dt_validade_carteira,
		nr_via_carteira
	from	w_pls_carga_segurado
	where	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '')
	and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '')
	order by CASE WHEN coalesce(cd_pessoa_titular::text, '') = '' THEN -1  ELSE cd_pessoa_titular END; --aaschlote 14/04/20101 OS 306320 - Ordenar primeiros os titulares e depois os dependentes;
BEGIN

open C01;
loop
fetch C01 into
	cd_pessoa_fisica_w,
	cd_pessoa_titular_w,
	nr_seq_contrato_w,
	nr_seq_pagador_w,
	nr_seq_plano_w,
	nr_seq_tabela_w,
	dt_contratacao_w,
	nr_seq_parentesco_w,
	dt_rescisao_w,
	dt_inclusao_operadora_w,
	cd_cod_anterior_w,
	ie_tipo_segurado_w,
	cd_usuario_plano_w,
	nr_cco_w,
	ie_digito_cco_w,
	dt_validade_cart_w,
	nr_via_cart_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	pls_segurado
	where	nr_seq_contrato		= nr_seq_contrato_w
	and	cd_pessoa_fisica	= cd_pessoa_fisica_w;

	if (qt_registro_w	= 0) then
		if (cd_pessoa_titular_w IS NOT NULL AND cd_pessoa_titular_w::text <> '') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_titular_w
			from	pls_segurado
			where	nr_seq_contrato		= nr_seq_contrato_w
			and	cd_pessoa_fisica	= cd_pessoa_titular_w;
		end if;

		select	coalesce(max(nr_seq_seg_contrato),0) + 1
		into STRICT	nr_seq_seg_contrato_w
		from	pls_segurado
		where	nr_seq_contrato	= nr_seq_contrato_w;

		select	nextval('pls_segurado_seq')
		into STRICT	nr_seq_segurado_w
		;

		insert into pls_segurado(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, cd_pessoa_fisica,
			nr_seq_titular, nr_seq_contrato, nr_seq_pagador,
			nr_seq_plano, nr_seq_tabela, dt_contratacao,
			nr_seq_parentesco, dt_rescisao, dt_inclusao_operadora,
			ie_tipo_segurado, cd_cod_anterior, nr_seq_seg_contrato, ie_situacao_atend,
			cd_estabelecimento,ie_importacao_base,nr_cco,ie_digito_cco)
		values (	nr_seq_segurado_w, clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, cd_pessoa_fisica_w,
			nr_seq_titular_w, nr_seq_contrato_w, nr_seq_pagador_w,
			nr_seq_plano_w, nr_seq_tabela_w, dt_contratacao_w,
			nr_seq_parentesco_w, dt_rescisao_w, dt_inclusao_operadora_w,
			ie_tipo_segurado_w, cd_cod_anterior_w, nr_seq_seg_contrato_w, 'A',
			cd_estabelecimento_p,'S',nr_cco_w,ie_digito_cco_w);

		begin
		select	coalesce(nr_seq_emissor,0),
			dt_contrato,
			cd_estabelecimento
		into STRICT	nr_seq_emissor_w,
			dt_contrato_w,
			cd_estabelecimento_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
		exception
			when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(262288, 'NR_SEQ_CONTRATO=' || nr_seq_contrato_w);
			/* Mensagem: Contrato: NR_SEQ_CONTRATO */

		end;

		if (coalesce(nr_via_cart_w::text, '') = '') then
			nr_via_cart_w	:= 1;
		end if;

		begin
		insert into pls_segurado_carteira(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
			dt_inicio_vigencia, cd_usuario_plano, nr_seq_emissor,
			ie_situacao, ds_observacao, nm_usuario_solicitante,
			dt_solicitacao, cd_estabelecimento,dt_validade_carteira,nr_via_solicitacao)
		values (	nextval('pls_segurado_carteira_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_segurado_w,
			coalesce(dt_contratacao_w,dt_contrato_w), cd_usuario_plano_w, nr_seq_emissor_w,
			'P', 'Cargas', nm_usuario_p,
			clock_timestamp(), cd_estabelecimento_w,dt_validade_cart_w,nr_via_cart_w);
		exception
			when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(262290, 'NR_SEQ_CONTRATO=' || nr_seq_contrato_w || ';DT_CONTRATACAO=' || dt_contratacao_w || ';DT_CONTRATO=' || dt_contrato_w || ';CD_PESSOA_FISICA=' || cd_pessoa_fisica_w);
			/* Mensagem: NR_SEQ_CONTRATO - DT_CONTRATACAO - DT_CONTRATO - CD_PESSOA_FISICA */

		end;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_carga_beneficiario ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

