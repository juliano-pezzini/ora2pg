-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_comunic_lib_prot ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_usuario_param_w	varchar(20);
ds_lista_usuario_w	varchar(4000);
nm_usuario_perfil_w	varchar(20);
cd_perfil_w		bigint;
ds_lista_perfil_w	varchar(4000);


C01 CURSOR FOR
	SELECT 	nm_usuario_param
	from	funcao_param_usuario
	where 	cd_funcao = 1208
	and	nr_sequencia = 23;

C02 CURSOR FOR
	SELECT	cd_perfil
	from  	funcao_param_perfil
	where	cd_funcao = 1208
	and	nr_sequencia = 23;


BEGIN

open C01;
loop
fetch C01 into
	nm_usuario_param_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	begin
	select	distinct c.nm_usuario
	into STRICT 	nm_usuario_perfil_w
	from	funcao_param_perfil a,
		perfil b,
		usuario_perfil c
	where	a.cd_funcao = 1208
	and	a.nr_sequencia = 23
	and	a.cd_perfil = b.cd_perfil
	and	b.cd_perfil = c.cd_perfil
	and	c.nm_usuario = nm_usuario_param_w;
	exception
	when others then
		nm_usuario_perfil_w	:= '';
	end;

	if (coalesce(ds_lista_usuario_w::text, '') = '') and (coalesce(nm_usuario_perfil_w::text, '') = '') then
		ds_lista_usuario_w := nm_usuario_param_w;
	elsif (coalesce(nm_usuario_perfil_w::text, '') = '') then
		ds_lista_usuario_w := ds_lista_usuario_w || ',' || nm_usuario_param_w;
	end if;

	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	if (ds_lista_perfil_w IS NOT NULL AND ds_lista_perfil_w::text <> '') then
		ds_lista_perfil_w := ds_lista_perfil_w || ',' || to_char(cd_perfil_w) ||  ',';
	else
		ds_lista_perfil_w := to_char(cd_perfil_w) || ',';
	end if;
	end;
end loop;
close C02;

insert into comunic_interna(dt_comunicado, ds_titulo, ds_comunicado,
	nm_usuario, dt_atualizacao, ie_geral,
	nm_usuario_destino, cd_perfil, nr_sequencia,
	ie_gerencial, nr_seq_classif, ds_perfil_adicional,
	cd_setor_destino, cd_estab_destino, ds_setor_adicional,
	dt_liberacao, ds_grupo, nm_usuario_oculto,
	nr_atendimento,	ds_grupo_perfil, ds_usuarios_ocultos,
	nr_seq_agenda)
values (clock_timestamp(), 'Protocolo liberado', 'O protocolo ' || nr_seq_protocolo_p || ' est√° liberado pelo Itamed.',
	nm_usuario_p, clock_timestamp(), 'N',
	ds_lista_usuario_w, null, nextval('comunic_interna_seq'),
	'N', null, ds_lista_perfil_w,
	null, null, null,
	clock_timestamp(), null, null,
	null, null, null,
	null);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_comunic_lib_prot ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

