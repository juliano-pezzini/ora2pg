-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_ordem_compra ( nr_ordem_compra_p bigint, nr_nova_ordem_p bigint, nr_item_oci_p bigint, ie_atualiza_p bigint, dt_entrega_p timestamp, qt_entrega_p bigint, nm_usuario_p text) AS $body$
DECLARE

qt_existe_ordem_w		bigint;
dt_prevista_entrega_w	timestamp;
nr_nova_ordem_w		bigint;
qt_material_original_w	numeric(20);
qt_material_desd_w		double precision;
qt_material_w		double precision;
nr_sequencia_w		bigint;
ds_observacao_w		varchar(4000);
vl_unitario_material_w	double precision;
vl_total_item_w		double precision;


BEGIN

if (nr_ordem_compra_p > 0) and (nr_item_oci_p > 0) then
	
	select	coalesce(vl_unitario_material,0)
	into STRICT	vl_unitario_material_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;
	
end if;

select	count(*)
into STRICT	qt_existe_ordem_w
from	ordem_compra
where	nr_ordem_compra = nr_nova_ordem_p;
if (ie_atualiza_p = 0) then
	begin
	if (nr_item_oci_p <> 0) then
		select	coalesce(qt_material,0)
		into STRICT	qt_material_original_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_p;
		qt_material_w := (qt_material_original_w - qt_material_desd_w);
	end if;

	update	ordem_compra
	set	dt_entrega = dt_entrega_p
	where	nr_ordem_compra = nr_ordem_compra_p;

	vl_total_item_w	:= qt_entrega_p * vl_unitario_material_w;
	
	update	ordem_compra_item
	set	qt_material	= qt_entrega_p,
		vl_total_item	= vl_total_item_w
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci	= nr_item_oci_p;

	update	ordem_compra_item_entrega
	set	qt_prevista_entrega = qt_entrega_p,
		dt_prevista_entrega = dt_entrega_p
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;
	
	update ordem_compra_item_trib
	set vl_tributo = ((vl_total_item_w/100)*pr_tributo)
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	end;
end if;

if (ie_atualiza_p = 1) then
	if (qt_entrega_p > 0) then
		if (qt_existe_ordem_w = 0) then
		
			select	ds_observacao
			into STRICT	ds_observacao_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;
					
			ds_observacao_w	:= substr(wheb_mensagem_pck.get_texto(299421, 'NR_ORDEM_COMPRA=' || nr_ordem_compra_p) || chr(13) || chr(10) || substr(ds_observacao_w,1,3900),1,4000);
			
			insert into ordem_compra(
				nr_ordem_compra,
				cd_estabelecimento,
				cd_cgc_fornecedor,
				cd_condicao_pagamento,
				cd_comprador,
				dt_ordem_compra,
				dt_atualizacao,
				nm_usuario,
				cd_moeda,
				ie_situacao,
				dt_inclusao,
				cd_pessoa_solicitante,
				cd_cgc_transportador,
				ie_frete,
				vl_frete,
				pr_multa_atraso,
				pr_desconto,
				pr_desc_pgto_antec,
				pr_juros_negociado,
				dt_emissao,
				ds_pessoa_contato,
				ds_observacao,
				cd_motivo_alteracao,
				cd_local_entrega,
				dt_entrega,
				nr_prescricao,
				ie_aviso_chegada,
				nr_requisicao,
				cd_pessoa_fisica,
				nr_ordem_agrup,
				ie_emite_obs,
				ie_urgente,
				nr_seq_interno,
				nr_atendimento,
				nm_usuario_imp,
				ie_somente_pagto,
				nr_seq_motivo_cancel,
				vl_despesa_acessoria,
				cd_setor_atendimento,
				nr_seq_subgrupo_compra,
				pr_desc_financeiro,
				dt_leitura,
				dt_aceite,
				nm_usuario_aceite,
				nr_seq_forma_pagto,
				vl_desconto,
				ie_tipo_ordem,
				nr_documento_externo)
			SELECT	nr_nova_ordem_p,
				cd_estabelecimento,
				cd_cgc_fornecedor,
				cd_condicao_pagamento,
				cd_comprador,
				dt_ordem_compra,
				clock_timestamp(),
				nm_usuario_p,
				cd_moeda,
				ie_situacao,
				dt_inclusao,
				cd_pessoa_solicitante,
				cd_cgc_transportador,
				ie_frete,
				vl_frete,
				pr_multa_atraso,
				pr_desconto,
				pr_desc_pgto_antec,
				pr_juros_negociado,
				clock_timestamp(),
				ds_pessoa_contato,
				ds_observacao_w,
				cd_motivo_alteracao,
				cd_local_entrega,
				dt_entrega_p,
				nr_prescricao,
				ie_aviso_chegada,
				nr_requisicao,
				cd_pessoa_fisica,
				nr_ordem_agrup,
				ie_emite_obs,
				ie_urgente,
				nr_seq_interno,
				nr_atendimento,
				nm_usuario_imp,
				ie_somente_pagto,
				nr_seq_motivo_cancel,
				vl_despesa_acessoria,
				cd_setor_atendimento,
				nr_seq_subgrupo_compra,
				pr_desc_financeiro,
				dt_leitura,
				dt_aceite,
				nm_usuario_aceite,
				nr_seq_forma_pagto,
				coalesce(vl_desconto,0),
				'D',
				nr_documento_externo
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;
		end if;

		vl_total_item_w	:= qt_entrega_p * vl_unitario_material_w;
		
		insert into ordem_compra_item(
			nr_ordem_compra,
			nr_item_oci,
			cd_material,
			cd_unidade_medida_compra,
			vl_unitario_material,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			cd_pessoa_solicitante,
			qt_material_entregue,
			pr_descontos,
			cd_local_estoque,
			ds_material_direto,
			ds_observacao,
			cd_motivo_alteracao,
			nr_cot_compra,
			nr_item_cot_compra,
			ds_marca,
			vl_item_liquido,
			cd_centro_custo,
			cd_conta_contabil,
			nr_solic_compra,
			nr_item_solic_compra,
			qt_conv_unid_fornec,
			ie_geracao_solic,
			nr_seq_proj_rec,
			pr_desc_financ,
			nr_seq_lic_item,
			nr_seq_conta_financ,
			qt_original,
			dt_validade,
			nr_seq_marca,
			nr_seq_ordem_serv,
			vl_ultima_compra,
			vl_dif_ultima_compra,
			pr_dif_ultima_compra,
			nr_seq_unidade_adic,
			vl_desconto,
			nr_atendimento,
			vl_total_item,
			nr_documento_externo)
		SELECT	nr_nova_ordem_p,
			nr_item_oci_p,
			cd_material,
			cd_unidade_medida_compra,
			vl_unitario_material,
			qt_entrega_p,
			clock_timestamp(),
			nm_usuario_p,
			ie_situacao,
			cd_pessoa_solicitante,
			qt_material_entregue,
			pr_descontos,
			cd_local_estoque,
			ds_material_direto,
			ds_observacao,
			cd_motivo_alteracao,
			nr_cot_compra,
			nr_item_cot_compra,
			ds_marca,
			vl_item_liquido,
			cd_centro_custo,
			cd_conta_contabil,
			nr_solic_compra,
			nr_item_solic_compra,
			qt_conv_unid_fornec,
			ie_geracao_solic,
			nr_seq_proj_rec,
			pr_desc_financ,
			nr_seq_lic_item,
			nr_seq_conta_financ,
			qt_entrega_p,
			dt_validade,
			nr_seq_marca,
			nr_seq_ordem_serv,
			vl_ultima_compra,
			vl_dif_ultima_compra,
			pr_dif_ultima_compra,
			nr_seq_unidade_adic,
			coalesce(vl_desconto,0),
			nr_atendimento,
			vl_total_item_w,
			nr_documento_externo
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_p;

		select	max(dt_prevista_entrega)
		into STRICT	dt_prevista_entrega_w
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_p;

		insert	into ordem_compra_item_entrega(
			nr_ordem_compra,
			nr_item_oci,
			dt_prevista_entrega,
			dt_real_entrega,
			dt_entrega_original,
			dt_entrega_limite,
			qt_prevista_entrega,
			qt_real_entrega,
			dt_atualizacao,
			nm_usuario,
			ds_observacao,
			dt_cancelamento,
			nr_sequencia)
		SELECT	nr_nova_ordem_p,
			nr_item_oci_p,
			dt_entrega_p,
			dt_real_entrega,
			dt_entrega_p,
			dt_entrega_p,
			qt_entrega_p,
			qt_real_entrega,
			clock_timestamp(),
			nm_usuario_p,
			ds_observacao,
			dt_cancelamento,
			nextval('ordem_compra_item_entrega_seq')
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_p
		and	dt_prevista_entrega = dt_prevista_entrega_w;

		qt_material_desd_w := (qt_material_desd_w + qt_entrega_p);
		
		insert into ordem_compra_item_trib(
		       nr_ordem_compra,
		       nr_item_oci,
		       cd_tributo,
		       pr_tributo,
		       dt_atualizacao,
		       nm_usuario,
		       ds_observacao,
		       ie_corpo_item,
			   vl_tributo)	
		SELECT nr_nova_ordem_p,
		       nr_item_oci_p,
		       cd_tributo,
		       pr_tributo,
		       clock_timestamp(),
		       nm_usuario_p,
		       ds_observacao,
		       ie_corpo_item,
			   ((vl_total_item_w/100)*pr_tributo)
		from ordem_compra_item_trib
		where nr_ordem_compra = nr_ordem_compra_p
		  and nr_item_oci = nr_item_oci_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_ordem_compra ( nr_ordem_compra_p bigint, nr_nova_ordem_p bigint, nr_item_oci_p bigint, ie_atualiza_p bigint, dt_entrega_p timestamp, qt_entrega_p bigint, nm_usuario_p text) FROM PUBLIC;

