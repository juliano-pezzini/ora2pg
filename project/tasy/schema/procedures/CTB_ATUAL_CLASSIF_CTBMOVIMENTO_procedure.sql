-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_atual_classif_ctbmovimento ( nr_lote_contabil_p bigint, ie_sobrepor_p text) AS $body$
DECLARE


cd_classif_debito_w			ctb_movimento.cd_classif_debito%type;
cd_classif_credito_w			ctb_movimento.cd_classif_credito%type;
ds_erro_w				varchar(2000);
ie_atualizar_w				varchar(1);
ie_atualizar_deb_w				varchar(1);
ie_atualizar_cred_w				varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.dt_movimento,
	a.cd_conta_debito,
	a.cd_conta_credito,
	a.cd_classif_debito,
	a.cd_classif_credito
from	ctb_movimento a
where	a.nr_lote_contabil	= nr_lote_contabil_p;

vet01	C01%RowType;


BEGIN

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ie_atualizar_w		:= 'S';
	ie_atualizar_deb_w	:= 'S';
	ie_atualizar_cred_w	:= 'S';
	cd_classif_debito_w	:= '';
	cd_classif_credito_w	:= '';

	/* Obter classif debito vigente */

	if (vet01.cd_conta_debito IS NOT NULL AND vet01.cd_conta_debito::text <> '') then
		cd_classif_debito_w	:= ctb_obter_classif_conta(vet01.cd_conta_debito, null, vet01.dt_movimento);
	end if;

	/* Obter classif credito vigente */

	if (vet01.cd_conta_credito IS NOT NULL AND vet01.cd_conta_credito::text <> '') then
		cd_classif_credito_w	:= ctb_obter_classif_conta(vet01.cd_conta_credito, null, vet01.dt_movimento);
	end if;

	/* Verifica se alterou */

	if (vet01.cd_classif_debito IS NOT NULL AND vet01.cd_classif_debito::text <> '') and (cd_classif_debito_w IS NOT NULL AND cd_classif_debito_w::text <> '') and (vet01.cd_classif_debito = cd_classif_debito_w) then
		ie_atualizar_deb_w	:= 'N';
	end if;

	if (vet01.cd_classif_credito IS NOT NULL AND vet01.cd_classif_credito::text <> '') and (cd_classif_credito_w IS NOT NULL AND cd_classif_credito_w::text <> '') and (vet01.cd_classif_credito = cd_classif_credito_w) then
		ie_atualizar_cred_w	:= 'N';
	end if;

	if (ie_atualizar_deb_w	= 'N') and (ie_atualizar_cred_w 	= 'N') then
		ie_atualizar_w		:= 'N';
	end if;

	/* Atualiza o registro porem somente se trocou a classifica√ßao */

	if (ie_atualizar_w = 'S') then

		begin
		update	ctb_movimento
		set	cd_classif_debito	= cd_classif_debito_w,
			cd_classif_credito	= cd_classif_credito_w
		where	nr_sequencia		= vet01.nr_sequencia;
		exception when others then
			ds_erro_w	:= substr(nr_lote_contabil_p || ' / ' || vet01.nr_sequencia || ' / DB' ||
							vet01.cd_conta_debito || ' / CR: ' || vet01.cd_conta_credito,1,2000);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266396,'DS_ERRO_W=' || ds_erro_w);
		end;
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_atual_classif_ctbmovimento ( nr_lote_contabil_p bigint, ie_sobrepor_p text) FROM PUBLIC;

