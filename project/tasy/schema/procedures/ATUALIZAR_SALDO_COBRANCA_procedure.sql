-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_cobranca ( nr_seq_cobranca_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


nr_titulo_w		bigint;
vl_titulo_original_w		double precision;
vl_saldo_w		double precision;
cd_estabelecimento_w	smallint;
ie_saldo_cob_w		varchar(255)	:= 'N';

dt_recebimento_w		timestamp;
vl_recebido_w		double precision;
vl_juros_w		double precision;
vl_multa_w		double precision;
vl_desconto_w		double precision;
vl_glosa_w		double precision;
vl_perdas_w		double precision;
vl_tributo_w		double precision;
vl_alteracao_w		double precision;
vl_titulo_w		double precision;
vl_nota_credito_w		double precision;
vl_recup_perda_w		double precision;
ie_encerrar_cob_liq_w	varchar(5)	:= 'N';
ie_nota_credito_cobr_w	varchar(1);
vl_cambial_passivo_w	titulo_receber_liq.vl_cambial_passivo%type;


BEGIN

select	cd_estabelecimento,
	nr_titulo
into STRICT	cd_estabelecimento_w,
	nr_titulo_w
from	cobranca
where	nr_sequencia	= nr_seq_cobranca_p;

select	coalesce(max(ie_saldo_cob),'N'),
	coalesce(max(ie_encerrar_cob_liq),'N'),
	coalesce(max(ie_nota_credito_cobr),'N')
into STRICT	ie_saldo_cob_w,
	ie_encerrar_cob_liq_w,
	ie_nota_credito_cobr_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_saldo_cob_w in ('S','P')) then

	if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
		begin
		if (ie_saldo_cob_w = 'S') then
			select	coalesce(max(dt_recebimento),clock_timestamp()),
				coalesce(sum(vl_recebido),0),
				coalesce(sum(vl_juros),0),
				coalesce(sum(vl_multa),0),
				coalesce(sum(vl_descontos),0),
				coalesce(sum(vl_glosa),0),
				coalesce(sum(vl_perdas),0),
				coalesce(sum(vl_nota_credito),0),
				coalesce(sum(vl_cambial_passivo),0)
			into STRICT 	dt_recebimento_w,
				vl_recebido_w,
				vl_juros_w,
				vl_multa_w,
				vl_desconto_w,
				vl_glosa_w,
				vl_perdas_w,
				vl_nota_credito_w,
				vl_cambial_passivo_w
			from	tipo_recebimento b,
				titulo_receber_liq a
			where	a.cd_tipo_recebimento	= b.cd_tipo_recebimento
			and	a.nr_titulo 		= nr_titulo_w
			and	coalesce(ie_lib_caixa, 'S') = 'S';
		else
			select	coalesce(max(dt_recebimento),clock_timestamp()),
				coalesce(sum(vl_recebido),0),
				coalesce(sum(vl_juros),0),
				coalesce(sum(vl_multa),0),
				coalesce(sum(vl_descontos),0),
				coalesce(sum(vl_glosa),0),
				coalesce(sum(vl_perdas),0),
				coalesce(sum(vl_nota_credito),0),
				coalesce(sum(vl_cambial_passivo),0)
			into STRICT 	dt_recebimento_w,
				vl_recebido_w,
				vl_juros_w,
				vl_multa_w,
				vl_desconto_w,
				vl_glosa_w,
				vl_perdas_w,
				vl_nota_credito_w,
				vl_cambial_passivo_w
			from	tipo_recebimento b,
				titulo_receber_liq a
			where	a.cd_tipo_recebimento	= b.cd_tipo_recebimento
			and	a.nr_titulo 		= nr_titulo_w
			and	((b.ie_tipo_consistencia <> 9) or
				((b.ie_tipo_consistencia = 9) and exists (
					SELECT	1
					from	perda_contas_receber x
					where	x.nr_titulo = a.nr_titulo
					and	x.nr_seq_baixa = a.nr_sequencia
					and	coalesce(x.ie_tipo_perda,'R') = 'I'
					and	not exists (	SELECT	1
								from	perda_contas_receb_baixa y,
									fin_tipo_baixa_perda z
								where	y.nr_seq_perda = x.nr_sequencia
								and	y.nr_seq_tipo_baixa = z.nr_sequencia
								and	z.ie_tipo_consistencia = '4'))))
			and	coalesce(ie_lib_caixa, 'S') = 'S';
		end if;

		if (ie_nota_credito_cobr_w <> 'S') then
			vl_nota_credito_w := 0;
		end if;

		select	coalesce(max(vl_titulo),0),
			coalesce(max(vl_saldo_titulo),0)
		into STRICT	vl_titulo_original_w,
			vl_saldo_w
		from	titulo_receber
		where	nr_titulo	= nr_titulo_w;

		select	coalesce(sum(CASE WHEN ie_aumenta_diminui='A' THEN  vl_alteracao WHEN ie_aumenta_diminui='D' THEN  vl_alteracao * -1 END ), 0)
		into STRICT	vl_alteracao_w
		from	alteracao_valor
		where	nr_titulo	=	nr_titulo_w;

		select	coalesce(sum(vl_tributo),0)
		into STRICT	vl_tributo_w
		from	titulo_receber_trib
		where	nr_titulo	= nr_titulo_w
		and	coalesce(ie_origem_tributo, 'C') = 'D';

		select	coalesce(sum(b.vl_baixa),0)
		into STRICT	vl_recup_perda_w
		from	perda_contas_receber a,
			perda_contas_receb_baixa b,
			fin_tipo_baixa_perda c
		where	a.nr_sequencia = b.nr_seq_perda
		and	b.nr_seq_tipo_baixa = c.nr_sequencia
		and	c.ie_tipo_consistencia in (0,1)
		and	a.nr_titulo = nr_titulo_w;

		vl_titulo_w 	:=  vl_titulo_original_w + vl_alteracao_w - (vl_recebido_w + vl_glosa_w + vl_desconto_w + vl_perdas_w + vl_recup_perda_w + vl_nota_credito_w + coalesce(vl_cambial_passivo_w,0)) - vl_tributo_w;

		update	cobranca
		set	vl_acobrar	= vl_titulo_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_cobranca_p;
		end;
	end if;
end if;


if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_cobranca ( nr_seq_cobranca_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

