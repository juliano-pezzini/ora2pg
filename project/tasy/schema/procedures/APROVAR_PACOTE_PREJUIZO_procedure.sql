-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovar_pacote_prejuizo ( Nr_Seq_proc_pacote_p Procedimento_Paciente.Nr_Sequencia%Type, Cd_Cargo_p Cargo.Cd_Cargo%Type, Nm_usuario_p Usuario.Nm_Usuario%Type, Ie_Aprovou_p INOUT text) AS $body$
DECLARE



nr_nivel_ant_w		smallint := 0;
ie_aprovou_w		varchar(1) := 'N';

C01 CURSOR FOR
	SELECT 	a.cd_cargo_aprovador,
			a.nm_usuario_aprovador,
			coalesce(a.nr_nivel,0) nr_nivel,
			a.nr_sequencia
	From	pacote_aprovacao a
	Where	Nr_Seq_proc_pacote = Nr_Seq_proc_pacote_p
	and		coalesce(a.dt_aprovacao::text, '') = ''
	Order By coalesce(a.nr_nivel,0);

BEGIN

If (coalesce(Nr_Seq_proc_pacote_p,0) > 0) Then

	For R1 In C01 Loop

		if (nr_nivel_ant_w = 0) or (R1.nr_nivel = nr_nivel_ant_w) then

			nr_nivel_ant_w	:= R1.nr_nivel;

			if	(R1.nm_usuario_aprovador IS NOT NULL AND R1.nm_usuario_aprovador::text <> '' AND R1.nm_usuario_aprovador = nm_usuario_p) or
				(R1.cd_cargo_aprovador IS NOT NULL AND R1.cd_cargo_aprovador::text <> '' AND R1.cd_cargo_aprovador = cd_cargo_p) then

				ie_aprovou_w	:= 'S';

				update	pacote_aprovacao
				set		dt_aprovacao = clock_timestamp(),
						nm_usuario_aprovacao = nm_usuario_p,
						dt_atualizacao = clock_timestamp(),
						nm_usuario = nm_usuario_p
				where	nr_sequencia = R1.nr_sequencia
				and	 	coalesce(dt_aprovacao::text, '') = '';

			end if;

		end if;

	End Loop;

End If;

Ie_Aprovou_p:=Ie_Aprovou_w;

Commit;

End;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovar_pacote_prejuizo ( Nr_Seq_proc_pacote_p Procedimento_Paciente.Nr_Sequencia%Type, Cd_Cargo_p Cargo.Cd_Cargo%Type, Nm_usuario_p Usuario.Nm_Usuario%Type, Ie_Aprovou_p INOUT text) FROM PUBLIC;

