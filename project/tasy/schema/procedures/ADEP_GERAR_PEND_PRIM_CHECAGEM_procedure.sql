-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_gerar_pend_prim_checagem ( nr_seq_projeto_p tasy_projeto_assinatura.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, ie_tipo_item_p text, nr_seq_horario_p bigint default null, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL, nr_seq_item_adep_p pep_item_pendente.nr_seq_item_adep%type default null, nr_etapa_adep_p bigint default null) AS $body$
DECLARE


ie_gera_sem_certificado_w		varchar(1);
cd_certificado_w			usuario.cd_certificado%type;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
											

BEGIN

select	max(a.cd_certificado)
into STRICT	cd_certificado_w
from	usuario	a
where	a.nm_usuario = nm_usuario_p;

ie_gera_sem_certificado_w	:= 'N';

if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
	ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(	nr_seq_projeto_p	=> nr_seq_projeto_p,
																cd_perfil_p			=> wheb_usuario_pck.get_cd_perfil);
end if;

if	((cd_certificado_w IS NOT NULL AND cd_certificado_w::text <> '') or (ie_gera_sem_certificado_w = 'S')) then
	select	max(a.cd_pessoa_fisica),
			max(a.nr_atendimento)
	into STRICT	cd_pessoa_fisica_w,
			nr_atendimento_w
	from	atendimento_paciente	a,
			prescr_medica			b
	where	a.nr_atendimento	= b.nr_atendimento
	and		b.nr_prescricao	 	= nr_prescricao_p;

	CALL gerar_registro_pendente_pep(	cd_tipo_registro_p			=> 'ADEP',
									nr_sequencia_registro_p     => nr_prescricao_p,
									cd_pessoa_fisica_p          => cd_pessoa_fisica_w,
									nr_atendimento_p            => nr_atendimento_w,
									nm_usuario_p                => nm_usuario_p,
									ie_tipo_pendencia_p         => 'A',
									nr_seq_horario_p            => nr_seq_horario_p,
									ie_tipo_item_adep_p         => ie_tipo_item_p,
									nr_seq_item_adep_p	    => nr_seq_item_adep_p,
									nr_etapa_adep_p             => nr_etapa_adep_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_gerar_pend_prim_checagem ( nr_seq_projeto_p tasy_projeto_assinatura.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, ie_tipo_item_p text, nr_seq_horario_p bigint default null, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL, nr_seq_item_adep_p pep_item_pendente.nr_seq_item_adep%type default null, nr_etapa_adep_p bigint default null) FROM PUBLIC;

