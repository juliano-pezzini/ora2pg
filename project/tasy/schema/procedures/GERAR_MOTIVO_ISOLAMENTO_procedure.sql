-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_motivo_isolamento (nr_atendimento_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text, ie_opcao_p text, ds_motivo_p text, ie_tipo_isolamento_p text, nr_seq_tipo_isolamento_cih_p bigint, dt_inicio_isolamento_p timestamp default null, dt_fim_isolamento_p timestamp default null, nr_seq_atend_precaucao_p bigint default null, nr_seq_precaucao_p bigint default null) AS $body$
DECLARE


nr_sequencia_w		bigint := 0;
nr_seq_tipo_alerta_w	bigint;
ie_valor_parametro_w	varchar(1);
ds_origem_w				varchar(4000);
ie_retirar_pc_isolamento_w		varchar(1);
cd_motivo_alta_w	motivo_alta.cd_motivo_alta%type;


BEGIN

ie_retirar_pc_isolamento_w := Obter_param_Usuario(3111, 132, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_retirar_pc_isolamento_w);
ie_valor_parametro_w := Obter_Param_Usuario(44, 247, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_valor_parametro_w);


/*
ie_opcao_p :
I = Início
T= Término
*/
if (ie_opcao_p = 'I') then  --Início
	if (nr_seq_tipo_isolamento_cih_p <> 0) then

		insert into motivo_isolamento_atend(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_Seq_motivo_isol,
				nr_atendimento,
				dt_inicio_isolamento,
				dt_fim_isolamento,
				ds_motivo,
				ie_tipo_isolamento,
				nr_seq_cih_tipo_isolamento,
				nr_seq_atendimento_precaucao)
		values (nextval('motivo_isolamento_atend_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_Seq_motivo_p,
				nr_atendimento_p,
				dt_inicio_isolamento_p,
				'',
				ds_motivo_p,
				ie_tipo_isolamento_p,
				nr_seq_tipo_isolamento_cih_p,
				nr_seq_precaucao_p);
	else

		insert into motivo_isolamento_atend(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_Seq_motivo_isol,
				nr_atendimento,
				dt_inicio_isolamento,
				dt_fim_isolamento,
				ds_motivo,
				ie_tipo_isolamento,
				nr_seq_atendimento_precaucao)
		values (nextval('motivo_isolamento_atend_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_Seq_motivo_p,
				nr_atendimento_p,
				dt_inicio_isolamento_p,
				'',
				ds_motivo_p,
				ie_tipo_isolamento_p,
				nr_seq_precaucao_p);
	end if;

	/*Não deve atualizar a data de início quando gerar o motivo pelo PEP ou Gestão de CCIH. Essa atualização é para a ocupação hospitalar solicitado na OS 1271499*/

	if (obter_funcao_ativa not in (281,7043)) then
		update	 atendimento_precaucao
		set	 dt_inicio	   = dt_inicio_isolamento_p
		where	 nr_sequencia      = nr_seq_precaucao_p;
	end if;

elsif (ie_opcao_p = 'T') then --Término
	if (coalesce(nr_seq_precaucao_p,0) > 0) then
		update	motivo_isolamento_atend
		set	dt_fim_isolamento		= dt_fim_isolamento_p,
			nm_usuario			= nm_usuario_p,
			dt_atualizacao			= clock_timestamp()
		where	nr_seq_atendimento_precaucao	= nr_seq_precaucao_p;

		ds_origem_w := substr(dbms_utility.format_call_stack,1,1800);

		insert into log_mov(	DT_ATUALIZACAO,
					NM_USUARIO,
					CD_LOG,
					DS_LOG)
			values (	clock_timestamp(),
					nm_usuario_p,
					55832,
					--'Liberação de Isolamento: Origem: '||ds_origem_w||' Atendimento:  '||nr_atendimento_p||'  Função ativa: '||obter_funcao_ativa||'  Perfil ativo: '||obter_perfil_ativo
					WHEB_MENSAGEM_PCK.get_texto(462231,'ds_origem='|| ds_origem_w ||';nr_atendimento='|| nr_atendimento_p ||';obter_funcao_ativa='|| obter_funcao_ativa ||';obter_perfil_ativo='|| obter_perfil_ativo)
					);

		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_alerta_w
		from	tipo_alerta_atend
		where	coalesce(ie_isolamento,'N')	= 'S';

		update	atendimento_alerta
		set	dt_inativacao		= dt_fim_isolamento_p,
			nm_usuario_inativacao	= nm_usuario_p,
			ie_situacao		= 'I'
		where	nr_seq_tipo_alerta 	= nr_seq_tipo_alerta_w
		and	nr_atendimento 		= nr_atendimento_p
		and	coalesce(dt_fim_alerta::text, '') = ''
		and	coalesce(dt_inativacao::text, '') = '';
	end if;

	if (coalesce(nr_seq_precaucao_p::text, '') = '') then

		if (coalesce(nr_seq_atend_precaucao_p,0) = 0) then
			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from	motivo_isolamento_atend
			where	nr_atendimento = nr_atendimento_p
			and	coalesce(dt_fim_isolamento::text, '') = '';
		else
			nr_sequencia_w	:=  nr_seq_atend_precaucao_p;
		end if;

		if (nr_sequencia_w > 0) then

			update	motivo_isolamento_atend
			set	dt_fim_isolamento	= dt_fim_isolamento_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_sequencia	= nr_sequencia_w;

			select	max(nr_sequencia)
			into STRICT	nr_seq_tipo_alerta_w
			from	tipo_alerta_atend
			where	coalesce(ie_isolamento,'N')	= 'S';

			update	atendimento_alerta
			set	dt_inativacao		= dt_fim_isolamento_p,
				nm_usuario_inativacao	= nm_usuario_p,
				ie_situacao		= 'I'
			where	nr_seq_tipo_alerta = nr_seq_tipo_alerta_w
			and	nr_atendimento = nr_atendimento_p
			and	coalesce(dt_fim_alerta::text, '') = ''
			and	coalesce(dt_inativacao::text, '') = '';
		end if;
	end if;

	if (coalesce(ie_valor_parametro_w,'U') = 'T')	then

		update	motivo_isolamento_atend
		set	dt_fim_isolamento	= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_atendimento		= nr_atendimento_p
		and	coalesce(dt_fim_isolamento::text, '') = '';
	end if;

	--Função ativa: Motivmentação de Pacientes
	if (obter_funcao_ativa = 3111) and (dt_fim_isolamento_p IS NOT NULL AND dt_fim_isolamento_p::text <> '') then
		CALL gerar_atendimento_precaucao(0 , nr_atendimento_p, 'T', null ,nm_usuario_p,nr_seq_atend_precaucao_p, '', '', '', '', dt_fim_isolamento_p);
	end if;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_motivo_isolamento (nr_atendimento_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text, ie_opcao_p text, ds_motivo_p text, ie_tipo_isolamento_p text, nr_seq_tipo_isolamento_cih_p bigint, dt_inicio_isolamento_p timestamp default null, dt_fim_isolamento_p timestamp default null, nr_seq_atend_precaucao_p bigint default null, nr_seq_precaucao_p bigint default null) FROM PUBLIC;

