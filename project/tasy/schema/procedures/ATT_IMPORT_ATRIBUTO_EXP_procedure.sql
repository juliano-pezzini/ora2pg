-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE vetorExpressao AS (vetorExpressao bigint[85]);


CREATE OR REPLACE PROCEDURE att_import_atributo_exp ( nr_seq_projeto_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tela_w	att_descricao_tela.nr_sequencia%type;
ds_descricao_w	lista_espera_elemento.ds_elemento%type;
expressao vetorExpressao;
qt_registro_w smallint;

C01 CURSOR FOR
	SELECT	substr(a.ds_elemento,1,255)
	from	lista_espera_elemento a
	where	a.nr_seq_projeto = nr_seq_projeto_p	
	and	not exists (	SELECT 1
				from 	att_descricao_tela x
				where	a.ds_elemento = x.ds_descricao)
	
union

	select	substr(a.ds_campo,1,255)
	from	lista_espera_atributo a,
		lista_espera_elemento b
	where	a.nr_seq_elemento = b.nr_sequencia
	and	b.nr_seq_projeto = nr_seq_projeto_p
	and	not exists (	select 1
				from 	att_descricao_tela x
				where	a.ds_campo = x.ds_descricao)
	
union

	select	substr(a.ds_atributo,1,255)
	from	lista_espera_atributo a,
		lista_espera_elemento b
	where	a.nr_seq_elemento = b.nr_sequencia
	and	b.nr_seq_projeto = nr_seq_projeto_p
	and	not exists (	select 1
				from 	att_descricao_tela x
				where	a.ds_atributo = x.ds_descricao)
	
union

	select	substr(a.ds_label,1,255)
	from	lista_espera_atributo a,
		lista_espera_elemento b
	where	a.nr_seq_elemento = b.nr_sequencia
	and	b.nr_seq_projeto = nr_seq_projeto_p
	and	not exists (	select 1
				from 	att_descricao_tela x
				where	a.ds_label = x.ds_descricao);
	
BEGIN

if (coalesce(nr_seq_projeto_p,0) > 0) then

	open C01;
	loop
	fetch C01 into	
		ds_descricao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		if (ds_descricao_w IS NOT NULL AND ds_descricao_w::text <> '')	and (length(trim(both ds_descricao_w)) > 0) then
			select 	nextval('att_descricao_tela_seq')
			into STRICT	nr_seq_tela_w
			;
		
			insert into ATT_DESCRICAO_TELA(	NR_SEQUENCIA,
								DT_ATUALIZACAO,
								NM_USUARIO,
								DT_ATUALIZACAO_NREC,
								NM_USUARIO_NREC,
								DS_DESCRICAO )
	  						values (	nr_seq_tela_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,	
								ds_descricao_w	);
		end if;
		end;
	end loop;
	close C01;
end if;

expressao := vetorExpressao(773706,759302,326424,667998,938901,317411,582178,782815,782815,302748,294203,338355,290992,965219,880737,283172,308614,
                            965241,965243,609936,965235,965203,965237,619719,965221,518164,612988,308816,321564,743973,749366,872004,284796,289232,
                            889336,285555,284200,289120,284755,289525,293659,744691,287065,744280,289161,294453,625399,293906,298476,286838,311535,
                            556035,965530,965532,965524,965526,600322,490221,490222,490510,490511,490512,490632,490633,490634,490635,490636,287354,
                            294607,284312,731335,518395,965528,328226,321624,327113,327114);

for i in 1..expressao.count loop

  ds_descricao_w := obter_desc_expressao(expressao(i));
  select count(1)
  into STRICT qt_registro_w
  from att_descricao_tela
  where ds_descricao = ds_descricao_w;

  if qt_registro_w = 0 then
    insert into att_descricao_tela(
      nr_sequencia,
      dt_atualizacao,
      nm_usuario,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      ds_descricao
    ) values (
      nextval('att_descricao_tela_seq'),
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,	
      ds_descricao_w);
    end if;

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE att_import_atributo_exp ( nr_seq_projeto_p bigint, nm_usuario_p text) FROM PUBLIC;

