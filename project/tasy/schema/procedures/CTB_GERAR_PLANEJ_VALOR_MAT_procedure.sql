-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_planej_valor_mat ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w          ctb_planej_orc_valor.nr_sequencia%type;
nr_seq_mes_ref_w        ctb_mes_ref.nr_sequencia%type;
dt_referencia_ww        timestamp;
index_w                 bigint := 0;

c_planej_orc_material CURSOR FOR
SELECT a.cd_conta_contabil,
       a.cd_centro_custo,
       a.cd_estabelecimento,
       a.cd_conta_financ,
       a.nr_seq_contrato,
       a.cd_cnpj,
       a.nr_seq_proj_gpi,
       coalesce(sum(a.vl_planej_01),0) vl_planej_01,
       coalesce(sum(a.vl_planej_02),0) vl_planej_02,
       coalesce(sum(a.vl_planej_03),0) vl_planej_03,
       coalesce(sum(a.vl_planej_04),0) vl_planej_04,
       coalesce(sum(a.vl_planej_05),0) vl_planej_05,
       coalesce(sum(a.vl_planej_06),0) vl_planej_06,
       coalesce(sum(a.vl_planej_07),0) vl_planej_07,
       coalesce(sum(a.vl_planej_08),0) vl_planej_08,
       coalesce(sum(a.vl_planej_09),0) vl_planej_09,
       coalesce(sum(a.vl_planej_10),0) vl_planej_10,
       coalesce(sum(a.vl_planej_11),0) vl_planej_11,
       coalesce(sum(a.vl_planej_12),0) vl_planej_12
from   ctb_planej_orc_material a
where  a.nr_seq_planej = nr_seq_planej_p
group by a.cd_conta_contabil,
         a.cd_centro_custo,
         a.cd_estabelecimento,
         a.cd_conta_financ,
         a.nr_seq_contrato,
         a.cd_cnpj,
         a.nr_seq_proj_gpi;

type t_planej_orc_material is table of c_planej_orc_material%rowtype;
v_planej_orc_material_w    t_planej_orc_material;

type t_ctb_planej_orc_valor is table of ctb_planej_orc_valor%rowtype index by integer;
v_ctb_planej_orc_valor_w t_ctb_planej_orc_valor;

BEGIN

open c_planej_orc_material;
loop fetch c_planej_orc_material bulk collect into v_planej_orc_material_w limit 1000;
    for i in 1 .. v_planej_orc_material_w.count loop
    begin

        update  ctb_planej_orc_valor a
        set     a.vl_planej_01      = v_planej_orc_material_w[i].vl_planej_01,
                a.vl_planej_02      = v_planej_orc_material_w[i].vl_planej_02,
                a.vl_planej_03      = v_planej_orc_material_w[i].vl_planej_03,
                a.vl_planej_04      = v_planej_orc_material_w[i].vl_planej_04,
                a.vl_planej_05      = v_planej_orc_material_w[i].vl_planej_05,
                a.vl_planej_06      = v_planej_orc_material_w[i].vl_planej_06,
                a.vl_planej_07      = v_planej_orc_material_w[i].vl_planej_07,
                a.vl_planej_08      = v_planej_orc_material_w[i].vl_planej_08,
                a.vl_planej_09      = v_planej_orc_material_w[i].vl_planej_09,
                a.vl_planej_10      = v_planej_orc_material_w[i].vl_planej_10,
                a.vl_planej_11      = v_planej_orc_material_w[i].vl_planej_11,
                a.vl_planej_12      = v_planej_orc_material_w[i].vl_planej_12,
                a.dt_atualizacao    = clock_timestamp(),
                a.nm_usuario        = nm_usuario_p
        where   a.nr_seq_planej         = nr_seq_planej_p
        and     a.cd_estabelecimento    = v_planej_orc_material_w[i].cd_estabelecimento
        and     a.cd_conta_contabil     = v_planej_orc_material_w[i].cd_conta_contabil
        and     a.cd_centro_custo       = v_planej_orc_material_w[i].cd_centro_custo
        and     coalesce(a.cd_conta_financ,0) = coalesce(v_planej_orc_material_w[i].cd_conta_financ,0)
        and     coalesce(a.nr_seq_contrato,0) = coalesce(v_planej_orc_material_w[i].nr_seq_contrato,0)
        and     coalesce(a.cd_cnpj,0)         = coalesce(v_planej_orc_material_w[i].cd_cnpj,0)
        and     coalesce(a.nr_seq_proj_gpi,0) = coalesce(v_planej_orc_material_w[i].nr_seq_proj_gpi,0);

        if (NOT FOUND) then

            select  nextval('ctb_planej_orc_valor_seq')
            into STRICT    nr_sequencia_w
;

            index_w := index_w + 1;

            v_ctb_planej_orc_valor_w[index_w].nr_sequencia          := nr_sequencia_w;
            v_ctb_planej_orc_valor_w[index_w].nr_seq_planej         := nr_seq_planej_p;
            v_ctb_planej_orc_valor_w[index_w].cd_estabelecimento    := v_planej_orc_material_w[i].cd_estabelecimento;
            v_ctb_planej_orc_valor_w[index_w].cd_centro_custo       := v_planej_orc_material_w[i].cd_centro_custo;
            v_ctb_planej_orc_valor_w[index_w].cd_conta_contabil     := v_planej_orc_material_w[i].cd_conta_contabil;
            v_ctb_planej_orc_valor_w[index_w].cd_conta_financ       := v_planej_orc_material_w[i].cd_conta_financ;
            v_ctb_planej_orc_valor_w[index_w].nr_seq_contrato       := v_planej_orc_material_w[i].nr_seq_contrato;
            v_ctb_planej_orc_valor_w[index_w].nr_seq_proj_gpi       := v_planej_orc_material_w[i].nr_seq_proj_gpi;
            v_ctb_planej_orc_valor_w[index_w].cd_cnpj               := v_planej_orc_material_w[i].cd_cnpj;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_01          := v_planej_orc_material_w[i].vl_planej_01;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_02          := v_planej_orc_material_w[i].vl_planej_02;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_03          := v_planej_orc_material_w[i].vl_planej_03;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_04          := v_planej_orc_material_w[i].vl_planej_04;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_05          := v_planej_orc_material_w[i].vl_planej_05;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_06          := v_planej_orc_material_w[i].vl_planej_06;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_07          := v_planej_orc_material_w[i].vl_planej_07;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_08          := v_planej_orc_material_w[i].vl_planej_08;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_09          := v_planej_orc_material_w[i].vl_planej_09;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_10          := v_planej_orc_material_w[i].vl_planej_10;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_11          := v_planej_orc_material_w[i].vl_planej_11;
            v_ctb_planej_orc_valor_w[index_w].vl_planej_12          := v_planej_orc_material_w[i].vl_planej_12;
            v_ctb_planej_orc_valor_w[index_w].dt_atualizacao       := clock_timestamp();
            v_ctb_planej_orc_valor_w[index_w].nm_usuario           := nm_usuario_p;
            v_ctb_planej_orc_valor_w[index_w].dt_atualizacao_nrec  := clock_timestamp();
            v_ctb_planej_orc_valor_w[index_w].nm_usuario_nrec      := nm_usuario_p;

            if (index_w = 1000) then
                forall j in v_ctb_planej_orc_valor_w.first .. v_ctb_planej_orc_valor_w.last
                    insert into ctb_planej_orc_valor values v_ctb_planej_orc_valor_w(j);

                index_w := 0;
                v_ctb_planej_orc_valor_w.delete;
                commit;
            end if;
        end if;
    end;
    end loop;
EXIT WHEN NOT FOUND; /* apply on c_planej_orc_material */
end loop;
close c_planej_orc_material;

if (v_ctb_planej_orc_valor_w.count > 0) then
    forall i in v_ctb_planej_orc_valor_w.first .. v_ctb_planej_orc_valor_w.last
        insert into ctb_planej_orc_valor values v_ctb_planej_orc_valor_w(i);

    v_ctb_planej_orc_valor_w.delete;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_planej_valor_mat ( nr_seq_planej_p ctb_orc_cenario.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

