-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_assoc_mat_proc (nr_seq_cpoe_p bigint, nr_atendimento_p bigint, nr_seq_mat_list_p text, ie_tipo_pessoa_p text, ie_prescricao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 type ty_number is table of cpoe_material.nr_sequencia%type index by integer;
 nr_seq_mat_w	          cpoe_material.nr_sequencia%type;
 dt_inicio_ret_w          timestamp;
 nr_prescricao_w          prescr_procedimento.nr_prescricao%type;
 nr_seq_procedimento_w    prescr_procedimento.nr_sequencia%type;
 nr_sequencia_list_w      ty_number;
 nr_seq_cpoe_w            cpoe_material.nr_sequencia%type;
 count_w                  integer := 0;
 start_w                  integer := 1;
 nr_seq_mat_list_w        varchar(32767) := nr_seq_mat_list_p;
 cd_item_w                prescr_procedimento.cd_procedimento%type;
 nr_seq_proc_interno_w    prescr_procedimento.nr_seq_proc_interno%type;

 C01 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_material
	where	nr_seq_procedimento = nr_seq_cpoe_p
	and (coalesce(dt_liberacao::text, '') = '' )
	and coalesce(ie_material,'N') = 'S';

 C02 CURSOR FOR
	SELECT	cd_material,
            ie_via_aplicacao,
            qt_dose,
            cd_unidade_medida,
            cd_intervalo,
            ds_horarios,
            dt_inicio,
            hr_prim_horario, 
            null ds_observacao, 
            ie_urgencia, 
            ie_administracao, 
            'N' ie_checar_adep, 
            nr_sequencia
	from	cpoe_material
	where	nr_seq_procedimento = nr_seq_cpoe_p
	and (coalesce(dt_liberacao::text, '') = '' )
	and coalesce(ie_material,'N') = 'N';

cd_mat_proc_w              cpoe_material.cd_material%type;
ie_via_aplicacao_w         cpoe_material.ie_via_aplicacao%type;
qt_dose_mat_w              cpoe_material.qt_dose%type;
cd_unid_medida_dose_mat_w  cpoe_material.cd_unidade_medida%type;
cd_interv_proc_w           cpoe_material.cd_intervalo%type;
ds_horarios_w              cpoe_material.ds_horarios%type;
dt_inicio_mat_w            cpoe_material.dt_inicio%type;
hr_prim_hor_proc_w         cpoe_material.hr_prim_horario%type;
ds_observacao_w            varchar(255);
ie_urgencia_mat_w          cpoe_material.ie_urgencia%type;
ie_adm_mat_w               cpoe_material.ie_administracao%type;
ie_checar_adep_w           varchar(2);

mat_count_w                integer;


BEGIN
  --nr_seq_mat_list_p ',' seperated list
  IF length(nr_seq_mat_list_w) >0 and substr(nr_seq_mat_list_w,length(nr_seq_mat_list_w)) = ',' Then
    nr_seq_mat_list_w := substr(nr_seq_mat_list_w, length(nr_seq_mat_list_w) - 1);
  end If;
  --get prescricao and sequencia
  --update cpoe material to link to procedure
   EXECUTE 'update cpoe_material 
                      set ie_tipo_assoc = :P,
                      nr_seq_proc_edit = :nr_seq_cpoe_p ,
                      nr_seq_procedimento = :nr_seq_cpoe_p
                      where nr_sequencia in ('||nr_seq_mat_list_w||')
                      and (nvl(nr_seq_procedimento,0) <> :nr_seq_cpoe_p
                      or nvl(nr_seq_proc_edit,0) <> :nr_seq_cpoe_p)
                      returning nr_sequencia into :nr_sequencia_w' using 'P', nr_seq_cpoe_p, nr_seq_cpoe_p, nr_seq_cpoe_p, nr_seq_cpoe_p returning bulk collect into STRICT nr_sequencia_list_w;

  select nr_prescricao, nr_sequencia, cd_procedimento, nr_seq_proc_interno into STRICT nr_prescricao_w, nr_seq_procedimento_w, cd_item_w, nr_seq_proc_interno_w from prescr_procedimento where nr_seq_proc_cpoe = nr_seq_cpoe_p;
  If coalesce(nr_prescricao_w,0) > 0 and coalesce(nr_seq_procedimento_w,0) > 0 Then

    IF  nr_sequencia_list_w.count > 0 Then
      open C01;
      loop
        fetch C01 into nr_seq_mat_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */	

        if (coalesce(nr_seq_mat_w,0) > 0) then
          --call insert material to insert into prescr_mat
          dt_inicio_ret_w := cpoe_insert_materials_reg( nr_atendimento_p, nr_prescricao_w, nr_seq_mat_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, clock_timestamp(), dt_inicio_ret_w, null, null, nr_seq_procedimento_w);
               -- update liberacao to current date
          update  cpoe_material
            set     dt_liberacao = clock_timestamp()
            where   nr_sequencia = nr_seq_mat_w
            and coalesce(dt_liberacao::text, '') = '';

        end if;
      end loop;
      close C01;

      Begin
        select 
          case 
            when coalesce(cd_mat_proc1::text, '') = '' then
             1
            when coalesce(cd_mat_proc2::text, '') = '' then
             2
            when coalesce(cd_mat_proc3::text, '') = '' then
             3
            when coalesce(cd_mat_proc4::text, '') = '' then
             4
            when coalesce(cd_mat_proc5::text, '') = '' then
             5
            when coalesce(cd_mat_proc6::text, '') = '' then
             6
            when coalesce(cd_mat_proc7::text, '') = '' then
             7
            else
             8
          end
          into STRICT mat_count_w from cpoe_procedimento where nr_sequencia = nr_seq_cpoe_p and nr_atendimento = nr_atendimento_p;
      Exception
        When others then
          mat_count_w := 1;
      end;

      open C02;
      loop
        fetch C02 into cd_mat_proc_w,
                       ie_via_aplicacao_w,
                       qt_dose_mat_w,
                       cd_unid_medida_dose_mat_w,
                       cd_interv_proc_w,
                       ds_horarios_w,
                       dt_inicio_mat_w,
                       hr_prim_hor_proc_w,
                       ds_observacao_w,
                       ie_urgencia_mat_w,
                       ie_adm_mat_w,
                       ie_checar_adep_w,
                       nr_seq_mat_w;
        EXIT WHEN NOT FOUND; /* apply on C02 */	
        exit when mat_count_w > 7;
        if coalesce(nr_seq_mat_w,0) > 0 Then
          EXECUTE   ' update	cpoe_procedimento ' ||
                              ' set		cd_mat_proc'||mat_count_w||' = :cd_mat_proc_w, ' ||
                              ' 			ie_via_mat_proc'||mat_count_w||' = :ie_via_mat_proc_w, ' ||
                              ' 			qt_dose_mat'||mat_count_w||' = :qt_dose_mat_w, ' ||
                              ' 			cd_unid_medida_dose_mat'||mat_count_w||' = :cd_unid_medida_dose_mat_w, ' ||
                              ' 			cd_interv_proc'||mat_count_w||' = :cd_interv_proc_w, ' ||
                              ' 			ds_hor_proc'||mat_count_w||' = :ds_hor_proc_w, ' ||
                              ' 			dt_inicio_proc'||mat_count_w||' = :dt_inicio_proc_w, ' ||
                              ' 			hr_prim_hor_proc'||mat_count_w||' = :hr_prim_hor_proc_w, ' ||
                              ' 			ds_obser_proc'||mat_count_w||' = :ds_obser_proc_w, ' ||
                              ' 			ie_urgencia_mat'||mat_count_w||' = :ie_urgencia_mat_w, ' ||
                              ' 			ie_adm_mat'||mat_count_w||' = :ie_adm_mat_w, ' ||
                              ' 			ie_assoc_adep'||mat_count_w||' = :ie_assoc_adep_w ' ||
                              ' where		nr_atendimento = :nr_atendimento_p ' ||
                              ' and		nr_sequencia = :nr_seq_cpoe_p ' using cd_mat_proc_w, ie_via_aplicacao_w, qt_dose_mat_w, cd_unid_medida_dose_mat_w, 
                              cd_interv_proc_w, ds_horarios_w, dt_inicio_mat_w, hr_prim_hor_proc_w, ds_observacao_w, ie_urgencia_mat_w, ie_adm_mat_w, ie_checar_adep_w, nr_atendimento_p, nr_seq_cpoe_p;

         update cpoe_material set ie_material = 'S', ie_duracao = 'P' where nr_sequencia = nr_seq_mat_w;

         dt_inicio_ret_w := cpoe_insert_materials_reg( nr_atendimento_p, nr_prescricao_w, nr_seq_mat_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, clock_timestamp(), dt_inicio_ret_w, null, null, nr_seq_procedimento_w);
               -- update liberacao to current date
         update  cpoe_material
           set     dt_liberacao = clock_timestamp()
           where   nr_sequencia = nr_seq_mat_w
            and coalesce(dt_liberacao::text, '') = '';

          mat_count_w := mat_count_w + 1;
        End If;
        
      end loop;
      close C02;
      --call liberar prescricao to insert into prec_mat_hor  
      ds_erro_p  := Liberar_prescricao(nr_prescricao_w, nr_atendimento_p, ie_tipo_pessoa_p, cd_perfil_p, nm_usuario_p, ie_prescricao_p, ds_erro_p);
      --Call to insert event
      CALL gerar_evento_reaprazamento(nr_atendimento_p => nr_atendimento_p,
                                 nr_prescricao_p => nr_prescricao_w,
                                 nr_seq_item_p => nr_seq_procedimento_w,
                                 nr_seq_horario_p => null,
                                 cd_item_p => cd_item_w,
                                 ie_tipo_item_p => 'P',
                                 ie_alteracao_p => 83,
                                 nr_seq_motivo_p => null,
                                 ds_justificativa_p => null,
                                 nm_usuario_p => nm_usuario_p,
                                 nr_seq_proc_interno_p => nr_seq_proc_interno_w,
                                 ie_acm_sn_p => null);
                                 
      commit;
    End If;
  End If;

Exception
  When others then
    rollback;
    raise;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_assoc_mat_proc (nr_seq_cpoe_p bigint, nr_atendimento_p bigint, nr_seq_mat_list_p text, ie_tipo_pessoa_p text, ie_prescricao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

