-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_subst_farm (cd_material_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_substituir_p INOUT text, ie_alterar_qt_p INOUT text, ie_quantidade_adic_p INOUT text) AS $body$
DECLARE



ie_substituir_w				regra_subst_farm.ie_substituir%type;
ie_alterar_quantidade_w		regra_subst_farm.ie_alterar_quantidade%type;
ie_quantidade_adicional_w	regra_subst_farm.ie_quantidade_adicional%type;
ie_controlado_w				varchar(1);
cd_grupo_w					smallint;
cd_subgrupo_w				smallint;
cd_classe_material_w		integer;


BEGIN

select	max(obter_estrutura_material(a.cd_material,'G')),
		max(obter_estrutura_material(a.cd_material,'S')),
		max(obter_estrutura_material(a.cd_material,'C')),
		max(obter_se_medic_controlado(a.cd_material))
into STRICT	cd_grupo_w,
		cd_subgrupo_w,
		cd_classe_material_w,
		ie_controlado_w
from	material a
where 	a.cd_material = cd_material_p;

select	max(a.ie_substituir),
		max(a.ie_alterar_quantidade),
		max(a.ie_quantidade_adicional)
into STRICT	ie_substituir_w,
		ie_alterar_quantidade_w,
		ie_quantidade_adicional_w
from	regra_subst_farm a
where 	coalesce(ie_situacao,'I') = 'A'
and (coalesce(a.cd_perfil::text, '') = '' or a.cd_perfil = cd_perfil_p)
and (coalesce(a.cd_material::text, '') = '' or a.cd_material = cd_material_p)
and (coalesce(a.cd_grupo_material::text, '') = '' or a.cd_grupo_material = cd_grupo_w)
and (coalesce(a.cd_subgrupo_material::text, '') = '' or a.cd_subgrupo_material = cd_subgrupo_w)
and (coalesce(a.cd_classe_material::text, '') = '' or a.cd_classe_material = cd_classe_material_w)
and (a.ie_receita = 'A'
		or (a.ie_receita = 'S' and ie_controlado_w = 'S')
		or (a.ie_receita = 'N' and ie_controlado_w = 'N'));

ie_substituir_p 		:=	coalesce(ie_substituir_w,'S');
ie_alterar_qt_p 		:=	coalesce(ie_alterar_quantidade_w,'S');
ie_quantidade_adic_p	:=	coalesce(ie_quantidade_adicional_w,'S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_subst_farm (cd_material_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_substituir_p INOUT text, ie_alterar_qt_p INOUT text, ie_quantidade_adic_p INOUT text) FROM PUBLIC;

