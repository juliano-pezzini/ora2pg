-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_alerta_prescr_mat ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_mensagem_p INOUT text) AS $body$
DECLARE


cd_material_w		bigint;
cd_unidade_medida_w	varchar(30);
cd_Setor_atendimento_w integer;
qt_idade_w			bigint;
ie_via_aplicacao_w	varchar(30);
ds_mensagem_w		varchar(2000);
cd_convenio_w		integer;



C01 CURSOR FOR
	SELECT	ds_mensagem
	from	regra_alerta_material
	where	1 = 1
	and		((coalesce(nr_seq_estrutura::text, '') = '')	or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_w)	= 'S'))
	and		qt_idade_w between coalesce(qt_idade_min, 0) and coalesce(qt_idade_max, 999)
	and		coalesce(ie_via_aplicacao,ie_via_aplicacao_w) = ie_via_aplicacao_w
	and		coalesce(cd_unidade_medida,cd_unidade_medida_w) = cd_unidade_medida_w
	and		coalesce(cd_convenio, cd_convenio_w) = cd_convenio_w
	and		coalesce(cd_Setor_atendimento,cd_Setor_atendimento_w) = cd_Setor_atendimento_w
	and		coalesce(cd_material,cd_material_w) = cd_material_w
	and	((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_perfil_ativo))
	and		coalesce(ie_atend_prescr,'N') = 'N'
	and		ie_situacao	= 'A'
	order by coalesce(qt_idade_min, 0),
		 coalesce(cd_material,0),
		 coalesce(nr_seq_estrutura,0),
		 coalesce(cd_Setor_atendimento,0),
		 coalesce(ie_via_aplicacao,'0'),
		 coalesce(cd_unidade_medida,'0');



BEGIN
--if	(nr_prescricao_p is not null) and
--	(nr_sequencia_p is not null) then
	begin

	select	a.cd_material,
			coalesce(a.ie_via_aplicacao,'0'),
			coalesce(a.cd_unidade_medida_dose,'0'),
			coalesce(b.cd_setor_atendimento,0),
			coalesce(obter_idade_pf(b.cd_pessoa_fisica,clock_timestamp(),'A'),0),
			coalesce(obter_convenio_atendimento(b.nr_atendimento),0)
	into STRICT	cd_material_w,
			ie_via_aplicacao_w,
			cd_unidade_medida_w,
			cd_Setor_atendimento_w,
			qt_idade_w,
			cd_convenio_w
	from	prescr_material a,
			prescr_medica b
	where	a.nr_prescricao		= b.nr_prescricao
	and		a.nr_sequencia		= nr_sequencia_p
	and		a.nr_prescricao		= nr_prescricao_p
	and		b.nr_prescricao		= nr_prescricao_p;


	open C01;
	loop
	fetch C01 into
		ds_mensagem_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;

	exception
		when others then
		null;
		end;
--end if;
ds_mensagem_p	:= substr(ds_mensagem_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_alerta_prescr_mat ( nr_prescricao_p bigint, nr_sequencia_p bigint, ds_mensagem_p INOUT text) FROM PUBLIC;

