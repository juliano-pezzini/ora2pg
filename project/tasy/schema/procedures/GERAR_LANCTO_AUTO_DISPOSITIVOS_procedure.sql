-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lancto_auto_dispositivos ( nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_atendimento_w			bigint;
nr_seq_proc_interno_w		bigint;
ie_lancar_proc_disp_w		varchar(1);
nr_sequencia_w			bigint;

C01 CURSOR FOR 
	SELECT 	a.nr_sequencia, 
		b.nr_atendimento, 
		a.nr_seq_proc_interno 
	from  	atend_pac_disp_proc a, 
		atend_pac_dispositivo b 
	where 	a.nr_seq_disp_pac = b.nr_sequencia 
	and	coalesce(a.dt_lancamento_automatico::text, '') = '' 
	and  	b.nr_cirurgia = nr_cirurgia_p;	

BEGIN	 
 
select	coalesce(max(ie_lancar_proc_disp),'N') 
into STRICT									 
	ie_lancar_proc_disp_w 
from	parametros_pepo 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (ie_lancar_proc_disp_w = 'S') then 
	open C01;
	loop 
		fetch C01 into 
			nr_sequencia_w, 
			nr_atendimento_w, 
			nr_seq_proc_interno_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */										
		begin 
		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then 
			SELECT * FROM Obter_Proc_Tab_Interno(nr_seq_proc_interno_w, null, nr_atendimento_w, null, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
		 
			CALL gerar_lancto_automatico_conta(	nr_atendimento_w, 
							nr_cirurgia_p, 
							null, 
							null, 
							null, 
							nr_seq_proc_interno_w, 
							cd_procedimento_w, 
							ie_origem_proced_w, 
							1, 
							nm_usuario_p, 
							null, 
							null, 
							null);
			update	atend_pac_disp_proc 
			set 	dt_lancamento_automatico = clock_timestamp() 
			where	nr_sequencia = nr_sequencia_w;
		end if;
		end;
	end loop;
	close C01;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lancto_auto_dispositivos ( nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

