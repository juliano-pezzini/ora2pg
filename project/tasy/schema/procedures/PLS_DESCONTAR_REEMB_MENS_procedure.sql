-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_descontar_reemb_mens ( nr_titulo_p titulo_receber.nr_titulo%type, nr_protocolo_reembolso_p pls_protocolo_conta.nr_sequencia%type, ie_atualizacao_final_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

 
					 
vl_reembolso_w			pls_conta.vl_total%type;	
cd_moeda_padrao_w		parametros_contas_pagar.cd_moeda_padrao%type;
vl_titulos_w			titulo_pagar.vl_titulo%type;
vl_baixas_realizadas_w		titulo_receber_liq.vl_recebido%type;
vl_baixa_w			titulo_receber_liq.vl_recebido%type;		
nr_seq_baixa_w			titulo_receber_liq.nr_sequencia%type;
vl_saldo_titulo_w		titulo_receber.vl_saldo_titulo%type;
cd_tipo_recebimento_w		pls_regra_baixa_tit_reemb.cd_tipo_recebimento%type;
nr_seq_trans_fin_baixa_w	pls_regra_baixa_tit_reemb.nr_seq_trans_fin_baixa%type;
					

BEGIN 
 
	select	max(cd_tipo_recebimento), 
		max(nr_seq_trans_fin_baixa) 
	into STRICT	cd_tipo_recebimento_w, 
		nr_seq_trans_fin_baixa_w 
	from	pls_regra_baixa_tit_reemb 
	where	cd_estabelecimento	= cd_estabelecimento_p;
	 
	if (coalesce(cd_tipo_recebimento_w::text, '') = '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(452106);
	end if;
 
	--Faz leitura das baixas já gerados para esse reembolso(A rotina é chamada dentro de um loop). 
	select 	coalesce(sum(vl_recebido),0) 
	into STRICT	vl_baixas_realizadas_w 
	from	titulo_receber_liq 
	where	nr_seq_reembolso = nr_protocolo_reembolso_p;
 
	--Obtém o valor total do reembolso em questão 
	vl_reembolso_w := pls_obter_valor_protocolo(nr_protocolo_reembolso_p,'T');
 
	select	max(cd_moeda_padrao) 
	into STRICT	cd_moeda_padrao_w 
	from	parametros_contas_pagar 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	--Como não há uma sequencia, busca a próxima sequência para tabela 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_seq_baixa_w 
	from	titulo_receber_liq 
	where	nr_titulo	= nr_titulo_p;
 
	--busca valor do título que pode ser descontado 
	select	vl_saldo_titulo 
	into STRICT	vl_saldo_titulo_w 
	from	titulo_receber 
	where	nr_titulo = nr_titulo_p;
 
	--descontará o valor do reembolso que ainda não foi descontado 
	vl_baixa_w := vl_reembolso_w - vl_baixas_realizadas_w;
	 
	--Se o valor que ainda falta baixar do reembolso for maior que o valor do título, então 
	--desconta apenas o valor do título. 
	if (vl_baixa_w > vl_saldo_titulo_w) then 
		vl_baixa_w := vl_saldo_titulo_w;
	end if;
				 
	if (vl_baixa_w > 0) then 
		--Insere informações na titulo_receber_liq para atualização de valores descontados da mensalidades na sequência. 
		insert	into titulo_receber_liq(nr_titulo, 
			nr_sequencia, 
			dt_recebimento, 
			vl_recebido, 
			vl_descontos, 
			vl_juros, 
			vl_multa, 
			vl_rec_maior, 
			vl_glosa, 
			cd_moeda, 
			dt_atualizacao, 
			nm_usuario, 
			cd_tipo_recebimento, 
			ie_acao, 
			nr_lote_contabil, 
			ie_lib_caixa, 
			nr_lote_contab_antecip, 
			nr_lote_contab_pro_rata, 
			nr_seq_reembolso, 
			nr_seq_trans_fin) 
		values (nr_titulo_p, 
			nr_seq_baixa_w, 
			trunc(clock_timestamp(),'dd'), 
			vl_baixa_w, 
			0, 
			0, 
			0, 
			0, 
			0, 
			cd_moeda_padrao_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_tipo_recebimento_w, 
			'I', 
			0,  
			'S', 
			0, 
			0, 
			nr_protocolo_reembolso_p, 
			nr_seq_trans_fin_baixa_w);
			 
		--Atualização do título a receber	 
		CALL atualizar_saldo_tit_rec(nr_titulo_p,nm_usuario_p);
		 
	end if;
	 
commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_descontar_reemb_mens ( nr_titulo_p titulo_receber.nr_titulo%type, nr_protocolo_reembolso_p pls_protocolo_conta.nr_sequencia%type, ie_atualizacao_final_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

