-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_codigo_barras_ficha ( nr_sequencia_p bigint, cd_barras_p text default null) AS $body$
DECLARE


cd_barras_w		lote_ent_sec_ficha.cd_barras%type;
IE_PROCURA_BARRAS_W	varchar(1);	
nm_usuario_w	usuario.nm_usuario%TYPE := wheb_usuario_pck.get_nm_usuario;
	

BEGIN

  CALL gravar_log_lab_pragma(1992, 'nr_sequencia_p:' || nr_sequencia_p || ', cd_barras_p: ' ||
  cd_barras_p, 'tasy', 000, 'inserir_codigo_barras_ficha');

ie_procura_barras_w	:= 'S';

if (coalesce(cd_barras_p,'0') = '0') then
	
	while(ie_procura_barras_w = 'S') loop
		begin
		select	nextval('lote_entrada_barras_seq')
		into STRICT	cd_barras_w
		;

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_procura_barras_w
		from	lote_ent_sec_ficha
		where	cd_barras = cd_barras_w;
		end;
	end loop;	
else
	cd_barras_w	:= cd_barras_p;
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_procura_barras_w
	from	lote_ent_sec_ficha
	where	cd_barras = cd_barras_w;
	
	if (ie_procura_barras_w = 'S') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(216187);
	end if;
end if;

if (ie_procura_barras_w <> 'S') then

	update	lote_ent_sec_ficha
	set	nm_usuario = nm_usuario_w,
      cd_barras = cd_barras_w
	where	nr_sequencia = nr_sequencia_p;
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_codigo_barras_ficha ( nr_sequencia_p bigint, cd_barras_p text default null) FROM PUBLIC;

