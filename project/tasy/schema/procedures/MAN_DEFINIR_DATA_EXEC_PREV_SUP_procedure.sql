-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_definir_data_exec_prev_sup ( nr_seq_ordem_serv_p bigint, dt_previsao_p timestamp, nm_usuario_prev_p text, nm_usuario_p text) AS $body$
DECLARE

				 
nm_usuario_grupo_w		varchar(15);
nr_seq_grupo_w			bigint;
dt_previsao_w			timestamp;
				
C01 CURSOR FOR 
	SELECT	nm_usuario_grupo 
	from	usuario_grupo_sup 
	where	nr_seq_grupo		= nr_seq_grupo_w;

C02 CURSOR FOR 
	SELECT	distinct 
		a.dt_prevista 
	from	man_ordem_ativ_prev a 
	where	a.nr_seq_ordem_serv	= nr_seq_ordem_serv_p 
	and	a.nm_usuario_prev	= nm_usuario_prev_p 
	and	(a.dt_prevista IS NOT NULL AND a.dt_prevista::text <> '') 
	order by 
		a.dt_prevista;


BEGIN 
select	max(nr_seq_grupo) 
into STRICT	nr_seq_grupo_w 
from	usuario_grupo_sup 
where	nm_usuario_grupo	= nm_usuario_prev_p;
 
if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then 
	update	man_ordem_ativ_prev 
	set	dt_prevista		= dt_previsao_p, 
		nm_usuario		= nm_usuario_p, 
		dt_atualizacao		= clock_timestamp() 
	where	nr_seq_ordem_serv	= nr_seq_ordem_serv_p 
	and	nm_usuario_prev		= nm_usuario_prev_p 
	and	coalesce(dt_prevista::text, '') = '';
 
	open C02;
	loop 
	fetch C02 into	 
		dt_previsao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		open C01;
		loop 
		fetch C01 into	 
			nm_usuario_grupo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			CALL man_gerar_previsao_dia(dt_previsao_w, nm_usuario_grupo_w);
			end;
		end loop;
		close C01;
		end;
	end loop;
	close C02;
else 
	open C01;
	loop 
	fetch C01 into	 
		nm_usuario_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL man_gerar_previsao_dia(dt_previsao_p, nm_usuario_grupo_w);
		end;
	end loop;
	close C01;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_definir_data_exec_prev_sup ( nr_seq_ordem_serv_p bigint, dt_previsao_p timestamp, nm_usuario_prev_p text, nm_usuario_p text) FROM PUBLIC;

