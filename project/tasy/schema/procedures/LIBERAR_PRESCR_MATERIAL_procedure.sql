-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescr_material ( nr_prescricao_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_tipo_item_p text) AS $body$
DECLARE

									
ds_erro_w			varchar(2000);
ds_observacao_w		prescr_material.ds_observacao_enf%type;
nr_sequencia_w		prescr_material.nr_sequencia%type;
ie_tipo_item_w		char(1);
ie_liberacao_w		char(1);

c01 CURSOR FOR
SELECT	'',
		nr_sequencia
from	prescr_material
where	nr_prescricao			= nr_prescricao_p
and		nr_sequencia_diluicao	= nr_seq_item_p
and		coalesce(dt_lib_material::text, '') = ''

union all

SELECT	'',
		nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_seq_kit		= nr_seq_item_p
and		coalesce(dt_lib_material::text, '') = ''

union all

select	'M',
		nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	= nr_seq_item_p
and		ie_agrupador 	<> 4
and		coalesce(dt_lib_material::text, '') = ''

union all

select	'S',
		nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	= nr_seq_item_p
and		ie_agrupador 	= 4
and		coalesce(dt_lib_material::text, '') = '';


BEGIN

select	max(ds_observacao_enf)
into STRICT	ds_observacao_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia	= nr_seq_item_p;

if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
	ds_observacao_w	:= ds_observacao_w||chr(13);
end if;

-- Medicamento liberado individualmente pela enfermagem.
ds_observacao_w	:=	ds_observacao_w || wheb_mensagem_pck.get_texto(290547);

if (coalesce(ie_tipo_item_p::text, '') = '') then
	ie_liberacao_w	:= 'S';
else
	ie_liberacao_w	:= 'N';
end if;

open C01;
loop
fetch C01 into
	ie_tipo_item_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	CALL define_local_disp_prescr(nr_prescricao_p, nr_seq_item_p, cd_perfil_p, nm_usuario_p);
	ds_erro_w := Liberar_item_Prescricao(nr_prescricao_p, nr_seq_item_p, nr_atendimento_p, 'N', cd_perfil_p, nm_usuario_p, 'N', 'N', 'A', ds_erro_w);
	
	update	prescr_material
	set		dt_lib_material	= clock_timestamp(),
			dt_lib_enfermagem = clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			ds_observacao_enf = ds_observacao_w
	where	nr_prescricao	= nr_prescricao_p
	and		nr_sequencia	= nr_sequencia_w;

	CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p,ie_liberacao_w,nm_usuario_p, null, ie_tipo_item_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescr_material ( nr_prescricao_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_tipo_item_p text) FROM PUBLIC;

