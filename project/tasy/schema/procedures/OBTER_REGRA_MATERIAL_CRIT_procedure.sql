-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_material_crit ( CD_ESTABELECIMENTO_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text, cd_material_P bigint, DT_atendimento_P timestamp, IE_TIPO_ATENDIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, IE_TIPO_SERVICO_SUS_P bigint, IE_TIPO_ATO_SUS_P bigint, CD_MEDICO_EXECUTOR_P text, CD_PESSOA_JURIDICA_P text, CD_CGC_FORNECEDOR_P text, IE_VALOR_AUTORIZADO_p text, CD_REGRA_P INOUT text, IE_ENTRA_CONTA_P INOUT text, IE_CALCULA_VALOR_P INOUT text, CD_CGC_P INOUT text, CD_PESSOA_FISICA_P INOUT text, nr_seq_criterio_p INOUT bigint) AS $body$
DECLARE


cd_edicao_amb_w				integer		:= 0;
cd_grupo_w				bigint		:= 0;
cd_subgrupo_w				bigint		:= 0;
cd_classe_w				bigint		:= 0;
ie_credenciado_w			varchar(1);
ie_funcionario_w			varchar(1);
ie_corpo_clinico_w			varchar(1);
cd_especial_medica_w			integer		:= 0;
cd_regra_w				varchar(5)		:= '';
cd_regra_valida_w			varchar(5)		:= '';
nr_sequencia_w         			smallint		:= 0;
ie_especialidade_w			smallint		:= 0;
ie_entra_conta_w			varchar(1)		:= 'S';
ie_calcula_valor_w			varchar(1)		:= 'S';
cd_cgc_w				varchar(14);
cd_pessoa_fisica_w			varchar(10);
cd_medico_executor_w			varchar(10);
cd_pessoa_juridica_w			varchar(14);
nr_seq_criterio_w			bigint;
nr_seq_criterio_valido_w		bigint;
ie_tipo_convenio_w			smallint;
cd_cgc_fornecedor_w			varchar(14);
nr_seq_familia_w			bigint;

C01 CURSOR FOR
	SELECT 		a.cd_especialidade_medica,
			a.cd_regra,
			b.ie_entra_conta,
			b.ie_calcula_valor,
			b.cd_cgc,
			b.cd_pessoa_fisica,
			a.nr_sequencia
      from 		regra_material_criterio a,
			regra_honorario b
	where		a.cd_regra						= b.cd_regra
	and		b.ie_situacao						= 'A'
        and 		a.cd_estabelecimento      				= cd_estabelecimento_p
	and		coalesce(a.cd_material,cd_material_p) 			= cd_material_p
	and		coalesce(a.CD_GRUPO_MATERIAL,cd_grupo_w)			= cd_grupo_w	
	and		coalesce(a.CD_SUBGRUPO_MATERIAL,CD_SUBGRUPO_w)		= CD_SUBGRUPO_w
	and		coalesce(a.cd_classe_material,cd_classe_w)			= cd_classe_w
	and 		coalesce(a.nr_seq_familia, coalesce(nr_seq_familia_w,0))		= coalesce(nr_seq_familia_w,0)
	--and		nvl(a.cd_edicao_amb,cd_edicao_amb_w)			= cd_edicao_amb_w
	and		coalesce(a.cd_convenio, cd_convenio_p)			= cd_convenio_p
	and		coalesce(a.ie_tipo_convenio, coalesce(ie_tipo_convenio_w, 0))	= coalesce(ie_tipo_convenio_w, 0)
	and		coalesce(a.cd_categoria, coalesce(cd_categoria_p, '0'))		= coalesce(cd_categoria_p, '0')
        and 		coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p)	= ie_tipo_atendimento_p
	and		coalesce(a.cd_setor_atendimento, cd_setor_atendimento_p)	= cd_setor_atendimento_p
	and		coalesce(a.cd_medico, cd_medico_executor_w)			= cd_medico_executor_w
	and		coalesce(a.cd_cgc, cd_pessoa_juridica_w)			= cd_pessoa_juridica_w
	and		((a.ie_credenciado					= 'T') or (a.ie_credenciado 					= ie_credenciado_w))
	and		((a.ie_funcionario					= 'T') or (a.ie_funcionario 					= ie_funcionario_w))
	and		((a.ie_corpo_clinico					= 'T') or (a.ie_corpo_clinico					= ie_corpo_clinico_w))
	and		((coalesce(a.ie_valor_autorizado,'A') = 'A') or (a.ie_valor_autorizado = coalesce(ie_valor_autorizado_p,'N')))
	and		coalesce(a.ie_tipo_servico_sus, coalesce(ie_tipo_servico_sus_p,0))= coalesce(ie_tipo_servico_sus_p,0)
	and		coalesce(a.ie_tipo_ato_sus, coalesce(ie_tipo_ato_sus_p,0))	= coalesce(ie_tipo_ato_sus_p,0)
	and		coalesce(a.cd_cgc_fornecedor, cd_cgc_fornecedor_w)		= cd_cgc_fornecedor_w
	and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(DT_atendimento_P) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_inicio_vigencia, DT_atendimento_P)) and
					ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(dt_final_vigencia,DT_atendimento_P))
	order by	coalesce(a.cd_medico,0),
			coalesce(a.cd_cgc, 0),
			coalesce(a.cd_setor_atendimento,0),
			coalesce(a.cd_material,0),
			coalesce(a.nr_seq_familia,0),
			coalesce(a.cd_classe_material,0),
			coalesce(a.cd_subgrupo_material,0),
			coalesce(a.cd_grupo_material,0),
			coalesce(a.cd_convenio,0),
			coalesce(a.ie_tipo_atendimento,0),
			a.ie_credenciado desc,
			coalesce(a.cd_especialidade_medica,0),
			coalesce(a.cd_edicao_amb,0),
			coalesce(a.ie_tipo_servico_sus, 0),
			coalesce(a.ie_tipo_ato_sus, 0),
			coalesce(a.cd_cgc_fornecedor,'0'),
			coalesce(a.ie_valor_autorizado,'A');

BEGIN

cd_regra_valida_w	:= '';
cd_medico_executor_w	:= coalesce(cd_medico_executor_p,'0');
cd_pessoa_juridica_w	:= coalesce(cd_pessoa_juridica_p,'0');
cd_cgc_fornecedor_w	:= coalesce(cd_cgc_fornecedor_p,'0');

select	max(ie_tipo_convenio)
into STRICT	ie_tipo_convenio_w
from	convenio
where	cd_convenio	= cd_convenio_p;

/* Obter Estrutura do procedimento */

begin
select 		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		nr_seq_familia
into STRICT		cd_grupo_w,
		cd_subgrupo_w,
		cd_classe_w,
		nr_seq_familia_w
from		Estrutura_material_V
where		cd_material	 	= cd_material_p;
exception
     		when others then
		begin
		cd_grupo_w	:= 0;
		cd_subgrupo_w	:= 0;
		cd_classe_w	:= 0;
		nr_seq_familia_w:= 0;
		end;
end;

/*      Obter edicao da AMB  */

begin
select	cd_edicao_amb
into STRICT		cd_edicao_amb_w
from		convenio_amb
where		cd_estabelecimento	= cd_estabelecimento_p
and		cd_convenio			= cd_convenio_p
and		cd_categoria		= cd_categoria_p
and 		coalesce(ie_situacao,'A')	= 'A'
and		dt_inicio_vigencia	=
		(SELECT max(dt_inicio_vigencia)
			from		convenio_amb a
			where		a.cd_estabelecimento	= cd_estabelecimento_p
			and		a.cd_convenio		= cd_convenio_p
			and		a.cd_categoria		= cd_categoria_p
		      and 		coalesce(ie_situacao,'A')	= 'A'
			and		a.dt_inicio_vigencia 	<= dt_atendimento_p);
exception
		when others then
     		cd_edicao_amb_w 	:= 0;
end;

/*      Obter indicador de medico credenciado  */

begin
select		coalesce(ie_conveniado,'N')
into STRICT		ie_credenciado_w
from		medico_convenio
where		cd_pessoa_fisica		= cd_medico_executor_p
and		cd_convenio			= cd_convenio_p;
exception
		when others then
     		ie_credenciado_w 	:= 'N';
end;


/*      Obter indicador de medico do corpo clinico */

select	coalesce(max(ie_corpo_clinico),'N'),
	CASE WHEN coalesce(max(ie_vinculo_medico),'99')='1' THEN 'S'  ELSE 'N' END
into STRICT	ie_corpo_clinico_w,
	ie_funcionario_w
from	Medico
where	cd_pessoa_fisica	= cd_medico_executor_p;

OPEN C01;
LOOP
FETCH C01 into
		cd_especial_medica_w,
		cd_regra_w,
		ie_entra_conta_w,
		ie_calcula_valor_w,
		cd_cgc_w,
		cd_pessoa_fisica_w,
		nr_seq_criterio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	if (coalesce(cd_especial_medica_w::text, '') = '') then
		cd_regra_valida_w		:= cd_regra_w;
		nr_seq_criterio_valido_w	:= nr_seq_criterio_w;	-- Edgar 14/04/2006, os 30827, coloquei tratamento de nr_seq_criterio_valido_w
	else
		begin
		select 	cd_regra_w,
			nr_seq_criterio_w
		into STRICT	cd_regra_valida_w,
			nr_seq_criterio_valido_w
		from	medico_especialidade
		where	cd_pessoa_fisica	= cd_medico_executor_p
		and	cd_especialidade	= cd_especial_medica_w;
		exception
			when others then
    				cd_regra_valida_w		:= cd_regra_valida_w;
				nr_seq_criterio_valido_w	:= nr_seq_criterio_valido_w;
		end;
	end if;
	END;
END LOOP;
CLOSE C01;

cd_regra_p			:= cd_regra_valida_w;
nr_seq_criterio_p		:= nr_seq_criterio_valido_w;

begin
select 	coalesce(ie_entra_conta,'S'),
	coalesce(ie_calcula_valor,'S'),
	cd_cgc,
	cd_pessoa_fisica
into STRICT
	ie_entra_conta_w,
	ie_calcula_valor_w,
	cd_cgc_w,
	cd_pessoa_fisica_w
from	regra_honorario
where	cd_regra		= cd_regra_valida_w;
exception
	when others then
		begin
		ie_entra_conta_w	:= 'S';
		ie_calcula_valor_w	:= 'S';
		end;	
end;	

ie_entra_conta_p		:= ie_entra_conta_w;
ie_calcula_valor_p		:= ie_calcula_valor_w;
cd_cgc_p			:= cd_cgc_w;
cd_pessoa_fisica_p		:= cd_pessoa_fisica_w;
--nr_seq_criterio_p		:= nr_seq_criterio_w;	-- Edgar 14/04/2006, os 30827, tirie pois coloquei tratamento de nr_seq_criterio_valido_w
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_material_crit ( CD_ESTABELECIMENTO_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text, cd_material_P bigint, DT_atendimento_P timestamp, IE_TIPO_ATENDIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, IE_TIPO_SERVICO_SUS_P bigint, IE_TIPO_ATO_SUS_P bigint, CD_MEDICO_EXECUTOR_P text, CD_PESSOA_JURIDICA_P text, CD_CGC_FORNECEDOR_P text, IE_VALOR_AUTORIZADO_p text, CD_REGRA_P INOUT text, IE_ENTRA_CONTA_P INOUT text, IE_CALCULA_VALOR_P INOUT text, CD_CGC_P INOUT text, CD_PESSOA_FISICA_P INOUT text, nr_seq_criterio_p INOUT bigint) FROM PUBLIC;

