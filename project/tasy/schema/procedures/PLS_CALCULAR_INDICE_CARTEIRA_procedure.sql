-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_calcular_indice_carteira ( nr_seq_simul_param_item_p bigint) AS $body$
DECLARE


qt_ponto_medio_faixa_w		bigint := 0;
qt_ponto_medio_w		double precision := 0;
qt_ponto_medio_total_w		double precision := 0;
qt_idade_limite_final_w		bigint;
qt_idade_inicial_w		bigint;
qt_idade_final_w		bigint;
qt_faixas_etarias_w		bigint := 0;
qt_beneficiario_w		bigint;
qt_beneficiarios_total_w	bigint := 0;
qt_vidas_multiplicada_w		bigint := 0;
qt_vidas_tot_multiplicada_w	bigint := 0;
qt_beneficiarios_limite_w	bigint;
qt_media_vidas_w		double precision;
vl_variacao_w			double precision := 0;
tx_indice_w			double precision := 1;
nr_seq_simul_perfil_w		bigint;

C01 CURSOR FOR
	SELECT	qt_idade_inicial,
		qt_idade_final,
		coalesce(qt_beneficiario,0)
	from	pls_simulpreco_coletivo
	where	nr_seq_simul_perfil	= nr_seq_simul_perfil_w
	and	qt_idade_final		<> qt_idade_limite_final_w;



BEGIN

select	max(nr_seq_regra_perfil)
into STRICT	nr_seq_simul_perfil_w
from	pls_simul_param_item
where	nr_sequencia	= nr_seq_simul_param_item_p;

select	max(qt_idade_final)
into STRICT	qt_idade_limite_final_w
from	pls_simulpreco_coletivo
where	nr_seq_simul_perfil	= nr_seq_simul_perfil_w;

select	max(qt_beneficiario)
into STRICT	qt_beneficiarios_limite_w
from	pls_simulpreco_coletivo
where	nr_seq_simul_perfil	= nr_seq_simul_perfil_w
and	qt_idade_final		= qt_idade_limite_final_w;

if (coalesce(qt_beneficiarios_limite_w::text, '') = '') then
	qt_beneficiarios_limite_w := 0;
end if;

/*Buscar o ponto médio das faixas etárias, menos a última*/

open C01;
loop
fetch C01 into
	qt_idade_inicial_w,
	qt_idade_final_w,
	qt_beneficiario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	qt_faixas_etarias_w		:= qt_faixas_etarias_w + 1;
	qt_ponto_medio_faixa_w		:= dividir((qt_idade_inicial_w + qt_idade_final_w),2);

	if (coalesce(qt_ponto_medio_faixa_w::text, '') = '') then
		qt_ponto_medio_faixa_w	:= 0;
	end if;

	qt_vidas_multiplicada_w 	:= qt_beneficiario_w * qt_ponto_medio_faixa_w;

	qt_ponto_medio_total_w		:= qt_ponto_medio_total_w + qt_ponto_medio_faixa_w;
	qt_vidas_tot_multiplicada_w	:= qt_vidas_tot_multiplicada_w + qt_vidas_multiplicada_w;
	qt_beneficiarios_total_w	:= qt_beneficiarios_total_w + qt_beneficiario_w;

	end;
end loop;
close C01;

/*Inicio - Considerar a expectativa de vida média dos brasileiros 72 anos*/

qt_ponto_medio_total_w		:= qt_ponto_medio_total_w + 72;
/*Fim - Considerar a expectativa de vida média dos brasileiros 72 anos*/

/*Soma a quantidade de faixas etárias mais 1*/

qt_faixas_etarias_w		:= qt_faixas_etarias_w +1;

/*Calcular a media do ponto medio*/

qt_ponto_medio_w		:= qt_ponto_medio_total_w/qt_faixas_etarias_w;

qt_vidas_tot_multiplicada_w	:= qt_vidas_tot_multiplicada_w + (72 *qt_beneficiarios_limite_w);

/*Somar a quantidade de beneficiários mais as do limite*/

qt_beneficiarios_total_w	:= qt_beneficiarios_total_w + qt_beneficiarios_limite_w;

/*Calcular a média total de vidas*/

if ( qt_beneficiarios_total_w = 0) then
	qt_beneficiarios_total_w := 1;
end if;

qt_media_vidas_w		:= qt_vidas_tot_multiplicada_w / qt_beneficiarios_total_w;

/*Calcular a variação*/

vl_variacao_w			:= qt_media_vidas_w - qt_ponto_medio_w;

vl_variacao_w			:= dividir(vl_variacao_w,qt_ponto_medio_w);

/*Terminar o calculo da variação*/

vl_variacao_w			:= vl_variacao_w *100;

if (vl_variacao_w	< 0) then
	tx_indice_w	:= 0.95;
elsif (vl_variacao_w	<= 20) and (vl_variacao_w	> 00) then
	tx_indice_w	:= 1.00;
elsif (vl_variacao_w	> 20) then
	tx_indice_w	:= 1.10;
end if;

update	pls_simul_param_item
set	tx_indice	= tx_indice_w
where	nr_sequencia	= nr_seq_simul_param_item_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_calcular_indice_carteira ( nr_seq_simul_param_item_p bigint) FROM PUBLIC;

