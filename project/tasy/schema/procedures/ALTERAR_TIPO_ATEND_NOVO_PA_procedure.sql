-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_tipo_atend_novo_pa ( nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
      
ora2pg_rowcount int;
nr_atendimento_novo_w    bigint;
ConstInternacao       constant integer := 1;
cd_classificacao_setor_w  varchar(2);

BEGIN
 
select 	coalesce(max(nr_atendimento),0) 
into STRICT	nr_atendimento_novo_w 
from 	atendimento_paciente 
where 	nr_atend_alta = nr_atendimento_p;
 
if (nr_atendimento_novo_w > 0) then 
 
  update atendimento_paciente 
  set   ie_tipo_atendimento =  ie_tipo_atendimento_p 
  where  nr_Atendimento   =  nr_atendimento_novo_w 
  and   ie_tipo_atendimento <> ie_tipo_atendimento_p;
   
  GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;

   
  if (ie_tipo_atendimento_p = ConstInternacao) and ( ora2pg_rowcount > 0)then 
     
    cd_classificacao_setor_w := Obter_classif_setor_atend(nr_atendimento_novo_w);
    if (cd_classificacao_setor_w in ('3','4')) then 
      CALL gqa_gerar_protocolo_assist(nr_atendimento_novo_w,1,nm_usuario_p);
    end if;
    CALL gerar_autor_regra(nr_atendimento_novo_w,null,null,null,null,null,'AT',nm_usuario_p,null,null,null,null,null,null,'','','');
  end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_tipo_atend_novo_pa ( nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

