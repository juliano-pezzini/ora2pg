-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gravar_log_lote ( nr_lote_contabil_p bigint, cd_log_lote_p bigint, ds_log_p text, nm_usuario_p text, nr_documento_p text default null, nm_tabela_p text default null, nm_atributo_p text default null, nr_seq_trans_fin_p bigint default null, vl_movimento_p bigint default null, dt_contabil_p timestamp default null, ie_consiste_geracao_p text default 'N') AS $body$
DECLARE


/*	Dominio 3106
1	Geração do lote
2	Desfazer lote
3	Integração na Contabilidade
4	Consistência
5	Atualização do saldo
6	Desatualização do saldo
7	Exclusão de lote integrado
8	Exclusão de movimentos do lote
9	Falta de regra para a transação financeira
10	Falta de cadastro de conta contábil
*/
ds_operacao_w			varchar(100);
ds_log_w				varchar(4000);
nr_sequencia_w			bigint;
vl_debito_w			double precision;
vl_credito_w			double precision;
nr_documento_w			LOTE_CONTABIL_LOG.NR_DOCUMENTO%Type;
nm_tabela_w			LOTE_CONTABIL_LOG.NM_TABELA%Type;
nm_atributo_w			LOTE_CONTABIL_LOG.NM_ATRIBUTO%Type;
vl_movimento_w			LOTE_CONTABIL_LOG.VL_MOVIMENTO%Type;
nr_seq_trans_fin_w		LOTE_CONTABIL_LOG.NR_SEQ_TRANS_FIN%Type;


BEGIN

ds_operacao_w	:= substr(obter_valor_dominio(3106, cd_log_lote_p),1,100);

if (coalesce(ds_log_p,'X') = 'X') then
	ds_log_w		:= ds_operacao_w;
else
	ds_log_w		:= substr(ds_operacao_w || ' - ' || ds_log_p,1,4000);
end if;

if (cd_log_lote_p = 1) then

	select	coalesce(vl_debito,0),
		coalesce(vl_credito,0)
	into STRICT	vl_debito_w,
		vl_credito_w
	from	lote_contabil
	where	nr_lote_contabil	= nr_lote_contabil_p;

	ds_log_w		:= substr(ds_operacao_w || ' ' || wheb_mensagem_pck.get_texto(799259) || ' ' || campo_mascara_virgula(vl_debito_w) || ' ' || wheb_mensagem_pck.get_texto(799260) || ' ' || campo_mascara_virgula(vl_credito_w),1,2000);
end if;

select	nextval('lote_contabil_log_seq')
into STRICT	nr_sequencia_w
;

nr_documento_w		:= substr(nr_documento_p,1,20);
nm_tabela_w		:= nm_tabela_p;
nm_atributo_w		:= nm_atributo_p;
vl_movimento_w		:= vl_movimento_p;
nr_seq_trans_fin_w	:= nr_seq_trans_fin_p;

insert into lote_contabil_log(
	nr_sequencia,
	nm_usuario,
	dt_atualizacao,
	nr_lote_contabil,
	cd_log_lote,
	ds_log,
	nr_documento,
	nm_tabela,
	nm_atributo,
	vl_movimento,
	nr_seq_trans_fin,
	dt_contabil)
values (	nr_sequencia_w,
	nm_usuario_p,
	clock_timestamp(),
	nr_lote_contabil_p,
	cd_log_lote_p,
	ds_log_w,
	nr_documento_w,
	nm_tabela_w,
	nm_atributo_w,
	vl_movimento_w,
	nr_seq_trans_fin_w,
	dt_contabil_p);

if (ie_consiste_geracao_p = 'S') then
	CALL ctb_consistir_lote_geracao(nr_lote_contabil_p,nm_usuario_p);
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gravar_log_lote ( nr_lote_contabil_p bigint, cd_log_lote_p bigint, ds_log_p text, nm_usuario_p text, nr_documento_p text default null, nm_tabela_p text default null, nm_atributo_p text default null, nr_seq_trans_fin_p bigint default null, vl_movimento_p bigint default null, dt_contabil_p timestamp default null, ie_consiste_geracao_p text default 'N') FROM PUBLIC;

