-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mp_gerar_relat_processo ( nr_seq_processo_p bigint, nm_usuario_p text, ie_seq_unica_p text) AS $body$
DECLARE


nr_seq_proc_objeto_w		bigint;
nr_seq_proximo_objeto_w		bigint;
nr_sequencia_w			bigint;
nr_seq_apres_w			bigint;
ds_unid_org_w			varchar(255);
nm_objeto_w			varchar(255);
ie_tipo_grupo_w			varchar(1);
cd_classif_w			varchar(40);
ds_objeto_w			text;

/* Atividades iniciais */

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	replace(replace(a.nm_objeto,chr(10),''),chr(13),''),
	mp_obter_tipo_grupo_obj(a.nr_sequencia)
from	mp_processo_objeto a
where	a.nr_seq_processo	= nr_seq_processo_p
and	coalesce(a.nr_seq_obj_origem::text, '') = '' /*  Desconsiderar fluxo */
and	coalesce(a.nr_seq_obj_destino::text, '') = '' /*  Desconsiderar fluxo */
and	not exists (select	1
			from	mp_processo_objeto x
			where	x.nr_seq_processo	= a.nr_seq_processo
			and	x.nr_seq_obj_destino	= a.nr_sequencia);


BEGIN

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') then
	delete	from	w_relat_mp_processo
	where	nm_usuario	= nm_usuario_p;

	open c01;
	loop
	fetch c01 into
		nr_seq_proc_objeto_w,
		nm_objeto_w,
		ie_tipo_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_tipo_grupo_w = 'C') then
			nm_objeto_w	:= replace(replace(mp_obter_proc_ativ_conexao(nr_seq_proc_objeto_w),chr(13),''),chr(10),'');
		end if;

		select	nextval('w_relat_mp_processo_seq')
		into STRICT	nr_sequencia_w
		;

		/*if	(ie_seq_unica_p = 'S') then
			select	nvl(max(a.nr_seq_apres),0) + 1
			into	nr_seq_apres_w
			from	w_relat_mp_processo a
			where	nm_usuario	= nm_usuario_p;
		else*/
			select	coalesce(max(a.nr_seq_apres),0) + 1
			into STRICT	nr_seq_apres_w
			from	w_relat_mp_processo a
			where	nm_usuario	= nm_usuario_p
			and	coalesce(a.nr_seq_superior::text, '') = ''
			/*and	exists	(select	1
					from	mp_proc_obj_es y,
						mp_processo_objeto x
					where	y.nr_seq_proc_obj	=  x.nr_sequencia
					and	x.nr_seq_processo	= nr_seq_processo_p
					and	x.nr_sequencia		= a.nr_seq_proc_objeto)*/
;
		/*end if;*/

		cd_classif_w	:= nr_seq_apres_w;

		select	max(b.ds_unid_org)
		into STRICT	ds_unid_org_w
		from	mp_unid_org b,
			mp_proc_obj_unid_org a
		where	a.nr_seq_unid_org	= b.nr_sequencia
		and	a.nr_seq_proc_obj	= nr_seq_proc_objeto_w;

		select	a.ds_objeto
		into STRICT	ds_objeto_w
		from	mp_processo_objeto a
		where	a.nr_sequencia	= nr_seq_proc_objeto_w;

		insert into w_relat_mp_processo(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_processo,
			nr_seq_proc_objeto,
			nm_objeto,
			ds_unid_org,
			nr_seq_superior,
			nr_seq_apres,
			ie_tipo,
			cd_classif)
		values (nr_sequencia_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_processo_p,
			nr_seq_proc_objeto_w,
			nm_objeto_w,
			ds_unid_org_w,
			null,
			nr_seq_apres_w,
			ie_tipo_grupo_w,
			cd_classif_w);

		update	w_relat_mp_processo
		set	ds_objeto	= ds_objeto_w
		where	nr_sequencia	= nr_sequencia_w;

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_proximo_objeto_w
		from	mp_processo_objeto a
		where	a.nr_seq_obj_origem	= nr_seq_proc_objeto_w;

		CALL mp_gerar_relat_processo_item(nr_seq_proximo_objeto_w,nr_sequencia_w,nm_usuario_p,ie_seq_unica_p);
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mp_gerar_relat_processo ( nr_seq_processo_p bigint, nm_usuario_p text, ie_seq_unica_p text) FROM PUBLIC;

