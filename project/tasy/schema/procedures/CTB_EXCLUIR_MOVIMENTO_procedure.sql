-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_excluir_movimento ( ds_movto_excluir_p text ) AS $body$
DECLARE


integrity_constraint_violation exception;

ds_erro_w varchar(4000);

  i RECORD;

BEGIN
				
	FOR i IN (SELECT A.*
                  FROM CTB_MOVIMENTO A
                  WHERE A.NR_SEQUENCIA IN (select nr_seq_ctb_movto
              from (WITH RECURSIVE cte AS (

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, 1) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb

                           ) x(regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '')  UNION ALL

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, (c.level+1)) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb
                              
                           ) x
                    (regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
)))
	LOOP
		CALL gravar_log_exclusao('CTB_MOVIMENTO', obter_usuario_ativo, 'NR_SEQUENCIA=' || i.nr_sequencia || ', '
			|| 'NR_LOTE_CONTABIL=' || i.nr_lote_contabil || ', ' || 'NR_SEQ_MES_REF=' || i.nr_seq_mes_ref || ', '
			|| 'VL_MOVIMENTO=' || i.vl_movimento || ', ' || 'CD_CONTA_DEBITO=' || i.cd_conta_debito || ', ' 
			|| 'CD_CONTA_CREDITO=' || i.cd_conta_credito || ', ' || 'IE_ELIMINACAO_LANCTO=' || coalesce(i.ie_eliminacao_lancto, 'N'), 'N');
	
	END LOOP;

    update ctb_movimento a
       set a.nr_seq_movto_corresp  = NULL
         , a.nr_seq_movto_partida  = NULL
     where a.nr_sequencia in (
            SELECT nr_seq_ctb_movto
              from (WITH RECURSIVE cte AS (

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, 1) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb

                           ) x(regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '')  UNION ALL

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, (c.level+1)) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb
                              
                           ) x
                    (regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
)
                   );

    delete from ctb_movimento a
     where a.nr_sequencia in (
            SELECT nr_seq_ctb_movto
              from (WITH RECURSIVE cte AS (

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, 1) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb

                           ) x(regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '')  UNION ALL

                    SELECT regexp_substr(nr_ctb,'[^,]+', 1, (c.level+1)) nr_seq_ctb_movto
                      from (
                            select ds_movto_excluir_p nr_ctb
                              
                           ) x
                    (regexp_substr(nr_ctb,'[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_ctb,'[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
)
                   );

    commit;

exception when integrity_constraint_violation then
    ds_erro_w := substr(sqlerrm(SQLSTATE),1,4000);
    rollback;
    /*Nao foi possivel excluir os movimentos por existirem dependencias
    Verifique se foram selecionadas todas as partidas e contrapartidas relacionadas
    Detalhes DSERRO*/
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1077102,'DS_ERRO=' || ds_erro_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_excluir_movimento ( ds_movto_excluir_p text ) FROM PUBLIC;

