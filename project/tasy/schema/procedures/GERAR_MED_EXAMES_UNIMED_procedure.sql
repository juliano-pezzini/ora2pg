-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_med_exames_unimed ( nr_seq_cliente_p bigint, nr_seq_protocolo_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint ) AS $body$
DECLARE




nr_sequencia_w		bigint;
nr_seq_protocolo_w	bigint;
nr_seq_exame_w		bigint;
nr_seq_apresent_w		bigint;
ds_dados_clinicos_w	varchar(255);
ds_exame_anterior_w	varchar(255);
ds_justificativa_w 	varchar(255);

C01 CURSOR FOR
	SELECT	nr_seq_protocolo,
		nr_seq_exame,
		nr_seq_apresent
	from	med_exame_protocolo
	where	nr_seq_protocolo  = nr_seq_protocolo_p
	and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');

BEGIN

select 	ds_dados_clinicos,
	ds_exame_anterior,
	ds_justificativa
into STRICT
	ds_dados_clinicos_w,
	ds_exame_anterior_w,
	ds_justificativa_w
from	med_protocolo_exame
where	nr_sequencia 	=	nr_seq_protocolo_p;

select 	nextval('med_pedido_exame_seq')
into STRICT	nr_sequencia_w
;

insert into med_pedido_exame( nr_sequencia,
			 dt_solicitacao,
			 ds_solicitacao,
			 ds_exame_ant,
			 ds_dados_clinicos,
			 ds_justificativa,
			 ie_ficha_unimed,
			 nr_seq_cliente,
			 dt_atualizacao,
			 nm_usuario )
		values ( nr_sequencia_w,
			 clock_timestamp(),
			 ' ',
			 ds_exame_anterior_w,
			 ds_dados_clinicos_w,
			 ds_justificativa_w,
			 'S',
			 nr_seq_cliente_p,
			 clock_timestamp(),
			 nm_usuario_p );


open C01;
loop
fetch C01 into
	nr_seq_protocolo_w,
	nr_seq_exame_w,
	nr_seq_apresent_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		insert into med_ped_exame_cod(	nr_sequencia,
						nr_seq_pedido,
						nr_seq_exame,
						qt_exame,
						dt_atualizacao,
						nm_usuario )
					values ( nextval('med_ped_exame_cod_seq'),
						currval('med_pedido_exame_seq'),
						nr_seq_exame_w,
						1,
						clock_timestamp(),
						nm_usuario_p
					       );
	end;
end loop;
close C01;

commit;

nr_sequencia_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_med_exames_unimed ( nr_seq_cliente_p bigint, nr_seq_protocolo_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint ) FROM PUBLIC;

