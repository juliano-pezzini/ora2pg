-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_fechar_franq_pag ( nr_seq_franq_pag_p pls_franq_pag.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


qt_prestadores_w	integer := 0;
ie_funcao_pagamento_w	pls_parametro_pagamento.ie_funcao_pagamento%type;


BEGIN

select	count(1)
into STRICT	qt_prestadores_w
from	pls_franq_pag_prest a
where	a.nr_seq_franq_pag = nr_seq_franq_pag_p;

select	coalesce(max(ie_funcao_pagamento), '1')
into STRICT	ie_funcao_pagamento_w
from	pls_parametro_pagamento
where	cd_estabelecimento = cd_estabelecimento_p;

if (qt_prestadores_w > 0) then

	-- sรณ gera a evento movimento se for pagamento atual
	if (ie_funcao_pagamento_w = '1') then
		CALL pls_gerar_lote_evento_franq(nr_seq_franq_pag_p, nm_usuario_p);
	end if;

	update 	pls_franq_pag
	set 	dt_fechamento_lote = clock_timestamp()
	where	nr_sequencia = nr_seq_franq_pag_p;

	commit;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(311844);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fechar_franq_pag ( nr_seq_franq_pag_p pls_franq_pag.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

