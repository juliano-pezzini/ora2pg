-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eclipse_getreceipt_details ( dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) AS $body$
DECLARE

cd_dvar_Status_w	varchar(15);

cDVAClaims CURSOR FOR
  SELECT	a.nr_sequencia,
		a.nr_seq_transaction,
		a.ie_status,
		a.nr_interno_conta
	from	dva_claim a
	where	a.NR_SEQUENCIA in ( SELECT nr_sequencia from (select  max(x.nr_sequencia)as nr_sequencia ,x.nr_interno_conta
                          from dva_claim x
                          where x.dt_atualizacao between dt_inicial_p and  dt_final_p
                          group by x.nr_interno_conta) alias1);

	
cDBSClaims CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_transaction,
		ie_status,
		nr_seq_account
	from	dbs_claim
	where	dt_atualizacao between dt_inicial_p and  dt_final_p;
BEGIN

for rDVAClaims in cDVAClaims loop

 cd_dvar_Status_w := Get_eclipse_claim_status(rDVAClaims.nr_interno_conta, 'REPORT');


	if (upper(cd_dvar_Status_w) = 'COMPLETED') then
  		cd_error_string_p := generate_dvy_request_data(rDVAClaims.nr_interno_conta, cd_estabelecimento_p, nm_usuario_p, cd_error_string_p);
	end if;

end loop;

for rDBSClaims in cDBSClaims loop
	
	cd_dvar_Status_w := Get_eclipse_claim_status(rDBSClaims.nr_seq_account, 'REPORT');
 	if (upper(cd_dvar_Status_w) = 'COMPLETED') then
 		cd_error_string_p := insert_dpy_request(rDBSClaims.nr_seq_account, cd_estabelecimento_p, nm_usuario_p, cd_error_string_p);
	end if;
end loop;

CALL generate_era_request_data(dt_inicial_p, dt_final_p, cd_estabelecimento_p, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eclipse_getreceipt_details ( dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) FROM PUBLIC;

