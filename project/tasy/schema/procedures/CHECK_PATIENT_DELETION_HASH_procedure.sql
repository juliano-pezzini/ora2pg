-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function check_patient_deletion_hash as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE check_patient_deletion_hash ( nm_pessoa_fisica_p text, dt_nascimento_p text, cd_pessoa_mae_p text, nm_usuario_p text) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL check_patient_deletion_hash_atx ( ' || quote_nullable(nm_pessoa_fisica_p) || ',' || quote_nullable(dt_nascimento_p) || ',' || quote_nullable(cd_pessoa_mae_p) || ',' || quote_nullable(nm_usuario_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE check_patient_deletion_hash_atx ( nm_pessoa_fisica_p text, dt_nascimento_p text, cd_pessoa_mae_p text, nm_usuario_p text) AS $body$
DECLARE
ds_nls_territory_w		    varchar(64);
  nm_pessoa_fisica_w        pessoa_fisica.nm_pessoa_fisica%type;
  dt_nascimento_w           pessoa_fisica.dt_nascimento%type;
  cd_pessoa_mae_w           pessoa_fisica.cd_pessoa_mae%type;
  ds_hash_new_w             pessoa_fisica_exc.ds_hash%type;
  ds_hash_exc_w             pessoa_fisica_exc.ds_hash%type;
  nr_seq_hash_exc_w         pessoa_fisica_exc.nr_sequencia%type;
  ds_text_w                 varchar(500);


BEGIN

  begin
    select	substr(value,1,64)
    into STRICT	ds_nls_territory_w
    from	v$nls_parameters
    where	parameter = 'NLS_TERRITORY';
  exception
  when others then
    ds_nls_territory_w := null;
  end;

  if ((coalesce(philips_param_pck.get_cd_pais,1) in (1,9)) or (upper(ds_nls_territory_w) = 'BRAZIL')) then

      ds_hash_new_w := upper(nm_pessoa_fisica_p) || dt_nascimento_p || upper(OBTER_NOME_PESSOA_FISICA( cd_pessoa_mae_p ,''));
      ds_hash_new_w := get_md5_hash_value(ds_hash_new_w);

      begin
        select  nr_sequencia,
                ds_hash
        into STRICT    nr_seq_hash_exc_w,
                ds_hash_exc_w
        from    pessoa_fisica_exc
        where   ds_hash = ds_hash_new_w
        and     ie_situacao = 'A';
      exception
      when others then
        ds_hash_exc_w := 'null';
      end;

      if (ds_hash_new_w = ds_hash_exc_w) then
        ds_text_w := WHEB_MENSAGEM_PCK.GET_TEXTO(1118667,'');
        CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(ds_text_w||' Seq hash: '||nr_seq_hash_exc_w||' Hash: '||ds_hash_exc_w);
      end if;

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE check_patient_deletion_hash ( nm_pessoa_fisica_p text, dt_nascimento_p text, cd_pessoa_mae_p text, nm_usuario_p text) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE check_patient_deletion_hash_atx ( nm_pessoa_fisica_p text, dt_nascimento_p text, cd_pessoa_mae_p text, nm_usuario_p text) FROM PUBLIC;

