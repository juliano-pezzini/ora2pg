-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sac_gerar_envio_comunic_resp ( nr_sequencia_p bigint, ie_evento_p text, nm_usuario_destino_p text, cd_perfil_dest_p text, cd_grupo_destino_p text, nr_seq_evento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
/*campos regra*/
 
nr_seq_bo_w			bigint;
nr_seq_regra_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicacao_w			varchar(32000);
ie_comunicacao_interna_w		varchar(01);
ie_email_w			varchar(01);
nr_seq_equip_os_w			bigint;
nr_seq_equip_regra_w		bigint;
ds_equipamento_w			varchar(80);
qt_existe_w			bigint;
nr_seq_classif_w			bigint;
ie_usuario_w			varchar(15);
cd_perfil_w			integer := obter_perfil_ativo;
cd_perfil_resp_w			integer;
ds_usuario_destino_w		varchar(2000);
ds_lista_email_destino_w		varchar(2000);
ds_email_origem_w			varchar(255);
nr_seq_classif_ci_w			sac_regra_envio_comunic.nr_seq_classif_ci%type;

/*Campos SAC */
 
nm_usuario_resp_w			varchar(15);
ds_status_ant_w			varchar(255);
ds_status_atual_w			varchar(255);
ds_historico_w			varchar(4000);
ds_ocorrencia_w			varchar(4000);
ds_ocorrencia_longa_w		varchar(32000);
nr_seq_responsavel_w		bigint;
nm_pessoa_abertura_w		varchar(60);
ds_setor_referencia_w		varchar(60);
nm_pessoa_referencia_w		varchar(60);
cd_setor_responsavel_w		integer;
cd_setor_atend_ww		integer;
ds_status_bo_w			varchar(60);
nr_seq_resp_w			bigint;
dt_resposta_w			varchar(30);

nm_usuario_envio_w		varchar(15);
cd_convenio_w			integer;
ds_convenio_w			varchar(255);
dt_ocorrencia_w			varchar(30);

dt_encerramento_w			varchar(30);
cdEstab_w				smallint;
nm_usuario_abert_bo_w		varchar(15);
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nm_paciente_atend_w		varchar(255);
nm_pessoa_registro_w		sac_boletim_ocorrencia.nm_pessoa_registro%type;

 
/*Campos CI*/
 
nm_usuario_w			varchar(2000);
ds_perfis_destino_w		varchar(2000);

/*Campos EMAIL*/
 
lista_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w			smallint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);

/*Campos do histórico*/
 
nr_seq_rtf_srtring_w			bigint;
ds_mensagem_historico_w		varchar(32000);

ie_gerar_w			varchar(01) := 'S';
/*Campo para envio de e-mail automático*/
 
c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ds_titulo, 
		ds_comunicado, 
		ie_comunicacao_interna, 
		ie_email, 
		coalesce(nr_seq_classif_ci,0) 
	from	sac_regra_envio_comunic 
	where	ie_evento = ie_evento_p 
	and (coalesce(nr_seq_evento_p,0) = 0 or nr_sequencia = nr_seq_evento_p) 
	and	coalesce(ie_situacao,'A') = 'A';

c02 CURSOR FOR 
	SELECT	ie_usuario, 
		ds_usuario_destino 
	from	sac_usuarios_comunicacao 
	where	nr_seq_regra = nr_seq_regra_w;

-- Usuários responsáveis 
c03 CURSOR FOR 
	SELECT	a.nr_seq_responsavel, 
		b.cd_setor_atendimento, 
		c.cd_estabelecimento 
	from	sac_resp_bol_ocor a, 
		sac_responsavel b, 
		sac_boletim_ocorrencia c 
	where	a.nr_seq_responsavel = b.nr_sequencia 
	and	c.nr_sequencia = a.nr_seq_bo 
	and	a.nr_seq_bo = nr_seq_bo_w;
/* 
PRR       	Perfil do responsável da resposta 
RSR       	Responsável do setor da resposta 
SRR       	Usuários do setor da resposta 
U        		Usuários informados 
URR       	Usuários responsáveis da resposta 
RS		Responsável pelo setor 
*/
c04 CURSOR FOR 
	SELECT	a.nm_usuario_resp 
	from	sac_resp_usuario	a, 
		usuario			b 
	where	b.nm_usuario		= a.nm_usuario_resp 
	and	a.nr_seq_resp		= nr_seq_responsavel_w 
	and	'URR'			= ie_usuario_w 
	and	coalesce(a.ie_email,'S')	= 'S' 
	and	((a.cd_estab_usuario = cdEstab_w) or (coalesce(a.cd_estab_usuario::text, '') = '')) 
	and	coalesce(b.ie_situacao,'A')	= 'A' 
	
union
 
	SELECT	c.nm_usuario 
	from	sac_resp_perfil	a, 
		usuario_perfil	b, 
		usuario		c 
	where 	a.cd_perfil_resp	= b.cd_perfil 
	and 	c.nm_usuario		= b.nm_usuario 
	and   a.nr_seq_resp		= nr_seq_responsavel_w 
	and	'PRR'			= ie_usuario_w 
	and	coalesce(c.ie_situacao,'A')	= 'A' 
	
union
 
	select	a.nm_usuario 
	from	usuario	a 
	where	a.cd_setor_atendimento	= cd_setor_responsavel_w 
	and	'SRR'			= ie_usuario_w 
	and	coalesce(a.ie_situacao,'A')	= 'A';
	
 

BEGIN 
select	count(*) 
into STRICT	qt_existe_w 
from	sac_regra_envio_comunic 
where	ie_evento = ie_evento_p 
and (coalesce(nr_seq_evento_p,0) = 0 or nr_sequencia = nr_seq_evento_p) 
and	coalesce(ie_situacao,'A') = 'A'; -- ok 
if (ie_evento_p in ('6')) then 
	select	nr_seq_bo, 
		nr_seq_responsavel, 
		to_char(dt_resposta, 'dd/mm/yyyy hh24:mi:ss'), 
		to_char(dt_encerramento, 'dd/mm/yyyy hh24:mi:ss') 
	into STRICT	nr_seq_bo_w, 
		nr_seq_resp_w, 
		dt_resposta_w, 
		dt_encerramento_w 
	from	sac_resp_bol_ocor 
	where	nr_sequencia = nr_sequencia_p;
end if;
 
if (qt_existe_w > 0) then 
	begin 
	open C01;
	loop 
	fetch C01 into 
		nr_seq_regra_w, 
		ds_titulo_w, 
		ds_comunicacao_w, 
		ie_comunicacao_interna_w, 
		ie_email_w, 
		nr_seq_classif_ci_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ie_gerar_w := 'S';
 
				 
		select	count(*) 
		into STRICT	qt_existe_w 
		from	sac_regra_envio_comun_lib 
		where	nr_seq_regra = nr_seq_regra_w;
 
		if (qt_existe_w > 0) then 
			begin 
			select	count(*) 
			into STRICT	qt_existe_w 
			from	sac_regra_envio_comun_lib 
			where	nr_seq_regra = nr_seq_regra_w 
			and	((coalesce(cd_perfil::text, '') = '') and (coalesce(nr_seq_resp_w::text, '') = ''));
 
			if (qt_existe_w = 0) then 
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
				into STRICT	ie_gerar_w 
				from	sac_regra_envio_comun_lib 
				where	nr_seq_regra = nr_seq_regra_w 
				and	coalesce(cd_perfil_w,0) = coalesce(cd_perfil,coalesce(cd_perfil_w,0)) 
				and	coalesce(nr_seq_resp_w,0) = coalesce(nr_seq_responsavel,coalesce(nr_seq_resp_w,0));
			end if;
			end;
		end if;
 
		 
		if (coalesce(ie_gerar_w,'S') = 'S') then 
			begin 
			select	substr(ds_ocorrencia,1,4000), 
				substr(obter_nome_pf(cd_pessoa_fisica),1,60) pessoa_fisica, 
				substr(obter_nome_pf(cd_pf_referencia),1,60) pessoa_ref, 
				substr(obter_nome_setor(cd_setor_referencia),1,100) setor_ref,				 
				nm_usuario_nrec, 
				cd_setor_referencia, 
				cd_convenio, 
				nm_usuario_envio, 
				to_char(dt_ocorrencia, 'dd/mm/yyyy hh24:mi:ss'), 
				nr_atendimento, 
				substr(OBTER_PESSOA_ATENDIMENTO(nr_atendimento,'N'),1,255), 
				nm_pessoa_registro 
			into STRICT	ds_ocorrencia_w, 
				nm_pessoa_abertura_w, 
				nm_pessoa_referencia_w, 
				ds_setor_referencia_w, 
				nm_usuario_abert_bo_w, 
				cd_setor_atend_ww, 
				cd_convenio_w, 
				nm_usuario_envio_w, 
				dt_ocorrencia_w, 
				nr_atendimento_w, 
				nm_paciente_atend_w, 
				nm_pessoa_registro_w 
			from	sac_boletim_ocorrencia 
			where	nr_sequencia = nr_seq_bo_w;
			 
			if (ie_evento_p in ('6')) then /* Resposta do B.O */
 
				select	CASE WHEN 	ie_status='A' THEN wheb_mensagem_pck.get_texto(306038) WHEN 	ie_status='R' THEN wheb_mensagem_pck.get_texto(306039) WHEN 	ie_status='P' THEN wheb_mensagem_pck.get_texto(306040) WHEN 	ie_status='E' THEN wheb_mensagem_pck.get_texto(306041) WHEN 	ie_status='S' THEN wheb_mensagem_pck.get_texto(306042) WHEN 	ie_status='B' THEN wheb_mensagem_pck.get_texto(306043) WHEN 	ie_status='N' THEN wheb_mensagem_pck.get_texto(306044) WHEN 	ie_status='G' THEN wheb_mensagem_pck.get_texto(306045) WHEN 	ie_status='C' THEN wheb_mensagem_pck.get_texto(306046)  ELSE wheb_mensagem_pck.get_texto(306047) END  
				into STRICT	ds_status_bo_w 
				from	sac_resp_bol_ocor 
				where	nr_sequencia = nr_sequencia_p;
			end if;
 
			open C02;
			loop 
			fetch C02 into 
				ie_usuario_w, 
				ds_usuario_destino_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin			 
				if (ie_usuario_w not in ('RSR','U','UNR')) then -- Usuários responsaveis da resposta. 
					open C03;
					loop 
					fetch C03 into 
						nr_seq_responsavel_w, 
						cd_setor_responsavel_w, 
						cdEstab_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
						begin 
						open C04;
						loop 
						fetch C04 into 
							nm_usuario_resp_w;
							EXIT WHEN NOT FOUND; /* apply on C04 */
							begin 
							if (coalesce(nm_usuario_resp_w,'X') <> 'X') then 
								nm_usuario_w := substr( nm_usuario_resp_w || ', ' ||nm_usuario_w,1,2000);
							end if;
							end;
						end loop;
						close C04;
						end;
					end loop;
					close C03;
				end if;
				 
				 
				if (ie_usuario_w = 'RS') then 
					begin 
					if (coalesce(cd_setor_atend_ww,0) > 0) then 
						begin 
						select 	substr(obter_usuario_pessoa(cd_pessoa_resp),1,15) 
						into STRICT	nm_usuario_resp_w 
						from	setor_atendimento 
						where	cd_setor_atendimento = cd_setor_atend_ww;
											 
						if (coalesce(nm_usuario_resp_w,'X') <> 'X') then 
							nm_usuario_w := substr(nm_usuario_resp_w || ', ' ||nm_usuario_w,1,2000);					
						end if;
						end;
					end if;					
					end;
				elsif (ie_usuario_w = 'U') then 
					begin 
					if (coalesce(ds_usuario_destino_w,'X') <> 'X') then 
						nm_usuario_w := substr(ds_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'RSR') then -- Usuários responsaveis da resposta. 
					begin 
					open C03;
					loop 
					fetch C03 into 
						nr_seq_responsavel_w, 
						cd_setor_responsavel_w, 
						cdEstab_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
						begin 
						select	substr(obter_usuario_pessoa(a.cd_pessoa_resp),1,15) 
						into STRICT	nm_usuario_resp_w 
						from	setor_atendimento a 
						where	a.cd_setor_atendimento = cd_setor_responsavel_w;
						 
						if (nm_usuario_resp_w IS NOT NULL AND nm_usuario_resp_w::text <> '') then 
							nm_usuario_w := substr(nm_usuario_resp_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C03;
					end;
				elsif (ie_usuario_w = 'UNR') then 
					begin 
					if (coalesce(nm_usuario_abert_bo_w,'X') <> 'X') then 
						nm_usuario_w := substr(nm_usuario_abert_bo_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				end if;
				end;
			end loop;
			close C02;
			 
			if (coalesce(nm_pessoa_abertura_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_abertura', nm_pessoa_abertura_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_abertura', nm_pessoa_abertura_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_abertura',wheb_mensagem_pck.get_texto(306049)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_abertura', wheb_mensagem_pck.get_texto(306049)),1,255);
			end if;
			 
			if (coalesce(nm_pessoa_registro_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_pessoa_reg',nm_pessoa_registro_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_pessoa_reg', nm_pessoa_registro_w),1,255);
			end if;
 
			if (ds_ocorrencia_w IS NOT NULL AND ds_ocorrencia_w::text <> '') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ocorrencia', ds_ocorrencia_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w,'@ds_ocorrencia', ds_ocorrencia_w),1,255);
			end if;
			 
			select	count(*) 
			into STRICT	qt_existe_w 
			from	sac_boletim_ocorrencia 
			where	nr_sequencia = nr_seq_bo_w 
			and	(ds_ocorrencia_longa IS NOT NULL AND ds_ocorrencia_longa::text <> '');			
			 
			if (qt_existe_w > 0) then 
				begin 
				nr_seq_rtf_srtring_w := converte_rtf_string( 
						'select	ds_ocorrencia_longa 
						 from	sac_boletim_ocorrencia a 
						 where	nr_sequencia = :nr_sequencia_p', nr_seq_bo_w, nm_usuario_p, nr_seq_rtf_srtring_w);
				select	ds_texto 
				into STRICT	ds_ocorrencia_longa_w 
				from	tasy_conversao_rtf 
				where	nr_sequencia = nr_seq_rtf_srtring_w;
				exception 
				when others then 
					ds_ocorrencia_longa_w	:= '';
				end;
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ocor_longa', ds_ocorrencia_longa_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_ocor_longa', ds_ocorrencia_longa_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ocor_longa', ''),1,32000);
			end if;
			 
			if (coalesce(nm_pessoa_referencia_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_ref', nm_pessoa_referencia_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_ref', nm_pessoa_referencia_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_ref',wheb_mensagem_pck.get_texto(306049)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_ref', obter_desc_expressao(345776)/*'Inf. não registrada'*/),1,255);
			end if;
 
			if (coalesce(ds_setor_referencia_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_setor_ref', ds_setor_referencia_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_setor_ref', ds_setor_referencia_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_setor_ref',wheb_mensagem_pck.get_texto(306049)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_setor_ref', wheb_mensagem_pck.get_texto(306049)),1,255);
			end if;			
 
			if (coalesce(nr_seq_resp_w,0) > 0) then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_responsavel', substr(obter_descricao_padrao('SAC_RESPONSAVEL', 'DS_RESPONSAVEL', nr_seq_resp_w),1,150)),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_responsavel', substr(obter_descricao_padrao('SAC_RESPONSAVEL', 'DS_RESPONSAVEL', nr_seq_resp_w),1,150)),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_responsavel',wheb_mensagem_pck.get_texto(306049)),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_responsavel', wheb_mensagem_pck.get_texto(306049)),1,255);
			end if;		
 
			ds_comunicacao_w		:= substr(replace_macro(ds_comunicacao_w, '@nr_boletim', nr_seq_bo_w),1,32000);
			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@nr_boletim', nr_seq_bo_w),1,255);
			 
			if (coalesce(ds_status_bo_w,'X') <> 'X') and (ie_evento_p <> '1') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_status_atual', ds_status_bo_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_status_atual', ds_status_bo_w),1,255);
			end if;
 
			select	count(*) 
			into STRICT	qt_existe_w 
			from	sac_hist_bol_ocor 
			where	nr_seq_resp_Bo = nr_sequencia_p;
			 
			/* Pega o último histórico do boletim*/
 
			if (qt_existe_w > 0) then 
				begin 
				select	a.ds_historico 
				into STRICT	ds_historico_w 
				from	sac_hist_bol_ocor a 
				where	a.nr_Seq_resp_bo = nr_sequencia_p 
				and	a.nr_Sequencia = (SELECT	max(x.nr_sequencia) 
							from	sac_hist_bol_ocor x 
							where	x.nr_seq_resp_bo = a.nr_seq_resp_bo);
				 
				exception 
				when others then 
					ds_historico_w	:= '';
				end;
			end if;
			 
			if (coalesce(ds_historico_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ultimo_historico',ds_historico_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_ultimo_historico', ds_historico_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ultimo_historico',wheb_mensagem_pck.get_texto(306050)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_ultimo_historico',wheb_mensagem_pck.get_texto(306050)),1,255);
			end if;
 
			if (coalesce(dt_resposta_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_resposta',dt_resposta_w),1,32000);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_resposta',wheb_mensagem_pck.get_texto(306051)),1,32000);
			end if;
			 
			 
			if (coalesce(dt_encerramento_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_encerramento',dt_encerramento_w),1,32000);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_encerramento',wheb_mensagem_pck.get_texto(306052)),1,32000);
			end if;
			 
			if (coalesce(cd_convenio_w,0) <> 0) then 
				select	ds_convenio 
				into STRICT	ds_convenio_w 
				from	convenio 
				where	cd_convenio = cd_convenio_w;
				 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_convenio',ds_convenio_w),1,32000);
			end if;
 
			if (coalesce(nm_usuario_envio_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_usuario_envio',nm_usuario_envio_w),1,32000);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_usuario_envio',wheb_mensagem_pck.get_texto(306053)),1,32000);
			end if;
			 
			select	count(*) 
			into STRICT	qt_existe_w 
			from	sac_resp_bol_ocor 
			where	nr_sequencia = nr_sequencia_p 
			and	(ds_responsavel IS NOT NULL AND ds_responsavel::text <> '');			
			 
			if (qt_existe_w > 0) then 
				begin 
				nr_seq_rtf_srtring_w := converte_rtf_string( 
						'select	ds_responsavel 
						 from	sac_resp_bol_ocor a 
						 where	nr_sequencia = :nr_sequencia_p', nr_sequencia_p, nm_usuario_p, nr_seq_rtf_srtring_w);
				select	ds_texto 
				into STRICT	ds_ocorrencia_longa_w 
				from	tasy_conversao_rtf 
				where	nr_sequencia = nr_seq_rtf_srtring_w;
				exception 
				when others then 
					ds_ocorrencia_longa_w	:= '';
				end;
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_responsavel', ds_ocorrencia_longa_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_responsavel', ds_ocorrencia_longa_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_responsavel', ''),1,32000);
			end if;
			 
			if (coalesce(nm_pessoa_referencia_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_ref', nm_pessoa_referencia_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_ref', nm_pessoa_referencia_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pessoa_ref',wheb_mensagem_pck.get_texto(306055)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_pessoa_ref', wheb_mensagem_pck.get_texto(306055)),1,255);
			end if;
			 
			if (coalesce(nr_atendimento_w,0) <> 0) then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_atendimento', nr_atendimento_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_atendimento', nr_atendimento_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_atendimento',wheb_mensagem_pck.get_texto(306054)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_atendimento', wheb_mensagem_pck.get_texto(306054)),1,255);
			end if;
 
			if (coalesce(nm_paciente_atend_w,'X') <> 'X') then 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_paciente_atend', nm_paciente_atend_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_paciente_atend', nm_paciente_atend_w),1,255);
			else 
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_paciente_atend',wheb_mensagem_pck.get_texto(306056)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_paciente_atend', wheb_mensagem_pck.get_texto(306056)),1,255);
			end if;
			 
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_ocorrencia',dt_ocorrencia_w),1,32000);
			 
			 
			if (ie_comunicacao_interna_w = 'S') then 
				begin 
				 
				if (nm_usuario_destino_p IS NOT NULL AND nm_usuario_destino_p::text <> '') then 
					nm_usuario_w		:= substr(nm_usuario_destino_p || nm_usuario_w ,1,2000);
				end if;
 
				if (cd_perfil_dest_p IS NOT NULL AND cd_perfil_dest_p::text <> '') then 
					ds_perfis_destino_w	:= substr(cd_perfil_dest_p || ds_perfis_destino_w,1,2000);
				end if;
				 
				if (coalesce(ds_titulo_w,'X') <> 'X') and (coalesce(ds_comunicacao_w,'X') <> 'X') then 
					begin 
 
					if (coalesce(nr_seq_classif_ci_w,0) <> 0) then 
						nr_seq_classif_w	:= nr_seq_classif_ci_w;
					else 
 
						select	obter_classif_comunic('F') 
						into STRICT	nr_seq_classif_w 
						;
 
					end if;
					 
					insert into comunic_interna(dt_comunicado, 
							ds_titulo, 
							ds_comunicado, 
							nm_usuario, 
							dt_atualizacao, 
							ie_geral, 
							nm_usuario_destino, 
							cd_perfil, 
							nr_sequencia, 
							ie_gerencial, 
							nr_seq_classif, 
							ds_perfil_adicional, 
							cd_setor_destino, 
							cd_estab_destino, 
							ds_setor_adicional, 
							dt_liberacao, 
							ds_grupo, 
							nm_usuario_oculto) 
					values (clock_timestamp(), 
							ds_titulo_w, 
							ds_comunicacao_w, 
							nm_usuario_p, 
							clock_timestamp(), 
							'N', 
							nm_usuario_w, 
							cd_perfil_dest_p, 
							nextval('comunic_interna_seq'), 
							'N', 
							nr_seq_classif_w, 
							CASE WHEN coalesce(cd_perfil_dest_p::text, '') = '' THEN ds_perfis_destino_w  ELSE to_char(cd_perfil_dest_p) || ',' END , 
							null, 
							'', 
							'', 
							clock_timestamp(), 
							cd_grupo_destino_p, 
							'');
					end;
				end if;
				end;
			end if;
 
			if (ie_email_w = 'S') then 
				begin 
				lista_usuario_w := substr(nm_usuario_w,1,2000);
 
				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop 
					tam_lista_w	:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);
 
					if (ie_pos_virgula_w <> 0) then 
						nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));
 
						select	max(ds_email) 
						into STRICT	ds_email_usuario_w 
						from	usuario 
						where	nm_usuario = nm_usuario_w;
 
						if (coalesce(ds_email_usuario_w,'X') <> 'X') then 
							begin 
							ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
							end;
						end if;
					else 
						lista_usuario_w	:= null;
					end if;
				end loop;
 
				if (coalesce(ds_lista_email_destino_w,'X') <> 'X') then 
					ds_lista_email_usuario_w := ds_lista_email_destino_w;
				end if;
				 
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then 
					ds_lista_email_usuario_w := replace(ds_lista_email_usuario_w,',',';');
					CALL enviar_email(	ds_titulo_w, 
							ds_comunicacao_w, 
							ds_email_origem_w, -- E-mail cadastrado na regra. busca o e-mail do usuário 
							ds_lista_email_usuario_w, 
							nm_usuario_p, 
							'M');
							 
				insert into sac_bol_ocor_envio( 
						nr_sequencia, 
						ds_destino, 
						ds_observacao, 
						dt_atualizacao, 
						dt_atualizacao_nrec, 
						dt_envio, 
						nm_usuario, 
						nm_usuario_nrec, 
						nr_seq_bo) 
					values (	nextval('sac_bol_ocor_envio_seq'), 
						substr(ds_lista_email_usuario_w,1,255), 
						wheb_mensagem_pck.get_texto(306057), 
						clock_timestamp(), 
						clock_timestamp(), 
						clock_timestamp(), 
						nm_usuario_p, 
						nm_usuario_p, 
						nr_seq_bo_w);
				end if;
			end;
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sac_gerar_envio_comunic_resp ( nr_sequencia_p bigint, ie_evento_p text, nm_usuario_destino_p text, cd_perfil_dest_p text, cd_grupo_destino_p text, nr_seq_evento_p bigint, nm_usuario_p text) FROM PUBLIC;

