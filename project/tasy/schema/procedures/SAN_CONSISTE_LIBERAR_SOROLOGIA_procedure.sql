-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_consiste_liberar_sorologia ( nr_seq_doacao_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_permite_liberar_w	varchar(1);
ie_altera_exame_w	varchar(1);
ie_amostra_inapta_w	varchar(1);

BEGIN

if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then

	ie_altera_exame_w 	:= obter_valor_param_usuario(450, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
	ie_amostra_inapta_w 	:= obter_valor_param_usuario(450, 390, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

	if (ie_altera_exame_w = 'S') then

		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_permite_liberar_w
		FROM	san_doacao
		WHERE 	coalesce(ie_auto_exclusao,'N') = 'N'
		AND	ie_status IN (2,6)
		AND	((coalesce(ie_avaliacao_final,'A') = 'A') or (ie_amostra_inapta_w = 'S' and (nr_seq_doacao_amostra IS NOT NULL AND nr_seq_doacao_amostra::text <> '')))
		AND	san_obter_se_exames_doacao_ok(nr_sequencia,0) = 0
		and	san_obter_se_analise_bloqueio(nr_sequencia,'D') = 'N'
		and	nr_sequencia = nr_seq_doacao_p
		AND	NOT EXISTS ( 	SELECT 1
					FROM	san_exame_lote a,
						san_exame_realizado b,
						san_exame c
					WHERE	a.nr_sequencia 	= b.nr_seq_exame_lote
					AND	c.nr_sequencia	= b.nr_seq_exame
					AND	a.nr_seq_doacao	= nr_seq_doacao_p
					AND 	((san_obter_se_exame_auxiliar(a.nr_sequencia,b.nr_seq_exame,cd_estabelecimento_p,'S') = 'S') OR (san_obter_se_exame_auxiliar(a.nr_sequencia,b.nr_seq_exame,cd_estabelecimento_p,'O') = 'S'))
					AND	coalesce(b.dt_liberacao::text, '') = ''
					AND	a.nr_sequencia  = nr_seq_lote_p);


		if (ie_permite_liberar_w = 'S') then

			update	san_doacao
                        set     ie_status      	= 3,
				dt_liberacao   	= clock_timestamp(),
                                nm_usuario_lib 	= nm_usuario_p,
                                ie_status_ant  	= ie_status
                        where   nr_sequencia 	= nr_seq_doacao_p;

		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_consiste_liberar_sorologia ( nr_seq_doacao_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

