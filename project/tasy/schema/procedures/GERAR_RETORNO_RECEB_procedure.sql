-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_retorno_receb ( nr_seq_convenio_ret_receb_p bigint, nr_seq_convenio_retorno_p bigint, vl_a_vincular_p bigint, ie_tipo_operacao_p bigint, vl_saldo_vinc_p bigint, vl_a_vincular_vinc_p bigint, dt_baixa_cr_p timestamp, ie_atualizar_dt_baixa_cr text, nm_usuario_p text) AS $body$
DECLARE

 
nr_adiantamento_w	bigint;


BEGIN 
 
-- ie_tipo_operacao_p indica qual if dever√° executar 
 
if (ie_tipo_operacao_p = 1) then 
 
	if (nr_seq_convenio_ret_receb_p IS NOT NULL AND nr_seq_convenio_ret_receb_p::text <> '') and (nr_seq_convenio_retorno_p IS NOT NULL AND nr_seq_convenio_retorno_p::text <> '') and (vl_a_vincular_p IS NOT NULL AND vl_a_vincular_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then	 
 
		insert into convenio_ret_receb( nr_seq_receb, 
						nr_seq_retorno, 
						vl_vinculacao, 
						dt_atualizacao, 
						nm_usuario) 
		values (	nr_seq_convenio_ret_receb_p, 
						nr_seq_convenio_retorno_p, 
						vl_a_vincular_p, 
						clock_timestamp(), 
						nm_usuario_p);	
	end if;
	 
	if (nr_seq_convenio_ret_receb_p IS NOT NULL AND nr_seq_convenio_ret_receb_p::text <> '') then	 
	 
		select	max(nr_adiantamento) 
		into STRICT	nr_adiantamento_w 
		from	convenio_receb 
		where	nr_sequencia	= nr_seq_convenio_ret_receb_p;
		 
		CALL atualizar_saldo_adiantamento(nr_adiantamento_w, nm_usuario_p, null);
		 
		if	((vl_saldo_vinc_p - vl_a_vincular_vinc_p) = 0) then 
			update	convenio_receb 
			set	ie_status	= 'T' 
			where	nr_sequencia	= nr_seq_convenio_ret_receb_p;
		else 
			update	convenio_receb 
			set	ie_status	= 'P' 
			where	nr_sequencia	= nr_seq_convenio_ret_receb_p;
		end if;	
	end if;		
 
elsif (ie_tipo_operacao_p 		= 2) and (ie_atualizar_dt_baixa_cr	= 'N') then 
	 
	update	convenio_retorno a 
	set	a.ie_status_retorno	= 'V', 
		a.dt_vinculacao		= clock_timestamp() 
	where 	a.nr_sequencia		= nr_seq_convenio_retorno_p;	
	 
elsif (ie_tipo_operacao_p 		= 2) and (ie_atualizar_dt_baixa_cr	= 'S') then 
	 
	update	convenio_retorno a 
	set	a.dt_baixa_cr	= dt_baixa_cr_p 
	where	a.nr_sequencia	= nr_seq_convenio_retorno_p;	
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_retorno_receb ( nr_seq_convenio_ret_receb_p bigint, nr_seq_convenio_retorno_p bigint, vl_a_vincular_p bigint, ie_tipo_operacao_p bigint, vl_saldo_vinc_p bigint, vl_a_vincular_vinc_p bigint, dt_baixa_cr_p timestamp, ie_atualizar_dt_baixa_cr text, nm_usuario_p text) FROM PUBLIC;

