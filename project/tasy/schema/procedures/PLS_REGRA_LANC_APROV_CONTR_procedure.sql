-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_regra_lanc_aprov_contr ( nr_seq_contrato_p bigint, ie_ordem_execucao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
ie_tipo_lancamento_p
1	Executa dentro da rotina PLS_APROVAR_CONTRATO
2	Executa pelo codigo fonte
*/
				
dt_contrato_w			timestamp;
ie_pessoa_contrato_w		varchar(10);
nr_seq_regra_w			bigint;
nr_seq_regra_dependencia_w	bigint;
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
nr_seq_contrato_plano_w		pls_contrato_plano.nr_sequencia%type;
nr_seq_regra_lanc_bonific_w	pls_regra_lanc_automatico.nr_sequencia%type;

C01 CURSOR(	nr_seq_regra_pc	pls_regra_lanc_automatico.nr_sequencia%type) FOR
	SELECT	nr_seq_regra_dependencia
	from	pls_regra_lanc_aut_item
	where	nr_seq_regra = nr_seq_regra_pc
	and	(nr_seq_regra_dependencia IS NOT NULL AND nr_seq_regra_dependencia::text <> '');
	
c02 CURSOR(	ie_tipo_contratacao_pc	pls_plano.ie_tipo_contratacao%type,
		nr_seq_plano_pc		pls_plano.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_regra
	from	pls_regra_lanc_automatico
	where	ie_acao_regra = 8
	and	ie_evento = 2
	and	ie_situacao = 'A'
	and	((coalesce(ie_tipo_contratacao::text, '') = '') or (ie_tipo_contratacao = ie_tipo_contratacao_pc))
	and	((coalesce(nr_seq_plano::text, '') = '') or (nr_seq_plano = nr_seq_plano_pc))
	and	((coalesce(nr_seq_sca::text, '') = '') or (exists (	SELECT	1
							from	pls_sca_vinculo a,
								pls_segurado b
							where	b.nr_seq_contrato = nr_seq_contrato_p
							and	b.nr_sequencia = a.nr_seq_segurado
							and	coalesce(b.dt_cancelamento::text, '') = ''
							and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
							and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))))
	order by
		coalesce(ie_tipo_contratacao, ' '),
		coalesce(nr_seq_plano, 0),
		coalesce(nr_seq_sca, 0);

c03 CURSOR(	nr_seq_regra_pc	pls_regra_lanc_automatico.nr_sequencia%type,
		dt_contrato_pc	pls_contrato.dt_contrato%type) FOR
	SELECT	a.nr_seq_bonificacao
	from	pls_regra_lanc_aut_item a
	where	a.ie_situacao = 'A'
	and	a.nr_seq_regra = nr_seq_regra_pc
	and	not exists (	SELECT	1
				from	pls_bonificacao_vinculo x
				where	x.nr_seq_bonificacao = a.nr_seq_bonificacao
				and	x.nr_seq_contrato = nr_seq_contrato_p)
	and	not exists (	select	1
				from	pls_bonificacao_vinculo x,
					pls_grupo_contrato y,
					pls_contrato_grupo w
				where	x.nr_seq_bonificacao = a.nr_seq_bonificacao
				and	y.nr_sequencia = x.nr_seq_grupo_contrato
				and	y.nr_sequencia = w.nr_seq_grupo
				and	w.nr_seq_contrato = nr_seq_contrato_p)
	and	dt_contrato_pc between coalesce(a.dt_inicio_vigencia, dt_contrato_pc) and coalesce(a.dt_fim_vigencia, dt_contrato_pc);
		
C04 CURSOR(	nr_seq_regra_pc	pls_regra_lanc_automatico.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_regra_multa_contratual
	from	pls_regra_multa_contratual
	where	nr_seq_regra_lanc_auto = nr_seq_regra_pc;
		
BEGIN

select	dt_contrato,
	CASE WHEN coalesce(cd_cgc_estipulante::text, '') = '' THEN 'PF'  ELSE 'PJ' END
into STRICT	dt_contrato_w,
	ie_pessoa_contrato_w
from	pls_contrato
where	nr_sequencia = nr_seq_contrato_p;

if (ie_ordem_execucao_p = '1') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_regra_w
	from	pls_regra_lanc_automatico a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	dt_contrato_w between coalesce(a.dt_inicio_vigencia,dt_contrato_w) and fim_dia(a.dt_fim_vigencia)
	and	((a.ie_pessoa_contrato	= ie_pessoa_contrato_w) or (a.ie_pessoa_contrato = 'A'))
	and	((coalesce(a.nr_seq_grupo_produto::text, '') = '') or (exists ( 	SELECT	1
				from	pls_preco_produto x,
					pls_contrato_plano y
				where	y.nr_seq_plano	= x.nr_seq_plano
				and	x.nr_seq_grupo	= a.nr_seq_grupo_produto
				and	y.nr_seq_contrato = nr_seq_contrato_p)))
				and	ie_situacao		= 'A'
				and 	ie_evento		= 12;

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		for r_c01_w in c01(nr_seq_regra_w) loop
			begin
			insert into pls_contrato_dependencia(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					cd_estabelecimento,nr_seq_contrato,nr_seq_regra_dependencia,ie_situacao,nr_seq_regra_lanc_aut)
			values (	nextval('pls_contrato_dependencia_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
					cd_estabelecimento_p,nr_seq_contrato_p,r_c01_w.nr_seq_regra_dependencia,'A',nr_seq_regra_w);
			end;
		end loop;
		
		for r_c04_w in c04(nr_seq_regra_w) loop
			begin
			insert into pls_regra_multa_contratual(	nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
					nm_usuario, nm_usuario_nrec, nr_seq_contrato,
					dt_inicio_vigencia, dt_fim_vigencia, ie_tipo_multa,
					ie_aplicacao_regra, ie_referencia_lanc, ie_data_base,
					ie_proporcional, ie_desconsiderar_remido, vl_multa,
					tx_multa)
				(SELECT	nextval('pls_regra_multa_contratual_seq'), clock_timestamp(), clock_timestamp(),
					nm_usuario_p, nm_usuario_p, nr_seq_contrato_p,
					dt_inicio_vigencia, dt_fim_vigencia, ie_tipo_multa,
					ie_aplicacao_regra, ie_referencia_lanc, ie_data_base,
					ie_proporcional, ie_desconsiderar_remido, vl_multa,
					tx_multa
				from	pls_regra_multa_contratual
				where	nr_sequencia = r_c04_w.nr_seq_regra_multa_contratual);
			end;
		end loop;
	end if;
elsif (ie_ordem_execucao_p = '2') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_plano_w
	from	pls_contrato_plano
	where	nr_seq_contrato = nr_seq_contrato_p
	and	ie_situacao = 'A';

	if (nr_seq_contrato_plano_w IS NOT NULL AND nr_seq_contrato_plano_w::text <> '') then
		select	max(b.nr_sequencia),
			max(b.ie_tipo_contratacao)
		into STRICT	nr_seq_plano_w,
			ie_tipo_contratacao_w
		from	pls_contrato_plano a,
			pls_plano b
		where	b.nr_sequencia = a.nr_seq_plano
		and	a.nr_sequencia = nr_seq_contrato_plano_w;
	end if;

	for r_c02_w in c02(	ie_tipo_contratacao_w,
				nr_seq_plano_w) loop
		begin
		nr_seq_regra_lanc_bonific_w	:= r_c02_w.nr_seq_regra;
		end;
	end loop;

	if (nr_seq_regra_lanc_bonific_w IS NOT NULL AND nr_seq_regra_lanc_bonific_w::text <> '') then
		for r_c03_w in c03(	nr_seq_regra_lanc_bonific_w,
					dt_contrato_w) loop
			begin
			insert	into	pls_bonificacao_vinculo(nr_sequencia,nr_seq_bonificacao,dt_atualizacao,
					nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					nr_seq_contrato, dt_inicio_vigencia)
				values (nextval('pls_bonificacao_vinculo_seq'),r_c03_w.nr_seq_bonificacao,clock_timestamp(),
					nm_usuario_p,clock_timestamp(),nm_usuario_p,
					nr_seq_contrato_p, trunc(dt_contrato_w,'mm'));
			end;
		end loop;
	end if;
	
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_regra_lanc_aprov_contr ( nr_seq_contrato_p bigint, ie_ordem_execucao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

