-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_qua_doc_trein_pessoa ( ds_pessoas_p text, ds_setores_p text, nm_usuario_p text, nr_seq_treinamento_p bigint, ie_consid_setor_usuario_p text default 'N', ie_somente_funcionario_p text default 'N') AS $body$
DECLARE


cd_pessoa_fisica_w 		varchar(10);
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
ds_pessoas_w			varchar(4000);
qt_registro_w			bigint;
cd_setor_atendimento_w		bigint;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type	:= wheb_usuario_pck.get_cd_estabelecimento;
ie_consid_somente_func_w	varchar(1);

C01 CURSOR FOR
	SELECT	u.cd_pessoa_fisica,
		u.cd_setor_atendimento
	FROM usuario u
LEFT OUTER JOIN usuario_setor s ON (u.nm_usuario = s.nm_usuario_param)
LEFT OUTER JOIN pessoa_fisica p ON (u.cd_pessoa_fisica = p.cd_pessoa_fisica)
WHERE ((ie_consid_somente_func_w = 'N') or (p.ie_funcionario = 'S')) and ie_consid_setor_usuario_p = 'N' and u.ie_situacao = 'A' and obter_se_contido(s.cd_setor_atendimento,ds_setores_p) = 'S' group by	u.cd_pessoa_fisica,
		u.cd_setor_atendimento
	
union all

	SELECT	u.cd_pessoa_fisica,
		u.cd_setor_atendimento
	FROM usuario u
LEFT OUTER JOIN pessoa_fisica p ON (u.cd_pessoa_fisica = p.cd_pessoa_fisica)
WHERE ((ie_consid_somente_func_w = 'N') or (p.ie_funcionario = 'S')) and ie_consid_setor_usuario_p = 'S' and u.ie_situacao = 'A' and obter_se_contido(u.cd_setor_atendimento,ds_setores_p) = 'S';


BEGIN

ie_consid_somente_func_w := obter_param_usuario(4000, 315, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consid_somente_func_w);

if (ie_somente_funcionario_p = 'N') then
	ie_consid_somente_func_w	:= 'N';
end if;

if (ds_setores_p IS NOT NULL AND ds_setores_p::text <> '') then
	open C01;
	loop
	fetch C01 into
		cd_pessoa_fisica_w,
		cd_setor_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
			insert into qua_doc_trein_pessoa(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_treinamento,
							cd_pessoa_fisica,
							ie_faltou,
							cd_setor_atendimento)
						values ( nextval('qua_doc_trein_pessoa_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_treinamento_p,
							cd_pessoa_fisica_w,
							'N',
							cd_setor_atendimento_w);
		end if;
		end;
	end loop;
	close C01;
end if;

ds_pessoas_w:=ds_pessoas_p;
while((trim(both ds_pessoas_w) IS NOT NULL AND (trim(both ds_pessoas_w))::text <> ''))  and (trim(both ds_pessoas_w) <> ',') loop
	begin
	tam_lista_w	:= length(ds_pessoas_w);
	ie_pos_virgula_w:= position(',' in ds_pessoas_w);

	if (ie_pos_virgula_w <> 0) then
		cd_pessoa_fisica_w := substr(ds_pessoas_w,1,(ie_pos_virgula_w - 1));
		ds_pessoas_w	:= substr(ds_pessoas_w,(ie_pos_virgula_w + 2), tam_lista_w);
	else
		ds_pessoas_w	:= null;
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	qua_doc_trein_pessoa
	where	cd_pessoa_fisica = cd_pessoa_fisica_w
	and	nr_seq_treinamento = nr_seq_treinamento_p;

	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from	usuario
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	if (qt_registro_w = 0) then
		if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
			insert into qua_doc_trein_pessoa(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_treinamento,
							cd_pessoa_fisica,
							ie_faltou,
							cd_setor_atendimento)
						values (nextval('qua_doc_trein_pessoa_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_treinamento_p,
							cd_pessoa_fisica_w,
							'N',
							cd_setor_atendimento_w);
		end if;
	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_qua_doc_trein_pessoa ( ds_pessoas_p text, ds_setores_p text, nm_usuario_p text, nr_seq_treinamento_p bigint, ie_consid_setor_usuario_p text default 'N', ie_somente_funcionario_p text default 'N') FROM PUBLIC;

