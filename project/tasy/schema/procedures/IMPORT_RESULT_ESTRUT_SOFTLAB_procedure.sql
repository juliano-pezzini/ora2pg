-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_result_estrut_softlab ( nr_prescricao_p prescr_procedimento.nr_prescricao%type, nr_seq_prescr_p prescr_procedimento.nr_sequencia%type, cd_exame_prin_p exame_laboratorio.cd_exame_integracao%type, cd_material_p material_exame_lab.cd_material_integracao%type, cd_exame_analito_p exame_laboratorio.cd_exame_integracao%type, ds_result_p exame_lab_result_item.ds_resultado%type, nr_seq_log_p log_integracao.nr_sequencia%type, ds_erro_p INOUT text) AS $body$
DECLARE


qt_resultado_w              exame_lab_result_item.qt_resultado%type;
pr_resultado_w              exame_lab_result_item.pr_resultado%type;
ds_resultado_w              exame_lab_result_item.ds_resultado%type;

nr_seq_exame_w              exame_laboratorio.nr_seq_exame%type;
nr_seq_exame_principal_w    exame_laboratorio.nr_seq_exame%type;
ie_formato_result_w         exame_laboratorio.ie_formato_resultado%type;

ie_result_num               varchar(1);
nm_usuario_w                varchar(255);


BEGIN

    select  wheb_usuario_pck.get_nm_usuario
    into STRICT    nm_usuario_w
;

    if (coalesce(nm_usuario_w::text, '') = '') then
        CALL wheb_usuario_pck.set_nm_usuario('SOFTLABWS');
    end if;

    select  obter_equip_exame_integracao(cd_exame_analito_p, 'SOFTLABWS', 1, nr_prescricao_p)
    into STRICT    nr_seq_exame_w
;

    if (coalesce(nr_seq_exame_w, 0) = 0) then
        select coalesce(max(nr_seq_exame), 0)
        into STRICT   nr_seq_exame_w
        from exame_laboratorio
        where coalesce(cd_exame_integracao, cd_exame) = cd_exame_analito_p;
    end if;

	if ((nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and nr_seq_exame_w > 0) then

		select  max(ie_formato_resultado)
		into STRICT    ie_formato_result_w
		from    exame_laboratorio
		where   nr_seq_exame = nr_seq_exame_w;

		if (coalesce(ie_formato_result_w::text, '') = '') then

			select  obter_equip_exame_integracao(cd_exame_prin_p, 'SOFTLABWS', 1, nr_prescricao_p)
			into STRICT    nr_seq_exame_principal_w
			;

			if (coalesce(nr_seq_exame_principal_w, 0) <> 0) then
				select coalesce(max(nr_seq_exame), 0)
				into STRICT   nr_seq_exame_principal_w
				from exame_laboratorio
				where coalesce(cd_exame_integracao, cd_exame) = cd_exame_prin_p;
			end if;

			select  max(ie_formato_resultado)
			into STRICT    ie_formato_result_w
			from    exame_laboratorio
			where   nr_seq_exame = nr_seq_exame_principal_w;

		end if;

		select  CASE WHEN obter_se_somente_numero(replace(ds_result_p, ',', ''))='N',    --'S' se e somente se ds_result_p contiver apenas numeros e virgulas OU se ds_result_p						obter_se_somente_numero(replace(ds_result_p, '.', '')) THEN  'S')   --contiver apenas numeros e pontos, 'N' em outros casos.		into STRICT    ie_result_num		;		ds_resultado_w := null;		qt_resultado_w := null;		pr_resultado_w := null;		if ((ie_formato_result_w = 'V' or ie_formato_result_w = 'DV') and ie_result_num = 'S') then			select  (replace(ds_result_p, '.', ','))::numeric 			into STRICT    qt_resultado_w			;		elsif (ie_formato_result_w = 'P' and ie_result_num = 'S') then			select  (replace(ds_result_p, '.', ','))::numeric 			into STRICT    pr_resultado_w			;		else			select  ds_result_p			into STRICT    ds_resultado_w			;		end if;		        --dt_resultado_p
						ds_erro_p := Atualizar_Lab_Result_Item(						nr_prescricao_p, nr_seq_prescr_p, null,            --cd_exame_p
						qt_resultado_w,  --qt_resultado_p
						pr_resultado_w,  --pr_resultado_p
						ds_resultado_w,  --ds_resultado_p
						null,            --ds_observacao_p
						null,            --cd_material_exame_p
						'N',             --ie_reenvio_p
						'SOFTLABWS',     --nm_usuario_p
						null,            --dt_coleta_p
						null,            --ds_referencia_p
						null,            --ds_unidade_medida_p
						null,            --nr_doc_lab_p
						clock_timestamp(), 
						ds_erro_p,       --ds_erro_p
						nr_seq_exame_w); --nr_seq_exame_w
	end if;end; END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_result_estrut_softlab ( nr_prescricao_p prescr_procedimento.nr_prescricao%type, nr_seq_prescr_p prescr_procedimento.nr_sequencia%type, cd_exame_prin_p exame_laboratorio.cd_exame_integracao%type, cd_material_p material_exame_lab.cd_material_integracao%type, cd_exame_analito_p exame_laboratorio.cd_exame_integracao%type, ds_result_p exame_lab_result_item.ds_resultado%type, nr_seq_log_p log_integracao.nr_sequencia%type, ds_erro_p INOUT text) FROM PUBLIC;

