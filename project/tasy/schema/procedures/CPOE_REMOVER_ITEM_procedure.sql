-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_remover_item ( ie_tipo_item_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_agenda_w			cpoe_procedimento.nr_seq_agenda%type;
nr_seq_lista_espera_w			cpoe_procedimento.nr_seq_lista_espera%type;
nr_seq_agenda_daily_w			agenda_paciente_auxiliar.nr_seq_agenda%type;
nr_seq_cpoe_proc_daily_w		agenda_paciente_auxiliar.nr_seq_cpoe_procedimento%type;
nr_seq_agenda_consulta_w		agenda_consulta_adic.nr_seq_agenda%type;
nr_seq_cpoe_proc_consulta_w		agenda_consulta_adic.nr_seq_cpoe_procedimento%type;
nr_seq_cpoe_anterior_w			cpoe_material.nr_seq_cpoe_anterior%type;

c_01 CURSOR(nr_seq_cpoe_procedimento_p agenda_paciente_auxiliar.nr_seq_cpoe_procedimento%type) FOR
    SELECT a.nr_seq_agenda,
    a.nr_seq_cpoe_procedimento
    from agenda_paciente_auxiliar a
    where (a.nr_seq_cpoe_procedimento IS NOT NULL AND a.nr_seq_cpoe_procedimento::text <> '')
    and a.nr_seq_cpoe_procedimento  = nr_seq_cpoe_procedimento_p;

c_02 CURSOR(nr_seq_cpoe_procedimento_p agenda_consulta_adic.nr_seq_cpoe_procedimento%type) FOR
    SELECT a.nr_seq_agenda,
    a.nr_seq_cpoe_procedimento
    from agenda_consulta_adic a
    where (a.nr_seq_cpoe_procedimento IS NOT NULL AND a.nr_seq_cpoe_procedimento::text <> '')
    and a.nr_seq_cpoe_procedimento  = nr_seq_cpoe_procedimento_p;


BEGIN

	if (ie_tipo_item_p = 'N') then--Dietas
		delete	from cpoe_justificativa_item
		where	nr_seq_nut_interacao = nr_sequencia_p;

		delete	from cpoe_plan_protocol
		where 	nr_seq_diet_cpoe = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_diet = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_diet_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_nutricao');

		delete
		from	cpoe_dieta
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'M' or ie_tipo_item_p = 'MA') then--Materiais
	
		select MAX(nr_seq_cpoe_anterior)
		into STRICT  nr_seq_cpoe_anterior_w
		from cpoe_material
		where nr_sequencia = nr_sequencia_p;		
		
		update cpoe_material
		set dt_suspensao  = NULL,
			nm_usuario_susp  = NULL
		where coalesce(dt_lib_suspensao::text, '') = ''
		and (nr_seq_adicional = nr_seq_cpoe_anterior_w
		or nr_seq_ataque = nr_seq_cpoe_anterior_w);

		delete	from cpoe_interacao
		where	nr_seq_mat_cpoe = nr_sequencia_p;

		delete	from cpoe_interacao
		where	nr_seq_mat_cpoe_interacao = nr_sequencia_p;

		delete	from cpoe_justificativa_item
		where	nr_seq_mat_interacao = nr_sequencia_p;

		delete	from cpoe_plan_protocol
		where 	nr_seq_mat_cpoe = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_material = nr_sequencia_p;

		delete FROM cpoe_trev
		where	coalesce(nr_seq_mat_cpoe, nr_seq_mat_cpoe_edit) = nr_sequencia_p;

		delete FROM cpoe_alternative_route
		where  nr_seq_mat_cpoe = nr_sequencia_p;

		delete FROM cpoe_tappering_dose
		where  nr_seq_mat_cpoe = nr_sequencia_p;

		delete FROM cpoe_variable_dose
		where  nr_seq_mat_cpoe = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_mat_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_material');

		delete
		from 	cpoe_material
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'P') then--Procedimento
		 delete
                from    proc_interno_doenca
                where   nr_seq_proc_cpoe = nr_sequencia_p;

    delete from CPOE_ANESTESISTA_DVT
        where nr_seq_anestesista in (SELECT  nr_sequencia from cpoe_proc_anestesista where nr_seq_proc_cpoe = nr_sequencia_p);

    delete
                from    cpoe_proc_anestesista
                where   nr_seq_proc_cpoe = nr_sequencia_p;


		select	max(nr_seq_agenda),
			max(nr_seq_lista_espera)
		into STRICT	nr_seq_agenda_w,
			nr_seq_lista_espera_w
		from	cpoe_procedimento
		where	nr_sequencia = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete	from cpoe_plan_protocol
		where 	nr_seq_exam_cpoe = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_exam_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_proced');

        open c_01(nr_sequencia_p);
        loop
          fetch c_01
            into nr_seq_agenda_daily_w, nr_seq_cpoe_proc_daily_w;
          EXIT WHEN NOT FOUND; /* apply on c_01 */
          begin

            delete from agenda_paciente_auxiliar
            where 	nr_seq_cpoe_procedimento = nr_seq_cpoe_proc_daily_w
            and nr_seq_agenda =  nr_seq_agenda_daily_w;

            delete from ageint_marcacao_usuario
            where nr_seq_ageint_item in ( SELECT nr_sequencia
                 from agenda_integrada_item
                 where nr_seq_agenda_exame = nr_seq_agenda_daily_w
             );

            delete from agenda_integrada_item
            where 	nr_seq_agenda_exame = nr_seq_agenda_daily_w;

            delete from agenda_paciente
            where 	nr_sequencia = nr_seq_agenda_daily_w;
          end;
        end loop;
        close c_01;

        open c_02(nr_sequencia_p);
        loop
          fetch c_02
            into nr_seq_agenda_consulta_w, nr_seq_cpoe_proc_consulta_w;
          EXIT WHEN NOT FOUND; /* apply on c_02 */
          begin

            delete from agenda_consulta_adic
            where 	nr_seq_cpoe_procedimento = nr_seq_cpoe_proc_consulta_w
            and nr_seq_agenda =  nr_seq_agenda_consulta_w;

            delete from ageint_marcacao_usuario
            where nr_seq_ageint_item in ( SELECT nr_sequencia
                 from agenda_integrada_item
                 where nr_seq_agenda_cons= nr_seq_agenda_consulta_w
             );

            delete from agenda_integrada_item
            where 	nr_seq_agenda_cons = nr_seq_agenda_consulta_w;

            delete from agenda_consulta
            where 	nr_sequencia = nr_seq_agenda_consulta_w;

            
          end;
        end loop;
        close c_02;

		delete from cpoe_procedimento
		where 	nr_seq_proc_princ = nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';

		delete FROM cpoe_revalidation_events
		where  nr_seq_exam = nr_sequencia_p;

		delete
		from 	cpoe_procedimento
		where  	nr_sequencia = nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';

		delete
		from 	cpoe_material
		where  	nr_seq_procedimento = nr_sequencia_p
		and	coalesce(dt_liberacao::text, '') = '';

		CALL cpoe_cancel_schedule_by_exam(nr_seq_agenda_w,nr_seq_lista_espera_w,null,nm_usuario_p);

	elsif (ie_tipo_item_p = 'G') then--Gasoterapia
		delete	from cpoe_plan_protocol
		where 	nr_seq_gaso_cpoe = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_gasotherapy = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_gaso_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_gasoterapia');

		delete
		from 	cpoe_gasoterapia
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'R') then--Recomendacao
		delete	from cpoe_plan_protocol
		where 	nr_seq_rec_cpoe = nr_sequencia_p;

		delete
		from 	w_kit_modificado
		where 	nr_seq_rec_cpoe = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_recomendation = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_rec_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_recomend');

		delete
		from 	cpoe_recomendacao
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'DP') then--Dialise peritoneal
		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_dialysis = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_dial_cpoe');

		delete
		from 	cpoe_dialise_perit
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'AP') then--Anatomia patologica
		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;
		
		delete	from cpoe_plan_protocol
        where   nr_seq_anat_cpoe = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_anat_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_anat_pat');

		delete
		from 	cpoe_anatomia_patologica
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'D' or ie_tipo_item_p = 'DI') then--Dialise
		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete	from cpoe_plan_protocol
		where 	nr_seq_dial_cpoe = nr_sequencia_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_dialysis = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_dial_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_dialise');

		delete
		from 	cpoe_dialise
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	elsif (ie_tipo_item_p = 'H') then--Hemoterapia
		delete	from cpoe_plan_protocol
		where 	nr_seq_hemo_cpoe = nr_sequencia_p;

		delete	from cpoe_inconsistency
		where	nr_seq_item = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = ''
		and		nm_usuario =	nm_usuario_p;

		delete FROM cpoe_revalidation_events
		where  nr_seq_hemotherapy = nr_sequencia_p;

		CALL cpoe_remover_item_inf_adic(nr_sequencia_p, 'nr_seq_hemo_cpoe');
		CALL cpoe_remover_comment_linkage(nr_sequencia_p,'nr_seq_cpoe_hemoterapia');

		delete
		from 	cpoe_hemoterapia
		where  	nr_sequencia = nr_sequencia_p
		and		coalesce(dt_liberacao::text, '') = '';

	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_remover_item ( ie_tipo_item_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

