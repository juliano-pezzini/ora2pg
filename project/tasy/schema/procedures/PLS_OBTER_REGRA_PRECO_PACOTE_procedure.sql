-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_preco_pacote ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_origem_p text, nr_seq_item_p bigint, nm_usuario_p text, nr_seq_pacote_p INOUT text, nr_seq_regra_preco_pac_p INOUT text) AS $body$
DECLARE


/* IE_ORIGEM_P
C -> Procedimento da conta -> pls_conta_proc
PI -> Procedimento da conta de Importacao XML (novo) -> pls_conta_item_imp
AA -> Procedimento da auditoria da autorizacao -> pls_auditoria_item
AR -> Procedimento da auditoria da requisicao -> pls_auditoria_item
E -> Execucao da Requisicao -> pls_execucao_req_item
G -> Guia/Autorizacao -> pls_guia_plano_proc
R -> Requisicao -> pls_requisicao_proc
pls_regra_lanc_aut_item
COMPL -> Complemento de guia -> ptu_ped_compl_aut_serv	
*/
nr_seq_regra_preco_pac_w		bigint	:= null;
nr_seq_pacote_w			bigint	:= null;
ie_regra_preco_w			varchar(3)	:= 'N';

cd_estabelecimento_w		smallint;
nr_seq_prestador_w		bigint;
nr_seq_tipo_acomod_w		bigint;
dt_pacote_w			timestamp;
ie_internado_w			varchar(3);
nr_seq_plano_w			bigint;
nr_contrato_w			bigint;
nr_seq_congenere_w		bigint;
ie_origem_conta_w		varchar(5);
ie_tipo_intercambio_w		varchar(5);
nr_seq_pacote_out_w		bigint;
nr_seq_regra_pacote_out_w	bigint;
cd_proc_pacote_out_w		bigint	:= null;
ie_origem_pacote_out_w		bigint	:= null;
vl_pacote_out_w			double precision	:= 0;
vl_medico_out_w			double precision	:= 0;
vl_anestesista_out_w		double precision	:= 0;
vl_auxiliares_out_w		double precision	:= 0;
vl_custo_operacional_out_w	double precision	:= 0;
vl_materiais_out_w		double precision	:= 0;
nr_seq_intercambio_w		bigint;
nr_seq_classificacao_prest_w	bigint;
nr_seq_procedimento_w		bigint;

nr_seq_conta_w			bigint;
dt_procedimento_w		timestamp;
nr_seq_prestador_conta_w	bigint;
nr_seq_protocolo_w		bigint;
dt_conta_guia_w			timestamp;
nr_seq_segurado_w		bigint;
cd_guia_w			varchar(30);
sg_estado_w			pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;
nr_seq_prestador_prot_w		bigint;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
ie_conta_medica_w		varchar(1);
dt_atendimento_referencia_w	timestamp;


BEGIN
ie_conta_medica_w := 'N';
/* Se nao passar o item, ira verificar apenas pelo codigo do procedimento, sem considerar regra de preco */

if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	if (ie_origem_p = 'C') then
		ie_conta_medica_w := 'S';
		select	a.nr_seq_conta,
			a.dt_procedimento
		into STRICT	nr_seq_conta_w,
			dt_procedimento_w
		from	pls_conta_proc a
		where	a.nr_sequencia	= nr_seq_item_p;
		
		dt_pacote_w := pls_obter_data_preco_item(nr_seq_item_p,'P');
		
		select	coalesce(nr_seq_prestador_exec,0),
			nr_seq_protocolo,
			cd_estabelecimento,
			nr_seq_tipo_acomodacao,
			coalesce(dt_atendimento_referencia, coalesce(dt_autorizacao, coalesce(dt_entrada, clock_timestamp()))),
			nr_seq_plano,
			substr(pls_obter_se_internado(nr_sequencia,'X'),1,1),
			nr_seq_segurado,
			coalesce(cd_guia,'X'),
			ie_origem_conta,
			dt_atendimento_referencia
		into STRICT	nr_seq_prestador_conta_w,
			nr_seq_protocolo_w,
			cd_estabelecimento_w,
			nr_seq_tipo_acomod_w,
			dt_conta_guia_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w,
			cd_guia_w,
			ie_origem_conta_w,
			dt_atendimento_referencia_w
		from	pls_conta
		where	nr_sequencia	= nr_seq_conta_w;
		
		/* Obter o prestador do protocolo */

		select	nr_seq_prestador
		into STRICT	nr_seq_prestador_prot_w
		from	pls_protocolo_conta
		where	nr_sequencia	= nr_seq_protocolo_w;

		if (nr_seq_prestador_conta_w	> 0) then
			nr_seq_prestador_w	:= nr_seq_prestador_conta_w;
		else
			nr_seq_prestador_w	:= nr_seq_prestador_prot_w;
		end if;
		
	elsif (ie_origem_p = 'PI') then
		-- Aqui obtem os dados da importacao nova pls_conta_item_imp e pls_conta_imp
		
		ie_conta_medica_w := 'S';
		
		-- no ie_origem_conta passo E por se tratar apenas de importacao XML / TISS quando entrar aqui

		-- pega os campos do procedimento e da conta, caso o prestador da conta nao esteja 

		-- identificado busca do protocolo

		-- pls_obter_se_internado tem alguns valores passados como NULL aqui porque ainda nao temos uma identificacao completa

		-- e nao sao valores utilizados neste momento
		select	c.dt_execucao,
			coalesce(a.nr_seq_prest_exec_conv, b.nr_seq_prestador_conv) nr_seq_prestador,
			a.cd_estabelecimento,
			null,
			
			pls_obter_produto_benef(
			(select max(x.nr_seq_plano)
			from	pls_segurado x
			where	x.nr_sequencia = a.nr_seq_segurado_conv),dt_atendimento_referencia_w) as nr_seq_plano,
			
--			(select max(x.nr_seq_plano)

--			from	pls_segurado x

--			where	x.nr_sequencia = a.nr_seq_segurado_conv) nr_seq_plano,
			
			pls_obter_se_internado(	null, 'X', b.ie_tipo_guia, a.nr_seq_tipo_atend_conv, null, null, 'N',
				a.ie_regime_atendimento, a.ie_saude_ocupacional, a.dt_atendimento),
			a.nr_seq_segurado_conv,
			'E' ie_origem_conta
		into STRICT	dt_pacote_w,
			nr_seq_prestador_w,
			cd_estabelecimento_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w,
			ie_origem_conta_w
		from	pls_conta_item_imp c,
			pls_conta_imp a,
			pls_protocolo_conta_imp b
		where	c.nr_sequencia = nr_seq_item_p
		and	a.nr_sequencia = c.nr_seq_conta
		and	b.nr_sequencia = a.nr_seq_protocolo;
	
	elsif (ie_origem_p = 'AA') then
		/*Obter dados do procedimento*/

		select	a.nr_seq_guia
		into STRICT	nr_seq_guia_w
		from	pls_auditoria_item	b,
			pls_auditoria		a			
		where	b.nr_sequencia	= nr_seq_item_p
		and	a.nr_sequencia	= b.nr_seq_auditoria;
		
		/*Obter dados da guia*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_solicitacao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'A'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	elsif (ie_origem_p = 'AR') then
		/*Obter dados do procedimento*/

		select	a.nr_seq_requisicao
		into STRICT	nr_seq_requisicao_w
		from	pls_auditoria_item	b,
			pls_auditoria		a			
		where	b.nr_sequencia	= nr_seq_item_p
		and	a.nr_sequencia	= b.nr_seq_auditoria;
		
		/*Obter dados da requisicao*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_requisicao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'R'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;
		
		if (coalesce(nr_seq_tipo_acomod_w::text, '') = '') then
			nr_seq_tipo_acomod_w := pls_obter_dados_produto(nr_seq_plano_w,'AP');
		end if;
	elsif (ie_origem_p = 'E') then
		/*Obter dados do procedimento*/

		select	nr_seq_requisicao
		into STRICT	nr_seq_requisicao_w
		from	pls_execucao_req_item
		where	nr_sequencia	= nr_seq_item_p;
		
		/*Obter dados da guia*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_requisicao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'R'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;
		
		if (coalesce(nr_seq_tipo_acomod_w::text, '') = '') then
			nr_seq_tipo_acomod_w := pls_obter_dados_produto(nr_seq_plano_w,'AP');
		end if;
	elsif (ie_origem_p = 'G') then
		/*Obter dados do procedimento*/

		select	nr_seq_guia
		into STRICT	nr_seq_guia_w
		from	pls_guia_plano_proc
		where	nr_sequencia	= nr_seq_item_p;
		
		/*Obter dados da guia*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_solicitacao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'A'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
		
	elsif (ie_origem_p = 'R') then
		/*Obter dados do procedimento*/

		select	nr_seq_requisicao
		into STRICT	nr_seq_requisicao_w
		from	pls_requisicao_proc
		where	nr_sequencia	= nr_seq_item_p;
		
		/*Obter dados da guia*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_requisicao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'R'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;
		
		if (coalesce(nr_seq_tipo_acomod_w::text, '') = '') then
			nr_seq_tipo_acomod_w := pls_obter_dados_produto(nr_seq_plano_w,'AP');
		end if;		
		
	elsif (ie_origem_p = 'COMPL') then
		/*Obter dados do procedimento*/

		select	a.nr_seq_guia
		into STRICT	nr_seq_guia_w
		from	ptu_pedido_compl_aut_serv	b,
			ptu_pedido_compl_aut		a
		where	b.nr_sequencia	= nr_seq_item_p
		and	b.nr_seq_pedido	= a.nr_sequencia;
		
		/*Obter dados da guia*/

		select	nr_seq_prestador,
			cd_estabelecimento,
			dt_solicitacao,
			nr_seq_tipo_acomodacao,
			nr_seq_plano,
			pls_obter_internado_guia(nr_sequencia,'A'),
			nr_seq_segurado
		into STRICT	nr_seq_prestador_w,
			cd_estabelecimento_w,
			dt_pacote_w,
			nr_seq_tipo_acomod_w,
			nr_seq_plano_w,
			ie_internado_w,
			nr_seq_segurado_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	end if;
	
	/* Dados validos para todos os tipos */

	if (coalesce(nr_seq_plano_w,0) = 0) then		
		begin
		select	a.nr_seq_plano
		into STRICT	nr_seq_plano_w
		from	pls_segurado			a	
		where	a.nr_sequencia = nr_seq_segurado_w;	
		exception
		when others then
			nr_seq_plano_w := null;
		end;
	end if;
	
	begin
	select	coalesce(a.nr_contrato,0),
		b.nr_seq_congenere
	into STRICT	nr_contrato_w,
		nr_seq_congenere_w
	from	pls_contrato	a,
		pls_segurado	b
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.nr_sequencia	= nr_seq_segurado_w;
	exception
	when others then
		nr_contrato_w	:= 0;
	end;
	
	if (coalesce(nr_seq_congenere_w::text, '') = '') then
		begin
		select	b.nr_seq_congenere
		into STRICT	nr_seq_congenere_w
		from	pls_segurado	b
		where	b.nr_sequencia	= nr_seq_segurado_w;
		exception
		when others then
			nr_seq_congenere_w	:= null;
		end;
	end if;
	
	select	max(nr_seq_intercambio)
	into STRICT	nr_seq_intercambio_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_w;
	
	select	max(nr_seq_classificacao)
	into STRICT	nr_seq_classificacao_prest_w
	from	pls_prestador
	where	nr_sequencia = nr_seq_prestador_w;
	
	select	coalesce(max(sg_estado),'X')
	into STRICT	sg_estado_w
	from	pessoa_juridica
	where	cd_cgc	= (	SELECT	max(cd_cgc_outorgante)
				from	pls_outorgante
				where	cd_estabelecimento	= cd_estabelecimento_w);
	select	coalesce(max(a.sg_estado),'X')
	into STRICT	sg_estado_int_w
	from	pessoa_juridica	a,
		pls_congenere	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_sequencia	= nr_seq_congenere_w;

	if (sg_estado_w <> 'X') and (sg_estado_int_w <> 'X') then
		if (sg_estado_w	= sg_estado_int_w) then
			ie_tipo_intercambio_w	:= 'E';
		else	
			ie_tipo_intercambio_w	:= 'N';
		end if;
	else
		ie_tipo_intercambio_w	:= 'A';
	end if;

	SELECT * FROM pls_define_preco_pacote(cd_estabelecimento_w, nr_seq_prestador_w, nr_seq_tipo_acomod_w, dt_pacote_w, cd_procedimento_p, ie_origem_proced_p, ie_internado_w, nr_seq_plano_w, nr_contrato_w, nr_seq_congenere_w, nm_usuario_p, ie_origem_conta_w, ie_tipo_intercambio_w, nr_seq_pacote_out_w, nr_seq_regra_pacote_out_w, cd_proc_pacote_out_w, ie_origem_pacote_out_w, vl_pacote_out_w, vl_medico_out_w, vl_anestesista_out_w, vl_auxiliares_out_w, vl_custo_operacional_out_w, vl_materiais_out_w, nr_seq_intercambio_w, nr_seq_classificacao_prest_w, nr_seq_procedimento_w, nr_seq_segurado_w, null, ie_conta_medica_w, null, 1) INTO STRICT nr_seq_pacote_out_w, nr_seq_regra_pacote_out_w, cd_proc_pacote_out_w, ie_origem_pacote_out_w, vl_pacote_out_w, vl_medico_out_w, vl_anestesista_out_w, vl_auxiliares_out_w, vl_custo_operacional_out_w, vl_materiais_out_w;
				
	nr_seq_regra_preco_pac_w	:= nr_seq_regra_pacote_out_w;
	
	/* Obter pacote */

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_pacote_w
	from	pls_pacote a
	where	a.ie_situacao	= 'A'
	and	a.cd_procedimento	= cd_procedimento_p
	and	a.ie_origem_proced	= ie_origem_proced_p;
	
	if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then
		/* Verificar se e considerado como pacote apenas atraves da regra de preco */

		select	coalesce(ie_regra_preco,'N')
		into STRICT	ie_regra_preco_w
		from	pls_pacote a
		where	a.nr_sequencia	= nr_seq_pacote_w;
		
		if (ie_regra_preco_w = 'S') and (coalesce(nr_seq_regra_pacote_out_w::text, '') = '') then
			nr_seq_pacote_w		:= null;
		end if;
	end if;
end if;

nr_seq_pacote_p			:= nr_seq_pacote_w;
nr_seq_regra_preco_pac_p	:= nr_seq_regra_preco_pac_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_preco_pacote ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_origem_p text, nr_seq_item_p bigint, nm_usuario_p text, nr_seq_pacote_p INOUT text, nr_seq_regra_preco_pac_p INOUT text) FROM PUBLIC;

