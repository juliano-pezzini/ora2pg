-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_atend_hist_paciente ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_item_p bigint, cd_item_exp_p bigint DEFAULT 0, dt_diagnostico_p timestamp DEFAULT NULL, cd_doenca_p text DEFAULT NULL, nr_atend_acomp_p text DEFAULT NULL, nr_seq_agenda_p bigint DEFAULT 0, nr_seq_comp_p bigint DEFAULT 0, nr_seq_group_p bigint DEFAULT 0, ds_coluna_p text DEFAULT NULL, ds_previous_status_p text DEFAULT NULL) AS $body$
DECLARE

    nr_sequencia_w                      tipo_historico_atendimento.nr_sequencia%TYPE;
    ds_obs_w                            varchar(4000);
    nr_seq_hist_w                       atendimento_hist_paciente.nr_sequencia%TYPE;
    nr_seq_ahpct_w                      atend_hist_pac_change_type.nr_sequencia%TYPE;
    ds_obs_atend_hist_pac_w             varchar(4000);
    ds_create_change_case_w             varchar(1);
    nr_seq_record_w                     bigint;
    nr_exp_cons_serv_w                  bigint;


BEGIN
    SELECT
        MAX(nr_sequencia)
    INTO STRICT nr_sequencia_w
    FROM
        tipo_historico_atendimento
    WHERE
        coalesce(ie_tipo_alterar_case, 'N') = 'S'
        AND coalesce(ie_situacao, null) = 'A';

        ds_obs_atend_hist_pac_w := null;
        ds_create_change_case_w := 'N';

    IF ( cd_item_p = 1 ) THEN
        SELECT
            concat(obter_desc_expressao(671494)
                   || ': '
                   || obter_nome_agenda(ap.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ap.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' seq: '
                                                       || ap.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_paciente   ap
        WHERE
            a.cd_agenda = ap.cd_agenda
            AND ap.nr_sequencia = nr_seq_agenda_p
            AND a.cd_tipo_agenda = cd_item_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_agenda_p;
        ds_obs_atend_hist_pac_w := concat('status: ', trim(both ds_previous_status_p) || '%%%');

    ELSIF ( cd_item_p = 2 ) THEN
        SELECT
            concat(obter_desc_expressao(317519)
                   || ': '
                   || obter_nome_agenda(ap.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ap.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' seq: '
                                                       || ap.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_paciente   ap
        WHERE
            a.cd_agenda = ap.cd_agenda
            AND ap.nr_sequencia = nr_seq_agenda_p
            AND a.cd_tipo_agenda = cd_item_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_agenda_p;
        ds_obs_atend_hist_pac_w := concat('status: ', trim(both ds_previous_status_p) || '%%%');

    ELSIF ( cd_item_p = 3 ) THEN
        SELECT
            concat(obter_desc_expressao(308862)
                   || ': '
                   || obter_nome_agenda(ac.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ac.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' seq: '
                                                       || ac.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_consulta   ac
        WHERE
            a.cd_agenda = ac.cd_agenda
            AND ac.nr_sequencia = nr_seq_agenda_p
            AND a.cd_tipo_agenda = cd_item_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_agenda_p;
        ds_obs_atend_hist_pac_w := concat('status: ', trim(both ds_previous_status_p) || '%%%');

    ELSIF ( cd_item_p = 5 ) THEN
        SELECT
            concat(obter_desc_expressao(308324)
                   || ': '
                   || obter_nome_agenda(ac.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ac.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' seq: '
                                                       || ac.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_consulta   ac
        WHERE
            a.cd_agenda = ac.cd_agenda
            AND ac.nr_sequencia = nr_seq_agenda_p
            AND a.cd_tipo_agenda = cd_item_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_agenda_p;
        ds_obs_atend_hist_pac_w := concat('status: ', trim(both ds_previous_status_p) || '%%%');

    ELSIF ( cd_item_p = 10 ) THEN
        SELECT
            max(concat(obter_desc_expressao(315963),
                ': '
                || coalesce(trim(both concat(substr(obter_nome_setor(gv.cd_setor_desejado), 1, 100), ' ' || substr(obter_desc_tipo_acomod(gv.cd_tipo_acomod_desej), 1, 100))), obter_desc_expressao(309956))
                || ' - '
                || coalesce(gv.cd_unidade_basica, obter_desc_expressao(309956))
                || ' - '
                || coalesce(gv.cd_unidade_compl, obter_desc_expressao(309956))))
        INTO STRICT ds_obs_w
        FROM
            gestao_vaga gv
        WHERE
            gv.nr_atendimento = nr_atendimento_p
            and gv.nr_sequencia = nr_seq_agenda_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_agenda_p;
        ds_obs_atend_hist_pac_w := concat('status: ', trim(both ds_previous_status_p) || '%%%');

    ELSIF ( cd_item_p = 11 ) THEN
        SELECT
            concat(obter_desc_expressao(856607)
                   || ': '
                   || dt_diagnostico, ' - '
                                      || cd_doenca
                                      || ' - '
                                      || trim(both substr(obter_desc_cid(cd_doenca), 1, 200))
                                      || ' - '
                                      || obter_desc_expressao(cd_item_exp_p))
        INTO STRICT ds_obs_w
        FROM
            diagnostico_doenca
        WHERE
            trim(both cd_doenca) = trim(both cd_doenca_p)
            AND trunc(dt_diagnostico) = trunc(dt_diagnostico_p)
            AND nr_atendimento = nr_atendimento_p;

        ds_obs_atend_hist_pac_w := concat('column: ', ds_coluna_p || '%%%cd_doenca: ' || trim(both cd_doenca_p) || '%%%date: ' || to_char(dt_diagnostico_p, 'dd/mm/yyyy hh24:mi:ss') || '%%%');
        ds_create_change_case_w := 'S';

    ELSIF ( cd_item_p = 12 ) THEN
        SELECT
            concat(obter_desc_expressao(283172)
                   || ': '
                   || obter_nome_pessoa_fisica(ap.cd_pessoa_fisica, null), ' - '
                                                                         || obter_desc_expressao(668979)
                                                                         || ': '
                                                                         || ap.nr_seq_episodio)
        INTO STRICT ds_obs_w
        FROM
            atendimento_paciente ap
        WHERE
            ap.nr_atendimento = nr_atend_acomp_p;

        ds_create_change_case_w := 'S';
        nr_seq_record_w         := nr_seq_comp_p;

    ELSIF ( cd_item_p = 13 ) THEN
        SELECT
            concat(obter_desc_expressao(495048)
                   || ': '
                   || obter_nome_pessoa_fisica(ap.cd_pessoa_fisica, null), ' - '
                                                                         || obter_desc_expressao(885346)
                                                                         || ': '
                                                                         || ap.nr_atendimento)
        INTO STRICT ds_obs_w
        FROM
            atendimento_paciente ap
        WHERE
            ap.nr_atendimento = nr_atendimento_p;

        ds_create_change_case_w := 'S';

    ELSIF ( cd_item_p = 14 ) THEN
        SELECT
            concat(obter_desc_expressao(1059571)
                   || ': '
                   || obter_nome_pessoa_fisica(ap.cd_pessoa_fisica, null), ' - '
                                                                         || obter_desc_expressao(668979)
                                                                         || ': '
                                                                         || ap.nr_seq_episodio)
        INTO STRICT ds_obs_w
        FROM
            atendimento_paciente ap
        WHERE
            ap.nr_atendimento = nr_atendimento_p;

        ds_create_change_case_w := 'S';

    ELSIF ( cd_item_p = 16 ) THEN
        SELECT concat(obter_desc_expressao(1067132),
                        ' SEQ : '
                   || nr_seq_episodio)
        INTO STRICT ds_obs_w
        FROM atendimento_paciente ap
        WHERE ap.nr_atendimento = 3468294;

    ELSIF ( cd_item_p = 17 ) THEN
        SELECT concat(obter_desc_expressao(1067138),
                        ' SEQ : '
                   || nr_atendimento)
        INTO STRICT ds_obs_w
        FROM atendimento_paciente ap
        WHERE ap.nr_atendimento = 3468294;

    ELSIF ( cd_item_p = 18 ) THEN

        SELECT
            concat(obter_desc_expressao(1067140)
                   || ': '
                   || obter_nome_agenda(ap.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ap.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' SEQ : '
                                                       || ap.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_paciente   ap
        WHERE
            a.cd_agenda = ap.cd_agenda
            AND ap.nr_sequencia = nr_seq_agenda_p;

    ELSIF ( cd_item_p = 19 ) THEN

        SELECT
            concat(obter_desc_expressao(1067144)
                   || ': '
                   || obter_nome_agenda(ap.cd_agenda), ' '
                                                       || pkg_date_formaters_tz.to_varchar(ap.dt_agenda, 'timestamp', establishment_timezone_utils
                                                       .gettimezone)
                                                       || ' seq: '
                                                       || ap.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
            agenda            a,
            agenda_paciente   ap
        WHERE
            a.cd_agenda = ap.cd_agenda
            AND ap.nr_sequencia = nr_seq_agenda_p;

    ELSIF ( cd_item_p = 20 ) THEN

        SELECT max(a.cd_tipo_agenda)
        INTO STRICT nr_exp_cons_serv_w
        FROM
                agenda            a,
                agenda_consulta   ac
        WHERE
                a.cd_agenda = ac.cd_agenda
                AND ac.nr_sequencia = nr_seq_agenda_p;

        IF (nr_exp_cons_serv_w = 3) THEN

                nr_exp_cons_serv_w := 1067146;

        ELSE
                nr_exp_cons_serv_w := 1067148;

        END IF;

        SELECT
                concat(obter_desc_expressao(nr_exp_cons_serv_w)
                        || ': '
                        || obter_nome_agenda(ac.cd_agenda), ' '
                                                        || pkg_date_formaters_tz.to_varchar(ac.dt_agenda, 'timestamp', establishment_timezone_utils
                                                        .gettimezone)
                                                        || ' seq: '
                                                        || ac.nr_sequencia)
        INTO STRICT ds_obs_w
        FROM
                agenda            a,
                agenda_consulta   ac
        WHERE
                a.cd_agenda = ac.cd_agenda
                AND ac.nr_sequencia = nr_seq_agenda_p;

    ELSIF ( cd_item_p = 21 ) THEN

        SELECT
                concat(obter_desc_expressao(1067150),
                        ': '
                        || obter_nome_pessoa_fisica(ap.cd_pessoa_fisica, null)
                        || ' - '
                        || obter_desc_expressao(668979)
                        || ': '
                        || ap.nr_seq_episodio
                )
        INTO STRICT ds_obs_w
        FROM
            atendimento_paciente ap,
            episodio_acompanhante eap
        WHERE
            ap.nr_atendimento = eap.NR_ATEND_ACOMPANHANTE
            and eap.nr_sequencia = nr_seq_comp_p;

    ELSIF ( cd_item_p = 22 ) THEN

        SELECT concat(obter_desc_expressao(1067152),
                                ': '
                                || dt_diagnostico
                                || ' - '
                                || cd_doenca
                                || ' - '
                                || trim(both substr(obter_desc_cid(cd_doenca), 1, 200))
                                || ' - '
                                || obter_desc_expressao(cd_item_exp_p))
        INTO STRICT ds_obs_w
        FROM
            diagnostico_doenca
        WHERE
            trim(both cd_doenca) = trim(both cd_doenca_p)
            AND trunc(dt_diagnostico) = trunc(dt_diagnostico_p)
            AND nr_atendimento = nr_atendimento_p;

     ELSIF ( cd_item_p = 23 ) THEN

        SELECT
            max(concat(obter_desc_expressao(1067154),
                ': '
                || COALESCE(trim(both concat(substr(obter_nome_setor(gv.cd_setor_desejado), 1, 100), ' ' || substr(obter_desc_tipo_acomod(gv.cd_tipo_acomod_desej), 1, 100))), obter_desc_expressao(309956))
                || ' - '
                || COALESCE(gv.cd_unidade_basica, obter_desc_expressao(309956))
                || ' - '
                || COALESCE(gv.cd_unidade_compl, obter_desc_expressao(309956))))
        INTO STRICT ds_obs_w
        FROM
            gestao_vaga gv
        WHERE
            gv.nr_atendimento = nr_atendimento_p
            and gv.nr_sequencia = nr_seq_agenda_p;

    END IF;

    select nextval('atendimento_hist_paciente_seq')
    into STRICT nr_seq_hist_w
;

    INSERT INTO atendimento_hist_paciente(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_historico,
        nr_atendimento,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_seq_tipo_historico,
        ds_observacao,
        dt_liberacao,
        dt_inativacao,
        nm_usuario_inativacao,
        nm_usuario_liberacao
    ) VALUES (
        nr_seq_hist_w,
        clock_timestamp(),
        wheb_usuario_pck.get_nm_usuario,
        clock_timestamp(),
        nr_atendimento_p,
        clock_timestamp(),
        wheb_usuario_pck.get_nm_usuario,
        nr_sequencia_w,
        ds_obs_w,
        clock_timestamp(),
        NULL,
        NULL,
        wheb_usuario_pck.get_nm_usuario
    );


    IF ds_create_change_case_w = 'S' THEN

        SELECT nextval('atend_hist_pac_change_type_seq')
        INTO STRICT nr_seq_ahpct_w
;

        INSERT INTO ATEND_HIST_PAC_CHANGE_TYPE(
                NR_SEQUENCIA,
                DT_ATUALIZACAO,
                NM_USUARIO,
                DT_ATUALIZACAO_NREC,
                NM_USUARIO_NREC,
                NR_SEQ_HISTORICO,
                NR_SEQ_REGISTRO,
                NR_SEQ_AGRUP,
                IE_TIPO_REGISTRO,
                DS_OBSERVACAO
        ) VALUES (
                nr_seq_ahpct_w,
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                nr_seq_hist_w,
                nr_seq_record_w,
                nr_seq_group_p,
                cd_item_p,
                ds_obs_atend_hist_pac_w
        );

    END IF;

    COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_atend_hist_paciente ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_item_p bigint, cd_item_exp_p bigint DEFAULT 0, dt_diagnostico_p timestamp DEFAULT NULL, cd_doenca_p text DEFAULT NULL, nr_atend_acomp_p text DEFAULT NULL, nr_seq_agenda_p bigint DEFAULT 0, nr_seq_comp_p bigint DEFAULT 0, nr_seq_group_p bigint DEFAULT 0, ds_coluna_p text DEFAULT NULL, ds_previous_status_p text DEFAULT NULL) FROM PUBLIC;

