-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_vinculo_item_problema ( nr_seq_listas_vinc_p text, cd_diagnostico_p text, nr_seq_reg_origem_p text, ie_tipo_reg_item_p text, nm_tabela_p text) AS $body$
DECLARE
	
 
	ds_list_problema_vincular_w varchar(1000);
	nr_pos_virgula_w			integer;
	nr_seq_problema_w			lista_problema_pac_item.nr_seq_problema%type;
	cd_diagnostico_w			lista_problema_pac_item.ie_tipo_problema%type;

BEGIN
	cd_diagnostico_w := cd_diagnostico_p;
	 
	if (ie_tipo_reg_item_p = 'DE' and coalesce(cd_diagnostico_w::text, '') = '') then 
		select	max(b.nr_seq_diag) 
		into STRICT 	cd_diagnostico_w 
		from	pe_prescricao a, pe_prescr_diag b 
		where	b.nr_seq_prescr = a.nr_sequencia 
		and		a.nr_sequencia = nr_seq_reg_origem_p;
	end if;
	 
	if ((nr_seq_listas_vinc_p IS NOT NULL AND nr_seq_listas_vinc_p::text <> '') and ((cd_diagnostico_w IS NOT NULL AND cd_diagnostico_w::text <> '') or ie_tipo_reg_item_p = 'EI') and 
		(nr_seq_reg_origem_p IS NOT NULL AND nr_seq_reg_origem_p::text <> '') and 
		(ie_tipo_reg_item_p IS NOT NULL AND ie_tipo_reg_item_p::text <> '') and 
		(nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '')) then 
	 
		ds_list_problema_vincular_w := nr_seq_listas_vinc_p;
	 
		if (substr(ds_list_problema_vincular_w, length(ds_list_problema_vincular_w)) <> ',') then 
			ds_list_problema_vincular_w := ds_list_problema_vincular_w ||',';
		end if;
		 
		while(ds_list_problema_vincular_w IS NOT NULL AND ds_list_problema_vincular_w::text <> '') loop 
		begin 
			 
			nr_pos_virgula_w := position(',' in ds_list_problema_vincular_w);
			 
			if (nr_pos_virgula_w <> 0) then 
				nr_seq_problema_w			:= substr(ds_list_problema_vincular_w, 1, (nr_pos_virgula_w - 1));
				ds_list_problema_vincular_w	:= substr(ds_list_problema_vincular_w, (nr_pos_virgula_w + 1), length(ds_list_problema_vincular_w));
			end if;
			 
			if (nr_seq_problema_w IS NOT NULL AND nr_seq_problema_w::text <> '') then 
				 
				insert into lista_problema_pac_item( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_problema, 
					ie_tipo_problema, 
					nr_seq_registro, 
					ie_tipo_registro, 
					nm_tabela 
					) values ( 
					nextval('lista_problema_pac_item_seq'), 
					clock_timestamp(), 
					wheb_usuario_pck.get_nm_usuario, 
					clock_timestamp(), 
					wheb_usuario_pck.get_nm_usuario, 
					nr_seq_problema_w, 
					cd_diagnostico_w, 
					nr_seq_reg_origem_p, 
					ie_tipo_reg_item_p, 
					nm_tabela_p 
					);
				 
				commit;
					 
			end if;
		end;
		end loop;
	 
	end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_vinculo_item_problema ( nr_seq_listas_vinc_p text, cd_diagnostico_p text, nr_seq_reg_origem_p text, ie_tipo_reg_item_p text, nm_tabela_p text) FROM PUBLIC;

