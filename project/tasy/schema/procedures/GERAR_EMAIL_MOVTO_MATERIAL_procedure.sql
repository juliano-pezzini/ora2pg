-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_email_movto_material ( nr_movimento_estoque_p bigint, cd_material_p bigint, cd_acao_p text, cd_operacao_estoque_p bigint, ie_origem_documento_p text, cd_local_estoque_p bigint, cd_local_estoque_destino_p bigint, cd_setor_atendimento_p bigint, dt_movimento_estoque_p timestamp, qt_movimento_p bigint, qt_estoque_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_grupo_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
nr_regras_w			bigint;
ds_assunto_w			varchar(255);
ds_mensagem_padrao_w		varchar(4000);
ds_email_destino_w			varchar(2000);
ds_material_w			varchar(255);
ds_acao_w			varchar(100);
ds_operacao_w			varchar(100);
ds_origem_doc_w			varchar(100);
ds_local_w			varchar(100);
ds_local_dest_w			varchar(100);
ds_setor_w			varchar(100);
ie_classif_custo_w		varchar(1);
ds_familia_mat_w		varchar(255);
nr_seq_familia_w		bigint;


c01 CURSOR FOR
	SELECT	ds_email_destino,
		ds_assunto,
		ds_mensagem_padrao
	from	regra_envio_email_material
	where	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
	and	coalesce(cd_material, cd_material_p)			= cd_material_p
	and	coalesce(nr_seq_familia,nr_seq_familia_w)		= nr_seq_familia_w
	and	ie_tipo_mensagem = 6
	and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
	order by 	coalesce(cd_grupo_material, 0),
		coalesce(cd_subgrupo_material, 0),
		coalesce(cd_classe_material, 0),
		coalesce(cd_material, 0),
		coalesce(ie_tipo_mensagem,0);


BEGIN

select	count(*)
into STRICT	nr_regras_w
from 	regra_envio_email_material
where	ie_tipo_mensagem = 6
and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p));

if (nr_regras_w > 0) then
	begin
	if (cd_material_p > 0) and (nr_movimento_estoque_p > 0) then

		select	coalesce(max(ie_classif_custo),'B')
		into STRICT	ie_classif_custo_w
		from	material_estab
		where	cd_estabelecimento = cd_estabelecimento_p
		and	cd_material = cd_material_p;

		if (ie_classif_custo_w = 'A') then

			select	substr(obter_desc_material(cd_material_p),1,255),
				substr(obter_valor_dominio(20,cd_acao_p),1,100) ds_acao,
				substr(obter_desc_operacao_estoque(cd_operacao_estoque_p),1,100) ds_operacao,
				substr(obter_valor_dominio(23,ie_origem_documento_p),1,100) ds_origem_doc,
				substr(obter_desc_local_estoque(cd_local_estoque_p),1,100) ds_local,
				substr(obter_desc_local_estoque(cd_local_estoque_destino_p),1,100) ds_local_dest,
				substr(obter_nome_setor(cd_Setor_atendimento_p),1,100) ds_setor,
				substr(OBTER_DESC_FAMILIA_MAT(nr_seq_familia_w),1,150)ds_familia_mat
			into STRICT	ds_material_w,
				ds_acao_w,
				ds_operacao_w,
				ds_origem_doc_w,
				ds_local_w,
				ds_local_dest_w,
				ds_setor_w,
				ds_familia_mat_w
			;

			select	coalesce(max(cd_grupo_material),0),
				coalesce(max(cd_subgrupo_material),0),
				coalesce(max(cd_classe_material),0),
				coalesce(max(nr_seq_familia), 0)
			into STRICT	cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				nr_seq_familia_w
			from	estrutura_material_v
			where 	cd_material = cd_material_p;

			open C01;
			loop
			fetch C01 into
				ds_email_destino_w,
				ds_assunto_w,
				ds_mensagem_padrao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin

				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@DESCMAT',ds_material_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@CODMAT',cd_material_p);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@ACAO',ds_acao_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@OPERACAO',ds_operacao_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@ORIGEMDOC',ds_origem_doc_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@LOCALESTOQUE',ds_local_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@LOCALDESTINO',ds_local_dest_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@SETOR',ds_setor_w);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@DTMOVIMENTO',dt_movimento_estoque_p);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@NRMOVIMENTO',nr_movimento_estoque_p);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@USUARIO',nm_usuario_p);
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@QTMOVIMENTO',campo_mascara_virgula_casas(qt_movimento_p,4));
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@QTESTOQUE',campo_mascara_virgula_casas(qt_estoque_p,4));
				ds_mensagem_padrao_w	:= replace_macro(ds_mensagem_padrao_w,'@DESCFAMILIAMAT',ds_familia_mat_w);


				if (coalesce(ds_email_destino_w,'X') <> 'X')  then
					CALL enviar_email(
						ds_assunto_w,
						ds_mensagem_padrao_w,
						null,
						ds_email_destino_w,
						nm_usuario_p,
						'M');
				end if;
				end;
			end loop;
			close C01;
		end if;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_email_movto_material ( nr_movimento_estoque_p bigint, cd_material_p bigint, cd_acao_p text, cd_operacao_estoque_p bigint, ie_origem_documento_p text, cd_local_estoque_p bigint, cd_local_estoque_destino_p bigint, cd_setor_atendimento_p bigint, dt_movimento_estoque_p timestamp, qt_movimento_p bigint, qt_estoque_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

