-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_impressao_ap_lote ( nr_seq_lote_p bigint, nm_usuario_p text, opcao_p bigint default null) AS $body$
DECLARE


ie_prescr_vigente_w	varchar(1) := 'S';


BEGIN

select	coalesce(max(obter_se_prescr_vigente(a.nr_prescricao)), 'S')
into STRICT	ie_prescr_vigente_w
from	prescr_medica a,
	ap_lote b
where	a.nr_prescricao = b.nr_prescricao
and	b.nr_sequencia = nr_seq_lote_p;

CALL gravar_log_tasy(1812, ' nr_seq_lote_p=' || nr_seq_lote_p || ' ie_prescr_vigente_w='|| ie_prescr_vigente_w || ' opcao_p=' || opcao_p,'tasy321');

if (ie_prescr_vigente_w = 'S') or (coalesce(opcao_p,0) = 0) then

	update	ap_lote
	set	dt_impressao	 = NULL,
		ds_maquina_imp_aqui = '',
		dt_impressao_aqui  = NULL,
		nm_usuario_imp_aqui = ''
	where	nr_sequencia	= nr_seq_lote_p;

	insert into ap_lote_historico(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_lote,
			ds_evento,
			ds_log)
		values (	nextval('ap_lote_historico_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_lote_p,
			wheb_mensagem_pck.get_Texto(311437), /*'Impressão desfeita',*/
			wheb_mensagem_pck.get_Texto(311437));/*'Impressão desfeita',*/
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_impressao_ap_lote ( nr_seq_lote_p bigint, nm_usuario_p text, opcao_p bigint default null) FROM PUBLIC;

