-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_refresh_object_pendencies ( nr_service_order_p reg_object_log.nr_service_order%TYPE, nm_usuario_p reg_service_order_pr.nm_usuario%TYPE ) AS $body$
DECLARE


	changed_objs_c CURSOR(nr_service_order_pp reg_object_log.nr_service_order%TYPE) FOR
	SELECT	coalesce(nr_seq_obj_schematic, nr_seq_dic_obj) nr_seq_obj,
		CASE coalesce(nr_seq_obj_schematic, 0)
			WHEN 0
			THEN 'O'
			ELSE 'S'
		END ie_object_type
	FROM reg_object_log
	WHERE nr_service_order = nr_service_order_pp
	GROUP BY coalesce(nr_seq_obj_schematic, nr_seq_dic_obj),
		CASE coalesce(nr_seq_obj_schematic, 0)
			WHEN 0
			THEN 'O'
			ELSE 'S'
		END;

	ie_deteted_w		varchar(255)	:= 'N';
	ie_object_operation_w	varchar(1)	:= 'X';
	first_operation_id_w	varchar(1)	:= 'X';
	ds_obj_field_w		varchar(30);
	nr_seq_product_req_w	reg_product_dic.nr_seq_product_requirement%TYPE;


BEGIN
	FOR obj in changed_objs_c(nr_service_order_p) LOOP

		IF	obj.ie_object_type = 'O' THEN
			ds_obj_field_w := 'nr_seq_dic_obj';
		ELSE
			ds_obj_field_w := 'nr_seq_obj_schematic';
		END IF;

		ie_deteted_w := obter_valor_dinamico_char_bv(
		'SELECT	CASE NVL(MAX(l.operation_id), ''X'') WHEN ''D'' THEN ''S'' ELSE ''N'' END
		FROM	reg_object_log l
		WHERE	l.'||ds_obj_field_w||' = :nr_seq_obj
		AND	l.operation_id = ''D''
		AND	l.nr_service_order = :nr_service_order ', 'nr_seq_obj='||obj.nr_seq_obj||',nr_service_order='||nr_service_order_p, ie_deteted_w);

		SELECT	MAX(nr_seq_product_requirement)
		INTO STRICT	nr_seq_product_req_w
		FROM	reg_product_dic
		WHERE	nr_seq_objeto = obj.nr_seq_obj
		AND	ie_tipo_objeto = obj.ie_object_type;

		IF	ie_deteted_w = 'S' THEN
			IF	(nr_seq_product_req_w IS NOT NULL AND nr_seq_product_req_w::text <> '') THEN
				ie_object_operation_w := 'D';
			ELSE
				ie_object_operation_w := 'X';
			END IF;
		ELSE
			SELECT	MAX(l.operation_id)
			INTO STRICT	first_operation_id_w
			FROM	reg_object_log l
			WHERE	l.nr_seq_obj_schematic = obj.nr_seq_obj
			AND	l.nr_service_order = nr_service_order_p
			AND	l.dt_atualizacao = (SELECT MIN(a.dt_atualizacao) FROM reg_object_log a WHERE a.nr_seq_obj_schematic = l.nr_seq_obj_schematic AND a.nr_service_order = l.nr_service_order);

			IF	first_operation_id_w = 'I' THEN
				ie_object_operation_w := 'I';
			ELSE
				ie_object_operation_w := 'U';
			END IF;
		END IF;

		IF	ie_object_operation_w <> 'X' THEN
			INSERT INTO reg_service_order_pr(
				nr_sequencia,
				nr_service_order,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_product_requirement,
				nr_seq_obj,
				ie_tipo_obj,
				ie_impact,
				ie_tipo_alteracao
			)
			VALUES (
				nextval('reg_service_order_pr_seq'),
				nr_service_order_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_product_req_w,
				obj.nr_seq_obj,
				obj.ie_object_type,
				'L', -- Low impact by default
				ie_object_operation_w
			);
		END IF;

	END LOOP;

	COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_refresh_object_pendencies ( nr_service_order_p reg_object_log.nr_service_order%TYPE, nm_usuario_p reg_service_order_pr.nm_usuario%TYPE ) FROM PUBLIC;

