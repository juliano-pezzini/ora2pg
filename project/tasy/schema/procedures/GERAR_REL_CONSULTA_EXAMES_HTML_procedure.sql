-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_consulta_exames_html ( nr_atendimento_p bigint default null, nr_prescricao_p bigint default null, ie_urgente_p text default 'N', ie_bloqueado_p text default 'N', ie_recoleta_inf_p text default 'N', ie_recoleta_p text default 'N', ie_amostra_n_p text default 'N', ie_inativ_p text default 'N', ie_tipo_data_p text default null, nr_data_restringir_p bigint default null, dt_inicial_p timestamp default null, dt_final_p timestamp default null, nr_lote_p bigint default null, nr_senha_p text default null, nr_controle_p bigint default null, nr_lot_ext_p bigint default null, ds_amostra_p text default null, nm_curto_p text default null, cd_exame_p text default null, cd_cliente_p text default null, ds_filtros_p text default null, cd_med_p text default null, ie_sit_p bigint default null, ie_int_p bigint default null, cd_barras_p text default null, nr_proto_p bigint default null, nr_pre_ext_p bigint default null, cd_estabelecimento_p bigint default null, ie_barras_completo_p text default null) AS $body$
DECLARE


C01			integer;
retorno_w		integer;
nr_atendimento_w	bigint;
nr_prescricao_w		bigint;
dt_prescricao_w		timestamp;
cd_pessoa_fisica_w	varchar(10);
cd_medico_w		varchar(10);
nr_controle_w		bigint;
cd_setor_atendimento_w	integer;
cd_procedencia_w	integer;
dt_liberacao_w		timestamp;
nr_seq_prescr_w		integer;
nm_usuario_w		varchar(15);
nm_usuario_atend_w	varchar(15);
dt_entrada_w		timestamp;
nr_quebra_w		integer;
ie_padrao_amostra_w	varchar(5);
ie_padrao_amostra_ww	varchar(5);
ie_utiliza_amostra_w	varchar(5);
sql_consulta1_w		varchar(4000);
sql_consulta2_w		varchar(4000);
nm_usuario_p		varchar(15);
dt_inicial_w		varchar(255);
dt_final_w		varchar(255);


BEGIN

sql_consulta1_w :=
	'select	DISTINCT
		a.nr_atendimento,
		a.nr_prescricao,
		a.dt_prescricao,
		a.cd_pessoa_fisica,
		a.cd_medico,
		a.nr_controle,
		a.cd_setor_atendimento,
		g.cd_procedencia,
		a.dt_liberacao,
		d.nr_sequencia,
		d.nm_usuario,
		g.nm_usuario_atend,
		g.dt_entrada
	FROM	prescr_medica a,
		atendimento_paciente_v g,
		prescr_procedimento d,
		exame_laboratorio e,
		material_exame_lab k,
		lab_parametro l
	WHERE 	a.nr_atendimento = g.nr_atendimento
	AND	a.nr_prescricao = d.nr_prescricao
	AND    	k.cd_material_exame  = d.cd_material_exame
	AND	e.nr_seq_exame = d.nr_seq_exame
	AND    	a.cd_estabelecimento = l.cd_estabelecimento
	AND 	d.nr_seq_exame IS NOT NULL';


--RESTRIÇÃO DE DATAS
if (ie_tipo_data_p = 'N') then

	dt_inicial_w 	:= 	to_date(dt_inicial_p,'dd/mm/yyyy');
	dt_final_w 	:=	to_date(dt_final_p,'dd/mm/yyyy');

	if (nr_data_restringir_p = 0) then
		sql_consulta1_w := sql_consulta1_w || ' and a.dt_prescricao between '''|| dt_inicial_w || ''' and fim_dia(''' || dt_final_w || ''')';
	elsif (nr_data_restringir_p = 1) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	exame_lab_resultado x,
										exame_lab_result_item y
									where 	x.nr_seq_resultado = y.nr_seq_resultado
									and 	x.nr_prescricao = a.nr_prescricao
									and 	y.nr_seq_prescr = d.nr_sequencia
									and 	y.nr_seq_material is not null
									and 	y.dt_aprovacao between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w || '''))';
	elsif (nr_data_restringir_p = 2) then
		sql_consulta1_w := sql_consulta1_w || ' and d.dt_coleta between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w || ''')';
	elsif (nr_data_restringir_p = 3) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	lab_lote_externo w
									where 	w.nr_sequencia = d.nr_seq_lote_externo
									and 	w.dt_lote between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w ||'''))';
	elsif (nr_data_restringir_p = 4) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	exame_lab_resultado x,
										exame_lab_result_item y
									where 	x.nr_seq_resultado = y.nr_seq_resultado
									and 	x.nr_prescricao = a.nr_prescricao
									and 	y.nr_seq_prescr = d.nr_sequencia
									and 	y.nr_seq_material is not null
									and 	x.dt_resultado between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w ||'''))';
	elsif (nr_data_restringir_p = 5) then
		sql_consulta1_w := sql_consulta1_w || ' and a.dt_entrega between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w || ''')';
	elsif (nr_data_restringir_p = 7) then
		sql_consulta1_w := sql_consulta1_w || ' and d.dt_integracao between ''' || dt_inicial_w || ''' and fim_dia(''' || dt_final_w || ''')';
	end if;

elsif (ie_tipo_data_p = 'S') then

	dt_inicial_w 	:= 	dt_inicial_p;
	dt_final_w 	:=	dt_final_p;

	if (nr_data_restringir_p = 0) then
		sql_consulta1_w := sql_consulta1_w || ' and a.dt_prescricao between to_date('''|| dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w ||''',''dd/mm/yyyy hh24:mi:ss'')';
	elsif (nr_data_restringir_p = 1) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	exame_lab_resultado x,
										exame_lab_result_item y
									where 	x.nr_seq_resultado = y.nr_seq_resultado
									and 	x.nr_prescricao = a.nr_prescricao
									and 	y.nr_seq_prescr = d.nr_sequencia
									and 	y.nr_seq_material is not null
									and 	y.dt_aprovacao between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w ||''',''dd/mm/yyyy hh24:mi:ss)';
	elsif (nr_data_restringir_p = 2) then
		sql_consulta1_w := sql_consulta1_w || ' and d.dt_coleta between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w || ''',''dd/mm/yyyy hh24:mi:ss)';
	elsif (nr_data_restringir_p = 3) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	lab_lote_externo w
									where 	w.nr_sequencia = d.nr_seq_lote_externo
									and 	w.dt_lote between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w || ''',''dd/mm/yyyy hh24:mi:ss''))';
	elsif (nr_data_restringir_p = 4) then
		sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
									from 	exame_lab_resultado x,
										exame_lab_result_item y
									where 	x.nr_seq_resultado = y.nr_seq_resultado
									and 	x.nr_prescricao = a.nr_prescricao
									and 	y.nr_seq_prescr = d.nr_sequencia
									and 	y.nr_seq_material is not null
									and 	x.dt_resultado between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w || ''',''dd/mm/yyyy hh24:mi:ss''))';
	elsif (nr_data_restringir_p = 5) then
		sql_consulta1_w := sql_consulta1_w || ' and a.dt_entrega between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w ||''',''dd/mm/yyyy hh24:mi:ss'')';
	elsif (nr_data_restringir_p = 7) then
		sql_consulta1_w := sql_consulta1_w || ' and d.dt_integracao between to_date(''' || dt_inicial_w || ''',''dd/mm/yyyy hh24:mi:ss'') and to_date(''' || dt_final_w ||''',''dd/mm/yyyy hh24:mi:ss'')';
	end if;

end if;
--FIM RESTRIÇÃO POR DATAS
if (nr_atendimento_p <> 0) then
	sql_consulta1_w := sql_consulta1_w || ' and a.nr_atendimento = '|| nr_atendimento_p;
end if;


if (nr_prescricao_p <> 0) then
	sql_consulta1_w := sql_consulta1_w || ' and a.nr_prescricao = ' || nr_prescricao_p;
end if;

if (ie_urgente_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and d.ie_urgencia = ''' || ie_urgente_p || '''';
end if;

if (ie_bloqueado_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and d.ie_exame_bloqueado = ''' || ie_bloqueado_p || '''';
end if;

if (ie_recoleta_inf_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and d.NR_SEQ_RECOLETA is not null';
end if;

if (ie_recoleta_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and exists (	select 1 from prescr_procedimento x
								where  x.nr_prescricao = a.nr_prescricao
								and  x.nr_sequencia  = d.nr_sequencia
								and  obter_se_recoleta(x.nr_prescricao, x.nr_sequencia) = ''S'')';
end if;

if (ie_amostra_n_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and d.ie_amostra = ''N''';
end if;

if (ie_inativ_p <> 'N') then
	sql_consulta1_w := sql_consulta1_w || ' and (obter_status_result_laborat(a.nr_prescricao, d.nr_sequencia) = ''I'')';
end if;

if (nr_lote_p <> 0) then
	sql_consulta1_w := sql_consulta1_w || ' and lab_obter_dados_lote(a.nr_prescricao, d.nr_sequencia, ''L'') = ' || nr_lote_p;
end if;

if (nr_senha_p IS NOT NULL AND nr_senha_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and g.ds_senha = ''' || nr_senha_p || '''';
end if;

if (nr_controle_p <> 0) then
	sql_consulta1_w := sql_consulta1_w || ' and a.nr_controle = ' || nr_controle_p;
end if;

if (nr_lot_ext_p <> 0) then
	sql_consulta1_w := sql_consulta1_w || ' and d.nr_seq_lote_externo = ' || nr_lot_ext_p;
end if;

if (nm_curto_p IS NOT NULL AND nm_curto_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and   exists (	select 	1
								from 	setor_atendimento w
								where 	a.cd_setor_atendimento = w.cd_setor_atendimento
								and   	upper(w.nm_curto)      = upper('''|| nm_curto_p ||'''))';
end if;

if (ie_sit_p = 0) then
	sql_consulta1_w := sql_consulta1_w || ' and (d.cd_motivo_baixa = 0 and d.dt_suspensao is null)';
elsif (ie_sit_p = 1) then
	sql_consulta1_w := sql_consulta1_w || ' and (d.dt_suspensao is null and obter_se_motivo_baixa_conta(d.cd_motivo_baixa) = ''S'')';
elsif (ie_sit_p = 2) then
	sql_consulta1_w := sql_consulta1_w || ' and (d.dt_suspensao is not null or obter_se_motivo_baixa_conta(d.cd_motivo_baixa) = ''N'')';
elsif (ie_sit_p = 3) then
	sql_consulta1_w := sql_consulta1_w || ' and ((d.cd_motivo_baixa = 0 or obter_se_motivo_baixa_conta(d.cd_motivo_baixa) = ''S'') and d.dt_suspensao is null)';
end if;

if (ie_int_p = 1) then
	sql_consulta1_w := sql_consulta1_w || ' and  d.dt_integracao is not null';
elsif (ie_int_p = 2) then
	sql_consulta1_w := sql_consulta1_w || ' and  d.dt_integracao is null';
elsif (ie_int_p = 3) then
	sql_consulta1_w := sql_consulta1_w || ' and  not exists	(	select 	1
									from 	exame_lab_resultado l,
										exame_lab_result_item m
									where 	l.nr_seq_resultado = m.nr_seq_resultado
									and 	l.nr_prescricao = a.nr_prescricao
									and 	m.nr_seq_prescr = d.nr_sequencia)
									and d.dt_integracao is not null';
end if;

if (nr_pre_ext_p IS NOT NULL AND nr_pre_ext_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
								from 	lab_tasylab_cli_prescr x
								where 	x.nr_prescricao = a.nr_prescricao
								and 	x.nr_prescricao_origem = ' || nr_pre_ext_p || ')';
end if;

if (cd_med_p IS NOT NULL AND cd_med_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and a.cd_medico = ' || cd_med_p;
end if;

if (cd_cliente_p IS NOT NULL AND cd_cliente_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and a.cd_pessoa_fisica = ' || cd_cliente_p;
end if;

if (nr_proto_p IS NOT NULL AND nr_proto_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and exists (	select 	1
								from  	procedimento_paciente h
								where 	d.nr_prescricao = h.nr_prescricao
								and 	d.nr_sequencia  = h.nr_sequencia_prescricao
								and 	obter_protocolo_conpaci(h.nr_interno_conta) = ' || nr_proto_p || ')';
end if;

if (cd_exame_p IS NOT NULL AND cd_exame_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ' and e.cd_exame = ''' || cd_exame_p || '''';
end if;

if (ds_filtros_p IS NOT NULL AND ds_filtros_p::text <> '') then
	sql_consulta1_w := sql_consulta1_w || ds_filtros_p;
end if;

if (ds_amostra_p IS NOT NULL AND ds_amostra_p::text <> '') then

	select 	ie_padrao_amostra
	into STRICT	ie_padrao_amostra_w
	from 	lab_parametro
	where 	cd_estabelecimento = cd_estabelecimento_p;

	if (ie_padrao_amostra_w = 'DGSL') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''dd'') || lpad(e.nr_seq_grupo,2, ''0'') || lpad(nvl(d.nr_seq_lab,0),4,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DGS') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(e.nr_seq_grupo,2, ''0'') || lpad(nvl(d.nr_seq_lab,0),3,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'S') then
		sql_consulta1_w := sql_consulta1_w || ' and lpad(e.nr_seq_grupo,2, ''0'') || d.nr_seq_lab = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DGS7') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(e.nr_seq_grupo,2,''0'') || lpad(nvl(d.nr_seq_lab,0),7,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DAGS4') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmmyy'') || lpad(e.nr_seq_grupo,2,''0'') || lpad(nvl(d.nr_seq_lab,0),4,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DGIS') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(e.nr_seq_grupo_imp,2,''0'') || lpad(nvl(d.nr_seq_lab,0),3,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DS4GI') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(nvl(d.nr_seq_lab,0),4,''0'') || lpad(e.nr_seq_grupo_imp,2,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DGS6') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(e.nr_seq_grupo,2,''0'') || lpad(nvl(d.nr_seq_lab,0),6,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'DGS5') then
		sql_consulta1_w := sql_consulta1_w || ' and to_char(nvl(a.dt_liberacao_medico,nvl(a.dt_liberacao,a.dt_prescricao)),''ddmm'') || lpad(e.nr_seq_grupo,2,''0'') || lpad(nvl(d.nr_seq_lab,0),5,''0'') = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'PM11') then
		sql_consulta1_w := sql_consulta1_w || ' and lpad(a.nr_prescricao || ''M'' || k.nr_sequencia,11,''0'')  = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'PM13') then
		sql_consulta1_w := sql_consulta1_w || ' and lpad(a.nr_prescricao || ''M'' || k.nr_sequencia,13,''0'')  = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'PM') then
		sql_consulta1_w := sql_consulta1_w || ' and lpad(a.nr_prescricao || ''M'' || k.nr_sequencia,10,''0'')  = ''' || ds_amostra_p || '''';
	elsif (ie_padrao_amostra_w = 'P') then
		sql_consulta1_w := sql_consulta1_w || ' and a.nr_prescricao  = ''' || ds_amostra_p || '''';
	elsif ((ie_padrao_amostra_w = 'AMO9') or (ie_padrao_amostra_w = 'AMO10') or (ie_padrao_amostra_w = 'AMO11') or (ie_padrao_amostra_w = 'AMO13') or (ie_padrao_amostra_w = 'AM11F') or (ie_padrao_amostra_w = 'AM10F')) then
		sql_consulta1_w := sql_consulta1_w ||  ' and to_char(substr(lab_obter_barras_amostra(a.nr_prescricao,d.nr_sequencia,null,''' || ie_padrao_amostra_w || '''),1,255)) = ''' || ds_amostra_p ||'''';
	end if;
end if;

if (cd_barras_p IS NOT NULL AND cd_barras_p::text <> '') then

	select 	ie_padrao_amostra
	into STRICT	ie_padrao_amostra_ww
	from 	lab_parametro
	where 	cd_estabelecimento = cd_estabelecimento_p;

	select 	ie_exame_amostra
	into STRICT	ie_utiliza_amostra_w
	from  	lab_parametro
	where 	cd_estabelecimento = cd_estabelecimento_p;

	if (ie_utiliza_amostra_w = 'S') then
		sql_consulta1_w := sql_consulta1_w || ' and (obter_amostras_seq_prescr(d.nr_prescricao, d.nr_sequencia)) like ''%''' || cd_barras_p || '''%';
	elsif (ie_utiliza_amostra_w <> 'S') then
		if (ie_barras_completo_p = 'S') then
			sql_consulta1_w := sql_consulta1_w || ' and lab_obter_barras_amostra(a.nr_prescricao, d.nr_sequencia, null, l.ie_padrao_amostra) = ''' ||cd_barras_p||'''';
		elsif (ie_padrao_amostra_ww = 'DGSL') then
			sql_consulta1_w := sql_consulta1_w || ' and to_char(a.dt_liberacao,''dd'') = substr(''' || cd_barras_p || ''',1,2)';
			sql_consulta1_w := sql_consulta1_w || ' and e.nr_seq_grupo = substr(''' || cd_barras_p || ''',3,2)';
			sql_consulta1_w := sql_consulta1_w || ' and a.nr_seq_lab = substr(''' || cd_barras_p || ''',5,(Length( '''|| cd_barras_p ||''')-4))';
		elsif (ie_padrao_amostra_ww = 'S') then
			sql_consulta1_w := sql_consulta1_w || ' and e.nr_seq_grupo = substr(''' || cd_barras_p || ''',1,2)';
			sql_consulta1_w := sql_consulta1_w || ' and d.nr_seq_lab = substr(''' || cd_barras_p ||''',3,(lenght(''' ||cd_barras_p ||''')-2))';
		else
			sql_consulta1_w := sql_consulta1_w || ' and to_char(a.dt_liberacao,''dd'') = substr(''' || cd_barras_p ||''',1,2)';
			sql_consulta1_w := sql_consulta1_w || ' and to_char(a.dt_liberacao,''mm'') = substr(''' || cd_barras_p ||''',3,2)';
			sql_consulta1_w := sql_consulta1_w || ' and e.nr_seq_grupo = substr(''' || cd_barras_p || ''',5,2)';
			sql_consulta1_w := sql_consulta1_w || ' and d.nr_seq_lab = substr('''||cd_barras_p||''',7,(Length('''||cd_barras_p||''')-6))';
		end if;
	end if;
end if;

--gravar_log_tasy(94321,sql_consulta1_w,'Tasy');
CALL exec_sql_dinamico(nm_usuario_p,'truncate table W_REL_CONSULTA_EXAM');

CALL Exec_sql_Dinamico_bv('CE',sql_consulta1_w,null);

C01 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C01, sql_consulta1_w, dbms_sql.Native);

-- Define as colunas
DBMS_SQL.DEFINE_COLUMN(C01,1,nr_atendimento_w);
DBMS_SQL.DEFINE_COLUMN(C01,2,nr_prescricao_w);
DBMS_SQL.DEFINE_COLUMN(C01,3,dt_prescricao_w);
DBMS_SQL.DEFINE_COLUMN(C01,4,cd_pessoa_fisica_w,10);
DBMS_SQL.DEFINE_COLUMN(C01,5,cd_medico_w,10);
DBMS_SQL.DEFINE_COLUMN(C01,6,nr_controle_w);
DBMS_SQL.DEFINE_COLUMN(C01,7,cd_setor_atendimento_w);
DBMS_SQL.DEFINE_COLUMN(C01,8,cd_procedencia_w);
DBMS_SQL.DEFINE_COLUMN(C01,9,dt_liberacao_w);
DBMS_SQL.DEFINE_COLUMN(C01,10,nr_seq_prescr_w);
DBMS_SQL.DEFINE_COLUMN(C01,11,nm_usuario_w,15);
DBMS_SQL.DEFINE_COLUMN(C01,12,nm_usuario_atend_w,15);
DBMS_SQL.DEFINE_COLUMN(C01,13,dt_entrada_w);

retorno_w := DBMS_SQL.execute(C01);
--insert into temp values (sysdate,10);
while( DBMS_SQL.FETCH_ROWS(C01) > 0 ) loop
	begin

	nr_atendimento_w		:= null; -- Limpa a variavel
	nr_prescricao_w			:= null;
	dt_prescricao_w			:= null;
	cd_pessoa_fisica_w		:= null;
	cd_medico_w			:= null;
	nr_controle_w			:= null;
	cd_setor_atendimento_w		:= null;
	cd_procedencia_w		:= null;
	dt_liberacao_w			:= null;
	nr_seq_prescr_w			:= null;
	nm_usuario_w			:= null;
	nm_usuario_atend_w		:= null;
	dt_entrada_w			:= null;

	DBMS_SQL.COLUMN_VALUE(C01,1,nr_atendimento_w); -- Seta variavel
	DBMS_SQL.COLUMN_VALUE(C01,2,nr_prescricao_w);
	DBMS_SQL.COLUMN_VALUE(C01,3,dt_prescricao_w);
	DBMS_SQL.COLUMN_VALUE(C01,4,cd_pessoa_fisica_w);
	DBMS_SQL.COLUMN_VALUE(C01,5,cd_medico_w);
	DBMS_SQL.COLUMN_VALUE(C01,6,nr_controle_w);
	DBMS_SQL.COLUMN_VALUE(C01,7,cd_setor_atendimento_w);
	DBMS_SQL.COLUMN_VALUE(C01,8,cd_procedencia_w);
	DBMS_SQL.COLUMN_VALUE(C01,9,dt_liberacao_w);
	DBMS_SQL.COLUMN_VALUE(C01,10,nr_seq_prescr_w);
	DBMS_SQL.COLUMN_VALUE(C01,11,nm_usuario_w);
	DBMS_SQL.COLUMN_VALUE(C01,12,nm_usuario_atend_w);
	DBMS_SQL.COLUMN_VALUE(C01,13,dt_entrada_w);

insert into W_REL_CONSULTA_EXAM(
	nr_atendimento,
	nr_prescricao,
	dt_prescricao,
	cd_pessoa_fisica,
	cd_medico,
	nr_controle,
	cd_setor_atendimento,
	cd_procedencia,
	dt_liberacao,
	nr_seq_prescr,
	nm_usuario,
	nm_usuario_atend,
	dt_entrada,
	dt_atualizacao
	)
	values (
	nr_atendimento_w,
	nr_prescricao_w,
	dt_prescricao_w,
	cd_pessoa_fisica_w,
	cd_medico_w,
	nr_controle_w,
	cd_setor_atendimento_w,
	cd_procedencia_w,
	dt_liberacao_w,
	nr_seq_prescr_w,
	nm_usuario_w,
	nm_usuario_atend_w,
	dt_entrada_w,
	clock_timestamp()
	);
	end;
END LOOP;

DBMS_SQL.CLOSE_CURSOR(C01);
--insert into temp values (sysdate,11);
commit;
--insert into temp values (sysdate,5);commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_consulta_exames_html ( nr_atendimento_p bigint default null, nr_prescricao_p bigint default null, ie_urgente_p text default 'N', ie_bloqueado_p text default 'N', ie_recoleta_inf_p text default 'N', ie_recoleta_p text default 'N', ie_amostra_n_p text default 'N', ie_inativ_p text default 'N', ie_tipo_data_p text default null, nr_data_restringir_p bigint default null, dt_inicial_p timestamp default null, dt_final_p timestamp default null, nr_lote_p bigint default null, nr_senha_p text default null, nr_controle_p bigint default null, nr_lot_ext_p bigint default null, ds_amostra_p text default null, nm_curto_p text default null, cd_exame_p text default null, cd_cliente_p text default null, ds_filtros_p text default null, cd_med_p text default null, ie_sit_p bigint default null, ie_int_p bigint default null, cd_barras_p text default null, nr_proto_p bigint default null, nr_pre_ext_p bigint default null, cd_estabelecimento_p bigint default null, ie_barras_completo_p text default null) FROM PUBLIC;

