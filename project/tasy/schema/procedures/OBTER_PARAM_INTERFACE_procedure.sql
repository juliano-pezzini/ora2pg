-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_param_interface ( nr_seq_protocolo_p bigint, ds_sql_interface_p INOUT text, cd_interface_envio_p INOUT bigint) AS $body$
DECLARE


cd_convenio_w		integer;
ie_tipo_atendimento_w	smallint;
ie_tipo_protocolo_w		smallint;
ds_sql_interface_w		varchar(2000);
cd_interface_envio_w	integer;
cd_estabelecimento_w	smallint;
nr_seq_interface_w		smallint;

c01 CURSOR FOR
SELECT	1,
	a.cd_interface_envio,
	a.ds_sql_interface
from	param_interface a
where	a.cd_convenio	= cd_convenio_w
and	coalesce(a.ie_tipo_protocolo,ie_tipo_protocolo_w) = ie_tipo_protocolo_w
and	coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
and	(a.ds_sql_interface IS NOT NULL AND a.ds_sql_interface::text <> '')

union

select	2,
	a.cd_interface_envio,
	b.ds_comando
from	interface b,
	protocolo_convenio a
where	a.nr_seq_protocolo	= nr_seq_protocolo_p
and	a.cd_interface_envio	= b.cd_interface
and	(b.ds_comando IS NOT NULL AND b.ds_comando::text <> '')

union

select	3,
	a.cd_interface_envio,
	b.ds_comando
from	interface b,
	convenio a
where	a.cd_convenio	= cd_convenio_w
and	a.cd_interface_envio	= b.cd_interface
and	(b.ds_comando IS NOT NULL AND b.ds_comando::text <> '')
order by	1 desc;



BEGIN
ds_sql_interface_w		:= null;
cd_interface_envio_w	:= null;

/* Obter dados do protocolo convÃªnio */

select	coalesce(max(cd_convenio),0),
	coalesce(max(ie_tipo_protocolo),0),
	max(cd_interface_envio),
	coalesce(max(cd_estabelecimento),0)
into STRICT	cd_convenio_w,
	ie_tipo_protocolo_w,
	cd_interface_envio_w,
	cd_estabelecimento_w
from	protocolo_convenio
where	nr_seq_protocolo	= nr_seq_protocolo_p;

open c01;
loop
fetch c01	into
	nr_seq_interface_w,
	cd_interface_envio_w,
	ds_sql_interface_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
     	begin
	cd_interface_envio_w := cd_interface_envio_w;
	end;
end loop;
close c01;

select	replace(lower(ds_sql_interface_w),':nr_seq_protocolo',to_char(nr_seq_protocolo_p))
into STRICT	ds_sql_interface_w
;

ds_sql_interface_p		:= ds_sql_interface_w;
cd_interface_envio_p	:= cd_interface_envio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_param_interface ( nr_seq_protocolo_p bigint, ds_sql_interface_p INOUT text, cd_interface_envio_p INOUT bigint) FROM PUBLIC;

