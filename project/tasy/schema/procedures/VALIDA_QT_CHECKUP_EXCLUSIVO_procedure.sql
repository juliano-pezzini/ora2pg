-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_qt_checkup_exclusivo ( CD_PESSOA_FISICA_P text, DT_PREVISTA_P timestamp, IE_ENCAIXE_P text, CD_ESTABELECIMENTO_P bigint, NR_SEQ_TIPO_CHECKUP_P bigint, NR_SEQUENCIA_P bigint) AS $body$
DECLARE

  qtd_total_max_dia_masc_w       bigint;
  qtd_total_max_exclusiva_masc_w bigint;
  qtd_total_max_dia_fem_w        bigint;
  qtd_total_max_exclusiva_fem_w  bigint;
  qtd_total_max_dia_ambos_w      bigint;
  qtd_total_max_ex_ambos_w       bigint;
  nr_seq_tipo_checkup_w          smallint;
  ie_genero_w                    varchar(200);
  qt_maxima_dia_w                bigint;
  qt_exclusiva_w                 bigint;

  C01 CURSOR FOR
    SELECT nr_seq_tipo_checkup,
      ie_genero,
      coalesce(qt_maxima_dia,0),
      coalesce(qt_exclusiva,0)
    FROM checkup_regra_ag_exclusivo ce
    WHERE ce.cd_estabelecimento = cd_estabelecimento_p
    AND ce.ie_dia_semana        = pkg_date_utils.get_WeekDay(dt_prevista_p);

BEGIN

if (NR_SEQ_TIPO_CHECKUP_P IS NOT NULL AND NR_SEQ_TIPO_CHECKUP_P::text <> '') then
	update	checkup
	set	nr_seq_tipo_checkup 	= nr_seq_tipo_checkup_p
	where	nr_sequencia		= nr_sequencia_p;
end if;

  OPEN C01;
  LOOP
    FETCH C01
    INTO nr_seq_tipo_checkup_w,
      ie_genero_w,
      qt_maxima_dia_w,
      qt_exclusiva_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    BEGIN
	
      IF (ie_genero_w = 'M') THEN
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_dia_masc_w
        FROM checkup c,
			pessoa_fisica pf
        WHERE c.cd_pessoa_fisica      = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND pf.ie_sexo                = 'M'
        AND TRUNC(c.dt_previsto,'dd') = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento      = cd_estabelecimento_p
        AND coalesce(c.ie_exclusivo,'N')   = 'N'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND coalesce(c.nr_seq_tipo_checkup,0)      = coalesce(nr_seq_tipo_checkup_w,0);
		
        IF ( qtd_total_max_dia_masc_w > qt_maxima_dia_w ) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099813);
        END IF;
		
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_exclusiva_masc_w
        FROM checkup c,
          pessoa_fisica pf
        WHERE c.cd_pessoa_fisica            = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND pf.ie_sexo                      = 'M'
        AND TRUNC(c.dt_previsto,'dd')       = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento            = cd_estabelecimento_p
        AND c.ie_exclusivo                  = 'S'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND c.nr_seq_tipo_checkup           = nr_seq_tipo_checkup_w;
		
        IF ( qtd_total_max_exclusiva_masc_w > qt_exclusiva_w) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099816);
        END IF;
		
      END IF;
      IF (ie_genero_w = 'F') THEN
	
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_dia_fem_w
        FROM checkup c,
          pessoa_fisica pf
        WHERE c.cd_pessoa_fisica      = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND pf.ie_sexo                = 'F'
        AND TRUNC(c.dt_previsto,'dd') = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento      = cd_estabelecimento_p
        AND coalesce(c.ie_exclusivo,'N')   = 'N'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND coalesce(c.nr_seq_tipo_checkup,0)      = coalesce(nr_seq_tipo_checkup_w,0);
		
        IF ( qtd_total_max_dia_fem_w  > qt_maxima_dia_w ) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099814);
        END IF;
		
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_exclusiva_fem_w
        FROM checkup c,
          pessoa_fisica pf
        WHERE c.cd_pessoa_fisica           = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND pf.ie_sexo                     = 'F'
        AND TRUNC(c.dt_previsto,'dd')      = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento           = cd_estabelecimento_p
        AND c.ie_exclusivo                 = 'S'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND c.nr_seq_tipo_checkup          = nr_seq_tipo_checkup_w;
		
        IF ( qtd_total_max_exclusiva_fem_w > qt_exclusiva_w) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099817);
        END IF;
		
      END IF;
	
      IF (ie_genero_w = 'A') THEN
	  
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_dia_ambos_w
        FROM checkup c,
          pessoa_fisica pf
        WHERE c.cd_pessoa_fisica       = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND TRUNC(c.dt_previsto,'dd')  = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento       = cd_estabelecimento_p
        AND coalesce(c.ie_exclusivo,'N')    = 'N'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND coalesce(c.nr_seq_tipo_checkup,0)      = coalesce(nr_seq_tipo_checkup_w,0);
		
        IF ( qtd_total_max_dia_ambos_w > qt_maxima_dia_w ) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099815);
        END IF;
		
        SELECT COUNT(*)
        INTO STRICT qtd_total_max_ex_ambos_w
        FROM checkup c,
          pessoa_fisica pf
        WHERE c.cd_pessoa_fisica      = pf.cd_pessoa_fisica
        AND (c.cd_pessoa_fisica IS NOT NULL AND c.cd_pessoa_fisica::text <> '')
        AND TRUNC(c.dt_previsto,'dd') = TRUNC(dt_prevista_p,'dd')
        AND c.cd_estabelecimento      = cd_estabelecimento_p
        AND c.ie_exclusivo            = 'S'
        AND coalesce(c.dt_cancelamento::text, '') = ''
        AND coalesce(c.nr_seq_tipo_checkup,0)      = coalesce(nr_seq_tipo_checkup_w,0);
		
        IF (qtd_total_max_ex_ambos_w  > qt_exclusiva_w) THEN
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1099818);
        END IF;
		
      END IF;
    END;
  END LOOP;
  CLOSE C01;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_qt_checkup_exclusivo ( CD_PESSOA_FISICA_P text, DT_PREVISTA_P timestamp, IE_ENCAIXE_P text, CD_ESTABELECIMENTO_P bigint, NR_SEQ_TIPO_CHECKUP_P bigint, NR_SEQUENCIA_P bigint) FROM PUBLIC;

