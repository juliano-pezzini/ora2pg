-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_prescricao ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, ie_gerar_ordem_pac_chegada_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_ordem_prod_w 		bigint;
nr_prescricao_w			bigint;
cd_material_w			integer;
ie_via_aplicacao_w		varchar(5);
cd_medico_resp_w		varchar(10);
cd_pessoa_fisica_w		varchar(10);
cd_farmaceutico_w		varchar(10);
nr_seq_prescr_w		bigint;
dt_prescricao_w		timestamp;
ds_precaucao_ordem_w		varchar(255);
ds_recomendacao_w		varchar(2000); --Ivan em 17/07/2007 OS61569
qt_min_aplicacao_w		smallint;
qt_hora_aplicacao_w		smallint;
ie_tipo_dosagem_w		varchar(3);
qt_dose_diluente_w		double precision;
vl_gotejo_w			double precision;
nr_agrupamento_w		double precision;
nr_agrup_ant_w		double precision := 0;
nr_ocorrencia_w		double precision;
cd_material_medic_w		integer;
nr_sequencia_medic_w		integer;
qt_dose_medic_w		double precision;
cd_unidade_medida_dose_w	varchar(30);
nr_seq_item_prescr_w		bigint;
cd_setor_paciente_w		integer;
cd_forma_armaz_w		varchar(255);
cd_estagio_armaz_w		varchar(255);
qt_estabilidade_w		double precision;
ie_tempo_estab_w		varchar(3);
qt_hora_validade_w		integer;
qt_min_validade_w		integer;
nr_atendimento_w		bigint;
nr_atend_w			bigint;
ie_internado_w			smallint;
ie_generico_w			varchar(1);
nr_seq_ordem_prod_w		bigint;
ie_gerar_ordem_w		varchar(1);
nr_seq_atendimento_w		bigint;
ie_usuario_manipulador_w	varchar(1);
ie_restringir_ordem_w		varchar(1);
ie_pre_medicacao_w		varchar(1);
nr_sequencia_log_w		bigint;
ie_liberado_w			varchar(1);
ie_consiste_ordem_w		varchar(1);
ie_agrupador_w			smallint;
ie_agrup_ant_w			smallint;
qt_dias_util_w			smallint;
ie_grava_aspirado_w		varchar(1);
qt_volume_aspirado_w		double precision;
ie_bomba_infusao_w		varchar(1);
nr_sequencia_solucao_w	bigint;
dt_chagada_w			timestamp;
ie_exige_lib_farma_w	varchar(1);
qt_mat_regra_w			bigint;
qt_dose_w				double precision;
ie_via_aplicacao_got_w	varchar(5);
ie_aplica_gotejamento_w	varchar(1);
dt_inicial_w			timestamp;
dt_final_w				timestamp;
nr_seq_mat_hor_w        bigint;


C01 CURSOR FOR
	SELECT	distinct b.nr_prescricao,
			a.nr_atendimento
	from	material c,
			prescr_material b,
			prescr_medica a
	where	b.cd_material	= c.cd_material	
	and		a.nr_prescricao	= b.nr_prescricao
	and		a.dt_prescricao between dt_inicial_w and dt_final_w
	and		(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
	and 	((a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringir_ordem_w = 'N'))
	and (obter_se_setor_ordem(ie_acm,obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S')		
	and	    ((a.dt_liberacao_farmacia IS NOT NULL AND a.dt_liberacao_farmacia::text <> '') or (coalesce(ie_exige_lib_farma_w,'N') = 	'N'))
	and		c.ie_mistura	<> 'N'	
	and		coalesce(a.dt_suspensao::text, '') = ''	
	and		coalesce(b.ie_medicacao_paciente, 'N') <> 'S'
	and		(b.ie_via_aplicacao IS NOT NULL AND b.ie_via_aplicacao::text <> '')
	and		coalesce(b.nr_seq_ordem_prod::text, '') = ''
	and not exists (SELECT 1 from paciente_atendimento x where x.nr_prescricao = a.nr_prescricao);
		
C02 CURSOR FOR
	SELECT	b.nr_sequencia,
		CASE WHEN ie_generico_w='S' THEN coalesce(c.cd_material_generico,b.cd_material)  ELSE b.cd_material END ,
		coalesce(b.ie_via_aplicacao,obter_via_soluc(nr_sequencia_solucao,b.nr_prescricao)),
		a.cd_medico,
		a.cd_pessoa_fisica,
		a.dt_prescricao,
		substr(c.ds_precaucao_ordem,1,255),
		substr(b.ds_observacao,1,255), --Ivan em 17/07/2007 OS61569
		coalesce(b.qt_min_aplicacao,0),
		coalesce(qt_hora_aplicacao,0),
		CASE WHEN coalesce(obter_um_rep_dispositivo(b.ie_bomba_infusao,b.ie_agrupador)::text, '') = '' THEN CASE WHEN b.ie_bomba_infusao='S' THEN 'mlh'  ELSE 'gtm' END   ELSE obter_um_rep_dispositivo(b.ie_bomba_infusao,b.ie_agrupador) END ,
		b.nr_agrupamento,
		coalesce(b.nr_ocorrencia,CASE WHEN b.ie_agrupador=4 THEN coalesce(obter_etapa_soluc_quimio(nr_prescricao_w, b.nr_sequencia_solucao),1)  ELSE 1 END ),
		a.cd_setor_atendimento,
		a.nr_atendimento,
		b.ie_pre_medicacao,
		b.ie_agrupador,
		b.qt_dias_util,
		b.ie_bomba_infusao,
		b.nr_sequencia_solucao
	from	material c,
		prescr_material b,
		prescr_medica a
	where	b.cd_material	= c.cd_material
	and	(((c.ie_mistura	= 'S') and (coalesce(b.ie_medicacao_paciente, 'N') <> 'S')) or
		 ((c.ie_mistura	= 'I') and (nr_atend_w IS NOT NULL AND nr_atend_w::text <> '') and (ie_internado_w > 0) and (coalesce(b.ie_medicacao_paciente, 'N') <> 'S')) or
		  ((c.ie_mistura = 'R') and (obter_se_gera_ordem(coalesce(b.ie_via_aplicacao,obter_via_soluc(nr_sequencia_solucao,b.nr_prescricao)),b.cd_intervalo, b.qt_dose, b.cd_material, b.cd_unidade_medida,'P', b.ie_medicacao_paciente, nr_atend_w) = 'S')))
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	b.ie_suspenso	<> 'S'
	and	coalesce(b.nr_seq_ordem_prod::text, '') = ''
	and	a.nr_prescricao	= b.nr_prescricao
	and (obter_se_setor_ordem(ie_acm,obter_setor_atendimento(obter_atendimento_prescr(b.nr_prescricao))) = 'S')
	and	(b.ie_via_aplicacao IS NOT NULL AND b.ie_via_aplicacao::text <> '')
	and	  ((a.dt_liberacao_farmacia IS NOT NULL AND a.dt_liberacao_farmacia::text <> '') or (coalesce(ie_exige_lib_farma_w,'N') = 	'N'))
	and	a.nr_prescricao	= nr_prescricao_w
	and	ie_gerar_ordem_w = 'S'
    and	b.ie_agrupador		in (1,2,4)	
	and not exists (SELECT 1 from paciente_atendimento x where x.nr_prescricao = a.nr_prescricao)
	order by b.nr_agrupamento, b.nr_sequencia;

C03 CURSOR FOR
	SELECT	CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE CASE WHEN ie_generico_w='C' THEN obter_medic_regra_onc(a.cd_material,b.cd_material_generico,nr_atendimento_w,ie_tipo_material,b.nr_seq_ficha_tecnica)  ELSE a.cd_material END  END ,
		a.nr_sequencia,
		a.qt_dose,
		a.cd_unidade_medida_dose
	from	material b,
		prescr_material a
	where	a.nr_prescricao		= nr_prescricao_w
	and	a.ie_suspenso		<> 'S'
	and	a.cd_material		= b.cd_material
	and	a.nr_agrupamento	= nr_agrupamento_w
	and 	a.ie_agrupador 		= ie_agrupador_w
	and	a.ie_agrupador		in (1,2,4);


BEGIN

ie_generico_w := Obter_Param_Usuario(3130, 22, obter_perfil_ativo, nm_usuario_p, 0, ie_generico_w);
ie_usuario_manipulador_w := Obter_Param_Usuario(3130, 142, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_usuario_manipulador_w);
ie_restringir_ordem_w := Obter_Param_Usuario(3130, 165, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_restringir_ordem_w);
ie_consiste_ordem_w := Obter_Param_Usuario(3130, 169, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_ordem_w);
ie_grava_aspirado_w := Obter_Param_Usuario(3130, 176, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_grava_aspirado_w);
ie_exige_lib_farma_w := Obter_Param_Usuario(3130, 429, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exige_lib_farma_w);


select nextval('log_gera_ordem_seq')
into STRICT	nr_sequencia_log_w
;

dt_inicial_w	:= INICIO_DIA(dt_referencia_p);
dt_final_w		:= FIM_DIA(dt_referencia_p);

insert into log_gera_ordem(
	nr_sequencia,
	nm_usuario,
	dt_inicio)
values (nr_sequencia_log_w,
	wheb_usuario_pck.get_nm_usuario,
	clock_timestamp());

commit;

ie_liberado_w := 'N';

if (ie_consiste_ordem_w = 'S') then
	while(ie_liberado_w <> 'S')  loop
		begin
		select 	coalesce(max('N'),'S')
		into STRICT 	ie_liberado_w
		from 	log_gera_ordem
		where 	nr_sequencia < nr_sequencia_log_w
		and (dt_inicio +1/288) > clock_timestamp()
		and 	coalesce(dt_final::text, '') = '';
		end;
	end loop;
end if;


  cd_farmaceutico_w := Obter_Param_Usuario(3130, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_farmaceutico_w);
  cd_estagio_armaz_w := Obter_Param_Usuario(3130, 10, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_estagio_armaz_w);
  cd_forma_armaz_w := Obter_Param_Usuario(3130, 11, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_forma_armaz_w);

	

	/*	lock table prescr_medica in exclusive mode;
	Bruna OS133410	*/
	OPEN C01;
	LOOP
	FETCH C01 into
		nr_prescricao_w,
		nr_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		nr_agrup_ant_w	:= 0;

		if (nr_atend_w IS NOT NULL AND nr_atend_w::text <> '') then
			select	count(1)
			into STRICT	ie_internado_w
			from	setor_atendimento b,
				unidade_atendimento a
			where	a.cd_setor_atendimento	= b.cd_setor_atendimento
			and	a.nr_atendimento	= nr_atend_w
			and	b.cd_classif_setor in (3,4);
		end if;

		ie_gerar_ordem_w	:= 'S';


			select 	max(nr_seq_atendimento)
			into STRICT	nr_seq_atendimento_w
			from	paciente_atendimento
			where	nr_prescricao = nr_prescricao_w
			and 	obter_tipo_atend_prescr(nr_prescricao) <> 1;

			if (coalesce(nr_seq_atendimento_w,0) > 0) then

				select 	MAX(dt_chegada)
				into STRICT	DT_CHAGADA_W
				from	paciente_atendimento
				where 	nr_seq_atendimento = nr_seq_atendimento_w;

			end if;

		if (ie_gerar_ordem_pac_chegada_p = 'S') then

			select 	max(nr_seq_atendimento)
			into STRICT	nr_seq_atendimento_w
			from	paciente_atendimento
			where	nr_prescricao = nr_prescricao_w
			and 	obter_tipo_atend_prescr(nr_prescricao) <> 1;

			if (coalesce(nr_seq_atendimento_w,0) > 0) then

				select 	CASE WHEN coalesce(dt_chegada::text, '') = '' THEN 'N'  ELSE 'S' END
				into STRICT	ie_gerar_ordem_w
				from	paciente_atendimento
				where 	nr_seq_atendimento = nr_seq_atendimento_w;

			end if;

		end if;

		OPEN C02;
		LOOP
		FETCH C02 into
			nr_seq_prescr_w,
			cd_material_w,
			ie_via_aplicacao_w,
			cd_medico_resp_w,
			cd_pessoa_fisica_w,
			dt_prescricao_w,
			ds_precaucao_ordem_w,
			ds_recomendacao_w,
			qt_min_aplicacao_w,
			qt_hora_aplicacao_w,
			ie_tipo_dosagem_w,
			nr_agrupamento_w,
			nr_ocorrencia_w,
			cd_setor_paciente_w,
			nr_atendimento_w,
			ie_pre_medicacao_w,
			ie_agrupador_w,
			qt_dias_util_w,
			ie_bomba_infusao_w,
			nr_sequencia_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (nr_agrup_ant_w <> nr_agrupamento_w) or
				(nr_agrup_ant_w = nr_agrupamento_w AND ie_agrup_ant_w <> ie_agrupador_w) then
				begin

				nr_agrup_ant_w	:= nr_agrupamento_w;
				ie_agrup_ant_w  := ie_agrupador_w;

				select	coalesce(min(qt_estabilidade),0),
					coalesce(min(ie_tempo_estab),'I')
				into STRICT	qt_estabilidade_w,
					ie_tempo_estab_w
				from	material_armazenamento
				where	cd_material	= cd_material_w
				and	nr_seq_estagio	= cd_estagio_armaz_w
				and	nr_seq_forma	= cd_forma_armaz_w
				and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0);

				qt_hora_validade_w	:= 0;
				qt_min_validade_w	:= 0;
				if (ie_tempo_estab_w = 'H') then
					qt_hora_validade_w	:= qt_estabilidade_w;
				elsif (ie_tempo_estab_w = 'D') then
					qt_hora_validade_w	:= qt_estabilidade_w * 24;
				elsif (ie_tempo_estab_w = 'M') then
					qt_hora_validade_w	:= qt_estabilidade_w * 30 * 24;
				elsif (ie_tempo_estab_w = 'A') then
					qt_hora_validade_w	:= qt_estabilidade_w * 365 * 24;
				end if;

				select	coalesce(max(nr_seq_ordem_prod),0)
				into STRICT	nr_seq_ordem_prod_w
				from	prescr_material
				where	nr_prescricao	= nr_prescricao_w
				and	nr_sequencia	= nr_seq_prescr_w;

				/*
				insert into logx_tasy(dt_atualizacao, nm_usuario, cd_log, ds_log)
				values (sysdate, nm_usuario_p, 54784, nr_ocorrencia_w || chr(13) || nr_prescricao_w || ' - ' || nr_seq_prescr_w||' - '||'Ordem Prescricao');
				*/
				while(nr_ocorrencia_w > 0) and (nr_seq_ordem_prod_w = 0) LOOP
					begin
					nr_ocorrencia_w	:= nr_ocorrencia_w - 1;

					select	nextval('can_ordem_prod_seq')
					into STRICT	nr_sequencia_w
					;

					if (ie_agrupador_w = 4) then

					select 	coalesce(max(ie_via_aplicacao),ie_via_aplicacao_w)
					into STRICT	ie_via_aplicacao_w
					from	prescr_solucao
					where	nr_prescricao = nr_prescricao_w
					and		nr_seq_solucao = nr_sequencia_solucao_w;

					end if;

					nr_ordem_prod_w := nr_sequencia_w;

					insert into can_ordem_prod(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						cd_pessoa_fisica,
						dt_prevista,
						ie_via_aplicacao,
						qt_hora_validade,
						qt_min_validade,
						qt_hora_aplic,
						qt_min_aplic,
						cd_medico_resp,
						cd_farmaceutico,
						cd_manipulador,
						cd_auxiliar,
						dt_inicio_preparo,
						dt_entrega_setor,
						dt_administracao,
						nr_seq_atendimento,
						nr_prescricao,
						dt_fim_preparo,
						ie_tipo_dosagem,
						ds_precaucao,
						ie_cancelada,
						ds_orientacao_adm,
						cd_setor_paciente,
						ie_conferido,
						nr_atendimento,
						ie_suspensa,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_pre_medicacao,
						qt_dias_util,
						ie_bomba_infusao)
					Values (
						nr_sequencia_w,
						cd_estabelecimento_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_w,
						dt_prescricao_w,
						ie_via_aplicacao_w,
						coalesce(qt_hora_validade_w,0),
						coalesce(qt_min_validade_w,0),
						coalesce(qt_hora_aplicacao_w,0),
						coalesce(qt_min_aplicacao_w,0),
						cd_medico_resp_w,
						null,
						CASE WHEN ie_usuario_manipulador_w='S' THEN Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C')  ELSE null END ,
						null,
						null,
						null,
						null,
						null,
						nr_prescricao_w,
						null,
						ie_tipo_dosagem_w,
						ds_precaucao_ordem_w,
						'N',
						ds_recomendacao_w,
						cd_setor_paciente_w,
						'N',
						nr_atendimento_w,
						'N',
						clock_timestamp(),
						nm_usuario_p,
						ie_pre_medicacao_w,
						qt_dias_util_w,
						ie_bomba_infusao_w);

					commit;

				update	prescr_material /* ALterado cursor pois quando gerava duas ordens ao mesmo tempo estava duplicando   OS240707*/
				set	nr_seq_ordem_prod	= nr_ordem_prod_w
				where	nr_prescricao		= nr_prescricao_w
				and	nr_agrupamento		= nr_agrupamento_w;

				commit;

					OPEN C03;
					LOOP
					FETCH C03 into
						cd_material_medic_w,
						nr_sequencia_medic_w,
						qt_dose_medic_w,
						cd_unidade_medida_dose_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						select	nextval('can_ordem_item_prescr_seq')
						into STRICT	nr_seq_item_prescr_w
						;

						select	count(1)
						into STRICT	qt_mat_regra_w
						from	regra_geracao_ordem_tot
						where	cd_material = cd_material_medic_w;

						if (qt_mat_regra_w > 0) then
							select	qt_material
							into STRICT	qt_dose_medic_w
							from	prescr_material
							where	nr_sequencia	= nr_sequencia_medic_w
							and		nr_prescricao	= nr_prescricao_w;
						end if;

            select min(a.nr_sequencia)
            into STRICT    nr_seq_mat_hor_w
            from    prescr_mat_hor a
            where   a.nr_seq_material = nr_sequencia_medic_w
	    and     (a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')
            and     a.nr_prescricao = nr_prescricao_w
            and     a.cd_material = cd_material_medic_w
            and     not exists (SELECT 1 from can_ordem_item_prescr b where   b.nr_seq_mat_hor = a.nr_sequencia);

						insert into can_ordem_item_prescr(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_ordem,
							cd_material,
							qt_dose,
							cd_unidade_medida,
							nr_prescricao,
							nr_seq_prescricao,
							nr_sequencia_diluente,
							nm_usuario_nrec,
							dt_atualizacao_nrec,
							nr_seq_mat_hor)
						values (	nr_seq_item_prescr_w,
							clock_timestamp(),
							nm_usuario_p,
							nr_sequencia_w,
							cd_material_medic_w,
							coalesce(qt_dose_medic_w,0),
							cd_unidade_medida_dose_w,
							nr_prescricao_w,
							nr_sequencia_medic_w,
							null,
							nm_usuario_p,
							clock_timestamp(),
							nr_seq_mat_hor_w);

						insert into can_ordem_item_prescr(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_ordem,
							cd_material,
							qt_dose,
							cd_unidade_medida,
							nr_prescricao,
							nr_seq_prescricao,
							nr_sequencia_diluente,
							nm_usuario_nrec,
							dt_atualizacao_nrec,
							nr_seq_mat_hor)
						SELECT	nextval('can_ordem_item_prescr_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_sequencia_w,
							CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE a.cd_material END ,
							coalesce(a.qt_dose,0),
							a.cd_unidade_medida_dose,
							nr_prescricao_w,
							a.nr_sequencia,
							nr_seq_item_prescr_w,
							nm_usuario_p,
							clock_timestamp(),
							nr_seq_mat_hor_w
						from	material b,
							prescr_material a
						where	a.nr_prescricao		= nr_prescricao_w
						and	a.nr_sequencia_diluicao	= nr_sequencia_medic_w
						and	a.cd_material		= b.cd_material
						and	a.ie_agrupador		= 3
						and 	coalesce(a.dt_suspensao::text, '') = '';


						begin
						select	CASE WHEN upper(cd_unidade_medida_dose)=upper(obter_unid_med_usua('ML')) THEN qt_dose  ELSE qt_dose * obter_conversao_unid_med(cd_material,obter_unid_med_usua('ML')) END
						into STRICT	qt_dose_diluente_w
						from	prescr_material
						where	nr_sequencia_diluicao	= nr_seq_prescr_w
						and	nr_prescricao		= nr_prescricao_w
						and	ie_agrupador		= 3;
						exception
						when others then
							qt_dose_diluente_w	:= 0;
						end;
				
						/*select	nvl(max(obter_conversao_ml(cd_material, qt_dose, cd_unidade_medida_dose)),0)
						into	qt_dose_w
						from	prescr_material
						where	nr_prescricao 	= nr_prescricao_w
						and		nr_sequencia	= nr_seq_prescr_w;
						*/
						ie_aplica_gotejamento_w := 'S';
						
						if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
							select coalesce(ie_gotejamento,'S')
							into STRICT   ie_aplica_gotejamento_w
							from   via_aplicacao
							where  ie_via_aplicacao = ie_via_aplicacao_w;
						end if;
						
						if (ie_aplica_gotejamento_w = 'S') then
							vl_gotejo_w := Calcular_gotejamento_ordem(ie_tipo_dosagem_w, dividir(qt_min_aplicacao_w,60) + qt_hora_aplicacao_w, qt_dose_diluente_w, vl_gotejo_w);
						else
							vl_gotejo_w := null;
							ie_tipo_dosagem_w := null;
						end if;

						qt_volume_aspirado_w := null;

						if (ie_grava_aspirado_w = 'S') then
							qt_volume_aspirado_w := obter_volume_aspirado(nr_sequencia_w);
						end if;

						update	can_ordem_prod
						set	qt_dosagem	        = vl_gotejo_w,
							qt_volume_aspirado	= qt_volume_aspirado_w,
							ie_tipo_dosagem		= ie_tipo_dosagem_w
						where	nr_sequencia		= nr_sequencia_w;
						end;
					END LOOP;
					Close C03;

					end;
				END LOOP;

				commit;

				end;
			end if;

			end;
		END LOOP;
		Close C02;

		end;
	END LOOP;
	Close C01;



	commit;
	update  log_gera_ordem
	set 	dt_final = clock_timestamp()
	where 	nr_sequencia = nr_sequencia_log_w;
	commit;


commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_prescricao ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, ie_gerar_ordem_pac_chegada_p text, nm_usuario_p text) FROM PUBLIC;

