-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_converter_conta_unif ( nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ie_tipo_atendimento_w	smallint;
nr_conta_sus_w		bigint;
cd_proc_unif_w		bigint;
qt_proc_unif_w		integer	:= 0;
nr_seq_partic_w		bigint;
nr_seq_partic_ww		bigint;
nr_sequencia_ww		bigint;
cd_estabelecimento_w	atendimento_paciente.cd_estabelecimento%type;
cd_motivo_exc_conta_w	parametro_faturamento.cd_motivo_exc_conta%type;

 
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		cd_procedimento, 
		ie_origem_proced 
	from	procedimento_paciente 
	where	nr_interno_conta	= nr_interno_conta_p;

C02 CURSOR FOR 
	SELECT	nr_seq_partic 
	from	procedimento_participante 
	where	nr_sequencia		= nr_sequencia_w;


BEGIN 
 
/* Obter dados da conta */
 
select	b.ie_tipo_atendimento, 
	b.cd_estabelecimento 
into STRICT	ie_tipo_atendimento_w, 
	cd_estabelecimento_w 
from	atendimento_paciente	b, 
	conta_paciente		a 
where	a.nr_interno_conta	= nr_interno_conta_p 
and	a.nr_atendimento	= b.nr_atendimento;
 
OPEN C01;
LOOP 
FETCH C01 into 
	nr_sequencia_w, 
	cd_procedimento_w, 
	ie_origem_proced_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	begin 
	select	a.cd_proc_unif 
	into STRICT	cd_proc_unif_w 
	from	sus_origem a, 
		procedimento b 
	where	a.cd_procedimento	= cd_procedimento_w 
	and	a.ie_origem_proced	= ie_origem_proced_w 
	and	a.cd_proc_unif		= b.cd_procedimento 
	and	a.ie_origem_proc_unif	= b.ie_origem_proced 
	and	b.ie_situacao		= 'A';
	exception 
		when others then 
		cd_proc_unif_w	:= 0;
	end;
 
	if (cd_proc_unif_w	> 0) then 
		qt_proc_unif_w	:= qt_proc_unif_w + 1;
		 
		select	nextval('procedimento_paciente_seq') 
		into STRICT	nr_sequencia_ww 
		;
 
		insert into procedimento_paciente(nr_sequencia, nr_atendimento, dt_entrada_unidade, cd_procedimento, dt_procedimento, 
			qt_procedimento, dt_atualizacao, nm_usuario, cd_medico, cd_convenio, 
			cd_categoria, cd_pessoa_fisica, dt_prescricao, ds_observacao, vl_procedimento, 
			vl_medico, vl_anestesista, vl_materiais, cd_edicao_amb, cd_tabela_servico, 
			dt_vigencia_preco, cd_procedimento_princ, dt_procedimento_princ, dt_acerto_conta, dt_acerto_convenio, 
			dt_acerto_medico, vl_auxiliares, vl_custo_operacional, tx_medico, tx_anestesia, 
			nr_prescricao, nr_sequencia_prescricao, cd_motivo_exc_conta, ds_compl_motivo_excon, cd_acao, 
			qt_devolvida, cd_motivo_devolucao, nr_cirurgia, nr_doc_convenio, cd_medico_executor, 
			ie_cobra_pf_pj, nr_laudo, dt_conta, cd_setor_atendimento, cd_conta_contabil, 
			cd_procedimento_aih, ie_origem_proced, nr_aih, ie_responsavel_credito, tx_procedimento, 
			cd_equipamento, ie_valor_informado, cd_estabelecimento_custo, cd_tabela_custo, cd_situacao_glosa, 
			nr_lote_contabil, cd_procedimento_convenio, nr_seq_autorizacao, ie_tipo_servico_sus, ie_tipo_ato_sus, 
			cd_cgc_prestador, nr_nf_prestador, cd_atividade_prof_bpa, nr_interno_conta, nr_seq_proc_princ, 
			ie_guia_informada, dt_inicio_procedimento, ie_emite_conta, ie_funcao_medico, ie_classif_sus, 
			cd_especialidade, nm_usuario_original, nr_seq_proc_pacote, ie_tipo_proc_sus, cd_setor_receita, 
			vl_adic_plant, qt_porte_anestesico, tx_hora_extra, ie_emite_conta_honor, nr_seq_atepacu, 
			ie_proc_princ_atend, cd_medico_req, ie_tipo_guia, ie_video, nr_doc_interno, 
			ie_auditoria, nr_seq_grupo_rec, cd_medico_convenio, cd_motivo_ajuste, ie_via_acesso, 
			nr_seq_exame, nr_seq_cor_exec, ie_intercorrencia, nr_seq_origem, ie_dispersao, 
			cd_setor_paciente, nr_seq_conta_origem, nr_seq_parcial, nr_seq_proc_interno, cd_senha, 
			nr_seq_aih, nr_doc_honor_conv, dt_conferencia, ie_tipo_atend_bpa, ie_grupo_atend_bpa, 
			cd_cgc_prestador_conta, cd_medico_exec_conta, nr_seq_pq_proc, qt_filme, nr_seq_proc_crit_repasse, 
			cd_senha_autor, cd_autor_convenio, nr_seq_regra_lanc, ie_tiss_tipo_guia, nr_seq_tiss_tabela, 
			ie_tiss_tipo_guia_honor, nr_seq_regra_preco, nr_minuto_duracao, ie_tiss_tipo_guia_desp, ie_tecnica_utilizada, 
			ie_tiss_tipo_despesa, cd_cgc_prestador_tiss, cd_cgc_honorario_tiss, ie_integracao, nr_seq_proc_acerto, 
			vl_original_tabela, cd_doenca_cid, nr_seq_apac, nr_seq_ajuste_proc, cd_tab_custo_preco, 
			nr_seq_proc_autor) 
		SELECT	nr_sequencia_ww, nr_atendimento, dt_entrada_unidade, cd_proc_unif_w, dt_procedimento, 
			qt_procedimento, clock_timestamp(), nm_usuario_p, cd_medico, cd_convenio, 
			cd_categoria, cd_pessoa_fisica, dt_prescricao, nr_sequencia_w || ' - ' || cd_procedimento_w || ' - ' || ie_origem_proced_w, vl_procedimento, 
			vl_medico, vl_anestesista, vl_materiais, cd_edicao_amb, cd_tabela_servico, 
			dt_vigencia_preco, cd_procedimento_princ, dt_procedimento_princ, dt_acerto_conta, dt_acerto_convenio, 
			dt_acerto_medico, vl_auxiliares, vl_custo_operacional, tx_medico, tx_anestesia, 
			nr_prescricao,nr_sequencia_prescricao, cd_motivo_exc_conta, ds_compl_motivo_excon, cd_acao, 
			qt_devolvida, cd_motivo_devolucao, nr_cirurgia, nr_doc_convenio, cd_medico_executor, 
			ie_cobra_pf_pj, nr_laudo, dt_conta, cd_setor_atendimento, cd_conta_contabil, 
			cd_procedimento_aih, 7, nr_aih, ie_responsavel_credito, tx_procedimento, 
			cd_equipamento, ie_valor_informado, cd_estabelecimento_custo, cd_tabela_custo, cd_situacao_glosa, 
			nr_lote_contabil, cd_procedimento_convenio, nr_seq_autorizacao, ie_tipo_servico_sus, ie_tipo_ato_sus, 
			cd_cgc_prestador, nr_nf_prestador, cd_atividade_prof_bpa, nr_interno_conta_p, nr_seq_proc_princ, 
			ie_guia_informada, dt_inicio_procedimento, ie_emite_conta, ie_funcao_medico, ie_classif_sus, 
			cd_especialidade, nm_usuario_original, nr_seq_proc_pacote, ie_tipo_proc_sus, cd_setor_receita, 
			vl_adic_plant, qt_porte_anestesico, tx_hora_extra, ie_emite_conta_honor, nr_seq_atepacu, 
			ie_proc_princ_atend, cd_medico_req, ie_tipo_guia, ie_video, nr_doc_interno, 
			ie_auditoria, nr_seq_grupo_rec, cd_medico_convenio, cd_motivo_ajuste, ie_via_acesso, 
			null, nr_seq_cor_exec, ie_intercorrencia, nr_seq_origem, ie_dispersao, 
			cd_setor_paciente, nr_seq_conta_origem, nr_seq_parcial, nr_seq_proc_interno, cd_senha, 
			nr_seq_aih, nr_doc_honor_conv, dt_conferencia, ie_tipo_atend_bpa, ie_grupo_atend_bpa, 
			cd_cgc_prestador_conta, cd_medico_exec_conta, nr_seq_pq_proc, qt_filme, nr_seq_proc_crit_repasse, 
			cd_senha_autor, cd_autor_convenio, nr_seq_regra_lanc, ie_tiss_tipo_guia, nr_seq_tiss_tabela, 
			ie_tiss_tipo_guia_honor, nr_seq_regra_preco, nr_minuto_duracao, ie_tiss_tipo_guia_desp, ie_tecnica_utilizada, 
			ie_tiss_tipo_despesa, cd_cgc_prestador_tiss, cd_cgc_honorario_tiss, ie_integracao, nr_seq_proc_acerto, 
			vl_original_tabela, cd_doenca_cid, nr_seq_apac, nr_seq_ajuste_proc, cd_tab_custo_preco, 
			nr_seq_proc_autor		 
		from	procedimento_paciente 
		where	nr_sequencia	= nr_sequencia_w;
 
		OPEN C02;
		LOOP 
		FETCH C02 into 
			nr_seq_partic_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin 
			select	max(nr_seq_partic) + 1 
			into STRICT	nr_seq_partic_ww 
			from	procedimento_participante;
 
			insert into procedimento_participante(nr_sequencia, nr_seq_partic, ie_funcao, dt_atualizacao, nm_usuario, 
				cd_pessoa_fisica, cd_cgc, ie_valor_informado, ie_emite_conta, vl_participante, 
				vl_conta, nr_lote_contabil, nr_conta_medico, ie_tipo_servico_sus, ie_tipo_ato_sus, 
				qt_ponto_sus, vl_ponto_sus, vl_original, ie_responsavel_credito, pr_procedimento, 
				cd_especialidade, pr_faturar, cd_medico_convenio, nr_doc_honor_conv, nr_seq_proc_crit_repasse, 
				ie_tiss_tipo_guia) 
			SELECT	nr_sequencia_ww, nr_seq_partic_ww, ie_funcao, clock_timestamp(), nm_usuario_p, 
				cd_pessoa_fisica, cd_cgc, ie_valor_informado, ie_emite_conta, vl_participante, 
				vl_conta, nr_lote_contabil, nr_conta_medico, ie_tipo_servico_sus, ie_tipo_ato_sus, 
				qt_ponto_sus, vl_ponto_sus, vl_original, ie_responsavel_credito, pr_procedimento, 
				cd_especialidade, pr_faturar, cd_medico_convenio, nr_doc_honor_conv, nr_seq_proc_crit_repasse, 
				ie_tiss_tipo_guia 
			from	procedimento_participante 
			where	nr_sequencia	= nr_sequencia_w 
			and	nr_seq_partic	= nr_seq_partic_w;
			end;
		END LOOP;
		CLOSE C02;
		 
	select	max(cd_motivo_exc_conta) 
	into STRICT	cd_motivo_exc_conta_w 
	from	parametro_faturamento 
	where	cd_estabelecimento = cd_estabelecimento_w;
 
	CALL excluir_matproc_conta(nr_sequencia_w, nr_interno_conta_p, coalesce(cd_motivo_exc_conta_w, 2), nr_sequencia_ww || ' - ' || cd_procedimento_w || ' - ' || ie_origem_proced_w , 'P', nm_usuario_p);
 
	end if;
 
	end;
END LOOP;
CLOSE C01;
 
if (qt_proc_unif_w	> 0) then 
	CALL recalcular_conta_paciente(nr_interno_conta_p, nm_usuario_p);
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_converter_conta_unif ( nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

