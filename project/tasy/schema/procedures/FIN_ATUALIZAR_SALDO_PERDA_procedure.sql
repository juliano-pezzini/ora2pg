-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_atualizar_saldo_perda ( nr_seq_perda_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_perda_w	double precision;
vl_baixa_w	double precision;
vl_saldo_w	double precision;
dt_liquidacao_w	timestamp;
dt_baixa_w	timestamp;


BEGIN
select	coalesce(max(vl_perdas),0),
	max(dt_liquidacao)
into STRICT	vl_perda_w,
	dt_liquidacao_w
from	perda_contas_receber
where	nr_sequencia = nr_seq_perda_p;

select	coalesce(max(dt_baixa),clock_timestamp())
into STRICT	dt_baixa_w
from	perda_contas_receb_baixa
where	nr_seq_perda = nr_seq_perda_p;

select	coalesce(sum(vl_baixa),0)
into STRICT	vl_baixa_w
from	perda_contas_receb_baixa a,
	fin_tipo_baixa_perda b
where	a.nr_seq_tipo_baixa = b.nr_sequencia
and	nr_seq_perda = nr_seq_perda_p
and	ie_tipo_consistencia in (0,1,2,4,5);

vl_saldo_w := vl_perda_w - vl_baixa_w;

if (vl_saldo_w > vl_perda_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(214968,	'VL_PERDA='||TO_CHAR(vl_perda_w,'999,999,999,990.00') ||
							';VL_BAIXA='||TO_CHAR(vl_baixa_w,'999,999,999,990.00')||
							';VL_SALDO='||TO_CHAR(vl_saldo_w,'999,999,999,990.00'));
elsif (vl_saldo_w < 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(214973,	'VL_PERDA='||TO_CHAR(vl_perda_w,'999,999,999,990.00') ||
							';VL_BAIXA='||TO_CHAR(vl_baixa_w,'999,999,999,990.00')||
							';VL_SALDO='||TO_CHAR(vl_saldo_w,'999,999,999,990.00'));
end if;

if (coalesce(dt_liquidacao_w::text, '') = '') and (vl_saldo_w = 0) then
	dt_liquidacao_w := dt_baixa_w;
elsif (dt_liquidacao_w IS NOT NULL AND dt_liquidacao_w::text <> '') and (vl_saldo_w > 0) then
	dt_liquidacao_w := null;
end if;

update	perda_contas_receber
set	vl_saldo = vl_saldo_w,
	dt_atualizacao = clock_timestamp(),
	nm_usuario = nm_usuario_p,
	dt_liquidacao = dt_liquidacao_w
where	nr_sequencia = 	nr_seq_perda_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_atualizar_saldo_perda ( nr_seq_perda_p bigint, nm_usuario_p text) FROM PUBLIC;

