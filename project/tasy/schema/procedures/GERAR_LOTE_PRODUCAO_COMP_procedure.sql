-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_producao_comp ( nr_lote_producao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w				integer;
qt_prevista_w				double precision;
qt_lote_padrao_w				double precision;

qt_fixa_w					double precision;
qt_variavel_w				double precision;
qt_conv_Est_consumo_w			double precision;
qt_prevista_cons_w				double precision;
qt_prevista_etq_w				double precision;
nr_sequencia_w				bigint;
cd_material_comp_w			integer;
cd_unidade_medida_w			varchar(30);
cd_unidade_medida_estoque_w		varchar(30);
cd_local_estoque_w			smallint;
qt_conv_est_Cons_Lote_w			double precision;
cd_estabelecimento_w			smallint;
nr_ficha_tecnica_w				bigint;

/* Serviços  */

ie_permite_vincular_servico_w		varchar(1) := 'N';
nr_seq_proc_interno_w			bigint;
qt_item_w				double precision;
vl_item_w					double precision;
nr_sequencia_serv_w			bigint;

qt_disp_estoque_atual_w			double precision;
nr_seq_componente_w			lote_producao_comp.nr_sequencia%type;

C01 CURSOR FOR
SELECT	coalesce(b.qt_fixa,0),
	coalesce(b.qt_variavel,0),
	a.qt_lote_padrao,
	m.qt_conv_estoque_consumo,
	b.cd_material,
	substr(obter_dados_material_estab(m.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
	substr(obter_dados_material_estab(m.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
	b.nr_seq_componente
from	material m,
    	ficha_tecnica_componente b,
    	ficha_tecnica a
where 	a.nr_ficha_tecnica   = b.nr_ficha_tecnica
and 	b.ie_situacao          = 'A'
and 	b.ie_tipo_componente   = 1
and 	b.cd_material          = m.cd_material
and 	a.cd_material          = cd_material_w
and	a.cd_estabelecimento  = cd_estabelecimento_w;

/* Serviços */

C02 CURSOR FOR
SELECT	coalesce(b.qt_fixa,0),
	coalesce(b.qt_variavel,0),
	a.qt_lote_padrao,
	b.nr_seq_proc_interno,
	b.nr_seq_componente,
	a.nr_ficha_tecnica
from	ficha_tecnica_componente b,
    	ficha_tecnica a
where 	a.nr_ficha_tecnica   = b.nr_ficha_tecnica
and 	b.ie_situacao          = 'A'
and 	b.ie_tipo_componente   = 2
and		a.cd_estabelecimento = cd_estabelecimento_w
and 	a.cd_material          = cd_material_w
and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
and	not exists (	select	1
			from	lote_producao_serv x
			where	x.nr_lote_producao = nr_lote_producao_p);


BEGIN

select	a.cd_material,
	a.qt_prevista,
	a.cd_local_estoque,
	CASE WHEN a.cd_unidade_medida=substr(obter_dados_material_estab(a.cd_material,a.cd_estabelecimento,'UMS'),1,30) THEN  1  ELSE m.qt_conv_estoque_consumo END ,
	a.cd_estabelecimento
INTO STRICT	cd_material_w,
	qt_prevista_w,
	cd_local_estoque_w,
	qt_conv_est_Cons_Lote_w,
	cd_estabelecimento_w
from	material m,
	lote_producao a
where 	nr_lote_producao = nr_lote_producao_p
and 	a.cd_material = m.cd_material;

delete	FROM consist_comp_lote_prod
where	nr_lote_producao = nr_lote_producao_p;
commit;

/*Pega o tempo para controle do item do inventário conforme parâmetro [199] do PalmWeb ( Usuário que está realizando a contagem )*/

ie_permite_vincular_servico_w := obter_param_usuario(143, 307, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_vincular_servico_w);

qt_prevista_w  	 := qt_prevista_w * qt_conv_est_Cons_Lote_w;

OPEN C01;
LOOP
	FETCH C01 into
		qt_fixa_w,
		qt_variavel_w,
		qt_lote_padrao_w,
		qt_conv_Est_consumo_w,
		cd_material_comp_w,
		cd_unidade_medida_w,
		cd_unidade_medida_estoque_w,
		nr_sequencia_w;
      EXIT WHEN NOT FOUND; /* apply on C01 */
            begin

		select	max(nr_sequencia)
		into STRICT	nr_seq_componente_w
		from	lote_producao_comp
		where	nr_lote_producao = nr_lote_producao_p
		and	nr_sequencia = nr_sequencia_w;

		if (nr_seq_componente_w IS NOT NULL AND nr_seq_componente_w::text <> '') then
			delete
			from 	lote_producao_comp
			where	nr_lote_producao = nr_lote_producao_p
			and	nr_sequencia = nr_seq_componente_w;
		end if;

		qt_prevista_cons_w := (qt_variavel_w * qt_prevista_w ) +
				      (qt_fixa_w * qt_prevista_w / qt_lote_padrao_w );

	 	qt_prevista_etq_w  := qt_prevista_Cons_w / qt_conv_Est_consumo_w;

		select	obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_comp_w, cd_local_estoque_w, clock_timestamp())
		into STRICT	qt_disp_estoque_atual_w
		;

		if (qt_disp_estoque_atual_w < qt_prevista_etq_w) then
			CALL gerar_consist_comp_lote_prod(	nr_lote_producao_p,
							cd_material_comp_w,
							'S',
							wheb_mensagem_pck.get_texto(313578), -- 313578 - Sem saldo para geração do lote
							nm_usuario_p,
							qt_disp_estoque_atual_w);
		end if;

		insert into lote_producao_comp(nr_lote_producao,
			 nr_sequencia,
			 cd_material,
			 cd_unidade_medida,
			 cd_unid_med_etq,
			 cd_local_estoque,
			 dt_atualizacao,
			 nm_usuario,
			 qt_prevista_etq,
			 qt_prevista,
			 qt_real,
			 qt_estoque,
			 qt_perda,
			 qt_perda_etq)
		values (nr_lote_producao_p,
			 nr_sequencia_w,
			 cd_material_comp_w,
			 cd_unidade_medida_w,
	    		 cd_unidade_medida_estoque_w,
			 cd_local_estoque_w,
			 clock_timestamp(),
			 nm_usuario_p,
			 coalesce(qt_prevista_etq_w,0),
			 coalesce(qt_prevista_cons_w,0),
			 0, 0, 0, 0);
		end;
end loop;
close C01;

if (coalesce(ie_permite_vincular_servico_w,'N') = 'S') then
	begin
	OPEN C02;
	LOOP
		FETCH C02 into
			qt_fixa_w,
			qt_variavel_w,
			qt_lote_padrao_w,
			nr_seq_proc_interno_w,
			nr_sequencia_w,
			nr_ficha_tecnica_w;
	      EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			/* Obter  a quantidade do procedimento */

			qt_item_w := cus_obter_qt_servico_prod(nr_ficha_tecnica_w, cd_estabelecimento_w, nr_sequencia_w, clock_timestamp(), qt_fixa_w) * qt_prevista_w;

			/* Obter o valor padrão do procedimento */

			vl_item_w := (qt_item_w * qt_prevista_w * cus_obter_preco_padrao_proc(cd_estabelecimento_w, clock_timestamp(), nr_seq_proc_interno_w));

			select	nextval('lote_producao_serv_seq')
			into STRICT	nr_sequencia_serv_w
			;

			insert into lote_producao_serv(nr_lote_producao,
				 nr_sequencia,
				 nr_seq_proc_interno,
				 dt_atualizacao,
				 nm_usuario,
				 qt_item,
				 vl_item)
			values (nr_lote_producao_p,
				 nr_sequencia_serv_w,
				 nr_seq_proc_interno_w,
				 clock_timestamp(),
				 nm_usuario_p,
				 coalesce(qt_item_w,0),
				 vl_item_w);
			end;
	END LOOP;
	close C02;
	end;
end if;

COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_producao_comp ( nr_lote_producao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

