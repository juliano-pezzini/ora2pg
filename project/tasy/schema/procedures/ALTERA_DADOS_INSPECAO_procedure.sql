-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_dados_inspecao ( nr_nota_fiscal_p text, nr_ordem_compra_p bigint, nr_sequencia_p bigint, cd_cnpj_p text, dt_entrega_real_p timestamp, ie_opcao_p bigint, nm_usuario_p text, cd_condicao_pagamento_p bigint default 0) AS $body$
DECLARE

 
/*ie_opcao_p 
 0 - Alterar todos com o mesmo número de nota 
 1 - Alterar todos com o mesmo número de ordem*/
 
  
cd_cgc_velho_w			varchar(14);
ds_razao_velha_w		varchar(100);
ds_razao_novo_w			varchar(100);
ds_historico_w			varchar(2000);
nr_seq_registro_w		bigint;
				

BEGIN 
if (ie_opcao_p = 0) then 
	begin 
	update	inspecao_recebimento 
	set	dt_entrega_real	= dt_entrega_real_p, 
		cd_cgc		= CASE WHEN cd_cnpj_p='X' THEN cd_cgc  ELSE cd_cnpj_p END  
	where	nr_nota_fiscal	= nr_nota_fiscal_p 
	and	coalesce(dt_liberacao::text, '') = '';	
	 
	if (coalesce(cd_condicao_pagamento_p,0) > 0) then 
		update	inspecao_recebimento 
		set	cd_condicao_pagamento = cd_condicao_pagamento_p 
		where	nr_nota_fiscal	= nr_nota_fiscal_p 
		and	coalesce(dt_liberacao::text, '') = '';
	end if;
	end;
elsif (ie_opcao_p = 1) then 
	begin 
	update	inspecao_recebimento 
	set	dt_entrega_real	= dt_entrega_real_p, 
		cd_cgc		= CASE WHEN cd_cnpj_p='X' THEN cd_cgc  ELSE cd_cnpj_p END  
	where	nr_ordem_compra	= nr_ordem_compra_p 
	and	coalesce(dt_liberacao::text, '') = '';
	 
	if (coalesce(cd_condicao_pagamento_p,0) > 0) then 
		update	inspecao_recebimento 
		set	cd_condicao_pagamento = cd_condicao_pagamento_p 
		where	nr_ordem_compra	= nr_ordem_compra_p 
		and	coalesce(dt_liberacao::text, '') = '';
	end if;
	end;
end if;
 
if (cd_cnpj_p <> 'X') then 
 
	if (nr_ordem_compra_p > 0) then 
	 
		select	cd_cgc_fornecedor, 
			substr(obter_nome_pf_pj(null, cd_cgc_fornecedor),1,100), 
			substr(obter_nome_pf_pj(null, cd_cnpj_p),1,100) 
		into STRICT	cd_cgc_velho_w, 
			ds_razao_velha_w, 
			ds_razao_novo_w 
		from	ordem_compra 
		where	nr_ordem_compra = nr_ordem_compra_p;
	 
		update	ordem_compra 
		set	cd_cgc_fornecedor	= cd_cnpj_p 
		where	nr_ordem_compra		= nr_ordem_compra_p;
		 
		/* 
		Alterado o fornecedor da ordem de compra através da opção Alterar dados simultaneamente, que existe na Inspeção recebimento. 
		Antes: #@CD_CGC_OLD#@ - #@DS_RAZAO_SOCIAL_OLD#@ 
		Depois: #@CD_CGC_NEW#@ - #@DS_RAZAO_SOCIAL_NEW#@ 
		*/
 
		 
		ds_historico_w := substr(	wheb_mensagem_pck.get_texto(297056, 
					'CD_CGC_OLD=' || cd_cgc_velho_w || ';DS_RAZAO_SOCIAL_OLD=' || ds_razao_velha_w || 
					';CD_CGC_NEW=' || cd_cnpj_p || ';DS_RAZAO_SOCIAL_NEW=' || ds_razao_novo_w),1,2000);
						 
		 
		CALL inserir_historico_ordem_compra( 
			nr_ordem_compra_p, 
			'S', 
			wheb_mensagem_pck.get_texto(297051)/*'Alteração fornecedor'*/
, 
			ds_historico_w, 
			nm_usuario_p);
	end if;
 
	select	coalesce(max(nr_seq_registro),0) 
	into STRICT	nr_seq_registro_w 
	from	inspecao_recebimento 
	where	nr_sequencia = nr_sequencia_p;
	 
	if (nr_seq_registro_w > 0) then 
		update	inspecao_registro 
		set	cd_cnpj = cd_cnpj_p 
		where	nr_sequencia = nr_seq_registro_w;	
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_dados_inspecao ( nr_nota_fiscal_p text, nr_ordem_compra_p bigint, nr_sequencia_p bigint, cd_cnpj_p text, dt_entrega_real_p timestamp, ie_opcao_p bigint, nm_usuario_p text, cd_condicao_pagamento_p bigint default 0) FROM PUBLIC;

