-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_benef_mens_sca ( dt_ano_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_mes_w			timestamp;
dt_mes_final_w			timestamp;
nr_seq_segurado_w		bigint;
dt_fim_mes_atual_w		timestamp;
dt_rescisao_w			timestamp;
nr_seq_w_pls_benef_w		bigint;
nr_seq_plano_w			bigint;
dt_mes_atual_w			timestamp;
qt_idade_w			bigint;
cd_pessoa_fisica_w		varchar(10);
i_w				bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.nr_seq_plano
	from	pls_sca_vinculo	b,
		pls_segurado 	a
	where	b.nr_seq_segurado	= a.nr_sequencia
	and	trunc(b.dt_inicio_vigencia,'MOnth') = trunc(dt_mes_w,'MOnth')
	and	not exists (	SELECT	1
				from	w_pls_benef_movto_mes_sca x
				where	a.nr_sequencia	= x.nr_seq_segurado
				and	x.dt_referencia	= dt_mes_w)
	and	((dt_fim_vigencia >= dt_mes_w) or (coalesce(dt_fim_vigencia::text, '') = ''));


BEGIN

dt_mes_w	:= dt_ano_p;
dt_mes_final_w	:= add_months(dt_ano_p,11);
dt_mes_atual_w	:= trunc(clock_timestamp(),'month');
i_w		:= 0;

if (dt_mes_final_w >= clock_timestamp()) then
	dt_mes_final_w := dt_mes_atual_w;
end if;

WHILE(dt_mes_w <= dt_mes_final_w) LOOP
	BEGIN
	dt_fim_mes_atual_w	:= last_day(dt_mes_w);

	open C01;
	loop
	fetch C01 into
		nr_seq_segurado_w,
		nr_seq_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		i_w	:= i_w +1;

		select	nextval('w_pls_benef_movto_mes_sca_seq')
		into STRICT	nr_seq_w_pls_benef_w
		;

		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_w;

		qt_idade_w	:= obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A');

		insert into w_pls_benef_movto_mes_sca(	nr_sequencia, dt_referencia, cd_estabelecimento, nr_seq_segurado, dt_atualizacao,
							nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_sca,qt_idade)
						values (	nr_seq_w_pls_benef_w, dt_mes_w, cd_estabelecimento_p, nr_seq_segurado_w, clock_timestamp(),
							nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_plano_w,qt_idade_w);

		if (i_w = 1000) then
			i_w := 0;
			commit;
		end if;
		end;
	end loop;
	close C01;

	dt_mes_w	:= add_months(dt_mes_w,1);
	END;
END LOOP;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_benef_mens_sca ( dt_ano_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

