-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_atend_visita_saida ( nr_sequencia_p bigint, nr_atendimento_p bigint, nr_seq_texto_p bigint, cd_estabelecimento_p bigint, ds_retorno_p INOUT text, tp_acom_convenio_p INOUT text, ds_setor_p INOUT text, cd_setor_p INOUT text, ds_leito_p INOUT text, nm_usuario_p text) AS $body$
DECLARE

 
qt_dia_w		bigint;
nr_senha_espera_w	integer;
tp_acom_convenio_w	varchar(100);
ds_setor_w		varchar(100);
ds_leito_w		varchar(100);
cd_setor_w		varchar(100);
ds_botao_w		varchar(4000);


BEGIN 
if (nr_seq_texto_p IS NOT NULL AND nr_seq_texto_p::text <> '') then 
	begin 
	ds_botao_w := obter_texto_dic_objeto(nr_seq_texto_p , wheb_usuario_pck.get_nr_seq_idioma, null);
 
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then 
		gerar_visitante_saida(nr_sequencia_p, nm_usuario_p, ds_botao_w, 'S');
	end if;
	end;
end if;
 
 
if (coalesce(nr_atendimento_p,0) > 0) then 
	begin 
	-- Ocupação hospitalar - Parâmetro [30] - Quantidade de dias relacionados ao controle de visitas 
	qt_dia_w := obter_param_usuario(44, 30, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_dia_w);
 
	select	min(nr_senha_espera_w) 
	into STRICT	nr_senha_espera_w 
	from	atendimento_visita 
	where	nr_atendimento	= nr_atendimento_p 
	and	dt_entrada between(clock_timestamp() - qt_dia_w) and clock_timestamp() 
	and	ie_status	= 'A' 
	and	coalesce(dt_saida::text, '') = '';
	end;
	 
	tp_acom_convenio_w	:= obter_tipo_acomod_atual(nr_atendimento_p,'D');
	ds_setor_w		:= obter_nome_setor(obter_setor_atendimento(nr_atendimento_p));
	 
	select 	SUBSTR(obter_unidade_atendimento(nr_atendimento_p,'IAA','U'),1,10) 
	into STRICT	ds_leito_w 
	;
	 
end if;
 
if (nr_senha_espera_w IS NOT NULL AND nr_senha_espera_w::text <> '') then 
	ds_retorno_p	:= substr(obter_texto_tasy(42514, wheb_usuario_pck.get_nr_seq_idioma),1,255)||' '||nr_senha_espera_w;
end if;
 
Select	obter_nome_setor(cd_setor_p) 
into STRICT	cd_setor_w
;
 
 
tp_acom_convenio_p	:= tp_acom_convenio_w;
ds_setor_p		:= ds_setor_w;
ds_leito_p		:= ds_leito_w;
cd_setor_p 		:= cd_setor_w;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_atend_visita_saida ( nr_sequencia_p bigint, nr_atendimento_p bigint, nr_seq_texto_p bigint, cd_estabelecimento_p bigint, ds_retorno_p INOUT text, tp_acom_convenio_p INOUT text, ds_setor_p INOUT text, cd_setor_p INOUT text, ds_leito_p INOUT text, nm_usuario_p text) FROM PUBLIC;

