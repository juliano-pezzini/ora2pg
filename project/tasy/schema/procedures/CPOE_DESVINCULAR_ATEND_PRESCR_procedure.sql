-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_desvincular_atend_prescr ( nr_prescricao_p prescr_medica.nr_prescricao%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE

 
ie_existe_cpoe_w		char(1);
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;


BEGIN 
 
select	max(cd_pessoa_fisica) 
into STRICT	cd_pessoa_fisica_w 
from	prescr_medica 
where	(coalesce(dt_liberacao_medico, dt_liberacao, dt_liberacao_farmacia) IS NOT NULL AND (coalesce(dt_liberacao_medico, dt_liberacao, dt_liberacao_farmacia))::text <> '') 
and		nr_prescricao = nr_prescricao_p;
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_existe_cpoe_w 
	from	prescr_medica a 
	where	a.nr_prescricao = nr_prescricao_p 
	and		exists (	SELECT	1 
					from	prescr_dieta b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_dieta_cpoe IS NOT NULL AND b.nr_seq_dieta_cpoe::text <> '') 
					
union all
 
					SELECT	1 
					from	nut_pac b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_npt_cpoe IS NOT NULL AND b.nr_seq_npt_cpoe::text <> '') 
					
union all
 
					select	1 
					from	rep_jejum b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_dieta_cpoe IS NOT NULL AND b.nr_seq_dieta_cpoe::text <> '') 
					
union all
 
					select	1 
					from	prescr_leite_deriv b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_dieta_cpoe IS NOT NULL AND b.nr_seq_dieta_cpoe::text <> '') 
					
union all
 
					select	1 
					from	prescr_material b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(coalesce(b.nr_seq_mat_cpoe,b.nr_seq_dieta_cpoe) IS NOT NULL AND (coalesce(b.nr_seq_mat_cpoe,b.nr_seq_dieta_cpoe))::text <> '') 
					
union all
 
					select	1 
					from	prescr_gasoterapia b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_gas_cpoe IS NOT NULL AND b.nr_seq_gas_cpoe::text <> '') 
					
union all
 
					select	1 
					from	prescr_procedimento b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_proc_cpoe IS NOT NULL AND b.nr_seq_proc_cpoe::text <> '') 
					
union all
 
					select	1 
					from	prescr_solic_bco_sangue b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_hemo_cpoe IS NOT NULL AND b.nr_seq_hemo_cpoe::text <> '') 
					
union all
 
					select	1 
					from	prescr_solucao b 
					where	b.nr_prescricao = a.nr_prescricao 
					and		(b.nr_seq_dialise_cpoe IS NOT NULL AND b.nr_seq_dialise_cpoe::text <> '') );
	 
	if (ie_existe_cpoe_w = 'S') then 
		update	cpoe_dieta a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_dieta b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_dieta_cpoe = a.nr_sequencia 
						
union all
 
						SELECT	1 
						from	nut_pac b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_npt_cpoe = a.nr_sequencia 
						
union all
 
						select	1 
						from	prescr_material b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_dieta_cpoe = a.nr_sequencia 
						
union all
 
						select	1 
						from	prescr_leite_deriv b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_dieta_cpoe = a.nr_sequencia 
						
union all
 
						select	1 
						from	rep_jejum b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_dieta_cpoe = a.nr_sequencia );
						 
		update	cpoe_material a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_material b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_mat_cpoe = a.nr_sequencia );
 
		update	cpoe_procedimento a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_procedimento b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_proc_cpoe = a.nr_sequencia );
 
		update	cpoe_hemoterapia a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_solic_bco_sangue b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_hemo_cpoe = a.nr_sequencia );
 
		update	cpoe_gasoterapia a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_gasoterapia b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_gas_cpoe = a.nr_sequencia );
 
		update	cpoe_recomendacao a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_recomendacao b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_rec_cpoe = a.nr_sequencia );
 
		update	cpoe_dialise a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_solucao b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_dialise_cpoe = a.nr_sequencia );
						 
		update	cpoe_anatomia_patologica a 
		set		a.nr_atendimento  = NULL, 
				a.cd_pessoa_fisica = cd_pessoa_fisica_w, 
				a.dt_atualizacao = clock_timestamp(), 
				a.nm_usuario = nm_usuario_p 
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and		exists (	SELECT	1 
						from	prescr_procedimento b 
						where	b.nr_prescricao = nr_prescricao_p 
						and		b.nr_seq_proc_cpoe = a.nr_sequencia 
						and	 ie_tipo_proced in ('AP','APH','APC'));
						 
		commit;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_desvincular_atend_prescr ( nr_prescricao_p prescr_medica.nr_prescricao%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;

