-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_resumo_proc_vini ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_procedimento_p bigint, qt_percet_adminis_p INOUT bigint, qt_administrados_p INOUT bigint, dt_primeira_util_p INOUT timestamp, dt_ultima_util_p INOUT timestamp) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
ie_origem_proced_w		integer;
qt_total_prescrito_w	bigint;
qt_total_suspensos_w	bigint;
qt_total_administrados_w  bigint;
dt_min_w	timestamp;
dt_max_w	timestamp;
dt_atual_w	timestamp;
dt_Suspensao_w	timestamp;
dt_fim_horario_w timestamp;
qt_prescr_hor_w	bigint;
qt_dias_prescritos_w	bigint;

C01 CURSOR FOR
SELECT 	a.dt_horario,
		a.dt_suspensao,
		a.dt_fim_horario,
		c.qt_procedimento
from 	Prescr_medica b,
	prescr_procedimento c,
	prescr_proc_hor a
where	a.nr_prescricao = b.nr_prescricao
and 	a.nr_seq_procedimento = c.nr_sequencia
and 	a.nr_prescricao = c.nr_prescricao
and 	a.ie_origem_proced = c.ie_origem_proced
and	a.cd_procedimento = cd_procedimento_p
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND b.nr_atendimento = nr_atendimento_p) or
	((Cd_pessoa_fisica_w IS NOT NULL AND Cd_pessoa_fisica_w::text <> '') and (coalesce(nr_atendimento_p::text, '') = '') and (b.cd_pessoa_fisica = cd_pessoa_fisica_w)))
and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and a.dt_horario < clock_timestamp();


BEGIN

select 	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from 	Prescr_medica
where (((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(nr_atendimento_p::text, '') = '') and (nr_prescricao = nr_prescricao_p)) or
	(nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nr_atendimento = nr_atendimento_p));

select Max(a.ie_origem_proced)
into STRICT	ie_origem_proced_w
from 	prescr_medica b,
		prescr_procedimento a
where	a.nr_prescricao = b.nr_prescricao
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND b.nr_atendimento = nr_atendimento_p) or
	((Cd_pessoa_fisica_w IS NOT NULL AND Cd_pessoa_fisica_w::text <> '') and (coalesce(nr_atendimento_p::text, '') = '') and (b.cd_pessoa_fisica = cd_pessoa_fisica_w)))
and 	a.cd_procedimento = cd_procedimento_p;

dt_min_w 	:= null;
dt_max_w 	:= null;
qt_total_suspensos_w 	:= 0;
qt_total_prescrito_w	:= 0;
qt_total_administrados_w	:= 0;
qt_dias_prescritos_w 	:= 0;

open C01;
loop
fetch C01 into
	dt_atual_w,
	dt_Suspensao_w,
	dt_fim_horario_w,
	qt_prescr_hor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (dt_atual_w < dt_min_w) or (coalesce(dt_min_w::text, '') = '') then
		dt_min_w := dt_atual_w;
	end if;

	if (dt_atual_w > dt_max_w) or (coalesce(dt_max_w::text, '') = '') then
		dt_max_w := dt_atual_w;
	end if;

	if (dt_Suspensao_w IS NOT NULL AND dt_Suspensao_w::text <> '') then
		qt_total_suspensos_w := qt_total_suspensos_w + qt_prescr_hor_w;
		qt_total_prescrito_w := qt_total_prescrito_w + qt_prescr_hor_w;
	end if;

	if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '') then
		qt_total_administrados_w := qt_total_administrados_w + qt_prescr_hor_w;
		qt_total_prescrito_w := qt_total_prescrito_w + qt_prescr_hor_w;
	end if;
	--qt_dias_prescritos_w := qt_dias_prescritos_w + 1
	end;
end loop;
close C01;

qt_percet_adminis_p 	:=  (dividir(qt_total_administrados_w, qt_total_prescrito_w))*100;
qt_administrados_p		:=  qt_total_administrados_w;
dt_primeira_util_p  	:=  dt_min_w;
dt_ultima_util_p		:=  dt_max_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_resumo_proc_vini ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_procedimento_p bigint, qt_percet_adminis_p INOUT bigint, qt_administrados_p INOUT bigint, dt_primeira_util_p INOUT timestamp, dt_ultima_util_p INOUT timestamp) FROM PUBLIC;

