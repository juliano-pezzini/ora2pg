-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_lote_prot_reemb ( nr_seq_lote_reemb_cred_p pls_protocolo_conta.nr_seq_lote_reemb_cred%type, nm_usuario_p text) AS $body$
DECLARE

 
dt_vencimento_w		pls_lote_reemb_credito.dt_vencimento%type;
dt_geracao_titulos_w	pls_lote_reemb_credito.dt_geracao_titulos%type;
			
C01 CURSOR(	nr_seq_lote_reemb_cred_pc	pls_protocolo_conta.nr_seq_lote_reemb_cred%type) FOR 
	SELECT		a.nr_sequencia nr_seq_protocolo 
	from		pls_protocolo_conta a 
	where		a.nr_seq_lote_reemb_cred	= nr_seq_lote_reemb_cred_pc;

BEGIN 
 
select	a.dt_vencimento, 
	a.dt_geracao_titulos 
into STRICT	dt_vencimento_w, 
	dt_geracao_titulos_w 
from	pls_lote_reemb_credito a 
where	a.nr_sequencia	= nr_seq_lote_reemb_cred_p;
 
if (dt_geracao_titulos_w IS NOT NULL AND dt_geracao_titulos_w::text <> '') then 
	--Não foi possível gerar os títulos. Já havia sido efetuada a geração de títulos para esse lote. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(306991);
end if;
 
for r_C01_w in c01(nr_seq_lote_reemb_cred_p) loop 
	CALL pls_gerar_titulo_prot_reemb(	r_C01_w.nr_seq_protocolo, 
						dt_vencimento_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						'N', 
						null);
end loop;
 
update 	pls_lote_reemb_credito 
set	dt_geracao_titulos	= clock_timestamp(), 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p 
where	nr_sequencia		= nr_seq_lote_reemb_cred_p;	
 
commit;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_lote_prot_reemb ( nr_seq_lote_reemb_cred_p pls_protocolo_conta.nr_seq_lote_reemb_cred%type, nm_usuario_p text) FROM PUBLIC;

