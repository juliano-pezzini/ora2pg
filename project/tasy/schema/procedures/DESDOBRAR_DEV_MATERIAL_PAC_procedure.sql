-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_dev_material_pac ( nr_devolucao_p bigint, nm_usuario_p text, nr_dev_gerada_p INOUT bigint) AS $body$
DECLARE


nr_devolucao_w	bigint;
nr_sequencia_w	integer;
nr_sequencia_ww	integer;

qt_controlados_w	bigint;
qt_nao_controlados_w	bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	item_devolucao_material_pac
	where	nr_devolucao = nr_devolucao_p
	and	substr(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'S';

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	item_devolucao_material_pac
	where	nr_devolucao = nr_devolucao_p
	order by nr_sequencia asc;


BEGIN

select	count(*)
into STRICT	qt_controlados_w
from	item_devolucao_material_pac
where	nr_devolucao = nr_devolucao_p
and	substr(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'S';

select	count(*)
into STRICT	qt_nao_controlados_w
from	item_devolucao_material_pac
where	nr_devolucao = nr_devolucao_p
and	substr(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'N';

if (qt_controlados_w > 0) and (qt_nao_controlados_w > 0) then
	begin
	select	nextval('devolucao_material_pac_seq')
	into STRICT	nr_devolucao_w
	;

	insert into devolucao_material_pac(
		cd_pessoa_fisica_devol,
		cd_setor_atendimento,
		ds_justificativa,
		dt_atualizacao,
		dt_baixa_total,
		dt_devolucao,
		dt_entrada_unidade,
		dt_entrega_fisica,
		dt_impressao,
		dt_liberacao_baixa,
		nm_usuario,
		nm_usuario_baixa,
		nm_usuario_devol,
		nm_usuario_entrega,
		nr_atendimento,
		nr_devolucao,
		nr_doc_interno)
	SELECT	cd_pessoa_fisica_devol,
		cd_setor_atendimento,
		ds_justificativa,
		dt_atualizacao,
		dt_baixa_total,
		dt_devolucao,
		dt_entrada_unidade,
		dt_entrega_fisica,
		dt_impressao,
		dt_liberacao_baixa,
		nm_usuario,
		nm_usuario_baixa,
		nm_usuario_devol,
		nm_usuario_entrega,
		nr_atendimento,
		nr_devolucao_w,
		nr_doc_interno
	from	devolucao_material_pac
	where	nr_devolucao = nr_devolucao_p;

	open c01;
	loop
	fetch c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		select (coalesce(max(nr_sequencia),0) + 1)
		into STRICT	nr_sequencia_ww
		from	item_devolucao_material_pac
		where	nr_devolucao = nr_devolucao_w;

		insert into item_devolucao_material_pac(
			cd_cgc_fornec,
			cd_local_estoque,
			cd_material,
			cd_material_dev,
			cd_motivo_devolucao,
			cd_pessoa_fisica_receb,
			cd_setor_atendimento,
			cd_unidade_medida,
			ds_justificativa,
			dt_atendimento,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_baixa_conta,
			dt_emissao_loc_estoque,
			dt_entrada_unidade,
			dt_recebimento,
			ie_baixa,
			ie_geracao,
			ie_tipo_baixa_estoque,
			nm_usuario,
			nm_usuario_baixa_conta,
			nm_usuario_devol,
			nm_usuario_justif,
			nm_usuario_nrec,
			nm_usuario_receb,
			nr_devolucao,
			nr_prescricao,
			nr_seq_atendimento,
			nr_seq_justificativa,
			nr_seq_lote,
			nr_seq_lote_fornec,
			nr_sequencia,
			nr_sequencia_prescricao,
			qt_material,
			qt_material_estoque)
		SELECT	cd_cgc_fornec,
			cd_local_estoque,
			cd_material,
			cd_material_dev,
			cd_motivo_devolucao,
			cd_pessoa_fisica_receb,
			cd_setor_atendimento,
			cd_unidade_medida,
			ds_justificativa,
			dt_atendimento,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_baixa_conta,
			dt_emissao_loc_estoque,
			dt_entrada_unidade,
			dt_recebimento,
			ie_baixa,
			ie_geracao,
			ie_tipo_baixa_estoque,
			nm_usuario,
			nm_usuario_baixa_conta,
			nm_usuario_devol,
			nm_usuario_justif,
			nm_usuario_nrec,
			nm_usuario_receb,
			nr_devolucao_w,
			nr_prescricao,
			nr_seq_atendimento,
			nr_seq_justificativa,
			nr_seq_lote,
			nr_seq_lote_fornec,
			nr_sequencia_ww,
			nr_sequencia_prescricao,
			qt_material,
			qt_material_estoque
		from	item_devolucao_material_pac
		where	nr_devolucao = nr_devolucao_p
		and	nr_sequencia = nr_sequencia_w;

		delete	FROM item_devolucao_material_pac
		where	nr_devolucao = nr_devolucao_p
		and	nr_sequencia = nr_sequencia_w;
		end;
	end loop;
	close c01;

	nr_sequencia_ww := 0;
	open c02;
	loop
	fetch c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		nr_sequencia_ww := (nr_sequencia_ww + 1);

		update	item_devolucao_material_pac
		set	nr_sequencia = nr_sequencia_ww
		where	nr_devolucao = nr_devolucao_p
		and	nr_sequencia = nr_sequencia_w;
		end;
	end loop;
	close c02;

	nr_dev_gerada_p := nr_devolucao_w;

	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_dev_material_pac ( nr_devolucao_p bigint, nm_usuario_p text, nr_dev_gerada_p INOUT bigint) FROM PUBLIC;

