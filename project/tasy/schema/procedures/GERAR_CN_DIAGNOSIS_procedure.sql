-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cn_diagnosis ( cd_doenca_p text default null, nr_sequencia_p bigint DEFAULT NULL, nr_atendimento_p bigint DEFAULT NULL, ie_commit_p text default 'S') AS $body$
DECLARE


cd_doenca_w evolucao_paciente_compl.cd_doenca%type;
rec_exist bigint;


BEGIN

select count(*)
into STRICT rec_exist
from evolucao_paciente_compl
where nr_seq_evo_paciente = nr_sequencia_p;

if (rec_exist > 0) then
    update evolucao_paciente_compl
	set cd_doenca = cd_doenca_p
    where nr_seq_evo_paciente = nr_sequencia_p;
elsif (rec_exist = 0)then
	if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then
		insert into evolucao_paciente_compl(
			cd_doenca,
			nr_seq_evo_paciente)
		values (cd_doenca_p,
			nr_sequencia_p);
	else
		select max(cd_doenca)
		into STRICT cd_doenca_w
		from diagnostico_doenca
		where   nr_atendimento = nr_atendimento_p
		and     ie_tipo_diagnostico IN (2, 3)
		and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and     ie_classificacao_doenca = 'P'
		and     dt_diagnostico = (SELECT max(b.dt_diagnostico)
								from diagnostico_doenca b
								where b.nr_atendimento = nr_atendimento_p
								and b.ie_tipo_diagnostico IN (2, 3)
								and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
								and b.ie_classificacao_doenca = 'P');

		if (cd_doenca_w IS NOT NULL AND cd_doenca_w::text <> '') then
			insert into evolucao_paciente_compl(
				cd_doenca,
				nr_seq_evo_paciente)
			values (cd_doenca_w,
				nr_sequencia_p);
			end if;
	end if;
end if;

if (ie_commit_p = 'S') then
  commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cn_diagnosis ( cd_doenca_p text default null, nr_sequencia_p bigint DEFAULT NULL, nr_atendimento_p bigint DEFAULT NULL, ie_commit_p text default 'S') FROM PUBLIC;

