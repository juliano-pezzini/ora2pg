-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_banrisul_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
ds_conteudo_w		varchar(4000) := null;
nr_seq_reg_arquivo_w	bigint := 1;
cd_conta_cobr_w		varchar(8);
cd_agencia_cobr_w	varchar(4);
ie_digito_conta_w	varchar(2);
nm_empresa_w		varchar(30);
dt_geracao_w		varchar(6);
cd_convenio_banco_w	varchar(6);
ie_digito_conta_cobr_w	varchar(1);
nr_remessa_w		bigint;
cd_cedente_w		varchar(9);

-- Detalhe 
nr_inscricao_empresa_w	varchar(14);
cd_agencia_bancaria_w	varchar(4);
cd_tipo_cobranca_w	varchar(2);
cd_conta_w		varchar(5);
ie_digito_conta_ww	varchar(1);
nr_titulo_w		varchar(10);
nr_nosso_numero_w	varchar(10);
dt_vencimento_w		varchar(6);
vl_titulo_w		varchar(13);
dt_emissao_w		varchar(6);
tx_mora_w		varchar(6);
tx_juros_w		varchar(6);
vl_desconto_w		varchar(13);
ie_tipo_inscricao_w	varchar(2);
nr_inscricao_w		varchar(14);
nm_pagador_w		varchar(35);
ds_endereco_w		varchar(40);	
ds_bairro_w		varchar(15);
cd_cep_w		varchar(8);
ds_municipio_w		varchar(15);
sg_estado_w		varchar(2);
cd_banco_w		titulo_receber_cobr.cd_banco%type;
cd_intrucao_escrit_w	varchar(2);
qt_dias_protesto_w	varchar(255);
vl_mora_w		varchar(12);
ie_instrucao_juros_w	varchar(1);
ie_instrucao_protesto_w varchar(2);

vl_total_titulo_w	double precision;
tx_multa_w		double precision;
nr_dias_multa_apos_venc_w varchar(2);

C01 CURSOR FOR 
	SELECT	lpad(coalesce(c.nr_titulo,'0'),10,'0') nr_titulo,		 
		coalesce(lpad(obter_nosso_numero_banco(c.cd_banco,c.nr_titulo),10,'0'),lpad(' ',10,' ')) nr_nosso_numero,		 
		to_char(coalesce(b.dt_pagamento_previsto,clock_timestamp()),'ddmmyy'), 
		lpad(replace(to_char(b.vl_titulo, 'fm00000000000.00'),'.',''),13,'0'), 
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'ddmmyy'), 
		lpad(replace(to_char(b.tx_juros, 'fm0000.00'),'.',''),6,'0'), 
		lpad('0',13,'0') vl_desconto, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') nr_inscricao, 
		substr(t.CD_TIPO_COBRANCA_EXT,1,2) cd_tipo_cobranca, 
		rpad(substr(coalesce(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),' '),1,35),35,' ') nm_pagador, 
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'EN'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'R')),' ')),1,40),40,' ') ds_endereco, 
		rpad(substr(upper(coalesce(elimina_caractere_especial(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'CEP'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'))),' ')),1,8),8,' ') cd_cep, 
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'CI'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI')),' ')),1,15),15,' ') ds_cidade, 
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'UF'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF')),' ')),1,2),2,' ') ds_uf, 
		c.cd_banco cd_banco, 
		lpad(coalesce(f.qt_dias_protesto,'0'),2,'0') qt_dias_protesto, 
		lpad(somente_numero(to_char(coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),'fm0000000000.00')),12,'0') vl_mora, 
		lpad(somente_numero(to_char(x.tx_multa,'fm00.0')),3,'0') tx_multa 
	FROM banco_estabelecimento e, titulo_receber_cobr c, titulo_receber_v b, titulo_receber x
LEFT OUTER JOIN pls_mensalidade d ON (x.nr_seq_mensalidade = d.nr_sequencia)
, cobranca_escritural a
LEFT OUTER JOIN tipo_cobr_escrit t ON (a.nr_seq_tipo = t.NR_SEQUENCIA)
LEFT OUTER JOIN banco_carteira f ON (a.nr_seq_carteira_cobr = f.nr_sequencia)
WHERE x.nr_titulo       = b.nr_titulo and c.nr_titulo       = b.nr_titulo and a.nr_sequencia     = c.nr_seq_cobranca and a.nr_seq_conta_banco  = e.nr_sequencia and a.nr_sequencia     = nr_seq_cobr_escrit_p;


BEGIN 
 
delete	FROM w_envio_banco 
where	nm_usuario = nm_usuario_p;
 
--Header 
select	lpad(coalesce(substr(b.cd_agencia_bancaria,1,4),'0'),4,'0'), 
	rpad(substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,30),30,' ') nm_empresa, 
	to_char(clock_timestamp(), 'DDMMYY'), 
	lpad(substr(coalesce(b.cd_cedente,b.cd_conta || coalesce(b.ie_digito_conta,'0')),1,9),9,'0') cd_cedente 
into STRICT	cd_agencia_cobr_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	cd_cedente_w 
from	banco_estabelecimento b, 
	cobranca_escritural a 
where	a.nr_seq_conta_banco	= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'01REMESSA' || --001 009 
			lpad(' ',17,' ') || --010 026 
			lpad(cd_agencia_cobr_w,4,'0') || --027 030 
			lpad(cd_cedente_w,9,'0') ||	--031 039	 
			lpad(' ',7,' ') || --040 046 
			nm_empresa_w ||	--047 076 
			'041BANRISUL' || --077 087	 
			lpad(' ',7,' ') || --088 094 
			dt_geracao_w || --095 100 
			rpad(' ',9,' ') || --101 109 
			rpad(' ',4,' ') || --110 113 
			' ' || --114 114 
			' ' || --115 115 
			' ' || --116 116 
			rpad(' ',10,' ') || --117 126 
			rpad(' ',268,' ') || --127 394	 
			lpad(nr_seq_reg_arquivo_w,6,'0'); --395 400 
insert into w_envio_banco(	nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
values (	nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
--Fim Header 
 
 
--Detalhe 
 
 
--begin 
open C01;
loop 
fetch C01 into	 
	nr_titulo_w, 
	nr_nosso_numero_w, 
	dt_vencimento_w, 
	vl_titulo_w , 
	dt_emissao_w, 
	tx_juros_w, 
	vl_desconto_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	cd_tipo_cobranca_w, 
	nm_pagador_w, 
	ds_endereco_w, 
	cd_cep_w, 
	ds_municipio_w, 
	sg_estado_w, 
	cd_banco_w, 
	qt_dias_protesto_w, 
	vl_mora_w, 
	tx_multa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	 
	select	lpad(substr(coalesce(max(a.CD_INSTRUCAO),'0'),1,2),2,'0') 
	into STRICT	cd_intrucao_escrit_w 
	from	INSTRUCAO_ESCRITURAL a 
	where	a.cd_banco = cd_banco_w 
	and 	(((cd_instrucao = '20' or cd_instrucao = '18') and tx_multa_w > 0) or (cd_instrucao <> '20' and cd_instrucao <> '18'));
	 
	if (cd_intrucao_escrit_w <> '20') or (cd_intrucao_escrit_w <> '18') then 
	  tx_multa_w := 000;
	end if;
	 
	if (ltrim(rtrim(cd_intrucao_escrit_w)) not in ('09','15')) then 
	  qt_dias_protesto_w := '00';
	end if;
	 
	if (coalesce(qt_dias_protesto_w::text, '') = '') or (qt_dias_protesto_w = '00') then 
		ie_instrucao_protesto_w := '00';
	elsif (cd_intrucao_escrit_w = '09') then 
		ie_instrucao_protesto_w := '00';
	elsif (cd_intrucao_escrit_w = '15') then 
		ie_instrucao_protesto_w := '00';
	else 
		ie_instrucao_protesto_w := '09';	
	end if;
	 
	if (coalesce(vl_mora_w::text, '') = '') or (vl_mora_w = '0') or (vl_mora_w = '000000000000') then 
		ie_instrucao_juros_w := ' ';
	else 
		ie_instrucao_juros_w := '1';
	end if;
	 
	if (cd_intrucao_escrit_w = '20') or (cd_intrucao_escrit_w = '18') then 
		nr_dias_multa_apos_venc_w := '00';
	else 
		nr_dias_multa_apos_venc_w := ' ';
	end if;	
 
	ds_conteudo_w	:=	'1' || --001 001 
				lpad(' ',16,' ') || --002 017 
				lpad(cd_agencia_cobr_w,4,'0') || lpad(cd_cedente_w,9,'0') ||	--018 030 
				lpad(' ',7,' ') || --031 037 
				lpad(' ',25,' ') || --038 062 
				nr_nosso_numero_w || --063 072 
				lpad(' ',32,' ') || --073 104 
				lpad(' ',3,' ') || --105 107 
				'1' || --108 108 
				'01' || --109 110 
				lpad(coalesce(nr_titulo_w,'0'),10,'0') || --111 120 
				dt_vencimento_w || --121 126 
				vl_titulo_w || --127 139 
				'041' || --140 142 
				lpad(' ',5,' ') || --143 147 
				lpad(coalesce(cd_tipo_cobranca_w,'06'),2,'0') || --148 149 
				'A' || --150 150 
				dt_emissao_w || --151 156 
				cd_intrucao_escrit_w || --157 158 
				ie_instrucao_protesto_w || --159 160 
				ie_instrucao_juros_w || --161 161 
				lpad(somente_numero(to_char(vl_mora_w,'fm0000000000.00')),12,'0') || --162 173 
				'000000' ||	--174 179 
				lpad(somente_numero(to_char(vl_desconto_w,'fm00000000000.00')),13,'0') || --180 192 
				'0000000000000' || --193 205 
				'0000000000000' || --206 218 
				ie_tipo_inscricao_w || --219 220 
				nr_inscricao_w || --221 234 
				elimina_caractere_especial(nm_pagador_w) || --235 269 
				lpad(' ',5,' ') || --270 274 
				rpad(elimina_caractere_especial(ds_endereco_w),40,' ') || --275 314 
				lpad(' ',7,' ') || --315 321 
				lpad(somente_numero(to_char(tx_multa_w,'fm00.0')),3,'0') || --322 324 
				nr_dias_multa_apos_venc_w ||--325 326 
				cd_cep_w || --327 334 
				elimina_caractere_especial(ds_municipio_w) || --335 349 
				substr(sg_estado_w,1,2) || --350 351 
				'0000' || --352 355 
				' ' || --356 356 
				'0000000000000' || --357 369 
				qt_dias_protesto_w || --370/371				 
				lpad(' ',23,' ') || --372 394 
				lpad(nr_seq_reg_arquivo_w,6,'0'); --395 400 
	insert into w_envio_banco(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_estabelecimento, 
			ds_conteudo, 
			nr_seq_apres) 
	values (	nextval('w_envio_banco_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_estabelecimento_p, 
			ds_conteudo_w, 
			nr_seq_reg_arquivo_w);
 
	end;
 
end loop;
close C01;
--end; 
--Fim Detalhe 
 
--Trailer 
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
select	sum(b.vl_saldo_titulo) 
into STRICT	vl_total_titulo_w 
from	titulo_receber b, 
	titulo_receber_cobr a 
where	a.nr_titulo		= b.nr_titulo 
and	a.nr_seq_cobranca	= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'9' || --001 001 
			lpad(' ',26,' ') || --002 027 
			lpad(somente_numero(to_char(coalesce(vl_total_titulo_w,0),'99999999990.00')),13,'0') || --028 040 
			lpad(' ',354,' ') || --041 394 
			lpad(nr_seq_reg_arquivo_w,6,'0'); --395 400 
insert	into w_envio_banco(	nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
values (	nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
 
--Fim Trailer 
 
commit;					
					 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_banrisul_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

