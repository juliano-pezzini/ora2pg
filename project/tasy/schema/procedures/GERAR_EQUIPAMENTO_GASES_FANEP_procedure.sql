-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equipamento_gases_fanep (nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_equipamento_w 	bigint;
cd_profissional_w	varchar(10);
dt_fim_w		timestamp;
dt_inicio_w		timestamp;
nr_seq_equipamento_w	bigint;

c01 CURSOR FOR
	SELECT	b.cd_equipamento,
		a.cd_profissional,
		c.dt_inicio_adm,
		c.dt_final_adm
	FROM	agente_anestesico b,
		cirurgia_agente_anestesico a,
		cirurgia_agente_anest_ocor c
	WHERE 	c.nr_seq_cirur_agente = a.nr_sequencia
	AND	a.nr_seq_agente	= b.nr_sequencia
	AND	((a.nr_seq_pepo = nr_seq_pepo_p) OR (a.nr_cirurgia = nr_cirurgia_p))
	AND 	(b.cd_equipamento IS NOT NULL AND b.cd_equipamento::text <> '')
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_situacao,'A') = 'A';


BEGIN

DELETE FROM equipamento_cirurgia
WHERE	((nr_seq_pepo = nr_seq_pepo_p) OR (nr_cirurgia = nr_cirurgia_p))
AND 	ie_gerado_sistema = 'S';
COMMIT;

OPEN c01;
LOOP
FETCH c01 INTO
	cd_equipamento_w,
	cd_profissional_w,
	dt_inicio_w,
	dt_fim_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	SELECT 	nextval('equipamento_cirurgia_seq')
	INTO STRICT	nr_seq_equipamento_w
	;

	INSERT INTO equipamento_cirurgia(
		nr_sequencia,
		cd_equipamento,
		dt_lancamento_automatico,
		nr_seq_pepo,
		nr_cirurgia,
		cd_profissional,
		dt_atualizacao,
		nm_usuario,
		qt_equipamento,
		dt_fim,
		dt_inicio,
		ie_gerado_sistema,
		ie_situacao)
	VALUES (nr_seq_equipamento_w,
		cd_equipamento_w,
		clock_timestamp(),
		CASE WHEN nr_seq_pepo_p=0 THEN NULL  ELSE nr_seq_pepo_p END ,
		nr_cirurgia_p,
		cd_profissional_w,
		clock_timestamp(),
		nm_usuario_p,
		1,
		dt_fim_w,
		dt_inicio_w,
		'S',
		'A');
	COMMIT;
	CALL gerar_taxa_equipamento_fanep(wheb_usuario_pck.get_cd_estabelecimento,nr_seq_equipamento_w,nm_usuario_p);
	END;
END LOOP;
CLOSE c01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equipamento_gases_fanep (nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

