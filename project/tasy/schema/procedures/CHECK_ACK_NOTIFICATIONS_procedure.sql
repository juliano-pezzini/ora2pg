-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE check_ack_notifications (cd_medico_p text ) AS $body$
DECLARE


    ie_notification_id_w      notificacoes.id%TYPE;
    qt_delegation_count_w     bigint;
    nm_usuario_w              usuario.nm_usuario%Type;


BEGIN
        nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
		
        SELECT  max(a.id)
        INTO STRICT    ie_notification_id_w
        FROM    notificacoes a,
                table(lista_pck.obter_lista_char(a.nm_usuarios_destino,';')) b
        WHERE   trim(both b.cd_registro) = nm_usuario_w
        AND     a.cd_grupo_notificacao = 'Deligation-profile'
        and     not exists (SELECT id from notificacoes_lidas c where c.id = a.id);

        select count(*)
        into STRICT   qt_delegation_count_w 
        from   delegacao_logs
        where  ie_status_ack = 'N' 
        and    coalesce(dt_ack_log::text, '') = '' 
        and    coalesce(nm_usuario_ack::text, '') = ''
        and    cd_medico = cd_medico_p
        and    nm_usuario = nm_usuario_w;

        if (coalesce(ie_notification_id_w::text, '') = '' or qt_delegation_count_w > 0) then
            return;
        end if;

        INSERT INTO notificacoes_lidas(
            id,
            nm_usuario,
            dt_leitura
        ) VALUES (
            ie_notification_id_w,
            nm_usuario_w,
            clock_timestamp()
        );
        DELETE from notificacoes where id = ie_notification_id_w;
        COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE check_ack_notifications (cd_medico_p text ) FROM PUBLIC;

