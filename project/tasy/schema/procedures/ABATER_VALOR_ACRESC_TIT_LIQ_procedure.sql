-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE abater_valor_acresc_tit_liq ( nr_titulo_p bigint, nr_seq_baixa_p bigint, ds_motivo_p text, vl_juros_p bigint, vl_multa_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_juros_w	double precision;
vl_multa_w	double precision;	
					 

BEGIN 
if (ds_motivo_p IS NOT NULL AND ds_motivo_p::text <> '') and (vl_juros_p IS NOT NULL AND vl_juros_p::text <> '') and (vl_multa_p IS NOT NULL AND vl_multa_p::text <> '') then 
	/* Antes de atualizar, obter os valores de juros e multa que estavam na baixa */
 
	select	max(vl_juros), 
		max(vl_multa) 
	into STRICT	vl_juros_w, 
		vl_multa_w 
	from	titulo_receber_liq 
	where	nr_titulo	= nr_titulo_p;
	 
	insert into titulo_rec_liq_abat_acres(nr_sequencia, 
		nr_titulo, 
		nr_seq_baixa, 
		ds_motivo, 
		nm_usuario, 
		dt_atualizacao, 
		vl_juros_anterior, 
		vl_multa_anterior) 
	values (nextval('titulo_rec_liq_abat_acres_seq'), 
		nr_titulo_p, 
		coalesce(nr_seq_baixa_p,0), 
		ds_motivo_p, 
		nm_usuario_p, 
		clock_timestamp(), 
		vl_juros_w, 
		vl_multa_w);
	 
	update	titulo_receber_liq 
	set	vl_juros 	= vl_juros_p, 
		vl_multa 	= vl_multa_p, 
		nm_usuario 	= nm_usuario_p, 
		dt_atualizacao = clock_timestamp() 
	where	nr_titulo 	= nr_titulo_p;
	 
	commit;	
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE abater_valor_acresc_tit_liq ( nr_titulo_p bigint, nr_seq_baixa_p bigint, ds_motivo_p text, vl_juros_p bigint, vl_multa_p bigint, nm_usuario_p text) FROM PUBLIC;

