-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_proc_paciente_eup_js ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_mensagem_erro_p INOUT text, cd_procedimento_sus_p INOUT bigint, ie_origem_proced_sus_p INOUT bigint, cd_doenca_cid_p INOUT text, cd_cid_secundario_p INOUT text, ie_sus_proc_doenca_p INOUT bigint, ie_buscar_cid_p INOUT text, ie_sus_proc_doenca_sec_p INOUT bigint) AS $body$
DECLARE


ie_situacao_w			varchar(1);
ie_continuar_exec_w		varchar(1)	:= 'S';
ds_mensagem_erro_w		varchar(255);
qt_proced_sus_w			bigint;
cd_procedimento_sus_w		bigint;
ie_origem_proced_sus_w		bigint;
cd_doenca_cid_w			varchar(10);
cd_cid_secundario_w		varchar(10);
ie_sus_proc_doenca_w		bigint;
ie_sus_proc_doenca_sec_w	bigint;

cd_estabelecimento_w		bigint;
nr_origem_proc_cih_w		bigint;
ie_buscar_cid_w			varchar(1);


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

nr_origem_proc_cih_w := Obter_param_Usuario(916, 229, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, nr_origem_proc_cih_w);
ie_buscar_cid_w := Obter_param_Usuario(916, 131, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_buscar_cid_w);


if (coalesce(cd_procedimento_p,0) > 0)then
	begin

	select 	max(ie_situacao)
	into STRICT	ie_situacao_w
	from 	procedimento
	where 	cd_procedimento = cd_procedimento_p;

	if (ie_situacao_w = 'I')then
		begin

		ds_mensagem_erro_w	:= obter_texto_tasy(71382, 1);
		ie_continuar_exec_w	:= 'N';

		end;
	end if;

	if (ie_continuar_exec_w = 'S')then
		begin

		select 	count(*)
		into STRICT	qt_proced_sus_w
		from 	procedimento
		where 	cd_procedimento  =  cd_procedimento_p
		and 	ie_origem_proced in (nr_origem_proc_cih_w);

		if (ie_origem_proced_p not in (2,7))or (qt_proced_sus_w = 0)then
			begin

			select  coalesce(max(cd_procedimento_sus),0),
				max(ie_origem_proced_sus)
			into STRICT	cd_procedimento_sus_w,
				ie_origem_proced_sus_w
			from    procedimento_conv_sus b
			where   b.cd_procedimento = cd_procedimento_p;

			if (cd_procedimento_sus_w = 0)then
				begin

				ds_mensagem_erro_w	:= obter_texto_tasy(71396, 1);
				ie_continuar_exec_w	:= 'N';

				end;
			end if;

			end;
		end if;

		end;
	end if;

	if (ie_continuar_exec_w = 'S')then
		begin

		if (ie_buscar_cid_w = 'S')then
			begin

			select  max(cd_doenca_cid),
				max(cd_cid_secundario)
			into STRICT	cd_doenca_cid_w,
				cd_cid_secundario_w
			from    procedimento
			where   cd_procedimento   = cd_procedimento_sus_w
			and     ie_origem_proced  = nr_origem_proc_cih_w;

			end;
		else
			begin

			SELECT * FROM consiste_procedimento_cih(nr_atendimento_p, ie_origem_proced_p, cd_procedimento_p, ie_sus_proc_doenca_w, cd_doenca_cid_w, cd_cid_secundario_w, ie_sus_proc_doenca_sec_w) INTO STRICT ie_sus_proc_doenca_w, cd_doenca_cid_w, cd_cid_secundario_w, ie_sus_proc_doenca_sec_w;

			end;
		end if;

		end;
	end if;

	end;
end if;

cd_procedimento_sus_p		:= cd_procedimento_sus_w;
ie_origem_proced_sus_p		:= ie_origem_proced_sus_w;
cd_doenca_cid_p			:= cd_doenca_cid_w;
cd_cid_secundario_p		:= cd_cid_secundario_w;
ie_sus_proc_doenca_p		:= ie_sus_proc_doenca_w;
ie_sus_proc_doenca_sec_p	:= ie_sus_proc_doenca_sec_w;
ds_mensagem_erro_p		:= ds_mensagem_erro_w;
ie_buscar_cid_p			:= ie_buscar_cid_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_proc_paciente_eup_js ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ds_mensagem_erro_p INOUT text, cd_procedimento_sus_p INOUT bigint, ie_origem_proced_sus_p INOUT bigint, cd_doenca_cid_p INOUT text, cd_cid_secundario_p INOUT text, ie_sus_proc_doenca_p INOUT bigint, ie_buscar_cid_p INOUT text, ie_sus_proc_doenca_sec_p INOUT bigint) FROM PUBLIC;

