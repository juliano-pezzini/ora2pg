-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualizar_result_contagem (nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame1_p text, cd_exame2_p text, cd_exame3_p text, cd_exame4_p text, cd_exame5_p text, cd_exame6_p text, cd_exame7_p text, cd_exame8_p text, cd_exame9_p text, cd_exame10_p text, cd_exame11_p text, cd_exame12_p text, qt_resultado1_p bigint, qt_resultado2_p bigint, qt_resultado3_p bigint, qt_resultado4_p bigint, qt_resultado5_p bigint, qt_resultado6_p bigint, qt_resultado7_p bigint, qt_resultado8_p bigint, qt_resultado9_p bigint, qt_resultado10_p bigint, qt_resultado11_p bigint, qt_resultado12_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_exame1_w		bigint;
nr_seq_exame2_w		bigint;
nr_seq_exame3_w		bigint;
nr_seq_exame4_w		bigint;
nr_seq_exame5_w		bigint;
nr_seq_exame6_w		bigint;
nr_seq_exame7_w		bigint;
nr_seq_exame8_w		bigint;
nr_seq_exame9_w		bigint;
nr_seq_exame10_w	bigint;
nr_seq_exame11_w	bigint;
nr_seq_exame12_w	bigint;
ds_erro_w			varchar(4000);
nr_seq_resultado_w	bigint;
nr_seq_exame_princ_w	bigint;
nr_seq_material_w	bigint;
qt_resultado_w		bigint;
pr_resultado_w		bigint;
ds_resultado_w		varchar(255);
nr_seq_exame_w		bigint;
ie_percent_valor_w  varchar(1);


C01 CURSOR FOR
	SELECT nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame1_p
	
union all

	SELECT nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame2_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame3_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame4_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame5_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame6_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame7_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame8_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame9_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame10_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame11_p
	
union all

	select nr_seq_exame
	from exame_laboratorio
	where cd_exame = cd_exame12_p;

c02 CURSOR FOR
	SELECT	nr_seq_exame,
		qt_resultado,
		pr_resultado,
		ds_resultado
	from exame_lab_result_item
	where nr_seq_resultado	= nr_seq_resultado_w
	  and nr_seq_prescr	= nr_seq_prescr_p
	  and ((qt_resultado <> 0) or (pr_resultado <> 0) or (ds_resultado IS NOT NULL AND ds_resultado::text <> ''))
	order by nr_sequencia;


BEGIN

ie_percent_valor_w	:= coalesce(obter_valor_param_usuario(-2265, 41, obter_perfil_ativo,nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'P');

/*select	a.nr_seq_exame,
		a.nr_seq_material,
		a.qt_resultado,
		a.pr_resultado,
		a.ds_resultado
into	nr_seq_exame_princ_w,
		nr_seq_material_w,
		qt_resultado_w,
		pr_resultado_w,
		ds_resultado_w
from	exame_lab_result_item a,
		exame_lab_resultado b,
		prescr_procedimento c
where	a.nr_seq_prescr = c.nr_sequencia
and		a.nr_seq_resultado = b.nr_seq_resultado
and		c.nr_prescricao = b.nr_prescricao
and		c.nr_prescricao = nr_prescricao_p
and		a.nr_seq_material is not null;*/
select	max(nr_seq_material)
into STRICT	nr_seq_material_w
from 	exame_lab_result_item
where 	nr_seq_resultado	= nr_seq_resultado_w
and 	nr_seq_prescr	= nr_seq_prescr_p
and 	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame1_w
from 	exame_laboratorio
where 	cd_exame = cd_exame1_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame2_w
from 	exame_laboratorio
where 	cd_exame = cd_exame2_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame3_w
from 	exame_laboratorio
where 	cd_exame = cd_exame3_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame4_w
from 	exame_laboratorio
where 	cd_exame = cd_exame4_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame5_w
from 	exame_laboratorio
where 	cd_exame = cd_exame5_p;

select  coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame6_w
from 	exame_laboratorio
where 	cd_exame = cd_exame6_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame7_w
from 	exame_laboratorio
where 	cd_exame = cd_exame7_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame8_w
from 	exame_laboratorio
where 	cd_exame = cd_exame8_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame9_w
from 	exame_laboratorio
where 	cd_exame = cd_exame9_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame10_w
from 	exame_laboratorio
where 	cd_exame = cd_exame10_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame11_w
from 	exame_laboratorio
where 	cd_exame = cd_exame11_p;

select 	coalesce(max(nr_seq_exame), '')
into STRICT	nr_seq_exame12_w
from 	exame_laboratorio
where 	cd_exame = cd_exame12_p;

select 	MAX(b.nr_seq_resultado)
into STRICT	nr_seq_resultado_w
from	exame_laboratorio a,
		exame_lab_resultado b,
		exame_lab_result_item e,
		prescr_procedimento c,
		prescr_medica d
where	a.nr_seq_exame 	= e.nr_seq_exame
and		b.nr_prescricao = c.nr_prescricao
and		c.nr_prescricao = d.nr_prescricao
and		e.nr_seq_prescr = c.nr_sequencia
and		b.nr_seq_resultado = e.nr_seq_resultado
and		c.nr_prescricao = nr_prescricao_p
and		c.nr_sequencia  = nr_seq_prescr_p;

if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then
	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then
		begin
			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado1_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado1_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame1_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado2_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado2_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame2_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado3_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado3_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame3_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado4_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado4_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame4_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado5_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado5_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame5_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado6_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado6_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame6_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado7_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado7_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame7_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado8_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado8_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame8_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado9_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado9_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame9_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado10_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado10_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame10_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado11_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado11_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame11_w;

			update 	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN qt_resultado12_p  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN qt_resultado12_p  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where 	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr	 = nr_seq_prescr_p
			and		nr_seq_exame	 = nr_seq_exame12_w;

			update	exame_lab_result_item
			set		qt_resultado = CASE WHEN ie_percent_valor_w='V' THEN ds_resultado_w  ELSE qt_resultado END ,
            		pr_resultado = CASE WHEN ie_percent_valor_w='P' THEN ds_resultado_w  ELSE pr_resultado END ,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
			where	nr_seq_resultado = nr_seq_resultado_w
			and		nr_seq_prescr = nr_seq_prescr_p
			and		nr_seq_exame = nr_seq_exame_princ_w;

			open c02;
			loop
			fetch c02 into	nr_seq_exame_w,
					qt_resultado_w,
					pr_resultado_w,
					ds_resultado_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */

				ds_resultado_w := calcular_valores_exame(nr_seq_resultado_w, nr_prescricao_p, nr_seq_prescr_p, nr_seq_material_w, nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);
			end loop;
			close c02;

		exception
		when others then
			ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(279118,null)||substr(sqlerrm,1,3500);
		end;
	end if;
else
	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(279119,null)||nr_prescricao_p||'.';
end if;
commit;
ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualizar_result_contagem (nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame1_p text, cd_exame2_p text, cd_exame3_p text, cd_exame4_p text, cd_exame5_p text, cd_exame6_p text, cd_exame7_p text, cd_exame8_p text, cd_exame9_p text, cd_exame10_p text, cd_exame11_p text, cd_exame12_p text, qt_resultado1_p bigint, qt_resultado2_p bigint, qt_resultado3_p bigint, qt_resultado4_p bigint, qt_resultado5_p bigint, qt_resultado6_p bigint, qt_resultado7_p bigint, qt_resultado8_p bigint, qt_resultado9_p bigint, qt_resultado10_p bigint, qt_resultado11_p bigint, qt_resultado12_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

