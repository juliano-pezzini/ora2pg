-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_envio_comunic_ata ( nr_sequencia_p bigint, ds_valor_p text, nm_usuario_p text, ie_evento_p text, cd_estabelecimento_p bigint, ie_tipo_usuario_dest_p text default null) AS $body$
DECLARE

 
dt_prev_solucao_w			timestamp;
nm_resp_pend_ata_w		varchar(60);
nm_usuario_resp_pend_ata_w	varchar(15);
dt_conclusao_real_w		timestamp;
ds_classif_ata_w			varchar(255);
dt_ata_w				timestamp;
ds_ata_w				varchar(255);
dt_liberacao_w			timestamp;
nm_usuario_resp_ata_w		varchar(15);
ds_pendencia_w			varchar(255);
nr_seq_pend_w			bigint;
nm_resp_ata_w			varchar(60);
nm_usuario_particip_ata_w		varchar(15);
nr_seq_ata_w			bigint;
qt_existe_w			bigint;
nr_seq_regra_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicacao_w			varchar(32000);
ie_usuario_w			varchar(2);
ds_usuario_destino_w		varchar(2000);
nm_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w			smallint;
lista_usuario_w			varchar(2000);
ds_observacao_w			varchar(255);
ie_comunic_interna_w		varchar(1);
ie_email_w			varchar(1);
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);
ds_email_origem_w			varchar(255);
nm_usuario_origem_w		varchar(15);
nm_usuario_original_w		varchar(15);
nr_seq_classif_w		comunic_interna_classif.nr_sequencia%type;
nr_seq_classif_ci_w		comunic_interna_classif.nr_sequencia%type;
nr_seq_classif_padrao_w		comunic_interna_classif.nr_sequencia%type;

c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ds_titulo, 
		ds_comunicacao, 
		ie_comunicacao_interna, 
		ie_email, 
		ds_email_origem, 
		nm_usuario_origem, 
		coalesce(nr_seq_classif_ci,0) 
	from	qua_regra_envio_comunic 
	where	ie_evento = ie_evento_p 
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

c02 CURSOR FOR	 
	SELECT	ie_usuario, 
		ds_usuario_destino 
	from	qua_usuarios_comunicacao 
	where	nr_seq_regra = nr_seq_regra_w 
	and	ie_usuario = coalesce(ie_tipo_usuario_dest_p,ie_usuario);

c03 CURSOR FOR 
	SELECT	distinct a.nm_usuario 
	from	proj_ata_participante b, 
		usuario a 
	where	a.cd_pessoa_fisica = b.cd_pessoa_participante 
	and	b.nr_seq_ata = nr_seq_ata_w;


BEGIN 
 
/*24 - ATA - Conclusão de pendência*/
 
if (ie_evento_p  ('24')) then 
	select	nr_seq_ata 
	into STRICT	nr_seq_ata_w 
	from	proj_ata_pendencia 
	where	nr_sequencia = nr_sequencia_p;
else 
	nr_seq_ata_w := nr_sequencia_p;
end if;
 
select	count(*) 
into STRICT	qt_existe_w 
from	qua_regra_envio_comunic 
where	ie_evento = ie_evento_p 
and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;
 
if (qt_existe_w > 0) then 
	begin 
 
	select	obter_classif_comunic('F') 
	into STRICT	nr_seq_classif_padrao_w 
	;
 
	open c01;
	loop 
	fetch c01 into 
		nr_seq_regra_w, 
		ds_titulo_w, 
		ds_comunicacao_w, 
		ie_comunic_interna_w, 
		ie_email_w, 
		ds_email_origem_w, 
		nm_usuario_origem_w, 
		nr_seq_classif_ci_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		if (coalesce(nr_seq_classif_ci_w,0) <> 0) then 
			nr_seq_classif_w	:= nr_seq_classif_ci_w;
		else 
			nr_seq_classif_w	:= nr_seq_classif_padrao_w;
		end if;		
 
		nm_usuario_w		:= null;
		nm_usuario_original_w	:= coalesce(nm_usuario_origem_w, nm_usuario_p);
		 
		select	substr(obter_nome_pf(cd_consultor),1,60), 
			ds_ata, 
			dt_ata, 
			dt_liberacao, 
			substr(obter_descricao_padrao('PROJ_ATA_CLASSIFICACAO','DS_CLASSIFICACAO',nr_seq_classif),1,255) 
		into STRICT	nm_resp_ata_w, 
			ds_ata_w, 
			dt_ata_w, 
			dt_liberacao_w, 
			ds_classif_ata_w 
		from	proj_ata 
		where	nr_sequencia = nr_seq_ata_w;
		 
		open c02;
		loop 
		fetch c02 into 
			ie_usuario_w, 
			ds_usuario_destino_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin 
			/*	24 - ATA - Conclusão de pendência 
				30 - ATA - Comunicar participantes	*/
 
			if (ie_evento_p in ('24','30')) then 
				begin 
				if (ie_evento_p = '24') and (ie_usuario_w = 'RP') then	/* Responsável pela pendência da ATA */
 
					begin 
					select	substr(obter_usuario_ativo_pf(cd_pessoa_resp),1,15) 
					into STRICT	nm_usuario_resp_pend_ata_w 
					from	proj_ata_pendencia 
					where	nr_sequencia = nr_sequencia_p;		
					 
					if (coalesce(nm_usuario_resp_pend_ata_w,'X') <> 'X') then 
						nm_usuario_w	:= substr(nm_usuario_resp_pend_ata_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				end if;
 
				if (ie_usuario_w = 'PA') then	/* Participantes da ATA */
 
					begin 
					open c03;
					loop 
					fetch c03 into 
						nm_usuario_particip_ata_w;
					EXIT WHEN NOT FOUND; /* apply on c03 */
						if (coalesce(nm_usuario_particip_ata_w,'X') <> 'X') then 
							nm_usuario_w	:= substr(nm_usuario_particip_ata_w || ', ' || nm_usuario_w,1,2000);
						end if;
					end loop;
					close c03;
					end;
				elsif (ie_usuario_w = 'RA') then	/* Responsável pela ATA */
 
					begin 
					select	substr(obter_usuario_ativo_pf(cd_consultor),1,15) 
					into STRICT	nm_usuario_resp_ata_w 
					from	proj_ata 
					where	nr_sequencia = nr_seq_ata_w;
					 
					if (coalesce(nm_usuario_resp_ata_w,'X') <> 'X') then 
						nm_usuario_w	:= substr(nm_usuario_resp_ata_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				end if;
				end;
			end if;
			 
			if (ie_usuario_w = 'UI') and (coalesce(ds_usuario_destino_w,'0') <> '0') then 
				nm_usuario_w := substr(ds_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
			end if;
			end;	
		end loop;
		close c02;
 
		/* Macros */
 
		ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@nr_seq_ata', nr_seq_ata_w),1,255);		
		ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_ata', ds_ata_w),1,255);
		ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@dt_reuniao_ata', to_char(dt_ata_w,'dd/mm/yyyy hh24:mi:ss')),1,255);
		 
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_seq_ata', nr_seq_ata_w),1,32000);
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ata', ds_ata_w),1,32000);
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_reuniao_ata', to_char(dt_ata_w,'dd/mm/yyyy hh24:mi:ss')),1,32000);
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_responsavel_ata', nm_resp_ata_w),1,32000);
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_classif_ata', ds_classif_ata_w),1,32000);
		ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_liberacao_ata', dt_liberacao_w),1,32000);
 
		if (ie_evento_p = '24') then /* ATA - Conclusão de pendência */
 
			begin 
			select	nr_sequencia, 
				substr(obter_nome_pf(cd_pessoa_resp),1,60), 
				ds_observacao, 
				ds_pendencia, 
				dt_prev_solucao, 
				dt_conclusao_real 
			into STRICT	nr_seq_pend_w, 
				nm_resp_pend_ata_w, 
				ds_observacao_w, 
				ds_pendencia_w, 
				dt_prev_solucao_w, 
				dt_conclusao_real_w 
			from	proj_ata_pendencia 
			where	nr_sequencia = nr_sequencia_p;
			 
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_seq_pend_ata', nr_seq_pend_w),1,32000);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_pendencia_ata', ds_pendencia_w),1,32000);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_resp_pend_ata', nm_resp_pend_ata_w),1,32000);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_obs_pend_ata', ds_observacao_w),1,32000);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_prev_soluc_pend_ata', dt_prev_solucao_w),1,32000);
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_conclusao_pend_ata', dt_conclusao_real_w),1,32000);
			end;
		end if;
 
 
		if (coalesce(nm_usuario_w,'X') <> 'X') then 
			begin 
			if (ie_comunic_interna_w = 'S') then 
				begin 
				 
				insert into comunic_interna( 
						dt_comunicado, 
						ds_titulo, 
						ds_comunicado, 
						nm_usuario, 
						dt_atualizacao, 
						ie_geral, 
						nm_usuario_destino, 
						cd_perfil, 
						nr_sequencia, 
						ie_gerencial, 
						nr_seq_classif, 
						ds_perfil_adicional, 
						cd_setor_destino, 
						cd_estab_destino, 
						ds_setor_adicional, 
						dt_liberacao, 
						ds_grupo, 
						nm_usuario_oculto) 
					values (	clock_timestamp(), 
						ds_titulo_w, 
						ds_comunicacao_w, 
						nm_usuario_original_w, 
						clock_timestamp(), 
						'N', 
						nm_usuario_w, 
						null, 
						nextval('comunic_interna_seq'), 
						'N', 
						nr_seq_classif_w, 
						'', 
						null, 
						'', 
						'', 
						clock_timestamp(), 
						'', 
						'');
 
				if (coalesce(nm_usuario_w,'X') <> 'X') then 
					insert into proj_ata_envio( 
							nr_sequencia, 
							nr_seq_ata, 
							dt_atualizacao, 
							dt_atualizacao_nrec, 
							nm_usuario, 
							nm_usuario_nrec, 
							dt_envio, 
							ds_destino, 
							ds_observacao) 
						values (	nextval('proj_ata_envio_seq'), 
							nr_seq_ata_w, 
							clock_timestamp(), 
							clock_timestamp(), 
							nm_usuario_p, 
							nm_usuario_p, 
							clock_timestamp(), 
							substr(nm_usuario_w,1,255), 
							substr(ds_comunicacao_w,1,4000));
				end if;
				end;
			end if;
 
			if (ie_email_w = 'S') then 
				begin 
				lista_usuario_w := substr(nm_usuario_w,1,2000);
 
				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop 
					tam_lista_w	:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);
 
					if (ie_pos_virgula_w <> 0) then 
						nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));
 
						select	max(ds_email) 
						into STRICT	ds_email_usuario_w 
						from	usuario 
						where	nm_usuario = nm_usuario_w;
 
						if (coalesce(ds_email_usuario_w,'X') <> 'X') then 
							begin 
							ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
							end;
						end if;
					else 
						lista_usuario_w	:= null;
					end if;
				end loop;
 
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then 
					ds_lista_email_usuario_w := replace(ds_lista_email_usuario_w,',',';');
					CALL enviar_email(	ds_titulo_w, 
							ds_comunicacao_w, 
							ds_email_origem_w, 
							ds_lista_email_usuario_w, 
							nm_usuario_original_w, 
							'M');
				end if;
 
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then 
					insert into proj_ata_envio( 
							nr_sequencia, 
							nr_seq_ata, 
							dt_atualizacao, 
							dt_atualizacao_nrec, 
							nm_usuario, 
							nm_usuario_nrec, 
							dt_envio, 
							ds_destino, 
							ds_observacao) 
						values (	nextval('proj_ata_envio_seq'), 
							nr_seq_ata_w, 
							clock_timestamp(), 
							clock_timestamp(), 
							nm_usuario_p, 
							nm_usuario_p, 
							clock_timestamp(), 
							substr(ds_lista_email_usuario_w,1,255), 
							substr(ds_comunicacao_w,1,4000));
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close c01;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_envio_comunic_ata ( nr_sequencia_p bigint, ds_valor_p text, nm_usuario_p text, ie_evento_p text, cd_estabelecimento_p bigint, ie_tipo_usuario_dest_p text default null) FROM PUBLIC;

