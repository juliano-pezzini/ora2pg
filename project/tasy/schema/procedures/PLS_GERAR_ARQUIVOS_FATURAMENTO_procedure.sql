-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arquivos_faturamento ( cd_interface_p interface.cd_interface%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_ptu_fatura_p ptu_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nm_arquivo_p INOUT text, nm_arquivo_zip_p INOUT text, ds_local_windows_utl_p INOUT text ) AS $body$
DECLARE

						
--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

--  		Finalidade:	Gerar os arquivos de interfaces criadas pela Philips

--------------------------------------------------------------------------------------------------

--			!!!	IMPORTANTE	!!!

--	

--	TODA VEZ QUE FOR ADICIONAR OU RETIRAR ALGUMA INTERFACE DA ROTINA

--	

--	E OBRIGATORIO REPETIR A ACAO SOBRE O OBJETO	336558

--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
nm_arquivo_w		varchar(4000) := null;
nm_arquivo_zip_w	varchar(4000) := null;
qt_interf_ptu_w		integer := 0;


BEGIN

CALL pls_grava_log_execucao_temp(	'Inicio - OS2011730 - ' ||
				cd_interface_p || ' - ' || 
				nr_seq_pls_fatura_p || ' - ' || 
				nr_seq_ptu_fatura_p || ' - ' || 
				cd_estabelecimento_p || ' - ' || 
				nm_usuario_p || ' - ' || 
				nm_arquivo_p || ' - ' ||
				nm_arquivo_zip_p || ' - ' ||
				ds_local_windows_utl_p, 'pls_gerar_arquivos_faturamento', nm_usuario_p, 'S');

select	count(1)
into STRICT	qt_interf_ptu_w
from	ptu_interfaces_v
where	ie_tipo_interface	= 'A500'
and	cd_interface		= cd_interface_p;

if (cd_interface_p = '2635') then -- Servicos (Modelo fundacoes)
	CALL pls_gerar_env_arq_fundacao_txt(	nr_seq_pls_fatura_p, cd_estabelecimento_p, nm_usuario_p);
	
	select	substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'FF',cd_interface_p),1,255)
	into STRICT	nm_arquivo_w
	;
	
	nm_arquivo_zip_w := nm_arquivo_w ||'.zip';

elsif (cd_interface_p = '2658') then -- Servicos (Modelo fundacoes)
	CALL pls_gerar_env_arq_fund_302_txt(	nr_seq_pls_fatura_p, cd_estabelecimento_p, nm_usuario_p);
	
	select	substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'FF',cd_interface_p),1,255)
	into STRICT	nm_arquivo_w
	;

	nm_arquivo_zip_w := nm_arquivo_w ||'.zip';
	
elsif (cd_interface_p = '2657') then -- Atos (Modelo fundacoes)
	CALL pls_gerar_arq_atos_txt(	nr_seq_pls_fatura_p, cd_estabelecimento_p, nm_usuario_p);
	
	select	substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'FFAA',cd_interface_p),1,255),
		substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'FFZIP',cd_interface_p),1,255)
	into STRICT	nm_arquivo_w,
		nm_arquivo_zip_w
	;

elsif (cd_interface_p in ( '2624' , '2697' )) then	-- A700 - Notas de Fatura em Intercambio 6.0 e A700 - Notas de Fatura em Intercambio 6.2
	CALL ptu_gerar_envio_arq_a700( cd_interface_p, null, nr_seq_ptu_fatura_p, cd_estabelecimento_p, nm_usuario_p);
	
	select	substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'NFI',cd_interface_p),1,255),
		substr(ptu_obter_nome_exportacao(nr_seq_pls_fatura_p,'NFIZIP',cd_interface_p),1,255)
	into STRICT	nm_arquivo_w,
		nm_arquivo_zip_w
	;

elsif (qt_interf_ptu_w > 0) then -- PTU A500
	ds_local_windows_utl_p := ptu_gerar_envio_fatura( cd_interface_p, nr_seq_ptu_fatura_p, cd_estabelecimento_p, nm_usuario_p, ds_local_windows_utl_p);
	
	select	substr(ptu_obter_nome_exportacao(nr_seq_ptu_fatura_p,'FA',cd_interface_p),1,255),
		substr(ptu_obter_nome_exportacao(nr_seq_ptu_fatura_p,'FZIP',cd_interface_p),1,255)
	into STRICT	nm_arquivo_w,
		nm_arquivo_zip_w
	;
	
	update	ptu_fatura
	set	ie_tipo_exportacao	= 'TXT'
	where	nr_sequencia		= nr_seq_ptu_fatura_p;
	
else
	-- PTU XML
	nm_arquivo_w	:= ptu_batch_xml_pck.obter_nome_exportacao( nr_seq_ptu_fatura_p, cd_estabelecimento_p, null, null, clock_timestamp(), 'A500', 'FA');
	nm_arquivo_zip_w:= ptu_batch_xml_pck.obter_nome_exportacao( nr_seq_ptu_fatura_p, cd_estabelecimento_p, null, null, clock_timestamp(), 'A500', 'FZIP');

	update	ptu_fatura
	set	ie_tipo_exportacao	= 'XML'
	where	nr_sequencia		= nr_seq_ptu_fatura_p;
end if;

nm_arquivo_p := coalesce(nm_arquivo_w,nm_arquivo_p);
nm_arquivo_zip_p := coalesce(nm_arquivo_zip_w,nm_arquivo_zip_p);

CALL pls_grava_log_execucao_temp(	'Fim - OS2011730 - ' ||
				cd_interface_p || ' - ' || 
				nr_seq_pls_fatura_p || ' - ' || 
				nr_seq_ptu_fatura_p || ' - ' || 
				cd_estabelecimento_p || ' - ' || 
				nm_usuario_p || ' - ' || 
				nm_arquivo_p || ' - ' ||
				nm_arquivo_zip_p || ' - ' ||
				ds_local_windows_utl_p, 'pls_gerar_arquivos_faturamento', nm_usuario_p, 'S');
				
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivos_faturamento ( cd_interface_p interface.cd_interface%type, nr_seq_pls_fatura_p pls_fatura.nr_sequencia%type, nr_seq_ptu_fatura_p ptu_fatura.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nm_arquivo_p INOUT text, nm_arquivo_zip_p INOUT text, ds_local_windows_utl_p INOUT text ) FROM PUBLIC;

