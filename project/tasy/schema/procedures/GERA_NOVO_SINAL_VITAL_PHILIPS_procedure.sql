-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_novo_sinal_vital_philips (cd_pessoa_fisica_p text, ds_bed_p text, nm_usuario_p text, dt_sinal_vital_p text, nr_seq_sinal_vital_p INOUT bigint) AS $body$
DECLARE

 
nr_seq_sinal_vital_w	bigint;
cd_pessoa_fisica_w	varchar(10);
cd_unidade_basica_w	varchar(10);
cd_unidade_compl_w	varchar(10);
dt_sinal_vital_w	timestamp;
nr_atendimento_w	bigint;


BEGIN 
 
if	((coalesce(cd_pessoa_fisica_p::text, '') = '') or (trim(both cd_pessoa_fisica_p) = '') or (trim(both cd_pessoa_fisica_p) = '""')) then 
 
	cd_unidade_basica_w 	:= substr(ds_bed_p,1, position('-' in ds_bed_p)-1);
	cd_unidade_compl_w	:= substr(ds_bed_p,position('-' in ds_bed_p) + 1, length(ds_bed_p));	
 
	 
	select	max(a.cd_pessoa_fisica), 
		max(a.nr_atendimento) 
	into STRICT	cd_pessoa_fisica_w, 
		nr_atendimento_w 
	from	atendimento_paciente a, 
		unidade_atendimento u 
	where	u.cd_unidade_basica 	= cd_unidade_basica_w 
	and	u.cd_unidade_compl 	= cd_unidade_compl_w 
	and	a.nr_atendimento	= u.nr_atendimento;
 
else 
 
	cd_pessoa_fisica_w := cd_pessoa_fisica_p;
		 
	select	max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from	atendimento_paciente 
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	 
end if;
 
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
 
 
	if	not(coalesce(dt_sinal_vital_p::text, '') = '') then 
		dt_sinal_vital_w := to_date(dt_sinal_vital_p, 'yyyymmddhh24miss');
	else 
		dt_sinal_vital_w := clock_timestamp();
	end if;
	 
 
	select	nextval('atendimento_sinal_vital_seq') 
	into STRICT	nr_seq_sinal_vital_w 
	;
 
 
	insert into atendimento_sinal_vital( 
		nr_sequencia, 
		cd_pessoa_fisica, 
		nr_atendimento, 
		dt_liberacao, 
		dt_sinal_vital, 
		dt_atualizacao, 
		nm_usuario, 
		ie_pressao, 
		ie_situacao 
		) 
	values ( 
		nr_seq_sinal_vital_w, 
		cd_pessoa_fisica_w, 
		nr_atendimento_w, 
		clock_timestamp(), 
		dt_sinal_vital_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		'D', 
		'A' 
		);
	 
	nr_seq_sinal_vital_p := nr_seq_sinal_vital_w;
 
	commit;
 
else 
	nr_seq_sinal_vital_p := 0;
	 
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_novo_sinal_vital_philips (cd_pessoa_fisica_p text, ds_bed_p text, nm_usuario_p text, dt_sinal_vital_p text, nr_seq_sinal_vital_p INOUT bigint) FROM PUBLIC;

