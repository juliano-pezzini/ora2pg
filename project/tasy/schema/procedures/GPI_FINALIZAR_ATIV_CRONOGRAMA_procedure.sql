-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpi_finalizar_ativ_cronograma ( nr_sequencia_p bigint, dt_fim_real_p timestamp, qt_hora_real_p bigint, nm_usuario_p text, pr_etapa_p bigint default 100) AS $body$
DECLARE


dt_inicio_real_w				timestamp;
dt_fim_real_w				timestamp;
ie_atual_hora_w				varchar(1)	:= 'S';
qt_hora_real_w				double precision;
qt_ordem_servico_w			bigint;


BEGIN

select	dt_inicio_real
into STRICT	dt_inicio_real_w
from	gpi_cron_etapa
where	nr_sequencia	= nr_sequencia_p;

dt_fim_real_w	:= coalesce(dt_fim_real_p,clock_timestamp());

if (trunc(dt_fim_real_w) > trunc(clock_timestamp())) then
	/*'A data final da atividade não pode ser superior a data atual!#@#@');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(266517);
end if;

qt_hora_real_w	:= dividir(obter_min_entre_datas(dt_inicio_real_w, dt_fim_real_w,1),60);

if (qt_hora_real_p > qt_hora_real_w) then
	/*Quantidade de horas inválida!');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(266518);
end if;

select	count(*)
into STRICT	qt_ordem_servico_w
from	man_ordem_servico
where	nr_seq_etapa_gpi	= nr_sequencia_p;

if (qt_ordem_servico_w > 0) then
	ie_atual_hora_w	:= 'N';
end if;

qt_hora_real_w	:= coalesce(qt_hora_real_p,0);

update	gpi_cron_etapa
set	dt_fim_real	= dt_fim_real_w,
	qt_hora_real	= CASE WHEN ie_atual_hora_w='S' THEN qt_hora_real_w  ELSE qt_hora_real END ,
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp(),
	pr_etapa	                = coalesce(pr_etapa_p, 100)
where	nr_sequencia	= nr_sequencia_p;

CALL gpi_atualizar_etapa_superior(nr_sequencia_p,nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpi_finalizar_ativ_cronograma ( nr_sequencia_p bigint, dt_fim_real_p timestamp, qt_hora_real_p bigint, nm_usuario_p text, pr_etapa_p bigint default 100) FROM PUBLIC;

