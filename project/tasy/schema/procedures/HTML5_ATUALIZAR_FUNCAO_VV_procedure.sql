-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html5_atualizar_funcao_vv () AS $body$
DECLARE

  AUX RECORD;

BEGIN
 FOR AUX IN (SELECT VW.CD_FUNCAO_ETAPA "CD_FUNCAO", 
           trim(both VW.DS_ATIVIDADE) "FUNCTION", 
           OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) NR_ROUND_VV, 
           CASE WHEN OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) = 1 THEN AD_001 
             WHEN OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) = 2 THEN AD_002 
             WHEN OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) = 3 THEN AD_003 
             WHEN OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) = 4 THEN AD_004 
             WHEN OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA) = 5 THEN AD_005 
             ELSE '0%' 
           END PR_ADERENCIA_VV, 
           round((CASE WHEN OS_TOTAL_T=0 THEN  0  ELSE OBTER_TOTAL_OS_SETOR_PROJ(VW.NR_SEQUENCIA_3, 'RP', -999, 'E', 0)*100/OS_TOTAL_T END )::numeric,0) ||'%' "PR_REPROV_VV", 
           CASE WHEN(UPPER(STATUS_DEV) <> 'VERIFICATION') THEN NULL 
             WHEN OBTER_STATUS_TESTE_PROJ(OBTER_OS_ADERENCIA_PROJ(VW.NR_SEQUENCIA, OBTER_LAST_ROUND_PROJ(VW.NR_SEQUENCIA)+1)) = 'I' THEN 'E' 
             WHEN OS_TOTAL_T = OS_ENC_T THEN 'P' 
             ELSE 'R' 
           END "IE_STATUS_VV", 
           OS_DEV    "QT_OS_VV_PEND_DEV", 
           OS_DEV_TEC  "QT_OS_VV_PEND_TEC", 
           OS_TEST_T  "QT_OS_VV_PEND_TEST", 
           OS_TEST_VS_T "QT_OS_VV_AGUAR_V"/*, 
           OS_ENC_T   "OS_CLOSED", 
           OS_TOTAL_T  "OS_TOTAL" */
 
        FROM VW_REL_VEV_1554 VW, 
           FUNCOES_HTML5 FH 
        WHERE FH.CD_FUNCAO = VW.CD_FUNCAO_ETAPA 
         AND VW.NR_SEQ_PROJ = 7119 
         AND position('.' in CLASSIFICACAO) <> 0) 
 LOOP  
  UPDATE FUNCOES_HTML5 FH 
    SET NR_ROUND_VV      = AUX.NR_ROUND_VV, 
      FH.PR_ADERENCIA_VV  = replace(AUX.PR_ADERENCIA_VV, '%', ''), 
      FH.PR_REPROV_VV    = replace(AUX.PR_REPROV_VV, '%', ''), 
      FH.IE_STATUS_VV    = AUX.IE_STATUS_VV, 
      FH.QT_OS_VV_PEND_DEV = AUX.QT_OS_VV_PEND_DEV, 
      FH.QT_OS_VV_PEND_TEC = AUX.QT_OS_VV_PEND_TEC, 
      FH.QT_OS_VV_PEND_TEST = AUX.QT_OS_VV_PEND_TEST, 
      FH.QT_OS_VV_AGUAR_V  = AUX.QT_OS_VV_AGUAR_V 
   WHERE FH.CD_FUNCAO     = AUX.CD_FUNCAO;
 END LOOP;
 
 COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html5_atualizar_funcao_vv () FROM PUBLIC;

