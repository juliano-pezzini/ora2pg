-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_reverter_etapa_ivc ( nr_atendimento_p bigint, nr_seq_ivc_p bigint, nr_seq_motivo_p text, nm_usuario_p text, ie_encerrar_ivc_p text) AS $body$
DECLARE


nr_seq_etapa_w		bigint;
nr_seq_etapa_ww		bigint;
count_w			bigint;
ie_evento_anterior_w	varchar(15);
ie_nova_ivc_w		varchar(1);
ie_status_ivc_w		varchar(5);
nr_seq_horario_w	bigint;
nr_seq_ivc_w		bigint;
nr_seq_hor_agrupado_w	bigint;
dt_horario_w		timestamp;				
ie_gerar_evento_w	varchar(1);
nr_seq_alteracao_w		prescr_mat_alteracao.nr_sequencia%type;
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_procedimento_w	prescr_procedimento.nr_sequencia%type;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_seq_proc_interno%type;
				

BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_ivc_p IS NOT NULL AND nr_seq_ivc_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
	ie_gerar_evento_w := obter_param_usuario(1113, 431, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_evento_w);
	
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_etapa_w
	from	adep_irrigacao_etapa
	where	nr_seq_irrigacao		= nr_seq_ivc_p
	and	coalesce(ie_evento_valido,'S')	= 'S';

	if (nr_seq_etapa_w > 0) then	
		update	adep_irrigacao_etapa
		set	ie_evento_valido	= 'N',
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_etapa_w;

		select	nextval('adep_irrigacao_etapa_seq')
		into STRICT	nr_seq_etapa_ww
		;

		insert into adep_irrigacao_etapa(
			nr_sequencia,
			nr_seq_irrigacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_registro,
			qt_infusao,
			qt_drenagem,
			nr_seq_aspecto,
			cd_pessoa_fisica,
			ie_evento,
			ie_evento_valido,
			nr_seq_motivo)
		values (
			nr_seq_etapa_ww,
			nr_seq_ivc_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			null,
			null,
			null,
			substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10),
			'D',
			'N',
			nr_seq_motivo_p);
			
			
		if (ie_gerar_evento_w = 'S') then
		
			SELECT	MAX(a.nr_prescricao),
				    MAX(a.nr_seq_procedimento),
				    MAX(b.nr_seq_proc_interno),
					MAX(b.cd_procedimento)
			into STRICT	nr_prescricao_w,
					nr_seq_procedimento_w,
					nr_seq_proc_interno_w,
					cd_procedimento_w
			FROM    adep_irrigacao a,
				    prescr_procedimento b
			WHERE   a.nr_prescricao = b.nr_prescricao
			AND	    a.nr_seq_procedimento = b.nr_sequencia
			AND	    a.nr_sequencia = nr_seq_ivc_p;
			
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;			
		
			insert into prescr_mat_alteracao(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_procedimento,
					dt_alteracao,
					cd_pessoa_fisica,
					ie_alteracao,
					nr_seq_motivo,
					ds_justificativa,
					ie_tipo_item,
					nr_atendimento,
					cd_item,
					nr_seq_proc_interno,
					nr_seq_motivo_susp
					--nr_seq_assinatura
					)	
			values (
					nr_seq_alteracao_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_w,
					nr_seq_procedimento_w,
					clock_timestamp(),
					obter_dados_usuario_opcao(nm_usuario_p,'C'),
					61,
					null,
					null,
					'I',
					nr_atendimento_p,
					cd_procedimento_w,	
					nr_seq_proc_interno_w,
					null
					--nr_seq_assinatura_p
					);		
		end if;	

		select	ie_evento
		into STRICT	ie_evento_anterior_w
		from	adep_irrigacao_etapa
		where	nr_sequencia = nr_seq_etapa_w;
		
		if (ie_evento_anterior_w = 'E') then
			ie_nova_ivc_w	:= substr(obter_se_permite_nova_ivc(nr_seq_ivc_p,null,ie_encerrar_ivc_p),1,1);
			if (ie_nova_ivc_w = 'N') then
				rollback;
				-- Nao e possivel reverte o termino desta irrigacao.

				--  Um paciente pode ter apenas uma irrigacao em andamento, favor verificar!
				CALL Wheb_mensagem_pck.exibir_mensagem_abort( 261369 );
			else
				update	adep_irrigacao
				set	dt_fim			 = NULL,
					cd_pessoa_fisica_fim	 = NULL,
					ie_status_ivc		= 'I'
				where	nr_sequencia		= nr_seq_ivc_p;
			end if;

		elsif (ie_evento_anterior_w = 'I') then

			select	coalesce(count(*),0)
			into STRICT	count_w
			from	adep_irrigacao
			where	nr_sequencia		= nr_seq_ivc_p
			and	coalesce(ie_status_ivc,'I')	= 'I';

			if (count_w > 0) then
				update	adep_irrigacao
				set	ie_status_ivc	= 'P'
				where	nr_sequencia	= nr_seq_ivc_p
				and	(nr_prescricao IS NOT NULL AND nr_prescricao::text <> '');

				update	adep_irrigacao
				set	ie_status_ivc	= 'X'
				where	nr_sequencia	= nr_seq_ivc_p
				and	coalesce(nr_prescricao::text, '') = '';
			end if;
		end if;
	else
		select	coalesce(count(*),0)
		into STRICT	count_w
		from	adep_irrigacao
		where	nr_sequencia		= nr_seq_ivc_p
		and	coalesce(ie_status_ivc,'I')	= 'I';

		if (count_w > 0) then
			update	adep_irrigacao
			set	ie_status_ivc = 'P'
			where	nr_sequencia		= nr_seq_ivc_p;
		end if;
		
	end if;	

end if;

	select	max(nr_seq_horario)
	into STRICT	nr_seq_horario_w
	from	adep_irrigacao_etapa
	where	nr_seq_irrigacao = nr_seq_ivc_p;
	
	select	max(ie_status_ivc)
	into STRICT	ie_status_ivc_w
	from	adep_irrigacao
	where	nr_sequencia	= nr_seq_ivc_p;
	
	if (nr_seq_horario_w > 0) then
		select	max(nr_prescricao),
			max(nr_seq_procedimento),
			max(dt_horario),
			max(cd_procedimento),
			max(nr_seq_proc_interno)
		into STRICT	nr_prescricao_w,
			nr_seq_procedimento_w,
			dt_horario_w,
			cd_procedimento_w,
			nr_seq_proc_interno_w
		from	prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_w;
		
		select	max(c.nr_sequencia)
		into STRICT	nr_seq_hor_agrupado_w
		from	prescr_procedimento a,
			prescr_medica b,
			prescr_proc_hor c
		where	a.nr_prescricao = b.nr_prescricao
		and	a.nr_sequencia = c.nr_seq_procedimento	
		and	a.nr_prescricao = c.nr_prescricao
		and	a.nr_prescricao <> nr_prescricao_w
		and	b.nr_atendimento = nr_atendimento_p
		and	c.dt_horario = dt_horario_w
		and	c.cd_procedimento = cd_procedimento_w
		and	c.nr_seq_proc_interno = nr_seq_proc_interno_w;
	
	else

		select	max(ie_status_ivc),
			max(nr_prescricao),
			max(nr_seq_procedimento)
		into STRICT	ie_status_ivc_w,
			nr_prescricao_w,
			nr_seq_procedimento_w
		from	adep_irrigacao
		where	nr_sequencia	= nr_seq_ivc_p;

	end if;
	
	if (ie_status_ivc_w = 'F') then
		ie_status_ivc_w	:= 'A';
	elsif (ie_status_ivc_w = 'P') then
		ie_status_ivc_w	:= 'N';
	end if;
	
	if (ie_status_ivc_w = 'N') then
	
		update	adep_irrigacao
		set		dt_inicio  = NULL,
				cd_pessoa_fisica  = NULL,
                qt_balanco  = NULL
		where	nr_sequencia = nr_seq_ivc_p;
		
		update	prescr_proc_hor
		set		ie_status_ivc	= ie_status_ivc_w,
				dt_fim_horario   = NULL
		where	nr_prescricao	= nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_procedimento_w
		and		nr_sequencia = nr_seq_horario_w;
		
		if (nr_seq_hor_agrupado_w IS NOT NULL AND nr_seq_hor_agrupado_w::text <> '') then
		
			update	prescr_proc_hor
			set		ie_status_ivc	= ie_status_ivc_w,
					dt_fim_horario   = NULL
			where	nr_sequencia	= nr_seq_hor_agrupado_w;
		
		end if;
	
	elsif (ie_status_ivc_w = 'A') then
	
		update	prescr_proc_hor
		set		ie_status_ivc	= ie_status_ivc_w
		where	nr_prescricao	= nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_procedimento_w
		and		nr_sequencia = nr_seq_horario_w;
		
		if (nr_seq_hor_agrupado_w IS NOT NULL AND nr_seq_hor_agrupado_w::text <> '') then
		
			update	prescr_proc_hor
			set		ie_status_ivc	= ie_status_ivc_w
			where	nr_sequencia	= nr_seq_hor_agrupado_w;
		
		end if;
	
	elsif (ie_status_ivc_w = 'I') then
	
		update 	prescr_proc_hor
		set		ie_status_ivc = 'N'
		where 	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_procedimento_w;

		update 	prescr_proc_hor
		set		ie_status_ivc = ie_status_ivc_w
		where 	nr_prescricao = nr_prescricao_w
		and		nr_seq_procedimento = nr_seq_procedimento_w
		and		nr_sequencia = nr_seq_horario_w;
	
	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_reverter_etapa_ivc ( nr_atendimento_p bigint, nr_seq_ivc_p bigint, nr_seq_motivo_p text, nm_usuario_p text, ie_encerrar_ivc_p text) FROM PUBLIC;

