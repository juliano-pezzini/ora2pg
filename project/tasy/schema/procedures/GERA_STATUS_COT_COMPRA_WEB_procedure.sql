-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_status_cot_compra_web ( nr_sequencia_p bigint, ie_status_p text, nm_usuario_p text) AS $body$
DECLARE


nr_cot_compra_w				bigint;
nr_seq_regra_w				bigint;
cd_estabelecimento_w			smallint;
cd_cgc_fornecedor_w			varchar(14);
ds_razao_social_w				varchar(100);
ds_fantasia_w				varchar(100);
ds_fornecedor_w				varchar(100);
ds_email_origem_w				varchar(255);
ds_email_destino_w				varchar(255);
ds_email_solicitante_w			varchar(255);
ds_email_comprador_w			varchar(255);
ds_assunto_w				varchar(255);
ds_mensagem_w				varchar(2000);
ie_usuario_w				varchar(3);
ds_email_compras_w			varchar(255);
ds_url_cotacao_w				varchar(120);
ds_email_adicional_w			varchar(2000);
nr_posicao_w				bigint := 0;
ie_momento_envio_w			varchar(1);
ds_email_remetente_w			varchar(255);
ds_erro_w				cot_compra.ds_observacao%type;


BEGIN

if (ie_status_p = 'LF') then
	update	cot_compra_forn
	set	ie_status		= ie_status_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p
	and	ie_status 		= 'LH';
	
else
	update	cot_compra_forn
	set	ie_status		= ie_status_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p;
end if;

commit;

if (ie_status_p = 'FF') then

	select	nr_cot_compra,
		cd_cgc_fornecedor
	into STRICT	nr_cot_compra_w,
		cd_cgc_fornecedor_w
	from	cot_compra_forn
	where	nr_sequencia = nr_sequencia_p;

	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	cot_compra
	where	nr_cot_compra = nr_cot_compra_w;
	
	select	ds_email,
		ds_url_cotacao
	into STRICT	ds_email_compras_w,
		ds_url_cotacao_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	select	coalesce(max(nr_sequencia),0),
		coalesce(max(ie_usuario),'U'),
		coalesce(max(ds_email_remetente),'X'),
		max(replace(ds_email_adicional,',',';')),
		coalesce(max(ie_momento_envio),'I')
	into STRICT	nr_seq_regra_w,
		ie_usuario_w,
		ds_email_remetente_w,
		ds_email_adicional_w,
		ie_momento_envio_w
	from	regra_envio_email_compra
	where	ie_tipo_mensagem = 20
	and	ie_situacao = 'A'
	and	cd_estabelecimento = cd_estabelecimento_w
	and	obter_se_envia_email_regra(nr_cot_compra_w, 'CC', 20, cd_estabelecimento_w) = 'S';
	
	if (nr_seq_regra_w > 0) then
	
		select	substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w),'N'),1,100) ds_razao_social,
			substr(obter_dados_pf_pj(null,obter_cgc_estabelecimento(cd_estabelecimento_w),'F'),1,100) ds_fantasia,
			substr(obter_dados_pf_pj(null,cd_cgc_fornecedor_w,'F'),1,100) ds_fornecedor,
			substr(obter_dados_pf_pj_estab(cd_estabelecimento_w,null,cd_cgc_fornecedor_w,'M'),1,100) ds_email_origem,
			substr(obter_dados_usuario_opcao(obter_usuario_pessoa(cd_pessoa_solicitante),'E'),1,255) ds_email_solicitante,
			substr(obter_dados_usuario_opcao(obter_usuario_pessoa(cd_comprador),'E'),1,255) ds_email_comprador
		into STRICT	ds_razao_social_w,
			ds_fantasia_w,
			ds_fornecedor_w,
			ds_email_origem_w,
			ds_email_solicitante_w,
			ds_email_comprador_w
		from	cot_compra
		where	nr_cot_compra = nr_cot_compra_w;

		select	ds_assunto,
			ds_mensagem_padrao
		into STRICT	ds_assunto_w,
			ds_mensagem_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_seq_regra_w;

		ds_assunto_w	:= replace_macro(ds_assunto_w, '@fantasia_pj', ds_fantasia_w);
		ds_assunto_w	:= replace_macro(ds_assunto_w, '@razao_pj', ds_razao_social_w);
		ds_assunto_w	:= replace_macro(ds_assunto_w, '@url', ds_url_cotacao_w);
		ds_assunto_w	:= replace_macro(ds_assunto_w, '@cotacao', nr_cot_compra_w);
		ds_assunto_w	:= replace_macro(ds_assunto_w, '@data', clock_timestamp());
		ds_assunto_w	:= replace_macro(ds_assunto_w, '@fornecedor', ds_fornecedor_w);
		ds_assunto_w	:= substr(ds_assunto_w, 1, 255);

		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@fantasia_pj', ds_fantasia_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@razao_pj', ds_razao_social_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@url', ds_url_cotacao_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@cotacao', nr_cot_compra_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@data', clock_timestamp()),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@fornecedor', ds_fornecedor_w),1,4000);
		ds_mensagem_w	:= substr(ds_mensagem_w, 1, 2000);

		ds_email_destino_w := ds_email_solicitante_w;
		
		if (ie_usuario_w = 'C') then
			
			if (ds_email_compras_w IS NOT NULL AND ds_email_compras_w::text <> '') then
				ds_email_origem_w := ds_email_compras_w;
			end if;
		end if;		
		
		if (coalesce(ds_email_comprador_w,'X') <> coalesce(ds_email_solicitante_w,'X')) then
			if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then
				ds_email_destino_w := ds_email_destino_w || ';' || ds_email_comprador_w;
			else
				ds_email_destino_w := ds_email_comprador_w;
			end if;
		end if;	

		if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
			ds_email_destino_w := ds_email_destino_w || ';' || ds_email_adicional_w;
		end if;
		
		nr_posicao_w	:= position(';' in ds_email_origem_w);
		
		if (nr_posicao_w > 0) then
			ds_email_origem_w := substr(ds_email_origem_w,1,nr_posicao_w -1);
		end if;

		if (ds_email_remetente_w <> 'X') then
			ds_email_origem_w	:= ds_email_remetente_w;
		end if;

		begin
			if (ie_momento_envio_w = 'A') then
				begin

				CALL sup_grava_envio_email(
					'CC',
					'20',
					nr_cot_compra_w,
					null,
					null,
					ds_email_destino_w,
					nm_usuario_p,
					ds_email_origem_w,
					ds_assunto_w,
					ds_mensagem_w,
					cd_estabelecimento_w,
					nm_usuario_p);

				end;
			else		
				CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_email_destino_w,nm_usuario_p,'M');
			end if;
		exception
		when others then
			ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(1100313, 'CD_REGRA=' || '20' || ';DS_ERRO=' || substr(SQLERRM(SQLSTATE),1,3900));
		
			CALL gerar_historico_cotacao(nr_cot_compra_w,
				WHEB_MENSAGEM_PCK.get_texto(1100617),
				ds_erro_w,
				'S',
				nm_usuario_p);
		end;
		
	end if;
end if;
commit;
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_status_cot_compra_web ( nr_sequencia_p bigint, ie_status_p text, nm_usuario_p text) FROM PUBLIC;

