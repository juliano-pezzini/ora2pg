-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_exe_requisicao (cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE


cd_area_w		bigint;
cd_especialidade_w	bigint;
cd_grupo_w		bigint;
nr_seq_estrutura_mat_w	bigint;
nr_seq_regra_w		bigint;
nr_seq_estrut_regra_w	bigint;
nr_seq_regra_ret_w	bigint;
ie_estrut_mat_w		varchar(1);

C01 CURSOR FOR
	SELECT	nr_seq_regra_exec_req,
		nr_seq_estrutura_mat
	from	(
		SELECT	a.nr_sequencia nr_seq_regra_exec_req,
			b.nr_seq_estrutura_mat nr_seq_estrutura_mat,
			cd_procedimento,
			cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento,
			nr_seq_material
		from	pls_regra_exec_requisicao	b,
			pls_grupo_regra_exec_req	a
		where	b.cd_estabelecimento				= cd_estabelecimento_p
		and	((coalesce(b.cd_procedimento::text, '') = '') or (b.cd_procedimento = coalesce(cd_procedimento_p,0)))
		and	((coalesce(b.ie_origem_proced::text, '') = '') or (b.ie_origem_proced = coalesce(ie_origem_proced_p,0)))
		and	coalesce(b.cd_grupo_proc,cd_grupo_w)			= cd_grupo_w
		and	coalesce(b.cd_especialidade, cd_especialidade_w)	= cd_especialidade_w
		and	coalesce(b.cd_area_procedimento, cd_area_w) 		= cd_area_w
		and	((coalesce(b.nr_seq_material::text, '') = '') or (b.nr_seq_material 	= coalesce(nr_seq_material_p,0)))
		and	b.ie_regra	= 'S'
		and	b.ie_situacao	= 'A'
		and	b.nr_seq_grupo 	= a.nr_sequencia
		and (a.cd_estabelecimento = cd_estabelecimento_p and (pls_obter_se_controle_estab('RE') = 'S'))
		
union all

		select	a.nr_sequencia,
			b.nr_seq_estrutura_mat,
			cd_procedimento,
			cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento,
			nr_seq_material
		from	pls_regra_exec_requisicao	b,
			pls_grupo_regra_exec_req	a
		where	b.cd_estabelecimento				= cd_estabelecimento_p
		and	((coalesce(b.cd_procedimento::text, '') = '') or (b.cd_procedimento = coalesce(cd_procedimento_p,0)))
		and	((coalesce(b.ie_origem_proced::text, '') = '') or (b.ie_origem_proced = coalesce(ie_origem_proced_p,0)))
		and	coalesce(b.cd_grupo_proc,cd_grupo_w)			= cd_grupo_w
		and	coalesce(b.cd_especialidade, cd_especialidade_w)	= cd_especialidade_w
		and	coalesce(b.cd_area_procedimento, cd_area_w) 		= cd_area_w
		and	((coalesce(b.nr_seq_material::text, '') = '') or (b.nr_seq_material 	= coalesce(nr_seq_material_p,0)))
		and	b.ie_regra	= 'S'
		and	b.ie_situacao	= 'A'
		and	b.nr_seq_grupo 	= a.nr_sequencia
		and (pls_obter_se_controle_estab('RE') = 'N')) alias41
	order by
		coalesce(cd_procedimento,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade,0),
		coalesce(cd_area_procedimento,0),
		coalesce(nr_seq_material,0),
		coalesce(nr_seq_estrutura_mat,0);


BEGIN

begin
select	coalesce(cd_area_procedimento,0),
	coalesce(cd_especialidade,0),
	coalesce(cd_grupo_proc,0)
into STRICT	cd_area_w,
	cd_especialidade_w,
	cd_grupo_w
from	estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	cd_area_w		:= 0;
	cd_especialidade_w	:= 0;
	cd_grupo_w		:= 0;
end;

begin
select	coalesce(nr_seq_estrut_mat,0)
into STRICT	nr_seq_estrutura_mat_w
from	pls_material
where	nr_sequencia = nr_seq_material_p;
exception
	when others then
	nr_seq_estrutura_mat_w := 0;
end;

open C01;
loop
fetch C01 into
	nr_seq_regra_w,
	nr_seq_estrut_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_estrut_mat_w	:= 'S';
	if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') then
		if (pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w) = 'N') then
			ie_estrut_mat_w	:= 'N';
		end if;
	end if;

	if (ie_estrut_mat_w = 'S') then
		nr_seq_regra_ret_w	:= nr_seq_regra_w;
	end if;
	end;
end loop;
close C01;

nr_seq_regra_p := coalesce(nr_seq_regra_ret_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_exe_requisicao (cd_estabelecimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

