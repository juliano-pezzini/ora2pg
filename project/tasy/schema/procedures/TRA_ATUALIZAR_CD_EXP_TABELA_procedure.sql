-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tra_atualizar_cd_exp_tabela () AS $body$
DECLARE


nm_tabela_w				corp_tabelas_traducao.nm_tabela%type;
nm_atributo_w			corp_tabelas_traducao.nm_atributo%type;
nm_atributo_exp_w		corp_tabelas_traducao.nm_atributo_exp%type;

dt_atualizacao_nrec_w	corp_tabelas_traducao.dt_atualizacao_nrec%type;
dt_ultima_exec_w		timestamp;
dt_considerar_reg_w		timestamp;


c01 CURSOR FOR
	SELECT	nm_tabela,
			nm_atributo,
			nm_atributo_exp,
			dt_atualizacao_nrec
	from	corp_tabelas_traducao
	where	ie_situacao = 'A';

c03 CURSOR FOR
	SELECT	nm_tabela
	from	LOG_CORP_TABELAS_TRADUCAO
	where	(nm_tabela IS NOT NULL AND nm_tabela::text <> '');


BEGIN

select max(dt_execucao) into STRICT dt_ultima_exec_w from log_corp_tabelas_traducao;
delete	FROM log_corp_tabelas_traducao;

-- Busca todos os registros do cadastro que estão ativos, e tenta atualizar.
open c01;
loop
fetch c01 into
	nm_tabela_w,
	nm_atributo_w,
	nm_atributo_exp_w,
	dt_atualizacao_nrec_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

		/* Pega a data de inserção da tabela na regra para o caso da tabela ter sido inserida posteriormente a job ser rodada, neste caso irá pegar todos os registros e atualiza-los.*/

		dt_considerar_reg_w := dt_ultima_exec_w;
		if (dt_atualizacao_nrec_w > dt_ultima_exec_w) then
			dt_considerar_reg_w := null;
		end if;

		CALL TRA_EXEC_UPD_TABELAS_TRADUCAO(dt_considerar_reg_w, nm_atributo_w, nm_atributo_exp_w, nm_tabela_w);

	end;
end loop;
close c01;

-- Busca todas as tabelas que deram algum tipo de erro (tabela de log) no cursor anterior, e tenta rodar novamente, sem restrição de data de atualização do registro da tabela.
/*open c03;
loop
fetch c03 into
	nm_tabela_w;
exit when c03%notfound;
	begin

		-- Na tabela de log, apenas temos o nm_tabela
		select	nm_atributo,
				nm_atributo_exp
		into	nm_atributo_w,
				nm_atributo_exp_w
		from	corp_tabelas_traducao
		where	nm_tabela = nm_tabela_w;

		TRA_EXEC_UPD_TABELAS_TRADUCAO(null, nm_atributo_w, nm_atributo_exp_w, nm_tabela_w);

	end;
end loop;
close c03;*/
insert into LOG_CORP_TABELAS_TRADUCAO(nm_tabela, ds_log, dt_execucao) values ('', 'Gravação da data de execução da job.', clock_timestamp());

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tra_atualizar_cd_exp_tabela () FROM PUBLIC;

