-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_aut_email ( nr_seq_guia_p bigint, ie_tipo_regra_p bigint, ie_prestador_p INOUT text, ie_fornecedor_p INOUT text, nr_seq_regra_p INOUT text, ie_solic_mat_med_p INOUT text) AS $body$
DECLARE


ie_prestador_w			varchar(15);
ie_fornecedor_w 		varchar(15);
nr_seq_regra_w			bigint;
ie_solicitacao_mat_med_w	varchar(1);

C01 CURSOR FOR
	SELECT	nr_seq_regra,
		ie_prestador,
		ie_fornecedor,
		ie_solicitacao_mat_med
	from	(
		SELECT	nr_seq_regra,
			ie_prestador,
			ie_fornecedor,
			ie_solicitacao_mat_med
		from	pls_autorizacao_email	b,
			pls_regra_aut_email	a
		where	a.nr_seq_regra = b.nr_sequencia
		and	a.ie_situacao = 'A'
		and	b.ie_situacao = 'A'
		and	((a.ie_prestador = 'S'
		or	a.ie_fornecedor = 'S'
		and	ie_tipo_regra_p = 2)
		or (a.ie_solicitacao_mat_med = 'S'
		and	ie_tipo_regra_p = 3))
		and (coalesce(b.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento and pls_obter_se_controle_estab('RE') = 'S')
		
union all

		select	nr_seq_regra,
			ie_prestador,
			ie_fornecedor,
			ie_solicitacao_mat_med
		from	pls_autorizacao_email	b,
			pls_regra_aut_email	a
		where	a.nr_seq_regra = b.nr_sequencia
		and	a.ie_situacao = 'A'
		and	b.ie_situacao = 'A'
		and	((a.ie_prestador = 'S'
		or	a.ie_fornecedor = 'S'
		and	ie_tipo_regra_p = 2)
		or (a.ie_solicitacao_mat_med = 'S'
		and	ie_tipo_regra_p = 3))
		and (pls_obter_se_controle_estab('RE') = 'N')) alias11
	order by nr_seq_regra;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_regra_w,
	ie_prestador_w,
	ie_fornecedor_w,
	ie_solicitacao_mat_med_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_seq_regra_p	:= nr_seq_regra_w;
	ie_prestador_p	:= ie_prestador_w;
	ie_fornecedor_p 	:= ie_fornecedor_w;
	ie_solic_mat_med_p := ie_solicitacao_mat_med_w;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_aut_email ( nr_seq_guia_p bigint, ie_tipo_regra_p bigint, ie_prestador_p INOUT text, ie_fornecedor_p INOUT text, nr_seq_regra_p INOUT text, ie_solic_mat_med_p INOUT text) FROM PUBLIC;

