-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_conferencia_xml ( nr_seq_lote_sib_p bigint, ds_situacao_benef_p text, nr_cco_p text, nr_cco_titular_p text, nm_beneficiario_p text, cd_usuario_plano_p text, ie_dependencia_p bigint, ie_sexo_p bigint, nr_cpf_p text, dt_nascimento_p text, dt_contratacao_p text, dt_cancelamento_p text, cd_plano_ans_p text, nr_plano_rps_p text, nr_seq_motivo_cancelamento_p bigint, nm_mae_p text, cd_cep_p text, ds_logradouro_p text, nr_endereco_p text, ds_bairro_p text, cd_municipio_p bigint, ie_resid_exterior_p bigint, ie_cpt_p bigint, ie_item_excluido_cobert_p bigint, cd_cnpj_empresa_p text, dt_atualizacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_cns_p text, dt_reativacao_p text, ie_tipo_endereco_p text, dt_atualizacao_ans_p text) AS $body$
DECLARE


nr_seq_linha_w			bigint;
ie_tipo_registro_w		bigint;
dt_nascimento_w			timestamp;
dt_nascimento_ww		varchar(8);
dt_contratacao_w		timestamp;
dt_contratacao_ww		varchar(8);
dt_cancelamento_w		timestamp;
dt_cancelamento_ww		varchar(8);
nr_cco_w			bigint;
ie_digito_cco_w			smallint;
nr_cco_titular_w		bigint;
ie_digito_cco_titular_w		smallint;
dt_alteracao_registro_w		timestamp;
dt_alteracao_registro_ww	varchar(8);
nr_seq_motivo_cancelamento_w	bigint;
nr_seq_retorno_sib_w		bigint;
dt_reativacao_w			timestamp;
dt_reativacao_ww		varchar(8);
dt_atualizacao_w		timestamp;
dt_atualizacao_ww		varchar(8);


BEGIN

/*select	max(nr_seq_linha)
into	nr_seq_linha_w
from	pls_retorno_sib
where	nr_seq_lote_sib	= nr_seq_lote_sib_p;*/
if (coalesce(nr_seq_linha_w::text, '') = '') then
	nr_seq_linha_w	:= 1;
else
	nr_seq_linha_w	:= nr_seq_linha_w + 1;
end if;

if (upper(ds_situacao_benef_p)	= 'ATIVO') then
	ie_tipo_registro_w	:= 1;
elsif (upper(ds_situacao_benef_p)	= 'INATIVO') then
	ie_tipo_registro_w	:= 3;
end if;

dt_nascimento_ww	:= replace(dt_nascimento_p,'-','');
if (dt_nascimento_ww IS NOT NULL AND dt_nascimento_ww::text <> '') then
	dt_nascimento_ww		:= substr(dt_nascimento_ww,7,2) || substr(dt_nascimento_ww,5,2) || substr(dt_nascimento_ww,1,4);
	dt_nascimento_w			:= to_date(dt_nascimento_ww);
end if;

dt_contratacao_ww	:= replace(dt_contratacao_p,'-','');
if (dt_contratacao_ww IS NOT NULL AND dt_contratacao_ww::text <> '') then
	dt_contratacao_ww		:= substr(dt_contratacao_ww,7,2) || substr(dt_contratacao_ww,5,2) || substr(dt_contratacao_ww,1,4);
	dt_contratacao_w		:= to_date(dt_contratacao_ww);
end if;

dt_cancelamento_ww	:= replace(dt_cancelamento_p,'-','');
if (dt_cancelamento_ww IS NOT NULL AND dt_cancelamento_ww::text <> '') then
	dt_cancelamento_ww		:= substr(dt_cancelamento_ww,7,2) || substr(dt_cancelamento_ww,5,2) || substr(dt_cancelamento_ww,1,4);
	dt_cancelamento_w		:= to_date(dt_cancelamento_ww);
end if;

dt_alteracao_registro_ww	:= replace(dt_atualizacao_p,'-','');
if (dt_alteracao_registro_ww IS NOT NULL AND dt_alteracao_registro_ww::text <> '') then
	dt_alteracao_registro_ww	:= substr(dt_alteracao_registro_ww,7,2) || substr(dt_alteracao_registro_ww,5,2) || substr(dt_alteracao_registro_ww,1,4);
	dt_alteracao_registro_w		:= to_date(dt_alteracao_registro_ww);
end if;

nr_cco_w		:= substr(nr_cco_p,1,10);
ie_digito_cco_w		:= substr(nr_cco_p,11,2);
nr_cco_titular_w	:= substr(nr_cco_titular_p,1,10);
ie_digito_cco_titular_w	:= substr(nr_cco_titular_p,11,2);
nr_seq_motivo_cancelamento_w	:= nr_seq_motivo_cancelamento_p;

dt_reativacao_ww	:= replace(dt_reativacao_p,'-','');
if (dt_reativacao_ww IS NOT NULL AND dt_reativacao_ww::text <> '') then
	dt_reativacao_ww	:= substr(dt_reativacao_ww,7,2) || substr(dt_reativacao_ww,5,2) || substr(dt_reativacao_ww,1,4);
	dt_reativacao_w		:= to_date(dt_reativacao_ww);
end if;

dt_atualizacao_ww	:= replace(dt_atualizacao_ans_p,'-','');
if (dt_atualizacao_ww IS NOT NULL AND dt_atualizacao_ww::text <> '') then
	dt_atualizacao_ww	:= substr(dt_atualizacao_ww,7,2) || substr(dt_atualizacao_ww,5,2) || substr(dt_atualizacao_ww,1,4);
	dt_atualizacao_w		:= to_date(dt_atualizacao_ww);
end if;

select	nextval('pls_retorno_sib_seq')
into STRICT	nr_seq_retorno_sib_w
;

insert into pls_retorno_sib(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
		nr_seq_linha,ie_tipo_registro,cd_usuario_plano,nm_beneficiario,dt_nascimento,
		ie_sexo,nr_cpf,nr_pis_pasep,nm_mae,
		dt_adesao_plano,dt_rescisao_contrato,dt_reativacao_contrato,ds_logradouro,nr_endereco,
		ds_complemento,ds_bairro,sg_uf,cd_cep,ie_vinculo_beneficiario,
		cd_alteracao_plano,ie_cobertura_parcial,cd_plano_anterior,nr_cns,nr_identidade,
		ds_orgao_emissor,cd_pais_emissor,cd_cgc,cd_titular_plano,ie_item_exc_cobertura,
		dt_migracao,nr_cei,dt_inclusao,dt_exclusao,cd_motivo_inclusao,
		nr_cco,ie_digito_cco,nr_plano_ans,cd_municipio_ibge,ie_resid_brasil,
		nr_seq_motivo_cancelamento,dt_alteracao_registro,nr_seq_lote_sib,ie_carteira_anterior,ie_enviar_sib,
		ie_tipo_retorno, ie_tipo_endereco, dt_atualizacao_ans, nr_cco_titular, ie_digito_cco_titular)
values (	nr_seq_retorno_sib_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
		nr_seq_linha_w,ie_tipo_registro_w,cd_usuario_plano_p,nm_beneficiario_p,dt_nascimento_ww,
		ie_sexo_p,nr_cpf_p,null,nm_mae_p,
		dt_contratacao_ww,dt_cancelamento_w,dt_reativacao_w,ds_logradouro_p,nr_endereco_p,
		'',ds_bairro_p,'',cd_cep_p,ie_dependencia_p,
		0,ie_cpt_p,nr_plano_rps_p,nr_cns_p,0,
		'','',cd_cnpj_empresa_p,null,ie_item_excluido_cobert_p,
		null,null,dt_contratacao_ww,dt_cancelamento_w,null,
		nr_cco_w,ie_digito_cco_w,cd_plano_ans_p,cd_municipio_p,ie_resid_exterior_p,
		nr_seq_motivo_cancelamento_w,dt_alteracao_registro_w,nr_seq_lote_sib_p,'N','N',
		to_char(ie_tipo_registro_w), ie_tipo_endereco_p, dt_atualizacao_w, nr_cco_titular_w, ie_digito_cco_titular_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_conferencia_xml ( nr_seq_lote_sib_p bigint, ds_situacao_benef_p text, nr_cco_p text, nr_cco_titular_p text, nm_beneficiario_p text, cd_usuario_plano_p text, ie_dependencia_p bigint, ie_sexo_p bigint, nr_cpf_p text, dt_nascimento_p text, dt_contratacao_p text, dt_cancelamento_p text, cd_plano_ans_p text, nr_plano_rps_p text, nr_seq_motivo_cancelamento_p bigint, nm_mae_p text, cd_cep_p text, ds_logradouro_p text, nr_endereco_p text, ds_bairro_p text, cd_municipio_p bigint, ie_resid_exterior_p bigint, ie_cpt_p bigint, ie_item_excluido_cobert_p bigint, cd_cnpj_empresa_p text, dt_atualizacao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_cns_p text, dt_reativacao_p text, ie_tipo_endereco_p text, dt_atualizacao_ans_p text) FROM PUBLIC;

