-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_lote_frasco_pato_loc ( nr_seq_lote_atend_p bigint, nm_usuario_p text) AS $body$
BEGIN

update	pato_lote_atend_rastreabi
set	nm_usuario	=	nm_usuario_p,
	dt_atualizacao	=	clock_timestamp(),
	ie_status	=	'C'
where	nr_sequencia	=	nr_seq_lote_atend_p;

update	amost_lote_atend_rastreabi
set	ie_status 	= 	'C',
	nm_usuario	=	nm_usuario_p,
	dt_atualizacao	=	clock_timestamp()
where	nr_seq_lote_atend	=	nr_seq_lote_atend_p;


insert into frasco_pato_loc_status(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_status,
	nr_seq_frasco_pato_loc,
	cd_setor_atendimento)
SELECT	nextval('frasco_pato_loc_status_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	60,
	a.nr_seq_amostra,
	null
from	amost_lote_atend_rastreabi a
where	a.nr_seq_lote_atend	=	nr_seq_lote_atend_p;


update	frasco_pato_loc a
set	a.ie_status 		= 	60,
	a.nm_usuario		=	nm_usuario_p,
	a.dt_atualizacao	=	clock_timestamp()
where	exists (SELECT	1
		from 	amost_lote_atend_rastreabi x
		where	x.nr_seq_amostra 	= a.nr_sequencia
		and	x.nr_seq_lote_atend	= nr_seq_lote_atend_p);


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_lote_frasco_pato_loc ( nr_seq_lote_atend_p bigint, nm_usuario_p text) FROM PUBLIC;

