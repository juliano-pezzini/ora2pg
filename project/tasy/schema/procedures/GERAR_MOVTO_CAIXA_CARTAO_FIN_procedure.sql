-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_caixa_cartao_fin (nm_usuario_p text, nr_seq_baixa_p text) AS $body$
DECLARE


nr_seq_movto_cartao_w		bigint;
nr_seq_trans_financ_w		bigint;
nr_seq_conta_banco_w		bigint;
dt_baixa_w			timestamp;
vl_baixa_w			double precision;
nr_sequencia_w			bigint;
vl_despesa_w			double precision;
nr_seq_trans_fin_desp_w		bigint;
nr_seq_trans_desp_equip_w	bigint;
vl_desp_equip_w			double precision;
ds_observacao_w			varchar(4000);
ie_obs_cartao_hist_cb_w		varchar(1);
cd_estabelecimento_w		smallint;
ie_valor_movto_bco_w		varchar(1);
nr_seq_parcela_w		bigint;
nr_seq_trans_fin_despesa_w	bigint;
ie_trans_despesa_w		varchar(1);
ie_baixa_desp_cartao_cc_w	varchar(1);
cd_centro_custo_w		integer;
cd_conta_financ_w		bigint;
vl_classificacao_w		double precision;
vl_tot_classificacao_w		double precision;
ie_deduzir_despesa_cartao_w	parametro_contas_receber.ie_deduzir_despesa_cartao%type;
nr_seq_baixa_orig_w		movto_cartao_cr_baixa.nr_seq_baixa_orig%type;
ie_estorno_w			movto_trans_financ.ie_estorno%type;
nr_seq_movto_orig_w		movto_trans_financ.nr_sequencia%type;
ie_estorno_controle_w			varchar(1) := 'N';
/*variaveis do cursor 02*/

nr_sequencia_trib_w			movto_cartao_cr_trib.nr_sequencia%type;
nr_seq_trans_financ_trib_w	movto_cartao_cr_trib.nr_seq_trans_financ%type;
cd_tributo_w				movto_cartao_cr_trib.cd_tributo%type;
vl_imposto_w				movto_cartao_cr_trib.vl_imposto%type;
nr_seq_movto_orig_trib_w	movto_trans_financ.nr_sequencia%type;
vl_imposto_parcela_w		movto_cartao_cr_parcela.vl_imposto%type;
vl_liquido_w				movto_cartao_cr_parcela.vl_liquido%type;
ds_obs_trib_w				varchar(4000);
ds_imposto_w				varchar(255);
vl_baixa_trib_w				movto_trans_financ.vl_transacao%type;
nr_seq_baixa_w				movto_cartao_cr_baixa.nr_sequencia%type;
nr_seq_lote_w				movto_trans_financ.nr_seq_lote%type;
nr_seq_caixa_w				bigint;
nr_seq_saldo_caixa_w			movto_trans_financ.nr_seq_saldo_caixa%type;
dt_saldo_referencia_w		timestamp;



BEGIN

nr_seq_caixa_w := obter_valor_param_usuario(3020,34,obter_perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo); --Caixa onde deve ser gerada a transação do lote de cartão
nr_seq_trans_financ_w := obter_valor_param_usuario(3020,35,obter_perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo); --Transação financeira para movimentação de caixa do lote de baixa
select coalesce(max(nr_seq_lote),0) + 1
into STRICT nr_seq_lote_w
from movto_trans_financ
where (dt_fechamento_lote IS NOT NULL AND dt_fechamento_lote::text <> '') 
and nr_seq_caixa = nr_seq_caixa_w;

select max(nr_sequencia),
	   max(dt_saldo)
into STRICT nr_seq_saldo_caixa_w,
	 dt_saldo_referencia_w
from caixa_saldo_diario
where nr_seq_caixa = nr_seq_caixa_w
and coalesce(dt_fechamento::text, '') = '';

    select	max(a.VL_BAIXA),
			max(a.NR_SEQ_PARCELA)
	into STRICT	vl_baixa_w,
			nr_seq_parcela_w
	from	movto_cartao_cr_baixa a
	where	a.nr_sequencia	= nr_seq_baixa_p;


	select	nextval('movto_trans_financ_seq')
	into STRICT	nr_sequencia_w
	;
	
	SELECT  MAX(nr_seq_movto)
	into STRICT nr_seq_movto_cartao_w
	FROM movto_cartao_cr_parcela d 
	WHERE d.nr_sequencia = nr_seq_parcela_w;
	
	select max(nr_sequencia)
	into STRICT nr_seq_movto_orig_w
	from movto_trans_financ
	where nr_seq_movto_cartao = nr_seq_movto_cartao_w;

	insert	into movto_trans_financ(nr_sequencia,
						nr_seq_lote,
						dt_transacao,
						nr_seq_trans_financ,
						vl_transacao,
						dt_atualizacao,
						nm_usuario,
						nr_lote_contabil,
						ie_conciliacao,
						nr_seq_movto_cartao,
						dt_referencia_saldo,
						nr_seq_parc_cartao,
						nr_seq_movto_orig,
						nr_seq_caixa,
						nr_seq_saldo_caixa)
					values (nr_sequencia_w,
						nr_seq_lote_w,
						clock_timestamp(),
						nr_seq_trans_financ_w,
						vl_baixa_w,
						clock_timestamp(),
						nm_usuario_p,
						0,
						'N',
						nr_seq_movto_cartao_w,
						dt_saldo_referencia_w,
						nr_seq_parcela_w,
						nr_seq_movto_orig_w,
						nr_seq_caixa_w,
						nr_seq_saldo_caixa_w);


update movto_trans_financ
set dt_fechamento_lote = clock_timestamp() 
where nr_seq_lote = nr_seq_lote_w;

CALL Atualizar_Saldo_Caixa(obter_estabelecimento_ativo,nr_seq_lote_w,nr_seq_caixa_w,nm_usuario_p,'S');
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_caixa_cartao_fin (nm_usuario_p text, nr_seq_baixa_p text) FROM PUBLIC;

