-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_get_means_of_payment ( nr_interno_conta_p nota_fiscal.nr_interno_conta%type, nr_seq_protocolo_p nota_fiscal.nr_seq_protocolo%type, nr_seq_lote_prot_p nota_fiscal.nr_seq_lote_prot%type, cd_cgc_p nota_fiscal.cd_cgc%type, cd_pessoa_fisica_p nota_fiscal.cd_pessoa_fisica%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type, ie_meio_pagamento_p INOUT nota_fiscal.ie_meio_pagamento%type, ds_outro_meio_pagamento_p INOUT nota_fiscal.ds_outro_meio_pagamento%type) AS $body$
DECLARE


cd_convenio_w			protocolo_convenio.cd_convenio%type;

C01 CURSOR FOR
	SELECT	ie_meio_pagamento,
		ds_outro_meio_pagamento
	from 	fis_regra_meio_pag
	where 	ie_situacao = 'A'
	and 	(ie_meio_pagamento IS NOT NULL AND ie_meio_pagamento::text <> '')
	and	coalesce(cd_cgc, coalesce(cd_cgc_p, 0)) = coalesce(cd_cgc_p, 0)
	and	coalesce(cd_pessoa_fisica, coalesce(cd_pessoa_fisica_p, 0)) = coalesce(cd_pessoa_fisica_p, 0)
	and	coalesce(cd_operacao_nf, coalesce(cd_operacao_nf_p, 0)) = coalesce(cd_operacao_nf_p, 0)
	and	coalesce(cd_convenio, coalesce(cd_convenio_w, 0)) = coalesce(cd_convenio_w, 0)
	order by coalesce(cd_cgc, 0), coalesce(cd_pessoa_fisica, 0), coalesce(cd_operacao_nf, 0), coalesce(cd_convenio, 0);
	

BEGIN
	
	begin
		select	max(cd_convenio_parametro)
		into STRICT	cd_convenio_w
		from (	SELECT		cd_convenio_parametro
				from		conta_paciente
				where		nr_interno_conta = nr_interno_conta_p
				and		(nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '')
				
union all

				SELECT		cd_convenio
				from		protocolo_convenio
				where		nr_seq_protocolo = nr_seq_protocolo_p
				and		(nr_seq_protocolo IS NOT NULL AND nr_seq_protocolo::text <> '')
				
union all

				select		cd_convenio
				from		lote_protocolo
				where		nr_sequencia = nr_seq_lote_prot_p
				and		(nr_seq_lote_prot_p IS NOT NULL AND nr_seq_lote_prot_p::text <> '')) alias4;	

	exception
	when no_data_found or too_many_rows then
		cd_convenio_w := null;
	end;
	
	open C01;
	loop
	fetch C01 into
		ie_meio_pagamento_p,
		ds_outro_meio_pagamento_p;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_get_means_of_payment ( nr_interno_conta_p nota_fiscal.nr_interno_conta%type, nr_seq_protocolo_p nota_fiscal.nr_seq_protocolo%type, nr_seq_lote_prot_p nota_fiscal.nr_seq_lote_prot%type, cd_cgc_p nota_fiscal.cd_cgc%type, cd_pessoa_fisica_p nota_fiscal.cd_pessoa_fisica%type, cd_operacao_nf_p nota_fiscal.cd_operacao_nf%type, ie_meio_pagamento_p INOUT nota_fiscal.ie_meio_pagamento%type, ds_outro_meio_pagamento_p INOUT nota_fiscal.ds_outro_meio_pagamento%type) FROM PUBLIC;

