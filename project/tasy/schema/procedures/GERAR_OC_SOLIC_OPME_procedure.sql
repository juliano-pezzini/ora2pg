-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_solic_opme ( nr_solic_compra_p bigint, cd_centro_custo_p bigint, cd_local_estoque_p bigint, cd_pessoa_solicitante_p text, cd_estabelecimento_p bigint, cd_fornec_sugerido_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_unidade_medida_compra_w		varchar(30);
cd_conta_contabil_w			varchar(20);
ie_tipo_conta_w				integer	:= 2;
qt_material_w				double precision;
vl_unit_previsto_w				double precision;
cd_material_w				integer;
nr_ordem_compra_w			bigint;
nr_item_oci_w				integer;
nr_item_solic_compra_w			integer;
cd_comprador_consig_w			varchar(10);
cd_local_entrega_consig_w			bigint;
cd_condicao_pagamento_padrao_w		bigint;
cd_moeda_padrao_w			bigint;
ie_frete_w				varchar(15);
qt_dias_entrega_oc_consig_w		integer;
cd_centro_custo_w				bigint;

c01 CURSOR FOR
SELECT	a.cd_material,
	a.qt_material,
	coalesce(a.vl_unit_previsto,0),
	a.cd_unidade_medida_compra,
	a.nr_item_solic_compra
from	solic_compra_item a
where	a.nr_solic_compra = nr_solic_compra_p;


BEGIN
cd_centro_custo_w := cd_centro_custo_p;

select	cd_comprador_consig,
	cd_local_entrega_consig,
	cd_condicao_pagamento_padrao,
	cd_moeda_padrao,
	qt_dias_entrega_oc_consig
into STRICT	cd_comprador_consig_w,
	cd_local_entrega_consig_w,
	cd_condicao_pagamento_padrao_w,
	cd_moeda_padrao_w,
	qt_dias_entrega_oc_consig_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(max(ie_frete),'C')
into STRICT	ie_frete_w
from	pessoa_juridica_estab
where	cd_cgc = cd_fornec_sugerido_p
and	cd_estabelecimento = cd_estabelecimento_p;

if (coalesce(cd_comprador_consig_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266013);
	--'Favor informar o campo Comprador consignado nos parametros de compras. Sera utilizado para gerar a OC de consigando.'
end if;

if (coalesce(cd_local_entrega_consig_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266014);
	--'Favor informar o campo Local entrega consignado nos parametros de compras. Sera utilizado para gerar a OC de consigando.'
end if;

if (coalesce(cd_condicao_pagamento_padrao_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266015);
	--'Favor informar o campo Cond. pagamento nos parametros de compras. Sera utilizado para gerar a OC de consigando.'
end if;

if (coalesce(cd_moeda_padrao_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266016);
	--'Favor informar o campo Moeda nos parametros de compras. Sera utilizado para gerar a OC de consigando.'
end if;


select	nextval('ordem_compra_seq')
into STRICT	nr_ordem_compra_w
;

insert into ordem_compra(
	nr_ordem_compra,
	cd_estabelecimento,
	cd_cgc_fornecedor,
	cd_condicao_pagamento,
	cd_comprador,
	dt_ordem_compra,
	dt_atualizacao,
	nm_usuario,
	cd_moeda,
	ie_situacao,
	dt_inclusao,
	cd_pessoa_solicitante,
	ie_frete,
	vl_frete,
	pr_desconto,
	pr_desc_pgto_antec,
	pr_juros_negociado,
	dt_entrega,
	ie_aviso_chegada,
	cd_pessoa_fisica,
	ie_emite_obs,
	ie_urgente,
	cd_setor_atendimento,
	pr_desc_financeiro,
	vl_desconto,
	ie_somente_pagto,
	ie_tipo_ordem,
	cd_local_entrega)
values (	nr_ordem_compra_w,
	cd_estabelecimento_p,
	cd_fornec_sugerido_p,
	cd_condicao_pagamento_padrao_w,
	cd_comprador_consig_w,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	cd_moeda_padrao_w,
	'A',
	clock_timestamp(),
	cd_pessoa_solicitante_p,
	ie_frete_w,
	0,
	0,
	0,
	0,
	trunc(clock_timestamp() + qt_dias_entrega_oc_consig_w,'dd'),
	'N',
	null,
	'N',
	'N',
	cd_setor_atendimento_p,
	0,
	0,
	'N',
	'H',
	cd_local_entrega_consig_w);
	
open C01;
loop
fetch C01 into	
	cd_material_w,
	qt_material_w,
	vl_unit_previsto_w,
	cd_unidade_medida_compra_w,
	nr_item_solic_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_item_oci),0) + 1
	into STRICT	nr_item_oci_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w;
		
	if (coalesce(cd_conta_contabil_w::text, '') = '') then
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			ie_tipo_conta_w	:= 2;
		else
			ie_tipo_conta_w	:= 3;
		end if;

		SELECT * FROM define_conta_material(	cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, null, null, null, null, null, null, null, cd_local_estoque_p, Null, clock_timestamp(), cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
	end if;

	insert into ordem_compra_item(
		nr_ordem_compra,
		nr_item_oci,
		cd_material,
		cd_unidade_medida_compra,
		vl_unitario_material,
		qt_material,
		qt_original,
		dt_atualizacao,
		nm_usuario,
		ie_situacao,
		cd_pessoa_solicitante,
		pr_descontos,
		cd_local_estoque,
		vl_item_liquido,
		cd_centro_custo,
		cd_conta_contabil,
		pr_desc_financ,
		vl_desconto,
		ie_geracao_solic,
		nr_solic_compra,
		nr_item_solic_compra,
		vl_total_item,
		cd_sequencia_parametro)
	values (	nr_ordem_compra_w,
		nr_item_oci_w,
		cd_material_w,
		cd_unidade_medida_compra_w,
		vl_unit_previsto_w,
		qt_material_w,
		qt_material_w,
		clock_timestamp(),
		nm_usuario_p,
		'A',
		cd_pessoa_solicitante_p,
		0,
		cd_local_estoque_p,
		vl_unit_previsto_w,
		cd_centro_custo_w,
		cd_conta_contabil_w,
		0,
		0,
		'U',		
		nr_solic_compra_p,
		nr_item_solic_compra_w,
		round((qt_material_w * vl_unit_previsto_w)::numeric,4),
		philips_contabil_pck.get_parametro_conta_contabil);

	insert into ordem_compra_item_entrega(
		nr_ordem_compra,
		nr_item_oci,
		dt_prevista_entrega,
		qt_prevista_entrega,
		dt_atualizacao,
		nm_usuario,
		nr_sequencia)
	values (	nr_ordem_compra_w,
		nr_item_oci_w,
		trunc(clock_timestamp() + qt_dias_entrega_oc_consig_w,'dd'),
		qt_material_w,
		clock_timestamp(),
		nm_usuario_p,
		nextval('ordem_compra_item_entrega_seq'));
	
	end;
end loop;
close C01;

CALL Gerar_Ordem_Compra_Venc(nr_ordem_compra_w, nm_usuario_p);


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_solic_opme ( nr_solic_compra_p bigint, cd_centro_custo_p bigint, cd_local_estoque_p bigint, cd_pessoa_solicitante_p text, cd_estabelecimento_p bigint, cd_fornec_sugerido_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

