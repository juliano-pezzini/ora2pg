-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_gerar_gestao_exame_2 ( dt_referencia_p timestamp, qt_meses_p bigint default 3) AS $body$
BEGIN

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then

	delete	FROM eis_gestao_exame_2
	where (coalesce(qt_meses_p::text, '') = '' or dt_prescricao >= add_months(dt_referencia_p, -1 * qt_meses_p));
	
	insert into eis_gestao_exame_2(
			nr_sequencia,
			nr_prescricao,
			dt_prescricao,
			cd_medico,
			dt_liberacao_medico,
			nm_usuario_original,
			nm_usuario,
			dt_emissao_setor_atend,
			dt_liberacao,
			cd_pessoa_fisica,
			dt_prev_execucao,
			nr_seq_laudo,
			dt_liberacao_laudo,
			ie_status_execucao,
			cd_setor_atendimento,
			cd_procedimento,
			ie_origem_proced,
			nm_usuario_laudo,
			nm_usuario_aprovacao,
			nm_usuario_seg_aprov,
			cd_medico_exec,
			cd_medico_executor,
			cd_medico_resp,
			ie_autorizacao,
			ds_observacao,
			nr_seq_proc_interno,
			nr_seq_proced,
			nr_seq_propaci,
			ds_dado_clinico,
			nr_seq_motivo_parada,
			nr_atendimento,
			cd_material_exame,
			nr_prontuario,
			cd_setor_entrega,
			dt_baixa,
			dt_procedimento,
			cd_motivo_baixa,
			nr_seq_interno,
			cd_procedencia,
			nr_seq_agenda,
			ie_lado,
			cd_estabelecimento,
			nm_usuario_exec,
			ie_urgencia,
			ie_tipo_atendimento,
			ie_executar_leito,
			dt_inicio_exame,
			nr_seq_exame,
			cd_tipo_procedimento,
			cd_grupo_proc,
			cd_empresa,
			cd_setor_prescr_proced,
			cd_setor_prescricao,
			cd_proc_exec,
			ie_origem_exec,
			nr_seq_proc_interno_exec,
			nr_seq_tamanho_filme,
			qt_filme,
			cd_pessoa_dia,
			nm_medico,
			ds_status_execucao,
			nm_medico_executor,
			nm_medico_laudo,
			ds_setor_atendimento,
			ds_tipo_atend,
			ds_convenio,
			cd_convenio,
			ds_proced_princ_int,
			ds_tipo_convenio,
			ds_hora_procedimento,
			ds_tipo_procedimento,
			ds_especialidade,
			ds_grupo_proc,
			ds_setor_prescricao,
			ds_proc_exec,
			cd_especialidade,
			ds_procedimento,
			ie_tipo_convenio,
			ds_interv_prescr,
			ds_interv_liber,
			ds_interv_exame,
			cd_hora_procedimento,
			ds_procedimento_cod,
			ds_tamanho_filme)
	SELECT	
			nextval('eis_gestao_exame_2_seq'),
			a.nr_prescricao,
			a.dt_prescricao,
			a.cd_medico,
			a.dt_liberacao_medico,
			a.nm_usuario_original,
			a.nm_usuario,
			b.dt_emissao_setor_atend,
			a.dt_liberacao,
			a.cd_pessoa_fisica,				
			b.dt_prev_execucao,
			d.nr_sequencia,
			d.dt_liberacao,
			b.ie_status_execucao,
			coalesce(b.cd_setor_atendimento, coalesce(a.cd_setor_entrega, a.cd_setor_atendimento)),
			b.cd_procedimento,
			b.ie_origem_proced,
			d.nm_usuario,
			d.nm_usuario_aprovacao,
			d.nm_usuario_seg_aprov,
			b.cd_medico_exec,
			c.cd_medico_executor,
			d.cd_medico_resp,
			b.ie_autorizacao,
			substr(b.ds_observacao,1,255),
			b.nr_seq_proc_interno,
			b.nr_sequencia,
			c.nr_sequencia,
			b.ds_dado_clinico,
			d.nr_seq_motivo_parada,
			a.nr_atendimento,
			b.cd_material_exame,
			g.nr_prontuario,
			a.cd_setor_entrega,
			b.dt_baixa,
			c.dt_procedimento,
			b.cd_motivo_baixa,
			b.nr_seq_interno,
			z.cd_procedencia,
			a.nr_seq_agenda,
			b.ie_lado,
			a.cd_estabelecimento,
			c.nm_usuario_original,
			b.ie_urgencia,
			z.ie_tipo_atendimento,
			coalesce(b.ie_executar_leito,'N'),
			b.dt_inicio_exame,
			b.nr_seq_exame,
			w.cd_tipo_procedimento,
			w.cd_grupo_proc,
			e.cd_empresa,
			b.cd_setor_atendimento,
			a.cd_setor_atendimento,
			c.cd_procedimento,
			c.ie_origem_proced,
			c.nr_seq_proc_interno,
			c.nr_seq_tamanho_filme,
			c.qt_filme,
			a.cd_pessoa_fisica || ' - ' || to_char(a.dt_prescricao,'dd/mm/yyyy'),
			(SELECT nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = a.cd_medico),
			(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio_v where cd_dominio	= 1226 and vl_dominio = b.ie_status_execucao),
			(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = b.cd_medico_exec),
			(select nm_pessoa_fisica from pessoa_fisica where cd_pessoa_fisica = d.cd_medico_resp),
			substr(obter_nome_setor(coalesce(b.cd_setor_atendimento, coalesce(a.cd_setor_entrega, a.cd_setor_atendimento))),1,100),
			(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio_v where cd_dominio	= 12 and vl_dominio	= z.ie_tipo_atendimento),
			(select max(ds_convenio) from convenio where cd_convenio = (select coalesce(max(cd_convenio),0) from atend_categoria_convenio z where z.nr_atendimento = a.nr_atendimento and z.dt_inicio_vigencia = (select max(dt_inicio_vigencia) from atend_categoria_convenio b where b.nr_atendimento = a.nr_atendimento))),
			obter_convenio_atendimento(a.nr_atendimento),
			substr((select max(ds_proc_interno) from procedimento x where x.cd_procedimento	= b.cd_procedimento and	x.ie_origem_proced 	= b.ie_origem_proced),1,200),
			substr(obter_desc_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)),1,100),
			to_char(c.dt_procedimento,'hh24') || ':00',
			(select substr(obter_desc_expressao(cd_exp_valor_dominio, ds_valor_dominio),1,254) from valor_dominio_v where cd_dominio = 95 and vl_dominio = w.cd_tipo_procedimento),
			substr((select max(x.ds_especialidade) from estrutura_procedimento_v x where x.cd_procedimento = b.cd_procedimento and x.ie_origem_proced = b.ie_origem_proced),1,80),
			substr((select max(x.ds_grupo_proc) from estrutura_procedimento_v x where x.cd_procedimento = b.cd_procedimento and x.ie_origem_proced = b.ie_origem_proced),1,80),
			substr((select max(x.ds_setor_atendimento) from	setor_atendimento x where x.cd_setor_atendimento = a.cd_setor_atendimento),1,100),
			substr(obter_desc_prescr_proc(c.cd_procedimento, c.ie_origem_proced, c.nr_seq_proc_interno),1,60),
			substr((select max(x.cd_especialidade) from estrutura_procedimento_v x where x.cd_procedimento = b.cd_procedimento and x.ie_origem_proced = b.ie_origem_proced),1,80),
			substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,60),
			obter_tipo_convenio(obter_convenio_atendimento(a.nr_atendimento)),
			obter_intervalo_minutos(obter_minutos_espera(a.dt_prescricao, a.dt_liberacao)),
			obter_intervalo_minutos(obter_minutos_espera(a.dt_liberacao, b.dt_inicio_exame)),
			obter_intervalo_minutos(obter_minutos_espera(b.dt_inicio_exame, b.dt_baixa)),
			(to_char(c.dt_procedimento,'hh24'))::numeric ,
			substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,60) || ' - ' || b.cd_procedimento,
			substr((select	max(x.ds_tamanho) ds from tamanho_filme_padrao x where	x.nr_sequencia = c.nr_seq_tamanho_filme),1,50)
	FROM procedimento w, pessoa_fisica g, procedimento_paciente c
LEFT OUTER JOIN laudo_paciente d ON (c.nr_laudo = d.nr_sequencia)
LEFT OUTER JOIN conta_paciente f ON (c.nr_interno_conta = f.nr_interno_conta)
, prescr_procedimento b
LEFT OUTER JOIN procedimento_paciente c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_sequencia_prescricao)
, prescr_medica a
LEFT OUTER JOIN atendimento_paciente z ON (a.nr_atendimento = z.nr_atendimento)
LEFT OUTER JOIN estabelecimento e ON (z.cd_estabelecimento = e.cd_estabelecimento)
WHERE w.cd_procedimento = b.cd_procedimento and w.ie_origem_proced = b.ie_origem_proced and a.cd_pessoa_fisica = g.cd_pessoa_fisica  and a.nr_prescricao = b.nr_prescricao      and ((b.cd_motivo_baixa = 0) or (b.ie_status_execucao <> '10')) and coalesce(f.ie_cancelamento::text, '') = '' and b.ie_suspenso <> 'S' and coalesce(a.dt_suspensao::text, '') = '' and (coalesce(qt_meses_p::text, '') = '' or a.dt_prescricao >= add_months(dt_referencia_p, -1 * qt_meses_p));
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_gerar_gestao_exame_2 ( dt_referencia_p timestamp, qt_meses_p bigint default 3) FROM PUBLIC;

