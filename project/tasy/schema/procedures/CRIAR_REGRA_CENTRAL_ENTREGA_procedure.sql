-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE criar_regra_central_entrega (nm_usuario_p text) AS $body$
DECLARE


sequence_w integer;
sequence_status_w integer;
sequence_regra_w integer;
sequence_acao_w integer;
count_w integer;
ie_criar_estagio_w varchar(1);


BEGIN
select count(*)
into STRICT count_w
from Regra_Entrega;

if (count_w = 0 ) then

	--Laudo Liberado
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(718061);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(718061),
									'A');

	end if;

	--Envelope Gerado
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717225);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717225),
									'A');

	end if;

	--Envelope Conferido
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717521);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717521),
									'A');
	end if;

	--Malote gerado
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717228);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717228),
									'A');
	end if;

	--Malote recebido
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717229);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717229),
									'A');
	end if;


	--Saída p/Entrega
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717232);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717232),
									'A');
	end if;

	--Entregue
	select CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
	into STRICT ie_criar_estagio_w
	from estagio_entrega
	where ds_estagio = wheb_mensagem_pck.get_texto(717235);

	if (ie_criar_estagio_w = 'S') then
	   select nextval('estagio_entrega_seq')
	   into STRICT sequence_w
	;

	   insert into Estagio_entrega(Nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									ds_estagio,
									ie_situacao)
							values (sequence_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									wheb_mensagem_pck.get_texto(717235),
									'A');
	end if;

	commit;

	--Insert Tabela Principal
	select nextval('regra_entrega_seq')
	into STRICT sequence_regra_w
	;

	insert into Regra_Entrega(NR_SEQUENCIA,
							   DT_ATUALIZACAO,
							   DT_ATUALIZACAO_NREC,
							   NM_USUARIO,
							   NM_USUARIO_NREC,
							   IE_SITUACAO,
                                                           DT_VIGENCIA_INICIAL)
						values (sequence_regra_w,
								clock_timestamp(),
								clock_timestamp(),
								nm_usuario_p,
								nm_usuario_p,
								'A',
                                                                clock_timestamp());

	--Insert Tabela Status
	select nextval('status_regra_entrega_seq')
	into STRICT sequence_status_w
	;

	insert into Status_Regra_Entrega(NR_SEQUENCIA,
									  DT_ATUALIZACAO,
									  DT_ATUALIZACAO_NREC,
									  NM_USUARIO,
									  NM_USUARIO_NREC,
									  IE_STATUS_EXECUCAO,
									  NR_SEQ_REGRA)
							  values (sequence_status_w,
									  clock_timestamp(),
									  clock_timestamp(),
									  nm_usuario_p,
									  nm_usuario_p,
									  '40',
									  sequence_regra_w);

	--Laudo liberado
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								        values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(718061)),
										sequence_status_w);

	   --Gerar envelope
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
							        	 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 2);

       --Alterar forma Entregue
       select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
							        	 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 12);


	select nextval('status_regra_entrega_seq')
	into STRICT sequence_status_w
	;

	insert into Status_Regra_Entrega(NR_SEQUENCIA,
									  DT_ATUALIZACAO,
									  DT_ATUALIZACAO_NREC,
									  NM_USUARIO,
									  NM_USUARIO_NREC,
									  IE_STATUS_EXECUCAO,
									  NR_SEQ_REGRA)
							  values (sequence_status_w,
									  clock_timestamp(),
									  clock_timestamp(),
									  nm_usuario_p,
									  nm_usuario_p,
									  '45',
									  sequence_regra_w);

	--Envelope Gerado
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717225)),
										sequence_status_w);

	   --Desfazer envelope
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 13);

    --Conferir Envelope
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 3);


	--Envelope Conferido
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717521)),
										sequence_status_w);

	   --Gerar Malote por barras
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 1);

	--malote Gerado
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717228)),
										sequence_status_w);

        --Confirmar recebimento do malote
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 6);

       --Desvincular envelope
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 11);

	--malote recebido
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717229)),
										sequence_status_w);

	   --Registrar saida do malote
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
										 dt_atualizacao,
										 nm_usuario,
										 dt_atualizacao_nrec,
										 nm_usuario_nrec,
										 NR_SEQ_ESTAGIO_STATUS,
										 CD_ACAO_ESTAGIO)
								 values (sequence_acao_w,
										 clock_timestamp(),
										 nm_usuario_p,
										 clock_timestamp(),
										 nm_usuario_p,
										 sequence_w,
										 5);

	--Saída para Entrega
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ESTAGIO,
										NR_SEQ_STATUS)
								values (sequence_w,
										clock_timestamp(),
										nm_usuario_p,
					             					clock_timestamp(),
										nm_usuario_p,
										(SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717232)),
										sequence_status_w);

	   --Registrar entrega
	   select nextval('acao_estagio_entrega_seq')
	   into STRICT sequence_acao_w
	;

	   insert into Acao_Estagio_Entrega(Nr_sequencia,
			                     dt_atualizacao,
					     nm_usuario,
					     dt_atualizacao_nrec,
					     nm_usuario_nrec,
					     NR_SEQ_ESTAGIO_STATUS,
					     CD_ACAO_ESTAGIO)
				     values (sequence_acao_w,
					     clock_timestamp(),
					     nm_usuario_p,
					     clock_timestamp(),
					     nm_usuario_p,
					     sequence_w,
				             8);

	select nextval('status_regra_entrega_seq')
	into STRICT sequence_status_w
	;

	insert into Status_Regra_Entrega(NR_SEQUENCIA,
					  DT_ATUALIZACAO,
					  DT_ATUALIZACAO_NREC,
					  NM_USUARIO,
					  NM_USUARIO_NREC,
					  IE_STATUS_EXECUCAO,
					  NR_SEQ_REGRA)
				  values (sequence_status_w,
					  clock_timestamp(),
				          clock_timestamp(),
					  nm_usuario_p,
					  nm_usuario_p,
					  '60',
					  sequence_regra_w);

	--Entregue
	select nextval('estagio_status_entrega_seq')
	into STRICT sequence_w
	;

	insert into Estagio_Status_entrega(NR_SEQUENCIA,
					    DT_ATUALIZACAO,
					    NM_USUARIO,
					    DT_ATUALIZACAO_NREC,
					    NM_USUARIO_NREC,
					    NR_SEQ_ESTAGIO,
					    NR_SEQ_STATUS)
				    values (sequence_w,
				            clock_timestamp(),
					    nm_usuario_p,
					    clock_timestamp(),
					    nm_usuario_p,
					    (SELECT nr_sequencia from estagio_entrega where ds_estagio = wheb_mensagem_pck.get_texto(717235)),
					    sequence_status_w);

	commit;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_regra_central_entrega (nm_usuario_p text) FROM PUBLIC;

