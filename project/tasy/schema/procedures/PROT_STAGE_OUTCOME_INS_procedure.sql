-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prot_stage_outcome_ins ( nr_seq_outcome_p protocolo_int_etapa_resul.nr_sequencia%type, nr_seq_etapa_out_p protocolo_int_etapa_resul.nr_sequencia%type, nm_usuario_p protocolo_int_etapa_resul.nm_usuario%type, ie_opcao_p text default 'CP') AS $body$
DECLARE


/* IE_OPCAO_P:
'CP' - Clinical Pathway
'PEP' - Electronic Patient Chart (PEP)
*/
ds_avaliacao_w 				protocolo_int_etapa_res_av.ds_avaliacao%type;
nr_ordem_apresentacao_w		protocolo_int_etapa_res_av.nr_ordem_apresentacao%type;
ie_situacao_w				protocolo_int_etapa_res_av.ie_situacao%type;

--------------------------------------- Cursor ---------------------------------------
evaluations CURSOR FOR
	SELECT  ds_avaliacao,
			nr_ordem_apresentacao,
			ie_situacao
	from protocolo_integrado_avalia
	where nr_seq_resultado = nr_seq_outcome_p
	and ie_situacao = 'A';
	
--------------------------------------- Inicio ---------------------------------------
BEGIN
  if (ie_opcao_p = 'CP') then
    delete from protocolo_int_etapa_res_av where nr_seq_resultado = nr_seq_etapa_out_p;

    update protocolo_int_etapa_resul 
    set	nr_seq_prot_int_result = nr_seq_outcome_p
    where nr_sequencia = nr_seq_etapa_out_p;

    open evaluations;
      loop
        fetch evaluations into
                ds_avaliacao_w,
                nr_ordem_apresentacao_w,
                ie_situacao_w;
        EXIT WHEN NOT FOUND; /* apply on evaluations */

        insert into protocolo_int_etapa_res_av(
            ds_avaliacao,
            nr_sequencia,
            nr_seq_resultado,
            nr_ordem_apresentacao,
            ie_situacao,
            nm_usuario,
            nm_usuario_nrec,
            dt_atualizacao,
            dt_atualizacao_nrec
        ) values (
            ds_avaliacao_w,
            nextval('protocolo_int_etapa_res_av_seq'),
            nr_seq_etapa_out_p,
            nr_ordem_apresentacao_w,
            ie_situacao_w,
            nm_usuario_p,
            nm_usuario_p,
            clock_timestamp(),
            clock_timestamp()	
        );

      end loop;
    close evaluations;
	else
    delete from protocolo_int_pac_resul_av where nr_seq_resultado = nr_seq_etapa_out_p;

    update protocolo_int_pac_resul 
    set	nr_seq_prot_int_result = nr_seq_outcome_p
    where nr_sequencia = nr_seq_etapa_out_p;

    open evaluations;
      loop
        fetch evaluations into
                ds_avaliacao_w,
                nr_ordem_apresentacao_w,
                ie_situacao_w;
        EXIT WHEN NOT FOUND; /* apply on evaluations */

        insert into protocolo_int_pac_resul_av(
            ds_avaliacao,
            nr_sequencia,
            nr_seq_resultado,
            nr_ordem_apresentacao,
            ie_situacao,
            ie_avaliacao,
            nm_usuario,
            nm_usuario_nrec,
            dt_atualizacao,
            dt_atualizacao_nrec
        ) values (
            ds_avaliacao_w,
            nextval('protocolo_int_pac_resul_av_seq'),
            nr_seq_etapa_out_p,
            nr_ordem_apresentacao_w,
            ie_situacao_w,
            'NI',
            nm_usuario_p,
            nm_usuario_p,
            clock_timestamp(),
            clock_timestamp()	
        );

      end loop;
    close evaluations;
  end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prot_stage_outcome_ins ( nr_seq_outcome_p protocolo_int_etapa_resul.nr_sequencia%type, nr_seq_etapa_out_p protocolo_int_etapa_resul.nr_sequencia%type, nm_usuario_p protocolo_int_etapa_resul.nm_usuario%type, ie_opcao_p text default 'CP') FROM PUBLIC;

