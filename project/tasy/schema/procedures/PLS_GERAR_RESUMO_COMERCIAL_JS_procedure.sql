-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_resumo_comercial_js ( ie_origem_p text, ie_dimensao_p text, ie_informacao_p text, ie_evolucao_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_dimensao_w	varchar(30);
nr_dimensao_w	smallint;
ie_dimensao_w	varchar(255);
ds_dimensao_w	varchar(255);
vl_dimensao_w	bigint;
ie_informacao_w	varchar(2);
ie_origem_solicitacao_w	varchar(10);

c00 CURSOR FOR 
SELECT	to_char(dt_referencia,'dd/mm/yy'), 
	ie_origem_solicitacao ie_origem_solicitacao 
from	w_pls_resumo_comercial 
where	ie_evolucao_p = 'M' 
group by 
	to_char(dt_referencia,'dd/mm/yy'), 
	to_char(ie_origem_solicitacao) 

union all
 
SELECT	ds_origem, 
	to_char(nr_sequencia) 
from  pls_origem_solicitacao 
where	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p 
and	ie_evolucao_p = 'O';
	
c01 CURSOR FOR 
SELECT	ie_dimensao, 
	ds_dimensao, 
	ie_informacao 
from	w_pls_resumo_comercial 
group by 
	ie_dimensao, 
	ds_dimensao, 
	ie_informacao;


BEGIN 
 
if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (ie_origem_p IS NOT NULL AND ie_origem_p::text <> '') and (ie_dimensao_p IS NOT NULL AND ie_dimensao_p::text <> '') and (ie_informacao_p IS NOT NULL AND ie_informacao_p::text <> '') and (ie_evolucao_p IS NOT NULL AND ie_evolucao_p::text <> '') and (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') then 
	begin 
 
	CALL pls_liberar_sessao_censo(nm_usuario_p);
	 
	CALL pls_gerar_resumo_comercial( 
		ie_origem_p, 
		ie_informacao_p, 
		ie_dimensao_p, 
		ie_evolucao_p, 
		dt_inicial_p, 
		dt_final_p, 
		cd_estabelecimento_p, 
		nm_usuario_p);
		 
	insert into w_pls_censo_geral_2( 
		nr_sequencia, 
		nm_usuario, 
		ie_dimensao, 
		ds_dimensao, 
		vl_dimensao_1, 
		vl_dimensao_2, 
		vl_dimensao_3, 
		vl_dimensao_4, 
		vl_dimensao_5, 
		vl_dimensao_6, 
		vl_dimensao_7, 
		vl_dimensao_8, 
		vl_dimensao_9, 
		vl_dimensao_10, 
		vl_dimensao_11, 
		vl_dimensao_12) 
	values ( 
		nextval('w_pls_censo_geral_2_seq'), 
		nm_usuario_p, 
		-1, 
		-1, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		null);
		 
	nr_dimensao_w := 1;
	 
	open c00;
	loop 
	fetch c00 into 
		dt_dimensao_w, 
		ie_origem_solicitacao_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		begin 
		update	w_pls_censo_geral_2 
		set	vl_dimensao_1 = CASE WHEN nr_dimensao_w=1 THEN  dt_dimensao_w  ELSE vl_dimensao_1 END , 
			vl_dimensao_2 = CASE WHEN nr_dimensao_w=2 THEN  dt_dimensao_w  ELSE vl_dimensao_2 END , 
			vl_dimensao_3 = CASE WHEN nr_dimensao_w=3 THEN  dt_dimensao_w  ELSE vl_dimensao_3 END , 
			vl_dimensao_4 = CASE WHEN nr_dimensao_w=4 THEN  dt_dimensao_w  ELSE vl_dimensao_4 END , 
			vl_dimensao_5 = CASE WHEN nr_dimensao_w=5 THEN  dt_dimensao_w  ELSE vl_dimensao_5 END , 
			vl_dimensao_6 = CASE WHEN nr_dimensao_w=6 THEN  dt_dimensao_w  ELSE vl_dimensao_6 END , 
			vl_dimensao_7 = CASE WHEN nr_dimensao_w=7 THEN  dt_dimensao_w  ELSE vl_dimensao_7 END , 
			vl_dimensao_8 = CASE WHEN nr_dimensao_w=8 THEN  dt_dimensao_w  ELSE vl_dimensao_8 END , 
			vl_dimensao_9 = CASE WHEN nr_dimensao_w=9 THEN  dt_dimensao_w  ELSE vl_dimensao_9 END , 
			vl_dimensao_10 = CASE WHEN nr_dimensao_w=10 THEN  dt_dimensao_w  ELSE vl_dimensao_10 END , 
			vl_dimensao_11 = CASE WHEN nr_dimensao_w=11 THEN  dt_dimensao_w  ELSE vl_dimensao_11 END , 
			vl_dimensao_12 = CASE WHEN nr_dimensao_w=12 THEN  dt_dimensao_w  ELSE vl_dimensao_12 END  
		where	ie_dimensao = '-1';
		 
		nr_dimensao_w := nr_dimensao_w + 1;
		end;
	end loop;
	close c00;
		 
	open c01;
	loop 
	fetch c01 into 	ie_dimensao_w, 
			ds_dimensao_w, 
			ie_informacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin		 
		insert into w_pls_censo_geral_2( 
			nr_sequencia, 
			nm_usuario, 
			ie_dimensao, 
			ds_dimensao, 
			vl_dimensao_1, 
			vl_dimensao_2, 
			vl_dimensao_3, 
			vl_dimensao_4, 
			vl_dimensao_5, 
			vl_dimensao_6, 
			vl_dimensao_7, 
			vl_dimensao_8, 
			vl_dimensao_9, 
			vl_dimensao_10, 
			vl_dimensao_11, 
			vl_dimensao_12) 
		values ( 
			nextval('w_pls_censo_geral_2_seq'), 
			nm_usuario_p, 
			ie_dimensao_w, 
			ds_dimensao_w, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null, 
			null);
			 
		nr_dimensao_w := 1;
		 
		open c00;
		loop 
		fetch c00 into 
			dt_dimensao_w, 
			ie_origem_solicitacao_w;
		EXIT WHEN NOT FOUND; /* apply on c00 */
			begin 
			 
			if (ie_evolucao_p = 'M') then 
			 
				select	count(*) 
				into STRICT	vl_dimensao_w 
				from	w_pls_resumo_comercial 
				where	ie_dimensao = ie_dimensao_w 
				and	dt_referencia = to_date(dt_dimensao_w);
				 
			elsif (ie_evolucao_p = 'O') then 
			 
				select	max(qt_registros) 
				into STRICT	vl_dimensao_w 
				from	w_pls_resumo_comercial 
				where	ie_dimensao = ie_dimensao_w 
				and	ie_origem_solicitacao = ie_origem_solicitacao_w;	
			 
			end if;
			 
			update	w_pls_censo_geral_2 
			set	vl_dimensao_1 = CASE WHEN nr_dimensao_w=1 THEN  vl_dimensao_w  ELSE vl_dimensao_1 END , 
				vl_dimensao_2 = CASE WHEN nr_dimensao_w=2 THEN  vl_dimensao_w  ELSE vl_dimensao_2 END , 
				vl_dimensao_3 = CASE WHEN nr_dimensao_w=3 THEN  vl_dimensao_w  ELSE vl_dimensao_3 END , 
				vl_dimensao_4 = CASE WHEN nr_dimensao_w=4 THEN  vl_dimensao_w  ELSE vl_dimensao_4 END , 
				vl_dimensao_5 = CASE WHEN nr_dimensao_w=5 THEN  vl_dimensao_w  ELSE vl_dimensao_5 END , 
				vl_dimensao_6 = CASE WHEN nr_dimensao_w=6 THEN  vl_dimensao_w  ELSE vl_dimensao_6 END , 
				vl_dimensao_7 = CASE WHEN nr_dimensao_w=7 THEN  vl_dimensao_w  ELSE vl_dimensao_7 END , 
				vl_dimensao_8 = CASE WHEN nr_dimensao_w=8 THEN  vl_dimensao_w  ELSE vl_dimensao_8 END , 
				vl_dimensao_9 = CASE WHEN nr_dimensao_w=9 THEN  vl_dimensao_w  ELSE vl_dimensao_9 END , 
				vl_dimensao_10 = CASE WHEN nr_dimensao_w=10 THEN  vl_dimensao_w  ELSE vl_dimensao_10 END , 
				vl_dimensao_11 = CASE WHEN nr_dimensao_w=11 THEN  vl_dimensao_w  ELSE vl_dimensao_11 END , 
				vl_dimensao_12 = CASE WHEN nr_dimensao_w=12 THEN  vl_dimensao_w  ELSE vl_dimensao_12 END  
			where	ie_dimensao = ie_dimensao_w;
			 
			nr_dimensao_w := nr_dimensao_w + 1;
			 
			end;
		end loop;
		close c00;		
		end;
	end loop;
	close c01;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_resumo_comercial_js ( ie_origem_p text, ie_dimensao_p text, ie_informacao_p text, ie_evolucao_p text, dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

