-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tec_ajustar_base_delphi ( nm_usuario_p text, nr_seq_log_erro_p bigint) AS $body$
DECLARE


qt_registro_w			bigint;
dt_versao_atual_cliente_w 	timestamp;
IE_STATUS_W			varchar(50);


BEGIN

CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w	:= coalesce(to_date(to_char(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

if (dt_versao_atual_cliente_w < to_date('01/07/2015','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	OBJETO_SISTEMA_PARAM a
	where 	not exists (	SELECT	1
				from	OBJETO_SISTEMA b
				where	a.NR_SEQ_OBJETO = b.NR_SEQUENCIA)
				and	(a.NR_SEQ_OBJETO IS NOT NULL AND a.NR_SEQ_OBJETO::text <> '');

	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('jcglopes', 'delete '
				||'from		OBJETO_SISTEMA_PARAM a '
				||'where 	not exists (select	1 '
				||'		from	OBJETO_SISTEMA b '
				||'		where	1 = 1 '
				||'		and		a.NR_SEQ_OBJETO = b.NR_SEQUENCIA) '
				||'and	a.NR_SEQ_OBJETO is not null');

		CALL exec_sql_dinamico('jcglopes', 'alter table OBJETO_SISTEMA_PARAM enable constraint OBSIPAR_OBJSIST_FK');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('01/07/2015','dd/mm/yyyy')) then
	select	count(1)
	into STRICT 	qt_registro_w
	from	user_objects
	where	object_name = 'TEC_AJUSTAR_INCONSIST_DELPHI';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Tasy', 'drop procedure TEC_AJUSTAR_INCONSIST_DELPHI '
);
	end	if;

end	if;


if (dt_versao_atual_cliente_w < to_date('23/07/2015','dd/mm/yyyy')) then

	select	count(1)
	into STRICT 	qt_registro_w
	from	user_objects
	where	object_name = 'TASY_LOG_ALTERACAO_UPDATE';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Tasy', 'drop procedure TASY_LOG_ALTERACAO_UPDATE '
);
	end	if;

end	if;

if (dt_versao_atual_cliente_w < to_date('23/07/2015','dd/mm/yyyy')) then

	select	count(1)
	into STRICT	qt_registro_w
	from	tasy_projeto_assinatura a
	where	not exists (SELECT 1 from relatorio b where a.nr_seq_relatorio = b.nr_sequencia)
	and	(a.nr_seq_relatorio IS NOT NULL AND a.nr_seq_relatorio::text <> '');

	if qt_registro_w > 0 then
		CALL exec_sql_dinamico('htneto', ' update tasy_projeto_assinatura a ' ||
				'    set a.nr_seq_relatorio = null ' ||
				'  where not exists (select 1 from relatorio b where a.nr_seq_relatorio = b.nr_sequencia) ' ||
				'    and a.nr_seq_relatorio is not null');

		CALL exec_sql_dinamico('htneto', 'alter table tasy_projeto_assinatura enable constraint taspras_relator_fk');
	end	if;

end	if;

if (dt_versao_atual_cliente_w < to_date('04/08/2015','dd/mm/yyyy')) then

	select	count(1)
	into STRICT	qt_registro_w
	from	objeto_sistema
	where	nm_objeto = 'OBTER_ATRIBUTO_LOOKUP'
	and	ie_tipo_objeto = 'Procedure';

	if qt_registro_w > 0 then
		CALL exec_sql_dinamico('htneto', ' delete from objeto_sistema ' ||
				'  where nm_objeto = ''OBTER_ATRIBUTO_LOOKUP''' ||
				'    and ie_tipo_objeto = ''Procedure''');
	end	if;

	select	count(1)
	into STRICT	qt_registro_w
	from	user_objects
	where	object_name = 'OBTER_ATRIBUTO_LOOKUP'
	and	object_type = 'PROCEDURE';

	if qt_registro_w > 0 then
		CALL exec_sql_dinamico('htneto', 'DROP PROCEDURE OBTER_ATRIBUTO_LOOKUP'
);
	end	if;

end	if;

if (dt_versao_atual_cliente_w < to_date('02/02/2016','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_registro_w
	from	USER_CONSTRAINTS
	where	table_name = 'OBJETO_SCHEMATIC_PROP'
	and	constraint_name = 'OBJSCHPRO_UK';

	if 	qt_registro_w > 0 then
		CALL exec_sql_dinamico('lhalves', 'alter table OBJETO_SCHEMATIC_PROP drop constraint OBJSCHPRO_UK');
	end if;

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_indexes
	WHERE	index_name = 'OBJSCHPRO_UK';

	if 	qt_registro_w > 0 then
		CALL exec_sql_dinamico('lhalves', 'drop index OBJSCHPRO_UK');
	end if;

	SELECT	COUNT(*)
	INTO STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name = 'OBJSCHPRO_OBJSCHE_FK';

	if (qt_registro_w	> 0) then

		SELECT	COUNT(*)
		INTO STRICT	qt_registro_w
		FROM	user_constraints
		WHERE	constraint_name = 'OBJSCHPRO_OBJSCHE_FK'
		AND	status = 'DISABLED';

		if (qt_registro_w > 0) then

			CALL Exec_Sql_Dinamico('Tasy',' delete from OBJETO_SCHEMATIC_PROP a ' ||
					' where not exists ( select 1 from OBJETO_SCHEMATIC b ' ||
					' where 1 = 1 and a.NR_SEQ_OBJETO = b.NR_SEQUENCIA) ' ||
					' and a.NR_SEQ_OBJETO is not null ');

			CALL Exec_Sql_Dinamico('Tasy','ALTER TABLE OBJETO_SCHEMATIC_PROP ENABLE CONSTRAINT OBJSCHPRO_OBJSCHE_FK');
		end if;
	else
		CALL Exec_Sql_Dinamico('Tasy','Alter Table OBJETO_SCHEMATIC_PROP add (Constraint OBJSCHPRO_OBJSCHE_FK Foreign Key (NR_SEQ_OBJETO) '||
					'References OBJETO_SCHEMATIC (NR_SEQUENCIA) on delete cascade)');
	end if;

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_indexes
	WHERE	index_name = 'OBJSCHPRO_OBJSCHE_FK_I';

	if 	qt_registro_w = 0 then
		CALL Exec_Sql_Dinamico('Tasy','Create Index OBJSCHPRO_OBJSCHE_FK_I on OBJETO_SCHEMATIC_PROP(NR_SEQ_OBJETO)');
	end if;

end if;

if (dt_versao_atual_cliente_w < to_date('03/02/2016','dd/mm/yyyy')) then
	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'DIC_MASCARA'
	and	column_name	= 'NM_IDENTIFICAR';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('Fernando','alter  table  DIC_MASCARA drop column NM_IDENTIFICAR ');
	end	if;
end	if;

if (dt_versao_atual_cliente_w < to_date('23/02/2016','dd/mm/yyyy')) then

	CALL exec_sql_dinamico('vhkrausser',' Delete from INTEGRIDADE_REFERENCIAL ' ||
								   ' where NM_TABELA  = ''DIC_PANEL'' ' ||
								   ' and   NM_INTEGRIDADE_REFERENCIAL = ''DICPANEL_OBJSIST_FK'' ');
	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name = 'DICPANEL_OBJSIST_FK'
	and     table_name = 'DIC_PANEL';

	if (qt_registro_w > 0) then

		CALL Exec_Sql_Dinamico('vhkrausser', 'alter table DIC_PANEL drop constraint  DICPANEL_OBJSIST_FK ');

	end	if;

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name = 'DETNODE_DICEXPR_FK'
	and     table_name = 'DETAIL_NODE';

	if (qt_registro_w > 0) then

		CALL Exec_Sql_Dinamico('vhkrausser', 'alter table DETAIL_NODE drop constraint  DETNODE_DICEXPR_FK ');

	end	if;

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_indexes
	WHERE	index_name = 'DETNODE_DICEXPR_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('vhkrausser', 'drop index DETNODE_DICEXPR_FK_I ');
	end if;

	CALL Exec_sql_dinamico('vhkrausser', ' Create Index DETNODE_DICEXPR_FK_I on DETAIL_NODE(CD_EXP_LABEL) ');


	CALL Exec_Sql_Dinamico('vhkrausser', ' Alter Table DETAIL_NODE add (  ' ||
									'  Constraint DETNODE_DICEXPR_FK Foreign Key ( CD_EXP_LABEL ) ' ||
									'  References DIC_EXPRESSAO (CD_EXPRESSAO))');

	CALL Exec_Sql_Dinamico('vhkrausser', ' Delete from tabela_visao_atributo ' ||
									' where nm_atributo = ''CD_LABEL_EXP'' ' ||
									' and nr_sequencia in (Select nr_sequencia  ' ||
									'						from tabela_visao  ' ||
									' 					   where nm_tabela = ''DETAIL_NODE'' ) ');

	CALL Exec_Sql_Dinamico('vhkrausser', ' Delete from tabela_atributo ' ||
									' where nm_tabela = ''DETAIL_NODE'' ' ||
									' and nm_atributo   = ''CD_LABEL_EXP'' ');
	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'DETAIL_NODE'
	and		column_name	= 'CD_LABEL_EXP';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('vhkrausser', 'alter table DETAIL_NODE drop column CD_LABEL_EXP');
	end if;

end	if;

if (dt_versao_atual_cliente_w < to_date('11/03/2016','dd/mm/yyyy')) then
	update	tabela_visao_Atributo tva
	set		VL_PADRAO =   ( 	SELECT 	ta.VL_DEFAULT
					FROM 	tabela_Atributo ta,
						tabela_visao tv
					WHERE ta.nm_atributo = tva.nm_atributo
						AND  tv.nr_sequencia = tva.nr_sequencia
						AND  ta.nm_tabela = tv.nm_tabela
						AND  (ta.VL_DEFAULT IS NOT NULL AND ta.VL_DEFAULT::text <> '')
						AND  coalesce(vl_padrao::text, '') = ''
						AND  ta.ie_obrigatorio = 'S')
	WHERE 	coalesce(VL_PADRAO, 'XPTOKULJOLK') <> ( 	SELECT 	ta.VL_DEFAULT
							FROM 	tabela_Atributo ta,
								tabela_visao tv
							WHERE ta.nm_atributo = tva.nm_atributo
							AND  tv.nr_sequencia = tva.nr_sequencia
							AND  ta.nm_tabela = tv.nm_tabela
							AND  (ta.VL_DEFAULT IS NOT NULL AND ta.VL_DEFAULT::text <> '')
							AND  coalesce(vl_padrao::text, '') = ''
							AND  ta.ie_obrigatorio = 'S')
	AND   NM_ATRIBUTO =   (	SELECT 	TA.NM_ATRIBUTO
				FROM 	tabela_Atributo ta,
					tabela_visao tv
				WHERE ta.nm_atributo = tva.nm_atributo
				AND  tv.nr_sequencia = tva.nr_sequencia
				AND  ta.nm_tabela = tv.nm_tabela
				AND  (ta.VL_DEFAULT IS NOT NULL AND ta.VL_DEFAULT::text <> '')
				AND  coalesce(vl_padrao::text, '') = '')
	AND   tva.IE_OBRIGATORIO = 'S';

	commit;
end if;

if (dt_versao_atual_cliente_w < to_date('12/04/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tables
	where	table_name = 'PSO_USUARIO_PERMISSAO';

	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('Fernando', 'drop table PSO_USUARIO_PERMISSAO');
	end if;
end	if;

if (dt_versao_atual_cliente_w < to_date('23/05/2016','dd/mm/yyyy')) then

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name = 'OBJSCHPRO_INTERFA_FK'
	and     table_name = 'OBJETO_SCHEMATIC_PROP';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('lhalves', 'Alter Table OBJETO_SCHEMATIC_PROP drop constraint OBJSCHPRO_INTERFA_FK ');
	end	if;

	SELECT	COUNT(*)
	into STRICT	qt_registro_w
	FROM	user_indexes
	WHERE	index_name = 'OBJSCHPRO_INTERFA_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('lhalves', 'drop index OBJSCHPRO_INTERFA_FK_I ');
	end if;

end	if;

if (dt_versao_atual_cliente_w < to_date('19/07/2016','dd/mm/yyyy')) then

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'USUARIO'
	and	column_name	= 'DT_EXPIRAR_CONTA';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'alter table usuario drop column DT_EXPIRAR_CONTA');
	end	if;
end	if;

if (dt_versao_atual_cliente_w < to_date('04/08/2016','dd/mm/yyyy')) then

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tabLES
	where	table_name	= 'VALOR_DOMINIO_BACKUP';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'DROP TABLE VALOR_DOMINIO_BACKUP');
	end	if;
end	if;



if (dt_versao_atual_cliente_w < to_date('21/09/2016','dd/mm/yyyy')) then

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tabLES
	where	table_name	= 'BACKUP_F0P3_FP';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'DROP TABLE BACKUP_F0P3_FP');
	end	if;

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tabLES
	where	table_name	= 'BACKUP_F0P3_FPE';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'DROP TABLE BACKUP_F0P3_FPE');
	end	if;

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tabLES
	where	table_name	= 'BACKUP_F0P3_FPP';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'DROP TABLE BACKUP_F0P3_FPP');
	end	if;

	SELECT	COUNT(1)
	into STRICT	qt_registro_w
	from	user_tabLES
	where	table_name	= 'BACKUP_F0P3_FPU';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'DROP TABLE BACKUP_F0P3_FPU');
	end	if;
end	if;

if (dt_versao_atual_cliente_w < to_date('21/12/2016','dd/mm/yyyy')) then
		CALL exec_sql_dinamico('djrezini', ' UPDATE MED_VALOR_DOMINIO SET IE_SITUACAO = ''A'' WHERE IE_SITUACAO IS NULL; ');
end	if;

if (dt_versao_atual_cliente_w < to_date('25/05/2017','dd/mm/yyyy')) then
	select 	count(1)
	into STRICT	qt_registro_w
	from 	indice
	where 	nm_indice = 'OBJSCHPRO_UK'
	and	nm_tabela = 'OBJETO_SCHEMATIC_PROP';

	if (qt_registro_w = 0) then

		select 	count(1)
		into STRICT	qt_registro_w
		from	user_constraints
		where	table_name = 'OBJETO_SCHEMATIC_PROP'
		and	constraint_name = 'OBJSCHPRO_UK';

		if ( qt_registro_w > 0 ) then
			CALL exec_sql_dinamico('Edgar', 'alter table OBJETO_SCHEMATIC_PROP drop constraint OBJSCHPRO_UK');
		end if;

		select	count(1)
		into STRICT	qt_registro_w
		from	user_indexes
		where	index_name = 'OBJSCHPRO_UK';

		if ( qt_registro_w > 0 ) then
			CALL exec_sql_dinamico('Edgar', 'drop index OBJSCHPRO_UK');
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tec_ajustar_base_delphi ( nm_usuario_p text, nr_seq_log_erro_p bigint) FROM PUBLIC;

