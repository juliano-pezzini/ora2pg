-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_pac_alergico_classe ( cd_pessoa_fisica_p text, cd_material_p bigint, ds_item_p INOUT text, ie_retorno_p INOUT text ) AS $body$
DECLARE


ie_pac_alergia_w		bigint := 0;
cd_classe_mat_w			bigint;
qt_alergia_w			bigint;
cd_classe_material_w		integer;
cont_w				bigint;

C01 CURSOR FOR
	SELECT	obter_dados_material(CD_MATERIAL,'CCLA')
	from	paciente_alergia
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	coalesce(dt_fim::text, '') = ''
	and	(CD_MATERIAL IS NOT NULL AND CD_MATERIAL::text <> '')
	and	coalesce(dt_inativacao::text, '') = ''
	
union all

	SELECT 	obter_dados_material(m.cd_material,'CCLA')
	from	paciente_alergia a,
		medic_ficha_tecnica f,
		material m
	where	a.nr_seq_ficha_tecnica = f.nr_sequencia
	and	f.nr_sequencia = m.nr_seq_ficha_tecnica
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	(a.nr_seq_ficha_tecnica IS NOT NULL AND a.nr_seq_ficha_tecnica::text <> '')
	and	coalesce(f.nr_seq_superior::text, '') = ''
	and	coalesce(a.dt_fim::text, '') = ''	
	and	coalesce(a.cd_material::text, '') = ''
	and	coalesce(a.dt_inativacao::text, '') = ''
	and 	pkg_i18n.get_user_locale() = 'en_AU'
	group by obter_dados_material(m.cd_material,'CCLA')
	
union all

	select 	obter_dados_material(m.cd_material,'CCLA')
	from	paciente_alergia a,
		medic_ficha_tecnica f,
		material m
	where	a.nr_seq_ficha_tecnica = f.nr_seq_superior
	and   	f.nr_sequencia = m.nr_seq_ficha_tecnica
	and   	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	(a.nr_seq_ficha_tecnica IS NOT NULL AND a.nr_seq_ficha_tecnica::text <> '')
	and	coalesce(a.dt_fim::text, '') = ''	
	and	coalesce(a.cd_material::text, '') = ''
	and	coalesce(a.dt_inativacao::text, '') = ''
	and	pkg_i18n.get_user_locale() = 'en_AU'
	group by obter_dados_material(m.cd_material,'CCLA');

C02 CURSOR FOR
	SELECT	CD_CLASSE_MATERIAL
	from	material
	where	cd_material in (SELECT	cd_material_p
				
				
union

				select	b.cd_material_generico
				from	material b
				where	b.cd_material = cd_material_p
				
union

				select	b.cd_material
				from	material b
				where	b.cd_material_generico = cd_material_p);


BEGIN

ie_retorno_p	:= 'N';
ds_item_p	:= '';

select	count(*)
into STRICT	qt_alergia_w
from	paciente_alergia
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and ((CD_MATERIAL IS NOT NULL AND CD_MATERIAL::text <> '') or (pkg_i18n.get_user_locale() = 'en_AU' and (nr_seq_ficha_tecnica IS NOT NULL AND nr_seq_ficha_tecnica::text <> '')))
and	coalesce(dt_fim::text, '') = '';

if (qt_alergia_w > 0) then
	
	open c01;
	loop
	fetch c01 into	
		cd_classe_mat_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	
		if (cd_classe_mat_w > 0) then
			select	cd_classe_material
			into STRICT	cd_classe_material_w
			from	estrutura_material_v
			where	cd_material	= cd_material_p;

			if (cd_classe_material_w = cd_classe_mat_w) then
				ds_item_p	:= substr(Obter_desc_classe_mat(cd_classe_material_w),1,35);
				ie_retorno_p	:= 'S';
				exit;
			end if;
		end if;
		
		open c02;
		loop
		fetch c02 into	
			cd_classe_material_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			if (cd_classe_material_w = cd_classe_mat_w) then
				ds_item_p	:= substr(Obter_desc_classe_mat(cd_classe_material_w),1,35);
				ie_retorno_p	:= 'S';
				exit;
			end if;		
		end loop;
		close c02;

		if (ie_retorno_p = 'S') then
			exit;
		end if;

	end loop;
	close c01;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_pac_alergico_classe ( cd_pessoa_fisica_p text, cd_material_p bigint, ds_item_p INOUT text, ie_retorno_p INOUT text ) FROM PUBLIC;

