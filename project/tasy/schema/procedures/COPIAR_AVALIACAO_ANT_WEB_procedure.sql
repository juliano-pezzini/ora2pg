-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_avaliacao_ant_web ( cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ds_msg_p INOUT text) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nr_atendimento_w	bigint;
nr_seq_avaliacao_w	bigint;
ds_msg_w		varchar(2000) := null;
dt_liberacao_w		timestamp;


BEGIN 
 
select	max(b.nr_sequencia) 
into STRICT	nr_sequencia_w 
from	med_avaliacao_paciente b 
where	b.cd_pessoa_fisica 	= cd_pessoa_fisica_p 
and	b.cd_medico 		= cd_medico_p 
and (b.ie_apresentar_web <> 'N' or (b.nr_seq_checkup IS NOT NULL AND b.nr_seq_checkup::text <> '')) 
and	b.dt_avaliacao = ( 
			SELECT	max(c.dt_avaliacao) 
			from	med_avaliacao_paciente c 
			where	c.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and (c.ie_apresentar_web <> 'N' or (c.nr_seq_checkup IS NOT NULL AND c.nr_seq_checkup::text <> '')) 
			and	c.cd_medico = cd_medico_p);
			 
select 	MAX(dt_liberacao) 
into STRICT	dt_liberacao_w 
from 	med_avaliacao_paciente 
where	nr_sequencia	= nr_sequencia_w;
 
if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')	then 
	begin 
	select	a.nr_sequencia, 
		a.nr_atendimento 
	into STRICT	nr_sequencia_w, 
		nr_atendimento_w 
	from	med_avaliacao_paciente a 
	where	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
	and	a.cd_medico 	= cd_medico_p 
	and (a.ie_apresentar_web <> 'N' or (a.nr_seq_checkup IS NOT NULL AND a.nr_seq_checkup::text <> '')) 
	and   (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
	and	a.nr_sequencia = ( 
			SELECT	max(b.nr_sequencia) 
			from	med_avaliacao_paciente b 
			where	b.cd_pessoa_fisica = cd_pessoa_fisica_p 
			and	b.cd_medico = cd_medico_p 
			and (b.ie_apresentar_web <> 'N' or (b.nr_seq_checkup IS NOT NULL AND b.nr_seq_checkup::text <> '')) 
			and   (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
			and	b.dt_avaliacao = ( 
						SELECT	max(c.dt_avaliacao) 
						from	med_avaliacao_paciente c 
						where	c.cd_pessoa_fisica = cd_pessoa_fisica_p 
						and (c.ie_apresentar_web <> 'N' or (c.nr_seq_checkup IS NOT NULL AND c.nr_seq_checkup::text <> '')) 
						and   (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
						and	c.cd_medico = cd_medico_p));
						 
	ds_msg_w := 'Atualize seus dados do questionário de antecedentes pessoais, este questionário é estritamente confidencial e o envio antecipado é de extrema importância na avaliação de possíveis riscos específicos à saúde, favorecendo uma melhor abordagem pela equipe médica.';
	exception 
		when others then 
		ds_msg_w := null;
	end;
	 
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then 
		begin 
		/* Pegar o próximo número de sequencia para a med_avaliacao_paciente */
 
		select	nextval('med_avaliacao_paciente_seq') 
		into STRICT	nr_seq_avaliacao_w 
		;
 
 
		/* Inservação dos dados na tabela med_avaliacao_paciente */
 
		insert	into med_avaliacao_paciente( 
			nr_sequencia, 
			cd_pessoa_fisica, 
			cd_medico, 
			dt_avaliacao, 
			dt_atualizacao, 
			nm_usuario, 
			ds_observacao, 
			nr_seq_tipo_avaliacao, 
			ie_avaliacao_parcial, 
			nr_atendimento, 
			nr_prescricao, 
			ie_apresentar_web, 
			nr_seq_aval_compl) 
		SELECT	nr_seq_avaliacao_w, 
			cd_pessoa_fisica, 
			cd_medico_p, 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			ds_observacao, 
			nr_seq_tipo_avaliacao, 
			ie_avaliacao_parcial, 
			nr_atendimento_w, 
			null, 
			'S', 
			nr_seq_aval_compl 
		from	med_avaliacao_paciente 
		where	nr_sequencia = nr_sequencia_w;
 
		/* Inserção dos dados na tabela med_avaliacao_result */
 
		insert	into med_avaliacao_result( 
			nr_seq_avaliacao, 
			nr_seq_item, 
			dt_atualizacao, 
			nm_usuario, 
			qt_resultado, 
			ds_resultado) 
		SELECT	nr_seq_avaliacao_w, 
			nr_seq_item, 
			clock_timestamp(), 
			nm_usuario_p, 
			qt_resultado, 
			ds_resultado 
		from	med_avaliacao_result 
		where	nr_seq_avaliacao = nr_sequencia_w;
		end;
	end if;
end if;		
ds_msg_p	:= ds_msg_w;		
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_avaliacao_ant_web ( cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ds_msg_p INOUT text) FROM PUBLIC;

