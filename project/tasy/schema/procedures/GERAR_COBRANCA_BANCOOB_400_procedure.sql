-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_bancoob_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
ds_conteudo_w		varchar(400) := null;
nr_seq_reg_arquivo_w	bigint := 1;
cd_conta_cobr_w		varchar(6);
cd_agencia_cobr_w	varchar(4);
nm_empresa_w		varchar(30);
dt_geracao_w		varchar(6);
ie_digito_conta_cobr_w	varchar(1);
ds_banco_w		varchar(15);

/* detalhe */
 
ie_tipo_inscricao_w	varchar(2);
nr_inscricao_empresa_w	varchar(14);
cd_agencia_bancaria_w	varchar(4);
cd_conta_w		varchar(7);
nr_nosso_numero_w	varchar(7);
vl_multa_w		double precision;
nr_titulo_w		bigint;
dt_vencimento_w		timestamp;
vl_titulo_w		double precision;
dt_emissao_w		timestamp;
vl_juros_w		double precision;
vl_desconto_w		double precision;
nm_pessoa_w		varchar(40);
ds_endereco_w		varchar(40);
ds_bairro_w		varchar(12);
cd_cep_w		varchar(8);
ds_cidade_w		varchar(15);
sg_estado_w		varchar(15);
tx_juros_w		double precision;
tx_multa_w		double precision;
ds_tipo_juros_w		varchar(255);
ds_tipo_multa_w		varchar(255);

qt_titulo_w		bigint;
vl_total_titulo_w	double precision;

c01 CURSOR FOR 
SELECT	CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN '02'  ELSE '01' END  ie_tipo_inscricao, 
	coalesce(c.nr_cpf,b.cd_cgc) nr_inscricao_empresa, 
	lpad(a.cd_agencia_bancaria,4,'0') cd_agencia_bancaria, 
	lpad(a.nr_conta || a.ie_digito_conta,7,'0') cd_conta, 
	lpad(coalesce(CASE WHEN b.ie_tipo_titulo='1' THEN substr(b.nr_nosso_numero,1,7)  ELSE '0' END ,'0'),7,'0') nr_nosso_numero, 
	CASE WHEN coalesce(a.vl_multa,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','M')  ELSE a.vl_multa END , 
	a.nr_titulo, 
	b.dt_pagamento_previsto, 
	b.vl_saldo_titulo, 
	b.dt_emissao, 
	CASE WHEN coalesce(a.vl_juros,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','J')  ELSE a.vl_juros END , 
	a.vl_desconto, 
	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,40) nm_pessoa, 
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'R'),1,40),40,' ') ds_endereco, 
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B'),1,12),12,' ') ds_bairro, 
	lpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'),1,8),8,'0') cd_cep, 
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI'),1,15),15,' ') ds_cidade, 
	rpad(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'),1,2),2,' ') sg_estado, 
	b.tx_juros, 
	b.tx_multa, 
	substr(obter_valor_dominio(707,b.cd_tipo_taxa_juro),1,255) ds_tipo_juros, 
	substr(obter_valor_dominio(707,b.cd_tipo_taxa_multa),1,255) ds_tipo_multa 
FROM titulo_receber_cobr a, titulo_receber b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE a.nr_titulo		= b.nr_titulo and a.nr_seq_cobranca	= nr_seq_cobr_escrit_p;

/* mensagens */
 
cd_banco_w		smallint;
nr_linha_w		bigint;
nr_linha_um_w		bigint;
nr_linha_dois_w		bigint;
nr_linha_tres_w		bigint;
nr_linha_quatro_w	bigint;
nr_linha_cinco_w	bigint;

c02 CURSOR FOR 
SELECT	a.nr_linha 
from	banco_instrucao_boleto a 
where	a.cd_banco	= cd_banco_w 
order	by a.nr_linha;


BEGIN 
 
delete	FROM w_envio_banco 
where	nm_usuario = nm_usuario_p;
 
/* header */
 
select	lpad(coalesce(b.cd_conta,'0'),6,'0'), 
	lpad(coalesce(b.cd_agencia_bancaria,'0'),4,'0'), 
	substr(coalesce(b.ie_digito_conta,'0'),1,1), 
	rpad(substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,30),30,' ') nm_empresa, 
	to_char(clock_timestamp(),'DDMMYY'), 
	b.cd_banco, 
	upper(ds_banco) ds_banco 
into STRICT	cd_conta_cobr_w, 
	cd_agencia_cobr_w, 
	ie_digito_conta_cobr_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	cd_banco_w, 
	ds_banco_w 
from	banco c, 
	banco_estabelecimento b, 
	cobranca_escritural a 
where	b.cd_banco		= c.cd_banco 
and	a.nr_seq_conta_banco	= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'01REMESSA01COBRANCA    0' || 
			cd_agencia_cobr_w || 
			'0' || 
			cd_conta_cobr_w || 
			ie_digito_conta_cobr_w || 
			'    ' || 
			nm_empresa_w || 
			lpad(cd_banco_w,3,'0') || 
			rpad(ds_banco_w,15,' ') || 
			dt_geracao_w || 
			'01600BPI' || 
			rpad(' ',286,' ') || 
			lpad(nr_seq_reg_arquivo_w,6,'0');
 
insert into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nextval('w_envio_banco_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_seq_reg_arquivo_w);
 
open	c02;
loop 
fetch	c02 into 
	nr_linha_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
 
	if (coalesce(nr_linha_um_w::text, '') = '') then 
 
		nr_linha_um_w		:= nr_linha_w;
 
	elsif (coalesce(nr_linha_dois_w::text, '') = '') then 
 
		nr_linha_dois_w		:= nr_linha_w;
 
	elsif (coalesce(nr_linha_tres_w::text, '') = '') then 
 
		nr_linha_tres_w		:= nr_linha_w;
 
	elsif (coalesce(nr_linha_quatro_w::text, '') = '') then 
 
		nr_linha_quatro_w	:= nr_linha_w;
 
	elsif (coalesce(nr_linha_cinco_w::text, '') = '') then 
 
		nr_linha_cinco_w	:= nr_linha_w;
 
	end if;
 
end	loop;
close	c02;
 
/* detalhe */
 
open	C01;
loop 
fetch	C01 into	 
	ie_tipo_inscricao_w, 
	nr_inscricao_empresa_w, 
	cd_agencia_bancaria_w, 
	cd_conta_w, 
	nr_nosso_numero_w, 
	vl_multa_w, 
	nr_titulo_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	dt_emissao_w, 
	vl_juros_w, 
	vl_desconto_w, 
	nm_pessoa_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	cd_cep_w, 
	ds_cidade_w, 
	sg_estado_w, 
	tx_juros_w, 
	tx_multa_w, 
	ds_tipo_juros_w, 
	ds_tipo_multa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	 
	ds_conteudo_w	:=	'1' || 
				ie_tipo_inscricao_w || 
				lpad(nr_inscricao_empresa_w,14,'0') || 
				'0' || 
				cd_agencia_bancaria_w || 
				'0' || 
				cd_conta_w || 
				rpad(' ',32,' ') || 
				'00' || 
				nr_nosso_numero_w || 
				'0000' || 
				lpad(somente_numero(to_char(coalesce(vl_multa_w,0),'99999999990.00')),13,'0') || 
				rpad(' ',7,' ') || 
				lpad('0',9,'0') || 
				'  ' || 
				'5' || 
				'01' || 
				rpad(nr_titulo_w,10,' ') || 
				to_char(dt_vencimento_w,'ddmmyy') || 
				lpad(somente_numero(to_char(coalesce(vl_titulo_w,0),'99999999990.00')),13,'0') || 
				'756' || 
				lpad(cd_agencia_cobr_w,5,'0') || 
				'99' || 
				'A' || 
				to_char(dt_emissao_w,'ddmmyy') || 
				'99' || 
				' ' || 
				'0' || 
				lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'9999999990.00')),12,'0') || 
				'888888' || 
				lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'99999999990.00')),13,'0') || 
				lpad('0',26,'0') || 
				ie_tipo_inscricao_w || 
				lpad(nr_inscricao_empresa_w,14,'0') || 
				rpad(nm_pessoa_w,40,' ') || 
				ds_endereco_w || 
				ds_bairro_w || 
				cd_cep_w || 
				ds_cidade_w || 
				substr(sg_estado_w,1,2) || 
				rpad(nm_empresa_w,40,' ') || 
				'007' || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
				 
	insert	into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
	values (nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
	ds_conteudo_w	:=	'8' || 
				'1' || 
				'0' || 
				cd_agencia_bancaria_w || 
				'0' || 
				cd_conta_w || 
				rpad(nr_titulo_w,10,' ') || 
				rpad(substr(obter_instrucao_boleto(nr_titulo_w,cd_banco_w,nr_linha_um_w),1,69),69,' ') || 
				' ' || 
				rpad(substr(obter_instrucao_boleto(nr_titulo_w,cd_banco_w,nr_linha_dois_w),1,69),69,' ') || 
				' ' || 
				rpad(substr(obter_instrucao_boleto(nr_titulo_w,cd_banco_w,nr_linha_tres_w),1,69),69,' ') || 
				' ' || 
				rpad(substr(obter_instrucao_boleto(nr_titulo_w,cd_banco_w,nr_linha_quatro_w),1,69),69,' ') || 
				' ' || 
				rpad(substr(obter_instrucao_boleto(nr_titulo_w,cd_banco_w,nr_linha_cinco_w),1,69),69,' ') || 
				' ' || 
				rpad(' ',19,' ') || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
 
	insert	into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
	values (nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_reg_arquivo_w);
 
end	loop;
close	C01;
 
/* trailer */
 
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
select	count(*), 
	sum(b.vl_saldo_titulo) 
into STRICT	qt_titulo_w, 
	vl_total_titulo_w 
from	titulo_receber b, 
	titulo_receber_cobr a 
where	a.nr_titulo		= b.nr_titulo 
and	a.nr_seq_cobranca	= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'9' || 
			lpad(qt_titulo_w,6,'0') || 
			lpad(somente_numero(to_char(coalesce(vl_total_titulo_w,0),'99999999990.00')),13,'0') || 
			rpad(' ',374,' ') || 
			lpad(nr_seq_reg_arquivo_w,6,'0');
 
insert	into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nextval('w_envio_banco_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_seq_reg_arquivo_w);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_bancoob_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

