-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_calcular_aprovar_exame ( nr_seq_result_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint ) AS $body$
DECLARE


nr_seq_material_w		bigint;
nr_seq_exame_w			bigint;
qt_resultado_w			double precision;
pr_resultado_w			double precision;
ds_resultado_w			varchar(2000);
ie_status_receb_w		smallint;
ie_status_novo_receb_w		smallint;
ds_consistencia_w		varchar(4000);
ie_aprovar_todos_interf_w	varchar(1);
qt_exames_consist_w		integer;
ie_status_receb_lote_w		smallint;

c02 CURSOR FOR
	SELECT	nr_seq_exame,
		qt_resultado,
		pr_resultado,
		ds_resultado
	from exame_lab_result_item
	where nr_seq_resultado	= nr_seq_result_p
	  and nr_seq_prescr	= nr_seq_prescr_p
	  and ((qt_resultado <> 0) or (pr_resultado <> 0) or (ds_resultado IS NOT NULL AND ds_resultado::text <> ''))
	order by nr_sequencia;



BEGIN

select	max(nr_seq_material)
into STRICT	nr_seq_material_w
from exame_lab_result_item
where nr_seq_resultado	= nr_seq_result_p
  and nr_seq_prescr	= nr_seq_prescr_p
  and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

open c02;
loop
fetch c02 into	nr_seq_exame_w,
		qt_resultado_w,
		pr_resultado_w,
		ds_resultado_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

	ds_resultado_w := calcular_valores_exame(nr_seq_result_p, nr_prescricao_p, nr_seq_prescr_p, nr_seq_material_w, nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);

end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_calcular_aprovar_exame ( nr_seq_result_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint ) FROM PUBLIC;

