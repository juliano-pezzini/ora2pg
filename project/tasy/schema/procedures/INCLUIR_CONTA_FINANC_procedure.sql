-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_conta_financ ( nm_usuario_p text, ie_restringir_estab_p text, cd_estabelecimento_p bigint, dt_referencia_p timestamp, ie_classif_fluxo_p text, cd_empresa_p bigint, ie_periodo_p text) AS $body$
BEGIN
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	if (ie_restringir_estab_p = 'E') then
		begin
		insert into	fluxo_caixa(
			cd_estabelecimento,
			dt_referencia,
			cd_conta_financ,
			ie_classif_fluxo,
			dt_atualizacao,
			nm_usuario,
			vl_fluxo,
			ie_origem,
			ie_periodo,
			ie_integracao,
			cd_empresa)
		SELECT	cd_estabelecimento_p,
			dt_referencia_p,
			a.cd_conta_financ,
			ie_classif_fluxo_p,
			clock_timestamp(),
			nm_usuario_p,
			0,
			'D',
			ie_periodo_p,
			'D',
			cd_empresa
		from	conta_financeira a
		where	a.ie_oper_fluxo <> 'A'
		and	a.cd_empresa = cd_empresa_p
		and	a.cd_estabelecimento = cd_estabelecimento_p
			and	not exists (
				SELECT 1
				from fluxo_caixa b
				where	b.cd_conta_financ = a.cd_conta_financ
				and	b.ie_periodo = ie_periodo_p
				and	b.ie_classif_fluxo = ie_classif_fluxo_p
				and	b.dt_referencia = dt_referencia_p);

		end;
	elsif (ie_restringir_estab_p <> 'E') then
		begin
		insert into	fluxo_caixa(
			cd_estabelecimento,
			dt_referencia,
			cd_conta_financ,
			ie_classif_fluxo,
			dt_atualizacao,
			nm_usuario,
			vl_fluxo,
			ie_origem,
			ie_periodo,
			ie_integracao,
			cd_empresa)
		SELECT	cd_estabelecimento_p,
			dt_referencia_p,
			a.cd_conta_financ,
			ie_classif_fluxo_p,
			clock_timestamp(),
			nm_usuario_p,
			0,
			'D',
			ie_periodo_p,
			'D',
			cd_empresa
		from	conta_financeira a
		where	a.ie_oper_fluxo <> 'A'
		and	a.cd_empresa = cd_empresa_p
		and	not exists (
				SELECT 1
				from fluxo_caixa b
				where	b.cd_conta_financ = a.cd_conta_financ
				and	b.ie_periodo = ie_periodo_p
				and	b.ie_classif_fluxo = ie_classif_fluxo_p
				and	b.dt_referencia = dt_referencia_p);
		end;
	end if;
	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_conta_financ ( nm_usuario_p text, ie_restringir_estab_p text, cd_estabelecimento_p bigint, dt_referencia_p timestamp, ie_classif_fluxo_p text, cd_empresa_p bigint, ie_periodo_p text) FROM PUBLIC;

