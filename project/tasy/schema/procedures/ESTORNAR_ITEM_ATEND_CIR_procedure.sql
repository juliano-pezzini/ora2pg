-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_item_atend_cir ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_sequencia_w				bigint;
nr_atendimento_w			bigint;
ie_fim_conta_w				varchar(1);
dt_fim_conta_w				timestamp;
cd_material_baixa_w			integer;
ie_gerar_integracao_w		varchar(1);
cd_setor_atendimento_w		integer;
cd_estabelecimento_w		smallint;
qt_material_w				double precision;
nr_seq_agenda_pac_opme_w	bigint;
cd_local_estoque_w			bigint;
					

BEGIN 
 
select	coalesce(max(nr_sequencia),0), 
		coalesce(max(nr_atendimento),0), 
		coalesce(max(cd_setor_atendimento),0) 
into STRICT	nr_sequencia_w, 
		nr_atendimento_w, 
		cd_setor_atendimento_w 
from	material_atend_paciente 
where	nr_prescricao = nr_prescricao_p 
and		nr_sequencia_prescricao = nr_sequencia_p;
 
	 
 
if (nr_sequencia_w > 0) then 
 
	if (nr_atendimento_w > 0) then 
		select	ie_fim_conta, 
				dt_fim_conta 
		into STRICT	ie_fim_conta_w, 
				dt_fim_conta_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_w;
		 
		if (ie_fim_conta_w = 'F') and (dt_fim_conta_w IS NOT NULL AND dt_fim_conta_w::text <> '') then 
			-- O atendimento deste paciente já foi fechado, o material não pode ser estornado. #@#@ 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(263598);
		end if;
	end if;
 
	select	cd_material_baixa, 
			cd_local_estoque 
	into STRICT	cd_material_baixa_w, 
			cd_local_estoque_w 
	from	prescr_material 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia = nr_sequencia_p;
	 
	 
	select	coalesce(max(qt_material),0), 
			coalesce(max(nr_seq_agenda_pac_opme),0) 
	into STRICT	qt_material_w, 
			nr_seq_agenda_pac_opme_w 
	from	material_atend_paciente 
	where	nr_sequencia = nr_sequencia_w;
	 
	CALL voltar_item_pendente_prescr(nr_sequencia_w, nm_usuario_p);
	 
	if (cd_setor_atendimento_w > 0) then 
		begin 
 
		select	obter_dados_setor(cd_setor_atendimento_w,'E') 
		into STRICT	cd_estabelecimento_w 
		;
		 
		ie_gerar_integracao_w := obter_param_usuario(900, 383, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_integracao_w);
 
		if (coalesce(ie_gerar_integracao_w,'N') = 'S') then 
 
			update	agenda_pac_opme 
			set		qt_material = qt_material - qt_material_w 
			where	nr_sequencia = nr_seq_agenda_pac_opme_w;
			 
		end if;
		end;
	end if;
	 
	if (cd_material_baixa_w IS NOT NULL AND cd_material_baixa_w::text <> '') then 
		update	prescr_material 
		set		cd_material_baixa  = NULL 
		where	nr_prescricao = nr_prescricao_p 
		and		nr_sequencia = nr_sequencia_p;
		commit;
	end if;
		 
	if (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') then 
		update	prescr_material 
		set	cd_local_estoque  = NULL 
		where	nr_prescricao = nr_prescricao_p 
		and	nr_sequencia = nr_sequencia_p;
		commit;
	end if;
		 
	CALL excluir_glosa_valor_mat(nr_sequencia_w, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_item_atend_cir ( nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

