-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atual_dt_imp_etiqueta_col (nr_prescricao_p text, nm_usuario_p text, lista_nr_seq_prescr_p text default null) AS $body$
DECLARE

ds_param_integration_w varchar(50);
specimen_count   bigint;
bacteria_count   bigint;
cd_estabelecimento_w smallint := wheb_usuario_pck.get_cd_estabelecimento;
ie_transmit_special_order varchar(1);
ie_retrogrado_w cpoe_procedimento.ie_retrogrado%type;
nr_prescricao_w prescr_procedimento.nr_prescricao%type;
nr_seq_interno_ww   prescr_procedimento.nr_seq_interno%type;
cd_pessoa_fisica_w  varchar(10);
nr_atendimento_w    bigint;
ds_guampa_w varchar(10)  := chr(39);
ie_integ_exist_w varchar(1) := null;
lista_nr_seq_prescr_w varchar(4000);
nr_seq_prescr_cpoe_w  prescr_procedimento.nr_seq_proc_cpoe%type;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	update 	prescr_medica
	set		dt_imp_etiq_col = clock_timestamp(),
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p	
	where 	nr_prescricao = nr_prescricao_p;
	
end if;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (lista_nr_seq_prescr_p IS NOT NULL AND lista_nr_seq_prescr_p::text <> '') then

   begin
   CALL lab_atual_dt_imp_etiq_col_proc(nr_prescricao_p,lista_nr_seq_prescr_p,nm_usuario_p);
   exception
   when others then
		null;
   end;

end if;
commit;


if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then

select count(case b.nr_seq_sub_grp  when 'B' then 1 end),
       count(case b.nr_seq_sub_grp  when 'L' then 1 end)
        into STRICT bacteria_count,
        specimen_count
        from cpoe_procedimento c, 
             prescr_procedimento p ,
             cpoe_order_unit a,
             cpoe_tipo_pedido b,						
             prescr_medica m,
             exame_laboratorio e,
             proc_interno pi,
             bft_encounter_v v
        where   c.nr_sequencia			= p.nr_seq_proc_cpoe 
                and p.nr_prescricao		= m.nr_prescricao
                and m.nr_prescricao     = p.nr_prescricao
                and p.nr_seq_exame 		= e.nr_seq_exame
				and p.nr_prescricao 	= nr_prescricao_p
                and a.nr_seq_cpoe_tipo_pedido   = b.nr_sequencia
                and a.nr_sequencia              = c.nr_seq_cpoe_order_unit
                and coalesce(e.ie_controla_pendente,'S') = 'S' 
                and c.nr_atendimento =  v.encounter_id
                and obter_conversao_externa_int(null,'PROC_INTERNO_CLASSIF','NR_SEQUENCIA', pi.nr_seq_classif, 'NAIS' ) in ( 'E8','E0')
				and ((b.nr_seq_sub_grp ='L' and get_patient_type(v.encounter_id, NULL) ='OP') or b.nr_seq_sub_grp ='B' )
                and pi.nr_sequencia	= c.nr_seq_proc_interno
				and coalesce(p.dt_integracao::text, '') = ''
				;


   if bacteria_count > 0 then
		ds_param_integration_w :=  '{"recordId" : "' || nr_prescricao_p|| '"' || '}';
        CALL execute_bifrost_integration(275,ds_param_integration_w);
	end if;

	if specimen_count > 0 then
		ds_param_integration_w :=  '{"recordId" : "' || nr_prescricao_p|| '"' || '}';
		CALL execute_bifrost_integration(276,ds_param_integration_w);
	end if;

    if position(',' in lista_nr_seq_prescr_p ) > 0 then
        ie_integ_exist_w := '0';
        lista_nr_seq_prescr_w := null;
    else
        ie_integ_exist_w := null;
        lista_nr_seq_prescr_w := lista_nr_seq_prescr_p;
    end if;

    select  is_special_order_rule('BA','D',cd_estabelecimento_w) into STRICT ie_transmit_special_order;
    CALL generate_itech_lab_external_id(nr_prescricao_p, nm_usuario_p, cd_estabelecimento_w);
    select  cd_pessoa_fisica,
            nr_atendimento
    into STRICT    cd_pessoa_fisica_w,
            nr_atendimento_w
    from    prescr_medica w
    where   nr_prescricao = nr_prescricao_p;

    select  min(nr_seq_interno)
    into STRICT    nr_seq_interno_ww
    from    prescr_procedimento
    where   nr_prescricao = nr_prescricao_p;

    select  nr_seq_proc_cpoe
    into STRICT    nr_seq_prescr_cpoe_w
    from    prescr_procedimento 
    where   nr_prescricao = nr_prescricao_p
    and     nr_seq_interno = nr_seq_interno_ww;

    select  coalesce(ie_retrogrado,'N')
    into STRICT    ie_retrogrado_w
    from    cpoe_procedimento
    where   nr_sequencia = nr_seq_prescr_cpoe_w;

    if (ie_retrogrado_w = 'N' or (ie_retrogrado_w = 'S' and ie_transmit_special_order = 'S')) then
      CALL call_interface_file(940, 'itech_pck.sample_order_info('||ds_guampa_w|| '1' || ds_guampa_w || ',' ||ds_guampa_w|| cd_pessoa_fisica_w ||ds_guampa_w||','||ds_guampa_w|| nr_atendimento_w ||ds_guampa_w||','|| ds_guampa_w || nr_prescricao_p  || ds_guampa_w ||','|| ds_guampa_w || nr_seq_interno_ww || ds_guampa_w ||','|| ds_guampa_w || null || ds_guampa_w ||','|| ds_guampa_w || 0 || ds_guampa_w ||','|| ds_guampa_w || nm_usuario_p || ds_guampa_w || ');', nm_usuario_p);
    end if;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atual_dt_imp_etiqueta_col (nr_prescricao_p text, nm_usuario_p text, lista_nr_seq_prescr_p text default null) FROM PUBLIC;

