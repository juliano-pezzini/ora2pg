-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_pf_lote_inclusao ( nr_seq_lote_inclusao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_beneficiario_w		bigint;
qt_pessoa_fisica_cpf_w		bigint	:= 0;
nr_cpf_w			varchar(255);
cd_pessoa_fisica_w		varchar(255);
ie_permite_cpf_duplicado_w	varchar(1);
ie_cpf_duplicado_w 		varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_cpf,
		cd_pessoa_fisica
	from	pls_inclusao_beneficiario
	where	nr_seq_lote_inclusao = nr_seq_lote_inclusao_p
	EXCEPT
	SELECT	distinct(a.nr_sequencia),
		nr_cpf,
		a.cd_pessoa_fisica
	from	pls_inclusao_beneficiario	a,
		pls_homonimo_pessoa_fisica	b
	where	b.nr_seq_inclusao_benef	= a.nr_sequencia
	and	a.nr_seq_lote_inclusao	= nr_seq_lote_inclusao_p;


BEGIN

ie_permite_cpf_duplicado_w := obter_valor_param_usuario(1232,90,Obter_Perfil_Ativo,nm_usuario_p,cd_estabelecimento_p);

open C01;
loop
fetch C01 into
	nr_seq_beneficiario_w,
	nr_cpf_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_cpf_duplicado_w	:= 'N';
	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		if	(ie_permite_cpf_duplicado_w = 'N' AND nr_cpf_w <> '') then
			ie_cpf_duplicado_w := obter_duplic_CPF('a', nr_cpf_w);
		end if;
		if (ie_cpf_duplicado_w  = 'N') then
			CALL pls_inclusao_benef_gerar_pf(nr_seq_beneficiario_w,nm_usuario_p);
		end if;
	end if;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pf_lote_inclusao ( nr_seq_lote_inclusao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

