-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tabela_xml_sline (nr_prescricao_p bigint, cd_medico_p bigint, sl_tipo_p text, sl_titulo_p text, sl_sn_p text, sl_chave_p text, sl_senha_p text, sl_cod_doc_p text, sl_formato_p text, sl_chave_adicional_p text, sl_data_realizacao_p text, sl_sms_p text, sl_oper_p text, sl_texto_p text, nm_usuario_p text) AS $body$
DECLARE


qt_registros_w	bigint;

BEGIN

select 	count(*)
into STRICT	qt_registros_w
from	sline_xml_laudo
where	nr_prescricao = nr_prescricao_p
and	cd_medico = cd_medico_p;

if (qt_registros_w > 0) then
	delete
	from	sline_xml_laudo
	where	cd_medico = cd_medico_p
	and	nr_prescricao = nr_prescricao_p;
end if;

insert
into sline_xml_laudo(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	sl_tipo,
	sl_titulo,
	sl_sn,
	sl_chave,
	sl_senha,
	sl_cod_doc,
	sl_formato,
	sl_chave_adicional,
	sl_data_realizacao,
	sl_sms,
	sl_oper,
	nr_prescricao,
	cd_medico,
	sl_texto)
values (nextval('sline_xml_laudo_seq'),
	 clock_timestamp(),
	 nm_usuario_p,
	 clock_timestamp(),
	 nm_usuario_p,
	 sl_tipo_p,
	 substr(sl_titulo_p,1,70),
	 sl_sn_p,
	 sl_chave_p,
	 sl_senha_p,
	 sl_cod_doc_p,
	 sl_formato_p,
	 sl_chave_adicional_p,
	 to_date(CASE WHEN sl_data_realizacao_p='' THEN null  ELSE sl_data_realizacao_p END ,'dd/mm/yyyy hh24:mi:ss'),
	 sl_sms_p,
	 sl_oper_p,
	 nr_prescricao_p,
	 cd_medico_p,
	 sl_texto_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tabela_xml_sline (nr_prescricao_p bigint, cd_medico_p bigint, sl_tipo_p text, sl_titulo_p text, sl_sn_p text, sl_chave_p text, sl_senha_p text, sl_cod_doc_p text, sl_formato_p text, sl_chave_adicional_p text, sl_data_realizacao_p text, sl_sms_p text, sl_oper_p text, sl_texto_p text, nm_usuario_p text) FROM PUBLIC;

