-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_auto_schedule (WEEK_P bigint, TIME_P text) AS $body$
DECLARE

NR_SEQ_SUITE_W	bigint;
NR_SEQ_PRESET_W bigint;
DS_TIME_W1 varchar(5);
DS_TIME_W2 varchar(5);
QTD_W bigint;

--loop suites that was scheduled 
C01 CURSOR FOR
  SELECT autosch.NR_SEQ_SUITE NR_SEQ_SUITE, substr(autosch.DS_TIME,0,4) DS_TIME1, substr(autosch.DS_TIME,6,10) DS_TIME2, autosch.NR_SEQ_PRESET NR_SEQ_PRESET
      INTO STRICT NR_SEQ_SUITE_W, DS_TIME_W1, DS_TIME_W2, NR_SEQ_PRESET_W
  FROM SCHEM_TEST_AUTO_SCHEDULE autosch WHERE autosch.IE_SWITCH = '1' AND (CASE '2'
                                                                                  WHEN '1' THEN  autosch.IE_DOM
                                                                                  WHEN '2' THEN  autosch.IE_SEG
                                                                                  WHEN '3' THEN  autosch.IE_TER
                                                                                  WHEN '4' THEN  autosch.IE_QUA
                                                                                  WHEN '5' THEN  autosch.IE_QUI
                                                                                  WHEN '6' THEN  autosch.IE_SEX
                                                                                  WHEN '7' THEN  autosch.IE_SAB

                                                                              END) = '1';

BEGIN
	--procedure that create schedule by suite
	IF (WEEK_P IS NOT NULL AND WEEK_P::text <> '') THEN
      OPEN C01;
      LOOP
        FETCH C01 INTO	
          NR_SEQ_SUITE_W,
          DS_TIME_W1, 
          DS_TIME_W2, 
          NR_SEQ_PRESET_W;
      EXIT WHEN NOT FOUND; /* apply on C01 */
      BEGIN	

		SELECT COUNT(NR_SEQUENCIA) QTD 
          INTO STRICT QTD_W
		FROM SCHEM_TEST_SCHEDULE schedule
			WHERE schedule.NR_SEQ_SUITE = NR_SEQ_SUITE_W AND schedule.IE_STATUS not in ('3','4','5')
			AND schedule.IE_JOBS not in ('1', '2','666');

      
		IF ((TIME_P = DS_TIME_W1) OR (TIME_P = DS_TIME_W2)) THEN
          IF (QTD_W = 0) THEN
              IF ((DS_TIME_W1 IS NOT NULL AND DS_TIME_W1::text <> '') OR (DS_TIME_W2 IS NOT NULL AND DS_TIME_W2::text <> '')) THEN                
                  IF (NR_SEQ_PRESET_W IS NOT NULL AND NR_SEQ_PRESET_W::text <> '') THEN
                      UPDATE SCHEM_TEST_SUITE SET NR_SEQ_PRESET = NR_SEQ_PRESET_W, IE_JOBS = '3' WHERE NR_SEQUENCIA = NR_SEQ_SUITE_W AND NR_SEQ_PRESET <> NR_SEQ_PRESET_W;
                      COMMIT;
                      CALL SCHEMATIC4TEST_CONFTSTSUITPRES();
                END IF;
              END IF;

              CALL SCHEMATIC4TEST_SENDTOSCHEDULE(NR_SEQ_SUITE_W,'0');
          END IF;
      END IF;
      END;
      END LOOP;
      CLOSE C01;
    END IF;
      EXCEPTION
      WHEN no_data_found THEN
        RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_auto_schedule (WEEK_P bigint, TIME_P text) FROM PUBLIC;

