-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE log_access_pacs ( nm_usuario_p log_acesso_pacs.nm_usuario%TYPE, nr_seq_laudo_p laudo_paciente.nr_sequencia%TYPE ) AS $body$
DECLARE


    nr_prescricao_w         laudo_paciente.nr_prescricao%TYPE;
    nr_seq_prescricao_w     laudo_paciente.nr_seq_prescricao%TYPE;
    nr_seq_proc_interno_w   log_acesso_pacs.nr_seq_proc_interno%TYPE;
    nr_sequencia_w          log_acesso_pacs.nr_sequencia%TYPE;
    nr_acesso_dicom_w       prescr_procedimento.nr_acesso_dicom%TYPE;

BEGIN
    SELECT
        MAX(nr_prescricao),
        MAX(nr_seq_prescricao)
    INTO STRICT
        nr_prescricao_w,
        nr_seq_prescricao_w
    FROM
        laudo_paciente
    WHERE
        nr_sequencia = nr_seq_laudo_p;

    IF (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') THEN
        SELECT
            nextval('log_acesso_pacs_seq')
        INTO STRICT nr_sequencia_w
;

        SELECT
            nr_seq_proc_interno,
            nr_acesso_dicom
        INTO STRICT
            nr_seq_proc_interno_w,
            nr_acesso_dicom_w
        FROM
            prescr_procedimento
        WHERE
            nr_prescricao = nr_prescricao_w
            AND nr_sequencia = nr_seq_prescricao_w;

        INSERT INTO log_acesso_pacs(
            nr_sequencia,
            dt_acesso,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_seq_proc_interno,
            nr_acesso_dicom,
            nm_usuario_acesso
        ) VALUES (
            nr_sequencia_w,
            clock_timestamp(),
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_proc_interno_w,
            nr_acesso_dicom_w,
            nm_usuario_p
        );

        COMMIT;
    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE log_access_pacs ( nm_usuario_p log_acesso_pacs.nm_usuario%TYPE, nr_seq_laudo_p laudo_paciente.nr_sequencia%TYPE ) FROM PUBLIC;

