-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_gqa_pendencia_regra ( NR_SEQ_PLANO_P protocolo_integrado_evento.NR_SEQ_PLANO%TYPE, NR_SEQ_EVENTO_P protocolo_integrado_evento.NR_SEQUENCIA%TYPE, NR_SEQ_PROT_INT_P protocolo_integrado.NR_SEQUENCIA%TYPE ) AS $body$
DECLARE

    QT_SHARED_RULES_W bigint := 0;
    QT_PROT_PACIENTE_W bigint := 0;

BEGIN

    SELECT
        COUNT(1)
    INTO STRICT QT_PROT_PACIENTE_W
    FROM protocolo_int_paciente a
    WHERE
        a.nr_sequencia_protocolo = NR_SEQ_PROT_INT_P;

    IF (QT_PROT_PACIENTE_W = 0) THEN
    
        SELECT 
            COUNT(1) 
        INTO STRICT QT_SHARED_RULES_W
        FROM PROTOCOLO_INTEGRADO_EVENTO a
        INNER JOIN PROTOCOLO_INTEGRADO_ETAPA b ON
            a.nr_seq_etapa = b.NR_SEQUENCIA
        WHERE 
            a.nr_seq_plano = NR_SEQ_PLANO_P AND
            a.nr_sequencia <> NR_SEQ_EVENTO_P;

        IF (QT_SHARED_RULES_W = 0 and (NR_SEQ_PLANO_P IS NOT NULL AND NR_SEQ_PLANO_P::text <> '')) then
    
            UPDATE GQA_PENDENCIA_REGRA
            SET ie_situacao = 'I'
            WHERE 
                nr_sequencia = NR_SEQ_PLANO_P AND 
                ie_situacao = 'A';

            COMMIT;
        END IF;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_gqa_pendencia_regra ( NR_SEQ_PLANO_P protocolo_integrado_evento.NR_SEQ_PLANO%TYPE, NR_SEQ_EVENTO_P protocolo_integrado_evento.NR_SEQUENCIA%TYPE, NR_SEQ_PROT_INT_P protocolo_integrado.NR_SEQUENCIA%TYPE ) FROM PUBLIC;

