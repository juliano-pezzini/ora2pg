-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_alteracao_peso_log_insert ( nm_usuario_p HD_ALTERACAO_PESO_LOG.NM_USUARIO%type, qt_peso_atual_novo_p HD_ALTERACAO_PESO_LOG.QT_PESO_ATUAL_NOVO%type, qt_peso_atual_p HD_ALTERACAO_PESO_LOG.QT_PESO_ATUAL%type, cd_pessoa_fisica_p HD_ALTERACAO_PESO_LOG.CD_PESSOA_FISICA%type ) AS $body$
DECLARE


dt_atual_s			CONSTANT HD_ALTERACAO_PESO_LOG.DT_ALTERACAO%type := clock_timestamp();

nr_prescricao_w 		HD_ALTERACAO_PESO_LOG.NR_PRESCRICAO%type;
qt_ultrafiltracao_total_w 	HD_PRESCRICAO.QT_ULTRAFILTRACAO_TOTAL%type;
qt_ultrafiltracao_w 		HD_PRESCRICAO.QT_ULTRAFILTRACAO%type;
qt_peso_atual_w 		HD_PRESCRICAO.QT_PESO_ATUAL%type;
qt_peso_ideal_w 		HD_PRESCRICAO.QT_PESO_IDEAL%type;
ie_prescricao_vigente_w 	HD_PRESCRICAO.NR_SEQUENCIA%type;


BEGIN
nr_prescricao_w := HD_OBTER_ULTIMA_PRESCR(cd_pessoa_fisica_p, OBTER_ESTABELECIMENTO_ATIVO);

IF (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') THEN
	SELECT 	MAX(a.NR_SEQUENCIA),
		coalesce(MAX(a.QT_PESO_ATUAL), 0),
	        coalesce(MAX(a.QT_PESO_IDEAL), 0),
	        coalesce(MAX(a.QT_ULTRAFILTRACAO), 0),
	        coalesce(MAX(a.QT_ULTRAFILTRACAO_TOTAL), 0)
	INTO STRICT 	ie_prescricao_vigente_w,
		qt_peso_atual_w,
		qt_peso_ideal_w,
		qt_ultrafiltracao_w,
		qt_ultrafiltracao_total_w
	FROM	HD_PRESCRICAO a,
		CPOE_DIALISE b
	WHERE	a.NR_SEQ_DIALISE_CPOE = b.NR_SEQUENCIA
	AND	coalesce(b.DT_SUSPENSAO::text, '') = ''
	AND 	a.NR_PRESCRICAO = nr_prescricao_w
	ORDER BY a.NR_SEQUENCIA DESC;
END IF;

INSERT INTO HD_ALTERACAO_PESO_LOG(
	NR_SEQUENCIA,
	DT_ATUALIZACAO,
	NM_USUARIO,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC,
	DT_ALTERACAO,
	NM_USUARIO_ALTERACAO,
	QT_PESO_ATUAL,
	QT_PESO_ATUAL_NOVO,
	QT_PESO_IDEAL,
	QT_ULTRAFILTRACAO,
	QT_ULTRAFILTRACAO_TOTAL,
	NR_PRESCRICAO,
	CD_PESSOA_FISICA
) VALUES (
	nextval('hd_alteracao_peso_log_seq'),
	dt_atual_s,
	nm_usuario_p,
	dt_atual_s,
	nm_usuario_p,
	dt_atual_s,
	nm_usuario_p,
	coalesce(qt_peso_atual_p, qt_peso_atual_w),
	qt_peso_atual_novo_p,
	qt_peso_ideal_w,
	qt_ultrafiltracao_w,
	qt_ultrafiltracao_total_w,
	(CASE WHEN coalesce(ie_prescricao_vigente_w::text, '') = '' THEN NULL ELSE nr_prescricao_w END),
	cd_pessoa_fisica_p
);

COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_alteracao_peso_log_insert ( nm_usuario_p HD_ALTERACAO_PESO_LOG.NM_USUARIO%type, qt_peso_atual_novo_p HD_ALTERACAO_PESO_LOG.QT_PESO_ATUAL_NOVO%type, qt_peso_atual_p HD_ALTERACAO_PESO_LOG.QT_PESO_ATUAL%type, cd_pessoa_fisica_p HD_ALTERACAO_PESO_LOG.CD_PESSOA_FISICA%type ) FROM PUBLIC;

