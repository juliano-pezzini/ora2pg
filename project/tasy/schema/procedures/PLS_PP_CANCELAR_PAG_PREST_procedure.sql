-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_pp_cancelar_pag_prest ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pp_prestador_p pls_pp_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_pp_prest_est_w	pls_pp_prestador.nr_sequencia%type;


BEGIN

-- faz o carregamento de parâmetros gerais e armazena em variáveis globais da package pls_pp_lote_pagamento_pck
CALL pls_pp_lote_pagamento_pck.carrega_parametros(nr_seq_lote_p, cd_estabelecimento_p);

-- verifica se pode cancelar os registros
CALL pls_pp_canc_pgto_prest_pck.valida_canc_pgto_prestador(nr_seq_lote_p, nr_seq_pp_prestador_p);

-- começa cancelando os títulos do lote
CALL pls_pp_canc_pgto_prest_pck.cancelar_titulo_pgto_prest(nr_seq_pp_prestador_p, nm_usuario_p);

-- cancela os títulos a pagar gerados para terceiros no lote
CALL pls_pp_canc_pgto_prest_pck.cancelar_tit_pagar_terceiro(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- inicio dos estornos dos registros
-- pls_pp_prestador retorna na variável a sequencia do registro que foi inserido
nr_seq_pp_prest_est_w := pls_pp_canc_pgto_prest_pck.estornar_pagamento_prest(nr_seq_pp_prestador_p, nm_usuario_p, nr_seq_pp_prest_est_w);

-- evento valor e a tabela n para n
CALL pls_pp_canc_pgto_prest_pck.estornar_prest_evento_valor(nr_seq_lote_p, nr_seq_pp_prestador_p, nr_seq_pp_prest_est_w, nm_usuario_p);

-- pls_pp_item_lote
CALL pls_pp_canc_pgto_prest_pck.estornar_item_lote_prest(nr_seq_lote_p, nr_seq_pp_prest_est_w, nm_usuario_p);

-- estorno dos tributos pagos base atual
CALL pls_pp_canc_pgto_prest_pck.estornar_tributos_pgto_prest(nr_seq_lote_p, nr_seq_pp_prest_est_w, nm_usuario_p);

-- pls_pp_valor_trib_pessoa
CALL pls_pp_canc_pgto_prest_pck.estornar_trib_pessoa_pgto(nr_seq_lote_p, nr_seq_pp_prest_est_w, nm_usuario_p);
-- fim dos estornos dentro do lote de pagamento
-- aqui desfaz os itens, realiza estorno na produção médica, cria registros novos, desfaz os registros de recurso de glosa
-- produção médica
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_1(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- adiantamento pago
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_3(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- títulos a receber
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_4(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- títulos a pagar
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_5(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- Apropriação
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_6(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

-- recurso de glosa
CALL pls_pp_canc_pgto_prest_pck.cancelar_ie_tipo_item_8(nr_seq_lote_p, nr_seq_pp_prestador_p, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_cancelar_pag_prest ( nr_seq_lote_p pls_pp_lote.nr_sequencia%type, nr_seq_pp_prestador_p pls_pp_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

