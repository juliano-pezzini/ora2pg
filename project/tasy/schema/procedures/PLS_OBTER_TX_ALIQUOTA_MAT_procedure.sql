-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_tx_aliquota_mat ( nr_seq_material_p pls_material.nr_sequencia%type, dt_referencia_p timestamp, tx_positiva_p INOUT pls_regra_aliquota.tx_positiva%type, tx_negativa_p INOUT pls_regra_aliquota.tx_negativa%type, tx_neutra_p INOUT pls_regra_aliquota.tx_neutra%type) AS $body$
DECLARE


tx_negativa_w			pls_regra_aliquota.tx_negativa%type;
tx_neutra_w			pls_regra_aliquota.tx_neutra%type;
tx_positiva_w			pls_regra_aliquota.tx_positiva%type;

C01 CURSOR(	nr_seq_material_p	pls_regra_aliquota.nr_seq_material%type,
			dt_referencia_p		timestamp)FOR
-- Foi invertido o order by e adicionado o rownum <= 1 para pegar a regra correta em apenas uma linha
SELECT	tx_negativa,
	tx_neutra,
	tx_positiva
from	(
		SELECT	a.tx_negativa,
			a.tx_neutra,
			a.tx_positiva,
			a.nr_seq_material,
			a.dt_inicio_vigencia
		from	pls_regra_aliquota a
		where	((a.nr_seq_material = nr_seq_material_p) or (coalesce(a.nr_seq_material::text, '') = ''))
		and	((dt_referencia_p >= a.dt_inicio_vigencia) and
			((dt_referencia_p <= a.dt_fim_vigencia) or coalesce(a.dt_fim_vigencia::text, '') = ''))
		and	ie_situacao	= 'A'
		order by a.nr_seq_material desc,
			 a.dt_inicio_vigencia desc) alias10 LIMIT 1;
BEGIN

for	r_C01_w in C01(nr_seq_material_p,trunc(dt_referencia_p)) loop

	tx_positiva_w := r_C01_w.tx_positiva;
	tx_negativa_w := r_C01_w.tx_negativa;
	tx_neutra_w := r_C01_w.tx_neutra;
end loop;

tx_negativa_p	:= tx_negativa_w;
tx_neutra_p	:= tx_neutra_w;
tx_positiva_p	:= tx_positiva_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_tx_aliquota_mat ( nr_seq_material_p pls_material.nr_sequencia%type, dt_referencia_p timestamp, tx_positiva_p INOUT pls_regra_aliquota.tx_positiva%type, tx_negativa_p INOUT pls_regra_aliquota.tx_negativa%type, tx_neutra_p INOUT pls_regra_aliquota.tx_neutra%type) FROM PUBLIC;

