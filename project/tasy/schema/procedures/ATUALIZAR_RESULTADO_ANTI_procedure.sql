-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_resultado_anti ( nr_sequencia_p bigint, ie_status_atual_p text, nm_usuario_p text) AS $body$
DECLARE

cd_w	varchar(5);
ds_w	varchar(50);
nr_seq_apresent_w	smallint;
nr_seq_apresent_max_w	smallint;


c01 CURSOR FOR
SELECT 	vl_dominio cd,
	ds_valor_dominio ds
from 	valor_dominio
where 	cd_dominio = 3485
and (vl_dominio <> ie_status_atual_p or coalesce(ie_status_atual_p::text, '') = '')
and (nr_seq_apresent > nr_seq_apresent_w or nr_seq_apresent_w = nr_seq_apresent_max_w)
order by nr_seq_apresent;


BEGIN

select 	coalesce(max(nr_seq_apresent),0)
into STRICT	nr_seq_apresent_w
from 	valor_dominio
where	vl_dominio = ie_status_atual_p
and	cd_dominio = 3485;

select 	coalesce(max(nr_seq_apresent),0)
into STRICT	nr_seq_apresent_max_w
from 	valor_dominio
where	cd_dominio = 3485;

open C01;
loop
fetch C01 into
	cd_w,
	ds_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	exit;

	end;
end loop;
close C01;

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	update	prescr_proc_result_antic
	set	ie_resultado	= cd_w,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao 	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_resultado_anti ( nr_sequencia_p bigint, ie_status_atual_p text, nm_usuario_p text) FROM PUBLIC;

