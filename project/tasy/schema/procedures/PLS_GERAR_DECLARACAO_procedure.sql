-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_declaracao ( nr_seq_contrato_p bigint, nr_seq_proposta_p bigint, cd_pessoa_fisica_p text, nr_seq_tipo_avaliacao_p bigint, cd_medico_solicitante_p text, qt_peso_p bigint, qt_altura_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_declaracao_p INOUT bigint) AS $body$
DECLARE


nr_seq_declaracao_w		pls_declaracao_segurado.nr_sequencia%type;
qt_imc_w			real;
nr_seq_beneficiario_w		pls_proposta_beneficiario.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_pessoa_responsavel_w		pls_declaracao_segurado.cd_pessoa_responsavel%type;
qt_idade_min_decl_saude_w 	pls_parametros.qt_idade_min_decl_saude%type;
cd_pessoa_fisica_titular_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_pessoa_fisica_titular_cnt_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_pesoa_fisica_pagador_w	pessoa_fisica.cd_pessoa_fisica%type;
qt_idade_w			bigint;


BEGIN

qt_imc_w	:= pls_declaracao_obter_imc(qt_altura_p, qt_peso_p);

if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then
	select	max(qt_idade_min_decl_saude)
	into STRICT	qt_idade_min_decl_saude_w
	from	pls_parametros
	where	cd_estabelecimento = cd_estabelecimento_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_beneficiario_w
	from	pls_proposta_beneficiario
	where	nr_seq_proposta	= nr_seq_proposta_p
	and	cd_beneficiario	= cd_pessoa_fisica_p;
	
	if	(nr_seq_beneficiario_w IS NOT NULL AND nr_seq_beneficiario_w::text <> '' AND qt_idade_min_decl_saude_w IS NOT NULL AND qt_idade_min_decl_saude_w::text <> '') then
		select (select	max(x.cd_beneficiario)
			from	pls_proposta_beneficiario x
			where	x.nr_sequencia = a.nr_seq_titular),
			(select	max(x.cd_beneficiario)
			from	pls_proposta_beneficiario x
			where	x.nr_sequencia = a.nr_seq_titular_contrato),
			b.cd_pagador,
			obter_dados_pf(a.cd_beneficiario, 'I')
		into STRICT	cd_pessoa_fisica_titular_w,
			cd_pessoa_fisica_titular_cnt_w,
			cd_pesoa_fisica_pagador_w,
			qt_idade_w
		from	pls_proposta_beneficiario a,
			pls_proposta_pagador b
		where	b.nr_sequencia = a.nr_seq_pagador
		and	a.nr_sequencia = nr_seq_beneficiario_w;
		
		if (qt_idade_w < qt_idade_min_decl_saude_w) then
			if (cd_pessoa_fisica_titular_w IS NOT NULL AND cd_pessoa_fisica_titular_w::text <> '') then
				cd_pessoa_responsavel_w	:= cd_pessoa_fisica_titular_w;
			elsif (cd_pessoa_fisica_titular_cnt_w IS NOT NULL AND cd_pessoa_fisica_titular_cnt_w::text <> '') then
				cd_pessoa_responsavel_w	:= cd_pessoa_fisica_titular_cnt_w;
			elsif (cd_pesoa_fisica_pagador_w IS NOT NULL AND cd_pesoa_fisica_pagador_w::text <> '') then
				cd_pessoa_responsavel_w	:= cd_pesoa_fisica_pagador_w;
			end if;
		end if;
	end if;
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_segurado_w
from	pls_segurado
where	nr_seq_contrato	= nr_seq_contrato_p
and	cd_pessoa_fisica = cd_pessoa_fisica_p;

select	nextval('pls_declaracao_segurado_seq')
into STRICT	nr_seq_declaracao_w
;

insert into pls_declaracao_segurado(nr_sequencia, cd_estabelecimento, nr_seq_tipo_avaliacao,
	cd_pessoa_fisica, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_proposta_adesao,
	nr_seq_contrato, cd_medico_solicitante, dt_liberacao,
	ie_status, qt_peso, qt_altura_cm,
	qt_imc, dt_declaracao, nr_seq_modelo, 
	nr_seq_segurado, cd_pessoa_responsavel)
values (nr_seq_declaracao_w, cd_estabelecimento_p, null,
	cd_pessoa_fisica_p, clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_proposta_p,
	nr_seq_contrato_p, cd_medico_solicitante_p, null,
	'U', qt_peso_p, qt_altura_p, 
	qt_imc_w, clock_timestamp(), nr_seq_tipo_avaliacao_p, 
	nr_seq_segurado_w, cd_pessoa_responsavel_w);

/*Gerar historico para o beneficiario*/

if (nr_seq_beneficiario_w IS NOT NULL AND nr_seq_beneficiario_w::text <> '') then
	CALL pls_gravar_histor_prop_benef(nr_seq_beneficiario_w,clock_timestamp(),'10','Gerada '|| lower(wheb_mensagem_pck.get_texto(1171972)),nm_usuario_p);
end if;

nr_seq_declaracao_p	:= nr_seq_declaracao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_declaracao ( nr_seq_contrato_p bigint, nr_seq_proposta_p bigint, cd_pessoa_fisica_p text, nr_seq_tipo_avaliacao_p bigint, cd_medico_solicitante_p text, qt_peso_p bigint, qt_altura_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_declaracao_p INOUT bigint) FROM PUBLIC;

