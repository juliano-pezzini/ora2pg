-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_reapr_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text) AS $body$
DECLARE


reg_integracao_p			gerar_int_padrao.reg_integracao;
nr_sequencia_w			bigint;	
cd_material_w			bigint;
nr_seq_mat_hor_w			bigint;
nr_seq_mat_hor_www			bigint;
nr_seq_mat_hor_ww		bigint;	/*utilizado apenas no C05*/
cd_unidade_medida_w		varchar(30);
qt_dispensar_w			double precision;
qt_dispensar_hor_w			double precision;
nr_seq_turno_w			bigint;
nr_seq_turno_ww			bigint;
nr_seq_turno_ant_w		bigint	:= 0;
cd_setor_atendimento_w		integer;
dt_horario_w			timestamp;
hr_inicio_turno_w			varchar(5);
hr_hora_w			varchar(5);
dt_atend_lote_w			timestamp;
dt_inicio_turno_w			timestamp;
cd_estabelecimento_w		smallint;
ie_urgente_w			varchar(1);
ds_maq_user_w 			varchar(80);
cd_perfil_ativo_w			integer;
nr_seq_classif_w			bigint;
nr_seq_classif_ww			bigint;
nr_seq_classif_www			bigint;
nr_seq_classif_ant_w		bigint	:= 0;
ds_erro_w			varchar(2000);
			
qt_min_antes_atend_w		bigint;
qt_min_receb_setor_w		bigint;
qt_min_entr_setor_w		bigint;
qt_min_disp_farm_w		bigint;
qt_min_atend_farm_w		bigint;
qt_min_inicio_atend_w		bigint;

cd_tipo_baixa_w			smallint;
ie_conta_paciente_w		varchar(1);
ie_atualiza_estoque_w		varchar(1);
cd_local_estoque_w		smallint;
cd_local_estoque_ant_w		smallint	:= 0;
ie_hora_antes_w			varchar(1);
ie_classif_nao_padrao_w		varchar(15);
qt_prioridade_w			smallint;

ie_lote_acm_sn_w			varchar(1);
ie_gerar_acm_w			varchar(1);
ie_gerar_sn_w			varchar(1);
nr_prescricao_w			bigint;
nr_seq_item_w			bigint;
ie_agrupador_w			smallint;
nr_seq_lote_w			bigint;	
nr_seq_lote_ww			bigint;	
nr_seq_lote_ant_w			bigint := 0;	
qt_existe_w			bigint;
nr_seq_superior_w			bigint;
ie_gerou_lote_filho_w		boolean		:= false;/*criada a variavel para identificar os itens com nr_seq_superior que devem gerar no mesmo lote */
qt_itens_w			integer;
dt_limite_agora_w			timestamp;
dt_limite_especial_w		timestamp;
dt_liberacao_w			timestamp;
qt_min_agora_w			bigint;
qt_min_especial_w			bigint;
ie_classif_urgente_w		varchar(3);
ie_padronizado_w			varchar(1);
ie_controlado_w			varchar(1);

ie_controlado_pmh_w		varchar(01);
ie_padronizado_pmh_w		varchar(01);
ie_classif_urgente_pmh_w		varchar(01);
ie_classif_urgente_ww		varchar(3);

ie_agora_impressao_w	varchar(15);
nr_seq_turno_hor_ag_ww	bigint;
hr_turno_agora_ww	varchar(15);
qt_min_antes_atend_ww	integer;
hr_final_turno_agora_w			varchar(15);
dt_inicio_prescr_w		timestamp;
ie_gerar_lote_area_w		varchar(1);
ie_quimio_w			varchar(1);
ie_motivo_prescricao_w		varchar(5);
ie_define_agora_w		regra_tempo_disp.ie_define_agora%type;
vl_union_w				smallint;
nr_seq_solucao_w		bigint;
nr_seq_solucao_ant_w	bigint := 0;
ie_primeira_solucao_w 	integer := 0;
qt_existe_regra_w		bigint;
ie_gera_integracao_w 		parametros_farmacia.ie_gera_integracao%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;

nr_seq_lote_integracao_w    prescr_mat_hor.nr_seq_lote%type;
ie_enviar_horarios_disp_w	varchar(1);
ie_enviar_mat_estoque_w		varchar(1) := 'N';
nr_seq_material_hl7_w		prescr_material.nr_sequencia%type;
ie_setor_supply_w			varchar(1) := 'N';
ds_param_integ_hl7_w		varchar(4000) := '';
nr_lote_agrupamento_w	ap_lote.nr_lote_agrupamento%type;
qt_lotes_susp_w			bigint;
nr_seq_proc_w			prescr_material.nr_sequencia_proc%type;
nr_seq_cpoe_reap_w		prescr_material.nr_seq_mat_cpoe%type;

C01 CURSOR FOR
	SELECT 1 vl_union,
		coalesce(b.nr_seq_superior,0) nr_seq_superior,
		b.nr_seq_lote,
		a.nr_prescricao,
		c.nr_sequencia nr_seq_item,
		b.ie_agrupador,
		b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		a.cd_setor_atendimento,
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_controlado,
		b.ie_padronizado,
		b.ie_classif_urgente,
		coalesce(b.nr_seq_solucao,0),
		coalesce(c.nr_sequencia_proc,0),
		c.nr_seq_mat_cpoe
	from	prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_sequencia_proc::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	b.qt_dispensar_hor	> 0
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	c.nr_sequencia = nr_sequencia_p
	and b.nr_sequencia = nr_seq_horario_p
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	exists (	SELECT 1
			from ap_lote x
			where x.nr_sequencia = b.nr_seq_lote
			and x.ie_status_lote = 'G'
			and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	
union

	select  2 vl_union,
		coalesce(b.nr_seq_superior,0) nr_seq_superior,
		b.nr_seq_lote,
		a.nr_prescricao,
		c.nr_sequencia nr_seq_item,
		b.ie_agrupador,
		b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		a.cd_setor_atendimento,
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_controlado,
		b.ie_padronizado,
		b.ie_classif_urgente,
		coalesce(b.nr_seq_solucao,0),
		coalesce(c.nr_sequencia_proc,0),
		c.nr_seq_mat_cpoe
	from	prescr_mat_hor  b,
			prescr_material c,
			prescr_solucao d,
			prescr_medica   a
	where	a.nr_prescricao 	= b.nr_prescricao
	and	c.nr_prescricao 		= d.nr_prescricao
	and	c.nr_sequencia			= b.nr_seq_material
	and	c.nr_sequencia_solucao	= d.nr_seq_solucao
	and	a.nr_prescricao			= c.nr_prescricao
	and	a.nr_prescricao 		= nr_prescricao_p
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	c.ie_agrupador = 4
	and	c.cd_motivo_baixa = 0
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(c.nr_sequencia_solucao IS NOT NULL AND c.nr_sequencia_solucao::text <> '')
	and	coalesce(c.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	b.qt_dispensar_hor	> 0
	and	((coalesce(ie_gerar_lote_area_w,'N') = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((coalesce(ie_gerar_acm_w,'N') = 'S') or (coalesce(ie_gerar_acm_w,'N') = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((coalesce(ie_gerar_sn_w,'N') = 'S') or (coalesce(ie_gerar_sn_w,'N') = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	((b.nr_seq_solucao = nr_sequencia_p AND b.nr_sequencia = nr_seq_horario_p) or
		((b.dt_horario = (	select	max(dt_horario)
							from	prescr_mat_hor x
							where	x.nr_sequencia = nr_seq_horario_p
							and		obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S'))))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	exists (	
				select 	1 
				from	ap_lote x
				where	x.nr_sequencia = b.nr_seq_lote
				and		x.ie_status_lote = 'G'
				and		coalesce(x.dt_inicio_dispensacao::text, '') = '')
	
union

	select 	3 vl_union,
			coalesce(b.nr_seq_superior,0) nr_seq_superior,
			b.nr_seq_lote,
			a.nr_prescricao,
			c.nr_sequencia nr_seq_item,
			b.ie_agrupador,
			b.cd_material,
			b.nr_sequencia,
			b.cd_unidade_medida,
			b.qt_dispensar,
			b.qt_dispensar_hor,
			coalesce(b.nr_seq_turno,-1),
			a.cd_setor_atendimento,
			b.dt_horario,
			to_char(b.dt_horario,'hh24:mi'),
			coalesce(a.cd_estabelecimento,1),
			b.ie_urgente,
			b.nr_seq_classif,
			coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
			b.ie_controlado,
			b.ie_padronizado,
			b.ie_classif_urgente,
			coalesce(b.nr_seq_solucao,0),
			coalesce(c.nr_sequencia_proc,0),
			c.nr_seq_mat_cpoe
	from	prescr_mat_hor  b,
			prescr_material c,
			prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	b.qt_dispensar_hor	> 0
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	((c.nr_sequencia_proc = nr_sequencia_p AND b.nr_sequencia = nr_seq_horario_p) or
		((b.dt_horario = (	select	max(dt_horario)
							from	prescr_mat_hor x
							where	x.nr_sequencia = nr_seq_horario_p
							and		obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S'))))
	and	exists (	select 1 
			from ap_lote x
			where x.nr_sequencia = b.nr_seq_lote
			and x.ie_status_lote = 'G'
			and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	order by nr_seq_superior asc,
			 nr_seq_classif,
			 dt_horario;
c10 CURSOR FOR
	SELECT  1 vl_union,
		coalesce(b.nr_seq_superior,0) nr_seq_superior,
		a.nr_prescricao,
		c.nr_sequencia nr_seq_item,
		b.ie_agrupador,
		b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		a.cd_setor_atendimento,
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		b.ie_controlado,
		b.ie_padronizado,
		b.ie_classif_urgente,
		coalesce(b.nr_seq_solucao,0),
		b.nr_seq_lote
	from	prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao 	= b.nr_prescricao
	and	a.nr_prescricao			= c.nr_prescricao
	and	c.nr_sequencia			= b.nr_seq_material
	and	a.nr_prescricao 		= nr_prescricao_p
	and (obter_se_associado(a.nr_prescricao, b.nr_seq_superior, nr_seq_item_w) = 'S')
	and b.nr_seq_turno 			= nr_seq_turno_w
	/*and b.nr_seq_classif		= nr_seq_classif_w RETIRADO ESSA RESTRICAO POIS NA ROTINA GERAR_LOTE_DESDOB NAO EXISTE. MESMO SENDO DE CLASSIF DISTINTACAO GERADO NO MESMO LOTE*/

	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	b.qt_dispensar_hor	> 0
	and	((coalesce(ie_gerar_lote_area_w,'N') = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((coalesce(ie_gerar_acm_w,'N') = 'S') or (coalesce(ie_gerar_acm_w,'N') = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((coalesce(ie_gerar_sn_w,'N') = 'S') or (coalesce(ie_gerar_sn_w,'N') = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and b.dt_horario =	(SELECT	max(dt_horario)
						from	prescr_mat_hor x
						where	x.nr_sequencia = nr_seq_mat_hor_w)
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	exists (	select 	1
				from	ap_lote x
				where	x.nr_sequencia = b.nr_seq_lote
				and		x.ie_status_lote = 'G'
				and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	order by nr_seq_superior asc,
			 nr_seq_classif,
			 dt_horario;

C11 CURSOR FOR
	SELECT 1 vl_union,
		b.nr_seq_lote nr_seq_lote,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)),
		a.cd_setor_atendimento
	from	prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_sequencia_proc::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	b.qt_dispensar_hor	> 0
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	c.nr_sequencia = nr_sequencia_p
	and b.nr_sequencia = nr_seq_horario_p
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	exists (	SELECT 1
			from ap_lote x
			where x.nr_sequencia = b.nr_seq_lote
			and x.ie_status_lote = 'G'
			and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	
union

	select  2 vl_union,
		b.nr_seq_lote,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		a.cd_setor_atendimento
	from	prescr_mat_hor  b,
			prescr_material c,
			prescr_solucao d,
			prescr_medica   a
	where	a.nr_prescricao 	= b.nr_prescricao
	and	c.nr_prescricao 		= d.nr_prescricao
	and	c.nr_sequencia			= b.nr_seq_material
	and	c.nr_sequencia_solucao	= d.nr_seq_solucao
	and	a.nr_prescricao			= c.nr_prescricao
	and	a.nr_prescricao 		= nr_prescricao_p
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	c.ie_agrupador = 4
	and	c.cd_motivo_baixa = 0
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(c.nr_sequencia_solucao IS NOT NULL AND c.nr_sequencia_solucao::text <> '')
	and	coalesce(c.nr_sequencia_proc::text, '') = ''
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	b.qt_dispensar_hor	> 0
	and	((coalesce(ie_gerar_lote_area_w,'N') = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((coalesce(ie_gerar_acm_w,'N') = 'S') or (coalesce(ie_gerar_acm_w,'N') = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((coalesce(ie_gerar_sn_w,'N') = 'S') or (coalesce(ie_gerar_sn_w,'N') = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	((b.nr_seq_solucao = nr_sequencia_p AND b.nr_sequencia = nr_seq_horario_p) or
		((b.dt_horario = (	select	max(dt_horario)
							from	prescr_mat_hor x
							where	x.nr_sequencia = nr_seq_horario_p
							and		obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S'))))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	exists (	
				select 	1 
				from	ap_lote x
				where	x.nr_sequencia = b.nr_seq_lote
				and		x.ie_status_lote = 'G'
				and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	
union

	select 	3 vl_union,
			b.nr_seq_lote,
			coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
			a.cd_setor_atendimento
	from	prescr_mat_hor  b,
			prescr_material c,
			prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	coalesce(b.nr_seq_superior::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	b.qt_dispensar_hor	> 0
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or (coalesce(b.ie_padronizado,'S') = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N'))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	((c.nr_sequencia_proc = nr_sequencia_p AND b.nr_sequencia = nr_seq_horario_p) or
		((b.dt_horario = (	select	max(dt_horario)
							from	prescr_mat_hor x
							where	x.nr_sequencia = nr_seq_horario_p
							and		obter_se_horario_liberado(x.dt_lib_horario, x.dt_horario) = 'S'))))
	and	exists (	select 1 
			from ap_lote x
			where x.nr_sequencia = b.nr_seq_lote
			and x.ie_status_lote = 'G'
			and	coalesce(x.dt_inicio_dispensacao::text, '') = '')
	order by nr_seq_lote;
			
C02 CURSOR FOR
	SELECT	to_char(b.hr_inicial,'hh24:mi')
	from	regra_turno_disp_param b,
		regra_turno_disp a
	where	a.nr_sequencia		= b.nr_seq_turno
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	a.nr_sequencia		= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w)
	and (coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w)
	order by coalesce(b.cd_setor_atendimento,0),
		to_char(b.hr_inicial,'hh24:mi');
	
C03 CURSOR FOR
	SELECT	cd_setor_atendimento,
		nr_seq_turno,
		nr_seq_classif,
		qt_min_antes_atend,
		qt_min_receb_setor,
		qt_min_entr_setor,
		qt_min_disp_farm,
		qt_min_atend_farm,
		qt_min_inicio_atend,
		coalesce(ie_hora_antes,'H')
	from	regra_tempo_disp
	where	cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(ie_situacao, 'A')	= 'A'
	order by coalesce(nr_seq_classif,0), 
		coalesce(nr_seq_turno,0),
		coalesce(cd_setor_atendimento,0);
		
C04 CURSOR FOR
	SELECT	nr_sequencia,
		ie_classif_urgente,
		ie_controlado,
		ie_padronizado
	from	classif_lote_disp_far
	where	cd_estabelecimento = cd_estabelecimento_w
	and	ie_situacao = 'A'
	and	ie_classif_urgente = ie_classif_urgente_ww
	order by ie_classif_urgente,
		ie_controlado desc,
		ie_padronizado desc;	
		
c05 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_mat_hor
	where	nr_prescricao	= nr_prescricao_w
	and		nr_seq_superior = nr_seq_item_w
	and		nr_seq_lote 	= nr_seq_lote_w
	and 	dt_horario 		= dt_horario_w
	and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

c06 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_mat_hor
	where	nr_prescricao = nr_prescricao_w
	and		nr_seq_solucao	= nr_seq_solucao_w
	and		nr_seq_lote 	= nr_seq_lote_w
	and 	dt_horario 		= dt_horario_w
	and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	
C20 CURSOR FOR
	SELECT	cd_tipo_baixa
	from	regra_disp_lote_farm
	where	((ie_motivo_prescricao = ie_motivo_prescricao_w) or (coalesce(ie_motivo_prescricao::text, '') = ''))
    and	clock_timestamp() between CASE WHEN coalesce(dt_hora_inicio::text, '') = '' THEN  clock_timestamp()  ELSE ESTABLISHMENT_TIMEZONE_UTILS.TodayAtTime(dt_hora_inicio) END  and CASE WHEN coalesce(dt_hora_fim::text, '') = '' THEN  clock_timestamp()  ELSE ESTABLISHMENT_TIMEZONE_UTILS.TodayAtTime(dt_hora_fim) END
	and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_fim_vigencia,clock_timestamp()))
	and		coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and		coalesce(cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w                                
	and		coalesce(ie_situacao,'A') = 'A'
	and 	((ie_quimio_w <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (ie_quimio_w = 'S'))
	order by CASE WHEN ie_quimioterapicas='S' THEN 'Z'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,coalesce(cd_setor_atendimento,0), coalesce(ie_motivo_prescricao,0);

c08 CURSOR FOR
	SELECT  distinct
			c.cd_material,
			a.nr_seq_lote,
			c.nr_sequencia
	from    prescr_mat_hor a,
			prescr_medica b,
			prescr_material c,
			estrutura_material_v s,
			material e
	where  	(a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
	and  	a.cd_material = s.cd_material
	and  	a.nr_prescricao = b.nr_prescricao
	and  	c.nr_prescricao = b.nr_prescricao
	and  	a.nr_seq_material = c.nr_sequencia
	and  	a.nr_prescricao = nr_prescricao_p
	and  	a.cd_material = e.cd_material
	and  	c.ie_suspenso <> 'S'
	and  	coalesce(a.dt_suspensao::text, '') = ''
	and 	(a.nr_sequencia = nr_seq_horario_p
	or		a.nr_seq_superior = (SELECT max(g.nr_seq_material)
								from 	prescr_mat_hor g 
								where 	g.nr_sequencia = nr_seq_horario_p
								and 	g.dt_horario = a.dt_horario))
	and  	exists(	select	1
					from  	ap_lote x,
							classif_lote_disp_far y
					where  	x.nr_sequencia = a.nr_seq_lote
					and   	coalesce(x.ie_integracao, 'N') <> 'P'
					and  	y.nr_sequencia = x.nr_seq_classif
					and		((ie_enviar_horarios_disp_w = 'S') or (y.ie_classif_urgente = 'A')) 
					and  	coalesce(x.dt_atend_farmacia::text, '') = '')
	and  exists(	select  1
					from   	regra_local_dispensacao x
					where   x.cd_estabelecimento  = b.cd_estabelecimento
					and  	x.cd_setor_atendimento  = b.cd_setor_atendimento
					and  	x.nr_sequencia   = coalesce(a.nr_regra_local_disp, c.nr_seq_regra_local)
					and   	coalesce(x.nr_seq_classif,a.nr_seq_classif) = a.nr_seq_classif
					and   	((x.cd_material   = s.cd_material) or (x.cd_grupo_material  = s.cd_grupo_material) or (x.cd_subgrupo_material = s.cd_subgrupo_material) or (x.cd_classe_material  = s.cd_classe_material) or ((x.nr_seq_estrut_int IS NOT NULL AND x.nr_seq_estrut_int::text <> '') and consistir_se_mat_contr_estrut(x.nr_seq_estrut_int, s.cd_material) = 'S')));

	

BEGIN

select 	coalesce(max('S'),'N')
into STRICT	ie_quimio_w
from	paciente_atendimento
where	nr_prescricao = nr_prescricao_p;

select	substr(obter_inf_sessao(0) ||' - ' || obter_inf_sessao(1),1,80)
into STRICT	ds_maq_user_w	
;

cd_perfil_ativo_w	:= obter_perfil_ativo;

select	max(cd_setor_atendimento),
		max(cd_estabelecimento),
		max(dt_liberacao),
		max(dt_inicio_prescr),
		max(ie_motivo_prescricao),
		max(nr_atendimento)
into STRICT	cd_setor_atendimento_w,
		cd_estabelecimento_w,
		dt_liberacao_w,
		dt_inicio_prescr_w,
		ie_motivo_prescricao_w,
		nr_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	count(*)
into STRICT	qt_existe_regra_w
from	dis_regra_setor
where	cd_setor_atendimento = cd_setor_atendimento_w;

select	max(ie_classif_urgencia),
	coalesce(max(ie_gerar_acm_lote), 'S'),
	coalesce(max(ie_gerar_sn_lote), 'S'),
	coalesce(max(qt_min_agora),0),
	coalesce(max(qt_min_especial),0),
	coalesce(max(ie_forma_agora), 'N'),
	coalesce(max(ie_gerar_lote_area),'S'),
	coalesce(max(ie_gera_integracao), 'N'),
	coalesce(max(ie_enviar_horarios_disp), 'N'),
	coalesce(max(ie_enviar_mat_estoque), 'N')
into STRICT	ie_classif_nao_padrao_w,
	ie_gerar_acm_w,
	ie_gerar_sn_w,
	qt_min_agora_w,
	qt_min_especial_w,
	ie_agora_impressao_w,
	ie_gerar_lote_area_w,
	ie_gera_integracao_w,
	ie_enviar_horarios_disp_w,
	ie_enviar_mat_estoque_w	
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

begin
	select  'S'
	into STRICT  	ie_setor_supply_w
	from  	far_setores_integracao
	where  	nr_seq_empresa_int =  82 -- SupplyPoint
	and  	cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
	ie_setor_supply_w := 'N';
end;

dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;

if (ie_origem_lote_p in ('RHIP')) then
	begin
	ie_lote_acm_sn_w	:= coalesce(obter_valor_param_usuario(1113, 145, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S');	
	if (ie_lote_acm_sn_w = 'S') or (ie_lote_acm_sn_w = 'N') then
		ie_gerar_acm_w	:= ie_lote_acm_sn_w;
		ie_gerar_sn_w	:= ie_lote_acm_sn_w;
	end if;
	end;
	
end if;

open C20;
loop
fetch C20 into	
	cd_tipo_baixa_w;
EXIT WHEN NOT FOUND; /* apply on C20 */
	begin
	cd_tipo_baixa_w	:= cd_tipo_baixa_w;
	end;
end loop;
close C20;

if (cd_tipo_baixa_w IS NOT NULL AND cd_tipo_baixa_w::text <> '') then
	select	max(ie_conta_paciente),
		max(ie_atualiza_estoque)
	into STRICT	ie_conta_paciente_w,
		ie_atualiza_estoque_w
	from	tipo_baixa_prescricao
	where	cd_tipo_baixa		= cd_tipo_baixa_w
	and	ie_prescricao_devolucao = 'P';
end if;

insert into ap_lote_log(
	nr_sequencia,
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_prescricao, 
	nr_seq_mat_hor, 
	nr_seq_lote, 
	ds_tipo_item, 
	ds_conteudo, 
	ds_stack)
values (	nextval('ap_lote_log_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_prescricao_p,
	nr_seq_horario_p,
	null,
	'Gerar_Lote_Reapr_Prescr1',
	' nr_prescricao_p=' || nr_prescricao_p || 
	' ie_so_aprazado_p=' || ie_so_aprazado_p ||
	' ie_gerar_lote_area_w=' || ie_gerar_lote_area_w ||
	' ie_classif_nao_padrao_w=' || ie_classif_nao_padrao_w || 
	' ie_gerar_acm_w=' || ie_gerar_acm_w || 
	' ie_gerar_sn_w=' || ie_gerar_sn_w ||
	' nr_sequencia_p=' || nr_sequencia_p ||
	' nr_seq_horario_p=' || nr_seq_horario_p,
	substr(dbms_utility.format_call_stack,1,2000));
	
open c11;
loop
fetch c11 into	
	vl_union_w,
	nr_seq_lote_w,
	cd_local_estoque_w,
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C11 */
	begin
	if (nr_seq_lote_w <> nr_seq_lote_ant_w) then
		reg_integracao_p.cd_estab_documento	:= wheb_usuario_pck.get_cd_estabelecimento;
		reg_integracao_p.cd_local_estoque	:= cd_local_estoque_w;
		reg_integracao_p.nr_seq_agrupador	:= nr_seq_lote_w;
		reg_integracao_p.cd_setor_atendimento	:= cd_setor_atendimento_w;
		reg_integracao_p := gerar_int_padrao.gravar_integracao('275', nr_seq_lote_w, nm_usuario_p, reg_integracao_p);
	end if;
	nr_seq_lote_ant_w := nr_seq_lote_w;
	end;
end loop;
close C11;

nr_seq_lote_ant_w := 0;

open C01;
loop
fetch C01 into
	vl_union_w,
	nr_seq_superior_w,
	nr_seq_lote_w,
	nr_prescricao_w,	
	nr_seq_item_w,
	ie_agrupador_w,
	cd_material_w,
	nr_seq_mat_hor_w,
	cd_unidade_medida_w,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	nr_seq_turno_w,
	cd_setor_atendimento_w,
	dt_horario_w,
	hr_hora_w,
	cd_estabelecimento_w,
	ie_urgente_w,
	nr_seq_classif_w,
	cd_local_estoque_w,
	ie_controlado_pmh_w,
	ie_padronizado_pmh_w,
	ie_classif_urgente_pmh_w,
	nr_seq_solucao_w,
	nr_seq_proc_w,
	nr_seq_cpoe_reap_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if	((nr_seq_lote_w = nr_seq_lote_ant_w) and
		((nr_seq_superior_w > 0) or (nr_seq_proc_w > 0) or (nr_seq_solucao_w > 0))) then
		ie_gerou_lote_filho_w := true;
	end if;

	insert into ap_lote_log(
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_prescricao, 
	nr_seq_mat_hor, 
	nr_seq_lote, 
	ds_tipo_item, 
	ds_conteudo, 
	ds_stack)
values (	nextval('ap_lote_log_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_prescricao_p,
	nr_seq_horario_p,
	null,
	'Gerar_Lote_Reapr_Prescr12',
	' nr_seq_mat_hor_w=' || nr_seq_mat_hor_w || 
	' ie_so_aprazado_p=' || ie_so_aprazado_p ||
	' ie_gerar_lote_area_w=' || ie_gerar_lote_area_w ||
	' ie_classif_nao_padrao_w=' || ie_classif_nao_padrao_w || 
	' ie_gerar_acm_w=' || ie_gerar_acm_w || 
	' ie_gerar_sn_w=' || ie_gerar_sn_w ||
	' nr_sequencia_p=' || nr_sequencia_p ||
	' nr_seq_horario_p=' || nr_seq_horario_p ||
	' nr_seq_turno_w=' || nr_seq_turno_w || 
	' nr_seq_turno_ant_w=' || nr_seq_turno_ant_w || 
	' nr_seq_classif_w=' || nr_seq_classif_w || 
	' nr_seq_classif_ant_w=' || nr_seq_classif_ant_w || 
	' vl_union_w=' || vl_union_w ||  
	' ie_origem_lote_p=' || ie_origem_lote_p ||  
	' nr_seq_superior_w=' || nr_seq_superior_w ||  
	' nr_seq_lote_w=' || nr_seq_lote_w ||  
	' nr_seq_solucao_w=' || nr_seq_solucao_w || 
	' nr_seq_proc_w=' || nr_seq_proc_w || 
	' nr_seq_lote_ant_w=' || nr_seq_lote_ant_w,
	substr(dbms_utility.format_call_stack,1,2000));

	if	((nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or (cd_local_estoque_w <> cd_local_estoque_ant_w) or
		(vl_union_w = 2 AND ie_origem_lote_p = 'RHIP') or
		(vl_union_w = 3 AND ie_origem_lote_p = 'RHP') or
		(((nr_seq_superior_w > 0) or (nr_seq_solucao_w > 0) or (nr_seq_proc_w > 0)) and 
		((ie_gerou_lote_filho_w) or (nr_seq_lote_w <> nr_seq_lote_ant_w)))) then 
		begin 
		OPEN C02;
		LOOP
			FETCH C02 INTO
				hr_inicio_turno_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			hr_inicio_turno_w	:= hr_inicio_turno_w;
			end;
		END LOOP;
		CLOSE C02;
		
		/*Cancelando o horario reaprazado com o lote anterior na integracao SupplyPoint.*/

		if (ie_setor_supply_w = 'S') then
			ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_p || obter_separador_bv
						|| 'nr_seq_material=' || null || obter_separador_bv
						|| 'ie_enviar_horarios_disp=' || ie_enviar_horarios_disp_w || obter_separador_bv
						|| 'nr_seq_horario=' || nr_seq_mat_hor_w || obter_separador_bv
						|| 'nr_seq_lote=' || nr_seq_lote_w || obter_separador_bv;

			CALL gravar_agend_integracao(437, ds_param_integ_hl7_w);
		end if;
	
		select	coalesce(max(qt_prioridade),999)
		into STRICT	qt_prioridade_w
		from	classif_lote_disp_far
		where	nr_sequencia	= nr_seq_classif_w;

		if (hr_hora_w < hr_inicio_turno_w) then
			dt_inicio_turno_w	:= to_date(to_char(dt_horario_w - 1,'dd/mm/yyyy')||' '||replace(hr_inicio_turno_w,'24:','00:') ||':00','dd/mm/yyyy hh24:mi:ss');
		else
			dt_inicio_turno_w	:= to_date(to_char(dt_horario_w,'dd/mm/yyyy')||' '||replace(hr_inicio_turno_w,'24:','00:') ||':00','dd/mm/yyyy hh24:mi:ss');
		end if;		
		
			
		/*	Fabio e Jonas - 19/01/2010 = Para gerar os lotes como AGORA dependendo do horario final do turno, e nAO mais pelo minutos de agora*/

		if (ie_agora_impressao_w = 'S') then
			nr_seq_turno_hor_ag_ww	:= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'), cd_local_estoque_w);
			select	max(to_char(b.hr_inicial,'hh24:mi')),
				max(to_char(b.hr_final,'hh24:mi'))
			into STRICT	hr_turno_agora_ww,
				hr_final_turno_agora_w
			from	regra_turno_disp_param b,
				regra_turno_disp a
			where	a.nr_sequencia		= b.nr_seq_turno
			and	a.cd_estabelecimento	= cd_estabelecimento_w
			and	a.nr_sequencia		= nr_seq_turno_hor_ag_ww
			and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0));

			select	coalesce(max(qt_min_antes_atend), 0),
				coalesce(max(ie_define_agora), 'N')
			into STRICT	qt_min_antes_atend_ww,
				ie_define_agora_w
			from	regra_tempo_disp
			where	cd_estabelecimento	= cd_estabelecimento_w
			and (coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0))
			and	nr_seq_turno = nr_seq_turno_hor_ag_ww
			and	ie_situacao = 'A';

			if (hr_turno_agora_ww > hr_final_turno_agora_w) then
				-- if	(to_char(dt_horario_w,'dd/mm/yyyy') > to_char(dt_inicio_prescr_w,'dd/mm/yyyy')) then
                if (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_horario_w) > ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)) then				
				
					dt_limite_agora_w := to_date(to_char(dt_horario_w-1,'dd/mm/yyyy')||' '||hr_turno_agora_ww||':00','dd/mm/yyyy hh24:mi:ss') - (qt_min_antes_atend_ww/1440);
				else
					dt_limite_agora_w := to_date(to_char(dt_horario_w,'dd/mm/yyyy')||' '||hr_turno_agora_ww||':00','dd/mm/yyyy hh24:mi:ss') - (qt_min_antes_atend_ww/1440);
				end if;
			else
				dt_limite_agora_w := to_date(to_char(dt_horario_w,'dd/mm/yyyy')||' '||hr_turno_agora_ww||':00','dd/mm/yyyy hh24:mi:ss') - (qt_min_antes_atend_ww/1440);
			end if;
		end if;
		/*	Fabio e Jonas - 19/01/2010 = Final da alteraCAO*/

	
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
			begin
			ie_classif_urgente_w	:= 'N';
			if	((ie_define_agora_w = 'N' AND dt_horario_w <= dt_limite_agora_w) or (ie_urgente_w = 'S')) then
				ie_classif_urgente_w	:= 'A';
			elsif	((dt_limite_agora_w <= clock_timestamp()) and (ie_agora_impressao_w = 'S') and (ie_define_agora_w = 'N')) then
				ie_classif_urgente_w	:= 'A';
			elsif (ie_agora_impressao_w = 'S' and ie_define_agora_w = 'S') and
				(dt_horario_w <= (clock_timestamp() + (qt_min_antes_atend_w /1440))) then
				ie_classif_urgente_w	:= 'A';
			elsif (dt_horario_w <= dt_limite_especial_w) then
				ie_classif_urgente_w	:= 'E';
			end if;
			ie_classif_urgente_ww	:= ie_classif_urgente_w;
			end;
		else
			ie_classif_urgente_ww	:= ie_classif_nao_padrao_w;
		end if; /**/
		update	ap_lote_item
		set 	dt_supensao 	= clock_timestamp(),
			nm_usuario_susp	= nm_usuario_p
		where 	nr_seq_lote 	= nr_seq_lote_w
		and	cd_material 	= cd_material_w
		and	nr_seq_mat_hor	= nr_seq_mat_hor_w;
				
		insert into ap_lote_historico(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_lote,
			ds_evento,
			ds_log)
		values (	nextval('ap_lote_historico_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_lote_w,
			wheb_mensagem_pck.get_Texto(310993),	/*'Item suspenso'*/
			wheb_mensagem_pck.get_Texto(310994, 'CD_MATERIAL_W='|| CD_MATERIAL_W)); /*Item #@CD_MATERIAL_W#@ suspenso no reaprazamento do horARIo. Procedure Gerar_Lote_Reapr_Prescr.*/
			
		insert into ap_lote_log(
				nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_mat_hor, 
				nr_seq_lote, 
				ds_tipo_item, 
				ds_conteudo, 
				ds_stack)
			values (	nextval('ap_lote_log_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_horario_p,
				null,
				'Gerar_Lote_Reapr_Prescr5',
				' nr_seq_superior_w = '|| nr_seq_superior_w || ' vl_union_w = ' || vl_union_w ||
				' nr_seq_solucao_w = ' || nr_seq_solucao_w || ' nr_seq_turno_w = ' || nr_seq_turno_w ||
				' nr_seq_turno_ant_w = ' || nr_seq_turno_ant_w || ' nr_seq_classif_w= ' || nr_seq_classif_w ||
				' cd_local_estoque_w = ' || cd_local_estoque_w || ' cd_local_estoque_ant_w = ' || cd_local_estoque_ant_w || 
				' nr_seq_lote_w=' || nr_seq_lote_w || ' nr_seq_lote_ant_w=' || nr_seq_lote_ant_w || 
				' nr_seq_mat_hor_w=' || nr_seq_mat_hor_w || ' nr_seq_solucao_ant_w=' || nr_seq_solucao_ant_w ||
				' nr_seq_classif_ant_w=' || nr_seq_classif_ant_w, 
				substr(dbms_utility.format_call_stack,1,2000));				
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		
		if	(nr_seq_superior_w = 0 AND vl_union_w = 1) or
			((vl_union_w in (2,3)) and
			((nr_seq_solucao_w <> coalesce(nr_seq_solucao_ant_w,0)) or (nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or (cd_local_estoque_w <> cd_local_estoque_ant_w))) or
			((nr_seq_superior_w > 0) and (not ie_gerou_lote_filho_w) and (coalesce(nr_seq_lote_w,0) <> coalesce(nr_seq_lote_ant_w,0))) then
			begin
			
			select	nextval('ap_lote_seq')
			into STRICT	nr_sequencia_w
			;

			
			insert into ap_lote(
				nr_sequencia,
				dt_inicio_turno,
				dt_prim_horario,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_geracao_lote,
				nr_prescricao,
				ie_status_lote,
				cd_setor_atendimento,
				nr_seq_classif,
				nm_usuario_geracao,
				ds_maquina_geracao,
				cd_perfil_geracao,
				qt_min_atraso_inicio_atend,
				qt_min_atraso_atend,
				qt_min_atraso_disp,
				qt_min_atraso_entrega,
				qt_min_atraso_receb,
				cd_tipo_baixa,
				ie_conta_paciente,
				ie_atualiza_estoque,
				cd_local_estoque,
				qt_prioridade,
				ie_origem_lote,
				ie_reaprazado,
				nr_seq_lote_sup,
				nr_seq_turno,
				ds_origem_ger_lote,
				nr_atendimento,
				nr_seq_local_geracao)
			values ( nr_sequencia_w,
				dt_inicio_turno_w,
				dt_horario_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nr_prescricao_p,
				'G',
				cd_setor_atendimento_w,
				nr_seq_classif_w,
				nm_usuario_p,
				ds_maq_user_w,
				cd_perfil_ativo_w,
				0,
				0,
				0,
				0,
				0,
				cd_tipo_baixa_w,
				ie_conta_paciente_w,
				ie_atualiza_estoque_w,
				cd_local_estoque_w,
				qt_prioridade_w,
				ie_origem_lote_p,
				'S',
				nr_seq_lote_w,
				obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
				'RE',
				nr_atendimento_w,
				'REP');
			
			/*Caso o ie_classif_urgente nao tenha sido atualizado na reaprazar_horario_item_prescr
			exemplo: Stack: MODIFICAR_DATA_INICIO_SOLUCAO > GERAR_LOTE_REAPR_PRESCR*/
			if (ie_classif_urgente_pmh_w <> ie_classif_urgente_ww) then
				ie_classif_urgente_pmh_w := ie_classif_urgente_ww;
			end if;
			
			open C04;
			loop
			fetch C04 into	
				nr_seq_classif_ww,
				ie_classif_urgente_w,
				ie_controlado_w,
				ie_padronizado_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
					update	ap_lote
					set		nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and		nr_sequencia			= nr_sequencia_w
					and 	ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_padronizado_pmh_w		= 'S'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_padronizado_pmh_w		= 'N'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'N'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'N'
					and	ie_padronizado_pmh_w		= 'N'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'N'
					and	ie_padronizado_pmh_w		= 'S'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'S'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'S'
					and	ie_padronizado_pmh_w		= 'N'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
					update	ap_lote
					set	nr_seq_classif			= nr_seq_classif_ww
					where	nr_prescricao			= nr_prescricao_w	
					and	nr_sequencia			= nr_sequencia_w
					and	ie_controlado_pmh_w		= 'S'
					and	ie_padronizado_pmh_w		= 'S'
					and ie_classif_urgente_pmh_w = ie_classif_urgente_w;
				end if;

				end;
			end loop;
			close C04;

			select	count(*)
			into STRICT	qt_existe_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_w
			and	nr_seq_superior = nr_seq_item_w
			and	nr_seq_lote = nr_seq_lote_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
			
			if (qt_existe_w > 0) then
				open C05;
				loop
				fetch C05 into	
					nr_seq_mat_hor_ww;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin
					
					update	ap_lote_item
					set 	dt_supensao 	= clock_timestamp(),
							nm_usuario_susp	= nm_usuario_p
					where 	nr_seq_lote 	= nr_seq_lote_w
					and		nr_seq_mat_hor	= nr_seq_mat_hor_ww;
					
					update	prescr_mat_hor
					set		nr_seq_lote	= nr_sequencia_w,
							nr_seq_turno	= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
							nm_usuario	= nm_usuario_p
					where	nr_sequencia	= nr_seq_mat_hor_ww;
					
					update	prescr_mat_alteracao
					set		nr_seq_lote = nr_sequencia_w
					where	nr_seq_horario	= nr_seq_mat_hor_ww
					and		nr_prescricao	= nr_prescricao_w;
					
					end;
				end loop;
				close C05;
			
			end if;
			
			select	count(1)
			into STRICT	qt_existe_w
			from	prescr_mat_hor
			where	nr_prescricao = nr_prescricao_w
			and	nr_seq_solucao = nr_seq_solucao_w;
			
			if (qt_existe_w > 0) then
				open C06;
				loop
				fetch C06 into	
					nr_seq_mat_hor_ww;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin
					
					update	ap_lote_item
					set 	dt_supensao 	= clock_timestamp(),
							nm_usuario_susp	= nm_usuario_p
					where 	nr_seq_lote 	= nr_seq_lote_w
					and		nr_seq_mat_hor	= nr_seq_mat_hor_ww;
							
					update	prescr_mat_hor
					set		nr_seq_lote	= nr_sequencia_w,
							nr_seq_turno	= obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,to_char(dt_horario_w,'hh24:mi'),cd_local_estoque_w),
							nm_usuario	= nm_usuario_p
					where	nr_sequencia	= nr_seq_mat_hor_ww;
					
					update	prescr_mat_alteracao
					set		nr_seq_lote = nr_sequencia_w
					where	nr_seq_horario	= nr_seq_mat_hor_ww
					and		nr_prescricao	= nr_prescricao_w;
					
					end;
				end loop;
				close C06;
			end if;
			
			end;	
		end if;
		
		if (coalesce(nr_sequencia_w,0) > 0) then
			begin
			insert into ap_lote_item(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_lote,
				nr_seq_mat_hor,
				ie_prescrito,
				qt_dispensar,
				qt_total_dispensar,
				cd_material,
				cd_unidade_medida,
				ie_urgente)
			values (nextval('ap_lote_item_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				nr_seq_mat_hor_w,
				'S',
				qt_dispensar_hor_w,
				qt_dispensar_w,
				cd_material_w,
				cd_unidade_medida_w,
				ie_urgente_w);
			
			if	(nr_seq_superior_w > 0 AND not ie_gerou_lote_filho_w) then
				ie_gerou_lote_filho_w 	:= true;
			end if;
			end;
		end if;

		update	prescr_mat_hor
		set		nr_seq_lote		= nr_sequencia_w,
				nm_usuario		= nm_usuario_p
		where	nr_sequencia	= nr_seq_mat_hor_w;
		
		--Envia novo lote para Swisslog evento 434
		CALL swisslog_inserir_prescr(nr_prescricao_p,nr_seq_mat_hor_w,nm_usuario_p);

		insert into ap_lote_log(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_mat_hor, 
			nr_seq_lote, 
			ds_tipo_item, 
			ds_conteudo, 
			ds_stack)
		values (	nextval('ap_lote_log_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_horario_p,
			null,
			'Gerar_Lote_Reapr_Prescr9',
			' nr_seq_superior_w = '|| nr_seq_superior_w || ' nr_seq_item_w = ' || nr_seq_item_w || ' nr_seq_mat_hor_w=' || nr_seq_mat_hor_w ||
			' ie_agrupador_w = ' || ie_agrupador_w || ' nr_seq_turno_w = ' || nr_seq_turno_w || ' nr_seq_classif_w= ' || nr_seq_classif_w ||
			' cd_local_estoque_w = ' || cd_local_estoque_w || ' nr_seq_lote_w=' || nr_seq_lote_w || ' cd_material_w=' || cd_material_w || 
			' nr_seq_mat_hor_w=' || nr_seq_mat_hor_w,
			substr(dbms_utility.format_call_stack,1,2000));
			
		nr_seq_turno_ant_w		:= nr_seq_turno_w;
		nr_seq_classif_ant_w	:= nr_seq_classif_w;
		cd_local_estoque_ant_w	:= cd_local_estoque_w;
		nr_seq_lote_ant_w		:= nr_seq_lote_w;
		nr_seq_solucao_ant_w	:= nr_seq_solucao_w;
		
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		open c10;
		loop
		fetch c10 into	
			vl_union_w,
			nr_seq_superior_w,
			nr_prescricao_w,	
			nr_seq_item_w,
			ie_agrupador_w,
			cd_material_w,
			nr_seq_mat_hor_www,
			cd_unidade_medida_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			nr_seq_turno_ww,
			cd_setor_atendimento_w,
			dt_horario_w,
			hr_hora_w,
			cd_estabelecimento_w,
			ie_urgente_w,
			nr_seq_classif_www,
			cd_local_estoque_w,
			ie_controlado_pmh_w,
			ie_padronizado_pmh_w,
			ie_classif_urgente_pmh_w,
			nr_seq_solucao_w,
			nr_seq_lote_ww;
		EXIT WHEN NOT FOUND; /* apply on c10 */
			begin

			/*Cancelando o horario reaprazado com o lote anterior na integracao SupplyPoint.*/

			if (ie_setor_supply_w = 'S') then
				ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_p || obter_separador_bv
							|| 'nr_seq_material=' || null || obter_separador_bv
							|| 'ie_enviar_horarios_disp=' || ie_enviar_horarios_disp_w || obter_separador_bv
							|| 'nr_seq_horario=' || nr_seq_mat_hor_www || obter_separador_bv
							|| 'nr_seq_lote=' || nr_seq_lote_ant_w || obter_separador_bv;

				CALL gravar_agend_integracao(437, ds_param_integ_hl7_w);
			end if;

			insert into ap_lote_log(
				nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_mat_hor, 
				nr_seq_lote, 
				ds_tipo_item, 
				ds_conteudo, 
				ds_stack)
			values (	nextval('ap_lote_log_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_horario_p,
				null,
				'Gerar_Lote_Reapr_Prescr10',
				' nr_seq_superior_w = '|| nr_seq_superior_w || ' nr_seq_item_w = ' || nr_seq_item_w ||
				' ie_agrupador_w = ' || ie_agrupador_w || ' nr_seq_turno_w = ' || nr_seq_turno_w ||
				' nr_seq_turno_ant_w = ' || nr_seq_turno_ant_w || ' nr_seq_classif_w= ' || nr_seq_classif_w ||
				' cd_local_estoque_w = ' || cd_local_estoque_w || ' cd_local_estoque_ant_w = ' || cd_local_estoque_ant_w || 
				' nr_seq_lote_w=' || nr_seq_lote_w || ' cd_material_w=' || cd_material_w || ' nr_seq_mat_hor_www=' || nr_seq_mat_hor_www,
				substr(dbms_utility.format_call_stack,1,2000));
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
			
			update	ap_lote_item
			set 	dt_supensao 		= clock_timestamp(),
					nm_usuario_susp		= nm_usuario_p
			where 	nr_seq_lote 		= nr_seq_lote_w
			and		cd_material 		= cd_material_w
			and		nr_seq_mat_hor		= nr_seq_mat_hor_www;
			
			insert into ap_lote_historico(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_lote,
				ds_evento,
				ds_log)
			values (	nextval('ap_lote_historico_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_lote_w,
				wheb_mensagem_pck.get_Texto(310993),	/*'Item suspenso'*/
				wheb_mensagem_pck.get_Texto(310994, 'CD_MATERIAL_W='|| CD_MATERIAL_W)); /*Item #@CD_MATERIAL_W#@ suspenso no reaprazamento do horario. Procedure Gerar_Lote_Reapr_Prescr.*/
			
			insert into ap_lote_item(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_lote,
				nr_seq_mat_hor,
				ie_prescrito,
				qt_dispensar,
				qt_total_dispensar,
				cd_material,
				cd_unidade_medida,
				ie_urgente)
			values (nextval('ap_lote_item_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				nr_seq_mat_hor_www,
				'S',
				qt_dispensar_hor_w,
				qt_dispensar_w,
				cd_material_w,
				cd_unidade_medida_w,
				ie_urgente_w);
			
			update	prescr_mat_hor
			set		nr_seq_lote		= nr_sequencia_w,
					nm_usuario		= nm_usuario_p
			where	nr_sequencia	= nr_seq_mat_hor_www;

			--Envia novo lote para Swisslog evento 434
			CALL swisslog_inserir_prescr(nr_prescricao_p,nr_seq_mat_hor_www,nm_usuario_p);
			
			end;
		end loop;
		close c10;
		
		select	count(*)
		into STRICT	qt_itens_w
		from 	ap_lote_item
		where 	coalesce(dt_supensao::text, '') = ''
		and 	nr_seq_lote = nr_seq_lote_w;
		
		if (qt_itens_w = 0) then	
			update	ap_lote
			set 	ie_status_lote = 'C',
					dt_cancelamento = clock_timestamp(),
					nm_usuario_cancelamento = nm_usuario_p
			where 	nr_sequencia = nr_seq_lote_w;
			
			select	coalesce(max(nr_lote_agrupamento),0)
			into STRICT	nr_lote_agrupamento_w
			from 	ap_lote
			where 	nr_sequencia = nr_seq_lote_w;
				
			if (nr_lote_agrupamento_w > 0) then	
				select	count(*)
				into STRICT	qt_lotes_susp_w
				from 	ap_lote
				where 	nr_lote_agrupamento = nr_lote_agrupamento_w
				and 	coalesce(ie_status_lote,'G') not in ('C','S','CA');
				
				if (qt_lotes_susp_w = 0) then
					update	ap_lote
					set		ie_status_lote = 'C'
					where	nr_sequencia = nr_lote_agrupamento_w;
				end if;
			end if;		
		end if;	
		end;
	end if;
	end;

	
end loop;
close C01;

open C03;
loop
fetch C03 into	
	cd_setor_atendimento_w,
	nr_seq_turno_w,
	nr_seq_classif_w,
	qt_min_antes_atend_w,
	qt_min_receb_setor_w,
	qt_min_entr_setor_w,
	qt_min_disp_farm_w,
	qt_min_atend_farm_w,
	qt_min_inicio_atend_w,
	ie_hora_antes_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	
	if (ie_hora_antes_w = 'H') then
		begin
		update	ap_lote
		set	dt_atend_lote		= round(dt_prim_horario - dividir(qt_min_antes_atend_w,1440),'mi'),
			dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
			dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_w))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno = nr_seq_turno_w))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif = nr_seq_classif_w));
		end;
	elsif (ie_hora_antes_w = 'I') then
		begin
		update	ap_lote
		set	dt_atend_lote		= round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'),
			dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
			dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_w))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno = nr_seq_turno_w))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif = nr_seq_classif_w));
		end;
	elsif (ie_hora_antes_w = 'T') then
		begin
		update	ap_lote
		set	dt_atend_lote		= round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'),
			dt_limite_inicio_atend	= round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi'),
			dt_limite_atend		= round(dt_inicio_turno - dividir(qt_min_atend_farm_w,1440),'mi'),
			dt_limite_disp_farm	= round(dt_inicio_turno - dividir(qt_min_disp_farm_w,1440),'mi'),
			dt_limite_entrega_setor	= round(dt_inicio_turno - dividir(qt_min_entr_setor_w,1440),'mi'),
			dt_limite_receb_setor	= round(dt_inicio_turno - dividir(qt_min_receb_setor_w,1440),'mi')
		where	nr_prescricao		= nr_prescricao_p
		and	((coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_w))
		and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno = nr_seq_turno_w))
		and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif = nr_seq_classif_w));
		end;
	end if;
	end;
end loop;
close C03;

if (qt_existe_regra_w > 0) then
	CALL intdisp_gerar_mat_hor_reapr(nr_prescricao_p, nm_usuario_p);
end if;

nr_seq_lote_ant_w := 0;

open c11;
loop
fetch c11 into	
	vl_union_w,
	nr_seq_lote_w,
	cd_local_estoque_w,
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C11 */
	begin
	if (nr_seq_lote_w <> nr_seq_lote_ant_w) then
		reg_integracao_p.cd_estab_documento	:= wheb_usuario_pck.get_cd_estabelecimento;
		reg_integracao_p.cd_local_estoque	:= cd_local_estoque_w;
		reg_integracao_p.nr_seq_agrupador	:= nr_seq_lote_w;
		reg_integracao_p.cd_setor_atendimento	:= cd_setor_atendimento_w;
		reg_integracao_p := gerar_int_padrao.gravar_integracao('260', nr_seq_lote_w, nm_usuario_p, reg_integracao_p);
	end if;
	nr_seq_lote_ant_w := nr_seq_lote_w;
	end;
end loop;
close C11;

select	coalesce(max(ie_gera_integracao),'N')
into STRICT	ie_gera_integracao_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_gera_integracao_w = 'S') then
	CALL disp_prescr_mat_hor(nr_prescricao_p,0,nm_usuario_p);
end if;	

if (ie_setor_supply_w = 'S') then
	/*Integra novamente o horario cancelado com as informacoes atualizadas*/

	open c08;
	loop
	fetch c08 into
		cd_material_w,
		nr_seq_lote_integracao_w,
		nr_seq_material_hl7_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */
	begin
		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || obter_separador_bv ||
			'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
			'nr_seq_lote=' || nr_seq_lote_integracao_w || obter_separador_bv ||
			'cd_material_presc=' || cd_material_w || obter_separador_bv ||
			'ie_aprazado=' || 'GPMH' || obter_separador_bv ||
			'ie_origem=' || 'GLAP' || obter_separador_bv ||
			'nr_seq_material=' || nr_seq_material_hl7_w || obter_separador_bv ||
			'ie_enviar_horarios_disp=' || ie_enviar_horarios_disp_w || obter_separador_bv ||
			'ie_enviar_mat_estoque=' || ie_enviar_mat_estoque_w || obter_separador_bv;
		-- Envio das informacoes do paciente internado para a integracao
		if (ie_setor_supply_w = 'S') then		
			CALL gravar_agend_integracao(434,ds_param_integ_hl7_w, cd_setor_atendimento_w);
		end if;

		update 	ap_lote
		set  	ie_integracao = 'P'
		where  	nr_sequencia = nr_seq_lote_integracao_w;
    end;
	end loop;
	close c08;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_reapr_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text) FROM PUBLIC;

