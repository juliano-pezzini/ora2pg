-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_vinc_prescr ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE
 	
 
 
nr_horas_validade_w		integer;	
cd_procedimento_w		bigint;
nr_ocorrencia_w			bigint;
cd_intervalo_w			varchar(10);
ds_horarios_w			varchar(2000);
ds_horarios2_w			varchar(2000);
dt_validade_prescr_w	timestamp;
nr_seq_procedimento_w	bigint;
dt_primeiro_horario_w	timestamp;
dt_prescricao_w			timestamp;
dt_prev_execucao_w		timestamp;
hr_prim_horario_w		varchar(5);
qt_hora_intervalo_w		smallint;
dt_inicio_prescricao_w	timestamp;
qt_min_intervalo_w		integer;

c02 CURSOR FOR 
	SELECT	cd_procedimento, 
		cd_intervalo, 
		nr_sequencia, 
		dt_prev_execucao, 
		coalesce(qt_hora_intervalo,0), 
	   coalesce(qt_min_intervalo,0), 
		ds_horarios 
	from	prescr_procedimento 
	where	nr_prescricao		 =  nr_prescricao_p 
	and	coalesce(ie_acm,'N')	  	 = 'N' 
	and	coalesce(ie_se_necessario,'N') = 'N' 
	and 	coalesce(ie_urgencia,'N')	 = 'N' 
	and	ie_tipo_proced not in ('BSST','BS');


BEGIN	 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '')	then 
	 
	select	nr_horas_validade, 
		dt_validade_prescr, 
		dt_prescricao, 
		dt_primeiro_horario, 
		to_char(dt_inicio_prescr,'hh24:mi'), 
		dt_inicio_prescr 
	into STRICT	nr_horas_validade_w, 
		dt_validade_prescr_w, 
		dt_prescricao_w, 
		dt_primeiro_horario_w, 
		hr_prim_horario_w, 
		dt_inicio_prescricao_w 
	from	prescr_medica 
	where	nr_prescricao	= nr_prescricao_p;
	 
	open c02;
	loop 
	fetch c02 into	 
		cd_procedimento_w, 
		cd_intervalo_w, 
		nr_seq_procedimento_w, 
		dt_prev_execucao_w, 
		qt_hora_intervalo_w, 
		qt_min_intervalo_w, 
		ds_horarios_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
		nr_ocorrencia_w := 0;
		SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_prev_execucao_w, nr_horas_validade_w, null, 0, 0, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
							 
		 
		ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
		 
		update	prescr_procedimento 
		set	ds_horarios	=	ds_horarios_w, 
			nr_ocorrencia	=	nr_ocorrencia_w 
		where	nr_prescricao	=	nr_prescricao_p 
		and	nr_sequencia	=	nr_seq_procedimento_w;
		 
		CALL ajustar_prescr_mat_proc(nr_prescricao_p, nr_seq_procedimento_w, cd_perfil_p,null);
		end;
	end loop;
	close c02;
end if;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_vinc_prescr ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

