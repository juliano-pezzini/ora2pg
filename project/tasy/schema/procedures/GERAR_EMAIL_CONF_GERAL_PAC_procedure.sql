-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_email_conf_geral_pac ( qt_dias_p bigint ) AS $body$
DECLARE

			

nr_seq_agenda_w		agenda_paciente.nr_sequencia%type;
			

c01 CURSOR FOR
	SELECT 	a.nr_sequencia
	from 	agenda_paciente a,
			agenda g
	where 	trunc(a.dt_agenda) = ( trunc(clock_timestamp()) + qt_dias_p )
	and 	a.cd_agenda = g.cd_agenda
	and		g.cd_tipo_agenda = 2
	and 	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and		a.ie_status_agenda <> 'C'
	and		a.nr_sequencia = (	SELECT	min(c.nr_sequencia)
								from	agenda_paciente c
								where 	trunc(c.dt_agenda) = ( trunc(clock_timestamp()) + qt_dias_p )
								and 	c.cd_pessoa_fisica = a.cd_pessoa_fisica
								and		c.ie_status_agenda <> 'C');
	
		
c02 CURSOR FOR
	SELECT 	a.nr_sequencia
	from 	agenda_consulta a,
			agenda	g
	where 	trunc(a.dt_agenda) = ( trunc(clock_timestamp()) + qt_dias_p )
	and 	a.cd_agenda = g.cd_agenda
	and		g.cd_tipo_agenda in (3,4)
	and 	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and		a.ie_status_agenda <> 'C'
	and	a.nr_sequencia = (	SELECT	min(c.nr_sequencia)
							from	agenda_consulta c
							where 	trunc(c.dt_agenda) = ( trunc(clock_timestamp()) + qt_dias_p )
							and		c.ie_status_agenda <> 'C'
							and 	c.cd_pessoa_fisica = a.cd_pessoa_fisica);

	

BEGIN


--Agendas Exame
open c01;
loop
fetch c01 into	
	nr_seq_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	CALL gerar_email_conf_agenda(nr_seq_agenda_w,2,'TASY');
	
	end;
end loop;
close c01;



--Agendas Consulta
open c02;
loop
fetch c02 into	
	nr_seq_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	CALL gerar_email_conf_agenda(nr_seq_agenda_w,4,'TASY');
	
	end;
end loop;
close c02;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_email_conf_geral_pac ( qt_dias_p bigint ) FROM PUBLIC;

