-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ficha_upp_evento ( nr_seq_evento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
 
ie_clinica_w			integer;
cd_setor_Atendimento_w	integer;
cd_setor_paciente_w		integer;
cd_pessoa_fisica_w		varchar(10);
ie_ficha_upp_w			varchar(1);
nr_atendimento_w		bigint;	
cd_estabelecimento_w	smallint;
qt_reg_w				bigint;
nr_seq_tipo_evento_w	bigint;
ie_tipo_w				varchar(5);

 

BEGIN 
 
if (coalesce(nr_seq_evento_p,0) > 0) then 
 
	Select max(cd_pessoa_fisica), 
			max(cd_setor_atendimento), 
			max(nr_atendimento), 
			max(cd_estabelecimento), 
			max(nr_seq_evento) 
	into STRICT 	cd_pessoa_fisica_w, 
			cd_setor_paciente_w, 
			nr_atendimento_w, 
			cd_estabelecimento_w, 
			nr_seq_tipo_evento_w			 
	from 	qua_evento_paciente 
	where	nr_sequencia = nr_seq_evento_p;
 
 
	cd_setor_atendimento_w := Obter_Setor_Atendimento(nr_atendimento_w);
	 
	Select 	max(a.ie_ficha_upp), 
			max(b.ie_tipo_evento) 
	into STRICT	ie_ficha_upp_w, 
			ie_tipo_w 
	from	qua_evento a, 
			qua_tipo_evento b 
	where	a.nr_sequencia = nr_seq_tipo_evento_w 
	and		a.nr_seq_tipo = b.nr_sequencia;
	 
	Select 	count(*) 
	into STRICT	qt_reg_w 
	from	cur_ferida 
	where	nr_seq_evento = nr_seq_evento_p;
	 
	if (coalesce(ie_ficha_upp_w,'N') = 'S') and (coalesce(ie_tipo_w,'X') = 'UPP') and (qt_reg_w = 0) then	 
		 
		if (coalesce(nr_atendimento_w,0) > 0) and (coalesce(cd_setor_atendimento_w,0) > 0) then 
			 
			ie_clinica_w := Obter_Clinica_Atend(nr_atendimento_w,'C');
			 
			if (coalesce(ie_clinica_w,0) > 0) then	 
		 
			 
				Insert into cur_ferida(nr_sequencia, 
										cd_pessoa_fisica, 
										dt_atualizacao, 
										nm_usuario, 
										ie_clinica, 
										cd_setor_atendimento, 
										cd_estabelecimento, 
										nr_seq_evento, 
										dt_liberacao, 
										ie_situacao, 
										qt_ano_ferida, 
										qt_mes_ferida, 
										qt_dia_ferida, 
										ie_fumante, 
										ie_diabetico, 
										ie_uso_alcool, 
										ie_doenca_vascular, 
										ie_historia_anterior,										 
										ie_dor, 
										ie_alergia_medic, 
										ie_insuf_vascular_venosa, 
										ie_insuf_renal_cronica, 
										ie_neoplasia, 
										ie_autoimune, 
										ie_obesidade, 
										ie_desnutricao, 
										ie_quimioterapia, 
										ie_corticoide, 
										ie_anti_infl_nao_ester, 
										ie_anticoagulante, 
										ie_radioterapia, 
										ie_admitido_ferida) 
								values (nextval('cur_ferida_seq'), 
										cd_pessoa_fisica_w, 
										clock_timestamp(), 
										nm_usuario_p, 
										ie_clinica_w, 
										coalesce(cd_setor_atendimento_w,cd_setor_paciente_w), 
										cd_estabelecimento_w, 
										nr_seq_evento_p, 
										clock_timestamp(), 
										'A', 
										1, 
										1, 
										0, 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N');
										 
			 
			 
				commit;
 
			end if;
			 
		end if;
		 
	end if;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ficha_upp_evento ( nr_seq_evento_p bigint, nm_usuario_p text) FROM PUBLIC;

