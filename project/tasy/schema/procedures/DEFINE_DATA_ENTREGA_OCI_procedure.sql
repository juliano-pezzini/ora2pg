-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_data_entrega_oci ( nr_ordem_compra_p bigint, dt_entrega_p timestamp, nm_usuario_p text) AS $body$
DECLARE


qt_register_w   bigint;

c01 CURSOR FOR
SELECT nr_item_oci
from ordem_compra_item
where nr_ordem_compra = nr_ordem_compra_p;

BEGIN

for item in c01
loop
	select count(*)
	into STRICT qt_register_w
	from ordem_compra_item_entrega
	where nr_ordem_compra = nr_ordem_compra_p
	and nr_item_oci = item.nr_item_oci
	and trunc(dt_prevista_entrega) = trunc(dt_entrega_p);

	if (qt_register_w = 0) then
		update	ordem_compra_item_entrega
		set	dt_prevista_entrega	= dt_entrega_p,
		dt_entrega_original	= coalesce(dt_entrega_original,dt_entrega_p),
		dt_entrega_limite	= coalesce(dt_entrega_limite,dt_entrega_p)
		where	nr_ordem_compra	= nr_ordem_compra_p
        and nr_item_oci = item.nr_item_oci  LIMIT 1;
     end if;
end loop;

CALL INSERIR_HISTORICO_ORDEM_COMPRA(
	NR_ORDEM_COMPRA_P,
	'S',
	WHEB_MENSAGEM_PCK.get_texto(298957),
	WHEB_MENSAGEM_PCK.get_texto(298958),
	NM_USUARIO_P);


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_data_entrega_oci ( nr_ordem_compra_p bigint, dt_entrega_p timestamp, nm_usuario_p text) FROM PUBLIC;

