-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE raas_generate_interf_acoes_psi ( nr_seq_lote_atend_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_uf_w					w_raas_interf_acoes_psico.cd_uf%type;
dt_mesano_referencia_w	w_raas_interf_acoes_psico.dt_producao%type;
cd_cnes_usf_w			w_raas_interf_acoes_psico.cd_cnes%type;
cd_cns_paciente_w		w_raas_interf_acoes_psico.cd_cartao_saude_paciente%type;
dt_admissao_w			w_raas_interf_acoes_psico.dt_validade_inicial%type;
cd_procedimento_w		w_raas_interf_acoes_psico.cd_sigtap_acao%type;
cd_cbo_w				w_raas_interf_acoes_psico.cd_cbos%type;
cd_cns_medico_w			w_raas_interf_acoes_psico.cd_cns%type;
dt_procedimento_w		w_raas_interf_acoes_psico.dt_execucao_acao%type;
cd_servico_w			w_raas_interf_acoes_psico.cd_servico%type;
cd_servico_classif_w	w_raas_interf_acoes_psico.cd_classificacao%type;
qt_procedimento_w		w_raas_interf_acoes_psico.qt_realizada%type;

c01 CURSOR FOR
SELECT	esus_obter_codigo_uf(obter_compl_pf(a.cd_pessoa_fisica,1,'UF')) cd_uf,
		a.dt_mesano_referencia,
		a.cd_cnes_usf,
		substr(obter_dados_pf(a.cd_pessoa_fisica,'CNS'),1,15) cd_cns_paciente,
		a.dt_admissao,
		lpad(b.cd_procedimento,10,0) cd_procedimento,
		b.cd_cbo,
		substr(obter_dados_pf(b.cd_medico_executor,'CNS'),1,15) cd_cns_medico,
		b.dt_procedimento,
		sus_obter_dados_servico(b.nr_seq_servico,'C') cd_servico,
		sus_obter_dados_serv_classif(b.nr_seq_servico_classif,'C') cd_servico_classif,
		b.qt_procedimento
from	raas_atend_atencao_psico a,
		raas_acoes_atencao_psico b
where	a.nr_sequencia = b.nr_seq_atend_atenc_psi
and		a.nr_seq_lote_atend = nr_seq_lote_atend_p;


BEGIN

open c01;
loop
fetch c01 into
	cd_uf_w,
	dt_mesano_referencia_w,
	cd_cnes_usf_w,
	cd_cns_paciente_w,
	dt_admissao_w,
	cd_procedimento_w,
	cd_cbo_w,
	cd_cns_medico_w,
	dt_procedimento_w,
	cd_servico_w,
	cd_servico_classif_w,
	qt_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	insert into w_raas_interf_acoes_psico(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_linha,
		cd_uf,
		dt_producao,
		cd_cnes,
		cd_cartao_saude_paciente,
		dt_validade_inicial,
		cd_sigtap_acao,
		cd_cbos,
		cd_cns,
		dt_execucao_acao,
		cd_servico,
		cd_classificacao,
		qt_realizada,
		ie_origem,
		ie_local_exame)
	values (
		nextval('w_raas_interf_acoes_psico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'16',
		cd_uf_w,
		dt_mesano_referencia_w,
		cd_cnes_usf_w,
		cd_cns_paciente_w,
		dt_admissao_w,
		cd_procedimento_w,
		cd_cbo_w,
		cd_cns_medico_w,
		dt_procedimento_w,
		cd_servico_w,
		cd_servico_classif_w,
		qt_procedimento_w,
		'EXT',
		'C');
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE raas_generate_interf_acoes_psi ( nr_seq_lote_atend_p bigint, nm_usuario_p text) FROM PUBLIC;

