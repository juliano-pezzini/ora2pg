-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_assumir_paciente ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

ie_tipo_w		varchar(10);
nr_sequencia_w		bigint;
nr_interno_conta_w	bigint;
cd_motivo_exc_conta_w	bigint;
cd_estabelecimento_w	bigint;
cd_pessoa_fisica_w	varchar(10);
nm_setor_leito_w 	setor_atendimento.ds_setor_atendimento%type;
cd_cgc_w		    	estabelecimento.cd_cgc%type;
nr_seq_interno_w	atend_paciente_unidade.nr_seq_interno%type;

--Procedure criada pelo Thiago Ferreti
c02 CURSOR FOR
	SELECT	'P' ie_tipo,
		a.nr_sequencia,
		a.nr_interno_conta
	from	procedimento_paciente a,
		conta_paciente b,
		regra_lanc_automatico c
	where	a.nr_interno_conta 	= b.nr_interno_conta
	and	b.nr_Atendimento	= nr_atendimento_p
	and	c.nr_sequencia		= a.nr_seq_regra_lanc
	and	b.ie_status_acerto	= 1
	and	c.NR_SEQ_EVENTO		= 221
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	
union all

	SELECT	'M' ie_tipo,
		a.nr_sequencia,
		a.nr_interno_conta
	from	material_Atend_paciente a,
		conta_paciente b,
		regra_lanc_automatico c
	where	a.nr_interno_conta 	= b.nr_interno_conta
	and	b.nr_Atendimento	= nr_atendimento_p
	and	c.nr_sequencia		= a.nr_seq_regra_lanc
	and	b.ie_status_acerto	= 1
	and	c.NR_SEQ_EVENTO		= 221
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '';


BEGIN

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

select	max(cd_motivo_exc_conta)
into STRICT	cd_motivo_exc_conta_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(max(cd_medico_anterior),obter_medico_resp_atend(nr_atendimento_p,'C'))
into STRICT	cd_pessoa_fisica_w
from	atendimento_troca_medico
where	nr_atendimento = nr_atendimento_p
and	dt_troca = (	SELECT max(dt_troca)
			from   atendimento_troca_medico
			where	nr_atendimento = nr_atendimento_p);

update	atendimento_paciente
	set	cd_medico_resp 		= cd_pessoa_fisica_w,
		nm_usuario     		= nm_usuario_p,
		dt_atualizacao 		= clock_timestamp(),
		dt_chamada_paciente	 = NULL,
		nr_seq_local_pa		 = NULL,
		ie_chamado		 = NULL
	where	nr_atendimento		= nr_atendimento_p;

	select	obter_atepacu_paciente(nr_atendimento_p, 'IAA')
	into STRICT	nr_seq_interno_w
	;
	
	if (nr_seq_interno_w > 0)then
		
    select 	REPLACE(a.cd_setor_atendimento||'@'||substr(obter_nome_setor(a.cd_setor_atendimento),1,100),'.',' ')||'.'||REPLACE(a.cd_unidade_basica,'.',' ')||'.'||REPLACE(a.cd_unidade_compl,'.',' ') nome_setor_leito,
				  (select max(e.cd_cgc) from estabelecimento e where e.cd_estabelecimento = cd_estabelecimento_w) cd_cgc
		into STRICT 	nm_setor_leito_w,
				  cd_cgc_w
		from 	atend_paciente_unidade a
		where	a.nr_seq_interno = nr_seq_interno_w
		and 	a.nr_atendimento = nr_atendimento_p;

		-- Estorno da admissao - Intregracao PFCS
		CALL pfcs_int_service_request(nr_atendimento_p, 'revoked', 'order', 'E0401', 'Request for Bed', obter_pessoa_atendimento(nr_atendimento_p,'C'), nm_setor_leito_w, cd_cgc_w, nm_usuario_p, 'N');
	
	end if;

open C02;
loop
fetch C02 into
	ie_tipo_w,
	nr_sequencia_w,
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	CALL excluir_matproc_conta(nr_sequencia_w,nr_interno_conta_w,cd_motivo_exc_conta_w,obter_desc_expressao(320459) ,ie_tipo_w,nm_usuario_p);
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_assumir_paciente ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

