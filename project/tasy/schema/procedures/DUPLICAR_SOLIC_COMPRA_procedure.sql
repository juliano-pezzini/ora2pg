-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_solic_compra (nr_solic_compra_p bigint, nm_usuario_p text, dt_entrega_p timestamp, ie_entrega_original_p text, nr_solic_compra_dest_p INOUT text) AS $body$
DECLARE


nr_solic_compra_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_item_solic_compra_w		integer;
nr_item_solic_compra_entr_w	integer;
qt_entrega_solicitada_w		double precision;
dt_entrega_w			timestamp;
dt_entrega_solicitada_w		timestamp;
ds_observacao_w			varchar(255);
cd_local_estoque_w		bigint;
cd_estabelecimento_w		bigint;
cd_perfil_ativo_w		bigint;
ie_copia_comprador_w		varchar(1);
cd_comprador_resp_w		varchar(10);

c01 CURSOR FOR
SELECT	nr_item_solic_compra,
	nr_item_solic_compra_entr,
	qt_entrega_solicitada,
	dt_entrega_solicitada,
	ds_observacao
from	solic_compra_item_entrega
where	nr_solic_compra = nr_solic_compra_p;


BEGIN

select	nextval('solic_compra_seq')
into STRICT	nr_solic_compra_w
;

select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario	= nm_usuario_p;

select	cd_local_estoque,
	cd_estabelecimento
into STRICT	cd_local_estoque_w,
	cd_estabelecimento_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

cd_perfil_ativo_w := obter_perfil_ativo;

ie_copia_comprador_w :=	substr(coalesce(obter_valor_param_usuario(913, 238, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);

insert into solic_compra(
	nr_solic_compra,
	cd_estabelecimento,
	dt_solicitacao_compra,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	cd_pessoa_solicitante,
	cd_local_estoque,
	cd_centro_custo,
	cd_conta_contabil,
	cd_setor_atendimento,
	ds_observacao,
	ie_aviso_chegada,
	nr_seq_ordem_serv,
	ie_aviso_aprov_oc,
	ie_urgente,
	ie_tipo_solicitacao,
	ie_comodato,
	ie_semanal,
	nr_seq_forma_compra,
	ie_tipo_servico,
	ie_forma_exportar,
	cd_comprador_resp,
	ie_tipo_compra,
	nr_seq_tipo_compra,
	nr_seq_mod_compra,
	nr_seq_motivo_solic,
	nr_seq_motivo_urgente,
	ds_justificativa,
	cd_fornec_exclusivo,
	cd_fornec_sugerido,
	nr_seq_grupo_resp_compra,
	cd_perfil,
	cd_pessoa_fisica,
	nm_usuario_nrec,
	dt_atualizacao_nrec)
SELECT	nr_solic_compra_w,
	cd_estabelecimento,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	'A',
	coalesce(cd_pessoa_fisica_w, cd_pessoa_solicitante),
	cd_local_estoque,
	cd_centro_custo,
	cd_conta_contabil,
	cd_setor_atendimento,
	ds_observacao,
	ie_aviso_chegada,
	nr_seq_ordem_serv,
	'N',
	ie_urgente,
	0,
	ie_comodato,
	ie_semanal,
	nr_seq_forma_compra,
	ie_tipo_servico,
	ie_forma_exportar,
	CASE WHEN ie_copia_comprador_w='N' THEN null WHEN ie_copia_comprador_w='S' THEN cd_comprador_resp END ,
	ie_tipo_compra,
	nr_seq_tipo_compra,
	nr_seq_mod_compra,
	nr_seq_motivo_solic,
	nr_seq_motivo_urgente,
	ds_justificativa,
	cd_fornec_exclusivo,
	cd_fornec_sugerido,
	nr_seq_grupo_resp_compra,
	cd_perfil,
	cd_pessoa_fisica,
	nm_usuario_p,
	clock_timestamp()
from 	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

insert into solic_compra_item(
	nr_solic_compra,
	nr_item_solic_compra,
	cd_material,
	cd_unidade_medida_compra,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	ds_material_direto,
	ds_observacao,
	dt_solic_item,
	ie_geracao,
	cd_conta_contabil,
	nr_seq_proj_rec,
	ie_bula,
	ie_amostra,
	ie_catalogo,
	qt_conv_compra_est_orig,
	nr_contrato,
	nr_seq_regra_contrato,
	qt_saldo_disp_estoque,
	ds_observacao_int,
	nr_seq_marca,
	ie_motivo_reprovacao,
	cd_cnpj,
	vl_unit_previsto,
	vl_custo_total,
	vl_estoque_total,
	cd_paciente_soli_compra)
SELECT	nr_solic_compra_w,
	nr_item_solic_compra,
	cd_material,
	cd_unidade_medida_compra,
	qt_material,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	ds_material_direto,
	ds_observacao,
	CASE WHEN ie_entrega_original_p='S' THEN dt_solic_item  ELSE coalesce(dt_entrega_p, clock_timestamp()) END ,
	ie_geracao,
	cd_conta_contabil,
	nr_seq_proj_rec,
	ie_bula,
	ie_amostra,
	ie_catalogo,
	obter_dados_material(cd_material,'QCE'),
	nr_contrato,
	nr_seq_regra_contrato,
	obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material, cd_local_estoque_w, trunc(clock_timestamp(),'mm')),
	ds_observacao_int,
	nr_seq_marca,
	ie_motivo_reprovacao,
	cd_cnpj,
	vl_unit_previsto,
	vl_custo_total,
	vl_estoque_total,
	cd_paciente_soli_compra
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;

open c01;
loop
fetch c01 into
	nr_item_solic_compra_w,
	nr_item_solic_compra_entr_w,
	qt_entrega_solicitada_w,
	dt_entrega_solicitada_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	dt_entrega_w		:= coalesce(dt_entrega_p, clock_timestamp());
	if (ie_entrega_original_p = 'S') then
		dt_entrega_w	:= dt_entrega_solicitada_w;
	end if;

	insert into solic_compra_item_entrega(
		nr_solic_compra,
		nr_item_solic_compra,
		nr_item_solic_compra_entr,
		qt_entrega_solicitada,
		dt_entrega_solicitada,
		dt_atualizacao,
		nm_usuario,
		ds_observacao)
	values (nr_solic_compra_w,
		nr_item_solic_compra_w,
		nr_item_solic_compra_entr_w,
		qt_entrega_solicitada_w,
		dt_entrega_w,
		clock_timestamp(),
		nm_usuario_p,
		ds_observacao_w);
	end;
end loop;
close c01;

commit;

nr_solic_compra_dest_p := nr_solic_compra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_solic_compra (nr_solic_compra_p bigint, nm_usuario_p text, dt_entrega_p timestamp, ie_entrega_original_p text, nr_solic_compra_dest_p INOUT text) FROM PUBLIC;

