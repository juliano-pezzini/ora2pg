-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_vl_glosa_reemb () AS $body$
DECLARE

 
c01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.vl_glosa, 
		a.vl_procedimento_imp - a.vl_liberado vl_glosa_novo, 
		'P' ie_item 
	from	pls_conta_proc a, 
		pls_conta b, 
		pls_protocolo_conta c 
	where	b.nr_sequencia = a.nr_seq_conta 
	and	c.nr_sequencia = b.nr_seq_protocolo	 
	and	c.ie_status in ('1','2','3','5','6') 
	and	c.ie_tipo_protocolo = 'R' 
	
union all
 
	SELECT	a.nr_sequencia, 
		a.vl_glosa, 
		a.vl_material_imp - a.vl_liberado vl_glosa_novo, 
		'M' ie_item 
	from	pls_conta_mat a, 
		pls_conta b, 
		pls_protocolo_conta c 
	where	b.nr_sequencia = a.nr_seq_conta 
	and	c.nr_sequencia = b.nr_seq_protocolo 
	and	c.ie_status in ('1','2','3','5','6') 
	and	c.ie_tipo_protocolo = 'R' 
	order by ie_item;

tb_nr_seq_proc_w	pls_util_cta_pck.t_number_table;
tb_nr_seq_mat_w		pls_util_cta_pck.t_number_table;
tb_vl_glosa_w		pls_util_cta_pck.t_number_table;
j			integer;
k			integer;

BEGIN 
-- evita a execução de algumas triggers 
CALL wheb_usuario_pck.set_ie_executar_trigger('N');
 
j := 0;
k := 0;
 
for r_c01_w in c01 loop 
	begin 
		if (r_c01_w.ie_item = 'P') and (r_c01_w.vl_glosa_novo > 0) then 
			tb_nr_seq_proc_w(j) := r_c01_w.nr_sequencia;
			tb_vl_glosa_w(j) := r_c01_w.vl_glosa_novo;
			 
			if (tb_nr_seq_proc_w.count >= pls_util_pck.qt_registro_transacao_w) then 
				forall i in tb_nr_seq_proc_w.first .. tb_nr_seq_proc_w.last 
					update 	pls_conta_proc set 
						vl_glosa = tb_vl_glosa_w(i) 
					where	nr_sequencia = tb_nr_seq_proc_w(i);
				commit;
				 
				j := 0;
				tb_nr_seq_proc_w.delete;
			else 
				j := j + 1;
			end if;
		elsif (r_c01_w.ie_item = 'M') and (r_c01_w.vl_glosa_novo > 0) then 
			tb_nr_seq_mat_w(k) := r_c01_w.nr_sequencia;
			tb_vl_glosa_w(k) := r_c01_w.vl_glosa_novo;
			 
			if (tb_nr_seq_mat_w.count >= pls_util_pck.qt_registro_transacao_w) then 
				forall i in tb_nr_seq_mat_w.first .. tb_nr_seq_mat_w.last 
					update 	pls_conta_proc set 
						vl_glosa = tb_vl_glosa_w(i) 
					where	nr_sequencia = tb_nr_seq_mat_w(i);
				commit;
				 
				k := 0;
				tb_nr_seq_mat_w.delete;
			else 
				k := k + 1;
			end if;
		end if;
	end;
end loop;
 
if (tb_nr_seq_proc_w.count >= 0) then 
	forall i in tb_nr_seq_proc_w.first .. tb_nr_seq_proc_w.last 
		update 	pls_conta_proc set 
			vl_glosa = tb_vl_glosa_w(i) 
		where	nr_sequencia = tb_nr_seq_proc_w(i);
	commit;
end if;
 
if (tb_nr_seq_mat_w.count >= 0) then 
	forall i in tb_nr_seq_mat_w.first .. tb_nr_seq_mat_w.last 
		update 	pls_conta_proc set 
			vl_glosa = tb_vl_glosa_w(i) 
		where	nr_sequencia = tb_nr_seq_mat_w(i);
	commit;
end if;
 
CALL wheb_usuario_pck.set_ie_executar_trigger('S');
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_vl_glosa_reemb () FROM PUBLIC;

