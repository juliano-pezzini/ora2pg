-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_protheus_movto_estoque ( qt_horas_p bigint, cd_estabelecimento_p bigint, --Informar '0' para considerar todos
 nm_usuario_p text) AS $body$
DECLARE


dt_movimento_estoque_w	timestamp;
cd_material_w		integer;
cd_centro_custo_w	integer;
cd_centro_custo_ww	varchar(20);
vl_movimento_w		double precision;
nr_movimento_estoque_w	bigint;
nr_seq_regra_w		bigint;
ie_entrada_saida_w	varchar(1);
cd_operacao_estoque_w	smallint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
cd_local_estoque_w	smallint;
cd_local_destino_w	smallint;
cd_sistema_ant_w	varchar(20);
qt_horas_w		bigint;
cd_unidade_medida_w	varchar(30);
cd_unidade_medida_ww	varchar(30);
qt_movimento_w		double precision;
cd_conta_contabil_w	varchar(30);
cd_conta_contabil_ww	varchar(30);
cd_acao_w		varchar(1);
ie_tipo_requisicao_w	varchar(3);
cd_setor_atendimento_w	bigint;
cd_setor_entrega_w	integer;
ie_origem_documento_w	movimento_estoque.ie_origem_documento%type;
nr_documento_w		movimento_estoque.nr_documento%type;

c01 CURSOR FOR
	SELECT	dt_movimento_estoque,
		cd_material_estoque,
		cd_centro_custo,
		coalesce(vl_movimento,0),
		nr_movimento_estoque,
		cd_operacao_estoque,
		cd_local_estoque,
		cd_unidade_medida_estoque,
		qt_estoque,
		cd_acao,
		cd_local_estoque_destino,
		cd_setor_atendimento,
		ie_origem_documento,
		nr_documento
	from	movimento_estoque_v1 a
	where	dt_atualizacao between clock_timestamp() -  (qt_horas_p/86400) and clock_timestamp()
	and (coalesce(cd_estabelecimento_p,0) = 0 or cd_estabelecimento_p = cd_estabelecimento)
	and (ie_origem_documento <> '1');
		/*or
		((ie_origem_documento = '1') and (obter_dados_nota_fiscal(nr_seq_tab_orig,'34') is not null)));*/
BEGIN
--qt_horas_w := dividir(dividir(qt_horas_p,60),60);
delete from w_protheus_movto_estoque;

open c01;
loop
fetch c01 into
	dt_movimento_estoque_w,
	cd_material_w,
	cd_centro_custo_w,
	vl_movimento_w,
	nr_movimento_estoque_w,
	cd_operacao_estoque_w,
	cd_local_estoque_w,
	cd_unidade_medida_w,
	qt_movimento_w,
	cd_acao_w,
	cd_local_destino_w,
	cd_setor_atendimento_w,
	ie_origem_documento_w,
	nr_documento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	ie_entrada_saida
	into STRICT	ie_entrada_saida_w
	from	operacao_estoque
	where	cd_operacao_estoque = cd_operacao_estoque_w;

	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v
	where	cd_material = cd_material_w;

	select	cd_conta_contabil
	into STRICT	cd_conta_contabil_w
	from	classe_material
	where	cd_classe_material = cd_classe_material_w;

	select	max(coalesce(nr_sequencia,0))
	into STRICT	nr_seq_regra_w
	from	regra_integr_movto_estoque
	
	where	ie_integracao = 'PR'
	and	ie_situacao = 'A'
	and (ie_entrada_saida = 'A' or ie_entrada_saida_w = ie_entrada_saida)
	and	coalesce(cd_operacao_estoque, cd_operacao_estoque_w) = cd_operacao_estoque_w
	and	coalesce(cd_material, cd_material_w) = cd_material_w
	and	coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
	and	coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
	and	coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
	and	coalesce(ie_integra,'S') = 'S';

	if (cd_acao_w = '2') then

		select	CASE WHEN ie_entrada_saida_w='E' THEN 'S' WHEN ie_entrada_saida_w='S' THEN 'E' END
		into STRICT	ie_entrada_saida_w
		;
	end if;

	if (nr_seq_regra_w > 0) then

		select	coalesce(substr(cd_sistema_ant,1,10),cd_material_w)
		into STRICT	cd_sistema_ant_w
		from	material
		where	cd_material = cd_material_w;

		if (cd_operacao_estoque_w > 0) then

			select	ie_tipo_requisicao
			into STRICT	ie_tipo_requisicao_w
			from	operacao_estoque
			where	cd_operacao_estoque = cd_operacao_estoque_w;

			/*Inventário*/

			if (ie_tipo_requisicao_w = 5) and (cd_local_estoque_w > 0) then

				select	cd_centro_custo
				into STRICT	cd_centro_custo_w
				from	local_estoque
				where	cd_local_estoque = cd_local_estoque_w;

			end if;

			/*Transferência entre Locais*/

			if (ie_tipo_requisicao_w = 2) and (cd_local_destino_w > 0) then

				select	cd_centro_custo
				into STRICT	cd_centro_custo_w
				from	local_estoque
				where	cd_local_estoque = cd_local_destino_w;

			end if;

			/*Nota Fiscal Compra*/

			if (ie_tipo_requisicao_w = 6) and (coalesce(cd_centro_custo_w,0) = 0) and (cd_local_estoque_w > 0) then

				select	cd_centro_custo
				into STRICT	cd_centro_custo_w
				from	local_estoque
				where	cd_local_estoque = cd_local_estoque_w;

			end if;
		end if;

		if (coalesce(cd_centro_custo_w,0) = 0) and (coalesce(cd_setor_atendimento_w,0) > 0) then

			select	cd_centro_custo
			into STRICT	cd_centro_custo_w
			from	setor_atendimento
			where	cd_setor_atendimento = cd_setor_atendimento_w;

		end if;

		cd_centro_custo_ww := '';
		if (cd_centro_custo_w > 0) then
			select	coalesce(cd_sistema_contabil,cd_centro_custo)
			into STRICT	cd_centro_custo_ww
			from	centro_custo
			where	cd_centro_custo = cd_centro_custo_w;
		end if;

		cd_unidade_medida_ww := '';
		if (cd_unidade_medida_w IS NOT NULL AND cd_unidade_medida_w::text <> '') then
			select	coalesce(cd_sistema_ant,cd_unidade_medida)
			into STRICT	cd_unidade_medida_ww
			from	unidade_medida
			where	cd_unidade_medida = cd_unidade_medida_w;
		end if;

		cd_conta_contabil_ww := '';
		if (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
			select	coalesce(cd_sistema_contabil,cd_conta_contabil)
			into STRICT	cd_conta_contabil_ww
			from	conta_contabil
			where	cd_conta_contabil = cd_conta_contabil_w;
		end if;

		cd_setor_entrega_w := '';
		if (ie_origem_documento_w = 2) and (nr_documento_w > 0) then

			select	max(cd_setor_entrega)
			into STRICT	cd_setor_entrega_w
			from	requisicao_material
			where	nr_requisicao = nr_documento_w;

		elsif (cd_setor_atendimento_w > 0) then
			cd_setor_entrega_w := cd_setor_atendimento_w;
		end if;


		insert into w_protheus_movto_estoque(
			nr_sequencia,
			ie_tipo_movimento,
			dt_movimento_estoque,
			cd_material,
			cd_centro_custo,
			vl_movimento,
			qt_movimento,
			nr_movimento_estoque,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			cd_unidade_medida_mov,
			cd_conta_contabil,
			ie_entrada_saida,
			cd_setor_entrega)
		values (	nextval('w_protheus_movto_estoque_seq'),
			'R',
			dt_movimento_estoque_w,
			cd_sistema_ant_w,
			cd_centro_custo_ww,
			vl_movimento_w,
			qt_movimento_w,
			nr_movimento_estoque_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			cd_unidade_medida_ww,
			cd_conta_contabil_ww,
			ie_entrada_saida_w,
			cd_setor_entrega_w);

	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_protheus_movto_estoque ( qt_horas_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

