-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_mov_mens (( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) is nr_contagem_benef_w bigint) RETURNS bigint AS $body$
DECLARE

nr_seq_mov_segurado_w	pls_mov_benef_segurado.nr_sequencia%type;
BEGIN
select	max(nr_sequencia)
into STRICT	nr_seq_mov_segurado_w
from	pls_mov_mens_benef
where	nr_seq_lote = nr_seq_lote_p
and	cd_usuario_plano = cd_usuario_plano_p;
return nr_seq_mov_segurado_w;
end;

function obter_seq_congenere(	cd_cooperativa_p	pls_congenere.cd_cooperativa%type)
					return number is
nr_seq_congenere_w	pls_congenere.nr_sequencia%type;
begin
select	max(nr_sequencia)
into STRICT	nr_seq_congenere_w
from	pls_congenere
where	cd_cooperativa = cd_cooperativa_p;
return nr_seq_congenere_w;
end;

begin

ie_gerou_w	:= 'N';

--Loop para percorrer todas as linhas do arquivo
for r_c01_w in C01 loop
	begin
	ds_conteudo_aux_w := replace(replace(r_c01_w.ds_conteudo,CHR(10),''),CHR(13),'');
	SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_linha_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_linha_w;
	if (ie_tipo_linha_w = '1') then -- Lote
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_seq_lote_ant_w) INTO STRICT ds_conteudo_aux_w, nr_seq_lote_ant_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_referencia_w) INTO STRICT ds_conteudo_aux_w, dt_referencia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_geracao_lote_w) INTO STRICT ds_conteudo_aux_w, dt_geracao_lote_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_movimento_inicial_w) INTO STRICT ds_conteudo_aux_w, dt_movimento_inicial_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_movimento_final_w) INTO STRICT ds_conteudo_aux_w, dt_movimento_final_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cooperativa_origem_w) INTO STRICT ds_conteudo_aux_w, cd_cooperativa_origem_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cooperativa_destino_w) INTO STRICT ds_conteudo_aux_w, cd_cooperativa_destino_w;
		
		nr_seq_congenere_destino_w	:= obter_seq_congenere(cd_cooperativa_destino_w);
		nr_seq_congenere_origem_w	:= obter_seq_congenere(cd_cooperativa_origem_w);
		
		insert	into	pls_mov_mens_lote(	nr_sequencia, nr_seq_regra, cd_estabelecimento,
				dt_referencia, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
				dt_movimento_inicial, dt_movimento_final, dt_geracao_lote, 
				ie_tipo_lote, dt_importacao, nr_seq_congenere_destino, nr_seq_congenere_origem)
			values (	nr_seq_lote_p, null, cd_estabelecimento_p, 
				dt_referencia_w, clock_timestamp(), 
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				to_date(dt_movimento_inicial_w,'ddmmYYYY'), to_date(dt_movimento_final_w,'ddmmYYYY'),clock_timestamp(),
				'R', clock_timestamp(), nr_seq_congenere_destino_w, nr_seq_congenere_origem_w);
		ie_gerou_w := 'S';		
	elsif (ie_tipo_linha_w = '2') then -- Benef
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		
		select  max(b.nr_sequencia)
		into STRICT    nr_seq_segurado_w
		from    pls_segurado_carteira a,
			pls_segurado b
		where   b.nr_sequencia    = a.nr_seq_segurado
		and    	a.cd_usuario_plano = cd_usuario_plano_w;
		
		insert	into	pls_mov_mens_benef(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, cd_usuario_plano, nr_seq_lote, nr_seq_segurado)
			values (	nextval('pls_mov_mens_benef_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p,	cd_usuario_plano_w , nr_seq_lote_p, nr_seq_segurado_w);
		ie_gerou_w := 'S';
	elsif (ie_tipo_linha_w = '3') then -- Item
	
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_item_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_item_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_inicio_cobertura_w) INTO STRICT ds_conteudo_aux_w, dt_inicio_cobertura_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_fim_cobertura_w) INTO STRICT ds_conteudo_aux_w, dt_fim_cobertura_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_item_w) INTO STRICT ds_conteudo_aux_w, vl_item_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_antecipacao_w) INTO STRICT ds_conteudo_aux_w, vl_antecipacao_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_cooperado_w) INTO STRICT ds_conteudo_aux_w, vl_ato_cooperado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_cooperado_antec_w) INTO STRICT ds_conteudo_aux_w, vl_ato_cooperado_antec_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_cooperado_pro_rata_w) INTO STRICT ds_conteudo_aux_w, vl_ato_cooperado_pro_rata_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_nao_coop_antec_w) INTO STRICT ds_conteudo_aux_w, vl_ato_nao_coop_antec_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_nao_cooperado_w) INTO STRICT ds_conteudo_aux_w, vl_ato_nao_cooperado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_nao_coop_pro_rata_w) INTO STRICT ds_conteudo_aux_w, vl_ato_nao_coop_pro_rata_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_pro_rata_dia_w) INTO STRICT ds_conteudo_aux_w, vl_pro_rata_dia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_auxiliar_w) INTO STRICT ds_conteudo_aux_w, vl_ato_auxiliar_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_auxiliar_antec_w) INTO STRICT ds_conteudo_aux_w, vl_ato_auxiliar_antec_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, vl_ato_auxiliar_pro_rata_w) INTO STRICT ds_conteudo_aux_w, vl_ato_auxiliar_pro_rata_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		
		nr_seq_mov_benef_w := obter_seq_mov_segurado(nr_seq_lote_p, cd_usuario_plano_w);
		
		insert	into	pls_mov_mens_benef_item(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_mov_benef, 
				dt_inicio_cobertura, dt_fim_cobertura, ie_tipo_item,
				vl_antecipacao, vl_ato_auxiliar, vl_ato_auxiliar_antec,
				vl_ato_auxiliar_pro_rata, vl_ato_cooperado, vl_ato_cooperado_antec,
				vl_ato_cooperado_pro_rata, vl_ato_nao_coop_antec, vl_ato_nao_cooperado,
				vl_ato_nao_coop_pro_rata, vl_item, vl_pro_rata_dia)
				
		values (	nextval('pls_mov_mens_benef_item_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), 
				nm_usuario_p, nr_seq_mov_benef_w,
				dt_inicio_cobertura_w, dt_fim_cobertura_w, ie_tipo_item_w,
				to_number(vl_antecipacao_w, '999999990D99'), to_number(vl_ato_auxiliar_w, '999999990D99'), to_number(vl_ato_auxiliar_antec_w, '999999990D99'),
				to_number(vl_ato_auxiliar_pro_rata_w, '999999990D99'), to_number(vl_ato_cooperado_w, '999999990D99'), to_number(vl_ato_cooperado_antec_w, '999999990D99'),
				to_number(vl_ato_cooperado_pro_rata_w, '999999990D99'), to_number(vl_ato_nao_coop_antec_w, '999999990D99'), to_number(vl_ato_nao_cooperado_w, '999999990D99'),
				to_number(vl_ato_nao_coop_pro_rata_w, '999999990D99'), to_number(vl_item_w, '999999990D99'), to_number(vl_pro_rata_dia_w, '999999990D99'));
		ie_gerou_w := 'S';
	end if;
	end;
end loop;

if (ie_gerou_w = 'N') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1076160);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_mov_mens (( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) is nr_contagem_benef_w bigint) FROM PUBLIC;

