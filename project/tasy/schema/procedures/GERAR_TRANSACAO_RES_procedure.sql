-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transacao_res ( nr_atendimento_p bigint, cd_transacao_p text, nm_usuario_p text, cd_convenio_p bigint default null, nr_seq_prontuario_p text default null, ie_tipo_inativacao_p text default null, nr_sequencia_anexo_p text default null) AS $body$
DECLARE


ie_resUnimed_w			varchar(1);
ie_resPhilips_w			varchar(1);

ds_param_integ_hl7_w 	varchar(4000);
cd_convenio_w			integer;
ie_atualiza_w			varchar(1);
cd_pessoa_fisica_w		varchar(10);
ie_privacidade_w		varchar(1);
cd_pf_usuario_w			varchar(10);
nr_seq_idioma_w			bigint;
cd_estabelecimento_w	varchar(50) := obter_estabelecimento_ativo;
cd_interno_w			conversao_meio_externo.cd_interno%type;
qt_dias_retroativo_w	conversao_meio_externo.cd_interno%type;
ds_patient_id_w			varchar(255);
ds_creationTimeFrom_w	varchar(255);
ds_creationTimeTo_w		varchar(255);
ds_retorno_integracao_w varchar(4000);



BEGIN

If ( coalesce(nr_atendimento_p,0) > 0 ) then

	begin

	nr_seq_idioma_w := wheb_usuario_pck.get_nr_seq_idioma;

	cd_pf_usuario_w := Obter_Pf_Usuario(nm_usuario_p, 'C');

	cd_convenio_w := coalesce(cd_convenio_p,0);

	Select 	obter_pessoa_atendimento(nr_atendimento_p,'C')
	into STRICT	cd_pessoa_fisica_w
	;

	if ( cd_convenio_w = 0) then

		Select  Obter_Convenio_Atendimento(nr_atendimento_p)
		into STRICT	cd_convenio_w
		;		

	end if;	

	if (cd_convenio_w > 0) then	

		if ( cd_transacao_p = '01000' ) then

			Select  coalesce(max('S'),'N')
			into STRICT	ie_resPhilips_w
			from    conversao_meio_externo
			where   upper(cd_externo) = 'RESPHILIPS'
			and		upper(nm_tabela) = 'ATEND_CATEGORIA_CONVENIO'
			and     cd_interno = to_char(cd_convenio_w);



			if (ie_resPhilips_w = 'N') then

				Select  coalesce(max('S'),'N')
				into STRICT	ie_resPhilips_w
				from    res_envio a,
						res_envio_protocolo e
				where   e.nr_seq_envio = a.nr_sequencia
				and     coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w
				and     coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w;

			end if;


			if ( ie_resPhilips_w = 'S') then

					Select  coalesce(max('S'),'N')
					into STRICT	ie_privacidade_w
					from	pep_pac_ci a,
							pep_pac_ci_anexo b
					where	a.cd_pessoa_fisica = cd_pessoa_fisica_w
					and		b.nr_seq_pac_ci = a.nr_sequencia
					and		a.ie_tipo_consentimento = 'L'
					and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
					and		coalesce(a.dt_inativacao::text, '') = ''
					and		(b.ds_arquivo IS NOT NULL AND b.ds_arquivo::text <> '');
					--and		obter_se_prontuario_envio(a.cd_pessoa_fisica) = 'S';
					if ( ie_privacidade_w = 'S' ) then

						ie_privacidade_w := 'S';

					end if;	

			end if;	


		elsif ( cd_transacao_p = '01100' ) then				

				Select  coalesce(max('S'),'N')
				into STRICT	ie_resPhilips_w
				from    conversao_meio_externo
				where   upper(cd_externo) = 'RESPHILIPS'
				and		upper(nm_tabela) = 'ATEND_CATEGORIA_CONVENIO'
				and     cd_interno = to_char(cd_convenio_w);


				if ( ie_resPhilips_w = 'S') then

					Select  max(cd_interno)
					into STRICT	cd_interno_w
					from    conversao_meio_externo
					where   upper(cd_externo) = 'OID'
					and		upper(nm_tabela) = 'RES_ENVIO';

					if (cd_interno_w IS NOT NULL AND cd_interno_w::text <> '') then

						if (cd_interno_w = '2.16.840.1.113883.13.237') then -- CPF
							Select  max(nr_cpf)
							into STRICT	ds_patient_id_w
							from 	pessoa_fisica
							where	cd_pessoa_fisica = cd_pessoa_fisica_w;

						elsif (cd_interno_w = '2.16.840.1.113883.13.236') then -- CNS
							Select  max(nr_cartao_nac_sus)
							into STRICT	ds_patient_id_w
							from 	pessoa_fisica
							where	cd_pessoa_fisica = cd_pessoa_fisica_w;	


						end if;

						if (ds_patient_id_w IS NOT NULL AND ds_patient_id_w::text <> '') then

							Select  coalesce(max(cd_interno),'30')
							into STRICT	qt_dias_retroativo_w
							from    conversao_meio_externo
							where   upper(cd_externo) = 'QT_DIAS_RETROATIVOS'
							and		upper(nm_tabela) = 'RES_ENVIO';

							Select 	to_char(clock_timestamp() - (somente_numero(qt_dias_retroativo_w)),'yyyymmdd'),
									to_char(clock_timestamp(),'yyyymmdd')
							into STRICT	ds_creationTimeFrom_w,
									ds_creationTimeTo_w
							;


							SELECT BIFROST.SEND_INTEGRATION(
							'patientDocument',
							'com.philips.tasy.integration.atepac.documents.Document',
							'{"patientID" : '||'"'||ds_patient_id_w ||'"'||','||
							'"patientsOID" : '||'"'|| cd_interno_w ||'"'||','||
							'"creationTimeFrom" : '||'"'|| ds_creationTimeFrom_w || '"'||','||
							'"creationTimeTo" : '||'"'|| ds_creationTimeTo_w ||'"'|| '} ',
							nm_usuario_p)
							INTO STRICT ds_retorno_integracao_w
							;

						end if;

					end if;

				end if;

		else

			Select  coalesce(max('S'),'N')
			into STRICT	ie_resUnimed_w
			from    conversao_meio_externo
			where   upper(cd_externo) = 'RESUNIMED'
			and		upper(nm_tabela) = 'ATEND_CATEGORIA_CONVENIO'
			and     cd_interno = to_char(cd_convenio_w);

			if ( ie_resUnimed_w = 'S') then

				if (cd_transacao_p = '00710') then
					ie_privacidade_w := 'S';
				elsif (cd_transacao_p = '00790') then
					Select  coalesce(max('S'),'N')
					into STRICT	ie_privacidade_w
					from	pep_pac_ci_anexo
					where	nr_seq_pac_ci = nr_sequencia_anexo_p;
				else
				  Select  coalesce(max('S'),'N')
					into STRICT	ie_privacidade_w
				  from	pep_pac_ci_anexo
							where	nr_seq_pac_ci = (
					SELECT MAX(nr_sequencia)
					from PEP_PAC_CI pac
					where pac.cd_pessoa_fisica = cd_pessoa_fisica_w
						AND pac.ie_situacao = 'A');
				end if;

				if (ie_privacidade_w = 'S') then

					ds_param_integ_hl7_w := 'nr_seq_prontuario_emissao=' || nr_seq_prontuario_p  || ';' ||
											'nr_atendimento='             || nr_atendimento_p            || ';' ||
											'cd_transacao='               || cd_transacao_p       || ';' ||
											'nm_usuario_solic='               || nm_usuario_p      || ';' ||
											'cd_pf_usuario='               || cd_pf_usuario_w      || ';' ||
											'nr_seq_idioma='               || nr_seq_idioma_w      || ';' ||
											'cd_estabelecimento='               || cd_estabelecimento_w      || ';' ||
											'ie_tipo_inativacao='         || ie_tipo_inativacao_p || ';';


						CALL gravar_agend_integracao(682, ds_param_integ_hl7_w);			
				end if;			
		end if;		
		end if;		
	end if;

	exception
	when others then
      	ie_resUnimed_w := 'N';
	end;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transacao_res ( nr_atendimento_p bigint, cd_transacao_p text, nm_usuario_p text, cd_convenio_p bigint default null, nr_seq_prontuario_p text default null, ie_tipo_inativacao_p text default null, nr_sequencia_anexo_p text default null) FROM PUBLIC;

