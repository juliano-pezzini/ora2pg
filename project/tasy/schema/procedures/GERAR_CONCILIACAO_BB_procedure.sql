-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conciliacao_bb (nr_seq_extrato_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* layout de 200 posições */

vl_saldo_inicial_w	double precision;
vl_saldo_final_w	double precision;
dt_saldo_inicial_w	timestamp;
dt_saldo_final_w	timestamp;
cd_agencia_w		varchar(4);--number(4);
cd_conta_w		varchar(12);--number(7);
cd_historico_w		varchar(4);
ds_historico_w		varchar(25);
ie_natureza_w		varchar(15);
nr_documento_w		integer;
dt_movto_w		timestamp;
vl_extrato_w		double precision;
ie_deb_cred_w		varchar(1);
cd_categoria_w		varchar(3);
nr_seq_conta_w		bigint;
nr_lote_w		varchar(30);

c01 CURSOR FOR
SELECT	substr(ds_conteudo,18,4) cd_agencia,
	substr(ds_conteudo,30,12) cd_conta,
	substr(ds_conteudo,43,3) cd_categoria,
	substr(ds_conteudo,46,4) cd_historico,
	substr(ds_conteudo,50,25) ds_historico,
	somente_numero(substr(ds_conteudo,75,6)) nr_documento,
	substr(ds_conteudo,182,8) dt_movto,
	somente_numero(substr(ds_conteudo,87,16)) || ',' || substr(ds_conteudo,103,2) vl_extrato,
	CASE WHEN substr(ds_conteudo,43,1)=1 THEN 'D'  ELSE 'C' END  ie_deb_cred,
	substr(ds_conteudo,111,5) nr_lote
from	w_interf_concil
where	substr(ds_conteudo,1,1)		= '1'
and	substr(ds_conteudo,42,1)	= '1'
and	nr_seq_conta			= nr_seq_conta_w
and	nm_usuario			= nm_usuario_p;


BEGIN

select	nr_seq_conta
into STRICT	nr_seq_conta_w
from	banco_extrato
where	nr_sequencia	= nr_seq_extrato_p;

select	max((substr(ds_conteudo,87,16) || ',' || substr(ds_conteudo,103,2))::numeric ) vl_extrato,
	max(to_date(substr(ds_conteudo,182,8),'ddmmyyyy')) dt_movto
into STRICT	vl_saldo_inicial_w,
	dt_saldo_inicial_w
from	w_interf_concil
where	substr(ds_conteudo,1,1) = '1'
and	substr(ds_conteudo,42,1) = '0'
and	substr(ds_conteudo,182,8) <> '        '
and	nm_usuario		= nm_usuario_p;

select	max((substr(ds_conteudo,87,16) || ',' || substr(ds_conteudo,103,2))::numeric ) vl_extrato,
	max(to_date(substr(ds_conteudo,182,8),'ddmmyyyy')) dt_movto
into STRICT	vl_saldo_final_w,
	dt_saldo_final_w
from	w_interf_concil
where	substr(ds_conteudo,1,1)		= '1'
and	substr(ds_conteudo,42,1)	= '2'
and	substr(ds_conteudo,182,8)	<> '        '
and	nm_usuario		= nm_usuario_p;

open c01;
loop
fetch c01 into
	cd_agencia_w,
	cd_conta_w,
	cd_categoria_w,
	cd_historico_w,
	ds_historico_w,
	nr_documento_w,
	dt_movto_w,
	vl_extrato_w,
	ie_deb_cred_w,
	nr_lote_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_natureza_w	:= 'D';

	/*OS73534. 16/11/2007. Incluído o If abaixo para jogar como bloqueado quando o histórico for um desses.*/

	if (coalesce(cd_historico_w,'0') in ('0911','0912','0913','0914','0915','0916','0917','0918','0919')) then
		ie_natureza_w	:= 'B';
	end if;

	insert into banco_extrato_lanc(cd_agencia_origem,
		cd_categoria,
		cd_historico,
		ds_historico,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_movimento,
		ie_conciliacao,
		ie_deb_cred,
		nm_usuario,
		nm_usuario_nrec,
		nr_documento,
		nr_seq_extrato,
		nr_sequencia,
		vl_lancamento,
		nr_lote,
		ie_natureza)
	values (cd_agencia_w,
		cd_categoria_w,
		cd_historico_w,
		ds_historico_w,
		clock_timestamp(),
		clock_timestamp(),
		dt_movto_w,
		'N',
		ie_deb_cred_w,
		nm_usuario_p,
		nm_usuario_p,
		nr_documento_w,
		nr_seq_extrato_p,
		nextval('banco_extrato_lanc_seq'),
		vl_extrato_w,
		nr_lote_w,
		ie_natureza_w);
end loop;
close c01;

update	banco_extrato
set	vl_saldo_inicial = vl_saldo_inicial_w,
	vl_saldo_final	= vl_saldo_final_w,
	dt_inicio	= dt_saldo_inicial_w,
	dt_final	= dt_saldo_final_w
where	nr_sequencia	= nr_seq_extrato_p;

delete	from w_interf_concil
where	nm_usuario	= nm_usuario_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conciliacao_bb (nr_seq_extrato_p bigint, nm_usuario_p text) FROM PUBLIC;

