-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ispg_gerar_relat_matricial (nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nm_paciente_w			varchar(255);
nr_atendimento_w		varchar(255);
nr_prescricao_w			varchar(255);
nm_medico_w				varchar(255);
dt_prescricao_w			varchar(255);
ds_convenio_w			varchar(255);
ds_setor_atendimento_w	varchar(255);
nr_telefone_w			varchar(255);
ds_grupo_exame_lab_w	varchar(255);
nm_exame_cab_w			varchar(255);
ie_urgencia_w			varchar(255);
ds_observacao_w			varchar(255);
nr_seq_grupo_par_w		bigint;
ds_idade_w				varchar(255);
hr_atendimento_w		varchar(255);
dt_impressao_w			varchar(255);
dt_entrega_w			varchar(255);
ie_sexo_w				varchar(255);
ds_exame_w				varchar(255);
ie_quebra_w				varchar(255);
nr_seq_grupo_w			bigint;
nm_exame1_w				varchar(255);
nm_exame2_w				varchar(255);
nr_seq_formato_w		bigint;
qt_linhas_w				bigint;
nr_pagina_w				bigint;
nr_sequencia_w			bigint;

nr_linha_w				bigint;
cont_w					bigint;
nr_total_w				bigint;

c01 CURSOR FOR 
SELECT	distinct 
	g.nm_paciente, 
	(obter_desc_expressao(344885)/*'Atend.: '*/
 || g.nr_atendimento), 
	a.nr_prescricao, 
	('Dr(a).:  ' || substr(obter_nome_pf(a.cd_medico), 1, 30)) nm_medico, 
	(obter_desc_expressao(284403)/*'Cadastro: '*/
 ||': '|| to_char(a.dt_prescricao,'dd/mm/yyyy hh24:mi:ss')) dt_prescricao, 
	(obter_desc_expressao(326148)/*'Convênio: '*/
 || g.ds_convenio) ds_convenio, 
	g.ds_setor_atendimento, 
	('Fone: ' || coalesce(g.nr_telefone_celular, obter_compl_pf(g.cd_pessoa_fisica, 1, 'T'))) nr_telefone, 
	e.ds_grupo_exame_lab, 
	' ' nm_exame_cab, 
	CASE WHEN b.ie_urgencia='S' THEN  'Urgente'  ELSE '' END  ie_urgencia, 
	('Obs.:' || substr(replace(a.ds_dado_clinico, chr(13) || chr(10), '/ '), 1, 80)) ds_observacao, 
	l.nr_seq_grupo nr_seq_grupo_par, 
	(obter_desc_expressao(326096)/*'Idade: '*/
 || substr(obter_idade(g.dt_nascimento, a.dt_prescricao, 'AM'), 1, 10)) ds_idade, 
	to_char(g.hr_inicio_prescricao, 'hh24:mi:ss') hr_atendimento, 
	(obter_desc_expressao(291738)/*'Impressão: '*/
 ||': '|| to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')) dt_impressao, 
	(obter_desc_expressao(289280)/*'Entrega: '*/
 ||': '|| to_char(a.dt_entrega, 'dd/mm/yyyy hh24:mi:ss')) dt_entrega, 
	('Sexo: ' || g.ie_sexo) ie_sexo, 
	(obter_desc_expressao(289728)/*'Exames: '*/
 ||': '|| substr(obter_exames_prescr_lab(a.nr_prescricao, null, null, null, null, 'CE', ';', 0), 1, 200)) ds_exame, 
	e.ds_grupo_exame_lab ie_quebra, 
	l.nr_seq_grupo nr_seq_grupo 
from	atendimento_paciente_v g, 
	grupo_exame_lab e, 
	exame_laboratorio l, 
	material_exame_lab f, 
	prescr_procedimento b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	a.nr_atendimento	= g.nr_atendimento 
and	e.nr_sequencia		= l.nr_seq_grupo 
and	b.cd_material_exame	= f.cd_material_exame 
and	b.nr_seq_exame		= l.nr_seq_exame 
and	a.nr_prescricao		= nr_prescricao_p 
and	(obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M') IS NOT NULL AND (obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M'))::text <> '') 
order by  e.ds_grupo_exame_lab;

c02 CURSOR FOR 
SELECT	nr_seq_formato, 
	round(count(*) /2) qt_linhas 
from	exame_lab_format_item 
where	nr_seq_formato in ( 
	SELECT	distinct obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M') 
	from	grupo_exame_lab e, 
		exame_laboratorio l, 
		material_exame_lab f, 
		prescr_procedimento b, 
		prescr_medica a 
	where	a.nr_prescricao		= b.nr_prescricao 
	and	e.nr_sequencia		= l.nr_seq_grupo 
	and	b.cd_material_exame	= f.cd_material_exame 
	and	b.nr_seq_exame		= l.nr_seq_exame 
	and	a.nr_prescricao		= nr_prescricao_p 
	and	e.nr_sequencia		= nr_seq_grupo_par_w 
	and	(obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M') IS NOT NULL AND (obter_formato_exame(b.nr_seq_exame, f.nr_sequencia, null, 'M'))::text <> '')) 
group by nr_seq_formato;

c03 CURSOR FOR 
SELECT	substr(LAB_OBTER_FORMATO_ITEM(nr_seq_formato_par2,(nr_linha_par*2) -1) || '.................',1,20) || ':________________' nm_exame1, 
	substr(LAB_OBTER_FORMATO_ITEM(nr_seq_formato_par2,(nr_linha_par*2)) || '.................',1,20) || ':________________' nm_exame2 
from ( 
	SELECT	nr_seq_formato_w	nr_seq_formato_par2, 
		row_number() OVER () AS nr_linha_par 
	from	tabela_sistema LIMIT (qt_linhas_w)) alias6;

 

BEGIN 
 
delete	from w_mapa_lab_ispg 
where	nm_usuario	= nm_usuario_p;
 
commit;
 
nr_pagina_w	:= 0;
nr_linha_w	:= 0;
 
open c01;
loop 
fetch c01 into 
	nm_paciente_w, 
	nr_atendimento_w, 
	nr_prescricao_w, 
	nm_medico_w, 
	dt_prescricao_w, 
	ds_convenio_w, 
	ds_setor_atendimento_w, 
	nr_telefone_w, 
	ds_grupo_exame_lab_w, 
	nm_exame_cab_w, 
	ie_urgencia_w, 
	ds_observacao_w, 
	nr_seq_grupo_par_w, 
	ds_idade_w, 
	hr_atendimento_w, 
	dt_impressao_w, 
	dt_entrega_w, 
	ie_sexo_w, 
	ds_exame_w, 
	ie_quebra_w, 
	nr_seq_grupo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 substr(obter_nome_estabelecimento(cd_estabelecimento_p), 1, 30), 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 'Mapa de Trabalho por Paciente Setor', 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 '=============================================================', 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nr_prescricao_w || '  ' || nm_paciente_w || '  ' || dt_prescricao_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_convenio_w || '  ' || dt_impressao_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nm_medico_w || '  ' || dt_entrega_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	nr_pagina_w	:= nr_pagina_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 nr_telefone_w || '  ' || ds_idade_w || '  Pág.: ' || nr_pagina_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_observacao_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 ds_exame_w, 
		 nm_usuario_p);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nr_linha, 
		 ds_linha, 
		 nm_usuario) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nr_linha_w, 
		 '-------------------------- ' || ds_grupo_exame_lab_w, 
		 nm_usuario_p);
 
	cont_w	:= 0;
 
	open c02;
	loop 
	fetch c02 into 
		nr_seq_formato_w, 
		qt_linhas_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		open c03;
		loop 
		fetch c03 into 
			nm_exame1_w, 
			nm_exame2_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
 
			if (cont_w	< 22) then 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_exame1_w || '  ' || nm_exame2_w, 
					 nm_usuario_p);
				cont_w		:= cont_w + 1;
			else 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 '', 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 substr(obter_nome_estabelecimento(cd_estabelecimento_p), 1, 30), 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 'Mapa de Trabalho por Paciente Setor', 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 '====================================================', 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nr_prescricao_w || '  ' || nm_paciente_w || '  ' || dt_prescricao_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_convenio_w || '  ' || dt_impressao_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_medico_w || '  ' || dt_entrega_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_pagina_w	:= nr_pagina_w + 1;
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nr_telefone_w || '  ' || ds_idade_w || '  Pág.: ' || nr_pagina_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_observacao_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 ds_exame_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 '-------------------------- ' || ds_grupo_exame_lab_w, 
					 nm_usuario_p);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nr_linha, 
					 ds_linha, 
					 nm_usuario) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nr_linha_w, 
					 nm_exame1_w || '  ' || nm_exame2_w, 
					 nm_usuario_p);
 
				cont_w	:= 0;
 
			end if;
 
		end loop;
		close c03;
 
	end loop;
	close c02;
 
	select	max(nr_linha) 
	into STRICT	nr_total_w 
	from	w_mapa_lab_ispg 
	where	nm_usuario	= nm_usuario_p;
 
	if (mod(nr_total_w, 33) <> 1) then 
		while(mod(nr_total_w, 33) <> 1) loop 
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nr_linha, 
				 ds_linha, 
				 nm_usuario) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nr_linha_w, 
				 '', 
				 nm_usuario_p);
			nr_total_w	:= nr_total_w + 1;
		end loop;
	end if;
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ispg_gerar_relat_matricial (nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

