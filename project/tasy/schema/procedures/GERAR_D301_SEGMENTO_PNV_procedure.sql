-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_pnv ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_usuario_convenio_w		d301_segmento_pnv.cd_usuario_convenio%type;
cd_identificacao_pessoa_w	d301_segmento_pnv.cd_identificacao_pessoa%type;
ds_dt_validade_w		d301_segmento_pnv.ds_dt_validade%type;
nr_ik_hospital_w		d301_segmento_pnv.nr_ik_hospital%type;
nr_episodio_convenio_w		d301_segmento_pnv.nr_episodio_convenio%type;
nr_arquivo_convenio_w		d301_segmento_pnv.nr_arquivo_convenio%type;
ds_dt_inicio_cobert_conv_w	d301_segmento_pnv.ds_dt_inicio_cobert_conv%type;
nr_contrato_conv_w		d301_segmento_pnv.nr_contrato_conv%type;
ds_nome_w			d301_segmento_pnv.ds_nome%type;
ds_primeiro_nome_w		d301_segmento_pnv.ds_primeiro_nome%type;

nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ie_tipo_conveniado_w		atend_categoria_convenio.ie_tipo_conveniado%type;
ie_tipo_doenca_w		diagnostico_doenca.ie_tipo_doenca%type;



BEGIN

nr_arquivo_convenio_w		:= null;
nr_contrato_conv_w		:= '00xxxxxxx'; --Pendente de definição
select	nr_atendimento
into STRICT	nr_atendimento_w
from	d301_dataset_envio
where	nr_sequencia = nr_seq_dataset_p;

select	substr(max(a.cd_usuario_convenio),1,12),
	max(to_char(dt_validade_carteira,'YYMM')), --AJUSTADA A MASCARA
	substr(max(a.cd_complemento),1,5),
	max(coalesce(a.nr_doc_convenio,e.nr_sequencia)),
	max(to_char(dt_inicio_vigencia,'YYYYMMDD')),
	substr(max(f.cd_interno),1,15)
into STRICT	cd_usuario_convenio_w,
	ds_dt_validade_w,
	cd_identificacao_pessoa_w,
	nr_episodio_convenio_w,
	ds_dt_inicio_cobert_conv_w,
	nr_ik_hospital_w
from	atend_categoria_convenio a,
	atendimento_paciente b,
	pessoa_fisica d,
	episodio_paciente e,
	convenio_estabelecimento f
where	a.nr_atendimento 	= b.nr_atendimento
and	b.cd_pessoa_fisica 	= d.cd_pessoa_fisica
and	d.cd_pessoa_fisica	= e.cd_pessoa_fisica
and	a.cd_convenio		= f.cd_convenio
and	f.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_seq_interno 	= obter_atecaco_atendimento(nr_atendimento_w);

insert into D301_SEGMENTO_PNV(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_dataset,
	cd_usuario_convenio,
	cd_identificacao_pessoa,
	ds_dt_validade,
	nr_ik_hospital,
	nr_episodio_convenio,
	nr_arquivo_convenio,
	ds_dt_inicio_cobert_conv,
	nr_contrato_conv,
	ds_nome,
	ds_primeiro_nome)
values (	nextval('d301_segmento_pnv_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_dataset_p,
	cd_usuario_convenio_w,
	cd_identificacao_pessoa_w,
	ds_dt_validade_w,
	nr_ik_hospital_w,
	nr_episodio_convenio_w,
	nr_arquivo_convenio_w,
	ds_dt_inicio_cobert_conv_w,
	nr_contrato_conv_w,
	ds_nome_w,
	ds_primeiro_nome_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_pnv ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

