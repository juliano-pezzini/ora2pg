-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_medicamento_cih ( nr_seq_prescr_mat_p bigint, nr_prescricao_p bigint, ds_comunicado_p text, ie_reprovacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_medicamento_p text default '', nr_seq_motivo_reprov_p bigint default null) AS $body$
DECLARE


ie_enviar_comunic_reprov_w	varchar(1);				
ds_usuario_medico_w		varchar(255);
ie_alerta_reprov_medicamento_w	varchar(1);	
nr_atendimento_w		bigint;
ds_alerta_w			varchar(2000);
nr_prescricao_w			bigint;
ds_material_w			varchar(255);
nm_medico_w			varchar(255);
ds_reprov_ccih_w		varchar(2000);
ds_perfil_adicional_w		varchar(255);
nm_pessoa_fisica_w		varchar(255);
ds_acao_w			varchar(255);
ds_comunicado_formatado_w	varchar(2000);
	

BEGIN

select	obter_usuario_pessoa(c.cd_medico),
	c.nr_atendimento,
	a.nr_prescricao,
	b.ds_material,
	obter_pessoa_fisica_usuario(nm_usuario_p,'N'),
	ds_reprov_ccih
into STRICT	ds_usuario_medico_w,
	nr_atendimento_w,
	nr_prescricao_w,
	ds_material_w,
	nm_medico_w,
	ds_reprov_ccih_w
from	material b,
	prescr_medica c,
	prescr_material  a
where	a.cd_material	= b.cd_material
and	c.nr_prescricao	= a.nr_prescricao
and	a.nr_prescricao	= nr_prescricao_p
and	a.nr_sequencia	= nr_seq_prescr_mat_p;

if (ie_reprovacao_p = 'S') then
	begin
	update	prescr_material
	set		ds_reprov_ccih	= substr(ds_comunicado_p,1,2000),
			nr_seq_motivo_reprov = nr_seq_motivo_reprov_p,
			dt_aprovacao_cih  = clock_timestamp(),
			qt_dias_liberado  = 0,
			nm_usuario_liberacao = nm_usuario_p
	where	nr_sequencia	= nr_seq_prescr_mat_p
	and	nr_prescricao	= nr_prescricao_p;
	
	ds_acao_w := wheb_mensagem_pck.get_texto(307897); -- Reprovação
	end;
else
	begin
	update	prescr_material
	set	ds_reprov_ccih	= substr(ds_comunicado_p,1,2000),
		nr_seq_motivo_reprov = nr_seq_motivo_reprov_p,
		dt_aprovacao_cih  = clock_timestamp(),
		nm_usuario_liberacao = nm_usuario_p
	where	nr_sequencia	= nr_seq_prescr_mat_p
	and	nr_prescricao	= nr_prescricao_p;
	
	ds_acao_w := wheb_mensagem_pck.get_texto(307898); -- Liberação parcial
	end;
end if;

select 	max(obter_pessoa_atendimento(nr_atendimento_w,'N'))
into STRICT	nm_pessoa_fisica_w
;

ds_comunicado_formatado_w := substr(wheb_mensagem_pck.get_texto(307900,	'NR_PRESCRICAO_P=' || nr_prescricao_p || ';' ||
																	'NM_PESSOA_FISICA_W=' || nm_pessoa_fisica_w || ';' ||
																	'DS_MEDICAMENTO_P=' || ds_medicamento_p || ';' ||
																	'DS_ACAO_W=' || ds_acao_w || ';' ||
																	'DS_COMUNICADO_P=' || ds_comunicado_p),1,2000);
						/*
							 Nº prescrição: #@NR_PRESCRICAO_P#@
							 Paciente: #@NM_PESSOA_FISICA_W#@
							 Medicamento: #@DS_MEDICAMENTO_P#@
			@cih@				 Ação: #@DS_ACAO_W#@
							 
							 Motivo: #@DS_COMUNICADO_P#@
						*/
ds_perfil_adicional_w := Obter_Param_Usuario(896, 31, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_perfil_adicional_w);
ie_enviar_comunic_reprov_w := Obter_Param_Usuario(896, 16, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_enviar_comunic_reprov_w);
if (ie_enviar_comunic_reprov_w = 'S') then
	CALL Gerar_Comunic_Padrao(	clock_timestamp(),
				wheb_mensagem_pck.get_texto(307902), -- Comunicado CCIH
				ds_comunicado_formatado_w,
				nm_usuario_p,
				'N',
				ds_usuario_medico_w,
				'N',
				'',
				ds_perfil_adicional_w || ', ',
				'',
				'',
				clock_timestamp(),
				'',
				'' );
end if;

ie_alerta_reprov_medicamento_w := Obter_Param_Usuario(896, 18, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_alerta_reprov_medicamento_w);
if (ie_alerta_reprov_medicamento_w	= 'S') then
	
	select	max(ds_reprov_ccih)
	into STRICT	ds_reprov_ccih_w
        from	prescr_material
        where	nr_prescricao	= nr_prescricao_p;
		
	ds_alerta_w	:=	substr(wheb_mensagem_pck.get_texto(307903,	'NR_PRESCRICAO_W=' || nr_prescricao_w || ';' ||
																'DS_MATERIAL_W=' || ds_material_w || ';' ||
																'NM_MEDICO_W=' || nm_medico_w || ';' ||
																'DS_REPROV_CCIH_W=' || ds_reprov_ccih_w),1,2000);	
					/*
						Nº prescrição: #@NR_PRESCRICAO_W#@
						Medicamento: #@DS_MATERIAL_W#@
						Médico: #@NM_MEDICO_W#@
						Motivo de reprovação ou liberação parcial: #@DS_REPROV_CCIH_W#@
					*/
	CALL inserir_atend_alertas_cih(	nr_atendimento_w,
					ds_alerta_w,
					nm_usuario_p,
					nr_prescricao_p ); 	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_medicamento_cih ( nr_seq_prescr_mat_p bigint, nr_prescricao_p bigint, ds_comunicado_p text, ie_reprovacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_medicamento_p text default '', nr_seq_motivo_reprov_p bigint default null) FROM PUBLIC;

