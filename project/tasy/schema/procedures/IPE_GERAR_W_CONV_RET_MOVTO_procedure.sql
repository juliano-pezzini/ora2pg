-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ipe_gerar_w_conv_ret_movto (nr_seq_retorno_p bigint) AS $body$
DECLARE

 
nr_registro_w		varchar(255);
cd_prestador_w		varchar(255);
vl_total_pago_w		varchar(255);
cd_autorizacao_w		varchar(255);
nr_doc_convenio_w	varchar(255);
vl_glosa_w		varchar(255);
vl_cobrado_w		varchar(255);
vl_total_pago_55_w	varchar(255);
vl_glosa_55_w		varchar(255);
nr_doc_convenio_princ_w	varchar(255);
cd_autorizacao_princ_w	varchar(255);
cd_usuario_convenio_w	varchar(255);
ds_complemento_w	varchar(255);
nr_conta_w		varchar(255);
nr_tipo_nota_w		varchar(255);
nr_sequencia		bigint;
nr_seq_cabecalho_w	bigint;
sqlerrm_w		varchar(255);

c01 CURSOR FOR 
SELECT	nr_sequencia, 
	substr(ds_conteudo,3,02), 
	substr(ds_conteudo,01,02), 
	'', 
	substr(ds_conteudo,9,06), 
	substr(ds_conteudo,47,5), 
	substr(ds_conteudo,47,5), 
	(0)::numeric , 
	somente_numero(substr(ds_conteudo,52,13)), 
	somente_numero(substr(ds_conteudo,65,9)), 
	'', 
	(0)::numeric , 
	(0)::numeric  
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,3,02) = '55') 
and (substr(ds_conteudo,01,02) = '00') 

union all
 
SELECT	nr_sequencia, 
	substr(ds_conteudo,3,02), 
	'', 
	substr(ds_conteudo,3,13), 
	'', 
	'', 
	'', 
	somente_numero(substr(ds_conteudo,100,13)), 
	(0)::numeric , 
	(0)::numeric , 
	substr(ds_conteudo,55,45), 
	somente_numero(substr(ds_conteudo,113,13)), 
	somente_numero(substr(ds_conteudo,126,09)) 
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,3,02) = '55') 
and (substr(ds_conteudo,41,14) = '91162511000165') 
and (substr(ds_conteudo,01,02) = '00') 

union all
 
select	nr_sequencia, 
	substr(ds_conteudo,16,02), 
	substr(ds_conteudo,14,02), 
	substr(ds_conteudo,20,13), 
	substr(ds_conteudo,41,06), 
	substr(ds_conteudo,62,06), 
	substr(ds_conteudo,62,06), 
	(0)::numeric , 
	somente_numero(substr(ds_conteudo,146,13)), 
	somente_numero(substr(ds_conteudo,159,9)), 
	'', 
	(0)::numeric , 
	(0)::numeric  
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,16,02) = '75' or substr(ds_conteudo,16,02) = '85') 
and (substr(ds_conteudo,14,02) = '00') 

union all
 
select	nr_Sequencia, 
	substr(ds_conteudo,16,02), 
	'', 
	'', 
	'', 
	'', 
	'', 
	somente_numero(substr(ds_conteudo,59,11)), 
	(0)::numeric , 
	(0)::numeric , 
	'', 
	somente_numero(substr(ds_conteudo,70,13)), 
	somente_numero(substr(ds_conteudo,83,9)) 
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,16,02) = '75' or substr(ds_conteudo,16,02) = '85') 
and (substr(ds_conteudo,24,14) = '91162511000165') 
and (substr(ds_conteudo,14,02) <> '00') 

union all
 
select	nr_sequencia, 
	substr(ds_conteudo,16,02), 
	substr(ds_conteudo,14,02), 
	substr(ds_conteudo,20,13), 
	substr(ds_conteudo,41,06), 
	substr(ds_conteudo,62,06), 
	substr(ds_conteudo,62,06), 
	(0)::numeric , 
	somente_numero(substr(ds_conteudo,159,13)), 
	somente_numero(substr(ds_conteudo,172,09)), 
	'', 
	(0)::numeric , 
	(0)::numeric  
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,16,02) = '76' or substr(ds_conteudo,16,02) = '86') 
and (substr(ds_conteudo,14,02) = '00') 

union all
 
select	nr_sequencia, 
	substr(ds_conteudo,16,02), 
	'', 
	'', 
	'', 
	'', 
	'', 
	somente_numero(substr(ds_conteudo,59,11)), 
	(0)::numeric , 
	(0)::numeric , 
	'', 
	somente_numero(substr(ds_conteudo,82,13)), 
	somente_numero(substr(ds_conteudo,95,9)) 
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,16,02) = '76' or substr(ds_conteudo,16,02) = '86') 
and (substr(ds_conteudo,24,14) = '91162511000165') 
and (substr(ds_conteudo,14,02) <> '00') 

union all
 
select	nr_sequencia, 
	substr(ds_conteudo,16,02), 
	substr(ds_conteudo,14,02), 
	substr(ds_conteudo,20,13), 
	substr(ds_conteudo,41,06), 
	substr(ds_conteudo,62,06), 
	substr(ds_conteudo,62,06), 
	(0)::numeric , 
	somente_numero(substr(ds_conteudo,146,13)), 
	somente_numero(substr(ds_conteudo,159,09)), 
	'', 
	(0)::numeric , 
	(0)::numeric  
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
and (substr(ds_conteudo,16,02)	= '77' or substr(ds_conteudo,16,02) = '87') 
and (substr(ds_conteudo,14,02) = '00') 

union all
 
select	nr_sequencia, 
	substr(ds_conteudo,16,02), 
	'', 
	'', 
	'', 
	'', 
	'', 
	somente_numero(substr(ds_conteudo,59,11)), 
	(0)::numeric , 
	(0)::numeric , 
	'', 
	somente_numero(substr(ds_conteudo,70,13)), 
	somente_numero(substr(ds_conteudo,83,09)) 
from	w_conv_ret_movto 
where	nr_seq_retorno		= nr_seq_retorno_p 
AND (substr(ds_conteudo,16,02)	= '77' or substr(ds_conteudo,16,02) = '87') 
and (substr(ds_conteudo,24,14) = '91162511000165') 
and (substr(ds_conteudo,14,02) <> '00') 
order by  1;


BEGIN 
	 
open c01;
loop 
fetch c01 into 
	nr_sequencia, 
	nr_tipo_nota_w, 
	nr_registro_w, 
	cd_usuario_convenio_w, 
	cd_prestador_w, 
	cd_autorizacao_w, 
	nr_doc_convenio_w, 
	vl_cobrado_w, 
	vl_total_pago_w, 
	vl_glosa_w, 
	ds_complemento_w, 
	vl_total_pago_55_w, 
	vl_glosa_55_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	 
	begin 
		 
	select	/*+ CHOOSE */max(a.nr_interno_conta) 
	into STRICT	nr_conta_w 
	from	atend_categoria_convenio d, 
		atendimento_paciente c, 
		conta_paciente b, 
		conta_paciente_guia a 
	where	a.nr_interno_conta		= b.nr_interno_conta 
	and	b.nr_atendimento		= c.nr_atendimento 
	and	d.nr_atendimento		= c.nr_atendimento 
	and	d.cd_usuario_convenio 	= cd_usuario_convenio_w 
	and	a.cd_autorizacao		= cd_autorizacao_w;
 
	if ((nr_registro_w = '00' ) and ((nr_tipo_nota_w = '75') or (nr_tipo_nota_w = '85'))) then 
		nr_doc_convenio_princ_w	:= nr_doc_convenio_w;
		cd_autorizacao_princ_w	:= cd_autorizacao_w;
	 
		select	nextval('convenio_retorno_movto_seq') 
		into STRICT	nr_seq_cabecalho_w 
		;
		 
		insert into convenio_retorno_movto(cd_usuario_convenio, 
			cd_prestador, 
		 	cd_autorizacao, 
		 	nr_doc_convenio, 
		 	vl_cobrado, 
		 	vl_total_pago, 
		 	vl_glosa, 
			ds_complemento, 
		 	dt_atualizacao, 
		 	nm_usuario, 
		 	nr_sequencia, 
		 	nr_seq_retorno, 
			nr_conta 
			) 
		values ((cd_usuario_convenio_w)::numeric , 
			(cd_prestador_w)::numeric , 
			(cd_autorizacao_w)::numeric , 
		 	(nr_doc_convenio_w)::numeric , 
		 	dividir_sem_round(((vl_cobrado_w)::numeric )::numeric,100), 
		 	(0)::numeric , 
		 	dividir_sem_round(((vl_glosa_w)::numeric )::numeric,100), 
			ds_complemento_w, 
		 	clock_timestamp(), 
		 	'TASY', 
		 	nr_seq_cabecalho_w, 
		 	nr_seq_retorno_p, 
			(nr_conta_w)::numeric  
		 	);
	else 
		insert into convenio_retorno_movto(vl_total_pago, 
		 	vl_glosa, 
		 	dt_atualizacao, 
		 	nm_usuario, 
		 	nr_sequencia, 
		 	nr_seq_retorno, 
			nr_doc_convenio, 
			vl_cobrado, 
			cd_autorizacao, 
			cd_usuario_convenio, 
			ds_complemento, 
			nr_conta 
			) 
		values (dividir_sem_round(((vl_total_pago_55_w)::numeric )::numeric,100), 
		 	 dividir_sem_round(((vl_glosa_55_w)::numeric )::numeric,100), 
		 	 clock_timestamp(), 
		 	 'TASY', 
		 	 nextval('convenio_retorno_movto_seq'), 
		 	 (nr_seq_retorno_p)::numeric , 
			 (nr_doc_convenio_princ_w)::numeric , 
			 dividir_sem_round(((vl_cobrado_w)::numeric )::numeric,100), 
			 (cd_autorizacao_princ_w)::numeric , 
		 	 (cd_usuario_convenio_w)::numeric , 
			 ds_complemento_w, 
			 (nr_conta_w)::numeric  );
			 
		update	convenio_retorno_movto 
		set	vl_total_pago = vl_total_pago + dividir_sem_round(((vl_total_pago_55_w)::numeric )::numeric,100) 
		where	nr_sequencia = nr_seq_cabecalho_W;
 
	end if;	
 
	exception 
	when others then 
		sqlerrm_w	:= sqlerrm;
		insert into convenio_retorno_movto(DS_COMPLEMENTO, 
			nr_seq_retorno, 
			nr_sequencia, 
			nm_usuario, 
			dt_atualizacao 
			) 
		values (substr(sqlerrm_w, 1, 255), 
			nr_seq_retorno_p, 
			nextval('convenio_retorno_movto_seq'), 
			'TASY', 
			clock_timestamp());
	end;
 
end loop;
close c01;
 
delete from w_conv_ret_movto 
where nr_seq_retorno = nr_seq_retorno_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ipe_gerar_w_conv_ret_movto (nr_seq_retorno_p bigint) FROM PUBLIC;

