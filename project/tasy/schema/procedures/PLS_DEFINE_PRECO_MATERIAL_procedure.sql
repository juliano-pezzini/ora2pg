-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_preco_material ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_vigencia_p timestamp, nr_seq_material_p pls_material.nr_sequencia%type, ie_tipo_tabela_p bigint, ie_tipo_despesa_p text, ie_origem_preco_p bigint, ie_tipo_conta_p text, nr_seq_outorgante_p bigint, nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_intercambio_p text, nr_seq_fornecedor_p text, nr_seq_categoria_p bigint, nr_seq_tipo_acomodacao_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, ie_tipo_guia_p text, ie_autorizacao_espec_p text, nr_seq_plano_espec_p bigint, ie_gravar_log_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_mat_conta_p pls_conta_mat.nr_sequencia%type, ds_parametro_tres_p text, ie_tipo_segurado_p text, ie_tipo_vinculo_p text, nr_seq_tipo_prestador_p bigint, ie_preco_plano_p text, nr_seq_estrut_mat_p bigint, nr_seq_tipo_uso_p bigint, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_plano_p bigint, nr_seq_contrato_p bigint, nr_seq_congenere_p bigint, ie_internado_p text, nr_seq_classificacao_prest_p bigint, sg_estado_outorg_p text, sg_estado_int_p text, ie_tipo_contratacao_p text, vl_material_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, nr_seq_material_preco_p INOUT bigint, vl_material_simpro_p INOUT bigint, vl_material_brasindice_p INOUT bigint, vl_material_tabela_p INOUT bigint, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material, nr_seq_uni_exec_p bigint default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) AS $body$
DECLARE


/* ie_tipo_tabela_p
	1 - Brasindice
	2 - Simpro
	3 - Tabela propria
	4 - Todas
*/
nr_seq_uni_exec_w		bigint;
ie_origem_preco_ww		smallint;
dt_base_w			timestamp;
dt_vigencia_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_orig_w		timestamp	:= clock_timestamp();
vl_material_w			double precision 	:= 0;
vl_material_brasindice_w	double precision 	:= null;
vl_material_simpro_w		double precision 	:= null;
vl_material_tabela_w		double precision 	:= null;
vl_material_orig_w		double precision 	:= null;
tx_ajuste_pfb_w			double precision	:= null;
tx_pmc_neut_w			double precision	:= null;
tx_pmc_neg_w			double precision	:= null;
tx_pmc_pos_w			double precision	:= null;
tx_simpro_pfb_w			double precision	:= null;
tx_simpro_pmc_w			double precision	:= null;
tx_ajuste_w			double precision	:= 0;
tx_ajuste_tab_w			double precision	:= null;
nr_seq_regra_w			bigint;
ie_origem_w			varchar(5);
ie_origem_ww			varchar(1);
ie_nacional_w			pls_congenere.ie_nacional%type;
vl_material_inf_w		double precision;
cd_tiss_w			varchar(40);
nr_seq_material_preco_w		bigint;
nr_seq_classificacao_prest_w	bigint;
nr_seq_plano_w			bigint;
nr_seq_contrato_w		bigint;
ie_tipo_contratacao_w		varchar(2);
ie_tabela_adicional_w		bigint;
ie_tipo_intercambio_w		varchar(10)	:= 'A';
sg_estado_w			pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;
nr_seq_congenere_w		bigint;
dt_base_fixo_w			timestamp;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
ds_observacao_log_w		varchar(4000);
ie_internado_w			varchar(10);
nr_seq_conta_w			bigint;
ie_tipo_segurado_w		varchar(5);
ie_tipo_vinculo_w		varchar(5);
nr_seq_tipo_prestador_w		bigint;
ie_preco_plano_w		varchar(3);
nr_seq_tipo_uso_w		bigint;
ie_pcmso_w			varchar(2);
ie_tipo_preco_brasindice_w	varchar(3);
ie_tipo_preco_simpro_w		varchar(1);
vl_apresentado_w		double precision;
vl_pfb_neutra_simpro_w		double precision	:= 0;
vl_pfb_positiva_simpro_w	double precision	:= 0;
vl_pfb_negativa_simpro_w	double precision	:= 0;
vl_pfb_nao_aplicavel_simpro_w	double precision	:= 0;
VL_PFB_NEUTRA_BRASINDICE_w	double precision	:= 0;
vl_pfb_positiva_brasindice_w	double precision	:= 0;
vl_pfb_negativa_brasindice_w	double precision	:= 0;
vl_material_a900_w		double precision	:= 0;
ie_tipo_ajuste_pfb_w		varchar(2);
dados_conta_w			pls_cta_valorizacao_pck.dados_conta;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;
ie_tipo_preco_tab_adic_w	pls_regra_preco_mat.ie_tipo_preco_tab_adic%type;
nr_seq_guia_w			pls_conta.nr_seq_guia%type;
ds_origem_w			varchar(255);
vl_unitario_imp_w		pls_conta_mat.vl_unitario_imp%type;
dados_guia_w     		pls_cta_valorizacao_pck.dados_guia;
cd_guia_w			pls_conta.cd_guia%type;
vl_perc_icms_w			pls_regra_icms.vl_perc_icms%type;
nr_seq_congenere_prot_w   	pls_protocolo_conta.nr_seq_congenere%type;
nr_seq_congenere_outorg_w	pls_congenere.nr_sequencia%type;
pr_icms_w			pls_regra_preco_mat.pr_icms%type;
cd_municipio_w			sus_municipio.cd_municipio_ibge%type;
ie_alc_w			pls_mat_unimed_trib.id_alc%type := 'N';
sg_uf_prestador_w		pessoa_juridica.sg_estado%type;
tx_ajuste_icms_w		pls_regra_icms_prest.tx_ajuste%type;
cd_material_a900_w		pls_material_a900.cd_material_a900%type;
ie_med_generico_w		varchar(1) := 'N';
ie_brasindice_w			varchar(1) := 'N';
cd_tiss_brasindice_w		pls_material.cd_tiss_brasindice%type;
cd_simpro_w			pls_material.cd_simpro%type;
ie_utilizar_duas_casas_w	pls_regra_preco_mat.ie_utilizar_duas_casas%type;
ie_ult_valor_fabrica_w		pls_regra_preco_mat.ie_ult_valor_fabrica%type;
ie_tipo_segurado_conta_w	pls_conta.ie_tipo_segurado%type;	

BEGIN

dt_vigencia_w := trunc(dt_vigencia_p, 'dd');

if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	nr_seq_conta_w	:= nr_seq_conta_p;
	
	select	max(a.nr_seq_congenere),
			max(b.ie_tipo_segurado)
	into STRICT	nr_seq_congenere_prot_w,
			ie_tipo_segurado_conta_w
	from	pls_protocolo_conta a,
		pls_conta b
	where  	a.nr_sequencia = b.nr_seq_protocolo
	and    	b.nr_sequencia = nr_seq_conta_p;
else

	select	max(nr_seq_conta),
		max(vl_material_imp),
		max(vl_unitario_imp)
	into STRICT	nr_seq_conta_w,
		vl_apresentado_w,
		vl_unitario_imp_w
	from	pls_conta_mat
	where	nr_sequencia = nr_seq_mat_conta_p;
	
	select	max(a.nr_seq_congenere),
			max(b.ie_tipo_segurado)
	into STRICT   	nr_seq_congenere_prot_w,
			ie_tipo_segurado_conta_w
	from   	pls_protocolo_conta a,
		pls_conta b,
		pls_conta_mat c
	where  	a.nr_sequencia = b.nr_seq_protocolo
	and    	b.nr_sequencia = c.nr_seq_conta
	and    	c.nr_sequencia = nr_seq_mat_conta_p;
	
	if (coalesce(vl_unitario_imp_w,0) <> 0) then
		vl_apresentado_w	:= vl_unitario_imp_w;
	end if;
end if;

if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then

	select	coalesce(max(guia.ie_pcmso),'N'),
		max(conta.nr_seq_guia),
		max(guia.nr_seq_tipo_acomodacao),
		max(conta.cd_guia),
		max(ie_vinc_internacao),
		max(nr_seq_tipo_conta)
	into STRICT	dados_conta_w.ie_atend_pcmso,
		nr_seq_guia_w,
		dados_guia_w.nr_seq_tipo_acomodacao,
		cd_guia_w,
		dados_conta_w.ie_ref_guia_internacao,
		dados_conta_w.nr_seq_tipo_conta
	from	pls_conta	conta,
		pls_guia_plano	guia
	where	conta.nr_seq_guia = guia.nr_sequencia
	and	conta.nr_sequencia = nr_seq_conta_w;

	select 	max(a.nr_seq_tipo_atendimento)
	into STRICT 	dados_conta_w.nr_seq_tipo_atendimento
	from 	pls_conta_v a
	where 	a.nr_sequencia = (	SELECT 	max(b.nr_seq_conta_princ)
					from	pls_conta b
					where	b.nr_sequencia = nr_seq_conta_w);
end if;

if (ie_internado_p IS NOT NULL AND ie_internado_p::text <> '') then
	ie_internado_w	:= ie_internado_p;
else
	if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then
		ie_internado_w	:= pls_obter_se_internado(nr_seq_conta_w,'');
	end if;
end if;

if (coalesce(vl_apresentado_w::text, '') = '') then
	begin
		select	coalesce(vl_material_imp,0),
			coalesce(vl_unitario_imp,0)
		into STRICT	vl_apresentado_w,
			vl_unitario_imp_w
		from	pls_conta_mat
		where	nr_sequencia = nr_seq_mat_conta_p;
	exception
	when others then
		vl_apresentado_w := 0;
	end;

	if (coalesce(vl_unitario_imp_w,0) <> 0) then
		vl_apresentado_w	:= vl_unitario_imp_w;
	end if;

end if;
cd_convenio_w	:= pls_obter_conv_cat_segurado(nr_seq_segurado_p, 1);
cd_categoria_w	:= pls_obter_conv_cat_segurado(nr_seq_segurado_p, 2);

/* Parametros novos  da ajuste mat */

if (ie_tipo_segurado_p IS NOT NULL AND ie_tipo_segurado_p::text <> '') or (nr_seq_plano_p IS NOT NULL AND nr_seq_plano_p::text <> '') or (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') or (nr_seq_congenere_p IS NOT NULL AND nr_seq_congenere_p::text <> '') then
	ie_tipo_segurado_w	:= ie_tipo_segurado_p;
	nr_seq_plano_w		:= nr_seq_plano_p;
	nr_seq_contrato_w	:= nr_seq_contrato_p;
	nr_seq_congenere_w	:= nr_seq_congenere_p;

	begin
		select	coalesce(ie_pcmso,'N')
		into STRICT	ie_pcmso_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		ie_pcmso_w	:= 'N';
	end;
else
	/* Obter dados do beneficiario */

	begin
		select	CASE WHEN coalesce(ie_tipo_segurado_conta_w::text, '') = '' THEN ie_tipo_segurado  ELSE ie_tipo_segurado_conta_w END ,
			pls_obter_produto_benef(nr_sequencia,dt_vigencia_p),
			nr_seq_contrato,
			nr_seq_congenere,
			coalesce(ie_pcmso,'N')
		into STRICT	ie_tipo_segurado_w,
			nr_seq_plano_w,
			nr_seq_contrato_w,
			nr_seq_congenere_w,
			ie_pcmso_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		ie_tipo_segurado_w	:= null;
		ie_pcmso_w		:= 'N';
	end;
end if;

-- se for intercambio de pagamento deve ser olhado o congenere do protocolo ao invez do congenere do beneficiario

-- pois trata-se de um atendimento que o beneficiario da operadora sofreu em outra operadora
if (ie_tipo_conta_p = 'IP') then

	nr_seq_congenere_w := nr_seq_congenere_prot_w;

end if;

--nr_seq_congenere_prot_w sera nulo quando nao for intercambio, o que causava problemas para obtencao da regra de icms
if (coalesce(nr_seq_congenere_prot_w::text, '') = '') then
	select	coalesce(max(b.nr_sequencia),0)
	into STRICT	nr_seq_congenere_outorg_w
	from	pls_congenere b,
		pls_outorgante a
	where	a.cd_cgc_outorgante	= b.cd_cgc
	and	a.cd_estabelecimento	= cd_estabelecimento_p;
end if;	
	
if (sg_estado_outorg_p IS NOT NULL AND sg_estado_outorg_p::text <> '') then
	sg_estado_w	:= sg_estado_outorg_p;
	sg_estado_int_w	:= sg_estado_int_p;

	select	coalesce(max(ie_nacional), 'N')
	into STRICT	ie_nacional_w
	from	pessoa_juridica	a,
		pls_congenere	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_sequencia	= nr_seq_congenere_w;

else
	/* Obter a UF da operadora  - Tasy*/

	select	coalesce(max(sg_estado),'X')
	into STRICT	sg_estado_w
	from	pessoa_juridica
	where	cd_cgc	= (	SELECT	max(cd_cgc_outorgante)
				from	pls_outorgante
				where	cd_estabelecimento	= cd_estabelecimento_p);

	/* Obter a UF da operadora do beneficiario eventual ou que enviou o protocolo*/

	select	coalesce(max(a.sg_estado),'X'),
		coalesce(max(ie_nacional), 'N')
	into STRICT	sg_estado_int_w,
		ie_nacional_w
	from	pessoa_juridica	a,
		pls_congenere	b
	where	a.cd_cgc	= b.cd_cgc
	and	b.nr_sequencia	= nr_seq_congenere_w;
		
end if;

if (ie_nacional_w	= 'S') then
	ie_tipo_intercambio_w := 'N';	-- Nacional
elsif (sg_estado_w <> 'X') then
	if (sg_estado_int_w <> 'X') then
		if (sg_estado_w	= sg_estado_int_w) then
			ie_tipo_intercambio_w	:= 'E';
		else
			ie_tipo_intercambio_w	:= 'N';
		end if;
	elsif (nr_seq_uni_exec_p IS NOT NULL AND nr_seq_uni_exec_p::text <> '') then
		select	pls_obter_seq_cooperativa(max(b.cd_cooperativa))
		into STRICT	nr_seq_uni_exec_w
		from	pessoa_juridica a,
			pls_congenere	b
		where	a.cd_cgc = (	SELECT	max(cd_cgc_outorgante)
					from	pls_outorgante
					where	cd_estabelecimento = cd_estabelecimento_p)
		and	b.cd_cgc = a.cd_cgc
		and	length(b.cd_cooperativa) >= 4;
		
		if (nr_seq_uni_exec_w IS NOT NULL AND nr_seq_uni_exec_w::text <> '' AND nr_seq_uni_exec_w <> nr_seq_uni_exec_p) then
			ie_tipo_intercambio_w := pls_obter_tipo_intercambio(nr_seq_uni_exec_p, cd_estabelecimento_p);
		else
			ie_tipo_intercambio_w	:= 'A';
		end if;
	else
		ie_tipo_intercambio_w	:= 'A';
	end if;
else
	ie_tipo_intercambio_w	:= 'A';
end if;

if (ie_tipo_vinculo_p IS NOT NULL AND ie_tipo_vinculo_p::text <> '') or (nr_seq_tipo_prestador_p IS NOT NULL AND nr_seq_tipo_prestador_p::text <> '') or (nr_seq_classificacao_prest_p IS NOT NULL AND nr_seq_classificacao_prest_p::text <> '') then
	ie_tipo_vinculo_w	:= ie_tipo_vinculo_p;
	nr_seq_tipo_prestador_w	:= nr_seq_tipo_prestador_p;
	nr_seq_classificacao_prest_w := nr_seq_classificacao_prest_p;
else
	/* Obter dados do prestador */

	
	select	max(ie_tipo_vinculo),
		max(nr_seq_tipo_prestador),
		max(nr_seq_classificacao)
	into STRICT	ie_tipo_vinculo_w,
		nr_seq_tipo_prestador_w,
		nr_seq_classificacao_prest_w
	from	pls_prestador
	where	nr_sequencia	= nr_seq_prestador_p;

end if;

if (ie_preco_plano_p IS NOT NULL AND ie_preco_plano_p::text <> '') or (ie_tipo_contratacao_p IS NOT NULL AND ie_tipo_contratacao_p::text <> '') then
	ie_preco_plano_w	:= ie_preco_plano_p;
	ie_tipo_contratacao_w	:= ie_tipo_contratacao_p;
else
	select	max(ie_preco),
		max(ie_tipo_contratacao)
	into STRICT	ie_preco_plano_w,
		ie_tipo_contratacao_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_w;
end if;

if (nr_seq_tipo_uso_p IS NOT NULL AND nr_seq_tipo_uso_p::text <> '') then
	nr_seq_tipo_uso_w	:= nr_seq_tipo_uso_p;
else
	/* Obter dados do material */

	select	max(nr_seq_tipo_uso)
	into STRICT	nr_seq_tipo_uso_w
	from	pls_material
	where	nr_sequencia = nr_seq_material_p;
end if;

cd_municipio_w := pls_obter_dados_prestador(nr_seq_prestador_p, 'IBGE');
				
select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
into STRICT	ie_alc_w
from	pls_municipio_livre_com
where	cd_municipio_ibge = cd_municipio_w;

dados_regra_preco_material_w := pls_obter_regra_ajuste_mat(	cd_estabelecimento_p, nr_seq_prestador_p, nr_seq_material_p, dt_vigencia_p, ie_tipo_despesa_p, ie_tipo_conta_p, nr_seq_outorgante_p, nr_seq_classificacao_prest_w, nr_seq_segurado_p, nr_seq_plano_w, nr_seq_contrato_w, ie_tipo_contratacao_w, nr_seq_contrato_intercambio_p, ie_gravar_log_p, nm_usuario_p, nr_seq_mat_conta_p, ie_tipo_intercambio_w, sg_estado_int_w, nr_seq_categoria_p, cd_convenio_w, cd_categoria_w, nr_seq_tipo_acomodacao_p, nr_seq_tipo_atendimento_p, nr_seq_clinica_p, ie_tipo_guia_p, ie_autorizacao_espec_p, ie_internado_w, null, ie_tipo_segurado_w, ie_tipo_vinculo_w, nr_seq_tipo_prestador_w, ie_preco_plano_w, null, nr_seq_tipo_uso_w, nr_seq_conta_w, ie_pcmso_w, dados_guia_w, dados_conta_w, dados_regra_preco_material_w, nr_seq_uni_exec_p, ie_regime_atendimento_p, null, ie_saude_ocupacional_p);

nr_seq_regra_w			:= dados_regra_preco_material_w.nr_sequencia;
tx_ajuste_w			:= dados_regra_preco_material_w.tx_ajuste;
vl_material_w			:= dados_regra_preco_material_w.vl_negociado;
tx_ajuste_pfb_w			:= dados_regra_preco_material_w.tx_ajuste_pfb;
tx_pmc_neut_w			:= dados_regra_preco_material_w.tx_ajuste_pmc_neut;
tx_pmc_neg_w			:= dados_regra_preco_material_w.tx_ajuste_pmc_neg;
tx_pmc_pos_w			:= dados_regra_preco_material_w.tx_ajuste_pmc_pos;
tx_simpro_pfb_w			:= dados_regra_preco_material_w.tx_ajuste_simpro_pfb;
tx_simpro_pmc_w			:= dados_regra_preco_material_w.tx_ajuste_simpro_pmc;
ie_origem_w			:= dados_regra_preco_material_w.ie_origem_preco;
nr_seq_material_preco_w		:= dados_regra_preco_material_w.nr_seq_material_preco;
tx_ajuste_tab_w			:= dados_regra_preco_material_w.tx_ajuste_tab_propria;
ie_tabela_adicional_w		:= dados_regra_preco_material_w.ie_tabela_adicional;
dt_base_fixo_w			:= dados_regra_preco_material_w.dt_base_fixo;
ie_tipo_preco_brasindice_w	:= dados_regra_preco_material_w.ie_tipo_preco_brasindice;
ie_tipo_preco_simpro_w		:= dados_regra_preco_material_w.ie_tipo_preco_simpro;
vl_pfb_neutra_simpro_w		:= dados_regra_preco_material_w.vl_pfb_neutra_simpro;
vl_pfb_positiva_simpro_w	:= dados_regra_preco_material_w.vl_pfb_positiva_simpro;
vl_pfb_negativa_simpro_w	:= dados_regra_preco_material_w.vl_pfb_negativa_simpro;
vl_pfb_nao_aplicavel_simpro_w	:= dados_regra_preco_material_w.vl_pfb_nao_aplicavel_simpro;
vl_pfb_neutra_brasindice_w	:= dados_regra_preco_material_w.vl_pfb_neutra_brasindice;
vl_pfb_positiva_brasindice_w	:= dados_regra_preco_material_w.vl_pfb_positiva_brasindice;
vl_pfb_negativa_brasindice_w	:= dados_regra_preco_material_w.vl_pfb_negativa_brasindice;
ie_tipo_ajuste_pfb_w		:= dados_regra_preco_material_w.ie_tipo_ajuste_pfb;
ie_tipo_preco_tab_adic_w	:= dados_regra_preco_material_w.ie_tipo_preco_tab_adic;
vl_material_inf_w		:= vl_material_w;
pr_icms_w			:= dados_regra_preco_material_w.pr_icms;
ie_utilizar_duas_casas_w	:= dados_regra_preco_material_w.ie_utilizar_duas_casas;
ie_ult_valor_fabrica_w		:= dados_regra_preco_material_w.ie_ult_valor_fabrica;

CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
				expressao_pck.obter_desc_expressao(967446), ds_observacao_log_w, 'pls_define_preco_material',
				vl_material_w, 1, nr_seq_regra_w,
				ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);

if (ie_origem_w IS NOT NULL AND ie_origem_w::text <> '') then
	--Percorre todos os caracteres do valor de dominio selecionado, priorizando a primeira que encontrar valor valido.
	for i in 1 .. length(ie_origem_w) loop
		begin
		vl_material_orig_w		:= 0;
		dt_vigencia_orig_w		:= clock_timestamp() - interval '2000 days';
		if (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'T') then
			
			ie_origem_ww	:= 'T';
			dt_base_w	:= dt_vigencia_p;
			cd_material_a900_w	:= null;
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			if (coalesce(ie_tabela_adicional_w,0)	= 1) and (coalesce(vl_material_orig_w,0) = 0) then
				SELECT * FROM pls_obter_preco_mat_adicional(	cd_estabelecimento_p, nr_seq_material_p, dt_base_w, tx_ajuste_tab_w, nr_seq_fornecedor_p, vl_material_orig_w, dt_vigencia_orig_w, dados_regra_preco_material_w.cd_versao_tiss	) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w;

			elsif (coalesce(ie_tabela_adicional_w,0)	= 2) and (coalesce(vl_material_orig_w,0) = 0)  then
				SELECT * FROM pls_obter_preco_mat_forn_adic(	cd_estabelecimento_p, nr_seq_material_p, dt_base_w, tx_ajuste_tab_w, nr_seq_fornecedor_p, vl_material_orig_w, dt_vigencia_orig_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w;

			elsif (coalesce(ie_tabela_adicional_w,0)	= 3) and (coalesce(vl_material_orig_w,0) = 0) then	
					
				
				vl_material_a900_w := pls_obter_preco_mat_A900(nr_seq_material_p, dt_vigencia_p, vl_material_a900_w); -- Edgar 11/11/2013, OS 633529, tratar preco do A900 (TNUMM), mas nao aplicar a regra se retornar ZERO
				if (coalesce(vl_material_a900_w,0) > 0) then
					vl_material_orig_w	:= vl_material_a900_w;
				end if;
				
				cd_material_a900_w:= pls_obter_seq_mat_a900(nr_seq_material_p, dt_vigencia_p, null, ie_tabela_adicional_w);
				
			elsif (coalesce(ie_tabela_adicional_w,0)	= 4) and (coalesce(vl_material_orig_w,0) = 0) then
			
				if (pr_icms_w IS NOT NULL AND pr_icms_w::text <> '') then
					vl_perc_icms_w := pr_icms_w;
				else		
					vl_perc_icms_w := pls_obter_vl_icms( coalesce(nr_seq_congenere_prot_w, nr_seq_congenere_outorg_w), dt_vigencia_p, nm_usuario_p, nr_seq_material_p);
				end if;
				
				vl_material_a900_w := pls_obter_icms_mat_A900( nr_seq_material_p, vl_perc_icms_w, dt_vigencia_p, ie_alc_w, vl_material_a900_w); -- OS 874054 - Realizar a valorizacao considerando o percentual de ICMS do A900 cadastrado na Cooperativa Medica. 
			
				if (coalesce(vl_material_a900_w,0) > 0) then
					vl_material_orig_w	:= vl_material_a900_w;
				end if;
				
				cd_material_a900_w :=  pls_obter_seq_mat_a900(nr_seq_material_p, dt_vigencia_p, ie_alc_w, ie_tabela_adicional_w);
				
			end if;
			
			if 	((coalesce(ie_tabela_adicional_w,0)	= 0) or (ie_origem_w	in ('AT','AST','ATS'))) and (coalesce(vl_material_orig_w,0) = 0) then
				SELECT * FROM pls_obter_preco_tabela(	cd_estabelecimento_p, nr_seq_prestador_p, nr_seq_material_p, nr_seq_material_preco_w, dt_base_w, tx_ajuste_tab_w, ie_tipo_preco_tab_adic_w, vl_material_orig_w, dt_vigencia_orig_w, dados_regra_preco_material_w.cd_moeda_calculo) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, dados_regra_preco_material_w.cd_moeda_calculo;
			end if;
			
			dados_regra_preco_material_w.vl_material_tabela	:= vl_material_orig_w;
			if (dados_regra_preco_material_w.cd_moeda_calculo IS NOT NULL AND dados_regra_preco_material_w.cd_moeda_calculo::text <> '') then
				dados_regra_preco_material_w.vl_ch_material	:= obter_valor_cotacao_moeda_data(dados_regra_preco_material_w.cd_moeda_calculo, dt_vigencia_p);
			end if;
			vl_material_tabela_w	:= vl_material_orig_w;
			ie_origem_preco_ww	:= 2;


			ds_observacao_log_w	:= 	';ie_tabela_adicional_w='||chr(39)||ie_tabela_adicional_w||chr(39)||
							';vl_material_tabela_w='||chr(39)||vl_material_tabela_w||chr(39)||
							';ie_origem_ww='||chr(39)||ie_origem_ww||' - '||ds_origem_w||chr(39)||
							';dt_base_w=to_date('||chr(39)||dt_base_w||chr(39)||','||chr(39)||'dd/mm/yyyy'||chr(39)||')'||
							';dt_vigencia_orig_w=to_date('||chr(39)||dt_vigencia_orig_w||chr(39)||','||chr(39)||'dd/mm/yyyy'||chr(39)||')'||
							';nr_seq_prestador_p='||chr(39)||nr_seq_prestador_p||chr(39)||
							';cd_estabelecimento_p='||chr(39)||cd_estabelecimento_p||chr(39)||
							';nr_seq_material_p='||chr(39)||nr_seq_material_p||chr(39)||
							';tx_ajuste_tab_w='||chr(39)||tx_ajuste_tab_w||chr(39)||
							';nr_seq_fornecedor_p='||chr(39)||nr_seq_fornecedor_p||chr(39)||
							';vl_material_orig_w='||chr(39)||vl_material_orig_w||chr(39)||
							';ie_origem_preco_ww='||chr(39)||ie_origem_preco_ww||chr(39)||
							';tx_ajuste_w='||chr(39)||tx_ajuste_w||chr(39)||
							';cd_material_a900='||chr(39)||cd_material_a900_w||chr(39)||
							';nr_seq_material_preco_w='||chr(39)||nr_seq_material_preco_w||chr(39);

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							expressao_pck.obter_desc_expressao(299018), ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_tabela_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);

		elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'B') then

			ie_origem_ww	:= 'B';
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			/* Felipe - 26/07/2011 - OS 336183 */

			if (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
				dt_base_w	:= dt_base_fixo_w;
			else
				dt_base_w	:= dt_vigencia_p;
			end if;

			SELECT * FROM pls_obter_preco_brasindice(cd_estabelecimento_p, nr_seq_prestador_p, nr_seq_material_p, dt_base_w, tx_ajuste_pfb_w, tx_pmc_neut_w, tx_pmc_neg_w, tx_pmc_pos_w, ie_tipo_preco_brasindice_w, vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, vl_pfb_neutra_brasindice_w, vl_pfb_positiva_brasindice_w, vl_pfb_negativa_brasindice_w, ie_tipo_ajuste_pfb_w, nm_usuario_p) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w;

			vl_material_brasindice_w	:= vl_material_orig_w;
			ie_origem_preco_ww		:= 2;

			ds_observacao_log_w	:= 'ie_origem_ww: ' || ie_origem_ww ||' - '||ds_origem_w|| ';dt_base_w: ' ||
							';ie_origem_preco_ww: ' || ie_origem_preco_ww;

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							'Brasindice', ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_brasindice_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);

		elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'S') then

			ie_origem_ww	:= 'S';
			
			if (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
				dt_base_w	:= dt_base_fixo_w;
			else
				dt_base_w	:= dt_vigencia_p;
			end if;
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			SELECT * FROM pls_calcular_preco_simpro(cd_estabelecimento_p, nr_seq_prestador_p, nr_seq_material_p, tx_simpro_pfb_w, tx_simpro_pmc_w, dt_base_w, ie_tipo_preco_simpro_w, vl_material_orig_w, dt_vigencia_orig_w, vl_pfb_neutra_simpro_w, vl_pfb_positiva_simpro_w, vl_pfb_negativa_simpro_w, vl_pfb_nao_aplicavel_simpro_w, ie_tipo_ajuste_pfb_w, nm_usuario_p, ie_ult_valor_fabrica_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w;

			vl_material_simpro_w	:= vl_material_orig_w;
			ie_origem_preco_ww	:= 4;

			ds_observacao_log_w	:= 'ie_origem_ww: ' || ie_origem_ww ||' - '||ds_origem_w|| ';dt_base_w: ' ||
							';ie_origem_preco_ww: ' || ie_origem_preco_ww;

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							'Simpro', ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_brasindice_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);

		elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'A') then
			ie_origem_ww	:= 'A';
			dt_base_w	:= dt_vigencia_p;
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			vl_material_orig_w := pls_obter_valor_material_espec(nr_seq_plano_espec_p, nr_seq_material_p, vl_material_orig_w);
			dados_regra_preco_material_w.vl_material_tabela	:= vl_material_orig_w;
			vl_material_w	:= vl_material_orig_w;
			
			cd_material_a900_w	:= null;
			/* Necessario incluir o testo abaixo para realmente buscar as informacoes da tabela adicionais, hoje isto somente ocorria quando era selecionado o valor tabela e com isto nao estava atendendo ao cliente dgkorz*/

			if (coalesce(vl_material_w,0)	= 0) then
				select 	substr(max(ds_valor_dominio),1,60)
				into STRICT	ds_origem_w
				from 	valor_dominio_v
				where 	cd_dominio = 7309
				and	vl_dominio = ie_origem_ww;
				
				if (coalesce(ie_tabela_adicional_w,0)	= 1) and (coalesce(vl_material_orig_w,0) = 0) then
					SELECT * FROM pls_obter_preco_mat_adicional(	cd_estabelecimento_p, nr_seq_material_p, dt_base_w, tx_ajuste_tab_w, nr_seq_fornecedor_p, vl_material_orig_w, dt_vigencia_orig_w, dados_regra_preco_material_w.cd_versao_tiss	) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w;

				elsif (coalesce(ie_tabela_adicional_w,0)	= 2) and (coalesce(vl_material_orig_w,0) = 0)  then
					SELECT * FROM pls_obter_preco_mat_forn_adic(	cd_estabelecimento_p, nr_seq_material_p, dt_base_w, tx_ajuste_tab_w, nr_seq_fornecedor_p, vl_material_orig_w, dt_vigencia_orig_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w;

				elsif (coalesce(ie_tabela_adicional_w,0)	= 3) and (coalesce(vl_material_orig_w,0) = 0) then	
						
					
					vl_material_a900_w := pls_obter_preco_mat_A900(nr_seq_material_p, dt_vigencia_p, vl_material_a900_w); -- Edgar 11/11/2013, OS 633529, tratar preco do A900 (TNUMM), mas nao aplicar a regra se retornar ZERO
					if (coalesce(vl_material_a900_w,0) > 0) then
						vl_material_orig_w	:= vl_material_a900_w;
					end if;
					
					cd_material_a900_w:= pls_obter_seq_mat_a900(nr_seq_material_p, dt_vigencia_p, null, ie_tabela_adicional_w);
					
				elsif (coalesce(ie_tabela_adicional_w,0)	= 4) and (coalesce(vl_material_orig_w,0) = 0) then
				
					if (pr_icms_w IS NOT NULL AND pr_icms_w::text <> '') then
						vl_perc_icms_w := pr_icms_w;
					else		
						vl_perc_icms_w := pls_obter_vl_icms( coalesce(nr_seq_congenere_prot_w, nr_seq_congenere_outorg_w), dt_vigencia_p, nm_usuario_p, nr_seq_material_p);
					end if;
					
					vl_material_a900_w := pls_obter_icms_mat_A900( nr_seq_material_p, vl_perc_icms_w, dt_vigencia_p, ie_alc_w, vl_material_a900_w); -- OS 874054 - Realizar a valorizacao considerando o percentual de ICMS do A900 cadastrado na Cooperativa Medica. 
				
					if (coalesce(vl_material_a900_w,0) > 0) then
						vl_material_orig_w	:= vl_material_a900_w;
					end if;
					
					cd_material_a900_w :=  pls_obter_seq_mat_a900(nr_seq_material_p, dt_vigencia_p, ie_alc_w, ie_tabela_adicional_w);
					
				end if;
			end if;
			ds_observacao_log_w	:= 'ie_origem_ww: ' || ie_origem_ww ||' - '||ds_origem_w|| ';dt_base_w: ';

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							'Unimed', ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_brasindice_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);

		elsif (vl_material_w = 0) and (ie_origem_w = 'VAO') then
			vl_material_w := vl_apresentado_w;
			
		elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'Z') then
		
			ie_origem_ww := 'Z';
			dt_base_w	:= dt_vigencia_p;
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
			
				vl_material_w := pls_obter_valor_autorizado(nr_seq_guia_w, nr_seq_material_p);
			
			end if;

			ds_observacao_log_w	:= 'ie_origem_ww: ' || ie_origem_ww ||' - '||ds_origem_w|| ';dt_base_w: ';

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							'Autorizado', ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);
		elsif (vl_material_w = 0) and (substr(ie_origem_w,i,1) = 'I') then
		
			ie_origem_ww := 'I';
			dt_base_w	:= dt_vigencia_p;
			
			select 	substr(max(ds_valor_dominio),1,60)
			into STRICT	ds_origem_w
			from 	valor_dominio_v
			where 	cd_dominio = 7309
			and	vl_dominio = ie_origem_ww;
			
			if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
			
				vl_material_w := pls_obter_valor_solicmed(nr_seq_guia_w, nr_seq_material_p);
			
			end if;

			ds_observacao_log_w	:= 'ie_origem_ww: ' || ie_origem_ww ||' - '||ds_origem_w|| ';dt_base_w: ';

			CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
							'Autorizado', ds_observacao_log_w, 'pls_define_preco_material',
							vl_material_w, 2, nr_seq_regra_w,
							ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);			
		end if;
		
		if (vl_material_orig_w > 0) and
			((vl_material_w = 0) or (dt_vigencia_orig_w	> dt_vigencia_w)) then
			begin
			dt_vigencia_w		:= dt_vigencia_orig_w;
			vl_material_w		:= vl_material_orig_w;
			end;
		end if;
		end;
	end loop;
end if;

if (ie_utilizar_duas_casas_w = 'S') then
	vl_material_tabela_w 		:= round((vl_material_tabela_w)::numeric,2);
	vl_material_brasindice_w	:= round((vl_material_brasindice_w)::numeric,2);
	vl_material_simpro_w 		:= round((vl_material_simpro_w)::numeric,2);
	vl_material_w 			:= round((vl_material_w)::numeric,2);
end if;

vl_material_tabela_w		:= (vl_material_tabela_w * tx_ajuste_w);
vl_material_brasindice_w	:= (vl_material_brasindice_w * tx_ajuste_w);
vl_material_simpro_w		:= (vl_material_simpro_w * tx_ajuste_w);
vl_material_w 			:= (vl_material_w * tx_ajuste_w);
dados_regra_preco_material_p	:= dados_regra_preco_material_w;

ds_observacao_log_w	:= 'Tx. ajuste: ' || tx_ajuste_w || ' ;vl_material_tabela_w: ' || vl_material_tabela_w ||
				' ;vl_material_brasindice_w: ' || vl_material_brasindice_w || ' ;vl_material_simpro_w: ' || vl_material_simpro_w;

if (ie_gravar_log_p = 'S') then
	CALL pls_gravar_log_calculo_mat(	ie_gravar_log_p, nr_seq_mat_conta_p, cd_estabelecimento_p,
					'Tx. ajuste', ds_observacao_log_w, 'pls_define_preco_material',
					vl_material_w, 3, nr_seq_regra_w,
					ie_tipo_conta_p, nr_seq_material_p, nm_usuario_p);
end if;

sg_uf_prestador_w := pls_obter_dados_prestador(nr_seq_prestador_p, 'UFTC');

select  max(cd_simpro),
        max(cd_tiss_brasindice)
into STRICT	cd_simpro_w,
	cd_tiss_brasindice_w
from    pls_material
where   nr_sequencia = nr_seq_material_p
and     cd_estabelecimento = cd_estabelecimento_p;

--dt_base_w
if (ie_origem_ww = 'B') then

	ie_brasindice_w := 'S';

	--Obtem a maior sequencia com vigencia valida e busca a informacao de generico do mesmo.
	with	query_tmp as
		(	select 	nr_sequencia,
				ie_generico
			from	brasindice_preco
			where 	cd_tiss = cd_tiss_brasindice_w
			and	dt_inicio_vigencia = (	select	max(a.dt_inicio_vigencia)
							from	brasindice_preco a
							where	a.cd_tiss = cd_tiss_brasindice_w	
							and	a.dt_inicio_vigencia <= dt_base_w)
			order by nr_sequencia desc
	)
	select 	coalesce(max(ie_generico),'N')
	into STRICT	ie_med_generico_w
	from 	query_tmp LIMIT 1;
	
elsif (ie_origem_ww = 'S') then

	with	query_tmp as
	(	select	nr_sequencia,
			ie_generico
		from	simpro_preco
		where 	cd_simpro = cd_simpro_w
		and	dt_vigencia >= (select	max(dt_vigencia)
						from	simpro_preco
						where	cd_simpro	= cd_simpro_w
						and	dt_vigencia	<= dt_base_w)
		
	)
	select 	coalesce(max(ie_generico),'N')
	into STRICT	ie_med_generico_w
	from 	query_tmp LIMIT 1;
	

end if;	

tx_ajuste_icms_w := pls_obter_icms_prest(sg_uf_prestador_w, dt_vigencia_p, ie_tipo_despesa_p, ie_med_generico_w, ie_brasindice_w);

if (tx_ajuste_icms_w <> 1) then
	vl_material_tabela_w		:= (vl_material_tabela_w * tx_ajuste_icms_w);
	vl_material_brasindice_w	:= (vl_material_brasindice_w * tx_ajuste_icms_w);
	vl_material_simpro_w		:= (vl_material_simpro_w * tx_ajuste_icms_w);
	vl_material_w 			:= (vl_material_w * tx_ajuste_icms_w);
end if;

if (coalesce(vl_material_inf_w,0) > 0) then
	vl_material_p			:= vl_material_inf_w;
	vl_material_simpro_p		:= vl_material_inf_w;
	vl_material_tabela_p		:= vl_material_inf_w;
	vl_material_brasindice_p	:= vl_material_inf_w;
	dt_ult_vigencia_p		:= dt_vigencia_w;
	nr_seq_material_preco_p		:= null;
else
	vl_material_p			:= vl_material_w;
	vl_material_simpro_p		:= vl_material_simpro_w;
	vl_material_tabela_p		:= vl_material_tabela_w;
	vl_material_brasindice_p 	:= vl_material_brasindice_w;
	dt_ult_vigencia_p		:= dt_vigencia_w;
	nr_seq_material_preco_p		:= nr_seq_material_preco_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_preco_material ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, dt_vigencia_p timestamp, nr_seq_material_p pls_material.nr_sequencia%type, ie_tipo_tabela_p bigint, ie_tipo_despesa_p text, ie_origem_preco_p bigint, ie_tipo_conta_p text, nr_seq_outorgante_p bigint, nr_seq_segurado_p pls_segurado.nr_sequencia%type, nr_seq_contrato_intercambio_p text, nr_seq_fornecedor_p text, nr_seq_categoria_p bigint, nr_seq_tipo_acomodacao_p bigint, nr_seq_tipo_atendimento_p bigint, nr_seq_clinica_p bigint, ie_tipo_guia_p text, ie_autorizacao_espec_p text, nr_seq_plano_espec_p bigint, ie_gravar_log_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_mat_conta_p pls_conta_mat.nr_sequencia%type, ds_parametro_tres_p text, ie_tipo_segurado_p text, ie_tipo_vinculo_p text, nr_seq_tipo_prestador_p bigint, ie_preco_plano_p text, nr_seq_estrut_mat_p bigint, nr_seq_tipo_uso_p bigint, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_plano_p bigint, nr_seq_contrato_p bigint, nr_seq_congenere_p bigint, ie_internado_p text, nr_seq_classificacao_prest_p bigint, sg_estado_outorg_p text, sg_estado_int_p text, ie_tipo_contratacao_p text, vl_material_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, nr_seq_material_preco_p INOUT bigint, vl_material_simpro_p INOUT bigint, vl_material_brasindice_p INOUT bigint, vl_material_tabela_p INOUT bigint, dados_regra_preco_material_p INOUT pls_cta_valorizacao_pck.dados_regra_preco_material, nr_seq_uni_exec_p bigint default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) FROM PUBLIC;

