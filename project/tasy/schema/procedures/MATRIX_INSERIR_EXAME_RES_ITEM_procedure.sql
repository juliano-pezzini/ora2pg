-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE matrix_inserir_exame_res_item ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_resultado_p text, cd_exame_p text, dt_coleta_p timestamp, ds_unidade_medida_p text, ds_erro_p INOUT text) AS $body$
DECLARE



cd_material_exame_w		prescr_procedimento.cd_material_exame%type;
nr_sequencia_w			prescr_procedimento.nr_sequencia%type;
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;
qt_resultado_w			exame_lab_result_item.qt_resultado%type;
pr_resultado_w			exame_lab_result_item.pr_resultado%type;
ds_resultado_w			exame_lab_result_item.ds_resultado%type;
cd_exame_laborat_w		exame_laboratorio.cd_exame%type;
ie_formato_resultado_w	exame_laboratorio.ie_formato_resultado%type;

BEGIN

begin	

	select	max(a.cd_material_exame),
			max(a.nr_sequencia),
			max(a.nr_seq_exame)
	into STRICT	cd_material_exame_w,
			nr_sequencia_w,
			nr_seq_exame_w
	from	prescr_procedimento a
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_sequencia = nr_seq_prescr_p;
	select	max(c.ie_formato_resultado),
			max(c.cd_exame)
	into STRICT	ie_formato_resultado_w,
			cd_exame_laborat_w
	from	equipamento_lab a,
			lab_exame_equip b,
			exame_laboratorio c
	where	a.cd_equipamento = b.cd_equipamento
	and		b.nr_seq_exame = c.nr_seq_exame
	and		a.ds_sigla = 'MATRIX'
	and		b.cd_exame_equip = cd_exame_p;

	if (ie_formato_resultado_w = 'V') or (ie_formato_resultado_w = 'VP') then

		qt_resultado_w	:= (ds_resultado_p)::numeric;
		ds_resultado_w	:= '';

	elsif (ie_formato_resultado_w = 'P') or (ie_formato_resultado_w = 'VP') then

		pr_resultado_w	:= (ds_resultado_p)::numeric;
		ds_resultado_w	:= '';
	else
		ds_resultado_w	:= ds_resultado_p;
	END IF;
	 --dt_resultado_p,
								ds_erro_p := Atualizar_Lab_Result_Item(	nr_prescricao_p, nr_seq_prescr_p, cd_exame_laborat_w, qt_resultado_w, pr_resultado_w, ds_resultado_w, '', cd_material_exame_w, 'N',  --ie_reenvio_p,
								'MATRIXWS', dt_coleta_p, '',  --ds_referencia_p,
								ds_unidade_medida_p, '',  --nr_doc_lab_p,
								clock_timestamp(), 
								ds_erro_p);
	commit;

EXCEPTION
	WHEN OTHERS THEN
		ds_erro_p	:= substr(SQLERRM(SQLSTATE),1,2000);
END;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE matrix_inserir_exame_res_item ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_resultado_p text, cd_exame_p text, dt_coleta_p timestamp, ds_unidade_medida_p text, ds_erro_p INOUT text) FROM PUBLIC;

