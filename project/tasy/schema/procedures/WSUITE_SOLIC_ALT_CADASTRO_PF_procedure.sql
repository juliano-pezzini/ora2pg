-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_solic_alt_cadastro_pf ( nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p regra_envio_sms.cd_estabelecimento%type, nm_tabela_p tabela_sistema.nm_tabela%type, nm_atributo_p tasy_solic_alt_campo.nm_atributo%type, ds_valor_old_p tasy_solic_alt_campo.ds_valor_old%type, ds_valor_new_p tasy_solic_alt_campo.ds_valor_new%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type default 1, ie_commit_p text DEFAULT NULL, nr_seq_tabela_pk_p bigint default null, nr_seq_documento_p tasy_solic_alt_campo.nr_seq_documento%type default null) AS $body$
DECLARE


nr_seq_solicitacao_w	tasy_solic_alteracao.nr_sequencia%type;
ds_chave_simples_w	tasy_solic_alt_campo.ds_chave_simples%type;
ds_chave_composta_w	tasy_solic_alt_campo.ds_chave_composta%type;
nm_atributo_w		tasy_solic_alt_campo.nm_atributo%type;

nr_seq_evento_w		regra_envio_sms.nr_seq_evento%type;

ie_cadastro_ok_w	varchar(1) := 'N';

c01 CURSOR FOR
	SELECT	nr_seq_evento
	from	regra_envio_sms
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	ie_evento_disp		= 'TWSAPF'
	and	coalesce(ie_situacao,'A') = 'A';


BEGIN

nm_atributo_w	:= nm_atributo_p;

if ((ie_commit_p = 'S') and (coalesce(nm_tabela_p::text, '') = '') and (coalesce(nm_atributo_w::text, '') = '')) then
	ie_cadastro_ok_w := 'S';
end if;

select	max(a.nr_sequencia)
into STRICT	nr_seq_solicitacao_w
from	tasy_solic_alteracao a,
	tasy_solic_alt_campo b
where	a.nr_sequencia 	= b.nr_seq_solicitacao
and	nm_tabela	= nm_tabela_p
and	nm_atributo	= nm_atributo_w
and	ds_valor_old	= ds_valor_old_p
and	ds_valor_new	= ds_valor_new_p
and	coalesce(dt_analise::text, '') = ''
and (b.ds_chave_simples = cd_pessoa_fisica_p
or (position('CD_PESSOA_FISICA='||cd_pessoa_fisica_p in b.ds_chave_composta) > 0));

if (coalesce(nr_seq_solicitacao_w::text, '') = '') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_solicitacao_w
	from	tasy_solic_alteracao a,
		tasy_solic_alt_campo b
	where	coalesce(a.dt_analise::text, '') = ''
	and	a.nr_sequencia = b.nr_seq_solicitacao
	and	b.nm_tabela in ('PESSOA_FISICA', 'COMPL_PESSOA_FISICA','PESSOA_FISICA_AUX','PESSOA_TITULAR_CONVENIO')
	and (b.ds_chave_simples = cd_pessoa_fisica_p
	or (position('CD_PESSOA_FISICA='||cd_pessoa_fisica_p in b.ds_chave_composta) > 0));

	if (coalesce(nr_seq_solicitacao_w::text, '') = '') then
		insert into tasy_solic_alteracao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_processo,
			ie_tipo_solicitacao,
			ie_status,
			nm_usuario_solic_web,
			cd_estabelecimento,
			cd_funcao)
		values (
			nextval('tasy_solic_alteracao_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			'W',
			'B',
			CASE WHEN ie_cadastro_ok_w='S' THEN 'L'  ELSE 'A' END ,
			nm_usuario_p,
			cd_estabelecimento_p,
			9111)
		returning nr_sequencia
		into nr_seq_solicitacao_w;
	end if;

	if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '' AND nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') then
		if (upper(nm_tabela_p)	= 'PESSOA_FISICA' or upper(nm_tabela_p)	= 'PESSOA_FISICA_AUX') then
			ds_chave_simples_w 	:= cd_pessoa_fisica_p;
		elsif (upper(nm_tabela_p)	= 'COMPL_PESSOA_FISICA') then
			if (nm_atributo_w = 'NM_PAI') then
				nm_atributo_w		:= 'NM_CONTATO';
				ds_chave_composta_w 	:= 'CD_PESSOA_FISICA='||cd_pessoa_fisica_p||'#@#@IE_TIPO_COMPLEMENTO=4';
			elsif (nm_atributo_w = 'NM_MAE') then
				nm_atributo_w		:= 'NM_CONTATO';
				ds_chave_composta_w 	:= 'CD_PESSOA_FISICA='||cd_pessoa_fisica_p||'#@#@IE_TIPO_COMPLEMENTO=5';
			else
				ds_chave_composta_w 	:= 'CD_PESSOA_FISICA='||cd_pessoa_fisica_p||'#@#@IE_TIPO_COMPLEMENTO='||ie_tipo_complemento_p;				
			end if;
		elsif (upper(nm_tabela_p)	= 'PESSOA_TITULAR_CONVENIO') then
			ds_chave_simples_w 	:= cd_pessoa_fisica_p;
			ds_chave_composta_w := nr_seq_tabela_pk_p;
		end if;
	
		insert into tasy_solic_alt_campo(
			nr_sequencia,
			nm_tabela,
			nm_atributo,
			ds_chave_simples,
			ds_chave_composta,
			nr_seq_solicitacao,
			ie_status,
			ds_valor_old,
			ds_valor_new,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
      nr_seq_documento)
		values (
			nextval('tasy_solic_alt_campo_seq'),
			upper(nm_tabela_p),
			upper(nm_atributo_w),
			ds_chave_simples_w,
			ds_chave_composta_w,
			nr_seq_solicitacao_w,
			'P',
			ds_valor_old_p,
			ds_valor_new_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
      nr_seq_documento_p);
	end if;

	if (ie_commit_p = 'S') then
		update	pessoa_fisica
		set	ie_revisar		= CASE WHEN ie_cadastro_ok_w='S' THEN 'U'  ELSE 'N' END ,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_p;

		if (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '' AND nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') then
			open C01;
			loop
			fetch C01 into	
				nr_seq_evento_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */		
				CALL gerar_evento_paciente(nr_seq_evento_w, null, cd_pessoa_fisica_p, null, nm_usuario_p,
				   null, null, null, null, null, null, null, null, null, null, 'N');
			end loop;
			close C01;
		end if;

		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_solic_alt_cadastro_pf ( nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_estabelecimento_p regra_envio_sms.cd_estabelecimento%type, nm_tabela_p tabela_sistema.nm_tabela%type, nm_atributo_p tasy_solic_alt_campo.nm_atributo%type, ds_valor_old_p tasy_solic_alt_campo.ds_valor_old%type, ds_valor_new_p tasy_solic_alt_campo.ds_valor_new%type, ie_tipo_complemento_p compl_pessoa_fisica.ie_tipo_complemento%type default 1, ie_commit_p text DEFAULT NULL, nr_seq_tabela_pk_p bigint default null, nr_seq_documento_p tasy_solic_alt_campo.nr_seq_documento%type default null) FROM PUBLIC;

