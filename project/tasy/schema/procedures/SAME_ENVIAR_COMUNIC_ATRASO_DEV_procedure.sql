-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_enviar_comunic_atraso_dev (dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
 
ie_tipo_w			integer;
dt_devolucao_prevista_w		timestamp;
nm_usuario_solic_w		varchar(15);
nm_pessoa_pront_w		varchar(150);
ds_mensagem_w			varchar(4000);
nr_prontuario_w			bigint;

c01 CURSOR FOR 
	SELECT	1 ie_tipo, 
		dt_devolucao_prevista, 
		obter_usuario_pessoa(cd_pessoa_solicitante), 
		substr(obter_nome_pf(cd_pessoa_fisica),1,80), 
		obter_prontuario_paciente(cd_pessoa_fisica) 
	from	same_solic_pront 
	where	trunc(dt_devolucao_prevista) = trunc(dt_referencia_p) 
	and	coalesce(dt_devolucao::text, '') = '' 
	and	(dt_entrega IS NOT NULL AND dt_entrega::text <> '') 
	and	IE_STATUS <> 'C' 
	and	(obter_usuario_pessoa(cd_pessoa_solicitante) IS NOT NULL AND (obter_usuario_pessoa(cd_pessoa_solicitante))::text <> '') 
	
union all
 
	SELECT	2 ie_tipo, 
		dt_devolucao_prevista, 
		obter_usuario_pessoa(cd_pessoa_solicitante), 
		substr(obter_nome_pf(cd_pessoa_fisica),1,80), 
		obter_prontuario_paciente(cd_pessoa_fisica) 
	from	same_solic_pront 
	where	trunc(dt_devolucao_prevista) < trunc(dt_referencia_p) 
	and	coalesce(dt_devolucao::text, '') = '' 
	and	coalesce(dt_entrega::text, '') = '' 
	and	IE_STATUS <> 'C' 
	and	(obter_usuario_pessoa(cd_pessoa_solicitante) IS NOT NULL AND (obter_usuario_pessoa(cd_pessoa_solicitante))::text <> '');


BEGIN 
 
open c01;
loop 
fetch c01 into	 
	ie_tipo_w, 
	dt_devolucao_prevista_w, 
	nm_usuario_solic_w, 
	nm_pessoa_pront_w, 
	nr_prontuario_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	ds_mensagem_w	:= wheb_mensagem_pck.get_texto(309879,	'NM_PESSOA_PRONT_W=' || nm_pessoa_pront_w || ';' || 
															'DT_DEVOLUCAO_PREVISTA_W=' || to_char(dt_devolucao_prevista_w,'dd/mm/yyyy') || ';' || 
															'NR_PRONTUARIO_W=' || nr_prontuario_w);
					/* 
						A solicitação do prontuário do paciente #@NM_PESSOA_PRONT_W#@ teve a data prevista de devolução atingida no dia: #@DT_DEVOLUCAO_PREVISTA_W#@. 
						Prontuário: #@NR_PRONTUARIO_W#@ 
						Favor renovar o empréstimo caso seja necessário permanecer com o prontuário. 
					*/
 
 
	if (ie_tipo_w = 1) then 
		ds_mensagem_w	:= wheb_mensagem_pck.get_texto(309890,	'NM_PESSOA_PRONT_W=' || nm_pessoa_pront_w || ';' || 
																'NR_PRONTUARIO_W=' || nr_prontuario_w);
						/* 
							A solicitação do prontuário do paciente #@NM_PESSOA_PRONT_W#@ terá a data prevista de devolução atigida hoje. 
							Prontuário: #@NR_PRONTUARIO_W#@ 
							Favor renovar o empréstimo caso seja necessário permanecer com o prontuário. 
						*/
 
	end if;
	 
	 
	insert into comunic_interna( 
				dt_comunicado, 
				ds_titulo, 
				ds_comunicado, 
				nm_usuario, 
				dt_atualizacao, 
				ie_geral, 
				nm_usuario_destino, 
				ds_perfil_adicional, 
				nr_sequencia, 
				ie_gerencial, 
				dt_liberacao, 
				cd_estab_destino 
			) values ( 
				clock_timestamp(), 
				wheb_mensagem_pck.get_texto(309891, 'NM_PESSOA_PRONT_W=' || nm_pessoa_pront_w), -- Aviso: devolução prontuário paciente: #@NM_PESSOA_PRONT_W#@ 
				ds_mensagem_w, 
				'Tasy', 
				clock_timestamp(), 
				'N', 
				nm_usuario_solic_w, 
				'', 
				nextval('comunic_interna_seq'), 
				'N', 
				clock_timestamp(), 
				null);	
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_enviar_comunic_atraso_dev (dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

