-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proj_cron_solic_cons (dt_referencia_p timestamp) AS $body$
DECLARE


cd_cliente_w		bigint;
ds_cliente_w		varchar(80);
dt_dia_atual_w	timestamp;
ie_consultoria_w	varchar(1);
qt_consultoria_w	smallint := 0;
ds_comando_w		varchar(1000);

/* obter cliente */

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ds_local
from	local_agenda_tasy a
where	a.ie_situacao	= 'A'
group by
	a.nr_sequencia,
	a.ds_local
order by
	a.ds_local;

/* obter solicitacao consultoria */

c02 CURSOR FOR
SELECT	b.cd_consultor
from	w_relat_proj_cron_cons b
group by
	b.cd_consultor
order by
	b.cd_consultor;


BEGIN
if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
	/* limpar tabela */

	delete from w_relat_proj_cron_cons;

	/* gerar cliente */

	open c01;
	loop
	fetch c01 into	cd_cliente_w,
				ds_cliente_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into w_relat_proj_cron_cons(
							cd_consultor,
							nm_consultor
							)
						values (
							cd_cliente_w,
							ds_cliente_w
							);
		end;
	end loop;
	close c01;

	/* gerar solicitacao consultoria */

	open c02;
	loop
	fetch c02 into cd_cliente_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		dt_dia_atual_w := trunc(dt_referencia_p,'mm');
		while(dt_dia_atual_w <= last_day(dt_referencia_p)) loop
			begin
			/* obter status consultoria */

			select	CASE WHEN coalesce(max(c.ie_status),'L')='L' THEN  ''  ELSE max(c.ie_status) END
			into STRICT	ie_consultoria_w
			from	agenda_tasy c
			where	trunc(c.dt_agenda) = trunc(dt_dia_atual_w)
			and	nr_seq_local = cd_cliente_w;

			/* atualizar status consultoria dia */

			ds_comando_w :=	' update w_relat_proj_cron_cons	' ||
						' set ie_dia' || to_char(dt_dia_atual_w,'dd') || ' = ' || chr(39) || ie_consultoria_w || chr(39) ||
						' where cd_consultor = ' || cd_cliente_w;

			/* atualizar total consultoria mes */

			if (ie_consultoria_w not in ('C','B','L','')) then
				qt_consultoria_w := qt_consultoria_w + 1;
			end if;

			CALL exec_sql_dinamico('TASY',ds_comando_w);
			dt_dia_atual_w := dt_dia_atual_w + 1;
			end;
		end loop;

		/* gerar total consultoria mes */

		update	w_relat_proj_cron_cons
		set	ie_total = qt_consultoria_w
		where	cd_consultor = cd_cliente_w;

		/* limpar total */

		qt_consultoria_w := 0;
		end;
	end loop;
	close c02;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proj_cron_solic_cons (dt_referencia_p timestamp) FROM PUBLIC;

