-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_obter_regra_prest_solic ( cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_setor_entrada_p bigint, ie_clinica_p bigint, cd_procedencia_p text, ie_tipo_atendimento_p bigint, ie_autorizacao_p text, ie_solicitante_p INOUT text, cd_cgc_prest_solic_p INOUT text, cd_medico_atendimento_p text, cd_medico_prestador_p INOUT text, cd_interno_p INOUT text, ds_prestador_tiss_p INOUT text, cd_medico_referido_p text, cd_categoria_p text, dt_referencia_p timestamp, ie_tipo_protocolo_p bigint, cd_medico_prescr_p text default null, cd_plano_convenio_p text default null, nr_seq_regra_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


ie_solicitante_w		varchar(255);
cd_cgc_prestador_w	varchar(255);
cd_medico_prestador_w	varchar(255);
cd_interno_w		varchar(60);
ds_prestador_tiss_w	varchar(255);
ie_vinculo_medico_w	bigint;
nr_seq_regra_w		TISS_REGRA_PRESTADOR_SOLIC.nr_sequencia%type;
c01 CURSOR FOR
SELECT	a.ie_solicitante,
	a.cd_cgc_prestador,
	a.cd_medico_prest,
	a.cd_interno,
	a.ds_prestador_tiss,
	a.nr_sequencia
from	TISS_REGRA_PRESTADOR_SOLIC a
where	a.cd_convenio							= cd_convenio_p
and	a.cd_estabelecimento						= cd_estabelecimento_p
and	coalesce(a.cd_setor_entrada, coalesce(cd_setor_entrada_p,0))			= coalesce(cd_setor_entrada_p,0)
and	coalesce(a.ie_clinica, coalesce(ie_clinica_p, 0))				= coalesce(ie_clinica_p, 0)
and	coalesce(to_char(a.cd_procedencia), coalesce(cd_procedencia_p,'0'))		= coalesce(cd_procedencia_p,'0')
and	((coalesce(a.ie_autorizacao, coalesce(ie_autorizacao_p, 'N'))			= coalesce(ie_autorizacao_p, 'N')) or (coalesce(a.ie_autorizacao, 'N') = 'N'))
and	coalesce(a.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p,0))		= coalesce(ie_tipo_atendimento_p,0)
and	coalesce(a.cd_medico_atendimento, coalesce(cd_medico_atendimento_p, 0))		= coalesce(cd_medico_atendimento_p, 0)
and	coalesce(a.cd_medico_referido, coalesce(cd_medico_referido_p,0))		= coalesce(cd_medico_referido_p,0)
and	coalesce(a.cd_categoria, coalesce(cd_categoria_p,0))				= coalesce(cd_categoria_p,0)
and	coalesce(a.ie_tipo_protocolo, coalesce(ie_tipo_protocolo_p,0))			= coalesce(ie_tipo_protocolo_p,0)
and	coalesce(a.ie_vinculo_medico, coalesce(ie_vinculo_medico_w,0))			= coalesce(ie_vinculo_medico_w,0)
and	coalesce(a.cd_medico_prescr, coalesce(cd_medico_prescr_p,0))			= coalesce(cd_medico_prescr_p,0)
and	coalesce(a.nr_seq_plano, coalesce(cd_plano_convenio_p,0))			= coalesce(cd_plano_convenio_p,0)
and	coalesce(dt_referencia_p,clock_timestamp())	between coalesce(a.dt_inicio_vigencia,to_date('01/01/1990','dd/mm/yyyy')) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_fim_vigencia,clock_timestamp() + interval '1 days'))
order by
	a.cd_convenio,
	a.cd_estabelecimento,
	coalesce(a.cd_setor_entrada,0),
	coalesce(a.ie_clinica,0),
	coalesce(a.cd_procedencia,0),
	coalesce(a.ie_tipo_atendimento,0),
	coalesce(a.cd_medico_atendimento,0),
	coalesce(a.cd_medico_referido,0),
	coalesce(a.cd_categoria,0),
	coalesce(a.dt_inicio_vigencia,to_date('01/01/1990','dd/mm/yyyy')),
	coalesce(a.ie_tipo_protocolo,0),
	coalesce(a.ie_vinculo_medico,0),
	coalesce(a.cd_medico_prescr,0),
	coalesce(a.nr_seq_plano,0);	


BEGIN

if (cd_medico_atendimento_p IS NOT NULL AND cd_medico_atendimento_p::text <> '') then
	
	select	max(ie_vinculo_medico)
	into STRICT	ie_vinculo_medico_w
	from	medico
	where	cd_pessoa_fisica	= cd_medico_atendimento_p;
	
end if;

open c01;
loop
fetch c01 into
	ie_solicitante_w,
	cd_cgc_prestador_w,
	cd_medico_prestador_w,
	cd_interno_w,
	ds_prestador_tiss_w,
	nr_seq_regra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ie_solicitante_p	:= ie_solicitante_w;
	cd_cgc_prest_solic_p	:= cd_cgc_prestador_w;
	cd_medico_prestador_p	:= cd_medico_prestador_w;
	cd_interno_p		:= cd_interno_w;
	ds_prestador_tiss_p	:= ds_prestador_tiss_w;
	nr_seq_regra_p		:= nr_seq_regra_w;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_obter_regra_prest_solic ( cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_setor_entrada_p bigint, ie_clinica_p bigint, cd_procedencia_p text, ie_tipo_atendimento_p bigint, ie_autorizacao_p text, ie_solicitante_p INOUT text, cd_cgc_prest_solic_p INOUT text, cd_medico_atendimento_p text, cd_medico_prestador_p INOUT text, cd_interno_p INOUT text, ds_prestador_tiss_p INOUT text, cd_medico_referido_p text, cd_categoria_p text, dt_referencia_p timestamp, ie_tipo_protocolo_p bigint, cd_medico_prescr_p text default null, cd_plano_convenio_p text default null, nr_seq_regra_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

