-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (	vl_orc	double precision);


CREATE OR REPLACE PROCEDURE ctb_copiar_orc_cenario_ano ( nr_seq_cenario_p bigint, cd_estabelecimento_p bigint, cd_centro_custo_p bigint, dt_ano_ref_p timestamp, nm_usuario_p text) AS $body$
DECLARE

type reg_campos is table of campos index by integer;

cd_centro_custo_w			bigint;
cd_conta_contabil_w		varchar(20);
cd_empresa_w			bigint;
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_referencia_w			timestamp;
nr_mes_w			bigint;
nr_seq_mes_ref_w			bigint;
valor_w				reg_campos;
vl_orcado_w			double precision;

c01 CURSOR FOR
SELECT	distinct
	a.cd_centro_custo,
	a.cd_conta_contabil
from	ctb_mes_ref b,
	ctb_orcamento a
where	a.nr_seq_mes_ref		= b.nr_sequencia
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	a.cd_centro_custo		= coalesce(cd_centro_custo_p, a.cd_centro_custo)
and	b.cd_empresa		= cd_empresa_w
and	b.dt_referencia between dt_inicial_w and dt_final_w
and	not exists (	select	1
			from	ctb_orc_cen_valor_linear y
			where	y.nr_seq_cenario		= nr_seq_cenario_p
			and	y.cd_centro_custo		= a.cd_centro_custo
			and	y.cd_conta_contabil	= a.cd_conta_contabil);

c02 CURSOR FOR
SELECT	y.nr_mes,
	y.nr_sequencia,
	y.dt_referencia
from (
	SELECT	a.nr_sequencia,
		a.dt_referencia,
		somente_numero(to_char(a.dt_referencia,'mm')) nr_mes
	from	ctb_mes_ref a
	where	a.cd_empresa	= cd_empresa_w
	and	a.dt_referencia between dt_inicial_w and dt_final_w
	order by 2) y
where	1 = 1
order by nr_mes;


BEGIN

cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

select	ctb_obter_mes_ref(nr_seq_mes_inicio),
	ctb_obter_mes_ref(nr_seq_mes_fim)
into STRICT	dt_inicial_w,
	dt_final_w
from	ctb_orc_cenario
where	nr_sequencia	= nr_seq_cenario_p;

open C01;
loop
fetch C01 into
	cd_centro_custo_w,
	cd_conta_contabil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	for nr_mes_w in 1..12 loop
		begin
		valor_w[nr_mes_w].vl_orc	:= 0;
		end;
	end loop;

	open C02;
	loop
	fetch C02 into
		nr_mes_w,
		nr_seq_mes_ref_w,
		dt_referencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		select	coalesce(max(a.vl_orcado),0)
		into STRICT	vl_orcado_w
		from	ctb_orcamento a
		where	cd_estabelecimento		= cd_estabelecimento_p
		and	nr_seq_mes_ref		= nr_seq_mes_ref_w
		and	cd_centro_custo		= cd_centro_custo_w
		and	cd_conta_contabil		= cd_conta_contabil_w;

		valor_w[nr_mes_w].vl_orc		:= vl_orcado_w;
		end;
	end loop;
	close C02;

	insert into ctb_orc_cen_valor_linear(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_cenario,
		cd_estabelecimento,
		cd_centro_custo,
		cd_conta_contabil,
		vl_orcado_1,
		vl_orcado_2,
		vl_orcado_3,
		vl_orcado_4,
		vl_orcado_5,
		vl_orcado_6,
		vl_orcado_7,
		vl_orcado_8,
		vl_orcado_9,
		vl_orcado_10,
		vl_orcado_11,
		vl_orcado_12)
	values (	nextval('ctb_orc_cen_valor_linear_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_cenario_p,
		cd_estabelecimento_p,
		cd_centro_custo_w,
		cd_conta_contabil_w,
		valor_w[01].vl_orc,
		valor_w[02].vl_orc,
		valor_w[03].vl_orc,
		valor_w[04].vl_orc,
		valor_w[05].vl_orc,
		valor_w[06].vl_orc,
		valor_w[07].vl_orc,
		valor_w[08].vl_orc,
		valor_w[09].vl_orc,
		valor_w[10].vl_orc,
		valor_w[11].vl_orc,
		valor_w[12].vl_orc);

	end;
end loop;
close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_copiar_orc_cenario_ano ( nr_seq_cenario_p bigint, cd_estabelecimento_p bigint, cd_centro_custo_p bigint, dt_ano_ref_p timestamp, nm_usuario_p text) FROM PUBLIC;

