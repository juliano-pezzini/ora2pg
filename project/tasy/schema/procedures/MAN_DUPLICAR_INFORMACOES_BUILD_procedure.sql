-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_duplicar_informacoes_build ( nr_sequencia_ctrl_p bigint, nr_sequencia_ctrl_build_p bigint, cd_versao_selecionada_p text, ds_lista_versao_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_versao_w		varchar(2000);
nr_pos_virgula_w		bigint;
cd_versao_w			varchar(15);
nr_controle_loop_w		smallint := 0;
nr_seq_registro_w		bigint  := 0;
nr_sequencia_build_alt_w	bigint;
ds_projeto_build_alt_w 		varchar(60);
ds_classe_build_alt_w 		varchar(255);
cd_pessoa_fisica_build_alt_w	varchar(10);
cd_ramal_build_alt_w 		bigint;
ie_localizacao_build_alt_w 	varchar(2);
ds_alteracao_build_alt_w 	varchar(2000);


C01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_projeto,
		ds_classe,
		cd_pessoa_fisica,
		cd_ramal,
		ie_localizacao,
		substr(ds_alteracao, 1, 1999)
 	from	man_os_ctrl_build_alt
	where	nr_seq_man_os_ctrl_build = nr_sequencia_ctrl_build_p;


BEGIN
if (ds_lista_versao_p IS NOT NULL AND ds_lista_versao_p::text <> '') and (nr_sequencia_ctrl_p IS NOT NULL AND nr_sequencia_ctrl_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	ds_lista_versao_w := ds_lista_versao_p;
	while(ds_lista_versao_w IS NOT NULL AND ds_lista_versao_w::text <> '') and (nr_controle_loop_w < 100) loop
		begin

		nr_pos_virgula_w := position(',' in ds_lista_versao_w);

		if (nr_pos_virgula_w > 0) then
			begin
			cd_versao_w	:= substr(ds_lista_versao_w,0,nr_pos_virgula_w-1);
			ds_lista_versao_w	:= substr(ds_lista_versao_w,nr_pos_virgula_w+1,length(ds_lista_versao_w));
			end;
		else
			begin
			cd_versao_w	:= (ds_lista_versao_w)::numeric;
			ds_lista_versao_w	:= null;
			end;
		end if;

		if (cd_versao_selecionada_p <> cd_versao_w) then

		if (cd_versao_w IS NOT NULL AND cd_versao_w::text <> '') then
			begin

			-- Verifica se já existe uma sequencia da versão na OS.
			begin
			select	distinct(coalesce(a.nr_sequencia,0))
			into STRICT	nr_seq_registro_w
			from	man_os_ctrl_build a,
				man_os_ctrl_desc b
			where	a.nr_seq_man_os_ctrl_desc = nr_sequencia_ctrl_p
			and	coalesce(a.cd_build::text, '') = ''
			and 	coalesce(b.dt_liberacao::text, '') = ''
			and 	coalesce(b.dt_inativacao::text, '') = ''
			and	a.cd_versao = cd_versao_w;

			exception
			when others then
				nr_seq_registro_w := 0;
			end;


			if (nr_seq_registro_w = 0) then

				begin

				select	nextval('man_os_ctrl_build_seq')
				into STRICT	nr_seq_registro_w
				;

				insert into man_os_ctrl_build(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								cd_versao,
								cd_build,
								dt_inicio_geracao,
								nr_seq_man_os_ctrl_desc,
								dt_fim_geracao,
								nm_usuario_geracao,
								ie_situacao)
							values (
								nr_seq_registro_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								cd_versao_w,
								null,
								null,
								nr_sequencia_ctrl_p,
								null,
								null,
								'A');

				commit;
				end;
			end if;

			open C01;
			loop
			fetch C01 into
				nr_sequencia_build_alt_w,
				ds_projeto_build_alt_w,
				ds_classe_build_alt_w,
				cd_pessoa_fisica_build_alt_w,
				cd_ramal_build_alt_w,
				ie_localizacao_build_alt_w,
				ds_alteracao_build_alt_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */

				begin
				insert into man_os_ctrl_build_alt( 	nr_sequencia,
 									dt_atualizacao,
 									nm_usuario,
 									dt_atualizacao_nrec,
 									nm_usuario_nrec,
 									ds_projeto,
 									ds_classe,
 									cd_pessoa_fisica,
									cd_ramal,
 									ie_localizacao,
 									ds_alteracao,
 									nr_seq_man_os_ctrl_build
 									)
								values (
									nextval('man_os_ctrl_build_alt_seq'),
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									ds_projeto_build_alt_w,
									ds_classe_build_alt_w,
									cd_pessoa_fisica_build_alt_w,
									cd_ramal_build_alt_w,
									ie_localizacao_build_alt_w,
									ds_alteracao_build_alt_w,
									nr_seq_registro_w);
				commit;
				end;
			end loop;
			close C01;

			nr_seq_registro_w := 0;
			end;
		end if;
		end if;
		nr_controle_loop_w := nr_controle_loop_w + 1;
		end;
	end loop;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_duplicar_informacoes_build ( nr_sequencia_ctrl_p bigint, nr_sequencia_ctrl_build_p bigint, cd_versao_selecionada_p text, ds_lista_versao_p text, nm_usuario_p text) FROM PUBLIC;

